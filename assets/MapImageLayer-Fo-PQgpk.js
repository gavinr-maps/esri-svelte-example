import{V as w,ab as v,u as f,s as x,E as O,r as i,m as a,$ as P,a as T}from"./Accessor-BmwT4B0c.js";import{P as g}from"./cast-CsZslgGN.js";import{t as E}from"./loadAll-D1eTJ7uv.js";import{S as L}from"./MultiOriginJSONSupport-DbmrbwMa.js";import{o as F,r as M}from"./writer-DKgfqj4X.js";import{w as R}from"./Extent-g5W9hy0j.js";import{i as _}from"./scaleUtils-DPfHG2g0.js";import{a2 as j}from"./Point-Cz2JYYmX.js";import{f as J}from"./Layer-DH4_Pn8a.js";import{i as N}from"./APIKeyMixin-3z69J1h4.js";import{m as q,f as U,s as A}from"./SublayersOwner-BZG8n34G.js";import{l as V}from"./ArcGISService-CDyDWGI0.js";import{p as k,t as z}from"./ScaleRangeLayer-Cnzwr9PT.js";import{e as Z}from"./CustomParametersMixin-Be7WOSEG.js";import{b as B}from"./OperationalLayer-B__lrMRq.js";import{j as C}from"./PortalLayer-Cqwv_mmr.js";import{f as D}from"./RefreshableLayer-C90FXoHt.js";import{l as G}from"./TemporalLayer-CMqBosxi.js";import{y as H}from"./commonProperties-B0GHoNP5.js";import{y as K}from"./ExportImageParameters-AbYMPLed.js";import{t as W}from"./imageBitmapUtils-DPq40V9d.js";import{e as S}from"./sublayerUtils-Cj6GQMKz.js";import{t as Q}from"./versionUtils-BfhafDf-.js";import{p as X}from"./TimeExtent-BO6BsF_x.js";import{a as I}from"./timeZoneUtils-DxzjpEBb.js";import"./index-4eY77cms.js";import"./JSONSupport-DcrLLGjL.js";import"./reactiveUtils-XM7cS2OP.js";import"./Evented-Dw4_VOGn.js";import"./SimpleObservable-CvOkykwM.js";import"./Portal-CmmHxpLg.js";import"./Promise-DfET-uns.js";import"./mathUtils-Cfq9PL9W.js";import"./Identifiable-BHVfzH03.js";import"./Version-Cd3TlGH0.js";import"./portalItemUtils-ByOtbGao.js";import"./projection-CyCZAIaD.js";import"./vec3f64-BLpZdpfb.js";import"./Polyline-s-JzsQqo.js";import"./projectBuffer-CQnuEMuP.js";import"./geodesicConstants-RQL9oKdk.js";import"./CollectionFlattener-U8hHQmGf.js";import"./Graphic-Dt0LgVGU.js";import"./Clonable-Z-AWS-16.js";import"./opacityUtils-Dim20wpZ.js";import"./enumeration-DpvDkLNI.js";import"./Color-VJEMvW-n.js";import"./colorUtils-Rxh2V3ai.js";import"./ActionToggle-D7439N1A.js";import"./jsonUtils-CwFG8yN4.js";import"./typeUtils-B6WBEKDM.js";import"./TextSymbol-BLIQ6RKX.js";import"./screenUtils-_ZIvrt5o.js";import"./collectionUtils-CTT-51g7.js";import"./aaBoundingBox-Dw3yBk2f.js";import"./QueryTask-DhCC-aVs.js";import"./infoFor3D-C7tb3HsI.js";import"./Query-B_2mhyL4.js";import"./Field-BDG0QV_T.js";import"./fieldType-CBeoJWlv.js";import"./FullTextSearch-CBnxSwz4.js";import"./utils-YowqfOgk.js";import"./executeForIds-BgTHdLi8.js";import"./query-Bjn_Ozo1.js";import"./normalizeUtils-BTGdXlpz.js";import"./normalizeUtilsCommon-lGDszWRI.js";import"./utils-B-dlKIhi.js";import"./pbfQueryUtils-mqiWagfZ.js";import"./pbf-BsmI3A9L.js";import"./memoryEstimations-Bcyf-mHz.js";import"./OptimizedGeometry-BJqUA4Pi.js";import"./OptimizedFeature-P2towpqD.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./queryZScale-BdW_vUm_.js";import"./executeQueryJSON-BvVQs3iA.js";import"./FeatureSet-B5-Veyin.js";import"./featureConversionUtils-CvnFcmH_.js";import"./OrderedLayer-ucEg87Tu.js";import"./OrderByInfo-KsusEmpW.js";import"./featureLayerUtils-Btb8HY8h.js";import"./uuid-Cl5lrJ4c.js";import"./featureQueryAll-JpNZKIBO.js";import"./layerUtils-B__v9OBu.js";import"./SimpleRenderer-CEw_geZx.js";import"./commonProperties-ZfGquLPI.js";import"./colorRamps-CRjjPL3r.js";import"./SizeVariable-B-ghFm6e.js";import"./visualVariableUtils-Xcorldoo.js";import"./lengthUtils-_77UiyVF.js";import"./ColorStop-BYiAUa8d.js";import"./jsonUtils-B-voMz-i.js";import"./defaults-FkBa0ybj.js";import"./defaultsJSON-GKolV7NZ.js";import"./UniqueValueRenderer-yoWHKJ_P.js";import"./diffUtils-BanfihCO.js";import"./RendererLegendOptions-CYAPr8D6.js";import"./styleUtils-ColFrJ-Z.js";import"./AttachmentQuery-CpEmJqq-.js";import"./NormalizationBinParametersMixin-CZD0XfhN.js";import"./RelationshipQuery-B5a-mYy7.js";import"./timeUtils-C1c_L2Fd.js";import"./FeatureType-DhERcdEP.js";import"./FeatureTemplate-Dh5_oWTV.js";import"./FieldsIndex-FW1AMU67.js";import"./labelingInfo-BgG6IH9B.js";import"./labelUtils-DCpQ7n-8.js";import"./LayerFloorInfo-iCgtHY6f.js";import"./Relationship-CTbzI1Kb.js";import"./serviceCapabilitiesUtils-B2yGaMdk.js";import"./typeUtils-B3iPBwJ2.js";import"./ClassBreaksRenderer-C7fhua2J.js";import"./LRUCache-CXiGQWMN.js";import"./MemCache-CmojB_Z1.js";import"./utils-UPZJIDfz.js";import"./defaultCIMValues-Bb-CUowV.js";import"./enums-BTM-fOHQ.js";import"./HeatmapColorStop-CHbSyb1s.js";import"./heatmapUtils-Cyq-bAyG.js";import"./vec42-YcqnINSP.js";import"./common-DQOJ18NT.js";import"./vec4f64-o2zAXfmz.js";import"./popupUtils-CmsUVJA0.js";import"./layerContainerType-C5CzMsLd.js";import"./jsonUtils-DZz5FrgB.js";import"./utils-DYurMneM.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-Fi6iAz29.js";import"./PortalItem-CTx1kJsR.js";import"./TimeInfo-CctegBed.js";import"./TimeInterval-B7L-CEq7.js";import"./ElevationInfo-BPOqhCue.js";import"./unitConversionUtils-rg07EgOm.js";import"./AttributeTableTemplate-cR37sM72.js";import"./floorFilterUtils-DZ5C6FQv.js";let o=class extends k(G(z(q(U(V(B(C(L(D(N(Z(J)))))))))))){constructor(...r){super(...r),this._exportImageParameters=new K({layer:this}),this.dateFieldsTimeZone=null,this.datesInUnknownTimezone=!1,this.dpi=96,this.gdbVersion=null,this.imageFormat="png24",this.imageMaxHeight=2048,this.imageMaxWidth=2048,this.imageTransparency=!0,this.isReference=null,this.labelsVisible=!1,this.operationalLayerType="ArcGISMapServiceLayer",this.preferredTimeZone=null,this.sourceJSON=null,this.sublayers=null,this.type="map-image",this.url=null}normalizeCtorArgs(r,e){return typeof r=="string"?{url:r,...e}:r}load(r){const e=r!=null?r.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Map Service"]},r).catch(w).then(()=>this._fetchService(e))),Promise.resolve(this)}destroy(){this._exportImageParameters.destroy()}readImageFormat(r,e){const n=e.supportedImageFormatTypes;return n&&n.includes("PNG32")?"png32":"png24"}writeSublayers(r,e,n,t){var l,c,b;if(!this.loaded||!r)return;const s=r.slice().reverse().flatten(({sublayers:m})=>m&&m.toArray().reverse()).toArray();let p=!1;const h=v(t.origin);if((l=this.capabilities)!=null&&l.operations.supportsExportMap&&((b=(c=this.capabilities)==null?void 0:c.exportMap)!=null&&b.supportsDynamicLayers)){if(h===f.PORTAL_ITEM){const m=this.createSublayersForOrigin("service").sublayers;p=S(s,m,f.SERVICE)}else if(h>f.PORTAL_ITEM){const m=this.createSublayersForOrigin("portal-item");p=S(s,m.sublayers,v(m.origin))}}const y=[],d={writeSublayerStructure:p,...t};let u=p||this.hasVisibleLayersForOrigin(h);s.forEach(m=>{const $=m.write({},d);y.push($),u=u||m.originOf("visible")==="user"}),y.some(m=>Object.keys(m).length>1)&&(e.layers=y),u&&(e.visibleLayers=s.filter(m=>m.visible).map(m=>m.id))}createExportImageParameters(r,e,n,t){const s=(t==null?void 0:t.pixelRatio)||1;r&&this.version>=10&&(r=r.clone().shiftCentralMeridian()),this._exportImageParameters.floors=(t==null?void 0:t.floors)??null,this._exportImageParameters.scale=_({extent:r,width:e})*s;const p=this._exportImageParameters.toJSON(),h=!(t!=null&&t.rotation)||this.version<10.3?{}:{rotation:-t.rotation},y=r==null?void 0:r.spatialReference,d=j(y);p.dpi*=s;const u={};if(t!=null&&t.timeExtent){const{start:l,end:c}=t.timeExtent.toJSON();u.time=l&&c&&l===c?""+l:`${l??"null"},${c??"null"}`}else this.timeInfo&&!this.timeInfo.hasLiveData&&(u.time="null,null");return{bbox:r?r.xmin+","+r.ymin+","+r.xmax+","+r.ymax:void 0,bboxSR:d,imageSR:d,size:e+","+n,...p,...h,...u}}async fetchImage(r,e,n,t){const{data:s}=await this._fetchImage("image",r,e,n,t);return s}async fetchImageBitmap(r,e,n,t){const{data:s,url:p}=await this._fetchImage("blob",r,e,n,t);return W(s,p,t==null?void 0:t.signal)}async fetchRecomputedExtents(r={}){const e={...r,query:{returnUpdates:!0,f:"json",...this.customParameters,token:this.apiKey}},{data:n}=await g(this.url,e),{extent:t,fullExtent:s,timeExtent:p}=n,h=t||s;return{fullExtent:h&&R.fromJSON(h),timeExtent:p&&X.fromJSON({start:p[0],end:p[1]})}}loadAll(){return E(this,r=>{r(this.allSublayers),r(this.subtables)})}serviceSupportsSpatialReference(r){return Q(this,r)}async _fetchImage(r,e,n,t,s){var y,d,u;const p={responseType:r,signal:(s==null?void 0:s.signal)??null,query:{...this.parsedUrl.query,...this.createExportImageParameters(e,n,t,s),f:"image",...this.refreshParameters,...this.customParameters,token:this.apiKey}},h=this.parsedUrl.path+"/export";if(((y=p.query)==null?void 0:y.dynamicLayers)!=null&&!((u=(d=this.capabilities)==null?void 0:d.exportMap)!=null&&u.supportsDynamicLayers))throw new x("mapimagelayer:dynamiclayer-not-supported",`service ${this.url} doesn't support dynamic layers, which is required to be able to change the sublayer's order, rendering, labeling or source.`,{query:p.query});try{const{data:l}=await g(h,p);return{data:l,url:h}}catch(l){throw O(l)?l:new x("mapimagelayer:image-fetch-error",`Unable to load image: ${h}`,{error:l})}}async _fetchService(r){if(this.sourceJSON)return void this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl});const{data:e,ssl:n}=await g(this.parsedUrl.path,{query:{f:"json",...this.parsedUrl.query,...this.customParameters,token:this.apiKey},signal:r});n&&(this.url=this.url.replace(/^http:/i,"https:")),this.sourceJSON=e,this.read(e,{origin:"service",url:this.parsedUrl})}hasVisibleLayersForOrigin(r){var e;return!(r==null||!((e=this.sublayersSourceJSON[r])!=null&&e.visibleLayers))}};i([a(I("dateFieldsTimeReference"))],o.prototype,"dateFieldsTimeZone",void 0),i([a({type:Boolean})],o.prototype,"datesInUnknownTimezone",void 0),i([a()],o.prototype,"dpi",void 0),i([a()],o.prototype,"gdbVersion",void 0),i([a()],o.prototype,"imageFormat",void 0),i([F("imageFormat",["supportedImageFormatTypes"])],o.prototype,"readImageFormat",null),i([a({json:{origins:{service:{read:{source:"maxImageHeight"}}}}})],o.prototype,"imageMaxHeight",void 0),i([a({json:{origins:{service:{read:{source:"maxImageWidth"}}}}})],o.prototype,"imageMaxWidth",void 0),i([a()],o.prototype,"imageTransparency",void 0),i([a({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],o.prototype,"isReference",void 0),i([a({json:{read:!1,write:!1}})],o.prototype,"labelsVisible",void 0),i([a({type:["ArcGISMapServiceLayer"]})],o.prototype,"operationalLayerType",void 0),i([a({json:{read:!1,write:!1}})],o.prototype,"popupEnabled",void 0),i([a(I("preferredTimeReference"))],o.prototype,"preferredTimeZone",void 0),i([a()],o.prototype,"sourceJSON",void 0),i([a({json:{write:{ignoreOrigin:!0}}})],o.prototype,"sublayers",void 0),i([M("sublayers",{layers:{type:[A]},visibleLayers:{type:[P]}})],o.prototype,"writeSublayers",null),i([a({type:["show","hide","hide-children"]})],o.prototype,"listMode",void 0),i([a({json:{read:!1},readOnly:!0,value:"map-image"})],o.prototype,"type",void 0),i([a(H)],o.prototype,"url",void 0),o=i([T("esri.layers.MapImageLayer")],o);const Oe=o;export{Oe as default};
