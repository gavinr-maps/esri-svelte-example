import{r as w}from"./tslib.es6-B3Jf3DVX.js";import{o as K}from"./Evented-BHRw9x22.js";import{b as Y,s as D}from"./Accessor-BLX9ikPh.js";import{watch as oe,initial as se}from"./reactiveUtils-C5zUhJQJ.js";import{m as O,a as N,b as ae}from"./subclass-BZA_h8Db.js";import{g as z}from"./Point-Cg0-ChZE.js";import{V as de}from"./QueryEngine-DrzbS-Dm.js";import{b as J}from"./Query-5Xpquc1r.js";import{d as ce}from"./asyncUtils-CWX51uTe.js";import{s as le}from"./ReactiveMap-6CfRGOlR.js";import{h as me,E as ee}from"./PooledRBush-D7s4d_Fs.js";import{n as ue}from"./centroid-DdLmOD72.js";import{s as k}from"./OptimizedGeometry-BF8iz5FO.js";import{i as pe,H as he}from"./Polyline-D9YkgmM_.js";import{d as fe}from"./query-Dw-gv3BA.js";import{n as _e}from"./pbf-BtDZ1BpD.js";import{n as G,u as q}from"./vec3f64-BLpZdpfb.js";import{a as ge,u as we,d as ye}from"./aaBoundingBox-BE7cC1jD.js";import{u as be}from"./quantizationUtils-uj_P09aO.js";import{Z as Ie}from"./FieldsIndex-DpwHKAMX.js";import{b as Re,h as Ce}from"./pbfQueryUtils-B0fU-MiS.js";import{l as xe}from"./ViewingMode-Dodu7ZZk.js";import{l as ve,t as Te}from"./Indices-DflDlU4Z.js";import{b as Ee}from"./FeaturePipelineRenderManager-DjjUkvYY.js";import{n as Oe,h as Ae,s as Se,o as $e,f as Fe}from"./mat4-GpOFENPA.js";import{e as A}from"./mat4f64-Dk4dwAN8.js";import{N as Me,O as De}from"./Texture-Fac_8AOC.js";import{e as f}from"./VertexAttribute-Cq4MnHjR.js";import{B as Be}from"./DefaultMaterial-DgOvtNL9.js";import{n as Ne}from"./projectBuffer-Bs7GwaPY.js";import{n as Ge}from"./projectVectorToVector-G2uWGoIb.js";import{C as je}from"./computeTranslationToOriginAndRotation-Q27G6TBL.js";import{b as Le,E as ke}from"./symbols-CNimns--.js";import{D as Pe}from"./graphicUtils-CWEFaVJb.js";import{h as Qe}from"./sdfPrimitives-CUWZbMRe.js";import{t as b}from"./orientedBoundingBox-DOAJUK5g.js";import{B as We}from"./RenderCoordsHelper-C50UGjbb.js";import"./Collection-CEdjem1-.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./cast-Bjksrh93.js";import"./writer-DNAwXnhG.js";import"./assets-C43MgM-v.js";import"./index-Bh2oEzTI.js";import"./jsonMap-0cxwUWs2.js";import"./projection-B971H0Re.js";import"./Extent-Bf3YTe7m.js";import"./jsonUtils-CEfjT-BK.js";import"./normalizeUtils-EVmAQ-ak.js";import"./normalizeUtilsCommon-dT81xWiM.js";import"./geometry-D964gYQX.js";import"./utils-6jMaHUrH.js";import"./utils-Bema0iXE.js";import"./featureConversionUtils-D14h8iad.js";import"./OptimizedFeature-6cJ-QFG5.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./LRUCache-B_PHMSGm.js";import"./MemCache-Dx1v3xLC.js";import"./WhereClause-BNiy948d.js";import"./TimeOnly-DOn_Hy89.js";import"./UnknownTimeZone-BkowvBs8.js";import"./date-DlqISzcw.js";import"./locale-C9TlLpzi.js";import"./mathUtils-C4_ghTv4.js";import"./fieldType-BuzM0UHS.js";import"./timeSupport-T1g9-JyG.js";import"./queryUtils-O-WFKoZd.js";import"./json-Wa8cmqdu.js";import"./QueryEngineCapabilities-DjYb9CEb.js";import"./fieldUtils-tmQlKvWo.js";import"./intl-CChhNOV8.js";import"./messages-OmQvZhAg.js";import"./utils-Bh2cHa3t.js";import"./screenUtils-_ZIvrt5o.js";import"./timeUtils-8fb_2oAt.js";import"./heatmapUtils-Dwiv9IEa.js";import"./vec42-YcqnINSP.js";import"./common-DQOJ18NT.js";import"./vec4f64-o2zAXfmz.js";import"./utils-BwQ00KBJ.js";import"./Basemap-DVYOaWHz.js";import"./collectionUtils-D_lHIu88.js";import"./Loadable-BabW5Xcc.js";import"./Promise-B2Hu02L7.js";import"./loadAll-B6mYSptb.js";import"./Portal-C10FKnaA.js";import"./PortalItem-DzgXrpyc.js";import"./persistableUrlUtils-fa1mAujs.js";import"./writeUtils-Dz7BsE1e.js";import"./layerUtils-BrNoooE9.js";import"./mat4f32-DcsiF_Rp.js";import"./utils-rwwdQ1Ui.js";import"./ClassBreaksDefinition-CS8Z_VNX.js";import"./enumeration-Ba5njXdz.js";import"./SnappingCandidate-O5eRSE6e.js";import"./Scheduler-CJu5awNf.js";import"./signal-D4lghLjV.js";import"./debugFlags-BF6Z0j0F.js";import"./DataLayerSource-BKkswDvG.js";import"./Field-ybkHhtnK.js";import"./FullTextSearch-Csd1Hktu.js";import"./Clonable-D3rtuBWg.js";import"./TimeExtent-DocT5yPf.js";import"./quickselect-QQC62dOK.js";import"./queryZScale-w66xFVGx.js";import"./LodRenderer-EVrH9dsH.js";import"./vec2-maR1OrZI.js";import"./vec2f64-miziP1SN.js";import"./Material-_xx7OZxD.js";import"./interfaces-DDtDqZYj.js";import"./boundedPlane-EV1sS2Ke.js";import"./sphere-C77djCO6.js";import"./vec32-Dvg_eL9J.js";import"./mat3-BRl2i9Bz.js";import"./mat3f64-BBpwCtoL.js";import"./plane-IENfwZlB.js";import"./quatf64-CCm9z-pX.js";import"./mathUtils-BG-eq9fO.js";import"./lineSegment-D7sKPPYf.js";import"./glUtil-D0YUa0ow.js";import"./enums-D9v74xTE.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./InterleavedLayout-e-di2fxs.js";import"./BufferView-_QDXRCew.js";import"./Util-BIfApRF5.js";import"./MergedRenderer-Dli9s1X5.js";import"./VertexArrayObject-lPxPk5E-.js";import"./Texture-Begq2x5n.js";import"./frustum-CQrOepbv.js";import"./NestedMap-GuqgquCN.js";import"./Matrix3DrawUniform-CiBFaSz6.js";import"./BindType-BmZEZMMh.js";import"./compilerUtils-Dw3R0f-Z.js";import"./renderState-DQLu6AJX.js";import"./intersectorUtils-BK9EUwUf.js";import"./Octree-C8d4sqjv.js";import"./BufferObject-BVi1lwBq.js";import"./dehydratedFeatureUtils-B--Sgpdi.js";import"./verticalOffsetUtils-BDQLpfho.js";import"./Intersector-BQ92CPLA.js";import"./RealisticTree.glsl-CAmeC2w1.js";import"./DecodeSymbolColor.glsl-BPIX0fAF.js";import"./HUDMaterial.glsl-D6WRipwF.js";import"./AlphaCutoff-UcccL64p.js";import"./VertexColor.glsl-_ARMpsAT.js";import"./ShaderTechniqueConfiguration-CBbn2DCi.js";import"./Float4DrawUniform-N58YDhuZ.js";import"./lengthUtils-DL1-FDQQ.js";import"./triangle-PTGDC_xJ.js";import"./requestImageUtils-DgMiQwsm.js";import"./doublePrecisionUtils-B0owpBza.js";import"./geodesicConstants-DWQLYX7F.js";import"./projectPointToVector-GINIbYMz.js";import"./TextSymbol-D8QO_KUV.js";import"./Color-BCS62Hs5.js";import"./colorUtils-0bJDPow9.js";import"./materialUtils-DarhapKC.js";import"./opacityUtils-C68Tlu6_.js";import"./meshVertexSpaceUtils-CXzOFlTI.js";import"./MeshLocalVertexSpace-LEHwMUnu.js";import"./hydratedFeatures-DBKLr8hT.js";import"./Graphic-DsxsIjhH.js";import"./PopupTemplate-BHMhS05j.js";import"./ActionToggle-iT4slXc7.js";import"./Identifiable-B1UbsKNt.js";import"./vec3f32-nZdmKIgz.js";import"./floatRGBA-CfH_2xsy.js";import"./quat-4pa1e6ds.js";import"./spatialReferenceEllipsoidUtils-DBE_OFra.js";import"./projectVectorToPoint-DcLtSZYw.js";let I=class extends Y{constructor(e){super(e),this._removing=0,this._tiles=new le}destroy(){for(const e of this._tiles.values())e.remove();this._tiles.clear()}get updating(){if(this._removing>0)return!0;for(const e of this._tiles.values())if(!e.finished)return!0;return!1}async onTileTreeChange(e){const{added:t,removed:i}=e,n=this._tiles,o=[];for(const s of i){const a=n.get(s);a!=null&&(a.abort(),n.delete(s),o.push({tileId:s}))}for(const s of t)n.has(s.id)||n.set(s.id,ce(a=>this._addTile(s,a)));await this._removeTiles(o)}async _addTile(e,t){const i=await this.addTile(e,t);return D(t),i}async _removeTiles(e){this._removing++,await this.removeTiles(e),this._removing--}};w([O()],I.prototype,"updating",null),w([O({constructOnly:!0})],I.prototype,"addTile",void 0),w([O({constructOnly:!0})],I.prototype,"removeTiles",void 0),w([O()],I.prototype,"_removing",void 0),I=w([N("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],I);let P=class{constructor(e,t){this._index=e,this._view=t}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(e){return this._view.getAttribute(this._index,e)}getAttributeAsTimestamp(e){return this._view.getAttributeAsTimestamp(this._index,e)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(e){return this._view.getCentroid(this._index,e)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(e){return new Ue(this._index,this._view,e)}},Ue=class extends P{constructor(e,t,i){super(e,t),this._geometryOverride=i}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return ue(new k,this._geometryOverride,e.hasZ,e.hasM)}},Ye=class{constructor(){this._storedTiles=new Map,this._pageBounds=new Map,this.events=new K,this.featureAdapter=Q.shared}addTile(e){this._storedTiles.set(e.descriptor.id,e);for(const t of e.pages)this._addPage(t)}removeTile(e){const t=this._storedTiles,i=t.get(e);if(i!=null){t.delete(e);for(const n of i.pages)this._removePage(n)}}_addPage(e){const{featureCount:t}=e;if(t===0)return;const i=new me(9,o=>e.getBounds(o)),n=new Array;for(let o=0;o<t;++o)n[o]=o;i.load(n),this._pageBounds.set(e,i),this.events.emit("changed")}_removePage(e){this._pageBounds.delete(e),this.events.emit("changed")}clear(){this._storedTiles.clear(),this._pageBounds.clear(),this.events.emit("changed")}forEach(e){for(const[t,i]of this._pageBounds)i.all(n=>e(new P(n,t)))}forEachInBounds(e,t){E.minX=e[0],E.minY=e[1],E.maxX=e[2],E.maxY=e[3];for(const[i,n]of this._pageBounds)n.search(E,o=>t(new P(o,i)))}forEachBounds(e,t){for(const i of e)t(i.getBoundingBox())}getFullExtent(e){let t=1/0,i=1/0,n=-1/0,o=-1/0;for(const s of this._pageBounds.values()){const{minX:a,minY:c,maxX:m,maxY:l}=s.toJSON();t=Math.min(t,a),i=Math.min(i,c),n=Math.min(n,m),o=Math.min(o,l)}return{xmin:t,ymin:i,xmax:n,ymax:o,spatialReference:e}}},Q=class{getObjectId(e){return e.getObjectId()}getAttribute(e,t){return e.getAttribute(t)}getAttributeAsTimestamp(e,t){return e.getAttributeAsTimestamp(t)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,t){return e.getCentroid(t)}cloneWithGeometry(e,t){return e.cloneWithGeometry(t)}};Q.shared=new Q;const E=new ee;let ze=class{constructor(e,t){this.descriptor=e,this.pages=t}};class Je{constructor(e){const t=new _e(new Uint8Array(e),new DataView(e));this._reader=t,this._index=qe(t)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){var c;const{_index:{fieldsIndex:i,attributeIndices:n}}=this,o=(c=i.get(t))==null?void 0:c.index;if(o==null)return;const s=n[e*i.fields.length+o],a=this._reader;return a.move(s),L(a)}getAttributeAsTimestamp(e,t){const i=this.getAttribute(e,t);return typeof i=="string"?new Date(i).getTime():typeof i=="number"||i==null?i:null}getAttributes(e){const{_index:{fieldsIndex:t,attributeIndices:i}}=this,n=e*t.fields.length,o=this._reader,s={};for(const a of t.fields){const c=i[n+a.index];o.move(c),s[a.name]=L(o)}return s}getCoordinates(e,t,i=0){const n=this._reader,{transform:o,featureIndices:s}=this._index,{scale:a,translate:c}=o;n.move(s[e]),this._readCoordinates(a,c,t,i)}getOptimizedGeometry(e){const t=G();return this.getCoordinates(e,t),new k([],t)}getCentroid(e,{hasZ:t,hasM:i}){this.getCoordinates(e,v);const[n,o,s]=v,a=[n,o];return t&&(a[3]=s),i&&(a[t?4:3]=0),new k([],a)}getBounds(e){this.getCoordinates(e,v);const[t,i]=v,n=new ee;return n.minX=t,n.minY=i,n.maxX=t,n.maxY=i,n}getBoundingBox(e){this.getCoordinates(e,v);const[t,i,n]=v;return ge(t,i,n,t,i,n)}readAllObjectIds(e,t=0){const i=this._reader,{_index:n,featureCount:o}=this,{objectIdFieldName:s,attributeIndices:a,fieldsIndex:c}=n,m=c.get(s).index,l=c.fields.length;for(let d=0;d<o;++d){const u=a[d*l+m];i.move(u),e[t++]=L(i)}return t}readAllCoordinates(e,t=0){const i=this._reader,{transform:n,featureIndices:o}=this._index,{scale:s,translate:a}=n;for(const c of o)i.move(c),t=this._readCoordinates(s,a,e,t);return t}_readCoordinates([e,t,i],[n,o,s],a,c){const d=this._reader,u=d.getLength(),p=d.pos()+u;for(;d.pos()<p&&d.next();)switch(d.tag()){case 2:{const g=d.getLength(),_=d.pos()+g;for(;d.pos()<_&&d.next();)d.tag()===3?(d.getUInt32(),a[c++]=n+e*d.getSInt64(),a[c++]=o+t*d.getSInt64(),a[c++]=s+i*d.getSInt64()):d.skip();break}default:d.skip()}return c}}function qe(r){for(;r.next();){if(r.tag()===2)return Ve(r.getMessage());r.skip()}B()}function Ve(r){for(;r.next();){if(r.tag()===1)return Xe(r.getMessage());r.skip()}B()}function Xe(r){let l,d,u=!1,p=!1,g=0;const _=new Array,R=new Array,C=new Array;for(;r.next();)switch(r.tag()){case 1:d=r.getString();break;case 7:r.getEnum()!==0&&B();break;case 9:u=r.getBool()??!1;break;case 12:l=be(r.processMessage(Ce));break;case 13:{const x=r.processMessage(Re);x.index=g++,_.push(x);break}case 15:{R.push(r.pos());const x=r.getUInt32(),j=r.pos()+x;for(;r.pos()<j&&r.next();)r.tag()===1&&C.push(r.pos()),r.skip();break}case 10:p=r.getBool()??!1;break;default:r.skip()}const S=new Ie(_);return l!=null&&p&&d!=null&&S.has(d)||B(),{transform:l,exceededTransferLimit:u,fieldsIndex:S,objectIdFieldName:d,featureIndices:R,attributeIndices:C}}function B(){const r=new ae("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(r),r}function L(r){const l=r.getLength(),d=r.pos()+l;for(;r.pos()<d&&r.next();)switch(r.tag()){case 1:return r.getString();case 2:return r.getFloat();case 3:return r.getDouble();case 4:return r.getSInt32();case 5:return r.getUInt32();case 6:return r.getInt64();case 7:return r.getUInt64();case 8:return r.getSInt64();case 9:return r.getBool();default:return r.skip(),null}return null}const v=G(),V=8e3,Ze=4,He=4;let Ke=class{constructor(e,t,i,n,o){this.spatialReference=e,this.url=i,this.objectIdField=n,this.capabilities=o;const{supportsMaxRecordCountFactor:s,maxRecordCount:a}=this.capabilities.query,c=s?Ze:1,m=(a??V)*c;this._pageSize=Math.min(V,m);const l=t.clone();l.cacheHint=!0,l.resultType="tile",l.outSpatialReference=e,l.returnGeometry=!0,l.returnZ=!0,l.maxRecordCountFactor=c,l.num=this._pageSize,l.outFields=[n],this._baseQuery=l}async fetch(e,t){const{spatialReference:i}=this,n=pe(e.extent,i),o=this._baseQuery.clone();o.geometry=n;const s=new Array;let a=0,c=!1,m=1;for(;!c;){const l=[];for(let u=0;u<m;++u)l.push(this._fetchPage(o,a++,t));const d=await Promise.all(l);D(t);for(const u of d){const p=u.featureCount!==0;c||(c=!u.exceededTransferLimit||!p),p&&s.push(u)}m=Math.min(m+1,He)}return new ze(e,s)}async _fetchPage(e,t,i){const n=e.clone();n.start=t*this._pageSize;const o=(await fe(this.url,n,{signal:i})).data;return D(i),new Je(o)}},X=class{constructor(e){this._bufferWriter=null,this._bufferWriter=e.createBufferWriter()}createBuffer(e,t){const i=this._bufferWriter;let n=null;if(e.transformation&&t)Oe(T,e.transformation),T[12]-=t[0],T[13]-=t[1],T[14]-=t[2],n=T;else{if(t)throw new Error("not implemented");e.transformation&&(n=e.transformation)}let o=null;n&&(Ae($,T),Se($,$),o=$);const s=e.attributes,a=i.elementCount(s),c=i.vertexBufferLayout.stride/4;a>Math.floor(et/c)&&console.warn("geometry with very large number of elements encountered");const m=i.vertexBufferLayout.createBuffer(a);return i.write(n,o,s,e.objectAndLayerIdColor,m,0),{data:m.buffer,elementCount:a}}};const T=A(),$=A(),et=16777216/4;class tt{constructor(e){this._context=e,this._commands=[],this._transferables=new Set}createMaterial(e){const t=this._context,i=t.generateId("material");switch(e){case"default":{const n=new Be({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),o=new X(n);t.registerRenderGeometryBufferWriter(i,o)}break;case"hud":{const n=Ee(null,this._context.globalViewingMode)[0],o=new X(n);t.registerRenderGeometryBufferWriter(i,o)}}return this._commands.push({id:"create-material",type:e,materialId:i}),i}createDirectRenderer(e){const t=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:t,materialId:e}),t}addDirectRendererGeometry(e,t,i){const n=t.materialId,o=this._context.getRenderGeometryBufferWriter(n);if(o==null)throw new Error(`no bufferwriter found for material ${n}`);const s=o.createBuffer(t,i);this._transferables.add(s.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:e,materialId:n,renderGeometryBuffer:s,localOrigin:i})}removeDirectRendererGeometry(e){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:e})}createLodRenderer(e){const t=this._context.generateId("lod-renderer"),i={levels:e.levels.map(n=>({components:n.components.map(o=>{const s=o.attributes.get(f.POSITION);if(!s||s.indices.length===0)throw new Error("positions attribute expected");const a=3,c=ve(s.indices.length/a),m=new Me(c,a,s),l=this._context.getRenderGeometryBufferWriter(o.materialId);if(l==null)throw new Error("writer not found");const d=l.createBuffer(o,null);return this._transferables.add(d.data),{materialId:o.materialId,renderGeometryBuffer:d,boundingInfo:{bbMax:m.bbMax,bbMin:m.bbMin}}}),minScreenSpaceRadius:n.minScreenSpaceRadius}))};return this._commands.push({id:"create-lod-renderer",lodRendererId:t,lodRenderGeometry:i}),t}addLodInstances(e,t){this._commands.push({id:"add-lod-instances",lodRendererId:e,data:t}),this._transferables.add(t.featureIds.buffer),this._transferables.add(t.globalTransforms.buffer),this._transferables.add(t.localTransforms.buffer)}removeLodInstances(e,t){this._commands.push({id:"remove-lod-instances",lodRendererId:e,featureIds:t}),this._transferables.add(t.buffer)}async dispatch(){const e=this._commands,t=Array.from(this._transferables);this._clearCommandBuffer(),this._context.dispatchRenderCommands(e,t)}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}}class rt{constructor(e){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=async()=>{},this.globalViewingMode=!1,this.globalViewingMode=e.viewingMode===xe.Global,this._dispatchRenderCommandsCallback=e.dispatchRenderCommandsCallback}generateId(e=""){return`${e}${this._idCounter++}`}createEncoder(){return new tt(this)}async dispatchRenderCommands(e,t){this._dispatchRenderCommandsCallback(e,t)}registerRenderGeometryBufferWriter(e,t){this._bufferWriters.set(e,t)}getRenderGeometryBufferWriter(e){return this._bufferWriters.get(e)}}var h;(function(r){r[r.OBJECT_ID=0]="OBJECT_ID",r[r.PARTITION_ID=1]="PARTITION_ID",r[r.GEOMETRY_MAP_COORDINATES=2]="GEOMETRY_MAP_COORDINATES",r[r.GEOMETRY_RENDER_COORDINATES=3]="GEOMETRY_RENDER_COORDINATES",r[r.TILE_CENTER_RENDER_COORDINATES=4]="TILE_CENTER_RENDER_COORDINATES"})(h||(h={}));async function it(r,e){const{numFeatures:t,tile:i,partitionInfo:n}=r,{pages:o}=i;if(o.length===0||t===0)return new Uint32Array;const s=new Uint32Array(t);if(n){const a=o.reduce((d,{featureCount:u})=>d+u,0),c=new Uint32Array(a);let m=0;for(const d of o)m=d.readAllObjectIds(c,m);const l=n.tileIndices;for(let d=0;d<t;++d){const u=c[l[d]];s[d]=u}}else{let a=0;for(const c of o)a=c.readAllObjectIds(s,a)}return s}async function nt(r,e){const{numFeatures:t,tile:i,partitionInfo:n}=r,{pages:o}=i;if(o.length===0||t===0)return new Float64Array;const s=new Float64Array(3*t);if(n){const a=o.reduce((d,{featureCount:u})=>d+u,0),c=new Float64Array(3*a);let m=0;for(const d of o)m=d.readAllCoordinates(c,m);const l=n.tileIndices;for(let d=0;d<t;++d){const u=l[d],p=c[3*u+0],g=c[3*u+1],_=c[3*u+2];s[3*d+0]=p,s[3*d+1]=g,s[3*d+2]=_}}else{let a=0;for(const c of o)a=c.readAllCoordinates(s,a)}return s}async function ot(r,e){await r.provision([h.GEOMETRY_MAP_COORDINATES],e);const{numFeatures:t,tile:i,mapCoordinates:n}=r,{pages:o}=i;if(o.length===0||t===0)return new Float64Array;const s=e.viewSpatialReference,a=e.renderSpatialReference,c=new Float64Array(3*t);if(!Ne(n,s,0,c,a,0,t))throw new Error("Failed to project coordinates");return c}async function st(r,e){const t=e.viewSpatialReference,i=e.renderSpatialReference,n=r.tile.descriptor.extent,o=he(n),s=G();return Ge([o[0],o[1],0],t,s,i),s}let te=class{constructor(e,t,i=null){this._tile=e,this._numFeatures=t,this._partitionInfo=i}get partitionInfo(){return this._partitionInfo}get tile(){return this._tile}get numFeatures(){return this._numFeatures}get tileId(){return this._tile.descriptor.id}get objectIds(){if(this._objectIds==null)throw new Error("objectIds haven't been provisioned yet");return this._objectIds}get partitionIds(){if(this._partitionIds==null)throw new Error("partitionIds haven't been provisioned yet");return this._partitionIds}get mapCoordinates(){if(this._mapCoordinates==null)throw new Error("mapCoordinates haven't been provisioned yet");return this._mapCoordinates}get renderCoordinates(){if(this._renderCoordinates==null)throw new Error("renderCoordinates haven't been provisioned yet");return this._renderCoordinates}get tileCenterRenderCoordinates(){if(this._tileCenterRenderCoordinates==null)throw new Error("tileCenterRenderCoordinates hasn't been provisioned yet");return this._tileCenterRenderCoordinates}async provision(e,t){for(const i of e)switch(i){case h.OBJECT_ID:if(this._objectIds)return;this._objectIds=await it(this);break;case h.PARTITION_ID:if(this._partitionIds)return;this._partitionIds=new Uint32Array(this._numFeatures);break;case h.GEOMETRY_MAP_COORDINATES:if(this._mapCoordinates)return;this._mapCoordinates=await nt(this);break;case h.GEOMETRY_RENDER_COORDINATES:if(this._renderCoordinates)return;this._renderCoordinates=await ot(this,t);break;case h.TILE_CENTER_RENDER_COORDINATES:if(this._tileCenterRenderCoordinates)return;this._tileCenterRenderCoordinates=await st(this,t);break;default:throw new Error("not implemented")}}dispose(){if(this.partitions){for(const e of this.partitions)e.dispose();this.partitions=void 0}}};function re(r){const e=new Map;for(const[t,i]of r)e.set(t,{...i,indices:Te(i.indices)});return e}function at(r,e){const t=(i,n,o=!1)=>({levels:i.map(s=>{const a=re(n(s.tesselation));return o&&dt(a),{components:[{attributes:a,objectAndLayerIdColor:void 0,transformation:null,materialId:e}],minScreenSpaceRadius:s.minScreenSpaceRadius}})});switch(r){case"cone":return t(ct,i=>Qe(1,.5,i,!1),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function dt(r){const e=r,t=e.get(f.POSITION).data,i=e.get(f.NORMAL).data;if(i){const n=Z(r,f.NORMAL).data;for(let o=0;o<i.length;o+=3){const s=i[o+1];n[o+1]=-i[o+2],n[o+2]=s}}if(t){const n=Z(r,f.POSITION).data;for(let o=0;o<t.length;o+=3){const s=t[o+1];n[o+1]=-t[o+2],n[o+2]=s}}}function Z(r,e){let t=r.get(e);return t&&!t.exclusive&&(t={...t,exclusive:!0,data:De(t.data)},r.set(e,t)),t}const ct=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];let W=class extends Y{constructor(r){super(),this._context=r,this.lodRendererId=null,this._loaded=!1}get loaded(){return this._loaded}async load(r){const e=r.createMaterial("default"),t=at("cone",e);this.lodRendererId=r.createLodRenderer(t),this._loaded=!0}async add(r,e){if(this.lodRendererId==null)throw new Error("expected lod renderer id to not be null");await this._provisionFeatureData(r);const t=r.numFeatures,i=!0,n=we(Le("cone")),o=q(ye(n)),s=q(ke(o,{isPrimitive:i,width:100,depth:null,height:null})),a=new Float64Array(16*t),c=new Float64Array(16*t),m=r.mapCoordinates;for(let d=0;d<t;++d){const u=d,p=m[3*d+0],g=m[3*d+1],_=m[3*d+2],R=this._computeGlobalTransform(p,g,_,this._context.viewSpatialReference,mt),C=this._computeLocalTransform(s,o,lt);this._writeMatrixToTypedBuffer(a,u,C),this._writeMatrixToTypedBuffer(c,u,R)}const l={featureIds:new Uint32Array(r.objectIds),localTransforms:a,globalTransforms:c};e.addLodInstances(this.lodRendererId,l)}async remove(r,e){if(this.lodRendererId==null)return;const t=new Uint32Array(r.objectIds);e.removeLodInstances(this.lodRendererId,t)}async _provisionFeatureData(r){await r.provision([h.GEOMETRY_MAP_COORDINATES,h.OBJECT_ID],this._context)}_writeMatrixToTypedBuffer(r,e,t){let i=16*e;for(let n=0;n<16;n++)r[i++]=t[n]}_computeGlobalTransform(r,e,t,i,n){return F[0]=r,F[1]=e,F[2]=t,je(i,F,n,this._context.renderSpatialReference),n}_computeLocalTransform(r,e,t){return $e(t),this._applyObjectScale(r,e,t),t}_applyObjectScale(r,e,t){const i=Pe(r,r,e,this._context.renderCoordsHelper.unitInMeters);i[0]===1&&i[1]===1&&i[2]===1||Fe(t,t,i)}};W=w([N("esri.views.3d.layers.graphics.pipeline.symbolization.TestObjectSymbol")],W);const F=G(),lt=A(),mt=A();let U=class extends Y{constructor(r){super(),this._context=r,this.materialId=null,this._loaded=!1}get loaded(){return this._loaded}async load(r){this.materialId=r.createMaterial("hud"),r.createDirectRenderer(this.materialId),this._loaded=!0}async add(r,e){if(this.materialId==null)throw new Error("expected material not to be null");await this._provisionFeatureData(r);const{numFeatures:t,tileId:i,renderCoordinates:n,tileCenterRenderCoordinates:o}=r,s=new Float64Array([0,0,1]),a=new Float64Array([255,255,255,255]),c=new Float64Array([24,24]),m=new Float64Array([0,0,0,1]),l=new Float64Array([0,0]),d=new Float64Array([0]),u=new Uint32Array(t);for(let y=0;y<t;++y)u[y]=y;const p=new Uint32Array(t);for(let y=0;y<t;++y)p[y]=0;const g=new b(n,u,3,!0),_=new b(s,p,3,!0),R=new b(l,p,2,!0),C=new b(a,p,4,!0),S=new b(d,p,1,!0),x=new b(c,p,2,!0),j=new b(m,p,4,!0),ie=[[f.POSITION,g],[f.NORMAL,_],[f.UV0,R],[f.COLOR,C],[f.ROTATION,S],[f.SIZE,x],[f.CENTEROFFSETANDDISTANCE,j]],ne={attributes:re(ie),objectAndLayerIdColor:void 0,transformation:A(),materialId:this.materialId};e.addDirectRendererGeometry(i,ne,o)}async remove(r,e){e.removeDirectRendererGeometry(r.tileId)}async _provisionFeatureData(r){await r.provision([h.GEOMETRY_RENDER_COORDINATES,h.TILE_CENTER_RENDER_COORDINATES],this._context)}};U=w([N("esri.views.3d.layers.graphics.pipeline.symbolization.TestSymbol")],U);class ut{constructor(e){this._symbols=new Map,this._context=e}async load(){this._symbols.set(0,new U(this._context)),this._symbols.set(1,new W(this._context))}async add(e,t){await this._provisionFeatureData(e,this._context);const i=this._partition(e);await Promise.all(i.map(async n=>{var s;const o=await this._provisionSymbol((s=n.partitionInfo)==null?void 0:s.index,t);o&&await o.add(n,t)}))}async remove(e,t){const i=e.partitions;if(!i)throw new Error("partitioned featureset expected");await Promise.all(i.map(async n=>{var s;const o=await this._provisionSymbol((s=n.partitionInfo)==null?void 0:s.index,t);o&&await o.remove(n,t)}))}async _provisionFeatureData(e,t){await e.provision([h.PARTITION_ID,h.OBJECT_ID],t)}async _provisionSymbol(e,t){if(e==null)return null;const i=this._symbols.get(e);return i?(i.loaded||await i.load(t),i):null}_partition(e){const{numFeatures:t,objectIds:i,partitionIds:n}=e,o=[[],[]];for(let s=0;s<t;++s){const a=i[s]%2;o[a].push(s),n[s]=a}return e.partitions=o.filter(s=>s.length>0).map((s,a)=>{const c=s.length,m={index:a,tileIndices:new Uint32Array(s)};return new te(e.tile,c,m)}),e.partitions}}class pt{constructor(e){this._tileFeatureData=new Map,this._context={viewSpatialReference:e.viewSpatialReference,renderSpatialReference:e.renderSpatialReference,renderCoordsHelper:We.create(e.viewingMode,e.renderSpatialReference)}}async add(e,t){this._featureRenderer||(this._featureRenderer=new ut(this._context),await this._featureRenderer.load());const i=this._addTileFeatureData(e);await this._featureRenderer.add(i,t)}async remove(e,t){const i=this._getFeatureSetFromTileId(e);i&&(this._featureRenderer&&this._featureRenderer.remove(i,t),this._removeTileFeatureData(e))}_getFeatureSetFromTileId(e){return this._tileFeatureData.get(e)}_addTileFeatureData(e){const t=e.descriptor.id,i=e.pages.reduce((o,{featureCount:s})=>o+s,0),n=new te(e,i);return this._tileFeatureData.set(t,n),n}_removeTileFeatureData(e){const t=this._tileFeatureData.get(e);t&&(t.dispose(),this._tileFeatureData.delete(e))}}let M=class extends K.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureStore=new Ye,this._tileManager=new I({addTile:(r,e)=>this._addTile(r,e),removeTiles:r=>this._removeTiles(r)}),this._renderCommandContext=null,this._fetcher=null,this._symbolizer=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager.destroy()}async setup({viewSpatialReference:r,renderSpatialReference:e,viewingMode:t,baseQuery:i,url:n,objectIdField:o,capabilities:s,fieldsIndex:a,timeInfo:c}){this._renderCommandContext=new rt({viewingMode:t,dispatchRenderCommandsCallback:(d,u)=>this.remoteClient.invoke("dispatchRenderCommands",d,{transferList:u})});const m=z.fromJSON(r),l=z.fromJSON(e);return this._fetcher=new Ke(m,J.fromJSON(i),n,o,s),this._symbolizer=new pt({viewSpatialReference:m,renderSpatialReference:l,viewingMode:t}),this._queryEngine=new de({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:o,fieldsIndex:a,availableFields:[o],spatialReference:r,featureStore:this._featureStore,timeInfo:c}),this._defaultQueryJSON=new J({outSpatialReference:m}).toJSON(),this.addHandles(oe(()=>this.updating,async d=>{this.emit("notify-updating",{updating:d})}),se),H}async executeQuery(r,e){return{result:await this._queryEngine.executeQuery(this._ensureQuery(r),e)}}async executeQueryForIds(r,e){const t=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(r),e);return{result:Array.from(t)}}async executeQueryForCount(r,e){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(r),e)}}async executeQueryForExtent(r,e){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(r),e)}}async executeQueryForLatestObservations(r,e){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(r),e)}}async onTileTreeChange(r){return await this._tileManager.onTileTreeChange(r),H}async _addTile(r,e){const t=await this._fetcher.fetch(r,e);D(e),this._featureStore.addTile(t);const i=this._renderCommandContext.createEncoder();return await this._symbolizer.add(t,i),await i.dispatch(),t}async _removeTiles(r){const e=this._renderCommandContext.createEncoder(),t=this._featureStore,i=this._symbolizer;for(const n of r)t.removeTile(n.tileId),await i.remove(n.tileId,e);await e.dispatch()}_ensureQuery(r){return r??this._defaultQueryJSON}};w([O()],M.prototype,"updating",null),M=w([N("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],M);const Fn=M,H={result:void 0};export{Fn as default};
