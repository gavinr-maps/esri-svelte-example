import{r as n}from"./tslib.es6-B3Jf3DVX.js";import{b as q,ab as ft,q as V,X as Vt,l as Z}from"./Accessor-BLX9ikPh.js";import{m as l,a as H,n as z}from"./subclass-BZA_h8Db.js";import{s as bt}from"./AnalysisView3D-BBHxe6zf.js";import{h as nt}from"./SlicePlane-CdDvBULA.js";import{watch as y,sync as Mt,syncAndInitial as F}from"./reactiveUtils-C5zUhJQJ.js";import{W as d,Z as u,y as K,J as W}from"./boundedPlane-EV1sS2Ke.js";import J from"./Layer-CVt7Hb5J.js";import{A as Dt}from"./BuildingComponentSublayer-BK6r0wKX.js";import{x as Et,L as Ct,V as Tt,R as lt,I as St,H as xt,g as X,v as $t,j as ot,A as pt,l as Q,_ as Y,r as kt,s as Lt,M as S,e as Ht,C as f,c as ht,u as zt,m as Rt,p as Gt,a as Ot,b as ut,t as ct,d as At,f as It}from"./SlicePlaneMaterial.glsl-CvGYpiku.js";import{t as Bt}from"./LineVisualElement-mUtX7dGi.js";import{n as Ft}from"./compilerUtils-Dw3R0f-Z.js";import{c as Kt,g as Ut}from"./screenUtils-_ZIvrt5o.js";import{p as jt,d as dt,c as mt}from"./mat4-GpOFENPA.js";import{P as x,r as C,s as tt,g as R,u as it,E as et,A as at,o as yt}from"./vec32-Dvg_eL9J.js";import{t as Nt,n as U}from"./vec3f64-BLpZdpfb.js";import{t as qt,s as vt}from"./vec4f64-o2zAXfmz.js";import{V as st,c,M as j,x as L,O as G,a as T,t as Zt}from"./plane-IENfwZlB.js";import{b as Wt}from"./sphere-C77djCO6.js";import{l as Jt,n as Xt}from"./Factory-Bm3bRF5y.js";import{m as Qt,M as wt,r as O,t as A,p as Yt,f as ti,h as ii,j as ei}from"./sliceToolConfig-D0gkc1PF.js";import{b as ai}from"./RenderObject-CuwfmXYe.js";import{C as $}from"./dragEventPipeline3D-BzC_kbE1.js";import{m as M}from"./Compositing.glsl-DMM7CJmu.js";import{o as si}from"./ShadedColorMaterial.glsl-BhqCcqcp.js";import{p as k}from"./InteractiveToolBase-vg6J8uyT.js";import{t as ri}from"./ToolIntersector-LAq5Sd_3.js";import{n as D}from"./screenUtils-WcqhHU65.js";import{h as ni}from"./lineStippleUtils-C89mzWlO.js";import{a as li,v as oi}from"./analysisViewUtils-E34vvAuK.js";import"./Promise-B2Hu02L7.js";import"./geometry-D964gYQX.js";import"./Extent-Bf3YTe7m.js";import"./Point-Cg0-ChZE.js";import"./cast-Bjksrh93.js";import"./writer-DNAwXnhG.js";import"./assets-C43MgM-v.js";import"./index-Bh2oEzTI.js";import"./jsonMap-0cxwUWs2.js";import"./Polyline-D9YkgmM_.js";import"./mathUtils-C4_ghTv4.js";import"./Clonable-D3rtuBWg.js";import"./Cyclical-oTUX3aX7.js";import"./persistable-DjaiFmiM.js";import"./MD5-C9MwAd2G.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./uuid-fwrPAdZb.js";import"./resourceExtension-D8MnQ6oV.js";import"./persistableUrlUtils-fa1mAujs.js";import"./asyncUtils-CWX51uTe.js";import"./Collection-CEdjem1-.js";import"./Evented-BHRw9x22.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./mat4f64-Dk4dwAN8.js";import"./lineSegment-D7sKPPYf.js";import"./Identifiable-B1UbsKNt.js";import"./Loadable-BabW5Xcc.js";import"./TimeExtent-DocT5yPf.js";import"./timeUtils-8fb_2oAt.js";import"./date-DlqISzcw.js";import"./locale-C9TlLpzi.js";import"./Graphic-DsxsIjhH.js";import"./PopupTemplate-BHMhS05j.js";import"./fieldUtils-tmQlKvWo.js";import"./intl-CChhNOV8.js";import"./messages-OmQvZhAg.js";import"./enumeration-Ba5njXdz.js";import"./Color-BCS62Hs5.js";import"./colorUtils-0bJDPow9.js";import"./ActionToggle-iT4slXc7.js";import"./symbols-CNimns--.js";import"./TextSymbol-D8QO_KUV.js";import"./materialUtils-DarhapKC.js";import"./opacityUtils-C68Tlu6_.js";import"./aaBoundingBox-BE7cC1jD.js";import"./collectionUtils-D_lHIu88.js";import"./Portal-C10FKnaA.js";import"./jsonUtils-CEfjT-BK.js";import"./ClassBreaksRenderer-BuHwSyVK.js";import"./UniqueValueRenderer-BQtAHUSo.js";import"./diffUtils-BP7jmOAy.js";import"./colorRamps-pKd7I5WZ.js";import"./SizeVariable-936USOrb.js";import"./sizeVariableUtils-Cmcuvw-4.js";import"./visualVariableUtils-DX1kS9Se.js";import"./lengthUtils-DL1-FDQQ.js";import"./ColorStop-Dk3U5tCk.js";import"./jsonUtils-Ds2Sqto-.js";import"./layerUtils-BrNoooE9.js";import"./defaults-DZ1kfMRx.js";import"./defaultsJSON-GKolV7NZ.js";import"./RendererLegendOptions-B-4se3aU.js";import"./styleUtils-BYTm14n3.js";import"./jsonUtils-DxpLMo6d.js";import"./LRUCache-B_PHMSGm.js";import"./MemCache-Dx1v3xLC.js";import"./Version-BSlAgupz.js";import"./FieldsIndex-DpwHKAMX.js";import"./UnknownTimeZone-BkowvBs8.js";import"./OverrideHelper-ti072FkP.js";import"./colorUtils-aL8wj-8G.js";import"./vec42-YcqnINSP.js";import"./common-DQOJ18NT.js";import"./utils-D2PLyMFF.js";import"./enums-CmIX1y88.js";import"./quantizationUtils-uj_P09aO.js";import"./HeatmapColorStop-BJc5nbwr.js";import"./heatmapUtils-Dwiv9IEa.js";import"./SimpleRenderer-BV2L9G_n.js";import"./FeatureLayer-wa_7EIxE.js";import"./MultiOriginJSONSupport-B5nfqtQh.js";import"./layerContainerType-C5CzMsLd.js";import"./FeatureLayerBase-Ck7-w8TE.js";import"./formUtils-ylzKAM7E.js";import"./Field-ybkHhtnK.js";import"./fieldType-BuzM0UHS.js";import"./HeightModelInfo-9nOoV6LU.js";import"./arcgisLayerUrl-BX1FE5Hm.js";import"./commonProperties-CPyIG_-u.js";import"./ElevationInfo-CA5m_tHv.js";import"./unitConversionUtils-BMfW9yAe.js";import"./AttributeTableTemplate-BZeVyq-j.js";import"./featureLayerUtils-DBsQMhTm.js";import"./featureQueryAll-DnVoEjkM.js";import"./Query-5Xpquc1r.js";import"./DataLayerSource-BKkswDvG.js";import"./FullTextSearch-Csd1Hktu.js";import"./AttachmentQuery-BUlkjzkx.js";import"./RelationshipQuery-DPPNeuLK.js";import"./LayerFloorInfo-CIQjg5Vk.js";import"./Relationship-COPq3qM4.js";import"./serviceCapabilitiesUtils-DAE5z8FP.js";import"./workers-D4HfeYKj.js";import"./Queue-yu3bZ02p.js";import"./editsZScale-Bs7_pSzI.js";import"./queryZScale-w66xFVGx.js";import"./projection-B971H0Re.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";import"./FeatureSet-BHEkYP03.js";import"./APIKeyMixin-Di9kcRBS.js";import"./ArcGISService-B5qxetOY.js";import"./BlendLayer-CXM4n_Ge.js";import"./jsonUtils-CSnQD004.js";import"./parser-CTsgEym6.js";import"./utils-93yNk4Xc.js";import"./mat4f32-DcsiF_Rp.js";import"./CustomParametersMixin-B4u7wiBT.js";import"./EditBusLayer-DoTks2sU.js";import"./FeatureEffectLayer-CpM66wLd.js";import"./FeatureEffect-BEzQmzeC.js";import"./FeatureFilter-BMHRQSxq.js";import"./FeatureReductionLayer-Ddbk727V.js";import"./FeatureReductionSelection-7vaL4DYT.js";import"./labelingInfo-DYPSPZCH.js";import"./labelUtils-B8petyBk.js";import"./OperationalLayer-CVyVfSPu.js";import"./OrderedLayer-C5VLMHgA.js";import"./OrderByInfo-IYmS1EXF.js";import"./PortalLayer-CKja4bdW.js";import"./PortalItem-DzgXrpyc.js";import"./portalItemUtils-BzVoFAku.js";import"./RefreshableLayer-D7lXUJRS.js";import"./ScaleRangeLayer-Bb8Ig1Hz.js";import"./TemporalLayer-Dpq2hKKV.js";import"./TimeInfo-LUiaSFyX.js";import"./TimeInterval-CNlkea1s.js";import"./FeatureTemplate-CssMa1yk.js";import"./FeatureType-C0q_coeM.js";import"./fieldProperties-Cgxj08ZE.js";import"./versionUtils-CQ_WhYSP.js";import"./styleUtils-KMFBtb6u.js";import"./popupUtils-BBuPGAHd.js";import"./AlphaCutoff-UcccL64p.js";import"./interfaces-CL2NbQte.js";import"./capabilities-Y9lFlGVh.js";import"./I3SIndexInfo-CzWbq05q.js";import"./I3SLayerDefinitions-BZ_CeKMl.js";import"./I3SUtil-BALmNw_P.js";import"./projectVectorToVector-G2uWGoIb.js";import"./projectPointToVector-GINIbYMz.js";import"./I3SBinaryReader-D1r70N_w.js";import"./VertexAttribute-Cq4MnHjR.js";import"./computeTranslationToOriginAndRotation-Q27G6TBL.js";import"./edgeUtils-BUKTgPFR.js";import"./floatRGBA-CfH_2xsy.js";import"./DecodeSymbolColor.glsl-BPIX0fAF.js";import"./interfaces-DDtDqZYj.js";import"./Matrix3DrawUniform-CiBFaSz6.js";import"./BindType-BmZEZMMh.js";import"./Float4DrawUniform-N58YDhuZ.js";import"./orientedBoundingBox-DOAJUK5g.js";import"./mat3-BRl2i9Bz.js";import"./mat3f64-BBpwCtoL.js";import"./quat-4pa1e6ds.js";import"./quatf64-CCm9z-pX.js";import"./spatialReferenceEllipsoidUtils-DBE_OFra.js";import"./ViewingMode-Dodu7ZZk.js";import"./vec2f64-miziP1SN.js";import"./layerViewUtils-DhFEu8Rd.js";import"./popupUtils-BaLxn3kI.js";import"./sdfPrimitives-CUWZbMRe.js";import"./vec3f32-nZdmKIgz.js";import"./Texture-Fac_8AOC.js";import"./Util-BIfApRF5.js";import"./Material-_xx7OZxD.js";import"./Texture-Begq2x5n.js";import"./enums-D9v74xTE.js";import"./renderState-DQLu6AJX.js";import"./vec2-maR1OrZI.js";import"./ShaderTechniqueConfiguration-CBbn2DCi.js";import"./Indices-DflDlU4Z.js";import"./triangle-PTGDC_xJ.js";import"./requestImageUtils-DgMiQwsm.js";import"./doublePrecisionUtils-B0owpBza.js";import"./RibbonLine.glsl-BZu1FDpE.js";import"./dehydratedFeatureUtils-B--Sgpdi.js";import"./intersectorUtils-BK9EUwUf.js";import"./verticalOffsetUtils-BDQLpfho.js";import"./ElevationProvider-C95wyCKc.js";import"./hydratedFeatures-DBKLr8hT.js";import"./mathUtils-BG-eq9fO.js";import"./Octree-C8d4sqjv.js";import"./frustum-CQrOepbv.js";import"./InterleavedLayout-e-di2fxs.js";import"./BufferView-_QDXRCew.js";import"./interfaces-D6pIddIh.js";import"./ImageMaterial.glsl-toQN6zid.js";import"./VertexColor.glsl-_ARMpsAT.js";import"./DefaultLayouts-BuE1efcQ.js";import"./TriangleMaterial-BiHR3MKx.js";import"./Object3DVisualElement-BVfa8i_P.js";import"./VisualElement-Bz1W-x8t.js";import"./ShaderTechniqueRepository-hTzew41Z.js";import"./NestedMap-GuqgquCN.js";import"./RenderCoordsHelper-C50UGjbb.js";import"./projectVectorToPoint-DcLtSZYw.js";import"./ColorMaterial.glsl-BF1fDRqL.js";import"./line-CML3g7Ng.js";import"./elevationInfoUtils-BC_66_Fg.js";import"./MergedRenderer-Dli9s1X5.js";import"./VertexArrayObject-lPxPk5E-.js";import"./glUtil-D0YUa0ow.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./graphicUtils-CWEFaVJb.js";import"./meshVertexSpaceUtils-CXzOFlTI.js";import"./MeshLocalVertexSpace-LEHwMUnu.js";import"./Blit-B-VutIER.js";import"./EditGeometryOperations-Cl8Sbfxr.js";import"./geometry2dUtils-DdyQE7AQ.js";function pi(t){switch(t.type){case"building-scene":case"catalog":case"catalog-dynamic-group":case"catalog-footprint":case"csv":case"dimension":case"feature":case"focusArea":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"integrated-mesh-3dtiles":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"viewshed":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case"parquet":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"video":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return Ft(t.type),!1}}let _=class extends q{constructor(t){super(t),this._internalChange=!1,this._currentSlicePlane=null}initialize(){this.addHandles(this.analysis.excludedLayers.on("before-add",t=>{const i=t.item;i!=null&&(i instanceof J||i instanceof Dt)?i instanceof J&&pi(i)?(z.getLogger(this).error("excludedLayers",`Layer '${i.title}, id:${i.id}' of type '${i.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),t.preventDefault()):this.analysis.excludedLayers.includes(i)&&t.preventDefault():(z.getLogger(this).error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),t.preventDefault())})),ui(this.view,this),this.addHandles([y(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),y(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),y(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),y(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this.addHandles([y(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null,this._updateActiveController(),this._updateViewSlicePlane()),ci(this.view,this),this.set("view",null)}get _allLayerAndSubLayerViews(){const t=this.view.allLayerViews.items;return t.concat(t.filter(Et).flatMap(({sublayerViews:i})=>i.items))}_updateBoundedPlaneFromSlicePlane(){const t=this.analysis.shape,i=this._currentSlicePlane;if(i==null&&t==null||i!=null&&t!=null&&t.equals(i))return;let e=null,a=null;if((t==null?void 0:t.position)!=null){const s=t.position.spatialReference,r=Ct(t,this.view);r==null&&Bt(this.analysis,s,z.getLogger(this)),e=Tt(r,this.view,{tiltEnabled:this.analysis.tiltEnabled},d()),e!=null&&(a={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=e,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const t=this.analysisViewData.plane,i=lt(t,this.view,this.view.spatialReference,new nt);let e=null;i!=null&&(e={heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height}),this._currentSlicePlane=e,this._internalChange=!0,this.analysis.shape=i,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(I)return;const t=_t(this.view);if(t)if(this.analysisViewData.active)t.activeController!=null&&t.activeController!==this?(I=!0,t.activeController.analysisViewData.active=!1,I=!1):t.activeController!=null&&t.activeController,this._updateLayerViews(),t.activeController=this;else{if(t.activeController!=null&&t.activeController!==this)return;t.activeController!=null&&t.activeController===this&&(t.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){hi(this.view)}_updateLayerViews(){const t=this.analysisViewData.plane!=null&&this.analysisViewData.visible&&this.analysisViewData.active,i=[],e=a=>{"layers"in a?a.layers.forEach(e):i.push(a)};this.analysis.excludedLayers.forEach(e),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=t&&!i.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=t&&!i.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=t&&!this.analysis.excludeGroundSurface)}};n([l()],_.prototype,"view",void 0),n([l()],_.prototype,"analysis",void 0),n([l()],_.prototype,"analysisViewData",void 0),n([l()],_.prototype,"_allLayerAndSubLayerViews",null),_=n([H("esri.views.3d.analysis.Slice.SliceController")],_);const g=new Map;let I=!1;function hi(t){const i=_t(t),e=i==null?void 0:i.activeController;(e==null?void 0:e.analysisViewData.plane)!=null&&e.analysisViewData.visible?t.slicePlane=e.analysisViewData.plane:t.slicePlane=null}function ui(t,i){var e;g.has(t)||g.set(t,{all:[],activeController:null}),(e=g.get(t))==null||e.all.push(i)}function _t(t){return g.get(t)}function ci(t,i){if(!g.has(t))throw new Error("view expected in global slice register");const e=g.get(t),a=(e==null?void 0:e.all.lastIndexOf(i))??-1;if(!e||a===-1)throw new Error("controller expected in global slice register");e.all.splice(a,1),e.all.length===0&&g.delete(t)}var N;let h=N=class extends si{constructor(t){super(t),this._clock=ft,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this._layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._frameTask=null,this._pointerMoveTimerMs=Qt,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=d(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=Kt(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=ri(t.view.state.viewingMode)}initialize(){var p;if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");const t=o=>{this._updateManipulatorsInteractive(o),o.grabbing||(this.analysisViewData.plane!=null&&u(this.analysisViewData.plane,this._startPlane),this.inputState=null)},i=new St(this.view,xt.CENTER_ON_ARROW);this.shiftManipulator=i,this.manipulators.add(i),this.addHandles([this._createShiftDragPipeline(i),i.events.on("grab-changed",o=>{this._onShiftGrab(o),t(i)})]);const e=!((p=this.view._stage)!=null&&p.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result),a=new X(this.view,(o,v)=>Jt(this.view.textures,{accentColor:o,contrastColor:v,preMultiplyAlpha:e}));this.rotateHeadingManipulator=a,this.manipulators.add(a),this.addHandles([this._createRotateHeadingDragPipeline(a),a.events.on("grab-changed",o=>{this._onRotateHeadingGrab(o),t(a)})]);const s=new X(this.view,(o,v)=>Xt(this.view.textures,{accentColor:o,contrastColor:v,preMultiplyAlpha:e}));this.rotateTiltManipulator=s,this.manipulators.add(s),this.addHandles([this._createRotateTiltDragPipeline(s),s.events.on("grab-changed",o=>{this._onRotateTiltGrab(o),t(s)})]),this.resizeManipulators=this._resizeHandles.map((o,v)=>{const P=new $t(this.view,o);return this.addHandles([this._createResizeDragPipeline(P),P.events.on("grab-changed",b=>{this._onResizeGrab(b,v),t(P)})]),P}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=ot(this.view),this._previewPlaneOutlineVisualElement=pt(this.view),this._previewPlaneOutlineVisualElement.width=wt,this.addHandles(y(()=>[this.analysisViewData.plane,this.analysis.tiltEnabled],()=>this._updateManipulators(),Mt));const r=y(()=>this.state,o=>{o==="sliced"&&this.finishToolCreation()},F);this.addHandles([r,y(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=V(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=V(this._previewPlaneGridVisualElement)}get state(){const t=!!this.analysisViewData.plane,i=!!this.inputState;return t?t&&i?"slicing":t&&!i?"sliced":"ready":"ready"}get cursor(){return this._isPlacingSlicePlane||this.layersMode==="exclude"?"crosshair":this._creatingPointerId!=null?"grabbing":null}set analysis(t){if(t==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.removeHandles("analysis"),this._set("analysis",t)}get layersMode(){return this._layersMode}get inputState(){return this._get("inputState")}set inputState(t){this._set("inputState",t),this.analysisViewData.showGrid=t!=null&&t.type==="resize",this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.analysisViewData.plane&&this.active}get _creatingPointerId(){return this.inputState!=null&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){this.analysisViewData.plane!=null&&(this._layersMode="exclude",this.active||(this.view.activeTool=this))}exitExcludeLayerMode(){this.analysisViewData.plane!=null&&(this._layersMode="none",this.active&&(this.view.activeTool=null))}onDeactivate(){this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(t){this._updateManipulators(),t||this._clearPointerMoveTimeout()}onInputEvent(t){switch(t.type){case"pointer-drag":if(!B(t))return;this._isPlacingSlicePlane?this._onClickPlacePlane(t)&&t.stopPropagation():this._onPointerDrag(t)&&t.stopPropagation();break;case"pointer-move":this._onPointerMove(t);break;case"pointer-up":this._onPointerUp(t)&&t.stopPropagation();break;case"immediate-click":if(!B(t))return;this._onClickPlacePlane(t)&&t.stopPropagation();break;case"click":if(!B(t))return;this._onClickExcludeLayer(t)&&t.stopPropagation();break;case"drag":this.inputState&&t.stopPropagation();break;case"key-down":this._onKeyDown(t)&&t.stopPropagation();break;case"key-up":this._onKeyUp(t)&&t.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(t){const i=this.inputState;if(t.pointerId===this._creatingPointerId&&i!=null&&i.type==="shift"){const e=D(t);return this.shiftManipulator.events.emit("drag",{action:i.hasBeenDragged?"update":"start",pointerType:t.pointerType,start:e,screenPoint:e}),i.hasBeenDragged=!0,!0}return!1}_onPointerMove(t){this._lastCursorPosition.x=t.x,this._lastCursorPosition.y=t.y,this._resetPointerMoveTimeout(),t.pointerType!=="touch"&&this._updatePreviewPlane(D(t),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(t){if(t.pointerId===this._creatingPointerId&&this.analysisViewData.plane!=null){const i=D(t);return this.shiftManipulator.events.emit("drag",{action:"end",start:i,screenPoint:i}),u(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(t){if(this.layersMode==="exclude")return!1;if(this._isPlacingSlicePlane){const i=D(t),e=d();if(this._pickPlane(i,!1,this._activeKeyModifiers,e)){if(t.type==="pointer-drag"){const a=M(this.view.state.camera,i,E);this.inputState=rt(a,t.pointerId,e.origin,e)}return u(e,this._startPlane),this.analysis.shape=lt(e,this.view,this.view.spatialReference,new nt),!0}}return!1}_onClickExcludeLayer(t){return!(this.layersMode!=="exclude"||!this.created)&&(this.view.hitTest(D(t)).then(i=>{if(i.results.length){const e=i.results[0],a=(e==null?void 0:e.type)==="graphic"&&e.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else i.ground.layer?this.analysis.excludedLayers.push(i.ground.layer):this.analysis.excludeGroundSurface=!0}),this.exitExcludeLayerMode(),!0)}_onKeyDown(t){return(t.key===O||t.key===A)&&(this._activeKeyModifiers[t.key]=!0,this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(t){return!(t.key!==O&&t.key!==A||!this._activeKeyModifiers[t.key])&&(delete this._activeKeyModifiers[t.key],this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const i=M(this.view.state.camera,t.screenPoint,E);u(this.analysisViewData.plane,this._startPlane),this.inputState=rt(i,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(t){return k(t,(i,e,a)=>{const s=this.inputState;if(s==null||s.type!=="shift")return;const r=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;e.next($(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{r!=null&&this._updateBoundedPlane(r)})})}_shiftDragAdjustSensitivity(t){return i=>{if(this.analysisViewData.plane==null)return null;const e=.001,a=Math.min((1-Math.abs(x(K(this.analysisViewData.plane),i.ray.direction)/C(i.ray.direction)))/e,1),s=-st(this._startPlane.plane,i.renderEnd),r=-st(this._startPlane.plane,t.startPoint);return t.depth=t.depth*(1-a)+s*a-r,i}}_shiftDragUpdatePlane(t){return()=>{if(this.analysisViewData.plane==null)return;const i=tt(c.get(),this._startPlane.origin),e=tt(c.get(),K(this._startPlane));R(e,e,-t.depth),it(e,e,i);const a=W(e,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,d());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const i=Q(this.analysisViewData.plane,this.view.renderCoordsHelper,Y.HEADING,j()),e=M(this.view.state.camera,t.screenPoint,E),a=U();L(i,e,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:i,startPoint:a})}_createRotateHeadingDragPipeline(t){return k(t,(i,e,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const r=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;e.next($(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{r!=null&&this._updateBoundedPlane(r)})})}_onRotateTiltGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const i=Q(this.analysisViewData.plane,this.view.renderCoordsHelper,Y.TILT,j()),e=M(this.view.state.camera,t.screenPoint,E),a=U();L(i,e,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:i,startPoint:a})}_createRotateTiltDragPipeline(t){return k(t,(i,e,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const r=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;e.next($(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{r!=null&&this._updateBoundedPlane(r)})})}_rotateDragRenderPlaneToRotate(t){return i=>{if(this.analysisViewData.plane==null)return null;const e=G(t.rotatePlane),a=ai(t.startPoint,i.renderEnd,this.analysisViewData.plane.origin,e);return{...i,rotateAxis:e,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return t=>{if(this.analysisViewData.plane==null)return;const i=jt(T.get(),t.rotateAngle,t.rotateAxis);if(i==null)return;const e=et(c.get(),this._startPlane.basis1,i),a=et(c.get(),this._startPlane.basis2,i),s=W(this.analysisViewData.plane.origin,e,a,d());this._updateBoundedPlane(s)}}_onResizeGrab(t,i){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const e=M(this.view.state.camera,t.screenPoint,E),a=c.get();L(this.analysisViewData.plane.plane,e,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:i,startPoint:Nt(a)})}_createResizeDragPipeline(t){return k(t,(i,e,a)=>{const s=this.inputState;if(s==null||s.type!=="resize"||this.analysisViewData.plane==null)return;const r=u(this.analysisViewData.plane,d());e.next($(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(r)})})}_resizeDragUpdatePlane(t){return i=>{if(this.analysisViewData.plane==null)return;const e=this._resizeHandles[t.activeHandleIdx],a=kt(e,t.startPoint,i.renderEnd,this.view.state.camera,this._startPlane,u(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(t){const i=this.analysisViewData;if(i==null)throw new Error("valid internal object expected");i.plane=t}_updatePreviewPlane(t,i={}){let e=this._previewPlane;if(this._previewPlane=null,t==null)return this._removeFrameTask(),void this._updateManipulators();if(!this.analysisViewData.plane&&this.active){const a=e??d();if(e=e!=null?u(e,mi):null,this._pickPlane(t,!0,i,a)){const s=ti;let r=!1;e!=null&&(r=x(G(e.plane),G(a.plane))<s||x(at(c.get(),e.basis1),at(c.get(),a.basis1))<s),r&&(this._previewPlaneOpacity=0),this._previewPlane=a}}this._previewPlane!=null&&this._frameTask==null&&this._previewPlaneOpacity===0?this._frameTask=Vt({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*Yt),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):this._previewPlane==null&&this._frameTask!=null?this._removeFrameTask():this._previewPlane!=null&&this._updateManipulators()}_removeFrameTask(){this._frameTask=Z(this._frameTask)}_pickMinResult(t){const i=Ut(t,Zt.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector),this._intersector.results.min}_pickPlane(t,i,e,a){const s=this._pickMinResult(t),r=c.get();if(!s.getIntersectionPoint(r))return!1;const p=s.getTransformedNormal(c.get()),o=this.view.state.camera;x(p,o.viewForward)>0&&R(p,p,-1);const v=Lt(r,o),P=(i?1:-1)*v*ii,b=R(c.get(),p,P);it(b,b,r);const gt=this.analysis.tiltEnabled?S.TILTED:S.HORIZONTAL_OR_VERTICAL,Pt=e[O]?S.VERTICAL:e[A]?S.HORIZONTAL:gt;return Ht(b,p,v,v,o,Pt,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Z(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=f,this.rotateHeadingManipulator.state|=f,this.rotateTiltManipulator.state|=f,this._prevPointerMoveTimeout=this._clock.setTimeout(()=>{this.shiftManipulator.state&=~f,this.rotateHeadingManipulator.state&=~f,this.rotateTiltManipulator.state&=~f},this._pointerMoveTimerMs)}_updateManipulators(){if(N.disableEngineLayers)return;let t,i=!1;if(this.analysisViewData.plane!=null)t=this.analysisViewData.plane,i=!1;else{if(this._previewPlane==null)return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(p=>p.available=!1),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);t=this._previewPlane,i=!0}const e=ht(t,T.get());i?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(p=>p.available=!1),this._previewPlaneOutlineVisualElement.attached=!0,this._previewPlaneGridVisualElement.attached=!0,this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.analysis.tiltEnabled,this.resizeManipulators.forEach(p=>p.available=!0),zt(this.shiftManipulator,e,t,this.view.state.camera),Rt(this.rotateHeadingManipulator,e,t,this.view.renderCoordsHelper),Gt(this.rotateTiltManipulator,e,t),this.resizeManipulators.forEach((p,o)=>Ot(p,this._resizeHandles[o],e,t)),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=yt(c.get(),C(t.basis1),C(t.basis2),1),s=dt(T.get(),a),r=mt(s,e,s);this._previewPlaneOutlineVisualElement.transform=r,this._previewPlaneGridVisualElement.transform=r,this._updateMaterials()}_updateMaterials(){const t=ut(this.view.effectiveTheme);t[3]*=this._previewPlaneOpacity;const i=qt(ct);i[3]*=this._previewPlaneOpacity,this._previewPlaneOutlineVisualElement.color=t,this._previewPlaneGridVisualElement.backgroundColor=i,this._previewPlaneGridVisualElement.gridColor=vt}_updateManipulatorsInteractive(t){if(!t.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(i=>{i.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===t,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===t,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===t,this.resizeManipulators.forEach(i=>{i.interactive=i===t})}get test(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:t=>{this._pointerMoveTimerMs=t}}}};h.disableEngineLayers=!1,n([l()],h.prototype,"_clock",void 0),n([l({constructOnly:!0})],h.prototype,"view",void 0),n([l()],h.prototype,"analysisViewData",void 0),n([l({readOnly:!0})],h.prototype,"state",null),n([l({readOnly:!0})],h.prototype,"cursor",null),n([l()],h.prototype,"analysis",null),n([l()],h.prototype,"removeIncompleteOnCancel",void 0),n([l()],h.prototype,"_layersMode",void 0),n([l()],h.prototype,"layersMode",null),n([l({value:null})],h.prototype,"inputState",null),n([l()],h.prototype,"_isPlacingSlicePlane",null),n([l()],h.prototype,"_creatingPointerId",null),h=N=n([H("esri.views.3d.analysis.Slice.SliceTool")],h);const di=h;function rt(t,i,e,a){const s=At(e,K(a),t.direction,j()),r=U();return L(s,t,r)?{type:"shift",creatingPointerId:i,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:r}:null}function B(t){return t.pointerType!=="mouse"||t.button===0}const mi=d(),E=Wt();let w=class extends q{constructor(t){super(t),this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const t=this.analysisViewData;if(t==null)throw new Error("expected internal object to be valid");this._gridVisualElement=ot(this.view),this._outlineVisualElement=pt(this.view),this.addHandles([y(()=>{const i=t.plane!=null&&this.analysisViewData.visible,{active:e}=this.analysisViewData,{preview:a,showGrid:s,view:r}=this,{effectiveTheme:p}=r;return{visible:i,active:e,preview:a,showGrid:s,gridColor:It(p),outlineColor:ut(p)}},i=>this._updateMaterials(i),F),y(()=>t.plane,i=>this._updatePlane(i),F)],"internal")}destroy(){this._gridVisualElement=V(this._gridVisualElement),this._outlineVisualElement=V(this._outlineVisualElement),this.set("view",null)}_updatePlane(t){if(t==null)return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const i=yt(c.get(),C(t.basis1),C(t.basis2),1),e=dt(T.get(),i),a=ht(t,T.get()),s=mt(e,a,e);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:t,active:i,preview:e,showGrid:a,gridColor:s,outlineColor:r}){this._outlineVisualElement.color=r,this._outlineVisualElement.width=e?wt:ei,this._outlineVisualElement.stipplePattern=i?null:ni(5),this._gridVisualElement.backgroundColor=ct,this._gridVisualElement.gridColor=a?s:vt,this._gridVisualElement.visible=t,this._outlineVisualElement.visible=t}};n([l()],w.prototype,"view",void 0),n([l()],w.prototype,"analysis",void 0),n([l()],w.prototype,"analysisViewData",void 0),n([l()],w.prototype,"showGrid",void 0),n([l()],w.prototype,"preview",void 0),w=n([H("esri.views.3d.analysis.Slice.SliceVisualization")],w);let m=class extends bt(q){constructor(t){super(t),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0}initialize(){this.analysisVisualization=new w({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new _({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(li(this,di))}destroy(){oi(this),this.analysisVisualization=V(this.analysisVisualization),this.analysisController=V(this.analysisController)}get showGrid(){var t;return((t=this.analysisVisualization)==null?void 0:t.showGrid)??!1}set showGrid(t){this.analysisVisualization&&(this.analysisVisualization.showGrid=t)}get editable(){return!this.analysisVisualization.preview}set editable(t){this.analysisVisualization.preview=!t}get testData(){}};n([l({readOnly:!0})],m.prototype,"type",void 0),n([l({constructOnly:!0,nonNullable:!0})],m.prototype,"analysis",void 0),n([l()],m.prototype,"tool",void 0),n([l()],m.prototype,"plane",void 0),n([l()],m.prototype,"active",void 0),n([l()],m.prototype,"showGrid",null),n([l()],m.prototype,"editable",null),m=n([H("esri.views.3d.analysis.SliceAnalysisView3D")],m);const Jr=m;export{Jr as default};
