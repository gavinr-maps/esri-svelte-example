import{a as x}from"./BindType-BBwFZqyN.js";import{i as $,u as ye,b as St,e as L,a as R,n as de,o as yt,t as _e,H as Ye}from"./Matrix3PassUniform-uCCQMnlP.js";import{aR as bt,a0 as Ze,B as Je,aD as be,aO as wt,I as ue,aF as It,r as ne,s as et,aE as ie,as as se,D as Ne,a4 as Ot,a6 as Lt,l as Mt}from"./Accessor-BmwT4B0c.js";import{O as Dt,r as tt,e as re,t as Rt,p as Ut}from"./Material-C_-mgXN8.js";import{b as zt,w as ae,a as Nt,p as Ft}from"./Texture-BVJ22uHh.js";import{E as Vt,c as D,G as K,L as q,D as we,O,X as H,R as fe,I as v}from"./enums-D9v74xTE.js";import{B as Ht,g as Bt,o as kt,r as Gt,c as jt,p as Kt}from"./renderState-Ci93M1-P.js";import{t as it,O as Xt,u as X,s as V}from"./basicInterfaces-CZwQPxTp.js";import{o as Fe,r as Wt,e as he}from"./mat4f64-Dk4dwAN8.js";import{I as Ve,v as qt,o as P,u as w,g as F,W as Qt,E as Te,c as st}from"./vec32-Dvg_eL9J.js";import{t as Yt,o as Zt}from"./Indices-D8XWalpO.js";import{r as Jt,t as ei,n as b,_ as Le}from"./vec3f64-BLpZdpfb.js";import{s as W}from"./InterleavedLayout-_dYEAUNK.js";import{S as ti}from"./triangle-B1tKFm7z.js";import{e as S}from"./VertexAttribute-Cq4MnHjR.js";import{a as ii,i as oe}from"./ShaderTechniqueConfiguration-D4dZMCXS.js";import{o as si,n as ri,r as ni,c as ai,f as oi,i as xe,x as li,l as ci,m as ui}from"./mat4-Fi6iAz29.js";import{n as u,t as N}from"./glsl-BH37Aalp.js";import{c as rt}from"./NoParameters-t-PuNrgq.js";import{r as nt}from"./mathUtils-Cfq9PL9W.js";import{n as di}from"./mat3-CR8GKnhD.js";import{e as hi}from"./mat3f64-BBpwCtoL.js";import{m as He}from"./lengthUtils-_77UiyVF.js";import{i as Me,aq as fi,n as j}from"./opacityUtils-Dim20wpZ.js";import{i as mi}from"./Evented-Dw4_VOGn.js";import{n as pi,Z as Be,A as gi,ah as vi}from"./cast-CsZslgGN.js";import{t as _i}from"./requestImageUtils-DWgRKL5q.js";import{_ as Ti}from"./index-4eY77cms.js";import{_ as J}from"./TextureFormat-1mYWTFa-.js";import{o as xi}from"./vec2-ChnYg_BJ.js";import{n as Ai}from"./vec2f64-Dy6m9Nrb.js";let at=class{constructor(){this.uid=bt()}},Ei=class extends at{constructor(e){super(),this.highlightName=e,this.channel=it.Highlight}},vr=class extends at{constructor(){super(...arguments),this.channel=it.MaskOccludee}},$i=class extends ${constructor(e,i){super(e,"vec2",x.Bind,(s,r)=>s.setUniform2fv(e,i(r)))}};function Ci(t){t.uniforms.add(new $i("zProjectionMap",e=>Pi(e.camera))),t.code.add(u`float linearizeDepth(float depth) {
float depthNdc = depth * 2.0 - 1.0;
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
return -(c1 / (depthNdc + c2 + 1e-7));
}`),t.code.add(u`float depthFromTexture(sampler2D depthTexture, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
float depth = texelFetch(depthTexture, iuv, 0).r;
return depth;
}`),t.code.add(u`float linearDepthFromTexture(sampler2D depthTexture, vec2 uv) {
return linearizeDepth(depthFromTexture(depthTexture, uv));
}`)}function Pi(t){const e=t.projectionMatrix;return xi(Si,e[14],e[10])}const Si=Ai();let xr=class extends ${constructor(e,i){super(e,"float",x.Pass,(s,r,n)=>s.setUniform1f(e,i(r,n)))}},yi=class extends ${constructor(e,i){super(e,"sampler2D",x.Pass,(s,r,n)=>s.bindTexture(e,i(r,n)))}},$r=class{constructor(e,i){this._module=e,this._load=i}get(){return this._module}async reload(){return this._module=await this._load(),this._module}},ke=class{constructor(e,i,s){this._context=e,this._locations=s,this._textures=new Map,this._freeTextureUnits=new Ze({deallocator:null}),this._glProgram=e.programCache.acquire(i.generate("vertex",!0),i.generate("fragment",!0),s),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bind=i.generateBind(this),this.bindPass=i.generateBindPass(this),this.bindDraw=i.generateBindDraw(this),this._fragmentUniforms=zt()?i.fragmentUniforms:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,i){this._glProgram.setUniform1i(e,i?1:0)}setUniform1i(e,i){this._glProgram.setUniform1i(e,i)}setUniform1f(e,i){this._glProgram.setUniform1f(e,i)}setUniform2fv(e,i){this._glProgram.setUniform2fv(e,i)}setUniform3fv(e,i){this._glProgram.setUniform3fv(e,i)}setUniform4fv(e,i){this._glProgram.setUniform4fv(e,i)}setUniformMatrix3fv(e,i){this._glProgram.setUniformMatrix3fv(e,i)}setUniformMatrix4fv(e,i){this._glProgram.setUniformMatrix4fv(e,i)}setUniform1fv(e,i){this._glProgram.setUniform1fv(e,i)}setUniform1iv(e,i){this._glProgram.setUniform1iv(e,i)}setUniform2iv(e,i){this._glProgram.setUniform2iv(e,i)}setUniform3iv(e,i){this._glProgram.setUniform3iv(e,i)}setUniform4iv(e,i){this._glProgram.setUniform4iv(e,i)}assertCompatibleVertexAttributeLocations(e){e.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(e,i){if((i==null?void 0:i.glName)==null){const r=this._textures.get(e);return r&&(this._context.bindTexture(null,r.unit),this._freeTextureUnit(r),this._textures.delete(e)),null}let s=this._textures.get(e);return s==null?(s=this._allocTextureUnit(i),this._textures.set(e,s)):s.texture=i,this._context.useProgram(this),this.setUniform1i(e,s.unit),this._context.bindTexture(i,s.unit),s.unit}rebindTextures(){var e;this._context.useProgram(this),this._textures.forEach((i,s)=>{this._context.bindTexture(i.texture,i.unit),this.setUniform1i(s,i.unit)}),(e=this._fragmentUniforms)==null||e.forEach(i=>{i.type!=="sampler2D"&&i.type!=="samplerCube"||this._textures.has(i.name)||console.error(`Texture sampler ${i.name} has no bound texture`)})}_allocTextureUnit(e){return{texture:e,unit:this._freeTextureUnits.length===0?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(e){this._freeTextureUnits.push(e.unit)}};const bi=()=>Je.getLogger("esri.views.3d.webgl.ShaderTechnique");let Sr=class{constructor(e,i,s,r=Dt){this.locations=r,this.primitiveType=Vt.TRIANGLES,this.key=i.key,this._program=new ke(e.rctx,s.get().build(i),r),this._pipeline=this.initializePipeline(i),this.reload=async n=>{n&&await s.reload(),this.key.equals(i.key)||bi().warn("Configuration was changed after construction, cannot reload shader.",s),be(this._program),this._program=new ke(e.rctx,s.get().build(i),r),this._pipeline=this.initializePipeline(i)}}destroy(){this._program=be(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}getPipeline(e,i){return this._pipeline}initializePipeline(e){return Ht({blending:kt,colorWrite:Bt})}},br=class extends ${constructor(e,i){super(e,"vec4",x.Bind,(s,r)=>s.setUniform4fv(e,i(r)))}},Ie=class extends ${constructor(e,i){super(e,"sampler2D",x.Bind,(s,r)=>s.bindTexture(e,i(r)))}},wi=class extends ${constructor(e,i){super(e,"vec3",x.Bind,(s,r)=>s.setUniform3fv(e,i(r)))}},Lr=class extends ${constructor(e,i){super(e,"vec4",x.Pass,(s,r,n)=>s.setUniform4fv(e,i(r,n)))}},Ii=class extends ${constructor(e,i){super(e,"float",x.Bind,(s,r)=>s.setUniform1f(e,i(r)))}};var I;function Oi(t,e){switch(e.textureCoordinateType){case I.Default:return t.attributes.add(S.UV0,"vec2"),t.varyings.add("vuv0","vec2"),void t.vertex.code.add(u`void forwardTextureCoordinates() {
vuv0 = uv0;
}`);case I.Compressed:return t.attributes.add(S.UV0,"vec2"),t.varyings.add("vuv0","vec2"),void t.vertex.code.add(u`vec2 getUV0() {
return uv0 / 16384.0;
}
void forwardTextureCoordinates() {
vuv0 = getUV0();
}`);case I.Atlas:return t.attributes.add(S.UV0,"vec2"),t.varyings.add("vuv0","vec2"),t.attributes.add(S.UVREGION,"vec4"),t.varyings.add("vuvRegion","vec4"),void t.vertex.code.add(u`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);default:wt(e.textureCoordinateType);case I.None:return void t.vertex.code.add(u`void forwardTextureCoordinates() {}`);case I.COUNT:return}}(function(t){t[t.None=0]="None",t[t.Default=1]="Default",t[t.Atlas=2]="Atlas",t[t.Compressed=3]="Compressed",t[t.COUNT=4]="COUNT"})(I||(I={}));function Li(t){t.fragment.code.add(u`vec4 textureAtlasLookup(sampler2D tex, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
return textureGrad(tex, uvAtlas, dUVdx, dUVdy);
}`)}function Mi(t,e){const{textureCoordinateType:i}=e;if(i===I.None||i===I.COUNT)return;t.include(Oi,e);const s=i===I.Atlas;s&&t.include(Li),t.fragment.code.add(u`
    vec4 textureLookup(sampler2D tex, vec2 uv) {
      return ${s?"textureAtlasLookup(tex, uv, vuvRegion)":"texture(tex, uv)"};
    }
  `)}let Rr=class{constructor(e){this._material=e.material,this._techniques=e.techniques,this._output=e.output}dispose(){}get _stippleTextures(){return this._techniques.context.stippleTextures}get _markerTextures(){return this._techniques.context.markerTextures}getTechnique(e,i){return this._techniques.get(e,this._material.getConfiguration(this._output,i))}ensureResources(e){return Xt.LOADED}};function zr(t){const e=3.141592653589793,i=.3183098861837907;t.vertex.constants.add("PI","float",e),t.fragment.constants.add("PI","float",e),t.fragment.constants.add("LIGHT_NORMALIZATION","float",i),t.fragment.constants.add("INV_PI","float",i),t.fragment.constants.add("HALF_PI","float",1.570796326794897),t.fragment.constants.add("TWO_PI","float",6.28318530717958)}function Di(t){const{fragment:e}=t;e.code.add(u`uint readChannelBits(uint channel, int highlightLevel) {
int llc = (highlightLevel & 3) << 1;
return (channel >> llc) & 3u;
}
uint readChannel(vec2 texel, int highlightLevel) {
int lic = (highlightLevel >> 2) & 1;
return uint(texel[lic] * 255.0);
}
uint readLevelBits(vec2 texel, int highlightLevel) {
return readChannelBits(readChannel(texel, highlightLevel), highlightLevel);
}`)}let Ri=class extends ${constructor(e,i){super(e,"int",x.Bind,(s,r)=>s.setUniform1i(e,i(r)))}};function Ui(t){if(t.length<ue)return Array.from(t);if(Array.isArray(t))return Float64Array.from(t);if(!("BYTES_PER_ELEMENT"in t))return Array.from(t);switch(t.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(t);case 2:return It(t)?Uint16Array.from(t):Int16Array.from(t);case 4:return Float32Array.from(t);default:return Float64Array.from(t)}}let zi=class ot{constructor(e,i,s){this.primitiveIndices=e,this._numIndexPerPrimitive=i,this.position=s,this._children=void 0,W(e.length>=1),W(s.size===3||s.size===4);const{data:r,size:n,indices:a}=s;W(a.length%this._numIndexPerPrimitive==0),W(a.length>=e.length*this._numIndexPerPrimitive);const o=e.length;let c=n*a[this._numIndexPerPrimitive*e[0]];B.clear(),B.push(c);const d=Jt(r[c],r[c+1],r[c+2]),l=ei(d);for(let f=0;f<o;++f){const m=this._numIndexPerPrimitive*e[f];for(let E=0;E<this._numIndexPerPrimitive;++E){c=n*a[m+E],B.push(c);let T=r[c];d[0]=Math.min(T,d[0]),l[0]=Math.max(T,l[0]),T=r[c+1],d[1]=Math.min(T,d[1]),l[1]=Math.max(T,l[1]),T=r[c+2],d[2]=Math.min(T,d[2]),l[2]=Math.max(T,l[2])}}this.bbMin=d,this.bbMax=l;const h=Ve(b(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(l[0]-d[0],l[1]-d[1]),l[2]-d[2]);let A=this.radius*this.radius;for(let f=0;f<B.length;++f){c=B.at(f);const m=r[c]-h[0],E=r[c+1]-h[1],T=r[c+2]-h[2],k=m*m+E*E+T*T;if(k<=A)continue;const Y=Math.sqrt(k),Z=.5*(Y-this.radius);this.radius=this.radius+Z,A=this.radius*this.radius;const G=Z/Y;h[0]+=m*G,h[1]+=E*G,h[2]+=T*G}this.center=h,B.clear()}getChildren(){if(this._children||qt(this.bbMin,this.bbMax)<=1)return this._children;const e=Ve(b(),this.bbMin,this.bbMax,.5),i=this.primitiveIndices.length,s=new Uint8Array(i),r=new Array(8);for(let l=0;l<8;++l)r[l]=0;const{data:n,size:a,indices:o}=this.position;for(let l=0;l<i;++l){let h=0;const A=this._numIndexPerPrimitive*this.primitiveIndices[l];let f=a*o[A],m=n[f],E=n[f+1],T=n[f+2];for(let k=1;k<this._numIndexPerPrimitive;++k){f=a*o[A+k];const Y=n[f],Z=n[f+1],G=n[f+2];Y<m&&(m=Y),Z<E&&(E=Z),G<T&&(T=G)}m<e[0]&&(h|=1),E<e[1]&&(h|=2),T<e[2]&&(h|=4),s[l]=h,++r[h]}let c=0;for(let l=0;l<8;++l)r[l]>0&&++c;if(c<2)return;const d=new Array(8);for(let l=0;l<8;++l)d[l]=r[l]>0?new Uint32Array(r[l]):void 0;for(let l=0;l<8;++l)r[l]=0;for(let l=0;l<i;++l){const h=s[l];d[h][r[h]++]=this.primitiveIndices[l]}this._children=new Array;for(let l=0;l<8;++l)d[l]!==void 0&&this._children.push(new ot(d[l],this._numIndexPerPrimitive,this.position));return this._children}static prune(){B.prune()}};const B=new Ze({deallocator:null});function Ni(t,e){if(!t)return!1;const{size:i,data:s,indices:r}=t;P(e,0,0,0),P(C,0,0,0);let n=0,a=0;for(let o=0;o<r.length-2;o+=3){const c=r[o]*i,d=r[o+1]*i,l=r[o+2]*i;P(p,s[c],s[c+1],s[c+2]),P(M,s[d],s[d+1],s[d+2]),P(me,s[l],s[l+1],s[l+2]);const h=ti(p,M,me);h?(w(p,p,M),w(p,p,me),F(p,p,1/3*h),w(e,e,p),n+=h):(w(C,C,p),w(C,C,M),w(C,C,me),a+=3)}return(a!==0||n!==0)&&(n!==0?(F(e,e,1/n),!0):a!==0&&(F(e,C,1/a),!0))}function Fi(t,e){if(!t)return!1;const{size:i,data:s,indices:r}=t;P(e,0,0,0);let n=-1,a=0;for(let o=0;o<r.length;o++){const c=r[o]*i;n!==c&&(e[0]+=s[c],e[1]+=s[c+1],e[2]+=s[c+2],a++),n=c}return a>1&&F(e,e,1/a),a>0}function Vi(t,e,i){if(!t)return!1;P(i,0,0,0),P(C,0,0,0);let s=0,r=0;const{size:n,data:a,indices:o}=t,c=o.length-1,d=c+(e?2:0);for(let l=0;l<d;l+=2){const h=l<c?l+1:0,A=o[l<c?l:c]*n,f=o[h]*n;p[0]=a[A],p[1]=a[A+1],p[2]=a[A+2],M[0]=a[f],M[1]=a[f+1],M[2]=a[f+2],F(p,w(p,p,M),.5);const m=Qt(p,M);m>0?(w(i,i,F(p,p,m)),s+=m):s===0&&(w(C,C,p),r++)}return s!==0?(F(i,i,1/s),!0):r!==0&&(F(i,C,1/r),!0)}const p=b(),M=b(),me=b(),C=b();let Fr=class lt extends tt{constructor(e,i,s=null,r=re.Mesh,n=null,a=-1){super(),this.material=e,this.mapPositions=s,this.type=r,this.objectAndLayerIdColor=n,this.edgeIndicesLength=a,this.highlights=new Set,this._highlightOptionsCounts=new Map,this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[o,c]of i)this._attributes.set(o,{...c,indices:Yt(c.indices)}),o===S.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(o).indices.length:this.edgeIndicesLength)}instantiate(e={}){const i=new lt(e.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach((s,r)=>{s.exclusive=!1,i._attributes.set(r,s)}),i._boundingInfo=this._boundingInfo,i.transformation=e.transformation||this.transformation,i}get attributes(){return this._attributes}getMutableAttribute(e){let i=this._attributes.get(e);return i&&!i.exclusive&&(i={...i,exclusive:!0,data:Ui(i.data)},this._attributes.set(e,i)),i}setAttributeData(e,i){const s=this._attributes.get(e);s&&this._attributes.set(e,{...s,exclusive:!0,data:i})}get indexCount(){var i;const e=(i=this._attributes.values().next().value)==null?void 0:i.indices;return(e==null?void 0:e.length)??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo==null&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(e){return!!(this.type===re.Mesh?this._computeAttachmentOriginTriangles(e):this.type===re.Line?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(this._transformation!=null&&Te(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){const i=this.attributes.get(S.POSITION);return Ni(i,e)}_computeAttachmentOriginLines(e){const i=this.attributes.get(S.POSITION);return Vi(i,Hi(this.material.parameters,i),e)}_computeAttachmentOriginPoints(e){const i=this.attributes.get(S.POSITION);return Fi(i,e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.attributes.get(S.POSITION);if(!e||e.indices.length===0)return null;const i=this.type===re.Mesh?3:1;W(e.indices.length%i==0,"Indexing error: "+e.indices.length+" not divisible by "+i);const s=Zt(e.indices.length/i);return new zi(s,i,e)}get transformation(){return this._transformation??Fe}set transformation(e){this._transformation=e&&e!==Fe?Wt(e):null}get highlightNames(){return this._highlightOptionsCounts}get hasHighlights(){return this._highlightOptionsCounts.size>0}foreachHighlightOptions(e){this._highlightOptionsCounts.forEach((i,s)=>e(s))}allocateIdAndHighlight(e){const i=new Ei(e);return this.addHighlight(i)}addHighlight(e){this.highlights.add(e);const{highlightName:i}=e,s=(this._highlightOptionsCounts.get(i)??0)+1;return this._highlightOptionsCounts.set(i,s),e}removeHighlight(e){if(this.highlights.delete(e)){const{highlightName:i}=e,s=this._highlightOptionsCounts.get(i)??0;s<=1?this._highlightOptionsCounts.delete(i):this._highlightOptionsCounts.set(i,s-1)}}};function Hi(t,e){return!(!("isClosed"in t)||!t.isClosed)&&e.indices.length>2}var Ge;(function(t){t[t.INTEGRATED_MESH=0]="INTEGRATED_MESH",t[t.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",t[t.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",t[t.OPAQUE_MATERIAL_WITHOUT_NORMALS=3]="OPAQUE_MATERIAL_WITHOUT_NORMALS",t[t.TRANSPARENT_MATERIAL=4]="TRANSPARENT_MATERIAL",t[t.TRANSPARENT_MATERIAL_WITHOUT_NORMALS=5]="TRANSPARENT_MATERIAL_WITHOUT_NORMALS",t[t.TRANSPARENT_TERRAIN=6]="TRANSPARENT_TERRAIN",t[t.TRANSPARENT_MATERIAL_WITHOUT_DEPTH=7]="TRANSPARENT_MATERIAL_WITHOUT_DEPTH",t[t.OCCLUDED_TERRAIN=8]="OCCLUDED_TERRAIN",t[t.OCCLUDER_MATERIAL=9]="OCCLUDER_MATERIAL",t[t.TRANSPARENT_OCCLUDER_MATERIAL=10]="TRANSPARENT_OCCLUDER_MATERIAL",t[t.OCCLUSION_PIXELS=11]="OCCLUSION_PIXELS",t[t.HUD_MATERIAL=12]="HUD_MATERIAL",t[t.LABEL_MATERIAL=13]="LABEL_MATERIAL",t[t.LINE_CALLOUTS=14]="LINE_CALLOUTS",t[t.LINE_CALLOUTS_HUD_DEPTH=15]="LINE_CALLOUTS_HUD_DEPTH",t[t.OVERLAY=16]="OVERLAY",t[t.DRAPED_MATERIAL=17]="DRAPED_MATERIAL",t[t.DRAPED_WATER=18]="DRAPED_WATER",t[t.VOXEL=19]="VOXEL",t[t.MAX_SLOTS=20]="MAX_SLOTS"})(Ge||(Ge={}));var _,je;(function(t){t[t.Undefined=0]="Undefined",t[t.DefinedSize=1]="DefinedSize",t[t.DefinedScale=2]="DefinedScale"})(_||(_={})),function(t){t[t.Undefined=0]="Undefined",t[t.DefinedAngle=1]="DefinedAngle"}(je||(je={}));let De=class{constructor(e){this.field=e}},Bi=class extends De{constructor(e){super(e),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[_.Undefined,_.Undefined,_.Undefined]}};class ki extends De{constructor(e){super(e),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0]}}let Gi=class extends De{constructor(e){super(e),this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}},ji=class{};function ee(t){return t!=null}function Ki(t,e,i,s=he()){const r=t||0,n=e||0,a=i||0;return r!==0&&li(s,s,-r/180*Math.PI),n!==0&&ci(s,s,n/180*Math.PI),a!==0&&ui(s,s,a/180*Math.PI),s}function U(t,e,i,s,r){var o;const n=t.minSize,a=t.maxSize;if(t.useSymbolValue){const c=s.symbolSize[i];return e.minSize[i]=c,e.maxSize[i]=c,e.offset[i]=e.minSize[i],e.factor[i]=0,e.type[i]=_.DefinedSize,!0}if(ee(t.field))return ee(t.stops)?t.stops.length===2&&j(t.stops[0].size)&&j(t.stops[1].size)?(Ke(t.stops[0].size,t.stops[1].size,t.stops[0].value,t.stops[1].value,e,i),e.type[i]=_.DefinedSize,!0):!1:j(n)&&j(a)&&ee(t.minDataValue)&&ee(t.maxDataValue)?(Ke(n,a,t.minDataValue,t.maxDataValue,e,i),e.type[i]=_.DefinedSize,!0):t.valueUnit==="unknown"?!1:He[t.valueUnit]!=null?(e.minSize[i]=-1/0,e.maxSize[i]=1/0,e.offset[i]=0,e.factor[i]=1/He[t.valueUnit],e.type[i]=_.DefinedSize,!0):!1;if(!ee(t.field)){if((o=t.stops)!=null&&o[0]&&j(t.stops[0].size))return e.minSize[i]=t.stops[0].size,e.maxSize[i]=t.stops[0].size,e.offset[i]=e.minSize[i],e.factor[i]=0,e.type[i]=_.DefinedSize,!0;if(j(n))return e.minSize[i]=n,e.maxSize[i]=n,e.offset[i]=n,e.factor[i]=0,e.type[i]=_.DefinedSize,!0}return!1}function Ke(t,e,i,s,r,n){const a=Math.abs(s-i)>0?(e-t)/(s-i):0;r.minSize[n]=a>0?t:e,r.maxSize[n]=a>0?e:t,r.offset[n]=t-i*a,r.factor[n]=a}function Xi(t,e,i,s){if(t.normalizationField||t.valueRepresentation||!fi(t.field))return null;if(e.size){if(t.field)if(e.size.field){if(t.field!==e.size.field)return null}else e.size.field=t.field}else e.size=new Bi(t.field);let r;switch(t.axis){case"width":return r=U(t,e.size,0,i),r?e:null;case"height":return r=U(t,e.size,2,i),r?e:null;case"depth":return r=U(t,e.size,1,i),r?e:null;case"width-and-depth":return r=U(t,e.size,0,i),r&&U(t,e.size,1,i),r?e:null;case null:case void 0:case"all":return r=U(t,e.size,0,i),r=r&&U(t,e.size,1,i),r=r&&U(t,e.size,2,i),r?e:null;default:return`${t.axis}`,null}}function Wi(t,e,i){for(let r=0;r<3;++r){let n=e.unitInMeters;t.type[r]===_.DefinedSize&&(n*=e.modelSize[r],t.type[r]=_.DefinedScale),t.minSize[r]=t.minSize[r]/n,t.maxSize[r]=t.maxSize[r]/n,t.offset[r]=t.offset[r]/n,t.factor[r]=t.factor[r]/n}let s;if(t.type[0]!==_.Undefined)s=0;else if(t.type[1]!==_.Undefined)s=1;else{if(t.type[2]===_.Undefined)return!1;s=2}for(let r=0;r<3;++r)t.type[r]===_.Undefined&&(t.minSize[r]=t.minSize[s],t.maxSize[r]=t.maxSize[s],t.offset[r]=t.offset[s],t.factor[r]=t.factor[s],t.type[r]=t.type[s]);return!0}function Xe(t,e,i){t[4*e]=i.r/255,t[4*e+1]=i.g/255,t[4*e+2]=i.b/255,t[4*e+3]=i.a}function qi(t,e,i){if(t.normalizationField)return null;if(Me(t.field)){if(!t.stops)return null;{if(t.stops.length>8)return null;e.color=new ki(t.field);const s=t.stops;for(let r=0;r<8;++r){const n=s[Math.min(r,s.length-1)];e.color.values[r]=n.value,Xe(e.color.colors,r,n.color)}}}else{if(!(t.stops&&t.stops.length>=0))return null;{const s=t.stops&&t.stops.length>=0&&t.stops[0].color;e.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let r=0;r<8;r++)e.color.values[r]=1/0,Xe(e.color.colors,r,s)}}return e}function Qi(t,e,i){if(t.normalizationField)return null;if(Me(t.field)){if(!t.stops)return null;{if(t.stops.length>8)return null;e.opacity=new Gi(t.field);const s=t.stops;for(let r=0;r<8;++r){const n=s[Math.min(r,s.length-1)];e.opacity.values[r]=n.value,e.opacity.opacityValues[r]=n.opacity}}}else{if(!(t.stops&&t.stops.length>=0))return null;{const s=t.stops&&t.stops.length>=0?t.stops[0].opacity:0;e.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let r=0;r<8;r++)e.opacity.values[r]=1/0,e.opacity.opacityValues[r]=s}}return e}function Ce(t,e,i){const s=i===2&&t.rotationType==="arithmetic";e.offset[i]=s?90:0,e.factor[i]=s?-1:1,e.type[i]=1}function Yi(t,e,i){if(!Me(t.field))return null;if(e.rotation){if(t.field)if(e.rotation.field){if(t.field!==e.rotation.field)return null}else e.rotation.field=t.field}else e.rotation={field:t.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(t.axis){case"tilt":return Ce(t,e.rotation,0),e;case"roll":return Ce(t,e.rotation,1),e;case null:case void 0:case"heading":return Ce(t,e.rotation,2),e;default:return`${t.axis}`,null}}class Gr{constructor(e,i=[1,1,1],s=[1,1,1],r=1,n=[0,0,0],a=[1,1,1],o=[0,0,0]){this.supports=e,this.modelSize=i,this.symbolSize=s,this.unitInMeters=r,this.anchor=n,this.scale=a,this.rotation=o}}function ct(t,e,i){if(!t)return null;const s=t.reduce((r,n)=>{if(!r)return r;if(n.valueExpression)return null;switch(n.type){case"size":return e.supports.size?Xi(n,r,e,i):r;case"color":return e.supports.color?qi(n,r):r;case"opacity":return e.supports.opacity?Qi(n,r):null;case"rotation":return e.supports.rotation?Yi(n,r,i):r;default:return null}},new ji);return!(t.length>0&&s)||s.size||s.color||s.opacity||s.rotation?s!=null&&s.size&&!Wi(s.size,e)?null:s:null}class Zi{constructor(e,i,s){this.visualVariables=e,this.materialParameters=i,this.requiresShaderTransformation=s}}function jr(t,e){if(!t||Rt.TESTS_DISABLE_FAST_UPDATES)return null;const i=ct(t.visualVariables,e);return i?new Zi(i,dt(i,e),!!i.size):null}function Kr(t,e,i){if(!e||!t)return!1;const s=t.visualVariables,r=ct(e.visualVariables,i);return!!r&&!!(pe(s.size,r.size,"size")&&pe(s.color,r.color,"color")&&pe(s.rotation,r.rotation,"rotation")&&pe(s.opacity,r.opacity,"opacity"))&&(t.visualVariables=r,t.materialParameters=dt(r,i),t.requiresShaderTransformation=!!r.size,!0)}function pe(t,e,i){if(!!t!=!!e||t&&t.field!==(e==null?void 0:e.field))return!1;if(t&&i==="rotation"){const s=t,r=e;for(let n=0;n<3;n++)if(s.type[n]!==r.type[n]||s.offset[n]!==r.offset[n]||s.factor[n]!==r.factor[n])return!1}return!0}class ut extends rt{constructor(e){super(),this.vvSize=(e==null?void 0:e.size)??null,this.vvColor=(e==null?void 0:e.color)??null,this.vvOpacity=(e==null?void 0:e.opacity)??null}}function dt(t,e){const i=new ut(t);return i.vvSize&&(i.vvSymbolAnchor=e.anchor,si(le),Ki(e.rotation[2],e.rotation[0],e.rotation[1],le),i.vvSymbolRotationMatrix=i.vvSymbolRotationMatrix||hi(),di(i.vvSymbolRotationMatrix,le)),i}function Xr(t,e,i){if(!t.vvSize)return i;ri(z,i);const s=t.vvSymbolRotationMatrix;ni(le,s[0],s[1],s[2],0,s[3],s[4],s[5],0,s[6],s[7],s[8],0,0,0,0,1),ai(z,z,le);for(let r=0;r<3;++r){const n=t.vvSize.offset[r]+e[0]*t.vvSize.factor[r];We[r]=nt(n,t.vvSize.minSize[r],t.vvSize.maxSize[r])}return oi(z,z,We),xe(z,z,t.vvSymbolAnchor),z}function Wr(t,e,i){if(!e.vvSize)return P(t,1,1,1),t;for(let s=0;s<3;++s){const r=e.vvSize.offset[s]+i[0]*e.vvSize.factor[s];t[s]=nt(r,e.vvSize.minSize[s],e.vvSize.maxSize[s])}return t}function qr(t,e){const i=t==null?0:e.attributes[t];return typeof i=="number"&&isFinite(i)?i:0}const z=he(),We=b(),le=he();let Qr=class extends ut{constructor(){super(...arguments),this.renderOccluded=Ut.Occlude,this.isDecoration=!1}};const Pe=8;var Ae;(function(t){t[t.None=0]="None",t[t.Value=1]="Value",t[t.Texture=2]="Texture",t[t.COUNT=3]="COUNT"})(Ae||(Ae={}));function Ji(t,e){if(!ye(e.output))return;const{emissionSource:i,hasEmissiveTextureTransform:s,bindType:r}=e,n=i===Ae.Texture;n&&(t.include(Mi,e),t.fragment.uniforms.add(r===x.Pass?new yi("texEmission",o=>o.textureEmissive):new St("texEmission",o=>o.textureEmissive)));const a=i===Ae.Value||n;a&&t.fragment.uniforms.add(r===x.Pass?new L("emissionFactor",o=>o.emissiveFactor):new R("emissionFactor",o=>o.emissiveFactor)),t.fragment.code.add(u`
    vec4 getEmissions() {
      vec4 emissions = ${a?"vec4(emissionFactor, 1.0)":"vec4(0.0)"};
      ${N(n,`emissions *= textureLookup(texEmission, ${s?"emissiveUV":"vuv0"});
         emissions.w = emissions.rgb == vec3(0.0) ? 0.0: emissions.w;`)}
      return emissions;
    }
  `)}let Oe=class extends ii{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}};ne([oe()],Oe.prototype,"instancedDoublePrecision",void 0),ne([oe()],Oe.prototype,"hasModelTransformation",void 0);var g;(function(t){t[t.NONE=0]="NONE",t[t.ColorAlpha=1]="ColorAlpha",t[t.FrontFace=2]="FrontFace",t[t.COUNT=3]="COUNT"})(g||(g={}));let Se=class extends Oe{constructor(){super(...arguments),this.output=de.Color,this.oitPass=g.NONE,this.hasSlicePlane=!1,this.bindType=x.Pass,this.writeDepth=!0}};ne([oe({count:de.COUNT})],Se.prototype,"output",void 0),ne([oe({count:g.COUNT})],Se.prototype,"oitPass",void 0),ne([oe()],Se.prototype,"hasSlicePlane",void 0);let en=class extends rt{constructor(e){super(),this.slicePlaneLocalOrigin=e}};function sn(t,e){ft(t,e,new L("slicePlaneOrigin",(i,s)=>Re(e,i,s)),new L("slicePlaneBasis1",(i,s)=>{var r;return Q(e,i,s,(r=s.slicePlane)==null?void 0:r.basis1)}),new L("slicePlaneBasis2",(i,s)=>{var r;return Q(e,i,s,(r=s.slicePlane)==null?void 0:r.basis2)}))}function rn(t,e){ft(t,e,new R("slicePlaneOrigin",(i,s)=>Re(e,i,s)),new R("slicePlaneBasis1",(i,s)=>{var r;return Q(e,i,s,(r=s.slicePlane)==null?void 0:r.basis1)}),new R("slicePlaneBasis2",(i,s)=>{var r;return Q(e,i,s,(r=s.slicePlane)==null?void 0:r.basis2)}))}function nn(t,e){ht(t,e,new R("slicePlaneOrigin",(i,s)=>Re(e,i,s)),new R("slicePlaneBasis1",(i,s)=>{var r;return Q(e,i,s,(r=s.slicePlane)==null?void 0:r.basis1)}),new R("slicePlaneBasis2",(i,s)=>{var r;return Q(e,i,s,(r=s.slicePlane)==null?void 0:r.basis2)}))}const es=u`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
bool rejectBySlice(vec3 pos) {
return sliceByPlane(pos);
}`;function ht(t,e,...i){e.hasSlicePlane?(t.uniforms.add(...i),t.code.add(es)):t.code.add("bool rejectBySlice(vec3 pos) { return false; }")}function ft(t,e,...i){ht(t,e,...i),e.hasSlicePlane?t.code.add(`
    void discardBySlice(vec3 pos) {
      if (sliceByPlane(pos)) {
        discard;
      }
    }

    vec4 applySliceOutline(vec4 color, vec3 pos) {
      SliceFactors factors = calculateSliceFactors(pos);

      factors.front /= 2.0 * fwidth(factors.front);
      factors.side0 /= 2.0 * fwidth(factors.side0);
      factors.side1 /= 2.0 * fwidth(factors.side1);
      factors.side2 /= 2.0 * fwidth(factors.side2);
      factors.side3 /= 2.0 * fwidth(factors.side3);

      // return after calling fwidth, to avoid aliasing caused by discontinuities in the input to fwidth
      if (sliceByFactors(factors)) {
        return color;
      }

      float outlineFactor = (1.0 - step(0.5, factors.front))
        * (1.0 - step(0.5, factors.side0))
        * (1.0 - step(0.5, factors.side1))
        * (1.0 - step(0.5, factors.side2))
        * (1.0 - step(0.5, factors.side3));

      return mix(color, vec4(vec3(0.0), color.a), outlineFactor * 0.3);
    }

    vec4 applySlice(vec4 color, vec3 pos) {
      return sliceEnabled() ? applySliceOutline(color, pos) : color;
    }
  `):t.code.add(u`void discardBySlice(vec3 pos) { }
vec4 applySlice(vec4 color, vec3 pos) { return color; }`)}function mt(t,e,i){return t.instancedDoublePrecision?P(ts,i.camera.viewInverseTransposeMatrix[3],i.camera.viewInverseTransposeMatrix[7],i.camera.viewInverseTransposeMatrix[11]):e.slicePlaneLocalOrigin}function pt(t,e){return t!=null?st(Ee,e.origin,t):e.origin}function gt(t,e,i){return t.hasSliceTranslatedView?e!=null?xe(is,i.camera.viewMatrix,e):i.camera.viewMatrix:null}function Re(t,e,i){if(i.slicePlane==null)return Le;const s=mt(t,e,i),r=pt(s,i.slicePlane),n=gt(t,s,i);return n!=null?Te(Ee,r,n):r}function Q(t,e,i,s){if(s==null||i.slicePlane==null)return Le;const r=mt(t,e,i),n=pt(r,i.slicePlane),a=gt(t,r,i);return a!=null?(w(te,s,n),Te(Ee,n,a),Te(te,te,a),st(te,te,Ee)):s}const ts=b(),Ee=b(),te=b(),is=he();function an(t,e){if(e.output!==de.ObjectAndLayerIdColor)return t.vertex.code.add(u`void forwardObjectAndLayerIdColor() {}`),void t.fragment.code.add(u`void outputObjectAndLayerIdColor() {}`);const i=e.objectAndLayerIdColorInstanced;t.varyings.add("objectAndLayerIdColorVarying","vec4"),t.attributes.add(i?S.INSTANCEOBJECTANDLAYERIDCOLOR:S.OBJECTANDLAYERIDCOLOR,"vec4"),t.vertex.code.add(u`
    void forwardObjectAndLayerIdColor() {
      objectAndLayerIdColorVarying = ${i?"instanceObjectAndLayerIdColor":"objectAndLayerIdColor"} * 0.003921568627451;
    }`),t.fragment.code.add(u`void outputObjectAndLayerIdColor() {
fragColor = objectAndLayerIdColorVarying;
}`)}let ss=class extends ${constructor(e,i,s){super(e,"vec4",x.Pass,(r,n,a)=>r.setUniform4fv(e,i(n,a)),s)}},rs=class extends ${constructor(e,i,s){super(e,"float",x.Pass,(r,n,a)=>r.setUniform1fv(e,i(n,a)),s)}};function cn(t,e){const{vertex:i,attributes:s}=t;e.hasVvInstancing&&(e.vvSize||e.vvColor)&&s.add(S.INSTANCEFEATUREATTRIBUTE,"vec4"),e.vvSize?(i.uniforms.add(new L("vvSizeMinSize",r=>r.vvSize.minSize)),i.uniforms.add(new L("vvSizeMaxSize",r=>r.vvSize.maxSize)),i.uniforms.add(new L("vvSizeOffset",r=>r.vvSize.offset)),i.uniforms.add(new L("vvSizeFactor",r=>r.vvSize.factor)),i.uniforms.add(new yt("vvSymbolRotationMatrix",r=>r.vvSymbolRotationMatrix)),i.uniforms.add(new L("vvSymbolAnchor",r=>r.vvSymbolAnchor)),i.code.add(u`vec3 vvScale(vec4 _featureAttribute) {
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),i.code.add(u`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);
        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);
      }

      ${e.hasVvInstancing?u`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):i.code.add(u`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),e.vvColor?(i.constants.add("vvColorNumber","int",Pe),i.uniforms.add(new rs("vvColorValues",r=>r.vvColor.values,Pe),new ss("vvColorColors",r=>r.vvColor.colors,Pe)),i.code.add(u`
      vec4 interpolateVVColor(float value) {
        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${e.hasVvInstancing?u`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }`:"vec4 vvColor() { return vec4(1.0); }"}
    `)):i.code.add(u`vec4 vvColor() { return vec4(1.0); }`)}let ns=class extends ${constructor(e,i){super(e,"mat4",x.Draw,(s,r,n)=>s.setUniformMatrix4fv(e,i(r,n)))}};function dn(t,e){e.instancedDoublePrecision?t.constants.add("cameraPosition","vec3",Le):t.uniforms.add(new R("cameraPosition",(i,s)=>P(vt,s.camera.viewInverseTransposeMatrix[3]-i.origin[0],s.camera.viewInverseTransposeMatrix[7]-i.origin[1],s.camera.viewInverseTransposeMatrix[11]-i.origin[2])))}function hn(t,e){if(!e.instancedDoublePrecision)return void t.uniforms.add(new _e("proj",s=>s.camera.projectionMatrix),new ns("view",(s,r)=>xe(qe,r.camera.viewMatrix,s.origin)),new R("localOrigin",s=>s.origin));const i=({camera:s})=>P(vt,s.viewInverseTransposeMatrix[3],s.viewInverseTransposeMatrix[7],s.viewInverseTransposeMatrix[11]);t.uniforms.add(new _e("proj",s=>s.camera.projectionMatrix),new _e("view",s=>xe(qe,s.camera.viewMatrix,i(s))),new wi("localOrigin",s=>i(s)))}const qe=he(),vt=b();function fn(t){t.uniforms.add(new _e("viewNormal",e=>e.camera.viewInverseTransposeMatrix))}function mn(t){t.uniforms.add(new Ii("pixelRatio",e=>e.camera.pixelRatio/e.overlayStretch))}function as(){return Qe??(Qe=(async()=>{const t=await Ti(()=>import("./basis_transcoder-zaOuheTe.js"),[],import.meta.url),e=await t.default({locateFile:i=>pi(`esri/libs/basisu/${i}`)});return e.initializeBasis(),e})()),Qe}let Qe,y=null,ge=null;async function _t(){return ge==null&&(ge=as(),y=await ge),ge}function os(t,e){if(y==null)return t.byteLength;const i=new y.BasisFile(new Uint8Array(t)),s=xt(i)?Tt(i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),e):0;return i.close(),i.delete(),s}function ls(t,e){if(y==null)return t.byteLength;const i=new y.KTX2File(new Uint8Array(t)),s=At(i)?Tt(i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),e):0;return i.close(),i.delete(),s}function Tt(t,e,i,s,r){const n=Nt(e?D.COMPRESSED_RGBA8_ETC2_EAC:D.COMPRESSED_RGB8_ETC2),a=r&&t>1?(4**t-1)/(3*4**(t-1)):1;return Math.ceil(i*s*n*a)}function xt(t){return t.getNumImages()>=1&&!t.isUASTC()}function At(t){return t.getFaces()>=1&&t.isETC1S()}async function cs(t,e,i){y==null&&(y=await _t());const s=new y.BasisFile(new Uint8Array(i));if(!xt(s))return null;s.startTranscoding();const r=Et(t,e,s.getNumLevels(0),s.getHasAlpha(),s.getImageWidth(0,0),s.getImageHeight(0,0),(n,a)=>s.getImageTranscodedSizeInBytes(0,n,a),(n,a,o)=>s.transcodeImage(o,0,n,a,0,0));return s.close(),s.delete(),r}async function us(t,e,i){y==null&&(y=await _t());const s=new y.KTX2File(new Uint8Array(i));if(!At(s))return null;s.startTranscoding();const r=Et(t,e,s.getLevels(),s.getHasAlpha(),s.getWidth(),s.getHeight(),(n,a)=>s.getImageTranscodedSizeInBytes(n,0,0,a),(n,a,o)=>s.transcodeImage(o,n,0,0,a,0,-1,-1));return s.close(),s.delete(),r}function Et(t,e,i,s,r,n,a,o){const{compressedTextureETC:c,compressedTextureS3TC:d}=t.capabilities,[l,h]=c?s?[J.ETC2_RGBA,D.COMPRESSED_RGBA8_ETC2_EAC]:[J.ETC1_RGB,D.COMPRESSED_RGB8_ETC2]:d?s?[J.BC3_RGBA,D.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[J.BC1_RGB,D.COMPRESSED_RGB_S3TC_DXT1_EXT]:[J.RGBA32,K.RGBA],A=e.hasMipmap?i:Math.min(1,i),f=[];for(let m=0;m<A;m++)f.push(new Uint8Array(a(m,l))),o(m,l,f[m]);return e.internalFormat=h,e.hasMipmap=f.length>1,e.samplingMode=e.hasMipmap?q.LINEAR_MIPMAP_LINEAR:q.LINEAR,e.width=r,e.height=n,new ae(t,e,{type:"compressed",levels:f})}const ve=()=>Je.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),ds=542327876,hs=131072,fs=4;function Ue(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function ms(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)}const ps=Ue("DXT1"),gs=Ue("DXT3"),vs=Ue("DXT5"),_s=31,Ts=0,xs=1,As=2,Es=3,$s=4,Cs=7,Ps=20,Ss=21;function ys(t,e,i){const s=bs(i,e.hasMipmap??!1);if(s==null)throw new Error("DDS texture data is null");const{textureData:r,internalFormat:n,width:a,height:o}=s;return e.samplingMode=r.levels.length>1?q.LINEAR_MIPMAP_LINEAR:q.LINEAR,e.hasMipmap=r.levels.length>1,e.internalFormat=n,e.width=a,e.height=o,new ae(t,e,r)}function bs(t,e){const i=new Int32Array(t.buffer,t.byteOffset,_s);if(i[Ts]!==ds)return ve().error("Invalid magic number in DDS header"),null;if(!(i[Ps]&fs))return ve().error("Unsupported format, must contain a FourCC code"),null;const s=i[Ss];let r,n;switch(s){case ps:r=8,n=D.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case gs:r=16,n=D.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case vs:r=16,n=D.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return ve().error("Unsupported FourCC code:",ms(s)),null}let a=1,o=i[$s],c=i[Es];(3&o||3&c)&&(ve().warn("Rounding up compressed texture size to nearest multiple of 4."),o=o+3&-4,c=c+3&-4);const d=o,l=c;let h,A;i[As]&hs&&e!==!1&&(a=Math.max(1,i[Cs]));let f=t.byteOffset+i[xs]+4;const m=[];for(let E=0;E<a;++E)A=(o+3>>2)*(c+3>>2)*r,h=new Uint8Array(t.buffer,f,A),m.push(h),f+=A,o=Math.max(1,o>>1),c=Math.max(1,c>>1);return{textureData:{type:"compressed",levels:m},internalFormat:n,width:d,height:l}}const $e=16;function pn(t){return Math.ceil(t/$e)*$e}function gn(t){return Math.floor(t/$e)*$e}function ws(t,e){let n=t.width*t.height;if(n<4096)return t instanceof ImageData?$t(t):t;let a=t.width,o=t.height;do a=Math.ceil(a/2),o=Math.ceil(o/2),n=a*o;while(n>1048576||e!=null&&(a>e||o>e));return ze(t,a,o)}function Is(t,e){const i=Math.max(t.width,t.height);if(i<=e)return t;const s=e/i;return ze(t,Math.round(t.width*s),Math.round(t.height*s))}function ze(t,e,i){if(t instanceof ImageData)return ze($t(t),e,i);const s=document.createElement("canvas");return s.width=e,s.height=i,s.getContext("2d").drawImage(t,0,0,s.width,s.height),s}function $t(t){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const i=e.getContext("2d");if(i==null)throw new et("Failed to create 2d context from HTMLCanvasElement");return i.putImageData(t,0,0),e}let vn=class extends tt{constructor(e,i){super(),this._data=e,this.type=re.Texture,this.events=new mi,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this._parameters={...Ls,...i},this._startPreload(e)}dispose(){this.unload(),this._data=this.frameUpdate=void 0}_startPreload(e){e!=null&&(e instanceof HTMLVideoElement?(this.frameUpdate=i=>this._frameUpdate(e,i),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(Be(e.src)||e.preload==="auto"&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";const i=!e.paused;if(e.src=e.src,i&&e.autoplay){const s=()=>{e.removeEventListener("canplay",s),e.play()};e.addEventListener("canplay",s)}}}_startPreloadImageElement(e){gi(e.src)||Be(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){const i=new Ft;return i.wrapMode=this._parameters.wrap??we.REPEAT,i.flipped=!this._parameters.noUnpackFlip,i.samplingMode=this._parameters.mipmap?q.LINEAR_MIPMAP_LINEAR:q.LINEAR,i.hasMipmap=!!this._parameters.mipmap,i.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,i.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),i}get glTexture(){return this._glTexture}get memoryEstimate(){var e;return((e=this._glTexture)==null?void 0:e.usedMemory)||Os(this._data,this._parameters)}load(e){if(this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;const i=this._data;return i==null?(this._glTexture=new ae(e,this._createDescriptor(e),null),this._glTexture):(this._parameters.reloadable||(this._data=void 0),typeof i=="string"?this._loadFromURL(e,i):i instanceof Image?this._loadFromImageElement(e,i):i instanceof HTMLVideoElement?this._loadFromVideoElement(e,i):i instanceof ImageData||i instanceof HTMLCanvasElement?this._loadFromImage(e,i):ie(i)&&this._parameters.encoding===X.DDS_ENCODING?this._loadFromDDSData(e,i):se(i)&&this._parameters.encoding===X.DDS_ENCODING?this._loadFromDDSData(e,new Uint8Array(i)):(se(i)||ie(i))&&this._parameters.encoding===X.KTX2_ENCODING?this._loadFromKTX2(e,i):(se(i)||ie(i))&&this._parameters.encoding===X.BASIS_ENCODING?this._loadFromBasis(e,i):ie(i)?this._loadFromPixelData(e,i):se(i)?this._loadFromPixelData(e,new Uint8Array(i)):null)}_frameUpdate(e,i){return this._glTexture==null||e.readyState<ce.HAVE_CURRENT_DATA||i===e.currentTime?i:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,i){return this._glTexture=ys(e,this._createDescriptor(e),i),this._glTexture}_loadFromKTX2(e,i){return this._loadAsync(()=>us(e,this._createDescriptor(e),i).then(s=>(this._glTexture=s,s)))}_loadFromBasis(e,i){return this._loadAsync(()=>cs(e,this._createDescriptor(e),i).then(s=>(this._glTexture=s,s)))}_loadFromPixelData(e,i){W(this._parameters.width>0&&this._parameters.height>0);const s=this._createDescriptor(e);return s.pixelFormat=this._parameters.components===1?K.LUMINANCE:this._parameters.components===3?K.RGB:K.RGBA,s.width=this._parameters.width??0,s.height=this._parameters.height??0,this._glTexture=new ae(e,s,i),this._glTexture}_loadFromURL(e,i){return this._loadAsync(async s=>{const r=await _i(i,{signal:s});return Ne(s),this._loadFromImage(e,r)})}_loadFromImageElement(e,i){return i.complete?this._loadFromImage(e,i):this._loadAsync(async s=>{const r=await vi(i,i.src,!1,s);return Ne(s),this._loadFromImage(e,r)})}_loadFromVideoElement(e,i){return i.readyState>=ce.HAVE_CURRENT_DATA?this._loadFromImage(e,i):this._loadFromVideoElementAsync(e,i)}_loadFromVideoElementAsync(e,i){return this._loadAsync(s=>new Promise((r,n)=>{const a=()=>{i.removeEventListener("loadeddata",o),i.removeEventListener("error",c),Mt(d)},o=()=>{i.readyState>=ce.HAVE_CURRENT_DATA&&(a(),r(this._loadFromImage(e,i)))},c=l=>{a(),n(l||new et("Failed to load video"))};i.addEventListener("loadeddata",o),i.addEventListener("error",c);const d=Ot(s,()=>c(Lt()))}))}_loadFromImage(e,i){let s=i;if(!(s instanceof HTMLVideoElement)){const{maxTextureSize:a}=e.parameters;s=this._parameters.downsampleUncompressed?ws(s,a):Is(s,a)}const r=Ct(s);this._parameters.width=r.width,this._parameters.height=r.height;const n=this._createDescriptor(e);return n.pixelFormat=this._parameters.components===3?K.RGB:K.RGBA,n.width=r.width,n.height=r.height,n.shouldCompress=this._parameters.shouldCompress,this._glTexture=new ae(e,n,s),this._glTexture}_loadAsync(e){const i=new AbortController;this._loadingController=i;const s=e(i.signal);this._loadingPromise=s;const r=()=>{this._loadingController===i&&(this._loadingController=null),this._loadingPromise===s&&(this._loadingPromise=null)};return s.then(r,r),s}unload(){if(this._glTexture=be(this._glTexture),this._loadingController!=null){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}};function Os(t,e){if(t==null)return 0;if(se(t)||ie(t))return e.encoding===X.KTX2_ENCODING?ls(t,!!e.mipmap):e.encoding===X.BASIS_ENCODING?os(t,!!e.mipmap):t.byteLength;const{width:i,height:s}=t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?Ct(t):e;return(e.mipmap?4/3:1)*i*s*(e.components||4)||0}function Ct(t){return t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:t}var ce;(function(t){t[t.HAVE_NOTHING=0]="HAVE_NOTHING",t[t.HAVE_METADATA=1]="HAVE_METADATA",t[t.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",t[t.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",t[t.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(ce||(ce={}));const Ls={wrap:{s:we.REPEAT,t:we.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1,downsampleUncompressed:!1,shouldCompress:!1};function Tn(t,{occlusionPass:e,terrainDepthTest:i,cullAboveTerrain:s}){const r=t.vertex,n=t.fragment;if(!i)return r.code.add("void forwardViewPosDepth(vec3 pos) {}"),void n.code.add(`${e?"bool":"void"} discardByTerrainDepth() { ${N(e,"return false;")}}`);t.varyings.add("viewPosDepth","float"),r.code.add(`void forwardViewPosDepth(vec3 pos) {
    viewPosDepth = pos.z;
  }`),n.include(Ci),n.uniforms.add(new Ie("terrainDepthTexture",a=>{var o;return(o=a.terrainDepth)==null?void 0:o.attachment})).code.add(u`
    ${e?"bool":"void"} discardByTerrainDepth() {
      float depth = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0).r;
      float linearDepth = linearizeDepth(depth);
      ${e?"return viewPosDepth < linearDepth && depth < 1.0;":`if(viewPosDepth ${s?">":"<="} linearDepth) discard;`}
    }`)}function Ms(t){t.code.add(u`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}let Ds=class extends ${constructor(e,i){super(e,"ivec2",x.Bind,(s,r)=>s.setUniform2iv(e,i(r)))}};function Rs(t,e){const{fragment:i}=t;e.output===de.Highlight?(i.uniforms.add(new Ie("depthTexture",s=>s.mainDepth),new Ie("highlightTexture",s=>s.highlightMixTexture),new Ri("highlightLevel",s=>s.highlightLevel??0),new Ds("highlightMixOrigin",s=>s.highlightMixOrigin)),t.outputs.add("fragHighlight","vec2",0),t.include(Di),i.code.add(u`vec2 getAccumulatedHighlight() {
return texelFetch(highlightTexture, ivec2(gl_FragCoord.xy) - highlightMixOrigin, 0).rg;
}
void outputHighlight(bool occluded) {
if (highlightLevel == 0) {
uint bits = occluded ? 3u : 1u;
fragHighlight = vec2(float(bits) / 255.0, 0.0);
} else {
int ll = (highlightLevel & 3) << 1;
int li = (highlightLevel >> 2) & 3;
uint bits;
if (occluded) {
bits = 3u << ll;
} else {
bits = 1u << ll;
}
vec2 combinedHighlight = getAccumulatedHighlight();
uint accumulatedI = uint(combinedHighlight[li] * 255.0);
combinedHighlight[li] = float(bits | accumulatedI) / 255.0;
fragHighlight = combinedHighlight;
}
}
bool isHighlightOccluded() {
float sceneDepth = texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x;
return gl_FragCoord.z > sceneDepth + 5e-7;
}
void calculateOcclusionAndOutputHighlight() {
outputHighlight(isHighlightOccluded());
}`),e.canHaveOverlay&&i.code.add(u`void calculateOcclusionAndOutputHighlightOverlay(vec2 highlightToAdd) {
uint levelBits = readLevelBits(highlightToAdd, highlightLevel);
if ((levelBits & 1u) == 0u) { discard; }
outputHighlight(isHighlightOccluded());
}`)):i.code.add(u`void calculateOcclusionAndOutputHighlight() {}`)}const Us=1/255.5;function An(t,e){t.include(Rs,e),t.include(Ji,e),t.fragment.include(Ms);const i=e.output===de.ObjectAndLayerIdColor,s=Ye(e.output),r=ye(e.output)&&e.oitPass===g.ColorAlpha,n=ye(e.output)&&e.oitPass!==g.ColorAlpha,a=e.discardInvisibleFragments;let o=0;(n||s||r)&&t.outputs.add("fragColor","vec4",o++),s&&t.outputs.add("fragEmission","vec4",o++),r&&t.outputs.add("fragAlpha","float",o++),t.fragment.code.add(u`
    void outputColorHighlightOID(vec4 finalColor, const in vec3 vWorldPosition) {
      ${N(i,"finalColor.a = 1.0;")}

      ${N(a,`if (finalColor.a < ${u.float(Us)}) { discard; }`)}

      finalColor = applySlice(finalColor, vWorldPosition);
      ${N(r,u`fragColor = premultiplyAlpha(finalColor);
             fragAlpha = finalColor.a;`)}
      ${N(n,"fragColor = finalColor;")}
      ${N(s,"fragEmission = finalColor.a * getEmissions();")}
      calculateOcclusionAndOutputHighlight();
      ${N(i,"outputObjectAndLayerIdColor();")}
    }
  `)}const Pt=Gt(fe.ONE,fe.ZERO,fe.ONE,fe.ONE_MINUS_SRC_ALPHA);function En(t){return t===g.FrontFace?null:Pt}function $n(t){switch(t){case g.NONE:return jt;case g.ColorAlpha:return Pt;case g.FrontFace:case g.COUNT:return null}}function Cn(t){if(t.draped)return null;switch(t.oitPass){case g.NONE:case g.FrontFace:return t.writeDepth?Kt:null;case g.ColorAlpha:case g.COUNT:return null}}const Pn=5e5,zs={factor:-1,units:-2};function Sn(t){return t?zs:null}function yn(t,e=O.LESS){return t===g.NONE||t===g.FrontFace?e:O.LEQUAL}function bn(t,e){const i=Ye(e);return t===g.ColorAlpha?i?{buffers:[H.COLOR_ATTACHMENT0,H.COLOR_ATTACHMENT1,H.COLOR_ATTACHMENT2]}:{buffers:[H.COLOR_ATTACHMENT0,H.COLOR_ATTACHMENT1]}:i?{buffers:[H.COLOR_ATTACHMENT0,H.COLOR_ATTACHMENT1]}:null}const wn={func:O.LESS},In={func:O.ALWAYS},On={mask:255},Ln={mask:0},Mn=t=>({function:{func:O.NOTEQUAL,ref:t,mask:t},operation:{fail:v.KEEP,zFail:v.KEEP,zPass:v.KEEP}}),Dn=t=>({function:{func:O.ALWAYS,ref:t,mask:t},operation:{fail:v.KEEP,zFail:v.KEEP,zPass:v.REPLACE}}),Rn={function:{func:O.ALWAYS,ref:V.OutlineVisualElementMask,mask:V.OutlineVisualElementMask},operation:{fail:v.KEEP,zFail:v.KEEP,zPass:v.ZERO}},Un={function:{func:O.ALWAYS,ref:V.OutlineVisualElementMask,mask:V.OutlineVisualElementMask},operation:{fail:v.KEEP,zFail:v.KEEP,zPass:v.REPLACE}},zn={function:{func:O.EQUAL,ref:V.OutlineVisualElementMask,mask:V.OutlineVisualElementMask},operation:{fail:v.KEEP,zFail:v.KEEP,zPass:v.KEEP}},Nn={function:{func:O.NOTEQUAL,ref:V.OutlineVisualElementMask,mask:V.OutlineVisualElementMask},operation:{fail:v.KEEP,zFail:v.KEEP,zPass:v.KEEP}};function Fn(t,e=!1){return t<=ue?e?new Array(t).fill(0):new Array(t):new Float32Array(t)}function Vn(t){return Array.isArray(t)?t.length<ue?t:new Float32Array(t):t.length<ue?Array.from(t):t}function Hn(t){return(Array.isArray(t)?t.length:t.byteLength/8)<=ue?Array.from(t):new Float32Array(t)}function Bn(t,e,i){return Array.isArray(t)?t.slice(e,e+i):t.subarray(e,e+i)}export{Un as $,Ge as A,Rs as B,g as C,bn as D,Se as E,Ae as F,rn as G,An as H,zs as I,Cn as J,$n as K,wi as L,Mi as M,vn as N,zr as O,ns as P,pn as Q,_t as R,Vn as S,En as T,ws as U,zi as V,Wr as W,Ui as X,Oi as Y,Ri as Z,Sn as _,$i as a,Rn as a0,On as a1,yn as a2,Pn as a3,vr as a4,rs as a5,Nn as a6,In as a7,zn as a8,Ln as a9,wn as aa,Qr as ab,qr as ac,gn as ad,Li as ae,en as af,Di as ag,jr as ah,Kr as ai,Gr as aj,Xr as ak,Bn as al,Pe as am,ss as an,Mn as ao,sn as ap,Dn as aq,Hn as b,Lr as c,dn as d,Rr as e,Fr as f,hn as g,Ii as h,Ie as i,Ei as j,yi as k,Ci as l,Sr as m,Fn as n,br as o,fn as p,I as q,Us as r,xr as s,$r as t,Tn as u,nn as v,mn as w,cn as x,an as y,Ms as z};
