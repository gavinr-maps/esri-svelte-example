import"./geometry-DpwwkAX1.js";import{d as q}from"./Graphic-Dc7F67nR.js";import{_ as J}from"./Accessor-D6mNnsWy.js";import{i as K,d as Q}from"./screenUtils-PfxkaaMN.js";import{n as F}from"./mathUtils-ClvKsMak.js";import{n as v}from"./projectVectorToVector-Chzd0Pq0.js";import{o as Y}from"./LayerConstants-B33OP6sh.js";import{m as P}from"./layerUtils-erzwAANv.js";import{t as Z}from"./Material-BN_i9QRJ.js";import{a as U,i as E,o as V,c as ee,s as w,d as L,T as H,e as b,b as te}from"./ElevationProvider-BHZsEIDd.js";import{O as ne}from"./mat4-ybYUU6jq.js";import{T as re}from"./aaBoundingBox-rJEWaOSN.js";import{N as ie}from"./sphere-7666U3LO.js";import{n as ae,o as B}from"./Intersector-CYIO18dt.js";import{i as D}from"./Intersector-wnm5hmmT.js";import{w as S}from"./verticalOffsetUtils-DaB1QvwW.js";import{f as j,_ as se}from"./Point-DB4Hp4hH.js";class Ce extends V{constructor(t,n,r,i){super(n,r),this.point=t,this.createGraphic=i}}function M(e){return U(e)&&e.intersector===E.PCL&&!!e.target}class Ge extends ee{constructor(t,n,r,i,o){super(t),this.layerUid=t,this.sublayerUid=n,this.nodeIndex=r,this.componentIndex=i,this.triangleNr=o}}class _e extends V{constructor(t,n,r){super(n,null),this.point=t,this.createVoxelGraphic=r}}let ve=class extends V{constructor(t,n){super(t,null),this.createTiles3DGraphic=n}};function x(e){return U(e)&&e.intersector===E.I3S&&!!e.target}function W(e){return U(e)&&e.intersector===E.VOXEL&&!!e.target}function le(e){return U(e)&&e.intersector===E.TILES3D&&!!e.target}function X(e,t){var n,r;return w(e)||L(e)?y((n=e.target)==null?void 0:n.object,t):ae(e)?(r=t.map)==null?void 0:r.ground:M(e)||x(e)||B(e)||W(e)?y(e.target,t):null}function Ae(e,t){const n=N(e,t);return n!=null&&n.type==="graphic"?n.graphic:null}function N(e,t){var n;if(e==null)return null;if(w(e)||L(e))return A((n=e.target)==null?void 0:n.object,t);if(M(e)){const r=e.target.createGraphic();return{type:"graphic",graphic:r,layer:r.layer}}if(W(e)){const r=e.target.createVoxelGraphic();return{type:"graphic",graphic:r,layer:r.layer}}if(le(e)){const r=e.target.createTiles3DGraphic();return{type:"graphic",graphic:r,layer:r.layer}}return B(e)||D(e)?A(e.target,t):x(e)?oe(e.target,t):null}function A(e,t){if((e==null?void 0:e.graphicUid)==null)return null;const n=y(e,t);if(n==null)return null;if(n===t.graphics)return t.graphicsView==null||typeof e.graphicUid!="number"?null:t.graphicsView.getHit(e.graphicUid);const r=t.allLayerViews.find(i=>i.layer===n);return!r||r.suspended||e.graphicUid==null?null:"getHit"in r?r.getHit(e.graphicUid):null}function oe(e,t){const n=y(e,t);if(n==null)return null;const r=t.allLayerViews.find(i=>i.layer===n);return r&&!r.suspended&&"getGraphicFromIntersectorTarget"in r?ue(r.getGraphicFromIntersectorTarget(e)):null}function ce(e,t){const n=y(e,t);if(n==null)return null;const r=t.allLayerViews.find(i=>i.layer===n);return r&&!r.suspended&&"getAABBFromIntersectorTarget"in r?r.getAABBFromIntersectorTarget(e):null}function ue(e){return e!=null?{type:"graphic",graphic:e,layer:e.layer}:null}function y(e,t){return(e==null?void 0:e.layerUid)==null?null:t.graphicsView!=null&&e.layerUid===t.graphicsView.processor.layer.id?t.graphics:t.map.allLayers.find(n=>n.uid===e.layerUid)}function Fe(e,t){if(w(e)||L(e))return ie(e.target.object.boundingVolumeWorldSpace.bounds);if(D(e)){ne(I,e.transformation);const n=Math.max(I[0],I[1],I[2]);return e.target.baseBoundingSphere.radius*n}if(x(e)){const n=ce(e.target,t);return n?.5*re(n):null}return null}function Pe(e){return!w(e)&&!L(e)&&(D(e)?e.target.numLodLevels>1:!!x(e))}const I=F();async function He(e,t,n,r){const i=n?z(e,n):r,o=K(t.x,t.y);i.requiresGroundFeedback=!0,i.enableDraped=!0;const a=H(e.state.viewingMode);a.options.selectionMode=!0,a.options.store=b.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(o,a,i);const u=de(e,a.results.all,i.graphics),s=a.results.ground,l=X(s,e),d=l!=null&&"type"in l&&P(l.type)?l:null,c={screenPoint:t,results:u,ground:{mapPoint:f(e,s),distance:U(s)?s.distanceInRenderSpace:0,layer:d}};return Z.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(c.intersector=a),c}function Be(e,t,n,r){var d,c,C,G,_;const i=n?z(e,n):r,o=!(!((d=i.graphics)!=null&&d.include)&&!((c=i.graphics)!=null&&c.exclude)),a=!(!((C=i.mediaElements)!=null&&C.include)&&!((G=i.mediaElements)!=null&&G.exclude)),u=Q(t);i.enableDraped=i.include&&!i.include.has(S)||((_=i.exclude)==null?void 0:_.has(S));const s=e.sceneIntersectionHelper,l=H(e.state.viewingMode);if(l.options.selectionMode=!0,l.options.store=o||a?b.ALL:b.MIN,l.options.hud=!(n!=null&&n.excludeHud),s.intersectIntersectorScreen(u,l,i),o||a){for(const $ of l.results.all){const h=N($,e);if(h==null||o&&(h.type!=="graphic"||O(i.graphics,h.graphic))||a&&(h.type!=="media"||k(i.mediaElements,h.element)))return f(e,$)}return null}return f(e,l.results.min)}function de(e,t,n){const r=new Array;let i=null;for(let o=0;o<t.length;o++){const a=t[o],u=X(a,e);if(u!=null&&(u===e.map.ground||"type"in u&&P(u.type)))break;const s=N(a,e);if(s==null)continue;if(s.type==="graphic"){if(i==null&&o!==t.length-1&&(i=new Set),i!=null){const c=R(s.graphic);if(i.has(c))continue;i.add(c)}if(!O(n,s.graphic))continue}const l=f(e,a),d=a.distanceInRenderSpace;if(s.type==="media"){const c=s.element.toSource(l);r.push({...s,mapPoint:l,distance:d,sourcePoint:c})}else r.push({...s,mapPoint:l,distance:d})}return r}function f(e,t,n){return t.getIntersectionPoint(g)?(n=pe(e,g,n),t.intersector===E.TERRAIN&&e.basemapTerrain&&(n.z=te(e.basemapTerrain,n)??0),n):null}function R(e){var i;const t=e.sourceLayer,n=e.layer,r=t&&"objectIdField"in t?t:n&&"objectIdField"in n?n:t;if(r){const o=r.objectIdField??Y,a=(i=e.attributes)==null?void 0:i[o];if(a)return`o-${r.id}-${a}`}return`u-${e.uid}`}function O(e,t){return k(e,R(t))}function k(e,t){return e==null||(e.include==null||e.include.has(t))&&(e.exclude==null||!e.exclude.has(t))}function pe(e,t,n){let r=e.spatialReference||j.WGS84;return v(t,e.renderSpatialReference,g,r)?t=g:(r=j.WGS84,v(t,e.renderSpatialReference,g,r)&&(t=g)),n?(n.x=t[0],n.y=t[1],n.z=t[2],n.spatialReference=r):n=new se(t,r),n}function z(e,t){const n=T(e,t.include,m.INCLUDE),r=T(e,t.exclude,m.EXCLUDE);return{include:n.layerUids,exclude:r.layerUids,graphics:{include:n.graphicUids,exclude:r.graphicUids},mediaElements:{include:n.mediaElements,exclude:r.mediaElements}}}function T(e,t,n,r={layerUids:void 0,graphicUids:void 0,mediaElements:void 0}){if(!t)return r;if(t instanceof q)fe(r,R(t)),n===m.INCLUDE&&(e.graphicsView!=null&&t.layer===e?p(r,e.graphicsView.processor.layer.id):t.layer&&p(r,t.layer.uid));else if("layer"in t&&"element"in t)ge(r,t.element),n===m.INCLUDE&&p(r,t.layer.uid);else if(J(t))for(const i of t)i===e.graphics&&e.graphicsView!=null?p(r,e.graphicsView.processor.layer.id):i===e.map.ground?p(r,S):T(e,i,n,r);else"uid"in t&&p(r,t.uid);return r}function p(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function fe(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}function ge(e,t){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(t)}const g=F();var m;(function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"})(m||(m={}));class Me{constructor(t){this._store=t}destroy(){this._store.destroy()}get(t){return this._store.get(t)}put(t,n){this._store.put(t,n,n.values.byteLength+256)}}export{Be as I,pe as L,z as R,He as U,Fe as V,x as a,_e as c,ve as l,Ae as m,Ge as o,le as p,Ce as s,Me as t,Pe as w};
