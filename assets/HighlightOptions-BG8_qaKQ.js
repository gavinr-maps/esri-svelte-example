import{f as $}from"./quickselect-D0_cvEX6.js";import{Y as E,S as k}from"./Accessor-D6mNnsWy.js";import{w as R}from"./Extent-B4rrMrqp.js";import{a as V}from"./Polyline-BQFeqYXi.js";import{a as j}from"./Query-BpMwiNVl.js";import{e as q}from"./TileKey-CIqLSCov.js";import{e as f}from"./Evented-CXIxDjmW.js";import{u as y}from"./Color-DDUWtbqR.js";import{y as x,b as A}from"./subclass-BR3PhgZG.js";function b(t,i){if(!(this instanceof b))return new b(t,i);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),i&&(typeof i=="function"?this.toBBox=i:this._initFormat(i)),this.clear()}function C(t,i,n){if(!n)return i.indexOf(t);for(var e=0;e<i.length;e++)if(n(t,i[e]))return e;return-1}function p(t,i){g(t,0,t.children.length,i,t)}function g(t,i,n,e,h){h||(h=d(null)),h.minX=1/0,h.minY=1/0,h.maxX=-1/0,h.maxY=-1/0;for(var a,r=i;r<n;r++)a=t.children[r],v(h,t.leaf?e(a):a);return h}function v(t,i){return t.minX=Math.min(t.minX,i.minX),t.minY=Math.min(t.minY,i.minY),t.maxX=Math.max(t.maxX,i.maxX),t.maxY=Math.max(t.maxY,i.maxY),t}function w(t,i){return t.minX-i.minX}function O(t,i){return t.minY-i.minY}function X(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function M(t){return t.maxX-t.minX+(t.maxY-t.minY)}function D(t,i){return(Math.max(i.maxX,t.maxX)-Math.min(i.minX,t.minX))*(Math.max(i.maxY,t.maxY)-Math.min(i.minY,t.minY))}function F(t,i){var n=Math.max(t.minX,i.minX),e=Math.max(t.minY,i.minY),h=Math.min(t.maxX,i.maxX),a=Math.min(t.maxY,i.maxY);return Math.max(0,h-n)*Math.max(0,a-e)}function _(t,i){return t.minX<=i.minX&&t.minY<=i.minY&&i.maxX<=t.maxX&&i.maxY<=t.maxY}function Y(t,i){return i.minX<=t.maxX&&i.minY<=t.maxY&&i.maxX>=t.minX&&i.maxY>=t.minY}function d(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function S(t,i,n,e,h){for(var a,r=[i,n];r.length;)(n=r.pop())-(i=r.pop())<=e||(a=i+Math.ceil((n-i)/e/2)*e,$(t,a,i,n,h),r.push(i,a,a,n))}b.prototype={all:function(){return this._all(this.data,[])},search:function(t){var i=this.data,n=[],e=this.toBBox;if(!Y(t,i))return n;for(var h,a,r,s,o=[];i;){for(h=0,a=i.children.length;h<a;h++)r=i.children[h],Y(t,s=i.leaf?e(r):r)&&(i.leaf?n.push(r):_(t,s)?this._all(r,n):o.push(r));i=o.pop()}return n},collides:function(t){var i=this.data,n=this.toBBox;if(!Y(t,i))return!1;for(var e,h,a,r,s=[];i;){for(e=0,h=i.children.length;e<h;e++)if(a=i.children[e],Y(t,r=i.leaf?n(a):a)){if(i.leaf||_(t,r))return!0;s.push(a)}i=s.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var i=0,n=t.length;i<n;i++)this.insert(t[i]);return this}var e=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){var h=this.data;this.data=e,e=h}this._insert(e,this.data.height-e.height-1,!0)}else this.data=e;return this},insert:function(t){return t!=null&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=d([]),this},remove:function(t,i){if(t==null)return this;for(var n,e,h,a,r=this.data,s=this.toBBox(t),o=[],l=[];r||o.length;){if(r||(r=o.pop(),e=o[o.length-1],n=l.pop(),a=!0),r.leaf&&(h=C(t,r.children,i))!==-1)return r.children.splice(h,1),o.push(r),this._condense(o),this;a||r.leaf||!_(r,s)?e?(n++,r=e.children[n],a=!1):r=null:(o.push(r),l.push(n),n=0,e=r,r=r.children[0])}return this},toBBox:function(t){return t},compareMinX:w,compareMinY:O,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,i){for(var n=[];t;)t.leaf?i.push.apply(i,t.children):n.push.apply(n,t.children),t=n.pop();return i},_build:function(t,i,n,e){var h,a=n-i+1,r=this._maxEntries;if(a<=r)return p(h=d(t.slice(i,n+1)),this.toBBox),h;e||(e=Math.ceil(Math.log(a)/Math.log(r)),r=Math.ceil(a/Math.pow(r,e-1))),(h=d([])).leaf=!1,h.height=e;var s,o,l,u,c=Math.ceil(a/r),B=c*Math.ceil(Math.sqrt(r));for(S(t,i,n,B,this.compareMinX),s=i;s<=n;s+=B)for(S(t,s,l=Math.min(s+B-1,n),c,this.compareMinY),o=s;o<=l;o+=c)u=Math.min(o+c-1,l),h.children.push(this._build(t,o,u,e-1));return p(h,this.toBBox),h},_chooseSubtree:function(t,i,n,e){for(var h,a,r,s,o,l,u,c;e.push(i),!i.leaf&&e.length-1!==n;){for(u=c=1/0,h=0,a=i.children.length;h<a;h++)o=X(r=i.children[h]),(l=D(t,r)-o)<c?(c=l,u=o<u?o:u,s=r):l===c&&o<u&&(u=o,s=r);i=s||i.children[0]}return i},_insert:function(t,i,n){var e=this.toBBox,h=n?t:e(t),a=[],r=this._chooseSubtree(h,this.data,i,a);for(r.children.push(t),v(r,h);i>=0&&a[i].children.length>this._maxEntries;)this._split(a,i),i--;this._adjustParentBBoxes(h,a,i)},_split:function(t,i){var n=t[i],e=n.children.length,h=this._minEntries;this._chooseSplitAxis(n,h,e);var a=this._chooseSplitIndex(n,h,e),r=d(n.children.splice(a,n.children.length-a));r.height=n.height,r.leaf=n.leaf,p(n,this.toBBox),p(r,this.toBBox),i?t[i-1].children.push(r):this._splitRoot(n,r)},_splitRoot:function(t,i){this.data=d([t,i]),this.data.height=t.height+1,this.data.leaf=!1,p(this.data,this.toBBox)},_chooseSplitIndex:function(t,i,n){var e,h,a,r,s,o,l,u;for(o=l=1/0,e=i;e<=n-i;e++)r=F(h=g(t,0,e,this.toBBox),a=g(t,e,n,this.toBBox)),s=X(h)+X(a),r<o?(o=r,u=e,l=s<l?s:l):r===o&&s<l&&(l=s,u=e);return u},_chooseSplitAxis:function(t,i,n){var e=t.leaf?this.compareMinX:w,h=t.leaf?this.compareMinY:O;this._allDistMargin(t,i,n,e)<this._allDistMargin(t,i,n,h)&&t.children.sort(e)},_allDistMargin:function(t,i,n,e){t.children.sort(e);var h,a,r=this.toBBox,s=g(t,0,i,r),o=g(t,n-i,n,r),l=M(s)+M(o);for(h=i;h<n-i;h++)a=t.children[h],v(s,t.leaf?r(a):a),l+=M(s);for(h=n-i-1;h>=i;h--)a=t.children[h],v(o,t.leaf?r(a):a),l+=M(o);return l},_adjustParentBBoxes:function(t,i,n){for(var e=n;e>=0;e--)v(i[e],t)},_condense:function(t){for(var i,n=t.length-1;n>=0;n--)t[n].children.length===0?n>0?(i=t[n-1].children).splice(i.indexOf(t[n]),1):this.clear():p(t[n],this.toBBox)},_initFormat:function(t){var i=["return a"," - b",";"];this.compareMinX=new Function("a","b",i.join(t[0])),this.compareMinY=new Function("a","b",i.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};class I{constructor(i,n){this.key=new q(0,0,0,0),this.bounds=V(),this.objectIds=new Set,this.key.set(n);const e=i.getLODInfoAt(this.key);this.tileInfoView=i,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=e.resolution,this.level=e.level,this.scale=e.scale,this.minScale=i.zoomToScale(e.level-1),this.maxScale=i.zoomToScale(e.level+1)}get lod(){return this.tileInfoView.getLODInfoAt(this.key)}get id(){return this.key.id}get extent(){return R.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createArcadeEvaluationOptions(i){return{$view:{scale:this.scale,timeZone:i}}}createChildTiles(){const i=this.key.getChildKeys(),n=E.acquire();for(let e=0;e<i.length;e++)n[e]=new I(this.tileInfoView,i[e]);return n}getQuantizationParameters(){return j.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}let m=class extends k{constructor(){super(...arguments),this.color=new y([0,255,255]),this.haloOpacity=1,this.fillOpacity=.25,this.multiHighlightEnabled=!1}equals(t){return this.color.equals(t.color)&&(this.haloColor||this.color).equals(t.haloColor||t.color)&&this.haloOpacity===t.haloOpacity&&this.fillOpacity===t.fillOpacity&&this.multiHighlightEnabled===t.multiHighlightEnabled}};f([x({type:y})],m.prototype,"color",void 0),f([x({type:y})],m.prototype,"haloColor",void 0),f([x()],m.prototype,"haloOpacity",void 0),f([x()],m.prototype,"fillOpacity",void 0),f([x()],m.prototype,"multiHighlightEnabled",void 0),m=f([A("esri.views.2d.support.HighlightOptions")],m);const Z=m;export{b as i,I as n,Z as p};
