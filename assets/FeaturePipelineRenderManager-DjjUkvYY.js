import{r as f}from"./tslib.es6-B3Jf3DVX.js";import{s as I,b as G,F as x}from"./Accessor-BLX9ikPh.js";import{m as C,a as _,j as T,e as M}from"./subclass-BZA_h8Db.js";import{s as w}from"./vec3f64-BLpZdpfb.js";import{N as L}from"./vec4f64-o2zAXfmz.js";import{l as P}from"./ViewingMode-Dodu7ZZk.js";import{q as D,s as S}from"./LodRenderer-EVrH9dsH.js";import{t as E}from"./glUtil-D0YUa0ow.js";import{n as u}from"./Matrix3DrawUniform-CiBFaSz6.js";import{u as $,i as A,t as B,V as F}from"./MergedRenderer-Dli9s1X5.js";import{A as R}from"./Texture-Fac_8AOC.js";import{e as H}from"./VertexAttribute-Cq4MnHjR.js";import{i as O,u as U,n as k,o as V,c as z}from"./RealisticTree.glsl-CAmeC2w1.js";import{a as q,b as N,c as h}from"./sdfPrimitives-CUWZbMRe.js";import{e as v}from"./renderState-DQLu6AJX.js";import{B as W,o as j}from"./DefaultMaterial-DgOvtNL9.js";import{a as J}from"./HUDMaterial.glsl-D6WRipwF.js";let m=class extends ${constructor(e){super(e),this._hasHighlights=!1,this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new A,this._bufferWriter=null}get produces(){return this._produces}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach((e,r)=>{this._produces.set(r,t=>!!(t!==u.Highlight&&t!==u.ShadowHighlight||this._hasHighlights)&&e(t))})}destroy(){this._glMaterials.dispose();const e=this._renderGeometries.keys();for(const r of e)this.removeRenderGeometry(r)}acquireTechniques(e){const r=this.material;if(!r.shouldRender(e))return null;const{output:t,bind:s}=e,i=r.produces.get(s.slot);if(!(i!=null&&i(t))||(t===u.Highlight||t===u.ShadowHighlight)&&!this._hasHighlights)return null;const n=this._glMaterials.load(e.rctx,s.slot,t);return n==null?void 0:n.beginSlot(s)}render(e,r){const t=this._renderGeometries;if(t.size===0)return;const{bind:s}=e,i=s.slot===R.OCCLUDER_MATERIAL||s.slot===R.TRANSPARENT_OCCLUDER_MATERIAL?s.slot:null,n=e.rctx;n.runAppleAmdDriverHelper(),n.bindTechnique(r,s,this.material.parameters);const a=r.program;for(const[d,o]of t)this._drawParameters.origin=o.localOrigin,a.bindDraw(s,this.material.parameters,this._drawParameters),r.ensureAttributeLocations(o.vao),n.bindVAO(o.vao),n.setPipelineState(r.getPipeline(!1,i)),n.drawArrays(r.primitiveType,0,o.numElements)}initializeRenderContext(e,r){this._glMaterials=new B(this.material,e.materials);const t=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,E(this._bufferWriter.vertexBufferLayout));this._vaoCache=t}uninitializeRenderContext(){}addRenderGeometry(e,r,t){this.removeRenderGeometry(e);const s=this._bufferWriter.vertexBufferLayout.stride,i=this._vaoCache.newVao(F(r.data.byteLength));i.vertexBuffers.get("geometry").setSubData(new Uint8Array(r.data),0,0,r.elementCount*s);const n={localOrigin:t,vao:i,numElements:r.elementCount};return this._renderGeometries.set(e,n),n}removeRenderGeometry(e){const r=this._renderGeometries.get(e);r!=null&&(this._vaoCache.deleteVao(r.vao),this._renderGeometries.delete(e))}};f([C({constructOnly:!0})],m.prototype,"material",void 0),m=f([_("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],m);let p=class{constructor(e){this._optionalFields=new Array,this._instanceIndexToFeatureId=new Map,this._featureIdToInstanceIndex=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this.layerUid=e.layerUid,this.view=e.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}async doLoad(e,r,t){T("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(H.OBJECTANDLAYERIDCOLOR);const s=Y(o=>r(o),e),i=this.view._stage,n=O(s);i.addMany(n),this._addDisposeResource(()=>i.removeMany(n));const a=U(s);i.addMany(a),this._addDisposeResource(()=>{a.forEach(o=>o.unload()),i.removeMany(a)}),await Promise.all(a.map(o=>this.view._stage.schedule(()=>o.load(i.renderView.renderingContext),t))),I(t);const d=await this._createLodRenderer(s,t);this._lodRendererResources={lodRenderer:d,materials:n,textures:a}}addInstances(e){const r=this._lodRendererResources;if(r==null)return;const{featureIds:t,localTransforms:s,globalTransforms:i}=e,n=r.lodRenderer;if(n==null)return;const a=n.instanceData,d=t.length;for(let o=0;o<d;++o){const l=t[o],c=a.addInstance(),g=a.view,y=16*o;g.localTransform.copyFromTypedBuffer(c,s,y),g.globalTransform.copyFromTypedBuffer(c,i,y),a.updateModelTransform(c),a.setVisible(c,!0),this._instanceIndexToFeatureId.set(c,l),this._featureIdToInstanceIndex.set(l,c)}}removeInstances(e){const r=this._lodRendererResources;if(r==null)return;const t=r==null?void 0:r.lodRenderer,s=t.instanceData,i=this._instanceIndexToFeatureId,n=this._featureIdToInstanceIndex,a=e.length;for(let d=0;d<a;++d){const o=e[d],l=n.get(o);l!=null&&(s.removeInstance(l),i.delete(l),n.delete(o))}}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createLodRenderer(e,r){const t=this.view._stage,s={layerUid:this.layerUid,graphicUid:n=>1,notifyGraphicGeometryChanged:n=>1,notifyGraphicVisibilityChanged:n=>1},i=new D({symbol:e,optionalFields:this._optionalFields,metadata:s,shaderTransformation:null},this.scheduler);return i.slicePlaneEnabled=!1,this._addDisposeResource(()=>{t.removeRenderPlugin(i),i.destroy()}),await t.addRenderPlugin(i,r),i}};function Y(e,r){const t=r.levels.map(s=>{const i=s.components.map(n=>{const a=e(n.materialId);if(!K(a))throw new Error("LodRenderer only supports DefaultMaterial");const d=a.createBufferWriter(),o={material:a,vertexBufferLayout:d.vertexBufferLayout,buffer:n.renderGeometryBuffer.data,elementCount:n.renderGeometryBuffer.elementCount,boundingInfo:n.boundingInfo};return new k(o)});return new V(i,s.minScreenSpaceRadius)});return new z(t)}function K(e){return e!=null&&"materialType"in e&&e.materialType==="default"}p=f([_("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],p);let b=class extends G{constructor(e){super(),this.view=null,this.layerUid=null,this._renderGeometries=new Map,this._materials=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.view=e.view,this.layerUid=e.layerUid}initialize(){}destroy(){}async executeRenderCommands(e){for(const r of e)switch(r.id){case"create-material":await this._createMaterial(r);break;case"create-direct-renderer":await this._createDirectRenderer(r);break;case"add-direct-renderer-geometry":await this._addDirectRendererGeometry(r);break;case"remove-direct-renderer-geometry":await this._removeDirectRendererGeometry(r);break;case"create-lod-renderer":await this._createLodRenderer(r);break;case"add-lod-instances":await this._addLodInstances(r);break;case"remove-lod-instances":await this._removeLodInstances(r)}}async _createMaterial(e){const{view:r}=this,{sharedSymbolResources:t}=r;if(t==null)throw new Error("No shared symbol resources found!");const{textures:s}=t,i=r.state.viewingMode===P.Global;let n=null;switch(e.type){case"default":n=X(t,{physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0,isPrimitive:!0,screenSizePerspectiveEnabled:!0,doublePrecisionRequiresObfuscation:r._stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result},i);break;case"hud":{const[a,d]=Q(s,i);this.addHandles([M(()=>x(d))]),n=a}break;default:throw new Error(`unable to create unknown material type ${e.type}`)}this._materials.set(e.materialId,n)}_getMaterial(e){return this._materials.get(e)}async _createDirectRenderer(e){const r=e.materialId,t=this._getMaterial(r);if(t==null)throw new Error(`material not found ${r}`);const{view:s}=this,i=new m({material:t});this._directRenderers.set(r,i),s._stage.addRenderPlugin(i),s._stage.renderView.renderer.updateHasFlags()}async _addDirectRendererGeometry(e){const r=e.renderGeometryId,t=e.materialId;this._renderGeometries.get(r)!=null&&await this._removeDirectRendererGeometry({renderGeometryId:r});const s=this._directRenderers.get(t);if(s==null)return void console.error("no renderer assigned to provided material");const i=s.addRenderGeometry(r,e.renderGeometryBuffer,e.localOrigin);this._renderGeometries.set(r,{renderGeometry:i,materialId:t}),this.view._stage.renderView.requestRender()}async _removeDirectRendererGeometry(e){const r=e.renderGeometryId,t=this._renderGeometries.get(r);if(t==null)return;const s=t.materialId,i=this._directRenderers.get(s);i!=null?i.removeRenderGeometry(e.renderGeometryId):console.error("no renderer assigned to provided material")}async _createLodRenderer(e){const r=new p({view:this.view,layerUid:this.layerUid}),t=new AbortController,s=i=>this._getMaterial(i);await r.doLoad(e.lodRenderGeometry,s,t.signal),this._lodRenderers.set(e.lodRendererId,r)}async _addLodInstances(e){const r=this._lodRenderers.get(e.lodRendererId);if(r==null)throw new Error("no lod renderer assigned to provided lod renderer Id");r.addInstances(e.data)}async _removeLodInstances(e){const r=this._lodRenderers.get(e.lodRendererId);if(r==null)throw new Error("no lod renderer assigned to provided lod renderer Id");r.removeInstances(e.featureIds)}};function Q(e,r){const t={anchorPosition:S.center,occlusionTest:!0,hasSlicePlane:!1},s=t,i=1;s.color=[1,0,0,1],s.outlineColor=[0,0,0,1],s.outlineSize=i;const n=null;if(e!=null){const a=e.fromData("circle-icon",()=>q("circle"));s.textureId=a.texture.id,s.textureIsSignedDistanceField=!0,s.sampleSignedDistanceFieldTexelCenter=N("circle")}return s.distanceFieldBoundingBox=ee,[new J(t,r),n]}function X(e,r,t){const s={usePBR:r.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:j,ambient:w,diffuse:w,hasSlicePlane:r.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:r.castShadows,offsetTransparentBackfaces:!r.isPrimitive};return Z(s),s.screenSizePerspective=e.screenSizePerspectiveSettings,s.externalColor=L,s.isInstanced=!0,new W(s,{spherical:t,doublePrecisionRequiresObfuscation:!0})}function Z(e){const r=e.opacity??1,t=r<1;return e.transparent=t,e.opacity=r,e.cullFace=t?v.None:v.Back,e}b=f([_("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],b);const ee=[h/2,h/2,1-h/2,1-h/2];export{Q as b,b as y};
