import{A as he,c as l,f as r,g as y,ay as j,aY as Me,b0 as C,aZ as z,fT as Ge,gA as De,D as ge,a4 as Re,s as k,aB as Ce,iQ as S,fU as de,eL as Ae,j3 as me,eK as He,j4 as Ve,da as Pe,gz as ee,ey as Le,a_ as we,iN as Ie,j5 as _e,a5 as v,bm as Z,dG as ye,gR as Je,cj as xe,ba as fe,m as We,aE as ie,c_ as Ze,di as Ke,eu as Qe,j as te}from"./index-XUlETPJZ.js";import{p as Se}from"./LegendOptions-KuTIRvg3.js";import{a as Ye}from"./diffUtils-FaRWg0DV.js";import{j as Xe,c as Y,b as Fe}from"./SizeVariable-eDAmtsU9.js";import{a as et}from"./ColorStop-FEjpkiot.js";import{l as K}from"./jsonUtils-FMkyl16O.js";import{c as tt}from"./styleUtils-dULYu5Y-.js";const se=new he({simple:"simple",uniqueValue:"unique-value",classBreaks:"class-breaks",heatmap:"heatmap",dotDensity:"dot-density",dictionary:"dictionary",pieChart:"pie-chart"},{ignoreUnknown:!0});let M=class extends j{constructor(t){super(t),this.authoringInfo=null,this.type=null}async getRequiredFields(t){if(!this.collectRequiredFields)return[];const s=new Set;return await this.collectRequiredFields(s,t),Array.from(s).sort()}getSymbol(t,s){}async getSymbolAsync(t,s){}getSymbols(){return[]}getAttributeHash(){return JSON.stringify(this)}getMeshHash(){return JSON.stringify(this)}};l([r({type:Xe,json:{write:!0}})],M.prototype,"authoringInfo",void 0),l([r({type:se.apiValues,readOnly:!0,json:{type:se.jsonValues,read:!1,write:{writer:se.write,ignoreOrigin:!0}}})],M.prototype,"type",void 0),M=l([y("esri.renderers.Renderer")],M);const qe=M;function st(e){var t,s;return((s=(t=e.match(it))==null?void 0:t[1])==null?void 0:s.replace(/\\'/g,"'"))??null}const it=/^hash\(\$feature\['((\\'|[^'])+)'\]\) \* 8\.381e-8$/;var le;let q=le=class extends Y{constructor(e){super(e),this.type="color",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(e){e&&Array.isArray(e)&&(e=e.filter(t=>!!t)).sort((t,s)=>t.value-s.value),this._set("stops",e)}clone(){var e;return new le({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(t=>t.clone()),legendOptions:(e=this.legendOptions)==null?void 0:e.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};l([r({readOnly:!0})],q.prototype,"cache",null),l([r({type:["color"],json:{type:["colorInfo"]}})],q.prototype,"type",void 0),l([r({type:String,json:{write:!0}})],q.prototype,"normalizationField",void 0),l([r({type:[et],json:{write:!0}})],q.prototype,"stops",null),q=le=l([y("esri.renderers.visualVariables.ColorVariable")],q);const $e=q;var ae;let I=ae=class extends j{constructor(e){super(e),this.label=null,this.opacity=null,this.value=null}readOpacity(e,t){return Ge(t.transparency)}writeOpacity(e,t,s){t[s]=De(e)}clone(){return new ae({label:this.label,opacity:this.opacity,value:this.value})}};l([r({type:String,json:{write:!0}})],I.prototype,"label",void 0),l([r({type:Number,json:{type:Me,write:{target:"transparency"}}})],I.prototype,"opacity",void 0),l([C("opacity",["transparency"])],I.prototype,"readOpacity",null),l([z("opacity")],I.prototype,"writeOpacity",null),l([r({type:Number,json:{write:!0}})],I.prototype,"value",void 0),I=ae=l([y("esri.renderers.visualVariables.support.OpacityStop")],I);const lt=I;var oe;let $=oe=class extends Y{constructor(e){super(e),this.type="opacity",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(e){e&&Array.isArray(e)&&(e=e.filter(t=>!!t)).sort((t,s)=>t.value-s.value),this._set("stops",e)}clone(){var e;return new oe({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(t=>t.clone()),legendOptions:(e=this.legendOptions)==null?void 0:e.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};l([r({readOnly:!0})],$.prototype,"cache",null),l([r({type:["opacity"],json:{type:["transparencyInfo"]}})],$.prototype,"type",void 0),l([r({type:String,json:{write:!0}})],$.prototype,"normalizationField",void 0),l([r({type:[lt],json:{write:!0}})],$.prototype,"stops",null),$=oe=l([y("esri.renderers.visualVariables.OpacityVariable")],$);const Ee=$;var re;let b=re=class extends Y{constructor(e){super(e),this.axis=null,this.type="rotation",this.rotationType="geographic",this.valueExpressionTitle=null}get cache(){return{hasExpression:!!this.valueExpression,compiledFunc:null}}writeValueExpressionTitleWebScene(e,t,s,i){if(i!=null&&i.messages){const a=`visualVariables[${this.index}]`;i.messages.push(new ge("property:unsupported",this.type+"VisualVariable.valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:a+".valueExpressionTitle",context:i}))}}clone(){var e;return new re({axis:this.axis,rotationType:this.rotationType,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,legendOptions:(e=this.legendOptions)==null?void 0:e.clone()})}};l([r({readOnly:!0})],b.prototype,"cache",null),l([r({type:["heading","tilt","roll"],json:{origins:{"web-scene":{default:"heading",write:!0}}}})],b.prototype,"axis",void 0),l([r({type:["rotation"],json:{type:["rotationInfo"]}})],b.prototype,"type",void 0),l([r({type:["geographic","arithmetic"],json:{write:!0,origins:{"web-document":{write:!0,default:"geographic"}}}})],b.prototype,"rotationType",void 0),l([r({type:String,json:{write:!0}})],b.prototype,"valueExpressionTitle",void 0),l([z("web-scene","valueExpressionTitle")],b.prototype,"writeValueExpressionTitleWebScene",null),b=re=l([y("esri.renderers.visualVariables.RotationVariable")],b);const je=b,at={color:$e,size:Fe,opacity:Ee,rotation:je},ot=new he({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"}),rt=/^\[([^\]]+)\]$/i;let P=class extends Re{constructor(){super(...arguments),this.colorVariables=null,this.opacityVariables=null,this.rotationVariables=null,this.sizeVariables=null}set visualVariables(t){if(this._resetVariables(),t=t&&t.filter(s=>!!s),t==null?void 0:t.length){for(const s of t)switch(s.type){case"color":this.colorVariables.push(s);break;case"opacity":this.opacityVariables.push(s);break;case"rotation":this.rotationVariables.push(s);break;case"size":this.sizeVariables.push(s)}this.sizeVariables.length&&this.sizeVariables.some(s=>!!s.target)&&t.sort((s,i)=>{let a=null;return a=s.target===i.target?0:s.target?1:-1,a});for(let s=0;s<t.length;s++)t[s].index=s;this._set("visualVariables",t)}else this._set("visualVariables",t)}readVariables(t,s,i){const{rotationExpression:a,rotationType:o}=s,n=a==null?void 0:a.match(rt),h=n==null?void 0:n[1];if(h&&(t||(t=[]),t.push({type:"rotationInfo",rotationType:o,field:h})),t)return t.map(p=>{const d=ot.read(p.type),m=at[d];m||(k.getLogger(this).warn(`Unknown variable type: ${d}`),i!=null&&i.messages&&i.messages.push(new Ce("visual-variable:unsupported",`visualVariable of type '${d}' is not supported`,{definition:p,context:i})));const f=new m;return f.read(p,i),f})}writeVariables(t,s){const i=[];for(const a of t){const o=a.toJSON(s);o&&i.push(o)}return i}_resetVariables(){this.colorVariables=[],this.opacityVariables=[],this.rotationVariables=[],this.sizeVariables=[]}};l([r()],P.prototype,"visualVariables",null),P=l([y("esri.renderers.visualVariables.VisualVariableFactory")],P);const nt=P,ut={base:Y,key:"type",typeMap:{opacity:Ee,color:$e,rotation:je,size:Fe}},Oe=e=>{let t=class extends e{constructor(){super(...arguments),this._vvFactory=new nt}set visualVariables(s){this._vvFactory.visualVariables=s,this._set("visualVariables",this._vvFactory.visualVariables)}readVisualVariables(s,i,a){return this._vvFactory.readVariables(s,i,a)}writeVisualVariables(s,i,a,o){i[a]=this._vvFactory.writeVariables(s,o)}get arcadeRequiredForVisualVariables(){if(!this.visualVariables)return!1;for(const s of this.visualVariables)if(s.arcadeRequired)return!0;return!1}hasVisualVariables(s,i){return s?this.getVisualVariablesForType(s,i).length>0:this.getVisualVariablesForType("size",i).length>0||this.getVisualVariablesForType("color",i).length>0||this.getVisualVariablesForType("opacity",i).length>0||this.getVisualVariablesForType("rotation",i).length>0}getVisualVariablesForType(s,i){const a=this.visualVariables;return a?a.filter(o=>o.type===s&&(typeof i=="string"?o.target===i:i!==!1||!o.target)):[]}async collectVVRequiredFields(s,i){let a=[];this.visualVariables&&(a=a.concat(this.visualVariables));for(const o of a)o&&(o.field&&S(s,i,o.field),o.normalizationField&&S(s,i,o.normalizationField),o.valueExpression&&(pt(o.valueExpression,s,i)||await de(s,i,o.valueExpression)))}};return l([r({types:[ut],value:null,json:{write:!0}})],t.prototype,"visualVariables",null),l([C("visualVariables",["visualVariables","rotationType","rotationExpression"])],t.prototype,"readVisualVariables",null),l([z("visualVariables")],t.prototype,"writeVisualVariables",null),t=l([y("esri.renderers.mixins.VisualVariablesMixin")],t),t};function pt(e,t,s){const i=st(e);return i!=null&&(S(t,s,i),!0)}const X={types:Ae,json:{write:{writer:K},origins:{"web-scene":{types:me,write:{writer:K},read:{reader:He({types:me})}}}}},ke=Ve({json:{origins:{"web-scene":{write:{isRequired:!0}}}}},X),Ue={types:{base:Pe,key:"type",typeMap:{"simple-fill":ee.typeMap["simple-fill"],"picture-fill":ee.typeMap["picture-fill"],"polygon-3d":ee.typeMap["polygon-3d"]}},json:{write:{writer:K},origins:{"web-scene":{type:Le,write:{writer:K}}}}},L={cast:e=>e==null||typeof e=="string"||typeof e=="number"?e:`${e}`,json:{type:String,write:{writer:(e,t)=>{t.value=e==null?void 0:e.toString()}}}};var ne;let _=ne=class extends j{constructor(e){super(e),this.description=null,this.label=null,this.minValue=null,this.maxValue=0,this.symbol=null}clone(){return new ne({description:this.description,label:this.label,minValue:this.minValue,maxValue:this.maxValue,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const e=JSON.stringify(this.symbol);return`${this.minValue}.${this.maxValue}.${e}`}};l([r({type:String,json:{write:!0}})],_.prototype,"description",void 0),l([r({type:String,json:{write:!0}})],_.prototype,"label",void 0),l([r({type:Number,json:{read:{source:"classMinValue"},write:{target:"classMinValue"}}})],_.prototype,"minValue",void 0),l([r({type:Number,json:{read:{source:"classMaxValue"},write:{target:"classMaxValue"}}})],_.prototype,"maxValue",void 0),l([r(ke)],_.prototype,"symbol",void 0),_=ne=l([y("esri.renderers.support.ClassBreakInfo")],_);const Q=_;var ue;const ze="log",J="percent-of-total",W="field",H=new he({esriNormalizeByLog:ze,esriNormalizeByPercentOfTotal:J,esriNormalizeByField:W}),ct=we(Q);let c=ue=class extends Oe(qe){constructor(e){super(e),this._compiledValueExpression={valueExpression:null,compiledFunction:null},this.backgroundFillSymbol=null,this.classBreakInfos=null,this.defaultLabel=null,this.defaultSymbol=null,this.field=null,this.isMaxInclusive=!0,this.legendOptions=null,this.normalizationField=null,this.normalizationTotal=null,this.type="class-breaks",this.valueExpression=null,this.valueExpressionTitle=null,this._set("classBreakInfos",[])}readClassBreakInfos(e,t,s){if(!Array.isArray(e))return;let i=t.minValue;return e.map(a=>{const o=new Q;return o.read(a,s),o.minValue==null&&(o.minValue=i),o.maxValue==null&&(o.maxValue=o.minValue),i=o.maxValue,o})}writeClassBreakInfos(e,t,s,i){const a=e.map(o=>o.write({},i));this._areClassBreaksConsecutive()&&a.forEach(o=>delete o.classMinValue),t[s]=a}castField(e){return e==null?e:typeof e=="function"?(k.getLogger(this).error(".field: field must be a string value"),null):Ie(e)}get minValue(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0}get normalizationType(){let e=this._get("normalizationType");const t=!!this.normalizationField,s=this.normalizationTotal!=null;return t||s?(e=t&&W||s&&J||null,t&&s&&k.getLogger(this).warn("warning: both normalizationField and normalizationTotal are set!")):e!==W&&e!==J||(e=null),e}set normalizationType(e){this._set("normalizationType",e)}addClassBreakInfo(e,t,s){let i=null;i=typeof e=="number"?new Q({minValue:e,maxValue:t,symbol:_e(s)}):ct(v(e)),this.classBreakInfos.push(i),this.classBreakInfos.length===1&&this.notifyChange("minValue")}removeClassBreakInfo(e,t){const s=this.classBreakInfos.length;for(let i=0;i<s;i++){const a=[this.classBreakInfos[i].minValue,this.classBreakInfos[i].maxValue];if(a[0]===e&&a[1]===t){this.classBreakInfos.splice(i,1);break}}}getBreakIndex(e,t){return this.valueExpression&&(t==null?void 0:t.arcade)==null&&k.getLogger(this).warn(""),this.valueExpression?this._getBreakIndexForExpression(e,t):this._getBreakIndexForField(e)}async getClassBreakInfo(e,t){let s=t;this.valueExpression&&(t==null?void 0:t.arcade)==null&&(s={...s,arcade:await Z()});const i=this.getBreakIndex(e,s);return i!==-1?this.classBreakInfos[i]:null}getSymbol(e,t){if(this.valueExpression&&(t==null?void 0:t.arcade)==null)return void k.getLogger(this).error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const s=this.getBreakIndex(e,t);return s>-1?this.classBreakInfos[s].symbol:this.defaultSymbol}async getSymbolAsync(e,t){let s=t;if(this.valueExpression&&(t==null?void 0:t.arcade)==null){const a=await Z(),{arcadeUtils:o}=a;o.hasGeometryOperations(this.valueExpression)&&await o.enableGeometryOperations(),s={...s,arcade:a}}const i=this.getBreakIndex(e,s);return i>-1?this.classBreakInfos[i].symbol:this.defaultSymbol}getSymbols(){const e=[];return this.classBreakInfos.forEach(t=>{t.symbol&&e.push(t.symbol)}),this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),s=`${this.normalizationField}.${this.normalizationType}.${this.normalizationTotal}`;return`${e}.${t}.${this.classBreakInfos.reduce((i,a)=>i+a.getMeshHash(),"")}.${s}.${this.field}.${this.valueExpression}`}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}clone(){var e,t;return new ue({field:this.field,backgroundFillSymbol:(e=this.backgroundFillSymbol)==null?void 0:e.clone(),defaultLabel:this.defaultLabel,defaultSymbol:(t=this.defaultSymbol)==null?void 0:t.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:v(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:v(this.visualVariables),legendOptions:v(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}async collectRequiredFields(e,t){const s=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(s)}async collectSymbolFields(e,t){const s=[...this.getSymbols().map(i=>i.collectRequiredFields(e,t)),de(e,t,this.valueExpression)];S(e,t,this.field),S(e,t,this.normalizationField),await Promise.all(s)}_getBreakIndexForExpression(e,t){const{viewingMode:s,scale:i,spatialReference:a,arcade:o,timeZone:n}=t??{},{valueExpression:h}=this;let p=this._compiledValueExpression.valueExpression===h?this._compiledValueExpression.compiledFunction:null;const d=o.arcadeUtils;if(!p){const f=d.createSyntaxTree(h);p=d.createFunction(f),this._compiledValueExpression.compiledFunction=p}this._compiledValueExpression.valueExpression=h;const m=d.executeFunction(p,d.createExecContext(e,d.getViewInfo({viewingMode:s,scale:i,spatialReference:a}),n));return this._getBreakIndexfromInfos(m)}_getBreakIndexForField(e){const t=this.field,s=e.attributes,i=this.normalizationType;let a=parseFloat(s[t]);if(i){const o=this.normalizationTotal,n=parseFloat(this.normalizationField?s[this.normalizationField]:void 0);if(i===ze)a=Math.log(a)*Math.LOG10E;else if(i!==J||o==null||isNaN(o)){if(i===W&&!isNaN(n)){if(isNaN(a)||isNaN(n))return-1;a/=n}}else a=a/o*100}return this._getBreakIndexfromInfos(a)}_getBreakIndexfromInfos(e){const t=this.isMaxInclusive;if(e!=null&&typeof e=="number"&&!isNaN(e))for(let s=0;s<this.classBreakInfos.length;s++){const i=[this.classBreakInfos[s].minValue,this.classBreakInfos[s].maxValue];if(i[0]<=e&&(t?e<=i[1]:e<i[1]))return s}return-1}_areClassBreaksConsecutive(){const e=this.classBreakInfos,t=e.length;for(let s=1;s<t;s++)if(e[s-1].maxValue!==e[s].minValue)return!1;return!0}};l([r(Ue)],c.prototype,"backgroundFillSymbol",void 0),l([r({type:[Q]})],c.prototype,"classBreakInfos",void 0),l([C("classBreakInfos")],c.prototype,"readClassBreakInfos",null),l([z("classBreakInfos")],c.prototype,"writeClassBreakInfos",null),l([r({type:String,json:{write:!0}})],c.prototype,"defaultLabel",void 0),l([r(X)],c.prototype,"defaultSymbol",void 0),l([r({type:String,json:{write:!0}})],c.prototype,"field",void 0),l([ye("field")],c.prototype,"castField",null),l([r({type:Boolean})],c.prototype,"isMaxInclusive",void 0),l([r({type:Se,json:{write:!0}})],c.prototype,"legendOptions",void 0),l([r({type:Number,readOnly:!0,value:null,json:{read:!1,write:{overridePolicy(){return this.classBreakInfos.length!==0&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],c.prototype,"minValue",null),l([r({type:String,json:{write:!0}})],c.prototype,"normalizationField",void 0),l([r({type:Number,cast:e=>Je(e),json:{write:!0}})],c.prototype,"normalizationTotal",void 0),l([r({type:H.apiValues,value:null,json:{type:H.jsonValues,read:H.read,write:H.write}})],c.prototype,"normalizationType",null),l([xe({classBreaks:"class-breaks"})],c.prototype,"type",void 0),l([r({type:String,json:{write:!0}})],c.prototype,"valueExpression",void 0),l([r({type:String,json:{write:!0}})],c.prototype,"valueExpressionTitle",void 0),c=ue=l([y("esri.renderers.ClassBreaksRenderer")],c);const xt=c;let O=class extends fe(j){constructor(t){super(t),this.value=null,this.value2=null,this.value3=null}};l([r(L)],O.prototype,"value",void 0),l([r(L)],O.prototype,"value2",void 0),l([r(L)],O.prototype,"value3",void 0),O=l([y("esri.renderers.support.UniqueValue")],O);const U=O;let x=class extends fe(j){constructor(t){super(t),this.description=null,this.label=null,this.symbol=null,this.values=null}castValues(t){if(t==null)return null;const s=typeof(t=Array.isArray(t)?t:[t])[0];return s==="string"||s==="number"?t.map(i=>new U({value:i})):s==="object"?t[0]instanceof U?t:t.map(i=>new U(i)):null}};l([r({type:String,json:{write:!0}})],x.prototype,"description",void 0),l([r({type:String,json:{write:!0}})],x.prototype,"label",void 0),l([r(X)],x.prototype,"symbol",void 0),l([r({type:[U],json:{type:[[String]],read:{reader:e=>e?e.map(t=>new U({value:t[0],value2:t[1],value3:t[2]})):null},write:{writer:(e,t)=>{const s=[];for(const i of e){const a=[i.value,i.value2,i.value3].filter(We).map(o=>o.toString());s.push(a)}t.values=s}}}})],x.prototype,"values",void 0),l([ye("values")],x.prototype,"castValues",null),x=l([y("esri.renderers.support.UniqueValueClass")],x);const Be=x;let G=class extends fe(j){constructor(e){super(e),this.heading=null,this.classes=null}};l([r({type:String,json:{write:!0}})],G.prototype,"heading",void 0),l([r({type:[Be],json:{write:!0}})],G.prototype,"classes",void 0),G=l([y("esri.renderers.support.UniqueValueGroup")],G);const pe=G;var ce;let E=ce=class extends j{constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.value=null}clone(){return new ce({value:this.value,description:this.description,label:this.label,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){var t;const e=JSON.stringify((t=this.symbol)==null?void 0:t.toJSON());return`${this.value}.${e}`}};l([r({type:String,json:{write:!0}})],E.prototype,"description",void 0),l([r({type:String,json:{write:!0}})],E.prototype,"label",void 0),l([r(ke)],E.prototype,"symbol",void 0),l([r(L)],E.prototype,"value",void 0),E=ce=l([y("esri.renderers.support.UniqueValueInfo")],E);const R=E;var D;const Te="esri.renderers.UniqueValueRenderer",w=k.getLogger(Te),ve="uvInfos-watcher",be="uvGroups-watcher",ht=",",dt=we(R);function yt(e){const{field1:t,field2:s,field3:i,fieldDelimiter:a,uniqueValueInfos:o,valueExpression:n}=e,h=!(!t||!s);return[{classes:(o??[]).map(p=>{var F;const{symbol:d,label:m,value:f,description:g}=p,[B,T,N]=h?((F=f==null?void 0:f.toString())==null?void 0:F.split(a||""))||[]:[f],V=[];return(t||n)&&V.push(B),s&&V.push(T),i&&V.push(N),{symbol:d,label:m,values:[V],description:g}})}]}let u=D=class extends Oe(qe){constructor(e){super(e),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this._isInfosSource=null,this.type="unique-value",this.backgroundFillSymbol=null,this.orderByClassesEnabled=!1,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(t,s){if(!t&&!s)return;if(!t||!s)return{type:"complete",oldValue:t,newValue:s};let i=!1;const a={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let o=0;o<s.length;o++){const n=t.find(h=>h.value===s[o].value);n?Ye(n,s[o])?(a.changed.push({type:"complete",oldValue:n,newValue:s[o]}),i=!0):a.unchanged.push({oldValue:n,newValue:s[o]}):(a.added.push(s[o]),i=!0)}for(let o=0;o<t.length;o++)s.find(n=>n.value===t[o].value)||(a.removed.push(t[o]),i=!0);return i?a:void 0}},this._set("uniqueValueInfos",[]),this._set("uniqueValueGroups",[])}get _cache(){return{compiledFunc:null}}set field(e){this._set("field",e),this._updateFieldDelimiter(),this._updateUniqueValues()}castField(e){return e==null||typeof e=="function"?e:Ie(e)}writeField(e,t,s,i){typeof e=="string"?t[s]=e:i!=null&&i.messages?i.messages.push(new ge("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):w.error(".field: cannot write field to JSON since it's not a string value")}set field2(e){this._set("field2",e),this._updateFieldDelimiter(),this._updateUniqueValues()}set field3(e){this._set("field3",e),this._updateUniqueValues()}set valueExpression(e){this._set("valueExpression",e),this._updateUniqueValues()}set defaultSymbol(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}set fieldDelimiter(e){this._set("fieldDelimiter",e),this._updateUniqueValues()}readPortal(e,t,s){return s.portal||ie.getDefault()}readStyleOrigin(e,t,s){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const i=Ze(t.styleUrl,s);return Object.freeze({styleUrl:i})}}writeStyleOrigin(e,t,s,i){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=Ke(e.styleUrl,i))}set uniqueValueGroups(e){this.styleOrigin?w.error("#uniqueValueGroups=","Cannot modify unique value groups of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueGroups",e),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups())}set uniqueValueInfos(e){this.styleOrigin?w.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())}addUniqueValueInfo(e,t){var i;if(this.styleOrigin)return void w.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let s;s=typeof e=="object"?dt(e):new R({value:e,symbol:_e(t)}),(i=this.uniqueValueInfos)==null||i.push(s),this._valueInfoMap[s.value]=s,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}removeUniqueValueInfo(e){if(this.styleOrigin)return void w.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");const t=this.uniqueValueInfos;if(t)for(let s=0;s<t.length;s++){const i=t[s];if(String(i.value)===String(e)){delete this._valueInfoMap[e],t.splice(s,1);break}}this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}async getUniqueValueInfo(e,t){let s=t;return this.valueExpression&&(t==null?void 0:t.arcade)==null&&(s={...s,arcade:await Z()}),this._getUniqueValueInfo(e,s)}getSymbol(e,t){if(this.valueExpression&&(t==null?void 0:t.arcade)==null)return void w.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const s=this._getUniqueValueInfo(e,t);return(s==null?void 0:s.symbol)||this.defaultSymbol}async getSymbolAsync(e,t){let s=t;if(this.valueExpression&&(s==null?void 0:s.arcade)==null){const a=await Z(),{arcadeUtils:o}=a;o.hasGeometryOperations(this.valueExpression)&&await o.enableGeometryOperations(),s={...s,arcade:a}}const i=this._getUniqueValueInfo(e,s);return(i==null?void 0:i.symbol)||this.defaultSymbol}getSymbols(){const e=[];for(const t of this.uniqueValueInfos??[])t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){var i;const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),s=(i=this.uniqueValueInfos)==null?void 0:i.reduce((a,o)=>a+o.getMeshHash(),"");return`${e}.${t}.${s}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`}clone(){const e=new D({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:v(this.defaultSymbol),orderByClassesEnabled:this.orderByClassesEnabled,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:v(this.visualVariables),legendOptions:v(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:v(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=v(this.uniqueValueInfos),s=v(this.uniqueValueGroups);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(v(this.styleOrigin))),Object.freeze(t),Object.freeze(s)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e._set("uniqueValueGroups",s),e._isInfosSource=this._isInfosSource,e._watchUniqueValueInfosAndGroups(),e}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(e,t){const s=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(s)}async collectSymbolFields(e,t){const s=[...this.getSymbols().map(i=>i.collectRequiredFields(e,t)),de(e,t,this.valueExpression)];S(e,t,this.field),S(e,t,this.field2),S(e,t,this.field3),await Promise.all(s)}populateFromStyle(){return tt(this.styleOrigin,{portal:this.portal}).then(e=>{var s;const t=[];return this._valueInfoMap={},e&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach(i=>{const a=new Qe({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:i.name});this.defaultSymbol||i.name!==e.data.defaultItem||(this.defaultSymbol=a,this._isDefaultSymbolDerived=!0);const o=new R({value:i.name,symbol:a});t.push(o),this._valueInfoMap[i.name]=o}),this._set("uniqueValueInfos",Object.freeze(t)),this._updateGroupsFromInfos(!0),this._isInfosSource=null,this._watchUniqueValueInfos(),!this.defaultSymbol&&((s=this.uniqueValueInfos)!=null&&s.length)&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateFieldDelimiter(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",ht)}_updateUniqueValues(){this._isInfosSource!=null&&(this._isInfosSource?this._updateGroupsFromInfos():this._updateInfosFromGroups())}_updateValueInfoMap(){this._valueInfoMap={};const{uniqueValueInfos:e}=this;if(e)for(const t of e)this._valueInfoMap[t.value+""]=t}_watchUniqueValueInfosAndGroups(){this._watchUniqueValueInfos(),this._watchUniqueValueGroups()}_watchUniqueValueInfos(){this.removeHandles(ve);const{uniqueValueInfos:e}=this;if(e){const t=[];for(const s of e)t.push(te(()=>({symbol:s.symbol,value:s.value,label:s.label,description:s.description}),(i,a)=>{i!==a&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)},{sync:!0}));this.addHandles(t,ve)}}_watchUniqueValueGroups(){this.removeHandles(be);const{uniqueValueGroups:e}=this;if(e){const t=[];for(const s of e){t.push(te(()=>({classes:s.classes}),(i,a)=>{i!==a&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}));for(const i of s.classes??[])t.push(te(()=>({symbol:i.symbol,values:i.values,label:i.label,description:i.description}),(a,o)=>{a!==o&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}))}this.addHandles(t,be)}}_updateInfosFromGroups(){if(!this.uniqueValueGroups)return this._set("uniqueValueInfos",null),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const e=[],{field:t,field2:s,field3:i,fieldDelimiter:a,uniqueValueGroups:o,valueExpression:n}=this;if(!t&&!n)return this._set("uniqueValueInfos",e),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const h=!(!t||!s);for(const p of o)for(const d of p.classes??[]){const{symbol:m,label:f,values:g,description:B}=d;for(const T of g??[]){const{value:N,value2:V,value3:F}=T,A=[N];s&&A.push(V),i&&A.push(F);const Ne=h?A.join(a||""):A[0];e.push(new R({symbol:m,label:f,value:Ne,description:B}))}}this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._watchUniqueValueInfos()}_updateGroupsFromInfos(e=!1){if(!this.uniqueValueInfos)return this._set("uniqueValueGroups",null),void this._watchUniqueValueGroups();const{field:t,field2:s,valueExpression:i,fieldDelimiter:a,uniqueValueInfos:o}=this;if(!t&&!i||!o.length)return this._set("uniqueValueGroups",[]),void this._watchUniqueValueGroups();const n=!(!t||!s),h=o.map(d=>{var F;const{symbol:m,label:f,value:g,description:B}=d,[T,N,V]=n?((F=g==null?void 0:g.toString())==null?void 0:F.split(a||""))||[]:[g];return new Be({symbol:m,label:f,description:B,values:[new U({value:T,value2:N,value3:V})]})}),p=[new pe({classes:h})];e&&Object.freeze(p),this._set("uniqueValueGroups",p),this._watchUniqueValueGroups()}_getUniqueValueInfo(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)}_getUnqiueValueInfoForExpression(e,t){const{viewingMode:s,scale:i,spatialReference:a,arcade:o,timeZone:n}=t??{};let h=this._cache.compiledFunc;const p=o.arcadeUtils;if(!h){const m=p.createSyntaxTree(this.valueExpression);h=p.createFunction(m),this._cache.compiledFunc=h}const d=p.executeFunction(h,p.createExecContext(e,p.getViewInfo({viewingMode:s,scale:i,spatialReference:a}),n));return this._valueInfoMap[d+""]}_getUnqiueValueInfoForFields(e){const t=this.field,s=e.attributes;let i;if(typeof t!="function"&&this.field2){const a=this.field2,o=this.field3,n=[];t&&n.push(s[t]),a&&n.push(s[a]),o&&n.push(s[o]),i=n.join(this.fieldDelimiter||"")}else typeof t=="function"?i=t(e):t&&(i=s[t]);return this._valueInfoMap[i+""]}static fromPortalStyle(e,t){const s=new D(t==null?void 0:t.properties);s._set("styleOrigin",Object.freeze({styleName:e})),s._set("portal",(t==null?void 0:t.portal)||ie.getDefault());const i=s.populateFromStyle();return i.catch(a=>{w.error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",a)}),i}static fromStyleUrl(e,t){const s=new D(t==null?void 0:t.properties);s._set("styleOrigin",Object.freeze({styleUrl:e}));const i=s.populateFromStyle();return i.catch(a=>{w.error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",a)}),i}};l([r({readOnly:!0})],u.prototype,"_cache",null),l([xe({uniqueValue:"unique-value"})],u.prototype,"type",void 0),l([r(Ue)],u.prototype,"backgroundFillSymbol",void 0),l([r({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],u.prototype,"field",null),l([ye("field")],u.prototype,"castField",null),l([z("field")],u.prototype,"writeField",null),l([r({type:String,value:null,json:{write:!0}})],u.prototype,"field2",null),l([r({type:String,value:null,json:{write:!0}})],u.prototype,"field3",null),l([r({type:Boolean,json:{name:"drawInClassOrder",default:!1,write:!0,origins:{"web-scene":{write:!1}}}})],u.prototype,"orderByClassesEnabled",void 0),l([r({type:String,value:null,json:{write:!0}})],u.prototype,"valueExpression",null),l([r({type:String,json:{write:!0}})],u.prototype,"valueExpressionTitle",void 0),l([r({type:Se,json:{write:!0}})],u.prototype,"legendOptions",void 0),l([r({type:String,json:{write:!0}})],u.prototype,"defaultLabel",void 0),l([r(Ve({...X},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],u.prototype,"defaultSymbol",null),l([r({type:String,value:null,json:{write:!0}})],u.prototype,"fieldDelimiter",null),l([r({type:ie,readOnly:!0})],u.prototype,"portal",void 0),l([C("portal",["styleName"])],u.prototype,"readPortal",null),l([r({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],u.prototype,"styleOrigin",void 0),l([C("styleOrigin",["styleName","styleUrl"])],u.prototype,"readStyleOrigin",null),l([z("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],u.prototype,"writeStyleOrigin",null),l([r({type:[pe],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(e,t,s)=>(t.uniqueValueGroups||yt(t)).map(i=>pe.fromJSON(i,s))},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],u.prototype,"uniqueValueGroups",null),l([r({type:[R],json:{read:!1,write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],u.prototype,"uniqueValueInfos",null),u=D=l([y(Te)],u);const qt=u;export{qt as A,je as a,Q as b,R as c,ke as n,qe as p,Oe as v,xt as w};
