import{r as w,c as I,h as g,F as E,g as V}from"./index-CeCSsEgo.js";import{l as L}from"./chunk-PVEVZB4O-2c3b8893-zEP54EYc.js";import{u as y}from"./index-c99fc80c-B8Hva1Pq.js";import{ag as S,i as P}from"./index-d2df902e-k_MvfteY.js";import{u as C,m as M}from"./useT9n-e78c8d12-FqRXqX1R.js";import"./component-utils-de9339fe-Dlc67iIs.js";/*!
 * All material copyright Esri, All Rights Reserved, unless otherwise specified.
 * See https://js.arcgis.com/4.30/esri/copyright.txt for details.
 * v4.30.7
 */const N=".calcite-flow-widget{width:350px}calcite-block{margin:0}calcite-pagination{justify-content:center}",F=N,_=M(S),k=class{constructor(e){w(this,e),this.arcgisReady=I(this,"arcgisReady",7),this.arcgisVersioningStateChanged=I(this,"arcgisVersioningStateChanged",7),this.manager=y(this),this.reactiveUtils=L(P),this.viewModel=_(this),this.messages=this.manager.readonly(C({blocking:!0})),this.allowEditingDisabled=!1,this.autoDestroyDisabled=!1,this.closable=!1,this.icon=void 0,this.label=void 0,this.mode=void 0,this.pageSize=5,this.position="top-right",this.referenceElement=void 0,this.state=this.viewModel.state,this.versioningStates=this.viewModel.versioningStates,this.view=this.viewModel.view}async componentWillLoad(){const{watch:e}=this.reactiveUtils;this.manager.onLifecycle(()=>[e(()=>this.viewModel.state,i=>{const{flowElement:n}=this,r=n==null?void 0:n.getElementsByTagName("arcgis-version-management-version-properties")[0],t=n==null?void 0:n.getElementsByTagName("arcgis-version-management-version-list")[0];if(i==="disabled"){r&&this._removeVersionPropertiesFlowItem(n),t&&this._removeVersionListFlowItem(n);return}t&&(t.versionListElementProps={...t.versionListElementProps,executionError:this.viewModel.executionError},t.versionListElementProps={...t.versionListElementProps,state:i}),r&&(r.versionPropertiesElementProps={...r.versionPropertiesElementProps,state:i})})])}async destroy(){await this.manager.destroy()}render(){const{allowEditingDisabled:e,closable:i,flowElement:n,label:r,messages:t,pageSize:o,viewModel:s,viewModel:{loadError:a,state:c}}=this,m=Array.from(s.serviceNameLookup,([l,p])=>({url:l,name:p})),d=c!=="disabled"?g(E,null,m.map(l=>{var f;const p={allowEditing:!e,closable:i,currentUser:s.userLookup.get(l.url),currentVersionIdentifier:s.versioningStateLookup.get(l.url).currentVersionInfo.versionIdentifier,executionError:void 0,flowElement:n,hasAdvEditingUte:s.advancedEditingUserTypeExtensionLookup.get(l.url),heading:r,isVersioningApiAvailable:(s.serverVersionLookup.get(l.url)??0)>=11.2,pageSize:o,serviceName:l.name,state:c,serviceUrl:l.url,strings:t,versionInfos:((f=s.versioningStateLookup.get(l.url))==null?void 0:f.versionInfos)??[]};return g("arcgis-version-management-service-item",{serviceItemElementProps:p,onArcgisGetVersions:async v=>{await this._refreshVersionList(v.detail.serviceUrl)},onArcgisFlowItemBack:()=>{this._removeVersionListFlowItem(n)},onArcgisFlowItemClose:()=>{this._handleFlowItemClose()},onArcgisManageVersion:v=>{this._handleManageVersionAction(v,n)},onArcgisNewVersion:v=>{const u=this._createVersionPropertiesFlowItem(v.detail.serviceUrl,void 0);n==null||n.appendChild(u)}})})):void 0,h=c==="disabled"?g("calcite-notice",{class:"notice",closable:!1,kind:"warning",open:!0,scale:"s",slot:"footer",width:"full"},g("div",{slot:"message"},this._getLoadError(a))):void 0;return g("calcite-flow",{ref:l=>{this.flowElement=l},class:this.mode==="dialog"?"":"calcite-flow-widget"},g("calcite-flow-item",{closable:this.closable,heading:r,onCalciteFlowItemClose:()=>{this._handleFlowItemClose()}},g("calcite-panel",{loading:c==="loading"||c==="executing"},d,h)))}_createVersionPropertiesFlowItem(e,i){const{closable:n,flowElement:r,viewModel:t,viewModel:{state:o}}=this,s=document.createElement("arcgis-version-management-version-properties");return s.versionPropertiesElementProps={closable:n,currentUser:t.userLookup.get(e),hasAdvEditingUte:t.advancedEditingUserTypeExtensionLookup.get(e),serviceUrl:e,state:o,strings:this.messages,versionInfo:i},s.addEventListener("arcgisCreateVersion",a=>{const{createVersionParameters:c,switchToVersion:m}=a.detail;t.createVersion(c).then(async d=>{d&&this.arcgisVersioningStateChanged.emit({type:"version-created",versionIdentifier:d.versionIdentifier,versioningState:t.versioningStateLookup.get(e)}),m&&await this.viewModel.changeVersion(e,d.versionIdentifier.name,d.versionIdentifier.guid).then(h=>{h&&this.arcgisVersioningStateChanged.emit({type:"version-switched",versionIdentifier:d.versionIdentifier,versioningState:t.versioningStateLookup.get(e)})})}).finally(async()=>{await this._refreshVersionList(e),this._removeVersionPropertiesFlowItem(r)})}),s.addEventListener("arcgisAlterVersion",async a=>{const{flowElement:c}=this,{alterVersionParameters:m}=a.detail;await t.alterVersion(m).then(async d=>{d&&this.arcgisVersioningStateChanged.emit({type:"version-changed",versionIdentifier:m.versionIdentifier,versioningState:t.versioningStateLookup.get(e)}),await this._refreshVersionList(e)}).finally(()=>{this._removeVersionPropertiesFlowItem(c)})}),s.addEventListener("arcgisFlowItemBack",()=>{this._removeVersionPropertiesFlowItem(this.flowElement)}),s.addEventListener("calciteFlowItemBack",a=>{a.preventDefault(),this._removeVersionPropertiesFlowItem(this.flowElement)}),s.addEventListener("calciteFlowItemClose",()=>{this._handleFlowItemClose()}),s}_getLoadError(e){const{messages:i}=this;switch(e){case"no-feature-services":return i.loadErrors.noFeatureServices;case"no-view-property":return i.loadErrors.noViewProperty;default:return e}}_handleFlowItemClose(){const e=document.querySelector("arcgis-version-management"),i=e.parentElement;i==null||i.removeChild(e)}async _handleManageVersionAction(e,i){const{actionType:n,serviceUrl:r,versionInfo:t}=e.detail,{viewModel:o}=this;switch(n){case"changeVersion":{o.changeVersion(r,t.versionIdentifier.name,t.versionIdentifier.guid).then(s=>{s&&this.arcgisVersioningStateChanged.emit({type:"version-switched",versionIdentifier:t.versionIdentifier,versioningState:o.versioningStateLookup.get(r)});const a=i==null?void 0:i.getElementsByTagName("arcgis-version-management-version-list")[0];a&&a&&(a.versionListElementProps={...a.versionListElementProps,currentVersionIdentifier:o.versioningStateLookup.get(r).currentVersionInfo.versionIdentifier})});break}case"deleteVersion":{o.deleteVersion(r,t.versionIdentifier.name,t.versionIdentifier.guid).then(async s=>{s&&this.arcgisVersioningStateChanged.emit({type:"version-deleted",versionIdentifier:t.versionIdentifier,versioningState:o.versioningStateLookup.get(r)}),await this._refreshVersionList(r)});break}case"editVersion":{const s=this._createVersionPropertiesFlowItem(r,t);i.appendChild(s);break}}}async _refreshVersionList(e){const{flowElement:i,viewModel:n}=this;if(i){const r=await n.getVersionInfos(e),t=i.getElementsByTagName("arcgis-version-management-service-item");for(const s of t)s.serviceItemElementProps.serviceUrl===e&&(s.serviceItemElementProps={...s.serviceItemElementProps,versionInfos:r});const o=i.getElementsByTagName("arcgis-version-management-version-list")[0];o&&(o.versionListElementProps={...o.versionListElementProps,currentVersionIdentifier:n.versioningStateLookup.get(e).currentVersionInfo.versionIdentifier,versionInfos:r})}}_removeVersionListFlowItem(e){for(const i of e.childNodes)i.nodeName.toUpperCase()==="ARCGIS-VERSION-MANAGEMENT-VERSION-LIST"&&e.removeChild(i),i.nodeName.toUpperCase()==="CALCITE-FLOW-ITEM"&&(i.hidden=!1)}_removeVersionPropertiesFlowItem(e){for(const i of e.childNodes)i.nodeName.toUpperCase()==="ARCGIS-VERSION-MANAGEMENT-VERSION-PROPERTIES"&&e.removeChild(i),i.nodeName.toUpperCase()==="ARCGIS-VERSION-MANAGEMENT-VERSION-LIST"&&(i.getElementsByTagName("calcite-flow-item")[0].hidden=!1)}static get assetsDirs(){return["assets"]}get el(){return V(this)}};k.style=F;export{k as arcgis_version_management};
