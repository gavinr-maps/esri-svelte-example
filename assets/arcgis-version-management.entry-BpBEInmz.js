import{r as V,c as I,h as m,F as E,g as L}from"./index-Bh2oEzTI.js";import{l as S}from"./index-ee4c09de-CPW6V7nq.js";import{al as y,i as P}from"./index-5cc0d3e9-BXwdUzLn.js";import{u as C,m as M}from"./useViewModel-5eedd1c7-Chco_mlm.js";import{u as N}from"./index-69f02a9e-wRYZXCy2.js";import"./component-utils-42b12dba-BfugynV_.js";/*!
 * All material copyright Esri, All Rights Reserved, unless otherwise specified.
 * See https://js.arcgis.com/4.31/esri/copyright.txt for details.
 * v4.31.2
 */const A=".calcite-combobox-item{width:330px}.calcite-flow-widget{width:350px}calcite-block{margin:0}calcite-pagination{justify-content:center}",F=A,k=M(y),_=class{constructor(e){V(this,e),this.arcgisReady=I(this,"arcgisReady",7),this.arcgisVersioningStateChanged=I(this,"arcgisVersioningStateChanged",7),this.manager=N(this),this.reactiveUtils=S(P),this.viewModel=k(this),this.messages=C({blocking:!0}),this.allowEditingDisabled=!1,this.autoDestroyDisabled=!1,this.closable=!1,this.icon=void 0,this.label=void 0,this.mode=void 0,this.pageSize=5,this.position="top-right",this.referenceElement=void 0,this.state=this.viewModel.state,this.versioningStates=this.viewModel.versioningStates,this.view=this.viewModel.view}async componentWillLoad(){const{watch:e}=this.reactiveUtils;this.manager.onLifecycle(()=>[e(()=>this.viewModel.state,i=>{const{flowElement:s}=this,n=s==null?void 0:s.getElementsByTagName("arcgis-version-management-version-properties")[0],t=s==null?void 0:s.getElementsByTagName("arcgis-version-management-version-list")[0];if(i==="disabled"){n&&this._removeVersionPropertiesFlowItem(s),t&&this._removeVersionListFlowItem(s);return}t&&(t.versionListElementProps={...t.versionListElementProps,executionError:this.viewModel.executionError},t.versionListElementProps={...t.versionListElementProps,state:i}),n&&(n.versionPropertiesElementProps={...n.versionPropertiesElementProps,state:i})})])}async destroy(){await this.manager.destroy()}render(){const{allowEditingDisabled:e,closable:i,flowElement:s,label:n,messages:t,mode:a,pageSize:o,viewModel:r,viewModel:{loadError:g,state:d}}=this,c=Array.from(r.serviceNameLookup,([l,p])=>({url:l,name:p})),h=d!=="disabled"?m(E,null,c.map(l=>{var f;const p={allowEditing:!e,closable:i,currentUser:r.userLookup.get(l.url),currentVersionIdentifier:r.versioningStateLookup.get(l.url).currentVersionInfo.versionIdentifier,executionError:void 0,flowElement:s,hasAdvEditingUte:r.advancedEditingUserTypeExtensionLookup.get(l.url),heading:n,isVersionAdministrator:r.versionAdministratorLookup.get(l.url),isVersioningApiAvailable:(r.serverVersionLookup.get(l.url)??0)>=11.2,mode:a,pageSize:o,serviceName:l.name,state:d,serviceUrl:l.url,strings:t,versionInfos:((f=r.versioningStateLookup.get(l.url))==null?void 0:f.versionInfos)??[]};return m("arcgis-version-management-service-item",{serviceItemElementProps:p,onArcgisGetVersions:async v=>{await this._refreshVersionList(v.detail.serviceUrl)},onArcgisFlowItemBack:()=>{this._removeVersionListFlowItem(s)},onArcgisFlowItemClose:()=>{this._handleFlowItemClose()},onArcgisManageVersion:v=>{this._handleManageVersionAction(v,s)},onArcgisNewVersion:v=>{const w=this._createVersionPropertiesFlowItem(v.detail.serviceUrl,void 0);s==null||s.appendChild(w)}})})):void 0,u=d==="disabled"?m("calcite-notice",{class:"notice",closable:!1,kind:"warning",open:!0,scale:"s",slot:"footer",width:"full"},m("div",{slot:"message"},this._getLoadError(g))):void 0;return m("calcite-flow",{ref:l=>{this.flowElement=l},class:this.mode==="dialog"?"":"calcite-flow-widget"},m("calcite-flow-item",{closable:this.closable,heading:n??void 0,onCalciteFlowItemClose:()=>{this._handleFlowItemClose()}},m("calcite-panel",{loading:d==="loading"||d==="executing"},h,u)))}_createVersionPropertiesFlowItem(e,i){const{closable:s,flowElement:n,viewModel:t,viewModel:{state:a}}=this,o=document.createElement("arcgis-version-management-version-properties");return o.versionPropertiesElementProps={closable:s,currentUser:t.userLookup.get(e),hasAdvEditingUte:t.advancedEditingUserTypeExtensionLookup.get(e),isVersionAdministrator:t.versionAdministratorLookup.get(e),serviceUrl:e,state:a,strings:this.messages,versionInfo:i},o.addEventListener("arcgisCreateVersion",r=>{const{createVersionParameters:g,switchToVersion:d}=r.detail;t.createVersion(g).then(async c=>{c&&this.arcgisVersioningStateChanged.emit({type:"version-created",versionIdentifier:c.versionIdentifier,versioningState:t.versioningStateLookup.get(e)}),d&&await this.viewModel.changeVersion(e,c.versionIdentifier.name,c.versionIdentifier.guid).then(h=>{h&&this.arcgisVersioningStateChanged.emit({type:"version-switched",versionIdentifier:c.versionIdentifier,versioningState:t.versioningStateLookup.get(e)})}),await this._refreshVersionList(e)}).finally(()=>{this._removeVersionPropertiesFlowItem(n)})}),o.addEventListener("arcgisAlterVersion",async r=>{const{flowElement:g}=this,{alterVersionParameters:d}=r.detail;await t.alterVersion(d).then(async c=>{c&&this.arcgisVersioningStateChanged.emit({type:"version-changed",versionIdentifier:d.versionIdentifier,versioningState:t.versioningStateLookup.get(e)}),await this._refreshVersionList(e)}).finally(()=>{this._removeVersionPropertiesFlowItem(g)})}),o.addEventListener("arcgisFlowItemBack",()=>{this._removeVersionPropertiesFlowItem(this.flowElement)}),o.addEventListener("calciteFlowItemBack",r=>{r.preventDefault(),this._removeVersionPropertiesFlowItem(this.flowElement)}),o.addEventListener("calciteFlowItemClose",()=>{this._handleFlowItemClose()}),o}_getLoadError(e){const{messages:i}=this;switch(e){case"no-feature-services":return i.loadErrors.noFeatureServices;case"no-view-property":return i.loadErrors.noViewProperty;default:return e}}_handleFlowItemClose(){const e=document.querySelector("arcgis-version-management"),i=e.parentElement;i==null||i.removeChild(e)}async _handleManageVersionAction(e,i){const{actionType:s,serviceUrl:n,versionInfo:t}=e.detail,{viewModel:a}=this;switch(s){case"changeVersion":{a.changeVersion(n,t.versionIdentifier.name,t.versionIdentifier.guid).then(o=>{o&&this.arcgisVersioningStateChanged.emit({type:"version-switched",versionIdentifier:t.versionIdentifier,versioningState:a.versioningStateLookup.get(n)});const r=i==null?void 0:i.getElementsByTagName("arcgis-version-management-version-list")[0];r&&r&&(r.versionListElementProps={...r.versionListElementProps,currentVersionIdentifier:a.versioningStateLookup.get(n).currentVersionInfo.versionIdentifier})});break}case"deleteVersion":{a.deleteVersion(n,t.versionIdentifier.name,t.versionIdentifier.guid).then(async o=>{o&&this.arcgisVersioningStateChanged.emit({type:"version-deleted",versionIdentifier:t.versionIdentifier,versioningState:a.versioningStateLookup.get(n)}),await this._refreshVersionList(n)});break}case"editVersion":{const o=this._createVersionPropertiesFlowItem(n,t);i.appendChild(o);break}}}async _refreshVersionList(e){const{flowElement:i,viewModel:s}=this;if(i){const n=await s.getVersionInfos(e),t=i.getElementsByTagName("arcgis-version-management-service-item");for(const o of t)o.serviceItemElementProps.serviceUrl===e&&(o.serviceItemElementProps={...o.serviceItemElementProps,versionInfos:n});const a=i.getElementsByTagName("arcgis-version-management-version-list")[0];a&&(a.versionListElementProps={...a.versionListElementProps,currentVersionIdentifier:s.versioningStateLookup.get(e).currentVersionInfo.versionIdentifier,versionInfos:n})}}_removeVersionListFlowItem(e){for(const i of e.childNodes)i.nodeName.toUpperCase()==="ARCGIS-VERSION-MANAGEMENT-VERSION-LIST"&&e.removeChild(i),i.nodeName.toUpperCase()==="CALCITE-FLOW-ITEM"&&(i.hidden=!1)}_removeVersionPropertiesFlowItem(e){for(const i of e.childNodes)i.nodeName.toUpperCase()==="ARCGIS-VERSION-MANAGEMENT-VERSION-PROPERTIES"&&e.removeChild(i),i.nodeName.toUpperCase()==="ARCGIS-VERSION-MANAGEMENT-VERSION-LIST"&&(i.getElementsByTagName("calcite-flow-item")[0].hidden=!1)}static get assetsDirs(){return["assets"]}get el(){return L(this)}};_.style=F;export{_ as arcgis_version_management};
