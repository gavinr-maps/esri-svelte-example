const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./MediaLayerInteraction-omb6y87l.js","./index-tefRSezt.js","./index-Cx51aysm.css","./Accessor-BHnuXKD2.js","./reactiveUtils-BR0C1Kq4.js","./Evented-DCWccWGU.js","./SimpleObservable-7oieNGD8.js","./UpdatingHandles-ptqz1ck8.js","./InputManager-Bs9UE-jw.js","./Queue-BOnccek2.js","./signal-DSa0yokC.js"])))=>i.map(i=>d[i]);
import{_ as D}from"./index-tefRSezt.js";import{aV as z,aD as $,at as v,B as E,s as U,E as F,o as I,r as x,m as A,a as W}from"./Accessor-BHnuXKD2.js";import"./Graphic-CFXUQZlS.js";import{d as l,P as g,p as Q,V as B,A as V,v as M}from"./reactiveUtils-BR0C1Kq4.js";import{a as j,w as N,x as J}from"./Extent-CBBGeHb-.js";import{a as K}from"./Polyline-BmuD2-ZN.js";import{j as X,m as P}from"./MediaElementView-CxjW2ccL.js";import"./SimpleRenderer-gSw1WaJS.js";import"./TextSymbol-BQ_NW9Xo.js";import"./colorUtils-BAowQmkN.js";import"./defaultCIMValues-DII_GG3u.js";import{d as R}from"./enums-BJSSbDkD.js";import"./floatRGBA-CR2j2c7-.js";import"./Point-XGrwlf63.js";import"./definitions-LJaw2n5Z.js";import"./UpdateTracking2D-BJv4lrAz.js";import"./mathUtils-DV9iOXpW.js";import"./GeometryUtils-B5FJlfZD.js";import"./CIMSymbolHelper-Vkq7AVTn.js";import"./vec2f32-BbH2jxlN.js";import"./defaults-Dwxdhopq.js";import"./OverrideHelper-CrxTOYuK.js";import"./EffectView-BDbE94Th.js";import"./Evented-DCWccWGU.js";import{e as Y}from"./DisplayObject-S19ALweP.js";import"./View2D-CIpCSKxG.js";import"./DefaultVertexAttributeLayouts-DMsCtEEh.js";import{D as Z}from"./enums-D9v74xTE.js";import"./WGLContainer-Bm0UZ79M.js";import{p as ee,w as G}from"./Texture-D-SqNa4i.js";import"./dataViewUtils-CH0QMRr9.js";import"./StyleDefinition-DxJzQnGW.js";import"./enums-BRzLM11V.js";import"./GridShader-BTUgme4s.js";import"./cast-BA_-jlhc.js";import"./pbf-CFI-xDDp.js";import"./TechniqueType-uMFRS8dR.js";import"./FramebufferObject-DHwDHMWe.js";import"./FeatureCommandQueue-C_h-Fzgt.js";import"./Color-gncXBiLc.js";import"./PieChartMeshWriter-CYKOJPZo.js";import"./aaBoundingBox-CeBivBRq.js";import"./opacityUtils-CSd4XoR2.js";import"./renderState-e7QeQoUO.js";import"./glsl-BH37Aalp.js";import"./testSVGPremultipliedAlpha-CpxLiQJP.js";import"./GraphicsView2D-Op6juEbw.js";import"./earcut-Lltz9D9k.js";import"./vec3f32-nZdmKIgz.js";import"./normalizeUtilsCommon-D0zPTJCj.js";import"./UpdatingHandles-ptqz1ck8.js";import"./projectBuffer-DOU0xvVi.js";import"./geodesicConstants-yASAK_zX.js";import{p as te,r as ie}from"./TileStrategy-DlGVvP4C.js";import"./TileKey-BtGhNUzq.js";import{e as re}from"./mat3f64-BBpwCtoL.js";import{o as oe}from"./vec2-maR1OrZI.js";import{n as se}from"./vec2f64-Dy6m9Nrb.js";import{o as ne}from"./mediaLayerUtils-BJ-DU5EY.js";import{c as me}from"./utils-I4Tn7vLa.js";import{u as pe}from"./OverlayContainer-UL-oYfKg.js";import{S as ae}from"./LayerView2D-BMuowJAc.js";import{y as le}from"./LayerView-DF8EqCYi.js";import{s as he}from"./MediaLayerView-BQs74upW.js";import{g as de}from"./Scheduler-B_GuBefw.js";import"./Clonable-DvJsj5LF.js";import"./JSONSupport-CGdeqxpk.js";import"./writer-B2bQV2uU.js";import"./enumeration-Cr5WIZs4.js";import"./Promise-CmQqe-ke.js";import"./ActionToggle-__-l4AdQ.js";import"./Identifiable-BrT7zvUW.js";import"./jsonUtils-Cu7OBRmN.js";import"./typeUtils-BSg8Y507.js";import"./collectionUtils-CbaToa73.js";import"./Portal-CTRRujjZ.js";import"./screenUtils-_ZIvrt5o.js";import"./vec3f64-BLpZdpfb.js";import"./SimpleObservable-7oieNGD8.js";import"./mat3-CR8GKnhD.js";import"./common-DQOJ18NT.js";import"./vec32-Dvg_eL9J.js";import"./projection-B2I9Bzj_.js";import"./normalizeUtilsSync-D3hTE8bq.js";import"./commonProperties-bGHL1a5M.js";import"./colorRamps-Dkx8zIVn.js";import"./SizeVariable-IzD1bP2e.js";import"./visualVariableUtils-Bp9QCb8E.js";import"./lengthUtils-DjJgJFRg.js";import"./ColorStop-CDpeFWOz.js";import"./jsonUtils-Dzgxk9pw.js";import"./layerUtils-dJgsXxkC.js";import"./defaultsJSON-GKolV7NZ.js";import"./vec42-YcqnINSP.js";import"./vec4f64-o2zAXfmz.js";import"./ReactiveMap-Dwhwbx9R.js";import"./BidiEngine-DNnuvc1i.js";import"./fontUtils-D0SfAiSy.js";import"./OptimizedGeometry-7IxBWtHr.js";import"./memoryEstimations-5gFNwkKK.js";import"./utils-B91u8350.js";import"./rasterizingUtils-5QTNbyfl.js";import"./mat2d-D9DBP-jx.js";import"./mat2df32-orApM5a3.js";import"./Rect-CUzevAry.js";import"./BoundingBox-CnpCxTZE.js";import"./callExpressionWithFeature-CM_sm0iu.js";import"./quantizationUtils-2Az-xHPA.js";import"./colorUtils-Rxh2V3ai.js";import"./jsonUtils-TjZmCq6l.js";import"./utils-DYurMneM.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-Fi6iAz29.js";import"./Viewpoint-Cv8Otrne.js";import"./Camera-DJtV7zYb.js";import"./Cyclical-CPiNl4ru.js";import"./CollectionFlattener-B9CFCLSp.js";import"./workers-D8Q3pEzK.js";import"./Queue-BOnccek2.js";import"./intl-Do3GEEJ7.js";import"./TileInfo-CRfZy5zq.js";import"./TileKey-DZd6gJy7.js";import"./DefaultUI-DqLHkAzt.js";import"./jsxFactory-CLjKarlq.js";import"./uuid-Cl5lrJ4c.js";import"./InputManager-Bs9UE-jw.js";import"./signal-DSa0yokC.js";import"./Basemap-BHdJ6wQH.js";import"./loadAll-Do8S8AWH.js";import"./PortalItem-CXk7DqVv.js";import"./basemapDefinitions-BmB40s1J.js";import"./writeUtils-C3ZSK02Z.js";import"./groundInstanceUtils-Ben03ZCf.js";import"./editableLayers-BZGjz8nI.js";import"./catalogUtils-CK4eMvD1.js";import"./basemapEnsureType-BVU7UGJp.js";import"./basemapUtils-DQr5T1wn.js";import"./TablesMixin-BzMj7HDl.js";import"./Layer-C9uQlTBT.js";import"./TimeExtent-J5qnUFx_.js";import"./timeUtils-D2X862bk.js";import"./GraphicsCollection-CkliHSk1.js";import"./HeightModelInfo-B3GZyQFz.js";import"./timeZoneUtils-COos5xIr.js";import"./Query-DCBIeen2.js";import"./Field-Cyk7Ur5d.js";import"./fieldType-L-VlbZqy.js";import"./FullTextSearch-BWm_kPUE.js";import"./selectionUtils-DYi6daQO.js";import"./ViewEvents-Hl5AOQnu.js";import"./IViewEvents-Bci6PjlS.js";import"./interfaces-D6pIddIh.js";import"./screenUtils-DyhV4TAA.js";import"./HighlightDefaults-ESbuT2uR.js";import"./a11yUtils-CSYUX1kC.js";import"./heightModelInfoUtils-CMg1cdju.js";import"./ViewingMode-Dodu7ZZk.js";import"./unitBezier-B1N-tmtC.js";import"./imageUtils-brik-GLm.js";import"./capabilities-DwlKKScG.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-CZa70j6i.js";import"./accessibleHandler-rIBXQ52V.js";import"./CompassViewModel-BAJa4WdS.js";import"./GoTo-BsXOAO95.js";import"./ZoomViewModel-BZXEbLSs.js";import"./viewpointUtils-DmJh_Ev7.js";import"./mat2df64-CBKYtunK.js";import"./normalizeUtils-XRAPXbWa.js";import"./utils-Cy8wFNQo.js";import"./utils-CkSELPnj.js";import"./Tile-CkUxg4dk.js";import"./quickselect-QQC62dOK.js";import"./utils-D02V2_jH.js";import"./Version-9k2AOv05.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./WGLBrushVTLSymbol-DhI09LJn.js";import"./BufferObject-CIl3vJtA.js";import"./config-MDUrh2eL.js";import"./ShaderCompiler-G2XYGDs6.js";import"./ProgramTemplate-C4sWoKdv.js";import"./Program-DD6La1z3.js";import"./Container-C9XOJkyO.js";import"./featureConversionUtils-DpmsPUmt.js";import"./OptimizedFeature-DcMLlxvB.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./getDataTypeBytes-BTGR5GyG.js";import"./GraphShaderModule-CNt-QO7Z.js";import"./ShaderBuilder-DV1s2efh.js";import"./BindType-BBwFZqyN.js";import"./CircularArray-CujHzHWW.js";import"./FeatureMetadata-_zu3ofPi.js";import"./diffUtils-CMkuJvD2.js";import"./queryUtils-DBeaQ3x_.js";import"./json-Wa8cmqdu.js";import"./timeSupport-Cvj97qZO.js";import"./FieldsIndex-DFdVonga.js";import"./TimeOnly-yGYcAQQJ.js";import"./labelFormatUtils-B--9rEVY.js";import"./labelUtils-Dq8OkaT-.js";import"./ZoomMomentumEstimator-Igei2Npb.js";import"./heatmapTextureUtils-nYqDzBiV.js";import"./streamLayerUtils-CKwt2uXH.js";import"./QueueProcessor-BFetastB.js";import"./libtess-BP1QYsmS.js";import"./utils-ilH32Koe.js";import"./basicInterfaces-CZwQPxTp.js";import"./dehydratedFeatures-Nwhn-hep.js";import"./ScheduledQueueProcessor-DfrR8pp0.js";import"./grouping-Df5gVU-y.js";import"./utils-ehcGqGxa.js";import"./utils-BQBvadb7.js";import"./ClipRect-XfrmCbGe.js";import"./layerViewUtils-tkZ5z_iY.js";import"./debugFlags-ZrDyTcDc.js";const H=[1,1],d=re(),ce={none:R.None,loop:R.Loop,oscillate:R.Oscillate};function ue(e){return e?{type:"CIMAnimatedSymbolProperties",...e,playAnimation:e.playing,repeatType:e.repeatType?ce[e.repeatType]:void 0}:{type:"CIMAnimatedSymbolProperties"}}class fe extends Y{constructor(t){super(),this.elementView=t,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=se(),this._handles=new z,this._vertices=new Float32Array(8),this._indices=new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]),this._handles.add([l(()=>this.elementView.element.opacity,i=>this.opacity=i,g),l(()=>[this.elementView.coords],()=>{this.requestRender()},g),l(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this._handles.remove("play"),this.texture=$(this.texture),this.requestRender()},g),Q(()=>this.elementView.element.loaded,()=>{const i=this.elementView.element;this.ready(),ne(i)&&i.content!=null&&(this._handles.add([v(i.content,"play",()=>this.requestRender()),v(i.content,"loadeddata",()=>this.requestRender()),v(i.content,"loaded",()=>this.requestRender())]),"requestVideoFrameCallback"in i.content?i.content.requestVideoFrameCallback(()=>this.requestRender()):this._handles.add([v(i.content,"seeked",()=>this.requestRender())]),this.requestRender())},g)]),t.element.load().catch(i=>{E.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new U("element-load-error","Element cannot be displayed",{element:t,error:i}))})}getMesh(t){throw new Error("Method not implemented.")}destroy(){this._handles.destroy(),this.texture=$(this.texture)}get textureSize(){return H}get dvsMat3(){return this.parent.dvsMat3}beforeRender(t){const{context:i}=t,r=this.elementView.element.content;if(r!=null){const o=r instanceof HTMLImageElement,n=r instanceof HTMLVideoElement,p=o?r.naturalWidth:n?r.videoWidth:r.width,s=o?r.naturalHeight:n?r.videoHeight:r.height;if(this._updatePerspectiveTransform(p,s),this.texture)n&&(this.texture.setData(r),this.texture.generateMipmap(),"requestVideoFrameCallback"in r?r.requestVideoFrameCallback(()=>this.requestRender()):r.paused||this.requestRender());else{const m=new ee;if(m.wrapMode=Z.CLAMP_TO_EDGE,m.preMultiplyAlpha=!0,m.width=p,m.height=s,"getFrame"in r){const f=h=>{this.texture?this.texture.setData(h):this.texture=new G(i,m,h),this.requestRender()};"animationOptions"in this.elementView.element&&this._handles.add(me(r,ue(this.elementView.element.animationOptions),null,f),"play")}else this.texture=new G(i,m,r);this.texture.generateMipmap(),n&&("requestVideoFrameCallback"in r?r.requestVideoFrameCallback(()=>this.requestRender()):r.paused||this.requestRender())}}super.beforeRender(t)}_createTransforms(){return null}draw(t,i){this.isReady&&this.texture!=null?i.render(t,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:H,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._indices}):this.requestRender()}updateDrawCoords(t,i,r,o){const{coords:n,bounds:p}=this.elementView;if(n==null||p==null)return;const[s,m,f,h]=n.rings[0],k=this._vertices,{x:y,y:_}=t;k.set([m[0]-y,m[1]-_,s[0]-y,s[1]-_,f[0]-y,f[1]-_,h[0]-y,h[1]-_]);let w=i;if(o){const[q,,T]=p,{worldWidth:S,xBounds:O}=o,[b,C]=O;q<b&&T>b?w=S:T>C&&q<C&&(w=-S)}this.wrapAroundShift=w,this.isWrapAround=w!==0}_updatePerspectiveTransform(t,i){const r=this._vertices;X(d,[0,0,t,0,0,i,t,i],[r[0],r[1],r[4],r[5],r[2],r[3],r[6],r[7]]),oe(this.perspectiveTransform,d[6]/d[8]*t,d[7]/d[8]*i)}}let u=class extends ae(he(le)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this._interaction=null,this.layer=null,this.elements=new B}initialize(){this.addHandles([l(()=>[this.interactive,this.suspended],async()=>{if(this.interactive&&!this._interaction){const{MediaLayerInteraction:e}=await D(()=>import("./MediaLayerInteraction-omb6y87l.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10]),import.meta.url);this._interaction=new e({view:this.view,layer:this.layer}),this.selectedElement!==this._interaction.selectedElement&&(this._interaction.selectedElement=this.selectedElement),this.interactionOptions!==this._interaction.options&&(this._interaction.options=this.interactionOptions)}this._interaction&&(this._interaction.enabled=!this.suspended&&this.interactive)},V),l(()=>this.interactionOptions,e=>{this._interaction&&(this._interaction.options=e)},V),l(()=>this.selectedElement,e=>{this._interaction&&(this._interaction.selectedElement=e)},V)])}attach(){this.addAttachHandles([M(()=>this.layer.effectiveSource,"refresh",()=>{this._tileStrategy.refresh(e=>this._updateTile(e)),this.requestUpdate()}),M(()=>this.layer.effectiveSource,"change",({element:e})=>this._elementUpdateHandler(e))]),this._overlayContainer=new pe,this.container.addChild(this._overlayContainer),this._fetchQueue=new te({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t),scheduler:this.scheduler,priority:de.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new ie({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){var e;this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),(e=this._debugGraphicsView)==null||e.destroy()}supportsSpatialReference(e){return!0}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(e){var t;this._tileStrategy.update(e),(t=this._debugGraphicsView)==null||t.update(e)}async hitTest(e,t){const i=[],r=e.normalize(),o=[r.x,r.y];for(const{elementView:{normalizedCoords:n,element:p}}of this._elementReferences.values())n!=null&&j(n.rings,o)&&i.push({type:"media",element:p,layer:this.layer,mapPoint:e,sourcePoint:p.toSource(e)});return i.reverse()}canResume(){return this.layer.source!=null&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh(e=>this._updateTile(e))}_acquireTile(e){const t=new ye(e.clone());return this._updateTile(t),t}_updateTile(e){this._updatingHandles.addPromise(this._fetchQueue.push(e.key).then(t=>{const[i,r]=e.setElements(t);this._referenceElements(e,i),this._dereferenceElements(e,r),this.requestUpdate()},t=>{F(t)||E.getLogger(this).error(t)}))}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._dereferenceElements(e,e.elements),this.requestUpdate()}async _queryElements(e,t){const i=this.layer.effectiveSource;if(i==null)return[];this.view.featuresTilingScheme.getTileBounds(a,e,!0);const r=new N({xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:this.view.spatialReference});return i.queryElements(r,t)}_referenceElements(e,t){if(this.layer.source!=null)for(const i of t)this._referenceElement(e,i)}_referenceElement(e,t){I(this._elementReferences,t.uid,()=>{const i=new P({element:t,spatialReference:this.view.spatialReference}),r=new fe(i);return this._overlayContainer.addChild(r),this.elements.add(t),this._updatingHandles.addPromise(t.load().catch(o=>{E.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new U("element-load-error","Element cannot be displayed",{element:t,error:o}))})),{debugGraphic:null,elementView:i,overlay:r,tiles:new Set}}).tiles.add(e)}_dereferenceElements(e,t){for(const i of t)this._dereferenceElement(e,i)}_dereferenceElement(e,t){var r;const i=this._elementReferences.get(t.uid);i.tiles.delete(e),i.tiles.size||(this._overlayContainer.removeChild(i.overlay),i.overlay.destroy(),i.elementView.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),(r=this._debugGraphicsView)==null||r.graphics.remove(i.debugGraphic))}_elementUpdateHandler(e){var r;let t=this._elementReferences.get(e.uid);if(t){const o=t.elementView.normalizedCoords;if(o==null)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.elementView.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),void((r=this._debugGraphicsView)==null?void 0:r.graphics.remove(t.debugGraphic));const n=[],p=[];for(const s of this._tileStrategy.tiles){const m=L(this.view.featuresTilingScheme,s,o);t.tiles.has(s)?m||p.push(s):m&&n.push(s)}for(const s of n)this._referenceElement(s,e);for(const s of p)this._dereferenceElement(s,e);return t=this._elementReferences.get(e.uid),void((t==null?void 0:t.debugGraphic)&&(t.debugGraphic.geometry=t.elementView.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:"geometry"})))}const i=new P({element:e,spatialReference:this.view.spatialReference}).normalizedCoords;if(i!=null)for(const o of this._tileStrategy.tiles)L(this.view.featuresTilingScheme,o,i)&&this._referenceElement(o,e)}};x([A()],u.prototype,"layer",void 0),x([A({readOnly:!0})],u.prototype,"elements",void 0),u=x([W("esri.views.2d.layers.MediaLayerView2D")],u);const a=K(),c={xmin:0,ymin:0,xmax:0,ymax:0};function L(e,t,i){return e.getTileBounds(a,t.key,!0),c.xmin=a[0],c.ymin=a[1],c.xmax=a[2],c.ymax=a[3],J(c,i)}class ye{constructor(t){this.key=t,this.elements=null,this.isReady=!1,this.visible=!0}setElements(t){const i=[],r=new Set(this.elements);this.elements=t;for(const o of t)r.has(o)?r.delete(o):i.push(o);return this.isReady=!0,[i,Array.from(r)]}destroy(){}}const _o=u;export{_o as default};
