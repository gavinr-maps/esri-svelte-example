import{L as W,u as N,c as J,n as K,s as v,x as w,b as M,e as X,d as G,i as Y,a as Z}from"./index-4eY77cms.js";import{d as f,w as ee,V as R,P as te,v as ae,p as O}from"./reactiveUtils-XM7cS2OP.js";import{D as C,G as se,s as y,g as D,E as q,r,m as n,a as F,B as ie}from"./Accessor-BmwT4B0c.js";import I from"./Basemap-BZmrlnvW.js";import{m as k,C as j}from"./Portal-CmmHxpLg.js";import{a as S}from"./cast-CsZslgGN.js";import{L as re,K as oe,k as ne}from"./projection-CyCZAIaD.js";import{c as E}from"./Point-Cz2JYYmX.js";import{e as le}from"./utils-BQBvadb7.js";import{m as pe}from"./basemapEnsureType-CmRtohu0.js";import{d as ce,y as me}from"./basemapUtils-oMnqy94d.js";import{y as he,n as de,f as ue}from"./layerUtils-B__v9OBu.js";import{a as P,l as ye}from"./ViewingMode-Dodu7ZZk.js";import{k as fe,M as A,f as be}from"./terrainUtils-CgFk6NLH.js";import{r as we}from"./spatialReferenceSupport-DfixDcu7.js";import{n as ve}from"./Identifiable-BHVfzH03.js";import{p as ge}from"./Promise-DfET-uns.js";import{s as $e}from"./useT9n-Dwv-EXPO.js";import{u as _e}from"./useViewModel-x7-oy52B.js";import{s as Be,u as Re}from"./static-DLD4WjLv.js";import{e as g}from"./globalCss-B9-jl_gY.js";import{t as b}from"./basemap-gallery-resources-Dm7dx1Wq.js";import"./Evented-Dw4_VOGn.js";import"./SimpleObservable-CvOkykwM.js";import"./collectionUtils-CTT-51g7.js";import"./JSONSupport-DcrLLGjL.js";import"./loadAll-D1eTJ7uv.js";import"./writer-DKgfqj4X.js";import"./PortalItem-CTx1kJsR.js";import"./Extent-g5W9hy0j.js";import"./basemapDefinitions-D-Q7PKmu.js";import"./intl-Duiy0OzY.js";import"./writeUtils-CcunaxF8.js";import"./vec3f64-BLpZdpfb.js";import"./Polyline-s-JzsQqo.js";import"./mathUtils-Cfq9PL9W.js";import"./projectBuffer-CQnuEMuP.js";import"./geodesicConstants-RQL9oKdk.js";import"./utils-DYurMneM.js";import"./colorUtils-Rxh2V3ai.js";import"./screenUtils-_ZIvrt5o.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-Fi6iAz29.js";import"./common-DQOJ18NT.js";import"./TileInfo-DxwC9WcY.js";import"./TileKey-DZd6gJy7.js";import"./index-C5b9dHRB.js";import"./component-utils-D0ciaaZ_.js";async function Le(t,e={}){const{basemap:a,view:s}=t;await a.load(e),Fe(a),await xe(a,s,e),C(e)}async function Ce(t,e={}){var p,c;const{basemap:a,view:s}=t;C(e);const i=(p=a.baseLayers.find(u=>u.type==="unknown"))==null?void 0:p.loadError;if(i!=null)throw i;if(!s||"spatialReferenceLocked"in s&&!s.spatialReferenceLocked||(await a.load(e),C(e),a.baseLayers.length===0))return;const o=a.baseLayers.at(0);if(!he(o))return;if(a.spatialReference){if(s.spatialReference.equals(a.spatialReference))return;T()}await o.load(e),C(e);const l=(("supportedSpatialReferences"in o?o.supportedSpatialReferences:null)||["tileInfo"in o?(c=o.tileInfo)==null?void 0:c.spatialReference:null]).filter(se);l.length!==0&&l.every(u=>!s.spatialReference.equals(u))&&T()}function T(){throw new y("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}function Fe(t){if(t.baseLayers.length===0&&t.referenceLayers.length===0)return;const e=t.baseLayers.concat(t.referenceLayers).toArray().filter(a=>!de(a)).map(a=>ke(a));if(e.length)throw e[0]}function ke(t){return new y("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:t,operationalLayerType:t.operationalLayerType||"unknown"})}async function xe(t,e,a){if(t.baseLayers.length===0)return;const s=t.baseLayers.at(0);if(ue(s)){try{await s.load(a)}catch(i){const o="basemap-compatibility:unknown-error",l="Unknown basemap compatibility error",{name:p=o,message:c=l,details:u}=i;throw new y(p,c,u)}Ie(s,e)}}function Ie(t,e){var p;const a=e.state.viewingMode;if(!a)return;let s,i;if((t==null?void 0:t.type)==="wmts"){const c=fe(t,e.spatialReference,a);if(c.tileInfo==null)throw new y("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");s=c.tileInfo,i=c.fullExtent}else s=t.tileInfo,i=t.fullExtent;if(s==null)return;if(!we(s.spatialReference,a))throw new y(`basemapgalleryitem:spatial-reference-unsupported-${P(a)}`,`Basemap spatial reference is unsupported in ${P(a)} mode`);const o=(t==null?void 0:t.type)==="vector-tile"?s.getCompatibleForVTL(256):null;if(a===ye.Global){let c=A(s,i,null,a);if(c&&(t==null?void 0:t.type)==="vector-tile"&&i!=null&&o&&!A(o,i,null,a)&&(c=null),c){const u=s.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new y(`basemapgalleryitem:tiling-scheme-unsupported-${u}-global`,"Basemap tiling scheme is unsupported in global mode",{error:c})}}else if(be.checkUnsupported(s))throw new y("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const l=(p=e.basemapTerrain)==null?void 0:p.tilingScheme;if(l&&!l.compatibleWith(s)&&((t==null?void 0:t.type)!=="vector-tile"||!o||!l.compatibleWith(o)))throw new y("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}let h=class extends ve.IdentifiableMixin(D){constructor(t){super(t),this.compatibilityFunction=null,this.error=null,this.state="loading",this.view=null}initialize(){const t=()=>this.refresh();this.addHandles([f(()=>{var e;return(e=this.basemap)==null?void 0:e.loadStatus},t),f(()=>this.compatibilityFunction,t),f(()=>{var e;return this.view&&"basemapTerrain"in this.view&&((e=this.view.basemapTerrain)==null?void 0:e.tilingScheme)},t),f(()=>{var e;return(e=this.view)==null?void 0:e.ready},t),f(()=>{var e;return(e=this.view)==null?void 0:e.spatialReference},t)]),this.refresh()}destroy(){this._cancelRefresh(),this.basemap=null,this.compatibilityFunction=null,this.view=null}get _spatialReferenceTask(){return ce(this.view,this.basemap)}set basemap(t){t&&t.load().catch(()=>{}),this._set("basemap",t)}get spatialReference(){return this._spatialReferenceTask.spatialReference}refresh(){var s;this._cancelRefresh(),this._set("state","loading");const t=(s=this.basemap)==null?void 0:s.loadStatus;if(t!=="loaded"&&t!=="failed")return;if(!this.compatibilityFunction)return void(t==="loaded"?(this._set("state","ready"),this._set("error",null)):(this._set("state","error"),this._set("error",this.basemap.loadError)));const e=new AbortController,{signal:a}=e;this.compatibilityFunction(this,{signal:a}).then(()=>ee(()=>!this._spatialReferenceTask.updating,a)).then(()=>{this._set("state","ready"),this._set("error",null)}).catch(i=>{q(i)||(this._set("state","error"),this._set("error",i))}),this._refreshController=e}_cancelRefresh(){this._refreshController&&(this._refreshController.abort(),this._refreshController=null)}};r([n({readOnly:!0})],h.prototype,"_spatialReferenceTask",null),r([n()],h.prototype,"basemap",null),r([n()],h.prototype,"compatibilityFunction",void 0),r([n({readOnly:!0})],h.prototype,"error",void 0),r([n({readOnly:!0})],h.prototype,"spatialReference",null),r([n({readOnly:!0})],h.prototype,"state",void 0),r([n()],h.prototype,"view",void 0),h=r([F("esri.widgets.BasemapGallery.support.BasemapGalleryItem")],h);const U=h,z=R.ofType(I);let $=class extends D{constructor(t){super(t),this.basemaps=new z}destroy(){this.basemaps.forEach(t=>t.destroy())}get state(){return"ready"}refresh(){}};r([n({type:z})],$.prototype,"basemaps",void 0),r([n({readOnly:!0})],$.prototype,"state",null),$=r([F("esri.widgets.BasemapGallery.support.LocalBasemapsSource")],$);const Q=$,V=R.ofType(I);let d=class extends k.LoadableMixin(ge.EsriPromiseMixin(Q)){constructor(t){super(t),this._lastPortalBasemapFetchController=null,this.basemaps=new V,this.filterFunction=null,this.portal=j.getDefault(),this.query=null,this.updateBasemapsCallback=null,this.viewType=null}initialize(){this.addHandles(f(()=>{var t,e,a;return[this.filterFunction,this.loadStatus,(t=this.portal)==null?void 0:t.basemapGalleryGroupQuery,(e=this.portal)==null?void 0:e.basemapGalleryGroupQuery3D,(a=this.portal)==null?void 0:a.user,this.query,this.updateBasemapsCallback]},()=>this.refresh(),te))}destroy(){this.filterFunction=null,this.portal=null,this.basemaps.forEach(t=>t.destroy())}get state(){return this.loadStatus==="not-loaded"?"not-loaded":this.loadStatus==="loading"||this._lastPortalBasemapFetchController?"loading":"ready"}load(t){return this.addResolvingPromise(this.portal.load(t)),Promise.resolve(this)}async refresh(){if(this.loadStatus!=="loaded")return;this._lastPortalBasemapFetchController&&(this._lastPortalBasemapFetchController.abort(),this._lastPortalBasemapFetchController=null);const t=this.portal,e=new AbortController;this._lastPortalBasemapFetchController=e,this.notifyChange("state");try{const a=await t.fetchBasemaps(this._toQueryString(this.query),{signal:e.signal,include3d:this.viewType==="3d"||void 0});await this._updateBasemaps(a)}catch(a){if(q(a))throw a;ie.getLogger(this).warn(new y("basemap-source:fetch-basemaps-error","Could not fetch basemaps from portal.",{error:a})),await this._updateBasemaps()}this._lastPortalBasemapFetchController=null,this.notifyChange("state")}_toQueryString(t){return t&&typeof t!="string"?Object.keys(t).map(e=>`${e}:${t[e]}`).join(" AND "):t}async _updateBasemaps(t=[]){let e=await this._filterBasemaps(t);e=this.updateBasemapsCallback?await this.updateBasemapsCallback(e):e,this.basemaps.removeAll(),this.basemaps.addMany(e)}async _filterBasemaps(t){if(!this.filterFunction)return t;const e=t.map(this.filterFunction),a=await Promise.all(e);return t.filter((s,i)=>a[i])}};r([n({readOnly:!0,type:V})],d.prototype,"basemaps",void 0),r([n()],d.prototype,"filterFunction",void 0),r([n({type:j})],d.prototype,"portal",void 0),r([n()],d.prototype,"query",void 0),r([n({readOnly:!0})],d.prototype,"state",null),r([n()],d.prototype,"updateBasemapsCallback",void 0),r([n()],d.prototype,"viewType",void 0),d=r([F("esri.widgets.BasemapGallery.support.PortalBasemapsSource")],d);const _=d,H=R.ofType(U);function Me(t){return t&&t.declaredClass==="esri.portal.Portal"}function Se(t){return t&&!(t instanceof _)&&(!!t.portal||!!t.query)}function Ee(t){return t&&"basemaps"in t&&"state"in t&&"refresh"in t}let m=class extends k{constructor(e){super(e),this._loadingProjectionEngine=!1,this.items=new H,this.source=new _,this.view=null}initialize(){const e=()=>this._recreateItems();this.addHandles([f(()=>this.state==="ready"?this.compatibilityFunction:null,()=>this._updateItems()),ae(()=>{var a;return(a=this.source)==null?void 0:a.basemaps},"change",e,{onListenerAdd:e}),O(()=>this.view,()=>{var a;this.source instanceof _&&(this.source.viewType=(a=this.view)==null?void 0:a.type)},{once:!0})])}destroy(){var a;const e=this.source.basemaps.find(s=>s===this.activeBasemap);e&&this.source.basemaps.remove(e),(a=this.source)==null||a.destroy()}get activeBasemap(){var e,a;return((a=(e=this.view)==null?void 0:e.map)==null?void 0:a.basemap)??null}set activeBasemap(e){var i,o;const a=this.view;if(!(a!=null&&a.map))return;if(!e||!a.ready)return a.map.basemap=e,void this._clearOverride("activeBasemap");const s=e.spatialReference||((o=(i=this.items)==null?void 0:i.find(l=>this.basemapEquals(e,l.basemap)))==null?void 0:o.spatialReference);if(s&&"spatialReferenceLocked"in a&&!a.spatialReferenceLocked){const l=a.spatialReference;if(s!=null&&!E(l,s)&&!re(a.spatialReference,s)&&!ne())return this._override("activeBasemap",e),this._loadingProjectionEngine=!0,void oe().then(()=>{this._get("activeBasemap")===e&&(a.map.basemap=e,a.spatialReference=s,this._clearOverride("activeBasemap"))},()=>{}).then(()=>{this._loadingProjectionEngine=!1});a.map.basemap=e,this._clearOverride("activeBasemap"),s==null||E(a.spatialReference,s)||(a.spatialReference=s)}else a.map.basemap=e,this._clearOverride("activeBasemap")}castActiveBasemap(e){return pe(e)}get activeBasemapIndex(){const{state:e,activeBasemap:a}=this;return e!=="ready"?-1:this._findBasemapIndex(a)}get compatibilityFunction(){var e;return((e=this.view)==null?void 0:e.type)==="3d"?Le:Ce}set compatibilityFunction(e){this._overrideIfSome("compatibilityFunction",e)}castSource(e){return Array.isArray(e)||R.isCollection(e)?new Q({basemaps:Array.isArray(e)?new R(e):e}):Me(e)?new _({portal:e}):Se(e)?new _(e):Ee(e)?e:null}get state(){var e;return(e=this.view)!=null&&e.ready&&this.source?le(this.view)&&!this.view.inGeographicLayout?"unsupported":this._loadingProjectionEngine?"loading":"ready":"disabled"}basemapEquals(e,a){return me(e,a)}refresh(){this._recreateItems()}load(){return this.loadSource()}loadSource(e){return this.addResolvingPromise(k.isLoadable(this.source)?this.source.load(e):null),Promise.resolve(this)}_findBasemapIndex(e){const{items:a}=this,s=a.findIndex(i=>i.basemap===e);return s===-1?a.findIndex(i=>this.basemapEquals(i.basemap,e)):s}_recreateItems(){var l;const e=((l=this.source)==null?void 0:l.basemaps)??[],{view:a,compatibilityFunction:s}=this,i=new Map(this.items.map(p=>[p.basemap,p])),o=e.map(p=>{const c=i.get(p);return c?(i.delete(p),c):new U({basemap:p,compatibilityFunction:s,view:a})});this.items.removeAll(),this.items.addMany(o),i.forEach(p=>p.destroy())}_updateItems(){for(const e of this.items)e.compatibilityFunction=this.compatibilityFunction,e.view=this.view}};r([n()],m.prototype,"_loadingProjectionEngine",void 0),r([n({type:I})],m.prototype,"activeBasemap",null),r([S("activeBasemap")],m.prototype,"castActiveBasemap",null),r([n({readOnly:!0})],m.prototype,"activeBasemapIndex",null),r([n()],m.prototype,"compatibilityFunction",null),r([n({readOnly:!0,type:H})],m.prototype,"items",void 0),r([n()],m.prototype,"source",void 0),r([S("source")],m.prototype,"castSource",null),r([n({readOnly:!0})],m.prototype,"state",null),r([n()],m.prototype,"view",void 0),m=r([F("esri.widgets.BasemapGallery.BasemapGalleryViewModel")],m);const Pe=m;/*! All material copyright Esri, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.32/esri/copyright.txt for details.
v4.32.12 */function Ae({level:t,class:e,children:a}){const s=Ge(t),i=`h${s}`,o=Be(i);return Re`<${o} .ariaLevel=${String(s)} class=${v(G(g.heading,e))} role=heading>${a}</${o}>`}function Te(t,e,a){return Math.min(Math.max(t,e),a)}function Ge(t){return Te(Math.ceil(t),1,6)}const Oe=Y`@layer{arcgis-basemap-gallery{display:block}}`,De=_e(Pe),L={small:200,default:280,wide:420},B=class B extends W{constructor(){super(...arguments),this.messages=$e({}),this.viewModel=De(this),this._width=0,this._state="",this.activeBasemap=this.viewModel.activeBasemap,this.autoDestroyDisabled=!1,this.disabled=!1,this.headingLevel=2,this.icon="basemap",this.label="",this.position="bottom-left",this.source=this.viewModel.source,this.state=this.viewModel.state,this.arcgisPropertyChange=N()("activeBasemap","state"),this.arcgisReady=J()}async destroy(){await this.manager.destroy()}loaded(){this.manager.onLifecycle(()=>[O(()=>this.source,()=>{this.viewModel.loadSource()},{sync:!0,initial:!0}),f(()=>this.source.state,()=>{this._state=this.source.state},{sync:!0})]);const e=new ResizeObserver(s=>{for(const i of s)this._width=i.contentRect.width}),a=this.el.childElem;a&&e.observe(a)}_getRoundRobinIndex(e,a){return(e+a)%a}_handleKeyDown(e){const{key:a}=e;if(!["ArrowUp","ArrowDown","ArrowRight","ArrowLeft"].includes(a))return;e.preventDefault();const{items:s,activeBasemapIndex:i}=this.viewModel,o=a==="ArrowUp"||a==="ArrowLeft"?this._getRoundRobinIndex(Math.max(i-1,-1),s.length):this._getRoundRobinIndex(i+1,s.length),l=s.at(o);(l==null?void 0:l.state)==="ready"&&(this.viewModel.activeBasemap=l.basemap)}render(){const e=this.source.state==="loading",a=this.disabled||this.state==="disabled",s=this.viewModel.items,i={[b.sourceLoading]:e,[g.disabled]:a,"esri-component":!0},o=this._width;o<=L.small||o>=L.wide?i[b.layoutGrid]=!0:o<L.default&&(i[b.narrowItems]=!0);const l=e?w`<div class=${v(b.loader)}></div>`:null,p=e?null:s.length>0?w`<div aria-disabled=${this.disabled??M} aria-label=${this.label??M} class=${v(b.itemContainer)} @keydown=${this._handleKeyDown} role=radiogroup>${s.map((c,u)=>w`<arcgis-basemap-gallery-item .disabled=${a} .item=${c} .itemIndex=${u} .viewModel=${this.viewModel} .messages=${this.messages}></arcgis-basemap-gallery-item>`)}</div>`:w`<div class=${v(g.empty)}>${Ae({level:this.headingLevel,children:this.messages.noBasemaps})}</div>`;return w`<div class=${v(G(b.base,g.widget,g.panel,i))} style=${X({"--esri-basemap-gallery-small":`${L.small}px`})}>${[l,p]}</div>`}};B.properties={_width:16,_state:16,activeBasemap:0,autoDestroyDisabled:5,disabled:7,headingLevel:9,icon:1,label:1,position:1,referenceElement:1,source:0,state:3},B.shadowRootOptions=K,B.styles=Oe;let x=B;Z("arcgis-basemap-gallery",x);export{x as ArcgisBasemapGallery};
