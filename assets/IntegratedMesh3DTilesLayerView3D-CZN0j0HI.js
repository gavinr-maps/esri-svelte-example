import{e as S}from"./Evented-CXIxDjmW.js";import{c as Y,h as Fe,n as ge,y as j,b as He}from"./subclass-BR3PhgZG.js";import{u as be,v as Ve}from"./Accessor-D6mNnsWy.js";import{d as ye,P as Le}from"./reactiveUtils-BFQ0BtrB.js";import{n as je,s as De}from"./mat3-DRqs2t5W.js";import{e as _e,o as K}from"./mat3f64-BBpwCtoL.js";import{i as Be,I as ke}from"./mat4-ybYUU6jq.js";import{e as we}from"./mat4f64-Dk4dwAN8.js";import{t as Ge}from"./quatf64-BrpT0VRp.js";import{E as Ne,n as Q,c as $e,S as ze}from"./mathUtils-ClvKsMak.js";import{r as We}from"./vec4f64-CBQL1T0x.js";import{T as qe}from"./Point-DB4Hp4hH.js";import{u as Je}from"./computeTranslationToOriginAndRotation-CLzktXYu.js";import{x as Xe,f as Ye,t as Ke,i as Qe}from"./Transform-DHCeObPm.js";import{n as Ze}from"./projectVectorToVector-Chzd0Pq0.js";import{c as et,x as tt,L as rt,i as Z,O as it,E as ot,u as st,k as at,B as ve,g as xe}from"./BufferView-B7Z-dzh4.js";import{r as E,a as ee,S as D,N as U,e as u,m as nt,d as lt,g as Te,t as P,n as te,i as R}from"./ILyr3DWasmPerSceneView-vPx4somd.js";import{R as Ce}from"./elevationInfoUtils-Bl7QRRwv.js";import{l as mt}from"./ViewingMode-Dodu7ZZk.js";import{t as pt}from"./WaterSurface.glsl-BJUc652W.js";import{d as ct}from"./RenderGeometry-CXcYvifi.js";import{l as dt}from"./LayerView3D-DMyi427V.js";import{i as ht,l as B,a as Me}from"./DefaultUI-DVON9ypr.js";import{s as $,e as A,u as Pe}from"./basicInterfaces-wONHx_SN.js";import{E as Ee,D as x}from"./enums-BlUEVwJR.js";import{d as ut}from"./Graphic-Dc7F67nR.js";import{l as ft}from"./ElevationQueryTileCache-Sgr0RZBH.js";import{i as gt,e as bt,G as yt}from"./ElevationProvider-BHZsEIDd.js";import{m as _t,A as wt}from"./VertexColor.glsl-lPkEAKYQ.js";import{e as vt}from"./ElevationRange-BrgM1moX.js";import{I as xt,J as Tt,t as k}from"./orientedBoundingBox-COq6pSqo.js";import{b as Ct,I as Mt,d as Pt}from"./Viewshed.glsl-DunS1wrb.js";import{s as Et}from"./RenderTexture-BNgzgNs_.js";import{d as Oe,N as Ot}from"./Texture-CcsX4Ue_.js";import{c as Ut}from"./Normals-D1LdtP06.js";import{e as G}from"./VertexAttribute-BnAa5VW0.js";import{y as At}from"./LayerView-CbIY_4n2.js";import{c as It}from"./layerViewUtils-D2JqIDZ8.js";import"./shared-B3wH2qpO.js";import"./jsonMap-DCC6W5ex.js";import"./writer-3zufXUNV.js";import"./assets-C2mb-ea2.js";import"./index-CeCSsEgo.js";import"./projectBuffer-vsa0P_cF.js";import"./geodesicConstants-XRAvAZCD.js";import"./Polyline-D97hl-6E.js";import"./Extent-DHjqVB-p.js";import"./sphere-7666U3LO.js";import"./vec42-B1mBkh1w.js";import"./plane-Bz78OrLf.js";import"./vec2f64-Diu2Kaa8.js";import"./mathUtils-kvswLROa.js";import"./projectPointToVector-D3506wm2.js";import"./projection-A9yUaaTs.js";import"./vec2-B_ymkwGp.js";import"./unitConversionUtils-Dl04YuQU.js";import"./lengthUtils-D7_DvYH0.js";import"./symbols-CsUQ5BxR.js";import"./enumeration--HlxOQ_N.js";import"./fieldUtils-CNduWQU9.js";import"./intl-Dpfm8vPB.js";import"./Promise-CZrWwByK.js";import"./geometry-DpwwkAX1.js";import"./TextSymbol-gKE-H_J6.js";import"./Color-DDUWtbqR.js";import"./colorUtils-CS9vdHXB.js";import"./screenUtils-PfxkaaMN.js";import"./materialUtils-CQ3JLQ1x.js";import"./opacityUtils-BT7mQkwC.js";import"./aaBoundingBox-rJEWaOSN.js";import"./persistableUrlUtils-BcifXQ1Z.js";import"./collectionUtils-Dm1icNvk.js";import"./Portal-liet8xHC.js";import"./Clonable-cKbRam6-.js";import"./ColorMaterial.glsl-CJh1RTEZ.js";import"./Material-BN_i9QRJ.js";import"./interfaces-B8ge7Jg9.js";import"./InterleavedLayout-UIhsB8jd.js";import"./Util-BMqL_pkg.js";import"./NormalAttribute.glsl-Dqf1UPF9.js";import"./BindType-BmZEZMMh.js";import"./compilerUtils-BA04t1lN.js";import"./renderState-PYzNpa1K.js";import"./ShaderTechniqueConfiguration-D3UbJ2mX.js";import"./hydratedFeatures-Cy9DBeYQ.js";import"./jsonUtils-Cma_7A64.js";import"./floatRGBA-C8rGFKJ0.js";import"./Texture-BbJIOVx_.js";import"./vec2f32-BbH2jxlN.js";import"./dehydratedFeatures-fOLmpfQS.js";import"./quantizationUtils-CIQDbQFJ.js";import"./Field-C8SaaeoI.js";import"./fieldType-CIG5ey7e.js";import"./featureConversionUtils-DdoZh_25.js";import"./OptimizedFeature-7juV2tZm.js";import"./OptimizedGeometry-vU5jWBvU.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./edgeUtils-BIb6yRHm.js";import"./DecodeSymbolColor.glsl-CeBC4xQe.js";import"./Float4DrawUniform-CWdxHXQ-.js";import"./earcut-BqgeR2O3.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./DoubleArray-CF_CpVBS.js";import"./Indices-B6BGScAS.js";import"./vec3-C3Q-RF_i.js";import"./SnappingCandidate-O5eRSE6e.js";import"./visualVariableUtils-DzaXbn8H.js";import"./sizeVariableUtils-Cmcuvw-4.js";import"./PopupTemplate-ByHks6sq.js";import"./ActionToggle-C0Z1k2jc.js";import"./Identifiable-BLvpQbOc.js";import"./triangulationUtils-D8OjVISe.js";import"./deduplicate-DxTSMkFY.js";import"./triangle-B7rKLsGW.js";import"./lineSegment-BvgMMk26.js";import"./objectResourceUtils-DwPhzmLp.js";import"./devEnvironmentUtils-D6qIi8Ky.js";import"./vec4-L9zJLV3y.js";import"./Version-_Vxue7Ui.js";import"./quat-ChS85qAG.js";import"./NestedMap-DgiGbX8E.js";import"./requestImageUtils-DgB0_9qP.js";import"./verticalOffsetUtils-DaB1QvwW.js";import"./CIMSymbolHelper-C1Ghh-WW.js";import"./BidiEngine-BwB1Df7c.js";import"./fontUtils-CILP_6vp.js";import"./GeometryUtils-BSPpv37S.js";import"./enums-BRXbslMp.js";import"./utils-CO7DMJWl.js";import"./definitions-ByNBSgP9.js";import"./mat2d-DPkeMmgR.js";import"./mat2df32-orApM5a3.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BhuXqU4L.js";import"./defaults-DCm7iNI6.js";import"./defaultsJSON-GKolV7NZ.js";import"./OverrideHelper-C4oumxVn.js";import"./colorUtils-D5nOabzP.js";import"./cimSymbolUtils-D00GIWna.js";import"./utils-C1cS-0Yj.js";import"./jsonUtils-C4Wp5KpV.js";import"./parser-BN6zmHl-.js";import"./utils-D20M4_S8.js";import"./mat4f32-DcsiF_Rp.js";import"./LRUCache-ju6LnIBZ.js";import"./MemCache-C6WUx-5V.js";import"./lineStippleUtils-BcQwIcXj.js";import"./projectVectorToPoint-Cwe6B2HP.js";import"./MeshComponent-D1ps11B9.js";import"./imageUtils-9KeT6Jbh.js";import"./MeshVertexAttributes-DVEL_Tlm.js";import"./meshVertexSpaceUtils-CtidK-ZY.js";import"./MeshLocalVertexSpace-Xt9zU6DE.js";import"./projection-CJ-ESJIf.js";import"./spatialReferenceEllipsoidUtils-BL8s_3ls.js";import"./DefaultLayouts-Bz7P2wdj.js";import"./frustum-DqmLJYYu.js";import"./styleUtils-DQEZjdpw.js";import"./webStyleSymbolUtils-BtUE3Q7L.js";import"./jsonUtils-C6dvhNjw.js";import"./layerUtils-erzwAANv.js";import"./glUtil-C6KhMg1m.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./Octree-DQVAqpsn.js";import"./BufferObject-CjYoWxgZ.js";import"./Intersector-wnm5hmmT.js";import"./Scheduler-CDoWuxMK.js";import"./signal-DzOfzcfh.js";import"./debugFlags-B3L9P_UW.js";import"./weather-TVtZwW4o.js";import"./vec3f32-Cw9Q6TO_.js";import"./axisAngleDegrees-CHCWDIqP.js";import"./Intersector-CYIO18dt.js";import"./VertexArrayObject-Cwnso4un.js";import"./heightModelInfoUtils-BSzg1Wnl.js";import"./HeightModelInfo-CSXZysDz.js";import"./arcgisLayerUrl-Cgl5IQFD.js";import"./jsxFactory-CbAu6VfF.js";import"./uuid-fwrPAdZb.js";import"./UpdatingHandles-CMtXpTiG.js";import"./InputManager-C4xu1R9l.js";import"./Queue-DpHko4Yk.js";import"./Map-C4JPDBFj.js";import"./Basemap-DhGpUWGY.js";import"./loadAll-DDw-urzS.js";import"./PortalItem-BuTU9OuN.js";import"./writeUtils-3wz9AuW7.js";import"./Ground-BuxgFYJy.js";import"./CollectionFlattener-CkyePFnC.js";import"./editableLayers-BHlaPs85.js";import"./catalogUtils--o1nDhfl.js";import"./basemapUtils-CkCKogG3.js";import"./TablesMixin-BKe9x_jT.js";import"./Layer-C96_yo4i.js";import"./TimeExtent-41gxTbrv.js";import"./timeUtils-DQR2jUPL.js";import"./GraphicsCollection-nEq2FD1R.js";import"./ReactiveMap-Dl_3-Rm5.js";import"./Query-Cx4awVKu.js";import"./DataLayerSource-6X35yXpo.js";import"./FullTextSearch-BNIhEccm.js";import"./selectionUtils-DYi6daQO.js";import"./IViewEvents-Bci6PjlS.js";import"./interfaces-D6pIddIh.js";import"./screenUtils-BGG3AyYa.js";import"./a11yUtils-DwloBVAu.js";import"./capabilities-C84AMSCg.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-CZa70j6i.js";import"./accessibleHandler-DFh8uIGE.js";import"./Compass-DD0Dkx4v.js";import"./utils-DsJqvptN.js";import"./GoTo-CyjNnle5.js";import"./NavigationToggle-C75z3F4y.js";import"./Zoom-DVO2GqC9.js";import"./LayerConstants-B33OP6sh.js";import"./boundedPlane-CZE_hxQR.js";import"./Viewpoint-B260yGoV.js";import"./Cyclical-BY_I03kj.js";import"./workers-8Q6jrI18.js";import"./RenderCoordsHelper-DgY-kqpV.js";import"./scaleUtils-BciLowpa.js";import"./viewpointUtils-NBu6CVKZ.js";import"./earthUtils-BoWm1Npn.js";import"./spatialReferenceSupport-C0HdvI6F.js";import"./ElevationSamplerData-IYvomv6Y.js";import"./terrainUtils-DI2O4VuO.js";import"./TileInfo-DkEc90N-.js";import"./TileKey-DZd6gJy7.js";import"./Environment-CIgtfJ1a.js";import"./quantityUtils-d_-fFwhF.js";import"./Program-BE7XUO18.js";import"./ShadowCastVisualizeTechniqueConfiguration-CoPYcmeP.js";import"./euclideanLengthMeasurementUtils-Cc80-VfJ.js";import"./ray-DM1mbnrb.js";import"./ZoomMomentumEstimator-BjFm7M7Z.js";import"./labelFormatUtils-jemMExFz.js";import"./labelUtils-Cczy0uDR.js";import"./FeatureTileDescriptor3D-eAC3sTRJ.js";import"./geometryServiceUtils-K7u_-O-B.js";import"./project-C_6NxEch.js";import"./utils-D61i9O7E.js";import"./utils-Dx8bgRIB.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./RenderableTile-BEiJLF3C.js";import"./enums-BRzLM11V.js";import"./TileStrategy-_ezroEyM.js";import"./TileKey-CIqLSCov.js";import"./QueueProcessor-Bu6RBZRX.js";import"./config-MDUrh2eL.js";import"./DefaultVertexAttributeLayouts-BIPVF1RK.js";import"./DisplayObject-DFOkWAgp.js";import"./StyleDefinition-BK3ROBTO.js";import"./resources-BB7af0HE.js";import"./edgeProcessing-kh6EVSro.js";import"./testSVGPremultipliedAlpha-CKx7iZPZ.js";import"./RenderingContext-B0G6O7lI.js";import"./ProgramCache-DZJRjGv8.js";import"./doublePrecisionUtils-B0owpBza.js";class St extends pt{constructor(e,p,s,m,n,o,c){super(e,0,0,0,p),this.nodesCached=s,this.vboMB=m,this.textureMB=n,this.vboMBCached=o,this.textureMBCached=c}}const Rt={[E.Points]:null,[E.Lines]:null,[E.LineStrip]:null,[E.Triangles]:Ee.TRIANGLES,[E.TriangleStrip]:Ee.TRIANGLE_STRIP,[E.NotSet]:null},Ue={[ee.Opaque]:$.Opaque,[ee.Mask]:$.Mask,[ee.Blend]:$.Blend},Ft={[D.Back]:A.Back,[D.Front]:A.Front,[D.None]:A.None,[D.NotSet]:A.Back},Ht={[U.WrapYBit]:{s:x.CLAMP_TO_EDGE,t:x.REPEAT},[U.WrapXBit]:{s:x.REPEAT,t:x.CLAMP_TO_EDGE},[U.WrapXy]:{s:x.REPEAT,t:x.REPEAT},[U.None]:{s:x.CLAMP_TO_EDGE,t:x.CLAMP_TO_EDGE},[U.NotSet]:{s:x.CLAMP_TO_EDGE,t:x.CLAMP_TO_EDGE}},Vt={[u.U8]:1,[u.I8]:1,[u.U16]:2,[u.I16]:2,[u.U32]:4,[u.I32]:4,[u.F32]:4,[u.F64]:8,[u.Utf8String]:1,[u.NotSet]:1};class Lt{constructor(e){this.layerUid=[],this.type=gt.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,p,s,m,n,o){const c=e.results,_=e.options.store===bt.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const w=this.layerView.view._stage.renderView.componentObjectCollection,f=new _t(o??!1,e.options.normalRequired);this.layerView.objects.forEach(h=>{h.visible&&h.intersectionGeometry&&w.intersect(h,s,m,e.tolerance,null,f,(d,a,r,g)=>{if(a>=0){if(p!=null&&!p(s,m,a))return;const l=C=>{const T=new ft(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));C.set(this.type,T,a,r)};if(this.isGround&&(c.ground.dist==null||a<c.ground.dist)&&l(c.ground),e.options.isFiltered)return;if((c.min.dist==null||a<c.min.dist)&&l(c.min),(c.max.dist==null||a>c.max.dist)&&l(c.max),_){const C=yt(e.ray);l(C),e.results.all.push(C)}}})})}_createTiles3DGraphic(e,p){return new ut({layer:e,sourceLayer:e,attributes:p})}}var b;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(b||(b={}));class jt{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function N(t){return Math.round(t/1048.576)/1e3}let O=class extends dt(At){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=ct.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(b.Error),this._dbg(b.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new Y("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=ht(this).then(e=>{this._intersectionHandler=new Lt(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,s=>this._slicePlaneEnabledChange(s)),this._elevationProvider=new Xe({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const p=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,s=>this._onRemoveFromCache(s));this._memCache=p,this.addHandles([ye(()=>this.layer.elevationInfo,s=>this._elevationInfoChanged(s))]),this._suspendedHandle=ye(()=>this.suspended,s=>{const m=B(this.view);m&&m.setEnabled(this,!s)},Le)}).catch(e=>{if(Me(this),this._wasmLayerId=-1,e===nt)throw new Y("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===lt)throw new Y("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(b.VerboseAPI,"Tiles3DLayerView3D destroy() called"),Me(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=be(this._memCache),this._updatingHandles=be(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle==null&&(this._visibleGeometryChangedSchedulerHandle=Ve(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const p=this._collection.getMaterial(e);p.commonMaterialParameters.hasSlicePlane=t,p.commonMaterialParameters.cullFace=t?A.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){const e=B(this.view);e&&e.setLayerOffset(this,Ce(t))}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.totalMemory())}),t}get unloadedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.totalMemory())}),t}get visibleAtCurrentScale(){return It(this.layer.effectiveScaleRange,this.view.terrainScale)}get performanceInfo(){let t=0,e=0,p=0,s=0,m=0,n=0;return this._lyrHandleToObjects.forEach(o=>{o.isVisible?(t+=o.texMemoryUsage,e+=o.vboMemoryUsage,m++):(p+=o.texMemoryUsage,s+=o.vboMemoryUsage,n++)}),new St(this.usedMemory,m,n,N(e),N(t),N(s),N(p))}_canProjectWithoutEngine(){var t,e;if(this.view.state.viewingMode===mt.Local){const p=(t=this.view.renderSpatialReference)!=null&&t.isWebMercator?3857:((e=this.view.renderSpatialReference)==null?void 0:e.wkid)??-1;if(p!==3857&&p!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return Ce(this.layer.elevationInfo)}get elevationRange(){const t=this.fullExtent;return t!=null&&t.zmin&&(t!=null&&t.zmax)?new vt(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=B(this.view);return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){var a;const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const p=Ne(e.desc.origin),s=new Array,m=new Map,n=new jt;n.handle=t.handle,this._lyrHandleToObjects.set(t.handle,n);const o=this.view.basemapTerrain.spatialReference;let c,_;if(this.view.viewingMode==="global"){const r=we();Je(qe,p,r,o),c=je(_e(),r),_=De(_e(),c)}else c=K,_=K;const w=we();Be(w,w,p);const f=ke(Q(),w);let h=null;const d=Q();if(e.desc.obb){const r=e.desc.obb.quaternion;h=new xt(e.desc.obb.center,e.desc.obb.halfSize,Ge(r[0],r[1],r[2],r[3]))}for(let r=0;r<e.desc.prims.length;r++){const g=e.desc.prims[r];if(this._dbg(b.VerboseAPI,JSON.stringify(g)),g.ptype===E.Lines)continue;if(Rt[g.ptype]==null||e.data==null){this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+g.ptype+"). Skipping primitive.");continue}const l=(a=e.desc)!=null&&a.materials&&g.materialId!=null?e.desc.materials[g.materialId]:null,C=l!=null?l.lightingModel:Te.Unlit,T=!Fe("disable-feature:im-shading"),{positionView:y,positionAttr:M,normalsView:Ae,normalsAttr:z,colorAttr:F,texCoord0Attr:H,indicesView:I}=this.getBufferViews(g,e.data.buffer,c,T);if(M==null||y==null||I==null)continue;const re={colors:F!=null,textureCoordinates:H!=null?Oe.Default:Oe.None,hasNormals:Ae!=null,needsNormals:T},Ie=M.data.length/M.size,W=(i,v)=>!i||i.data.length/i.size===Ie||(this._dbg(b.Error,`${v} !== numPos. Skipping primitive.`),!1);if(!W(H,"numTexcoord")||!W(F,"numColors")||!W(z,"normals"))continue;const ie=Ct(re);if(h!=null?h=h.clone():(h=Tt(M),$e(d,h.center,p),h.center=d),c!==K)for(let i=0;i<y.count;i++)y.getVec(i,d),ze(d,d,c),y.setVec(i,d);const q=ie.createBuffer(M.data.length),V=new Map([[G.POSITION,M]]);H!=null&&V.set(G.UV0,H),F!=null&&V.set(G.COLOR,F),z!=null&&V.set(G.NORMALCOMPRESSED,z),V.forEach((i,v)=>{i!=null&&wt(v,i,null,null,q,0)});const Se=new Uint32Array([0,I.typedBuffer.length]),Re={vertices:{data:q.buffer,count:q.byteLength/ie.stride,layoutParameters:re},positionData:{positions:y.typedBuffer,indices:I.typedBuffer},indices:I.typedBuffer,componentOffsets:Se};n.cpuMemoryUsage+=y.count,n.cpuMemoryUsage+=I.count;const oe=this.view.renderSpatialReference,J=Q(),X=[1,1,1];Ye(f,oe,X,o)||this._dbg(b.Error,"Unsupported coordinate system for IM overlay"),Ze(f,oe,J,o);const L=this._collection.createObject(new Ke(We(J[0],J[1],X[0],X[1]),new Qe(f,_),h,Re));l&&this._collection.updateMaterial(L,i=>{i.baseColor=l.baseColorFactor,i.usePBR=C===Te.Pbr,i.hasParametersFromSource=!1,i.baseColorTexture=this._getTexture(l.baseColorTex,e,m),i.usePBR&&(i.mrrFactors=[l.metallicFactor,l.roughnessFactor,0],i.emissiveFactor=l.emissiveFactor??[0,0,0],i.metallicRoughnessTexture=this._getTexture(l.metalTex,e,m),i.emissionTexture=this._getTexture(l.emissiveTex,e,m),i.occlusionTexture=this._getTexture(l.occlusionTex,e,m),i.normalTexture=this._getTexture(l.normalTex,e,m)),i.objectOpacity=0,i.alphaDiscardMode=$.Mask;const v=[];i.baseColorTexture&&v.push(i.baseColorTexture.loadPromise),i.usePBR&&i.metallicRoughnessTexture&&v.push(i.metallicRoughnessTexture.loadPromise),i.usePBR&&i.emissionTexture&&v.push(i.emissionTexture.loadPromise),i.usePBR&&i.occlusionTexture&&v.push(i.occlusionTexture.loadPromise),i.usePBR&&i.normalTexture&&v.push(i.normalTexture.loadPromise);const se=Promise.all(v);s.push(se),se.then(()=>{var ae,ne,le,me,pe,ce,de,he,ue,fe;i.alphaDiscardMode=Ue[l.alphaMode],i.objectOpacity=1,n.texMemoryUsage+=((ne=(ae=i.baseColorTexture)==null?void 0:ae.glTexture)==null?void 0:ne.usedMemory)||0,i.usePBR&&(n.texMemoryUsage+=((me=(le=i.metallicRoughnessTexture)==null?void 0:le.glTexture)==null?void 0:me.usedMemory)||0,n.texMemoryUsage+=((ce=(pe=i.emissionTexture)==null?void 0:pe.glTexture)==null?void 0:ce.usedMemory)||0,n.texMemoryUsage+=((he=(de=i.occlusionTexture)==null?void 0:de.glTexture)==null?void 0:he.usedMemory)||0,n.texMemoryUsage+=((fe=(ue=i.normalTexture)==null?void 0:ue.glTexture)==null?void 0:fe.usedMemory)||0)}),i.commonMaterialParameters.doubleSided=l.isDoubleSided,i.commonMaterialParameters.cullFace=l.faceCulling?Ft[l.faceCulling]:A.Back,this._initialCullFace.set(L,i.commonMaterialParameters.cullFace),i.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,i.componentParameters.castShadows=Mt.All,i.textureAlphaCutoff=l.alphaCutoff??.1,i.alphaDiscardMode=Ue[l.alphaMode],i.isIntegratedMesh=!0,i.polygonOffsetEnabled=!1,i.hasOccludees=!1,i.ellipsoidMode=Pt(this.view.spatialReference)}),n.components.push(L),n.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(L)}if(await Promise.all(s),m.forEach(r=>{n.textures.push(r)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${n.handle}`,n,n.totalMemory()),{memUsageBytes:n.totalMemory()}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(p=>{this._stage.remove(p)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,p){if(this._memCache){for(let s=0;s<p;++s){const m=t[s],n=e[s];if(!n)continue;const o=this._lyrHandleToObjects.get(m);o&&(this._visibleGeometryChanged(),o.isVisible=n,o.components.forEach(c=>{this._collection.setObjectVisibility(c,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(c))}),this._memCache.pop(`${m}`))}for(let s=0;s<p;++s){const m=t[s],n=e[s];if(n)continue;const o=this._lyrHandleToObjects.get(m);o&&(this._visibleGeometryChanged(),o.isVisible=n,o.components.forEach(c=>{this._collection.setObjectVisibility(c,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(c))}),this._memCache.put(`${m}`,o,o.totalMemory()))}}}_getTexture(t,e,p){var m,n;let s=null;if(t&&((m=e.desc)!=null&&m.images)&&((n=e.data)!=null&&n.buffer)){const o=e.desc.images[t==null?void 0:t.imageId];if(s=p.get(o),!s&&o){const c=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,_=c>1,w=Ht[t.wrapMode??U.None];let f=o.alpha?4:3;const h=new Uint8Array(e.data.buffer,o.data.byteOffset,o.data.byteCount);let d=null,a=null,r=null;switch(o.format){case P.Raw:o.pixelFormat===te.R8?(d=h.buffer,f=1,a=""):o.pixelFormat===te.Rgb8?(d=h.buffer,f=3,a=""):o.pixelFormat===te.Rgba8&&(d=h.buffer,f=4,a="");break;case P.Dxt1:d=h.buffer,f=3,a=Pe.DDS_ENCODING;break;case P.Dxt5:d=h.buffer,f=4,a=Pe.DDS_ENCODING;break;case P.Png:a="image/png",r=document.createElement("img");break;case P.Jpeg:a="image/jpeg",r=document.createElement("img");break;case P.Etc2:a="image/ktx",r=document.createElement("img");break;case P.Astc:this._dbg(b.Error,"Astc texture not supported");break;case P.Pvrtc:this._dbg(b.Error,"Pvrtc texture not supported")}if(r&&a){const g=new Blob([h],{type:a});r.src=URL.createObjectURL(g),d=r}d&&a!=null&&(s=new Ot(d,{mipmap:_,maxAnisotropy:c,encoding:a,wrap:w,components:f,noUnpackFlip:!0,width:o.mip0Width,height:o.mip0Height}),this._stage.add(s),p.set(o,s))}}return s?new Et(this.view._stage.renderView.textures,s.id):null}getBufferViews(t,e,p,s){let m,n,o,c,_,w,f,h=null;for(let d=0;d<t.atrbs.length;d++){const a=t.atrbs[d],r=a.view,g=void 0,l=r.byteOffset+r.byteCount,C=r.byteCount/Vt[r.type],T=[...Array(C).keys()].map(y=>y);try{switch(a.sem){case R.Position:r.ncomp!==3||r.type!==u.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Position ("+r+")"):(m=new Z(e,r.byteOffset,g,l),n=new k(m.typedBuffer,T,3));break;case R.Normal:if(r.ncomp!==3||r.type!==u.F32)this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Normal ("+r+")");else if(s){const y=new Z(e,r.byteOffset,g,l),M=Ut(y.typedBuffer,p);_=new at(M),w=new k(_.typedBuffer,T,2)}break;case R.TexCoord:r.ncomp!==2||r.type!==u.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+r+")"):c===void 0&&(c=new k(new st(e,r.byteOffset,g,l).typedBuffer,T,2));break;case R.Color:r.ncomp===4?(r.type===u.F32&&(h=new et(e,r.byteOffset,g,l)),r.type===u.U8&&(h=new tt(e,r.byteOffset,g,l)),r.type===u.U16&&(h=new rt(e,r.byteOffset,g,l))):r.ncomp===3&&(r.type===u.F32&&(h=new Z(e,r.byteOffset,g,l)),r.type===u.U8&&(h=new it(e,r.byteOffset,g,l)),r.type===u.U16&&(h=new ot(e,r.byteOffset,g,l))),h==null?this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+r+")"):o=new k(h.typedBuffer,T,r.ncomp);break;case R.FeatureIndex:break;default:this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+a.sem+"). Skipping vertex attribute.")}}catch(y){this._dbg(b.VerboseAPI,"Error Creating buffer ("+y+"). Skipping vertex attribute.")}}if(t.index){const d=t.index.view,a=void 0,r=d.byteOffset+d.byteCount;switch(t.index.view.type){case u.U16:f=new xe(e,d.byteOffset,a,r);break;case u.U32:f=new ve(e,d.byteOffset,a,r);break;case u.U8:default:this._dbg(b.Error,"[Unsupported Feature] index type not supported ("+d.type+").")}}if(f==null&&m!=null){const d=m.count;if(d<65535){const a=new Uint16Array(d);f=new xe(a)}else{const a=new Uint32Array(d);f=new ve(a)}for(let a=0;a<d;a++)f.set(a,a)}return{positionView:m,positionAttr:n,colorAttr:o,texCoord0Attr:c,indicesView:f,normalsView:_,normalsAttr:w}}_onRemoveFromCache(t){const e=B(this.view);e&&e.onRenderableEvicted(this,t.handle,t.totalMemory()),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===b.Error?ge.getLogger(this).error(e):ge.getLogger(this).warn(e))}};S([j()],O.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),S([j()],O.prototype,"layer",void 0),S([j({readOnly:!0})],O.prototype,"visibleAtCurrentScale",null),S([j()],O.prototype,"elevationOffset",null),O=S([He("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],O);const Aa=O;export{Aa as default};
