import{i as z,L as W,c as U,n as G,x as y,s as j,a as q}from"./index-tefRSezt.js";import{V,d as S,v as P,j as J}from"./reactiveUtils-BR0C1Kq4.js";import{B as I,s as u,r as c,m as v,a as $,o as X,e as K,g as Q}from"./Accessor-BHnuXKD2.js";import{a4 as Y}from"./cast-BA_-jlhc.js";import{h as C}from"./UpdatingHandles-ptqz1ck8.js";import{x as Z}from"./layerUtils-dJgsXxkC.js";import{m as ee,C as ie}from"./Portal-CTRRujjZ.js";import{s as te,t as re}from"./utils-Cf-KB5Fk.js";import{p as L,X as F,I as T}from"./VersionManagementService-Cw_pm6KK.js";import{p as oe}from"./utils-BuPEKwV4.js";import{S as se}from"./JSONSupport-CGdeqxpk.js";import{e as ne,n as ae}from"./ref-Ccn4I0kT.js";import{s as le}from"./useT9n-B0I3cNlQ.js";import{u as de}from"./useViewModel-BxErfUSG.js";import"./Evented-DCWccWGU.js";import"./SimpleObservable-7oieNGD8.js";import"./Promise-CmQqe-ke.js";import"./writer-B2bQV2uU.js";import"./Extent-CBBGeHb-.js";import"./Point-XGrwlf63.js";import"./Identifiable-BrT7zvUW.js";import"./applyEditsUtils-B-dfj_XI.js";import"./Graphic-CFXUQZlS.js";import"./Clonable-DvJsj5LF.js";import"./opacityUtils-CSd4XoR2.js";import"./enumeration-Cr5WIZs4.js";import"./Color-gncXBiLc.js";import"./colorUtils-Rxh2V3ai.js";import"./mathUtils-DV9iOXpW.js";import"./ActionToggle-__-l4AdQ.js";import"./jsonUtils-Cu7OBRmN.js";import"./Polyline-BmuD2-ZN.js";import"./typeUtils-BSg8Y507.js";import"./TextSymbol-BQ_NW9Xo.js";import"./screenUtils-_ZIvrt5o.js";import"./collectionUtils-CbaToa73.js";import"./vec3f64-BLpZdpfb.js";import"./aaBoundingBox-CeBivBRq.js";import"./projection-B2I9Bzj_.js";import"./projectBuffer-DOU0xvVi.js";import"./geodesicConstants-yASAK_zX.js";import"./MeshTransform-CIhaTwDv.js";import"./mat4-Fi6iAz29.js";import"./common-DQOJ18NT.js";import"./mat4f64-Dk4dwAN8.js";import"./quat-4pa1e6ds.js";import"./mat3f64-BBpwCtoL.js";import"./quatf64-CCm9z-pX.js";import"./vec32-Dvg_eL9J.js";import"./vec42-YcqnINSP.js";import"./axisAngleDegrees-8Sw4vC28.js";import"./editingSupport-Dr0ErgB3.js";import"./uuid-Cl5lrJ4c.js";import"./normalizeUtils-XRAPXbWa.js";import"./normalizeUtilsCommon-D0zPTJCj.js";import"./utils-Cy8wFNQo.js";import"./utils-CkSELPnj.js";import"./EditBusLayer-Cx9SJosU.js";import"./infoFor3D-CsJzgCF0.js";import"./featureLayerUtils-BzWCGee1.js";import"./Field-Cyk7Ur5d.js";import"./fieldType-L-VlbZqy.js";import"./featureQueryAll-xezK3WCp.js";import"./Query-DCBIeen2.js";import"./FullTextSearch-BWm_kPUE.js";import"./TimeExtent-J5qnUFx_.js";import"./timeUtils-D2X862bk.js";import"./SimpleRenderer-gSw1WaJS.js";import"./commonProperties-bGHL1a5M.js";import"./colorRamps-Dkx8zIVn.js";import"./SizeVariable-IzD1bP2e.js";import"./visualVariableUtils-Bp9QCb8E.js";import"./lengthUtils-DjJgJFRg.js";import"./ColorStop-CDpeFWOz.js";import"./jsonUtils-Dzgxk9pw.js";import"./defaults-Dwxdhopq.js";import"./defaultsJSON-GKolV7NZ.js";import"./UniqueValueRenderer-Cri3tgP5.js";import"./diffUtils-CMkuJvD2.js";import"./RendererLegendOptions-mgfHoilI.js";import"./styleUtils-BB-zx7mT.js";import"./AttachmentQuery-BceVlzuF.js";import"./NormalizationBinParametersMixin-D6iHLB7I.js";import"./RelationshipQuery-W-4bfgaH.js";import"./serviceCapabilitiesUtils-BuKg0yWx.js";import"./PortalItem-CXk7DqVv.js";import"./portalItemUtils-rm7sAgcm.js";import"./editsZScale-BKYnJc2O.js";import"./catalogUtils-CK4eMvD1.js";import"./directive-helpers-C0aXnQdc.js";import"./index-BkKcLxWB.js";import"./component-utils-DWY0IMHC.js";let g=class extends se.JSONSupportMixin(ee){constructor(e){super(e),this.versionManagementService=null,this.featureServiceUrl=null,this.url=null,this.currentVersion=null,this.currentVersionInfo=null,this.versionInfos=[],this.versionableItems=new V,this.usePersistentReadSessions=!1,this.state="lock-none"}initialize(){this.url=this.versionManagementService.url,this.featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),this.addHandles([this.versionableItems.on("before-add",e=>{if(e.item.featureServiceUrl.toLowerCase()!==this.featureServiceUrl.toLowerCase())return e.preventDefault(),void I.getLogger(this).error("#add()","Cannot add versionAdapter, feature service urls do not match.")}),this.versionableItems.on("before-remove",e=>{if(this.versionableItems.items.length===0&&this.currentVersion&&"name"in this.currentVersion&&this.versionManagementService.getLockType(this.currentVersion)!=="none")return e.preventDefault(),void I.getLogger(this).error("#remove()","Cannot remove last versionAdapter.")})])}load(e){return this.addResolvingPromise(this._setUpState(e)),Promise.resolve(this)}get defaultVersionIdentifier(){return this.versionManagementService.defaultVersionIdentifier}get isDefault(){return!this.currentVersion||!!this.currentVersion&&"name"in this.currentVersion&&this.currentVersion.name===this.defaultVersionIdentifier.name}async getVersionInfos(e=!1){return e&&(this.versionInfos=await this.versionManagementService.getVersionInfos()),this.versionInfos}async alterVersion(e,i){if(this.currentVersion&&"guid"in this.currentVersion&&e.guid===this.currentVersion.guid)return!1;const r=await this.versionManagementService.alterVersion(e,i);return r&&await this.getVersionInfos(!0),r}async deleteVersion(e){if(this.currentVersion&&"guid"in this.currentVersion&&e.guid===this.currentVersion.guid)return!1;const i=await this.versionManagementService.deleteVersion(e);return i&&await this.getVersionInfos(!0),i}async getVersionInfoExtended(){return this.currentVersion&&"name"in this.currentVersion?this.versionManagementService.getVersionInfoExtended(this.currentVersion):this.versionManagementService.getVersionInfoExtended(this.defaultVersionIdentifier)}async startEditing(){if(this._isDefaultOrHistoricVersion())return{success:!1};if(!this.usePersistentReadSessions){const i=await this.versionManagementService.startReadingWithResult(this.currentVersion);if(!i.success)return i;this.state="lock-read"}const e=await this.versionManagementService.startEditingWithResult(this.currentVersion);return e.success&&(this.state="lock-write"),e}async stopEditing(e){if(this._isDefaultOrHistoricVersion())return{success:!1};const i=await this.versionManagementService.stopEditingWithResult(this.currentVersion,e);if(!i.success)return i;if(this.state="lock-read",!this.usePersistentReadSessions){const r=await this.versionManagementService.stopReadingWithResult(this.currentVersion);return r.success&&(this.state="lock-none"),r}return i}async changeVersion(e){var o;let i=null;if(this.usePersistentReadSessions){if(this._isDefaultOrHistoricVersion(e))e&&"name"in e?(i=await this.versionManagementService.getVersionInfoExtended(e),this.state=(i==null?void 0:i.access)==="public"?"lock-none":"lock-read"):this.state="lock-read";else if(!await this.versionManagementService.startReading(e))throw new u("Failed to acquire read lock for version: "+e);this._isDefaultOrHistoricVersion(this.currentVersion)||await this.versionManagementService.stopReading(this.currentVersion)}const r=await this.versionManagementService.changeVersionWithResult(this.versionableItems,this.currentVersion,e);let s=!1;return r.forEach((a,n)=>{s=s||a.success}),s&&(this.currentVersion=e,this.currentVersionInfo=i||await this.getVersionInfoExtended(),this._isDefaultOrHistoricVersion()?this.currentVersion&&"name"in this.currentVersion?this.state=((o=this.currentVersionInfo)==null?void 0:o.access)==="public"?"lock-none":"lock-read":this.state="lock-read":this.state=this.versionManagementService.getLockType(this.currentVersion)!=="read"?"lock-none":"lock-read"),r}async undo(){return this._isDefaultOrHistoricVersion()?{success:!1}:(this.versionManagementService.undo(this.currentVersion),{success:!0})}async redo(){return this._isDefaultOrHistoricVersion()?{success:!1}:(this.versionManagementService.redo(this.currentVersion),{success:!0})}async _setUpState(e){var i;await this.versionManagementService.load(e),this.state="lock-none",this.currentVersionInfo=await this.getVersionInfoExtended(),this.versionableItems.forEach(r=>{this.currentVersion?"name"in this.currentVersion?(r.gdbVersion=this.currentVersion.name,r.historicMoment=null):(r.historicMoment=this.currentVersion,r.gdbVersion=null):(r.gdbVersion=null,r.historicMoment=null)}),this.usePersistentReadSessions&&(this._isDefaultOrHistoricVersion()?this.currentVersion&&"name"in this.currentVersion?this.state=((i=this.currentVersionInfo)==null?void 0:i.access)==="public"?"lock-none":"lock-read":this.state="lock-read":await this.versionManagementService.startReading(this.currentVersion)&&(this.state="lock-read"))}_isDefaultOrHistoricVersion(e=this.currentVersion){return!(e&&"name"in e)||e.name===this.versionManagementService.defaultVersionIdentifier.name}};c([v()],g.prototype,"versionManagementService",void 0),c([v()],g.prototype,"featureServiceUrl",void 0),c([v()],g.prototype,"url",void 0),c([v()],g.prototype,"currentVersion",void 0),c([v()],g.prototype,"currentVersionInfo",void 0),c([v()],g.prototype,"versionInfos",void 0),c([v()],g.prototype,"versionableItems",void 0),c([v()],g.prototype,"usePersistentReadSessions",void 0),c([v()],g.prototype,"state",void 0),c([v({readOnly:!0})],g.prototype,"defaultVersionIdentifier",null),c([v({readOnly:!0})],g.prototype,"isDefault",null),g=c([$("esri.versionManagement.VersioningState")],g);const A=g;async function ce(t,e){let i;if("layers"in t){const o=L(t.allTables.concat(t.allLayers).filter(a=>a.type!=="group").toArray());t.utilityNetworks&&t.utilityNetworks.forEach(a=>{const n=L([a]);o.push(...n)}),i=o}else i=new V(t);const r=new Map;for(const o of i){const a=r.get(o.featureServiceUrl);a?a.push(o):r.set(o.featureServiceUrl,new V([o]))}const s=new V;for(const[o,a]of r){const n=new F({url:o});if(await n.load(),!n.versionManagementServiceUrl)continue;const d=new T({url:n.versionManagementServiceUrl});s.push(new A({versionManagementService:d,versionableItems:a,usePersistentReadSessions:e}))}return s}const N=new Map;async function ve(t,e=!1){const i=await ce(t.map,e);return X(N,t,()=>(t.addHandles(K(()=>{N.delete(t),i.forEach(r=>r.destroy())})),i.forEach(r=>r.load().catch(s=>{I.getLogger("esri.versionManagement.VersioningState").error("Failed to load Versioning State",s)})),i))}let m=class extends Q{constructor(t){super(t),this._portalLookup=new Map,this._updatingHandlesLoad=new C,this._updatingHandlesExecute=new C,this.advancedEditingUserTypeExtensionLookup=new Map,this.executionError=void 0,this.featureServiceLookup=new Map,this.loadError=void 0,this.serverVersionLookup=new Map,this.serviceNameLookup=new Map,this.userLookup=new Map,this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionAdministratorLookup=new Map,this.versionManagementServiceLookup=new Map,this.versioningStateLookup=new Map,this.view=null,this.versioningStates=null}initialize(){this._viewChangeHandle(),this.addHandles([S(()=>this.view,()=>{this._resetAllLookupProperties(),this._viewChangeHandle()}),S(()=>this.versioningStates,()=>{this._resetVersioningLookupProperties(),this._setVersioningStatesLookups()})])}destroy(){this._updatingHandlesLoad.destroy(),this._updatingHandlesExecute.destroy()}get state(){return this._updatingHandlesLoad.updating?"loading":this.loadError?"disabled":this._updatingHandlesExecute.updating?"executing":this.executionError?"failed":"ready"}async alterVersion(t){return this._updatingHandlesExecute.addPromise(this._alterVersionInternal(t))}async changeVersion(t,e,i){return this._updatingHandlesExecute.addPromise(this._changeVersionInternal(t,e,i))}async createVersion(t){return this._updatingHandlesExecute.addPromise(this._createVersionInternal(t))}async deleteVersion(t,e,i){return this._updatingHandlesExecute.addPromise(this._deleteVersionInternal(t,e,i))}async getVersionInfos(t){return this._updatingHandlesExecute.addPromise(this._getVersionInfosInternal(t))}async _alterVersionInternal(t){if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new u("version-management-view-model:load-error",this.loadError);this._setExecutionError();const e=this.versioningStateLookup.get(t.featureServerUrl);if(!e)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new u("version-management-view-model:execution-error",this.executionError);if(!this.serverVersionLookup.has(t.featureServerUrl)||this.serverVersionLookup.get(t.featureServerUrl)<=11.1)throw this._logError("version-management-view-model:execution-error","no-valid-enterprise-version"),new u("version-management-view-model:execution-error",this.executionError);if(!this.advancedEditingUserTypeExtensionLookup.get(t.featureServerUrl))throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new u("version-management-view-model:execution-error",this.executionError);const{featureServerUrl:i,versionIdentifier:r,...s}=t,o=await e.alterVersion(r,s).catch(a=>{throw this._logExecutionError(a),a});return await this.getVersionInfos(i),o}async _changeVersionInternal(t,e,i){if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new u("version-management-view-model:load-error",this.loadError);this._setExecutionError();const r=this.versioningStateLookup.get(t);if(!r)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new u("version-management-view-model:execution-error",this.executionError);const s={name:e,guid:i};return await r.changeVersion(s).catch(o=>{throw this._logExecutionError(o),o})}_updateVersionableItems(t){this._updatingHandlesLoad.addPromise((async()=>{L(t.added).forEach(e=>{const i=e.featureServiceUrl,r=this.versioningStateLookup.get(i);r&&(r.versionableItems.find(s=>s.versionableItem===e.versionableItem)||r.versionableItems.add(e))}),L(t.removed).forEach(e=>{const{allLayers:i,allTables:r}=this.view.map,s=e.featureServiceUrl,o=this.versioningStateLookup.get(s);if(!o)return void this._logError("version-management-view-model:execution-error","no-version-management-service-found");const a=d=>{var h;return(d.type==="feature"||d.type==="subtype-group")&&(((h=d.url)==null?void 0:h.includes(s))??!1)};[...i.filter(a),...r.filter(a)].length||(this.featureServiceLookup.delete(s),this.serviceNameLookup.delete(s),this.versioningStateLookup.delete(s),this.versioningStates.remove(o));const n=o.versionableItems.find(d=>d.versionableItem===e.versionableItem);n&&o.versionableItems.remove(n)})})())}async _createVersionInternal(t){var d,h,p;if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new u("version-management-view-model:load-error",this.loadError);this._setExecutionError();const e=t.featureServerUrl,i=this.versioningStateLookup.get(e);if(!i)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new u("version-management-view-model:execution-error",this.executionError);const r=this.advancedEditingUserTypeExtensionLookup.get(t.featureServerUrl),s=this.userLookup.get(e).toUpperCase(),o=this._isEmptyString(t.ownerName)?s:(d=t.ownerName)==null?void 0:d.trim().toUpperCase();if(o!==s){if(this.serverVersionLookup.get(e)<=11.1)throw this._logError("version-management-view-model:execution-error","versioning-api-error"),new u("version-management-view-model:execution-error",this.executionError);if(!r)throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new u("version-management-view-model:execution-error",this.executionError)}let a=await((h=this.versioningStateLookup.get(e))==null?void 0:h.getVersionInfos());if((o==null?void 0:o.toUpperCase())==="SDE"&&t.versionName.toUpperCase()==="DEFAULT"||a!=null&&a.find(l=>l.versionIdentifier.name.toUpperCase()===(o+"."+t.versionName).toUpperCase()||l.versionIdentifier.name.toUpperCase()===(s+"."+t.versionName).toUpperCase()))throw this._logError("version-management-view-model:execution-error","no-valid-version-name"),new u("version-management-view-model:execution-error",this.executionError);const n=await i.versionManagementService.createVersion({versionName:t.versionName,access:o!==s?"public":t.access,description:t.description}).catch(l=>{throw this._logExecutionError(l),l});if(o!==s){const{guid:l,name:E}=n.versionIdentifier,w={featureServerUrl:e,versionIdentifier:{guid:l,name:E},access:t.access,ownerName:o};await this.alterVersion(w)||this.deleteVersion(e,s+"."+t.versionName,n.versionIdentifier.guid)}return await this.getVersionInfos(e),a=await((p=this.versioningStateLookup.get(e))==null?void 0:p.getVersionInfos()),a==null?void 0:a.find(l=>l.versionIdentifier.guid===n.versionIdentifier.guid)}async _deleteVersionInternal(t,e,i){if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new u("version-management-view-model:load-error",this.loadError);this._setExecutionError();const r=this.versioningStateLookup.get(t);if(!r)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new u("version-management-view-model:execution-error",this.executionError);if(this.serverVersionLookup.get(t)<=11.1)throw this._logError("version-management-view-model:execution-error","versioning-api-error"),new u("version-management-view-model:execution-error",this.executionError);if(!this.advancedEditingUserTypeExtensionLookup.get(t))throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new u("version-management-view-model:execution-error",this.executionError);const s={name:e,guid:i};return await r.deleteVersion(s).catch(o=>{throw this._logExecutionError(o),new u("version-management-view-model:execution-error",this.executionError)})}async _getVersionInfosInternal(t){var o,a;if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new u("version-management-view-model:load-error",this.loadError);this._setExecutionError();const e=(o=this.featureServiceLookup.get(t))==null?void 0:o.featureService;if(!e)throw this._logError("version-management-view-model:execution-error","no-feature-service-found"),new u("version-management-view-model:execution-error",this.executionError);e.loaded||await e.load().catch(n=>{throw this._logExecutionError(n),n});const i=e.url;this.serverVersionLookup.set(i,((a=e.sourceJSON)==null?void 0:a.currentVersion)??0),this.serverVersionLookup.get(i)<=11.1&&this.advancedEditingUserTypeExtensionLookup.set(i,!1);const r=this.userLookup.get(t);this._portalLookup.get(t)&&r?(this.advancedEditingUserTypeExtensionLookup.set(i,await te(this._portalLookup.get(t),r,"advediting")),this.versionAdministratorLookup.set(i,await re(this._portalLookup.get(t),r,"features:user:manageVersions"))):(this.advancedEditingUserTypeExtensionLookup.set(i,!1),this.versionAdministratorLookup.set(i,!1));const s=this.versioningStateLookup.get(t);if(!s)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new u("version-management-view-model:execution-error",this.executionError);return s.loaded||await s.load().catch(n=>{throw this._logExecutionError(n),n}),await s.getVersionInfos(!0).catch(n=>{throw this._logExecutionError(n),n})}_isEmptyString(t){return!t||t.trim().length===0}_logError(t,e){switch(I.getLogger(this).error(new u(t,e)),t){case"version-management-view-model:load-error":this._setLoadError(e);break;case"version-management-view-model:execution-error":this._setExecutionError(e)}}_logExecutionError(t){this._logError("version-management-view-model:execution-error",t.message)}async _viewChangeHandle(){this._updatingHandlesLoad.addPromise((async()=>{if(this._setLoadError(),!this.view)return void this._setLoadError("no-view-property");if(this.view&&this.view.type!=="2d")return void this._logError("version-management-view-model:load-error","sceneView-not-supported");this.removeHandles("map-change-handle"),this.addHandles([S(()=>{var e;return(e=this.view)==null?void 0:e.map},()=>{this._resetAllLookupProperties(),this._mapChangeHandle(this.versioningStates)})],"map-change-handle");const t=await this._getVersioningStates();await this._mapChangeHandle(t)})())}async _mapChangeHandle(t){this._updatingHandlesLoad.addPromise((async()=>{this._setLoadError(),this.removeHandles("map-layers-tables-change-handle"),this.addHandles([P(()=>{var e;return(e=this.view)==null?void 0:e.map.allLayers},"change",e=>{(e.added.some(({type:i})=>i==="feature")||e.removed.some(({type:i})=>i==="feature")||e.added.some(({type:i})=>i==="subtype-group")||e.removed.some(({type:i})=>i==="subtype-group"))&&(this._resetServiceRelatedLookupProperties(),this._propertiesChangeInternal(this.versioningStates),this._updateVersionableItems(e))}),P(()=>{var e;return(e=this.view)==null?void 0:e.map.allTables},"change",e=>{(e.added.some(({type:i})=>i==="feature")||e.removed.some(({type:i})=>i==="feature")||e.added.some(({type:i})=>i==="subtype-group")||e.removed.some(({type:i})=>i==="subtype-group"))&&(this._resetServiceRelatedLookupProperties(),this._propertiesChangeInternal(this.versioningStates),this._updateVersionableItems(e))})],"map-layers-tables-change-handle"),await this._propertiesChangeInternal(t)})())}async _propertiesChangeInternal(t){this._updatingHandlesLoad.addPromise((async()=>{var s;const e=o=>o.type==="feature"||o.type==="subtype-group",{allLayers:i,allTables:r}=this.view.map;if(this._setLoadError(),this.featureServiceLookup=oe([...i.filter(e),...r.filter(e)]),this.featureServiceLookup.size){this._updateFeatureServiceLookup(t),this.serviceNameLookup=new Map;for(const o of this.featureServiceLookup.values()){const{featureService:a,featureService:{url:n}}=o;if(!this.serviceNameLookup.has(n)){if(a.loaded||await a.load().catch(l=>{I.getLogger(this).error(l)}),!a.versionManagementServiceUrl){this.featureServiceLookup.delete(n);continue}const d=await Z(n),h=new ie({authMode:"immediate",url:d});await h.load().catch(l=>{I.getLogger(this).error(l)});const p=(s=h.user)==null?void 0:s.username;if(!a.loaded||!h.loaded||!p)continue;this.serviceNameLookup.set(Y(n),n.split("/").at(-2)),this.userLookup.set(n,p),this._portalLookup.set(n,h)}}this.removeHandles("versioning-states-change-handle"),t.forEach(o=>this._handleVersioningStateLookupUpdate(o)),await this._updateVersioningStates(t),this.versioningStates=t}else this._logError("version-management-view-model:load-error","no-feature-services")})())}_updateFeatureServiceLookup(t){for(const e of t){const i=e.featureServiceUrl;if(!this.featureServiceLookup.has(i)){const r=new F({url:i}),s=e.versionableItems.toArray().flatMap(o=>o.type==="network"?null:o.versionableItem).filter(o=>!!o);this.featureServiceLookup.set(i,{featureService:r,layers:s})}}}async _updateVersioningStates(t){for(const e of this.featureServiceLookup.values()){const i=e.featureService;if(i.versionManagementServiceUrl){if(!t.find(r=>r.featureServiceUrl===i.url)&&i.versionManagementServiceUrl){const r=new V(L(e.layers)),s=new A({versionManagementService:new T({url:i.versionManagementServiceUrl}),versionableItems:r});t.add(s),this._handleVersioningStateLookupUpdate(s)}await this.getVersionInfos(i.url)}}}async _getVersioningStates(){return this.versioningStates&&this.versioningStates.length?this.versioningStates:this.view?await ve(this.view,!1):(this._logError("version-management-view-model:load-error","no-view-property"),new V)}_handleVersioningStateLookupUpdate(t){var e;this.versioningStateLookup.set(t.featureServiceUrl,t),this._addHandlesToVersioningState(t),this.versionIdentifierLookup.set(t.featureServiceUrl,(e=t.currentVersionInfo)==null?void 0:e.versionIdentifier),this.versionManagementServiceLookup.set(t.featureServiceUrl,t.versionManagementService)}async _setVersioningStatesLookups(){this._updatingHandlesLoad.addPromise((async()=>{this.versioningStates&&(this.removeHandles("versioning-states-change-handle"),this._updateFeatureServiceLookup(this.versioningStates),this.versioningStates.forEach(t=>this._handleVersioningStateLookupUpdate(t)),await this._updateVersioningStates(this.versioningStates))})())}_addHandlesToVersioningState(t){this.addHandles([S(()=>t.versionInfos,()=>{this.versionInfoLookup.set(t.featureServiceUrl,t.versionInfos)}),S(()=>{var e;return(e=t.currentVersionInfo)==null?void 0:e.versionIdentifier},()=>{var e;this.versionIdentifierLookup.set(t.featureServiceUrl,(e=t.currentVersionInfo)==null?void 0:e.versionIdentifier)})],"versioning-states-change-handle")}_resetVersioningLookupProperties(){this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionManagementServiceLookup=new Map,this.versioningStateLookup=new Map}_resetAllLookupProperties(){this._portalLookup=new Map,this.advancedEditingUserTypeExtensionLookup=new Map,this.serverVersionLookup=new Map,this.userLookup=new Map,this.versioningStates=new V,this._resetVersioningLookupProperties(),this._resetServiceRelatedLookupProperties()}_resetServiceRelatedLookupProperties(){this.featureServiceLookup=new Map,this.serviceNameLookup=new Map}_setExecutionError(t){this._set("executionError",t)}_setLoadError(t){this._set("loadError",t)}};c([v()],m.prototype,"_portalLookup",void 0),c([v()],m.prototype,"advancedEditingUserTypeExtensionLookup",void 0),c([v({readOnly:!0})],m.prototype,"executionError",void 0),c([v()],m.prototype,"featureServiceLookup",void 0),c([v({readOnly:!0})],m.prototype,"loadError",void 0),c([v()],m.prototype,"serverVersionLookup",void 0),c([v()],m.prototype,"serviceNameLookup",void 0),c([v({readOnly:!0})],m.prototype,"state",null),c([v()],m.prototype,"userLookup",void 0),c([v()],m.prototype,"versionIdentifierLookup",void 0),c([v()],m.prototype,"versionInfoLookup",void 0),c([v()],m.prototype,"versionAdministratorLookup",void 0),c([v()],m.prototype,"versionManagementServiceLookup",void 0),c([v()],m.prototype,"versioningStateLookup",void 0),c([v()],m.prototype,"view",void 0),c([v()],m.prototype,"versioningStates",void 0),m=c([$("esri.widgets.VersionManagement.VersionManagementViewModel")],m);const he=m;/*! All material copyright Esri, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.32/esri/copyright.txt for details.
v4.32.12 */const ue=z`@layer{.initial-version-invalid-block{margin-bottom:1rem}.calcite-combobox-item{width:330px}.calcite-flow-widget{width:350px}calcite-block{margin:0}calcite-pagination{justify-content:center}}`,me=de(he),H="map-components:version-management",_=class _ extends W{constructor(){super(...arguments),this.flowElement=ne(),this.messages=le({blocking:!0}),this.viewModel=me(this),this._isInitialVersionInvalid=new Map,this._initialVersionInfos=[],this._showInvalidFeatureServiceNotice=!1,this.allowEditingDisabled=!1,this.autoDestroyDisabled=!1,this.closable=!1,this.pageSize=5,this.position="top-right",this.state=this.viewModel.state,this.versioningStates=this.viewModel.versioningStates,this.view=this.viewModel.view,this.arcgisReady=U(),this.arcgisVersioningStateChanged=U()}get initialVersionInfos(){return this._initialVersionInfos}set initialVersionInfos(e){this._initialVersionInfos=e.map(i=>({...i,url:this._removeTrailingSlash(i.url)}))}async destroy(){await this.manager.destroy()}async load(){J(()=>this.viewModel.state==="ready").then(()=>{this.initialVersionInfos.forEach(e=>{try{this._changeToInitialVersion(e)}catch(i){console.error(i)}})}),this.manager.onLifecycle(()=>[S(()=>this.viewModel.state,e=>{const{flowElement:{value:i},versionList:r}=this,s=i==null?void 0:i.getElementsByTagName("arcgis-version-management-version-properties")[0];if(e==="disabled"&&i){s&&this._removeVersionPropertiesFlowItem(i),r&&this._removeVersionListFlowItem(i);return}r&&(r.versionListElementProps={...r.versionListElementProps,executionError:this.viewModel.executionError},r.versionListElementProps={...r.versionListElementProps,state:e}),s&&(s.versionPropertiesElementProps={...s.versionPropertiesElementProps,state:e})})])}_removeTrailingSlash(e){return e.replace(/\/+$/u,"")}_createVersionPropertiesFlowItem(e,i){const{closable:r,flowElement:{value:s},viewModel:o,viewModel:{state:a}}=this,n=document.createElement("arcgis-version-management-version-properties");return n.versionPropertiesElementProps={closable:r,currentUser:o.userLookup.get(e),hasAdvEditingUte:o.advancedEditingUserTypeExtensionLookup.get(e),isVersionAdministrator:o.versionAdministratorLookup.get(e),serviceUrl:e,state:a,strings:this.messages,versionInfo:i},n.selected=!0,n.showBackButton=!0,n.addEventListener("arcgisCreateVersion",d=>{const{createVersionParameters:h,switchToVersion:p}=d.detail;o.createVersion(h).then(async l=>{l&&this.arcgisVersioningStateChanged.emit({type:"version-created",versionIdentifier:l.versionIdentifier,versioningState:o.versioningStateLookup.get(e)}),p&&await this.viewModel.changeVersion(e,l.versionIdentifier.name,l.versionIdentifier.guid).then(E=>{E&&this.arcgisVersioningStateChanged.emit({type:"version-switched",versionIdentifier:l.versionIdentifier,versioningState:o.versioningStateLookup.get(e)})}),await this._refreshVersionList(e)}).finally(()=>{s&&this._removeVersionPropertiesFlowItem(s)})}),n.addEventListener("arcgisAlterVersion",async d=>{const{flowElement:{value:h}}=this,{alterVersionParameters:p}=d.detail;await o.alterVersion(p).then(async l=>{l&&this.arcgisVersioningStateChanged.emit({type:"version-changed",versionIdentifier:p.versionIdentifier,versioningState:o.versioningStateLookup.get(e)}),await this._refreshVersionList(e)}).finally(()=>{h&&this._removeVersionPropertiesFlowItem(h)})}),n.addEventListener("arcgisFlowItemBack",()=>{this._removeVersionPropertiesFlowItem(this.flowElement.value)}),n.addEventListener("calciteFlowItemBack",d=>{d.preventDefault(),this._removeVersionPropertiesFlowItem(this.flowElement.value),this.versionList&&(this.versionList.selected=!0)}),n.addEventListener("calciteFlowItemClose",()=>{this._handleFlowItemClose()}),n}_getLoadError(e){const{messages:i}=this;switch(e){case"no-feature-services":return i.loadErrors.noFeatureServices;case"no-view-property":return i.loadErrors.noViewProperty;default:return e}}_changeToInitialVersion(e){var p;const{_isInitialVersionInvalid:i,viewModel:r}=this,{url:s,name:o}=e,a=r.versioningStateLookup.get(s);if(!a)throw this._showInvalidFeatureServiceNotice=!0,new Error(`${H} - no versioning state found for feature service ${s}`);const n=a==null?void 0:a.versionInfos.find(l=>l.versionIdentifier.name===o);if(!n)throw i.set(s,!0),new Error(`${H} - version ${o} not found in the versioning state for feature service ${s}`);const d=n.versionIdentifier,h=(p=a==null?void 0:a.currentVersionInfo)==null?void 0:p.versionIdentifier;d.guid!==(h==null?void 0:h.guid)&&r.changeVersion(s,d.name,d.guid)}_handleFlowItemClose(){var i;const e=document.querySelector("arcgis-version-management");(i=e.parentElement)==null||i.removeChild(e)}async _handleNewVersionAction(e){var r;const i=this._createVersionPropertiesFlowItem(e.detail.serviceUrl,void 0);(r=this.flowElement.value)==null||r.appendChild(i),this.versionList&&(this.versionList.selected=!1)}async _handleManageVersionAction(e){var n;const{actionType:i,serviceUrl:r,versionInfo:s}=e.detail,{viewModel:o,flowElement:a}=this;switch(i){case"changeVersion":{o.changeVersion(r,s.versionIdentifier.name,s.versionIdentifier.guid).then(d=>{d&&this.arcgisVersioningStateChanged.emit({type:"version-switched",versionIdentifier:s.versionIdentifier,versioningState:o.versioningStateLookup.get(r)});const{versionList:h}=this;h&&(h.versionListElementProps={...h.versionListElementProps,currentVersionIdentifier:o.versioningStateLookup.get(r).currentVersionInfo.versionIdentifier})});break}case"deleteVersion":{o.deleteVersion(r,s.versionIdentifier.name,s.versionIdentifier.guid).then(async d=>{d&&this.arcgisVersioningStateChanged.emit({type:"version-deleted",versionIdentifier:s.versionIdentifier,versioningState:o.versioningStateLookup.get(r)}),await this._refreshVersionList(r)});break}case"editVersion":{const d=this._createVersionPropertiesFlowItem(r,s);(n=a.value)==null||n.appendChild(d),this.versionList&&(this.versionList.selected=!1);break}}}async _refreshVersionList(e){const{flowElement:{value:i},versionList:r,viewModel:s}=this;if(i){const o=await s.getVersionInfos(e),a=i.getElementsByTagName("arcgis-version-management-service-item");for(const n of a)n.serviceItemElementProps.serviceUrl===e&&(n.serviceItemElementProps={...n.serviceItemElementProps,versionInfos:o});r&&(r.versionListElementProps={...r.versionListElementProps,currentVersionIdentifier:s.versioningStateLookup.get(e).currentVersionInfo.versionIdentifier,versionInfos:o})}}_removeVersionListFlowItem(e){for(const i of e.childNodes)i.nodeName.toUpperCase()==="ARCGIS-VERSION-MANAGEMENT-VERSION-LIST"&&(e.removeChild(i),this.versionList=void 0),i.nodeName.toUpperCase()==="CALCITE-FLOW-ITEM"&&(i.hidden=!1)}_removeVersionPropertiesFlowItem(e){for(const i of e.childNodes)i.nodeName.toUpperCase()==="ARCGIS-VERSION-MANAGEMENT-VERSION-PROPERTIES"&&e.removeChild(i)}render(){const{allowEditingDisabled:e,closable:i,flowElement:{value:r},initialVersionInfos:s,_isInitialVersionInvalid:o,label:a,messages:n,mode:d,pageSize:h,versionList:p,viewModel:l,viewModel:{loadError:E,state:w}}=this,R=Array.from(l.serviceNameLookup,([f,k])=>({url:f,name:k})),O=w!=="disabled"?R.map(f=>{var b;const k={allowEditing:!e,closable:i,currentUser:l.userLookup.get(f.url),currentVersionIdentifier:l.versioningStateLookup.get(f.url).currentVersionInfo.versionIdentifier,executionError:void 0,flowElement:r,hasAdvEditingUte:l.advancedEditingUserTypeExtensionLookup.get(f.url),heading:a,initialVersionInfos:s,isInitialVersionInvalid:o,isVersionAdministrator:l.versionAdministratorLookup.get(f.url),isVersioningApiAvailable:(l.serverVersionLookup.get(f.url)??0)>=11.2,mode:d,pageSize:h,serviceName:f.name,state:w,serviceUrl:f.url,strings:n,versionInfos:((b=l.versioningStateLookup.get(f.url))==null?void 0:b.versionInfos)??[]};return y`<arcgis-version-management-service-item .serviceItemElementProps=${k} @arcgisGetVersions=${async x=>{await this._refreshVersionList(x.detail.serviceUrl)}} @arcgisFlowItemBack=${()=>{r&&(this._removeVersionListFlowItem(r),this.versionList=void 0)}} @arcgisFlowItemClose=${()=>{this._handleFlowItemClose()}} @arcgisManageVersion=${this._handleManageVersionAction} @arcgisNewVersion=${this._handleNewVersionAction} @arcgisCreateVersionList=${x=>{this.versionList=x.detail}}></arcgis-version-management-service-item>`}):void 0,D=w==="disabled"&&E!=null?y`<calcite-notice class="notice" kind=warning open scale=s slot=footer width=full><div slot=message>${this._getLoadError(E)}</div></calcite-notice>`:void 0,B=this._showInvalidFeatureServiceNotice?y`<calcite-notice closable kind=warning open scale=s slot=content-top width=full icon @calciteNoticeClose=${()=>this._showInvalidFeatureServiceNotice=!1}><div slot=title>${n.headers.invalidInitialFeatureService}</div><div slot=message>${n.loadErrors.invalidInitialFeatureService}</div></calcite-notice>`:void 0;return y`<calcite-flow custom-item-selectors="arcgis-version-management-version-list, arcgis-version-management-version-properties" class=${j(this.mode==="dialog"?"":"calcite-flow-widget")} ${ae(this.flowElement)}><calcite-flow-item .closable=${this.closable} .heading=${a??void 0} @calciteFlowItemClose=${()=>{this._handleFlowItemClose()}} .selected=${!p}>${B}<calcite-panel .loading=${w==="loading"||w==="executing"}>${O}${D}</calcite-panel></calcite-flow-item></calcite-flow>`}};_.properties={versionList:16,_showInvalidFeatureServiceNotice:16,allowEditingDisabled:5,autoDestroyDisabled:5,closable:7,initialVersionInfos:0,icon:3,label:3,messageOverrides:0,mode:1,pageSize:9,position:1,referenceElement:1,state:3,versioningStates:0,view:0},_.styles=ue,_.shadowRootOptions=G;let M=_;q("arcgis-version-management",M);export{M as ArcgisVersionManagement};
