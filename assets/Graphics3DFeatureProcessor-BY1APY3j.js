import{r as s}from"./tslib.es6-B3Jf3DVX.js";import{d as Q}from"./Graphic-DsxsIjhH.js";import{i as $}from"./hash-CcEbRgUF.js";import{n as T}from"./compilerUtils-Dw3R0f-Z.js";import{m as a,a as x,n as G,e as q}from"./subclass-BZA_h8Db.js";import{b as F,l as A,q as E,s as C,p as P,a2 as S}from"./Accessor-BLX9ikPh.js";import{m as H}from"./Promise-B2Hu02L7.js";import{initial as y,watch as m,when as N}from"./reactiveUtils-C5zUhJQJ.js";import{d as R}from"./diffUtils-BP7jmOAy.js";import{h as V}from"./UpdatingHandles-GfwcIh5z.js";import{ah as M,a2 as J}from"./Point-Cg0-ChZE.js";import{e as U}from"./UniqueValueRenderer-BQtAHUSo.js";import{i as j,l as D}from"./renderingInfoUtils-DAsRBUXK.js";import{b as I}from"./Query-5Xpquc1r.js";import{e as L,C as k}from"./RibbonLine.glsl-BZu1FDpE.js";import{r as z}from"./LineCallout.glsl-C1R4fy2f.js";import{z as B,u as Z,e as W}from"./ExtentSet-BhWFQ8Zv.js";import{p as Y,a as K,u as X}from"./Graphics3DObjectStates-DLTNWJbN.js";import{S as ee}from"./graphicUtils-CWEFaVJb.js";import{n as O}from"./attributeUtils-Dc8--CBJ.js";import{d as te}from"./FeatureFilter-BMHRQSxq.js";import{o as ie}from"./floorFilterUtils-DZ5C6FQv.js";import{o as re}from"./geometry-D964gYQX.js";import{w as se}from"./Extent-Bf3YTe7m.js";import{V as ne}from"./QueryEngine-DrzbS-Dm.js";import{Z as ae}from"./FieldsIndex-DpwHKAMX.js";import{d as v}from"./FeatureSet-BHEkYP03.js";import{g as oe}from"./Scheduler-CJu5awNf.js";import{s as _,n as le,e as ue}from"./highlightUtils-BYmbiZ48.js";import{c as pe}from"./HighlightDefaults-D4ckYWWJ.js";const de=ne;let h=class extends F{get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new I({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}constructor(e){super(e),this._dataQueryEngineInstance=null}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t,r){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,t),r)}async executeQueryForCount(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:r,extent:i}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:se.fromJSON(i)}}async executeQueryForIds(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const r=await this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),i=v.fromJSON(r);return i.features.forEach(n=>{n.layer=this.layer,n.sourceLayer=this.layer}),i}async executeQuery(e,t){const r=await this._dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),i=v.fromJSON(r);return i.features.forEach(n=>{n.layer=this.layer,n.sourceLayer=this.layer}),i}_ensureQueryJSON(e,t){let r=this.defaultQueryJSON;if(e!=null&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),r=e.toJSON()),t!=null){const i=t.geometries.map(n=>n.toJSON()).reduce((n,l)=>(n.rings=n.rings.concat(l.rings),n));r={...r,sceneFilter:{...t,geometry:i}}}return r}_ensureDataQueryEngine(){var g,w;if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&((g=this.layer.timeInfo)==null?void 0:g.toJSON())||null,t=this.layer.objectIdField,r=re.toJSON(this._queryGeometryType),i=((w=this.layer.fieldsIndex)==null?void 0:w.toJSON())||new ae([]),n=this.priority,l=this.spatialReference.toJSON(),{hasZ:u,hasM:p,featureStore:c,scheduler:f}=this.context;return this._dataQueryEngineInstance=new de({hasZ:u,hasM:p,geometryType:r,fieldsIndex:i,timeInfo:e,spatialReference:l,objectIdField:t,featureStore:c,scheduler:f,priority:n}),this._dataQueryEngineInstance}};s([a({constructOnly:!0})],h.prototype,"context",void 0),s([a({constructOnly:!0})],h.prototype,"priority",void 0),s([a()],h.prototype,"layer",null),s([a()],h.prototype,"spatialReference",null),s([a()],h.prototype,"_queryGeometryType",null),s([a()],h.prototype,"defaultQueryJSON",null),h=s([x("esri.views.3d.layers.graphics.QueryEngine")],h);let d=class extends F{constructor(e){super(e),this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new V,this._abortController=new AbortController}initialize(){const e=oe.FILTER_VISIBILITY,{layer:t,view:r}=this._configuration,{featureStore:i}=this.context,n=this._configuration.hasZ??!1,l=this._configuration.hasM??!1;this._queryEngine=new h({context:{spatialReference:r.spatialReference,layer:t,scheduler:r.resourceController.scheduler,featureStore:i,hasM:l,hasZ:n},priority:e}),this._frameTask=r.resourceController.scheduler.registerTask(e),this._updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this._updateRequested=!0,y),this._updatingHandles.addWhen(()=>!this._frameTask.updating&&this._updateRequested,()=>{this._frameTask.schedule(()=>this._updateVisibility(),this._abortController.signal),this._updateRequested=!1},y)}destroy(){this._abortController.abort(),this._updatingHandles.destroy(),this.clear(),this._frameTask=A(this._frameTask),this._queryEngine=E(this._queryEngine),this._set("context",null)}get updating(){return this._updateRequested||this._updatingHandles.updating||this._frameTask.updating}get defaultVisibility(){return this._compositedFeatureFilter==null&&this._sceneFilter==null}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _sceneFilter(){return"layerFilter"in this._configuration?this._configuration.layerFilter:null}get _floorFilter(){return ie(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){var n;const{_featureFilter:e,_timeExtent:t,_floorFilter:r}=this;if(t==null&&r==null)return e;const i=(e==null?void 0:e.clone())??new te;if(t!=null&&(i.timeExtent=((n=i.timeExtent)==null?void 0:n.intersection(t))??t),r!=null){const l=i.where==null||i.where==="";i.where=l?r:`(${i.where}) AND (${r})`}return i}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}async _updateVisibility(){const e=this._compositedFeatureFilter,t=this._sceneFilter,{signal:r}=this._abortController,i=this._frameTask,{context:n}=this;if(C(r),e==null&&t==null||n.getFeatureCount()===0)return await i.schedule(()=>this.clear(),r);try{const l=await this._queryEngine.executeQueryForIdSet(e,t,r);return C(r),await i.schedule(()=>{n.updateFeatureVisibilities(u=>l.has(u))},r)}catch(l){return P(l),G.getLogger(this).warn(`FeatureFilter query failed: ${l}`,{error:l}),await i.schedule(()=>{n.setAllFeaturesVisibility(!0)},r)}}};s([a({constructOnly:!0})],d.prototype,"context",void 0),s([a()],d.prototype,"updating",null),s([a()],d.prototype,"defaultVisibility",null),s([a()],d.prototype,"_featureFilter",null),s([a()],d.prototype,"_sceneFilter",null),s([a()],d.prototype,"_floorFilter",null),s([a()],d.prototype,"_timeExtent",null),s([a()],d.prototype,"_compositedFeatureFilter",null),s([a()],d.prototype,"_configuration",null),s([a()],d.prototype,"_updateRequested",void 0),d=s([x("esri.views.3d.layers.support.FeatureVisibilityFilter")],d);let o=class extends H{constructor(e){super(e),this.type="graphics-3d",this._randomRotationRenderers=null,this._updatingHandles=new V,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=L.Features,this.preferredUpdatePolicy=k.ASYNC,this._suspendResumeExtent=null}initialize(){const e=this.owner,t=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&e.layer.geometryType!=="multipatch",r=new B({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.hasZ,hasM:e.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:i=>e.view.deconflictor.addGraphicsOwner(i),labeler:(i,n)=>e.view.labeler.addGraphicsOwner(i,n),elevationAlignment:this.elevationAlignmentEnabled?(i,n)=>new Y({graphicsCoreOwner:this,graphicsCore:i,queryGraphicUIDsInExtent:n,elevationProvider:e.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(i,n)=>new Z({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:n,graphicsCore:i,basemapTerrain:e.view.basemapTerrain}):null,filterVisibility:t?i=>new d({context:{...i,configuration:e}}):null,objectStates:i=>new K(i)}});this._set("graphicsCore",r),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new X({graphicsCoreOwner:this})),this.elevationAlignment&&this._updatingHandles.add(()=>this.layer.elevationInfo,(i,n)=>{R(i,n)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())}),this._updatingHandles.add(()=>this.layer.labelsVisible,()=>this.graphicsCore.updateVisibilityInfo()),this._updatingHandles.add(()=>this.layer.labelingInfo,(i,n)=>{R(i,n)&&this.graphicsCore.updateLabelingInfo()}),this._updatingHandles.add(()=>this.preferredUpdatePolicy,i=>this.graphicsCore.preferredUpdatePolicy=i),this.addResolvingPromise(this._initializeAsync())}async _initializeAsync(){await S(this.graphicsCore.initializePromise);const e=this.owner;this._updatingHandles.add(()=>this.renderer,t=>this._updatingHandles.addPromise(this.graphicsCore.rendererChange(t))),this._updatingHandles.add(()=>e.fullOpacity,()=>this.graphicsCore.opacityChange()),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this._updatingHandles.add(()=>e.view.clippingArea,()=>this._updateClippingExtent()),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await S(this.graphicsCore.updateLabelingInfo())}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",E(this.frustumVisibility)),this._set("graphicsCore",E(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get dataUpdating(){var e;return((e=this.graphicsCore)==null?void 0:e.dataUpdating)??!1}get renderer(){const{renderer:e,objectIdField:t}=this.layer;if(!e||!t||e.type==="heatmap"||!e.visualVariables)return e;const r=e.visualVariables.findIndex(n=>n.type==="rotation"&&n.valueExpression!=null&&U(n.valueExpression)===t&&(n.axis==null||n.axis==="heading")&&n.rotationType==="geographic");if(r<0)return e;const i=e.clone();return i.visualVariables?(i.visualVariables.splice(r,1),this._randomRotationRenderers||(this._randomRotationRenderers=new WeakMap),this._randomRotationRenderers.set(i,t),i):e}get scaleVisibility(){var e;return(e=this.graphicsCore)==null?void 0:e.scaleVisibility}get filterVisibility(){var e;return(e=this.graphicsCore)==null?void 0:e.filterVisibility}get elevationAlignment(){var e;return(e=this.graphicsCore)==null?void 0:e.elevationAlignment}get suspendResumeExtentMode(){return this.owner.suspendResumeExtentMode??"computed"}get scaleVisibilitySuspended(){return this.scaleVisibility!=null&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return this.frustumVisibility==null||!this.frustumVisibility.suspended}get suspendInfo(){const e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),this.frustumVisibility!=null&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){var e,t;return!!((e=this.graphicsCore)!=null&&e.updating||(t=this.frustumVisibility)!=null&&t.updating||this._updatingHandles.updating)}get updatingRemaining(){var e;return((e=this.graphicsCore)==null?void 0:e.updatingRemaining)??0}get featureStore(){var e;return(e=this.graphicsCore)==null?void 0:e.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){var e;return(e=this.owner)==null?void 0:e.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){var e;return(e=this.graphicsCore)==null?void 0:e.graphics3DGraphics}get graphics3DGraphicsByObjectID(){var e;return(e=this.graphicsCore)==null?void 0:e.graphics3DGraphicsByObjectID}get symbolUpdateType(){var e;return(e=this.graphicsCore)==null?void 0:e.symbolUpdateType}get displayFeatureLimit(){var i;const e=this.view.quality,t=(i=this.graphicsCore)==null?void 0:i.displayFeatureLimit;if(e===1)return t;const r=Math.ceil(t.maximumNumberOfFeatures*e);return new W(t.maximumTotalNumberOfVertices,r,t.averageSymbolComplexity)}get usedMemory(){var e;return((e=this.graphicsCore)==null?void 0:e.usedMemory)??0}get loadedFeatures(){var e;return((e=this.graphicsCore)==null?void 0:e.numberOfGraphics)??0}get usedMemoryPerFeature(){var e;return((e=this.graphicsCore)==null?void 0:e.usedMemoryPerGraphic)??0}get unprocessedMemoryEstimate(){var e;return((e=this.graphicsCore)==null?void 0:e.unprocessedMemoryEstimate)??0}get performanceInfo(){return this.graphicsCore.performanceInfo}maskOccludee(e){var n;const t=(n=this.graphicsCore)==null?void 0:n.objectStates;if(!t)return q();const{set:r,handle:i}=t.acquireOccludeeSet(null);return t.setUid(r,e.uid),i}highlight(e,t=null,r){var l;const i=(l=this.graphicsCore)==null?void 0:l.objectStates;if(!i)return _;if(r??(r=pe),e instanceof I){const{set:u,handle:p}=i.acquireHighlightSet(r,t);return this.owner.queryObjectIds(e).then(c=>i.setObjectIds(u,c)),p}let n=le(e);if(n.length===0)return _;if(n[0]instanceof Q){const u=n;if(O(this.layer.fieldsIndex,u[0].attributes,t)==null){const p=u.map(g=>g.uid),{set:c,handle:f}=i.acquireHighlightSet(r,null);return i.setUids(c,p),f}n=u.map(p=>O(this.layer.fieldsIndex,p.attributes,t))}if(ue(n[0])){const u=n,{set:p,handle:c}=i.acquireHighlightSet(r,t);return i.setObjectIds(p,u),c}return _}resetObjectStates(){var e,t;(t=(e=this.graphicsCore)==null?void 0:e.objectStates)==null||t.reset()}whenGraphicBounds(e,t){var r;return(r=this.graphicsCore)==null?void 0:r.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){var r;return(r=this.graphicsCore)==null?void 0:r.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}getRenderingInfo(e,t,r){var n;const i=j(e,{renderer:t,arcade:r});if(i!=null&&i.color){const l=i.color;l[0]=l[0]/255,l[1]=l[1]/255,l[2]=l[2]/255}if(i!=null&&t!=null&&((n=this._randomRotationRenderers)!=null&&n.has(t))){const l=this._randomRotationRenderers.get(t),u=e.attributes[l],p=new $(0);p.updateFloatArray([u]),p.updateUint8Array([173]),i.heading=8381e-11*p.digest()}return i}getRenderingInfoAsync(e,t,r,i){return D(e,{renderer:t,arcade:r,...i})}getSymbolLayerSize(e,t){var r;return(r=this.graphicsCore)==null?void 0:r.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){var r;(r=this.graphicsCore)==null||r.setObjectIdVisibility(e,t)}refreshFilter(){this.filterVisibility!=null&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(e){var t;return(t=this.graphicsCore)==null?void 0:t.getGraphics3DGraphicByObjectId(e)}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.addHandles(m(()=>this.suspendResumeExtentMode,()=>{switch(this.removeHandles(b),this.suspendResumeExtentMode){case"computed":this.addHandles([m(()=>this.graphicsCore.computedExtent,e=>this._updateSuspendResumeExtent(e),y),m(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent))],b);break;case"data":this.addHandles([N(()=>this.dataExtent,e=>this._updateSuspendResumeExtent(e),y),m(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.dataExtent))],b);break;default:T(this.suspendResumeExtentMode)}},y))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){const r=this.owner.view.spatialReference;if(!e.spatialReference.equals(r)){if(!M(e,r))return;e=J(e,r)}return ee(e,t,z,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){this.frustumVisibility!=null&&this.frustumVisibility.setExtent(e),this.scaleVisibility!=null&&this.scaleVisibility.setExtent(e)}};s([a()],o.prototype,"type",void 0),s([a({constructOnly:!0})],o.prototype,"owner",void 0),s([a()],o.prototype,"layer",null),s([a({readOnly:!0})],o.prototype,"dataUpdating",null),s([a()],o.prototype,"renderer",null),s([a({constructOnly:!0})],o.prototype,"updateClippingExtent",void 0),s([a({constructOnly:!0})],o.prototype,"elevationFeatureExpressionEnabled",void 0),s([a({constructOnly:!0})],o.prototype,"graphicsCore",void 0),s([a({constructOnly:!0})],o.prototype,"scaleVisibilityEnabled",void 0),s([a({constructOnly:!0})],o.prototype,"filterVisibilityEnabled",void 0),s([a({constructOnly:!0})],o.prototype,"frustumVisibilityEnabled",void 0),s([a({constructOnly:!0})],o.prototype,"elevationAlignmentEnabled",void 0),s([a({constructOnly:!0})],o.prototype,"timeExtentEnabled",void 0),s([a({constructOnly:!0})],o.prototype,"setUidToIdOnAdd",void 0),s([a()],o.prototype,"scaleVisibility",null),s([a()],o.prototype,"filterVisibility",null),s([a()],o.prototype,"elevationAlignment",null),s([a({constructOnly:!0})],o.prototype,"frustumVisibility",void 0),s([a()],o.prototype,"suspendResumeExtentMode",null),s([a()],o.prototype,"dataExtent",void 0),s([a()],o.prototype,"scaleVisibilitySuspended",null),s([a()],o.prototype,"suspended",null),s([a()],o.prototype,"legendEnabled",null),s([a()],o.prototype,"suspendInfo",null),s([a()],o.prototype,"updating",null),s([a()],o.prototype,"updatingRemaining",null),s([a()],o.prototype,"featureStore",null),s([a()],o.prototype,"view",null),s([a()],o.prototype,"loadedGraphics",null),s([a()],o.prototype,"fullOpacity",null),s([a()],o.prototype,"filter",null),s([a()],o.prototype,"slicePlaneEnabled",null),s([a()],o.prototype,"drapeSourceType",void 0),s([a()],o.prototype,"updatePolicy",null),s([a()],o.prototype,"preferredUpdatePolicy",void 0),s([a({readOnly:!0})],o.prototype,"displayFeatureLimit",null),o=s([x("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],o);const b="suspendResumeExtentMode";export{o as D,d as f,h as l};
