const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./geometryServiceUtils-CW7bdn7_.js","./Accessor-BmwT4B0c.js","./Portal-CmmHxpLg.js","./index-4eY77cms.js","./index-Cx51aysm.css","./cast-CsZslgGN.js","./JSONSupport-DcrLLGjL.js","./Promise-DfET-uns.js","./writer-DKgfqj4X.js","./Extent-g5W9hy0j.js","./Point-Cz2JYYmX.js","./project-CvBujuEW.js","./jsonUtils-CwFG8yN4.js","./Polyline-s-JzsQqo.js","./mathUtils-Cfq9PL9W.js","./utils-YowqfOgk.js","./utils-B-dlKIhi.js"])))=>i.map(i=>d[i]);
import{_ as j}from"./index-4eY77cms.js";import{s as f}from"./Accessor-BmwT4B0c.js";import{m as U}from"./MultiOriginJSONSupport-DbmrbwMa.js";import{w}from"./reactiveUtils-XM7cS2OP.js";import{T as F,I as K,B as H}from"./cast-CsZslgGN.js";import{i as J}from"./originUtils-D69mHv66.js";import{c as z,k as q,g as Q}from"./Point-Cz2JYYmX.js";import{L as W,w as X}from"./layerUtils-B__v9OBu.js";import{C as Y}from"./Portal-CmmHxpLg.js";import Z from"./PortalItem-CTx1kJsR.js";import{o as $}from"./jsonContext-Ctyl6VtL.js";import{a as n,E as y,i as p,s as u}from"./portalItemUtils-ByOtbGao.js";import{m as ee,n as ae}from"./project-CvBujuEW.js";import{d as te,m as oe,b as re}from"./basemapUtils-oMnqy94d.js";import{p as A}from"./resourceUtils-DLwJDPjK.js";import{r as T,t as P}from"./saveUtils-D2cY3Oni.js";import"./JSONSupport-DcrLLGjL.js";import"./Evented-Dw4_VOGn.js";import"./SimpleObservable-CvOkykwM.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./writer-DKgfqj4X.js";import"./Promise-DfET-uns.js";import"./Extent-g5W9hy0j.js";import"./projection-CyCZAIaD.js";import"./vec3f64-BLpZdpfb.js";import"./Polyline-s-JzsQqo.js";import"./mathUtils-Cfq9PL9W.js";import"./projectBuffer-CQnuEMuP.js";import"./geodesicConstants-RQL9oKdk.js";import"./jsonUtils-CwFG8yN4.js";import"./utils-YowqfOgk.js";import"./utils-B-dlKIhi.js";import"./utils-DYurMneM.js";import"./colorUtils-Rxh2V3ai.js";import"./screenUtils-_ZIvrt5o.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-Fi6iAz29.js";import"./common-DQOJ18NT.js";import"./basemapDefinitions-D-Q7PKmu.js";import"./intl-Duiy0OzY.js";import"./uuid-Cl5lrJ4c.js";import"./resourceUtils-B0t9BqfX.js";const ie=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map(a=>a.toLowerCase());async function ba(a,e,t){t??(t={}),ne(a,e),await w(()=>!e.updatingFromView),await e.load(),await E(e),await T(e),await C(a,e);const o=e.portalItem,{json:r,jsonContext:i}=await O(e,o,a.origin);return P(i,{errorName:`${a.name}:save`},t),await D(e,o),await Oe(a,e,o,r,i),await Promise.all([e.updateItemThumbnail(),A(e.resourceReferences,i)]),o}async function O(a,e,t){const o=$(e,t,!0),r=a.write({},o);return await Promise.all(o.resources.pendingOperations),{json:r,jsonContext:o}}async function va(a,e,t,o){o??(o={});const r=se(a,t);await w(()=>!e.updatingFromView),await e.load(),await E(e),await T(e),await C(a,e);const{json:i,jsonContext:s}=await O(e,r,a.origin);P(s,{errorName:`${a.name}:save`},o),await ce(e,r);const l=e.getThumbnailState();return await Se(a,e,r,i,s,o)&&(e.resourceReferences.portalItem=r),e.restoreThumbnailFromState(l),await Promise.all([e.updateItemThumbnail(),A(e.resourceReferences,s)]),r}function ne(a,e){if(!e.portalItem)throw new f(`${a.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");S(a,e.portalItem)}function S(a,e){if(e.type!==a.itemType)throw new f(`${a.name}:portal-item-wrong-type`,`Portal item needs to have type "${a.itemType}"`)}async function C(a,e){var o;if(a.name==="linkchart")return;if(!((o=e.basemap)!=null&&o.baseLayers.length))throw new f(`${a.name}:save`,"Map does not have a valid basemap with a base layer.");let t=null;if(await w(()=>{const r=te(e.initialViewProperties,e.basemap);return t=r.spatialReference,!r.updating}),!z(t,e.initialViewProperties.spatialReference))throw new f(`${a.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:e.initialViewProperties.spatialReference,actual:t})}function se(a,e){let t=Z.from(e);return t.id&&(t=t.clone(),t.id=null),t.type||(t.type=a.itemType),t.portal||(t.portal=Y.getDefault()),S(a,t),t}function E(a){const e=[];return a.basemap&&e.push(a.basemap.load()),a.ground&&e.push(a.ground.load()),Promise.allSettled(e).then(()=>{})}async function D(a,e){e.extent=await ve(a.portalItem,a.initialViewProperties.viewpoint.targetGeometry),await ue(a,e)}const le=y.JSAPI,V="CollectorDisabled",_="Collector",g="Data Editing",k="OfflineDisabled",b="Offline",L="Workforce Project",M="Workforce Worker",G="Workforce Dispatcher",pe="Offline Map Areas",me="FieldMapsDisabled",v=y.DEVELOPER_BASEMAP,R="UtilityNetwork",I="IPS";async function ce(a,e){n(e,V),n(e,me),n(e,y.METADATA),n(e,k),n(e,pe),n(e,G),n(e,L),n(e,M),await D(a,e)}async function ue(a,e){p(e,le),await fe(a),we(a,e),ye(a,e),he(a,e),_e(a,e),ge(a,e),be(a,e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((t,o,r)=>r.indexOf(t)===o))}function fe(a){const e=h(a).map(t=>t.load()).toArray();return Promise.allSettled(e).then(()=>{})}function h(a){return a.allLayers.concat(a.allTables)}function N(a){return h(a).some(e=>e.loaded&&W(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&(e.type!=="subtype-group"||e.sublayers.some(t=>t.editingEnabled)))}function de(a){return h(a).filter(e=>e.type!=="group").every(e=>e.loaded&&We(a,e))}function we(a,e){u(e,V)||u(e,L)||u(e,M)||u(e,G)||!N(a)?n(e,_):p(e,_)}function ye(a,e){N(a)?p(e,g):n(e,g)}function he(a,e){!u(e,k)&&de(a)?p(e,b):n(e,b)}function _e(a,e){oe(a.basemap)?p(e,v):n(e,v)}function ge(a,e){var t;(t=a.utilityNetworks)!=null&&t.length?p(e,R):n(e,R)}function be(a,e){a.ipsInfo?p(e,I):n(e,I)}async function ve(a,e){const t=e.clone().normalize();let o;if(t.length>1)for(const r of t)o?r.width>o.width&&(o=r):o=r;else o=t[0];return Re(a,o)}async function Re(a,e){const t=e.spatialReference;if(t.isWGS84)return e.clone();if(t.isWebMercator)return q(e);const{getGeometryServiceURL:o}=await j(()=>import("./geometryServiceUtils-CW7bdn7_.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]),import.meta.url),r=await o(a),i=new ee({geometries:[e],outSpatialReference:Q.WGS84});return(await ae(r,i))[0]}function Ie(a){return X(a)||a.type==="map-notes"||a.type==="route"}function We(a,e){return W(e)&&e.capabilities.operations.supportsSync||Ie(e)&&!e.portalItem||Ae(e)&&!Te(e)&&e.spatialReference.equals(a.initialViewProperties.spatialReference)}function Ae(a){return(a.type==="tile"||a.type==="vector-tile")&&(a.capabilities.operations.supportsExportTiles||Pe(a)||re(a))}function Te(a){return a.type==="vector-tile"&&Object.keys(a.sourceNameToSource).length>1}function Pe(a){return a.type==="tile"&&H(a.url)&&ie.some(e=>{var t;return(t=a.url)==null?void 0:t.toLowerCase().includes("/"+e+"/")})}async function Oe(a,e,t,o,r){await t.update({data:o}),x(a,e,t,o,r)}async function Se(a,e,t,o,r,i){const s=e.portalItem,l={item:s,authenticated:!(!(s!=null&&s.id)||!s.portal.user)},m=t.portal;await m.signIn();const{copyAllowed:c,itemReloaded:d}=await Ce(l,m);if(l.authenticated||(l.authenticated=d),!c)throw new f(`${a.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const B=await Ee(t,l,o,i);return e.portalItem=t,x(a,e,t,o,r),B}async function Ce(a,e){var r;const{item:t,authenticated:o}=a;return t!=null&&t.id&&((r=t.typeKeywords)!=null&&r.includes("useOnly"))?t.portal.portalHostname!==e.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(o||await t.reload(),{copyAllowed:t.itemControl==="admin"||t.itemControl==="update",itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function Ee(a,e,t,o){const r=a.portal,{item:i}=e,{folder:s,copyAllResources:l}=o;let m=!1;if(l&&(i!=null&&i.id)&&F(i.portal.url,r.url)&&parseInt(i.portal.currentVersion,10)>=2023){const{total:c}=await i.fetchResources();m=!!c}if(m){const c=await i.copy({copyResources:"all",folder:s});a.id=c.id,a.portal=c.portal;const d=a.toJSON();await a.load(),a.read(d),await a.update({data:t})}else await r.user.addItem({item:a,folder:s,data:t});return m}function x(a,e,t,o,r){U.prototype.read.call(e,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{origin:a.origin,ignoreDefaults:!0,url:t.itemUrl?K(t.itemUrl):void 0}),J(r),e.resourceInfo=o}export{O as createJSON,Ee as initializeNewItem,Ce as isCopyAllowed,ba as save,va as saveAs};
