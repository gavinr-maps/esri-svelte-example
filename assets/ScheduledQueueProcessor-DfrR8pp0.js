import{l,a4 as d,a5 as g,a3 as m,a6 as u,f,S as q}from"./Accessor-BHnuXKD2.js";import{s as v}from"./Queue-BOnccek2.js";import{s as n}from"./ReactiveMap-Dwhwbx9R.js";import{r as I}from"./signal-DSa0yokC.js";class x{constructor(s,e){this.item=s,this.controller=e,this.promise=null}}class b{constructor(s){this._schedule=null,this._task=null,this._deferreds=new n,this._controllers=new n,this._processingItems=new n,this._pausedSignal=I(!1),this.concurrency=1,s.concurrency&&(this.concurrency=s.concurrency),this._queue=new v(s.peeker),this.process=s.process;const e=s.scheduler;s.priority&&e&&(this._task=e.registerTask(s.priority,this))}destroy(){this.clear(),this._schedule=l(this._schedule),this._task=l(this._task)}get updating(){var s;return!!((s=this._task)!=null&&s.updating)||this.running}get length(){return this._processingItems.size+this._queue.length}abort(s){const e=this._controllers.get(s);e&&e.abort()}clear(){this._queue.clear();const s=[];this._controllers.forEach(e=>s.push(e)),this._controllers.clear(),s.forEach(e=>e.abort()),this._processingItems.clear(),this._cancelNext()}forEach(s){this._deferreds.forEach((e,i)=>s(i))}get(s){const e=this._deferreds.get(s);return e?e.promise:void 0}isOngoing(s){return this._processingItems.has(s)}has(s){return this._deferreds.has(s)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(s,e){const i=this.get(s);if(i)return i;const t=new AbortController;let r=null;e&&(r=d(e,()=>t.abort()));const a=()=>{const c=this._processingItems.get(s);c&&c.controller.abort(),o(),h.reject(u())},o=()=>{p.remove(),r!=null&&r.remove(),this._removeItem(s),this._queue.remove(s),this._scheduleNext()},p=g(t.signal,a),h=m();return this._deferreds.set(s,h),this._controllers.set(s,t),h.promise.then(o,o),this._queue.push(s),this._scheduleNext(),h.promise}last(){return this._queue.last()}lastPromise(){const s=this.last();return s?this.get(s):null}peek(){return this._queue.peek()}popLast(){var e;const s=this._queue.popLast();return s&&((e=this._deferreds.get(s))==null||e.reject(u()),this._removeItem(s)),s}reset(){const s=Array.from(this._processingItems.values());this._processingItems.clear();for(const e of s)this._queue.push(e.item),e.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const s=[];for(;this._queue.length;)s.push(this._queue.pop());return this.clear(),s}get running(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(s){for(;!s.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),s.madeProgress()}_removeItem(s){this._deferreds.delete(s),this._controllers.delete(s),this._processingItems.delete(s)}_scheduleNext(){this._task||this._pausedSignal.value||this._schedule||(this._schedule=f(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(s,e){this._canProcessFulfillment(s)&&(this._scheduleNext(),this._deferreds.get(s.item).resolve(e))}_processError(s,e){this._canProcessFulfillment(s)&&(this._scheduleNext(),this._deferreds.get(s.item).reject(e))}_canProcessFulfillment(s){return!!this._deferreds.get(s.item)&&this._processingItems.get(s.item)===s}_process(s){if(s==null)return;let e;const i=new AbortController,t=new x(s,i);this._processingItems.set(s,t);try{e=this.process(s,i.signal)}catch(r){this._processError(t,r)}q(e)?(t.promise=e,e.then(r=>this._processResult(t,r),r=>this._processError(t,r))):this._processResult(t,e)}get test(){}}export{b as _};
