import{m as j}from"./Viewpoint-C4FqWA2d.js";import{V as it}from"./Collection-CEdjem1-.js";import{s as ct}from"./mathUtils-C4_ghTv4.js";import{c as B,z as st,j as L,n as P,s as W,d as ut,g as ft}from"./Point-Cg0-ChZE.js";import{u as lt}from"./common-DQOJ18NT.js";import{f as mt,s as J,c as K,i as M,M as yt,h as pt,u as gt}from"./mat2d-D9DBP-jx.js";import{e as k}from"./mat2df64-CBKYtunK.js";import{x as xt,l as $,o as m,e as V,v as q,y as ht,j as bt,q as C,B as O,S as v,r as wt,u as dt}from"./vec2-maR1OrZI.js";import{r as Gt,n as l}from"./vec2f64-miziP1SN.js";import{w as Q}from"./Extent-Bf3YTe7m.js";import{_ as T,J as _,W as D,K as E}from"./projection-B971H0Re.js";import{P as H,v as Rt}from"./normalizeUtils-EVmAQ-ak.js";const X=96,Y=39.37,At=180/Math.PI;function Z(t){return t.wkid?t:t.spatialReference||ft.WGS84}function z(t,e){return e.type?m(t,e.x,e.y):wt(t,e)}function U(t){return st(t)}function tt(t,e,n=0){let r=t.width,o=t.height;if(n!==0){const u=ct(n),s=Math.abs(Math.cos(u)),c=Math.abs(Math.sin(u));r=t.width*s+t.height*c,o=t.width*c+t.height*s}const a=Math.max(1,e[0]),i=Math.max(1,e[1]);return Math.max(r/a,o/i)*vt(t.spatialReference)}async function A(t,e,n,r){var u,s;let o,a;if(!t||Array.isArray(t)&&!t.length)return null;if(it.isCollection(t)&&(t=t.toArray()),Array.isArray(t)&&t.length&&typeof t[0]=="object"){const c=t.every(f=>"attributes"in f),p=t.some(f=>!f.geometry);let y=t;if(c&&p&&e&&e.allLayerViews){const f=new Map;for(const g of t){const b=g.layer,R=f.get(b)||[],d=g.attributes[b.objectIdField];d!=null&&R.push(d),f.set(b,R)}const x=[];f.forEach((g,b)=>{const R=e.allLayerViews.find(d=>d.layer.id===b.id);if(R&&"queryFeatures"in R){const d=b.createQuery();d.objectIds=g,d.returnGeometry=!0,x.push(R.queryFeatures(d))}});const h=await Promise.all(x),w=[];for(const g of h)if(g&&g.features&&g.features.length)for(const b of g.features)b.geometry!=null&&w.push(b.geometry);y=w}for(const f of y)r=await A(f,e,n,r);return r}if(Array.isArray(t)&&t.length===2&&typeof t[0]=="number"&&typeof t[1]=="number")o=new L(t);else if(t instanceof P)o=t;else if("geometry"in t){if(t.geometry)o=t.geometry;else if(t.layer){const c=t.layer,p=e.allLayerViews.find(y=>y.layer.id===c.id);if(p&&"queryFeatures"in p){const y=c.createQuery();y.objectIds=[t.attributes[c.objectIdField]],y.returnGeometry=!0;const f=await p.queryFeatures(y);o=(s=(u=f==null?void 0:f.features)==null?void 0:u[0])==null?void 0:s.geometry}}}if(o==null)return null;switch(o.type){case"point":a=new Q({xmin:o.x,ymin:o.y,xmax:o.x,ymax:o.y,spatialReference:o.spatialReference});break;case"extent":case"multipoint":case"polygon":case"polyline":a=Rt(o);break;default:a=o.extent}if(!a)return null;T()||_(a.spatialReference,n)||await D();const i=E(a,n);if(!i)return null;if(r){const c=i.center,p=c.clone();p.x=H(c.x,r.center.x,n),p.x!==c.x&&i.centerAt(p),r=r.union(i)}else r=i;return r}function St(t){var e;if(t&&(!Array.isArray(t)||typeof t[0]!="number")&&(typeof t=="object"||Array.isArray(t)&&typeof t[0]=="object")){if("layer"in t&&((e=t.layer)==null?void 0:e.minScale)!=null&&t.layer.maxScale!=null){const n=t.layer;return{min:n.minScale,max:n.maxScale}}if(Array.isArray(t)&&t.length&&t.every(n=>"layer"in n)){let n=0,r=0;for(const o of t){const a=o.layer;a!=null&&a.minScale&&a.maxScale&&(n=a.minScale<n?a.minScale:n,r=a.maxScale>r?a.maxScale:r)}return n&&r?{min:n,max:r}:null}}}function I(t,e){const n=Z(t);return W(n,e)||n.imageCoordinateSystem||e.imageCoordinateSystem?t:E(t,e)}async function Dt(t,e){var g;if(!t||!e)return new j({targetGeometry:new L,scale:0,rotation:0});let n=e.spatialReference;const{constraints:r,padding:o,viewpoint:a,size:i}=e,u=[o?i[0]-o.left-o.right:i[0],o?i[1]-o.top-o.bottom:i[1]];let s=null;t instanceof j?s=t:t.viewpoint?s=t.viewpoint:t.target&&t.target.declaredClass==="esri.Viewpoint"&&(s=t.target);let c=null;s!=null&&s.targetGeometry?c=s.targetGeometry:t instanceof Q?c=t:t instanceof P?c=await A(t,e,n):t&&(c=await A(t.center,e,n)||await A(t.target,e,n)||await A(t,e,n)),!c&&(a!=null&&a.targetGeometry)?c=a.targetGeometry:!c&&e.extent&&(c=e.extent),n||(n=Z(e.spatialReference||e.extent||c)),T()||W(c.spatialReference,n)||_(c.spatialReference,n)||await D();const p=I(c,n),y="center"in p?p.center:p;e.pickClosestTarget!==!1&&y.type==="point"&&((g=a.targetGeometry)==null?void 0:g.type)==="point"&&(y.x=H(y.x,a.targetGeometry.x,y.spatialReference));let f=0;s?f=s.rotation:t.hasOwnProperty("rotation")?f=t.rotation:a&&(f=a.rotation);let x=0;x=(s==null?void 0:s.targetGeometry)!=null&&s.targetGeometry.type==="point"?s.scale:"scale"in t&&t.scale?t.scale:"zoom"in t&&t.zoom!==-1&&r&&r.effectiveLODs?r.zoomToScale(t.zoom):Array.isArray(c)||c.type==="point"||c.type==="extent"&&c.width===0&&c.height===0?a.scale:tt(I(c.extent,n),u,f);const h=St(t.target??t);h&&(h.min&&h.min<x?x=h.min:h.max&&h.max>x&&(x=h.max));let w=new j({targetGeometry:y,scale:x,rotation:f});return r&&(w=r.fit(w),r.constrainByGeometry(w),r.rotationEnabled||(w.rotation=a.rotation)),w}function G(t,e){const n=t.targetGeometry,r=e.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}function kt(t,e,n){return n?m(t,.5*(e[0]-n.right+n.left),.5*(e[1]-n.bottom+n.top)):$(t,e,.5)}const Et=function(){const t=l();return function(e,n,r){const o=n.targetGeometry;z(t,o);const a=.5*S(n);return e.xmin=t[0]-a*r[0],e.ymin=t[1]-a*r[1],e.xmax=t[0]+a*r[0],e.ymax=t[1]+a*r[1],e.spatialReference=o.spatialReference,e}}();function Ht(t,e,n,r,o){var a;return Nt(t,e,n.center),t.scale=tt(n,r),(a=o==null?void 0:o.constraints)==null||a.constrain(t),t}function $t(t,e,n,r){return rt(t,e,n,r),gt(t,t)}const et=function(){const t=l();return function(e,n,r){return O(e,zt(e,n),kt(t,n,r))}}(),jt=function(){const t=k(),e=l();return function(n,r,o,a){const i=S(r),u=F(r);return m(e,i,i),pt(t,e),J(t,t,u),M(t,t,et(e,o,a)),M(t,t,[0,a.top-a.bottom]),m(n,t[4],t[5])}}();function S(t){var e;return t.scale*Mt((e=t.targetGeometry)==null?void 0:e.spatialReference)}function Mt(t){return t!=null&&B(t)?1/(U(t)*Y*X):1}function F(t){return lt(t.rotation)||0}function vt(t){return B(t)?U(t)*Y*X:1}function zt(t,e){return $(t,e,.5)}const nt=function(){const t=l(),e=l(),n=l();return function(r,o,a,i,u,s){return xt(t,o),$(e,a,.5*s),m(n,1/i*s,-1/i*s),mt(r,e),u&&J(r,r,u),K(r,r,n),M(r,r,t),r}}(),rt=function(){const t=l();return function(e,n,r,o){const a=S(n),i=F(n);return z(t,n.targetGeometry),nt(e,t,r,a,i,o)}}(),Xt=function(){const t=l();return function(e,n,r,o){const a=S(n);return z(t,n.targetGeometry),nt(e,t,r,a,0,o)}}();function Ft(t){const e=ut(t);return e?e.valid[1]-e.valid[0]:0}function Yt(t,e){return Math.round(Ft(t)/e)}const Zt=function(){const t=l(),e=l(),n=[0,0,0];return function(r,o,a){V(t,r,o),q(t,t),V(e,r,a),q(e,e),ht(n,t,e);let i=Math.acos(bt(t,e)/(C(t)*C(e)))*At;return n[2]<0&&(i=-i),isNaN(i)&&(i=0),i}}(),Ut=function(){const t=l();return function(e,n,r,o){const a=e.targetGeometry;return G(e,n),jt(t,n,r,o),a.x+=t[0],a.y+=t[1],e}}(),Nt=function(t,e,n){G(t,e);const r=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,t},te=function(){const t=l();return function(e,n,r,o,a){a||(a="center"),O(t,r,o),$(t,t,.5);const i=t[0],u=t[1];switch(a){case"center":m(t,0,0);break;case"left":m(t,-i,0);break;case"top":m(t,0,u);break;case"right":m(t,i,0);break;case"bottom":m(t,0,-u);break;case"top-left":m(t,-i,u);break;case"bottom-left":m(t,-i,-u);break;case"top-right":m(t,i,u);break;case"bottom-right":m(t,i,-u)}return N(e,n,t),e}}();function ee(t,e,n){return G(t,e),t.rotation+=n,t}function ne(t,e,n){return G(t,e),t.rotation=n,t}const Vt=function(){const t=l();return function(e,n,r,o,a){return G(e,n),isNaN(r)||r===0||(at(t,o,n,a),e.scale=n.scale*r,ot(t,t,e,a),N(e,e,m(t,t[0]-o[0],o[1]-t[1]))),e}}();function re(t,e,n){return G(t,e),t.scale=n,t}const qt=function(){const t=l();return function(e,n,r,o,a,i){return G(e,n),isNaN(r)||r===0||(at(t,a,n,i),e.scale=n.scale*r,e.rotation+=o,ot(t,t,e,i),N(e,e,m(t,t[0]-a[0],a[1]-t[1]))),e}}(),ae=function(){const t=l(),e=l();return function(n,r,o,a,i,u,s){return et(e,u,s),dt(t,i,e),a?qt(n,r,o,a,t,u):Vt(n,r,o,t,u)}}(),at=function(){const t=k();return function(e,n,r,o){return v(e,n,$t(t,r,o,1))}}(),ot=function(){const t=k();return function(e,n,r,o){return v(e,n,rt(t,r,o,1))}}(),N=function(){const t=l(),e=k();return function(n,r,o){G(n,r);const a=S(r),i=n.targetGeometry;return yt(e,F(r)),K(e,e,Gt(a,a)),v(t,o,e),i.x+=t[0],i.y+=t[1],n}}();export{kt as $,qt as G,tt as H,ae as R,Dt as Y,G as Z,Et as _,Mt as a,ee as b,vt as c,Xt as f,Ut as g,te as h,re as j,N as k,rt as l,Ft as m,S as o,Zt as p,et as r,Ht as t,nt as u,ne as w,Nt as x,Yt as y};
