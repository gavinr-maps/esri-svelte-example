import{n as I}from"./mat4-ybYUU6jq.js";import{e as J,o as j}from"./mat4f64-Dk4dwAN8.js";import{t as P,A as S,n as m,c as C,O as w,g as x,s as X,r as T,z,y as H}from"./mathUtils-ClvKsMak.js";import{z as k}from"./vec42-B1mBkh1w.js";import{n as W}from"./vec4f64-CBQL1T0x.js";import{m as u,k as q,b as R}from"./sphere-7666U3LO.js";import{l as M}from"./ViewingMode-Dodu7ZZk.js";import{u as Y}from"./boundedPlane-CZE_hxQR.js";import{v as F,d as B}from"./verticalOffsetUtils-DaB1QvwW.js";var l,O;(function(r){r[r.OBJECT=0]="OBJECT",r[r.HUD=1]="HUD",r[r.TERRAIN=2]="TERRAIN",r[r.OVERLAY=3]="OVERLAY",r[r.I3S=4]="I3S",r[r.PCL=5]="PCL",r[r.LOD=6]="LOD",r[r.VOXEL=7]="VOXEL",r[r.TILES3D=8]="TILES3D"})(l||(l={}));let Q=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=O.ALL,this.normalRequired=!0}};(function(r){r[r.MIN=0]="MIN",r[r.MINMAX=1]="MINMAX",r[r.ALL=2]="ALL"})(O||(O={}));let K=class{constructor(t,s,e){this.object=t,this.geometryId=s,this.triangleNr=e}},Z=class extends K{constructor(t,s,e,a){super(t,s,e),this.center=a!=null?P(a):null}};class tt{constructor(t){this.layerUid=t}}let gt=class extends tt{constructor(t,s){super(t),this.graphicUid=s}};function b(r){return(r==null?void 0:r.dist)!=null}function Lt(r){return(t,s,e)=>(S(N,t,s,e),!Y(r,N))}function _t(r){return b(r)&&r.intersector===l.OBJECT&&!!r.target}function Et(r){return b(r)&&r.intersector===l.HUD&&!!r.target&&"center"in r.target&&r.target.center!=null}const N=m(),D=1e-5;class rt{constructor(t){this.options=new Q,this._results=new st,this.transform=new F,this.tolerance=D,this.verticalOffset=null,this._ray=u(),this._rayEnd=m(),this._rayBeginTransformed=m(),this._rayEndTransformed=m(),this.viewingMode=t??M.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,s,e){this.resetWithRay(q(t,s,this._ray),e)}resetWithRay(t,s){this.camera=s,t!==this._ray&&R(t,this._ray),this.options.verticalOffset!==0?this.viewingMode===M.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,C(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(t=null,s,e,a,o){var c;this.point=s,this.filterPredicate=a,this.tolerance=e??D;const f=B(this.verticalOffset);if(t&&t.length>0){const y=o?i=>{o(i)&&this.intersectObject(i)}:i=>{this.intersectObject(i)};for(const i of t){const d=(c=i.getSpatialQueryAccelerator)==null?void 0:c.call(i);d!=null?(f!=null?d.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,y,f):d.forEachAlongRay(this._ray.origin,this._ray.direction,y),this.options.selectionMode&&this.options.hud&&d.forEachDegenerateObject(y)):i.objects.forAll(L=>y(L))}}this.sortResults()}intersectObject(t){const s=t.geometries;if(!s)return;const e=t.effectiveTransformation,a=B(this.verticalOffset);for(const o of s){if(!o.visible)continue;const{material:f,id:c}=o;this.transform.setAndInvalidateLazyTransforms(e,o.transformation),w(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),w(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const y=this.transform.transform;a!=null&&(a.objectTransform=this.transform),f.intersect(o,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(i,d,L,v,_,G)=>{if(i>=0){if(this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,i))return;const n=v?this._results.hud:this._results,E=v?h=>{const V=new Z(t,c,L,G);h.set(l.HUD,V,i,d,j,_)}:h=>h.set(l.OBJECT,{object:t,geometryId:c,triangleNr:L},i,d,y,_);if((n.min.drapedLayerOrder==null||_>=n.min.drapedLayerOrder)&&(n.min.dist==null||i<n.min.dist)&&E(n.min),this.options.store!==O.MIN&&(n.max.drapedLayerOrder==null||_<n.max.drapedLayerOrder)&&(n.max.dist==null||i>n.max.dist)&&E(n.max),this.options.store===O.ALL)if(v){const h=new $(this._ray);E(h),this._results.hud.all.push(h)}else{const h=new p(this._ray);E(h),this._results.all.push(h)}}})}}sortResults(t=this._results.all){t.sort((s,e)=>s.dist!==e.dist?(s.dist??0)-(e.dist??0):s.drapedLayerOrder!==e.drapedLayerOrder?U(s.drapedLayerOrder,e.drapedLayerOrder):U(s.drapedLayerGraphicOrder,e.drapedLayerGraphicOrder))}}function U(r,t){return(t??-Number.MAX_VALUE)-(r??-Number.MAX_VALUE)}function Tt(r){return new rt(r)}class st{constructor(){this.min=new p(u()),this.max=new p(u()),this.hud={min:new $(u()),max:new $(u()),all:new Array},this.ground=new p(u()),this.all=[]}init(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0}}class p{get ray(){return this._ray}get distanceInRenderSpace(){return this.dist!=null?(x(A,this.ray.direction,this.dist),X(A)):null}getIntersectionPoint(t){return!!b(this)&&(x(A,this.ray.direction,this.dist),C(t,this.ray.origin,A),!0)}getTransformedNormal(t){return T(g,this.normal),g[3]=0,k(g,g,this.transformation),T(t,g),z(t,t)}constructor(t){this.intersector=l.OBJECT,this.normal=m(),this.transformation=J(),this._ray=u(),this.init(t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=l.OBJECT,R(t,this._ray)}set(t,s,e,a,o,f,c){this.intersector=t,this.dist=e,T(this.normal,a??H),I(this.transformation,o??j),this.target=s,this.drapedLayerOrder=f,this.drapedLayerGraphicOrder=c}copy(t){R(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,T(this.normal,t.normal),I(this.transformation,t.transformation)}}class $ extends p{constructor(){super(...arguments),this.intersector=l.HUD}}function At(r){return new p(r)}const A=m(),g=W();function et(r){return r.type==="point"}class vt{constructor(t,s=null,e=0){this.array=t,this.spatialReference=s,this.offset=e}}function it(r){return"array"in r}function Rt(r,t,s="ground"){if(et(t))return r.getElevation(t.x,t.y,t.z||0,t.spatialReference,s);if(it(t)){let e=t.offset;return r.getElevation(t.array[e++],t.array[e++],t.array[e]||0,t.spatialReference??r.spatialReference,s)}return r.getElevation(t[0],t[1],t[2]||0,r.spatialReference,s)}export{D as E,At as G,Tt as T,b as a,Rt as b,tt as c,Et as d,O as e,it as f,Lt as g,l as i,gt as o,vt as r,_t as s,et as t};
