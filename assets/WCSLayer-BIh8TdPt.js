const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./imageryUtils-DZpgBwaI.js","./utils-rirLb0Sq.js","./Accessor-BHnuXKD2.js","./originUtils-D69mHv66.js","./multiOriginJSONSupportUtils-C0wm8_Yw.js","./Portal-CTRRujjZ.js","./index-tefRSezt.js","./index-Cx51aysm.css","./cast-BA_-jlhc.js","./JSONSupport-CGdeqxpk.js","./Promise-CmQqe-ke.js","./writer-B2bQV2uU.js","./Extent-CBBGeHb-.js","./Point-XGrwlf63.js","./PortalItem-CXk7DqVv.js","./jsonContext-CdRtpU_S.js","./portalItemUtils-rm7sAgcm.js","./projection-B2I9Bzj_.js","./SimpleObservable-7oieNGD8.js","./vec3f64-BLpZdpfb.js","./Polyline-BmuD2-ZN.js","./mathUtils-DV9iOXpW.js","./projectBuffer-DOU0xvVi.js","./geodesicConstants-yASAK_zX.js","./saveUtils-DLMLWtvP.js"])))=>i.map(i=>d[i]);
import{_ as Te}from"./index-tefRSezt.js";import{s as _,E as ye,r as $,m as T,a as be,B as se,k as Le,V as Pe}from"./Accessor-BHnuXKD2.js";import{q as Ae}from"./Graphic-CFXUQZlS.js";import{a as Re}from"./Clonable-DvJsj5LF.js";import{S as Ee}from"./MultiOriginJSONSupport-nGLpCFeg.js";import{d as Oe}from"./reactiveUtils-BR0C1Kq4.js";import{f as Me}from"./Layer-C9uQlTBT.js";import{p as Ve,t as Ne}from"./ScaleRangeLayer-C59zG_yk.js";import{e as ke}from"./CustomParametersMixin-uo3x70vd.js";import{t as b,e as x,n as R,r as S,l as O,i as A,c as we,X as Fe,K as _e}from"./xmlUtilities-DSmZyTVq.js";import{b as Ge}from"./OperationalLayer-Bts9W3HA.js";import{j as je}from"./PortalLayer-jhi5QQgB.js";import{f as Be}from"./RefreshableLayer-Cn2UpWQD.js";import{l as We}from"./TemporalLayer-CYEvmdjr.js";import{d as qe,l as Ue}from"./commonProperties-C0eC30J9.js";import{y as ge}from"./Field-Cyk7Ur5d.js";import{o as He}from"./rasterFieldUtils-tcgglH7k.js";import{w as q}from"./Extent-CBBGeHb-.js";import{o as xe}from"./crsUtils-DAndLU68.js";import{P as ae}from"./cast-BA_-jlhc.js";import{j as ze}from"./Polyline-BmuD2-ZN.js";import{d as pe,P as Ye}from"./RasterSymbolizer-B36eoQa5.js";import{D as Ke,w as le,p as Xe}from"./multidimensionalUtils-SQpvKUH-.js";import{P as Ze}from"./dataUtils-C9PeJKfO.js";import{p as Je}from"./popupUtils-pQ0CVidQ.js";import{A as te}from"./interfaces-CL2NbQte.js";import"./JSONSupport-CGdeqxpk.js";import"./writer-B2bQV2uU.js";import"./opacityUtils-CSd4XoR2.js";import"./Promise-CmQqe-ke.js";import"./Point-XGrwlf63.js";import"./enumeration-Cr5WIZs4.js";import"./Color-gncXBiLc.js";import"./colorUtils-Rxh2V3ai.js";import"./mathUtils-DV9iOXpW.js";import"./ActionToggle-__-l4AdQ.js";import"./Identifiable-BrT7zvUW.js";import"./jsonUtils-Cu7OBRmN.js";import"./typeUtils-BSg8Y507.js";import"./TextSymbol-BQ_NW9Xo.js";import"./screenUtils-_ZIvrt5o.js";import"./collectionUtils-CbaToa73.js";import"./Portal-CTRRujjZ.js";import"./vec3f64-BLpZdpfb.js";import"./aaBoundingBox-CeBivBRq.js";import"./Evented-DCWccWGU.js";import"./SimpleObservable-7oieNGD8.js";import"./TimeExtent-J5qnUFx_.js";import"./timeUtils-D2X862bk.js";import"./layerContainerType-C5CzMsLd.js";import"./jsonUtils-TjZmCq6l.js";import"./utils-DYurMneM.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-Fi6iAz29.js";import"./common-DQOJ18NT.js";import"./ImageHistogramParameters-Cobpl2oj.js";import"./workers-D8Q3pEzK.js";import"./Queue-BOnccek2.js";import"./intl-Do3GEEJ7.js";import"./ClassBreaksRenderer-BBSNkSFx.js";import"./commonProperties-bGHL1a5M.js";import"./colorRamps-Dkx8zIVn.js";import"./SizeVariable-IzD1bP2e.js";import"./visualVariableUtils-Bp9QCb8E.js";import"./lengthUtils-DjJgJFRg.js";import"./ColorStop-CDpeFWOz.js";import"./jsonUtils-Dzgxk9pw.js";import"./layerUtils-dJgsXxkC.js";import"./defaults-Dwxdhopq.js";import"./defaultsJSON-GKolV7NZ.js";import"./RendererLegendOptions-mgfHoilI.js";import"./UniqueValueRenderer-Cri3tgP5.js";import"./diffUtils-CMkuJvD2.js";import"./styleUtils-BB-zx7mT.js";import"./ClassBreaksDefinition-DvZJqFCP.js";import"./normalizeUtils-XRAPXbWa.js";import"./normalizeUtilsCommon-D0zPTJCj.js";import"./utils-Cy8wFNQo.js";import"./utils-CkSELPnj.js";import"./utils-9nq77ifz.js";import"./cimSymbolUtils-azhJhO4Y.js";import"./utils-B91u8350.js";import"./defaultCIMValues-DII_GG3u.js";import"./enums-BJSSbDkD.js";import"./LRUCache-DS2O1kTf.js";import"./MemCache-CDoaVBHf.js";import"./TileInfo-CRfZy5zq.js";import"./TileKey-DZd6gJy7.js";import"./QueueProcessor-BFetastB.js";import"./ReactiveMap-Dwhwbx9R.js";import"./signal-DSa0yokC.js";import"./RawBlockCache-Bn1rWP55.js";import"./rasterProjectionHelper-BYBh__EP.js";import"./projection-B2I9Bzj_.js";import"./projectBuffer-DOU0xvVi.js";import"./geodesicConstants-yASAK_zX.js";import"./pixelRangeUtils-ouDveaCT.js";import"./rasterFunctionHelper-BT4Uat-i.js";import"./colorUtils-BAowQmkN.js";import"./vec42-YcqnINSP.js";import"./vec4f64-o2zAXfmz.js";import"./FeatureSet-DpCN730g.js";import"./PortalItem-CXk7DqVv.js";import"./portalItemUtils-rm7sAgcm.js";import"./TimeInfo-LjqhhubF.js";import"./TimeInterval-BDTTJ9Uw.js";import"./timeZoneUtils-COos5xIr.js";import"./ElevationInfo-Di4W6v5U.js";import"./unitConversionUtils-C4AR5obr.js";import"./AttributeTableTemplate-B7rH2qLr.js";import"./fieldType-L-VlbZqy.js";import"./_commonjsHelpers-DCkdB7M8.js";function J(e){return e.endsWith("?")?e.slice(0,-1):e}function ce(e){return e.filter(({coverageSubType:t})=>t==null||t===""||/^rectified(grid|dataset)/i.test(t))}function Qe(e){var r,p,g;const t=b(e,"Service/name"),n=x(e,"Capability"),o=((r=x(n,"GetCapabilities/Get/OnlineResource"))==null?void 0:r.getAttribute("xlink:href"))??"",i=((p=x(n,"DescribeCoverage/Get/OnlineResource"))==null?void 0:p.getAttribute("xlink:href"))??"",a=((g=x(n,"GetCoverage/Get/OnlineResource"))==null?void 0:g.getAttribute("xlink:href"))??"",s={getCapabilities:J(o),describeCoverage:J(i),getCoverage:J(a)},c=R(e,"CoverageOfferingBrief"),l=[];for(let m=0;m<c.length;m++){const f=c[m],h=b(f,"name"),d=R(f,"pos"),u=S(d[0]),v=S(d[1]),y=new q({xmin:u[0],ymin:u[1],xmax:v[0],ymax:v[1],spatialReference:{wkid:4326}});l.push({id:h,lonLatEnvelope:y})}return{name:t,onlineResources:s,coverages:l,gridCoverages:ce(l),supportedVersions:["1.0.0"],version:"1.0.0"}}function Ce(e){const t={};for(let n=0;n<e.childNodes.length;n++){const o=e.childNodes[n];if(o.nodeType!==1)continue;const i=we(o).toLowerCase();switch(i){case"title":case"abstract":t[i]=b(o);break;case"identifier":t.id=b(o);break;case"wgs84boundingbox":{const a=S(o,"LowerCorner"),s=S(o,"UpperCorner");t.lonLatEnvelope=new q({xmin:a[0],ymin:a[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":t.coverageSummaries=t.coverageSummaries||[],t.coverageSummaries.push(Ce(o))}}return t}function Ie(e,t){if(e.coverageSummaries)for(let n=0;n<e.coverageSummaries.length;n++)e.coverageSummaries[n].abstract=e.coverageSummaries[n].abstract||e.abstract,e.coverageSummaries[n].lonLatEnvelope=e.coverageSummaries[n].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[n].title=e.coverageSummaries[n].title||e.title,Ie(e.coverageSummaries[n],t);e.id!=null&&t.push(e)}function Se(e){var i,a,s;const t=((i=x(e.querySelector("Operation[name=GetCapabilities]"),"Get"))==null?void 0:i.getAttribute("xlink:href"))||"",n=((a=x(e.querySelector("Operation[name=DescribeCoverage]"),"Get"))==null?void 0:a.getAttribute("xlink:href"))||"",o=((s=x(e.querySelector("Operation[name=GetCoverage]"),"Get"))==null?void 0:s.getAttribute("xlink:href"))||"";return{getCapabilities:J(t),describeCoverage:J(n),getCoverage:J(o)}}function et(e){const t=b(e,"ServiceIdentification/Title"),n=O(e,"ServiceIdentification/ServiceTypeVersion"),o=Se(x(e,"OperationsMetadata")),i=[],a=x(e,"Contents");for(let c=0;c<a.childNodes.length;c++){const l=a.childNodes[c];l.nodeType===1&&A(l,"CoverageSummary")&&Ie(Ce(l),i)}const s=O(a,"SupportedFormat");return{name:t,onlineResources:o,coverages:i,gridCoverages:ce(i),supportedVersions:n,supportedFormats:s,version:"1.1.0"}}function tt(e){const t=x(e,"ServiceIdentification"),n=b(t,"Title"),o=O(t,"ServiceTypeVersion"),i=O(t,"Profile"),a=Se(x(e,"OperationsMetadata")),s=R(e,"Contents/CoverageSummary"),c=[];for(let r=0;r<s.length;r++){const p=s[r],g=b(p,"CoverageId"),m=x(p,"WGS84BoundingBox");let f;if(m){const d=S(m,"LowerCorner"),u=S(m,"UpperCorner");f=new q({xmin:d[0],ymin:d[1],xmax:u[0],ymax:u[1],spatialReference:{wkid:4326}})}const h=b(p,"CoverageSubtype")||"RectifiedGridCoverage";c.push({id:g,lonLatEnvelope:f,coverageSubType:h})}const l=x(e,"ServiceMetadata");return{name:n,supportedVersions:o,supportedFormats:O(l,"formatSupported"),supportedInterpolations:O(l,"interpolationSupported").concat(O(l,"InterpolationSupported")),onlineResources:a,profiles:i,coverages:c,gridCoverages:ce(c),version:"2.0.1"}}function nt(e){let t=null;typeof e=="string"?t=new DOMParser().parseFromString(e,"text/xml"):t=e;const n=t.documentElement.getAttribute("version"),o=n==null?void 0:n.slice(0,3);return o!=null&&o<"2.1"}function it(e,t=null){let n=null;typeof e=="string"?n=new DOMParser().parseFromString(e,"text/xml"):n=e;let o=n.documentElement.getAttribute("version");o==="1.0"?o="1.0.0":o==="1.1"&&(o="1.1.0");const i=o||t||"1.0.0",a=i.slice(0,3);let s;if(a==="2.0")s=tt(n);else if(a==="1.1")s=et(n);else{if(a!=="1.0")throw new _("wcsraster:parsecapabilities","the capabilities version is not supported");s=Qe(n)}return s.version=i,s}function ue(e){e.variables.forEach(t=>t.dimensions.forEach(n=>n.values??(n.values=Ke(n))))}function ot(e){return{requestResponseCRSs:O(e,"requestResponseCRSs").map(t=>t.split(":")[1]),nativeCRSs:O(e,"nativeCRSs").map(t=>t.split(":")[1])}}function $e(e,t){const n=O(e,t==="1.0.0"?"interpolationMethod":"InterpolationMethod"),o=t==="1.0.0"?e.getAttribute("default"):b(e,"InterpolationMethods/Default");return o!=null?[o].concat(n.filter(i=>i.toLowerCase()!==o.toLowerCase())):n}function me(e){return e==null?["nearest"]:e.map(t=>{const n=t.toLowerCase();return n.includes("nearest")?"nearest":n.includes("linear")?"bilinear":n.includes("cubic")?"cubic":null}).filter(t=>!!t)}function st(e){const t=R(e,"pos"),n=S(t[0]),o=S(t[1]);return new q({xmin:n[0],ymin:n[1],xmax:o[0],ymax:o[1],spatialReference:{wkid:4326}})}function de(e,t){const n=O(e,t);return n!=null&&n.length&&n[0]!==""&&!isNaN(Number(n[0]))?n.map(o=>Number(o)):null}function rt(e){const t=S(e,"MinimumValue"),n=S(e,"MaximumValue");return t.length&&n.length?t.map((o,i)=>({min:o,max:n[i],avg:-1,stddev:-1})):null}function fe(e){return e==null?null:e.every(t=>t===e[0])?e[0]:e}function at(e){const t=[],n=R(e,"RangeSet");let o=[];for(let i=0;i<n.length;i++){const a=b(n[i],"name"),s=b(n[i],"label"),c=[],l=de(n[i],"nullValues/singleValue"),r=R(n[i],"AxisDescription");for(let p=0;p<r.length;p++){const g=b(r[p],"name"),m=b(r[p],"label"),f=O(r[p],"singleValue");if(f.length===0){const h=b(r[p],"min"),d=b(r[p],"max"),u=Number(b(r[p],"res"))||1;if(h!==null&&d!==null)for(let v=parseInt(h,10);v<=parseInt(d,10);v+=u)f.push(v.toString())}g.toLowerCase()==="band"&&(o=f),c.push({name:g,label:m,values:f})}t.push({name:a,label:s,nullValues:l,axis:c})}return{rangeSet:t,bandNames:o}}function lt(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const n=["Y","M","D"],o=["H","M","S"],i=["Years","Months","Days","Hours","Minutes","Seconds"];let a,s,c;return t.includes("PT")?(t=t.slice(2),c=o.findIndex(l=>t.includes(l)),a=i[3+c],s=parseFloat(t.slice(0,-1))):(t=t.slice(1),c=n.findIndex(l=>t.includes(l)),c>-1&&(a=i[c]),s=parseFloat(t.slice(0,-1))),{resolution:s,units:a}}function oe(e){const t=R(e,"timeposition");if(t.length>0){const o=[];for(let i=0;i<t.length;i++)o.push(new Date(b(t[i])));return{begin:o[0],end:o[o.length-1],values:o}}const n=x(e,"timePeriod")||x(e,"TimePeriod");return n?{begin:new Date(b(n,"beginPosition")||b(n,"BeginPosition")),end:new Date(b(n,"endPosition")||b(n,"EndPosition")),...lt(b(n,"timeResolution")||b(n,"TimeResolution"))}:null}function pt(e){const t=x(e,"spatialDomain"),n=x(t,"Envelope")||x(t,"EnvelopeWithTimePeriod"),o=n.getAttribute("srsName").split(":"),i=o[o.length-1],a=R(n,"pos"),s=S(a[0]),c=S(a[1]),l=parseInt(i,10),r=isNaN(l)?null:{wkid:l},p=new q({xmin:s[0],ymin:s[1],xmax:c[0],ymax:c[1],spatialReference:r}),g=x(t,"RectifiedGrid"),m=b(g,"low").split(" "),f=b(g,"high").split(" "),h=parseInt(f[0],10)-parseInt(m[0],10)+1,d=parseInt(f[1],10)-parseInt(m[1],10)+1,u=S(t,"origin/pos"),v=R(t,"offsetVector"),y={envelope:p,columns:h,rows:d,offset:{x:parseFloat(b(v[0]).split(" ")[0]),y:parseFloat(b(v[1]).split(" ")[1])},origin:{x:u[0],y:u[1]}},w=x(e,"temporalDomain")||x(e,"TemporalDomain");return{spatialDomain:y,temporalDomain:w?oe(w):null}}function ct(e){const t={version:"1.0"};let n,o=[];for(let h=0;h<e.childNodes.length;h++){const d=e.childNodes[h];if(d.nodeType===1)if(A(d,"description"))t.description=b(d);else if(A(d,"name"))t.name=b(d);else if(A(d,"label"))t.label=b(d);else if(A(d,"supportedFormats"))t.supportedFormats=O(d,"formats");else if(A(d,"supportedCRSs"))t.supportedCRSs=ot(d);else if(A(d,"supportedInterpolations"))t.supportedInterpolations=$e(d,"1.0.0");else if(A(d,"lonLatEnvelope"))t.lonLatEnvelope=st(d);else if(A(d,"rangeSet")){const u=at(d);t.rangeSet=u.rangeSet,o=u.bandNames;const v=u.rangeSet[0].nullValues;v!=null&&v.length&&(n=fe(v))}else A(d,"domainSet")&&(t.domainSet=pt(d))}const i=me(t.supportedInterpolations),{name:a,description:s,label:c,lonLatEnvelope:l,supportedFormats:r}=t,{spatialDomain:p}=t.domainSet,g={x:Math.abs(p.offset.x),y:Math.abs(p.offset.y)},m=ut(t.domainSet),f=new pe({width:p.columns,height:p.rows,pixelSize:g,pixelType:"unknown",extent:p.envelope,spatialReference:p.envelope.spatialReference,bandCount:o.length||1,noDataValue:n,multidimensionalInfo:m});return{id:a,title:t.name,description:s||c,lonLatEnvelope:l,rasterInfo:f,bandNames:o,supportedFormats:r,supportedInterpolations:i,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}function ut(e){if(!e.temporalDomain)return null;const{begin:t,end:n,values:o,units:i,resolution:a}=e.temporalDomain,s={variables:[{name:"default",description:"",dimensions:[{name:"StdTime",description:"",unit:"ISO8601",values:o==null?void 0:o.map(c=>c.getTime()),hasRegularIntervals:!o,interval:a,intervalUnit:i,extent:[t.getTime(),n.getTime()]}]}]};return ue(s),s}function mt(e,t){const n=[],o=R(e,"Field");let i,a=[];for(let s=0;s<o.length;s++){const c=b(o[s],"Identifier"),l=b(o[s],"Description"),r=b(o[s],"Definition"),p=b(o[s],"Abstract"),g=b(o[s],"Title"),m=de(o[s],"NullValue"),f=x(o[s],"AllowedValues"),h=f?rt(f):null,d=$e(o[s],"1.1.0"),u=[],v=R(o[s],"Axis");for(let y=0;y<v.length;y++){const w=v[y].getAttribute("identifier"),L=b(v[y],"UOM"),C=b(v[y],"DataType"),E=O(v[y],"Key");t&&!w.toLowerCase().includes("band")||(a=E,i=m),u.push({identifier:w,uom:L,dataType:C,values:E,bandNoDataValues:i})}n.push({identifier:c,description:l,definition:r,abstract:p,title:g,supportedInterpolations:d,axis:u,nullValues:m,statistics:h})}return{rangeSet:n,bandNames:a,bandNoDataValues:i,statistics:n[0].statistics}}function dt(e,t){if(!t.temporalDomain)return null;const n=e.filter(i=>!i.identifier.toLowerCase().includes("field_1")&&!i.axis.some(a=>a.identifier.includes("band"))),o=[];if(n.length&&n.forEach(i=>{var s;const a=i.axis.map(c=>{const l=c.values.map(p=>c.uom==="ISO8601"?(p=p.trim()).toLowerCase().includes("z")?new Date(p).getTime():new Date(p+"Z").getTime():parseFloat(p.trim())),r=[Math.min.apply(null,l),Math.max.apply(null,l)];return{name:c.identifier.trim(),description:"",field:c.identifier.trim(),unit:c.uom?c.uom.trim():"",hasRegularIntervals:!1,values:l,extent:r}});o.push({name:i.identifier.trim(),description:((s=i.description)==null?void 0:s.trim())??"",unit:"",dimensions:a,statistics:i.statistics})}),t.temporalDomain){const{begin:i,end:a,values:s,units:c,resolution:l}=t.temporalDomain;o.some(r=>r.dimensions.some(p=>p.name.toLowerCase()==="stdtime"))||o.forEach(r=>{r.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:s==null?void 0:s.map(p=>p.getTime()),hasRegularIntervals:!s,interval:l,intervalUnit:c,extent:[i.getTime(),a.getTime()]})})}if(o.length){const i={variables:o};return ue(i),i}return null}function ft(e){var v;const t=x(e,"SpatialDomain"),n=x(t,"GridCRS"),o=b(n,"GridBaseCRS"),i=b(n,"GridOrigin"),a=(i==null?void 0:i.split(" ").map(y=>parseFloat(y)))??[0,0],s=S(n,"GridOffsets"),c=R(t,"BoundingBox");let l,r,p,g;for(let y=0;y<c.length;y++){const w=(v=c[y].getAttribute("crs"))==null?void 0:v.toLowerCase();if(w!=null){if(w.includes("imagecrs")){const L=S(c[y],"LowerCorner"),C=S(c[y],"UpperCorner");l=C[0]-L[0]+1,r=C[1]-L[1]+1}else if(w.indexOf("epsg")>0){const L=w.split(":");p=parseInt(L[L.length-1],10);const C=S(c[y],"LowerCorner"),E=S(c[y],"UpperCorner");g=new q({xmin:C[0],ymin:C[1],xmax:E[0],ymax:E[1],spatialReference:{wkid:p}})}}}const m=l>r,f=g.xmax-g.xmin>g.ymax-g.ymin;let h=!1;xe(p)&&(m===f?h=!1:(h=!0,g=new q({xmin:g.ymin,ymin:g.xmin,xmax:g.ymax,ymax:g.xmax,spatialReference:{wkid:p}})));const d={columns:l,rows:r,origin:{x:a[0],y:a[1]},offset:{x:s[0],y:s[s.length-1]},gridBaseCRS:o,envelope:g,useEPSGAxis:h},u=x(e,"temporalDomain")||x(e,"TemporalDomain");return{spatialDomain:d,temporalDomain:u?oe(u):null}}function gt(e,t){var v;const n=[],o=[],i={supportedFormats:n,supportedCRSs:o,version:"1.1"};let a,s,c=[];for(let y=0;y<e.childNodes.length;y++){const w=e.childNodes[y];if(w.nodeType!==1)continue;const L=we(w).toLowerCase();switch(L){case"title":case"abstract":case"identifier":i[L]=b(w);break;case"supportedformat":{const C=b(w);n.includes(C)||n.push(C)}break;case"supportedcrs":{const C=b(w);o.includes(C)||o.push(C)}break;case"range":{const C=mt(w,!!((v=i.domain)!=null&&v.temporalDomain));i.range=C.rangeSet,c=C.bandNames;const{bandNoDataValues:E}=C;E!=null&&E.length&&(a=fe(E)),s=C.statistics}break;case"domain":i.domain=ft(w)}}const l=me(i.range[0].supportedInterpolations),{identifier:r,abstract:p,title:g,domain:m,range:f}=i,h={x:Math.abs(m.spatialDomain.offset.x),y:Math.abs(m.spatialDomain.offset.y)},d=dt(f,m);d&&(a=f[0].nullValues,(a==null?void 0:a.length)===1&&(a=a[0]));const u=new pe({width:m.spatialDomain.columns,height:m.spatialDomain.rows,pixelSize:h,pixelType:"unknown",extent:m.spatialDomain.envelope,spatialReference:m.spatialDomain.envelope.spatialReference,bandCount:c.length||1,noDataValue:a,statistics:s,multidimensionalInfo:d});return{id:r,title:i.title,description:p||g,bandNames:c,rasterInfo:u,supportedFormats:n,supportedInterpolations:l,coverageDescription:i,version:t,useEPSGAxis:m.spatialDomain.useEPSGAxis}}function ht(e){const t=x(e,"Envelope")||x(e,"EnvelopeWithTimePeriod"),n=t.getAttribute("srsName"),o=n.slice(n.lastIndexOf("/")+1),i=t.getAttribute("axisLabels").split(" ").map(d=>d.trim()).filter(d=>d.trim()!==""),a=S(t,"lowerCorner"),s=S(t,"upperCorner"),c=!["y","lat","latitude","north","nor","n","b"].includes(i[0].toLowerCase());let l;const r=parseInt(o,10),p=isNaN(r)?null:{wkid:r};l=new q(c?{xmin:a[0],ymin:a[1],xmax:s[0],ymax:s[1],spatialReference:p}:{xmin:a[1],ymin:a[0],xmax:s[1],ymax:s[0],spatialReference:p});const g={mins:a,maxs:s},m=t.getAttribute("uomLabels").trim().split(" ");let f,h;if(A(t,"EnvelopeWithTimePeriod")){f=new Date(b(e,"beginPosition")||b(e,"BeginPosition")),h=new Date(b(e,"endPosition")||b(e,"EndPosition"));const d=m==null?void 0:m.findIndex(u=>(u==null?void 0:u.toLowerCase())==="oledatetime");d>-1&&(m[d]="ISO8601")}return{envelope:l,axisLabels:i,uomLabels:m.length?m:null,envelopeAllDims:g,beginPosition:f,endPosition:h,isEastFirst:c}}function vt(e,t){var c,l;const n=[],o=R(e,"DataRecord"),i=[];let a,s=[];for(let r=0;r<o.length;r++){const p=R(o[r],"field"),g=[];for(let m=0;m<p.length;m++){const f=p[m].getAttribute("name"),h=b(p[m],"description")||"",d=((c=x(p[m],"uom"))==null?void 0:c.getAttribute("code"))||"",u=S(p[m],"interval"),v=(l=de(p[m],"nilValue"))==null?void 0:l[0];t&&!f.toLowerCase().includes("band")||(i.push(f),u!=null&&u.length&&(a=a||[],a.push({min:u[0],max:u[1],avg:-1,stddev:-1})),s.push(v)),g.push({name:f,description:h,uom:d,allowedValues:u,nilValue:v})}n.push(g)}return s.some(r=>r!=null)||(s=null),{rangeType:n,bandNames:i,bandStats:a,bandNoDataValues:s}}function yt(e){let t=1,n="";const o=.01;return Math.abs(e-1/24)<1/24*o?n="Hours":Math.abs(e-1)<1*o?n="Days":e<1?(t=Math.round(24*e),n="Hours"):e>28-o&&e<31+o||Math.round(e/30)<12?n="Months":e>365-o&&e<366+o&&(n="Years"),{interval:t,intervalUnit:n}}function bt(e,t,n){var a,s;if(n.axisLabels.length<=2)return null;const o=[];for(let c=0;c<e.length;c++){const l=e[c];for(let r=0;r<l.length;r++)l[r].name.toLowerCase().includes("band")||o.push(l[r])}const i=[];if(o.length){const c=[];for(let l=2;l<n.axisLabels.length;l++){const r=((s=(a=t.uomLabels)==null?void 0:a[l])==null?void 0:s.trim())??"",p=n.axisLabels[l].toLowerCase().includes("time")||r.toLowerCase()==="iso8601"||r.toLowerCase()==="oledatetime";let g,m;if(p){const h=yt(n.offset[l]);g=h.interval,m=h.intervalUnit}else g=n.offset[l],m=r;const f=[];p?(f.push(le(t.envelopeAllDims.mins[l])),f.push(le(t.envelopeAllDims.maxs[l]))):(f.push(t.envelopeAllDims.mins[l]),f.push(t.envelopeAllDims.maxs[l])),c.push({name:n.axisLabels[l].trim(),description:n.axisLabels[l].trim(),unit:p?"ISO8601":r,hasRegularIntervals:!0,extent:f,interval:g,intervalUnit:m})}if(o.forEach(l=>{var g;const{allowedValues:r}=l,p=(r==null?void 0:r.length)===2?[{min:r[0],max:r[1],avg:-1,stddev:-1}]:null;i.push({name:l.name.trim(),description:((g=l.description)==null?void 0:g.trim())??"",unit:l.uom.trim(),statistics:p,dimensions:[...c]})}),i.length){const l={variables:i};return ue(l),l}}return null}function wt(e,t){const n=x(e,"RectifiedGrid"),o=S(n,"low"),i=S(n,"high"),a=[];for(let u=0;u<o.length;u++)a.push(i[u]-o[u]+1);const s=b(n,"axisLabels").split(" "),c=S(n,"origin/pos"),l=R(n,"offsetVector"),r=[];for(let u=0;u<l.length;u++){const v=S(l[u]),y=v.findIndex(w=>w!==0);r[y]=v[y]}const p=["y","lat","latitude","north","nor","n","b"];let g=!1;t!=null&&t.length&&(s!=null&&s.length)&&(g=[...t].sort((u,v)=>u<v?-1:1).join(",")===[...s].sort((u,v)=>u<v?-1:1).join(","));const m=g?s:t;let f,h,d;return p.includes(m[0].toLowerCase())?(f=a[1],h=a[0],d={y:Math.abs(r[0]),x:Math.abs(r[1])}):(f=a[0],h=a[1],d={x:Math.abs(r[0]),y:Math.abs(r[1])}),{columns:f,rows:h,origin:c,offset:r,resolution:d,gridSamples:a,axisLabels:s,hasSameAxisLabelsAsBoundedBy:g}}function xt(e){const t=x(e,"EarthObservation");if(!t)return null;const n=x(t,"phenomenonTime"),o=n?oe(n):null,i=x(t,"phenomenonTime"),a=i?oe(i):null,s=b(t,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList");let c=null;if(s){const l=s.split(" ").map(r=>r.trim()).filter(r=>r!=null&&r!=="").map(Number);if(l.length){const r=[];for(let p=0;p<l.length/2;p+=2)r.push(l[p],l[p+1]);c=new ze({rings:[[r]]})}}return{observation:{phenomenonTime:o,resultTime:a,footprint:c,identifier:b(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:b(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:b(e,"metaDataProperty/EarthObservationMetaData/status")}}}function Ct(e){var g,m,f;const t={version:"2.0"};let n,o,i=[];for(let h=0;h<e.childNodes.length;h++){const d=e.childNodes[h];if(d.nodeType===1){if(A(d,"coverageId"))t.coverageId=b(d);else if(A(d,"ServiceParameters"))t.serviceParameters={supportedFormats:O(d,"nativeFormat")};else if(A(d,"boundedBy"))t.boundedBy=ht(d);else if(A(d,"rangeType")){const u=vt(d,((g=t.boundedBy)==null?void 0:g.axisLabels.length)>2||((m=t.domainSet)==null?void 0:m.axisLabels.length)>2);t.rangeType=u.rangeType,i=u.bandNames,n=u.bandStats;const{bandNoDataValues:v}=u;v!=null&&v.length&&(o=fe(v))}else if(A(d,"domainSet"))t.domainSet=wt(d,(f=t.boundedBy)==null?void 0:f.axisLabels);else if(A(d,"metadata")){const u=x(d,"EOMetadata");t.eoMetadata=u?xt(u):null}}}const{coverageId:a,boundedBy:s,domainSet:c,rangeType:l,serviceParameters:r}=t,p=bt(l,s,c);return!n&&p&&(n=p==null?void 0:p.variables[0].statistics),p!=null&&(o=l[0][0].nilValue),{id:a,title:a,description:a,bandNames:i,rasterInfo:new pe({width:c.columns,height:c.rows,pixelSize:c.resolution,pixelType:"unknown",extent:s.envelope,spatialReference:s.envelope.spatialReference,bandCount:i.length||1,statistics:n,noDataValue:o,multidimensionalInfo:p}),supportedFormats:r.supportedFormats,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}function It(e,t){let n=null;if(typeof e=="string"?n=new DOMParser().parseFromString(e,"text/xml"):n=e,t==="1.0.0")return R(n,"CoverageOffering").map(i=>ct(i));const o=R(n,"CoverageDescription");return t==="1.1.0"||t==="1.1.1"||t==="1.1.2"?o.map(i=>gt(i,t)):o.map(i=>Ct(i))}async function St(e,t){const{version:n,customParameters:o,signal:i}=t??{},a=n!=null&&n.startsWith("1.0")?"version":"acceptVersions",s={service:"WCS",request:"GetCapabilities",[a]:n,...o};try{let{data:c}=await ae(e,{query:s,responseType:"xml",signal:i});return t!=null&&t.version||nt(c)||(s[a]="2.0.1",{data:c}=await ae(e,{query:s,responseType:"xml",signal:i})),it(c)}catch(c){throw ye(c)?c:new _("wcslayer:open","wcs capabilities is not valid or supported")}}async function re(e,t){const{coverageIds:n,version:o,customParameters:i,signal:a}=t,s=o.slice(0,3),c=s==="1.0"?"coverage":s==="1.1"?"identifiers":"coverageId",l={service:"WCS",request:"DescribeCoverage",version:o,[c]:n.join(","),...i};try{const{data:r}=await ae(e,{query:l,responseType:"xml",signal:a});return It(r,o)}catch(r){throw ye(r)?r:new _("wcslayer:open","wcs coverage description is not valid or supported")}}function $t(e){const t=Tt(e);return t?{isMultipart:!0,data:t.boundary?Dt(e.data,t,0):null}:{isMultipart:!1,data:null}}function Dt(e,t,n=0){const o="--"+t.boundary,i=[];for(let u=0;u<o.length;u++)i.push(o.charCodeAt(u));const a=[],s=`
--`+t.boundary+"--";for(let u=0;u<s.length;u++)a.push(s.charCodeAt(u));const c=[10],l=[13,10],r=[],p=i.length,g=new Uint8Array(e,n),m=g.length-p;let f=0,h=0;for(let u=0;u<m;u++){for(h=0;h<p&&g[u+h]===i[h];h++);if(h!==p)continue;let v=!1;if(f){const y=he(g.subarray(f,u),t);r.push(y),v=!!y.isValidImage}if(u+=p-1,g[u+1]===c[0]?u+=1:g[u+1]===l[0]&&g[u+2]===l[1]&&(u+=2),f=u+1,v)break}const d=a.length;for(let u=g.length-d-10;u<g.length-d;u++){for(h=0;h<d&&g[u+h]===a[h];h++);if(h===d){r.push(he(g.subarray(f,u),t));break}}return r}function Tt(e){var o,i;const t=(i=(o=e.getHeader)==null?void 0:o.call(e,"Content-Type"))==null?void 0:i.split(";");if(!t||!(t[0].trim()??"").startsWith("multipart/"))return null;const n={boundary:"",start:"",type:""};for(let a=1;a<t.length;a++){const s=t[a].indexOf("=");if(s>0){const c=t[a].slice(0,s).trim(),l=t[a].slice(s+1).trim();n[c]=l.startsWith('"')?l.slice(1,-1):l}}return n}function he(e,t){var s;const n=String.fromCharCode.apply(null,e.subarray(0,Math.min(300,e.length))).split(`
`),o=Math.min(n.length,7),i={contentDisposition:"inline"};let a=0;for(let c=0;c<o;c++)if(n[c].length<4)a=a+n[c].length+1;else if(n[c].slice(0,7).toLowerCase()==="content"){a=a+n[c].length+1;const l=n[c].indexOf(":");if(l===-1)continue;const r=n[c].slice(0,l).trim(),p=n[c].slice(l+1).trim();switch(r.toLowerCase()){case"content-type":i.contentType=p;break;case"content-description":i.contentDescription=p;break;case"content-transfer-encoding":i.contentTransferEncoding=p;break;case"content-id":i.contentID=p;break;case"content-disposition":i.contentDisposition=p;break;case"content-location":i.contentLocation=p}}else{if(i.contentDisposition.toLowerCase().includes("inline")&&n[c].length>=4&&((s=i.contentType)==null?void 0:s.toLowerCase().indexOf("image"))>-1){let l=!0,r=e.subarray(a,e.length);if(i.contentType.toLowerCase().indexOf("tif")>0){if(i.contentTransferEncoding==="base64"){let p="";const g=r;for(let f=0;f<g.length;f+=65535){const h=g.subarray(f,f+65535>g.length-1?g.length-1:f+65535);p+=String.fromCharCode.apply(null,h)}const m=atob(p);r=new Uint8Array(m.length);for(let f=0;f<r.length;f++)r[f]=m.charCodeAt(f)}l=r[0]===73&&r[1]===73||r[0]===77&&r[1]===77}if(l){let p=r.buffer;i.contentTransferEncoding!=="base64"&&(p=new ArrayBuffer(e.length-a),r=new Uint8Array(p),r.set(e.subarray(a,e.length))),i.contentData=p,i.isValidImage=!0}break}if((t.start===""||i.contentID===t.start)&&i.contentType){if(i.contentType.includes("text")||i.contentType.includes("xml")){i.contentData=String.fromCharCode.apply(null,e.subarray(a,e.length));break}i.contentData=e.subarray(a,e.length)}}return i}const Lt=["nearest neighbor","bilinear","bicubic"],Pt=["nearest","linear","cubic"],ve="response is not a supported multipart/related mediaType with inline tiff,  switching to compatibility mode",At="response is not a supported multipart mediaType with inline tiff",Rt="response is base64 encoded which may impact layer display performance",Et="server returns an exception",ne=new Set(["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"]);let z=class extends Fe{constructor(){super(...arguments),this.datasetFormat="WCSServer",this.tileType="Raster"}get rasterId(){return`${this.url}-${this.coverageId}-${this.version}`}async fetchRawTile(e,t,n,o={}){if(this.isBlockOutside(e,t,n))return null;const{nativePixelSize:i,spatialReference:a}=this.rasterInfo,s=2**e,c=i.x*s,l=i.y*s,{blockWidth:r,blockHeight:p}=this.getBlockWidthHeight(e),{origin:g}=this.rasterInfo.storageInfo.tileInfo,m=this.getTileExtent({x:c,y:l},t,n,g,a,[r,p]),f=this.rasterInfo.extent,h=m.xmax>f.xmax,d=m.ymin<f.ymin,u=h||d;let v=m,y=r,w=p;if(u&&(v=m.clone().intersection(f),v!=null&&(h&&(y=Math.floor((v.xmax-v.xmin)/c),v.xmax=v.xmin+c*y),d&&(w=Math.floor((v.ymax-v.ymin)/l),v.ymin=v.ymax-l*w))),v==null||y<=1||w<=1)return null;const L=await this._getCoverage(v,y,w,s,o);if(!L)return null;const{coverageDescription:C}=this.coverageInfo,{noDataValue:E,multidimensionalInfo:M}=this.rasterInfo,{multidimensionalDefinition:U}=o;let B;if(M!=null&&U!=null&&U.length){const Y=U[0].variableName;if(C.version==="2.0"){const j=C.rangeType[0].find(G=>G.name===Y);B=j==null?void 0:j.nilValue}else if(C.version==="1.1"){const j=C.range.find(G=>G.identifier===Y);B=j==null?void 0:j.nullValues}}const H=B??E,N=await this.decodePixelBlock(L,{width:y,height:w,planes:null,pixelType:null,tiffNoDataValue:Array.isArray(H)?H[0]:H,matchAllNoData:!0});if(N==null)return null;if(N&&(N.width!==y||N.height!==w))throw new _("wcsraster-fetch",`the response has unexpected dimension width: ${N.width}, height: {pixelBlock.height}`);return u?Ze(N,{x:0,y:0},{width:p,height:p}):N}async _open(e){const{customFetchParameters:t}=this.ioConfig,n=e==null?void 0:e.signal,o=await St(this.url,{version:(t==null?void 0:t.version)??this.version,customParameters:t,signal:n});if(this.capabilities=o,!this.version){let m=o.version.slice(0,3);m==="2.0"||m==="1.1"||m==="1.0"?this.version=o.version:(m=o.supportedVersions.find(f=>f==="2.0.1")||o.supportedVersions.find(f=>f.slice(0,3)==="2.0")||o.supportedVersions.find(f=>f.slice(0,3)==="1.1")||o.supportedVersions.find(f=>f.slice(0,3)==="1.0")||"1.0.0",this.version=m)}const{version:i}=this;if(!ne.has(i))throw new _("wcsraster-open",`unsupported WCS version ${i}`);const{gridCoverages:a}=o;if(!a.length)throw new _("wcsraster-open","cannot find rectified grid coverages");this.coverageId??(this.coverageId=a[0].id);const{coverageId:s}=this,c=a.find(m=>m.id===s);if(c==null)throw new _("wcsraster-open",`the coverageId ${s} does not exist in capabilities`);const l=await re(this.url,{coverageIds:[s],version:i,customParameters:t,signal:n});if(this.coverageInfo=l[0],i.slice(0,3)==="2.0"){const{coverageInfo:m}=this;m.lonLatEnvelope=c.lonLatEnvelope,m.supportedInterpolations=me(o.supportedInterpolations),this._patchDimensionValues201(s,n)}this.datasetName=this.coverageInfo.title;const{rasterInfo:r}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(r,512,512),this._set("rasterInfo",r),r.spatialReference==null)throw new _("wcsraster-open",`coverage without spatial reference is not supported: ${s}`);const{pixelType:p,bandCount:g}=await this._getPixelTypeAndBandCount(n);r.pixelType=p,r.bandCount===1&&g>1&&(r.bandCount=g),this.updateTileInfo()}async _patchDimensionValues201(e,t){var s,c,l,r,p;const{coverageInfo:n}=this,o=(s=n.rasterInfo.multidimensionalInfo)==null?void 0:s.variables,i=ne.has("1.1.2")?"1.1.2":ne.has("1.1.1")?"1.1.1":ne.has("1.1.0")?"1.1.0":null,{customFetchParameters:a}=this.ioConfig;if(o&&i)try{const g=this.url.includes("/ImageServer/"),m=e.length>8&&e.startsWith("Coverage")&&g?e.slice(8):e,f=await re(this.url,{coverageIds:[m??e],version:i,customParameters:a,signal:t}).catch(()=>{if(m)return re(this.url,{coverageIds:[e],version:i,customParameters:a,signal:t})}),h=(c=f==null?void 0:f[0].rasterInfo.multidimensionalInfo)==null?void 0:c.variables;if(h)for(const d of o){const u=h.find(({name:v})=>v===d.name);if((l=u==null?void 0:u.dimensions)!=null&&l.length)for(let v=d.dimensions.length-1;v>=0;v--){const y=d.dimensions[v],w=u.dimensions.find(({name:L})=>L===y.name);w?w.values&&((r=w.extent)==null?void 0:r.join(","))===((p=y.extent)==null?void 0:p.join(","))&&(d.dimensions[v]={...y,values:w.values}):g&&d.dimensions.splice(v,1)}}}catch{}}async _getPixelTypeAndBandCount(e){var h;const{pixelSize:t,extent:n,multidimensionalInfo:o}=this.rasterInfo,i=n.center,a=new q({xmin:i.x-t.x,xmax:i.x+t.x,ymin:i.y-t.y,ymax:i.y+t.y,spatialReference:n.spatialReference});let s=[];if(o!=null){const d=o.variables[0];s=[],d.dimensions.forEach(u=>{var v,y;s.push(new Xe({variableName:d.name,dimensionName:u.name,values:u.hasRegularIntervals?(v=u.extent)==null?void 0:v[0]:(y=u.values)==null?void 0:y[0],isSlice:!0}))})}const{coverageDescription:c}=this.coverageInfo,l={interpolation:"nearest",multidimensionalDefinition:s,signal:e},{version:r}=c,{ioConfig:p}=this,g=r==="2.0"&&p.allowAnyMediaType==null||r==="1.1"&&p.use2GridOffsets==null;let m;try{m=await this._getCoverage(a,2,2,1,l,!0)}catch(d){if(!g)throw d;if(r==="1.1"){if(!((h=d.details)!=null&&h.isResolutionMismatch))throw d;p.use2GridOffsets=!0}}if(!m&&g&&(r==="2.0"&&(p.allowAnyMediaType=!0),m=await this._getCoverage(a,2,2,1,l),m&&se.getLogger(this).warn("wcsraster:getcoverage",ve)),!m)throw new _("wcsraster-open","unable to determine pixel type");const f=await this.decodePixelBlock(m,{width:2,height:2,planes:null,pixelType:null});if(f==null)throw new _("wcsraster-open","unable to determine pixel type");return{pixelType:f.pixelType,bandCount:f.getPlaneCount()??0}}async _getCoverage(e,t,n,o,i,a=!1){const{coverageDescription:s}=this.coverageInfo,{version:c}=s,l=c==="2.0"?this._getCoverage201Parameters(e,t,n,o,i,s):c==="1.1"?this._getCoverage110Parameters(e,t,n,i,s):this._getCoverage100Parameters(e,t,n,i),r=c==="2.0"?await this.request(this._constructWCS201Url(l),{signal:i.signal,responseType:"array-buffer"}):await this.request(this.url,{query:l,signal:i.signal,responseType:"array-buffer"});if(c==="1.0")return r.data;if(c==="2.0"&&this.ioConfig.allowAnyMediaType!==!1&&Ye(r.data)==="tiff")return a&&(this.ioConfig.allowAnyMediaType=!0,se.getLogger(this).warn("wcsraster:getcoverage",ve)),r.data;const p=$t(r);if(p.isMultipart&&p.data){const h=p.data.find(d=>d.isValidImage);return a&&(h==null?void 0:h.contentTransferEncoding)==="base64"&&se.getLogger(this).warn("wcsraster:getcoverage",Rt),h==null?void 0:h.contentData}const g=new Uint8Array(r.data,0,Math.min(r.data.byteLength,2e3)),m=String.fromCharCode.apply(null,g).toLowerCase().includes("exception"),f=m&&String.fromCharCode.apply(null,g).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");throw m?new _("wcsraster:getcoverage",Et,{isResolutionMismatch:f}):new _("wcsraster:getcoverage",At)}_getInterpolationIndex(e){var t;return e&&((t=this.coverageInfo.supportedInterpolations)!=null&&t.includes(e))?e==="nearest"?0:e==="bilinear"?1:e==="cubic"?2:0:0}_getCoverage100Parameters(e,t,n,o){const i=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,a=e.spatialReference.wkid,s=(this.coverageInfo.supportedFormats||[]).find(h=>h.toLowerCase().includes("tiff"))||"GEOTIFF",{bandIds:c,interpolation:l}=o,r=this._getInterpolationIndex(l),p=c?c.map(h=>this.coverageInfo.bandNames[h]):null,g=Lt[r],{multidimensionalDefinition:m}=o;let f;if(m!=null&&this.rasterInfo.multidimensionalInfo!=null){const h=m.find(u=>u.dimensionName==="StdTime");let d=h==null?void 0:h.values;d&&d.length>0&&(Array.isArray(d[0])&&(d=d[0]),f=d.map(u=>ie(u)).join(","))}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:s,crs:`EPSG:${a}`,bbox:i,width:t,height:n,time:f,interpolation:g,band:p==null?void 0:p.join(",")}}_getCoverage110Parameters(e,t,n,o,i){var F,W,Q;const{multidimensionalDefinition:a,bandIds:s,interpolation:c}=o,l=e.spatialReference.wkid,r=`urn:ogc:def:crs:EPSG::${l}`,p=(this.coverageInfo.supportedFormats||[]).find(D=>D.toLowerCase().includes("tiff"))||"image/tiff",g=this._getInterpolationIndex(c),m=Pt[g],f=c==null||((F=this.coverageInfo.supportedInterpolations)==null?void 0:F.indexOf(c))===0,h=i.domain.spatialDomain,d=h.origin.x<=h.envelope.xmin&&h.origin.y<=h.envelope.ymin,u=e.width/t,v=e.height/n*(d?1:-1),y=d?[e.xmin,e.ymin]:[e.xmin,e.ymax],w=h.useEPSGAxis&&xe(l),L=w?`${y[1]},${y[0]}`:`${y[0]},${y[1]}`,C=this.ioConfig.use2GridOffsets,E=w?C?`${v},${u}`:`${v},0,0,${u}`:C?`${u},${v}`:`${u},0,0,${v}`,M=u/2,U=e.xmin+M,B=e.xmax-M,H=Math.abs(v)/2,N=e.ymin+H,Y=e.ymax-H,j=w?`${N},${U},${Y},${B},${r}`:`${U},${N},${B},${Y},${r}`,G=i.range.find(D=>D.axis.some(V=>V.identifier.toLowerCase().includes("band")));let I,k=G&&m&&s?f?`${G.identifier}[${G.axis[0].identifier}[${s.join(",")}]]`:`${G.identifier}:${m}[${G.axis[0].identifier}[${s.join(",")}]]`:null;if(a!=null&&a.length)for(let D=0;D<a.length;D++){let V=a[D].values;const K=(W=a[D].dimensionName)==null?void 0:W.toLowerCase(),ee=(Q=a[D].variableName)==null?void 0:Q.toLowerCase(),X=i.range.find(Z=>Z.identifier.toLowerCase()===ee);if(V.length>0){if(Array.isArray(V[0])&&(V=V[0]),K==="stdtime")I=V.map(Z=>ie(Z)).join(",");else if(X){const Z=X.axis.find(De=>De.identifier.toLowerCase()===K);Z&&(k=f?X.identifier+"["+Z.identifier+"["+V.join(",")+"]]":X.identifier+":"+m+"["+Z.identifier+"["+V.join(",")+"]]")}}D===a.length-1&&X&&!k&&(k=f?X.identifier:X.identifier+":"+m)}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:p,crs:`EPSG:${l}`,boundingbox:j,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:L,gridOffsets:E,gridBaseCRS:r,timeSequence:I,rangeSubset:k}}_getCoverage201Parameters(e,t,n,o,i,a){var G;const{multidimensionalDefinition:s,interpolation:c}=i,l=this._getInterpolationIndex(c);let r=null;const{supportedInterpolations:p}=this.capabilities;if(p!=null&&p.length)switch(l){case 0:r=p.find(I=>I.toLowerCase().includes("nearest"));break;case 1:r=p.find(I=>I.toLowerCase().includes("linear"));break;case 2:r=p.find(I=>I.toLowerCase().includes("cubic")||I.toLowerCase().includes("quadratic"))}const g=(this.coverageInfo.supportedFormats||[]).find(I=>I.toLowerCase().includes("tiff"))||"image/tiff",{bandNames:m}=this.coverageInfo,{boundedBy:f,domainSet:h,rangeType:d}=a,u=f.isEastFirst?0:1,v=1-u,{axisLabels:y}=f,w=y[u],L=y[v],C=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,E=C,M=[];M.push(`${w}(${e.xmin},${e.xmax})`),M.push(`${L}(${e.ymin},${e.ymax})`);const U=[];if(y.length>2)for(let I=2;I<y.length;I++){const k=h.origin[I];if(y[I].toLowerCase().includes("time")){let F=k.toString();(G=f.uomLabels)!=null&&G[I].toLowerCase().includes("ole")&&(U.push(y[I]),F=ie(k,!0)),M.push(y[I]+",http://www.opengis.net("+F+")")}else M.push(y[I]+",http://www.opengis.net("+k+")")}let B=null;if(s!=null&&s.length){const I=[];d.forEach(F=>F.forEach(W=>I.push(W.name)));const k=[];for(let F=0;F<s.length;F++){const W=y.find(D=>D===s[F].dimensionName),Q=I.find(D=>D===s[F].variableName);if(k.includes(Q)||k.push(Q),W){let D=s[F].values;if(D.length>0){Array.isArray(D[0])&&(D=D[0]);let V="";V=W.toLowerCase().includes("time")?D.map(ee=>ie(ee)).join(","):D.join(",");const K=M.findIndex(ee=>ee.indexOf(W+",http://www.opengis.net")===0);K===-1&&M.push(W+",http://www.opengis.net("+V+")"),K===-1||M[K].includes("("+V+")")||M.splice(K,1,W+",http://www.opengis.net("+V+")")}}}k.length&&(B=k.join(","))}else(m==null?void 0:m.length)>=2&&(B=(i.bandIds?i.bandIds.map(I=>m[I]):m).join(","));const H=M.join("&subset="),N=!a.domainSet.hasSameAxisLabelsAsBoundedBy&&this.ioConfig.allowScaleFactor!==!1,Y=N?null:`${w}(${t}),${L}(${n})`,j=N?1/o:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:B,interpolation:r,scaleSize:Y,scaleFactor:j,subset:H,format:g,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:C,subsettingcrs:E}}_constructWCS201Url(e){const t={...this.ioConfig.customFetchParameters,...e},n=[];return Object.keys(t).forEach(o=>{const i=t[o];i!=null&&(o==="subset"?typeof i=="string"&&i.split("&subset=").forEach(a=>{a&&n.push(`subset=${encodeURIComponent(a)}`)}):n.push(`${o}=${encodeURIComponent(i)}`))}),`${encodeURI(this.url)}?${n.join("&")}`}};function ie(e,t=!1){return(t?new Date(le(e)):new Date(e)).toISOString()}$([T({type:String,json:{write:!0}})],z.prototype,"datasetFormat",void 0),$([T({readOnly:!0})],z.prototype,"tileType",void 0),$([T({type:String,json:{write:!0}})],z.prototype,"version",void 0),$([T({type:String,json:{write:!0}})],z.prototype,"coverageId",void 0),$([T({readOnly:!0})],z.prototype,"rasterId",null),z=$([be("esri.layers.support.rasterDatasets.WCSRaster")],z);const Ot=z,Mt=new Set(["milliseconds","seconds","minutes","hours","days","weeks","months","years","decades","centuries"]);let P=class extends Ve(Ne(Ge(je(ke(_e(We(Be(Ee(Re.ClonableMixin(Me)))))))))){constructor(...e){super(...e),this.coverageId=null,this.version=null,this.isReference=null,this.legendEnabled=!0,this.noData=0,this.operationalLayerType="WCS",this.type="wcs",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null,this._debouncedSaveOperations=Le(async(t,n,o)=>{const{save:i,saveAs:a}=await Te(()=>import("./imageryUtils-DZpgBwaI.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]),import.meta.url);switch(t){case te.SAVE:return i(this,n);case te.SAVE_AS:return a(this,o,n)}})}normalizeCtorArgs(e,t){return typeof e=="string"?{url:e,...t}:e}load(e){const t=e!=null?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WCS"]},e).catch(Pe).then(()=>this._openRaster(t))),Promise.resolve(this)}get coverageInfo(){return this.raster.coverageInfo}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){return[He("Pixel Value")]}createPopupTemplate(e){return Je({fields:this.rasterFields,title:this.title},e)}async save(e){return this._debouncedSaveOperations(te.SAVE,e)}async saveAs(e,t){return this._debouncedSaveOperations(te.SAVE_AS,t,e)}async _openRaster(e){var i,a,s,c;const t=new Ot({url:this.url,version:this.version,coverageId:this.coverageId,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters}});if(await t.open({signal:e}),!t.rasterInfo)throw t.destroy(),new _("wcs-layer:load","cannot load resources on "+this.url);const{rasterInfo:n}=t;n.noDataValue==null&&(n.noDataValue=this.noData),this._set("serviceRasterInfo",n),this._set("spatialReference",n.spatialReference),this.title==null&&this.setAtOrigin("title",t.datasetName,"service"),this.coverageId==null&&this.setAtOrigin("coverageId",t.coverageInfo.id,"service"),this.version==null&&t.version&&this.setAtOrigin("version",t.version,"service"),this.setAtOrigin("tileInfo",t.rasterInfo.storageInfo.tileInfo,"service");const{multidimensionalInfo:o}=n;if(o!=null){const l=o.variables[0].dimensions.find(({name:r})=>r==="StdTime");if(l){let r=((i=l.extent)==null?void 0:i[0])??l.values[0];Array.isArray(r)&&(r=r[0]);let p=((a=l.extent)==null?void 0:a[1])??l.values[l.values.length-1];Array.isArray(p)&&(p=p[1]);const g=Mt.has((s=l.intervalUnit)==null?void 0:s.toLowerCase())?(c=l.intervalUnit)==null?void 0:c.toLowerCase():null;this.set("timeInfo",{startField:"StdTime",fullTimeExtent:{start:r,end:p},timeZone:null,interval:g?{value:l.interval,unit:g}:null})}}this.raster=t,this._configDefaultSettings(),this.addHandles(Oe(()=>this.customParameters,l=>this.raster.ioConfig.customFetchParameters=l))}};$([T({type:String,nonNullable:!0,json:{name:"wcsInfo.coverageId",write:{isRequired:!0,ignoreOrigin:!0}}})],P.prototype,"coverageId",void 0),$([T()],P.prototype,"coverageInfo",null),$([T({type:["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"],nonNullable:!0,json:{name:"wcsInfo.version",write:{isRequired:!0,ignoreOrigin:!0}}})],P.prototype,"version",void 0),$([T({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],P.prototype,"isReference",void 0),$([T({json:{read:!0,write:!0}})],P.prototype,"blendMode",void 0),$([T(qe)],P.prototype,"legendEnabled",void 0),$([T({type:["show","hide"]})],P.prototype,"listMode",void 0),$([T()],P.prototype,"noData",void 0),$([T({type:["WCS"]})],P.prototype,"operationalLayerType",void 0),$([T()],P.prototype,"raster",void 0),$([T({readOnly:!0})],P.prototype,"type",void 0),$([T(Ue)],P.prototype,"popupEnabled",void 0),$([T({type:Ae,json:{name:"popupInfo",write:!0}})],P.prototype,"popupTemplate",void 0),$([T({readOnly:!0})],P.prototype,"defaultPopupTemplate",null),$([T({readOnly:!0,type:[ge]})],P.prototype,"fields",void 0),$([T({readOnly:!0,type:[ge]})],P.prototype,"rasterFields",null),P=$([be("esri.layers.WCSLayer")],P);const Gi=P;export{Gi as default};
