const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./TileLayerView3D-BlIhhyFI.js","./Evented-CXIxDjmW.js","./Accessor-D6mNnsWy.js","./subclass-BR3PhgZG.js","./projection-tSh-0UvX.js","./index-BVncS3aY.js","./index-CjOb8WjV.css","./reactiveUtils-BFQ0BtrB.js","./shared-B3wH2qpO.js","./mathUtils-ClvKsMak.js","./Point-TlcsOcXV.js","./jsonMap-DCC6W5ex.js","./writer-3zufXUNV.js","./assets-BNizZMOZ.js","./Extent-B4rrMrqp.js","./Polyline-BQFeqYXi.js","./projectBuffer-iyGwL2dv.js","./geodesicConstants-kj1AtlGg.js","./LayerView3D-B6WbYlXn.js","./heightModelInfoUtils-C5nNknML.js","./HeightModelInfo-CzO-kRMK.js","./arcgisLayerUrl-ETqee4Bd.js","./persistableUrlUtils-Dx61-x4K.js","./TiledLayerView3D-NeMW6vGA.js","./WaterSurface.glsl-BpeZRtH_.js","./symbols-CfvYGR4J.js","./enumeration--HlxOQ_N.js","./fieldUtils-C5R42-PY.js","./intl-CArXn1et.js","./Promise-CZrWwByK.js","./geometry-CnaxvJsv.js","./TextSymbol-zZq0BA1M.js","./Color-DDUWtbqR.js","./colorUtils-CS9vdHXB.js","./screenUtils-PfxkaaMN.js","./materialUtils-CQ3JLQ1x.js","./opacityUtils-BT7mQkwC.js","./aaBoundingBox-BGxkJAW0.js","./collectionUtils-Dm1icNvk.js","./Portal-DCqdz-K4.js","./Clonable-cKbRam6-.js","./vec4f64-CBQL1T0x.js","./RenderGeometry-C4TY81Cr.js","./vec2f64-Diu2Kaa8.js","./vec3f32-Cw9Q6TO_.js","./DoubleArray-CF_CpVBS.js","./Texture-DjTh7HwY.js","./NormalAttribute.glsl-Dqf1UPF9.js","./interfaces-B8ge7Jg9.js","./BindType-BmZEZMMh.js","./compilerUtils-BA04t1lN.js","./VertexAttribute-BnAa5VW0.js","./Util-BMqL_pkg.js","./vec42-B1mBkh1w.js","./enums-BlUEVwJR.js","./Texture-BbJIOVx_.js","./basicInterfaces-wONHx_SN.js","./vec2-B_ymkwGp.js","./mat3-DRqs2t5W.js","./mat3f64-BBpwCtoL.js","./mat4f64-Dk4dwAN8.js","./mat4-ybYUU6jq.js","./ShaderTechniqueConfiguration-D3UbJ2mX.js","./doublePrecisionUtils-B0owpBza.js","./Indices-B6BGScAS.js","./Material-BN_i9QRJ.js","./ViewingMode-Dodu7ZZk.js","./triangle-DtfDEZcP.js","./sphere-DIv2hmik.js","./plane-Bz78OrLf.js","./quatf64-BrpT0VRp.js","./mathUtils-kvswLROa.js","./lineSegment-A3_mEhFF.js","./lengthUtils-vgIBtB6M.js","./renderState-PYzNpa1K.js","./requestImageUtils-BkbekjsQ.js","./orientedBoundingBox-WyW1LZfF.js","./quat-ChS85qAG.js","./spatialReferenceEllipsoidUtils-DuE2W35w.js","./computeTranslationToOriginAndRotation-CFxYfzBj.js","./ElevationProvider-eMOI1-3B.js","./boundedPlane-Xr4Vx-V9.js","./verticalOffsetUtils-CU5zOPGb.js","./unitConversionUtils-BUA_O87q.js","./hydratedFeatures-DHwl8sGq.js","./Graphic-Bi5hWHps.js","./PopupTemplate-D8mXPxzU.js","./ActionToggle-C0Z1k2jc.js","./Identifiable-BLvpQbOc.js","./jsonUtils-DtWlwXHP.js","./projectVectorToVector-BLdiwuTJ.js","./projectPointToVector-C-hGM2ap.js","./frustum-6KI4j9vx.js","./axisAngleDegrees-CHCWDIqP.js","./weather-B51D8kuv.js","./Scheduler-CDoWuxMK.js","./signal-DzOfzcfh.js","./debugFlags-B3L9P_UW.js","./Float4DrawUniform-CWdxHXQ-.js","./NestedMap-DgiGbX8E.js","./Octree-BnKLop8B.js","./InterleavedLayout-UIhsB8jd.js","./BufferView-B7Z-dzh4.js","./floatRGBA-C8rGFKJ0.js","./Intersector-pThUjfQo.js","./glUtil-C6KhMg1m.js","./VertexElementDescriptor-BOD-G50G.js","./MemCache-C6WUx-5V.js","./VertexArrayObject-Cwnso4un.js","./BufferObject-CjYoWxgZ.js","./ColorMaterial.glsl-8RSfQ59m.js","./VertexColor.glsl-BROYASAm.js","./vec2f32-BbH2jxlN.js","./dehydratedFeatures-DzTz-nWK.js","./quantizationUtils-DFd0XKEL.js","./Field-poIiHWUc.js","./fieldType-CIG5ey7e.js","./featureConversionUtils-B-SknPj_.js","./OptimizedFeature-7juV2tZm.js","./OptimizedGeometry-vU5jWBvU.js","./OptimizedFeatureSet-Blu9Ckm7.js","./edgeUtils-BIb6yRHm.js","./DecodeSymbolColor.glsl-CeBC4xQe.js","./earcut-BqgeR2O3.js","./_commonjsHelpers-DCkdB7M8.js","./vec3-C3Q-RF_i.js","./SnappingCandidate-O5eRSE6e.js","./visualVariableUtils-CrTsYJ9f.js","./sizeVariableUtils-Cmcuvw-4.js","./triangulationUtils-KizYbMMI.js","./deduplicate-DxTSMkFY.js","./Normals-D1LdtP06.js","./objectResourceUtils-CpGUIAJs.js","./devEnvironmentUtils-D6qIi8Ky.js","./vec4-L9zJLV3y.js","./Version-_Vxue7Ui.js","./CIMSymbolHelper-Ei9DhmLE.js","./BidiEngine-BwB1Df7c.js","./fontUtils-CILP_6vp.js","./GeometryUtils-CXWuBstD.js","./enums-BRXbslMp.js","./utils-D8D39sLt.js","./definitions-ByNBSgP9.js","./mat2d-DPkeMmgR.js","./mat2df32-orApM5a3.js","./Rect-CUzevAry.js","./BoundingBox-BhuXqU4L.js","./defaults-CIM29kXM.js","./defaultsJSON-GKolV7NZ.js","./OverrideHelper-0-cH6aQ2.js","./colorUtils-D5nOabzP.js","./cimSymbolUtils-Ctf0ZrmH.js","./utils-CvMr5svk.js","./jsonUtils-C4Wp5KpV.js","./parser-BN6zmHl-.js","./utils-D20M4_S8.js","./mat4f32-DcsiF_Rp.js","./LRUCache-ju6LnIBZ.js","./lineStippleUtils-BJ8wDzcw.js","./projectVectorToPoint-GP7lggIC.js","./MeshComponent-uUfLXsBv.js","./imageUtils-Bwri-Uf9.js","./MeshVertexAttributes-De1gN3Wb.js","./meshVertexSpaceUtils-BfF6O78E.js","./MeshLocalVertexSpace-sBjAuOT3.js","./projection-CODyCdLE.js","./DefaultLayouts-Bz7P2wdj.js","./styleUtils-C7rrjuqd.js","./webStyleSymbolUtils--o9yKGMN.js","./jsonUtils-aUmUTP_F.js","./layerUtils-BzjQnEdj.js","./Intersector-C4Z_0aqD.js","./terrainUtils-CFCwJ7li.js","./TileInfo-Dm24FfTU.js","./TileKey-DZd6gJy7.js","./layerViewUtils-D2JqIDZ8.js","./fetchTile-ByPBx0Aa.js","./RefreshableLayer-B26jSd3d.js","./layerContainerType-C5CzMsLd.js","./LayerView-CbIY_4n2.js","./UpdatingHandles-CMtXpTiG.js","./RefreshableLayerView-BClKL0FL.js","./MapServiceLayerViewHelper-DYMcPhwY.js","./scaleUtils-C_vWi-B7.js","./floorFilterUtils-DZ5C6FQv.js","./drapedUtils-BgWOavfo.js","./normalizeUtils-CuTX3yb4.js","./normalizeUtilsCommon-DNPu20r0.js","./utils-Blh5cXWv.js","./utils-Bh7lx_TM.js","./sublayerUtils-_xnIyjYh.js","./TimeExtent-Dl-qaORu.js","./timeUtils-DQR2jUPL.js","./popupUtils-BA90ku9o.js","./Viewpoint-7_owAOZm.js","./Cyclical-BY_I03kj.js","./jsxFactory-Be5PKa9i.js","./uuid-fwrPAdZb.js","./workers-D8NOwm_V.js","./Queue-DpHko4Yk.js","./GraphicsCollection-B0IuEpT5.js","./RenderCoordsHelper-DIYuiHA3.js","./DefaultUI-Cy6B6U3V.js","./InputManager-C4xu1R9l.js","./Map-D9sO0Jqv.js","./Basemap-CKBB4cRW.js","./loadAll-z9YY33Kx.js","./PortalItem-CaeKabGc.js","./writeUtils-BUKZUL8X.js","./Ground-CSI-YC3C.js","./CollectionFlattener-CkyePFnC.js","./editableLayers-BdCikvlg.js","./catalogUtils--o1nDhfl.js","./basemapUtils-fcYt_ePc.js","./TablesMixin-BWPSKW45.js","./Layer-CfUiPX3n.js","./ReactiveMap-Dl_3-Rm5.js","./Query-BpMwiNVl.js","./DataLayerSource-BX7Ap_tY.js","./FullTextSearch-BhJOgh_r.js","./selectionUtils-DYi6daQO.js","./IViewEvents-Bci6PjlS.js","./interfaces-D6pIddIh.js","./screenUtils-BGG3AyYa.js","./a11yUtils-DwloBVAu.js","./capabilities-C84AMSCg.js","./themeUtils-C3zvZbsE.js","./globalCss-CZa70j6i.js","./accessibleHandler-COYT31Am.js","./Compass-eoZ7sbNQ.js","./utils-DsJqvptN.js","./GoTo-CyjNnle5.js","./NavigationToggle-Dune4J79.js","./Zoom-BgowPovH.js","./viewpointUtils-DrSHV8Bj.js","./earthUtils-IMU84l4c.js","./spatialReferenceSupport-B36j_qpq.js","./ElevationSamplerData-Buk1kzZu.js","./Environment-Dqtndk8e.js","./quantityUtils-Cz8e0KG8.js","./Program-BE7XUO18.js","./ShadowCastVisualizeTechniqueConfiguration-CoPYcmeP.js","./euclideanLengthMeasurementUtils-j7PbRKQS.js","./ray-DzoXcN4v.js","./ZoomMomentumEstimator-BjFm7M7Z.js","./labelFormatUtils-CJcADR3o.js","./labelUtils-Cczy0uDR.js","./FeatureTileDescriptor3D-BOE-lJxV.js","./elevationInfoUtils-C0SzfJu0.js","./ElevationQueryTileCache-CGdGXbwa.js","./LayerConstants-B33OP6sh.js","./ElevationRange-BrgM1moX.js","./geometryServiceUtils-C-iODloP.js","./project-DXhIgRZA.js","./hitTestSelectUtils-UXJPjatw.js","./ByteSizeUnit-BsxeN7wM.js","./RenderableTile-DOglSSxI.js","./enums-BRzLM11V.js","./TileStrategy-Dx1mrlzq.js","./TileKey-CIqLSCov.js","./QueueProcessor-Bu6RBZRX.js","./config-MDUrh2eL.js","./DefaultVertexAttributeLayouts-BIPVF1RK.js","./DisplayObject-DFOkWAgp.js","./StyleDefinition-BK3ROBTO.js","./resources-Aq4homSZ.js","./edgeProcessing-kh6EVSro.js","./testSVGPremultipliedAlpha-CKx7iZPZ.js","./RenderingContext-B0G6O7lI.js","./ProgramCache-DZJRjGv8.js","./ElevationLayerView3D-E7YrZUe4.js","./LercDecoder-EOZMVq9O.js","./WorkerHandle-zf9G5gFF.js","./BaseDynamicLayerView3D-BG_XLhSm.js","./DynamicLayerView3D-BCVt6pmt.js","./projectExtentUtils-C9TgtdUr.js","./ImageMaterial.glsl-CE7Ov3rX.js","./BuildingSceneLayerView3D-BiU7howA.js","./BuildingGroupSublayer-DxJ7H0k4.js","./BuildingComponentSublayer-Zqjgw1MQ.js","./ClassBreaksRenderer-B2uJHW90.js","./UniqueValueRenderer-Q9ooDuxf.js","./diffUtils--7ofoPN-.js","./colorRamps-BBM5Timv.js","./SizeVariable-Bq7jlw1r.js","./ColorStop-DEfc5Idt.js","./jsonUtils-DsFdmTaK.js","./FieldsIndex-DHql50vu.js","./UnknownTimeZone-D0GlcniK.js","./HeatmapColorStop-7F2_sZ2U.js","./heatmapUtils-C-uT6ZIV.js","./SimpleRenderer-FL1Ywtqd.js","./FeatureLayer-UOSH_sw8.js","./MultiOriginJSONSupport-CvjUw5hc.js","./FeatureLayerBase-BE0EfCO4.js","./inputs-BiRi4vRH.js","./formUtils-Dni92j4V.js","./commonProperties-BTyJ6vjt.js","./ElevationInfo-jptbPjRY.js","./featureLayerUtils-t2Um2-kg.js","./featureQueryAll-ClGLkoIX.js","./AttachmentQuery-Ccywtvr9.js","./RelationshipQuery-DuLVs9A4.js","./LayerFloorInfo-Bx-Ddgjy.js","./Relationship-Cktwo5cM.js","./serviceCapabilitiesUtils-C8Sa1o3S.js","./editsZScale-Bh8FjDvn.js","./queryZScale-DGW6qDy9.js","./FeatureSet-4rZsDUx9.js","./APIKeyMixin-DpJrW91V.js","./ArcGISService-aI6tC6k0.js","./BlendLayer-DmvCcS5c.js","./CustomParametersMixin-BStBpako.js","./EditBusLayer-BXrQoGfQ.js","./FeatureEffectLayer-DB6VToGX.js","./FeatureEffect-By-hP1x9.js","./FeatureFilter-DqmBE6ye.js","./FeatureReductionLayer-DLpK6ddX.js","./FeatureReductionSelection-BoaPXZg2.js","./labelingInfo-DAjvnaKu.js","./MD5-C9MwAd2G.js","./OperationalLayer-Bq6MAeyc.js","./OrderedLayer-DxmkHdYI.js","./OrderByInfo-D0jsxwzL.js","./PortalLayer-CX96aZTI.js","./portalItemUtils-C4O2jNL5.js","./ScaleRangeLayer-CKYXLXxK.js","./TemporalLayer-DwHwsJsP.js","./TimeInterval-DtVUy51q.js","./TimeInfo-C84oEL3g.js","./FeatureTemplate-DbIjVC84.js","./FeatureType-o-GvSMTI.js","./fieldProperties-Lf6CXfwL.js","./versionUtils-BzPsp3a1.js","./styleUtils-BATHgMyw.js","./TopFeaturesQuery-CoSK-G18.js","./popupUtils-D3OP9u3f.js","./interfaces-CL2NbQte.js","./capabilities-CAweHQni.js","./I3SIndexInfo-1etHuhKG.js","./I3SLayerDefinitions-J4clquwZ.js","./I3SUtil-CLj2BKbM.js","./I3SBinaryReader-CtwiVPE4.js","./WhereClause-CO6Fm86l.js","./TimeOnly-BtK5SiqG.js","./I3SMeshView3D-4x9O_lDb.js","./Transform-CvQcMVkY.js","./RenderTexture--Pm2x6s_.js","./I3SOverrides-Dsomt9Cx.js","./I3SNode-D1Sym7pQ.js","./ReactiveSet-HYC-4KEs.js","./meshFeatureSet-CuwfofFS.js","./Mesh-D9C5l95j.js","./MeshTransform-CtzYVl06.js","./vertexSpaceConversion-CtySDdI9.js","./External-ChjUrdf2.js","./infoFor3D-CxOdoily.js","./FeatureLayerView3D-J5GdaifB.js","./FeatureLayerViewBase3D-B8asdQfT.js","./HeatmapDensity.glsl-vlwBfRBL.js","./timeSupport-DeLDxidC.js","./timeUtils-FF8YLCMd.js","./utils-CXgSw6Sd.js","./tagSymbols-BPcGfZon.js","./dehydratedFeatureComparison-NNZuxUKF.js","./queryForSymbologySnapping-CBwyJUOj.js","./hash-CcEbRgUF.js","./Graphics3DObjectStates-BAOAOP8E.js","./rendererConversion-CEpE4SFL.js","./optimizedFeatureQueryEngineAdapter-Buta7wlw.js","./centroid-DdLmOD72.js","./PooledRBush-CGlhTzFe.js","./quickselect-D0_cvEX6.js","./QueryEngine-BaqPXEl6.js","./timeSupport-86-Lo3YD.js","./json-Wa8cmqdu.js","./QueryEngineCapabilities-CTDe3LlQ.js","./utils-hH5IaWNz.js","./utils-HfpQY-3e.js","./utils-DUUw13Ab.js","./ClassBreaksDefinition-BpZNgsmK.js","./FeatureStore-GQfqFqRN.js","./BoundsStore-BYcuS8_t.js","./heatmapTextureUtils-DhR7tWLr.js","./query-DQxxoK17.js","./pbfQueryUtils-BxTeJmn3.js","./pbf-CmaozfCN.js","./EventedSet-BlB7MiXE.js","./FeatureLayerView-C0ylNWtU.js","./SceneModification-X7C-cceb.js","./persistable-DuNX96g5.js","./multiOriginJSONSupportUtils-C0wm8_Yw.js","./resourceExtension-CiZflZqo.js","./SceneLayerWorker-DZoOFbHf.js","./makeScheduleFunction-CggzEh3c.js","./I3SQueryFeatureStore-D1QtdSdn.js","./TemporalSceneLayerView-E6TyhkL4.js","./CatalogLayerView3D-bnaQE33e.js","./CatalogLayerView-B7s_YSCL.js","./CatalogDynamicGroupLayerView3D-CQjPHw5O.js","./CatalogDynamicGroupLayerView-D3Vh3278.js","./CatalogFootprintLayerView3D-C32lwRlR.js","./CatalogFootprintLayerView-iq08Mw7I.js","./CSVLayerView3D-BTxGbb3r.js","./DimensionLayerView3D-CW7Upxkn.js","./GeoJSONLayerView3D-C_C52zq2.js","./GraphicsLayerView3D-CdsQFI1v.js","./GraphicsProcessor-vyXQsv5I.js","./GroupLayerView-DbjAVkM1.js","./ImageryLayerView3D-DqcZ8JLJ.js","./ImageryLayerView-DXyhkgR6.js","./IntegratedMeshLayerView3D-DM78oryQ.js","./IntegratedMesh3DTilesLayerView3D-D6RcPR1L.js","./ILyr3DWasmPerSceneView-vPx4somd.js","./LineOfSightLayerView3D-BMOmCp1J.js","./MapImageLayerView3D-33CQHccl.js","./MapImageLayerView-CzK9EQ2T.js","./ExportImageParameters-ejhot2o-.js","./MediaLayerView3D-CxYke016.js","./perspectiveUtils-CiAQDRsn.js","./normalizeUtilsSync-DD8htqGn.js","./mat2df64-CBKYtunK.js","./keybindings-DYR2fa8r.js","./SnappingManagerPool-CxgepikZ.js","./SnappingManager-DFm0py-D.js","./geodesicUtils-DyOqnDq-.js","./geometry2dUtils-BraNT6Fs.js","./geodesicLengthMeasurementUtils-YCCCQWpE.js","./geometryEngine-DyRMGqqp.js","./geometryEngineBase-RmbNeFm7.js","./hydrated-CRSW297p.js","./OGCFeatureLayerView3D-_S0SPJjw.js","./OGCFeatureLayerView-CGLmxsqB.js","./PointCloudLayerView3D-BfjVuXIb.js","./PointCloudWorkerUtil-CVRnvUqm.js","./PointCloudUniqueValueRenderer-CrJCBPy2.js","./PopupSceneLayerView-D2mhqjsX.js","./VoxelLayerView3D-C5RwKnmA.js","./RouteLayerView3D-anMnKXJh.js","./RouteInfo-DjFt5bex.js","./networkEnums-CvjEi2yz.js","./Stop-DtyCWHkQ.js","./SceneLayerView3D-BRRndg-m.js","./SceneLayerView-DFDbGbpP.js","./SceneLayerGraphicsView3D-BXVJ0Nab.js","./StreamLayerView3D-X6mhgb6Q.js","./StreamFeatureManager-CxTvjNd5.js","./CircularArray-CujHzHWW.js","./createConnection-CvfGxtUS.js","./StreamLayerView-BxLSbpdG.js","./ImageryTileLayerView3D-BdtgFch5.js","./rasterProjectionHelper-CuUa3waC.js","./rasterUtils-Brs-M08Y.js","./ImageryTileLayerView-SCdASw7T.js","./VectorTileLayerView3D-D17uJp57.js","./TileInfoViewPOT-z-AsSuJR.js","./rasterizingUtils-Cm2OdJYT.js","./constants-D5zmR9t2.js","./WGLBrushVTLSymbol-BVZwlPlb.js","./vec4f32-CjrfB-0a.js","./VTLMaterialManager-B10yUbF1.js","./ShaderCompiler-G2XYGDs6.js","./programUtils-CwiKxPbA.js","./StyleRepository-CcGT0u4w.js","./unitBezier-BX6NeAEr.js","./WFSLayerView3D-D-5Va5C4.js","./WMSLayerView3D-B3XPKzDq.js","./WMSLayerView-BkSmmRWw.js","./ExportWMSImageParameters-BI_JqfG1.js","./WMTSLayerView3D-DkIVt9Ab.js","./AreaMeasurementAnalysisView3D-DYr2gP3n.js","./defaultUnit-6wOlq6cB.js","./getDefaultUnitForView-C278cFTz.js","./AnalysisView3D-Bxdzk7YF.js","./interfaces-js1RL7O8.js","./measurementUtils-22mMXl4k.js","./geodesicAreaMeasurementUtils-CSr4mjZE.js","./euclideanAreaMeasurementUtils-xuftUuQL.js","./projectionUtils-B3AaEXhh.js","./EditGeometryOperations-yqtNdguW.js","./quantityFormatUtils-Del4ZVDh.js","./unitFormatUtils-BtkL2qzA.js","./Segment-DrMYStNF.js","./VisualElement-CT5Yhr5G.js","./TextOverlayItem-BgGhi1uW.js","./LineVisualElement-DDrOKAfo.js","./Object3DVisualElement-DudZRJcw.js","./DimensionAnalysisView3D-C_6tu--8.js","./LengthDimension-BFgmpuaK.js","./automaticLengthMeasurementUtils-BGxs6YHN.js","./RenderObject-Cc5ObyLE.js","./dragEventPipeline3D-BsmsUwER.js","./InteractiveToolBase-BwczmwYA.js","./memoize-DsJmrG76.js","./Factory-CJCzdmBA.js","./SnappingVisualizer3D-MnPwlkC2.js","./ExtendedLineVisualElement-CC63Pz3j.js","./EngineVisualElement-DP_S_DwA.js","./Laserlines.glsl-Dgb6OMTT.js","./PointVisualElement-BUqXP0eU.js","./RightAngleQuadVisualElement-ChD6bB1A.js","./SnappingVisualizer-Bg9_3fTb.js","./PointSnappingHint-DJuRAzp4.js","./VerticesVisualElement-Cwz-EXpy.js","./SnappingContext-lR2hMWGP.js","./SnappingDragPipelineStep-Xj6G0KqT.js","./SnappingOperation-CqqVcxu4.js","./ShadedColorMaterial.glsl-vn9dLgnT.js","./ToolIntersector-CtDkwpAn.js","./analysisViewUtils-CW7QQu79.js","./DirectLineMeasurementAnalysisView3D-DC3jUiUT.js","./interfaces-CjSZqm0S.js","./LineOfSightAnalysisView3D-oKU-PWMO.js","./LineOfSightAnalysisTarget-4TzU1Bfu.js","./manipulatorUtils-Jei8Io8x.js","./SliceAnalysisView3D-D0EdlXpS.js","./SlicePlane-CrJ8Mzmr.js","./SlicePlaneMaterial.glsl-DNfTBo04.js","./sliceToolConfig-DLdTgbpM.js","./ViewshedAnalysisView3D-CfhjLWq5.js","./MoveManipulation-3eFTSIuR.js","./settings-D4LvGPKp.js","./VoxelWasmPerSceneView-BkLBGcGF.js","./TerrainTileTree3DDebugger-C-dEUWgs.js","./TileTreeDebugger-DO3eX0_-.js","./EdgeView-Cygm2Z61.js","./EdgeWorkerHandle-BYj6binE.js","./workerHelper-DszV5Eae.js","./FeatureTileTree3DDebugger-BaHNP4BP.js","./GraphicsView3D-DQ96X9Rd.js"])))=>i.map(i=>d[i]);
import{_ as ae}from"./index-BVncS3aY.js";import{o as Pr,e as c}from"./Evented-CXIxDjmW.js";import{m as Fh,d as _o}from"./Viewpoint-7_owAOZm.js";import"./geometry-CnaxvJsv.js";import{V as Qr,p as yl,d as M,C as nt,c as cc,A as ut,P as si,w as wm,v as Ma,e as gC,_ as fC,E as of}from"./reactiveUtils-BFQ0BtrB.js";import{x as vC}from"./jsxFactory-Be5PKa9i.js";import{t as lf,n as Pe,y as p,b as F,c as xs,k as on,$ as yC,Z as bC,a as xm,h as li,aa as qy,S as zy,J as By,Q as wC,aV as xC,A as CC,ag as TC,g as SC,E as hf,R as PC}from"./subclass-BR3PhgZG.js";import{e as cf,S as Re,g as vr,v as RC,f as Zr,u as Y,q as Pn,y as xh,L as R_,T as $u,B as tt,r as je,as as Hy,b as mn,E as df,H as ct,V as OC,n as MC,m as O_,U as Iu,l as Gt,s as Qi,d as _n,c as EC,ae as AC,a as DC,z as $C,at as IC,h as M_,$ as Tc,au as LC,a6 as uf,K as NC}from"./Accessor-D6mNnsWy.js";import{i as Ht,c as Gy,d as Ca,x as dc,p as pf,s as ky}from"./screenUtils-PfxkaaMN.js";import{m as FC}from"./workers-D8NOwm_V.js";import{s as bl}from"./jsonMap-DCC6W5ex.js";import{e as Z,h as Tt,M as Zd,b as St,n as b,d as it,s as xe,v as gr,N as Be,af as Vh,z as oe,P as ue,g as ee,A as Tr,c as _e,x as os,_ as yt,ag as VC,T as xt,r as le,f as be,J as Lu,m as Kr,O as Xt,l as Kd,t as gn,S as Pa,y as UC,j as qC,i as zC,p as ln,E as jy,D as Xr,C as Ea,q as Yo,a1 as Ch,Y as fs,G as E_,a2 as Uh,X as BC,ah as HC,a as GC,ai as qh,u as Wy,K as kC,aj as mf,ac as jC}from"./mathUtils-ClvKsMak.js";import{l as WC}from"./GraphicsCollection-B0IuEpT5.js";import{v as QC}from"./HeightModelInfo-CzO-kRMK.js";import{J as Cm,B as Ul,U as XC,Q as YC,K as Qy}from"./projection-tSh-0UvX.js";import{p as ZC,A as js,L as fr,k as KC,c as JC,q as eT,s as tT,v as iT,w as _f,x as sT,y as rT,z as gf,B as aT,G as nT,C as oT,D as lT,S as hT,b as cT,N as dT,u as Xy,E as uT,F as pT,a as Yy,H as mT,e as _T}from"./WaterSurface.glsl-BpeZRtH_.js";import{c as zh}from"./projectPointToVector-C-hGM2ap.js";import{i as Zy,a as hi,D as Jr,a1 as Ky,r as Kn,s as Bh,l as hn,E as Nu,b as Jy,a8 as gT,q as e1,e as Tm,K as fT,a7 as t1,o as vT,a6 as ff,I as lo,U as Sm,R as vf,w as yT,a9 as yf}from"./Polyline-BQFeqYXi.js";import{u as bT,W as Fu,Z as A_,l as wT,p as xT,G as CT}from"./boundedPlane-Xr4Vx-V9.js";import{w as Pm,q as bf,z as TT,v as ST}from"./RenderCoordsHelper-DIYuiHA3.js";import{o as PT}from"./scaleUtils-C_vWi-B7.js";import{m as Rm,d as RT,y as Th,p as wl,j as vd,v as wf,h as xf}from"./layerUtils-BzjQnEdj.js";import{I as OT,p as MT,c as xl,J as ET,K as i1,d as AT,L as D_,h as Cf,s as np,M as Tf,j as DT,f as $T,m as IT,o as LT,q as NT,v as FT,w as VT,x as UT,e as qT,G as zT,C as s1,D as BT,E as HT,H as GT,O as r1,z as op,A as lp,P as kT,Q as jT,F as WT,N as QT}from"./DefaultUI-Cy6B6U3V.js";import{R as a1,f as $_,a as n1,d as XT,Z as ja,Q as Sf,_ as o1,r as YT,h as ZT,P as KT,g as JT,w as hp,K as Sc,c as eS,$ as tS,A as iS,l as sS,N as rS,u as aS}from"./viewpointUtils-DrSHV8Bj.js";import{f as pi,s as Ur,g as Ut,m as l1,ab as Om,l as h1,W as c1,_ as ea,L as nS,G as Pf,i as oS,aa as d1,t as lS,e as hS}from"./Point-TlcsOcXV.js";import{e as cS,w as zr}from"./Extent-B4rrMrqp.js";import{p as dS,t as uS}from"./ElevationSamplerData-Buk1kzZu.js";import{l as I_,r as L_,m as pS,c as mS,k as Vu,_ as u1,O as N,a as ih,y as Mm,n as p1,b as pl,S as ei,t as ql,d as _S,e as gS,A as Hh,T as vt,z as Jd,E as zi,g as yr,J as N_,h as eu,$ as Rf,Z as Of,X as Mf,Y as Ef,i as Em,K as fS,Q as vS,q as ks,j as ti,P as la,B as Af,o as tu,w as yS,p as bS,s as wS,C as xS,v as CS,f as Do,u as TS,x as SS,H as Pc,I as PS,L as RS,N as OS,R as Am,U as zl,W as Df,a0 as $f,a1 as MS,a2 as ES,V as AS}from"./terrainUtils-CFCwJ7li.js";import{l as $e,a as cp,o as If}from"./ViewingMode-Dodu7ZZk.js";import{l as Uu}from"./Clonable-cKbRam6-.js";import{k as yd,v as Dm,q as DS,p as Rc,m as $m}from"./mathUtils-kvswLROa.js";import{n as Cl}from"./compilerUtils-BA04t1lN.js";import{p as m1,a as _1,b as g1,c as $S}from"./Environment-Dqtndk8e.js";import{s as IS}from"./quantityUtils-Cz8e0KG8.js";import{E as Gh}from"./colorUtils-D5nOabzP.js";import{o as Aa,r as fn,T as LS,m as kh,e as NS}from"./vec2-B_ymkwGp.js";import{s as vn,z as Im,m as f1,o as FS,a as F_,H as v1,_ as VS,E as US}from"./vec42-B1mBkh1w.js";import{n as mi,_ as V_,r as er,t as y1,e as Lf}from"./vec4f64-CBQL1T0x.js";import{n as Hi,r as U_,a as iu}from"./vec2f64-Diu2Kaa8.js";import{o as v,n as ri}from"./interfaces-B8ge7Jg9.js";import{o as Dt,D as qu,d as yn,q as Bi,b as cn,u as Fe,W as q_,L as uc,m as $t,r as It,j as Lt,K as Ps,ao as su,R as ni,e as b1,B as Qt,V as qS,Y as zS,aG as z_,i as w1,t as x1,E as j,aH as BS,ar as HS,aI as GS,N as kS,_ as jS,a as WS,p as Nf,P as QS,f as XS,at as YS,X as C1,aJ as ZS,Z as jh,C as B_,ag as Br,g as wi,v as bd,G as T1,J as KS,aK as S1,aL as JS,a0 as eP,h as tP,c as iP,A as H_,k as sP,a3 as rP,s as aP,a4 as nP,aM as oP,a6 as lP,O as hP,x as cP,M as zu,aq as Vi,ap as dP,Q as uP,aN as pP}from"./Texture-DjTh7HwY.js";import{O as pt,d as mP,t as Ts,f as _P,n as P1,g as gP,j as R1,h as yi,e as O1}from"./Material-BN_i9QRJ.js";import{R as K,O as Xi,C as Da,F as xr,L as Zs,E as Ai,T as fP,M as Lm,D as Ki,f as M1,G as _i,I as dp,B as E1,_ as Mi,t as Nm,X as Wh,P as Ol,U as go}from"./enums-BlUEVwJR.js";import{S as ot,s as ta,_ as ht,l as Ss,r as A1,o as D1,h as vP}from"./renderState-PYzNpa1K.js";import{r as z,t as tr}from"./ShaderTechniqueConfiguration-D3UbJ2mX.js";import{e as Te}from"./VertexAttribute-BnAa5VW0.js";import{t as ru}from"./VertexElementDescriptor-BOD-G50G.js";import{ao as G_,K as Rn,ap as yP,aq as k_,ar as j_,as as Qh,at as Fm,au as bP,r as $1,L as W_,av as Q_,aw as wP,v as Ct,ax as vs,c as xP,ay as CP,M as TP,k as Ns,az as SP,aA as ii,aB as au,aC as Bl,aD as mr,aE as qr,aF as Bu,J as PP,aG as Ff,aH as Vf,aI as up,E as Yt,I as ha,_ as RP,aJ as nu,m as OP,aK as MP,aL as EP,aM as Bn,aN as ou,aO as AP,aP as DP,aQ as $P,aR as IP,aS as LP,aT as Vm,aU as Uf,aV as wa,aW as I1,aX as NP,aY as FP,aZ as VP,N as Mr,a_ as UP,a$ as qP,b0 as zP,b1 as BP,b2 as HP,b3 as GP,b4 as kP,b5 as jP,b6 as qf,C as pp}from"./RenderGeometry-C4TY81Cr.js";import{c as Ls}from"./BufferObject-CjYoWxgZ.js";import{e as gi,c as Yi,i as $a,E as WP,_ as QP,b as XP,n as zf}from"./Texture-BbJIOVx_.js";import{n as L1,u as Hu,o as N1,M as lu,h as F1,f as V1,r as YP,i as ZP,s as X_,p as KP}from"./mat3-DRqs2t5W.js";import{e as Ml,Y as JP,n as pc,X as e2,c as Ks,x as Bf,p as bn,B as t2,b as Ra,i as fo,o as hu,h as cu,J as du,q as U1,d as i2,f as s2,C as r2}from"./mat4-ybYUU6jq.js";import{e as Qe,t as q1,o as ho}from"./mat4f64-Dk4dwAN8.js";import{r as Hr,o as a2,n as n2}from"./vec3f32-Cw9Q6TO_.js";import{E as mc,A as Y_,i as z1,s as o2}from"./Program-BE7XUO18.js";import{I as ci,o as Zi,a as ft,C as Ta,F as uu,g as l2}from"./Scheduler-CDoWuxMK.js";import{p as Um}from"./weather-B51D8kuv.js";import{t as On}from"./glUtil-C6KhMg1m.js";import{H as Mn}from"./InterleavedLayout-UIhsB8jd.js";import{a as Hf,s as Cs}from"./Util-BMqL_pkg.js";import{aa as h2,U as mp,a7 as B1,n as Gf}from"./assets-BNizZMOZ.js";import{h as H1}from"./UpdatingHandles-CMtXpTiG.js";import{c as kf}from"./earthUtils-IMU84l4c.js";import{S as c2,O as d2,z as u2,I as G1,t as jf,r as p2}from"./ShadowCastVisualizeTechniqueConfiguration-CoPYcmeP.js";import{m as m2}from"./euclideanLengthMeasurementUtils-j7PbRKQS.js";import{l as vo,X as Gu,d as _2,J as ku,L as Z_,f as K_,m as El,V as qt,_ as Sr,W as g2,T as f2}from"./sphere-DIv2hmik.js";import{e as La,r as v2}from"./mat3f64-BBpwCtoL.js";import{T as Na,E as pu,e as co,a as y2,i as ua,g as Wf,G as b2,b as w2}from"./ElevationProvider-eMOI1-3B.js";import{s as wn,n as Qf}from"./Cyclical-BY_I03kj.js";import{O as x2}from"./quat-ChS85qAG.js";import{e as C2}from"./quatf64-BrpT0VRp.js";import{r as T2,d as k1,E as yo,f as S2,S as J_,c as Et,_ as j1,j as W1,F as Vr,O as Xf,q as P2,V as bo,Q as Yf,b as Zf,m as R2}from"./plane-Bz78OrLf.js";import{p as Al,g as Q1,f as X1}from"./ray-DzoXcN4v.js";import{w as Xh,I as O2,L as Kf}from"./verticalOffsetUtils-CU5zOPGb.js";import{a as Rr,o as xn,d as M2,_ as Jf}from"./InputManager-C4xu1R9l.js";import{g as gt,H as mu,I as E2,L as A2,P as D2,s as ju,u as $2,c as I2,l as L2,v as N2,b as Sa,d as F2,N as qm}from"./frustum-6KI4j9vx.js";import{t as zm}from"./NestedMap-DgiGbX8E.js";import{t as _p,b as V2,s as Y1,a as Z1,c as K1}from"./ZoomMomentumEstimator-BjFm7M7Z.js";import{Q as J1,c as U2}from"./ColorMaterial.glsl-8RSfQ59m.js";import{c as q2}from"./hydratedFeatures-DHwl8sGq.js";import{w as z2}from"./labelFormatUtils-CJcADR3o.js";import{J as B2,w as H2,G as G2,z as k2}from"./symbols-CfvYGR4J.js";import{i as Wu,E as j2,N as W2,P as _u,k as Q2,a as e0,O as X2}from"./aaBoundingBox-BGxkJAW0.js";import{t as sh,s as Bs}from"./FeatureTileDescriptor3D-BOE-lJxV.js";import{S as Y2}from"./triangle-DtfDEZcP.js";import{a as Z2}from"./spatialReferenceEllipsoidUtils-DuE2W35w.js";import{G as Bm,E as K2,f as J2,n as eR,C as tR}from"./projectBuffer-iyGwL2dv.js";import{R as iR}from"./elevationInfoUtils-C0SzfJu0.js";import{L as t0,t as sR,I as rR,U as aR}from"./ElevationQueryTileCache-CGdGXbwa.js";import{e as gu}from"./ElevationRange-BrgM1moX.js";import{u as uo}from"./Color-DDUWtbqR.js";import{getGeometryServiceURL as nR}from"./geometryServiceUtils-C-iODloP.js";import{p as oR,n as lR}from"./project-DXhIgRZA.js";import{t as hR}from"./hitTestSelectUtils-UXJPjatw.js";import{r as Sh}from"./signal-DzOfzcfh.js";import{h as cR,r as dR}from"./MemCache-C6WUx-5V.js";import{E as uR}from"./ByteSizeUnit-BsxeN7wM.js";import{G as pR,l as mR,n as _R,M as gR,N as eg,y as eb,A as fu,B as fR,x as vR,D as yR,E as tb,F as an,O as bR,m as wR,P as xR,T as CR,Q as tg,j as TR,p as SR,k as PR,R as Qu,S as RR,U as i0,V as OR}from"./objectResourceUtils-CpGUIAJs.js";import{d as MR}from"./Graphic-Bi5hWHps.js";import{l as ER}from"./CollectionFlattener-CkyePFnC.js";import{n as Yh}from"./projectVectorToVector-BLdiwuTJ.js";import{r as AR,s as DR,e as $R,l as IR,a as LR,t as NR,u as FR}from"./RenderableTile-DOglSSxI.js";import{O as st,N as Ph,e as ig,s as ml,i as Ws,a as s0}from"./basicInterfaces-wONHx_SN.js";import{f as VR,s as Zh}from"./Normals-D1LdtP06.js";import{i as Ji,h as Ei,c as He,b as _c,f as UR,a as Xu,t as qR,o as E,k as Qs,s as sg}from"./NormalAttribute.glsl-Dqf1UPF9.js";import{o as ib,a as sb,v as zR,i as BR,n as rb,w as ab,z as nb,m as rg,x as HR,B as GR,C as kR,q as jR,e as ob,j as WR}from"./VertexColor.glsl-BROYASAm.js";import{t as QR}from"./DoubleArray-CF_CpVBS.js";import{i as XR,x as vu}from"./BufferView-B7Z-dzh4.js";import"./TileStrategy-Dx1mrlzq.js";import{e as YR}from"./TileKey-CIqLSCov.js";import{i as ZR,a as KR}from"./StyleDefinition-BK3ROBTO.js";import{s as JR,a as eO}from"./resources-Aq4homSZ.js";import{s as tO,L as iO}from"./orientedBoundingBox-WyW1LZfF.js";import{t as lb,l as sO}from"./Indices-B6BGScAS.js";import{r as rO}from"./vec3-C3Q-RF_i.js";import{n as yu,r as aO}from"./DecodeSymbolColor.glsl-CeBC4xQe.js";import{s as gc,m as nO,C as oO,A as $o}from"./edgeUtils-BIb6yRHm.js";import{m as lO,E as hO}from"./edgeProcessing-kh6EVSro.js";import{o as cO}from"./VertexArrayObject-Cwnso4un.js";import{t as Kh}from"./requestImageUtils-BkbekjsQ.js";import{r as dO}from"./floatRGBA-C8rGFKJ0.js";import{Y as ao}from"./Octree-BnKLop8B.js";import{E as uO}from"./testSVGPremultipliedAlpha-CKx7iZPZ.js";import{y as pO,n as mO}from"./RenderingContext-B0G6O7lI.js";import{s as gp}from"./imageUtils-Bwri-Uf9.js";import{t as _O}from"./capabilities-C84AMSCg.js";import{e as gO}from"./layerViewUtils-D2JqIDZ8.js";import{o as r0,r as a0}from"./screenUtils-BGG3AyYa.js";import{r as n0}from"./spatialReferenceSupport-B36j_qpq.js";import{a as fO}from"./BindType-BmZEZMMh.js";import{o as vO}from"./Float4DrawUniform-CWdxHXQ-.js";function hb(i,e){const t=lf(i),s=lf(e),r=t.store,a=s.store,n=s.metadata;for(const o in n){const l=n[o],h=r.originOf(o),d=a.originOf(o);if(!l.readOnly&&d!==cf.DEFAULTS)if(h===cf.DEFAULTS)i.set(o,a.get(o));else{const u=r.get(o),m=a.get(o);u&&m&&m instanceof Re&&u instanceof Re&&u instanceof m.constructor&&hb(u,m)}}}let Wa=class extends Pr.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=I_}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const e=this.view.basemapTerrain;if((e==null?void 0:e.extent)==null||e.spatialReference==null)return null;const t=Zy(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){var e;return((e=this.view.basemapTerrain)==null?void 0:e.spatialReference)??pi.WGS84}elevationAt(e,t){var s;if(this.extent==null||!cS(this.extent,e,t)){const r=this.extent!=null?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return Pe.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${r})`),this.noDataValue}return((s=this.view.elevationProvider)==null?void 0:s.getElevation(e,t,0,this.spatialReference,"ground"))??this.noDataValue}queryElevation(e){return dS(e.clone(),this)}};c([p({readOnly:!0})],Wa.prototype,"demResolution",void 0),c([p({readOnly:!0})],Wa.prototype,"extent",null),c([p({readOnly:!0})],Wa.prototype,"noDataValue",void 0),c([p()],Wa.prototype,"spatialReference",null),c([p({constructOnly:!0})],Wa.prototype,"view",void 0),Wa=c([F("esri.views.support.GroundViewElevationSampler")],Wa);const yO=Wa;let pa=class extends Re{constructor(e){super(e),this.view=null,this.layerViews=new Qr}initialize(){this.addHandles(yl(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground},e=>e.load())),this.addHandles(this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()))}destroy(){this._set("view",null);for(const e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new yO({view:this.view}):null:null}get extent(){const e=this.view;return e&&e.type!=="2d"&&e.ready?a1(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return!this.view||this.view.suspended}_layerViewsAfterChangesHandler(){this.removeHandles("updating"),this.addHandles(this.layerViews.map(e=>M(()=>e.updating,()=>this._updateUpdating(),nt)).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};c([p({readOnly:!0})],pa.prototype,"elevationSampler",null),c([p({readOnly:!0})],pa.prototype,"extent",null),c([p({type:Boolean,readOnly:!0})],pa.prototype,"updating",null),c([p({constructOnly:!0})],pa.prototype,"view",void 0),c([p({type:Qr,readOnly:!0})],pa.prototype,"layerViews",void 0),c([p({readOnly:!0})],pa.prototype,"suspended",null),pa=c([F("esri.views.GroundView")],pa);const bO=pa,Hl=()=>ae(()=>import("./TileLayerView3D-BlIhhyFI.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),o0=()=>ae(()=>import("./ElevationLayerView3D-E7YrZUe4.js"),__vite__mapDeps([270,1,2,3,271,272,198,199,7,8,13,5,6,28,29,11,18,19,20,10,12,21,22,23,24,25,26,27,9,30,14,15,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,16,17,80,81,82,83,84,85,86,87,88,89,90,91,4,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,179,180,194,195,196,197,200,201,183,202,203,204,205,206,207,208,209,210,211,212,213,214,215,191,192,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,188,189,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),l0={"base-dynamic":()=>ae(()=>import("./BaseDynamicLayerView3D-BG_XLhSm.js"),__vite__mapDeps([273,1,2,3,274,7,8,14,10,11,12,13,5,6,15,9,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,16,17,80,81,82,83,84,30,85,86,40,27,28,29,26,32,33,87,88,25,31,34,35,36,37,22,38,39,89,90,91,4,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,18,19,20,21,275,252,253,188,189,276,111,166,110,179,180,175,181]),import.meta.url),"base-elevation":o0,"base-tile":Hl,"bing-maps":Hl,"building-scene":()=>ae(()=>import("./BuildingSceneLayerView3D-BiU7howA.js"),__vite__mapDeps([277,1,2,3,85,30,14,10,11,12,13,5,6,15,9,86,40,7,8,27,28,29,26,32,33,87,88,25,31,34,35,36,37,22,38,39,89,278,206,279,280,281,282,283,284,285,128,127,50,73,169,170,147,148,167,286,157,107,135,287,288,149,150,53,41,141,114,289,290,291,292,293,178,294,295,115,116,296,20,21,297,298,83,299,300,217,191,192,218,219,301,302,303,304,305,215,198,199,306,307,4,16,17,308,309,310,311,153,154,155,156,61,312,313,197,314,315,316,317,318,319,246,320,321,322,323,324,207,325,177,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,60,78,90,91,68,69,59,70,43,71,342,51,79,121,103,122,48,47,49,98,76,58,77,66,193,343,344,345,255,180,346,347,251,24,42,44,45,46,52,54,55,56,57,62,63,64,65,67,72,74,75,80,81,82,84,92,93,94,95,96,97,99,100,101,102,104,105,106,108,109,110,111,112,113,117,118,119,120,123,124,125,126,129,130,131,132,133,134,136,137,138,139,140,142,143,144,145,146,151,152,158,159,160,161,162,163,164,165,166,168,171,250,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,275,252,253,188,189,216,364,172,173,174,365,248,366,367,368,213,205,208,369,370,371,372,203,175,184,373,186,187,374,375,376,377,378,379,380,183,381,382,240,383,18,19,384,385,386,272,387,388,179,181,194,195,196,200,201,202,204,209,210,211,212,214,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,242,243,244,245,247,249,254,256,257,258,259,260,261,262,263,264,265,266,267,268,269,389,390,391,392,393,394,395,396]),import.meta.url),catalog:()=>ae(()=>import("./CatalogLayerView3D-bnaQE33e.js"),__vite__mapDeps([397,1,2,3,7,8,18,19,20,11,13,5,6,10,12,21,22,398,179,88,29,180,175]),import.meta.url),"catalog-dynamic-group":()=>ae(()=>import("./CatalogDynamicGroupLayerView3D-CQjPHw5O.js"),__vite__mapDeps([399,1,2,3,7,8,18,19,20,11,13,5,6,10,12,21,22,400,27,28,29,9,30,14,15,179,88,180,175]),import.meta.url),"catalog-footprint":()=>ae(()=>import("./CatalogFootprintLayerView3D-C32lwRlR.js"),__vite__mapDeps([401,1,2,3,358,7,8,113,10,11,12,13,5,6,37,14,15,9,114,30,115,26,116,359,84,85,86,40,27,28,29,32,33,87,88,25,31,34,35,36,22,38,39,89,90,16,17,91,4,360,361,191,192,362,363,217,218,219,275,252,253,188,189,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,180,21,170,216,364,172,173,174,152,153,154,155,156,151,141,157,365,248,366,282,281,283,284,285,128,127,169,147,148,167,24,110,111,112,117,118,119,120,121,122,123,124,125,126,129,130,131,132,133,134,135,136,137,138,139,140,142,143,144,145,146,149,150,158,159,160,161,162,163,164,165,166,168,171,367,280,286,287,288,289,290,291,215,368,213,205,206,207,208,369,370,371,372,203,199,193,175,316,184,373,186,187,343,344,374,375,376,377,378,379,380,308,183,381,382,240,383,18,19,20,384,385,386,307,272,198,387,388,315,179,181,402,194,195,196,197,200,201,202,204,209,210,211,212,214,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,242,243,244,245,246,247,249,250,251,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),csv:()=>ae(()=>import("./CSVLayerView3D-BTxGbb3r.js"),__vite__mapDeps([403,1,2,3,358,7,8,113,10,11,12,13,5,6,37,14,15,9,114,30,115,26,116,359,84,85,86,40,27,28,29,32,33,87,88,25,31,34,35,36,22,38,39,89,90,16,17,91,4,360,361,191,192,362,363,217,218,219,275,252,253,188,189,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,180,21,170,216,364,172,173,174,152,153,154,155,156,151,141,157,365,248,366,282,281,283,284,285,128,127,169,147,148,167,24,110,111,112,117,118,119,120,121,122,123,124,125,126,129,130,131,132,133,134,135,136,137,138,139,140,142,143,144,145,146,149,150,158,159,160,161,162,163,164,165,166,168,171,367,280,286,287,288,289,290,291,215,368,213,205,206,207,208,369,370,371,372,203,199,193,175,316,184,373,186,187,343,344,374,375,376,377,378,379,380,308,183,381,382,240,383,18,19,20,384,385,386,307,272,198,387,388,315,179,181,194,195,196,197,200,201,202,204,209,210,211,212,214,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,242,243,244,245,246,247,249,250,251,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),dimension:()=>ae(()=>import("./DimensionLayerView3D-CW7Upxkn.js"),__vite__mapDeps([404,5,6,1,2,3,7,8,18,19,20,11,13,10,12,21,22,179,88,29,180,175]),import.meta.url),elevation:o0,feature:()=>ae(()=>import("./FeatureLayerView3D-J5GdaifB.js"),__vite__mapDeps([357,1,2,3,7,8,4,5,6,9,10,11,12,13,14,15,16,17,170,167,39,29,358,113,37,114,30,115,26,116,359,84,85,86,40,27,28,32,33,87,88,25,31,34,35,36,22,38,89,90,91,360,361,191,192,362,363,217,218,219,275,252,253,188,189,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,180,21,216,364,172,173,174,152,153,154,155,156,151,141,157,365,248,366,282,281,283,284,285,128,127,169,147,148,24,110,111,112,117,118,119,120,121,122,123,124,125,126,129,130,131,132,133,134,135,136,137,138,139,140,142,143,144,145,146,149,150,158,159,160,161,162,163,164,165,166,168,171,367,280,286,287,288,289,290,291,215,368,213,205,206,207,208,369,370,371,372,203,199,193,175,316,184,373,186,187,343,344,374,375,376,377,378,379,380,308,183,381,382,240,383,18,19,20,384,385,386,307,272,198,387,388,315,179,181,194,195,196,197,200,201,202,204,209,210,211,212,214,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,242,243,244,245,246,247,249,250,251,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),geojson:()=>ae(()=>import("./GeoJSONLayerView3D-C_C52zq2.js"),__vite__mapDeps([405,1,2,3,358,7,8,113,10,11,12,13,5,6,37,14,15,9,114,30,115,26,116,359,84,85,86,40,27,28,29,32,33,87,88,25,31,34,35,36,22,38,39,89,90,16,17,91,4,360,361,191,192,362,363,217,218,219,275,252,253,188,189,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,180,21,170,216,364,172,173,174,152,153,154,155,156,151,141,157,365,248,366,282,281,283,284,285,128,127,169,147,148,167,24,110,111,112,117,118,119,120,121,122,123,124,125,126,129,130,131,132,133,134,135,136,137,138,139,140,142,143,144,145,146,149,150,158,159,160,161,162,163,164,165,166,168,171,367,280,286,287,288,289,290,291,215,368,213,205,206,207,208,369,370,371,372,203,199,193,175,316,184,373,186,187,343,344,374,375,376,377,378,379,380,308,183,381,382,240,383,18,19,20,384,385,386,307,272,198,387,388,315,179,181,194,195,196,197,200,201,202,204,209,210,211,212,214,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,242,243,244,245,246,247,249,250,251,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),graphics:()=>ae(()=>import("./GraphicsLayerView3D-CdsQFI1v.js"),__vite__mapDeps([406,1,2,3,7,8,18,19,20,11,13,5,6,10,12,21,22,365,30,14,15,9,91,4,16,17,90,248,83,73,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,74,75,76,77,78,79,80,81,82,84,85,86,40,27,28,29,26,32,33,87,88,25,31,34,35,36,37,38,39,89,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,407,282,180,215,191,192,24,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,217,218,219,367,280,281,283,284,285,286,287,288,289,290,291,368,213,205,206,207,208,369,370,371,372,203,199,193,175,275,252,253,188,189,179]),import.meta.url),group:()=>ae(()=>import("./GroupLayerView-DbjAVkM1.js"),__vite__mapDeps([408,1,2,3,7,8,38,179,88,29,11,180,175]),import.meta.url),imagery:()=>ae(()=>import("./ImageryLayerView3D-DqcZ8JLJ.js"),__vite__mapDeps([409,1,2,3,7,8,274,14,10,11,12,13,5,6,15,9,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,16,17,80,81,82,83,84,30,85,86,40,27,28,29,26,32,33,87,88,25,31,34,35,36,37,22,38,39,89,90,91,4,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,18,19,20,21,275,252,253,188,189,276,111,166,110,179,180,175,181,410,360,361,191,192,362,363,217,218,115,116,219,193]),import.meta.url),"integrated-mesh":()=>ae(()=>import("./IntegratedMeshLayerView3D-DM78oryQ.js"),__vite__mapDeps([411,1,2,3,85,30,14,10,11,12,13,5,6,15,9,86,40,7,8,27,28,29,26,32,33,87,88,25,31,34,35,36,37,22,38,39,89,345,255,58,59,61,60,70,53,41,180,346,16,17,347,68,69,43,71,251,24,42,44,45,46,47,48,49,50,51,52,54,55,56,57,62,63,64,65,66,67,72,73,74,75,76,77,78,79,80,81,82,83,84,90,91,4,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,250,348,197,349,341,217,191,192,218,219,342,350,300,351,352,353,354,355,356,308,357,358,359,360,361,362,363,275,252,253,188,189,21,216,364,172,173,174,365,248,366,282,281,283,284,285,367,280,286,287,288,289,290,291,215,368,213,205,206,207,208,369,370,371,372,203,199,193,175,316,184,373,186,187,343,344,374,375,376,377,378,379,380,183,381,382,240,383,18,19,20,384,385,386,307,272,198,387,388,315,179,181,194,195,196,200,201,202,204,209,210,211,212,214,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,242,243,244,245,246,247,249,254,256,257,258,259,260,261,262,263,264,265,266,267,268,269,389,390,320,391,392,393,394]),import.meta.url),"integrated-mesh-3dtiles":()=>ae(()=>import("./IntegratedMesh3DTilesLayerView3D-D6RcPR1L.js"),__vite__mapDeps([412,1,2,3,7,8,58,9,59,61,60,70,41,10,11,12,13,5,6,79,16,17,346,347,15,14,68,53,69,43,71,251,24,25,26,27,28,29,30,31,32,33,34,35,36,37,22,38,39,40,42,44,45,46,47,48,49,50,51,52,54,55,56,57,62,63,64,65,66,67,72,73,74,75,76,77,78,80,81,82,83,84,85,86,87,88,89,90,91,4,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,413,248,18,19,20,21,202,196,197,180,203,199,204,205,206,207,208,209,210,211,212,213,214,215,191,192,200,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,249,250,179,175,194,195,198,201,183,234,235,236,237,172,173,174,238,239,240,241,242,243,244,245,246,247,252,253,188,189,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),"line-of-sight":()=>ae(()=>import("./LineOfSightLayerView3D-BMOmCp1J.js"),__vite__mapDeps([414,5,6,1,2,3,7,8,18,19,20,11,13,10,12,21,22,179,88,29,180,175]),import.meta.url),"map-image":()=>ae(()=>import("./MapImageLayerView3D-33CQHccl.js"),__vite__mapDeps([415,1,2,3,274,7,8,14,10,11,12,13,5,6,15,9,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,16,17,80,81,82,83,84,30,85,86,40,27,28,29,26,32,33,87,88,25,31,34,35,36,37,22,38,39,89,90,91,4,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,18,19,20,21,275,252,253,188,189,276,111,166,110,179,180,175,181,416,417,183,184,190,360,361,191,192,362,363,182,185,186,187,193]),import.meta.url),media:()=>ae(()=>import("./MediaLayerView3D-CxYke016.js"),__vite__mapDeps([418,1,2,3,419,15,12,14,10,11,13,5,6,9,4,7,8,16,17,420,89,187,58,59,57,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,30,85,86,40,27,28,29,26,32,33,87,88,25,31,34,35,36,37,22,38,39,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,18,19,20,21,143,421,180,203,199,422,423,424,248,425,426,316,191,192,217,218,115,116,219,184,170,362,175,427,239,428,429,124,430,195,276,111,166,110,179]),import.meta.url),"ogc-feature":()=>ae(()=>import("./OGCFeatureLayerView3D-_S0SPJjw.js"),__vite__mapDeps([431,1,2,3,358,7,8,113,10,11,12,13,5,6,37,14,15,9,114,30,115,26,116,359,84,85,86,40,27,28,29,32,33,87,88,25,31,34,35,36,22,38,39,89,90,16,17,91,4,360,361,191,192,362,363,217,218,219,275,252,253,188,189,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,180,21,170,216,364,172,173,174,152,153,154,155,156,151,141,157,365,248,366,282,281,283,284,285,128,127,169,147,148,167,24,110,111,112,117,118,119,120,121,122,123,124,125,126,129,130,131,132,133,134,135,136,137,138,139,140,142,143,144,145,146,149,150,158,159,160,161,162,163,164,165,166,168,171,367,280,286,287,288,289,290,291,215,368,213,205,206,207,208,369,370,371,372,203,199,193,175,316,184,373,186,187,343,344,374,375,376,377,378,379,380,308,183,381,382,240,383,18,19,20,384,385,386,307,272,198,387,388,315,179,181,432,194,195,196,197,200,201,202,204,209,210,211,212,214,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,242,243,244,245,246,247,249,250,251,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),"open-street-map":Hl,"oriented-imagery":()=>ae(()=>import("./FeatureLayerView3D-J5GdaifB.js"),__vite__mapDeps([357,1,2,3,7,8,4,5,6,9,10,11,12,13,14,15,16,17,170,167,39,29,358,113,37,114,30,115,26,116,359,84,85,86,40,27,28,32,33,87,88,25,31,34,35,36,22,38,89,90,91,360,361,191,192,362,363,217,218,219,275,252,253,188,189,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,180,21,216,364,172,173,174,152,153,154,155,156,151,141,157,365,248,366,282,281,283,284,285,128,127,169,147,148,24,110,111,112,117,118,119,120,121,122,123,124,125,126,129,130,131,132,133,134,135,136,137,138,139,140,142,143,144,145,146,149,150,158,159,160,161,162,163,164,165,166,168,171,367,280,286,287,288,289,290,291,215,368,213,205,206,207,208,369,370,371,372,203,199,193,175,316,184,373,186,187,343,344,374,375,376,377,378,379,380,308,183,381,382,240,383,18,19,20,384,385,386,307,272,198,387,388,315,179,181,194,195,196,197,200,201,202,204,209,210,211,212,214,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,242,243,244,245,246,247,249,250,251,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),"point-cloud":()=>ae(()=>import("./PointCloudLayerView3D-BfjVuXIb.js"),__vite__mapDeps([433,1,2,3,7,8,34,9,44,37,14,10,11,12,13,5,6,15,69,53,59,60,70,43,41,71,115,26,116,27,28,29,30,95,96,97,248,83,73,18,19,20,21,22,24,25,31,32,33,35,36,38,39,40,42,45,46,47,48,49,50,51,52,54,55,56,57,58,61,62,63,64,65,66,67,68,72,74,75,76,77,78,79,16,17,80,81,82,84,85,86,87,88,89,90,91,4,92,93,94,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,272,198,199,341,217,191,192,218,219,342,434,435,285,249,250,436,193,179,180,175,194,195,196,197,200,201,183,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,172,173,174,238,239,240,241,242,243,244,245,246,247,251,252,253,188,189,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),voxel:()=>ae(()=>import("./VoxelLayerView3D-C5RwKnmA.js"),__vite__mapDeps([437,1,2,3,30,14,10,11,12,13,5,6,15,9,7,8,90,16,17,91,4,37,18,19,20,21,22,24,25,26,27,28,29,31,32,33,34,35,36,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,436,193,179,180,175,194,195,196,197,198,199,200,201,183,202,203,204,205,206,207,208,209,210,211,212,213,214,215,191,192,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,172,173,174,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,188,189,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),route:()=>ae(()=>import("./RouteLayerView3D-anMnKXJh.js"),__vite__mapDeps([438,1,2,3,7,8,210,439,85,30,14,10,11,12,13,5,6,15,9,86,40,27,28,29,26,32,33,87,88,25,31,34,35,36,37,22,38,39,89,440,441,18,19,20,21,407,282,180,215,191,192,84,90,16,17,91,4,24,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,217,218,219,367,280,281,283,284,285,286,287,288,289,290,291,368,213,205,206,207,208,369,370,371,372,203,199,193,175,275,252,253,188,189,387,179]),import.meta.url),scene:i=>i.profile==null||i.profile==="mesh-pyramids"?ae(()=>import("./SceneLayerView3D-BRRndg-m.js"),__vite__mapDeps([442,1,2,3,85,30,14,10,11,12,13,5,6,15,9,86,40,7,8,27,28,29,26,32,33,87,88,25,31,34,35,36,37,22,38,39,89,350,343,344,288,316,191,192,217,218,115,116,219,184,167,345,255,58,59,61,60,70,53,41,180,346,16,17,347,68,69,43,71,251,24,42,44,45,46,47,48,49,50,51,52,54,55,56,57,62,63,64,65,66,67,72,73,74,75,76,77,78,79,80,81,82,83,84,90,91,4,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,168,169,170,171,250,348,197,349,341,342,300,351,352,353,354,355,356,308,357,358,359,360,361,362,363,275,252,253,188,189,21,216,364,172,173,174,365,248,366,282,281,283,284,285,367,280,286,287,289,290,291,215,368,213,205,206,207,208,369,370,371,372,203,199,193,175,373,186,187,374,375,376,377,378,379,380,183,381,382,240,383,18,19,20,384,385,386,307,272,198,387,388,315,179,181,194,195,196,200,201,202,204,209,210,211,212,214,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,242,243,244,245,246,247,249,254,256,257,258,259,260,261,262,263,264,265,266,267,268,269,389,390,320,391,392,393,394,443,396,395,436]),import.meta.url):ae(()=>import("./SceneLayerGraphicsView3D-BXVJ0Nab.js"),__vite__mapDeps([444,5,6,1,2,3,85,30,14,10,11,12,13,15,9,86,40,7,8,27,28,29,26,32,33,87,88,25,31,34,35,36,37,22,38,39,89,16,17,90,91,4,45,250,113,114,115,116,84,348,24,41,42,43,44,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,197,347,349,341,217,191,192,218,219,342,251,350,300,351,352,353,354,355,356,308,357,358,359,360,361,362,363,275,252,253,188,189,180,21,216,364,172,173,174,365,248,366,282,281,283,284,285,367,280,286,287,288,289,290,291,215,368,213,205,206,207,208,369,370,371,372,203,199,193,175,316,184,373,186,187,343,344,374,375,376,377,378,379,380,183,381,382,240,383,18,19,20,384,385,386,307,272,198,387,388,315,179,181,194,195,196,200,201,202,204,209,210,211,212,214,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,242,243,244,245,246,247,249,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,443,396,436]),import.meta.url),stream:()=>ae(()=>import("./StreamLayerView3D-X6mhgb6Q.js"),__vite__mapDeps([445,1,2,3,7,8,30,14,10,11,12,13,5,6,15,9,85,86,40,27,28,29,26,32,33,87,88,25,31,34,35,36,37,22,38,39,89,446,447,448,4,16,17,384,186,187,188,189,385,386,119,118,120,307,217,191,192,218,115,116,219,387,96,359,84,90,91,360,361,362,363,275,252,253,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,92,93,94,95,97,98,99,100,101,102,103,104,105,106,107,108,109,180,21,170,216,113,114,364,172,173,174,152,153,154,155,156,151,141,157,365,248,366,282,281,283,284,285,128,127,169,147,148,167,24,110,111,112,117,121,122,123,124,125,126,129,130,131,132,133,134,135,136,137,138,139,140,142,143,144,145,146,149,150,158,159,160,161,162,163,164,165,166,168,171,367,280,286,287,288,289,290,291,215,368,213,205,206,207,208,369,370,371,372,203,199,193,175,316,184,373,343,344,374,375,376,377,378,379,380,308,183,381,382,240,383,18,19,20,179,449,194,195,196,197,198,200,201,202,204,209,210,211,212,214,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,242,243,244,245,246,247,249,250,251,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),tile:Hl,"imagery-tile":()=>ae(()=>import("./ImageryTileLayerView3D-BdtgFch5.js"),__vite__mapDeps([450,1,2,3,7,8,451,30,14,10,11,12,13,5,6,15,9,4,16,17,18,19,20,21,22,23,24,25,26,27,28,29,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,452,453,360,361,191,192,362,363,193,179,180,181,185,225,194,195,196,197,198,199,200,201,183,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,188,189,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),"vector-tile":()=>ae(()=>import("./VectorTileLayerView3D-D17uJp57.js"),__vite__mapDeps([454,1,2,3,7,8,107,202,196,28,29,11,13,5,6,197,180,203,199,96,204,205,38,39,12,14,10,206,207,22,208,170,209,32,33,9,50,26,36,210,211,212,213,155,34,156,61,214,215,30,15,191,192,88,200,85,86,40,27,87,25,31,35,37,89,20,216,217,218,115,116,219,220,221,222,223,224,19,21,66,4,16,17,225,226,227,228,229,230,231,232,233,455,198,145,54,55,386,456,103,457,259,173,174,258,57,260,256,58,257,109,108,261,262,263,106,264,140,139,458,459,142,112,460,461,462,463,150,53,41,464,18,23,24,42,43,44,45,46,47,48,49,51,52,56,59,60,62,63,64,65,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,90,91,92,93,94,95,97,98,99,100,101,102,104,105,110,111,113,114,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,141,143,144,146,147,148,149,151,152,153,154,157,158,159,160,161,162,163,164,165,166,167,168,169,171,172,175,179,194,195,201,183,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,188,189,254,255,265,266,267,268,269]),import.meta.url),wcs:()=>ae(()=>import("./ImageryTileLayerView3D-BdtgFch5.js"),__vite__mapDeps([450,1,2,3,7,8,451,30,14,10,11,12,13,5,6,15,9,4,16,17,18,19,20,21,22,23,24,25,26,27,28,29,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,452,453,360,361,191,192,362,363,193,179,180,181,185,225,194,195,196,197,198,199,200,201,183,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,188,189,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),"web-tile":Hl,wfs:()=>ae(()=>import("./WFSLayerView3D-D-5Va5C4.js"),__vite__mapDeps([465,1,2,3,358,7,8,113,10,11,12,13,5,6,37,14,15,9,114,30,115,26,116,359,84,85,86,40,27,28,29,32,33,87,88,25,31,34,35,36,22,38,39,89,90,16,17,91,4,360,361,191,192,362,363,217,218,219,275,252,253,188,189,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,180,21,170,216,364,172,173,174,152,153,154,155,156,151,141,157,365,248,366,282,281,283,284,285,128,127,169,147,148,167,24,110,111,112,117,118,119,120,121,122,123,124,125,126,129,130,131,132,133,134,135,136,137,138,139,140,142,143,144,145,146,149,150,158,159,160,161,162,163,164,165,166,168,171,367,280,286,287,288,289,290,291,215,368,213,205,206,207,208,369,370,371,372,203,199,193,175,316,184,373,186,187,343,344,374,375,376,377,378,379,380,308,183,381,382,240,383,18,19,20,384,385,386,307,272,198,387,388,315,179,181,194,195,196,197,200,201,202,204,209,210,211,212,214,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,242,243,244,245,246,247,249,250,251,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),wms:()=>ae(()=>import("./WMSLayerView3D-B3XPKzDq.js"),__vite__mapDeps([466,1,2,3,14,10,11,12,13,5,6,274,7,8,15,9,42,43,44,45,46,47,48,49,50,51,52,53,41,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,16,17,80,81,82,83,84,30,85,86,40,27,28,29,26,32,33,87,88,25,31,34,35,36,37,22,38,39,89,90,91,4,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,18,19,20,21,275,252,253,188,189,276,111,166,110,179,180,175,181,467,468,360,361,191,192,362,363]),import.meta.url),wmts:()=>ae(()=>import("./WMTSLayerView3D-DkIVt9Ab.js"),__vite__mapDeps([469,1,2,3,7,8,170,13,5,6,18,19,20,11,10,12,21,22,23,24,25,26,27,28,29,9,30,14,15,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,16,17,80,81,82,83,84,85,86,87,88,89,90,91,4,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,171,172,173,174,175,176,177,178,179,180,181,194,195,196,197,198,199,200,201,183,202,203,204,205,206,207,208,209,210,211,212,213,214,215,191,192,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,188,189,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269]),import.meta.url),"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};function wO(i){const e=i.declaredClass?i.declaredClass.slice(i.declaredClass.lastIndexOf(".")+1):"Unknown",t=e.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new xs(`${t}:view-not-supported`,`${e} is not supported in 3D`)}const h0={hasLayerViewModule:i=>l0[i.type]!=null,importLayerView:i=>{const e=l0[i.type];if(e==null)throw wO(i);return e(i)}},c0="analyses-owner-handles";var sl,Jn;(function(i){i[i.PENDING=0]="PENDING",i[i.CREATED=1]="CREATED"})(sl||(sl={})),function(i){i[i.ADDED=0]="ADDED",i[i.REMOVED=1]="REMOVED"}(Jn||(Jn={}));let Hn=class extends Re{constructor(e){super(e),this._allAnalysisViews=new Qr,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=d0(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(vr("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(vr()),this._attachedToViewResolver=d0()}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(t==null||t.state.list===Jn.REMOVED)throw new xs("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),c0)}_disconnectOwners(){this.removeHandles(c0),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const r of e)this._addAnalysis(r);const t=e.on("after-add",r=>this._addAnalysis(r.item)),s=e.on("after-remove",r=>this._removeAnalysis(r.item));return on(()=>{t.remove(),s.remove();for(const r of e)this._removeAnalysis(r)})}_addAnalysis(e){const t=this._items.get(e);if(t==null){const s={state:{view:sl.PENDING,list:Jn.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,s),s.createAnalysisViewTask=cc(r=>this._createAnalysisViewPromise(s,r))}else t.state.list=Jn.ADDED}_removeAnalysis(e){const t=this._items.get(e);t!=null?(t.state.list=Jn.REMOVED,this._scheduleUpdate()):Pe.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){this._scheduledUpdateHandle==null&&(this._scheduledUpdateHandle=RC(()=>this._update()))}_update(){this._scheduledUpdateHandle=Zr(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list===Jn.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case sl.PENDING:e.createAnalysisViewTask=Pn(e.createAnalysisViewTask);break;case sl.CREATED:e.view!=null&&(this._allAnalysisViews.remove(e.view),e.view=Y(e.view),e.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(e,t){const s=e.analysis,r=s.type,a=this._analysisModules[r];if(this._creatingViewCount+=1,a.module==null)try{a.module=await this._loadAnalysisModule(r)}catch(o){throw this._creatingViewCount-=1,o}if(xh(t))throw this._creatingViewCount-=1,vr("AnalysisView creation aborted");const n=new a.module.default({analysis:s,view:this.view});try{await n.when()}catch(o){throw this._creatingViewCount-=1,o}if(xh(t))throw this._creatingViewCount-=1,n.destroy(),vr("AnalysisView creation aborted");return e.view=n,e.state.view=sl.CREATED,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_loadAnalysisModule(e){switch(e){case"area-measurement":return ae(()=>import("./AreaMeasurementAnalysisView3D-DYr2gP3n.js"),__vite__mapDeps([470,1,2,3,471,472,10,11,12,13,5,6,39,29,14,473,474,7,8,9,239,57,43,41,4,15,16,17,78,90,91,64,68,61,53,69,59,60,70,71,67,72,475,476,428,429,124,430,425,30,427,34,248,83,73,80,66,81,82,58,76,77,79,477,123,242,478,479,50,426,28,150,32,33,480,195,481,255,482,483,196,197,484,485,486,42,44,45,46,47,48,49,51,52,54,55,56,62,63,65,74,75,84,85,86,40,27,26,87,88,25,31,35,36,37,22,38,89,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,158,129,130,111,166,110]),import.meta.url);case"dimension":return ae(()=>import("./DimensionAnalysisView3D-C_6tu--8.js"),__vite__mapDeps([487,1,2,3,7,8,473,29,11,488,30,14,10,12,13,5,6,15,9,40,195,472,39,239,61,60,69,53,59,70,43,41,71,90,16,17,91,4,84,85,86,27,28,26,32,33,87,88,25,31,34,35,36,37,22,38,89,482,57,483,427,248,83,73,428,429,124,430,425,196,197,484,78,489,242,150,490,50,58,79,72,68,80,66,81,82,76,77,243,42,44,45,46,47,48,49,51,52,54,55,56,62,63,64,65,67,74,75,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,222,110,111,491,492,163,164,479,426,276,166,493,180,494,495,496,459,497,498,499,486,500,424,316,191,192,217,218,115,116,219,184,170,203,199,422,362,175,501,502,485,158,129,123,130,503,504,505,364,423,506,507,508,223,480,481,255,24,112,113,114,117,118,119,120,121,122,125,126,127,128,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,151,152,153,154,155,156,157,159,160,161,162,165,167,168,169,171,478,509]),import.meta.url);case"direct-line-measurement":return ae(()=>import("./DirectLineMeasurementAnalysisView3D-DC3jUiUT.js"),__vite__mapDeps([510,1,2,3,471,472,10,11,12,13,5,6,39,29,14,473,474,7,8,478,4,9,15,16,17,80,61,60,53,41,68,69,59,70,43,71,66,81,72,82,58,76,77,78,79,242,239,90,91,427,34,57,248,83,73,428,429,124,430,425,30,28,150,32,33,480,195,481,255,511,482,483,196,197,484,485,486,42,44,45,46,47,48,49,50,51,52,54,55,56,62,63,64,65,67,74,75,84,85,86,40,27,26,87,88,25,31,35,36,37,22,38,89,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,158,129,123,130,234,194,159,183,235,236,500,497,110,111]),import.meta.url);case"line-of-sight":return ae(()=>import("./LineOfSightAnalysisView3D-oKU-PWMO.js"),__vite__mapDeps([512,1,2,3,7,8,9,473,29,11,30,14,10,12,13,5,6,15,513,40,390,320,391,197,392,22,298,27,28,83,73,180,4,16,17,24,25,26,31,32,33,34,35,36,37,38,39,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,74,75,76,77,78,79,80,81,82,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,248,249,250,243,478,490,222,514,498,483,202,196,203,199,204,205,206,207,208,209,210,211,212,213,214,215,191,192,200,20,216,217,218,219,220,221,223,224,19,21,225,226,227,228,229,230,231,232,233,507,492,479,426,485,486,499,509]),import.meta.url);case"slice":return ae(()=>import("./SliceAnalysisView3D-D0EdlXpS.js"),__vite__mapDeps([515,1,2,3,473,29,11,516,30,14,10,12,13,5,6,15,9,40,195,390,320,391,197,392,22,7,8,81,68,61,53,41,69,59,60,70,43,71,72,215,191,192,88,39,279,85,86,27,28,26,32,33,87,25,31,34,35,36,37,38,89,280,281,282,283,284,285,128,127,50,73,169,170,147,148,167,286,157,107,135,287,288,149,150,141,114,289,290,291,292,293,178,294,295,115,116,296,20,21,297,298,83,299,300,217,218,219,301,302,303,304,305,198,199,306,307,4,16,17,308,309,310,311,153,154,155,156,312,313,314,315,316,317,318,319,246,321,322,323,324,207,325,177,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,78,90,91,342,51,79,121,103,122,48,47,49,98,76,58,77,66,193,517,518,490,57,84,248,80,82,243,42,44,45,46,52,54,55,56,62,63,64,65,67,74,75,92,93,94,95,96,97,99,100,101,102,104,105,106,108,109,222,110,111,276,166,478,485,486,483,158,129,123,124,130,201,159,494,491,492,163,164,479,426,507,508,223,509]),import.meta.url);case"viewshed":return ae(()=>import("./ViewshedAnalysisView3D-CfhjLWq5.js"),__vite__mapDeps([519,1,2,3,7,8,473,29,11,32,33,9,61,60,57,43,428,429,124,430,14,10,12,13,5,6,15,69,53,59,70,41,71,490,30,50,34,58,4,16,17,79,72,68,84,85,86,40,27,28,26,87,88,25,31,35,36,37,22,38,39,89,90,91,248,83,73,80,66,81,82,76,77,78,243,42,44,45,46,47,48,49,51,52,54,55,56,62,63,64,65,67,74,75,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,222,150,110,111,491,492,163,164,479,426,485,486,483,158,129,123,130,195,518,520,521,496,459,497,498,507,422,203,199,508,223,509,194,196,197,198,200,20,24,112,113,114,115,116,117,118,119,120,121,122,125,126,127,128,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,151,152,153,154,155,156,157,159,160,161,162,165,166,167,168,169,170,171,201,183,202,180,204,205,206,207,208,209,210,211,212,213,214,215,191,192,216,217,218,219,220,221,224,19,21,225,226,227,228,229,230,231,232,233,234,235,236,237,172,173,174,238,239,240,241,242,244,245,246,247,249,250,251,252,253,188,189,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,175]),import.meta.url)}}};function d0(){const i=R_();return i.promise.catch(()=>{}),i}c([p()],Hn.prototype,"updating",null),c([p({constructOnly:!0})],Hn.prototype,"view",void 0),c([p()],Hn.prototype,"_allAnalysisViews",void 0),c([p()],Hn.prototype,"_creatingViewCount",void 0),Hn=c([F("esri.views.3d.analysis.AnalysisViewManager3D")],Hn);const xO=Hn;let ma=class extends Re{constructor(e){super(e),this.collision=new rh,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===$e.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==$e.Local?this._set("altitude",e):Pe.getLogger(this).warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?Z(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const s=this.tilt(e);return Z(t,s.min,s.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===$e.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,s=fp)=>(s.min=Ri.min,s.max=e,s)}_createDefaultTiltLocal(){const e=this.collision.enabled?yd([[4e3,Ri.max],[1e4,Tt(88)],[6e6,Tt(88)]]):()=>Ri.max;return(t,s=fp)=>(s.min=Ri.min,s.max=e(t),s)}_createDefaultTiltGlobal(){const e=this.collision.enabled?yd([[4e3,Ri.max],[5e4,Tt(88)],[6e6,Tt(88)],[2e7,Ri.min]]):yd([[3e5,Ri.max],[3e6,Tt(88)],[6e6,Tt(88)],[2e7,Ri.min]]);return(t,s=fp)=>(s.min=Ri.min,s.max=e(t),s)}};function CO(i){return{min:-2e5,max:4*i.radius}}c([p()],ma.prototype,"altitude",null),c([p({readOnly:!0})],ma.prototype,"collision",void 0),c([p()],ma.prototype,"distance",void 0),c([p({readOnly:!0})],ma.prototype,"minimumPoiDistance",void 0),c([p()],ma.prototype,"tilt",void 0),c([p({constructOnly:!0})],ma.prototype,"mode",void 0),ma=c([F("esri.views.3d.state.Constraints")],ma);const u0=CO(Ur),Ri={min:Tt(.5),max:Tt(179.5)},fp={min:0,max:0};let rh=class extends Re{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};c([p({type:Boolean})],rh.prototype,"enabled",void 0),c([p({type:Number})],rh.prototype,"elevationMargin",void 0),rh=c([F("esri.views.3d.state.Constraints.CollisionConstraint")],rh);let rl=class extends Uu{constructor(){super(...arguments),this.min=u0.min,this.max=u0.max}};c([p({type:Number})],rl.prototype,"min",void 0),c([p({type:Number})],rl.prototype,"max",void 0),rl=c([F("esri.views.3d.constraints.AltitudeConstraint")],rl);let va=class extends Uu{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};c([p({type:Number,value:1e-8})],va.prototype,"near",null),c([bl("near")],va.prototype,"castNear",null),c([p({type:Number,value:1e-8})],va.prototype,"far",null),c([bl("far")],va.prototype,"castFar",null),c([p({type:["auto","manual"]})],va.prototype,"mode",void 0),va=c([F("esri.views.3d.constraints.ClipDistanceConstraint")],va);const Hm={min:Zd(Ri.min),max:Zd(Ri.max)};let eo=class extends Uu{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return Z(e,Hm.min,Hm.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};c([p({type:["auto","manual"]})],eo.prototype,"mode",void 0),c([p({type:Number,value:Hm.max})],eo.prototype,"max",null),c([bl("max")],eo.prototype,"castMax",null),eo=c([F("esri.views.3d.constraints.TiltConstraint")],eo);let to=class extends Uu{constructor(){super(...arguments),this.tilt=new eo,this.altitude=new rl,this.clipDistance=new va}};c([p({type:eo})],to.prototype,"tilt",void 0),c([p({type:rl})],to.prototype,"altitude",void 0),c([p({type:va})],to.prototype,"clipDistance",void 0),to=c([F("esri.views.3d.constraints.Constraints")],to);var Zo;let Qa=Zo=class extends Pr.EventedMixin(m1){constructor(i){super(i),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const e=new Date().getFullYear(),t=new Date("March 15, "+e+" 12:00:00 UTC");this._set("defaultDate",t),this._set("date",t)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(i){return new Zo(i.cloneConstructProperties())}set defaultDate(i){const e=this._get("date")===this._get("defaultDate");i=new Date(i.getTime()),this._set("defaultDate",i),e&&this._set("date",i)}set date(i){i!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(i.getTime())))}autoUpdate(i,e){const t=Zo.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=e.hours,this.positionTimezoneInfo.minutes=e.minutes,this.positionTimezoneInfo.seconds=e.seconds;let s=null;i!=null&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(i.getTime())?(s=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(s=this.date&&this.date.getTime(),this._set("date",new Date(i.getTime()))));const r=Zo.calculateTimezoneOffset(this.positionTimezoneInfo);if(t!==r&&(Oc.target=this,Oc.timezoneOffset=r,this.emit("timezone-will-change",Oc),Oc.target=null),i!=null)return isNaN(i.getTime())||s!==i.getTime()}clone(){const i=this._get("date")===this._get("defaultDate"),e=new Zo({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled});return i&&e._set("date",e._get("defaultDate")),e.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,e.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,e.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,e.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,e}cloneWithWebsceneLighting(i){const e=this.clone();return i.date!=null&&(e.date=i.date),e.directShadowsEnabled=i.directShadowsEnabled,e.displayUTCOffset=i.displayUTCOffset,e}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};c([p({type:Boolean})],Qa.prototype,"cameraTrackingEnabled",void 0),c([p({type:Date})],Qa.prototype,"defaultDate",null),c([p({type:Date})],Qa.prototype,"date",null),Qa=Zo=c([F("esri.views.3d.environment.SunLighting")],Qa),function(i){function e({hours:t,minutes:s,seconds:r}){return Math.round(t+s/60+r/3600)}i.calculateTimezoneOffset=e}(Qa||(Qa={}));const Oc={target:null,timezoneOffset:0},Gn=Qa;var wd;let xd=wd=class extends Pr.EventedMixin(_1){constructor(i){super(i),this.cameraTrackingEnabled=!0}clone(){return new wd({...this.cloneConstructProperties(),cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(i){return new wd(i.cloneConstructProperties())}cloneWithWebsceneLighting(i){const e=this.clone();return e.directShadowsEnabled=i.directShadowsEnabled,e}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};c([p({type:Boolean})],xd.prototype,"cameraTrackingEnabled",void 0),xd=wd=c([F("esri.views.3d.environment.VirtualLighting")],xd);const ah=xd,TO={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Gn,virtual:ah}};var Gm;let Rh=Gm=class extends Re{set quality(i){["low","high"].includes(i)&&this._set("quality",i)}clone(){return new Gm({quality:this.quality})}};c([p({type:["low","high"],value:"low"})],Rh.prototype,"quality",null),Rh=Gm=c([F("esri.views.3d.environment.SceneViewAtmosphere")],Rh);var nh;let Ko=nh=class extends g1{constructor(i){super(i),this.atmosphere=new Rh,this.lighting=this.castLighting(),this.cachedCameraTrackingEnabled=null}destroy(){this.atmosphere.destroy()}static fromWebsceneEnvironment(i){const e=i.cloneConstructProperties();return new nh({...e,lighting:e.lighting?e.lighting.type==="virtual"?ah.fromWebsceneLighting(e.lighting):Gn.fromWebsceneLighting(e.lighting):void 0})}castLighting(i){return this._convertLightingWithDestroy(i)}applyLighting(i){this.lighting=this._convertLightingWithDestroy(i)}_convertLightingWithDestroy(i){const e=this._convertLighting(i);return e!==i&&this.addHandles(yC(e)),e}_convertLighting(i){var e,t;return i?i instanceof Gn||i instanceof ah?i:i instanceof m1?this.lighting&&this.lighting.type!=="virtual"?this.lighting.cloneWithWebsceneLighting(i):new Gn({...i.cloneConstructProperties(),...(e=this.lighting)==null?void 0:e.cloneNonPersistentConstructProperties()}):i instanceof _1?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(i):new ah({...i.cloneConstructProperties(),...(t=this.lighting)==null?void 0:t.cloneNonPersistentConstructProperties()}):bC(TO,i):new Gn}clone(){return new nh({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:xm(this.background)})}cloneWithWebsceneEnvironment(i){return new nh({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:xm(this.background),...i.cloneConstructProperties(),lighting:this._getLighting(i)})}_getLighting(i){switch(i.lighting.type){case"sun":return this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(i.lighting):Gn.fromWebsceneLighting(i.lighting);case"virtual":return this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(i.lighting):ah.fromWebsceneLighting(i.lighting);default:return Cl(i.lighting),Gn.fromWebsceneLighting(i.lighting)}}};c([p({type:Rh,json:{read:!1},nonNullable:!0})],Ko.prototype,"atmosphere",void 0),c([p({nonNullable:!0})],Ko.prototype,"lighting",void 0),c([bl("lighting")],Ko.prototype,"castLighting",null),Ko=nh=c([F("esri.views.3d.environment.SceneViewEnvironment")],Ko);const Jo=Ko;var Ni;(function(i){i[i.Realistic=0]="Realistic",i[i.Local=1]="Local",i[i.Mars=2]="Mars",i[i.None=3]="None"})(Ni||(Ni={}));function ag(i){return Z((i-1e5)/9e5,0,1)}const km=1e4,SO=.085,en=1e5,_l=St(parseFloat(5802e-9.toFixed(6)),parseFloat(13558e-9.toFixed(6)),parseFloat(331e-7.toFixed(6))),vp=3,yp=St(vp*parseFloat(65e-8.toFixed(6)),vp*parseFloat(1881e-9.toFixed(6)),vp*parseFloat(85e-9.toFixed(6))),PO=3996e-9,RO=St(parseFloat(Number(_l[0]+yp[0]).toFixed(6)),parseFloat(Number(_l[1]+yp[1]).toFixed(6)),parseFloat(Number(_l[2]+yp[2]).toFixed(6)));function cb(i){const e=new Dt;e.attributes.add(Te.POSITION,"vec2"),e.include(qu,{textureCoordinateType:yn.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");const{vertex:t,fragment:s}=e;return t.uniforms.add(new Ji("inverseProjectionMatrix",(r,a)=>a.camera.inverseProjectionMatrix),new Ji("inverseViewMatrix",(r,a)=>Ml(OO,a.camera.viewMatrix))),t.code.add(v`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),s.uniforms.add(new Ei("backgroundColor",r=>r.backgroundColor),new Bi("radii",r=>r.radii),new Ei("cameraPosition",(r,a)=>a.camera.eye),new cn("heightParameters",r=>r.heightParameters),new He("innerFadeDistance",r=>r.innerFadeDistance),new He("altitudeFade",r=>r.altitudeFade),new Fe("depthTexture",r=>r.depthTexture),new He("hazeStrength",r=>r.hazeStrength)),s.constants.add("betaRayleigh","vec3",_l),s.constants.add("betaCombined","vec3",RO),s.constants.add("betaMie","float",PO),s.constants.add("scaleHeight","float",SO*en),q_(s),e.include(G_),i.haze&&s.include(uc),s.code.add(v`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),s.code.add(v`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),s.code.add(v`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),s.code.add(v`
    const int STEPS = 6;

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${i.haze?v`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${i.haze?"":v`mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * `} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${i.haze?"":v`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;

      ${i.haze?v`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:v`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    ${i.haze?"":v`
            vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
              vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
              if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
                return fragColor;
              }

              float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
              vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
              float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
              if (relDist > 1.0) {
                return surfaceColor;
              }

              return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
            }

            float getGlow(float dist, float radius, float intensity) {
              return pow(radius / max(dist, 1e-6), intensity);
            }

            vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){

              // Get the amount of atmosphere between camera and the Sun along the view ray
              float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
              float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));

              // Find the amount of light that remains after travelling through the atmosphere from the Sun along the view ray
              // This will make the colour of the Sun reddish on the horizon and white from space
              vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));

              // Alignment of light direction and view ray
              float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
              // Draw the Sun as a bright disc
              float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));

              return normalize(sunTransmittance) * sunDisc;
            }`}

    ${i.haze&&i.reduced?v`
        float getDepth(vec2 uv){
          return linearDepthFromTexture(depthTexture, uv);
        }

        float textureBilinear(vec2 uv) {
          // Information about the high-resolution depth texture
          vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
          vec2 texelSize = 1.0 / depthTextureSize;

          // The uv inside the upper right pixel - of the tile of 4 pixels -
          // that the atmosphere uv maps to in the depth texture
          vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);

          // Relative distance of the uv coordinates inside the depth texture pixel
          vec2 f = fract(depthUV);

          // Snap to the centre of the depth texture pixel
          vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;

          // Read the depth texture pixel and its three neighbours
          float d0 = getDepth(snapUV);
          float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
          float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
          float d3 = getDepth(snapUV + texelSize);

          // Return the bilinearly interpolated value of the neighbouring pixels based
          // on the sample position in the depth texture pixel
          return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
        }
        `:""}

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${i.haze?v`
          float depthSample = texture(depthTexture, vuv0).r;
          if (depthSample != 1.0) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;

              ${i.reduced?v`cameraSpaceRay *= -textureBilinear(vuv0);`:v`cameraSpaceRay *= -linearDepthFromTexture(depthTexture, vuv0);`}

            terrainDepth = max(0.0, length(cameraSpaceRay));
          }else{
            discard;
          }
          `:v`${i.reduced?"":v`
                float depthSample = texture(depthTexture, vuv0).r;
                if (depthSample != 1.0) {
                  fragColor = vec4(0);
                  return;
                }`}`}

      ${i.haze?v`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != 1.0){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);
            }
            // Alpha is ignored for haze blending
            float alpha = 1.0;
            `:v`
            vec3 col = linearizeGamma(backgroundColor);
            col += getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);
            col += getSun(cameraPosition, rayDir, mainLightDirection);
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      ${i.haze?"":v`fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);`}
    }
  `),e}const OO=Qe(),MO=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:_l,build:cb},Symbol.toStringTag,{value:"Module"}));let EO=class extends ri{constructor(){super(...arguments),this.heightParameters=mi(),this.radii=Hi(),this.innerFadeDistance=0,this.altitudeFade=0,this.hazeStrength=1,this.renderScale=Hi(),this.backgroundColor=b()}},oh=class db extends It{initializeProgram(e){return new Lt(e.rctx,db.shader.get().build(this.configuration),pt)}initializePipeline(){return this.configuration.reduced?ot({blending:ta(K.ONE,K.ZERO),depthTest:{func:Xi.ALWAYS},colorWrite:ht}):this.configuration.haze?ot({blending:Ss(K.ONE,K.ZERO,K.ONE_MINUS_SRC_COLOR,K.ONE),colorWrite:ht}):ot({blending:ta(K.SRC_ALPHA,K.ONE_MINUS_SRC_ALPHA),depthTest:{func:Xi.LEQUAL},colorWrite:ht})}};oh.shader=new $t(MO,()=>ae(()=>Promise.resolve().then(()=>H5),void 0,import.meta.url));let ub=class extends tr{constructor(){super(...arguments),this.haze=!1}};c([z()],ub.prototype,"haze",void 0);let pb=class extends ub{constructor(){super(...arguments),this.reduced=!1}};c([z()],pb.prototype,"reduced",void 0);new ru(Te.POSITION,3,Da.FLOAT,0,12);const ng=[new ru(Te.POSITION,2,Da.FLOAT,0,8)],fc=[new ru(Te.POSITION,2,Da.FLOAT,0,16),new ru(Te.UV0,2,Da.FLOAT,8,16)];function ra(i,e=ng,t=pt,s=-1,r=1){let a=null;return e===fc?a=new Float32Array([s,s,0,0,r,s,1,0,s,r,0,1,r,r,1,1]):a=new Float32Array([s,s,r,s,s,r,r,r]),new Rn(i,t,{geometry:e},{geometry:Ls.createVertex(i,xr.STATIC_DRAW,a)})}const AO=4;function mb(i){const e=new gi(AO);return e.samplingMode=Zs.NEAREST,new Yi(i,e)}let og=class extends ri{};function _b(i){const e=new Dt;e.include(Ps),e.fragment.uniforms.add(new Fe("colorTexture",s=>s.color),new Fe("depthTexture",s=>s.depth));const t=i.haze;return e.fragment.code.add(v`
    void main() {
      float depthSample = texture(depthTexture, uv).r;
      if (depthSample ${t?v`== 1.0`:v`!= 1.0`} ) {
          fragColor = vec4(0);
          return;
      }
      fragColor = texture(colorTexture, uv);
    }
    `),e}const DO=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:og,build:_b},Symbol.toStringTag,{value:"Module"}));let jm=class gb extends It{initializeProgram(e){return new Lt(e.rctx,gb.shader.get().build(this.configuration),pt)}initializePipeline(){return this.configuration.haze?ot({blending:Ss(K.ONE,K.ZERO,K.ONE_MINUS_SRC_COLOR,K.ONE),depthTest:{func:Xi.ALWAYS},colorWrite:ht}):ot({blending:ta(K.SRC_ALPHA,K.ONE_MINUS_SRC_ALPHA),depthTest:{func:Xi.ALWAYS},colorWrite:ht})}};jm.shader=new $t(DO,()=>ae(()=>Promise.resolve().then(()=>G5),void 0,import.meta.url));let $O=class{constructor(e,t){this._view=e,this._context=t,this.type=Ni.Realistic,this._handles=new $u,this._compositingPassParameters=new og,this._passParameters=new EO,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=Ur.radius,this._fadeHaze=0,this._updateRadius(Ur.radius);const s=this._context.renderContext.rctx;this._updateRootTileElevationBounds(),this._handles.add([M(()=>{var a,n;return(n=(a=this._view)==null?void 0:a.basemapTerrain)==null?void 0:n.rootTileElevationBounds},()=>{var a;return(a=this._view)!=null&&a.basemapTerrain?this._updateRootTileElevationBounds():null}),M(()=>{var a,n;return(n=(a=this._view)==null?void 0:a.basemapTerrain)==null?void 0:n.visibleElevationBounds},()=>{var a;return(a=this._view)!=null&&a.basemapTerrain?this._updateVisibleElevationBounds():null}),M(()=>{var a;return(a=this._view)==null?void 0:a.environment.background},a=>{const n=a instanceof $S?Gh(a.color):V_;it(this._passParameters.backgroundColor,n[0]*n[3],n[1]*n[3],n[2]*n[3])},ut)]);const r=new pb;r.haze=!1,this._atmosphereTechnique=this._context.techniques.acquire(oh,r),this._compositingTechnique=this._context.techniques.acquire(jm,r),r.haze=!0,this._atmosphereHazeTechnique=this._context.techniques.acquire(oh,r),this._compositingHazeTechnique=this._context.techniques.acquire(jm,r),r.reduced=!0,r.haze=!1,this._atmosphereReducedTechnique=this._context.techniques.acquire(oh,r),r.haze=!0,this._atmosphereHazeReducedTechnique=this._context.techniques.acquire(oh,r),this._vao=ra(s,fc)}destroy(){this._handles.destroy(),this._compositingTechnique.release(),this._compositingHazeTechnique.release(),this._atmosphereTechnique.release(),this._atmosphereHazeTechnique.release(),this._atmosphereReducedTechnique.release(),this._atmosphereHazeReducedTechnique.release(),this._vao.dispose()}render(e,t){this._render(e,t?this._atmosphereTechnique:this._atmosphereReducedTechnique,t,!1)}renderHaze(e,t,s){this._fadeHaze=t,this._render(e,s?this._atmosphereHazeTechnique:this._atmosphereHazeReducedTechnique,s,!0)}_render(e,t,s,r){const a=e.bindParameters.mainDepth;if(!a)return;this._update(e.bindParameters.camera),this._passParameters.depthTexture=a;const n=e.rctx.bindTechnique(t,e.bindParameters,this._passParameters),o=e.offscreenRenderingHelper;if(s)o.renderDepthDetached(()=>this._renderCommon(n,e));else{const l=e.rctx.getViewport(),h=xe(e.bindParameters.camera.eye)-Ur.radius;let d;if(h<en){const g=Math.min(1,Math.max(0,h/en));d=r?Be(.4,.5,g):Be(.2,.3,g)}else{const g=Math.min(1,Math.max(0,(h-en)/(15*en)));d=r?Be(.5,1,g):Be(.3,.6,g)}const u=su(Math.round(d*e.bindParameters.camera.fullViewport[2])),m=su(Math.round(d*e.bindParameters.camera.fullViewport[3]));e.rctx.setViewport(0,0,u,m);const _=o.renderToCachedFBO(null,r?"chapman haze":"chapman",()=>this._renderCommon(n,e),[0,0,0,1],ni.RGBA,null,u,m);e.rctx.setViewport(l.x,l.y,l.width,l.height),this._compositingPassParameters.color=_.getTexture(),this._compositingPassParameters.depth=a;const f=r?this._compositingHazeTechnique:this._compositingTechnique;e.rctx.bindTechnique(f,e.bindParameters,this._compositingPassParameters),o.renderDepthDetached(()=>e.rctx.screen.draw()),_.release()}}_renderCommon(e,t){this._vao!=null&&(t.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),t.rctx.drawArrays(Ai.TRIANGLE_STRIP,0,4))}_updateRootTileElevationBounds(){const e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=Ur.radius,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=IO(Ur.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,Aa(this._passParameters.radii,e,e+en),this._passParameters.innerFadeDistance=2*Math.sqrt((2*e-km)*km)}_update(e){if(!e)return;const t=gr(e.eye),s=Math.sqrt(t),r=t-this._passParameters.radii[1]*this._passParameters.radii[1],a=Z((s-this._passParameters.radii[0])/en,0,1);vn(this._passParameters.heightParameters,s,t,r,a),this._passParameters.altitudeFade=ag(s-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=Be(Be(.6,1,Vh(9500,10500,s-Ur.radius)),1,this._fadeHaze)}};function IO(i){return i*Math.cos(Math.PI/16/16)}function fb(){const i=new Dt,{attributes:e,varyings:t,vertex:s,fragment:r}=i;return e.add(Te.POSITION,"vec2"),t.add("worldRay","vec3"),s.uniforms.add(new Ji("inverseProjectionMatrix",(a,n)=>n.camera.inverseProjectionMatrix),new Ji("inverseViewMatrix",(a,n)=>Ml(LO,n.camera.viewMatrix))),s.code.add(v`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),r.include(b1),r.include(_c),i.include(pR,{pbrMode:Qt.Disabled,lightingSphericalHarmonicsOrder:2}),i.include(qS),i.include(G_),i.include(zS),i.include(yP),r.uniforms.add(new Ei("cameraPosition",(a,n)=>n.camera.eye)),r.code.add(v`void main() {
vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),i}const LO=Qe(),NO=Object.freeze(Object.defineProperty({__proto__:null,build:fb},Symbol.toStringTag,{value:"Module"}));let vb=class yb extends It{constructor(e){super(e,new tr,()=>this.destroy())}initializeProgram(e){return new Lt(e.rctx,yb.shader.get().build(),pt)}initializePipeline(){return ot({blending:Ss(K.ONE,K.ZERO,K.SRC_ALPHA,K.ONE),depthTest:{func:Xi.LEQUAL},colorWrite:ht})}};vb.shader=new $t(NO,()=>ae(()=>Promise.resolve().then(()=>k5),void 0,import.meta.url));let kn=class extends Re{constructor(e){super(e),this._technique=new vb(e),this._vao=ra(e.rctx)}destroy(){this._technique=tt(this._technique),this._vao=je(this._vao)}render(e){if(!this._technique.compiled)return void this.requestRender();const t=e.bindParameters.cloudsFade;if(this._vao==null||t.data==null)return;const s=e.rctx.bindTechnique(this._technique,e.bindParameters,FO);e.rctx.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(Ai.TRIANGLE_STRIP,0,4)}};c([p({constructOnly:!0})],kn.prototype,"rctx",void 0),c([p({constructOnly:!0})],kn.prototype,"viewingMode",void 0),c([p({constructOnly:!0})],kn.prototype,"planetRadius",void 0),c([p({constructOnly:!0})],kn.prototype,"requestRender",void 0),kn=c([F("esri.views.3d.environment.CloudsComposition")],kn);const FO=new ri;var ls;(function(i){i[i.SIXTEEN=0]="SIXTEEN",i[i.HUNDRED=1]="HUNDRED",i[i.TWOHUNDRED=2]="TWOHUNDRED",i[i.COUNT=3]="COUNT"})(ls||(ls={}));let Cd=class extends tr{constructor(){super(...arguments),this.steps=ls.SIXTEEN,this.writeTextureChannels=k_.RG}};c([z({count:ls.COUNT})],Cd.prototype,"steps",void 0),c([z({constValue:li("esri-mobile")?1024:2048})],Cd.prototype,"cubeMapSize",void 0),c([z()],Cd.prototype,"writeTextureChannels",void 0);let lh=class{constructor(e,t,s,r,a,n,o,l,h=.5){this.coverage=e,this.density=t,this.absorption=s,this.cloudSize=r,this.detailSize=a,this.smoothness=n,this.cloudHeight=o,this.raymarchingSteps=l,this.median=h}};const p0=new lh([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],ls.SIXTEEN),Li={sunny:p0,cloudy:new lh([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],ls.TWOHUNDRED,.6),rainy:new lh([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],ls.TWOHUNDRED,.4),snowy:new lh([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],ls.HUNDRED,.65),foggy:new lh([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],ls.SIXTEEN),default:p0},Gs=li("esri-mobile")?64:128,VO=Gs/128,dr=Math.ceil(Math.sqrt(Gs)),dn=(Gs+2)*dr,UO=1e5,bp=128,qO=dn/1560;let lg=class extends ri{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.raymarchingSteps=Li.default.raymarchingSteps,this.weatherTile=Hi(),this.viewMatrix=La()}};function bb(i){const e=new Dt;e.include(Ps,!1);const t=e.fragment;return t.uniforms.add(new He("cloudRadius",s=>s.cloudRadius),new He("power",s=>Be(35,120,s.absorption)),new He("sigmaE",s=>1+s.absorption),new He("density",s=>Be(0,.3,s.density)),new He("cloudSize",s=>Be(0,.02,Math.max(.01,1-s.cloudSize))),new He("detailSize",s=>Be(0,.2,Math.max(.01,1-s.detailSize))),new He("smoothness",s=>Be(0,.5,1-s.smoothness)),new He("cloudHeight",s=>Be(0,1500,s.cloudHeight)),new He("coverage",s=>s.coverage),new UR("view",s=>s.viewMatrix),new Fe("cloudShapeTexture",s=>s.noiseTexture!=null?s.noiseTexture.textureAtlas:null),new Bi("cloudVariables",s=>Aa(zO,s.coverage,s.absorption))),t.constants.add("halfCubeMapSize","float",.5*i.cubeMapSize),t.code.add(v`
    const int STEPS = ${i.steps===ls.SIXTEEN?v`16`:i.steps===ls.HUNDRED?v`100`:v`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),t.code.add(v`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${v.float(dn)};
      const float dataWidth = ${v.float(dn)};
      const float tileRows = ${v.float(dr)};
      const vec3 atlasDimensions = vec3(${v.float(Gs)}, ${v.float(Gs)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${v.float(VO)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${v.float(qO)} * p) / ${v.float(dn)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),t.code.add(v`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),t.code.add(v`vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = dot(start, start) - (radius * radius);
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}
float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}`),t.code.add(`
    float multipleOctaves(float extinction, float mu, float stepL) {
      float attenuation = 1.0;
      float contribution = 1.0;
      float phaseAttenuation = 1.0;
      float luminance = 0.0;

      for (int i = 0; i < 4; i++) {
        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
        attenuation *= 0.2;
        contribution *= 0.6;
        phaseAttenuation *= 0.5;
      }

      return luminance;
    }`),t.code.add(v`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),t.code.add(v`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),t.code.add(v`void main() {
if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
if (hitsPlanet) {
shading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);
totalTransmittance = hazeFactor;
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
return;
}
vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
}`),e}const zO=Hi(),BO=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:lg,build:bb},Symbol.toStringTag,{value:"Module"}));let wb=class xb extends It{constructor(e,t){super(e,t,()=>this.destroy())}initializeProgram(e){return new Lt(e.rctx,xb.shader.get().build(this.configuration),pt)}initializePipeline(){return ot({blending:ta(K.CONSTANT_COLOR,K.ONE_MINUS_CONSTANT_COLOR,fP.ADD,this.configuration.writeTextureChannels===k_.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:Xi.LEQUAL},colorWrite:ht})}};wb.shader=new $t(BO,()=>ae(()=>Promise.resolve().then(()=>j5),void 0,import.meta.url));var Is;(function(i){i[i.Full=0]="Full",i[i.WeatherMap=1]="WeatherMap",i[i.COUNT=2]="COUNT"})(Is||(Is={}));let Wm=class extends tr{constructor(){super(...arguments),this.mode=Is.Full}};c([z({count:Is.COUNT})],Wm.prototype,"mode",void 0);let hg=class extends ri{constructor(){super(...arguments),this.weatherTile=U_(0,0)}};function Cb(i){const e=new Dt;return e.include(Ps,!1),e.fragment.code.add(v`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),i.mode===Is.Full&&e.fragment.code.add(v`
    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    // Safer modulo for positive and negative values
    vec3 modulo(vec3 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec3 hash(vec3 p3, float frequency){
      p3 = modulo(p3, frequency);
      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yxz + 33.33);
      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
    }

    // 5th order polynomial interpolation
    vec3 fade(vec3 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec3 p, float frequency){
      // Cell point is in
      vec3 i = floor(p);

      // Position in the cell in [0, 1]
      vec3 f = fract(p);

      // Interpolation value for gradient mixing
      vec3 u = fade(f);

      // Trilinear interpolation of gradients at cube vertices around point
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequencyFactor = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${v.float(dr)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${v.float(8)});

      float worley0 = worley(p, ${v.float(2)} * 2.0);
      float worley1 = worley(p, ${v.float(2)} * 8.0);
      float worley2 = worley(p, ${v.float(2)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${v.float(2)});
      float worley1 = worley(p, ${v.float(2)} * 2.0);
      float worley2 = worley(p, ${v.float(2)} * 4.0);
      float worley3 = worley(p, ${v.float(2)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `),e.fragment.uniforms.add(new Bi("weatherTile",t=>t.weatherTile)),e.fragment.code.add(v`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${v.float(bp)});

      // Get global coordinates of p
      p += weatherTile * ${v.float(bp)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${v.float(UO)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),e.fragment.code.add(v`void main() {`),i.mode===Is.Full&&e.fragment.code.add(v`
        float padWidth = 1.0;
        float paddedSize = ${v.float(Gs)} + 2.0 * padWidth;
        float tileCount = ${v.float(dr)} * ${v.float(dr)};
        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

        bool padCell = false;
        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        bool startPadX = false;
        bool startPadY = false;
        bool endPadX = false;
        bool endPadY = false;

        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
          startPadX = true;
        }

        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
          startPadY = true;
        }

        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
          endPadX = true;
        }

        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
          endPadY = true;
        }

        vec2 padding = vec2(2.0 * padWidth) * tile;
        vec2 uv;

        if (padCell) {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;

          if (startPadX) {
            pixel.x += ${v.float(Gs)};
          }

          if (startPadY) {
            pixel.y += ${v.float(Gs)};
          }

          if (endPadX) {
            pixel.x -= ${v.float(Gs)};
          }

          if (endPadY) {
            pixel.y -= ${v.float(Gs)};
          }

          uv = vec2(pixel.xy / ${v.float(Gs)});
        } else {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;
          uv = vec2(pixel.xy / ${v.float(Gs)});
        }

        vec3 p_ = get3Dfrom2D(uv);
        vec3 p = p_;
        p.z /= (${v.float(dr)} * ${v.float(dr)});

        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        float worleyNoise = getTextureForPointWorley(p);

        fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

        p_ = mod(p_ + 1.0, ${v.float(dr)} * ${v.float(dr)});
        p = p_;
        p.z /= (${v.float(dr)} * ${v.float(dr)});

        worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        worleyNoise = getTextureForPointWorley(p);

        fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
      `),e.fragment.code.add(v`
      vec2 mapUV = ${v.float(bp)} * (gl_FragCoord.xy / ${v.float(dn)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);

      ${i.mode===Is.Full?v`fragColor.ba = vec2(0.0, map);`:v`fragColor = vec4(map);`};
    }
  `),e}const HO=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:hg,build:Cb},Symbol.toStringTag,{value:"Module"}));let Qm=class Tb extends It{initializeProgram(e){return new Lt(e.rctx,Tb.shader.get().build(this.configuration),pt)}initializePipeline(){return ot({blending:this.configuration.mode===Is.Full?ta(K.ONE,K.ZERO):Ss(K.ZERO,K.ONE,K.ONE,K.ZERO),depthTest:{func:Xi.ALWAYS},colorWrite:ht})}};Qm.shader=new $t(HO,()=>ae(()=>Promise.resolve().then(()=>W5),void 0,import.meta.url));let hh=class extends Re{constructor(e){super(e),this._needsRender=!0,this._passParameters=new hg,this._fbo=new mc(e.context.renderContext.rctx,new gi(dn)),this._vao=ra(e.context.renderContext.rctx)}get _techniques(){return this.context.techniques}get textureAtlas(){return this._texture!=null?this._weatherMapTechnique!=null&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(Is.WeatherMap)):this._fullTechnique!=null&&this._fullTechnique.compiled&&(this._texture=this._render(Is.Full)),this._texture}_setDirty(){this._needsRender=!0}updateWeatherMap(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||(fn(this._passParameters.weatherTile,e),this._setDirty())}destroy(){this._fullTechniqueCached=tt(this._fullTechniqueCached),this._weatherMapTechniqueCached=tt(this._weatherMapTechniqueCached),this._fbo=je(this._fbo),this._vao=je(this._vao)}get _fullTechnique(){if(this._fullTechniqueCached==null){const e=new Wm;e.mode=Is.Full,this._fullTechniqueCached=this._techniques.acquire(Qm,e)}return this._fullTechniqueCached}get _weatherMapTechnique(){if(this._weatherMapTechniqueCached==null){const e=new Wm;e.mode=Is.WeatherMap,this._weatherMapTechniqueCached=this._techniques.acquire(Qm,e)}return this._weatherMapTechniqueCached}_render(e){if(this._vao==null||this._fbo==null)return null;const t=e===Is.Full?this._fullTechnique:this._weatherMapTechnique,s=this.context.renderContext.rctx,r=s.getViewport();s.setViewport(0,0,dn,dn),s.bindFramebuffer(this._fbo);const a=s.bindTechnique(t,null,this._passParameters);return s.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),s.gl.drawArrays(s.gl.TRIANGLE_STRIP,0,4),s.setViewport(r.x,r.y,r.width,r.height),this._needsRender=!1,this._fbo.colorTexture}};c([p({constructOnly:!0})],hh.prototype,"context",void 0),c([p({readOnly:!0})],hh.prototype,"_techniques",null),hh=c([F("esri.views.3d.environment.NoiseTextureAtlas")],hh);let ts=class extends Re{constructor(e){super(e),this._techniques=new Array,this._techniqueConfiguration=new Cd,this._bindParameters=new j_(null,null),this._passParameters=new lg,this._weatherTile=Hi(),this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this.coverage=Be(Li.default.coverage[0],Li.default.coverage[1],.5),this.density=Be(Li.default.density[0],Li.default.density[1],.5),this.absorption=Be(Li.default.absorption[0],Li.default.absorption[1],.5),this.cloudSize=Be(Li.default.cloudSize[0],Li.default.cloudSize[1],.5),this.detailSize=Be(Li.default.detailSize[0],Li.default.detailSize[1],.5),this.smoothness=Be(Li.default.smoothness[0],Li.default.smoothness[1],.5),this.cloudHeight=Be(Li.default.cloudHeight[0],Li.default.cloudHeight[1],.5),this.raymarchingSteps=Li.default.raymarchingSteps,this._viewMatrix=Qe(),this._dirty=!1,this.running=!1,this._vao=ra(e.context.renderContext.rctx)}_getTechnique(e){const t=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,s=t===k_.RG?2*e:2*e+1;return this._techniques[s]||(this._techniqueConfiguration.writeTextureChannels=t,this._techniqueConfiguration.steps=e,this._techniques[s]=new wb({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[s])}updateWeatherTile(){const e=this.view.camera.position.latitude,t=this.view.camera.position.longitude;if(e==null||t==null)return;Aa(this._weatherTile,(e+90)/180,(t+180)/360);const s=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-s)*this._weatherTile[1]);let r=0,a=0;if(this.view.environment!=null&&this.view.environment.lighting.type!=="virtual"&&this.view.environment.lighting.date!=null){const n=new Date(this.view.environment.lighting.date);n.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(this.view.environment.lighting.displayUTCOffset??0)),r=31*n.getUTCMonth()+n.getUTCDate(),a=n.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+r)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+a%100)%(4*this._weatherTileCount),LS(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}initialize(){const e=Ut(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius,this.setDirty(),this.updateWeatherTile(),this.addHandles([this.view.resourceController.scheduler.registerTask(ci.CLOUDS_GENERATOR,this),M(()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps],()=>this.setDirty(),si)])}destroy(){this._techniques.forEach(e=>tt(e)),this._frameBufferCube=je(this._frameBufferCube),this._techniques.length=0,this._vao.dispose(),this._passParameters.noiseTexture=Y(this._passParameters.noiseTexture)}get _tilesPerFace(){switch(this._techniqueConfiguration.steps){case ls.SIXTEEN:return 1;case ls.HUNDRED:return 4;case ls.COUNT:case ls.TWOHUNDRED:return 8}}get usedMemory(){var e,t,s;return(((e=this._frameBufferCube)==null?void 0:e.usedMemory)??0)+(((s=(t=this._passParameters.noiseTexture)==null?void 0:t.textureAtlas)==null?void 0:s.usedMemory)??0)}_ensureNoiseTexture(){var e;return(e=this._passParameters).noiseTexture??(e.noiseTexture=new hh({context:this.context})),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile),this._passParameters.noiseTexture.textureAtlas!=null}_ensureFrameBufferCube(e){if(this._frameBufferCube==null){const t=new gi(e);t.target=Lm.TEXTURE_CUBE_MAP,t.wrapMode=Ki.CLAMP_TO_EDGE,this._frameBufferCube=new mc(this.context.renderContext.rctx,t)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}destroyFrameBufferCube(){this._frameBufferCube=je(this._frameBufferCube)}applyPreset(e,t){const s=e.median,r=a=>{const n=Be(a[0],a[1],s);return t<.5?Be(a[0],n,2*t):Be(n,a[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}setDirty(){this._dirty=this.running=!0}runTask(e){this._faceIndex===0&&this._tileIndex===0&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),fn(this._passParameters.weatherTile,this._weatherTile));const t=this._getTechnique(this._passParameters.raymarchingSteps);if(!t.compiled)return Zi;if(this.context.renderContext.bindParameters.cloudsFade.fadeMode===Qh.CROSS_FADE||!this._ensureNoiseTexture())return Zi;this._faceIndex===0&&this._tileIndex===0&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=Fm.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);const s=GO[this._faceIndex],r=kO[this._faceIndex];JP(this._viewMatrix,jO,s,r),L1(this._passParameters.viewMatrix,this._viewMatrix);const a=this.context.renderContext.rctx,n=a.bindTechnique(t,this._bindParameters,this._passParameters);a.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao);const o=a.getViewport(),l=t.configuration.cubeMapSize,h=l/this._tilesPerFace,d=this._tileIndex*h;a.setViewport(0,d,l,h);const u=this._ensureFrameBufferCube(l);a.bindFramebuffer(u);const m=Lm.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return u.setColorTextureTarget(m),a.gl.drawArrays(a.gl.TRIANGLE_STRIP,0,4),a.gl.flush(),a.setViewport(o.x,o.y,o.width,o.height),this.requestRender(),++this._tileIndex,this._faceIndex===4&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.running||(this.context.renderContext.bindParameters.cloudsFade.renderingStage=Fm.FADING)):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),Zi}};c([p({constructOnly:!0})],ts.prototype,"context",void 0),c([p({constructOnly:!0})],ts.prototype,"view",void 0),c([p({constructOnly:!0})],ts.prototype,"requestRender",void 0),c([p()],ts.prototype,"coverage",void 0),c([p()],ts.prototype,"density",void 0),c([p()],ts.prototype,"absorption",void 0),c([p()],ts.prototype,"cloudSize",void 0),c([p()],ts.prototype,"detailSize",void 0),c([p()],ts.prototype,"smoothness",void 0),c([p()],ts.prototype,"cloudHeight",void 0),c([p()],ts.prototype,"raymarchingSteps",void 0),c([p()],ts.prototype,"running",void 0),ts=c([F("esri.views.3d.environment.CloudsGenerator")],ts);const GO=[Hr(1,0,0),Hr(-1,0,0),Hr(0,1,0),Hr(0,-1,0),Hr(0,0,1)],kO=[Hr(0,1,0),Hr(0,1,0),Hr(0,0,-1),Hr(0,0,1),Hr(0,1,0)],jO=a2();let cg=class extends ri{constructor(){super(...arguments),this.fogColor=b(),this.fogStrength=4e-6,this.atmosphereC=1,this.fogAmount=0}};function Sb(){const i=new Dt;i.attributes.add(Te.POSITION,"vec2"),i.include(qu,{textureCoordinateType:yn.Default}),i.varyings.add("worldRay","vec3"),i.varyings.add("eyeDir","vec3");const{vertex:e,fragment:t}=i;return e.uniforms.add(new Ji("inverseProjectionMatrix",(s,r)=>r.camera.inverseProjectionMatrix),new Ji("inverseViewMatrix",(s,r)=>Ml(WO,r.camera.viewMatrix))),e.code.add(v`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),t.uniforms.add(new He("atmosphereC",s=>s.atmosphereC),new Ei("cameraPosition",(s,r)=>r.camera.eye),new Bi("nearFar",(s,r)=>r.camera.nearFar),new Fe("depthTexture",s=>s.depthTexture),new He("fogStrength",s=>s.fogStrength),new He("fogAmount",s=>s.fogAmount),new Ei("fogColor",s=>s.fogColor)),i.include(G_),t.include(z_),t.code.add(v`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),t.code.add(v`vec4 applyFog(float dist, vec3 rayDir){
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
dist = 0.055 * rayAtmosphereIntersect.y;
}
float fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));
return vec4(fogAmount * fogColor, fogAmount);
}`),t.code.add(v`vec3 tonemapACES(vec3 x) {
return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
}
void main() {
vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
float depthSample = texture(depthTexture, vuv0).r;
float zNorm = 2.0 * depthSample - 1.0;
float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
if(depthSample < 1.0 && depthSample > 0.0){
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= linDepth;
terrainDepth = max(0.0, length(cameraSpaceRay));
}
vec4 fog = applyFog(terrainDepth, rayDir);
fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
}`),i}const WO=Qe(),QO=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:cg,build:Sb},Symbol.toStringTag,{value:"Module"}));let Pb=class Rb extends It{constructor(e){super(e,new tr,()=>this.destroy())}initializeProgram(e){return new Lt(e.rctx,Rb.shader.get().build(),pt)}initializePipeline(){return ot({blending:Ss(K.SRC_ALPHA,K.ZERO,K.ONE_MINUS_SRC_ALPHA,K.ONE),colorWrite:ht})}};Pb.shader=new $t(QO,()=>ae(()=>Promise.resolve().then(()=>Q5),void 0,import.meta.url));const XO=.95,YO=1;let jn=class extends Re{constructor(e){super(e),this._passParameters=new cg;const t=e.context.renderContext.rctx;this._vao=ra(t,fc),this._technique=new Pb(e);const s=Ut(e.view.spatialReference);this._planetRadius=s.radius,this._atmosphereRadius=s.radius+en}destroy(){this._technique.release(),this._vao.dispose()}set strength(e){this._passParameters.fogStrength=e}get strength(){return this._passParameters.fogStrength}render(e,t){if(this._update(e,t),this._passParameters.fogAmount<=0)return;const s=this._technique;if(!s.compiled)return void this.context.requestRender();const r=e.offscreenRenderingHelper;r.renderDepthDetached(()=>{this._passParameters.depthTexture=r.depthTexture;const a=e.rctx.bindTechnique(s,e.bindParameters,this._passParameters);this._renderFog(a,e)})}_renderFog(e,t){const s=t.rctx;s.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(Ai.TRIANGLE_STRIP,0,4)}_update(e,t){const s=e.bindParameters.camera;oe(m0,s.eye);const r=Math.max(0,ue(m0,e.bindParameters.lighting.mainLight.direction)),a=t.color;ee(_0,a,.1),Tr(this._passParameters.fogColor,_0,a,r);const n=xe(s.eye),o=n*n;this._passParameters.atmosphereC=o-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-Vh(XO*Um,YO*Um,Math.abs(n-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}};c([p({constructOnly:!0})],jn.prototype,"context",void 0),c([p({constructOnly:!0})],jn.prototype,"view",void 0),c([p({constructOnly:!0})],jn.prototype,"rctx",void 0),c([p({constructOnly:!0})],jn.prototype,"viewingMode",void 0),jn=c([F("esri.views.3d.environment.Fog")],jn);let ZO=class{constructor(){this.color=b(),this.strength=0,this.amount=0}};const m0=b(),_0=b();var ia;(function(i){i[i.Cone=0]="Cone",i[i.Cylinder=1]="Cylinder",i[i.Underground=2]="Underground",i[i.COUNT=3]="COUNT"})(ia||(ia={}));let dg=class extends w1{constructor(){super(...arguments),this.geometry=ia.Cone}};c([z({count:ia.COUNT})],dg.prototype,"geometry",void 0);let Yu=class extends ri{constructor(){super(...arguments),this.texV=Hi(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new ug}},ug=class{constructor(){this.center=b(),this.v1=b(),this.v2=b()}};function Ob(i){const e=new Dt,{vertex:t,fragment:s}=e;if(q_(t),i.geometry===ia.Underground)e.attributes.add(Te.POSITION,"vec2"),e.varyings.add("color","vec4"),t.uniforms.add(new Ei("cameraPosition",(r,a)=>a.camera.eye),new He("undergroundFadeAlpha",r=>r.undergroundFadeAlpha)),t.code.add(v`void main(void) {
float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),s.code.add(v`void main() {
fragColor = color;
}`);else{e.include(ib,i),e.attributes.add(Te.POSITION,"vec3"),e.varyings.add("vtc","vec2"),e.varyings.add("falloff","float");const r=i.geometry===ia.Cylinder;t.uniforms.add(new Ji("proj",(o,l)=>l.camera.projectionMatrix),new Ji("view",(o,l)=>l.camera.viewMatrix)),r||(e.varyings.add("innerFactor","float"),t.uniforms.add(new Ei("silCircleCenter",o=>o.silhouette.center)),t.uniforms.add(new Ei("silCircleV1",o=>o.silhouette.v1)),t.uniforms.add(new Ei("silCircleV2",o=>o.silhouette.v2)),t.uniforms.add(new Bi("texV",o=>o.texV)),t.uniforms.add(new He("innerScale",o=>o.innerScale)));const a=6.2831853,n=1/128;t.code.add(v`
		void main(void) {
      ${r?v`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:v`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${v.float(a*n)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${v.float(n)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),s.uniforms.add(new Fe("tex",o=>o.texture)),r||s.uniforms.add(new He("altitudeFade",o=>o.altitudeFade)),s.code.add(v`
		void main() {
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${r?v`fragColor = atmosphereColor;`:v`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return e}const KO=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:ug,SimpleAtmospherePassParameters:Yu,build:Ob},Symbol.toStringTag,{value:"Module"}));let bu=class Mb extends It{initializeProgram(e){return new Lt(e.rctx,Mb.shader.get().build(this.configuration),pt)}initializePipeline(){return this.configuration.geometry===ia.Cylinder?ot({blending:Ss(K.SRC_ALPHA,K.ONE,K.ONE_MINUS_SRC_ALPHA,K.ONE_MINUS_SRC_ALPHA),culling:A1,depthTest:{func:Xi.LEQUAL},colorWrite:ht}):ot({blending:Ss(K.SRC_ALPHA,K.ONE,K.ONE_MINUS_SRC_ALPHA,K.ONE_MINUS_SRC_ALPHA),depthTest:{func:Xi.LEQUAL},colorWrite:ht})}};bu.shader=new $t(KO,()=>ae(()=>Promise.resolve().then(()=>X5),void 0,import.meta.url));const JO=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);let eM=class{constructor(e,t){this.type=Ni.Local,this._configuration=new dg,this._passParameters=new Yu,this._configuration.geometry=ia.Cylinder,this._technique=t.techniques.acquire(bu,this._configuration);const s=t.renderContext.rctx;this._vao=tM(s),this._vaoCount=$a(this._vao,"geometry");const r=new gi;r.wrapMode=Ki.CLAMP_TO_EDGE,r.flipped=!0,r.width=1,r.height=512,this._passParameters.texture=new Yi(s,r,JO)}destroy(){this._passParameters.texture=je(this._passParameters.texture),this._vao.dispose(),this._technique.release()}render(e){const t=e.rctx,s=t.bindTechnique(this._technique,e.bindParameters,this._passParameters);iM(g0,e.bindParameters.camera.viewMatrix),s.setUniformMatrix4fv("view",g0),t.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(Ai.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}};function tM(i){const e=bP(1,2,!1),{data:t,indices:s}=e[0][1],r=f0.createBuffer(s.length),a=r.position;for(let n=0;n<s.length;++n){const o=3*s[n%3==0?n+2:n%3==2?n-2:n];a.set(n,0,t[o]),a.set(n,1,t[o+1]),a.set(n,2,t[o+2])}return new Rn(i,pt,{geometry:On(f0)},{geometry:Ls.createVertex(i,xr.STATIC_DRAW,r.buffer)})}function iM(i,e){pc(i,e),i[12]=0,i[13]=0,i[14]=0,i[15]=1}const g0=Qe(),f0=Mn().vec3f(Te.POSITION),sM=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),Mc=128,v0=-km,y0=0,wp=50,rM=()=>1-511/512,aM=yd([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let nM=class{constructor(e,t){this.view=e,this.type=Ni.Mars,this._passParameters=new Yu,this._vaoCount=0,this._texV1=1;const s=Ut(e.spatialReference);this._planetRadius=s.radius,this._outerRimWidth=s.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+v0)/this._planetRadius,this._middleRimFactor=(this._planetRadius+y0)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=y0/this._outerRimWidth,this._texVScale=this._texV1-this._texV0,this._techniques=t.techniques;const r=t.renderContext.rctx;this._cameraChangeHandle=M(()=>{var o;return(o=this.view.state)==null?void 0:o.camera},()=>t.requestRender(),ut),this._vao=this._createRibbon(r),this._vaoCount=$a(this._vao,"geometry"),this._fadeVao=ra(r),this._fadeVaoCount=$a(this._fadeVao,"geometry");const a=new gi;a.wrapMode=Ki.CLAMP_TO_EDGE,a.flipped=!0,a.width=1,a.height=512,this._passParameters.texture=new Yi(r,a,sM);const n=new dg;n.geometry=ia.Cone,this._coneTechnique=this._techniques.acquire(bu,n),n.geometry=ia.Underground,this._undergroundTechnique=this._techniques.acquire(bu,n)}destroy(){this._coneTechnique.release(),this._undergroundTechnique.release(),this._cameraChangeHandle.remove(),this._passParameters.texture=je(this._passParameters.texture),this._fadeVao.dispose(),this._vao.dispose()}render(e){const t=e.bindParameters.camera;this._update(t);const s=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(s.bindTechnique(this._coneTechnique,e.bindParameters,this._passParameters),s.bindVAO(this._vao),s.drawArrays(Ai.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(s.bindTechnique(this._undergroundTechnique,e.bindParameters,this._passParameters),s.bindVAO(this._fadeVao),s.drawArrays(Ai.TRIANGLE_STRIP,0,this._fadeVaoCount))}renderHaze(){}_update(e){const t=b(),s=this._planetRadius,r=xe(e.eye),a=r-s;if(a<0){const _=Math.min(-a/5e3,1);this._passParameters.undergroundFadeAlpha=_}else this._passParameters.undergroundFadeAlpha=0;const n=Math.max(wp,a),o=s+v0;this._passParameters.innerScale=oM(s+n,s,o)-1,this._passParameters.altitudeFade=ag(a),ee(t,e.eye,(s+wp)/r),b0(t,e.center,e.up,s,this._passParameters.silhouette);const l=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),h=rM(),d=aM(a);let u=this._texV0+h*this._texVScale,m=this._texV0+l*d*this._texVScale;if(a>wp){b0(e.eye,e.center,e.up,s,this._passParameters.silhouette);const _=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),f=Z((_-1.5)/(l-1.5),0,1);u=this._texV0+f*h*this._texVScale,m=this._texV0+Be(this._texV1,l*d,f)*this._texVScale}Aa(this._passParameters.texV,u,m)}_createRibbon(e){const t=x1(3+3*Mc*3),s=new Uint32Array(3*Mc*5);t[0]=0,t[1]=0,t[2]=-1;for(let n=0;n<Mc;n++){const o=9*n+3;t[o]=n,t[o+1]=this._innerRimFactor,t[o+2]=-1,t[o+3]=n,t[o+4]=this._middleRimFactor,t[o+5]=0,t[o+6]=n,t[o+7]=this._outerRimFactor,t[o+8]=1;const l=3*n+1,h=n===Mc-1?1:l+3,d=15*n;s[d]=l,s[d+1]=l+1,s[d+2]=h+1,s[d+3]=h+1,s[d+4]=h,s[d+5]=l,s[d+6]=l+1,s[d+7]=l+2,s[d+8]=h+2,s[d+9]=h+2,s[d+10]=h+1,s[d+11]=l+1,s[d+12]=l,s[d+13]=h,s[d+14]=0}const r=w0.createBuffer(s.length),a=r.position;for(let n=0;n<s.length;++n){const o=3*s[n];a.set(n,0,t[o]),a.set(n,1,t[o+1]),a.set(n,2,t[o+2])}return new Rn(e,pt,{geometry:On(w0)},{geometry:Ls.createVertex(e,xr.STATIC_DRAW,r.buffer)})}_computeScreenRimWidth(e,t,s,r){return _e(Io,r.center,r.v2),ee(Ec,Io,this._outerRimFactor),e2(xp,t,Io,s),Hf(Io,xp,e.projectionMatrix,e.viewport,Io),Hf(Ec,xp,e.projectionMatrix,e.viewport,Ec),os(Io,Ec)/e.height}};function b0(i,e,t,s,r){const a=xe(i),n=s*Math.sqrt(a*a-s*s)/a,o=Math.sqrt(s*s-n*n),l=r.v1,h=r.v2;return ee(r.center,i,o/a),yt(l,i,e),gr(l)<1&&yt(l,i,t),ee(l,l,n/xe(l)),yt(h,l,i),ee(h,h,n/xe(h)),n}const xp=Qe(),Io=b(),Ec=b();function oM(i,e,t){return i*i/(Math.sqrt(i*i-e*e)*Math.sqrt(i*i-t*t)+e*t)}const w0=Mn().vec3f(Te.POSITION);var Fa;(function(i){i[i.Rain=0]="Rain",i[i.Snow=1]="Snow",i[i.COUNT=2]="COUNT"})(Fa||(Fa={}));let Xm=class extends tr{constructor(){super(...arguments),this.type=Fa.Rain}};c([z({count:Fa.COUNT})],Xm.prototype,"type",void 0);function Eb(i){const e=new Dt;return e.attributes.add(Te.POSITION,"vec3"),e.attributes.add(Te.INSTANCEFEATUREATTRIBUTE,"float"),e.vertex.uniforms.add(new Ei("cameraPosition",(t,s)=>s.camera.eye)),e.vertex.uniforms.add(new Ei("offset",(t,s)=>lM(t,s))),e.vertex.uniforms.add(new He("width",t=>t.width)),e.vertex.uniforms.add(new Ji("proj",(t,s)=>s.camera.projectionMatrix)),e.vertex.uniforms.add(new Ji("view",(t,s)=>s.camera.viewMatrix)),e.vertex.uniforms.add(new He("time",t=>t.time)),e.varyings.add("vUv","vec2"),e.vertex.code.add(v`
    vec3 hash31(float p){
      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return fract((p3.xxy + p3.yzz) * p3.zyx);
    }

    float hash11(float p){
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);
    }

    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/
    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
    }

    void main(void) {

      vUv = position.xz;

      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${i.type===Fa.Rain?v`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:v`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
    }
  `),e.fragment.uniforms.add(new He("opacity",t=>t.opacity),new Ei("particleColor",(t,s)=>hM(s,i))),e.fragment.code.add(v`
    void main() {

      // Cut off corners of the triangle
      if(vUv.x < 0.0 || vUv.y < 0.0){
        discard;
      }

      float d = length(vUv - vec2(0.5));

      ${i.type===Fa.Rain?v`d = 0.35 * smoothstep(0.5, 0.0, d);`:v`d = smoothstep(0.5, 0.1, d);`}
      fragColor = opacity * vec4(particleColor * d, d);
    }
  `),e}function lM(i,e){const t=e.camera.eye,s=.5*i.width,r=1/i.width,a=VC(Ym,it(Ym,(t[0]+s)*r,(t[1]+s)*r,(t[2]+s)*r));return xt(a,t,ee(a,a,i.width))}function hM(i,e){const t=e.type===Fa.Rain?dM:cM,s=ee(Ym,t,uM),r=i.camera.eye;oe(x0,r);const a=Math.max(0,ue(x0,i.lighting.mainLight.direction));return Tr(s,s,t,a)}const Ym=b(),x0=b(),cM=St(1,1,1),dM=St(.85,.85,.85),uM=.7,pM=Object.freeze(Object.defineProperty({__proto__:null,build:Eb},Symbol.toStringTag,{value:"Module"}));let mM=class extends ri{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=1}},Zm=class Ab extends It{initializeProgram(e){return new Lt(e.rctx,Ab.shader.get().build(this.configuration),wu)}initializePipeline(){return ot({blending:Ss(K.ONE,K.ONE,K.ONE_MINUS_SRC_ALPHA,K.ONE_MINUS_SRC_ALPHA),depthTest:{func:Xi.LEQUAL},colorWrite:ht})}};Zm.shader=new $t(pM,()=>ae(()=>Promise.resolve().then(()=>Y5),void 0,import.meta.url));const wu=new Map([[Te.POSITION,0],[Te.INSTANCEFEATUREATTRIBUTE,1]]);let ch=class extends Re{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._passParameters=new mM,this._animation=new mP,this._passParameters.time=0,this._passParameters.radius=Ut(e.view.spatialReference).radius,this._techniques=e.context.techniques}destroy(){this._numParticles=0,this._snowTechniqueCached=tt(this._snowTechniqueCached),this._rainTechniqueCached=tt(this._rainTechniqueCached),this._vao=je(this._vao),this._instanceIdBuffer=je(this._instanceIdBuffer)}get _rainTechnique(){if(this._rainTechniqueCached==null){const e=new Xm;e.type=Fa.Rain,this._rainTechniqueCached=this._techniques.acquire(Zm,e)}return this._rainTechniqueCached}get _snowTechnique(){if(this._snowTechniqueCached==null){const e=new Xm;e.type=Fa.Snow,this._snowTechniqueCached=this._techniques.acquire(Zm,e)}return this._snowTechniqueCached}update(e){return this._animation.advance(e)}render(e,t,s){const r=s==="rainy"?this._rainTechnique:this._snowTechnique;if(!r.compiled)return void this.context.requestRender();const a=e.rctx;if(this._ensureResources(a),r==null||this._vao==null||this._instanceIdBuffer==null||(e.bindParameters.cloudsFade.data!=null&&(this._passParameters.opacity=e.bindParameters.cloudsFade.opacity),this._passParameters.opacity<=0))return;const n=.35;t=t<.5?Be(0,n,2*t):Be(n,1,2*(t-.5)),this._passParameters.time=(s==="rainy"?this._rainSpeed:this._snowSpeed)*Hy(this._animation.time)%1e5;const o=a.bindTechnique(r,e.bindParameters,this._passParameters);a.bindVAO(this._vao),o.assertCompatibleVertexAttributeLocations(this._vao),WP(a,wu,this._instanceIdBuffer,C0,0),a.drawArraysInstanced(Ai.TRIANGLES,0,3,this._numParticles*t),QP(a,wu,this._instanceIdBuffer,C0)}_ensureResources(e){this._vao==null&&(this._vao=_M(e)),this._instanceIdBuffer==null&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const t=[];for(let s=0;s<this._numParticles;s++)t.push(s);return Ls.createVertex(e,xr.STATIC_DRAW,new Float32Array(t))}};function _M(i){const e=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new Rn(i,wu,{geometry:On(gM)},{geometry:Ls.createVertex(i,xr.STATIC_DRAW,e)})}c([p({constructOnly:!0})],ch.prototype,"context",void 0),c([p({constructOnly:!0})],ch.prototype,"view",void 0),ch=c([F("esri.views.3d.environment.Precipitation")],ch);const gM=Mn().vec3f(Te.POSITION),C0=On(Mn().f32(Te.INSTANCEFEATUREATTRIBUTE),1);function Db(){const i=new Dt;return i.attributes.add(Te.POSITION,"vec3"),i.attributes.add(Te.COLOR,"vec4"),i.attributes.add(Te.SIZE,"float"),i.varyings.add("vcolor","vec4"),i.varyings.add("vsize","float"),i.vertex.uniforms.add(new Ji("transform",(e,t)=>fM(e,t)),new cn("viewport",(e,t)=>t.camera.fullViewport),new He("pixelRatio",(e,t)=>t.camera.pixelRatio)),i.vertex.code.add(v`void main(void) {
gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),i.fragment.code.add(v`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);
}`),i}function fM(i,e){return pc(qa,e.camera.projectionMatrix),qa[10]=24e-8-1,qa[11]=-1,qa[14]=(24e-8-2)*e.camera.near,Ks(qa,qa,e.camera.viewMatrix),Ks(qa,qa,i.modelMatrix)}const qa=Qe(),vM=Object.freeze(Object.defineProperty({__proto__:null,build:Db},Symbol.toStringTag,{value:"Module"}));let yM=class extends ri{constructor(){super(...arguments),this.modelMatrix=Qe()}},$b=class Ib extends It{constructor(e){super(e,new tr,()=>this.destroy())}initializeProgram(e){return new Lt(e.rctx,Ib.shader.get().build(),pt)}initializePipeline(){return ot({blending:Ss(K.SRC_ALPHA,K.ONE,K.ONE_MINUS_SRC_ALPHA,K.ONE_MINUS_SRC_ALPHA),depthTest:{func:Xi.LEQUAL},colorWrite:ht})}};$b.shader=new $t(vM,()=>ae(()=>Promise.resolve().then(()=>Z5),void 0,import.meta.url));let Xa=class extends Re{get updating(){return this._updatingTracking.updating||this.loading}get loading(){return this._loadDataTask!=null&&!this._loadDataTask.finished}constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._passParameters=new yM,this._updatingTracking=new H1}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=Pn(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=tt(this._technique),this._vao=je(this._vao),Dn=null}render(e){const{rctx:t}=e;if(this._ensureResources(t),this._technique==null||this._vao==null)return;if(!this._technique.compiled)return void this.requestRender();const s=t.bindTechnique(this._technique,e.bindParameters,this._passParameters);t.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(Ai.POINTS,0,this._numPoints)}_ensureResources(e){if(this._technique!=null||Dn==null)return;this._technique=new $b({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=Dn.byteLength/Lb;const t=new Float32Array(Dn,0,2*this._numPoints),s=new Uint8Array(Dn,2*this._numPoints*4,this._numPoints);this._vao=bM(e,t,s,this._numPoints),this._updatingTracking.add(()=>this.view.environment.lighting.type!=="virtual"?this.view.environment.lighting.date:null,r=>this._update(r),si)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,s=2*wM(e),r=pc(this._passParameters.modelMatrix,RM);Bf(r,r,-s*Math.PI),Ks(r,PM,r),Bf(r,r,-t*Math.PI),this.requestRender()}_createLoadDataTask(){if(Dn!=null)return null;const e=cc(async t=>{const{data:s}=await h2("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});xM(s),Dn=s});return e.promise.catch(t=>{mn(t)||Pe.getLogger(this).error(t)}).then(()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))}),e}};function bM(i,e,t,s){const r=T0.createBuffer(s),a=r.position,n=r.color,o=r.size;for(let l=0;l<s;l++){const h=e[2*l],d=e[2*l+1];a.set(l,0,-Math.cos(h)*Math.sin(d)),a.set(l,1,-Math.sin(h)*Math.sin(d)),a.set(l,2,-Math.cos(d));const u=TM(t[l]),m=CM(SM[u[1]]);n.set(l,0,255*m[0]),n.set(l,1,255*m[1]),n.set(l,2,255*m[2]),n.set(l,3,255),o.set(l,u[0])}return new Rn(i,pt,{geometry:On(T0)},{geometry:Ls.createVertex(i,xr.STATIC_DRAW,r.buffer)})}function wM(i){const e=i,t=new Date(i.getFullYear(),0,1,11,58,56);return(+e-+t)/(+new Date(i.getFullYear()+1,0,1,11,58,55)-+t)}function xM(i){if(!i)throw new xs("stars:no-data-received","Failed to create stars because star catalogue is missing");const e=i.byteLength/Lb;if(e%1!=0||e>5e4||e<5e3)throw new xs("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}function CM(i){return[parseInt(i.substring(0,2),16),parseInt(i.substring(2,4),16),parseInt(i.substring(4,6),16)]}function TM(i){return i>=192?[2.9,i-192]:i>=160?[2.5,i-160]:i>=128?[2,i-128]:i>=96?[1.5,i-96]:i>=64?[1,i-64]:i>=32?[.7,i-32]:[.4,i]}c([p({constructOnly:!0})],Xa.prototype,"view",void 0),c([p({constructOnly:!0})],Xa.prototype,"requestRender",void 0),c([p({readOnly:!0})],Xa.prototype,"updating",null),c([p()],Xa.prototype,"_loadDataTask",void 0),c([p()],Xa.prototype,"_updatingTracking",void 0),Xa=c([F("esri.views.3d.environment.Stars")],Xa);const SM=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],PM=q1(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),RM=q1(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),Lb=9,T0=Mn().vec3f(Te.POSITION).vec4u8(Te.COLOR).f32(Te.SIZE);let Dn=null;var gl;(function(i){i[i.Immediate=0]="Immediate",i[i.Faded=1]="Faded"})(gl||(gl={}));let Ti=class extends $1{constructor(e){super(e),this.produces=new Map([[j.OPAQUE_ENVIRONMENT,()=>!(this._atmosphere===null&&this._stars===null)],[j.TRANSPARENT_ENVIRONMENT,()=>this._atmosphere!==null]]),this._context=null,this._atmosphere=null,this._oldWeatherParameters=new Cp,this._newWeatherParameters=new Cp,this._fadedWeatherParameters=new Cp,this._weatherParameters=this._newWeatherParameters}initialize(){this.view._stage.addRenderPlugin(this)}destroy(){var e;this.removeHandles(),this.uninitializeRenderContext(),((e=this.view)==null?void 0:e._stage)!=null&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}get atmosphere(){return this._atmosphere}get _atmosphereType(){return this.atmosphere!=null?this.atmosphere.type:Ni.None}consumes(){return this._atmosphereType===Ni.Realistic?W_:Q_}updateAnimation(e){return this._precipitation!=null&&this._precipitation.update(e)}get updating(){return this._stars!=null&&this._stars.updating||this._clouds!=null&&this._clouds.running}get weatherVisible(){return xe(this.view.state.camera.eye)-Ut(this.view.spatialReference).radius<=Um}get usedMemory(){var e;return((e=this._clouds)==null?void 0:e.usedMemory)??0}get _stars(){var r;const e=this.view,t=((r=e.environment)==null?void 0:r.starsEnabled)??!1,s=this._get("_stars");return t&&this._context!=null?s??new Xa({view:e,requestRender:()=>this._setNeedsRender()}):(Y(s),null)}get _precipitation(){const e=this._get("_precipitation");if(!this._precipitationEnabled||this._context==null)return Y(e),null;const t=this.view,s=this._context;return e!=null&&e.context===s?e:(Y(e),new ch({context:s,view:t}))}get _clouds(){const e=this._get("_clouds");if(!this.weatherEnabled||this._context==null)return Y(e),null;if(e!=null)return e;const t=this.view,s=this._context;return Y(e),new ts({context:s,view:t,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const e=this._get("_cloudsComposition");if(!this.weatherEnabled||this._context==null)return Y(e),null;const t=this.view.state.viewingMode,s=this._context.renderContext.rctx,r=Ut(this.view.spatialReference).radius;return e!=null&&e.viewingMode===t&&e.planetRadius===r?e:(Y(e),new kn({rctx:s,viewingMode:t,planetRadius:r,requestRender:()=>this._setNeedsRender()}))}get _fog(){const e=this._get("_fog");if(!this.weatherEnabled||this._context==null)return Y(e),null;if(e!=null)return e;const t=this.view,s=this._context,r=this._context.renderContext.rctx,a=this.view.state.viewingMode;return new jn({context:s,view:t,rctx:r,viewingMode:a})}get weatherEnabled(){var e,t;return!!((t=(e=this.view)==null?void 0:e.environmentManager)!=null&&t.weatherEnabled)}get _precipitationEnabled(){return this.weatherEnabled&&(this.view.environment.weather.type==="rainy"||this.view.environment.weather.type==="snowy")}initializeRenderContext(e=null){this._context=e;const t=()=>this._setNeedsRender();this.addHandles([M(()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled}),s=>this._updateAtmosphere(s),ut),M(()=>this._stars,t),M(()=>this._precipitation,t),M(()=>this._clouds,()=>this._updateWeather(),si),M(()=>this._fog,()=>this._updateFogHaze(),si),M(()=>this.view.state.mode,()=>this._setNeedsRender(),nt),M(()=>this._weatherUpdateParameters,()=>{this._updateWeather(),this._updateFogHaze()},ut)])}uninitializeRenderContext(){this._context=null,this._atmosphere=Y(this._atmosphere),this._set("_stars",Y(this._stars)),this._set("_precipitation",Y(this._precipitation)),this._set("_clouds",Y(this._clouds)),this._set("_cloudsComposition",Y(this._cloudsComposition)),this._set("_fog",Y(this._fog))}prepareRender(e){var t;e.bindParameters.cloudsFade.data=wP(this._clouds)?this._clouds:null,this.view.viewingMode!=="local"&&((t=e.bindParameters.cloudsFade.data)==null?void 0:t.cubeMap)!=null&&(this._updateWeatherFading(e.bindParameters,e.time),e.bindParameters.cloudsFade.renderingStage===Fm.FINISHED&&this._clouds!=null&&this._clouds.coverage===0&&this._clouds.running===!1&&(this._clouds.destroyFrameBufferCube(),e.bindParameters.cloudsFade.data=null))}renderNode(e){var t,s,r,a,n,o,l,h;switch(e.bindParameters.slot){case j.OPAQUE_ENVIRONMENT:(t=this._stars)==null||t.render(e),this.atmosphere!=null&&(this.atmosphere.render(e,(a=(r=(s=this.view)==null?void 0:s._stage)==null?void 0:r.renderer)==null?void 0:a.fullResolutionAtmosphere),this._cloudsComposition&&e.bindParameters.cloudsFade.data!=null&&(this.weatherVisible&&this._clouds!=null&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(e)),e.bindParameters.cloudsFade.isFading&&this._context&&((n=e.bindParameters.cloudsFade.data)==null?void 0:n.cubeMap)!=null&&this._context.requestRender());break;case j.TRANSPARENT_ENVIRONMENT:if(this.atmosphere!=null&&(this.atmosphere.renderHaze(e,this._weatherParameters.hazeAmount,(h=(l=(o=this.view)==null?void 0:o._stage)==null?void 0:l.renderer)==null?void 0:h.fullResolutionAtmosphere),this._weatherParameters.fog.amount>0&&this._fog!=null&&this._fog.render(e,this._weatherParameters.fog),this._precipitation)){const d=this.view.environment.weather;d.type!=="rainy"&&d.type!=="snowy"||this._precipitation.render(e,d.precipitation,d.type)}}}updateLightSources(e,t,s,r){if(this._context!=null){const a=this._context.renderContext;a.bindParameters.oldLighting.copyFrom(a.bindParameters.lighting),a.bindParameters.newLighting.noonFactor=t,a.bindParameters.newLighting.globalFactor=s,a.bindParameters.newLighting.set(e),r===gl.Faded||a.bindParameters.weatherFading?a.bindParameters.fadeLighting(0):a.bindParameters.fadeLighting(1),this._context.requestRender()}}get _weatherUpdateParameters(){const e=this.weatherEnabled?this.view.environment.weather:null;return e==null?null:e.type==="rainy"||e.type==="snowy"?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:e.type==="foggy"?e.fogStrength:e.cloudCover}}_updateWeatherFading(e,t){e.cloudsFade.updateFading(e.camera,this.view.state.mode,t,this.view.qualitySettings.fadeDuration),e.cloudsFade.updateParallax(e.camera),e.weatherFading&&(OM(e),this._updateFogAtmoshpere(e))}_updateFogAtmoshpere(e){e.cloudsFade.fadeMode!==Qh.CROSS_FADE&&e.cloudsFade.fadeMode!==Qh.FADE_IN?this._fadeWeather(0):this._fadeWeather(e.cloudsFade.fadeFactor)}_fadeWeather(e){const{_newWeatherParameters:t,_oldWeatherParameters:s}=this;e>=1?this._weatherParameters=t:(this._fadedWeatherParameters.lerp(s,t,e),this._weatherParameters=this._fadedWeatherParameters)}_updateWeather(){const e=this._weatherUpdateParameters;e!=null&&this._clouds!=null&&(this._clouds.applyPreset(Li[e.type],e.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){this._context!=null&&this._context.requestRender()}_updateFogHaze(){const e=this._weatherUpdateParameters;if(this._fog==null||e==null||this._context==null)return;const t=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),e.type){case"foggy":this._newWeatherParameters.fog.strength=Be(3e-5,.005,e.weatherAdjustment**3),le(this._newWeatherParameters.fog.color,S0),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=Be(4e-6,2e-4,(e.effect??0)**3),le(this._newWeatherParameters.fog.color,MM),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=Be(4e-6,2e-4,(e.effect??0)**3),le(this._newWeatherParameters.fog.color,S0),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender()}t.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}_updateAtmosphere(e){const t=this._selectAtmosphereType(e);if(t!==Ni.None&&this._context){if(!this._atmosphere||this._atmosphere.type!==t){this._atmosphere=Y(this._atmosphere);const s=this._getAtmosphereClass(t);s&&(this._atmosphere=new s(this.view,this._context))}}else this._atmosphere=Y(this._atmosphere);this._setNeedsRender()}_getAtmosphereClass(e){switch(e){case Ni.Realistic:return $O;case Ni.Local:return eM;case Ni.Mars:return nM;default:case Ni.None:return null}}_selectAtmosphereType(e){const{enabled:t,viewingMode:s}=e;return!t||l1(this.view.spatialReference)?Ni.None:s===$e.Local?Ni.Local:this._context!=null&&Om(this.view.spatialReference)?Ni.Realistic:h1(this.view.spatialReference)?Ni.Mars:Ni.None}get test(){}};c([p({constructOnly:!0})],Ti.prototype,"view",void 0),c([p({readOnly:!0})],Ti.prototype,"atmosphere",null),c([p({readOnly:!0})],Ti.prototype,"_atmosphereType",null),c([p({type:Boolean,readOnly:!0})],Ti.prototype,"updating",null),c([p({readOnly:!0})],Ti.prototype,"weatherVisible",null),c([p()],Ti.prototype,"_context",void 0),c([p()],Ti.prototype,"_atmosphere",void 0),c([p({readOnly:!0})],Ti.prototype,"_stars",null),c([p({readOnly:!0})],Ti.prototype,"_precipitation",null),c([p({readOnly:!0})],Ti.prototype,"_clouds",null),c([p({readOnly:!0})],Ti.prototype,"_cloudsComposition",null),c([p({readOnly:!0})],Ti.prototype,"_fog",null),c([p({readOnly:!0})],Ti.prototype,"weatherEnabled",null),c([p({readOnly:!0})],Ti.prototype,"_precipitationEnabled",null),c([p({readOnly:!0})],Ti.prototype,"_weatherUpdateParameters",null),Ti=c([F("esri.views.3d.environment.EnvironmentRenderer")],Ti);let Cp=class{constructor(){this.fog=new ZO,this.hazeAmount=1}copyFrom(e){this.fog.amount=e.fog.amount,this.hazeAmount=e.hazeAmount,this.fog.strength=e.fog.strength,le(this.fog.color,e.fog.color)}lerp(e,t,s){this.fog.amount=Be(e.fog.amount,t.fog.amount,s),this.hazeAmount=Be(e.hazeAmount,t.hazeAmount,s),this.fog.strength=Be(e.fog.strength,t.fog.strength,s),Tr(this.fog.color,e.fog.color,t.fog.color,s)}};function OM(i){i.cloudsFade.fadeMode!==Qh.CROSS_FADE&&i.cloudsFade.fadeMode!==Qh.FADE_IN?i.fadeLighting(0):i.fadeLighting(i.cloudsFade.fadeFactor)}const MM=St(.5,.5,.5),S0=St(1.5,1.5,1.5);let ar=class extends Pr.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandlesKey="viewHandles",this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new BS,this._ambientLight=new HS,this._moonLight=new GS,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePositionGeographic=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){var e;return(e=this._renderer)==null?void 0:e.view}get updating(){var e;return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&!((e=this._renderer)!=null&&e.updating))}get weatherEnabled(){var e,t,s;return((e=this._view)==null?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&((s=(t=this._view)==null?void 0:t.state)==null?void 0:s.viewingMode)===$e.Global&&Om(this._view.spatialReference)}get weatherVisible(){var e;return this.weatherEnabled&&((e=this._renderer)==null?void 0:e.weatherVisible)}get referencePositionGeographic(){return this._referencePositionGeographic}connectView(e){if(this._renderer)return;this._renderer=new Ti({view:e});const t=()=>this._updateRenderParameters(),s=()=>this._cameraHandler();this.addHandles([M(()=>e.environment.lighting,r=>this._updateLightingHandler(r),nt),M(()=>e.environment.lighting.type!=="virtual"?e.environment.lighting.date:null,r=>this._lightingDateHandler(r),nt),M(()=>e.stationary,()=>this._interactingStationaryHandler()),M(()=>e.environment.lighting.directShadowsEnabled,t,nt),M(()=>e.qualitySettings.ambientOcclusion,t,nt),M(()=>e.qualitySettings.reflections,t,nt),M(()=>e.spatialReference,()=>this._resetReferencePosition(!0),nt),M(()=>e.environment.weather.type,()=>this._updateLighting(null,gl.Faded),nt),M(()=>this.weatherEnabled,()=>this._updateLighting(null,gl.Faded),nt),M(()=>e.viewingMode,()=>this._resetReferencePosition(!0),ut),M(()=>e.environment.lighting.type!=="virtual"&&e.environment.lighting.cameraTrackingEnabled,r=>this._updateCameraTracking(r),ut),M(()=>e.state.camera,s,ut),M(()=>this.disableQueries,s)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=Y(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type!=="virtual"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.type!=="virtual"?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const t=this._view.environment.lighting;(t==null?void 0:t.type)!=="virtual"&&(t.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if((t==null?void 0:t.type)!=="virtual"){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const s=this._view.spatialReference;if(!Cm(s,pi.WGS84)){const r=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(r))return void this._requestReferencePositionUpdate(r)}if(this._preupdateTracking(e),this._referencePositionGeographic!=null){const r=kf(this._referencePositionGeographic,P0);r!=null&&(t.autoUpdate(null,r),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type!=="virtual"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const s=t.stateManager.camera;s&&(this._cameraHandlerClientSide(s,e)||this._cameraHandlerServerSide(s))}_cameraHandlerClientSide(e,t){const s=Om(this._view.spatialReference);if(s&&!Cm(this._view.spatialReference,pi.WGS84))return this._view.environment.lighting.type==="virtual"&&this._updateLighting(),!1;const r=e.position;return this._referencePositionGeographic??(this._referencePositionGeographic=b()),s?zh(r,this._referencePositionGeographic,pi.WGS84):it(this._referencePositionGeographic,r.longitude??0,r.latitude??0,r.z??0),this.notifyChange("referencePositionGeographic"),this._autoUpdateTimezone(this._referencePositionGeographic,t)||this._updateLighting(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePositionGeographic&&(this._referencePositionGeographic[2]=(t.z??0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e,t=gl.Immediate){const s=this._view;e=e||(s.environment.lighting.type==="virtual"?null:s.environment.lighting.date);const r=this._referencePositionGeographic,a=r?EM:AM,n=this.weatherVisible?s.environment.weather.type:"disabled";r!=null?c2(e,r,s.state.viewingMode,n,s.state.camera,a):s.environment.lighting.type==="virtual"&&d2(s.state.camera,s.state.viewingMode,a.direct.directionToLightSource);const o=this._mainLight,l=a.direct;ee(o.intensity,l.color,l.intensity*Math.PI),le(o.direction,l.directionToLightSource),o.specularStrength=a.specularStrength,o.environmentStrength=a.environmentStrength;const h=this._ambientLight;ee(h.intensity,a.ambient.color,a.ambient.intensity);const d=this._moonLight;Tr(d.intensity,$M,IM,a.globalFactor);const u=(1-.5*a.globalFactor)*(1-.4*a.noonFactor*(1-a.globalFactor));ee(d.intensity,d.intensity,u),le(d.direction,l.directionToLightSource),this._renderer.updateLightSources([o,h,d],a.noonFactor,a.globalFactor,t),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||e==null)return!1;const s=DM;s.setTime((t||this._view.environment.lighting.date).getTime());const r=kf(e,P0);if(r==null)return!1;let a=this._view.environment.lighting.positionTimezoneInfo;if(a.autoUpdated){if(a.hours===r.hours&&a.minutes===r.minutes&&a.seconds===r.seconds)return!1}else a=r;const n=s.getUTCHours()-(r.hours-a.hours),o=s.getUTCMinutes()-(r.minutes-a.minutes),l=s.getUTCSeconds()-(r.seconds-a.seconds);return s.setUTCHours(n),s.setUTCMinutes(o),s.setUTCSeconds(l),!t&&this._view.environment.lighting.autoUpdate(s,r)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=this._referencePositionGeographic==null||u2(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePositionGeographic=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const s=this._referencePosUpdateQuery=df(this._referencePointUpdateDelay).then(()=>{if(this._referencePosUpdateQuery===s){const a=()=>this._referencePosUpdateQuery!==s;return this._doReferencePositionUpdateQuery(a)}}).catch(a=>{a.name==="mapcoordshelper:missing-geometry-service"&&(this.disableQueries=!0)}).then(()=>{this._referencePosUpdateQuery===s&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))}),r=this._referencePosUpdateTimer=df(this._referencePointUpdateInterval).then(()=>{this._referencePosUpdateTimer===r&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())});this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const s=(this._referencePosMapCoords.z??0)*this._view.mapCoordsHelper.unitInMeters;this._referencePositionGeographic?it(this._referencePositionGeographic,t[0],t[1],s):this._referencePositionGeographic=St(t[0],t[1],s),this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePositionGeographic)||this._updateLighting(),this.notifyChange("referencePositionGeographic")}_exceedsReferencePosDistThreshold(e){const t=this._referencePosMapCoords;if(t==null)return!0;const s=m2(t,e);return s==null?!0:IS(s,"meters").value>this._referencePointUpdateDistThreshold}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){}};c([p({type:Boolean,readOnly:!0})],ar.prototype,"updating",null),c([p()],ar.prototype,"disableQueries",void 0),c([p()],ar.prototype,"_disableWeather",void 0),c([p()],ar.prototype,"weatherEnabled",null),c([p()],ar.prototype,"weatherVisible",null),c([p()],ar.prototype,"referencePositionGeographic",null),c([p()],ar.prototype,"_renderer",void 0),c([p()],ar.prototype,"_referencePositionGeographic",void 0),ar=c([F("esri.views.3d.environment.SceneViewEnvironmentManager")],ar);const EM=new G1,AM=new G1,DM=new Date,P0={hours:0,minutes:0,seconds:0},$M=St(.22,.22,.33),IM=St(.22,.22,.22);var dt;(function(i){i[i.NONE=0]="NONE",i[i.TILT=1]="TILT",i[i.ALTITUDE=2]="ALTITUDE",i[i.DISTANCE=4]="DISTANCE",i[i.COLLISION=8]="COLLISION",i[i.ALL=15]="ALL",i[i.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"})(dt||(dt={}));var Ee;(function(i){i[i.NONE=0]="NONE",i[i.ZOOM=1]="ZOOM",i[i.TUMBLE=2]="TUMBLE",i[i.LOOK_AROUND=3]="LOOK_AROUND",i[i.PAN=4]="PAN",i[i.ASCEND=5]="ASCEND"})(Ee||(Ee={}));var sa;(function(i){i[i.TUMBLE=0]="TUMBLE",i[i.LOOK_AROUND=1]="LOOK_AROUND"})(sa||(sa={}));let ir=class{constructor(e=dt.ALL,t=Ee.NONE,s=0,r=null,a=null,n=sa.TUMBLE){this.selection=e,this.interactionType=t,this.interactionFactor=s,this.interactionStartCamera=r,this.interactionDirection=a,this.tiltMode=n}};function Jh(i,e){return!!(i&e)}function xu(i,e,t,s,r,a){i!==0&&(t?(a.min=Math.min(a.min,e),a.max=Math.max(a.max,e)):s!=null?(a.min-=Math.max(0,(e-a.min)*(1-s)),a.max+=Math.max(0,(e-a.max)*(1-s))):r&&(a.min-=Math.max(0,e-a.min-r),a.max+=Math.max(0,e-a.max-r)))}const Co=new ir(dt.NONE);function Nb(i,e,t,s){return e=e||i.viewForward,le(s,e),ee(s,s,Math.sign(ue(e,t))),s}function LM(i,e,t=Co){const s=pg(i,e,t);if(s===0)return!1;const r=i.renderCoordsHelper,a=r.getAltitude(e.eye)+s,n=Nb(e,t.interactionDirection,VM(i,e,Math.sign(s),BM),zM),o=le(HM,e.viewForward),l=r.intersectInfiniteManifold(vo(e.eye,n),a,Tp);return e.eye=l??r.setAltitude(Tp,a,e.eye),e.center=ZC(Tp,e.eye,o,e.center),!0}function pg(i,e,t=Co){if(!NM(i,t)||!i.state.constraints.altitude)return 0;const s=UM(i.state.constraints.altitude,qM);FM(i,t,s);const r=i.renderCoordsHelper.getAltitude(e.eye),a=Z(r,s.min,s.max)-r;return Math.abs(a)<=1e-6?0:a}function NM(i,e){const t=i.state.constraints.altitude;return!(!i.state.isGlobal||!t)&&(e.interactionType!==Ee.TUMBLE||!Jh(e.selection,dt.TILT))}function FM(i,e,t){const s=e.interactionType;if(s===Ee.NONE)return;const{min:r,max:a}=t,{interactionStartCamera:n,interactionFactor:o}=e;if(!n)return;const l=s===Ee.TUMBLE||s===Ee.ZOOM,h=pg(i,n),d=h===0?0:i.renderCoordsHelper.getAltitude(n.eye);t.min=r,t.max=a,xu(h,d,l,o,.05*d,t)}function VM(i,e,t,s){return i.renderCoordsHelper.worldUpAtPosition(e.eye,s),ee(s,s,t),s}function UM(i,e){return e.min=i.min,e.max=i.max,e}const qM={min:0,max:0},zM=b(),BM=b(),HM=b(),Tp=b();function mg(i,e,t=Co){if(!i.state.isLocal)return 0;const s=i.state.constraints.distance;if(!i.pointsOfInterest.surfaceOrigin.renderLocation||s===1/0)return 0;Ac.min=0,Ac.max=s,kM(i,t,Ac);const r=_g(i,e),a=Ac.max-r;return a>=-1e-6?0:a}function GM(i,e,t=Co){const s=mg(i,e,t);if(s===0)return!1;const r=i.pointsOfInterest.surfaceOrigin;if(!r.renderLocation)return!1;const a=_g(i,e)+s,n=le(WM,e.eye),o=Nb(e,t.interactionDirection,jM(e,r.renderLocation,YM),XM);if(!Gu(_2(r.renderLocation,a),vo(e.eye,o),Dc))return!1;e.eye=Dc;const l=be(QM,e.eye,n);e.center=_e(Dc,e.center,l);const h=i.renderCoordsHelper.getAltitude(e.center),d=i.renderCoordsHelper.intersectInfiniteManifold(e.ray,h,Dc);return d!=null&&(e.center=d),!0}function kM(i,e,t){const s=e.interactionType;if(s===Ee.NONE)return;const{min:r,max:a}=t,{interactionStartCamera:n,interactionFactor:o}=e;if(!n)return;const l=s===Ee.ZOOM||s===Ee.PAN,h=mg(i,n),d=h===0?0:_g(i,n);t.min=r,t.max=a,xu(h,d,l,o,.05*d,t)}function _g(i,e){const t=i.pointsOfInterest.surfaceOrigin;return t.renderLocation?os(e.eye,t.renderLocation):0}function jM(i,e,t){return Lu(t,i.eye,e)}const Ac={min:0,max:0},WM=b(),QM=b(),XM=b(),YM=b(),Dc=b();function Dl(i,e,t=Ys.EYE){const s=i.state.constraints;if(!s.collision.enabled)return!1;const r=$_(i,e.eye),a=i.renderCoordsHelper.getAltitude(e.eye),n=r+s.collision.elevationMargin;if(a>=n)return!1;const o=xe(e.eye);if(be($c,e.center,e.eye),e.eye=i.renderCoordsHelper.setAltitude(ZM,n,e.eye),t===Ys.EYE_AND_CENTER)e.center=_e($c,e.eye,$c);else if(t===Ys.EYE_AND_CENTER_SCALE){const l=(o-a+n)/o;e.center=ee($c,e.center,l)}return!0}var Ys;(function(i){i[i.EYE=0]="EYE",i[i.EYE_AND_CENTER=1]="EYE_AND_CENTER",i[i.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})(Ys||(Ys={}));const $c=b(),ZM=b();function Cn(i,e,t){i.worldUpAtPosition(e,R0),be(Sp,t,e);const s=xe(Sp);return s===0?0:Kr(ue(Sp,R0)/s)}const R0=b(),Sp=b();function Fb(i,e,t,s=!0){Gl.eyeCenterDistance=0,Gl.requiresTwoSteps=!1;const r=gg(i,e,t,Co,Gl);if(r===0)return!1;switch(bn(Ic,-r,e.viewRight),t.tiltMode){case sa.LOOK_AROUND:Xt(za,e.viewForward,Ic),ee(za,za,Gl.eyeCenterDistance),e.center=_e(tn,e.eye,za);break;case sa.TUMBLE:be(za,e.center,e.eye),Xt(za,za,Ic),e.eye=be(tn,e.center,za);break;default:Cl(t.tiltMode)}return e.up=Xt(tn,e.up,Ic),!Gl.requiresTwoSteps||!s||Fb(i,e,t,!1)}function gg(i,e,t,s=Co,r){if(!i.state.constraints.tilt)return 0;const a=e.distance,n=i.state.constraints.tilt(a,oE);return nE(i,t,n),s.interactionType===Ee.TUMBLE&&Jh(s.selection,dt.ALTITUDE)&&Vb(i,s.interactionStartCamera,n),t.tiltMode===sa.LOOK_AROUND||s.tiltMode===sa.LOOK_AROUND?JM(i,e,n,r):KM(i,e,n)}function KM(i,e,t){const s=Cn(i.renderCoordsHelper,e.center,e.eye),r=s-Z(s,t.min,t.max);return ec(r)?r:0}function JM(i,e,t,s){switch(s&&(s.requiresTwoSteps=!1),i.viewingMode){case"global":return tE(i,e,t,s);case"local":return eE(i,e,t,s)}}function eE(i,e,t,s){const r=Cn(i.renderCoordsHelper,e.center,e.eye),a=Z(r,t.min,t.max),n=r-a;if(!ec(n))return 0;if(s){const o=i.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=i.renderCoordsHelper.getAltitude(e.eye)-o,h=Math.cos(a);Math.abs(h)>1e-4?s.eyeCenterDistance=l/h:s.eyeCenterDistance=e.distance}return n}function tE(i,e,t,s){const r=iE(i,e,lE),a=Z(r.tiltAtCenter,t.min,t.max);if(!ec(r.tiltAtCenter-a))return 0;let n,o;return r.centerIsOnSurface?(n=sE(r),o=rE(r,n)):(n=r.constraints.clampTilt(r.eyeCenterDistance,r.tiltAtCenter),s&&n<Math.PI/2&&(s.requiresTwoSteps=!0,n=Math.PI/2-1e-5),o=aE(r,n)),s&&(s.eyeCenterDistance=Km(r,n)),o}function iE(i,e,t){const s=i.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=s+Ut(i.spatialReference).radius,a=i.renderCoordsHelper.intersectManifold(e.ray,s,tn);return t.eyeCenterDistance=e.distance,t.centerIsOnSurface=!1,a!=null?(t.eyeCenterDistance=os(e.eye,a),t.tiltAtCenter=Cn(i.renderCoordsHelper,a,e.eye),t.centerIsOnSurface=!0):i.state.isLocal?t.tiltAtCenter=Cn(i.renderCoordsHelper,e.center,e.eye):(ku(Z_(K_,r),e.ray,tn),t.eyeCenterDistance=os(e.eye,tn),t.tiltAtCenter=Kr(-ue(e.viewForward,oe(tn,tn)))),t.radius=r,t.eyeRadius=xe(e.eye),t.constraints=i.state.constraints,t}function ec(i){return Math.abs(i)>1e-9}function sE(i){const{constraints:e,eyeCenterDistance:t,tiltAtCenter:s}=i;let r=s,a=e.clampTilt(t,s);const n=Km(i,a);if(e.clampTilt(n,s)===a)return a;let o=0;for(;o<10&&ec(a-r);){const l=(r+a)/2,h=Km(i,l);ec(e.clampTilt(h,l)-l)?r=l:a=l,o++}return a}function Km(i,e){if(!i.centerIsOnSurface)return i.eyeCenterDistance;const t=Math.PI-Z(e,0,Math.PI),s=Kd(i.radius/i.eyeRadius*Math.sin(t)),r=Math.PI-t-s,a=Math.sin(r)/Math.sin(t);if(i.eyeRadius<i.radius&&a>1){const n=Math.PI-s,o=Math.PI-t-n;return Math.sin(o)/Math.sin(t)*i.eyeRadius}return a*i.eyeRadius}function rE(i,e){const t=Kd(i.radius/i.eyeRadius*Math.sin(i.tiltAtCenter)),s=Kd(i.radius/i.eyeRadius*Math.sin(e));return i.eyeRadius>i.radius?t-s:s-t}function aE(i,e){return i.tiltAtCenter-Math.PI/2-(e-Math.PI/2)}function nE(i,e,t){if(e.interactionType===Ee.NONE)return;const{interactionStartCamera:s,interactionFactor:r}=e;if(!s)return;const{min:a,max:n}=t,o=gg(i,s,Co,e),l=o===0?0:Cn(i.renderCoordsHelper,s.center,s.eye);t.min=a,t.max=n,e.interactionType===Ee.TUMBLE?(Jh(e.selection,dt.ALTITUDE)&&Vb(i,s,t),xu(o,l,!0,r,O0,t)):xu(o,l,!1,r,O0,t)}function Vb(i,e,t){const s=i.state.constraints;if(i.state.isLocal||!s.altitude||!e)return;const r=gr(e.center),a=Math.sqrt(r),n=e.distance,o=Ut(i.spatialReference).radius,l=s.altitude.min+o,h=s.altitude.max+o,d=(l*l-n*n-r)/(-2*a*n),u=(h*h-n*n-r)/(-2*a*n);t.min=Math.max(t.min,Math.min(Math.PI-Kr(u),t.max)),t.max=Math.min(t.max,Math.PI-Kr(d))}const za=b(),Ic=Qe(),tn=b(),O0=Tt(5),oE={min:0,max:0},lE={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},Gl={eyeCenterDistance:0,requiresTwoSteps:!1};function Bt(i,e,t=uE,s=e){s!==e&&s.copyFrom(e),s.computeUp(i.state.viewingMode);let r=!1;for(let o=0;o<pE;o++){let l=0;for(const h of dE)if(Jh(t.selection,h.type)){const d=Math.abs(h.error(i,s,t));h.apply(i,s,t)&&(r=!0,l+=d)}if(l===0)break}const a=Jh(t.selection,dt.COLLISION),n=hE(t.interactionType,i);return a&&Dl(i,s,n)&&(r=!0),r&&s.computeUp(i.state.viewingMode),r}function hE(i,e){switch(i){case Ee.PAN:return Ys.EYE_AND_CENTER;case Ee.ASCEND:return e.state.isGlobal?Ys.EYE_AND_CENTER_SCALE:Ys.EYE_AND_CENTER;default:return Ys.EYE}}function _r(i){const e=Math.min(1,i/150);return OT(e)}function cE(i,e,t){return gg(i,e,t)*e.distance}const dE=[{type:dt.TILT,error:cE,apply:Fb},{type:dt.ALTITUDE,error:pg,apply:LM},{type:dt.DISTANCE,error:mg,apply:GM}],uE=new ir,pE=5;let M0=class{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=b(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=gn(E0),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,t){if(this.viewingMode===$e.Global){const a=(xe(this.center)+xe(e.center))/2;t.pan=Dm(this.center,e.center)*a}else t.pan=os(this.center,e.center);let s=Math.abs(e._yaw-this._yaw);s>=Math.PI&&(s=2*Math.PI-s);const r=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(s,r),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}interpolate(e,t,s){this.viewingMode===$e.Global?DS(e.center,t.center,s.pan,this.center):Tr(this.center,e.center,t.center,s.pan),this._distance=isFinite(t.distance)?Be(e.distance,t.distance+s.zoomOffset,s.zoom):e.distance,this._pitch=Be(e.pitch,t.pitch,s.rotate);let r=e._yaw;const a=t._yaw;Math.abs(a-r)>=Math.PI&&(r+=2*(r<a?1:-1)*Math.PI),this._yaw=Be(r,a,s.rotate),this._fov=Be(e.fov,t.fov,s.fov)}copyFrom(e){le(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,le(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,A0);le(this.center,e.center),be(Ci,e.center,e.eye),Pa(Ci,Ci,t),Pa(Ha,e.up,t),this._distance=xe(Ci),this._distance!==0&&(Ci[0]/=this._distance,Ci[1]/=this._distance,Ci[2]/=this._distance),this._pitch=this._eyeUpToPitch(Ci),this._yaw=mE(Ci,Ha),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,A0);Hu(t,t),this._axisAngleVec3(Td,this._pitch-Math.PI/2,E0,Ci),this._axisAngleVec3(io,this._yaw,Ci,Ci),this._axisAngleVec3(Td,this._pitch-Math.PI/2,io,Ha),this._axisAngleVec3(io,this._yaw,Ha,Ha),ee(Ci,Ci,this._distance),Pa(Ci,Ci,t),Pa(Ha,Ha,t),e.center=this.center,e.eye=be(Ci,this.center,Ci),e.up=Ha,e.fov=this._fov}_axisAngleVec3(e,t,s,r){const a=Math.cos(t),n=Math.sin(t);return ee(Rs,s,a),yt(gs,e,s),ee(gs,gs,n),ee(Ba,e,(1-a)*ue(e,s)),_e(r,_e(r,Rs,gs),Ba)}_lookAtOrientation(e,t=La()){return this._upAtLookAt(e,Ba),yt(Rs,this.direction,Ba),oe(Rs,Rs),Rs[0]===0&&Rs[1]===0&&Rs[2]===0&&le(Rs,Td),yt(gs,Ba,Rs),oe(gs,gs),t[0]=Rs[0],t[1]=gs[0],t[2]=Ba[0],t[3]=Rs[1],t[4]=gs[1],t[5]=Ba[1],t[6]=Rs[2],t[7]=gs[2],t[8]=Ba[2],t}_upAtLookAt(e,t){return this.viewingMode===$e.Local?le(t,io):oe(t,e)}_eyeUpToPitch(e){return Math.PI-Dm(io,e)}};function mE(i,e){const t=_E;return Math.abs(e[2])<.5?(le(t,e),i[2]>0&&ee(t,t,-1)):le(t,i),yt(gs,t,io),oe(gs,gs),Dm(Td,gs,io)}const Rs=b(),gs=b(),Ba=b(),Ci=b(),Ha=b(),_E=b(),io=UC,E0=qC,Td=zC,A0=La();let gE=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=ct(0),this._animation=new MT(()=>new M0(e)),this._current=new M0(e)}update(e,t,s){const{source:r,target:a}=this._animation.definition,n=be(fE,t.center,e.center),o=xe(n);o>=1e-5?(n[0]/=o,n[1]/=o,n[2]/=o):(n[0]=0,n[1]=1,n[0]=0),le(r.direction,n),le(a.direction,n),r.copyFromRenderCamera(e),a.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,a,s),this.currentTime=ct(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){return this._animation.cameraAt(e,this._current),t=t||new Ct,this._current.copyToRenderCamera(t),t}step(e,t){return this.finished||(this.currentTime=ct(this.currentTime+OC(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}};const fE=b();var wt;(function(i){i[i.Ready=0]="Ready",i[i.Rejected=1]="Rejected",i[i.Running=2]="Running",i[i.Stopped=3]="Stopped",i[i.Finished=4]="Finished"})(wt||(wt={}));let xa=class extends Re{constructor(e){super(e),this.state=wt.Ready}get active(){return this.state===wt.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=wt.Stopped,!0)}finishController(){this.state=wt.Finished}get steppingFinished(){return!1}};c([p({constructOnly:!0})],xa.prototype,"view",void 0),c([p({readOnly:!0})],xa.prototype,"active",null),c([p()],xa.prototype,"state",void 0),c([p({readOnly:!0})],xa.prototype,"isInteractive",null),xa=c([F("esri.views.3d.state.controllers.CameraController")],xa);let tc=class extends xa{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(vr()),this._asyncResult=null),this.state===wt.Finished||this.state===wt.Stopped?(MC(e),this.state===wt.Finished?e.resolve():e.reject(vr())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=wt.Running,this.viewAnimation!=null&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){this.viewAnimation==null||this.state!==wt.Ready&&this.state!==wt.Running||(this.viewAnimation.state===xl.State.FINISHED?this.finish():this.viewAnimation.state===xl.State.STOPPED&&(this.state=wt.Stopped))}onControllerEnd(){this.viewAnimation==null||this.viewAnimation.done||(this.state===wt.Finished?this.viewAnimation.finish():this.state===wt.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===wt.Finished?this._asyncResult.resolve():this._asyncResult.reject(vr()))}finish(){this.finishController()}};tc=c([F("esri.views.3d.state.controllers.AnimationController")],tc);let Oa=class extends tc{get intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new gE(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new xl}get isInteractive(){return this.mode==="interaction"}begin(e,t){this._hasTarget=!0;const s=this.animationSettings(t);Lc.copyFrom(this.view.state.camera);const r=Na(this.view.state.viewingMode);this.intersectionHelper.intersectRay(Lc.ray,r,D0)&&(Lc.center=D0),this.animation.update(Lc,e,s),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:typeof e.easing=="string"?ET[e.easing]:e.easing}}};c([p({constructOnly:!0})],Oa.prototype,"mode",void 0),c([p({readOnly:!0})],Oa.prototype,"isInteractive",null),Oa=c([F("esri.views.3d.state.controllers.PointToPointAnimationController")],Oa);const Lc=new Ct,D0=b();function Zu(i=yE){return[i[0],i[1],i[2],i[3]]}function ic(i,e){return vE(i[0],i[1],i[2],e,T2.get())}function vE(i,e,t,s,r=Zu()){return r[0]=i,r[1]=e,r[2]=t,r[3]=s,r}function fg(i,e,t){return yt(t,i,e),oe(t,t),t[3]=k1(i,e),t}const yE=[0,0,1,0];function vg(i,e,t,s){const r=Al(e,t,bE);return Gu(i,r,s)}const bE=El();var Tl;(function(i){i[i.Ellipsoid=0]="Ellipsoid",i[i.Silhouette=1]="Silhouette"})(Tl||(Tl={}));const Ub=30,Cu=[1,3e8],Ku=80,qb=8,zb=200,Bb=1508e5,Hb=5,Gb=50,wE=5,xE=10,Pp=90,To={exclude:new Set([Xh])};function po(i,e,t){return t[0]=e[0]/(i.fullWidth/i.pixelRatio),t[1]=e[1]/(i.fullHeight/i.pixelRatio),t}function Jm(i){for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}function Tn(i,e,t){const s=bn(S2.get(),t[3],t);s==null||t2(s,ho)||(be(Ke,i.eye,e),Xt(Ke,Ke,s),i.eye=_e(Ke,Ke,e),be(Ke,i.center,e),Xt(Ke,Ke,s),i.center=_e(Ke,Ke,e),i.up=Xt(Ke,i.up,s))}function CE(i,e,t,s){return J_(i,Q1(e,t,wg),s)}function e_(i,e,t,s){return J_(i,Al(e,t,wg),s)}function yg(i,e,t,s){const r=Et.get();let a=1-t;be(r,e,i.eye);const n=xe(r);let o=n*(1-a);a>=0&&o<s&&(o=s,a=-(o-n)/n),Math.abs(n-o)<1e-6||(ee(r,r,a),i.eye=_e(Ke,i.eye,r),i.center=Tr(Ke,i.center,e,a))}function kb(i,e,t){e.getScreenCenter($0),vg(i,e,$0,Ke)&&(e.center=Ke);const s=e.distance,r=s*t;if(Math.abs(s-r)<1e-6)return;const a=ee(Et.get(),e.viewForward,r);e.eye=be(Ke,e.center,a)}const $0=Ht();function Rp(i,e){it(e,0,0,0);for(const t of i)_e(e,e,t);ee(e,e,1/i.length)}function Sd(i,e,t,s){return Math.sin(i/xe(e))*(t+s.radius)}function I0(i,e,t,s){return Sd(Math.PI/2,e,t,s)+(i-Math.PI/2)}var Oi;(function(i){i[i.Vertical=0]="Vertical",i[i.Horizontal=1]="Horizontal"})(Oi||(Oi={}));const L0={Elevation:3e4,Angle:Tt(16)},Nc={Pole:.95,Angle:Tt(18),Tilt:45},jb=Tt(80);function Wb(i,e,t,s,r,a){const n=b(),o=Sr();let l=!0,h=!0;return i.intersectScreen(t,n,a)?o[3]=xe(n):(h=!1,e.aboveGround&&r!==Tl.Ellipsoid?o[3]=Math.max(xe(e.center),.9*s.radius):o[3]=xe(e.eye)-e.relativeElevation,r===Tl.Silhouette?sc(o,e,t,n):l=vg(o,e,t,n)),{sphere:o,scenePickPoint:l?n:null,hasGeometryIntersection:h}}function vc(i,e,t,s){const r=i.relativeElevation;if(r>L0.Elevation&&s==="global")return Oi.Horizontal;Al(i,e,Mp);const a=Math.sign(r),n=t.worldUpAtPosition(i.eye,Ke);return-a*ue(n,Mp.direction)<Math.sin(L0.Angle)*xe(Mp.direction)?Oi.Vertical:Oi.Horizontal}function Qb(i,e,t){be(Op,t,e),i.eye=be(Ke,i.eye,Op),i.center=be(Ke,i.center,Op)}const Op=b();function sc(i,e,t,s){const r=Al(e,t,wg);return r!=null&&(ku(i,r,Fc),Gu(i,r,s)?!(ln(Fc,r.origin)<ln(s,r.origin))||(le(s,Fc),!1):(be(Lo,e.eye,e.center),oe(Lo,Lo),j1(Lo,-ue(oe(Lo,Lo),Fc),N0),J_(N0,r,s),!1))}const Fc=b(),Lo=b(),N0=yo();function Xb(i,e,t,s,r,a){let n=0;if(yt(Pu,i,e),be(zc,i,e),xe(i)<=r||!s.aboveGround){yt(t,zc,s.eye);const o=ue(i,e)/(xe(i)*xe(e));if(o<.9999)n=Kr(o);else{const h=xe(yt(b(),i,e))/(xe(i)*xe(e));n=Kd(h)}const l=Math.cos(Z(wn.normalize(Tt(a)),0,jb));n=-n-Math.max(0,xe(e)-r)/(l*r)}else be(F0,s.eye,s.center),yt(t,zc,F0),n=-xe(zc)/r;return oe(t,t),ee(t,t,xe(Pu)),n}const F0=b();function V0(i,e,t,s){let r,a;const n=Math.cos(Z(wn.normalize(Tt(s)),0,jb));return r=e>t?-(e-t)/(n*t):e<-t?Math.PI-(e+t)/(n*t):Kr(e/t),a=i>t?-(i-t)/(n*t):i<-t?Math.PI-(i+t)/(n*t):Kr(i/t),(a-r)*t}function TE(i,e,t,s,r,a,n,o,l,h){const d=V0(i[2],e[2],a[3],o),u=l?V0(i[0],e[0],a[3],180):e[0]-i[0],m=Math.sin(n)*u-Math.cos(n)*d,_=Math.cos(n)*u+Math.sin(n)*d;oe(Ke,r);const f=l?m/Math.sqrt(Math.abs(a[3]**2-ue(t,Ke)**2)):m/a[3],g=_/Math.sqrt(Math.abs(a[3]**2-ue(t,s)**2));Aa(h,f,g)}function Yb(i,e,t,s,r,a,n,o,l,h){yt(Pu,i,e),Pm(a.up,a.eye,Vc,Uc,qc),Pm([0,0,1],a.eye,Ia,un,ew),le(t,un),le(s,Ia),oe(t,t),ee(t,t,xe(Pu)),bf(i,oe(Uc,Uc),oe(qc,qc),oe(Vc,Vc),U0),bf(e,Uc,qc,Vc,q0),TE(U0,q0,i,Ia,un,n,o,l,h,r)}function SE(i,e,t,s,r,a,n){bn(Tu,r,s),bn(Su,n,a),Ks(al,Tu,Su),be(e,i,t),Xt(e,e,al),_e(e,e,t)}function Zb(i,e,t,s,r,a){bn(Tu,s,t),bn(Su,a,r),Ks(al,Tu,Su),be(Ke,i.eye,e),Xt(Ke,Ke,al),i.eye=_e(Ke,Ke,e),be(Ke,i.center,e),Xt(Ke,Ke,al),i.center=_e(Ke,Ke,e),be(Ke,i.up,e),Xt(Ke,Ke,al),i.up=_e(Ke,Ke,e)}function bg(i,e,t,s,r,a){return(Math.abs(s)>Math.PI-Nc.Angle||Math.abs(s)<Nc.Angle)&&(Math.abs(i[2])<t*Nc.Pole||Math.abs(e)>t)&&a.aboveGround&&r<Nc.Tilt}function Kb(i,e,t,s,r,a){if(a)fg(t,s,z0),Tn(e,qt(i),z0);else{const n=Xb(t,s,B0,e,i[3],r);Tn(e,qt(i),ic(B0,n))}}function Jb(i,e,t,s,r,a,n){const o=n?20:1,l=1e-12;let h,d;le($n,s),Bc.copyFrom(e);for(let u=0;u<o&&ln(t,$n)>l&&(h=ln(t,$n),Yb(t,$n,un,Ia,kl,Bc,i,r,a,n),Zb(Bc,qt(i),Ia,kl[1],un,kl[0]),SE($n,$n,qt(i),Ia,kl[1],un,kl[0]),d=ln(t,$n),d<h||u===0);u++)e.copyFrom(Bc)}function PE(i,e,t,s,r,a,n){bg(t,ue(e.up,t),i[3],-wn.normalize(Tt(r)),a,e)?Jb(i,e,t,s,-wn.normalize(Tt(r)),a,n):Kb(i,e,t,s,a,n)}function RE(i,e,t,s,r,a){const{eye:n}=i;Pm([0,0,1],n,Ia,un,ew);const o=e.translation[0]*t.pan,l=r.mode==="zoom"?0:e.translation[1]*t.pan,h=Math.max(Math.sqrt(Math.abs(1-ue(i.center,Ia)**2/xe(i.center)**2)),.5),d=(Math.sin(a)*l+Math.cos(a)*o)/h,u=-Math.cos(a)*l+Math.sin(a)*o;switch(Ra(s.pan.matrix,s.pan.matrix,d,Ia),s.pan.enabled=!0,r.mode){case"pan":Ra(s.pan.matrix,s.pan.matrix,u,un),s.pan.enabled=!0;break;case"zoom":s.zoom=-e.translation[1]*t.zoom}}function OE(i,e,t,s,r){const{eye:a,viewRight:n}=i,o=yt(Et.get(),n,a),l=e.translation[0]*t.pan;switch(l!==0&&(Ra(s.pan.matrix,s.pan.matrix,-l,o),s.pan.enabled=!0),r.mode){case"pan":{const h=e.translation[1]*t.pan;h!==0&&(Ra(s.pan.matrix,s.pan.matrix,h,n),s.pan.enabled=!0);break}case"zoom":s.zoom=-e.translation[1]*t.zoom}}function ME(i,e,t,s,r,a,n,o,l){bg(i.center,ue(i.up,i.center),xe(i.center),-wn.normalize(Tt(a)),n,e)?RE(e,t,s,o,l,-wn.normalize(Tt(r))):OE(e,t,s,o,l)}const Ia=b(),un=b(),ew=b(),Vc=b(),Uc=b(),qc=b(),U0=b(),q0=b(),kl=Hi(),z0=Zu(),Tu=Qe(),Su=Qe(),al=Qe(),$n=b(),Ke=b(),zc=b(),Bc=new Ct,Pu=b(),B0=b(),wg={origin:b(),direction:b()},Mp={origin:b(),direction:b()},H0=.6,Ep=4,EE=60;let Ru=class extends Oa{constructor(){super(...arguments),this._zoomLocation=b(),this._tmpCamera=new Ct,this._tmpViewDir=b(),this._tmpRayDir={origin:b(),direction:b()},this._targetOnSphere=b(),this._tmpCenter=b(),this._beginCamera=new Ct,this._constraintOptions=new ir(dt.ALL_EXCEPT_COLLISION,Ee.ZOOM,null,this._beginCamera),this._sphere=Sr()}initialize(){this._intersector=Na(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const s=this.view.state;this.animation.finished?this._beginCamera.copyFrom(s.camera):this.animation.cameraAt(1,this._beginCamera);let r=!1,a=!1;this.intersectionHelper.intersectScreen(t,this._zoomLocation,this.view.map.ground.opacity===0?To:{})&&(r=e>0,a=!0),this._tmpCamera.copyFrom(s.camera),r?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:le(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,t,a),this.begin(this._tmpCamera)}animationSettings(){return{duration:ct(600),easing:i1}}_updateCamera(e,t,s,r,a){const n=vc(e,r,this.view.renderCoordsHelper,this.view.viewingMode),o=Math.abs(this.view.camera.position.z);oe(Gc,e.eye),ee(Gc,Gc,-1),Al(e,r,this._tmpRayDir),oe(this._tmpRayDir.direction,this._tmpRayDir.direction);const l=Z(Math.min(qb,1/Math.abs(ue(Gc,this._tmpRayDir.direction)))*o,zb,Bb);if(n===Oi.Horizontal){let h=H0**t;this._sphere[3]=xe(s),be(this._tmpViewDir,e.center,e.eye);const d=Math.min(xe(this._tmpViewDir),l);let u=d*h;if(h<=1&&u<Ep&&(u=Ep,h=u/d),Math.abs(d-u)<1e-6)return;const m=xe(e.center);if(this._sphere[3]!==m){const _=this._sphere[3]+h*(m-this._sphere[3]);e.center=ee(Hc,e.center,_/m)}ee(this._tmpViewDir,this._tmpViewDir,-h),e.eye=_e(Hc,e.center,this._tmpViewDir),Bt(this.view,e,this._constraintOptions),ln(s,e.center)>1e-12&&vg(this._sphere,e,r,this._targetOnSphere)&&PE(this._sphere,e,s,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let h=H0**Math.abs(t);const d=t>0?1:-1;be(this._tmpViewDir,s,e.eye);const u=xe(this._tmpViewDir),m=this.view._stage.renderView.getMinimalDepthForArea(null,r[0],r[1],this.view.state.camera,EE);let _=m??l;_=a&&t>0?Math.min(_,u):_,ee(this._tmpRayDir.direction,this._tmpRayDir.direction,_),_e(s,this._tmpRayDir.origin,this._tmpRayDir.direction);let f=_*h;const g=Math.max(Ep,1.01*e.nearFar[0]);if(t>0&&f<g&&(f=g,h=f/_),Math.abs(_-f)<1e-6)return;ee(this._tmpRayDir.direction,this._tmpRayDir.direction,d*(1-h)),e.eye=_e(Hc,e.eye,this._tmpRayDir.direction),e.center=_e(Hc,e.center,this._tmpRayDir.direction)}Dl(this.view,e)}};Ru=c([F("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],Ru);const Hc=b(),Gc=b();let Pd,Rd=null;const fl=new Map;async function EU(i){Rd==null&&(Pd==null&&(Pd=ae(()=>import("./VoxelWasmPerSceneView-BkLBGcGF.js"),__vite__mapDeps([522,1,2,3,85,30,14,10,11,12,13,5,6,15,9,86,40,7,8,27,28,29,26,32,33,87,88,25,31,34,35,36,37,22,38,39,89,192,201,61,78,91,4,16,17,159,90,81,68,53,41,69,59,60,70,43,71,72,80,66,82,58,76,77,79,92,249,250,170,65,48,56,51,104,171,42,44,45,46,47,49,50,52,54,55,57,62,63,64,67,73,74,75,83,84,93,94,95,96,97,98,99,100,101,102,103,105,106,107,108,109,194,195,196,197,198,199,200,20,24,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,160,161,162,163,164,165,166,167,168,169,183,202,180,203,204,205,206,207,208,209,210,211,212,213,214,215,191,216,217,218,219,220,221,222,223,224,19,21,225,226,227,228,229,230,231,232,233,234,235,236,237,172,173,174,238,239,240,241,242,243,244,245,246,247,248,251,252,253,188,189,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,175]),import.meta.url)),Rd=await Pd);const e=i.view;let t=fl.get(e);return t||(t=new Rd.default({view:e}),fl.set(e,t)),t.addVoxelLayer(i)}function rc(i){return fl.get(i)}function AU(i){const e=i.view,t=fl.get(e);t&&t.removeVoxelLayer(i)<1&&(fl.delete(e),fl.size===0&&(Pd=null,Rd=null))}const AE=.6,DE=4,$E=60;let Ou=class extends Oa{constructor(){super(...arguments),this._zoomLocation=b(),this._tmpCamera=new Ct,this._tmpRayDir=b(),this._tmpCenter=b(),this._beginCamera=new Ct,this._constraintOptions=new ir(dt.ALL,Ee.ZOOM,null,this._beginCamera)}zoomStep(e,t){if(!this.active)return;const s=this.view.state;this.animation.finished?this._beginCamera.copyFrom(s.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(s.camera);const r=Na(this.view.state.viewingMode);let a=!1;e>0?(a=this.intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.map.ground.opacity===0?To:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:le(this._zoomLocation,this._tmpCamera.center);const n=AE**e;let o=this.view._stage.renderView.getMinimalDepthForArea(rc(this.view),t[0],t[1],this.view.state.camera,$E);be(kc,this._tmpCamera.eye,this._zoomLocation),oe(kc,kc);const l=Z(Math.min(qb,1/Math.abs(ue(IE,kc)))*Math.abs(this.view.camera.position.z),zb,Bb);if(o=o??l,o){const h=b();be(h,this._zoomLocation,this._tmpCamera.eye),(o<xe(h)||!a)&&(oe(h,h),_e(this._zoomLocation,this._tmpCamera.eye,ee(h,h,o)))}this._updateCamera(this._tmpCamera,n,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:ct(600),easing:i1}}_updateCamera(e,t,s){be(this._tmpRayDir,s,e.eye);const r=xe(this._tmpRayDir);let a=r*t;const n=t<=1,o=Math.max(DE,1.01*e.nearFar[0]);a!==0&&(n&&a<o&&(a=o,t=a/r),Math.abs(r-a)<1e-6||(ee(this._tmpRayDir,this._tmpRayDir,t),e.eye=be(G0,s,this._tmpRayDir),e.center=Tr(G0,e.center,s,1-t),Bt(this.view,e,this._constraintOptions)))}};Ou=c([F("esri.views.3d.state.controllers.ZoomStepControllerLocal")],Ou);const G0=b(),IE=St(0,0,1),kc=b();let LE=class extends Rr{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,s=>this._handleDoubleClick(s))}_handleDoubleClick(e){const t=e.data;if(AT(t,"primary")){const s=this._view.state.isGlobal?new Ru({view:this._view,mode:"animation"}):new Ou({view:this._view,mode:"animation"});this._view.state.switchCameraController(s),s.zoomStep(Math.log(.5)/Math.log(.6),Ht(t.x,t.y)),e.stopPropagation()}}};function NE(i,e,t){return i===$e.Global?new VE(t):new FE(e,t)}let FE=class{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=Ut(t),this._unitInMeters=c1(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,s,r,a){var T;a||(a={near:0,far:0});let n=e[2]*this._unitInMeters;const o=n,l=n-r,h=(T=this._elevationProvider)==null?void 0:T.visibleElevationBounds;h&&(n=l>=0?o-this._unitInMeters*h.min:this._unitInMeters*h.max-o);const d={x:(s=s??new zr({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-s.xmin,y:s.ymax-s.ymin,z:4*Math.max(s.xmax-s.xmin,s.ymax-s.ymin)},u=Math.max(d.x,d.y,d.z);be(In,t,e),No[0]=In[0]>0?s.xmax:s.xmin,No[1]=In[1]>0?s.ymax:s.ymin,No[2]=In[2]>0?u/2:-u/2,be(No,No,e),oe(In,In);const m=1.1*ue(No,In)*this._unitInMeters,_=Math.sqrt(n*(n+2*this._referenceEllipsoid.radius)),f=Math.max(s.xmax-s.xmin,s.ymax-s.ymin),g=f*zE*this._unitInMeters,y=f*BE*this._unitInMeters,w=Z((n-y)/(g-y),0,1)**3,x=Math.min(Be(_,m,w),_)*Math.max(Math.log(Math.abs(l)),1);return tw(Math.min(x,Math.max(34064e4,u))/this._unitInMeters,UE,this._unitInMeters,a)}},VE=class{constructor(e){this._referenceEllipsoid=Ut(e)}compute(e,t,s,r,a){a||(a={near:0,far:0});const n=xe(e),o=n-this._referenceEllipsoid.radius,l=this._referenceEllipsoid.radius+Math.min(0,r),h=Math.abs(o-r),d=Math.max(h,Math.abs(o)),u=Math.sqrt(d*(d+2*l)),m=n+this._referenceEllipsoid.radius;return tw(1.2*Be(u,m,ag(d)),Z(2e4-(Math.log(d)-7.983)/9.011*19900,100,2e4),1,a)}};function tw(i,e,t,s){const r=qE/t;return i/e>r?(s.far=i,s.near=s.far/e):(s.near=r,s.far=s.near*e),s}const UE=2e4,qE=2,zE=.001,BE=1e-4,No=b(),In=b();let Od=class extends Re{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;e.spatialReference!=null&&n1(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>Dl(this.view,e,Ys.EYE_AND_CENTER))}};c([p({constructOnly:!0})],Od.prototype,"view",void 0),Od=c([F("esri.views.3d.state.SurfaceCollisionConstraint")],Od);let dh=class extends Re{constructor(e){super(e),this.nearFarHeuristic=NE(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([M(()=>{var e,t,s,r;return[(t=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:t.near,(r=(s=this.view.constraints)==null?void 0:s.clipDistance)==null?void 0:r.far]},()=>this._clipDistanceNearFarChanged()),M(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:t.mode},()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e)),M(()=>this.view.renderDataExtent,()=>this._updateNearFar(),nt),M(()=>{var e,t,s,r;return[(t=(e=this.view.constraints)==null?void 0:e.altitude)==null?void 0:t.min,(r=(s=this.view.constraints)==null?void 0:s.altitude)==null?void 0:r.max]},()=>this._updateAltitude(),nt),M(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:t.max},()=>this._updateTiltMax(),nt),M(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:t.mode},()=>this._updateTilt(),nt),M(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this._updateTiltAutoMax(),nt),M(()=>{var e,t,s,r,a,n;return[(s=(t=(e=this.view.map)==null?void 0:e.ground)==null?void 0:t.navigationConstraint)==null?void 0:s.type,(n=(a=(r=this.view.state)==null?void 0:r.constraints)==null?void 0:a.collision)==null?void 0:n.enabled]},()=>this._updateCollision(),nt)]),this.view.state.isLocal&&this.addHandles(M(()=>this.view.renderDataExtent,e=>this._updateLocalSurfaceDistance(e),si)),this._updateNearFar(),this.view.state.viewingMode!==$e.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new Od({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var t;const e=(t=this.view.constraints)==null?void 0:t.clipDistance;e&&e.mode!=="auto"&&this.view.state.updateCamera(s=>k0(s,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;(t?t.mode:"auto")==="manual"?k0(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,$_(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCollision(){var r,a,n;const e=(n=(a=(r=this.view.map)==null?void 0:r.ground)==null?void 0:a.navigationConstraint)==null?void 0:n.type,t=!e||e==="stay-above",s=this.view.state.constraints.collision;if(t!==s.enabled){s.enabled=t,t&&this._reapplyConstraints(dt.COLLISION);const o=this.view.constraints&&this.view.constraints.tilt;o&&o.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==$e.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;(e?e.mode:"auto")==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(Tt(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||e.mode!=="auto")return;const t=this.view.state.constraints;if(t.tilt){const s=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(Zd(s))}}_updateLocalSurfaceDistance(e){if(e==null)return;let t=Math.max(e.width,e.height);if(t<=0)return;e.zmax!=null&&e.zmin!=null&&(t=Math.max(t,e.zmax-e.zmin));const s=this.view.state,r=3*t/Math.atan(s.camera.fov/2);r!==s.constraints.distance&&(s.constraints.distance=r)}_reapplyConstraints(e=dt.ALL){this.view.state.updateCamera(t=>Bt(this.view,t,new ir(e,Ee.NONE,null)))}};function k0(i,e){e&&(i.near=e.near,i.far=e.far)}c([p({constructOnly:!0})],dh.prototype,"view",void 0),c([p({readOnly:!0})],dh.prototype,"surfaceCollisionConstraint",void 0),dh=c([F("esri.views.3d.state.ConstraintsManager")],dh);let nn=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=mu(),this._points=E2(),this.lines=new Array(12),this._origin=b(),this._direction=b(),this._altitude=null;for(let t=0;t<12;t++)this.lines[t]={origin:null,direction:b(),endpoint:null}}update(e){A2(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),le(this._origin,e.eye),le(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)le(this._points[t],e[t]);D2(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return ju(this.frustum,e)}intersectsRay(e){return $2(this.frustum,e)}intersectsLineSegment(e,t){return I2(this.frustum,e,t)}intersectsPoint(e){return L2(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const s=t+4;Ap(this.lines[t],e[t],e[s]),Ap(this.lines[t+4],e[t],t===3?e[0]:e[t+1]),Ap(this.lines[t+8],e[s],t===3?e[4]:e[s+1])}}};function Ap(i,e,t){i.origin=e,i.endpoint=t,Lu(i.direction,e,t)}nn.planePointIndices=N2,nn.nearFarLineIndices=[[gt.NEAR_BOTTOM_LEFT,gt.FAR_BOTTOM_LEFT],[gt.NEAR_BOTTOM_RIGHT,gt.FAR_BOTTOM_RIGHT],[gt.NEAR_TOP_RIGHT,gt.FAR_TOP_RIGHT],[gt.NEAR_TOP_LEFT,gt.FAR_TOP_LEFT]];let Oh=class extends xa{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=wt.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(e.spatialReference==null||n1(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),Dl(this.view,e,Ys.EYE_AND_CENTER)||this.constraintEnabled||(this.state=wt.Stopped)})}};c([p({constructOnly:!0})],Oh.prototype,"desiredCamera",null),Oh=c([F("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],Oh);let HE=class{constructor(e,t,s){this._target=e,this._options=t,this.view=s,this.state="pending",this._animationController=null,this.promise=new Promise((r,a)=>{this._resolveCallback=r,this._rejectCallback=a;const n=new AbortController;this._options.signal!=null&&O_(this._options.signal,()=>{this.abort()}),this._abortController=n,this._waitForReady()})}_resolve(e){if(this.state!=="finished")return this.state="finished",this._resolveCallback(e)}_reject(e){if(this.state!=="finished")return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),this.state==="wait-for-animation-finish"&&!e&&this._animationController!=null&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this._reject(vr())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await wm(()=>this.view.ready,this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()}async _createViewPoint(){if(this.state!=="finished"){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{const e=await XT(this.view,this._target,this._abortController.signal);if(this.state==="finished")return;const t=e?this._getCameraFromViewpoint(e):null;if(t==null)return;if(this._options.animate){if(this._animationController==null)return;this._startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}}_getCameraFromViewpoint(e){var a;const t=!!(this._target instanceof Fh&&this._target.camera||this._target instanceof _o),s=e.camera;if(s==null)return null;if(!this.view.stateManager.isCompatible(s)){const n=s.position,o=n&&n.spatialReference,l=o?o.wkid:"none",h=(a=this.view.spatialReference)==null?void 0:a.wkid;return this._reject(new xs("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${l}, view: ${h})`,{camera:s})),null}const r=ja(this.view,s);return r==null?(this._reject(new xs("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:r,isFullySpecified:t}}_startAnimation(e,t){this.state="wait-for-animation-finish";const s=t.viewAnimation;if(s==null)return void this._reject(new xs("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(s.update(e.viewpoint,"running"),!t.active||t.viewAnimation==null||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new Oh({view:this.view,desiredCamera:e.camera}),Dl(this.view,e.camera,Ys.EYE_AND_CENTER)):Bt(this.view,e.camera),t.begin(e.camera,this._options);const a=()=>{const o=this.view.state.cameraController;r&&(o&&o.active?o instanceof Oa&&o.viewAnimation!=null&&o.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=r):t.viewAnimation!=null&&t.viewAnimation.target===e.viewpoint&&t.state===wt.Finished&&(this.view.state.cameraController=r))},n=o=>{if(this.view.state!=null)switch(t.state){case wt.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case wt.Ready:case wt.Rejected:case wt.Running:case wt.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(o)}}};s.when(a,o=>n(o)),t.asyncResult={resolve:()=>n(),reject:o=>n(o)}}_getAnimationController(){let e=null,t=null;const s=this.view.state.cameraController;return s instanceof Oa&&(s.updateStateFromViewAnimation(),s.active&&(e=s,t=e.viewAnimation)),e!=null||(e=new Oa({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e))?e:(t!=null&&t.stop(),this._reject(new xs("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}};var Vt;function j0(i=!li("disable-feature:high-quality-idle"),e=null){const t=new zm;return i?(t.set(ft.IDLE,Vt.Antialiasing,e!=="low"),t.set(ft.IDLE,Vt.HighResolutionAtmosphere,e!=="low"),t.set(ft.IDLE,Vt.HighQualityTransparency,!0),t.set(ft.IDLE,Vt.SSAO,!0),t.set(ft.IDLE,Vt.WaterReflection,!0),t.set(ft.IDLE,Vt.PhysicalPixelRendering,!0)):(t.set(ft.ANIMATING,Vt.HighResolutionShadows,!0),t.set(ft.ANIMATING,Vt.HighResolutionViewshed,!0),t.set(ft.INTERACTING,Vt.HighResolutionShadows,!0),t.set(ft.INTERACTING,Vt.HighResolutionViewshed,!0)),t.set(ft.IDLE,Vt.HighResolutionShadows,!0),t.set(ft.IDLE,Vt.HighResolutionViewshed,!0),t.set(ft.IDLE,Vt.HighResolutionVoxel,!0),t}(function(i){i[i.Antialiasing=0]="Antialiasing",i[i.HighQualityTransparency=1]="HighQualityTransparency",i[i.HighResolutionVoxel=2]="HighResolutionVoxel",i[i.HighResolutionAtmosphere=3]="HighResolutionAtmosphere",i[i.SSAO=4]="SSAO",i[i.WaterReflection=5]="WaterReflection",i[i.HighResolutionShadows=6]="HighResolutionShadows",i[i.HighResolutionViewshed=7]="HighResolutionViewshed",i[i.PhysicalPixelRendering=8]="PhysicalPixelRendering"})(Vt||(Vt={}));let zt=class extends Re{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=W0,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:t=>this._devicePixelRatioOverride=t,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return this.renderState!=null},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(t){this.viewStateManager._idleTimeout=t?W0:0}},this._propertiesPool=new xn({frustum:nn},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new GE}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([Ma(()=>this.view.state.events,"before-camera-change",e=>e&&this._updateElevation(e)),M(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},(e,t)=>this._cameraChangedHandler(e,t),nt)]),yl(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([Iu({prepare:()=>this._prepareFrame()}),M(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(Wc)}),Ma(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=Y(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=Sf(this.view,this.view.state.camera,Dp);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){var t,s;this._updatePropertyBeforeReady("camera",e)||((t=this.view.elevationProvider)==null||t.enableCache(!0),this.setStateCamera(ja(this.view,e),{applyConstraints:!1})||Pe.getLogger(this).error("#camera=","Invalid camera",e),(s=this.view.elevationProvider)==null||s.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=Sf(this.view,this.view.state.contentCamera,Dp);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=ja(this.view,e);t!=null?(this._updateElevation(t),this.view.state.contentCamera=t):this.view.state.contentCamera=null}installContentCameraReset(e){if(this.removeHandles($p),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,s=this.view.state.camera.distance**2,r=jy(this.view.state.camera.center),a=e.sticky?this.contentCamera.clone():null;return this.addHandles([M(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles($p),this.test.contentCameraResetState.clear())}),M(()=>this.zoom,n=>{n!==void 0&&t!==void 0&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(n-t)/2),Math.abs(n-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=a))}),M(()=>this.view.state.camera,n=>{const o=ln(r,n.center);this.test.contentCameraResetState.set("camera.center",o/s),o>s?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=a)})],$p),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){var t;this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():Pe.getLogger(this).error("#center=","Invalid center",e):Pe.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e):Pe.getLogger(this).error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=a1(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return t??this._get("extent")}set extent(e){var t;this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||Pe.getLogger(this).error("#extent=","Invalid extent",e):Pe.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e):Pe.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){var t;const e=this.view.map;return e&&"initialViewProperties"in e?(t=e.initialViewProperties)==null?void 0:t.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return o1(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||Pe.getLogger(this).error("#scale=","Invalid scale",e)}get terrainScale(){if(!this.ready)return this._get("scale");const e=this.view,t=e.basemapTerrain.tilingScheme,s=e.pointsOfInterest.cameraOnSurface.scale;if(!t||!s)return this._get("scale");const r=e.state.contentCamera;let a=YT(e,r.eye,r.viewForward,r.up).tilt;a>90&&(a=180-a);const n=2*(a/90)**2,o=t.levelAtScale(s)-n;return o<0?this._get("scale"):t.scaleAtLevel(o)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,s=e.pixelRatio,r=this._get("padding"),a=Math.round(t[vs.TOP]/s),n=Math.round(t[vs.RIGHT]/s),o=Math.round(t[vs.BOTTOM]/s),l=Math.round(t[vs.LEFT]/s);return r!=null&&r.top===a&&r.right===n&&r.bottom===o&&r.left===l?r:{top:a,right:n,bottom:o,left:l}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,jc),this.view.state.updateCamera(t=>t.padding=jc))}_paddingToArray(e,t,s){e?vn(s,e.top||0,e.right||0,e.bottom||0,e.left||0):vn(s,0,0,0,0);for(let r=0;r<4;r++)s[r]=Math.round(s[r]*t)}get screenCenter(){const e=this.padding;return Gy((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?ZT(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){var t;if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||Pe.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{const s=e.camera!=null?e.camera.position:e.targetGeometry,r=s!=null&&s.spatialReference;Pe.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(r?r.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e)}else Pe.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?KT(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||e===void 0||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||Pe.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){var r;if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const s=(r=this.view._stage.renderView.renderingContext)==null?void 0:r.parameters.maxTextureSize;return s&&Y_(this._tmpCanvasSize,s),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return this._devicePixelRatioOverride!=null?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){var e,t;return((t=(e=this.view)==null?void 0:e._stage)==null?void 0:t.renderer.isFeatureEnabled(Vt.PhysicalPixelRendering))??!1}get _usePhysicalPixelRenderingAny(){var t,s;const e=(s=(t=this.view)==null?void 0:t._stage)==null?void 0:s.renderer;return e&&(e.isFeatureEnabled(Vt.PhysicalPixelRendering,ft.IDLE)||e.isFeatureEnabled(Vt.PhysicalPixelRendering,ft.INTERACTING)||e.isFeatureEnabled(Vt.PhysicalPixelRendering,ft.ANIMATING))}preinit(e){var t,s,r;return!(this._isOverridden("center")&&!Ul(this.center.spatialReference,e))&&!(this._isOverridden("camera")&&!Ul(this.camera.position.spatialReference,e))&&!(this._isOverridden("extent")&&!Ul(this.extent.spatialReference,e))&&!!(!this._isOverridden("viewpoint")||Ul((t=this.viewpoint.targetGeometry)==null?void 0:t.spatialReference,e)&&Ul((r=(s=this.viewpoint.camera)==null?void 0:s.position)==null?void 0:r.spatialReference,e))}init(){this._constraintsManager=new dh({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const t=this._initialViewpoint||this.view.initialExtent;t&&this.isCompatible(t)?this._setInitialView(t):this.view.state.viewingMode===$e.Local&&this.addHandles(yl(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(Wc),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),Wc)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(Wc),this._constraintsManager=Y(this._constraintsManager))}async goTo(e,t){return t={animate:!0,...t},this._gotoOperation!=null&&this._gotoOperation.abort(t.animate),this._gotoOperation=new HE(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera(JT(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,s=t==null?void 0:t.cameraController;s&&(t.updateCamera(r=>s.stepController(e,r)),s.steppingFinished&&s.finishController())}_cancelGoToOperation(){this._gotoOperation!=null&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:s,overrides:r}of jE){const a=e.has(s),n=this._isOverridden(s);!a&&n&&t.push({name:s,value:this._get(s)}),this._clearOverride(s),(a||n)&&r.forEach(o=>e.add(o))}return t}_setInitialView(e){if(e==null||this._cameraSetByUser)return;if(e instanceof _o)return void this.setStateCamera(ja(this.view,e),{applyConstraints:!1});if(e instanceof Fh){if(e.targetGeometry instanceof zr){const a=hp(this.view,e.targetGeometry,0,.5,Sc.LOCKED);return void(a!=null&&this.setStateCamera(ja(this.view,a),{applyConstraints:!0}))}const s={applyConstraints:!e.camera},r=this._viewpointToCamera(e);return void this.setStateCamera(r,s)}const t=hp(this.view,e,0,.5,Sc.LOCKED);t!=null&&this.setStateCamera(ja(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&kE.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return e!=null&&(e instanceof Fh?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof _o?this.isCompatible(e.position):e.spatialReference&&!XC(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=WE){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,s=Ga){const{heading:r,tilt:a}=this._getPreservingHeadingTilt(),n=eS(this.view,r,a,e,t,Sc.ADJUST);return n==null?null:(s.copyFrom(this.view.state.camera),s.eye=n.eye,s.center=n.center,s.up=n.up,s)}_centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const s=t.distance;return this._centerPointAtDistanceToCamera(e,s)}_extentToCamera(e){const{heading:t,tilt:s}=this._getPreservingHeadingTilt(),r=hp(this.view,e,t,s,Sc.ADJUST,Dp);return r?ja(this.view,r):null}_scaleToCamera(e){if(e==null)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const s=t.renderLocation,r=t.location.latitude,a=tS(this.view,e,r);return this._centerPointAtDistanceToCamera(s,a)}_zoomToCamera(e){return this._scaleToCamera(iS(this.view,e))}_viewpointToCamera(e){return ja(this.view,sS(this.view,e))}setStateCamera(e,t){return!(e==null||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(s=>{t.positionAndOrientationOnly?(s.eye=e.eye,s.center=e.center,s.up=e.up,s.fov=e.fov):s.copyFrom(e),t.applyConstraints&&Bt(this.view,s)}),t.applyConstraints||(this.view.state.cameraController=new Oh({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const s=this._computeCanvasSize();if(s.width!==0&&s.height!==0&&(t.width===s.width&&t.height===s.height||(t.width=s.width,t.height=s.height),this.view.state)){const r=this.view.state.camera;r.fullWidth===s.width&&r.fullHeight===s.height&&r.pixelRatio===s.pixelRatio||(Ga.copyFrom(r),Ga.pixelRatio!==s.pixelRatio&&(this._paddingToArray(this.padding,s.pixelRatio,jc),Ga.padding=jc),Ga.fullWidth=s.width,Ga.fullHeight=s.height,Ga.pixelRatio=s.pixelRatio,this.view.state.camera=Ga),this._updateViewState()}}_updateElevation(e){var a,n;const t=(a=this.view.basemapTerrain)==null?void 0:a.spatialReference,s=((n=this.view.renderCoordsHelper)==null?void 0:n.getAltitude(e.eye))??0,r=t?$_(this.view,e.eye):0;e.relativeElevation=s-r}_updateViewState(){this.test.renderState!=null?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=ft.ANIMATING:this.view.interacting?this.view.state.mode=ft.INTERACTING:(this.view.state.mode===ft.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=ft.INTERACTING:this.view.state.mode=ft.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};c([p({type:_o,dependsOn:["view.state.camera","ready"]})],zt.prototype,"camera",null),c([p({type:_o,dependsOn:["view.state.contentCamera","ready"]})],zt.prototype,"contentCamera",null),c([p({type:ea})],zt.prototype,"center",null),c([p({type:zr})],zt.prototype,"extent",null),c([p({readOnly:!0})],zt.prototype,"frustum",null),c([p()],zt.prototype,"_constraintsManager",void 0),c([p({readOnly:!0})],zt.prototype,"constraintsManager",null),c([p()],zt.prototype,"_initialViewpoint",null),c([p({readOnly:!0})],zt.prototype,"hasInitialView",null),c([p({readOnly:!0,type:Boolean})],zt.prototype,"ready",void 0),c([p({type:Number})],zt.prototype,"scale",null),c([p({type:Number})],zt.prototype,"terrainScale",null),c([p()],zt.prototype,"padding",null),c([p({readOnly:!0})],zt.prototype,"screenCenter",null),c([p({constructOnly:!0})],zt.prototype,"view",void 0),c([p({type:Fh})],zt.prototype,"viewpoint",null),c([p({type:Number})],zt.prototype,"zoom",null),c([p({readOnly:!0})],zt.prototype,"_rasterPixelRatio",null),c([p({readOnly:!0})],zt.prototype,"_usePhysicalPixelRendering",null),c([p({readOnly:!0})],zt.prototype,"_usePhysicalPixelRenderingAny",null),c([p()],zt.prototype,"_windowDevicePixelRatio",void 0),c([p()],zt.prototype,"_devicePixelRatioOverride",void 0),zt=c([F("esri.views.3d.state.ViewStateManager")],zt);let GE=class{constructor(){this.width=0,this.height=0,this.pixelRatio=1}};const kE=new Set(["camera","viewpoint","extent","scale","center","zoom"]),jE=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],WE={heading:0,tilt:0},Dp=new _o,Ga=new Ct,jc=mi(),Wc="pending-initial-view",$p="content-camera-reset",W0=300,Q0=100;let kr=class extends xa{constructor(){super(...arguments),this.startCamera=new Ct,this.currentCamera=new Ct,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<Q0}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=wt.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout(()=>this.notifyChange("isInteractive"),Q0),this.view.state.updateCamera(e=>this.stepController(0,e)),this.steppingFinished&&this.finishController()}};c([p({readOnly:!0})],kr.prototype,"isInteractive",null),c([p()],kr.prototype,"_lastInteraction",void 0),kr=c([F("esri.views.3d.state.controllers.InteractiveController")],kr);var ys;(function(i){i[i.CENTER=0]="CENTER",i[i.EYE=1]="EYE"})(ys||(ys={}));let Mh=class extends kr{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=ys.CENTER,this._rotScale=0,this._lastPoint=Hi(),this._tmpWorldUp=b(),this._tmpViewDir=b(),this._tmpRotCurPoint=Hi(),this._tmpTransf=Qe(),this._tmpAxis=b(),this._tmpPivotPoint=b(),this._pivotPos=b(),this._constraintOptions=new ir(dt.ALL,Ee.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===ys.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case ys.EYE:le(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=Ee.LOOK_AROUND,this._constraintOptions.tiltMode=sa.LOOK_AROUND,this._constraintOptions.selection=dt.NONE;break;case ys.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.map.ground.opacity===0?To:{});t||le(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=Ee.TUMBLE,this._constraintOptions.tiltMode=sa.TUMBLE,this._constraintOptions.selection=dt.ALL&~dt.DISTANCE;break}}po(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const s=this.startCamera,r=b();be(r,this._pivotPos,s.eye);const a=xe(r),n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(s.eye,X0);let o=Math.max(Math.min(wE,1/Math.abs(ue(X0,s.viewForward)))*n,xE);t&&(o=Math.min(a,o));const l=Ht(s.width/s.pixelRatio*.5,s.height/s.pixelRatio*.5),h=vc(this.startCamera,l,this.view.renderCoordsHelper,this.view.viewingMode);let d=this.view._stage.renderView.getMinimalDepthForArea(rc(this.view),s.fullWidth/s.pixelRatio*.5,s.fullHeight/s.pixelRatio*.5,s,2.5*Pp,Pp),u=this.view._stage.renderView.getMinimalDepthForArea(rc(this.view),e[0],e[1],s,Pp);d==null&&u==null||(d=d??u??0,u=u==null||h===Oi.Horizontal?d:u,o=d>u?u:d,o=t?Math.min(o,a):o),oe(r,r),le(this._pivotPos,_e(this._tmpPivotPoint,s.eye,ee(this._tmpPivotPoint,r,o)))}update(e){if(this.active){switch(this.pivot){case ys.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case ys.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Bt(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.active&&this.finishController()}_applyRotation(e,t,s,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),po(e,t,this._tmpRotCurPoint);let a=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,n=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;be(this._tmpViewDir,s,r);const o=xe(this._tmpViewDir),l=Kr(ue(this._tmpViewDir,this._tmpWorldUp)/o);if(this.pivot===ys.EYE){a*=-.5;const h=.5*Math.PI-l,d=.5*Math.PI*.99;a=h-Math.max(-d,Math.min(d,h+a))}return a=Z(a+l,Ri.min,Ri.max)-l,yt(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===ys.CENTER&&(n=-n),bn(this._tmpTransf,n,this._tmpWorldUp),Ra(this._tmpTransf,this._tmpTransf,a,this._tmpAxis),Xt(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=Xt(Ip,e.up,this._tmpTransf),_e(Ip,r,this._tmpViewDir),fn(this._lastPoint,this._tmpRotCurPoint),Ip}};c([p()],Mh.prototype,"pivot",void 0),Mh=c([F("esri.views.3d.state.controllers.RotateController")],Mh);const Ip=b(),X0=b();let Lp=class extends Rr{constructor(e,t,s,r){super(!0),this._view=e,this.pointerAction=t,this._pivot=s,this.registerIncoming("drag",r,a=>this._handleDrag(a))}_handleDrag(e){const t=e.data;if(t.pointers.size>1||!D_(e.data,this.pointerAction))return;const s=Ht(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new Mh({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(s);break;case"update":this._cameraController&&this._cameraController.update(s);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}},t_=class extends kr{constructor(){super(...arguments),this._pickPoint=b(),this._tmpP0=Hi(),this._panAxisAngle=Zu(),this._tmpRayDir=b(),this._tmpRayDirPick=b(),this._targetOnSphere=b(),this._navMode=Oi.Horizontal,this._tmpRay={origin:b(),direction:b()},this.dragBeginPoint=Ht(),this._normalizedAnchorPoint=Hi(),this._constraintOptions=new ir(dt.ALL_EXCEPT_COLLISION,Ee.ZOOM,0,this.startCamera),this._sphere=Sr(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;fn(this.dragBeginPoint,e),po(this.startCamera,e,this._normalizedAnchorPoint);const t=Ut(this.view.spatialReference),s=Wb(this._intersectionHelper,this.startCamera,e,t,Tl.Ellipsoid,this.view.map.ground.opacity===0?To:{});if(this._navMode=vc(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===Oi.Horizontal)this._hasPickPoint=!!s.scenePickPoint,this._pickPoint=s.scenePickPoint??this._pickPoint,this._sphere=s.sphere;else{let r;Al(this.startCamera,e,this._tmpRay),oe(this._tmpRay.direction,this._tmpRay.direction),s.scenePickPoint!=null&&(be(this._tmpRayDirPick,this.startCamera.eye,s.scenePickPoint),r=xe(this._tmpRayDirPick));const a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,Y0);let n=Z(Math.min(Ub,1/Math.abs(ue(Y0,this._tmpRay.direction)))*a,Cu[0],Cu[1]);const o=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,Ku);n=o??n,n=r!=null?Math.min(n,r):n,this._hasPickPoint=!0,ee(this._tmpRay.direction,this._tmpRay.direction,n),_e(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===Oi.Horizontal){be(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=xe(this._tmpRayDir);po(this.currentCamera,e,this._tmpP0);const s=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**s;const a=this.view.state.constraints.minimumPoiDistance;if(s<0&&r<a&&(r=a),Math.abs(t-r)<1e-6)return;if(this._hasPickPoint&&r<t){const n=1-(1-r/t)*(1-this._sphere[3]/xe(this.currentCamera.center));this.currentCamera.center=ee(Qc,this.currentCamera.center,n)}ee(this._tmpRayDir,this._tmpRayDir,-r/t),this.currentCamera.eye=_e(Qc,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=_r(kh(this.dragBeginPoint,e)),Bt(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(sc(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),fg(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Tn(this.currentCamera,qt(this._sphere),this._panAxisAngle))}else{const t=xe(this._tmpRay.direction);po(this.currentCamera,e,this._tmpP0);const s=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**s;const a=this.view.state.constraints.minimumPoiDistance;if(s<0&&r<a&&(r=a),Math.abs(t-r)<1e-6)return;ee(this._tmpRayDir,this._tmpRay.direction,1-r/t),this.currentCamera.eye=_e(Qc,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=_e(Qc,this.currentCamera.center,this._tmpRayDir)}Dl(this.view,this.currentCamera),this.commitCamera()}}end(){this.active&&this.finishController()}};t_=c([F("esri.views.3d.state.controllers.ZoomControllerGlobal")],t_);const Qc=b(),Y0=b();let i_=class extends kr{constructor(){super(...arguments),this._tmpP=b(),this._tmpDir=b(),this._tmpN=b(),this._tmpP0=Hi(),this._tmpPoi=b(),this._tmpRayDir=b(),this.dragBeginPoint=Ht(),this._normalizedAnchorPoint=Hi(),this._constraintOptions=new ir(dt.ALL,Ee.ZOOM,0,this.startCamera,b()),this._plane=yo()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;fn(this.dragBeginPoint,e),po(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.map.ground.opacity===0?To:{});be(this._tmpDir,this._tmpP,this.startCamera.eye);const s=xe(this._tmpDir);oe(this._tmpDir,this._tmpDir);const r=Math.abs(this.view.camera.position.z);let a=Z(Math.min(Ub,1/Math.abs(ue(QE,this._tmpDir)))*r,Cu[0],Cu[1]);const n=this.view._stage.renderView.getMinimalDepthForArea(rc(this.view),e[0],e[1],this.view.state.camera,Ku);a=n??a,a=t?Math.min(a,s):a,ee(this._tmpDir,this._tmpDir,a),_e(this._tmpP,this.startCamera.eye,this._tmpDir),be(this._tmpN,this.startCamera.eye,this.startCamera.center),oe(this._tmpN,this._tmpN),this._tmpN[1]<0&&Xr(this._tmpN,this._tmpN),W1(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.active)return;CE(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||le(this._tmpPoi,this.currentCamera.center),po(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);fn(this._normalizedAnchorPoint,this._tmpP0),be(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const s=xe(this._tmpRayDir);let r=s*(1-t);this._constraintOptions.interactionDirection&&(le(this._constraintOptions.interactionDirection,this._tmpRayDir),ee(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/s));const a=this.view.state.constraints.minimumPoiDistance;t>=0&&r<a&&(r=a,t=-(r-s)/s),Math.abs(s-r)<1e-6||(ee(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=_e(Ln,this.currentCamera.eye,this._tmpRayDir),Tr(Ln,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?Ln[2]=Math.max(this.startCamera.center[2],Ln[2]):Ln[2]=Math.min(this.startCamera.center[2],Ln[2]),this.currentCamera.center=Ln,this._constraintOptions.interactionFactor=_r(kh(this.dragBeginPoint,e)),Bt(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}end(){this.active&&this.finishController()}};i_=c([F("esri.views.3d.state.controllers.ZoomControllerLocal")],i_);const Ln=b(),QE=St(0,0,1);let XE=class extends Rr{constructor(e,t,s){super(!0),this._view=e,this.pointerAction=t,this.registerIncoming("drag",s,r=>this._handleDrag(r))}_handleDrag(e){const t=e.data;if(t.pointers.size>1||!D_(e.data,this.pointerAction))return;const s=Ht(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new t_({view:this._view}):this._cameraController=new i_({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(s);break;case"update":this._cameraController&&this._cameraController.update(s);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}},no=class extends kr{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new Ct,this._headingStart=0,this._constraintOptions=new ir(dt.ALL,Ee.NONE,0,new Ct,null,sa.LOOK_AROUND)}handleEventGamepad(e){const t=Cf(e,this.view.navigation.gamepad,this._transformation);(e.action==="end"||np(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,Tf(this._keysButtonState,this._transformation)}deactivateDirection(e){this._keysButtonState[e]=0;const t=Tf(this._keysButtonState,this._transformation);np(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z,s=1;this._filteredSurfaceElevation+=s*(t-this._filteredSurfaceElevation)*e}stepController(e,t){var s;this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),(s=this._constraintOptions.interactionStartCamera)==null||s.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,Nn),this._applyDisabledMovementTypes(Nn),this._applyPan(Nn.pan),this._applyRotate(Nn.rotate),this._applyZoom(Nn.zoom),this._applyAscend(Nn.ascend),this._constraintOptions.interactionType=Ee.NONE,this._constraintOptions.selection=dt.COLLISION,Bt(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){this._transformation.heading!==0&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;be(es,t.center,t.eye),Xt(es,es,e.matrix),t.center=_e(es,es,t.eye),t.up=Xt(es,t.up,e.matrix),this._constraintOptions.interactionType=Ee.LOOK_AROUND,this._constraintOptions.selection=dt.ALL_EXCEPT_COLLISION,Bt(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=Xt(es,t.eye,e.matrix),t.center=Xt(es,t.center,e.matrix),this.view.state.isGlobal&&(t.up=Xt(es,t.up,e.matrix)),this._constraintOptions.interactionType=Ee.PAN,this._constraintOptions.selection=dt.ALL,Bt(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=_e(es,this.currentCamera.eye,ee(Et.get(),t,e)),le(jl,t),Xr(jl,jl),this._constraintOptions.interactionDirection=jl,this._constraintOptions.interactionType=Ee.ZOOM,this._constraintOptions.selection=dt.ALL_EXCEPT_COLLISION,Bt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Et.get());if(this._constraintOptions.interactionDirection=le(jl,t),this.view.state.isGlobal){const s=xe(this.currentCamera.eye),r=(s+e)/s;this.currentCamera.eye=ee(es,this.currentCamera.eye,r),this.currentCamera.center=ee(es,this.currentCamera.center,r)}else{const s=ee(Et.get(),t,e);this.currentCamera.eye=_e(es,this.currentCamera.eye,s),this.currentCamera.center=_e(es,this.currentCamera.center,s)}this._updateCameraCenter(),this._constraintOptions.interactionType=Ee.ASCEND,this._constraintOptions.selection=dt.COLLISION,Bt(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=dt.ALL_EXCEPT_COLLISION,Bt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,s){iA(s);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,s):this._calculateControlTransformationGlobal(r,t,s)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,s=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(s,e,es)}_calculateControlTransformationLocal(e,t,s){const{viewRight:r,viewForward:a}=t,n=this._transformation,o=this.view.navigation.gamepad,l=it(Et.get(),a[0],a[1],0);oe(l,l);const h=n.translation[0]*e.pan;if(h!==0){const g=ee(Et.get(),r,h);fo(s.pan.matrix,s.pan.matrix,g),s.pan.enabled=!0}switch(o.mode){case"pan":{const g=-n.translation[1]*e.pan;if(g!==0){const y=ee(Et.get(),l,g);fo(s.pan.matrix,s.pan.matrix,y),s.pan.enabled=!0}s.zoom=n.zoom*e.zoom;break}case"zoom":s.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:Cl(o.mode)}const d=n.translation[2]*e.ascend;s.ascend=d;const u=-n.heading*e.rotate;u!==0&&(Ra(s.rotate.matrix,s.rotate.matrix,u,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,Et.get())),s.rotate.enabled=!0);const m=n.tilt*e.rotate,_=Cn(this.view.renderCoordsHelper,t.center,t.eye),f=Z(_+m,Ri.min,Ri.max)-_;f&&(Ra(s.rotate.matrix,s.rotate.matrix,f,r),s.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,s){const{eye:r,viewRight:a}=t,n=this._transformation,o=this.view.navigation.gamepad,l=yt(Et.get(),a,r);oe(l,l),Xr(l,l),ME(this.startCamera,t,n,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,s,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(Nn.pan,this._tmpCamera);const h=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,d=n.translation[2]*e.ascend;s.ascend=d;const u=-n.heading*e.rotate;u!==0&&(Ra(s.rotate.matrix,s.rotate.matrix,u,this._tmpCamera.eye),s.rotate.enabled=!0);const m=n.tilt*e.rotate,_=this._clampTiltDeltaGlobalToValidRange(m,t.ray,h);_!==0&&(Ra(s.rotate.matrix,s.rotate.matrix,_,this._tmpCamera.viewRight),s.rotate.enabled=!0),s.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,s){const r=Ut(this.view.spatialReference),a=Sd(Ri.min,t.origin,s,r);let n=0,o=0;const l=Et.get();if(this.view.renderCoordsHelper.intersectManifold(t,s,l)){const h=Cn(this.view.renderCoordsHelper,l,t.origin);n=Sd(h,t.origin,s,r),o=Sd(Ri.max,t.origin,s,r)}else{ku(Z_(K_,s+r.radius),t,l);const h=Math.PI+k1(t.direction,l);n=I0(h,t.origin,s,r),o=I0(Ri.max,t.origin,s,r)}return Z(n+e,a,o)-n}_getPointAbsoluteSurfaceElevation(e,t,s){const{renderCoordsHelper:r}=this.view,a=r.getAltitude(e),n=t+Math.abs(a-t);return r.setAltitude(s,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:s}=this.view,{camera:r}=this.view.state,{direction:a}=rS(this.view,t,0,iw,tA),n=s.intersectManifoldClosestSilhouette(vo(t,a),e,Et.get()),o=os(t,n),l=s.intersectManifoldClosestSilhouette(vo(t,Lu(Et.get(),t,r.center)),e,Et.get()),h=os(t,l);return Math.min(o,h)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:s}=this.view,{camera:r,isGlobal:a}=s,n=t.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,Et.get());if(a){const o=be(Et.get(),e,n),l=xe(o);ee(o,o,1/l);const h=oe(Et.get(),e),d=Kr(ue(h,o));return l*Math.sin(Math.min(ZE,d))}{const o=le(Et.get(),e);return t.setAltitude(o,this._filteredSurfaceElevation),os(n,o)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:KE}_computeVelocities(e){const t=this._filteredSurfaceElevation,s=t+Ut(this.view.spatialReference).radius,{camera:r,isGlobal:a}=this.view.state,n=Et.get(),o=this._getPointAbsoluteSurfaceElevation(r.eye,t,n),l=this._clampedDistanceToSurface(t,n),h=r.width/2,d=Z0*r.width,u=Z0*r.width,m=l*Math.tan(.5*r.fovX)/h,_=m/s,f=m/this._computeHeadingRotateRadius(n),g=o-t;return{pan:(a?_:m)*d*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(d*e/h)*g-g),zoom:2**(d*e/h)*l-l,rotate:Z(f*u,JE,eA)*e}}_applyDisabledMovementTypes(e){this.disableMovements==null||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&hu(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&hu(e.rotate.matrix))}static activatesFor(e,t){const s=Cf(t,e.navigation.gamepad,YE);return!(t.action==="end"||np(s))}};c([p({constructOnly:!0})],no.prototype,"gamepadDevice",void 0),c([p({constructOnly:!0})],no.prototype,"disableMovements",void 0),no=c([F("esri.views.3d.state.controllers.GamepadKeyboardController")],no);const YE={translation:[0,0,0],heading:0,tilt:0,zoom:0},iw=80,ZE=Tt(iw),Z0=.75,KE=5,JE=Tt(30),eA=Tt(80),Nn={zoom:0,ascend:0,pan:{enabled:!1,matrix:Qe()},rotate:{enabled:!1,matrix:Qe()}},es=b(),jl=b(),tA=aS();function iA(i){i.zoom=0,i.ascend=0,i.pan.enabled=!1,hu(i.pan.matrix),i.rotate.enabled=!1,hu(i.rotate.matrix)}let sA=class extends Rr{constructor(e){super(!0),this._view=e,this._watchHandles=new $u,this._handle=this.registerIncoming("gamepad",t=>this._handleEventGamepad(t)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([M(()=>this._view.navigation.gamepad.enabled,t=>{t?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},si),M(()=>this._view.navigation.gamepad.device,t=>{this._cameraControllerGamepad&&t&&this._cameraControllerGamepad.gamepadDevice!==t&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){var r;const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const s=(r=this._cameraControllerGamepad)==null?void 0:r.active;if(s||no.activatesFor(this._view,e.data)){if(!s){const a=new no({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(a)&&(this._cameraControllerGamepad=a)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}};var ms;(function(i){i[i.LEFT=0]="LEFT",i[i.RIGHT=1]="RIGHT",i[i.FORWARD=2]="FORWARD",i[i.BACKWARD=3]="BACKWARD",i[i.UP=4]="UP",i[i.DOWN=5]="DOWN",i[i.HEADINGLEFT=6]="HEADINGLEFT",i[i.HEADINGRIGHT=7]="HEADINGRIGHT",i[i.TILTUP=8]="TILTUP",i[i.TILTDOWN=9]="TILTDOWN",i[i.ZOOMIN=10]="ZOOMIN",i[i.ZOOMOUT=11]="ZOOMOUT"})(ms||(ms={}));let rA=class extends Rr{constructor(e,t){super(!0),this._view=e,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:$e.Local},this._keyToNumber={[t.left]:ms.LEFT,[t.right]:ms.RIGHT,[t.forward]:ms.FORWARD,[t.backward]:ms.BACKWARD,[t.up]:ms.UP,[t.down]:ms.DOWN,[t.headingLeft]:ms.HEADINGLEFT,[t.headingRight]:ms.HEADINGRIGHT,[t.tiltUp]:ms.TILTUP,[t.tiltDown]:ms.TILTDOWN,[t.zoomIn]:ms.ZOOMIN,[t.zoomOut]:ms.ZOOMOUT},this.registerIncoming("key-down",null,s=>this._handleKeyDown(s)),this.registerIncoming("key-up",null,s=>this._handleKeyUp(s)),this.registerIncoming("blur",null,()=>this._handleStop()),this._visibilityHandle=DT(s=>s?null:this._handleStop())}onUninstall(){var e;(e=this._visibilityHandle)==null||e.remove(),this._handleStop()}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];t!=null&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new no({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}_handleStop(){var e;(e=this._cameraControllerKeyboard)!=null&&e.active&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){var s;if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];t!=null&&((s=this._cameraControllerKeyboard)!=null&&s.active)&&(this._cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}},aA=class extends Rr{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",t,s=>this._handleMouseWheel(s))}_handleMouseWheel(e){if(!this._view.navigation.mouseWheelZoomEnabled)return;const t=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new Ru({view:this._view,mode:"interaction"}):new Ou({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*t.deltaY,Ht(t.x,t.y)),e.preventDefault(),e.stopPropagation()}},Mu=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return this._value===void 0?0:this._value}update(e){this._value===void 0?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}},wo=class extends tc{constructor(){super(...arguments),this._beginCamera=new Ct,this._elapsedTimeSec=0,this.constraintOptions=new ir(dt.ALL,Ee.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new xl}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),Bt(this.view,t,this.constraintOptions)}};wo=c([F("esri.views.3d.state.controllers.momentum.MomentumController")],wo);let Eh=class extends wo{constructor(e){super(e),this.interactionType=Ee.PAN,this._tmpPan=b()}momentumStep(e,t){const s=this.momentum.value(e);ee(this._tmpPan,this.momentum.direction,s),t.eye=be(K0,t.eye,this._tmpPan),t.center=be(K0,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};c([p({constructOnly:!0})],Eh.prototype,"momentum",void 0),Eh=c([F("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Eh);const K0=b(),nA=b(),Xc=b();let Md=class extends wo{constructor(e){super(e),this.interactionType=Ee.PAN}momentumStep(e,t){const s=this.momentum.value1(e),r=this.momentum.value2(e);le(Xc,t.eye),oe(Xc,Xc),yt(this.momentum.axis2,Xc,this.momentum.axis1),Zb(t,nA,this.momentum.axis1,s,this.momentum.axis2,r)}};c([p({constructOnly:!0})],Md.prototype,"momentum",void 0),Md=c([F("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Md);let so=class extends wo{set center(e){this._set("center",gn(e))}set axis(e){this._set("axis",gn(e))}constructor(e){super(e),this.interactionType=Ee.TUMBLE}momentumStep(e,t){const s=this.momentum.value(e);Tn(t,this.center,ic(this.axis,s))}};c([p({constructOnly:!0})],so.prototype,"momentum",void 0),c([p({constructOnly:!0})],so.prototype,"center",null),c([p({constructOnly:!0})],so.prototype,"axis",null),so=c([F("esri.views.3d.state.controllers.momentum.RotationMomentumController")],so);let nl=class extends wo{set zoomCenter(e){this._set("zoomCenter",gn(e))}constructor(e){super(e),this.interactionType=Ee.ZOOM,this.constraintOptions.interactionDirection=b()}momentumStep(e,t){const{interactionDirection:s}=this.constraintOptions;if(!s)return;le(s,t.eye);const r=this.momentum.valueDelta(0,e);yg(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),Lu(s,t.eye,s)}};c([p({constructOnly:!0})],nl.prototype,"momentum",void 0),c([p({constructOnly:!0})],nl.prototype,"zoomCenter",null),nl=c([F("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],nl);let Wn=class extends wo{set screenCenter(e){this._set("screenCenter",Ht(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",gn(e))}constructor(e){super(e),this.interactionType=Ee.ZOOM,this.radius=0,this._tmpSceneCenter=b(),this._tmpZoomAxisAngle=Zu(),this._sphere=Sr()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const s=this.momentum.valueDelta(0,e);kb(this._sphere,t,s),this.constraintOptions.interactionType=Ee.ZOOM,Bt(this.view,t,this.constraintOptions),sc(this._sphere,t,this.screenCenter,this._tmpSceneCenter),fg(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Tn(t,qt(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=Ee.PAN}};c([p({constructOnly:!0})],Wn.prototype,"momentum",void 0),c([p({constructOnly:!0})],Wn.prototype,"screenCenter",null),c([p({constructOnly:!0})],Wn.prototype,"sceneCenter",null),c([p({constructOnly:!0})],Wn.prototype,"radius",void 0),Wn=c([F("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],Wn);let J0=class{constructor(e){this._gain=e}update(e){this.filteredValue!==void 0?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}};const ev=1e-5;let oA=class extends V2{constructor(e,t,s,r,a,n=0,o){super(e,t,s),this._angularVelocity1=r,this.axis1=a,this.angularVelocity2=n,this.axis2=o}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}},lA=class{constructor(e=300,t=12,s=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=s,this.enabled=!0,this._tmpAxis1=b(),this._tmpAxis2=b(),this._tmpAngles=Hi(),this._time=new _p(.3),this._screen=[new _p(.4),new _p(.4)],this._angle1=new J0(.6),this._angle2=new J0(.6),this._axis1=b(),this._axis2=b(),this._lastScene=b()}addMomentumDirectRotation(e,t,s,r,a,n){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(s)<.01)return;let o=Xb(this._lastScene,t,this._tmpAxis2,r,a,n);this._angle2.update(0),gr(this._tmpAxis2)<ev?o=0:oe(this._axis1,this._tmpAxis2),this._angle1.update(o),le(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(s)}}addMomentumPreserveHeading(e,t,s,r,a,n,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(s)<.01)return;Yb(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,r,a,n,o,!1),gr(this._tmpAxis2)<ev?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),oe(this._axis1,this._tmpAxis1),oe(this._axis2,this._tmpAxis2)),le(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(s)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,s=e==null||t==null?null:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,a=s==null||r==null?0:s/r;return Math.abs(a)<this._minimumInitialVelocity?null:this.createMomentum(a,this._stopVelocity,this._friction)}createMomentum(e,t,s){const r=this._time.filteredDelta,a=this._angle1.filteredValue,n=this._angle2.filteredValue,o=r==null||n==null?0:n/r;return new oA(e,t,s,r==null||a==null?0:a/r,this._axis1,o,this._axis2)}},s_=class extends kr{constructor(){super(...arguments),this._smoothRotation=new Mu(.05),this._rotationAxis=b(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=yo(),this._beginRadius=0,this._smoothScaling=new Mu(.05),this._zoomCenterScreen=Ht(),this._zoomMomentumEstimator=new Y1,this._rotationMomentumEstimator=new Z1,this._panSphericalMomentumEstimator=new lA,this._panPlanarMomentumEstimator=new K1,this._adjustedSphere=Sr(),this._tmp3d=b(),this._tmpScreenPointArray=Ht(),this._beginScreenPoint=Ht(),this._beginScenePoint=b(),this._screenPickPoint=Ht(),this._scenePickPoint=b(),this._navMode=Oi.Horizontal,this._sphere=Sr(),this._pointerCount=0,this._tmpInteractionDirection=b(),this._beginCamera=new Ct,this._constraintOptions=new ir(dt.ALL,Ee.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-wn.normalize(Tt(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),Ca(e.center,this._screenPickPoint),fn(this._beginScreenPoint,this._screenPickPoint);const t=Ut(this.view.spatialReference),s=Wb(this._intersectionHelper,this.startCamera,this._screenPickPoint,t,Tl.Silhouette,this.view.map.ground.opacity===0?To:{});s.scenePickPoint!=null&&(this._scenePickPoint=s.scenePickPoint,this._sphere=s.sphere,le(this._beginScenePoint,this._scenePickPoint),this._navMode=vc(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===Oi.Vertical&&this._preparePlanarPanMode(e,s.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._navMode===Oi.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._navMode===Oi.Horizontal?new Wn({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new nl({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const s=this._rotationMomentumEstimator.evaluateMomentum();if(s)return new so({view:this.view,momentum:s,center:qt(this._sphere),axis:this._rotationAxis});if(this._navMode===Oi.Horizontal){const r=this._panSphericalMomentumEstimator.evaluateMomentum();if(r)return new Md({view:this.view,momentum:r})}else{const r=this._panPlanarMomentumEstimator.evaluateMomentum();if(r)return new Eh({view:this.view,momentum:r})}return null}_preparePlanarPanMode(e,t){const s=Xr(this._tmp3d,this.startCamera.viewForward);W1(this._scenePickPoint,s,this._panningPlane);const r=Ht(this._screenPickPoint[0],0),a=b(),n=xe(this.startCamera.eye);this._adjustedSphere[3]=n<this._sphere[3]?n-100:this._sphere[3],sc(this._adjustedSphere,this.startCamera,r,a);const o=dc();this.startCamera.projectToRenderScreen(a,o);const l=b(),h=b(),d=b();be(l,this._scenePickPoint,this.currentCamera.eye);const u=xe(l);oe(l,l);const m=Hb*Math.max(Math.abs(this.view.camera.position.z),Gb),_=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,Ku);let f=_??m;f=t?Math.min(f,u):f,le(d,_e(h,this.currentCamera.eye,ee(h,l,f))),this._panningPlane[3]=-ue(Vr(this._panningPlane),d),this.startCamera.center=_e(h,this.startCamera.eye,ee(h,this.startCamera.viewForward,f));const g=Ca(e.center,this._tmpScreenPointArray);e_(this._panningPlane,this.startCamera,g,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,s=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=s,this._smoothScaling.update(t),kb(this._sphere,this.currentCamera,this._smoothScaling.value),Ca(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=Ee.ZOOM,this._constraintOptions.interactionFactor=_r(e.radius-this._beginRadius),Bt(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=Ca(e.center,this._tmpScreenPointArray);sc(this._sphere,this.currentCamera,t,this._tmp3d),bg(this._beginScenePoint,ue(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(Jb(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(Kb(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=Ee.PAN,this._constraintOptions.interactionFactor=_r(kh(this._screenPickPoint,t)),Bt(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){oe(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||Xr(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,s=t+Jm(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(s);const a=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp),Tn(this.currentCamera,qt(this._sphere),ic(this._rotationAxis,a)),this._constraintOptions.interactionType=Ee.TUMBLE,this._constraintOptions.interactionFactor=_r(e.radius*s),Bt(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=Ca(e.center,this._tmpScreenPointArray);e_(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(Qb(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=Ee.PAN,this._constraintOptions.interactionFactor=_r(kh(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Bt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,s=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=s,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),yg(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=Ee.ZOOM,this._constraintOptions.interactionFactor=_r(e.radius-this._beginRadius),Bt(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){le(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||Xr(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let s=e.angle-t;s=Jm(s);const r=t+s,a=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=a,this._smoothRotation.update(r);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),Tn(this.currentCamera,qt(this._sphere),ic(this._rotationAxis,n)),this._constraintOptions.interactionType=Ee.TUMBLE,this._constraintOptions.interactionFactor=_r(e.radius*n),Bt(this.view,this.currentCamera,this._constraintOptions)}};s_=c([F("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],s_);const tv=St(0,0,1);let r_=class extends kr{constructor(){super(...arguments),this._rotationValueSmooth=new Mu(.05),this._scalingValueSmooth=new Mu(.05),this._planeHorizontal=yo(),this._planeVertical=yo(),this._rotationMomentumEstimator=new Z1,this._panMomentumEstimator=new K1(300,12,.9),this._zoomMomentumEstimator=new Y1,this._beginRadius=0,this._beginCenter=b(),this._beginAngle=0,this._tmpPoints=[],this._navMode=Oi.Horizontal,this._beginCenterScreen=Ht(),this._tmpCentroid3d=b(),this._tmpCentroid2d=Ht(),this._tmp2d=Ht(),this._pointerCount=0,this._beginCamera=new Ct,this._constraintOptions=new ir(dt.ALL,Ee.NONE,0,this._beginCamera)}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),Ca(e.center,this._beginCenterScreen),j1(tv,0,this._planeHorizontal);const s=b(),r=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,s,this.view.map.ground.opacity===0?To:{}),a=b();Xr(a,this.startCamera.viewForward);const n=b();le(n,tv);const o=ue(a,n);this._navMode=vc(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);const l=Math.min(Hb,1/Math.abs(ue(n,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),Gb);Xf(this._planeHorizontal,this._planeHorizontal,s),this.startCamera.aboveGround||P2(this._planeHorizontal,this._planeHorizontal);const h=b(),d=b(),u=b();be(h,s,this.currentCamera.eye);const m=xe(h);if(oe(h,h),this._navMode===Oi.Vertical){ee(n,n,o),be(Vr(this._planeVertical),a,n),oe(Vr(this._planeVertical),Vr(this._planeVertical)),Xf(this._planeVertical,this._planeVertical,s);const _=this.view._stage.renderView.getMinimalDepthForArea(rc(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,Ku);let f=_??l;f=r?Math.min(f,m):f,le(u,_e(d,this.currentCamera.eye,ee(d,h,f))),this._planeVertical[3]=-ue(Vr(this._planeVertical),u),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),Rp(this._tmpPoints,this._beginCenter)}else{const _=r?m:l;le(u,_e(d,this.currentCamera.eye,ee(d,h,_))),this._planeHorizontal[3]=-ue(Vr(this._planeHorizontal),u),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),Rp(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,s=this._navMode===Oi.Horizontal?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(t){const a=this._beginRadius/e.radius,n=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=n,this._scalingValueSmooth.update(a),yg(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=Ee.ZOOM,this._constraintOptions.interactionFactor=_r(Math.abs(e.radius-this._beginRadius)),Bt(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,s,this.currentCamera,this._tmpPoints),Rp(this._tmpPoints,this._tmpCentroid3d),Ca(e.center,this._tmpCentroid2d),Qb(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=Ee.PAN,this._constraintOptions.interactionFactor=_r(kh(this._beginCenterScreen,this._tmpCentroid2d)),Bt(this.view,this.currentCamera,this._constraintOptions),t){const a=r,n=this._rotationValueSmooth.value,o=n+Jm(e.angle-n),l=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=l,this._rotationValueSmooth.update(o);const h=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(h,.001*e.timestamp);const d=Vr(this._planeHorizontal);Tn(this.currentCamera,a,ic(d,h)),this._constraintOptions.interactionType=Ee.TUMBLE,this._constraintOptions.interactionFactor=_r(Math.abs(e.radius*h)),Bt(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new nl({view:this.view,momentum:t,zoomCenter:this._beginCenter});const s=this._rotationMomentumEstimator.evaluateMomentum();if(s)return new so({view:this.view,momentum:s,center:this._beginCenter,axis:Vr(this._planeHorizontal)});const r=this._panMomentumEstimator.evaluateMomentum();return r?new Eh({view:this.view,momentum:r}):null}_computePlanePoints(e,t,s,r){r.length=e.size;const a=this._tmp2d;let n=0;return e.forEach(o=>{a[0]=o.x,a[1]=o.y,r[n]===void 0&&(r[n]=b()),e_(t,s,a,r[n]),n+=1}),r}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};r_=c([F("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],r_);let iv=class extends Rr{constructor(e,t,s){super(!0),this._view=e,this.pointerAction=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",s,r=>this._handleDrag(r))}_handleDrag(e){if(e.data.pointerType==="mouse"&&!D_(e.data,this.pointerAction))return;const t=e.timestamp-this._lastEndTimestamp,s=40,r=this._momentum&&this._momentum.active&&t<s;switch(e.data.action){case"start":case"update":if(r)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){var s;if((s=this._controller)!=null&&s.active){this._lastEndTimestamp=e.timestamp;const r=this._controller.end(e.data);t&&r&&(this._momentum=r,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new s_({view:this._view}):new r_({view:this._view})}},hA=class extends Rr{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,()=>this.view.state.stopActiveCameraController())}},sw=class extends Rr{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,s=>this._handleKeyDown(s))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}},cA=class extends sw{constructor(e,t,s){super(t,s),this.view=e}activate(){this.view.goTo({heading:0}).catch(()=>{})}},dA=class extends sw{constructor(e,t,s){super(t,s),this.view=e}activate(){this.view.goTo({tilt:0}).catch(()=>{})}},uA=class extends Rr{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",s=>this._handleTwoFinger(s))}_handleTwoFinger(e){var r,a,n;const t=this._invert?-1:1,s=Ht(0,e.data.delta*t);switch(e.data.action){case"begin":(r=this._cameraController)==null||r.end(),this._cameraController=new Mh({view:this._view,pivot:ys.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(s);break;case"update":(a=this._cameraController)==null||a.update(s);break;case"end":(n=this._cameraController)==null||n.end(),this._cameraController=null}}},pA=class extends Rr{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new $T({start:(s,r)=>this._observeStart(s,r),update:(s,r,a)=>this._observeUpdate(s,r,a),end:(s,r)=>this._observeEnd(r)}),this.registerIncoming("drag",s=>this._dragEventSeparator.handle(s))}get failed(){return this._state==="failed"}_observeStart(e,t){e===1&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=e===2?"ready":"failed"}_observeUpdate(e,t,s){if(this._state!=="failed"&&e===2)return this._state==="active"?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,s.data)?this._checkVerticalThresholdReached(t.data,s.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){this._state==="active"&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let s=-1/0,r=1/0,a=-1/0,n=1/0;for(const{x:g,y}of t.pointers.values())s=Math.max(s,g),r=Math.min(r,g),a=Math.max(a,y),n=Math.min(n,y);let o=-1/0,l=1/0,h=-1/0,d=1/0;for(const{x:g,y}of e.pointers.values())o=Math.max(o,g),l=Math.min(l,g),h=Math.max(h,y),d=Math.min(d,y);const u=s-r,m=a-n,_=o-l,f=h-d;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(_-u)<=this._maxDelta&&Math.abs(f-m)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let s=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((r,a)=>{const n=t.pointers.get(a);s=Math.min(s,Math.abs(r.y-n.y))}),s>=this._threshold}},nr=class extends Re{destroy(){this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){e!=="pan"&&e!=="rotate"||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){e!=="default"&&e!=="pro"||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get updating(){var e;return!!((e=this._inputManager)!=null&&e.updating)}get latestPointerType(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerType}get latestPointerLocation(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerLocation}get multiTouchActive(){var e;return((e=this._inputManager)==null?void 0:e.multiTouchActive)??!1}disconnect(){this.view.viewEvents.disconnect(),this._inputManager=Y(this._inputManager)}connect(){const e=this.view;this._source=new IT(this.view.surface,e.input);const t=[new LT,new NT,new FT,new VT(this.view.navigation),new pA],s=new M2({eventSource:this._source,recognizers:t});this._inputManager=s,s.installHandlers("prevent-context-menu",[new UT],Jf.INTERNAL),this._modeDragPan=new iv(e,"primary"),this._modeDragRotate=new Lp(e,"secondary",ys.CENTER),this._modeDragZoom=new XE(e,"tertiary");const r={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};s.installHandlers("navigation",[new hA(e),new LE(e),new sA(e),new rA(e,r.pan),new aA(e),new dA(e,r.resetTilt),new cA(e,r.resetHeading),new Lp(e,"primary",ys.EYE,[r.lookAround]),new Lp(e,"secondary",ys.CENTER,[r.lookAround]),new iv(e,"tertiary",[r.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new uA(e)],Jf.INTERNAL),this.view.viewEvents.connect(s),this._updateMode(),this.addHandles(M(()=>{var a;return(a=this.view.navigation)==null?void 0:a.browserTouchPanEnabled},a=>{this._source.browserTouchPanningEnabled=!a},si))}isModifierKeyDown(e){var t;return((t=this._inputManager)==null?void 0:t.isModifierKeyDown(e))??!1}_updateMode(){var r;const e=this.mode,t=this.primaryDragAction,s=(r=a_.get(e))==null?void 0:r.get(t);s&&(this._modeDragPan&&(this._modeDragPan.pointerAction=s.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=s.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=s.zoom))}get test(){}};c([p()],nr.prototype,"view",void 0),c([p({value:"pan"})],nr.prototype,"primaryDragAction",null),c([p({value:"default"})],nr.prototype,"mode",null),c([p({readOnly:!0})],nr.prototype,"updating",null),c([p()],nr.prototype,"latestPointerType",null),c([p()],nr.prototype,"latestPointerLocation",null),c([p()],nr.prototype,"multiTouchActive",null),c([p()],nr.prototype,"_inputManager",void 0),nr=c([F("esri.views.3d.input.SceneInputManager")],nr);const a_=new Map,Np=new Map,Fp=new Map;Np.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),Np.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),Fp.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),Fp.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),a_.set("default",Np),a_.set("pro",Fp);const mA=nr;let $s,vl,n_=!1,o_=!1,l_=!1,h_=!1,Ah=null;function _A(i,e){if(!o_||!vl)return;rw();const t=vl;let s=0;for(let r=0;r<i.accBinsNumX;r++)for(let a=0;a<i.accBinsNumY;a++){const n=i.accBins[r][i.accBinsNumY-1-a];s+=n.length;const o=r*i.accBinsSizeX,l=(r+1)*i.accBinsSizeX,h=a*i.accBinsSizeY,d=(a+1)*i.accBinsSizeY;t.fillText(n.length.toFixed(),o+5,h+15),aw(o,l,h,d,"blue")}t.fillText("total totalShownLabels: "+s,70,40),t.fillText("total visible labels: "+e.size,70,50),t.fillText("total numTests: "+i.accNumTests,70,30)}function gA(i){l_=Ts.DECONFLICTOR_SHOW_VISIBLE,h_=Ts.DECONFLICTOR_SHOW_INVISIBLE,n_=l_||h_,o_=Ts.DECONFLICTOR_SHOW_GRID,Ah=null,n_||o_?Ah=()=>fA(i):$s&&($s.parentElement.removeChild($s),$s=null)}function rw(){Ah&&(Ah(),Ah=null)}function fA(i){$s==null&&($s=document.createElement("canvas"),$s.setAttribute("id","debugCanvas2d"),i.surface.parentElement.style.position="relative",i.surface.parentElement.appendChild($s));const{state:e}=i,{camera:t,pixelRatio:s}=e,{width:r,height:a}=t,n=r*s,o=a*s;$s.setAttribute("width",`${n}px`),$s.setAttribute("height",`${o}px`),$s.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${r}px;height:${a}px`),vl=$s.getContext("2d"),vl.clearRect(0,0,r,a),vl.font="12px Arial"}function aw(i,e,t,s,r){rw();const a=$s.height,n=vl;n.beginPath(),n.lineWidth=1,n.strokeStyle=r,n.moveTo(i,a-t),n.lineTo(e,a-t),n.stroke(),n.lineTo(e,a-s),n.stroke(),n.lineTo(e,a-t),n.stroke(),n.lineTo(i,a-t),n.stroke(),n.lineTo(i,a-t),n.stroke(),n.closePath()}function vA(i,e){n_&&(e&&l_||!e&&h_)&&aw(i.aabr[0],i.aabr[2],i.aabr[1],i.aabr[3],e?"green":"red")}const Er=b(),Fo=mi(),Wl=mi(),Vp=b(),yA=Qe(),bA=Sr(),Up=El(),wA=b(),xA=hi();class CA{constructor(){this.aabr=hi(),this.distance=0,this.culled=!1,this.visible=!1}}class TA{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info={}}}var _s;(function(i){i[i.Idle=0]="Idle",i[i.Process=1]="Process",i[i.Sort=2]="Sort",i[i.Deconflict=3]="Deconflict",i[i.NumStates=4]="NumStates"})(_s||(_s={}));class SA{constructor(){this.camera=new Ct,this.slicePlane=Fu(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),A_(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let ol=class extends Re{get dirty(){return this._dirty}get state(){return this._state}constructor(i){super(i),this._dirty=!1,this._viewState=new SA,this._state=_s.Idle,this._active=new Map,this._visible=new Map,this._iterators=new MA,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0}destroy(){this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==_s.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const i=this._state/_s.NumStates;return this._dirty?.5*i:i}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(i){switch(this._state){case _s.Idle:this._startUpdate(),i.madeProgress();case _s.Process:if(this._state=_s.Process,!this._processActiveGraphics(i))return;case _s.Sort:if(this._state=_s.Sort,!this._sortVisibleGraphics(i))return;case _s.Deconflict:if(this._state=_s.Deconflict,!this._deconflictVisibleGraphics(i))return;default:_A(this,this._visible),this._state=_s.Idle,this.notifyChange("updating")}}modifyGraphics(i,e){e?i.forEach(t=>this.addToActiveGraphics(t)):i.forEach(t=>this.removeFromActiveGraphics(t)),this.setDirty()}layerSupportsDeconfliction(i){if(i==null||i.type!=="object3d")return!1;const e=i.stageObject;if(((e==null?void 0:e.geometries.length)??0)!==1)return!1;const t=e==null?void 0:e.geometries[0];return(t==null?void 0:t.material)instanceof J1}_startUpdate(){gA(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:i,fullHeight:e}=this._viewState.camera;this._initBins(i,e),this._resetIterators()}addToActiveGraphics(i){i.info[this.visibilityGroup]=new CA,this._active.set(i.graphics3DGraphic.graphic.uid,i),this.setDirty()}removeFromActiveGraphics(i){this._visible.delete(i.graphics3DGraphic.graphic.uid),PA(i,this.visibilityGroup),delete i.info[this.visibilityGroup],this._active.delete(i.graphics3DGraphic.graphic.uid),this.setDirty()}_processActiveGraphics(i){const e=this._ensureActiveGraphicsIterator(),t=Ml(yA,this._viewState.camera.projectionMatrix),s=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._viewState.camera.relativeElevation>0?bA:null;let r=0;for(s!=null&&(Xt(qt(s),Ea,this._viewState.camera.viewMatrix),s[3]=Ut(this.view.spatialReference).radius,r=g2(s,Ea));!i.done;){i.madeProgress();const a=e.next();if(a.done===!0)return this._resetActiveGraphicsIterator(),!0;const n=a.value,o=n==null?void 0:n.info[this.visibilityGroup];o&&(this._collectGraphics3DGraphics(n,t,s,r),o.culled?this._visible.delete(n.graphics3DGraphic.graphic.uid):this._visible.set(n.graphics3DGraphic.graphic.uid,n))}return!1}_sortVisibleGraphics(i){const e=this._ensureSortGraphicsIterator();for(;!i.done;){const t=e.next();if(i.madeProgress(),t.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(i){const e=this._ensureVisibleGraphicsIterator(),t=this.visibilityGroup===js.LABEL;for(;!i.done;){i.madeProgress();const s=e.next();if(s.done===!0)return this._resetVisibleGraphicsIterator(),!0;const r=s.value,a=r.info[this.visibilityGroup];if(!a||a.culled){this._setGraphicVisibility(r,!1);continue}const n=r.graphics3DGraphic,o=!t||n.isVisible();a.visible=o&&!this._isConflicted(r),a.visible&&this._addToBins(r),this._setGraphicVisibility(r,a.visible),vA(a,a.visible)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=sv(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=sv(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=RA(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(i,e,t,s){const r=i.graphics3DGraphic;if(r.destroyed)return;const a=i.info[this.visibilityGroup];if(!r.isVisible(js.GRAPHIC,fr.DECONFLICTION))return void(a.culled=!0);const n=this.getGraphicsLayers(r);Jr(a.aabr);let o=null;for(const l of n){if(!this.layerSupportsDeconfliction(l))continue;const h=l.stageObject.geometries[0].material;if(o==null&&(o=$A,this._getProjectionInfo(l,e,o),o.isOutsideScreen||this._isCulledBySlice(i,Er)||t!=null&&DA(o,t,s)))return void(a.culled=!0);this._expandBoundingRect(a,l,h,o)}o==null?a.culled=!0:(a.distance=o.distance,a.culled=!1)}_getProjectionInfo(i,e,t){const s=this._viewState.camera,r=i.stageObject,a=r.geometries[0],n=a.material,o=qt(r.boundingVolumeWorldSpace.bounds);Xt(Er,o,s.viewMatrix);const l=a.attributes,h=l.get(Te.NORMAL).data,d=l.get(Te.CENTEROFFSETANDDISTANCE).data;n.applyShaderOffsetsView(Er,h,r.transformation,d,s,t.scaleInfo,Er),vn(Fo,Er[0],Er[1],Er[2],1),Im(Wl,Fo,s.projectionMatrix),ee(t.positionNDC,Wl,1/Wl[3]),n.applyShaderOffsetsNDC(t.positionNDC,d,s,t.positionNDC,Vp),t.distanceWithoutPolygonOffset=s.depthNDCToWorld(Vp[2]),t.distance=Vp[2]===t.positionNDC[2]?t.distanceWithoutPolygonOffset:s.depthNDCToWorld(t.positionNDC[2]),vn(Wl,t.positionNDC[0],t.positionNDC[1],t.positionNDC[2],1),Im(Fo,Wl,e),f1(Fo,Fo,1/Fo[3]),it(t.positionView,Er[0],Er[1],Er[2])}_isCulledBySlice(i,e){return i.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&bT(this._viewState.slicePlane,e)}_expandBoundingRect(i,e,t,{positionNDC:s,scaleInfo:r}){const a=this._viewState.camera,n=e.getScreenSize(EA);_P(n,r.factor,n),n[0]*=a.pixelRatio,n[1]*=a.pixelRatio;const o=Ky(t.calculateRelativeScreenBounds(n,r.factorAlignment.scale,xA),Be(0,a.fullWidth,.5+.5*s[0]),Be(0,a.fullHeight,.5+.5*s[1])),l=this.marginFactor;if(l!==0){const h=l*Math.min(Kn(o),Bh(o));o[0]-=h,o[1]-=h,o[2]+=h,o[3]+=h}hn(i.aabr,o,i.aabr)}_isConflicted(i){const e=i.graphics3DGraphic.graphic.uid,t=i.info[this.visibilityGroup];let s=!0;for(let r=Math.floor(t.aabr[0]/this._accBinsSizeX);r<=Math.floor(t.aabr[2]/this._accBinsSizeX);r++)if(!(r<0||r>=this._accBinsNumX))for(let a=Math.floor(t.aabr[1]/this._accBinsSizeY);a<=Math.floor(t.aabr[3]/this._accBinsSizeY);a++){if(a<0||a>=this._accBinsNumY)continue;s=!1;const n=this._accBins[r][a];for(let o=0;o<n.length;o++){const l=n.data[o],h=l.info[this.visibilityGroup];if(h&&h.visible&&l.graphics3DGraphic.graphic.uid!==e&&(this.accNumTests++,Nu(h.aabr,t.aabr)))return!0}}return s}_initBins(i,e){if(this._accBins==null){this._accBins=[];for(let t=0;t<this._accBinsNumX;t++){this._accBins.push([]);const s=this._accBins[this._accBins.length-1];for(let r=0;r<this._accBinsNumY;r++)s.push(new Gt)}}else for(let t=0;t<this._accBinsNumX;t++)for(let s=0;s<this._accBinsNumY;s++)this._accBins[t][s].clear();this._accBinsSizeX=i/this._accBinsNumX,this._accBinsSizeY=e/this._accBinsNumY,this.accNumTests=0}_addToBins(i){const e=i.info[this.visibilityGroup],t=Math.floor(e.aabr[0]/this._accBinsSizeX),s=Math.floor(e.aabr[2]/this._accBinsSizeX),r=Math.floor(e.aabr[1]/this._accBinsSizeY),a=Math.floor(e.aabr[3]/this._accBinsSizeY);for(let n=t;n<=s;n++)if(!(n<0||n>=this._accBinsNumX))for(let o=r;o<=a;o++)o<0||o>=this._accBinsNumY||this._accBins[n][o].push(i)}_setGraphicVisibility(i,e){const t=i.graphics3DGraphic;t.destroyed||(t.setVisibilityFlag(this.visibilityGroup,fr.DECONFLICTION,e),this.visibilityGroup===js.LABEL&&this.view.labeler.setLabelGraphicVisibility(t,e))}};function PA(i,e){const t=i.graphics3DGraphic;t.destroyed||t.setVisibilityFlag(e,fr.DECONFLICTION,!0)}function*sv(i){if(Map.prototype.entries){const e=i.entries();for(let t=e.next();!t.done;t=e.next())yield t.value[1]}else yield*i.values()}function*RA(i,e,t){e.clear(),i.forEach((r,a)=>{var l;const n=e.pushNew();n.id=a,n.visible=r.graphics3DGraphic.getVisibilityFlag(t,fr.DECONFLICTION);const o=(l=r.info)==null?void 0:l[t];n.prio=r.graphics3DGraphic.deconflictionPriority,n.distance=o?o.distance:Number.MAX_VALUE}),yield;const s=e.iterableSort((r,a)=>r.prio!==a.prio?a.prio-r.prio:r.distance!==a.distance?r.distance-a.distance:r.visible!==a.visible?r.visible?-1:1:r.id-a.id);for(let r=s.next();!r.done;r=s.next())yield;e.forAll(r=>{const a=i.get(r.id);a&&(i.delete(r.id),i.set(r.id,a))}),e.clear()}c([p({constructOnly:!0})],ol.prototype,"view",void 0),c([p({type:Boolean,readOnly:!0})],ol.prototype,"updating",null),ol=c([F("esri.views.3d.layers.graphics.Deconflictor")],ol);class OA{constructor(){this.id=0,this.visible=!1,this.prio=0,this.distance=0}}class MA{constructor(e=null,t=null,s=null){this.active=e,this.visible=t,this.sort=s,this.sortArray=new Gt({allocator:r=>r||new OA})}}const EA=Hi();class AA{constructor(){this.positionView=b(),this.positionNDC=b(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new U2}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}}function DA(i,e,t){return le(Up.direction,i.positionView),it(Up.origin,0,0,0),!!Gu(e,Up,wA)&&i.distanceWithoutPolygonOffset>t}const $A=new AA,IA=2e3;let Ed=class extends ol{constructor(e){super(e),this.visibilityGroup=js.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return Zi;const t=performance.now();if(e.state!==ft.IDLE&&t-this._lastDeconfliction<IA)return Zi;super.runTask(e),this.state===_s.Idle&&(this._lastDeconfliction=t)}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};c([p({constructOnly:!0})],Ed.prototype,"parent",void 0),Ed=c([F("esri.views.3d.layers.graphics.LabelDeconflictor")],Ed);let c_=class extends ol{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=js.GRAPHIC,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this.addHandles([M(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.state)==null?void 0:t.camera},()=>{this._updateViewState(),this.setDirty()}),M(()=>{var e,t,s;return(s=(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground)==null?void 0:s.opacity},(e,t)=>{e!==1&&t!==1||this.setDirty()}),M(()=>{var e;return(e=this.view)==null?void 0:e.slicePlane},()=>{this._updateSlicePlane(),this._slicePlaneChanged()},si)]),this._frameTask=this.view.resourceController.scheduler.registerTask(ci.GRAPHICS_DECONFLICTOR,this),this._labels=new Ed({view:this.view,parent:this})}destroy(){this._labels=Y(this._labels),this._frameTask=Zr(this._frameTask)}get marginFactor(){return this._marginFactor}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}_updateViewState(){var e;(e=this.view)!=null&&e.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;e!=null&&wT(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=e!=null}_slicePlaneChanged(){qy(this._contexts,(e,t)=>t.symbolCreationContext.slicePlaneEnabled)&&this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:s=>this._addGraphic(e,t,s),removeGraphic:s=>this._removeGraphic(t,s),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach(s=>this._removeGraphic(t,s.graphics3DGraphic)),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(s=>this._removeGraphic(t,s.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,s){const r=s.graphic.uid,a=new TA(s,e.symbolCreationContext.slicePlaneEnabled);t.set(r,a),qp(e)&&this.addToActiveGraphics(a),e.labelsEnabled&&this._labels.addToActiveGraphics(a);const n=!this._graphicSupportsDeconfliction(s)||!qp(e);s.setVisibilityFlag(js.GRAPHIC,fr.DECONFLICTION,n)}_removeGraphic(e,t){const s=t.graphic.uid,r=e.get(s);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(s),this.setDirty())}enabledChanged(e,t){const s=qp(e);s||LA(e),this.modifyGraphics(t,s)}_slicePlaneEnabledChanged(e,t){const s=e.symbolCreationContext.slicePlaneEnabled;t.forEach(r=>r.slicePlaneEnabled=s),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!(t!=null&&t.length))return!1;for(const s of t)if(this.layerSupportsDeconfliction(s))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const s=new Map;return this._contexts.set(e,s),this.setDirty(),s}};function qp(i){const e=i.layer;return!(!(e!=null&&e.featureReduction)||e.featureReduction.type!=="selection")}function LA(i){const e=i.graphics3DGraphics;e&&e.forEach(t=>t.setVisibilityFlag(js.GRAPHIC,fr.DECONFLICTION,!0))}c_=c([F("esri.views.3d.layers.graphics.GraphicsDeconflictor")],c_);function xg(i){return i instanceof KC?i.graphics3DSymbol:i instanceof JC?i:null}const ac=()=>Pe.getLogger("esri.views.3d.layers.graphics.labelPlacement");let NA=class{constructor(e,t,s,r=null){this.graphics3DGraphic=e,this.labelSymbol=t,this.labelClass=s,this.disablePlacement=r}};function rv(i){const e=kA(i);if(e==null)return null;const t=FA(i,e);if(t==null)return null;const s=t.anchor,r=!!e.hasLabelVerticalOffset,a=e.verticalOffset;return UA(new eT(a,s,r),t,i)}function FA(i,e){if(e.anchor)return e;const t=i.labelClass.labelPlacement,s=br[t],r=s||Eu(i);return t&&!s&&ac().warnOncePerTick(`the requested label placement '${t}' is currently unsupported in SceneView.`),VA(r,i)}function Cg(i){const e=i.graphics3DGraphic.graphics3DSymbol,t=xg(e);return t!=null?t.symbol.symbolLayers.at(0):null}function VA(i,e){const t=e.graphics3DGraphic.graphic.geometry;if(t==null)return null;if(e.disablePlacement!=null)return e.labelClass.labelPlacement?(ac().warnOncePerTick(av(i==null?void 0:i.placement,e.disablePlacement.logEntityDescription)),Eu(e)):i;const s=t.type;switch(s){case"polyline":case"polygon":case"extent":case"multipoint":if(e.labelClass.labelPlacement)return ac().warnOncePerTick(av(i==null?void 0:i.placement,`'${s}' geometries`)),Eu(e);break;case"point":case"mesh":return i}return i}function av(i,e){return`the requested label placement '${i}' is currently unsupported for ${e} in SceneView.`}function Eu(i){const e=i.graphics3DGraphic.graphic.geometry;if(e==null)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:Ea,anchor:"center"};case"polygon":{const t=Cg(i);return t!=null&&t.type==="extrude"?br["above-center"]:{placement:"center-center",normalizedOffset:Ea,anchor:"center"}}case"point":case"mesh":return br["above-center"];default:return}}function UA(i,e,t){const s=t.graphics3DGraphic.graphic.geometry;if(s==null)return null;switch(s.type){case"point":case"mesh":zA(i,e,t);break;case"polygon":qA(i,e,t)}const r=tT-iT;return i.screenOffset[0]+=r*e.normalizedOffset[0],i.screenOffset[1]+=r*e.normalizedOffset[1],i}function qA(i,e,t){const s=Cg(t);if(s!=null)switch(s.type){case"extrude":{const r=t.graphics3DGraphic.layers[0];r!=null?(r.getBoundingBoxObjectSpace(Dh),j2(Dh,i.translation),i.translation[2]=W2(Dh)/2):it(i.translation,0,0,0),nw(i,e,r);break}}}function zA(i,e,t){const s=Cg(t);if(s==null)return;const r=t.graphics3DGraphic.layers[0];switch(r!=null?r.getCenterObjectSpace(i.translation):it(i.translation,0,0,0),s.type){case"icon":case"text":BA(i,e,t,r);break;case"object":case"fill":nw(i,e,r)}}function BA(i,e,t,s){const{graphics3DGraphic:r}=t,a=s!=null?s.getScreenSize():null;if(r.isDraped||a==null)i.hasLabelVerticalOffset||i.anchor==="center"||(br[t.labelClass.labelPlacement]&&ac().warnOncePerTick(`the requested placement '${e.placement}' is currently unsupported for draped graphics`),i.anchor="center");else{const n=HA(t);i.screenOffset[0]=a[0]/2*(e.normalizedOffset[0]-n[0]);const o=a[1]/2*(e.normalizedOffset[1]-n[1]);i.hasLabelVerticalOffset?(i.centerOffset[1]=o,i.centerOffsetUnits="screen"):i.screenOffset[1]=o}}function HA(i,e=jA){const{graphics3DGraphic:t}=i,s=t.layers[0],r=(s==null?void 0:s.stageObject.geometries[0].material)??null;if(r&&r instanceof J1){const a=r.parameters.anchorPosition;e[0]=2*(a[0]-.5),e[1]=2*(a[1]-.5)}else e[0]=0,e[1]=0;return e}function nw(i,e,t){const s=t!=null?t.getBoundingBoxObjectSpace(Dh):Dh,r=St(s[3]-s[0],s[4]-s[1],s[5]-s[2]),a=Math.sqrt(r[0]*r[0]+r[1]*r[1]);i.centerOffset[0]=a/2*e.normalizedOffset[0];const n=i.translation[2],o=r[2]/2*e.normalizedOffset[1];i.translation[2]=0,i.elevationOffset=n+o;const l=xe(r);i.centerOffset[2]=l/2*e.normalizedOffset[2]}function GA(i){return i==="above-center"}function kA(i){const e=i.labelClass.labelPlacement,{labelSymbol:t,graphics3DGraphic:s}=i,r=xg(s.graphics3DSymbol),a=(r==null?void 0:r.symbol.type)==="point-3d"?r.symbol:null,n=br[e]||Eu(i);return a!=null&&a.supportsCallout()&&a.hasVisibleVerticalOffset()&&!s.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:a.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!t||!t.hasVisibleVerticalOffset()||a!=null&&a.supportsCallout()&&a.verticalOffset&&!s.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:n&&GA(n.placement)?{placement:"above-center",verticalOffset:t.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(ac().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}const br={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},nv={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const i in nv){const e=nv[i],t=br[i];e.forEach(s=>{br[s]=t})}Object.freeze&&(Object.freeze(br),Object.keys(br).forEach(i=>{var e;Object.freeze(br[i]),Object.freeze((e=br[i])==null?void 0:e.normalizedOffset)}));const jA=[0,0],Dh=Wu();let ov=class{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}},lv=class{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.addedToTextureAtlas=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}},WA=class{constructor(e,t,s,r,a){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=s,this.textRenderParameters=r,this.labelFunction=a,this.calloutSymbolLayerIndex=0}},QA=class{constructor(e,t,s,r,a,n,o,l){this.layer=t,this.graphics3DCore=s,this.scaleVisibility=r,this.emptySymbolLabelSupported=a,this.elevationInfoOverride=n,this.disablePlacement=o,this.active=l,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new xP(e,{pickable:!0,disableOctree:!0},t.uid)}destroy(){this.stageLayer.destroy()}},Qn=class extends Re{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([M(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this.setDirty()),M(()=>{var e;return(e=this.view.state)==null?void 0:e.rasterPixelRatio},()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(ci.LABELER,this)]),this._textTextureAtlas=new _f({view:this.view}),this._hudMaterialCollection=new ov(this.view._stage),this._calloutMaterialCollection=new ov(this.view._stage)}dispose(){this.removeAllHandles(),this._textTextureAtlas=je(this._textTextureAtlas),this._hudMaterialCollection=je(this._hudMaterialCollection),this._calloutMaterialCollection=je(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),sr.graphic=null,sr.renderingInfo=null,sr.layer=null}_activateLabelingContext(e){e.graphics.forEach((t,s)=>{const r=new lv(e,t);this._labels.set(s,r),e.labelsToInitialize.set(s,r),t.setVisibilityFlag(js.LABEL,fr.USER,!0)}),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach((t,s)=>{t.setVisibilityFlag(js.LABEL,fr.USER,!1),this.setLabelGraphicVisibility(t,!1),t.clearLabelGraphics(),this._labels.delete(s)}),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&(this._textTextureAtlas.addTextTexture(s,t.stageObject),e.addedToTextureAtlas=!0)}}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s!=null&&(this._textTextureAtlas.removeTextTexture(s,t.stageObject),e.addedToTextureAtlas=!1)}}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),Zi}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(zp(t))this._dirty=!0;else if(Bp(t.labelClassContexts)){if(t.labelClassContexts===null){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else qy(t.labelsToInitialize,(s,r)=>(this._ensureGraphics3DResources(s)&&(this._labels.set(r,s),this.deconflictor.setDirty(),e.madeProgress()),(s.visible&&s.textInitialized||!s.visible&&s.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done))&&(this._dirty=!0);this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){var n,o,l;const t=(n=e.labelClassAbortController)==null?void 0:n.signal;e.layer.when&&await e.layer.when(),Qi(t),(o=e.scaleVisibility)==null||o.updateScaleRangeActive();const s=e.graphics3DCore,r=s.layer,a=(l=r.labelingInfo)==null?void 0:l.filter(h=>!!h.symbol);!a||a.length===0||(await gC(a,async(h,d)=>{const u=h.symbol,m=xg(s.getOrCreateGraphics3DSymbol(u));if(m==null)return void Pe.getLogger(this).error("Failed to create Graphics3DSymbol for label");await m.load(),Qi(t);let _=null;B2(u)&&u.hasVisibleCallout()&&(_=cT(u,s.symbolCreationContext),await _.load(),Qi(t));const f=await fC(z2(h,e.layer.fieldsIndex,this.view.spatialReference));if(Qi(t),f.ok===!0){const g=await this._createTextRenderParameters(m.symbol);Qi(t),e.labelClassContexts[d]=new WA(h,m,_,g,f.value)}else Pe.getLogger(this).error(`Label expression failed to evaluate: ${f.error}`)}),Qi(t))}async _createLabelClassContext(e){return e.labelClassPromise==null&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(t=>{if(mn(t))throw t;e.labelClassContexts.length=0}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return(t==null?void 0:t.type)!=="text"?null:sT.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const s of e.labelClassContexts)--s.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,Pn(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,s,r,a,n){const o=new rT(s,gf(s.anchor),aT(s.anchor),e.text,U_(e.displayWidth,e.displayHeight));return sr.graphic=t,sr.renderingInfo=null,sr.layer=r,a.createLabel(sr,o,this._hudMaterialCollection,this._textTextureAtlas,()=>{const l=rv(n);return l?l.elevationOffset:null})}_createLineCalloutGraphic(e,t,s,r,a){sr.graphic=e,sr.layer=a;const n=r.screenOffset[0];return sr.renderingInfo=new nT(null,t,r.translation,r.centerOffset,n,r.centerOffsetUnits,r.elevationOffset,this._calloutMaterialCollection),s.createGraphics3DGraphic(sr)}_ensureGraphics3DResources(e){var h,d;if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const s=e.labelingContext,r=s.labelClassContexts;if(Bp(r)||!s.emptySymbolLabelSupported&&t.layers.length===0)return!1;let a=!1;const n=t.graphic,o=s.layer,l=Yc(s.layer);for(let u=0;u<r.length;u++){const m=e.textRenderers[u],_=e.textLabelPlacements[u];if(m==null||_==null)continue;const f=r[u],g=f.graphics3DSymbol,y=g.symbol&&g.symbol.type==="label-3d"?g.symbol:null,w=g.symbolLayers[0];if(!w)continue;w.setElevationInfoOverride(s.elevationInfoOverride);const x=new NA(t,y,f.labelClass),T=this._createTextSymbolGraphic(m,n,_,o,w,x);if(T==null)return!1;T._labelClass=f.labelClass,T._labelIndex=u,t.addLabelGraphic(T,s.stageLayer),t.deconflictionPriority=((h=f.textRenderParameters)==null?void 0:h.definition.size)??0,t.setVisibilityFlag(js.LABEL,fr.USER,l),t.setVisibilityFlag(js.LABEL,fr.SCALE_RANGE,!0),t.setVisibilityFlag(js.LABEL,fr.DECONFLICTION,!1),a=!0;const S=f.graphics3DCalloutSymbolLayer;if(S&&_.hasLabelVerticalOffset){S.setElevationInfoOverride(s.elevationInfoOverride);const C=this._createLineCalloutGraphic(n,y,S,_,o);C!=null&&(f.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(C,s.stageLayer))}break}return a&&((d=s.scaleVisibility)==null||d.updateGraphicLabelScaleVisibility(t)),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const s of e.graphics3DGraphic.labelLayers){if(s._labelClass==null)continue;const r=t[s._labelIndex].graphics3DSymbol.symbolLayers[0];r==null||r.onRemoveGraphic(s)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){var a;if(e.textInitialized)return;const t=e.labelingContext,s=t.labelClassContexts;if(Bp(s))return;const r=e.graphics3DGraphic.graphic;for(let n=0;n<s.length;n++){const o=s[n];if(e.textRenderers[n]=null,e.textLabelPlacements[n]=null,(o==null?void 0:o.textRenderParameters)==null)continue;const l=o.labelFunction;let h;if(l.type==="arcade")try{const x=l.needsHydrationToEvaluate()?q2(r,t.layer):r;h=l.evaluate(x)}catch{h=null}else h=l.evaluate(r);if(h==null||h===""||/^\s+$/.test(h))continue;const d=o.graphics3DSymbol,u=((a=d.symbol)==null?void 0:a.type)==="label-3d"?d.symbol:null;if(!d.symbolLayers[0])continue;const m=e.graphics3DGraphic,_=o.labelClass,f=t.disablePlacement,g=rv({graphics3DGraphic:m,labelSymbol:u,labelClass:_,disablePlacement:f});if(g==null)continue;const y=gf(g.anchor),w=oT(y);e.textRenderers[n]=new lT(h,w,o.textRenderParameters,_f.maxSize),e.textLabelPlacements[n]=g}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const s=t.graphic.uid;if(e.graphics.set(s,t),e.active){const r=new lv(e,t);this._labels.set(s,r),e.labelsToInitialize.set(s,r)}this.setDirty(),this.deconflictor.setDirty()}_updateGraphicGeometry(e,t){const s=t.graphic.uid,r=this._labels.get(s);if(!r)return!0;for(const a of r.graphics3DGraphic.labelLayers)if(a._labelClass!=null&&!e.labelClassContexts[a._labelIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(a,t.graphic.geometry))return!1;return this.setDirty(),this.deconflictor.setDirty(),!0}_removeGraphic(e,t){const s=t.graphic.uid,r=this._labels.get(s);e.graphics.delete(s),r&&(this._destroyGraphic(r,s),e.labelsToInitialize.delete(s),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const s of t){const r=e.graphics.get(s);r&&(this._removeGraphic(e,r),this._addGraphic(e,r))}}_globalPropertyChanged(e,t){for(const s of t.labelClassContexts){const r=new Map;t.graphics.forEach(n=>r.set(n.graphic.uid,n));const a=n=>n.labelLayers[0];if(s.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,a),s.graphics3DCalloutSymbolLayer){const n=o=>o.labelLayers[s.calloutSymbolLayerIndex];s.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,n)}}}_visibilityInfoChange(e){const t=Yc(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach((t,s)=>{const r=this._labels.get(s);r&&(this._destroyGraphic(r,s),r.visible=!1,e.labelsToInitialize.set(s,r))}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,s){const r=(s==null?void 0:s.emptySymbolLabelSupported)||!1,a=(s==null?void 0:s.elevationInfoOverride)||null,n=(s==null?void 0:s.disablePlacement)||null;if(this._findLabelingContext(e))return;const o=e.layer,l=new QA(this.view._stage,o,e,t,r,a,n,Yc(o));return this._labelingContexts.push(l),this.setDirty(),{addGraphic:h=>this._addGraphic(l,h),removeGraphic:h=>this._removeGraphic(l,h),updateGraphicGeometry:h=>this._updateGraphicGeometry(l,h),layerLabelsEnabled:()=>Yc(l.layer),labelingInfoChange:h=>this._labelingInfoChange(l,h),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",l),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",l),visibilityInfoChange:()=>this._visibilityInfoChange(l),reset:()=>this._resetLabels(l),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const s=this._labelingContexts.indexOf(t);this._labelingContexts.splice(s,1),t.graphics.forEach(r=>this._removeGraphic(t,r)),t.destroy(),this.setDirty()}setLabelGraphicVisibility(e,t){const s=e.graphic.uid,r=this._labels.get(s);r&&r.visible!==t&&(t&&!r.addedToTextureAtlas?(this._addLabelTextureToAtlas(r),r.textInitialized||r.labelingContext.labelsToInitialize.set(s,r)):!t&&r.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(r),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some(t=>zp(t))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((t,s)=>t+(zp(s)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){}};function zp(i){return!!i.labelClassPromise&&!!i.labelClassAbortController}function Bp(i){return!i||i.length===0}function Yc(i){var e;return i.labelsVisible===!0&&!!((e=i.labelingInfo)!=null&&e.some(t=>!!t.symbol))}c([p({constructOnly:!0})],Qn.prototype,"view",void 0),c([p({constructOnly:!0})],Qn.prototype,"deconflictor",void 0),c([p()],Qn.prototype,"_textTextureAtlas",void 0),c([p({type:Boolean,readOnly:!0})],Qn.prototype,"updating",null),Qn=c([F("esri.views.3d.layers.graphics.Labeler")],Qn);const sr=new hT(null,null,null);function XA(i,e,t,s,r,a,n=1){const o=Bm(e,r,K2);if(o==null)return!1;if(o===J2){if(i===s&&t===a)return!0;const h=t+n;for(let d=t,u=a;d<h;++d,++u)le(s[u],i[d]);return!0}const l=t+n;for(let h=t,d=a;h<l;++h,++d)o(i[h],0,s[d],0);return!0}let YA=class{constructor(e,t){this._renderCoordsHelper=e,this._getIsGroundOpaque=t,this._surfaceElevation=0,this._isGroundOpaque=!1,this._cache=new Map,this._frustumBoundingSphereCenter=b(),this._frustumBoundingSphereRadius=0,this._frustum=new nn(e),this._extendedFrustum=new nn(e),this._intersector=new dT({renderCoordsHelper:e}),this._renderSR=e.spatialReference;const s=Z2(this._renderSR);this._renderSREllipsoidRadius=Ut(s).radius,this._renderCoordsHelper=e}begin(e,t){this._surfaceElevation=t,this._aboveGround=e.aboveGround,this._isGroundOpaque=this._getIsGroundOpaque(),this._frustum.update(e),pv(this._frustum),this._updateExtendedFrustum(e),this._updateFrustumBoundingSphere()}end(){this._cache.clear()}calculate(e){const t=this._renderCoordsHelper.viewingMode===$e.Global&&e.lij[0]>=ZA&&e.lij[0]<KA,s=this._getOrCalculateSingleTileVisibility(e,!t);return s!==Bs.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):s}_calculateAggregatedChildrenVisibility(e){let t=Bs.INVISIBLE;const s=this._cache.get(e.id);if(s!=null)return s;const r=uv.acquire();e.getChildren(r);for(const a of r){const n=this.calculate(a);if(n!==Bs.INVISIBLE&&(t=n,n===Bs.VISIBLE_ON_SURFACE))break}return uv.release(r),this._cache.set(e.id,t),t}_getOrCalculateSingleTileVisibility(e,t){const s=this._cache.get(e.id);if(s!=null)return s;const r=this._calculateSingleTileVisibility(e);return t&&this._cache.set(e.id,r),r}_calculateSingleTileVisibility(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===$e.Global&&e.lij[0]<JA?this._calculateSingleTileVisibilitySided(e,!1)===Bs.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}_isTileVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===$e.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,t=e.origin,s=dD;oe(s,e.direction);const r=e.points,a=uD;xt(a,r[4],t);const n=.5*ue(a,a)/ue(s,a),o=this._frustumBoundingSphereCenter;Yo(o,t,s,n);const l=1+n;this._frustumBoundingSphereRadius=l}_isTileVisibleInFrustumLocal(e){const t=e.tilingScheme.spatialReference,s=e.extent,r=this._renderSR,a=aD;if(a[0]=s[0],a[1]=s[1],a[2]=0,a[3]=s[2],a[4]=s[3],a[5]=0,!eR(a,t,0,a,r,0,2))return!1;const n=_v;it(n[0],a[0],a[1],0),it(n[1],a[3],a[1],0),it(n[2],a[3],a[4],0),it(n[3],a[0],a[4],0);const o=gv;it(o,.5*(a[0]+a[3]),.5*(a[1]+a[4]),.5*(a[2]+a[5]));const l=nD;it(l,0,0,1);const h=.5*Ch(n[0],n[2]),d=this._frustum,u=this._frustumBoundingSphereRadius,m=this._frustumBoundingSphereCenter,_=mD;xt(_,m,o);const f=ue(l,_),g=pD;if(Yo(g,o,l,f),Ch(g,m)>h+u)return!1;const y=rD,w=this._isGroundOpaque&&this._aboveGround,x=this._isGroundOpaque&&!this._aboveGround,T=Math.min(x?Xl:1/0,f+u),S=Math.max(w?-Xl:-1/0,f-u);for(let C=0;C<4;++C)Yo(y[C],n[C],l,T),Yo(y[C+4],n[C],l,S);return!d_(d.planes,y,8)}_isTileVisibleInFrustumGlobal(e){const t=e.tilingScheme.spatialReference,s=e.extent,r=this._isGroundOpaque&&this._aboveGround,a=this._isGroundOpaque&&!this._aboveGround;if(e.lij[0]<ow)return!0;const n=_v,o=.5*(s[0]+s[2]);if(it(n[0],s[0],s[1],0),it(n[1],s[2],s[1],0),it(n[2],s[2],s[3],0),it(n[3],s[0],s[3],0),it(n[4],o,s[1],0),it(n[5],o,s[3],0),!XA(n,t,0,n,this._renderSR,0,6))return!1;const l=n[0][2]>0,h=n[3][2]<0,d=l||h,u=this._renderSREllipsoidRadius;if(d){const ne=St(0,0,1),de=oD;Ya(de,ne,n[0]);const ce=lD;if(Ya(ce,ne,n[1]),l){const re=fv,Oe=n[4],Ie=vv;Ya(Ie,Oe,ne),Ya(re,Ie,Oe);const Me=n[0];yt(Me,de,re),Ql(Me,u);const Ae=n[1];yt(Ae,ce,re),Ql(Ae,u)}else if(h){const re=fv,Oe=n[5],Ie=vv;Ya(Ie,Oe,ne),Ya(re,Oe,Ie);const Me=n[3];yt(Me,re,de),Ql(Me,u);const Ae=n[2];yt(Ae,re,ce),Ql(Ae,u)}}const m=gv;{const ne=xt(vD,n[3],n[0]);oe(ne,ne);const de=_e(yD,n[0],n[3]);ee(de,de,.5);const ce=-ue(de,ne),re=_e(bD,n[0],n[1]);ee(re,re,.5);const Oe=_e(wD,n[2],n[3]);ee(Oe,Oe,.5);const Ie=xt(xD,Oe,re);oe(Ie,Ie);const Me=-(ce+ue(ne,re))/ue(ne,Ie);Yo(m,re,Ie,Me),Ql(m,u)}const _=this._frustumBoundingSphereRadius,f=this._frustumBoundingSphereCenter,g=this._frustum,y=g.planes,w=hD;oe(w,m);const x=ue(n[0],w)/fs(n[0]),T=g.origin,S=g.points;let C=!1;if(r){{C=!0;const de=oe(b(),T);for(let ce=0;ce<4;++ce){const re=S[4+ce],Oe=xt(b(),re,T);oe(Oe,Oe);const Ie=yt(b(),de,Oe);oe(Ie,Ie);const Me=yt(b(),Oe,Ie);if(oe(Me,Me),ue(T,Me)>u){C=!1;break}}}if(C&&ue(T,w)<u*x-Xl)return!1;const ne=oe(VD,g.origin);if(ue(ne,w)<0)return!1;{const de=oe(UD,g.direction);if(ue(de,w)>qD)return!1}}const P=Math.sqrt(1-x*x);if(P>.9)return!0;let R=!1;{const ne=ue(w,f),de=fs(f);if(de<=_&&!y.some(Oe=>bo(Oe,Hp)>0)){if(!r)return!0;R=!0}const ce=ne/de;if(!R&&ne<=0&&-ne>_)return!1;const re=_/de;if(Math.sqrt(1-ce*ce)*Math.sqrt(1-re*re)-re*ce>P)return!1}if(!C&&(n.some(ne=>g.intersectsPoint(ne))||g.intersectsPoint(m)))return!0;const I=_D;xt(I,f,Hp);const L=ue(I,w),G=cD;ee(G,w,L);const H=Ch(G,f),D=t.isWGS84,J=e.lij,A=D&&J[2]===2**J[0]-1,O=D&&J[2]===0,te=O?DD:A?ED:OD,$=O?$D:A?AD:MD;if(!R){const ne=n,de=ID,ce=CD,re=TD,Oe=Hp;for(const Ie of te){const Me=ne[Ie];if(mv(ce,ne[(Ie+1)%4],Me),mv(re,Oe,Me),Ya(de,re,ce),sD(de,S,1))return!1}}let U=null;if(!r&&L<1.01*_){const ne=2.5*_;if(H>x*ne+_)return!1;const de=fD,ce=ne/x;for(let re=0;re<4;++re)ee(de[re],n[re],ce/u);it(de[4],0,0,0),U=de}else{const ne=(a?u+Xl:L+_)/x,de=r?u-Xl:(L-_)/x,ce=gD;for(let re=0;re<4;++re){const Oe=n[re];ee(ce[re],Oe,de/u),ee(ce[re+4],Oe,ne/u)}U=ce}if(d_(y,U,U.length))return!1;const ye=g.lines,he=SD,ge=PD;for(const ne of ye){oe(ge,ne.direction);for(const de of $){const ce=U[de];if(oe(he,ce),Gp(ge,he,U,S))return!1;const re=(de+1)%4;if(r){const Oe=U[re];if(xt(he,Oe,ce),oe(he,he),Gp(ge,he,U,S))return!1}if(a){const Oe=U[4+de],Ie=U[4+re];if(xt(he,Ie,Oe),oe(he,he),Gp(ge,he,U,S))return!1}}}return!0}_calculateSingleTileVisibilitySided(e,t){return this._isTileVisibleInFrustum(e)?(this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,t),this._intersector.isVisibleInFrustum(this._frustum,this._renderSREllipsoidRadius,!0)?Bs.VISIBLE_ON_SURFACE:Bs.VISIBLE_WHEN_EXTENDED):Bs.INVISIBLE}_updateExtendedFrustum(e){this._extendedFrustum.update(e),pv(this._extendedFrustum);const t=this._renderCoordsHelper.worldUpAtPosition(e.eye,Ds);this._aboveGround||Xr(t,t);const s=Kr(-ue(t,e.viewForward));if(this._hasExtendedFrustum=s>e.fovY/2,!this._hasExtendedFrustum)return;const r=this._extendedFrustumParameters(),a=this._extendedFrustum.mutablePoints;for(let n=0;n<4;n++){const o=r.pointIndices[n],l=a[o],h=this._renderCoordsHelper.getAltitude(l);if(r.needsAltitudeAdjustment(h)){switch(this._renderCoordsHelper.worldUpAtPosition(l,Ds),o){case gt.FAR_BOTTOM_LEFT:case gt.FAR_TOP_LEFT:case gt.NEAR_BOTTOM_LEFT:case gt.NEAR_TOP_LEFT:Yf(this._extendedFrustum.planes[Sa.LEFT],Ds,Ds);break;case gt.FAR_BOTTOM_RIGHT:case gt.FAR_TOP_RIGHT:case gt.NEAR_BOTTOM_RIGHT:case gt.NEAR_TOP_RIGHT:Yf(this._extendedFrustum.planes[Sa.RIGHT],Ds,Ds)}ee(Ds,Ds,r.direction),this._renderCoordsHelper.intersectInfiniteManifold(vo(l,Ds),r.zWithMargin,l)}}if(this._extendedFrustum.updatePoints(a),Zf(a[gt.NEAR_BOTTOM_LEFT],a[gt.NEAR_BOTTOM_RIGHT],a[gt.NEAR_TOP_RIGHT],cv),Zf(a[gt.NEAR_BOTTOM_RIGHT],a[gt.NEAR_TOP_RIGHT],a[gt.NEAR_TOP_LEFT],dv),ue(Vr(cv),Vr(dv))<0){const n=this._extendedFrustum.mutablePoints;this._aboveGround?[n[gt.NEAR_BOTTOM_LEFT],n[gt.NEAR_BOTTOM_RIGHT]]=[n[gt.NEAR_BOTTOM_RIGHT],n[gt.NEAR_BOTTOM_LEFT]]:[n[gt.NEAR_TOP_LEFT],n[gt.NEAR_TOP_RIGHT]]=[n[gt.NEAR_TOP_RIGHT],n[gt.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(n)}}_extendedFrustumParameters(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const e=this._surfaceElevation-hv;return{zWithMargin:e,pointIndices:nn.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}_extendedFrustumParametersBelowSurface(){const e=this._surfaceElevation+hv;return{zWithMargin:e,pointIndices:nn.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}};const ZA=2,KA=6,JA=12,eD=.95,hv=1,Ds=b(),cv=yo(),dv=yo(),uv=new _n(Array,i=>{i.length!==4&&(i[0]=new sh,i[1]=new sh,i[2]=new sh,i[3]=new sh)},i=>{i[0].release(),i[1].release(),i[2].release(),i[3].release()});function pv(i){const e=nn.nearFarLineIndices,t=i.mutablePoints;for(const s of e){const[r,a]=s,n=t[r],o=t[a];be(Ds,o,n),ee(Ds,Ds,eD),_e(t[a],n,Ds)}i.updatePoints(t)}function Ya(i,e,t){return yt(i,e,t),oe(i,i),i}function mv(i,e,t){return xt(i,e,t),oe(i,i),i}function Ql(i,e){return ee(i,i,e/fs(i)),i}const tD=[Sa.LEFT,Sa.RIGHT,Sa.BOTTOM,Sa.TOP,Sa.FAR];function iD(i,e,t){for(let s=0;s<t;++s)if(bo(i,e[s])<=0)return!1;return!0}function d_(i,e,t){for(const s of tD)if(iD(i[s],e,t))return!0;return!1}const ow=4;function sD(i,e,t){for(const s of e)if(ue(s,i)<t)return!1;return!0}const rD=[b(),b(),b(),b(),b(),b(),b(),b()],aD=[0,0,0,0,0,0],_v=[b(),b(),b(),b(),b(),b()],gv=b(),nD=b(),fv=b(),oD=b(),lD=b(),vv=b(),hD=b(),cD=b(),dD=b(),uD=b(),pD=b(),mD=b(),Hp=St(0,0,0),_D=b(),gD=[b(),b(),b(),b(),b(),b(),b(),b()],fD=[b(),b(),b(),b(),b()],vD=b(),yD=b(),bD=b(),wD=b(),xD=b(),CD=b(),TD=b(),SD=b(),PD=b(),RD=b(),OD=[0,1,2,3],MD=[0,1,2,3],ED=[0,1,3],AD=[0,1,3],DD=[1,2,3],$D=[1,2,3],ID=b();function LD(i,e,t){let s=1/0,r=-1/0;for(const a of t){const n=ue(e,a);s=Math.min(s,n),r=Math.max(r,n)}i[0]=s,i[1]=r}function ND(i,e,t,s){let r=1/0,a=-1/0;for(const n of s){const o=ue(t,n);if(r=Math.min(r,o),a=Math.max(a,o),r<=e&&a>=i)return!1}return!0}const FD=[0,0];function Gp(i,e,t,s){if(t.length===0||s.length===0)return!0;const r=RD;Ya(r,i,e);const a=s[0]<t[0],n=a?t:s,o=FD;return LD(o,r,a?s:t),ND(o[0],o[1],r,n)}const Xl=430,VD=b(),UD=b(),qD=Math.cos(.25*Math.PI);let zD=class{constructor(e){this._camera=new Ct,this._focusOnMap=[0,0],this._screenRect=hi(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new YA(e.renderCoordsHelper,e.getIsGroundOpaque)}begin(e,t,s){this._camera.copyFrom(e),this._surfaceElevation=s,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,Jy(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,s)}end(){this._visibility.end()}updateTile(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=gT(e.extent,this._focusOnMap),e.measures.visibility!==Bs.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const t=BD,s=1<<t,r=e.measures.screenRect;Jr(r);let a=0;const n=e.lij,o=n[0],l=o+t,h=n[1]<<t,d=n[2]<<t,u=this._tileSizeWithBias(e),m=u*u,_=this._camera,{frustum:f,viewport:g}=_;if(this._renderCoordsHelper.viewingMode===$e.Local||o>ow){const y=yv;this._tilingScheme.getExtent(n[0],n[1],n[2],y);const w=Vo,x=kD,T=Jr();for(let P=0;P<4;++P)this._toRenderCoords(y,xv[P][0],xv[P][1],x[P]),_.projectToScreen(x[P],w[P]),e1(T,w[P]);const S=d_(f,x,4),C=T[0]>g[2]||T[1]>g[3]||T[2]<g[0]||T[3]<g[1];if(S||C)return void(e.measures.shouldSplit=!1)}for(let y=0;y<s;y++)for(let w=0;w<s;w++)if(a+=this._computeScreenArea(l,h+y,d+w,r),a>m)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===Bs.VISIBLE_WHEN_EXTENDED?this._tileSize*HD:this._tileSize}_computeScreenArea(e,t,s,r){this._tilingScheme.ensureMaxLod(e);const a=yv;this._tilingScheme.getExtent(e,t,s,a);const n=GD;return this._toRenderCoords(a,0,3,n[0]),this._toRenderCoords(a,2,3,n[1]),this._toRenderCoords(a,2,1,n[2]),this._toRenderCoords(a,0,1,n[3]),this._computeTriangleScreenArea([n[0],n[1],n[2]],r)+this._computeTriangleScreenArea([n[2],n[1],n[3]],r)}_computeTriangleScreenArea(e,t){const s=this._camera.frustum[Sa.NEAR];let r=0,a=-1,n=-1;for(let o=0;o<3;++o)bo(s,e[o])>0?(r++,a===-1&&(a=o)):n===-1&&(n=o);if(r===0)return this._computeTriangleScreenAreaInside(e,t);if(r===1){const o=wv,l=(a+1)%3,h=(a+2)%3,d=a;le(o[0],e[l]),le(o[1],e[h]),Kc(o[2],e[h],e[d],s);const u=this._computeTriangleScreenAreaInside(o,t);return Kc(o[1],e[l],e[d],s),u+this._computeTriangleScreenAreaInside(o,t)}if(r===2){const o=wv,l=n;le(o[0],e[l]);const h=(n+1)%3,d=(n+2)%3;return Kc(o[1],e[l],e[h],s),Kc(o[2],e[l],e[d],s),this._computeTriangleScreenAreaInside(o,t)}return 0}_computeTriangleScreenAreaInside(e,t){for(let s=0;s<3;s++)this._camera.projectToRenderScreen(e[s],bv),this._camera.renderToScreen(bv,Vo[s]),hn(t,Vo[s],t);return Y2(Vo[0],Vo[1],Vo[2])}_toRenderCoords(e,t,s,r){return Zc[0]=e[t],Zc[1]=e[s],Zc[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(Zc,this._tilingScheme.spatialReference,r),r}};const BD=2,HD=5,Vo=[Ht(),Ht(),Ht(),Ht()],yv=hi(),Zc=b(),GD=[b(),b(),b(),b()],bv=dc(),wv=[b(),b(),b()];function Kc(i,e,t,s){const r=bo(s,e),a=bo(s,t),n=Math.abs(a-r);ee(i,e,Math.abs(a)/n),Yo(i,i,t,Math.abs(r)/n)}const kD=[b(),b(),b(),b()],xv=[[0,3],[2,3],[2,1],[0,1]];let vi=class extends Re{get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(e!=null&&!e.spatialReference.equals(this.viewState.spatialReference))return void Pe.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||t!=null&&e&&t.equals(e))return;const s=e!=null?e.clone():null;this._set("filterExtent",s),this._setDirty()}get _filterExtentRect(){if(this.filterExtent==null)return null;const e=hi();return Xy(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}constructor(e){super(e),this.tiles=new Qr,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=!1,this._pendingTiles=null,this._newTiles=new Gt}initialize(){this.addHandles([M(()=>[this.tilingScheme,this.tileSize],()=>this._reset(),nt),M(()=>{var e,t,s;return[this.tileSize,(e=this.cameraOnSurface)==null?void 0:e.location,this.tilingScheme,(t=this.viewState)==null?void 0:t.contentCamera,(s=this.focus)==null?void 0:s.location]},()=>this._setDirty(),ut),M(()=>{var e;return((e=this.terrain)==null?void 0:e.baseOpacity)??1},()=>this._setDirty())]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(ci.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=Zr(this._frameWorker)}addClient(){const e=EC();return this._clients.add(e),this._clients.size===1&&this._setDirty(),on(()=>this._removeClient(e))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(Ta))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),this._frameWorker!=null&&(this._frameWorker.priority=ci.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),this._pendingTiles||this._frameWorker==null||(this._frameWorker.priority=ci.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new zD({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize,getIsGroundOpaque:()=>{var t;return(((t=this.terrain)==null?void 0:t.baseOpacity)??1)===1}}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){const{tilingScheme:e}=this;return this._rootTileIds.map(t=>new sh(t[0],t[1],t[2],e))}_purgeHorizonTiles(e){if(e.sort((t,s)=>{const r=t.measures.screenRect,a=s.measures.screenRect;return r[1]+r[3]-(a[1]+a[3])}),!(e.length>WD))return e.toArray();Jr(Jc);for(let t=0;t<e.length;t++)if(hn(Jc,e.data[t].measures.screenRect,Jc),Bh(Jc)>jD)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(!this._pendingTiles)return;const{tilingScheme:t}=this;for(;this._pendingTiles.length>0&&!e.done;){const s=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!Nu(this._filterExtentRect,s.extent)||(this._tileMeasurements.updateTile(s),s.measures.visibility!==Bs.INVISIBLE&&(s.measures.shouldSplit?(t.ensureMaxLod(s.lij[0]+1),this._pendingTiles.push(...s.getChildren())):this._newTiles.push(s)))}this._pendingTiles.length===0&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}_updateTiles(e){for(const r of this.tiles.items)r.used=!1;const t=e.filter(r=>{const a=this._idToTile.get(r.id);return a?(a.copyMeasurementsFrom(r),a.used=!0):this._idToTile.set(r.id,r),!a}),s=this.tiles.items.filter(r=>!r.used&&(this._idToTile.delete(r.id),!0));this.tiles.removeMany(s),this.tiles.addMany(t),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,t)=>e.measures.visibility!==t.measures.visibility?e.measures.visibility===Bs.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance),this.tiles.forEach((e,t)=>e.loadPriority=t)}};c([p({constructOnly:!0})],vi.prototype,"scheduler",void 0),c([p({constructOnly:!0})],vi.prototype,"renderCoordsHelper",void 0),c([p({constructOnly:!0})],vi.prototype,"tilingSchemeOwner",void 0),c([p({constructOnly:!0})],vi.prototype,"cameraOnSurface",void 0),c([p({constructOnly:!0})],vi.prototype,"focus",void 0),c([p({constructOnly:!0})],vi.prototype,"viewState",void 0),c([p({constructOnly:!0})],vi.prototype,"terrain",void 0),c([p()],vi.prototype,"tiles",void 0),c([p()],vi.prototype,"tileSize",void 0),c([p({readOnly:!0})],vi.prototype,"tilingScheme",null),c([p()],vi.prototype,"filterExtent",null),c([p({readOnly:!0})],vi.prototype,"_filterExtentRect",null),c([p({readOnly:!0})],vi.prototype,"_rootTileIds",null),c([p({value:!1})],vi.prototype,"suspended",null),c([p({readOnly:!0})],vi.prototype,"updating",null),vi=c([F("esri.views.3d.layers.support.FeatureTileTree3D")],vi);const Jc=hi(),jD=10,WD=50;let Ot=class extends Re{constructor(){super(...arguments),this._propertiesPool=new xn({camera:Ct},this),this._lastSeenCameraProjectionValues=new Ct,this.mode=ft.ANIMATING,this._cssCamera=new Ct,this._camera=new Ct,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.events=new Pr,this.viewingMode=$e.Global,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new ma({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new xn({camera:Ct},this)}destroy(){var e;this.cameraController=null,(e=this._propertiesPool)==null||e.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===$e.Global){const e=Ut(this.spatialReference).radius;this.camera=new Ct({eye:St(4*e,0,0),center:St(e,0,0),up:St(0,0,1)})}else this.camera=new Ct({eye:St(0,0,100),center:St(0,0,0),up:St(0,1,0)})}get animation(){return this.cameraController instanceof tc&&this.cameraController.viewAnimation!=null?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:s,pixelRatio:r}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/r),e.width=Math.round(s/r),e}get camera(){return this._camera}set camera(e){e!==Fs&&Fs.copyFrom(e),Fs.computeUp(this.viewingMode),this.events.emit("before-camera-change",Fs);const t=this._camera;if(XD(this._lastSeenCameraProjectionValues,Fs)&&(this._lastSeenCameraProjectionValues.copyFrom(Fs),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(Fs)&&(this._camera=this._propertiesPool.get("camera").copyFrom(Fs),this._cameraChanged=!t.almostEquals(Fs),this._cameraChanged)){const s=AC(()=>{this._cameraChanged=!1,s.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===ft.IDLE}get updating(){return this.mode!==ft.IDLE}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){this._contentCamera=e!=null?e.clone():null}get fixedContentCamera(){return this._contentCamera!=null}get isGlobal(){return this.viewingMode===$e.Global}get isLocal(){return this.viewingMode===$e.Local}get navigating(){var e;return!!((e=this.cameraController)!=null&&e.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){var t;this.stopActiveCameraController()?((t=this.cameraController)==null||t.destroy(),e&&(this.removeHandles(Cv),this.addHandles(yl(()=>e.state===wt.Finished||e.state===wt.Stopped,()=>{this._set("cameraController",null),this.updateCamera(s=>e.onControllerEnd(s))},{sync:!0,once:!0}),Cv),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=wt.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==wt.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this._updateQueue.length===0||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Fs.copyFrom(this._get("camera")),e(Fs),this.camera=Fs,this._processingUpdates=!1,this._processUpdateQueue()}};c([p()],Ot.prototype,"mode",void 0),c([p({readOnly:!0,type:xl})],Ot.prototype,"animation",null),c([p({type:Ct})],Ot.prototype,"cssCamera",null),c([p()],Ot.prototype,"_cssCamera",void 0),c([p({type:Ct})],Ot.prototype,"camera",null),c([p()],Ot.prototype,"_camera",void 0),c([p({readOnly:!0})],Ot.prototype,"pixelRatio",null),c([p()],Ot.prototype,"rasterPixelRatio",void 0),c([p()],Ot.prototype,"contentPixelRatio",void 0),c([p({readOnly:!0})],Ot.prototype,"alignPixelEnabled",null),c([p({readOnly:!0})],Ot.prototype,"updating",null),c([p({})],Ot.prototype,"_contentCamera",void 0),c([p({type:Ct})],Ot.prototype,"contentCamera",null),c([p({readOnly:!0})],Ot.prototype,"fixedContentCamera",null),c([p({readOnly:!0})],Ot.prototype,"constraints",void 0),c([p({readOnly:!0})],Ot.prototype,"events",void 0),c([p({readOnly:!0})],Ot.prototype,"isGlobal",null),c([p({readOnly:!0})],Ot.prototype,"isLocal",null),c([p({readOnly:!0})],Ot.prototype,"viewingMode",void 0),c([p({readOnly:!0})],Ot.prototype,"spatialReference",void 0),c([p()],Ot.prototype,"navigating",null),c([p()],Ot.prototype,"stationary",null),c([p()],Ot.prototype,"_cameraChanged",void 0),c([p()],Ot.prototype,"cameraController",null),Ot=c([F("esri.views.3d.state.ViewState")],Ot);const QD=Ot;function XD(i,e){return i.fov!==e.fov||i.fullViewport[0]!==e.fullViewport[0]||i.fullViewport[1]!==e.fullViewport[1]||i.fullViewport[2]!==e.fullViewport[2]||i.fullViewport[3]!==e.fullViewport[3]||i.padding[vs.TOP]!==e.padding[vs.TOP]||i.padding[vs.RIGHT]!==e.padding[vs.RIGHT]||i.padding[vs.BOTTOM]!==e.padding[vs.BOTTOM]||i.padding[vs.LEFT]!==e.padding[vs.LEFT]}const Fs=new Ct,Cv="ViewStateHandles";let YD=class{constructor(e,t,s){this.viewingMode=e,this._forEachLayer=t,this._view=s,this._externalIntersectionHandlers=new Gt,this._tolerance=pu,this._tmpRay=El(),this._tmpRegion=hi(),this._validateHUDIntersector=Na(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,s){return this.intersectRay(this._getPickRay(e,this._tmpRay),Tv(this.viewingMode),t,s)}intersectScreenFreePointFallback(e,t,s){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,s)}intersectRayFreePointFallback(e,t,s){return this.intersectRay(e,Tv(this.viewingMode),t,s)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,s,r){return t.options.selectionMode=!1,t.options.store=co.MIN,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(s)}getCenterRayWithSubpixelOffset(e,t,s=.5,r=.5){return e.getRenderCenter(td,s,r),td[0]+=.0466,td[1]-=.0123,X1(e,td,t)}intersectIntersectorScreen(e,t,s){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,s)}intersectToolIntersectorScreen(e,t,s){const r=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(r,t,s)}intersectToolIntersectorRay(e,t,s){t.options.selectionMode=!0,this.computeIntersection(e,t,s);const r=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||y2(r)&&r.intersector!==ua.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,s))}setTolerance(e=pu){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((t,s)=>t.type===ua.TERRAIN?1:s.type===ua.TERRAIN?-1:0)}removeIntersectionHandler(e){this._externalIntersectionHandlers.removeUnordered(e)!=null&&this._externalIntersectionHandlers.sort((t,s)=>t.type===ua.TERRAIN?1:s.type===ua.TERRAIN?-1:0)}_getPickRay(e,t){const s=this._view.state.camera;return Q1(s,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==$e.Local||e==null||_e(t,e.origin,oe(Et.get(),e.direction)),!1}intersectElevationFromScreen(e,t,s=0,r=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,s,r)}_intersectElevation(e,t,s=0,r=null){if(e==null)return null;const a=this._view,{renderCoordsHelper:n}=a,o=nS(a.spatialReference),l=t!=null?t.mode:"absolute-height",h=iR(t)/o,d=(l!=="on-the-ground"?h+s:0)*o/n.unitInMeters,{camera:u}=a.state;if(l==="absolute-height"){const S=n==null?void 0:n.getAltitude(u.eye),C=ue(oe(Yl,e.direction),n.worldUpAtPosition(u.eye,JD));if(S<d&&C<0||S>=d&&C>0)return null;if(n.intersectInfiniteManifold(e,d,Yl)){const P=t0(a,Yl);return P.z??(P.z=0),P.z-=h,P}return null}const m=pf(Et.get());u.projectToRenderScreen(e.origin,m);const _=new Sv(null,this._forEachLayer),{slicePlane:f}=a,g=f!=null?Wf(f):null,y=Na(this.viewingMode);y.options.store=co.MIN,y.options.verticalOffset=d,y.options.normalRequired=!1;const w=e.origin,x=_e(Et.get(),w,e.direction);y.reset(w,x,u),y.point=m;const T=r?"type"in r&&r.type==="graphics"?S=>S.layerUid!==r.uid:S=>S.graphicUid!==r.uid:null;switch(l){case"relative-to-scene":{const S=C=>(!T||T(C))&&!!C.lastValidElevationBB;y.intersect(_.layers,m,this._tolerance,null,S),this._externalIntersectionHandlers.forAll(C=>{if(C.type===ua.I3S||C.type===ua.TERRAIN||C.type===ua.TILES3D){const P=C.slicePlaneEnabled?g:null;C.intersect(y,P,y.rayBegin,y.rayEnd,m)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(S=>{if(S.isGround){const C=S.slicePlaneEnabled?g:null;S.intersect(y,C,y.rayBegin,y.rayEnd,m)}})}if(y.results.min.getIntersectionPoint(Yl)){const S=t0(a,Yl);return S.z=s,S}return null}computeIntersection(e,t,s,r){var g;if(e==null)return;const a=this._view.state.camera,n=pf(Et.get());a.projectToRenderScreen(e.origin,n);const o=new Sv(s,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!s||!("include"in s||"exclude"in s);const l=e.origin,h=_e(Et.get(),e.origin,e.direction);t.reset(l,h,a),t.intersect(o.layers,n,this._tolerance);const d=this._view.slicePlane,u=d!=null?Wf(d):null;t.intersect(o.sliceableLayers,n,this._tolerance,u);const m=s&&(s.requiresGroundFeedback||s.enableDraped);this._externalIntersectionHandlers.forAll(y=>{const w=y.layerUid,x=Array.isArray(w),T=x?w:[w];x&&(t.options.filteredLayerUids=[]);let S=!1;for(const C of T)o.filterLayerUid(C)?S=!0:x&&t.options.filteredLayerUids.push(C);if(t.options.isFiltered=!S,y.isGround&&m||!t.options.isFiltered){const C=y.slicePlaneEnabled?u:null;y.intersect(t,C,l,h,n,r)}});const _=Et.get(),f=this._view.basemapTerrain;if(s&&s.enableDraped&&f.spatialReference!=null&&t.results.ground.getIntersectionPoint(_)){const y=f.overlayManager.renderer,w=this._view.renderCoordsHelper.spatialReference,x=Et.get();this._view.renderCoordsHelper.fromRenderCoords(_,x,f.spatialReference),x[2]=((g=this._view.elevationProvider)==null?void 0:g.getElevation(_[0],_[1],_[2],w,"ground"))??0,y.intersect(t,x,t.results.ground,T=>o.filterRenderGeometry(T))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;Tm(this._tmpRegion,fT);const s=this._view.state.camera,r=[],a=this._tmpRegion,n=w=>{const x=new KD(w);s.projectToRenderScreen(w.target.center,x.screenPoint),x.screenPoint[0]=Math.floor(x.screenPoint[0]),x.screenPoint[1]=Math.floor(x.screenPoint[1]),r.push(x),e1(a,x.screenPoint)};e.sortResults(t.all),t.min.dist!=null&&n(t.min);for(const w of t.all)t.min.target.object!==w.target.object&&t.max.target.object!==w.target.object&&n(w);if(t.max.dist!=null&&t.max.target.object!==t.min.target.object&&n(t.max),!r.length)return;a[0]===a[2]&&(a[2]+=1),a[1]===a[3]&&(a[3]+=1);const o=s.fullWidth,l=s.fullHeight,h=Math.max(0,a[0]-uh),d=Math.max(0,a[1]-uh),u=Math.min(Kn(a)+2*uh,o-h),m=Math.min(Bh(a)+2*uh,l-d);if(u<=0||m<=0)return;const _=new Uint8Array(u*m*4);this._view._stage.renderer.readHUDVisibility(h,d,u,m,_);let f=!0;const g=e.results.max.dist==null;let y=0;for(const w of r)for(const x of ZD){const T=4*(Math.min(w.screenPoint[0]+x[0],o)-a[0]+(Math.min(w.screenPoint[1]+x[1],l)-a[1])*u);if(!(T<0||T>=_.length)&&_[T]){f&&(e.results.min.copy(w.result),f=!1),g&&e.results.max.copy(w.result),e.options.store===co.ALL&&e.results.all.splice(y++,0,w.result);break}}}};const uh=1,ZD=(()=>{const i=[],e=uh;for(let t=-e;t<=e;t++)for(let s=-e;s<=e;s++)i.push([s+e,t+e]);return i})();let KD=class{constructor(e){this.result=e,this.screenPoint=dc()}},ed;function Tv(i){return ed&&ed.viewingMode===i||(ed=Na(i)),ed}let Sv=class{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e==null?void 0:e.include,this.exclude=e==null?void 0:e.exclude,t(s=>{s.pickable&&this.filterLayerUid(s.apiLayerUid)&&(s.sliceable?this.sliceableLayers:this.layers).push(s)})}filterLayerUid(e){const{include:t,exclude:s}=this;return e==null?t==null&&s==null:(t==null||t.has(e))&&(s==null||!s.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}};function Pv(i){return typeof i=="object"&&"intersect"in i}const Yl=b(),JD=b(),td=dc();let ph=class extends Pr.EventedMixin(Re){get spatialReference(){var e,t;return(t=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:t.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=Y(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,s,r,a){if(this._cacheEnabled&&this.lastElevationQuery!=null){const o=this.lastElevationQuery;if(e===o.x&&t===o.y&&s===o.z&&Pf(r,o.spatialReference)&&a===o.queryContext)return o.result}let n=null;return n=id(n,this._im,e,t,s,r,a),n==null&&(n=id(n,this._ground,e,t,s,r,a)),a==="scene"&&(n=id(n,this._scene,e,t,s,r,a)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:s,spatialReference:r,queryContext:a,result:n}),n}getSphereElevationBounds(e,t,s){const r=new gu;function a(n){for(const o of n)if(o.getSphereElevationBounds){const l=o.getSphereElevationBounds(e,t,s);l!=null&&r.expandElevationRangeValues(l.elevationRangeMin,l.elevationRangeMax)}}return a(this._ground),a(this._im),s==="scene"&&a(this._scene),r}getRootElevationBounds(){const e=new gu;for(const t of[this._im,this._ground,this._scene])t.forEach(s=>{if(s.getRootElevationBounds){const r=s.getRootElevationBounds();r!=null&&e.expandElevationRangeValues(r.elevationRangeMin,r.elevationRangeMax)}});return e}async queryElevation(e,t,s,r,a,n=null,o=0){const l=this._getElevationQuery(r);try{const h=await l.queryElevation(e,t,n,o);return a==="scene"?id(h,this._scene,e,t,s,r,a):h}catch(h){return DC(h),this.getElevation(e,t,s,r,a)}}register(e,t){this.addHandles(t.on("elevation-change",s=>this.emit("elevation-change",s)),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const s=t.indexOf(e);s>-1&&t.splice(s,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(t!=null&&Pf(e,t.spatialReference))return t;t==null||t.destroy({completeTasks:!0});const{wkid:s,wkt:r,wkt2:a,latestWkid:n}=e,o=new uT(this.view.resourceController.scheduler,new pi({wkid:s,wkt:r,wkt2:a,latestWkid:n}),()=>{var l;return(l=this.view.map)==null?void 0:l.ground},{maximumAutoTileRequests:4});return this._cachedQuery=o,o}};function id(i,e,t,s,r,a,n){for(const o of e){const l=o.getElevation(t,s,r,a,n);l!=null&&(i=i!=null?Math.max(l,i):l)}return i}c([p({constructOnly:!0})],ph.prototype,"view",void 0),c([p()],ph.prototype,"spatialReference",null),ph=c([F("esri.views.3d.support.CombinedElevationProvider")],ph);let nc=class u_{static isValidProfile(e){return e in u_.profiles}static getDefaultProfile(){return li("esri-iPhone")?"low":"medium"}static apply(e,t){const s=u_.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=s.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=s.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=s.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=s.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=s.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=s.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=s.graphics3D.skipHighSymbolLods,t.graphics3D.uncompressedTextureDownsamplingEnabled=s.graphics3D.uncompressedTextureDownsamplingEnabled;const r=t.sceneService.object,a=s.sceneService.object;r.lodFactor=a.lodFactor,t.sceneService.point.lodFactor=s.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=s.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=s.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=s.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=s.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=s.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=s.tiledSurface.vtlContentZoom,t.tiledSurface.elevationLevelDelta=s.tiledSurface.elevationLevelDelta,t.tiledSurface.reduceTileLevelDifferences=s.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=s.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=s.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=s.fadeDuration,t.antialiasingEnabled=s.antialiasingEnabled,t.physicallyBasedRenderingEnabled=s.physicalBasedRenderingEnabled,t.highQualityTransparency=s.highQualityTransparency,t.highResolutionAtmosphere=s.highResolutionAtmosphere,t.reflections=s.reflections,t.ambientOcclusion=s.ambientOcclusion,t.memoryLimit=s.memoryLimit,t.additionalCacheMemory=s.additionalCacheMemory,t.frameRate=s.frameRate,t.maximumPixelRatio=s.maximumPixelRatio}};nc.test={reset(){const i=lw();for(const e of Object.keys(i))nc.profiles[e]=i[e]}};const Zl={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430};function lw(){const i=!!li("esri-mobile"),e=!!li("ios"),t=ct(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0,uncompressedTextureDownsamplingEnabled:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:ct(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:200+Zl.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:i?.8:1,polylineLodFactor:i?1.2:1.5,snapshotAvailable:!e,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:i},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:i},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!li("disable-feature:reduce-map-tile-levels")},fadeDuration:t,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:i?600+Zl.GalaxyS20:750+Zl.FullHD,additionalCacheMemory:i?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:i?1.2:2,polylineLodFactor:i?1.2:2,snapshotAvailable:!e,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!li("disable-feature:reduce-map-tile-levels")},fadeDuration:t,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,memoryLimit:i?900+Zl.SurfacePro7:1500+Zl.FullHDRetina,additionalCacheMemory:i?-150:0,frameRate:0,maximumPixelRatio:i?1:1/0}}}(function(i){i.profiles=lw()})(nc||(nc={}));const Ad=nc,hw=new uo([0,255,255]),cw=1,dw=.25,uw=new uo([0,0,0]),pw=.4,mw=.2;let Lr=class extends Re{constructor(){super(...arguments),this.color=hw.clone(),this.haloColor=null,this.haloOpacity=cw,this.fillOpacity=dw,this.shadowOpacity=pw,this.shadowColor=uw.clone(),this.shadowDifference=mw}};c([p({type:uo})],Lr.prototype,"color",void 0),c([p({type:uo})],Lr.prototype,"haloColor",void 0),c([p()],Lr.prototype,"haloOpacity",void 0),c([p()],Lr.prototype,"fillOpacity",void 0),c([p()],Lr.prototype,"shadowOpacity",void 0),c([p({type:uo})],Lr.prototype,"shadowColor",void 0),c([p()],Lr.prototype,"shadowDifference",void 0),Lr=c([F("esri.views.3d.support.HighlightOptions")],Lr);const _w=Lr;let e$=class{constructor(e,t){this.spatialReference=t,this.unitInMeters=c1(this.spatialReference,Ut(this.spatialReference).metersPerDegree);const s=e&&"portalItem"in e?e.portalItem:void 0;this._geometryServiceURLPromise=nR(s).catch(()=>{throw new xs("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")})}async toGeographic(e){const t=await this._geometryServiceURLPromise;let s,r=!0;Array.isArray(e[0])&&typeof e[0]!="number"?s=e:(s=[e],r=!1);const a=s.map(l=>l instanceof ea?l:new ea(l,this.spatialReference)),n=new oR({geometries:a,outSpatialReference:pi.WGS84}),o=(await lR(t,n)).map(l=>l.type==="point"?[l.x,l.y]:void 0).filter(l=>!!l);return r?o:o[0]}};var we;(function(i){i[i.ELEVATION=0]="ELEVATION",i[i.MAP=1]="MAP"})(we||(we={}));const Xn=[we.ELEVATION,we.MAP];async function t$(i,e){var m,_,f,g,y;const{results:t,ground:s}=await hR(i,e),r=(!s.layer||!Rm(s.layer.type))&&s.mapPoint,a=[],n=r$(i),o=r?i$(i,n):s$;let l=0,h=0;const d=()=>{const w=o.layerViews[h];r&&w&&"fetchPopupFeaturesAtLocation"in w&&a.push({mapPoint:s.mapPoint,layerView:w}),++h};let u=null;for(;l<t.length||h<o.layerViews.length;){const w=t[l];if(w&&w.type!=="graphic")++l;else if(((m=w==null?void 0:w.layer)==null?void 0:m.type)!=="scene"||((_=w==null?void 0:w.layer)==null?void 0:_.parent)!==((f=i==null?void 0:i.map)==null?void 0:f.basemap))if(w){const x=(g=w.layer)==null?void 0:g.uid,T=o.layerUids.has(x)&&w.distance===s.distance,S=n.get((y=w.layer)==null?void 0:y.uid);if(u??(u=w.mapPoint),h<o.layerViews.length&&(T||(w.distance??0)>s.distance)&&o.layerViews[h]!==S){d();continue}a.push({graphic:w.graphic,layerView:S}),++l}else d();else++l}return u??(u=s.mapPoint),{hits:a,location:u}}function i$(i,e){const t=new Set,s=[];for(let a=i.basemapTerrain.numLayers(we.MAP)-1;a>=0;a--){const n=i.basemapTerrain.layerViewByIndex(a,we.MAP);t.add(n.layer.uid),s.push(n)}const r=i.basemapTerrain.overlayManager.renderer.layers;for(const{uid:a}of r){const n=e.get(a);n&&(t.add(a),s.push(n))}return s.reverse(),{layerUids:t,layerViews:s}}const s$={layerUids:new Set,layerViews:[]};function r$(i){const e=new Map;for(const t of i.allLayerViews){const s=t.layer.uid;e.set(s,t)}return e}let As=class extends Re{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1,this.uncompressedTextureDownsamplingEnabled=!1}};c([p()],As.prototype,"minTotalNumberOfFeatures",void 0),c([p()],As.prototype,"maxTotalNumberOfFeatures",void 0),c([p()],As.prototype,"maxNumberOfDrawCalls",void 0),c([p()],As.prototype,"maxTotalNumberOfVertices",void 0),c([p()],As.prototype,"snapshotAvailable",void 0),c([p()],As.prototype,"polygonLodFactor",void 0),c([p()],As.prototype,"polylineLodFactor",void 0),c([p()],As.prototype,"skipHighSymbolLods",void 0),c([p()],As.prototype,"uncompressedTextureDownsamplingEnabled",void 0),As=c([F("esri.views.3d.support.QualitySettings.Graphics3DSettings")],As);let wr=class extends Re{constructor(){super(...arguments),this.lodFactor=1}};c([p()],wr.prototype,"lodFactor",void 0),wr=c([F("esri.views.3d.support.QualitySettings.LoDFactorSettings")],wr);let ya=class extends Re{constructor(){super(...arguments),this.object=new wr,this.point=new wr,this.integratedMesh=new wr,this.pointCloud=new wr,this.uncompressedTextureDownsamplingEnabled=!1}};c([p({type:wr})],ya.prototype,"object",void 0),c([p({type:wr})],ya.prototype,"point",void 0),c([p({type:wr})],ya.prototype,"integratedMesh",void 0),c([p({type:wr})],ya.prototype,"pointCloud",void 0),c([p()],ya.prototype,"uncompressedTextureDownsamplingEnabled",void 0),ya=c([F("esri.views.3d.support.QualitySettings.SceneServiceSettings")],ya);let ba=class extends Re{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};c([p()],ba.prototype,"lodBias",void 0),c([p()],ba.prototype,"angledSplitBias",void 0),c([p()],ba.prototype,"vtlContentZoom",void 0),c([p()],ba.prototype,"elevationLevelDelta",void 0),c([p()],ba.prototype,"reduceTileLevelDifferences",void 0),ba=c([F("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],ba);let ll=class extends Re{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};c([p()],ll.prototype,"pixelRatio",void 0),c([p()],ll.prototype,"maxTotalNumberOfFeatures",void 0),ll=c([F("esri.views.3d.support.QualitySettings.HeatmapSettings")],ll);let Si=class extends Re{constructor(){super(...arguments),this.graphics3D=new As,this.sceneService=new ya,this.tiledSurface=new ba,this.heatmap=new ll,this.fadeDuration=ct(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};c([p({type:As})],Si.prototype,"graphics3D",void 0),c([p({type:ya})],Si.prototype,"sceneService",void 0),c([p({type:ba})],Si.prototype,"tiledSurface",void 0),c([p({type:ll})],Si.prototype,"heatmap",void 0),c([p()],Si.prototype,"fadeDuration",void 0),c([p()],Si.prototype,"antialiasingEnabled",void 0),c([p()],Si.prototype,"physicallyBasedRenderingEnabled",void 0),c([p()],Si.prototype,"highQualityTransparency",void 0),c([p()],Si.prototype,"highResolutionAtmosphere",void 0),c([p()],Si.prototype,"reflections",void 0),c([p()],Si.prototype,"ambientOcclusion",void 0),c([p()],Si.prototype,"memoryLimit",void 0),c([p()],Si.prototype,"additionalCacheMemory",void 0),c([p()],Si.prototype,"frameRate",void 0),c([p()],Si.prototype,"maximumPixelRatio",void 0),Si=c([F("esri.views.3d.support.QualitySettings")],Si);const Rv=Si;var Gr;(function(i){i[i.ELEVATION=0]="ELEVATION",i[i.BASEMAP=1]="BASEMAP",i[i.I3S_INDEX=2]="I3S_INDEX",i[i.I3S_DATA=3]="I3S_DATA",i[i.SYMBOLOGY=4]="SYMBOLOGY"})(Gr||(Gr={}));const a$=(()=>{const i=new Array;return i[Gr.ELEVATION]=10,i[Gr.BASEMAP]=10,i[Gr.I3S_INDEX]=10,i[Gr.I3S_DATA]=10,i[Gr.SYMBOLOGY]=5,i})(),n$=30;function o$(i){return"usedMemory"in i&&"unloadedMemory"in i&&"ignoresMemoryFactor"in i}function l$(i){return new ki({view:i})}const Ov=.1,sd=1,kp=1,h$=.75,c$=.6,Mv=1.3;let ki=class extends Re{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new cR,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles(Iu({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){e==null||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(sd),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){e!=null&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t){return new dR(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();this._memoryPredicted<c$&&this._canFastRecover?(this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(sd)):e?(this._memoryPredicted>1.1*kp||this._usedMemory>kp)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>Ov&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/Mv),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1)):(this._downscaleMemoryUsed=0,this._usedMemory>kp?(this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/Mv),this._downscaleMemoryUsed=this._memoryPredicted):this._stableQuality!==this._quality&&(this._usedMemory<h$&&this._quality<sd?(this._stableQuality=this._quality,e=this._updateQuality(this._quality+.05)):this._quality<1&&(this._canFastRecover=!0))),this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,Ov),sd))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){var o,l,h,d,u;if(!this.view)return;(l=(o=this.view._stage)==null?void 0:o.renderer)==null||l.tick();const e=(d=(h=this.view._stage)==null?void 0:h.renderer)==null?void 0:d.usedMemory;let t=(((u=this.view.basemapTerrain)==null?void 0:u.usedMemory)??0)+(e?e.fbos+e.edges+e.plugins:0),s=0;this.view.allLayerViews&&this.view.allLayerViews.forEach(m=>{if(o$(m)){const _=m.ignoresMemoryFactor?this._quality:1;t+=m.usedMemory*_,s+=m.unloadedMemory*_}});const r=this._warnMemoryUsage==null||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),a=1048576*this.maxMemory;if(t>a&&r){this._warnMemoryUsage=t;const m=f=>(f/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",_=Math.round(100*this._quality);Pe.getLogger(this).warn(`Memory Limit exceeded! Limit: ${m(a)} Current: ${m(t)} Projected: ${m(t+s)} Quality: ${_}%`)}this._usedMemory=t/a,this._memoryPredicted=(t+s)/a;const n=a-t;this._cacheStorage.maxSize=Math.max(0,n+1048576*this.additionalCacheMemory)}get test(){}};c([p({constructOnly:!0})],ki.prototype,"view",void 0),c([p()],ki.prototype,"maxMemory",null),c([p()],ki.prototype,"additionalCacheMemory",null),c([p({readOnly:!0})],ki.prototype,"memoryFactor",null),c([p({readOnly:!0})],ki.prototype,"updating",null),c([p({readOnly:!0})],ki.prototype,"usedMemory",null),c([p({readOnly:!0})],ki.prototype,"usedCacheMemory",null),c([p()],ki.prototype,"_quality",void 0),c([p()],ki.prototype,"_usedMemory",void 0),c([p()],ki.prototype,"_updating",void 0),c([p()],ki.prototype,"_stableQuality",void 0),c([p()],ki.prototype,"_maxMemory",void 0),c([p()],ki.prototype,"_additionalCacheMemory",void 0),ki=c([F("esri.views.3d.support.MemoryController")],ki);let d$=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},u$=class{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new p$}},p$=class{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}},m$=class{constructor(e,t,s,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=s,this._totalNumWorkers=0,this._clients=r.map(a=>new u$(a))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(s,r)=>this._taskCallback(s,r))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,Cs(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(t,s)=>this._taskCallback(t,s)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){}},_$=class{constructor(e,t){this.element=e,this.type="image+type",this.isOpaque=t==="image/jpeg"}},Dd=class extends Re{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,s){this._loadQueue=new m$((r,a)=>this._startLoading(r,a),(r,a)=>this._doneLoadingCB(r,a),e,t),s&&(this._frameTask=s.registerTask(ci.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=Zr(this._frameTask),this._tasks.forEach(e=>Pn(e.abortController)),this._loadQueue=Y(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,s,r={}){const a=R_();a.__signal=r!=null?r.signal:null;const n=this._createOrUpdateTask(e,t,s,r,a);return O_(r,()=>this._cancelRequest(n,a)),a.promise}_createTask(e,t,s,r,a,n){const o=new v$(e,t,s,r,a);return this._updateTask(o,n),this._tasks.set(a,o),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){var s;zy(e.resolvers,t),t.reject(vr()),e.resolvers.length===0&&(e.status===qs.DOWNLOADING&&(e.status=qs.CANCELLED,this._loadQueue.cancel(e),(s=e.abortController)==null||s.abort(),e.request=null,e.abortController=null),e.status=qs.CANCELLED,this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,s,r,a){const n=y$((r==null?void 0:r.uid)||e,t,s),o=this._tasks.get(n);return o?(this._updateTask(o,a),o):this._createTask(e,r,t,s,n,a)}_doneLoadingCB(e,t){this._loadQueue&&(Cs(e.status===qs.DOWNLOADING),e.status=qs.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();Qi(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==qs.DOWNLOADED&&(t.err=t.err||vr()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!mn(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let s=L_(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)mn(t)?r.reject(t):r.reject(new xs("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--s;const a=s>0?xm(e.result):e.result;r.resolve(a)}this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,t){if(e.status===qs.CANCELLED)return!1;let s,r;switch(e.startTime=performance.now(),e.status=qs.DOWNLOADING,e.docType){case"binary":r="array-buffer",s=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const a=e.abortController.signal;e.request=mp(e.url,{...e.options,responseType:r,timeout:s,signal:a});const n=l=>{e.duration=performance.now()-e.startTime,e.size=l instanceof ArrayBuffer?l.byteLength:e.size||0,e.result=l,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},o=l=>{e.status===qs.DOWNLOADING&&t(e,l)};return e.docType!=="image+type"?(e.request.then(l=>n(l.data),o),!0):(e.request.then(l=>{const h=l.data,d=f$(h);if(r="image",e.size=h.byteLength,d==="unknown")return e.request=mp(e.url,{responseType:r,timeout:s,signal:a}),void e.request.then(_=>n(_.data),o);const u=new Blob([h],{type:d}),m=window.URL.createObjectURL(u);e.request=mp(m,{responseType:r,timeout:s,signal:a}),e.request.then(_=>n(new _$(_.data,d)),o).finally(()=>window.URL.revokeObjectURL(m))},o),!0)}get test(){}};c([p({readOnly:!0})],Dd.prototype,"updating",void 0),Dd=c([F("esri.views.3d.support.StreamDataLoader")],Dd);const g$={numRetries:0};function f$(i){if(i.byteLength<2)return"unknown";const e=new Uint8Array(i,0,i.byteLength);return e[0]===137&&e[1]===80?"image/png":e[0]===71&&e[1]===73?"image/gif":e[0]===66&&e[1]===77?"image/bmp":e[0]===255&&e[1]===216?"image/jpeg":"unknown"}let v$=class extends d${constructor(e,t,s,r,a){super(r),this.url=e,this.options=t,this.docType=s,this.key=a,this.result=null,this.status=qs.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=g$.numRetries}};function y$(i,e,t){return`${i}:${e}:${t}`}var qs;(function(i){i[i.QUEUED=1]="QUEUED",i[i.DOWNLOADING=2]="DOWNLOADING",i[i.DOWNLOADED=3]="DOWNLOADED",i[i.CANCELLED=4]="CANCELLED"})(qs||(qs={}));let $d=class extends Re{constructor(){super(...arguments),this.updating=!1}};function b$(i){return new or({view:i})}c([p({readOnly:!0})],$d.prototype,"updating",void 0),$d=c([F("esri.views.3d.support.ResourceController.ResourceControllerMain")],$d);let or=class extends $d{constructor(){super(...arguments),this._immediateTask=uu,this._normalTask=uu,this._updatingObjects=Sh([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=l2(),this._memoryController=l$(this.view),this._streamDataLoader=new Dd,this._streamDataLoader.setup(n$,a$,this._scheduler),this.addHandles([M(()=>{var e;return(e=this.view.state)==null?void 0:e.mode},e=>{e!=null&&(this._scheduler.state=e)},nt),M(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=Iu({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(ci.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(ci.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=Zr(this._frameTask),this._streamDataLoader=Y(this._streamDataLoader),this._memoryController=Y(this._memoryController),this._scheduler=Y(this._scheduler),this.view=null}get updating(){var e,t,s,r;return!!((e=this._memoryController)!=null&&e.updating||(t=this._streamDataLoader)!=null&&t.updating||(s=this._immediateTask)!=null&&s.updating)||((r=this._updatingObjects)==null?void 0:r.value.some(a=>a.updating))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(s,r,a)=>t.request(s,r,e,a),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],on(()=>{t.value=t.value.filter(s=>s!==e)})}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(Hy(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.updateBudget(e)&&this._scheduler.frame())}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};c([p()],or.prototype,"view",void 0),c([p()],or.prototype,"_scheduler",void 0),c([p()],or.prototype,"_memoryController",void 0),c([p()],or.prototype,"_streamDataLoader",void 0),c([p()],or.prototype,"_immediateTask",void 0),c([p()],or.prototype,"_normalTask",void 0),c([p()],or.prototype,"_updatingObjects",void 0),c([p({readOnly:!0})],or.prototype,"updating",null),or=c([F("esri.views.3d.support.ResourceController")],or);let w$=class{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}},x$=class{constructor(e){var t,s,r,a;if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,e.resourceController!=null){const n=e.resourceController.memoryController;this.totalMemory=(n.maxMemory??0)*uR.MEGABYTES,this.usedMemory=Math.round(n.usedMemory*this.totalMemory),this.quality=e.quality,this.load=e.resourceController.scheduler.load,this.cachedMemory=n.usedCacheMemory}this.terrainMemory=((t=e.basemapTerrain)==null?void 0:t.usedMemory)??0,this.edgesMemory=((s=e._stage)==null?void 0:s.renderer.usedMemory.edges)??0,this.fboMemory=((r=e._stage)==null?void 0:r.renderer.usedMemory.fbos)??0,(a=e.allLayerViews)==null||a.items.forEach(n=>{pT(n)&&this.layerPerformanceInfos.push(new w$(n))}),this.layerPerformanceInfos.sort((n,o)=>o.memory-n.memory)}},C$=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",()=>{}),this._wosrMemCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,s){const r=s?`gltfPBR:${e}`:`gltf:${e}`,a=this._gltfMemCache.get(r);return a!=null?Promise.resolve(a):Ev(this._gltfLoading,this._gltfMemCache,r,n=>mR(new _R(n.streamDataRequester),e,n,s),t)}loadWOSR(e,t){const s=`wosr:${e}:${t.disableTextures}`,r=this._wosrMemCache.get(s);return r!=null?Promise.resolve(r):Ev(this._wosrLoading,this._wosrMemCache,s,a=>gR(e,a),t)}};async function Ev(i,e,t,s,r){Qi(r);const a=O_(r,()=>T$(i,t));let n=i.get(t);if(n)n.refCount++;else{const o=new AbortController;n={refCount:1,abortController:o,promise:s({...r,signal:o.signal})},i.set(t,n)}try{const o=await n.promise;return e.put(t,o,o.size),i.delete(t),Qi(r),o}finally{Zr(a)}}function T$(i,e){const t=i.get(e);t!=null&&--t.refCount>0||(i.delete(e),t!=null&&t.abortController.abort())}let hl=class extends Re{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=(t==null?void 0:t.registerTask(ci.TEXTURE_UNLOAD))??uu}normalizeCtorArgs(){return{}}destroy(){var e,t,s;super.destroy(),(e=this._frameTask)==null||e.remove(),(t=this._textureRequests)==null||t.forEach(r=>this._releaseTextureRequest(r)),(s=this._textureRequests)==null||s.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const s=this.makeUid(e);let r=this._textureRequests.get(s);if(!r){const a=new fw;a.texture=t(),this._stage&&(a.texture.load(this._stage.renderView.renderingContext),this._stage.add(a.texture)),this._textureRequests.set(s,a),r=a}return r.referenceCount++,new gw(s,r.texture,()=>this._release(s))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){}_releaseNow(e){var s;if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||((s=t.texture)==null||s.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){var t;e.texture?(t=this._stage)==null||t.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return t!=null?`${e}.${t}px`:e}};c([p()],hl.prototype,"_frameTask",void 0),c([p()],hl.prototype,"updating",null),hl=c([F("esri.views.3d.support.TextureCollection")],hl);let gw=class{constructor(e,t,s){this.uid=e,this.texture=t,this.release=s}},fw=class{constructor(){this.referenceCount=0}},S$=class extends hl{constructor(e,t,s){super(t,s),this._streamDataRequester=e}async fromUrl(e,t,s){Qi(s);const r=s==null?void 0:s.signal,a=this.makeUid(e,t);let n=this._textureRequests.get(a);if(!n){const o=new AbortController,l=this._streamDataRequester.request(e,"image",{uid:a,signal:o.signal});n=new fw,n.abortController=o;const h=n;this._textureRequests.set(a,n),n.textureAsync=l.then(async d=>{const u=this._createTexture(e,d,t);return h.texture=u,h.abortController=null,await u.load(this._stage.renderView.renderingContext),this._stage.add(u),new gw(a,u,()=>this._release(a))},d=>{throw h.abortController=null,d})}n.referenceCount++;try{return await $C(n.textureAsync,r)}catch(o){throw this._release(a),o}}_createTexture(e,t,s){var a;const r={width:t.width,height:t.height,wrap:{s:Ki.CLAMP_TO_EDGE,t:Ki.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if(B1(e)){if(s||t.width===0&&t.height===0){const n=t.width?t.height/t.width:1;s=s||64,n>1?(t.width=Math.round(s/n),t.height=s):(t.width=s,t.height=Math.round(s*n))}(a=this._stage.renderView)!=null&&a.renderingContext.driverTest.svgPremultipliesAlpha.result&&(r.preMultiplyAlpha=!1)}return new kS(t,r)}},P$=class{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(Gr.SYMBOLOGY),this.objectResourceCache=new C$((s,r)=>e.resourceController.memoryController.newCache(s,r)),this.textures=new S$(this.streamDataRequester,e.view._stage,e.resourceController.scheduler);const t=Ut(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=P1(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=gP(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return on();this._graphicsOwners.push(e);const t=M(()=>{var s;return(s=e.layer)==null?void 0:s.screenSizePerspectiveEnabled},()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),on(()=>{t.remove(),zy(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some(t=>{var s;return((s=t.layer)==null?void 0:s.screenSizePerspectiveEnabled)===!0});if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new $u;const t=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([M(()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance,t,nt),this._viewState.events.on("camera-projection-changed",t)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=Y(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;rd.distance=e.centerOnSurfaceInfrequent.distance,rd.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(rd),this.screenSizePerspectiveSettingsLabels.update(rd),this._view._stage.renderView.requestRender()}get test(){}};const rd={distance:0,fovY:0};let el=class{constructor(e,t,s=""){this.graphics=e,this._symbol=new H2({symbolLayers:new Qr([new G2({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new k2({text:s,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(t==null)return;this.hide();const s=new ea({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new MR({geometry:s,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){this._graphic!=null&&(this.graphics.remove(this._graphic),this._graphic=null)}},sn=class extends Re{constructor(e){super(e)}};c([p({constructOnly:!0})],sn.prototype,"renderCoordsHelper",void 0),c([p({constructOnly:!0})],sn.prototype,"surface",void 0),c([p({constructOnly:!0})],sn.prototype,"state",void 0),sn=c([F("esri.views.3d.support.pointsOfInterest.PointOfInterest")],sn);const R$=Array;let lr=class extends sn{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new xn({location:ea,renderLocation:R$},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=b(),this._tmpPoint=new ea}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles(Ma(()=>{var t,s;return(s=(t=this.map)==null?void 0:t.ground)==null?void 0:s.layers},"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=Y(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=os(e.eye,this.renderLocation),s={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return o1(s,t,0)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){var r;if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!((r=this.map)!=null&&r.ground))return this._updateSurfaceAltitude(0),Zi;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>O$&&this.renderCoordsHelper.viewingMode===$e.Global&&(e.isWGS84||e.isWebMercator);let s=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:s.signal,cache:this.cache,minDemResolution:t?M$:0}).then(a=>this._updateSurfaceAltitude(a.geometry.z??0)).catch(a=>{mn(a)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===s&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),s=null}),this._pendingElevationQueryController=s,Zi}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(jp,this._estimatedSurfaceAltitude,this._camera.eye),E_(this._get("renderLocation"),jp)||(this._set("renderLocation",le(this._propertiesPool.get("renderLocation"),jp)),this.notifyChange("renderLocation"))}};c([p({constructOnly:!0})],lr.prototype,"scheduler",void 0),c([p({constructOnly:!0})],lr.prototype,"cache",void 0),c([p({constructOnly:!0})],lr.prototype,"task",void 0),c([p()],lr.prototype,"location",null),c([p({constructOnly:!0})],lr.prototype,"map",void 0),c([p()],lr.prototype,"renderLocation",void 0),c([p()],lr.prototype,"scale",null),c([p()],lr.prototype,"updating",null),lr=c([F("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],lr);const jp=b(),O$=1e5,M$=1e6,E$=Array;let zs=class extends sn{constructor(e){super(e),this._propertiesPool=new xn({location:ea,renderLocation:E$},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=b(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=Zr(this._frameWorker),this._propertiesPool=Y(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Zi}_updateRenderLocation(){const e=D$;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const s=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&s&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=$$;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(le(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=os(this._camera.eye,e):(ee(e,this._camera.viewForward,this._get("distance")),_e(e,e,this._camera.eye)),E_(this._get("renderLocation"),e)||this._set("renderLocation",le(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){var r,a;const s=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(s.ray,e,t))return!1;if(this.state.isGlobal){const n=Ut(this.renderCoordsHelper.spatialReference).radius,o=n+e,l=gr(s.eye),h=l<o*o,d=os(s.eye,t);if(h&&d>n/4){const u=o-Math.sqrt(l);return ee(t,s.viewForward,u),_e(t,t,s.eye),!0}}else{const n=(r=this.surface)!=null&&r.ready?this.surface.extent:null;n!=null&&Yy(n,(a=this.surface)==null?void 0:a.spatialReference,Kl,this.renderCoordsHelper.spatialReference)&&(t[0]=Z(t[0],Kl[0],Kl[2]),t[1]=Z(t[1],Kl[1],Kl[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(Ts.TESTS_DISABLE_OPTIMIZATIONS)return!0;const s=this._camera.eye,r=os(s,e),a=os(s,t);if(Math.abs(a-r)/r>A$)return!0}return!1}};c([p({constructOnly:!0})],zs.prototype,"scheduler",void 0),c([p({constructOnly:!0})],zs.prototype,"task",void 0),c([p()],zs.prototype,"distance",void 0),c([p({constructOnly:!0})],zs.prototype,"estimateSurfaceAltitudeAtCenter",void 0),c([p({readOnly:!0})],zs.prototype,"location",null),c([p({readOnly:!0})],zs.prototype,"renderLocation",void 0),c([p()],zs.prototype,"updating",void 0),zs=c([F("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],zs);const A$=.05,D$=b(),$$=b(),Kl=hi();let I$=class{constructor(e){this._handles=new $u,this.events=new Pr,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",t=>this._layerViewsChanged(t))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=Y(this._handles),this._contentLayerViews.destroy()}_layerViewsChanged(e){e.added.forEach(t=>{t.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this._handles.add(t.on("visible-geometry-changed",()=>this._contentChanged()),t.uid)}),e.removed.forEach(t=>this._handles.remove(t.uid))}_contentChanged(){this.events.emit("request-update",L$)}};const L$={},N$=Array;let hr=class extends sn{constructor(e){super(e),this._propertiesPool=new xn({location:ea,renderLocation:N$},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([M(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),M(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.addHandles(this.scheduler.registerTask(ci.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=Y(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,s=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,s.worldUpAtPosition(t,Av);const a=Math.max(0,(Math.acos(ue(Av,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(a)){if(!e||!Uh(e,t)){const h=this._propertiesPool.get("renderLocation");le(h,t),this._set("renderLocation",h)}return Zi}const n=1-Z(a/(.5*Math.PI),0,1),o=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(Dv);const l=this._propertiesPool.get("renderLocation");return Tr(l,t,Dv,o),e&&Uh(e,l)||this._set("renderLocation",l),Zi}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,s=t.getRenderCenter(dc());if(s[1]=t.aboveGround?t.padding[vs.BOTTOM]:t.fullHeight-t.padding[vs.TOP],this.estimateSurfaceIntersectionAtRenderPoint(s,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(s,Jl)){be(Jl,Jl,t.eye);const a=oe(Jl,Jl);if(this.renderCoordsHelper.intersectInfiniteManifold(vo(t.eye,a),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};c([p()],hr.prototype,"_dirty",void 0),c([p({constructOnly:!0})],hr.prototype,"scheduler",void 0),c([p({constructOnly:!0})],hr.prototype,"centerOnSurface",void 0),c([p({constructOnly:!0})],hr.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),c([p()],hr.prototype,"updating",null),c([p()],hr.prototype,"location",null),c([p()],hr.prototype,"renderLocation",void 0),c([p()],hr.prototype,"worldUnitsPerContentPixel",null),hr=c([F("esri.views.3d.support.pointsOfInterest.Focus")],hr);const Av=b(),Jl=b(),Dv=b();let _a=class extends Re{get surface(){var e;return(e=this.view.map)==null?void 0:e.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=b();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([M(()=>{var e,t;return[(e=this.surfaceView)==null?void 0:e.spatialReference,(t=this.surfaceView)==null?void 0:t.extent]},()=>this._update()),Ma(()=>{var e;return(e=this.surface)==null?void 0:e.layers},"change",()=>this._update())]),this._update())}_update(){var s;if(this._updateController&&(this._updateController.abort(),this._updateController=null),((s=this.surfaceView)==null?void 0:s.extent)==null||this.surfaceView.spatialReference==null)return void this._set("location",null);const e=t1(this.surfaceView.extent),t=new ea({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(r=>{this._updateController=null,this._set("location",r.geometry)}).catch(r=>{})):this._set("location",t)}};c([p({constructOnly:!0})],_a.prototype,"view",void 0),c([p({constructOnly:!0})],_a.prototype,"cache",void 0),c([p()],_a.prototype,"surface",null),c([p()],_a.prototype,"surfaceView",null),c([p({readOnly:!0})],_a.prototype,"location",void 0),c([p({readOnly:!0})],_a.prototype,"renderLocation",null),_a=c([F("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],_a);let ga=class extends Re{constructor(e){super(e),this._tileGeometryUpdateExtent=Jr(),this._tileGeometryUpdateSpatialReference=null,this.events=new Pr,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(ci.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",F$),Jr(this._tileGeometryUpdateExtent),this._set("updating",!1),Zi):Zi}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,hn(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const s=this.centerOnSurfaces[t];s.distance>e.distance&&(e=s)}return e}_centerIntersectsExtent(e,t){const s=this.state.contentCamera.eye,r=V$,a=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(s,Fn,t),this.renderCoordsHelper.fromRenderCoords(a.renderLocation,Vn,t),Fn[0]<Vn[0]?(r[0]=Fn[0],r[2]=Vn[0]):(r[0]=Vn[0],r[2]=Fn[0]),Fn[1]<Vn[1]?(r[1]=Fn[1],r[3]=Vn[1]):(r[1]=Vn[1],r[3]=Fn[1]),Nu(r,e)}};c([p({constructOnly:!0})],ga.prototype,"state",void 0),c([p({constructOnly:!0})],ga.prototype,"centerOnSurfaces",void 0),c([p({constructOnly:!0})],ga.prototype,"renderCoordsHelper",void 0),c([p({constructOnly:!0})],ga.prototype,"scheduler",void 0),c([p({constructOnly:!0})],ga.prototype,"surface",void 0),c([p({readOnly:!0})],ga.prototype,"updating",void 0),ga=c([F("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],ga);const F$={},Fn=b(),Vn=b(),V$=Jr();let rs=class extends Re{constructor(e){super(e),this.renderPointOfView=b(),this._pois=new Array,this._debugCenters=new Map,this._tmpRay=El(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new xn({renderPointOfView:U$},this)}initialize(){var d;const{state:e,basemapTerrain:t,renderCoordsHelper:s,map:r}=this.view;this._surfaceIntersector=Na(e.viewingMode),e.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=co.MIN,this._contentIntersector=Na(e.viewingMode);const a=()=>this._estimateSurfaceAltitudeAtCenter(),n=this.view.resourceController.scheduler,o=(d=this.view.basemapTerrain)==null?void 0:d.elevationQueryCache,l={state:e,scheduler:n,surface:t,renderCoordsHelper:s};this._set("centerOnSurfaceInfrequent",new zs({...l,task:ci.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:a})),this._set("centerOnSurfaceFrequent",new zs({...l,task:ci.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:a})),this._set("centerOnContent",new zs({...l,task:ci.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new lr({...l,cache:o,task:ci.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new ga({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new I$({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:s})),this._set("surfaceOrigin",new _a({cache:o,view:this.view})),this._set("focus",new hr({state:e,scheduler:n,surface:t,renderCoordsHelper:s,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(u,m)=>this._estimateSurfaceIntersectionAtRenderPoint(u,this.view.state.contentCamera,m)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);const h=this.view.graphics;this._debugCenters.set(this.centerOnContent,new el(h,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new el(h,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new el(h,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new el(h,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new el(h,"green","Focus")),this.addHandles([M(()=>e.contentCamera,u=>this._cameraChanged(u),nt),M(()=>t.extent,()=>this._updateCenterPointsOfInterest()),yl(()=>!t.updating,()=>this._updateCenterPointsOfInterest(),nt),Ma(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),Ma(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),yl(()=>Ts.SHOW_POI,u=>this._setDebug(u),si)]),this._cameraChanged(this.view.state.contentCamera);for(const u of this._pois)u.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!(!((e=this.surfaceGeometryUpdates)!=null&&e.updating)&&!this._pois.some(t=>t.updating))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return e==null||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,Uo,z$)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Uo):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(e==null)return this._surfaceAltitudeAtCenter;const t=e.origin,s=_e(Uo,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,s),this._surfaceIntersector.results.min.getIntersectionPoint(Uo)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Uo)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,s){const r=X1(t,e,q$);if(r==null)return null;const a=r.origin,n=_e(Uo,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,a,n),this._surfaceIntersector.results.min.getIntersectionPoint(s)?s:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;E_(this.renderPointOfView,t)||this._set("renderPointOfView",le(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach(t=>t.hide()),void this.removeHandles("debug");for(const t of this._pois)this.addHandles(M(()=>t.renderLocation,s=>{var r;return(r=this._debugCenters.get(t))==null?void 0:r.show(s,t.renderCoordsHelper.spatialReference)},si),"debug")}get test(){}};c([p()],rs.prototype,"centerOnContent",void 0),c([p()],rs.prototype,"centerOnSurfaceFrequent",void 0),c([p()],rs.prototype,"centerOnSurfaceInfrequent",void 0),c([p()],rs.prototype,"cameraOnSurface",void 0),c([p()],rs.prototype,"focus",void 0),c([p()],rs.prototype,"renderPointOfView",void 0),c([p()],rs.prototype,"surfaceOrigin",void 0),c([p()],rs.prototype,"contentGeometryUpdates",void 0),c([p()],rs.prototype,"surfaceGeometryUpdates",void 0),c([p({constructOnly:!0})],rs.prototype,"view",void 0),c([p()],rs.prototype,"updating",null),rs=c([F("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],rs);const U$=Array,Uo=b(),q$=El(),z$={exclude:new Set([Xh])},gz={value:.5,readOnly:!0},B$={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};let cl=class{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}},H$=class{constructor(e,t,s){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new uS(s,t)}computeMinMaxValue(e,t,s,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const a=e-this.level;if(a<=0)return r;const n=2**a;if(!(Math.floor(t/n)===this.i&&Math.floor(s/n)===this.j))return r;let o=1/0,l=-1/0;const h=this.samplerData.data.width,d=this.samplerData.data.values,u=.5*I_;let m=(h-1)/n,_=(s-this.j*n)*m,f=(t-this.i*n)*m;if(m<1){const g=Math.floor(_),y=Math.floor(f),w=g+y*h,x=d[w],T=d[w+1],S=d[w+h],C=d[w+h+1];if(x+T+S+C<u){const P=_-g,R=f-y,I=Rc(x,T,S,C,P,R),L=Rc(x,T,S,C,P+m,R),G=Rc(x,T,S,C,P,R+m),H=Rc(x,T,S,C,P+m,R+m);return r.min=Math.min(I,L,G,H),r.max=Math.max(I,L,G,H),r}_=g,f=y,m=1}else _=Math.floor(_),f=Math.floor(f),m=Math.ceil(m);for(let g=_;g<=_+m;g++)for(let y=f;y<=f+m;y++){const w=d[g+y*h];w<u?(o=Math.min(o,w),l=Math.max(l,w)):r.hasNoDataValues=!0}return r.min=o,r.max=l,r}};const G$=.5*I_;function Rt(i,e,t){if(t==null)return null;for(const s of t){if(!s)continue;const r=s.safeWidth;let a=Z(s.dy*(s.y1-e),0,r),n=Z(s.dx*(i-s.x0),0,r);const o=Math.floor(a),l=Math.floor(n),h=s.data.width,d=o*h+l,u=s.data.values,m=u[d],_=u[d+1],f=d+h,g=u[f],y=u[f+1];if(m+g+_+y<G$){a-=o,n-=l;const w=m+(_-m)*n;return w+(g+(y-g)*n-w)*a}}return null}let Us=class extends Re{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const s=t.layer;if("operationalLayerType"in s&&RT(s.operationalLayerType)&&this.viewSpatialReference!=null){const r=vw(s.fullExtent,this.viewSpatialReference);r!=null&&e.push(vT(r))}}),e}};function k$(i,e){return i===$e.Global?new p_(e):new m_(e)}c([p({readOnly:!0})],Us.prototype,"layerViewsExtent",null),c([p({readOnly:!0})],Us.prototype,"tiledLayersExtent",null),c([p({readOnly:!0})],Us.prototype,"stencilEnabledExtents",null),c([p()],Us.prototype,"viewSpatialReference",void 0),c([p()],Us.prototype,"tilingScheme",void 0),c([p()],Us.prototype,"defaultTiledLayersExtent",void 0),c([p({constructOnly:!0})],Us.prototype,"layers",void 0),c([p({constructOnly:!0})],Us.prototype,"layerViews",void 0),Us=c([F("esri.views.3d.terrain.ExtentHelper")],Us);let p_=class extends Us{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?pS:mS}};p_=c([F("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],p_);let m_=class extends Us{_computeLayerViewsExtent(){const e=Jr(),t=this.viewSpatialReference;this.layerViews.forEach(a=>{const n=a.layer;if(a.isResolved()&&(n.type!=="graphics"||!n.internal)){const o=vw("fullExtentInLocalViewSpatialReference"in a&&a.fullExtentInLocalViewSpatialReference||a.layer.fullExtent,t);hn(e,o,e)}});const s=ff(e)?e:null,r=this._get("layerViewsExtent");return lo(s,r)?r:s}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,s=Jr();this.layers.forEach(n=>{var o;if(n.loaded&&Th(n)){const l=Vu(n,t,$e.Local);if(l==null)return;const{tileInfo:h,fullExtent:d}=l,u="tilemapCache"in n?(o=n.tilemapCache)==null?void 0:o.effectiveMaxLOD:void 0;h!=null&&d!=null&&(u1(n)||e.compatibleWith(h,u)&&d.spatialReference.equals(e.spatialReference))&&hn(s,d,s)}}),hn(s,this.defaultTiledLayersExtent,s);const r=ff(s)?s:null,a=this._get("tiledLayersExtent");return lo(r,a)?a:r}};function vw(i,e){return i==null||i.spatialReference.equals(e)?i:YC(i,i.spatialReference,e)}m_=c([F("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],m_);function yw(){var e;const i=(e=globalThis.require)==null?void 0:e.modules;if(i){const t=Object.keys(i);for(const s of t)s.includes(".glsl")&&delete i[s]}}const bw=1.3,j$=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let ka,is=class extends Re{constructor(e){super(e),this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=li("esri-mobile")?2048:4096,this._animationTimeLast=0}initialize(){const e=this.view;this.renderer=new CP({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),e._stage.renderer.plugins.add(this.renderer);const t=()=>this.setDrawTexturesDirty();this._groundIntersector=Na(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([M(()=>this.renderer.hasHighlights,t),this.renderer.events.on("has-water",s=>{var r;return(r=e._stage)==null?void 0:r.renderer.setParameters({hasOverlayWater:s})}),this.renderer.events.on("content-changed",t),M(()=>e.state.camera.pixelRatio,t),M(()=>e.state.alignPixelEnabled,t),this.renderer.events.on("textures-disposed",()=>this.surface.requestRender()),M(()=>{var s,r,a;return[(s=e.pointsOfInterest)==null?void 0:s.renderPointOfView,(a=(r=e.pointsOfInterest)==null?void 0:r.centerOnSurfaceFrequent)==null?void 0:a.location]},()=>this.setPlacementDirty()),M(()=>{var s,r;return[(s=e.state)==null?void 0:s.pixelRatio,(r=e.state)==null?void 0:r.contentPixelRatio]},()=>this.setPlacementDirty(),nt),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.on("resize",()=>this.setPlacementDirty()),e.resourceController.scheduler.registerTask(ci.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",s=>{this._updateOverlays(Ta,s.camera,st.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(st.BACKGROUND,s)})]),e._stage.renderer.renderOverlay=s=>this._renderOverlay(s)}destroy(){var e;(e=this.view)!=null&&e._stage&&(this.view._stage.renderer.plugins.remove(this.renderer),this.view._stage.renderer.renderOverlay=()=>{}),ka&&(ka.hide(),ka=null),this.renderer=Y(this.renderer)}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||Ts.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return this._spatialReference!=null&&this._spatialReference.isGeographic&&!this.view.state.isLocal?Ut(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return bw/this.view.resolutionScale}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}_renderOverlay(e){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._dispatchAnimationUpdate(e),this._drawOverlays(st.UPDATE,this.view.state)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;e!=null&&t!=null?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new Qf(-20037508342787e-6,20037508342787e-6):new Qf(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}registerDrapeSource(e,t,s){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const r=this.renderer.createDrapeSourceRenderer(e,t,s);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),r}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,TP)}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&e.setDrapingExtent!=null&&this._spatialReference!=null&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,st.UPDATE)}_updateOverlays(e,t,s){if(!this._spatialReference)return Zi;const r=this._computeOverlayResolution(t);this._computeOverlayExtents(t,r,Ar),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,Ar.stretch);const a=this._updateOverlay(Ns.INNER,Ar.inner,r,1*Ar.pixelRatioAdjustment,Ar.mapUnitsPerPixel),n=Kn(Ar.inner)/Kn(Ar.outer),o=this._updateOverlay(Ns.OUTER,Ar.outer,r,n*Ar.pixelRatioAdjustment,Ar.mapUnitsPerPixel);a!==Fr.EXTENT&&o!==Fr.EXTENT||(this._drapeSources.forEach(l=>this._updateDrapeSourceExtent(l)),this.surface.updateTileOverlayParams(s)),a===Fr.NONE&&o===Fr.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,s=e.fullWidth/e.pixelRatio*t,r=e.fullHeight/e.pixelRatio*t,a=Math.ceil(1.5*Math.max(s,r));return Math.min(su(a),this._maxResolution)}_updateOverlay(e,t,s,r,a){if(this.renderer.overlays.length===0)return Fr.NONE;const n=this.renderer.overlays[e],o=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=a,n.pixelRatio=r,W$(t,n.extent)&&s===n.resolution)return o===a?Fr.NONE:Fr.RERENDER_ONLY;Tm(n.extent,t),n.resolution=s;const l=t1(n.extent);return n.renderLocalOrigin=SP(l[0],l[1],0,"OV_"+this._latestOriginId++),Fr.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const s=this.renderer.overlays[Ns.INNER],r=this.renderer.overlays[Ns.OUTER],a=e.extent;this._rectInsideRect(s.extent,a)||this._rectanglesOverlap(a,s.extent)||this._rectanglesOverlap(a,r.extent)?(this._setTileOverlayData(a,Ns.INNER,t),this._setTileOverlayData(a,Ns.OUTER,t)):(this._clearTileOverlayData(Ns.INNER,t),this._clearTileOverlayData(Ns.OUTER,t))}else this._clearTileOverlayData(Ns.INNER,t),this._clearTileOverlayData(Ns.OUTER,t)}overlayPixelSizeInMapUnits(e,t){if(this.renderer.overlays.length===0)return t();const s=this.renderer.overlays[Ns.INNER],r=this.renderer.overlays[Ns.OUTER],a=this._pointIsInExtent(e,s.extent)?s:r;return(a.extent[2]-a.extent[0])/a.resolution}_setTileOverlayData(e,t,s){if(this.renderer.overlays.length===0)return;const r=this.renderer.overlays[t].extent,a=Kn(r),n=Bh(r);let o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(r[0],o);const l=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);o>l&&(o=l-(e[2]-e[0]))}s.setScale(t,Kn(e)/a,Bh(e)/n),s.setOffset(t,(o-r[0])/a,(e[1]-r[1])/n)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){yw(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask(Ta)}_dispatchAnimationUpdate(e){const t=ct(e-this._animationTimeLast);if(t>=this.surface.view._stage.renderer.animationTimestep||this.view.state.forcedAnimationTime!=null||this._drawTexturesDirty||this._drawTexturesAnimateDirty){const s=ct(t/this.surface.view._stage.renderer.animationTimeDilation),r=new R1(this.view.state.camera,s,this.view.state.forcedAnimationTime);this.renderer.updateAnimation(r)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this.view._stage.renderView.requestRender()):this.setPlacementDirty()}_intersectGroundFromView(e,t,s,r){const a=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,Z$,t,s);if(a==null)return!1;const n=a.origin,o=_e(ad,a.origin,a.direction);return this._groundIntersector.reset(n,o,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,n,o),this._groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(e,t){let s=.5;const r=.55,a=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,l=Z(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:a+o,e.aboveGround?a-o:1/0),h=e.aboveGround;if(this.view.viewingMode==="global"){const d=ad;ku(Z_(K_,Ut(this.view.spatialReference).radius+l),vo(e.eye,e.viewForward),d),be(d,d,e.eye);const u=wn.normalize(R2(e.viewForward,d,e.viewRight))/e.fovY+.5,m=u<=0||u>=1?.5:r;s=h?m*u:u+m*(1-u)}else{const d=.5*Math.PI-Math.acos(-e.viewForward[2]),u=Math.tan(d),m=er(0,u,1,0),_=Im(m,m,e.projectionMatrix)[1],f=Z(.5+.5*_,0,1);s=f===1||f===0?.5:h?f*r:1-(1-f)*r}return!!this._intersectGroundFromView(e,.5,s,t)&&BC(t,e.eye)<n.distance*n.distance}_computeOverlayExtents(e,t,s){var L;const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,a=b();this._findHorizonBasedPointOfInterest(e,a)||le(a,r),Ts.OVERLAY_SHOW_CENTER?(ka==null&&(ka=new el(this.view.graphics,"red")),ka.show(a,this._renderSR)):ka!=null&&ka.hide();const n=Math.max(.1,os(e.eye,a)),o=Cn(this.view.renderCoordsHelper,r,e.eye);this._overlaySREqualsRenderSR||Yh(a,this._renderSR,a,this._spatialReference);const l=this.surface.extent,h=!this._isSpherical&&((L=this._spatialReference)==null?void 0:L.isGeographic),d=h&&this._spatialReference?1/Ut(this._spatialReference).metersPerDegree:1,u=this.view.state.contentPixelRatio,m=e.perScreenPixelRatio/u*n*d;s.mapUnitsPerPixel=m/this._worldToPCSRatio,s.stretch=this._overlayStretch;let _=t*m/2*s.stretch,f=!1,g=h?90:1/0;this._isSpherical&&l&&this._spatialReference&&(this._spatialReference.isWebMercator?(_/=Math.cos(oS(a[1])),g=l[3]):(f=!0,_/=Ut(this._spatialReference).metersPerDegree,g=90),_>=g&&(_=g,a[1]=0,this._spatialReference.isWebMercator&&(a[0]=0)));let y=1;f&&(y=1/Math.max(.2,Math.cos(Math.abs(Tt(a[1])))),_*y>180&&(y=180/_),s.mapUnitsPerPixel*=y);const w=Math.log(2)/12;_=Math.exp(Math.round(Math.log(_)/w)*w);const x=_*y,T=32,S=.5*t/(T*x),C=.5*t/(T*_);a[0]=Math.round(a[0]*S)/S,a[1]=Math.round(a[1]*C)/C;const P=s.inner;P[0]=a[0]-x,P[1]=a[1]-_,P[2]=a[0]+x,P[3]=a[1]+_,this._isSpherical&&this._shiftExtentToFitBounds(P,1/0,g);const R=s.outer;if(6*x>Kn(l))Tm(R,l);else if(Math.PI/2-Math.abs(o-Math.PI/2)<=.25*Math.PI)R[0]=P[0]-x,R[1]=P[1]-_,R[2]=P[2]+x,R[3]=P[3]+_;else{Yh(e.eye,this._renderSR,ad,this._spatialReference),NS(Un,a,ad);let G=-Math.atan2(Un[1],Un[0])+.125*Math.PI;G<0&&(G+=2*Math.PI);const H=Math.floor(G/(.25*Math.PI));f1(Un,j$[H],2*_),Un[0]*=y,Un[2]*=y,FS(R,P,Un)}if(this._isSpherical)R[0]=this._longitudeCyclical.clamp(R[0]),R[2]=this._longitudeCyclical.clamp(R[2]),R[1]=Math.max(R[1],-g),R[3]=Math.min(R[3],g);else{const G=Sm(P,l,X$),H=Sm(R,l,Y$);vf(G,H)&&(R[2]=R[0],R[3]=R[1])}const I=Math.abs(P[2]-P[0])/t;s.mapUnitsPerPixel=Math.max(s.mapUnitsPerPixel,I),s.pixelRatioAdjustment=s.mapUnitsPerPixel/I}_drawOverlays(e,t){if(!this.renderer.hasOverlays)return;if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const s=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const r=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),r!==this.renderer.computeValidity()&&this.surface.updateTileOverlayParams(st.UPDATE),s?(this.surface.requestRender(e),e===st.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(st.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return e!=null&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):Nu(e,t))}_rectInsideRect(e,t){return t!=null&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:vf(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const s=e.x,r=e.y;return s>t[0]&&s<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,s){let r=0,a=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-s?a=e[1]+s:e[3]>s&&(a=s-e[3]),Ky(e,r,a)}get test(){}};function W$(i,e){const s=Ts.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(i[2]-i[0],i[3]-i[1],e[2]-e[0],e[3]-e[1]);return Math.abs(e[0]-i[0])<=s&&Math.abs(e[1]-i[1])<=s&&Math.abs(e[2]-i[2])<=s&&Math.abs(e[3]-i[3])<=s}c([p()],is.prototype,"_spatialReference",void 0),c([p({readOnly:!0})],is.prototype,"running",null),c([p()],is.prototype,"_placementDirty",void 0),c([p()],is.prototype,"_contentUpdated",void 0),c([p()],is.prototype,"_isSpherical",null),c([p()],is.prototype,"_worldToPCSRatio",null),c([p()],is.prototype,"renderer",void 0),c([p({constructOnly:!0})],is.prototype,"view",void 0),c([p({constructOnly:!0})],is.prototype,"surface",void 0),c([p()],is.prototype,"suspended",null),c([p()],is.prototype,"updating",null),c([p({type:Boolean})],is.prototype,"rendersOccludedDraped",null),is=c([F("esri.views.3d.terrain.OverlayManager")],is);let Q$=class{constructor(){this.inner=hi(),this.outer=hi(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=bw}};const Un=mi(),ad=b(),Ar=new Q$,X$=hi(),Y$=hi(),Z$=El();var Fr;(function(i){i[i.NONE=0]="NONE",i[i.EXTENT=1]="EXTENT",i[i.RERENDER_ONLY=2]="RERENDER_ONLY"})(Fr||(Fr={}));let K$=class{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=_u(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=tt(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,_u(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,s,r){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,r),t),_e(t,t,s)}getEdgeNormal(e,t,s){const{typedBuffer:r,typedBufferStride:a}=this.vertexAttributes.normalCompressed;VR(t,r,this.getEdgeAttributeIndex(e,s),a)}setEdgeNormalFromValues(e,t,s,r,a){this._setNormal(this.getEdgeAttributeIndex(e,t),s,r,a)}setEdgeVertexFromValuesRawPositionUV(e,t,s,r,a,n,o){const l=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(l,s,r,a),this._setUV(l,n,o)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,s,r,a,n,o,l,h,d){const u=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(u,s,r,a),this._setUV(u,n,o),this._setNormal(u,l,h,d)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,s,r){const{typedBuffer:a,typedBufferStride:n}=this.vertexAttributes.normalCompressed;Zh(a,e,t,s,r,n)}_setUV(e,t,s){Cr(this.vertexAttributes.uv0,e,t,s)}getEdgeAttributeIndex(e,t){return N(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}};const $v=16384;function Cr(i,e,t,s){i.setValues(e,t*$v,s*$v)}let J$=class{constructor(){this.sinLonLUT=new Array(ih+1),this.cosLonLUT=new Array(ih+1),this.sinLatLUT=new Array(ih+1),this.cosLatLUT=new Array(ih+1)}update(e,t,s){const r=t[0],a=t[2];for(let n=0;n<=e;n++){const o=n/e,l=r*(1-o)+a*o;this.sinLonLUT[n]=Math.sin(l),this.cosLonLUT[n]=Math.cos(l);const h=s(o);this.sinLatLUT[n]=Math.sin(h),this.cosLatLUT[n]=Math.cos(h)}}},eI=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}},ww=class Id{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=Y(this._current),this._next=Y(this._next),this._waiting=Y(this._waiting),this._delayed=Y(this._delayed)}get current(){if(this._current==null)return null;if(!this._isFadingEnabled){const t=this._delayed||this._waiting||this._next||this._current;t!==this._current&&(this._current=null,this.clear(),this._current=t)}let e=Id.test.fadeMoment;if(this._delayed!=null&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,pn.Immediate),this._delayed=null)),this._next!=null){e=e||performance.now();const t=this._fadeDuration,s=this._current!=null&&this._next.texture===this._current.texture,r=this._next.type!==ii.FADING,a=e-this._fadeStart>=t;(s||r||a)&&(Y(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(this._next==null)return 1;const e=Id.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),s=this._fadeDuration;return t>s?0:1-t/s}get isFading(){return this._next!=null||this._delayed!=null}push(e,t=pn.Immediate){this._delayed=Y(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),this._current==null)return void(this._current=e);const s=Id.test.fadeMoment||performance.now();return t!==pn.Immediate?(this._delayed=e,void(this._delayedTime=s+t)):this._next==null?(this._next=e,void(this._fadeStart=this._alignFadeStart(s))):void(e!=null&&(Y(this._waiting),this._waiting=e))}get _fadeDuration(){return this._waiting==null?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}};var pn;ww.test={fadeMoment:0},function(i){i[i.Immediate=0]="Immediate",i[i.Delayed=5e3]="Delayed"}(pn||(pn={}));var Sl;(function(i){i[i.BACK_TO_FRONT=-1]="BACK_TO_FRONT",i[i.NONE=0]="NONE",i[i.FRONT_TO_BACK=1]="FRONT_TO_BACK"})(Sl||(Sl={}));let xw=class{constructor(){this._queue=new Gt,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),e!=null&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){var t;const e=(t=this._last)==null?void 0:t.children;return e!=null&&e[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}},tI=class{constructor(){this._q=new Gt}get done(){return this._q.length===0}reset(e){if(this._q.clear(),e!=null){this._q.pushArray(e);for(let t=0;t<this._q.length;++t){const s=this._q.data[t];s.isLeaf||this._q.pushArray(s.children)}}}next(){return this._q.pop()}};function $h(i,e,t){if((e==null?void 0:e.fullExtent)==null)return!1;const s=e.fullExtent,r=i.extent;if(t){if(r[0]<s.xmin||r[1]<s.ymin||r[2]>s.xmax||r[3]>s.ymax)return!1}else if(s.xmin>r[2]||s.ymin>r[3]||s.xmax<r[0]||s.ymax<r[1])return!1;const a=i.surface.tilingScheme.levels[i.level].scale,n=e.minScale;if(n>0&&a>1.00000001*n)return!1;const o=e.maxScale;return!(o>0&&a<.99999999*o)}function jr(i,e){const t=i.lij,s=e.lij;return t[0]-s[0]||t[1]-s[1]||t[2]-s[2]}function iI(i,e,t=null){t==null||t.length===0?i===Sl.BACK_TO_FRONT?e.sort(sI):e.sort(rI):e.sort((s,r)=>aI(s,r,i,t))}function sI(i,e){const t=e.screenDepth-i.screenDepth;if(t!==0)return t;const s=i.lij,r=e.lij;return s[0]-r[0]||s[1]-r[1]||s[2]-r[2]}function rI(i,e){const t=i.screenDepth-e.screenDepth;if(t!==0)return t;const s=i.lij,r=e.lij;return s[0]-r[0]||s[1]-r[1]||s[2]-r[2]}function Cw(i,e,t){const s=i.screenDepth,r=e.screenDepth;return s<r?-t:s>r?t:jr(i,e)}function aI(i,e,t,s){return Iv(i,s)===Iv(e,s)?Cw(i,e,t):i?t:-t}function Iv(i,e){for(const t of e)if(i.intersectsExtent(t))return!0;return!1}function nI(i,e){const t=i.distanceToPOI-e.distanceToPOI;if(t!==0)return t;const s=i.lij,r=e.lij;return s[0]-r[0]||s[1]-r[1]||s[2]-r[2]}function oI(i,e){const t=i.length;for(let s=0;s<t;++s)i.at(s).updateDistanceToPOI(e);i.sort(nI)}function lI(i,e,t){let s=1,r=0,a=0;for(;i!==e;)if(s*=.5,r*=.5,a*=.5,1&i.lij[2]&&(r+=.5),1&i.lij[1]||(a+=.5),(i=i.parent)==null)throw new Error("tile was not a descendant of upsampleTile");t.init(e,r,a,s)}function hI(i){for(let e=0;e<i.length;e++){const t=i[e],s=t.parent;if(s)for(let r=0;r<4;r++){const a=s.children[r];if(a&&a!==t)return!0}}return!1}function Mz(i,e){if(!i||!e||i[0]===e[0])return!1;const t=i[0]<e[0],s=t?i:e,r=t?e:i,a=1<<r[0]-s[0];return Math.floor(r[1]/a)===s[1]&&Math.floor(r[2]/a)===s[2]}let Tg=class{get updating(){return!!this._tileRequested}init(e,t,s,r){this.tile=e,this._layerIdx=t,this._layerClass=s,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,s),this._tileRequested=null;const a=this._findAncestorWithData();this._setUpsampleTile(a)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,ii.FADING,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e!=null?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,s=this.tile.surface.layerViewByIndex(e,t),r=Mm(s),{minLevel:a,maxLevel:n}=s.dataLevelRange,o=this._desiredMinLevelDelta,l=this._progressiveLevelModulo+o,h=this._scaleRangeEnabled?$h:()=>!0;let d=this.tile;const u=d.level;let m;const _=this._tileLayerInfo.upsampleInfo,f=_!=null?_.tile.level:-1,g=_!=null&&f-u>=o,y=r==null?void 0:r.tilemapCache,w=s.type==="vector-tile-3d"?s.schemaHelper:null;for(;d&&h(d,r,!1)&&d.level>=a;){const x=d.level,T=u-x,S=d.layerInfo[t][e];if(S.data&&T>=o){(!g||x>f)&&this._setUpsampleTile(d),S.dataInvalidated&&(m=d);break}const C=(w==null?void 0:w.getLevelRowColumn(d.lij))??d.lij;if((y==null?void 0:y.getAvailability(C[0],C[1],C[2]))!=="unavailable"&&x<=n&&!S.data&&!S.dataMissing&&((!m||d.level===a||x%p1==0||u-m.level<o)&&(m=d),T>=l))break;d=d.parent}if(m!=null&&u-m.level<o)if(_)m=null;else{const x=this._findAncestorWithData();x!=null&&(this._setUpsampleTile(x),m=x.layerInfo[t][e].dataInvalidated?x:null)}return m}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let s;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;s=r}return s}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,ii.FADING,t)}get test(){}},cI=class extends Tg{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw Lv}get _progressiveLevelModulo(){throw Lv}dispose(){}};const Lv=new Error("Abstract method called on TileAgent"),ps=new cI;let dI=class extends Tg{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}};function uI(i){return i.type==="elevation"}let pI=class extends Tg{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return p1}};function mI(i){return i.type==="map"}var Ui;(function(i){i[i.INSIDE=0]="INSIDE",i[i.INTERSECTS=1]="INTERSECTS",i[i.OUTSIDE=2]="OUTSIDE"})(Ui||(Ui={}));let Ld=class{constructor(){this.waitingAgents=new Gt,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const t=Wp.acquire();return t._init(e),t}release(){this.dispose(),Nd.delete(this),Wp.release(this)}dispose(){this.loadingAgent=je(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=pl(this._data)}static prune(){Wp.prune(0)}_init(e){this.waitingAgents.clear(),this._data=pl(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=Pn(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo!=null&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&t!=null){if(this._upsampleInfo==null)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),lI(e,t,this._upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){pl(this._data),this._data=e}};const Wp=new _n(Ld,null,()=>{}),Nd=new Map;function _I(){Nd.size>0&&(console.log(`${Nd.size} live TilePerLayerInfo allocations:`),Nd.forEach(i=>console.log(i,`
`)))}var se;(function(i){i[i.NONE=0]="NONE",i[i.SPLIT=1]="SPLIT",i[i.ELEVATION=2]="ELEVATION",i[i.MERGE=4]="MERGE",i[i.GEOMETRY=8]="GEOMETRY",i[i.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",i[i.TEXTURE_FADING=32]="TEXTURE_FADING"})(se||(se={}));const gI=.1;let Sg=class{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=hi(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=hi(),this.centerAtSeaLevel=b(),this._center=[b(),Sr(),b()],this.up=HC(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=b(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){Pg.prune(0),Rg.prune(0),Ld.prune()}get _isCached(){return!this.isLeaf&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[Wt.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent,t=(e==null?void 0:e.frustumVisibility)??Ui.INTERSECTS;this._frustumVisibility=t===Ui.INSIDE?Ui.INSIDE:t===Ui.OUTSIDE?Ui.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);const s=this._frustumVisibility!==Ui.OUTSIDE&&this._intersectsClippingArea;s!==this._visible&&(this._visible=s,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,s,r,a){this._lij[0]=e,this._lij[1]=t,this._lij[2]=s,this.ellipsoid=Ut(a.tilingScheme.spatialReference),a.tilingScheme.getExtent(e,t,s,this.extent),a.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,a.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[Wt.MIDDLE][3]=0,this.elevationLevel=e,r&&!Number.isNaN(r.elevationBoundsMin)?(this._elevationBoundsMin=r.elevationBoundsMin,this._elevationBoundsMax=r.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=r,this.unsetChildren(),this._surface=a,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const n of Xn){const o=a.numLayers(n),l=this.layerInfo[n];for(const h of l)h.release();l.length=o;for(let h=0;h<o;h++)l[h]=Ld.acquire(this._surface.upsampleInfoPool),n===we.ELEVATION&&this.findElevationBoundsForLayer(h,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(a.tilingScheme.pixelSize,ih)}dispose(){ei(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of Xn){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null;for(let e=0;e<4;++e)this._children[e]=null;this._surface=null,this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();const e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}get _cachedMemory(){return this._isCached?this._mapTileMemory:0}get _mapTileMemory(){return this._ensureUsedMemory(),this.layerInfo[we.MAP].reduce((e,{data:t})=>e+(ql(t)?t.usedMemory/t.referenced:0),this._mapTileMemoryInternal)}get _cpuImageMemorySize(){const t=this._surface.tilingScheme.pixelSize;return t*t*4}_ensureUsedMemory(){var s;if(this._usedMemory!=null)return this._usedMemory;this._usedMemory=this._baseUsedMemory,this._mapTileMemoryInternal=0;let e=0;for(const{data:r}of this.layerInfo[we.MAP])ql(r)?e+=this._getTerrainDataMemory(r):this._mapTileMemoryInternal+=this._getTerrainDataMemory(r);const t=this._cpuImageMemorySize;for(const r of this.layerInfo[we.ELEVATION])this._usedMemory+=r.data?t:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=((s=this.renderData.texture)==null?void 0:s.usedMemory)??0),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+e),this._usedMemory}getUsedMemoryForLayer(e,t){const s=this.layerInfo[e][t];return s!=null&&s.data?e===we.MAP?this._isCached?0:this._getTerrainDataMemory(s.data):e===we.ELEVATION?this._cpuImageMemorySize:0:0}_getTerrainDataMemory(e){return _S(e)?e.texture.usedMemory:gS(e)?e.memoryUsage:ql(e)?e.usedMemory/e.referenced:L_(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(e){const t=this._center[Wt.MIDDLE],s=e,r=t[0],a=t[1],n=t[2],o=s[2]*r+s[6]*a+s[10]*n+s[14];this.screenDepth=o<0?0:o/(s[3]*r+s[7]*a+s[11]*n+s[15])}shouldSplit(e,t,s){if(!this.visible||e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===Ui.OUTSIDE))return se.NONE;const r=this.level;be(od,qt(this._center[Wt.MIDDLE]),t);let a=gr(od),n=od,o=qt(this._center[Wt.MIDDLE]);be(Qp,this._center[Wt.TOP],t);const l=gr(Qp);l<a&&(a=l,n=Qp,o=this._center[Wt.TOP]),be(Xp,this._center[Wt.BOTTOM],t);const h=gr(Xp);if(h<a&&(a=h,n=Xp,o=this._center[Wt.BOTTOM]),this._edgeLen2>a&&r<e.maxLod)return se.SPLIT;const d=Math.sqrt(a),u=e.fovX*d*2,m=this._edgeLen/u,_=()=>{if(r<e.maxLod)return this.elevationLevel=r,se.NONE;const R=r+Math.ceil(-Math.log2(e.relativeWidthLimit/m));return R!==this.elevationLevel?(this.elevationLevel=R,se.ELEVATION):se.NONE},f=s!=null?s-r:1/0;if(f<=.5)return _();const g=ue(this.up,od),y=this._elevationBoundsMax-this._elevationBoundsMin,w=y/this.edgeLen;if(e.aboveGround&&g>0&&w<.001&&g/d-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-w>0)return se.NONE;const x=s!=null?3-Math.min(f,2):1;if(m*x<e.relativeWidthLimit||r>=e.maxLod)return _();if(r<7)return se.SPLIT;ee(fi,this.up,g),be(fi,fi,n);const T=gr(fi);if(T<=this.radius*this.radius)return se.SPLIT;ee(fi,fi,this.radius/Math.sqrt(T)),_e(fi,fi,o),be(fi,t,fi);const S=Math.min(1,(Math.abs(ue(fi,this.up))+.5*y+this._curvatureHeight)/xe(fi)),C=gI/e.angledSplitBias,P=e.fovY*d*2;return S*(this._edgeLen/P*x)<C*e.relativeHeightLimit?se.NONE:se.SPLIT}setChildren(e,t,s,r){ei(!!(e&&t&&s&&r),"Null child passed");const a=this._children;return a[0]=e,a[1]=t,a[2]=s,a[3]=r,a}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}get isLoaded(){var e;return((e=this.renderData)==null?void 0:e.hasGeometry)??!1}load(){this.refMapData();for(const e of Xn)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(e){e.unloadTile(this);for(const t of Xn){const s=this.layerInfo[t];for(const r of s)r.loadingAgent&&r.loadingAgent!==ps&&(nd(r.loadingAgent),r.loadingAgent=null),r.pendingUpdates=0}this.resetPendingUpdate(se.GEOMETRY),this.resetPendingUpdate(se.TEXTURE_NOFADING),this.resetPendingUpdate(se.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[we.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==ps&&(nd(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(lo(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,s=this._isWithinClippingArea;e!=null?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=s&&this._isWithinClippingArea,a=!(s||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||r||a||this.setPendingUpdate(se.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const s=this.layerInfo[t][e];return!(!(s!=null&&s.data)||s.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of Xn){const t=this.layerInfo[e];for(const s of t)if(s.loadingAgent&&s.loadingAgent!==ps&&s.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(se.SPLIT)||e!==we.ELEVATION&&!this.loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,e===se.SPLIT||e===se.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,s){const r=this.layerInfo[t][e];if(r.waitingAgents.has(s))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),s.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(s),r.data&&!r.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),s.tile.lij.toString(),t,e);const o=ql(r.data);return s.dataArrived(this,o),!0}if(r.requestPromise)return!0;Pn(r.requestAbort),r.requestAbort=new AbortController;const a=this._surface.requestTileData(this,e,t,r.requestAbort);if(!a)return r.requestAbort=null,!1;const n=()=>{r.requestPromise===a&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=a,a.then(n,n),!0}get isLeaf(){return this._children[0]==null}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return gr(be(fi,qt(this._center[Wt.MIDDLE]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const s=this.extent;return e>=s[0]&&t>=s[1]&&e<=s[2]&&t<=s[3]}unrequestLayerData(e,t,s){const r=this.layerInfo[t][e],a=r.waitingAgents,n=a.removeUnordered(s)!=null;ei(n,"agent has not requested this piece of map data"),a.length<1&&(r.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,s){const r=ql(s),a=this.layerInfo[t][e];a.data=s,a.dataInvalidated=!1,a.waitingAgents.forAll(n=>n.dataArrived(this,r)),a.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t){const s=this.layerInfo[t][e];s.dataMissing=!0,s.waitingAgents.forAll(r=>r.dataMissing()),s.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,s){switch(s&&this.forEachLoadedNeighbor(r=>r.updateRenderData(e,t)),e){case we.MAP:return this._updateTexture(t);case we.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===ii.FADING?se.TEXTURE_NOFADING:se.TEXTURE_FADING),this.setPendingUpdate(e===ii.FADING?se.TEXTURE_FADING:se.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(se.GEOMETRY);for(const e of this.layerInfo[we.ELEVATION])e.pendingUpdates|=se.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let s=1/0,r=-1/0;const a=this.layerInfo[we.ELEVATION];let n=!0;for(const o of a)o.elevationBounds!=null&&(s=Math.min(s,o.elevationBounds.min),r=Math.max(r,o.elevationBounds.max),o.elevationBounds.hasNoDataValues||(n=!1));n&&(s=Math.min(s,0),r=Math.max(r,0)),e===s&&t===r||(this._elevationBoundsMin=s,this._elevationBoundsMax=r,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax,s=.5*(e+t),r=this._center;ee(fi,this.up,s),_e(qt(r[Wt.MIDDLE]),this.centerAtSeaLevel,fi),ee(fi,this.up,e),_e(r[Wt.TOP],this.centerAtSeaLevel,fi),ee(fi,this.up,t),_e(r[Wt.BOTTOM],this.centerAtSeaLevel,fi)}findElevationBoundsForLayer(e,t){const s=this.layerInfo[we.ELEVATION][e],r=this.elevationLevelDelta,a=Math.max(this.elevationLevel-r,0),n=s.elevationBounds;if(n!=null&&n.level>=t&&n.level<=a)return;const o=this._surface.layerViewByIndex(e,we.ELEVATION),l=Mm(o);if(!$h(this,l,!1))return;const h=vI;let d=!1;const u=s.data;if(u&&u.level<=a){const m=s.data;h.min=m.samplerData.data.minValue,h.max=m.samplerData.data.maxValue,h.hasNoDataValues=m.samplerData.data.hasNoDataValues,h.level=this.level,d=!0}else{let m,_,f=0;for(let g=this._parent;g&&(!_||f<r)&&(f=this.elevationLevel-g.level,m=_||m,_=g.layerInfo[we.ELEVATION][e].data,!(!_&&m&&g.level<=a));g=g.parent);_=_||m,_&&(_.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],h),h.min!==1/0&&(h.level=_.level,d=!0))}d&&(s.elevationBounds==null&&(s.elevationBounds=new cl),s.elevationBounds.copyFrom(h))}modifyLayers(e,t,s){const r=this.layerInfo[s];for(const o of r)o.loadingAgent&&o.loadingAgent!==ps&&(nd(o.loadingAgent),o.loadingAgent=null),o.waitingAgents.clear();for(let o=0;o<r.length;++o)e[o]===void 0&&r[o].release();const a=new Array(...r),n=t.length;r.length=n;for(let o=0;o<n;o++){const l=t[o];r[o]=l>-1?a[l]:Ld.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,ii.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const s of t)s.loadingAgent===ps&&(s.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of Xn){const t=this._isSuspended(e);for(const s of this.layerInfo[e])s.loadingAgent&&s.loadingAgent!==ps&&(s.loadingAgent.setSuspension(t),s.loadingAgent===ps&&this.updateRenderData(e,ii.FADING))}}removeLayerAgent(e,t){const s=this.layerInfo[t][e];s.loadingAgent&&s.loadingAgent!==ps&&s.loadingAgent.dispose(),s.loadingAgent=null}agentDone(e,t){const s=this.layerInfo[t][e];s.loadingAgent=ps,s.data||s.upsampleInfo!=null||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return e.blendMode!=="normal"||wl(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,s){var r,a,n;for(let o=e;o<t;++o){const l=this._surface.layerViewByIndex(o,s);if(Hh(l)&&((r=l==null?void 0:l.layer)==null?void 0:r.blendMode)!=="normal"||wl((a=l==null?void 0:l.layer)==null?void 0:a.parent)&&this._hasBlendableAncestor((n=l==null?void 0:l.layer)==null?void 0:n.parent))return!0}return!1}_createOrUpdateAgents(e,t){const s=this.layerInfo[t];if(s.length===0)return;const r=this._isSuspended(t);for(let a=e;a<s.length;++a){const n=s[a];let o=!1;const l=this._surface.layerViewByIndex(a,t),h=Mm(l);if(n.loadingAgent?$h(this,h,!1)?(n.loadingAgent!==ps&&n.loadingAgent.setSuspension(r),n.loadingAgent!==ps&&(o=n.loadingAgent.update())):n.dispose():$h(this,h,!1)&&(n.loadingAgent=fI(this,a,t,r),o=n.loadingAgent.startLoading(),o?n.loadingAgent===ps&&this.setPendingUpdate(se.GEOMETRY):(nd(n.loadingAgent),n.loadingAgent=ps)),n.loadingAgent===ps&&this.updateRenderData(t,ii.FADING),!this._hasBlendModes(e,s.length,t)&&o&&l.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,s=Math.max(this.level-e,this.elevationLevelDelta-t),r=Z(1+(this.maxTesselation>>s),2,this.maxTesselation+1),a=this.getDefaultVerticesPerSide();return Math.max(r,a)}_findLIJ(e,t){if(!e)return null;const s=this.surface.rootTiles;if(s!=null){for(const r of s)if(yI(r,e)){let a=r,n=e[0]-a.level-1;for(;n>=0&&!a.isLeaf&&!t(a);){const o=e[1]>>n&1,l=e[2]>>n&1;a=a.children[2*o+l],n--}return t(a)?a:null}}return null}findNeighborTile(e,t){const s=this._lij,r=this.getNeighborLIJ(s,e);return r?Fd(s,r)?t(this)?this:null:this._findLIJ(r,t):null}findCorner(e,t){const s=e===vt.NORTH_EAST?1:e===vt.NORTH_WEST?0:e===vt.SOUTH_WEST?2:3;let r=this;for(;r.children[0]&&(!t||!t(r));)r=r.children[s];return r}findNeighborCornerTileExact(e,t){var s;return((s=this.findNeighborTile(e,r=>t(r)||r.level===this.level))==null?void 0:s.findCorner(Jd(e),t))||null}forAllSubtreeOnSide(e,t){const s=e===vt.NORTH?[0,1]:e===vt.NORTH_EAST?[1]:e===vt.EAST?[1,3]:e===vt.SOUTH_EAST?[3]:e===vt.SOUTH?[2,3]:e===vt.SOUTH_WEST?[2]:e===vt.WEST?[0,2]:[0],r=a=>{const n=a.children;!t(a)&&n[0]&&s.forEach(o=>r(n[o]))};r(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const s=this.level-t.level;if(N(!zi||s>=0),s===0)return 0;const r=2**s,a=!(1&~e),n=a?0:1,o=t.lij[n+1]*r,l=this._lij[n+1],h=l-o,d=a?r-1-h:h;return zi&&(N(o<=l&&l<o+r),N(0<=d&&d<r)),d}forEachLoadedNeighbor(e){const t=this.level,s=r=>r.level===t||r.isLoaded;yr.forEach(r=>{const a=this.findNeighborTile(r,s);a!=null&&a!==this&&a.forAllSubtreeOnSide(N_(r),n=>!!n.isLoaded&&(e(n,r),!0))}),eu.forEach(r=>{var n;const a=(n=this.findNeighborTile(r,s))==null?void 0:n.findCorner(Jd(r),o=>o.isLoaded);N(!a||__(this,a,r)),a!=null&&a.isLoaded&&e(a,r)})}getNeighborLIJ(e,t){const s=Rf(t)?-1:Of(t)?1:0,r=Mf(t)?-1:Ef(t)?1:0,a=[e[0],e[1]+s,e[2]+r];return a[1]<0?null:this.surface.isGlobal?this.wrapLIJ(a):a[2]<0?null:a}wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}get westNeighborWestExtent(){return this.extent[0]*(this.isWestEnd?-1:1)}get eastNeighborEastExtent(){return this.extent[2]*(this.isEastEnd?-1:1)}get isEastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get isWestEnd(){return this._lij[2]===0}get isNorthEnd(){return this._lij[1]===0}get isSouthEnd(){const e=this.surface.extent,t=(e==null?void 0:e[1])??null;return t!=null&&this.extent[1]+GC()>=t}checkGeometryWaterproofness(){var e;Em&&(N(this.isLoaded),(e=this.renderData)==null||e.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,s=this.surface.rootTilesExtent,r=.25*(t[2]-t[0]);if(Rf(e)&&t[3]+r>=s[3]||Of(e)&&t[1]-r<=s[1])return!1;const a=this.surface.isGlobal;return!(!a&&Mf(e)&&t[0]-r<=s[0])&&!(!a&&Ef(e)&&t[2]+r>=s[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;le(this._lastPOI,e);const s=this._center[Wt.MIDDLE],r=e[0]-s[0],a=e[1]-s[1],n=e[2]-s[2];this.distanceToPOI=r*r+a*a+n*n}get test(){return{cachedMemory:this._cachedMemory}}};function fI(i,e,t,s){const r=t===we.ELEVATION?Rg.acquire():Pg.acquire();return r.init(i,e,t,s),r}function nd(i){i.dispose(),uI(i)?Rg.release(i):mI(i)&&Pg.release(i)}const Pg=new _n(pI),Rg=new _n(dI),vI=new cl;var Wt;function yI(i,e){const t=i.lij,s=e[0]-t[0];return!(s<0)&&e[1]>>s===t[1]&&e[2]>>s===t[2]}function Fd(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]}function bI(i,e,t){if(i==null||e==null)return!1;if(i.level===0&&e.level===0&&(i.isEastEnd&&e.isWestEnd&&t===vt.EAST||i.isWestEnd&&e.isEastEnd&&t===vt.WEST))return!0;const s=Math.max(1e-6*(i.extent[2]-i.extent[0]),1);switch(t){case vt.NORTH:return ks(i.extent[3],e.extent[1],s);case vt.SOUTH:return ks(i.extent[1],e.extent[3],s);case vt.EAST:return ks(i.extent[2],e.extent[0],s)||ks(i.extent[2],-e.extent[0],s);case vt.WEST:return ks(i.extent[0],e.extent[2],s)||ks(i.extent[0],-e.extent[2],s)}}function __(i,e,t){return i!=null&&e!=null&&e!==i&&(i.level>=e.level?Nv(i,e,t):Nv(e,i,Jd(t)))}function Nv(i,e,t){N(i.level>=e.level);const s=fS(t),r=vS(t),a=i.extent,n=e.extent,o=[s?a[0]:a[2],r?a[3]:a[1]],l=[s?n[2]:n[0],r?n[1]:n[3]],h=1e-5*(a[2]-a[0]),d=ks(o[0],l[0],h)||i.surface.isGlobal&&ks(o[0],-l[0],h),u=ks(o[1],l[1],h);if(d&&u)return!0;if(i.level===e.level)return N(!1),!1;if(!d&&!u)return N(!1),!1;const m=d?Fv(n[1],n[3],a[1],a[3],h):Fv(n[0],n[2],a[0],a[2],h);return N(m),m}function Fv(i,e,t,s,r){return i-r<=t&&t<=s&&s<=e+r}(function(i){i[i.TOP=0]="TOP",i[i.MIDDLE=1]="MIDDLE",i[i.BOTTOM=2]="BOTTOM"})(Wt||(Wt={}));const od=b(),Qp=b(),Xp=b(),fi=b();let wI=class{constructor(){this._scales=er(-1,-1,-1,-1),this._offsets=er(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,s){this._scales[2*e]=t,this._scales[2*e+1]=s}setOffset(e,t,s){this._offsets[2*e]=t,this._offsets[2*e+1]=s}get scales(){return this._scales}get offsets(){return this._offsets}};function xI(i,e){i.varyings.add("tbnTangent","vec3"),i.varyings.add("tbnBiTangent","vec3"),e.spherical?i.vertex.code.add(v`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):i.vertex.code.add(v`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),i.fragment.code.add(v`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function Og(i){i.code.add(v`
    float lineFactorAtPosition(float value) {
      float pos = value * ${v.float(257)};
      if(pos < 0.5 || pos > ${v.float(257-.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}var Wr;(function(i){i[i.LayerOnly=0]="LayerOnly",i[i.ColorComposite=1]="ColorComposite",i[i.GridComposite=2]="GridComposite",i[i.COUNT=3]="COUNT"})(Wr||(Wr={}));let CI=class extends eg{constructor(){super(...arguments),this.overlayOpacity=1}};function TI(i,e){const{vertex:t,fragment:s,varyings:r}=i;r.add("vtc","vec2"),t.uniforms.add(new Vv("texOffsetAndScale")),s.uniforms.add(new Uv("tex")),s.uniforms.add(new Yp("textureOpacities"));const a=e.textureFadingEnabled&&!e.renderOccluded;a&&(t.uniforms.add(new Vv("nextTexOffsetAndScale")),r.add("nvtc","vec2"),s.uniforms.add(new Uv("texNext")),s.uniforms.add(new Yp("nextTexOpacities")),s.uniforms.add(new SI("fadeFactor")));const n=e.tileBlendInput===Wr.ColorComposite,o=e.tileBlendInput===Wr.GridComposite;o&&s.include(Og),n&&s.uniforms.add(new Yp("backgroundColor")),t.code.add(v`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${a?v`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:v``}
  }`),s.code.add(v`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${o||n?v`
              if (opacities.y <= 0.0) {
                return color * opacities.z * opacities.x;
              }
              vec4 bg = vec4(${n?v`backgroundColor`:v`gridColor(uv)`} * opacities.y, opacities.y);
              vec4 layer = color * opacities.z;
              return (bg * (1.0 - layer.a) + layer) * opacities.x;`:v`return color;`}
    }`),a?s.code.add(v`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):s.code.add(v`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}let SI=class extends Xu{constructor(e){super(e,"float")}},Yp=class extends Xu{constructor(e){super(e,"vec3")}},Vv=class extends Xu{constructor(e){super(e,"vec4")}},Uv=class extends Xu{constructor(e){super(e,"sampler2D")}},Mg=class extends CI{};function Tw(i){const e=new Dt,{vertex:t,fragment:s,varyings:r}=e;e.include(jS),e.include(qR,i),e.include(qu,i);const a=()=>{e.include(mT,i),t.code.add(v`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};WS(t,i),e.include(ib,i);const n=i.overlayMode!==au.Disabled,o=n&&i.invisible;switch(i.output){case E.Color:{e.include(TI,i),e.include(fu,i),n&&e.include(Bl,{...i,pbrMode:i.pbrMode===Qt.Simplified?Qt.TerrainWithWater:Qt.Water});const l=i.overlayMode===au.EnabledWithWater;l&&e.include(xI,i),r.add("vnormal","vec3"),r.add("vpos","vec3"),r.add("vup","vec3"),a(),i.screenSizePerspective&&Nf(t);const h=i.receiveShadows&&!i.renderOccluded;h&&e.include(rb,i),i.screenSizePerspective&&(r.add("screenSizeDistanceToCamera","float"),r.add("screenSizeCosAngle","float")),t.code.add(v`
        void main(void) {
          //Position
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);

          //Normal
          vnormal = getNormal();

          //Up
          vup = getLocalUp(position, localOrigin);

          ${l?v`forwardVertexTangent(vnormal);`:v``}

          //Texture UV
          vec2 uv = getUV0();
          forwardTextureCoordinatesWithTransform(uv);
          ${n?v`setOverlayVTC(uv);`:""}
          ${i.tileBorders?v`forwardTextureCoordinates();`:""}

          ${i.screenSizePerspective?v`
          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
          screenSizeDistanceToCamera = length(viewPos);
          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
          screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}

          ${h?v`forwardLinearDepth();`:""}

        }
      `),e.include(QS,i),e.include(fu,i),e.include(fR,i),e.include(vR,i),XS(s,i),yR(s),tb(s),s.uniforms.add(t.uniforms.get("localOrigin"),new Ei("viewDirection",(d,u)=>oe(qv,it(qv,u.camera.viewMatrix[12],u.camera.viewMatrix[13],u.camera.viewMatrix[14])))),l&&s.uniforms.add(new Fe("ovWaterTex",(d,u)=>{var m;return(m=u.overlay)==null?void 0:m.getTexture(mr.WaterNormal)}),new YS("view",(d,u)=>fo(PI,u.camera.viewMatrix,d.origin))),s.code.add(v`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),q_(s),C1(s),s.code.add(v`
        void main() {
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${i.receiveShadows&&!i.renderOccluded?"readShadowMap(vpos, linearDepth)":i.spherical?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${n?v`
              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
              vec4 overlayColor = overlayOpacity * overlayColorOpaque;
              ${i.invisible?v`if (overlayColor.a == 0.0) { discard; }`:""}
              vec4 groundColor = tileColor;
              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a <= 0.0) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= sliceOpacity;
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${i.pbrMode===Qt.Simplified||i.pbrMode===Qt.TerrainWithWater?v`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:v`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${l?v`
              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                vec4 viewPosition = view*vec4(vpos, 1.0);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                float opacity = sliced ? sliceOpacity : 1.0;
                // un-gamma the ground color to mix in linear space
                fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
              }`:""}
          ${i.screenSizePerspective?v`
            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));
            if (perspectiveScale <= 0.25) {
              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
            }
            else if (perspectiveScale <= 0.5) {
              fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
            }
            else if (perspectiveScale >= 0.99) {
              fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
            }
            else {
              fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
            }`:""}
          ${i.visualizeNormals?i.spherical?v`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:v`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:""}
          ${i.tileBorders?v`
              vec2 dVuv = fwidth(vuv0);
              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
          fragColor = highlightSlice(fragColor, vpos);
        }
      `)}break;case E.Depth:o&&e.include(Bl,i),t.code.add(v`
              void main(void) {
                ${o?v`setOverlayVTC(getUV0());`:""}
                gl_Position = transformPosition(proj, view, position);
              }
          `),s.code.add(v`
              void main() {
                ${o?v`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
              }
          `);break;case E.Shadow:case E.ShadowHighlight:case E.ShadowExcludeHighlight:case E.ViewshedShadow:e.include(eb,i),zR(e),BR(e),t.code.add(v`void main(void) {
gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
}`),s.code.add(v`void main() {
outputDepth(linearDepth);
}`);break;case E.Normal:o&&e.include(Bl,i),r.add("vnormal","vec3"),Nf(t),a(),t.code.add(v`
        void main(void) {
          ${o?v`setOverlayVTC(getUV0());`:""}
          gl_Position = transformPosition(proj, view, position);
          vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);
        }
      `),s.code.add(v`
        void main() {
          ${o?v`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
          vec3 normal = normalize(vnormal);
          if (gl_FrontFacing == false) {
            normal = -normal;
          }
          fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
        }
      `);break;case E.Highlight:n&&e.include(Bl,i),t.code.add(v`
          void main() {
            ${n?v`setOverlayVTC(getUV0());`:""}
            gl_Position = transformPosition(proj, view, position);
          }
        `),e.include(sb,i),s.code.add(v`
          void main() {
            ${n?v`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
            outputHighlight();
          }
        `)}return i.output===E.ObjectAndLayerIdColor&&(n?(e.include(Bl,{...i,pbrMode:Qt.Disabled}),t.code.add(v`void main(void) {
gl_Position = transformPosition(proj, view, position);
setOverlayVTC(getUV0());
}`),s.code.add(v`void main() {
fragColor = getOverlayColorTexel(vtcOverlay);
}`)):(t.code.add(v`void main(void) {
        ${i.opaque?v` gl_Position = transformPosition(proj, view, position);`:""}
      }`),s.code.add(v`void main() {
fragColor = vec4(0.0);
}`))),e}const PI=Qe(),qv=b(),RI=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:Mg,build:Tw},Symbol.toStringTag,{value:"Module"}));let Sw=class Pw extends It{constructor(){super(...arguments),this.useStencil=!1}initializeConfiguration(e,t){t.spherical=e.viewingMode===$e.Global}initializeProgram(e){return new Lt(e.rctx,Pw.shader.get().build(this.configuration),Rw)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(e){const t=this.configuration,s=t.backfaceCullingEnabled&&!t.renderOccluded;return ot({blending:t.renderOccluded?ta(K.ONE,K.ONE_MINUS_SRC_ALPHA):null,culling:s?A1:null,depthTest:t.renderOccluded?null:{func:Xi.LESS},depthWrite:t.renderOccluded?null:D1,colorWrite:ht,stencilTest:e?ZS(Ph.IntegratedMeshMaskExcluded):null,drawBuffers:t.output===E.Depth?{buffers:[M1.NONE]}:null})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}};Sw.shader=new $t(RI,()=>ae(()=>Promise.resolve().then(()=>K5),void 0,import.meta.url));const Rw=new Map([[Te.POSITION,0],[Te.UV0,1],[Te.NORMALCOMPRESSED,2]]);let OI=class{constructor(){this.geometry=new K$,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureRef=new ww(()=>this.tile.surface.fadeDuration),this.overlay=new wI,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new eI,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),zi&&this.tile.intersectsClippingArea)for(let t=0;t<4;++t)N(this.geometry.getEdgeCount(t)===this.geometryState.edgeResolutions[t]+1)}_calculateEdgeResolution(e,t){var l;const s=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!s.surface.isGlobal){const h=s.surface.extent;if(h!=null&&(e===0&&s.extent[3]>h[3]||e===1&&s.extent[2]>h[2]||e===2&&s.extent[1]<h[1]||e===3&&s.extent[0]<h[0]))return r}const a=s.level,n=yr[e];if(!t)return N(((l=s.surface)==null?void 0:l.rootTiles)==null||s.surface.updatingRootTiles||!s.shouldHaveNeighbor(n)),r;if(t.isLoaded){const h=t,d=h.renderData.geometryState,u=a-h.level;if(N(u>=0),u===0){const f=d.numVerticesPerSide-1;return Math.max(f,r)}const m=2**u,_=d.edgeResolutions[(e+2)%4]/m;return Math.max(1,_)}N(!t.isLeaf);let o=r;return t.forAllSubtreeOnSide(N_(n),h=>h===s||(h.isLoaded?(o=Math.max(o,2**(h.level-a)),!0):(N(!h.isLeaf),!1))),o}updateNeighborData(){var n;const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,s=o=>(o.isLoaded||o.level===e.level)&&(o==null?void 0:o.intersectsClippingArea),r=t.edgePeerNeighbors,a=t.edgePeerNeighborSamplerVersions;for(let o=0;o<4;++o){const l=e.findNeighborTile(yr[o],s),h=ro(e,l),d=((n=h==null?void 0:h.renderData)==null?void 0:n.geometryState.samplerDataVersion)??-1,u=r[o],m=h!==ro(e,u),_=a[o]!==d;zi&&l&&(N(e.level>=l.level),N(e.level-l.level<=ti)),r[o]=l,(m||_)&&(a[o]=d,this._markEdgeDirty(o));const f=t.edgeResolutions[o],g=this._calculateEdgeResolution(o,l);N(qh(g)),N(g>=1),t.edgeResolutions[o]=g,f!==g&&this._markEdgeResolutionDirty(o)}for(let o=0;o<4;++o){const l=e.findNeighborTile(eu[o],s);t.cornerPeerNeighbors[o]=l;const h=ro(e,r[o]),d=ro(e,r[(o+1)%4]),u=ro(e,l);rr[o]=u,rr[(o+1)%4]=d,rr[(o+2)%4]=e,rr[(o+3)%4]=h,N(rr.some(g=>(g==null?void 0:g.isLoaded)||g===e));const m=rr.reduce((g,y)=>Math.min(g,(y==null?void 0:y.level)??1/0),1/0);rr.forEach((g,y)=>{g&&(g==null?void 0:g.level)>m&&(rr[y]=null)}),N(rr.some(g=>(g==null?void 0:g.isLoaded)||g===e));const _=t.cornerNeighborCornerTiles,f=t.cornerNeighborCornerTileSamplerVersions;for(let g=0;g<4;++g){const y=rr[g],w=(y==null?void 0:y.renderData.geometryState.samplerDataVersion)??-1,x=4*o+g,T=_[x]!==y,S=!T&&f[x]!==w;(T||S)&&(_[x]=y,f[x]=w,this._markCornerDirty(o))}zi&&N(Eg.some(g=>{var y;return((y=_[4*o+g])==null?void 0:y.isLoaded)||_[4*o+g]===e}))}zi&&N(this.geometryState.edgeResolutions.every(o=>o>0));for(let o=0;o<4;++o)rr[o]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;zi&&N(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every(_=>_>0)),this.intersectionData=null;const{tile:t,_vao:s,geometry:r,geometryState:a}=this,n=!s||!1||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,o=this.dirtyEdgeResolutions!==0,l=a.edgeResolutions.reduce((_,f)=>_+f+1,0),h=n||o&&l>((r==null?void 0:r.maxEdgeVertexCount)??0),d=!h&&o,u=!d&&(this.dirtyEdges!==0||o),m=!u&&this.dirtyCorners!==0;h?(this.releaseGeometry(),this._createGeometry(e)):d?t.updateEdgeElevationsAndResolutions():u||m?t.updateEdgeElevations():m?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=je(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,s){const r=t?_i.RGBA:_i.RGB;return this._texture==null||this._texture.descriptor.width===e&&this._texture.descriptor.pixelFormat===r||this.releaseTexture(),this._texture==null&&(this._texture=s(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture!=null&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}get numVerticesPerSideChanged(){return!!(this._modifiedFlags&EI)}get samplerDataChanged(){return!!(this._modifiedFlags&AI)}get clippingAreaChanged(){return!!(this._modifiedFlags&DI)}get wireframeChanged(){return!!(this._modifiedFlags&$I)}get dirtyEdges(){return this._modifiedFlags>>Zp&15}get dirtyCorners(){return this._modifiedFlags>>Kp&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>Jp&15}_markCornerDirty(e){const t=1<<e<<Kp;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<Zp;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<Jp;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<Kp|15<<Zp|15<<Jp}updateGeometryState(){const e=this._getElevationInfo(),t=this.tile,s=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.getDefaultVerticesPerSide(),r=Math.max(s,5);let a=t.clippingArea;t.intersectsClippingArea&&!t.isWithinClippingArea||(a=null);const n=this.geometryState;let o=!1;n.numVerticesPerSide!==r&&(this._modifiedFlags|=1,n.numVerticesPerSide=r,n.samplerDataVersion++,o=!0),e.changed&&(this._modifiedFlags|=2,n.samplerData=e.samplerData,n.samplerDataVersion++,o=!0),By(n.clippingArea,a)||(this._modifiedFlags=4,n.clippingArea=a,o=!0);const l=t.surface.wireframe;return n.wireframe!==l&&(this._modifiedFlags=8,n.wireframe=l,o=!0),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=o),o&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometry.vertexAttributes,s=this.geometry.indices,r=e.gl;this._vao=new Rn(e,Rw,{geometry:On(t.layout)},{geometry:Ls.createVertex(e,r.STATIC_DRAW,t.buffer)},Ls.createIndex(e,r.STATIC_DRAW,s)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=pn.Immediate){e!=null&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[we.ELEVATION],s=t.length,r=new Array(s);let a=0,n=0,o=!1;for(let d=0;d<s;d++){const u=t[d];if(u.upsampleInfo!=null){const m=u.upsampleInfo.tile,_=m.layerInfo[we.ELEVATION][d].data,f=_&&_.samplerData;e&&e[a]===f||(o=!0),r[a++]=f,n=Math.max(n,m.lij[0])}else if(u.data){const m=this.tile.surface.layerViewByIndex(d,we.ELEVATION);if($h(this.tile,m.layer,!1)){const _=u.data;e&&e[a]===_.samplerData||(o=!0),r[a++]=_.samplerData,n=this.tile.level}}}e!=null&&e.length!==a&&(o=!0);const l=a>0,h=l?r:null;return l&&(r.length=a),{changed:o,samplerData:h,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){var t,s,r;const e=((t=this.intersectionData)==null?void 0:t.estimatedMemoryUsage)??0;return(((s=this.geometry.indices)==null?void 0:s.byteLength)??0)+(((r=this.geometry.vertexAttributes)==null?void 0:r.byteLength)??0)+e}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!zi)return;const e=this.tile;if(!e.isLoaded||!e.intersectsClippingArea||e.level===0)return void N(e==null?void 0:e.isLoaded);const t=e.surface.extent;if(t!=null&&!e.intersectsExtent(t))return;const s=yr.map((o,l)=>t!=null&&(l<2?-1:1)*(e.extent[3-l]-t[3-l])<0),r=e.level;N(this.dirtyCorners===0),N(this.dirtyEdges===0),N(this.dirtyEdgeResolutions===0),N(!this.numVerticesPerSideChanged),N(!this.samplerDataChanged),N(!this.clippingAreaChanged),N(!this.wireframeChanged);const a=eu.map(o=>e.findNeighborCornerTileExact(o,l=>!l.intersectsClippingArea||l.isLoaded||l.level===e.level)??null).map(o=>o!=null&&o.intersectsClippingArea?o:null),n=this.geometryState;for(let o=0;o<4;++o){const l=n.cornerPeerNeighbors[o],h=a[o];N(h===l,`Tile[${e.lij}].corner[${o}] out of date: cur=[${l==null?void 0:l.lij}] exp=[${h==null?void 0:h.lij}]`)}yr.forEach((o,l)=>{if(s[l])return;const h=e.findNeighborTile(o,ge=>(ge.level===r||(ge==null?void 0:ge.isLoaded))&&(ge==null?void 0:ge.intersectsClippingArea));if(!h){const ge=!e.surface.updatingRootTiles&&e.surface.rootTiles!=null&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(o);return void N(!ge)}N(h.isLoaded||h.level===e.level),N(h===this.geometryState.edgePeerNeighbors[l]);const d=r-h.level;if(!h.isLoaded)return N(!h.isLeaf),void N(d===0);const u=h.renderData;N(bI(e,h,o)),N(d>=0);const m=2**d;if(d<0)return void N(!1);const _=e.renderData,f=_.geometry,g=_.localOrigin,y=f.getEdgeCount(l),w=f.numVerticesPerSide-1,x=u.geometry;if(!x)return void N(!1);const T=u.localOrigin,S=this.geometryState.edgePeerNeighbors[l];if(S!=null&&S.isLoaded){const ge=S.renderData;N(_.geometryState.edgePeerNeighborSamplerVersions[l]===ge.geometryState.samplerDataVersion),N(this.geometryState.edgePeerNeighborSamplerVersions[l]===ge.geometryState.samplerDataVersion)}const C=(l+2)%4,P=x.getEdgeCount(C),R=y-1,I=P-1;N(R*m===I,`Tile[${e.lij}]:e${l},res=${R} edgeRes mismatch with Neighbor[${h.lij}]:e${C},res=${I} (expected:${R*m})`);const L=e.extent,G=o===vt.NORTH||o===vt.SOUTH,H=P-1,D=H>>d,J=y-1;if(D<1)return void N(J===1);N(D===J),N(qh(D));const A=x.numVerticesPerSide-1;N(d>0||D===Math.max(A,w));const O=e.getNeighborEdgeStartVertexIndex(l,h);N(0<=O&&O<m);const te=O*D;N(0<=te&&te<=H-D);let $=0,U=te;f.getEdgeVertexPosition(l,Dr,g,0),f.getEdgeVertexPosition(l,$r,g,y-1);const ye=os(Dr,$r),he=Math.max(MI,1e-4*ye);for(let ge=0;ge<=D;++ge){f.getEdgeVertexPosition(l,Dr,g,$),x.getEdgeVertexPosition(C,$r,T,U);const ne=ge/D,de=G?L[0]+ne*(L[2]-L[0]):o===vt.WEST?L[0]:L[2],ce=G?o===vt.SOUTH?L[1]:L[3]:L[1]+ne*(L[3]-L[1]),re=e.surface.extent;if(re==null||yT(re,de,ce)){const Oe=Ch(Dr,$r),Ie=fs(Dr)-Ur.radius,Me=fs($r)-Ur.radius,Ae=Oe<he;if(!Ae){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${l}[${$}/${y}] and [${h.lij}].edge${C}[${U}/${P}]`),re!=null&&console.warn("  surface extent= ",re," x,y=",de,",",ce);const Je=b();be(Je,_.localOrigin,u.localOrigin),fs(Je)>0&&console.warn(`   localOrigins: ${_.localOrigin} vs ${u.localOrigin} d=${fs(Je)} [${Je}]`),(()=>{const k=gn(Dr),We=gn($r);e.updateEdgeElevations(),h.updateEdgeElevations(),f.getEdgeVertexPosition(l,Dr,g,$),x.getEdgeVertexPosition(C,$r,T,U);const B=b();xt(B,Dr,k),fs(B)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${k} vs ${Dr} d=${fs(B)} [${B}]`),xt(B,$r,We),fs(B)>0&&console.warn(`  XXX Neighbor[${h.lij}] edge out of date: ${We} vs ${$r} d=${fs(B)} [${B}]`)})();const Ye=f.getEdgeCount(l),Nt=x.getEdgeCount(P);N(Ae,`Mismatch in tile [${e.lij}].edge[${l}][${$}/${Ye}] vs neighbor [${h.lij}].edge[${C}][${U}/${Nt}] ${la(Dr)} vs ${la($r)}  dist=${Oe} h(t|n|d)=${Ie}|${Me}|${Me-Ie}`)}f.getEdgeNormal(l,qo,$),x.getEdgeNormal(C,zo,U),oe(zv,qo),oe(Bv,zo);const rt=ue(zv,Bv),Xe=1-rt<.01||!1||e===h;if(!Xe){const Je=b();xt(Je,qo,zo);const Ye=()=>`Mismatch in tile edge normal ${Af(e.lij)} (${$}/${y-1}) edge ${l} vs neighbor ${Af(h.lij)}  (${U}/${P-1}) nedge ${C} :${la(qo)} vs ${la(zo)}  dot = ${rt} : ${la(Je)}`;console.warn("Mismatch in tile edge normal: ",Ye());{e.updateEdgeElevations(),h.updateEdgeElevations();const Nt=b(),k=b();f.getEdgeNormal(l,Nt,$),x.getEdgeNormal(C,k,U),Uh(qo,Nt)||console.warn("Missing update in tile normal: ",la(qo)," => ",la(Nt)),Uh(zo,k)||console.warn("Missing update in neighbor normal: ",la(zo)," => ",la(k))}N(Xe,Ye())}}$+=1,U+=1}})}};const Dr=b(),$r=b(),qo=b(),zo=b(),zv=b(),Bv=b(),MI=1,rr=[null,null,null,null];function ro(i,e){return e!=null&&e.isLoaded||e===i?e:null}const EI=1,AI=2,DI=4,$I=8,Zp=4,Kp=8,Jp=12,Eg=[0,1,2,3],II=65536;function LI(i,e){const{tile:t,geometry:s,geometryState:r}=i,{extentInRadians:a,surface:n}=t,{isWebMercator:o,renderer:l}=n,{numVerticesPerSide:h,wireframe:d}=r,u=h-1,m=(h-2)**2,_=o&&(e===qr.HAS_SOUTH_POLE||e===qr.HAS_BOTH_POLES),f=o&&(e===qr.HAS_NORTH_POLE||e===qr.HAS_BOTH_POLES),g=((_?1:0)+(f?1:0))*Vd*h,y=Bw(r),w=m+g+4*y,x=l.tileGeometryCache.acquire(w);s.numVerticesPerSide=h,s.vertexAttributes=x,s.maxEdgeVertexCount=y;const{boundingBox:T}=s;_u(T);const S=Dg(i);bi.update(u,a,S),FI(i),s.poleVerticesStartIndex=m;const C=NI(i,_,f);s.edgeVerticesStartIndex=m+g,Ig(i),Ag(i),Iw(s,C,d),i.intersectionData=null}function NI(i,e,t){const{tile:s,localOrigin:r,geometry:a}=i,{extent:n,ellipsoid:o}=s,{boundingBox:l,numVerticesPerSide:h,vertexAttributes:d,poleVerticesStartIndex:u}=a,m=h-1,_=r[0],f=r[1],g=r[2],y=o.radius,w=n[1],x=n[3],T=[];let S=u;const C=(P,R)=>{const I=R*h;Js(-_,-f,P*y-g,l),T.push(new tL(P===1,I,P===1?0:2,S,Vd));const L=Ew(P===-1?w:x,y),G=P*Math.PI/2-L,H=.99*(P===1?1:-1),D=y+0,{position:J,uv0:A}=d,{typedBuffer:O,typedBufferStride:te}=d.normalCompressed;for(let $=1;$<=Vd;++$){const U=L+G*($/Vd),ye=Math.cos(U),he=Math.sin(U);for(let ge=0;ge<=m;ge++){const ne=ge/m,de=bi.sinLonLUT[ge],ce=bi.cosLonLUT[ge]*ye,re=de*ye,Oe=he,Ie=ce*D-_,Me=re*D-f,Ae=Oe*D-g;Js(Ie,Me,Ae,l),J.setValues(S,Ie,Me,Ae),Cr(A,S,ne,H),Zh(O,S,ce,re,Oe,te),++S}}};return e&&C(-1,0),t&&C(1,m),T}function FI(i){const{tile:e}=i;if(!e.intersectsClippingArea)return;const{geometry:t,geometryState:s,localOrigin:r}=i,{numVerticesPerSide:a,samplerData:n}=s,o=a-2,l=a-1,{vertexAttributes:h,boundingBox:d}=t,u=h.position,m=h.uv0,{typedBuffer:_,typedBufferStride:f}=h.normalCompressed,{extent:g}=e,y=g[0],w=g[2],x=g[1],T=g[3],S=e.ellipsoid.radius,C=r[0],P=r[1],R=r[2],I=u.typedBuffer,L=u.typedBufferStride,G=1/l;let H=0;if(1<=o){const D=G,J=x*(1-D)+T*D,A=bi.sinLatLUT[1],O=bi.cosLatLUT[1];for(let te=1;te<=o;te++){const $=te*G,U=y*(1-$)+w*$,ye=bi.sinLonLUT[te],he=bi.cosLonLUT[te],ge=S+Rt(U,J,n),ne=ge*he*O-C,de=ge*ye*O-P,ce=ge*A-R;Js(ne,de,ce,d);const re=(te-1)*L;I[re]=ne,I[re+1]=de,I[re+2]=ce,Cr(m,te-1,$,D)}}for(let D=1;D<=o;D++){const J=D*G,A=x*(1-J)+T*J,O=bi.sinLatLUT[D],te=bi.cosLatLUT[D],$=D+1,U=$*G,ye=x*(1-U)+T*U,he=bi.sinLatLUT[$],ge=bi.cosLatLUT[$],ne=bi.sinLonLUT[0],de=bi.cosLonLUT[0],ce=S+Rt(y,A,n);let re=de*te*ce-C,Oe=ne*te*ce-P,Ie=O*ce-R;const Me=H*L;let Ae=I[Me],rt=I[Me+1],Xe=I[Me+2];for(let Je=1;Je<=o;Je++){const Ye=Je*G,Nt=y*(1-Ye)+w*Ye,k=bi.sinLonLUT[Je],We=bi.cosLonLUT[Je];let B=0,W=0,pe=0;if(Je<o){const Ne=(H+1)*L;B=I[Ne],W=I[Ne+1],pe=I[Ne+2]}else{const Ne=bi.sinLonLUT[l],bt=bi.cosLonLUT[l],kt=S+Rt(w,A,n);B=bt*te*kt-C,W=Ne*te*kt-P,pe=O*kt-R}const Ce=re,Q=Oe,fe=Ie;re=Ae,Oe=rt,Ie=Xe,Ae=B,rt=W,Xe=pe;const q=B-Ce,ie=W-Q,ve=pe-fe;let lt=0,mt=0,_t=0;if(D>1){const Ne=(H-o)*L;lt=I[Ne],mt=I[Ne+1],_t=I[Ne+2]}else{const Ne=bi.sinLatLUT[0],bt=bi.cosLatLUT[0],kt=S+Rt(Nt,x,n);lt=We*bt*kt-C,mt=k*bt*kt-P,_t=Ne*kt-R}const Ge=S+Rt(Nt,ye,n),Ze=We*ge*Ge-C,Ve=k*ge*Ge-P,ke=he*Ge-R;if(D<o){const Ne=H+o,bt=Ne*L;I[bt]=Ze,I[bt+1]=Ve,I[bt+2]=ke,Js(Ze,Ve,ke,d),Cr(m,Ne,Ye,U)}const qe=lt-Ze,et=mt-Ve,me=_t-ke;let Le=We*te,ze=k*te,at=O;at*at<.999&&(Le=ve*et-ie*me,ze=q*me-ve*qe,at=ie*qe-q*et);const Kt=1/Math.sqrt(Le*Le+ze*ze+at*at);Zh(_,H,Le*Kt,ze*Kt,at*Kt,f),++H}}}function VI(i){i.tile.intersectsClippingArea&&(Ag(i),$l(i),i.intersectionData=null)}function UI(i){i.tile.intersectsClippingArea&&(Fw(i),Ag(i),$l(i),qw(i),i.intersectionData=null)}function qI(i){i.tile.intersectsClippingArea&&(Mw(i),Ow(i,!0),$l(i),i.intersectionData=null)}function Ag(i){i.tile.intersectsClippingArea&&(Mw(i),Ow(i))}function Ow(i,e=!1){const{geometry:t,geometryState:s,tile:r,localOrigin:a}=i,{level:n,extent:o,extentInRadians:l,ellipsoid:h}=r,d=h.radius,u=l[0],m=l[2],_=l[1],f=l[3],{samplerData:g}=s,y=o[0],w=o[2],x=o[1],T=o[3],S=Dg(i),{boundingBox:C,vertexAttributes:P}=t,R=a[0],I=a[1],L=a[2],G=P.position,H=G.typedBuffer,D=G.typedBufferStride,J=P.uv0;for(let A=0;A<4;++A){const O=A===1||A===3,te=s.edgeResolutions[A];N(qh(te));const $=te+1,U=ro(r,s.edgePeerNeighbors[A]);if(zw(r,U,A)){Vw(i,A,U);continue}const ye=U!=null;N(!ye||U.level===r.level),N(!ye||jr(r,U)<=0);const he=U==null?void 0:U.renderData,ge=he==null?void 0:he.geometryState;if(zi){const q=r.surface;if(!U&&q&&!q.updatingRootTiles){const ie=yr[A],ve=r.findNeighborTile(ie,lt=>lt.isLoaded||lt.isLeaf||lt.level===r.level);ve?ve.intersectsClippingArea&&(N(!ve.isLoaded),N(!ve.isLeaf),N(ve.level===n)):N((q==null?void 0:q.rootTiles)==null||!r.shouldHaveNeighbor(ie))}}const ne=A===1?o[2]:o[0],de=U==null?void 0:U.extent,ce=de&&O?A===1?de[0]:de[2]:ne,re=A===0?o[3]:o[1],Oe=A===1?1:0,Ie=A===0?1:0,Me=A===1?m:u,Ae=A===0?f:_,rt=Math.sin(Me),Xe=Math.cos(Me),Je=Math.sin(Ae),Ye=Math.cos(Ae),Nt=ge==null?void 0:ge.samplerData,k=ye?(q,ie,ve)=>.5*(Rt(q,ie,g)+Rt(ve,ie,Nt)):(q,ie,ve)=>Rt(q,ie,g),We=t.outerEdgesOffsetAndLength[2*A+0],B=e&&$>3?$-3:1,W=g!=null&&g.some(q=>q!=null),pe=Nt!=null&&Nt.some(q=>q!=null),Ce=W||pe,Q=1/te,fe=We;N(!de||ks(de[2]-de[0],o[2]-o[0])),(()=>{const q=A===1?-1:A===3?1:0,ie=A===0?-1:A===2?1:0,ve=(o[2]-o[0])*Q,lt=q*ve,mt=ie*ve,_t=O?q*((m-u)*Q):0,Ge=O?0:ie*Q,Ze=Ie,Ve=O?Me+_t:Me,ke=O?Math.sin(Ve):rt,qe=O?Math.cos(Ve):Xe,et=O?Me-_t:Me,me=O?Math.sin(et):rt,Le=O?Math.cos(et):Xe,ze=O?Ae:S(Ze+Ge),at=O?Je:Math.sin(ze),Kt=O?Ye:Math.cos(ze),Ne=O?Ae:S(Ze-Ge),bt=O?Je:Math.sin(Ne),kt=O?Ye:Math.cos(Ne);let Di=0,hs=0,cs=0;{const Ue=0*Q,Pt=O?ne:y*(1-Ue)+w*Ue,di=O?ce:Pt,xi=O?x*(1-Ue)+T*Ue:re,Jt=O?Me:u*(1-Ue)+m*Ue,ds=O?rt:Math.sin(Jt),So=O?Xe:Math.cos(Jt),aa=O?S(Ue):Ae,En=O?Math.sin(aa):Je,na=O?Math.cos(aa):Ye,oa=d+k(Pt,xi,di);Di=So*na*oa,hs=ds*na*oa,cs=En*oa}let $i=0,ai=0,jt=0;{const Ue=1*Q,Pt=O?ne:y*(1-Ue)+w*Ue,di=O?ce:Pt,xi=O?x*(1-Ue)+T*Ue:re,Jt=O?Me:u*(1-Ue)+m*Ue,ds=O?rt:Math.sin(Jt),So=O?Xe:Math.cos(Jt),aa=O?S(Ue):Ae,En=O?Math.sin(aa):Je,na=O?Math.cos(aa):Ye,oa=d+k(Pt,xi,di);$i=So*na*oa,ai=ds*na*oa,jt=En*oa}for(let Ue=1;Ue<$-1;Ue+=B){let Pt=0,di=0,xi=0;{const us=(Ue+1)*Q,Or=O?ne:y*(1-us)+w*us,Va=O?ce:Or,Gi=O?x*(1-us)+T*us:re,Ua=O?Me:u*(1-us)+m*us,Eo=O?rt:Math.sin(Ua),xc=O?Xe:Math.cos(Ua),Nl=O?S(us):Ae,Cc=O?Math.sin(Nl):Je,Fl=O?Math.cos(Nl):Ye,Ao=d+k(Or,Gi,Va);Pt=xc*Fl*Ao,di=Eo*Fl*Ao,xi=Cc*Ao}const Jt=Pt,ds=di,So=xi,aa=$i,En=ai,na=jt;$i=Jt,ai=ds,jt=So;{const us=fe+Ue,Or=us*D,Va=aa-R,Gi=En-I,Ua=na-L;H[Or]=Va,H[Or+1]=Gi,H[Or+2]=Ua,Js(Va,Gi,Ua,C);const Eo=Ue*Q;Cr(J,us,O?Oe:Eo,O?Eo:Ie)}const oa=Di,mC=hs,_C=cs;Di=aa,hs=En,cs=na;const Il=aa,Ll=En,Po=na,wc=1/Math.sqrt(Il*Il+Ll*Ll+Po*Po),Zg=Po*wc;let Ro=0,Oo=0,Mo=0;if(Ce&&Zg*Zg<.999){let us=0,Or=0,Va=0;{const Gi=A===0?-1:1;us=Gi*(Jt-oa),Or=Gi*(ds-mC),Va=Gi*(So-_C)}{const Gi=Ue*Q,Ua=O?ne:y*(1-Gi)+w*Gi,Eo=O?ce:Ua,xc=O?x*(1-Gi)+T*Gi:re,Nl=O?Me:u*(1-Gi)+m*Gi,Cc=O?rt:Math.sin(Nl),Fl=O?Xe:Math.cos(Nl),Ao=O?S(Gi):Ae,Kg=O?Math.sin(Ao):Je,Jg=O?Math.cos(Ao):Ye;let tp=Il,ip=Ll,sp=Po;if(ye){const An=d+Rt(Eo-lt,xc-mt,Nt),Vl=O?Jg:kt;tp=(O?Le:Fl)*Vl*An,ip=(O?me:Cc)*Vl*An,sp=(O?Kg:bt)*An}{const An=d+Rt(Ua+lt,xc+mt,g),Vl=O?Jg:Kt,ef=(O?qe:Fl)*Vl*An,tf=(O?ke:Cc)*Vl*An,sf=(O?Kg:at)*An;ye||(tp=2*Il-ef,ip=2*Ll-tf,sp=2*Po-sf);const rp=A===3?-1:1,rf=rp*(tp-ef),af=rp*(ip-tf),nf=rp*(sp-sf);Ro=Va*af-Or*nf,Oo=us*nf-Va*rf,Mo=Or*rf-us*af;const ap=1/Math.sqrt(Ro*Ro+Oo*Oo+Mo*Mo);Ro*=ap,Oo*=ap,Mo*=ap}}}else Ro=Il*wc,Oo=Ll*wc,Mo=Po*wc;t.setEdgeNormalFromValues(A,Ue,Ro,Oo,Mo)}})()}}function Mw(i){Uw(i)}function Ew(i,e){return Math.PI/2-2*Math.atan(Math.exp(-i/e))}function zI(i,e,t,s){return Ew(i*(1-s)+e*s,t)}function BI(i,e,t){return i*(1-t)+e*t}function Dg(i){const{tile:e}=i;if(e.surface.isWebMercator){const s=e.extent,r=e.ellipsoid.radius;return a=>zI(s[1],s[3],r,a)}const t=e.extentInRadians;return s=>BI(t[1],t[3],s)}function HI(i,e){const{tile:t,geometryState:s,geometry:r}=i,{extent:a,surface:n}=t,{wireframe:o}=s,l=a[0],h=a[1],d=a[2]-l,u=a[3]-h,{numVerticesPerSide:m,clippingArea:_}=s,f=_!=null?Math.max(0,(_[0]-l)/d):0,g=_!=null?Math.max(0,(_[1]-h)/u):0,y=_!=null?Math.min(1,(_[2]-l)/d):1,w=_!=null?Math.min(1,(_[3]-h)/u):1,x=(m-2)**2,T=Bw(s),S=x+4*T,C=n.renderer.tileGeometryCache.acquire(S),{boundingBox:P}=r;_u(P),r.numVerticesPerSide=m,r.vertexAttributes=C,r.maxEdgeVertexCount=T,r.minu=f,r.minv=g,r.maxu=y,r.maxv=w,GI(i),r.edgeVerticesStartIndex=x,Ig(i),$g(i),Iw(r,[],o),i.intersectionData=null}function GI(i){const e=i.tile;if(!e.intersectsClippingArea)return;const{geometry:t,geometryState:s,localOrigin:r}=i,{samplerData:a,clippingArea:n,numVerticesPerSide:o}=s,{surface:l,extent:h,ellipsoid:d}=e,{isWebMercatorOnPlateCarree:u}=l,m=n??Lg,_=h[0],f=h[1],g=h[2],y=h[3],w=Math.max(_,m[0]),x=Math.min(g,m[2]),T=Math.max(f,m[1]),S=Math.min(y,m[3]),C=d.radius,P=e.horizontalScale,R=o-1,I=o-2,{minu:L,minv:G,maxu:H,maxv:D,boundingBox:J,vertexAttributes:A}=t,O=A.position,te=A.uv0,{typedBuffer:$,typedBufferStride:U}=A.normalCompressed,ye=r[0],he=r[1],ge=r[2],ne=O.typedBuffer,de=O.typedBufferStride;let ce=0;const re=Z(f,T,S),Oe=u?(Math.PI/2-2*Math.atan(Math.exp(-re/C)))*C:re*P,Ie=1/R,Me=Z(f*(1-Ie)+y*Ie,T,S);let Ae=Oe,rt=u?(Math.PI/2-2*Math.atan(Math.exp(-Me/C)))*C:Me*P;for(let Xe=1;Xe<=I;Xe++){const Je=Xe/R,Ye=Z(f*(1-Je)+y*Je,T,S),Nt=Z(Je,G,D),k=rt,We=(Xe-1)/R,B=Z(f*(1-We)+y*We,T,S),W=Ae,pe=(Xe+1)/R,Ce=Z(f*(1-pe)+y*pe,T,S),Q=u?(Math.PI/2-2*Math.atan(Math.exp(-Ce/C)))*C:Ce*P,fe=Z(pe,G,D);Ae=rt,rt=Q;const q=Z(_,w,x);let ie=q*P,ve=Rt(q,Ye,a);const lt=1/R,mt=Z(lt,L,H),_t=Z(_*(1-mt)+g*mt,w,x);let Ge=mt,Ze=_t,Ve=_t*P,ke=Rt(_t,Ye,a);if(Xe===1){const qe=Ve-ye,et=Ae-he,me=ke-ge,Le=0*de;ne[Le]=qe,ne[Le+1]=et,ne[Le+2]=me,Js(qe,et,me,J);const ze=Z(lt,L,H);Cr(te,ce,ze,Nt)}for(let qe=1;qe<=I;qe++){const et=Ve,me=ke,Le=(qe+1)/R,ze=Z(Le,L,H),at=Z(_*(1-Le)+g*Le,w,x),Kt=Ze;Ze=at;{const ai=ce+1,jt=ai*de;if(Xe===1||qe===I){const Ue=at*P,Pt=Rt(at,Ye,a);if(Xe===1&&qe<I){const di=Ue-ye,xi=k-he,Jt=Pt-ge;ne[jt]=di,ne[jt+1]=xi,ne[jt+2]=Jt,Js(di,xi,Jt,J),Cr(te,ai,ze,Nt)}Ve=Ue,ke=Pt}else Ve=ne[jt]+ye,ke=ne[jt+2]+ge}const Ne=Ve,bt=ke,kt=ie,Di=ve;ie=et,ve=me;const hs=(ce-I)*de,cs=Xe===1?Rt(Kt,B,a):ne[hs+2]+ge,$i=Rt(Kt,Ce,a);if(Xe<I){const ai=ce+I,jt=ai*de,Ue=et-ye,Pt=Q-he,di=$i-ge;ne[jt]=Ue,ne[jt+1]=Pt,ne[jt+2]=di,Js(Ue,Pt,di,J);const xi=Ge;Ge=ze,Cr(te,ai,xi,fe)}{const ai=Ne-kt,jt=W-Q,Ue=jt*(bt-Di),Pt=ai*(cs-$i),di=-jt*ai,xi=Ue*Ue+Pt*Pt+di*di;if(xi===0)Zh($,ce,0,0,1,U);else{const Jt=1/Math.sqrt(xi);Zh($,ce,Ue*Jt,Pt*Jt,di*Jt,U)}}++ce}}}function kI(i,e){i.tile.intersectsClippingArea&&(Dw(i),Aw(i,!0),$l(i),i.intersectionData=null)}function jI(i,e){i.tile.intersectsClippingArea&&(Fw(i),$g(i),$l(i),qw(i),i.intersectionData=null)}function WI(i,e){i.tile.intersectsClippingArea&&($g(i),$l(i),i.intersectionData=null)}function $g(i,e){i.tile.intersectsClippingArea&&(Dw(i),Aw(i,!1))}function Aw(i,e){const{geometry:t,geometryState:s,localOrigin:r}=i,a=i.tile,{surface:n,extent:o}=a,{clippingArea:l,samplerData:h}=s,d=l??Lg,u=o[0],m=o[2],_=o[1],f=o[3],g=[f>d[3],m>d[2],_<d[1],u<d[0]],y=a.horizontalScale,w=$w(n.isWebMercatorOnPlateCarree,a.ellipsoid.radius,y),{minu:x,minv:T,maxu:S,maxv:C,boundingBox:P}=t,R=Math.max(u,d[0]),I=Math.min(m,d[2]),L=Math.max(_,d[1]),G=Math.min(f,d[3]),H=r[0],D=r[1],J=r[2];for(let A=0;A<4;++A){const O=A===1||A===3,te=s.edgeResolutions[A];N(qh(te));const $=te+1,U=g[A],ye=ro(a,s.edgePeerNeighbors[A]);if(!U&&zw(a,ye,A)){Vw(i,A,ye);continue}const he=ye!=null&&!U,ge=ye==null?void 0:ye.renderData,ne=ge==null?void 0:ge.geometryState;if(zi&&(N(!he||ye.level===a.level),N(!he||jr(a,ye)<=0),a&&!ye&&!n.updatingRootTiles)){const Q=yr[A],fe=a.findNeighborTile(Q,q=>q.isLoaded||q.isLeaf||q.level===a.level);n.updatingRootTiles||(fe?fe.intersectsClippingArea&&(N(!fe.isLoaded),N(!fe.isLeaf),N(fe.level===a.level)):N((n==null?void 0:n.rootTiles)==null||!a.shouldHaveNeighbor(Q)))}const de=Z(A===1?m:u,R,I),ce=Z(A===0?f:_,L,G),re=ne==null?void 0:ne.samplerData,Oe=e&&$>3?$-3:1,Ie=Z(A===1?1:0,x,S),Me=Z(A===0?1:0,T,C),Ae=he?(Q,fe)=>.5*(Rt(Q,fe,re)+Rt(Q,fe,h)):(Q,fe)=>Rt(Q,fe,h),rt=(m-u)/te,Xe=O?A===1?rt:-rt:0,Je=O?0:A===0?rt:-rt,Ye=-Xe,Nt=-Je;let k=0,We=0,B=0;{const Q=0/te,fe=O?de:Z(u*(1-Q)+m*Q,R,I),q=O?Z(_*(1-Q)+f*Q,L,G):ce,ie=Ae(fe,q);k=fe*y,We=w(q),B=ie}let W=0,pe=0,Ce=0;{const Q=1/te,fe=O?de:Z(u*(1-Q)+m*Q,R,I),q=O?Z(_*(1-Q)+f*Q,L,G):ce,ie=Ae(fe,q);W=fe*y,pe=w(q),Ce=ie}for(let Q=1;Q<$-1;Q+=Oe){const fe=Q/te,q=W,ie=pe,ve=Ce;{const me=O?Ie:Z(fe,x,S),Le=O?Z(fe,T,C):Me,ze=q-H,at=ie-D,Kt=ve-J;Js(q,at,Kt,P),t.setEdgeVertexFromValuesRawPositionUV(A,Q,ze,at,Kt,me,Le)}{const me=(Q+1)/te,Le=O?de:Z(u*(1-me)+m*me,R,I),ze=O?Z(_*(1-me)+f*me,L,G):ce,at=Ae(Le,ze);W=Le*y,pe=w(ze),Ce=at}const lt=W,mt=Ce,_t=k,Ge=We,Ze=B;k=q,We=ie,B=ve;let Ve=0,ke=0,qe=0;if(O){const me=pe-ie,Le=mt-ve,ze=Ge-ie,at=Ze-ve,Kt=Z(_*(1-fe)+f*fe,L,G),Ne=de+Ye,bt=Ne*y-q,kt=Rt(Ne,Kt,h)-ve,Di=A===3?-1:1;if(Ve=Di*(-ze+me)*kt,ke=Di*bt*(-at+Le),qe=-Di*bt*(-ze+me),he){const hs=de+Xe,cs=hs*y-q;Ve=(-ze+me)*(kt-(Rt(hs,Kt,re)-ve)),ke=(bt-cs)*(-at+Le),qe=-(bt-cs)*(-ze+me)}}else{const me=lt-q,Le=mt-ve,ze=_t-q,at=Ze-ve,Kt=Z(u*(1-fe)+m*fe,R,I),Ne=ce+Nt,bt=Rt(Kt,Ne,h)-ve,kt=w(Ne)-ie,Di=A===2?-1:1;if(Ve=Di*kt*(-at+Le),ke=Di*(-ze+me)*bt,qe=-Di*kt*(-ze+me),he){const hs=Kt,cs=ce+Je,$i=w(cs)-ie;Ve=(-kt+$i)*(-at+Le),ke=(-ze+me)*(-bt+(Rt(hs,cs,re)-ve)),qe=-(-kt+$i)*(-ze+me)}}const et=1/Math.sqrt(Ve*Ve+ke*ke+qe*qe);t.setEdgeNormalFromValues(A,Q,Ve*et,ke*et,qe*et)}}}function Dw(i,e){Uw(i)}function QI(i,e){return(Math.PI/2-2*Math.atan(Math.exp(-i/e)))*e}function XI(i,e){return i*e}function $w(i,e,t){return i?s=>QI(s,e):s=>XI(s,t)}function Iw(i,e,t){const{numVerticesPerSide:s,vertexAttributes:r,maxEdgeVertexCount:a}=i,n=s-1,o=r.count,l=2*(s-3)*(s-3),h=4*(n+a-3),d=Eg.reduce((g,y)=>g+(n+i.getEdgeCount(y)-3),0),u=e.reduce((g,y)=>g+n*(2*(y.latitudeResolution-1)+1),0),m=3*(t?2:1),_=(l+h+u)*m,f=o>=II?new Uint32Array(_):new Uint16Array(_);for(let g=0;g<_;++g)f[g]=0;i.indices=f,i.indexCount=(l+d+u)*m,i.poleIndicesStartIndex=l*m,i.edgeIndicesStartIndex=(l+u)*m,t?(KI(i),JI(i,e),Nw(i)):(YI(i),ZI(i,e),Lw(i))}function YI(i){const{numVerticesPerSide:e,indices:t,vertexAttributes:s}=i,{position:r}=s,{typedBuffer:a,typedBufferStride:n}=r,o=e-2,l=e-3,h=0,d=e-3;let u=0;for(let m=0;m<l;++m){const _=m*o;for(let f=h;f<d;++f){const g=_+f,y=g+1,w=y+o,x=w-1;Hw(g,y,w,x,n,a)?(t[u]=g,t[u+1]=y,t[u+2]=w,t[u+3]=w,t[u+4]=x,t[u+5]=g):(t[u]=g,t[u+1]=y,t[u+2]=x,t[u+3]=x,t[u+4]=y,t[u+5]=w),u+=6}}}function ZI(i,e){const{numVerticesPerSide:t,indices:s,poleIndicesStartIndex:r}=i,a=t-1;let n=r;for(const o of e){const l=o.isNorth?1:2,h=o.isNorth?2:1,d=o.isNorth?3:4,u=o.isNorth?4:3;let m=i.getEdgeVertexIndex(o.connectedOuterEdgeOffset,0),_=1;for(let f=0;f<o.latitudeResolution;++f){const g=f===0?o.rowOffset:m+t;for(let y=0;y<a;y++){const w=g+y;s[n]=m,s[n+l]=m+1,s[n+h]=w,f<o.latitudeResolution-1?(s[n+d]=m+1,s[n+u]=w+1,s[n+5]=w,n+=6):n+=3,m+=_}m=g,_=1}}}function Lw(i){const{indices:e,numVerticesPerSide:t,edgeIndicesStartIndex:s}=i,r=t-1,a=r-2;let n=s;for(let o=0;o<4;++o){const l=Ng[o];let h=0,d=0;const u=i.getEdgeCount(o),m=l.count;N(m===r-1);const _=o===1||o===2,f=_?1:2,g=_?2:1,y=i.getEdgeFirstVertexIndex(o),w=1,x=l.vertex0Index,T=l.stride;for(;h<u-1||d<m-1;){const S=x+d*T,C=y+h*w,P=h<u-1,R=d<m-1,I=P&&(!R||(P?0+r*(h+.5)/(u-1):0)<=(R?1+a*(d+.5)/(m-1):0));I?++h:++d;const L=I?C+w:S+T;e[n]=S,e[n+f]=C,e[n+g]=L,n+=3}}i.indexCount=n}function KI(i){const{indices:e,numVerticesPerSide:t,vertexAttributes:s}=i,{position:r}=s,{typedBuffer:a,typedBufferStride:n}=r,o=t-2;let l=0;for(let h=0;h<t-3;++h){const d=h*o;for(let u=0;u<t-3;++u){const m=h*o+u,_=m+1,f=_+o,g=f-1,y=d+u,w=y+1,x=w+o;Hw(y,w,x,x-1,n,a)?(dl(e,l,m,_,f),l+=6,dl(e,l,f,g,m)):(dl(e,l,m,_,g),l+=6,dl(e,l,g,f,_)),l+=6}}}function JI(i,e){const{indices:t,numVerticesPerSide:s,poleIndicesStartIndex:r}=i,a=s-1;let n=r;for(const o of e){const l=o.connectedOuterEdgeOffset;let h=i.getEdgeVertexIndex(l,0),d=1;for(let u=0;u<o.latitudeResolution;++u){const m=u===0?o.rowOffset:h+s;for(let _=0;_<a;_++)dl(t,n,h,h+1,m+_),n+=6,u<o.latitudeResolution-1&&(dl(t,n,h+1,m+_+1,m+_),n+=6),h+=d;h=m,d=1}}}function Nw(i){const{indices:e,numVerticesPerSide:t,edgeIndicesStartIndex:s}=i,r=t-1,a=r-2;let n=s;for(let o=0;o<4;++o){const l=Ng[o];let h=0,d=0;const u=i.getEdgeCount(o),m=l.count;N(m===r-1);const _=o===1||o===2,f=_?1:3,g=_?3:1,y=i.getEdgeFirstVertexIndex(o),w=1,x=l.vertex0Index,T=l.stride;for(;h<u-1||d<m-1;){const S=x+d*T,C=y+h*w,P=h<u-1,R=d<m-1,I=P&&(!R||(P?0+r*(h+.5)/(u-1):0)<=(R?1+a*(d+.5)/(m-1):0));I?++h:++d;const L=I?C+w:S+T;e[n]=S,e[n+f]=C,e[n+f+1]=C,e[n+g]=L,e[n+g+1]=L,e[n+5]=S,n+=6}}i.indexCount=n}function Ig(i){const{geometry:e,geometryState:t}=i,{edgeResolutions:s}=t,{numVerticesPerSide:r,edgeVerticesStartIndex:a}=e,n=r-2;let o=a;for(let l=0;l<4;++l){{const h=l===0||l===2,d=(l===0?n-1:0)*n+(l===1?n-1:0),u=(h?0:1)*n+(h?1:0),m=Ng[l];m.vertex0Index=d,m.stride=u,m.count=n}{const h=s[l]+1;e.outerEdgesOffsetAndLength[2*l+0]=o,e.outerEdgesOffsetAndLength[2*l+1]=h,o+=h}}}function Fw(i){Ig(i),i.geometryState.wireframe?Nw(i.geometry):Lw(i.geometry)}function Vw(i,e,t){const{geometryState:s,geometry:r,tile:a,localOrigin:n}=i,o=e===1||e===3,l=s.edgeResolutions[e];N(qh(l));const h=l+1,{boundingBox:d,minu:u,minv:m,maxu:_,maxv:f,vertexAttributes:g}=r,y=Z(e===1?1:0,u,_),w=Z(e===0?1:0,m,f),x=t.renderData,T=x.geometryState,S=x.geometry,C=(e+2)%4,P=S.getEdgeCount(C),R=a.getNeighborEdgeStartVertexIndex(e,t)*l,I=l*2**(a.level-t.level);N(T.edgeResolutions[C]===I),N(P-1===I);const L=x.localOrigin[0]-n[0],G=x.localOrigin[1]-n[1],H=x.localOrigin[2]-n[2],D=r.getEdgeFirstVertexIndex(e),J=g.position,A=J.typedBuffer,O=J.typedBufferStride,te=g.normalCompressed,$=te.typedBuffer,U=te.typedBufferStride,ye=g.uv0,he=S.vertexAttributes,ge=S.getEdgeFirstVertexIndex(C),ne=he.position.typedBuffer,de=he.position.typedBufferStride,ce=he.normalCompressed.typedBuffer,re=he.normalCompressed.typedBufferStride;for(let Oe=1;Oe<h-1;++Oe){const Ie=D+Oe,Me=ge+(R+Oe),Ae=Ie*O,rt=Me*de,Xe=ne[rt]+L,Je=ne[rt+1]+G,Ye=ne[rt+2]+H;A[Ae]=Xe,A[Ae+1]=Je,A[Ae+2]=Ye,Js(Xe,Je,Ye,d);const Nt=Ie*U,k=Me*re;$[Nt]=ce[k],$[Nt+1]=ce[k+1];const We=Oe/l,B=o?y:Z(We,u,_),W=o?Z(We,m,f):w;Cr(ye,Ie,B,W)}}function Uw(i){var Nt;const{geometry:e,geometryState:t,localOrigin:s}=i,{clippingArea:r,samplerData:a}=t,{minu:n,minv:o,maxu:l,maxv:h,boundingBox:d,vertexAttributes:u}=e,m=i.tile,{surface:_,ellipsoid:f,extent:g,extentInRadians:y,horizontalScale:w}=m,x=((Nt=_.view)==null?void 0:Nt.viewingMode)==="local",T=f.radius;let S=0,C=0,P=0;const R=(k,We,B)=>{const W=y[We===0?1:3],pe=y[k===0?0:2],Ce=Math.cos(W),Q=Math.sin(W),fe=Math.sin(pe),q=Math.cos(pe),ie=T+B;S=q*Ce*ie,C=fe*Ce*ie,P=Q*ie},I=x?(()=>{const k=r,We=k!=null&&(g[3]>k[3]||g[2]>k[2]||g[1]<k[1]||g[0]<k[0]),B=$w(_.isWebMercatorOnPlateCarree,T,w);return(W,pe,Ce)=>{const Q=W===0?g[0]:g[2],fe=pe===0?g[1]:g[3],q=We?Z(Q,k[0],k[2]):Q,ie=We?Z(fe,k[1],k[3]):fe,ve=Ce;S=q*w,C=B(ie),P=ve}})():R;let L=0,G=0,H=0,D=0,J=0,A=0,O=0,te=0,$=0;const U=x&&_.isWebMercatorOnPlateCarree,ye=(k,We,B,W,pe)=>{let Ce=0,Q=0,fe=0;if(x){const q=We*w,ie=U?(Math.PI/2-2*Math.atan(Math.exp(-B/T)))*T:B*w;Ce=q-S,Q=ie-C,fe=W-P}else{const q=Dg(k),ie=k.tile,ve=ie.extent,lt=ie.extentInRadians,mt=(We-ve[0])/(ve[2]-ve[0]),_t=(B-ve[1])/(ve[3]-ve[1]),Ge=lt[0]*(1-mt)+lt[2]*mt,Ze=q(_t),Ve=Math.cos(Ze),ke=Math.sin(Ze),qe=Math.sin(Ge),et=Math.cos(Ge),me=T+W;Ce=et*Ve*me-S,Q=qe*Ve*me-C,fe=ke*me-P}switch(pe){case 0:O+=Ce,te+=Q,$+=fe;break;case 1:D-=Ce,J-=Q,A-=fe;break;case 2:O-=Ce,te-=Q,$-=fe;break;case 3:D+=Ce,J+=Q,A+=fe}},he=r??Lg,ge=g[0],ne=g[2],de=g[1],ce=g[3],re=[ce>he[3],ne>he[2],de<he[1],ge<he[0]],Oe=Math.max(ge,he[0]),Ie=Math.min(ne,he[2]),Me=Math.max(de,he[1]),Ae=Math.min(ce,he[3]),rt=k=>Math.max(he[0],Math.min(he[2],k)),Xe=k=>Math.max(he[1],Math.min(he[3],k)),Je=k=>{const We=t.cornerNeighborCornerTiles;L=0,G=0,H=1,D=0,J=0,A=0,O=0,te=0,$=0;let B=1/0;for(let q=0;q<4;++q){const ie=We[4*k+q];B=Math.min(B,(ie==null?void 0:ie.level)??1/0)}for(let q=0;q<4;++q){const ie=We[4*k+q];eh[q]=(ie==null?void 0:ie.level)===B?ie:null}let W=1,pe=0;for(let q=0;q<4;++q){const ie=eh[q];ie&&(W=Math.max(W,ie==null?void 0:ie.renderData.geometryState.numVerticesPerSide),pe=ie.extent[2]-ie.extent[0])}const Ce=pe,Q=W;N(Q>1);const fe=Ce/Q;for(let q=0;q<4;++q){const ie=eh[(q+3)%4],ve=eh[q%4];if(!ie&&!ve)continue;const lt=q===0?1:q===1?2:q===2?3:0,mt=q===0?2:q===1?3:q===2?0:1;if(ie&&ve){const _t=em[q][0]*fe,Ge=em[q][1]*fe,Ze=ie.extent,Ve=rt(Ze[lt===0||lt===1?2:0]+_t),ke=Xe(Ze[lt===0||lt===3?3:1]+Ge),qe=ve.extent,et=rt(qe[mt===0||mt===1?2:0]+_t),me=Xe(qe[mt===0||mt===3?3:1]+Ge),Le=ie.renderData,ze=ve.renderData,at=Rt(Ve,ke,Le.geometryState.samplerData),Kt=Rt(et,me,ze.geometryState.samplerData);ye(Le,Ve,ke,.5*(at+Kt),q)}else{const _t=ie??ve,Ge=ie?lt:mt,Ze=_t.extent,Ve=em[q],ke=rt(Ze[Ge===0||Ge===1?2:0]+Ve[0]*fe),qe=Xe(Ze[Ge===0||Ge===3?3:1]+Ve[1]*fe),et=_t.renderData,me=Rt(ke,qe,et.geometryState.samplerData);ye(et,ke,qe,me,q)}}if(!x){const q=Math.sqrt(S*S+C*C+P*P);L=S/q,G=C/q,H=P/q}if(x||H*H<.999){const q=Math.sqrt(D*D+J*J+A*A);D/=q,J/=q,A/=q;const ie=Math.sqrt(O*O+te*te+$*$);O/=ie,te/=ie,$/=ie,L=A*te-J*$,G=D*$-A*O,H=J*O-D*te;const ve=1/Math.sqrt(L*L+G*G+H*H);L*=ve,G*=ve,H*=ve}},Ye=t.cornerNeighborCornerTiles;for(let k=0;k<4;++k){const We=k,B=(k+1)%4,W=k===0||k===1?1:0,pe=k===0||k===3?1:0,Ce=Z(W,n,l),Q=Z(pe,o,h),fe=e.getEdgeFirstVertexIndex(We),q=e.getEdgeCount(We),ie=k===0||k===3?q-1:0,ve=e.getEdgeFirstVertexIndex(B),lt=e.getEdgeCount(B),mt=k===0||k===1?lt-1:0;let _t=-1;for(let Ve=0;Ve<4;++Ve){const ke=Ye[4*k+Ve],qe=Ye[4*k+_t];ke&&(_t===-1||jr(qe,ke)>0)&&(_t=Ve)}const Ge=_t,Ze=Ye[4*k+Ge];if(Ze!==m){const Ve=m.level-Ze.level,ke=2**Ve,qe=[Ze.lij[0]+Ve,Ze.lij[1]*ke,Ze.lij[2]*ke],et=[qe[1]+ke===m.lij[1],k===0&&(Ge===1||Ge===0&&Ze!==Ye[4*k+3])||k===1&&(Ge===0||Ge===1&&Ze!==Ye[4*k+2]),qe[1]===m.lij[1]+1,k===2&&(Ge===3||Ge===2&&Ze!==Ye[4*k+1])||k===3&&(Ge===2||Ge===3&&Ze!==Ye[4*k+0])],me=et.reduce((Ne,bt)=>Ne+(bt?1:0),0);N(me===1||me===2);let Le=-1,ze=-1;const at=Ze.renderData;if(me===1){const Ne=et.findIndex(kt=>kt);N(0<=Ne&&Ne<=3),Le=(Ne+2)%4;const bt=t.edgeResolutions[Ne];ze=m.getNeighborEdgeStartVertexIndex(Ne,Ze)*bt+bt*(Ne===0&&k===0||Ne===1&&k===0||Ne===2&&k===1||Ne===3&&k===3?1:0)}else{N(et[1]||et[3]),Le=et[1]?3:1;const Ne=at.geometryState.edgeResolutions[Le];ze=k===0||k===3?0:Ne}const Kt=at.geometry;{const Ne=fe+ie,bt=ve+mt,kt=Kt.getEdgeFirstVertexIndex(Le)+ze,Di=Kt.vertexAttributes,hs=at.localOrigin;{const $i=Di.position,ai=$i.typedBuffer,jt=kt*$i.typedBufferStride,Ue=ai[jt]+hs[0]-s[0],Pt=ai[jt+1]+hs[1]-s[1],di=ai[jt+2]+hs[2]-s[2];Js(Ue,Pt,di,d);const xi=u.position,Jt=xi.typedBuffer;{const ds=Ne*xi.typedBufferStride;Jt[ds]=Ue,Jt[ds+1]=Pt,Jt[ds+2]=di}{const ds=bt*xi.typedBufferStride;Jt[ds]=Ue,Jt[ds+1]=Pt,Jt[ds+2]=di}}const cs=u.uv0;Cr(cs,Ne,Ce,Q),Cr(cs,bt,Ce,Q);{const $i=Di.normalCompressed.typedBuffer,ai=kt*Di.normalCompressed.typedBufferStride,jt=u.normalCompressed,Ue=jt.typedBuffer;{const Pt=Ne*jt.typedBufferStride;Ue[Pt]=$i[ai],Ue[Pt+1]=$i[ai+1]}{const Pt=bt*jt.typedBufferStride;Ue[Pt]=$i[ai],Ue[Pt+1]=$i[ai+1]}}}}else{const Ve=re[We],ke=re[B];let qe;if(Ve||ke){const ze=Z(ge*(1-W)+ne*W,Oe,Ie),at=Z(de*(1-pe)+ce*pe,Me,Ae);qe=Rt(ze,at,a)}else qe=eL(Ye,k);I(W,pe,qe),Je(k);const et=S-s[0],me=C-s[1],Le=P-s[2];Js(et,me,Le,d),e.setEdgeVertexFromValuesRawPositionUVNormal(We,ie,et,me,Le,Ce,Q,L,G,H),e.setEdgeVertexFromValuesRawPositionUVNormal(B,mt,et,me,Le,Ce,Q,L,G,H)}}for(let k=0;k<4;++k)eh[k]=null}function eL(i,e){var o,l;const t=4*e,s=Eg.reduce((h,d)=>{var u;return Math.min(h,((u=i[t+d])==null?void 0:u.level)??1/0)},1/0);zi&&(N(!i[t+0]||!i[t+2]||__(i[t+0],i[t+2],vt.SOUTH_WEST)),N(!i[t+1]||!i[t+3]||__(i[t+1],i[t+3],vt.NORTH_WEST)));let r=0,a=0;for(let h=0;h<4;++h){const d=i[t+h];if(d&&d.level===s){const u=h===0||h===1,m=h===0||h===3,_=d.extent,f=_[u?0:2],g=_[m?1:3],y=(l=(o=d.renderData)==null?void 0:o.geometryState)==null?void 0:l.samplerData;a+=Rt(f,g,y),r++}}const n=r?a/r:0;return N(n!=null),n}function $l(i){const{vao:e,geometry:t}=i,{vertexAttributes:s,edgeVerticesStartIndex:r}=t,a=s.position.typedBuffer;e.vertexBuffers.geometry.setSubData(a,r,r,a.length)}function qw(i){const{vao:e,geometry:t}=i,{indices:s,indexCount:r,edgeIndicesStartIndex:a}=t;e.indexBuffer.setSubData(s,a,a,r)}let tL=class{constructor(e,t,s,r,a){this.isNorth=e,this.connectedRowOffset=t,this.connectedOuterEdgeOffset=s,this.rowOffset=r,this.latitudeResolution=a}};const em=[[0,1],[1,0],[0,-1],[-1,0]],bi=new J$,Lg=Jy(-1/0,-1/0,1/0,1/0),eh=[null,null,null,null];function zw(i,e,t){if(!e)return!1;const s=jr(i,e);return s>0||s===0&&t>=2}let ld=class{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return N(0<=e&&e<this.count),this.vertex0Index+this.stride*e}};const Ng=[new ld,new ld,new ld,new ld];function Js(i,e,t,s){i<s[0]?s[0]=i:i>s[3]&&(s[3]=i),e<s[1]?s[1]=e:e>s[4]&&(s[4]=e),t<s[2]?s[2]=t:t>s[5]&&(s[5]=t)}function Bw(i){const{edgeResolutions:e,numVerticesPerSide:t}=i,s=1+Math.max(...e);return Math.max(t,s)}function Hw(i,e,t,s,r,a){const n=i*r,o=a[n],l=a[n+1],h=a[n+2],d=e*r,u=a[d],m=a[d+1],_=a[d+2],f=t*r,g=a[f],y=a[f+1],w=a[f+2],x=s*r,T=a[x],S=a[x+1],C=a[x+2];return(u-T)*(u-T)+(m-S)*(m-S)+(_-C)*(_-C)>(o-g)*(o-g)+(l-y)*(l-y)+(h-w)*(h-w)}function dl(i,e,t,s,r){i[e]=t,i[e+1]=s,i[e+2]=s,i[e+3]=r,i[e+4]=r,i[e+5]=t}const Vd=6;let iL=class extends Sg{constructor(e,t,s,r,a){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=hi(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,s,r,a)}init(e,t,s,r,a){super.init(e,t,s,r,a);const n=a.view.renderSpatialReference,o=a.spatialReference,l=n!=null&&d1(n)&&o!=null&&o.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=l;const{isWebMercatorOnPlateCarree:h}=a,d=this._extentInRenderSR,u=this.extent;if(h){const m=St(u[0],u[1],0);Yh(m,pi.WebMercator,m,pi.PlateCarree);const _=St(u[2],u[3],0);Yh(_,pi.WebMercator,_,pi.PlateCarree),d[0]=m[0],d[1]=m[1],d[2]=_[0],d[3]=_[1]}else for(let m=0;m<4;++m)d[m]=u[m]*l;this.centerAtSeaLevel[0]=.5*(d[0]+d[2]),this.centerAtSeaLevel[1]=.5*(d[1]+d[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(d[2]-d[0],d[3]-d[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),s=.5*(e[3]-e[1]),r=Math.sqrt(t*t+s*s),a=.5*(this.elevationBoundsMax-this.elevationBoundsMin),n=Math.max(r,a);this._center[Wt.MIDDLE][3]=n}_calculateFrustumVisibilityStatus(e){const t=this._aabb(),s=t[0],r=t[1],a=t[2],n=t[3],o=t[4],l=t[5];let h=!0;for(let d=0;d<6;d++){const u=e[d],m=u[0],_=u[1],f=u[2],g=u[3];if(m*(m>0?s:n)+_*(_>0?r:o)+f*(f>0?a:l)+g>=0)return Ui.OUTSIDE;h=h&&m*(m<0?s:n)+_*(_<0?r:o)+f*(f<0?a:l)+g<=0}return h?Ui.INSIDE:Ui.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return Q2(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,s,r){return hd[0]=1/t[0],hd[1]=1/t[1],hd[2]=1/t[2],ab(this._aabb(),e,hd,s,r)}createGeometry(){HI(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,s=this.renderData;let r=e,a=t;if(s){const n=s.geometry.boundingBox;r=n[2],a=n[5]}else if(!this.isLeaf){r=1/0,a=-1/0;for(const n of this.children)r=Math.min(r,n._subtreeGeometryElevationBoundMin),a=Math.max(a,n._subtreeGeometryElevationBoundMax)}if(r!==this._subtreeGeometryElevationBoundMin||a!==this._subtreeGeometryElevationBoundMax){this._subtreeGeometryElevationBoundMin=r,this._subtreeGeometryElevationBoundMax=a;const n=this.parent;n==null||n._updateSubtreeGeometryElevationsBounds()}}getDefaultVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){kI(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){WI(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){jI(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}};const hd=b();let sL=class{constructor(){this.extent=mi(),this.minLevel=0,this.maxLevel=0,this.callback=null}},Ud=class extends Re{constructor(){super(...arguments),this._queries=new Gt({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new Gt({initialSize:30}),this._queryPool=new _n(sL)}queryVisibleLevelRange(e,t,s,r){const a=this._queryPool.acquire();F_(a.extent,e),a.minLevel=t??-Number.MAX_VALUE,a.maxLevel=s??Number.MAX_VALUE,a.callback=r,this._queryQueue.push(a),this.notifyChange("updating")}get updating(){return this._queryQueue.length!==0}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let s=0;for(;s<this._queriesInvPtr;){const r=this._queries.data[s],a=r.extent;t>=r.minLevel&&t<=r.maxLevel&&a[0]<=e.extent[2]&&a[2]>=e.extent[0]&&a[1]<=e.extent[3]&&a[3]>=e.extent[1]?(this._queries.swapElements(s,this._queriesInvPtr-1),this._queriesInvPtr--):s++}}};c([p()],Ud.prototype,"updating",null),Ud=c([F("esri.views.3d.terrain.ScaleRangeQueries")],Ud);function rL(i,e,t,s){const r=Math.cos(t);i[0]=Math.cos(e)*r*s,i[1]=Math.sin(e)*r*s,i[2]=Math.sin(t)*s}let aL=class extends Sg{constructor(e,t,s,r,a){super(),this._convexHull=new Array(24),this._boundingSphere=Sr(),this._baseUsedMemory=1816,this.init(e,t,s,r,a)}init(e,t,s,r,a){super.init(e,t,s,r,a);const n=this.ellipsoid.radius,o=this.extentInRadians[0],l=this.extentInRadians[1],h=this.extentInRadians[2],d=this.extentInRadians[3],u=Be(l,d,.5),m=Be(o,h,.5),_=e===0?0:Math.min(Math.abs(l),Math.abs(d));this._edgeLen=(h-o)*Math.cos(_)*n,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=n-Math.sqrt(n*n-this._edgeLen2/4),rL(this.centerAtSeaLevel,m,u,this.ellipsoid.radius),oe(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(this.lij[0]===0)it(qt(e[Wt.MIDDLE]),0,0,0),it(e[Wt.TOP],0,0,0),it(e[Wt.BOTTOM],0,0,0),e[Wt.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[Wt.MIDDLE],s=this.convexHull;let r=0;for(let a=0;a<8;++a)r=Math.max(r,nL(qt(t),s,3*a));e[Wt.MIDDLE][3]=Math.sqrt(r)}}_calculateFrustumVisibilityStatus(e){if(!ju(e,this._boundingSphere))return Ui.OUTSIDE;if(this.lij[0]<10)return Ui.INTERSECTS;const t=this.convexHull,s=this.surface.view.state.camera.near;let r=!0;for(let a=0;a<F2;a++){const n=a===Sa.NEAR,o=e[a],l=o[0],h=o[1],d=o[2],u=o[3]-(n?s:0);let m=!1;for(let _=0;_<8;++_){const f=3*_;if(l*t[f]+h*t[f+1]+d*t[f+2]+u<0){if(m=!0,!r)break}else r=!1}if(!m)return Ui.OUTSIDE}return r?Ui.INSIDE:Ui.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){LI(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),zi&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=qt(e),s=this.elevationBoundsMin,r=this.elevationBoundsMax,a=this.ellipsoid.radius,n=r;if(this.level===0)it(t,0,0,0),e[3]=a+n;else{const o=this.extentInRadians,l=.5*(o[0]+o[2]),h=o[1],d=o[3];qn(kv,l,h,a),qn(jv,l,d,a),_e(t,kv,jv),ee(t,t,(a+.5*(s+r))/fs(t));const u=this.convexHull;let m=0;const _=(g,y)=>{const w=g[0]-u[3*y],x=g[1]-u[3*y+1],T=g[2]-u[3*y+2];return Math.sqrt(w*w+x*x+T*T)};for(let g=0;g<8;++g){const y=_(t,g);m=Math.max(m,y)}const f=m;e[3]=f+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(this.level===0)return;const s=this.elevationBoundsMin,r=this.elevationBoundsMax,a=this._getPatchType(),n=this.surface.isWebMercator,o=n&&a===qr.HAS_NORTH_POLE,l=n&&a===qr.HAS_SOUTH_POLE,h=l||o,d=Math.PI/2,u=e[0],m=e[2],_=l?-d:e[1],f=o?d:e[3],g=.5*(u+m),y=s,w=t+(h?Math.min(0,y-1):y),x=($,U,ye)=>qn($,U,ye,w),T=b(),S=b(),C=b(),P=b();x(T,u,_),x(S,u,f),x(C,m,f),x(P,m,_);const R=($,U)=>{for(let ye=0;ye<3;++ye)this._convexHull[3*U+ye]=$[ye]};R(T,0),R(S,1),R(C,2),R(P,3);const I=r,L=t+(h?Math.max(0,I+1):I),G=b(),H=b(),D=b();qn(H,g,f,w),qn(D,g,_,w),_e(G,H,D),oe(G,G);const J=b(),A=b(),O=($,U)=>{xt(A,$,U),oe(A,A);const ye=-ue($,J)/ue(A,J);N(ye>=0),ee(A,A,ye),_e($,$,A)};if(2**this.lij[0]>2*this.lij[1]){const $=D,U=b();yt(U,Gv,$),oe(U,U),yt(J,$,U),oe(J,J),N(ks(ue(J,$)/fs($),0)),O(T,S),O(P,C),R(T,0),R(P,3)}else if(2**this.lij[0]!==2*this.lij[1]){const $=H,U=b();yt(U,Gv,$),oe(U,U),yt(J,U,$),oe(J,J),O(S,T),O(C,P),R(S,1),R(C,2)}const te=($,U)=>{const ye=L/ue(U,G);for(let he=0;he<3;++he)this._convexHull[3*$+he]=U[he]*ye};te(4,T),te(5,S),te(6,C),te(7,P)}_getPatchType(){const e=this.lij[1],t=e===0,s=e===(1<<this.level)-1;return t?s?qr.HAS_BOTH_POLES:qr.HAS_NORTH_POLE:s?qr.HAS_SOUTH_POLE:qr.REGULAR}intersectsRay(e,t,s,r){const a=this._boundingSphere,n=a[3]+s,o=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],l=a[0]-e[0],h=a[1]-e[1],d=a[2]-e[2],u=(l*t[0]+h*t[1]+d*t[2])/o,m=t[0]*u-l,_=t[1]*u-h,f=t[2]*u-d;return m*m+_*_+f*f<n*n}getDefaultVerticesPerSide(){return this.level<Hv.length?Hv[this.level]+1:2}updateCornerElevations(){qI(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){VI(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){UI(this.renderData),this._updateBoundingVolumes()}_checkBVs(){var We;if(!zi||this.level<=2)return;const e=this._boundingSphere,t=e[3],s=qt(e),r=b(),a=this.ellipsoid.radius,n=this.elevationBoundsMin,o=this.elevationBoundsMax,l=a+n,h=1,d=0,u=this._center[Wt.MIDDLE][3],m=this.convexHull,_=(B,W)=>{for(let pe=0;pe<3;++pe)B[pe]=m[3*W+pe]};{const B=b(),W=b(),pe=b(),Ce=b(),Q=b(),fe=(q,ie,ve,lt)=>{_(W,q),_(pe,ie),_(Ce,ve),xt(W,W,pe),xt(Ce,Ce,pe),yt(B,W,Ce),oe(B,B);const mt=ue(B,pe);_(Q,lt);const _t=ue(B,Q),Ge=Math.abs(_t-mt);N(ks(Ge,0),`Non coplanar ${q},${ie},${ve},${lt} diff = ${Ge}`)};fe(0,1,2,3),fe(4,5,6,7),fe(0,1,4,5),fe(1,2,5,6),fe(2,3,6,7),fe(3,0,7,4)}const f=QR(24),g=(B,W,pe)=>{const Ce=4*B;for(let Q=0;Q<3;++Q)f[Ce+Q]=W[Q];f[Ce+3]=pe},y=b(),w=b(),x=b(),T=b(),S=(B,W,pe,Ce)=>{_(y,W),_(w,pe),_(x,Ce),xt(y,y,w),oe(y,y),xt(x,x,w),oe(x,x),yt(T,y,x),oe(T,T);const Q=ue(T,w);g(B,T,Q)};S(0,0,1,2),S(1,1,0,4),S(2,1,5,2),S(3,3,2,6),S(4,4,0,3),S(5,4,6,5);const C=1,P=(B,W,pe,Ce)=>{const Q=4*B;return f[Q]*W+f[Q+1]*pe+f[Q+2]*Ce-f[Q+3]},R=(B,W,pe,Ce)=>P(B,W,pe,Ce)>=-C,I=(B,W)=>R(B,W[0],W[1],W[2]),L=2**this.lij[0]>2*this.lij[1],G=(B,W,pe)=>Math.sqrt(Gw(B,W,pe,s[0],s[1],s[2]))<t,H=B=>G(B[0],B[1],B[2]),D=(B,W)=>G(B[W],B[W+1],B[W+2]),J=this.extentInRadians,A=.5*(J[0]+J[2]),O=J[1],te=J[3],$=b(),U=b();qn($,A,te,l),qn(U,A,O,l);const ye=L?"Upper":"Lower";let he=!0;for(let B=0;B<6;++B){for(let W=0;W<8;++W){const pe=3*W,Ce=R(B,m[pe],m[pe+1],m[pe+2]);he&&(he=Ce),N(Ce,`Tile[${this.lij}] Convex hull point ${W} outside of plane ${B}`)}N(I(B,U),`Tile[${this.lij}] (${ye}) bottom mid outside of plane ${B}`),N(I(B,$),`Tile[${this.lij}] (${ye}) top mid outside of plane ${B}`)}N(he,"Not all convex hull points are inside  convex hull polyhedron"),N(H(U),`Tile[${this.lij}] (${ye}) bottom mid outside of bounding sphere`),N(H($),`Tile[${this.lij}] (${ye}) top mid outside of bounding sphere`);for(let B=0;B<8;++B){const W=D(m,3*B);N(W,`Tile[${this.lij}] Convex hull point ${B} outside of bounding sphere`)}for(let B=0;B<6;++B)for(let W=0;W<8;++W){const pe=3*W;R(B,m[pe],m[pe+1],m[pe+2])||console.error(`Tile[${this.lij}] Convex hull point ${W} outside of plane ${B}`)}const{extentInRadians:ge}=this,ne=Math.max(ge[2]-ge[0],ge[3]-ge[1]),de=Math.round(ne*a),{renderData:ce}=this;if(!ce)return;const{geometry:re,geometryState:Oe,localOrigin:Ie}=ce,Me=(We=re.vertexAttributes)==null?void 0:We.position;if(!Me)return;const Ae=b(),rt=re.numVerticesPerSide-2,{indices:Xe,indexCount:Je,edgeVerticesStartIndex:Ye,poleVerticesStartIndex:Nt}=re;if(!Xe)return;const k=new Set;for(let B=0;B<Je;++B){const W=Xe[B];if(k.has(W))continue;k.add(W);const pe=W<Nt,Ce=W>=Ye;let Q=!1,fe=-1;if(Ce){let me=Ye;for(let Le=0;Le<4;++Le){const ze=Oe.edgeResolutions[Le];if(W===me||W===me+ze-1){Q=!0;break}if(me+=ze,W<me){fe=Le;break}}}const q=Ce?Oe.edgePeerNeighbors[fe]:null,ie=Ce&&q&&jr(this,q)>0;Me.getVec(W,r),_e(Ae,r,Ie);const ve=fs(Ae)-a;let lt=0,mt=!1;const _t=n-ve,Ge=ve-o,Ze=_t>h,Ve=Ge>h,ke=Ze||Ve,qe=()=>{const me=pe?"internal":Ce&&!Q?"edge":Q?"corner":"pole";return`Tile[${this.lij}].vertex[${W}]:${me}`+(Ze?"(below)":Ve?"(above)":"")+(ie?"(Neighbor)":"")},et=Ch(Ae,s);if(et>=t+d){const me=et-t;ke||(console.error(`${qe()} is out of the bounding sphere by ${me.toFixed(0)} / ${t.toFixed(0)}[tol=${d}] h=${ve.toFixed(0)} / [${n.toFixed(0)}..${o.toFixed(0)}] (${(me/t).toFixed(0)})`),mt=!0)}for(let me=0;me<6;++me)if(!R(me,Ae[0],Ae[1],Ae[2])){const Le=P(me,Ae[0],Ae[1],Ae[2]),ze=W%rt,at=(W-ze)/rt;me===0&&_t||me===5&&Ge||(console.error(`${qe()} (${ze},${at})|${rt}] is out of the bounding trapezoid plane ${me} h=${Math.round(ve)} / [${Math.round(n)}..${Math.round(o)}] dist=${Math.round(Le)} radii = ${Math.round(t)}/${Math.round(u)}} : maxL = ${de}`),++lt)}if(mt||lt>0)break}}get convexHull(){return this._convexHull}};const Hv=[128,64,64,32,16,8,8,4];function nL(i,e,t){return Gw(i[0],i[1],i[2],e[t],e[t+1],e[t+2])}function Gw(i,e,t,s,r,a){const n=s-i,o=r-e,l=a-t;return n*n+o*o+l*l}const qn=(i,e,t,s)=>{const r=Math.cos(e),a=Math.sin(e),n=Math.cos(t),o=Math.sin(t);i[0]=s*n*r,i[1]=s*n*a,i[2]=s*o},Gv=[0,0,1],kv=b(),jv=b();let cr=class extends Re{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};c([p()],cr.prototype,"fovX",void 0),c([p()],cr.prototype,"fovY",void 0),c([p()],cr.prototype,"relativeWidthLimit",void 0),c([p()],cr.prototype,"relativeHeightLimit",void 0),c([p()],cr.prototype,"maxLod",void 0),c([p()],cr.prototype,"angledSplitBias",void 0),c([p()],cr.prototype,"aboveGround",void 0),c([p()],cr.prototype,"frustum",void 0),cr=c([F("esri.views.3d.terrain.SplitLimits")],cr);const oL=Mn().vec3f(Te.POSITION).vec2i16(Te.UV0).vec2i16(Te.NORMALCOMPRESSED,{glNormalized:!0});let lL=class{constructor(e){this._storage=new Bu((t,s)=>e.newCache(t,s),"TileGeometry")}acquire(e){const s=Math.ceil(e/4)*4,r=this._storage,a=hL(s),n=r.pop(a);if(n)return n;const o=oL.createBuffer(s);return o.release=()=>r.put(a,o),o}clear(){this._storage.clear()}destroy(){this._storage.destroy()}};function hL(i){return i.toString()}var V;(function(i){i[i.Normal=0]="Normal",i[i.Average=1]="Average",i[i.Lighten=2]="Lighten",i[i.Lighter=3]="Lighter",i[i.Plus=4]="Plus",i[i.Screen=5]="Screen",i[i.ColorDodge=6]="ColorDodge",i[i.Darken=7]="Darken",i[i.Multiply=8]="Multiply",i[i.ColorBurn=9]="ColorBurn",i[i.Overlay=10]="Overlay",i[i.SoftLight=11]="SoftLight",i[i.HardLight=12]="HardLight",i[i.VividLight=13]="VividLight",i[i.Hue=14]="Hue",i[i.Saturation=15]="Saturation",i[i.Luminosity=16]="Luminosity",i[i.Color=17]="Color",i[i.DestinationOver=18]="DestinationOver",i[i.DestinationAtop=19]="DestinationAtop",i[i.DestinationIn=20]="DestinationIn",i[i.DestinationOut=21]="DestinationOut",i[i.SourceAtop=22]="SourceAtop",i[i.SourceIn=23]="SourceIn",i[i.SourceOut=24]="SourceOut",i[i.Xor=25]="Xor",i[i.Difference=26]="Difference",i[i.Exclusion=27]="Exclusion",i[i.Minus=28]="Minus",i[i.Invert=29]="Invert",i[i.Reflect=30]="Reflect",i[i.COUNT=31]="COUNT"})(V||(V={}));const g_={normal:V.Normal,average:V.Average,lighten:V.Lighten,lighter:V.Lighter,screen:V.Screen,plus:V.Plus,"color-dodge":V.ColorDodge,darken:V.Darken,multiply:V.Multiply,"color-burn":V.ColorBurn,overlay:V.Overlay,"soft-light":V.SoftLight,"hard-light":V.HardLight,"vivid-light":V.VividLight,hue:V.Hue,saturation:V.Saturation,luminosity:V.Luminosity,color:V.Color,difference:V.Difference,exclusion:V.Exclusion,minus:V.Minus,invert:V.Invert,reflect:V.Reflect,"destination-over":V.DestinationOver,"destination-atop":V.DestinationAtop,"destination-in":V.DestinationIn,"destination-out":V.DestinationOut,"source-atop":V.SourceAtop,"source-in":V.SourceIn,"source-out":V.SourceOut,xor:V.Xor};function cL(i){return i===V.DestinationOver||i===V.DestinationAtop||i===V.DestinationIn||i===V.DestinationOut||i===V.SourceAtop||i===V.SourceIn||i===V.SourceOut||i===V.Xor}let kw=class extends tr{constructor(){super(...arguments),this.blendMode=V.Normal}};c([z({count:V.COUNT})],kw.prototype,"blendMode",void 0);var Fi;(function(i){i[i.NotRequired=0]="NotRequired",i[i.Required=1]="Required",i[i.COUNT=2]="COUNT"})(Fi||(Fi={}));var Zt;(function(i){i[i.Composite=0]="Composite",i[i.ColorComposite=1]="ColorComposite",i[i.GridComposite=2]="GridComposite",i[i.GroupBackgroundComposite=3]="GroupBackgroundComposite",i[i.COUNT=4]="COUNT"})(Zt||(Zt={}));var pr;(function(i){i[i.Off=0]="Off",i[i.On=1]="On",i[i.COUNT=2]="COUNT"})(pr||(pr={}));let Ih=class extends kw{constructor(){super(...arguments),this.output=Zt.Composite,this.baseOpacityMode=Fi.NotRequired,this.premultipliedSource=pr.Off}};c([z({count:Zt.COUNT})],Ih.prototype,"output",void 0),c([z({count:Fi.COUNT})],Ih.prototype,"baseOpacityMode",void 0),c([z()],Ih.prototype,"premultipliedSource",void 0);let jw=class extends ri{constructor(){super(...arguments),this.scale=1,this.offset=iu}};function Ww(i){i.attributes.add(Te.POSITION,"vec2"),i.attributes.add(Te.UV0,"vec2"),i.varyings.add("uv","vec2"),i.varyings.add("vuv","vec2"),i.vertex.uniforms.add(new He("scale",e=>e.scale),new Bi("offset",e=>e.offset)).code.add(v`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;
}`)}function dL(i,e){const t=e.blendMode;t!==V.Normal&&(t===V.Reflect&&i.code.add(v`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),t!==V.ColorDodge&&t!==V.VividLight||i.code.add(v`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),t!==V.ColorBurn&&t!==V.VividLight||i.code.add(v`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),t===V.Overlay&&i.code.add(v`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),t===V.HardLight&&i.code.add(v`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),t===V.SoftLight&&i.code.add(v`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),t===V.VividLight&&i.code.add(v`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),t!==V.Hue&&t!==V.Saturation&&t!==V.Color&&t!==V.Luminosity||(i.code.add(v`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),t!==V.Hue&&t!==V.Saturation||i.code.add(v`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),i.code.add(v`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${t===V.Multiply?v`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.Average?v`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.Lighten?v`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.Darken?v`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.Lighter?v`return vec4(cl * ol + cb * ob, ol + ob);`:t===V.Plus?v`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:t===V.Minus?v`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:t===V.Screen?v`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.Difference?v`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.Invert?v`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:t===V.DestinationOver?v`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:t===V.DestinationAtop?v`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:t===V.DestinationOut?v`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:t===V.SourceAtop?v`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:t===V.SourceOut?v`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:t===V.Xor?v`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:t===V.DestinationIn?v`return vec4(cb * ob * ol, ol * ob);`:t===V.SourceIn?v`return vec4(cl * ol * ob, ol * ob);`:t===V.Hue?v`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.Saturation?v`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.Color?v`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.Luminosity?v`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.Exclusion?v`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.Reflect?v`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.ColorDodge?v`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.ColorBurn?v`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.Overlay?v`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.SoftLight?v`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.HardLight?v`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===V.VividLight?v`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:v``}
    }
  `))}function Qw(i,e){const t=e.output===Zt.GridComposite,s=e.output===Zt.ColorComposite,r=e.output===Zt.GroupBackgroundComposite,a=e.output===Zt.Composite,n=e.baseOpacityMode===Fi.Required,o=i.fragment;n&&o.uniforms.add(new He("baseOpacity",u=>u.baseOpacity)),t?o.include(Og):s?o.uniforms.add(new Ei("backgroundColor",u=>u.backgroundColor)):a&&o.uniforms.add(new Fe("fboColor",u=>u.fboTexture));const l=e.blendMode!==V.Normal,h=e.premultipliedSource===pr.On,d=!l&&!h&&(a&&!n||r);o.include(dL,e),o.code.add(v`
    vec4 getBackground(vec2 uv) {
      return ${n?v`baseOpacity *`:""} ${r?v`vec4(0.0, 0.0, 0.0, 0.0)`:s?v`vec4(backgroundColor, 1.0)`:t?v`vec4(gridColor(uv), 1.0)`:v`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`};
    }

    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {
      ${l?v`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec4 bgColor = getBackground(bgUV);
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:v`
          float composeAlpha = colorLayer.a * opacity;
          ${d?v`return colorLayer * opacity;`:v`
            vec4 bgColor = getBackground(bgUV);
            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}var Sn;function Xw(i){const e=new Dt,t=e.fragment;if(e.include(Ww),i.background===Sn.Only){const s=i.output===Zt.ColorComposite;return s?t.uniforms.add(new Ei("backgroundColor",r=>r.backgroundColor)):t.include(Og),t.code.add(v`
      void main() {
        fragColor = vec4(${s?v`backgroundColor`:v`gridColor(uv)`}, 1.0);
      }
    `),e}return e.include(Qw,i),t.uniforms.add(new Fe("tex",s=>s.texture),new He("opacity",s=>s.opacity)).code.add(v`void main() {
fragColor = blendLayers(uv, texture(tex, uv), opacity);
}`),e}(function(i){i[i.BelowLayer=0]="BelowLayer",i[i.Only=1]="Only",i[i.COUNT=2]="COUNT"})(Sn||(Sn={}));const uL=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return Sn},build:Xw},Symbol.toStringTag,{value:"Module"}));let pL=class extends jw{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=Ea}},Yw=class Zw extends It{initializeProgram(e){return new Lt(e.rctx,Zw.shader.get().build(this.configuration),pt)}initializePipeline(){return ot({blending:ta(K.ONE,K.ONE_MINUS_SRC_ALPHA),colorWrite:ht})}};Yw.shader=new $t(uL,()=>ae(()=>Promise.resolve().then(()=>J5),void 0,import.meta.url));let Kw=class extends Ih{constructor(){super(...arguments),this.background=Sn.BelowLayer}};c([z()],Kw.prototype,"background",void 0);let f_=class{constructor(e,t,s,r,a,n){this.texture=e,this.type=t,e.retain(),this.offsetAndScale=er(s.offset[0],s.offset[1],s.scale,s.scale),this.opacities=St(r,a,n)}destroy(){this.texture.release()}};var mo,xo;(function(i){i[i.Stretch=0]="Stretch",i[i.Lut=1]="Lut",i[i.Hillshade=2]="Hillshade",i[i.COUNT=3]="COUNT"})(mo||(mo={})),function(i){i[i.Noop=0]="Noop",i[i.PerBand=1]="PerBand",i[i.COUNT=2]="COUNT"}(xo||(xo={}));function mL(i,e){const t=i.transforms.tileUnitsToPixels,s=Wy(e),r=Math.cos(s),a=Math.sin(s),n=Math.ceil(512*(Math.abs(a)+Math.abs(r)));N1(Ir),lu(Ir,Ir,[n/2,n/2]),F1(Ir,Ir,s),lu(Ir,Ir,[-256,-256]),V1(Ir,Ir,[1/8,1/8,1]),i.transforms.tileUnitsToPixels=Ir;const o=[],l=new AR(4096,o,()=>new DR),h=new $R(o,l,(d,u,m)=>new IR(d,u,m,i.styleRepository,i.key.level,e),(d,u)=>{LR(d,u,!1)},()=>0,d=>{const u=i.styleRepository.getStyleLayerByUID(d).getLayoutProperty("visibility");return!u||u.getValue()!==ZR.NONE});o.push(i),l.add(i),h.setScreenSize(n,n),h.continue(1/0),l.removeTile(i),i.transforms.tileUnitsToPixels=t}const Ir=qT(),_L=.125;let gL=class{constructor(){this._renderParams={reshuffleManager:new JR,context:null,drawPhase:1,state:new fL,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new NR(new YR(0,0,0,0),0,0,0,512,512,4096,4096),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,t,s,r,a,n,o,l,h,d){const u=this._backgroundTile;this._updateRenderParameters(e,t,u,s,a,n,o,l,h,d),this._renderParams.stencilSymbols=!1,s.drawBackground(this._renderParams,u,r)}renderContent(e,t,s,r,a,n,o,l,h,d,u,m){this._declutter(s),r.forAll(f=>this._declutter(f.sourceLayerInfo.data)),this._stencilSymbols(e,t,s,r,a,n,o,Math.round(1/l),h,d,u,m);let _=1;s.stencilRef=_++,e.setStencilFunction(Xi.EQUAL,s.stencilRef,255),this._render(e,t,s,a,n,o,l,h,d,u,m),r.forAll(f=>{f.sourceLayerInfo.data.stencilRef=_++,this._renderSymbols(e,f.sourceLod,f.sourceLayerInfo.data,a,n,o,Math.round(1/l),f.offset,d,u,m)})}_stencilSymbols(e,t,s,r,a,n,o,l,h,d,u,m){let _=1;s.stencilRef=_++,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(dp.KEEP,dp.KEEP,dp.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(Xi.ALWAYS,s.stencilRef,255),this._stencilTileSymbols(e,t,s,a,n,o,l,h,d,u,m);for(const f of r.toArray()){const{sourceLod:g,offset:y,sourceLayerInfo:w}=f;w.data.stencilRef=_++,e.setStencilFunction(Xi.ALWAYS,w.data.stencilRef,255),this._stencilTileSymbols(e,g,w.data,a,n,o,l,y,d,u,m)}e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,s,r,a,n,o,l,h,d,u){e.setStencilFunction(Xi.EQUAL,s.stencilRef,255),this._render(e,t,s,r,a,n,o,l,h,d,u,KR.SYMBOL)}_render(e,t,s,r,a,n,o,l,h,d,u,m){this._updateRenderParameters(e,t,s,r,n,o,l,h,d,u),this._renderParams.stencilSymbols=!1,r.drawTile(this._renderParams,s,a,m)}_stencilTileSymbols(e,t,s,r,a,n,o,l,h,d,u){this._updateRenderParameters(e,t,s,r,n,o,l,h,d,u),this._renderParams.stencilSymbols=!0,s.triangleCount=0,r.drawSymbols(this._renderParams,s,a)}_updateRenderParameters(e,t,s,r,a,n,o,l,h,d){"type"in s&&s.type==="vector-tile"&&!s.stage&&s.attachWithContext(e);const u=t[0]-a.getLevelShift(t[0]),m=this._renderParams;m.context=e,m.painter=r,m.glyphMosaic=r.glyphMosaic,m.spriteMosaic=r.spriteMosaic,m.pixelRatio=h*d,m.displayLevel=u,m.requiredLevel=u;const _=a.getScale(t[0]),[f,g]=a.getOffset(t,n*_),y=_L*n*_/l,w=s.transforms.displayViewScreenMat3;w[0]=y,w[4]=-y,w[6]=-1-f-o[0]*n*2,w[7]=1+g+(1-o[1])*n*2-2;const x=m.state,T=l/d;x.size[0]=T,x.size[1]=T,x.pixelRatio=d,x.rotation=(360-this._heading)%360;const S=2/T;YP(x.displayViewMat3,S,0,0,0,-S,0,-1,1,1);const C=N1(x.displayMat3),P=Wy(this._heading);lu(C,C,[T/2,T/2]),F1(C,C,P),lu(C,C,[-T/2,-T/2]),ZP(C,x.displayViewMat3,C)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(mL(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}},fL=class{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=La(),this.displayViewMat3=La(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}};function vL(i){i.fragment.uniforms.add(new Fe("u_colormap",e=>e.u_colormap),new He("u_colormapOffset",e=>e.colormap.u_colormapOffset),new He("u_colormapMaxIndex",e=>e.colormap.u_colormapMaxIndex),new He("u_opacity",e=>e.common.u_opacity)),i.fragment.code.add(v`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}function yL(i){i.fragment.uniforms.add(new Fe("u_transformGrid",e=>e.u_transformGrid),new Bi("u_transformSpacing",e=>e.common.u_transformSpacing),new Bi("u_targetImageSize",e=>e.common.u_targetImageSize)),i.fragment.code.add(v`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}let bL=class extends jw{constructor(e,t,s){super(),this.common=e,this.u_image=t,this.u_transformGrid=s}};function wL(i,e){i.include(yL),i.fragment.uniforms.add(new Fe("u_image",s=>s.u_image),new jh("u_flipY",s=>s.common.u_flipY),new jh("u_applyTransform",s=>s.common.u_applyTransform));const{requireBilinearWithNN:t}=e;t&&i.fragment.uniforms.add(new Bi("u_srcImageSize",s=>s.common.u_srcImageSize)),i.fragment.code.add(v`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),t?i.fragment.code.add(v`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):i.fragment.code.add(v`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}let Ju=class extends bL{constructor(e,t,s,r,a,n){super(e,r,a),this.colormap=t,this.symbolizer=s,this.u_colormap=n,this.backgroundColor=Ea,this.fboTexture=null,this.baseOpacity=1}},Jw=class extends Ju{},ex=class extends Ju{};function tx(i){const e=new Dt;return e.include(Ww),e.include(wL,i),e.include(vL,i),e.include(Qw,i),e.fragment.code.add(v`vec4 applyBackgroundBlend(vec4 layerColor) {
return blendLayers(vuv, layerColor, u_opacity);
}`),i.colorizerType===mo.Stretch?CL(e,i):i.colorizerType===mo.Lut?xL(e):i.colorizerType===mo.Hillshade&&TL(e,i),e}function xL(i){i.fragment.code.add(v`void main() {
vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));
}`)}function CL(i,e){i.fragment.uniforms.add(new B_("u_bandCount",s=>s.symbolizer.u_bandCount),new Br("u_minCutOff",s=>s.symbolizer.u_minCutOff,3),new Br("u_maxCutOff",s=>s.symbolizer.u_maxCutOff,3),new Br("u_factor",s=>s.symbolizer.u_factor,3),new He("u_minOutput",s=>s.symbolizer.u_minOutput),new He("u_maxOutput",s=>s.symbolizer.u_maxOutput),new jh("u_useGamma",s=>s.symbolizer.u_useGamma),new Br("u_gamma",s=>s.symbolizer.u_gamma,3),new Br("u_gammaCorrection",s=>s.symbolizer.u_gammaCorrection,3),new He("u_opacity",s=>s.common.u_opacity)),i.fragment.code.add(v`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const t=e.applyColormap?v`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:v`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;i.fragment.code.add(v`
      void main() {
        vec2 pixelLocation = getPixelLocation(uv);
        if (isOutside(pixelLocation)) {
          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${e.stretchType===xo.Noop?v`
        fragColor = applyBackgroundBlend(currentPixel);`:v`
        if (currentPixel.a == 0.0) {
          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${t}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
        }`}
      }`)}function TL(i,e){const t=i.fragment;t.uniforms.add(new Fe("u_image",r=>r.u_image),new B_("u_hillshadeType",r=>r.symbolizer.u_hillshadeType),new Br("u_sinZcosAs",r=>r.symbolizer.u_sinZcosAs,6),new Br("u_sinZsinAs",r=>r.symbolizer.u_sinZsinAs,6),new Br("u_cosZs",r=>r.symbolizer.u_cosZs,6),new Br("u_weights",r=>r.symbolizer.u_weights,6),new Bi("u_factor",r=>r.symbolizer.u_factor),new He("u_minValue",r=>r.symbolizer.u_minValue),new He("u_maxValue",r=>r.symbolizer.u_maxValue),new Bi("u_srcImageSize",r=>r.common.u_srcImageSize)),t.include(b1),t.code.add(v`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),t.code.add(v`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const s=e.applyColormap?v`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:v`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;t.code.add(v`
    void main() {
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${s}
    }
  `)}const SL=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:ex,ColorizerStretchUniforms:Jw,ColorizerUniforms:Ju,build:tx},Symbol.toStringTag,{value:"Module"}));let ix=class sx extends It{initializeProgram(e){return new Lt(e.rctx,sx.shader.get().build(this.configuration),pt)}initializePipeline(){return ot({blending:ta(K.ONE,K.ONE_MINUS_SRC_ALPHA),colorWrite:ht})}};ix.shader=new $t(SL,()=>ae(()=>Promise.resolve().then(()=>eF),void 0,import.meta.url));let mh=class extends Ih{constructor(){super(...arguments),this.colorizerType=mo.Stretch,this.stretchType=xo.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}};c([z({count:mo.COUNT})],mh.prototype,"colorizerType",void 0),c([z({count:xo.COUNT})],mh.prototype,"stretchType",void 0),c([z()],mh.prototype,"applyColormap",void 0),c([z()],mh.prototype,"requireBilinearWithNN",void 0);let Wv=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const s=new mc(this._rctx,new gi(e),new z1(E1.DEPTH24_STENCIL8,e));return this._fbos.set(e,s),s}};const PL=()=>Pe.getLogger("esri.views.3d.terrain");let RL=class{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new gL,this._bindParameters=new j_(null,null),this._blendLayersTechniqueConfig=new Kw,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=ra(this._rctx,fc)}dispose(){this._fbos.forEach(je),this._fbos=null,this._vtFBO=je(this._vtFBO),this._vaoQuad=je(this._vaoQuad),this._vectorTileHelper=je(this._vectorTileHelper),this._backgroundTechnique=tt(this._backgroundTechnique),this._applyOpacityTechnique=tt(this._applyOpacityTechnique),this._blendLayersTechnique=tt(this._blendLayersTechnique)}updateHeading(e){var t;(t=this._vectorTileHelper)==null||t.updateHeading(e)}_getBlendLayersTechnique(e,t,s,r=pr.Off,a=Sn.BelowLayer){return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=s,this._blendLayersTechniqueConfig.premultipliedSource=r,this._blendLayersTechniqueConfig.background=a,this._blendLayersTechnique=this._techniques.releaseAndAcquire(Yw,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}drawBackground(e,t){const s=this._getBlendLayersTechnique(V.Normal,t?Zt.ColorComposite:Zt.GridComposite,Fi.NotRequired,pr.Off,Sn.Only),r=this._rctx.bindTechnique(s,this._bindParameters,e);this._render(r)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(Ai.TRIANGLE_STRIP,0,$a(this._vaoQuad,"geometry"))}drawGroup(e,t,s,r,a=pr.On){t===Zt.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(s).colorTexture),e.texture=this.currentFBO(s).colorTexture,this.closeGroup(s);const n=e.baseOpacity<1?Fi.Required:Fi.NotRequired,o=this._getBlendLayersTechnique(r,t,n,a),l=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(l)}drawImageData(e,t,s,r,a=pr.Off){if(e.texture==null)return;const n=e.baseOpacity<1?Fi.Required:Fi.NotRequired;e.fboTexture=t===Zt.GroupBackgroundComposite||r===V.Normal&&n===Fi.NotRequired&&a===pr.Off?null:this.switch(s).colorTexture;const o=this._getBlendLayersTechnique(r,t,n,a),l=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(l)}drawRasterData(e,t,s,r,a){const n=a.sourceLayerInfo.data;if(!n.source||(a.tile.surface.layerViewByIndex(a.layerIndex,we.MAP).ensureSymbolizerParameters(n),!n.bind(this._rctx)))return;const o=e.baseOpacity<1?Fi.Required:Fi.NotRequired;e.fboTexture=r===V.Normal&&o===Fi.NotRequired?null:this.switch(s).colorTexture;const l=this._getRasterColorizerTechnique(n,t,r,o);n.opacity=e.opacity;const h=n.getUniforms();h.scale=a.scale,h.offset=a.offset,h.backgroundColor=e.backgroundColor,h.fboTexture=e.fboTexture,h.baseOpacity=e.baseOpacity;const d=this._rctx.bindTechnique(l,null,h);this._render(d)}_getRasterColorizerTechnique(e,t,s,r){const a=e.symbolizerParameters,n=["stretch","lut","hillshade"].indexOf(a.type);return this._rasterColorizerConfig==null&&(this._rasterColorizerConfig=new mh,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=s,this._rasterColorizerConfig.baseOpacityMode=r,this._rasterColorizerConfig.colorizerType=n,this._rasterColorizerConfig.applyColormap=!!a.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?xo.Noop:xo.PerBand,this._rasterColorizerTechnique=this._techniques.releaseAndAcquire(ix,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}drawVectorData(e,t,s,r,a,n,o,l){const h=this._rctx,d=a.sourceLayerInfo.data,u=a.tile.surface.layerViewByIndex(a.layerIndex,we.MAP),m=e.baseOpacity<1?Fi.Required:Fi.NotRequired,_=m===Fi.Required||e.opacity<1||r!==V.Normal||t!==Zt.Composite,f=_?pr.On:pr.Off,g=this._getBlendLayersTechnique(r,t,m,f);h.setPipelineState(g.getPipeline());let y=null,w=null;_?(w=this.currentFBO(s),this._vtFBO==null&&(this._vtFBO=new Wv(this._rctx)),y=this._vtFBO.get(s),h.bindFramebuffer(y),this._clearCurrentFBO()):l&&h.clear(Mi.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.renderBackground(h,a.sourceLod,u.painter,u.layer.styleRepository,u.schemaHelper,Math.round(1/a.scale),a.offset,o,n,u.contentZoom),d&&this._vectorTileHelper.renderContent(h,a.sourceLod,d,a.vtlNeighborInfos,u.painter,u.layer.styleRepository,u.schemaHelper,Math.round(1/a.scale),a.offset,o,n,u.contentZoom)}catch(x){PL().warnOnce("A render call containing vector tiles did not resolve correctly.",x)}return y==null||(h.bindFramebuffer(w),e.texture=y.colorTexture,e.offset=iu,e.scale=1,this.drawImageData(e,t,s,r,f),l)}copyFBOToTexture(e){const t=this._rctx,s=t.bindTexture(e.texture,Yi.TEXTURE_UNIT_FOR_UPDATES),r=e.descriptor;t.gl.copyTexImage2D(Lm.TEXTURE_2D,0,r.pixelFormat,0,0,r.width,r.height,0),e.generateMipmap(),t.bindTexture(s,Yi.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(Mi.COLOR_BUFFER_BIT|Mi.DEPTH_BUFFER_BIT|Mi.STENCIL_BUFFER_BIT)}_initFBO(e,t,s){this._rctx.bindFramebuffer(e),s&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,s=!0){if(this._current=t,t>=this._fbos.length)for(let r=this._fbos.length;r<=t;r++)this._fbos.push(new Wv(this._rctx));this._initFBO(this._fbos[t].get(e),e,s)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),s=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(s),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},OL=class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new Gt({allocator:e=>e||new ML})}},ML=class{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}},Qv=class{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){if(--this._refCount,this._refCount===0)if(this._cache){const e=`${this._texture.descriptor.width} ${this._texture.descriptor.pixelFormat}`;this._cache.put(e,this)}else this.dispose()}dispose(){this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get usedMemory(){return this._texture.usedMemory}},EL=class{constructor(e,t,s,r,a,n){this.start=e,this.end=t,this.blendMode=s,this.opacity=r,this.output=a,this.baseOpacity=n}},AL=class{constructor(e,t,s,r){this._rctx=e,this.tileSize=t,this._techniques=s,this._cache=r,this._passParameters=new pL,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new RL(this._rctx,this._techniques),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._compositor=je(this._compositor),this._backgroundTexture=tt(this._backgroundTexture)}get backgroundIsGrid(){return this._backgroundColor==null}get backgroundColor(){return this._backgroundColor}updateHeading(e){var t;(t=this._compositor)==null||t.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const s=e.surface,r=s.baseOpacity;let a=0,n=0,o=this.tileSize,l=!1,h=!1;const d=s.view.state.contentPixelRatio;let u=!1;Au.clear(),Bo.length=0;const m=e.layerInfo[we.MAP];let _=0,f=null;for(;_<m.length;_++){const w=s.layerViewByIndex(_,we.MAP),x=w.layer.opacity,T=w.fullOpacity;if(h=h||vd(w.layer),Hh(w)){let P=w.layer.blendMode!=="normal";if(wl(w.layer.parent)){const R=v_(w.layer.parent);R!=null&&R!==""&&(P=rx(w.layer.parent)||P)}P&&(u=P,l=!1)}if(x===0&&!u){m[_].pendingUpdates&=~(se.TEXTURE_NOFADING&se.TEXTURE_FADING);continue}++n;const S=tu(w),C=tm(e,_,S);if(C){if(m[_].pendingUpdates&=~(se.TEXTURE_NOFADING&se.TEXTURE_FADING),wl(w.layer.parent)){const P=v_(w.layer.parent);P!=null&&P!==""&&ax(w.layer.parent,_)}S?o=Math.max(o,this.tileSize*d):r===1&&T===1&&(w.isOpaque||this._dataToTexture(C)&&C.sourceLayerInfo.data.descriptor.isOpaque)&&(l=!0),++a,f===null&&(f=_)}}const g=o/this.tileSize,y=this._ensureBackgroundTexture(this.tileSize);a!==0&&f!==null?a===1&&!u&&this._useLayerTexture(e,f)||this._composeLayers(e,t,_-1,h,o,g,!l||u,Au,u):$L(e,n,y,t!==ii.FADING)}_ensureBackgroundTexture(e){return this._backgroundTexture==null&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._compositor.bind(e),this._passParameters.offset=iu,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,this.backgroundColor!=null),this._compositor.copyFBOToTexture(this._backgroundTexture),this._compositor.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useLayerTexture(e,t){const s=e.surface.layerViewByIndex(t,we.MAP),r=vd(s.layer),a=r?e.surface.baseOpacity:1,n=r?1:e.surface.baseOpacity,o=s.fullOpacity,l=tm(e,t,!1);return!!this._dataToTexture(l)&&(e.renderData.setTextureReference(new f_(l.sourceLayerInfo.data,ii.FADING,l,a,n,o)),!0)}_composeLayers(e,t,s,r,a,n,o,l,h){this._compositor.ensureBuffer(a);const d=e.surface.baseOpacity;let u=!1,m=Zs.LINEAR_MIPMAP_LINEAR,_=!1,f=0;for(let x=s;x>=0;x--){const T=e.surface.layerViewByIndex(x,we.MAP),S=tu(T),C=tm(e,x,S),P=T.layer.opacity;if(!C||P===0&&!h)continue;const R=!vd(T.layer)&&!u;R&&(u=!0);let I=!1;l.forEach(D=>{D.start===x&&(D.output=r?Zt.Composite:o&&R?this.backgroundIsGrid?Zt.GridComposite:Zt.ColorComposite:Zt.Composite,D.baseOpacity=R?d:1,Bo.push(D),this._compositor.openGroup(a),I=!0)});const L=f===0,G=I?Zt.GroupBackgroundComposite:o&&L?this.backgroundIsGrid?Zt.GridComposite:Zt.ColorComposite:Zt.Composite,H=g_[Hh(T)?T.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=R&&!I&&d<1?d:1,this._passParameters.opacity=P,yS(C)?_=this._compositor.drawVectorData(this._passParameters,G,a,H,C,n,this.tileSize,_):bS(C)?(this._compositor.drawRasterData(this._passParameters,G,a,H,C),DL(C)&&(m=Zs.NEAREST)):this._dataToTexture(C)&&(this._passParameters.texture=C.sourceLayerInfo.data.texture,this._passParameters.offset=C.offset,this._passParameters.scale=C.scale,this._compositor.drawImageData(this._passParameters,G,a,H));Bo.length>0&&Bo[Bo.length-1].end===x;){const D=Bo.pop();this._passParameters.baseOpacity=D.baseOpacity,this._passParameters.opacity=D.opacity,this._passParameters.offset=iu,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,D.output,a,g_[D.blendMode])}f++}const g=e.renderData,y=h||u&&d<1,w=g.ensureTexture(a,y,()=>this._buildTexture(a,y,m));this._compositor.copyFBOToTexture(w),this._compositor.unbind(),g.setTextureReference(new f_(w,t,nx,u?1:d,0,1))}_dataToTexture(e){if(wS(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data,!0),e.tile.setMemoryDirty()}return xS(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t,s=Zs.LINEAR_MIPMAP_LINEAR){if(e==null)return null;const r=new gi;r.wrapMode=Ki.CLAMP_TO_EDGE,r.samplingMode=s,r.maxAnisotropy=this._maxAnisotropy,r.preMultiplyAlpha=!0,r.flipped=!0,r.hasMipmap=!0,t||(r.pixelFormat=_i.RGB);const a=this._rctx;let n;if(typeof e=="number")r.width=r.height=e,n=this._buildTileTexture(r,e);else if(L_(e))r.isOpaque=e.isOpaque,r.isOpaque&&(r.pixelFormat=_i.RGB),n=this._buildTileTexture(r,e.element.width,e.element);else try{r.width=e.width,r.height=e.height,n=this._buildTileTexture(r,e.width,e)}catch{n=new Qv(mb(a)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=a.bindTexture(n.texture,Yi.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),a.bindTexture(o,Yi.TEXTURE_UNIT_FOR_UPDATES),n}_buildTileTexture(e,t,s){const r=`${t} ${e.pixelFormat}`,a=this._cache.pop(r);return a?(a.retain(),a.texture.setData(s),a):new Qv(new Yi(this._rctx,e,s),this._cache)}get test(){}};function tm(i,e,t){Ii.layerIndex=e,Ii.vtlNeighborInfos.clear();const s=i.layerInfo[we.MAP][e];if(Aa(Ii.offset,0,0),Ii.tile=i,Ii.scale=1,Ii.sourceLod=i.lij,Ii.sourceLayerInfo=s,Ii.isVTLBackground=t,s.data)return t&&i.forEachLoadedNeighbor((a,n)=>{if(a.level!==i.level)return;const o=a.layerInfo[we.MAP][e];if(!CS(o)||s.data===o.data)return;const l=Ii.vtlNeighborInfos.pushNew();l.offset=fa[n],l.sourceLod=a.lij,l.sourceLayerInfo=o}),Ii;const r=s.upsampleInfo;if(r){const a=r.tile.layerInfo[we.MAP][e];return Ii.tile=r.tile,fn(Ii.offset,r.offset),Ii.scale=r.scale,Ii.sourceLod=r.tile.lij,Ii.sourceLayerInfo=a,Ii}return t?Ii:null}function v_(i){return i.uid}function DL(i){const e=i.sourceLayerInfo.data;return!!e.source&&e.interpolation==="nearest"}function rx(i){let e=i.blendMode!=="normal";return wl(i.parent)&&(e=rx(i.parent)||e),e}function ax(i,e){wl(i.parent)&&ax(i.parent,e);const t=v_(i);if(t!=null&&t!==""){const s=Au.get(t);s?s.start=e:Au.set(t,new EL(e,e,i.blendMode,i.opacity,Zt.Composite,1))}}function $L(i,e,t,s){const r=i.renderData,a=!s&&r.textureReference!=null&&(i.surface.view.layerViewManager.updating||e>0)?pn.Delayed:pn.Immediate;r.setTextureReference(new f_(t,ii.FADING,nx,i.surface.baseOpacity,0,1),a)}const Au=new Map,Bo=new Array,Ii=new OL,nx={offset:[0,0],scale:1},fa=new Array;fa[vt.NORTH]=[0,-1],fa[vt.NORTH_EAST]=[-1,-1],fa[vt.EAST]=[-1,0],fa[vt.SOUTH_EAST]=[-1,1],fa[vt.SOUTH]=[0,1],fa[vt.SOUTH_WEST]=[1,1],fa[vt.WEST]=[1,0],fa[vt.NORTH_WEST]=[1,-1];const IL=200,im=40,LL=.8,NL=10,_h=1e-6;function FL(i,e,t){const s=e,r=t;let a=0,n=1/0;for(let o=0;o<3;++o){{const l=i[o];if(s[o]<l){if(r[o]<=_h)return!1;const h=(l-s[o])/r[o];a=Math.max(a,h)}else if(r[o]<=-_h){const h=(l-s[o])/r[o];n=Math.min(n,h)}if(a>n)return!1}{const l=i[o+3];if(s[o]>l){if(r[o]>=-_h)return!1;const h=(l-s[o])/r[o];a=Math.max(a,h)}else if(r[o]>=_h){const h=(l-s[o])/r[o];n=Math.min(n,h)}if(a>n)return!1}}return!0}let Xv=class{constructor(e,t,s,r,a){this.aabb=e,this.axis=t,this.d=s,this.midStartIndex=r,this.rightStartIndex=a}},ox=class y_{constructor(e,t,s,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positions=r,this._rayDirection=b(),this._callback=Zv,this._intersectionOptions=Yv,this.bspNodeTree=new Array;const a=s-t,n=new(a<BL?Uint8Array:a<HL?Uint16Array:Uint32Array)(a);this.triangleIndexMap=n;for(let o=0;o<a;++o)n[o]=o;{const o=zL(e,t,s,r.data,r.stride),l=Z(Math.log2(a/im),2,NL),h=(d,u,m)=>{const _=UL(n,o,d,u),f=u-d;if(f<=im){const S=new Xv(_,void 0,0,d,u);return this.bspNodeTree.push(S),S}const{axis:g,midValue:y}=qL(_),w=VL(n,o,d,u,g,y),x=(S,C)=>{if(m>l)return;const P=C-S;return P<im||P>=LL*f?void 0:h(S,C,m+1)},T=new Xv(_,g,y,w.next,w.mid);return this.bspNodeTree.push(T),T.leftNode=x(d,w.next),T.rightNode=x(w.mid,u),T};h(0,a,0)}}intersectRayTriangleRange(e,t){if(e>=t)return;const s=this.positions;nb(this._rayFrom,this._rayDirection,e,t,this.globalTriangleVertexIndices,s.data,s.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),y_.numFacesTested+=t-e}intersectRay(e,t,s,r){y_.numFacesTested=0;const a=e,n=t,o=n[0]-a[0],l=n[1]-a[1],h=n[2]-a[2];if(o*o+l*l+h*h<_h)return;this._rayFrom=a;const d=this._rayDirection;d[0]=o,d[1]=l,d[2]=h;const u=this.triangleIndexMap.length;this._callback=r,this._intersectionOptions=s,this.intersectRayBSP(this.bspNodeTree[0],0,u),this._callback=Zv,this._intersectionOptions=Yv}intersectRayBSP(e,t,s){const r=this._rayFrom,a=this._rayDirection;if(!FL(e.aabb,r,a))return;const n=e.axis,o=e.d;if(r[n]<o||a[n]<0){const l=t,h=e.midStartIndex;if(l<h){const d=e.leftNode;d!==void 0?this.intersectRayBSP(d,l,h):this.intersectRayTriangleRange(l,h)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[n]>o||a[n]>0){const l=e.rightStartIndex,h=s;if(l<h){const d=e.rightNode;d!==void 0?this.intersectRayBSP(d,l,h):this.intersectRayTriangleRange(l,h)}}}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}};ox.numFacesTested=0;const Ho=[1/0,1/0,1/0],Go=[-1/0,-1/0,-1/0];function VL(i,e,t,s,r,a){let n=t,o=s;for(;n<o;){const h=i[n];e[6*h+r+3]<=a?++n:(--o,i[n]=i[o],i[o]=h)}let l=n;for(o=s;l<o;){const h=i[o-1];e[6*h+r]>=a?--o:(i[o-1]=i[l],i[l]=h,++l)}return{next:n,mid:l}}function UL(i,e,t,s){if(s<=t)return e0(NaN,NaN,NaN,NaN,NaN,NaN);{const r=6*i[t];for(let a=0;a<3;++a)Ho[a]=e[r+0+a],Go[a]=e[r+3+a]}for(let r=t+1;r<s;++r){const a=6*i[r];for(let n=0;n<3;++n)Ho[n]=Math.min(Ho[n],e[a+0+n]),Go[n]=Math.max(Go[n],e[a+3+n])}return e0(Ho[0],Ho[1],Ho[2],Go[0],Go[1],Go[2])}function qL(i){const e=i[3]-i[0],t=i[4]-i[1],s=i[5]-i[2],r=e>t?e>s?0:t>s?1:2:t>s?1:s>e?2:0;return{axis:r,midValue:(i[r]+i[r+3])/2}}function zL(i,e,t,s,r){const a=t-e,n=new Float32Array(6*a);for(let o=0;o<a;++o){const l=3*(o+e),h=i[l]*r,d=i[l+1]*r,u=i[l+2]*r;for(let m=0;m<3;++m){const _=s[h+m],f=s[d+m],g=s[u+m];n[6*o+m]=Math.min(_,f,g),n[6*o+3+m]=Math.max(_,f,g)}}return n}const BL=255,HL=65535,Yv=new rg,Zv=()=>{};let Ft=class extends w1{constructor(){super(...arguments),this.output=E.Color,this.overlayMode=au.Disabled,this.tileBlendInput=Wr.LayerOnly,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.invisible=!1,this.opaque=!0,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.pbrMode=Qt.Simplified}};c([z({count:E.COUNT})],Ft.prototype,"output",void 0),c([z({count:au.COUNT})],Ft.prototype,"overlayMode",void 0),c([z({count:Wr.COUNT})],Ft.prototype,"tileBlendInput",void 0),c([z()],Ft.prototype,"spherical",void 0),c([z()],Ft.prototype,"doublePrecisionRequiresObfuscation",void 0),c([z()],Ft.prototype,"receiveShadows",void 0),c([z()],Ft.prototype,"hasSlicePlane",void 0),c([z()],Ft.prototype,"backfaceCullingEnabled",void 0),c([z()],Ft.prototype,"textureFadingEnabled",void 0),c([z()],Ft.prototype,"renderOccluded",void 0),c([z()],Ft.prototype,"hasScreenSpaceReflections",void 0),c([z()],Ft.prototype,"hasCloudsReflections",void 0),c([z()],Ft.prototype,"invisible",void 0),c([z()],Ft.prototype,"opaque",void 0),c([z()],Ft.prototype,"tileBorders",void 0),c([z()],Ft.prototype,"visualizeNormals",void 0),c([z()],Ft.prototype,"screenSizePerspective",void 0),c([z()],Ft.prototype,"receiveAmbientOcclusion",void 0),c([z({count:Qt.COUNT})],Ft.prototype,"pbrMode",void 0),c([z({constValue:Qs.Compressed})],Ft.prototype,"normalType",void 0),c([z({constValue:yn.Compressed})],Ft.prototype,"textureCoordinateType",void 0),c([z({constValue:!1})],Ft.prototype,"highStepCount",void 0),c([z({constValue:!1})],Ft.prototype,"useCustomDTRExponentForWater",void 0),c([z({constValue:!1})],Ft.prototype,"useFillLights",void 0),c([z({constValue:!0})],Ft.prototype,"hasColorTexture",void 0);const sm=7,GL=10,rm=Wu();var qi;(function(i){i[i.Opaque=0]="Opaque",i[i.Semitransparent=1]="Semitransparent",i[i.TransparentWithDraped=2]="TransparentWithDraped",i[i.Empty=3]="Empty"})(qi||(qi={}));let Vs=class extends PP{get _isGlobal(){return this._stage.viewingMode===$e.Global}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(i,e,t,s,r){super({}),this._overlayRenderer=i,this._stage=e,this._allTiles=t,this._ellipsoidRadius=s,this.type=ua.TERRAIN,this.isGround=!0,this._tileSize=256,this._techniqueConfiguration=new Ft,this._passParameters=new Mg,this._drawParameters=new Ff,this._renderDataPool=new _n(OI),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new xw,this._transparencyState=qi.Opaque,this._castShadows=!1,this._inViewshed=!1,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=yi.Occlude,this.produces=new Map([[j.OPAQUE_TERRAIN,()=>this._produces()],[j.TRANSPARENT_TERRAIN,()=>this._produces()],[j.OCCLUDED_TERRAIN,()=>this._produces()]]),this._tileTextureCache=new Bu((a,n)=>r.newCache(a,n),"TileTexture"),this.tileGeometryCache=new lL(r)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(M(()=>this._overlayRenderer.rendersOccludedDraped,i=>{this.renderOccludedFlags=i?Vf:yi.Occlude,this.setNeedsRender()},nt))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?W_:Q_}set renderingDisabled(i){this._set("renderingDisabled",!!i),this.setDirty()}set visible(i){this._set("visible",!!i),this.setDirty()}updateHeading(i){var e;(e=this._tileRenderer)==null||e.updateHeading(i)}set transparency(i){this._transparencyState!==i&&(this._techniqueConfiguration.invisible=i===qi.TransparentWithDraped||i===qi.Empty,this._techniqueConfiguration.opaque=i===qi.Opaque,this._transparencyState=i,this.setNeedsRender())}get transparency(){return this._transparencyState}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(i){this._techniqueConfiguration.tileBorders!==i&&(this._techniqueConfiguration.tileBorders=i,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(i){this._techniqueConfiguration.visualizeNormals!==i&&(this._techniqueConfiguration.visualizeNormals=i,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(i){this._techniqueConfiguration.backfaceCullingEnabled!==i&&(this._techniqueConfiguration.backfaceCullingEnabled=i,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(i){this._set("renderOrder",i),this._setSortingDirty()}get layerUid(){return Xh}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(i){this._techniqueConfiguration.hasSlicePlane!==i&&(this._techniqueConfiguration.hasSlicePlane=i,this.setNeedsRender())}set textureFadingEnabled(i){this._techniqueConfiguration.textureFadingEnabled!==i&&(this._techniqueConfiguration.textureFadingEnabled=i,this.setNeedsRender())}set pbrMode(i){this._techniqueConfiguration.pbrMode!==i&&(this._techniqueConfiguration.pbrMode=i,this.setNeedsRender())}setDebugScreenSizePerspective(i){this._techniqueConfiguration.screenSizePerspective!==i&&(this._techniqueConfiguration.screenSizePerspective=i,this.setNeedsRender())}setRootTiles(i){this._rootTiles=i,this.setDirty()}setStencilEnabledLayerExtents(i){this._stencilEnabledLayerExtents=i,this._setSortingDirty()}setTileSize(i){this._tileSize=i,this._tileRenderer!=null&&(this._tileRenderer.tileSize=i),this.setDirty()}_prepareTileForLoading(i){i.renderData||(i.renderData=this._renderDataPool.acquire(),i.renderData.init(i,this._getLocalOriginOfTile(i)))}loadTile(i){this._prepareTileForLoading(i),this.updateTileGeometryState(i),this.updateTileTexture(i,se.TEXTURE_FADING)}updateTileTexture(i,e){this._tileRenderer!=null&&(this._tileRenderer.updateTileTexture(i,e===se.TEXTURE_FADING?ii.FADING:ii.UNFADED),this.setNeedsRender(),i.resetPendingUpdate(e))}updateTileGeometryState(i){for(const t of i.layerInfo[we.ELEVATION])t.pendingUpdates&=~se.GEOMETRY;i.resetPendingUpdate(se.GEOMETRY);const e=i.renderData.updateGeometryState();return e&&this.setDirty(),e}updateGeometryIfNeeded(i){i.isLoaded&&i.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(i){const e=i.renderData;e&&(e.releaseGeometry(),this._renderDataPool.release(e),e.clear(),i.renderData=null,i.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(i){const e=GL-sm,t=Math.max(0,Math.floor((i.level-e)/sm)*sm);if(this._isGlobal&&t===0)return Ea;for(;i.parent&&i.level>t;)i=i.parent;return i.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(i){this._get("wireframe")!==i&&(this._set("wireframe",i),this.setNeedsRender())}setDirty(i=st.UPDATE){this._patchesByOriginDirty=!0,this._context.requestRender(i)}_setSortingDirty(i=st.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(i)}setNeedsRender(i=st.UPDATE){this._context.requestRender(i)}initializeRenderContext(i){this._context=i,this._tileRenderer=new AL(this._rctx,this._tileSize,this._techniques,this._tileTextureCache),this.updateTileBackground(),this._emptyTex=mb(this._rctx)}uninitializeRenderContext(){this._emptyTex=je(this._emptyTex),this._tileRenderer=je(this._tileRenderer)}intersect(i,e,t,s){if(!this._rootTiles||i.options.selectOpaqueTerrainOnly&&i.options.selectionMode&&this.transparency!==qi.Opaque)return;const r=kL,a=jL;be(r,s,t),it(a,1/r[0],1/r[1],1/r[2]);const n=i.results.min,o=i.results.max,l=i.results.ground,h=i.options.store===co.MIN,d=!!i.results.ground.target,u=O2(i.verticalOffset),m=i.tolerance;let _,f=h&&n.dist!=null?n.dist:1/0;const g=i.options,y=g.normalRequired||!g.backfacesTerrain,w=new rg(!1,y),x=S=>{const C=S.renderData;if(!(C!=null&&C.vao))return;const P=C.geometry;X2(rm,P.boundingBox);const R=C.localOrigin;u!=null&&(u.localOrigin=R,u.applyToAabb(rm));const I=rm;if(ko[0]=t[0]-R[0],ko[1]=t[1]-R[1],ko[2]=t[2]-R[2],!ab(I,ko,a,m,f))return;const L=(U,ye,he)=>{U.set(this.type,S,ye,he,ho),f=h&&n.dist!=null?n.dist:1/0},G=(U,ye,he)=>{if((!y||he!=null)&&U>=0&&(g.backfacesTerrain||ue(he,r)<0)&&(g.invisibleTerrain||!g.selectionMode||e==null||e(t,s,U))){if((l.dist==null||U<l.dist)&&L(l,U,he),g.isFiltered)return;g.store===co.ALL&&(_==null?(_=b2(i.ray),L(_,U,he),i.results.all.push(_)):U<_.dist&&L(_,U,he)),(n.dist==null||U<n.dist)&&L(n,U,he),g.store!==co.MIN&&(o.dist==null||U>o.dist)&&L(o,U,he)}},H=WL;be(H,s,R);const{indices:D,indexCount:J}=P,A=P.vertexAttributes,O=A.getField(Te.POSITION,XR),te=new tO(O.typedBuffer,3,A.stride/4),$=J/3;if(!u&&$>IL){const U=S.renderData;U.intersectionData==null&&(U.intersectionData=new ox(D,0,$,te)),U.intersectionData.intersectRay(ko,H,w,G)}else HR(ko,H,0,$,D,te,u,w,G)},T=this._rootTiles;T!=null&&(()=>{const S=this._tileIterator;S.reset(T);const C=i.options.invisibleTerrain;for(let P=S.next();P;P=S.next())!(P.visible||C&&P.intersectsClippingArea)||u==null&&!P.intersectsRay(t,r,m,f)||d&&this._useStencilForTile(P)?S.skipSubtree():x(P)})()}processScaleRangeQueries(i,e){var t;if(!e.done)for(this._updatePatchGroups();i.updating&&!e.done;){i.prepare();for(const s of this._visiblePatchesByOrigin.values())for(const r of s)((t=r.renderData)==null?void 0:t.textureReference)!=null&&i.queriesForTile(r);i.process(),e.madeProgress()}}prepareTechnique(i){const e=li("enable-feature:terrain-shadows")&&i.bindParameters.shadowMap.enabled;e!==this._castShadows&&(this._castShadows=e,this._patchesByOriginDirty=!0);const t=i.bindParameters.viewshedEnabled;if(this._inViewshed!==t&&(this._inViewshed=t,this._patchesByOriginDirty=!0),i.bindParameters.slot===j.OCCLUDED_TERRAIN){if(!(i.renderOccludedMask&Vf))return null}else{const s=this.transparency===qi.Opaque?j.OPAQUE_TERRAIN:j.TRANSPARENT_TERRAIN;if(i.bindParameters.slot!==s)return null}if(this.transparency===qi.Empty)return null;switch(i.output){case E.Color:return this._techniqueConfiguration.hasScreenSpaceReflections=i.bindParameters.ssr.lastFrameColor!=null,this._techniqueConfiguration.hasCloudsReflections=i.bindParameters.cloudsFade.data!=null,this._techniqueConfiguration.receiveShadows=i.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=i.bindParameters.ssao!=null,this._techniqueConfiguration.overlayMode=this._overlayRenderer.mode,this._updateTechnique(E.Color,i.bindParameters.slot===j.OCCLUDED_TERRAIN);case E.Shadow:case E.ShadowExcludeHighlight:return this._castShadows?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(E.Shadow,!1)):null;case E.ViewshedShadow:return this._inViewshed?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(E.ViewshedShadow,!1)):null;case E.Depth:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(E.Depth,!1);case E.Normal:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(E.Normal,!1);case E.ObjectAndLayerIdColor:return this._updateTechnique(E.ObjectAndLayerIdColor,!1);case E.Highlight:return this._overlayRenderer.hasHighlights?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(E.Highlight,!1)):null}return null}renderNode(i,e){switch(this._updatePatchGroups(),e.useStencil=!1,i.output){case E.Color:{const t=i.bindParameters.slot===j.OCCLUDED_TERRAIN?mr.Occluded:mr.Color;this._renderMaterialPass(i,e,t);break}case E.Depth:case E.Normal:this._renderAuxiliaryPass(i,e,mr.Color,this._visiblePatchesByOrigin);break;case E.Highlight:this._renderAuxiliaryPass(i,e,mr.Highlight,this._visiblePatchesByOrigin);break;case E.Shadow:case E.ShadowExcludeHighlight:case E.ViewshedShadow:this._renderAuxiliaryPass(i,e,null,this._allPatchesByOrigin);break;case E.ObjectAndLayerIdColor:this._renderAuxiliaryPass(i,e,mr.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(i){if(this._tileRenderer==null)return;const e=this._tileRenderer;let t;if(i!=null){const s=uo.toUnitRGBA(i);t=St(s[0]||0,s[1]||0,s[2]||0)}e.setBackground(t),this._allTiles.forAll(s=>e.updateTileTexture(s,ii.FADING)),this._techniqueConfiguration.tileBlendInput=e.backgroundIsGrid?Wr.GridComposite:e.backgroundColor!=null?Wr.ColorComposite:Wr.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==Sl.NONE){const i=Array.from(this._visiblePatchesByOrigin.values()),e=this._stencilEnabledLayerExtents;for(const t of i)iI(this.renderOrder,t,e);i.sort((t,s)=>Cw(t[0],s[0],this.renderOrder)),this._visiblePatchesByOrigin=new Map(i.map(t=>[t[0].renderData.localOrigin,t])),this._patchSortingDirty=!1}}_rebuildPatchGroups(){var e;const i=this._rootTiles;if(i!=null){(e=i[0])==null||e.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of i)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(i){const e=this._tileIterator;for(e.resetOne(i);!e.done;){const t=e.next(),s=t.renderData;if(!s){this._numTilesCulled++;continue}const r=s.localOrigin;if(this._castShadows||this._inViewshed){let n=this._allPatchesByOrigin.get(r);n||(n=[],this._allPatchesByOrigin.set(r,n)),n.push(t)}if(!t.visible){this._numTilesCulled++,e.skipSubtree();continue}let a=this._visiblePatchesByOrigin.get(r);a||(a=[],this._visiblePatchesByOrigin.set(r,a)),a.push(t),e.skipSubtree()}}_useStencilForTile(i){for(const e of this._stencilEnabledLayerExtents)if(i.intersectsExtent(e))return!0;return!1}_renderAuxiliaryPass(i,e,t,s){const r=i.rctx;this._passParameters.overlayContent=t,r.bindTechnique(e,i.bindParameters,this._passParameters);const a=this._stencilEnabledLayerExtents.length>0;s.forEach(n=>{this._drawParameters.origin=n[0].renderData.localOrigin,e.program.bindDraw(this._drawParameters,i.bindParameters,this._passParameters);for(let o=0;o<n.length;o++)this._renderPatch(i,e,n[o],Ai.TRIANGLES,a,t)}),i.rctx.bindVAO(null)}_renderMaterialPass(i,e,t){var u;const{rctx:s}=i;this._passParameters.overlayContent=t,s.bindTechnique(e,i.bindParameters,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const r=i.bindParameters.camera,a=e.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const m=P1(this._stage.viewingMode,this._ellipsoidRadius),_=this.pointsOfInterest.centerOnSurfaceFrequent.distance;m.update({distance:_,fovY:r.fovY})}const n=this._stencilEnabledLayerExtents.length>0,o=t===mr.Occluded;o&&(a.bindTexture("tex",this._emptyTex),a.setUniform3fv("textureOpacities",Ea),a.setUniform4fv("texOffsetAndScale",V_));const l=((u=this._tileRenderer)==null?void 0:u.backgroundColor)!=null?this._tileRenderer.backgroundColor:Ea;this._techniqueConfiguration.tileBlendInput===Wr.ColorComposite&&a.setUniform3fv("backgroundColor",l);const h=this.wireframe?Ai.LINES:Ai.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&a.bindTexture("texNext",this._emptyTex);const d=this._visiblePatchesByOrigin;for(const m of d.values()){const _=m[0].renderData.localOrigin;e.program.bindDraw(new Ff(_),i.bindParameters,this._passParameters),this._numOriginsRendered++;for(const f of m){const g=f.renderData,y=g.textureReference;if(y!=null){if(!o){a.setUniform4fv("texOffsetAndScale",y.offsetAndScale),a.bindTexture("tex",y.texture.texture);const w=g.textureFadeFactor,x=w<1?g.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&x!=null&&w<1?(a.setUniform1f("fadeFactor",w),a.setUniform4fv("nextTexOffsetAndScale",x.offsetAndScale),a.setUniform3fv("nextTexOpacities",x.opacities),a.bindTexture("texNext",x.texture.texture)):a.setUniform1f("fadeFactor",1),g.textureIsFading&&this.setNeedsRender(),a.setUniform3fv("textureOpacities",y.opacities)}this._renderPatch(i,e,f,h,n,t),f.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}i.rctx.bindVAO(null)}_renderPatch(i,e,t,s,r,a){const n=t.renderData,o=n.vao,l=o==null?void 0:o.indexBuffer;if(!o||l==null)return void(zi&&console.error("Rendered tile with no indices: ",t.lij," : ",n));const h=e.program;a==null||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,n.overlay),r&&(e.useStencil=this._useStencilForTile(t),i.rctx.setPipelineState(e.getPipeline()));const d=n.geometry.indexCount;i.rctx.bindVAO(o),h.assertCompatibleVertexAttributeLocations(o),i.rctx.drawElements(s,d,l.indexType,0)}_bindOverlayPatchData(i,e){i.setUniform4fv("overlayTexOffset",e.offsets),i.setUniform4fv("overlayTexScale",e.scales)}_updateTechnique(i,e){return this._techniqueConfiguration.output=i,this._techniqueConfiguration.renderOccluded=e,this._shaderTechnique=this._techniques.releaseAndAcquire(Sw,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){}};c([p({readOnly:!0})],Vs.prototype,"_isGlobal",null),c([p()],Vs.prototype,"renderOccludedFlags",void 0),c([p({value:!1})],Vs.prototype,"renderingDisabled",null),c([p({value:!0})],Vs.prototype,"visible",null),c([p()],Vs.prototype,"renderPatchBorders",null),c([p()],Vs.prototype,"visualizeNormals",null),c([p()],Vs.prototype,"cullBackFaces",null),c([p({value:Sl.FRONT_TO_BACK})],Vs.prototype,"renderOrder",null),c([p()],Vs.prototype,"wireframe",null),Vs=c([F("esri.views.3d.terrain.TerrainRenderer")],Vs);const kL=b(),jL=b(),ko=b(),WL=b();let QL=class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}},Nr=class extends Re{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",()=>this._update()),M(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!Th(t)||t.isRejected())&&!(t.isFulfilled()&&!XL(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!((t==null?void 0:t.type)==="vector-tile"||u1(t)))),e)if(e.isResolved()){const t=Vu(e,this.viewSpatialReference,this.viewingMode);if(t!=null){const s=new Do(t.tileInfo);this._lockTilingScheme(s)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===$e.Global){const t=e.levels.length-1,s=e.spatialReference;s.isWebMercator?e=Do.makeWebMercatorAuxiliarySphere(t):TS(s)&&(e=Do.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles(M(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===$e.Global){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=Do.WebMercatorAuxiliarySphere:SS(e)&&(this.tilingScheme=Do.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;e==null||lo(e,this.extent)||(this.tilingScheme=Do.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}};function XL(i,e,t){return Vu(i,e,t)!=null}c([p()],Nr.prototype,"tilingScheme",void 0),c([p({readOnly:!0})],Nr.prototype,"extent",void 0),c([p({value:!1})],Nr.prototype,"tilingSchemeLocked",void 0),c([p({constructOnly:!0})],Nr.prototype,"viewSpatialReference",void 0),c([p({constructOnly:!0})],Nr.prototype,"layers",void 0),c([p({constructOnly:!0})],Nr.prototype,"extentHelper",void 0),c([p({constructOnly:!0})],Nr.prototype,"viewingMode",void 0),Nr=c([F("esri.views.3d.terrain.TilingSchemeLogic")],Nr);let YL=class{constructor(){this.offset=Hi(),this.scale=0,this.tile=null}init(e,t,s,r){this.tile=e,this.offset[0]=t,this.offset[1]=s,this.scale=r}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}};var qd;let Se=qd=class extends Pr.EventedMixin(Re){constructor(i){var e,t,s;super(i),this._scaleRangeQueries=new Ud,this._iteratorPool=new _n(xw,r=>r.remove=()=>this._iteratorPool.release(r)),this._postorderIterator=new tI,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new QL,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=b(),this._eyePosSurfaceSR=b(),this._splitLimits=new cr,this._frustum=mu(),this._viewProjectionMatrix=Qe(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new H1,this._frameTask=uu,this._allTiles=new Gt,this._upsampleInfoPool=new _n(YL),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=hi(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=pi.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new cl(1/0,-1/0),this.rootTileElevationBounds=new cl(1/0,-1/0),this._sebProjectorMap=new Map,this._sebProjectorCache=tR(),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this.overlayManager=new is({...i,surface:this}),this._isGlobal=!((t=(e=i.view)==null?void 0:e.state)!=null&&t.isLocal),this._isGeographic=((s=this._spatialReference)==null?void 0:s.isGeographic)??!1,this._tileConstructor=this._isGlobal?aL:iL}initialize(){const i=this.view,e=i.resourceController,t=e.memoryController;this._tileCache=new Bu((l,h)=>t.newCache(l,h),"terrain-tile"),this._upsampleMapCache=t.newCache("terrain-upsample",l=>l.unloadMapData()),this._elevationQueryCache=new sR(t.newCache("elevation-query"));const s=this.overlayManager;this._renderer=new Vs(s.renderer,i._stage,this._allTiles,Ut(i.spatialReference).radius,t),this.addHandles([M(()=>s.renderer.isEmpty,()=>this._evaluateTransparency()),M(()=>this.renderer.visible,l=>this.suspended=!l),M(()=>this.heading,l=>{this._renderer.updateHeading(l),this._updateTileTextures(ii.FADING)}),M(()=>{var l,h;return{heading:(l=i.camera)==null?void 0:l.heading,state:(h=i.state)==null?void 0:h.mode}},({heading:l,state:h})=>{if(l==null)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(l/90)%360);const d=Math.round(l)%360,u=Math.abs(d-this.heading);(h===ft.IDLE||Math.min(u,360-u)>=30)&&(this.heading=d)})],"overlayManager"),this.addHandles([M(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?ii.UNFADED:ii.IMMEDIATE)},ut),M(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?ii.UNFADED:ii.IMMEDIATE),ut),M(()=>this.backgroundColor,(l,h)=>{l!=null&&l.equals(h)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(l))},nt),M(()=>this.snapLevel,()=>this._viewChanged=!0,nt),M(()=>this.view.pointsOfInterest,l=>{this._renderer.pointsOfInterest=l,this._watchUpdatingTracking.removeAll(),l&&this._watchUpdatingTracking.add(()=>l.focus.renderLocation,()=>this._allTilesSorted=!1)}),M(()=>Ts.TERRAIN_TILE_TREE_SHOW_TILES,l=>{l&&!this._treeDebugger?ae(()=>import("./TerrainTileTree3DDebugger-C-dEUWgs.js"),__vite__mapDeps([523,1,2,3,30,14,10,11,12,13,5,6,15,9,7,8,524,32,33,85,86,40,27,28,29,26,87,88,25,31,34,35,36,37,22,38,39,89]),import.meta.url).then(({TerrainTileTree3DDebugger:h})=>{!this._treeDebugger&&Ts.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new h({view:i}))}):l||(this._treeDebugger=Y(this._treeDebugger))},si)]);const{spatialReference:r}=i;this._extentHelper=k$(this.viewingMode,{layers:i.map.allLayers,layerViews:i.allLayerViews,viewSpatialReference:r});const a=new ER({getCollections:()=>{var l,h;return(h=(l=i.defaultsFromMap)==null?void 0:l.mapCollections)==null?void 0:h.map(({layers:d})=>d)},getChildrenFunction:l=>l&&"layers"in l?l.layers:null}),n=new Nr({layers:a,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:r});this._set("tilingSchemeLogic",n),this._updateTilingScheme(),this._elevationDataRequester=e.createStreamDataRequester(Gr.ELEVATION),this._mapDataRequester=e.createStreamDataRequester(Gr.BASEMAP);const o=e.scheduler;this._frameTask=o.registerTask(ci.TERRAIN_SURFACE,this),this.addHandles([M(()=>this._extentHelper.stencilEnabledExtents,l=>this._renderer.setStencilEnabledLayerExtents(l),si),M(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),nt),M(()=>this.extent,()=>this._updateRootTiles(),si),i.on("resize",()=>this._viewChangeUpdate()),M(()=>{const l=i.state;return[this._lodBias,this.lodSnapping,i.quality,l.camera,l.contentCamera,l.fixedContentCamera]},()=>this._viewChangeUpdate(),ut),M(()=>{var l;return(l=i.qualitySettings)==null?void 0:l.fadeDuration},l=>this._renderer.textureFadingEnabled=l>0,si),M(()=>{var l;return(l=i.qualitySettings)==null?void 0:l.physicallyBasedRenderingEnabled},l=>this._renderer.pbrMode=l?Qt.Simplified:Qt.Disabled,si),M(()=>{var l;return(l=i.qualitySettings)==null?void 0:l.tiledSurface.elevationLevelDelta},()=>this._updateAllTileGeometries()),M(()=>this._userClippingExtent,()=>this._updateClippingExtent(),nt)]),this.addHandles(i.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",Y(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((i,e)=>this._unregisterTiledLayerView(e)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",Y(this.overlayManager)),this._tileCache=Y(this._tileCache),Sg.prune(),this._treeDebugger=Y(this._treeDebugger),this._renderer=Y(this._renderer),this._iteratorPool=Y(this._iteratorPool),this._upsampleMapCache=Y(this._upsampleMapCache),this._elevationQueryCache=Y(this._elevationQueryCache),this._set("view",null),this._extentHelper=Y(this._extentHelper),this._upsampleInfoPool=Y(this._upsampleInfoPool),FR(),_I()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnapping===up.ON){const i=this.view,e=this.tilingScheme,t=i.terrainScale;if(e&&t){const s=e.levelAtScale(t)+i.qualitySettings.tiledSurface.lodBias,r=e.getMaxLod();return Math.min(s,r||1/0)}}return null}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?up.ON:up.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get _userClippingExtent(){const{spatialReference:i}=this,{clippingArea:e}=this.view;if(e==null||i==null)return null;const t=hi(),s=Xy(e,t,i)?t:null,r=this._get("extent");return lo(s,r)?r:s}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const i=Sm(this.groundExtent,this._userClippingExtent,hi()),e=this._get("extent");return lo(i,e)?e:i}get groundExtent(){return this._tilingSchemeExtent!=null?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){var i;return(i=this.tilingSchemeLogic)==null?void 0:i.extent}get updating(){var i,e;return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||(i=this._watchUpdatingTracking)!=null&&i.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||(e=this.overlayManager)!=null&&e.updating)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){var i,e,t;return((t=(e=(i=this.view)==null?void 0:i.map)==null?void 0:e.ground)==null?void 0:t.opacity)??1}set baseOpacity(i){this.view.map.ground.opacity=i}get viewingMode(){return this.view.state.viewingMode}get ready(){return this._rootTiles!=null}set renderOrder(i){this._renderer.renderOrder=i,this._set("renderOrder",i)}get rootTiles(){return this._rootTiles}get spatialReference(){var i;return((i=this.tilingScheme)==null?void 0:i.spatialReference)??null}get backgroundColor(){var i,e,t;return(t=(e=(i=this.view)==null?void 0:i.map)==null?void 0:e.ground)==null?void 0:t.surfaceColor}set backgroundColor(i){this.view.map.ground.surfaceColor=i}set slicePlaneEnabled(i){this._renderer.slicePlaneEnabled=i,this._set("slicePlaneEnabled",i),this._evaluateTransparency()}get tilingSchemeLocked(){var i;return((i=this.tilingSchemeLogic)==null?void 0:i.tilingSchemeLocked)??!1}get wireframe(){var i;return(i=this._renderer)==null?void 0:i.wireframe}set wireframe(i){i!==this._renderer.wireframe&&(this._renderer.wireframe=i,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===qi.Opaque}set suspended(i){this._set("suspended",i),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(i,e,t,s){this._renderer.intersect(i,e,t,s)}getElevationLevelDelta(i){return i<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(i,e,t,s){const r=this._rootTiles;if(!(r!=null&&r.length)||r[0].layerInfo[we.ELEVATION].length===0)return null;let a=this._elevationProjectorCache.get(s);if(a===void 0&&(a=Bm(s,this._spatialReference)??null,this._elevationProjectorCache.set(s,a)),a==null)return Pe.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const n=it(th,i,e,t);return a(n,0,n,0),Kv(r,n[0],n[1])}getElevations(i,e,t){const s=this._rootTiles,r=s?s[0].layerInfo[we.ELEVATION].length:0;if(s!=null&&s.length&&r!==0)for(let a=0;a<e;++a){const n=3*a;t(a,Kv(s,i[n],i[n+1]))}else for(let a=0;a<e;++a)t(a,null)}getScale(i){if(!this.tilingScheme)return null;if(!zh(i,th,this.spatialReference))return Pe.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const e=this._rootTiles;if(e!=null){for(const t of e)if(t!=null&&t.containsPoint(th)){let s=t;for(;s.children[0]&&!s.rendered;){const r=s.children[0].extent;let a=0;th[0]>r[2]&&(a+=1),th[1]<r[1]&&(a+=2),s=s.children[a]}return this._getLodBiasCorrectedScale(s.level)}}return 1/0}_ensureSEBProject(i){const e=this._sebProjectorMap.get(i);if(e)return e;const t=Bm(i,this._tilingSchemeSpatialReference,this._sebProjectorCache)??null;return this._sebProjectorMap.set(i,t),t}getSphereElevationBounds(i,e){const t=this._ensureSEBProject(e);if(t==null)return Pe.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;f2(i,jo);const s=qt(jo);t(s,0,s,0);const r=new gu,a=this._rootTiles;if(a!=null){const n=[];for(const l of a)n.push(l);let o=0;for(;o<n.length;){const l=n[o];if(++o,!yf(l.extent,jo))continue;const h=l.children;if(h[0]==null||l.rendered)r.expandElevationRangeValues(l.elevationBoundsMin,l.elevationBoundsMax);else for(const d of h)n.push(d)}}return r}getRootElevationBounds(){return new gu(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getSphereScale(i,e){if(!this.tilingScheme)return null;if(!zh(i,qt(jo),this.spatialReference))return Pe.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;jo[3]=e;let t=null;const s=a=>{if(a&&yf(a.extent,jo)){const n=a.children;if(n[0]&&!a.rendered)for(const o of n)s(o);else{const o=this._getLodBiasCorrectedScale(a.level);t=t==null?o:Math.min(t,o)}}},r=this._rootTiles;if(r!=null)for(const a of r)s(a);return t}queryVisibleScaleRange(i,e,t,s){const r=e?this.tilingScheme.levelAtScale(e):0,a=t?this.tilingScheme.levelAtScale(t):1/0,n=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(i,r+n,a+n,s)}_evaluateTransparency(){var a,n;const i=this.baseOpacity,e=this.overlayManager.renderer.isEmpty,t=this._renderer.transparency,s=this._allSurfaceLayersTransparent()?e?qi.Empty:qi.TransparentWithDraped:i>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?qi.Opaque:qi.Semitransparent,r=t!==s;return r&&(this._renderer.transparency=s,(n=(a=this.view)==null?void 0:a._stage)==null||n.renderer.setParameters({terrainTransparency:this._renderer.transparency})),r}_updateTilingScheme(){var t,s,r,a;const i=this.tilingSchemeLogic.tilingScheme;if(i===this.tilingScheme)return;ei(!!i,"tiling scheme cannot be reset to undefined"),this._isGlobal=!((s=(t=this.view)==null?void 0:t.state)!=null&&s.isLocal),this.tilingScheme&&this._removeAllTiles();const e=(i==null?void 0:i.spatialReference)??pi.WebMercator;this._spatialReference=e,this._isWebMercator=!!(e!=null&&e.isWebMercator),this._isWebMercatorOnPlateCarree=this._isWebMercator&&d1((r=this.view)==null?void 0:r.renderSpatialReference),this._isGeographic=(e==null?void 0:e.isGeographic)??!1,this._set("tilingScheme",i),this._tilingSchemeSpatialReference=(a=this.tilingScheme)==null?void 0:a.spatialReference,this._sebProjectorMap.clear(),this._updateClippingExtent(),i&&(this._updateTiledLayers(),this._renderer.setTileSize(i.pixelSize),this.overlayManager.setSpatialReference(i.spatialReference),this._updateRootTiles())}_acquireTile(i,e,t,s){const r=this._tileCache.pop(qd._tileMemcacheKey);return r?(r.init(i,e,t,s,this),r):new this._tileConstructor(i,e,t,s,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:i,tilingScheme:e}=this;if(!e)return;const t=KL;let s=e.rootTilesInExtent(i,t,5*Pc);if(this._rootTiles!=null){if(s.length>Pc)return void Pe.getLogger(this).warn(PS);const r=this._rootTiles.map(n=>n.lij),a=wC(r,s,Fd);if(this._updatingRootTiles=!0,a.removed.length>0||a.added.length>0){const n=this._rootTiles.filter(o=>!(a.removed.findIndex(l=>Fd(l,o.lij))>-1)||(this._purgeTile(o),!1));a.added.forEach(o=>n.push(this._newRootTile(o))),this._setRootTiles(n)}}else this._updatingRootTiles=!0,s.length>Pc&&(Pe.getLogger(this).warn(RS),s=e.rootTilesInExtent(i,t,Pc)),this._setRootTiles(s.map(r=>this._newRootTile(r)));lo(t,this._rootTilesExtent)||(this._rootTilesExtent=hi(t)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const i=this._allTiles.filter(e=>e.isLoaded&&e.intersectsClippingArea);i.sort(jr),i.forEach(e=>this._renderer.updateTileGeometryState(e)),i.forEach(e=>e.renderData.updateNeighborData()),this._updateTilesGeometries(i),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(i){if(i.length===0)return;i.sort(jr);const e=this.renderer;i.forEach(t=>e.updateGeometryIfNeeded(t)),i.forEach(t=>this._pendingTilesForElevationUpdateEvent.add(t))}_shouldSplit(i){return i.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===se.SPLIT}_newRootTile(i){const e=this._acquireTile(0,i[1],i[2],null);return this._shouldSplit(e)&&e.setPendingUpdate(se.SPLIT),this._loadTile(e),this._markTileToUpdate(e),this._updateRootTileElevationBounds(),e}_setRootTiles(i){if(this._rootTiles=i,this._allTiles.clear(),i!=null){const e=this._iteratorPool.acquire();for(e.reset(i);!e.done;)this._allTiles.push(e.next());e.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(i)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(i){i.updateClippingStatus(this.extent)&&i.resetPendingUpdate(se.GEOMETRY)&&this._updateTileGeometryState(i)}_updateTilesVisibility(i){if(i==null)return;const e=hI(i),t=this.visibleElevationBounds;let s=e?t.min:1/0,r=e?t.max:-1/0;const a=this.extent,n=this._viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(i);!o.done;){const l=o.next();l.updateClippingStatus(a)&&l.resetPendingUpdate(se.GEOMETRY)&&this._updateTileGeometryState(l),l.computeVisibility(),l.updateScreenDepth(n),l.renderData&&(s=Math.min(l.elevationBoundsMin,s),r=Math.max(l.elevationBoundsMax,r))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(s)&&isFinite(r)&&(t.min!==s||t.max!==r)&&(this.visibleElevationBounds=new cl(s,r))}_updateRootTileElevationBounds(){let i=1/0,e=-1/0;const t=this._rootTiles;t!=null&&t.forEach(({elevationBoundsMin:r,elevationBoundsMax:a})=>{i=Math.min(i,r),e=Math.max(e,a)});const s=this.rootTileElevationBounds;s.min===i&&s.max===e||(this.rootTileElevationBounds=new cl(i,e))}_updateViewDependentParameters(){const{camera:i,contentCamera:e}=this.view.state,t=Math.tan(.5*e.fovX),s=Math.tan(.5*e.fovY),r=this.tilingScheme.pixelSize,a=2**-this._lodBias*i.pixelRatio;this._splitLimits.aboveGround=i.aboveGround,this._splitLimits.fovX=t,this._splitLimits.fovY=s,this._splitLimits.relativeWidthLimit=r/i.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=r/i.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=qm(this._splitLimits.frustum??mu(),e.frustum):this._splitLimits.frustum=null,qm(this._frustum,i.frustum),Ks(this._viewProjectionMatrix,e.projectionMatrix,e.viewMatrix),le(this._eyePosRenderSR,e.eye),Yh(i.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(i){i.updateVisibility(),this._renderer.updateTileGeometryState(i)&&this._markTileToUpdate(i),this._usedMemory=null}_markAllTileNeighborsForUpdate(i){i.forEachLoadedNeighbor(e=>{this._layerViews[we.MAP].some(tu)&&e.setPendingUpdate(se.TEXTURE_FADING),this._pendingTilesToUpdate.add(e)})}_updateTileTexture(i,e){const t=i.resetPendingUpdate(se.TEXTURE_FADING)?se.TEXTURE_FADING:!!i.resetPendingUpdate(se.TEXTURE_NOFADING)&&se.TEXTURE_NOFADING;t&&(this._renderer.updateTileTexture(i,t),this._usedMemory=null,e.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const i=am.extent;Jr(i),this._pendingTilesForElevationUpdateEvent.forEach(e=>hn(i,e.extent,i)),this._pendingTilesForElevationUpdateEvent.clear(),am.spatialReference=this.spatialReference,this.emit("elevation-change",am),this._shouldEmitChangeEvent=!1}runTask(i){this._handleLayerViewChanges(i),this._frameTask.processQueue(i),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,i),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(i),this._sortTiles(i);const e=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(i,e),this._updateElevation(i),this._updateTextures(i),e||this._mergeAndSplit(i,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),i.done&&i.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),zi&&this._checkTileInvariant(),!i.hasProgressed)return Zi}_checkTileInvariant(){const i=new Map;this._allTiles.forAll(e=>i.set(e,new Set)),this._allTiles.forAll(e=>{var t;if(ei(e.rendered===e.isLeaf,` rendered ${e.rendered} != ${e.isLeaf} leaf`),!e.isLeaf){const s=a=>a.unmergableChildCount===0&&a.maxLevelDeltaNeighborCount===0,r=e.children.reduce((a,n)=>a+(s(n)?0:1),0);if(ei(e.unmergableChildCount===r,` Tile[${e.lij.toString()}] unmergeable child count mismatch: actual ${e.unmergableChildCount} vs ${r}`),e.hasPendingUpdate(se.MERGE)){ei(!e.hasPendingUpdate(se.SPLIT),"Tile can be both split and merge at the same time");for(const a of e.children)ei(a.isLeaf||a.hasPendingUpdate(se.MERGE),"Child of tile to merge must also merge")}}for(let s=0;s<4;++s){if(e.rendered){const o=(t=e.renderData)==null?void 0:t.geometryState.edgePeerNeighbors[s];if(o!=null){{const l=e.level-o.level<=ti;l||(console.log(`tile level delta [${e.lij.toString()}] vs [${o.lij.toString()}] > ${ti}  (edge[${s}])`),ei(l,`tile level delta [${e.level}] vs [${o.level}] > ${ti}`))}ei(e.level-o.level<=ti,`Max tile lod delta exceeded: [${e.lij.toString()}] vs [${o.lij.toString()}]`)}}const r=e.level-ti,a=o=>o.isLeaf||o.level===e.level,n=e.findNeighborTile(yr[s],a);if(n!=null){if(e.isLeaf&&e.level>=ti){let o=n;for(;e.level-o.level<ti;)o=o.parent;const l=[r,e.lij[1]>>ti,e.lij[2]>>ti];if(!Fd(l,o.lij)){const h=i.get(o);ei(!h.has(e),"Cannot already have neighbor"),h.add(e)}}ei(n.rendered||n.level===e.level,"Non-same-level-neighbor of rendered must be rendered"),ei(e.level-n.level<=ti,`Tile level delta [${e.level}] vs [${n.level}] > ${ti}`)}}}),this._allTiles.forAll(e=>{const t=e.maxLevelDeltaNeighborCount,s=i.get(e);ei(t===s.size,`Tile[${e.lij.toString()}] merge-blocker mismatch: actual ${t} vs ${s.size}`)})}_updateAllTilesStatus(i){if(!this._viewChanged||!this._rootTiles||i.done)return;this._viewChanged=!1;const e=new JL(this._allTiles.length);e.pushAll(this._rootTiles);const t=this.snapLevel,s=this._splitLimits,r=this._eyePosRenderSR;this._allTiles.forAll(n=>{n.maxLevelDeltaNeighborCount=0,n.unmergableChildCount=0});const a=this._viewProjectionMatrix;for(;!e.empty;){const n=e.pop(),o=n.parent,l=o!=null&&o.hasPendingUpdate(se.MERGE),h=l?se.MERGE:n.shouldSplit(s,r,t),d=h===se.SPLIT;n.isLeaf?nm(n,d):e.pushAll(n.children),l?(n.resetPendingUpdate(se.SPLIT),n.isLeaf||n.setPendingUpdate(se.MERGE),this._updateClippingStatus(n),n.updateVisibility(),n.updateScreenDepth(a)):d?(n.resetPendingUpdate(se.MERGE),n.isLeaf&&n.setPendingUpdate(se.SPLIT)):(n.resetPendingUpdate(se.SPLIT)&&n.updateAgentSuspension(),h===se.ELEVATION&&n.updateAgents(we.ELEVATION),n.isLeaf||(n.setPendingUpdate(se.MERGE),n.resetPendingUpdate(se.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),i.madeProgress()}_sortTiles(i){i.done||this._allTilesSorted||(oI(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),i.madeProgress())}_markTileToUpdate(i){N(i.isLoaded),i.intersectsClippingArea&&(this._pendingTilesToUpdate.add(i),this._markAllTileNeighborsForUpdate(i))}_updatePendingTileGeometries(){const i=this._pendingTilesToUpdate,e=Array.from(i.keys()).filter(r=>r.isLoaded&&r.intersectsClippingArea);if(e.length===0)return void i.clear();const t=(r,a)=>{!(a!=null&&a.isLoaded)||!a.intersectsClippingArea||a.level<r.level||i.has(a)||(i.add(a),e.push(a),a.renderData.updateNeighborData())};e.sort(jr);const s=e.length;for(let r=0;r<s;++r){const a=e[r];N(a.isLoaded),N(a.intersectsClippingArea);const n=a.renderData;n.updateNeighborData();const o=n.dirtyEdgeResolutions,l=n.geometryState,h=d=>{var m;const u=eu[d];t(a,(m=l.cornerPeerNeighbors[d])==null?void 0:m.findCorner(Jd(u),_=>_.isLoaded))};for(let d=0;d<4;++d)if(o&1<<d){const u=n.geometryState.edgePeerNeighbors[d];u&&(u==null?void 0:u.level)>=a.level&&u.forAllSubtreeOnSide(N_(yr[d]),m=>!(!m.isLoaded||!m.intersectsClippingArea)&&(N(i.has(m)||jr(a,m)<0),t(a,m),!0)),h((d+1)%4),h(d)}}i.clear(),this._updateTilesGeometries(e),this._shouldEmitChangeEvent=!0,zi&&Em&&this.checkAllTilesWaterproofness()}_mergeAndSplit(i,e){if(this.suspended||i.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let t=!1;const s=this.view.state.fixedContentCamera;let r=!1;for(;!i.done;){r=!0;let a=!1;const n=!this._allTiles.some(o=>{if(!t&&!s&&!o.visible)return i.done;let l=o;if(o.hasPendingUpdate(se.MERGE)){if(!e||o.unmergableChildCount>0)return i.done;for(o.resetPendingUpdate(se.MERGE);l.parent!=null&&l.parent.unmergableChildCount===0&&l.parent.resetPendingUpdate(se.MERGE);)l=l.parent;this._mergeTile(l),a=!0,i.madeProgress()}else if(o.resetPendingUpdate(se.SPLIT)){let h=!0;const d=o.level;if(d>=ti){const u=m=>m.isLeaf||d-m.level<ti;for(let m=0;m<4;++m){const _=o.findNeighborTile(yr[m],u);_!=null&&d-_.level===ti&&(h=!1,zi&&(N(_.isLeaf),N(_.hasPendingUpdate(se.SPLIT))))}}h?(this._splitTile(o),i.madeProgress(),a=!0):o.setPendingUpdate(se.SPLIT)}return i.done});if(a&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),n){if(!t){t=!0;continue}if(!a)break}else this._allTilesDirty=!0}r?i.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(i)}_updateElevation(i){i.done||(this._allTiles.some(e=>(e.resetPendingUpdate(se.GEOMETRY)&&(this._updateTileGeometryState(e),this._shortBatches&&this._updatePendingTileGeometries(),i.madeProgress()),i.done)),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(i){i.done||this._allTiles.some(e=>(this._updateTileTexture(e,i),i.done))}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(st.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const i=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-i)*OS}_getLodBiasCorrectedScale(i){const e=this.tilingScheme.levels,t=Z(i-this._lodBias,0,e.length-1),s=t-Math.floor(t);return e[Math.floor(t)].scale*(1-s)+e[Math.ceil(t)].scale*s}_removeAllTiles(){this._rootTiles!=null&&(this._rootTiles.forEach(i=>this._purgeTile(i)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.renderer.visible=!1}_purgeDescendantTiles(i){if(!i.children[0])return;const e=i.children.slice();i.unsetChildren();for(let t=0;t<4;++t)this._purgeTile(e[t])}_purgeTile(i){i.isLeaf?Jv(i):this._purgeDescendantTiles(i),this._allTiles.removeUnordered(i),this._unloadTile(i),this._tileCache.put(qd._tileMemcacheKey,i)}_unloadTile(i){this._pendingTilesToUpdate.delete(i),this._pendingTilesForElevationUpdateEvent.delete(i),i.unload(this._renderer)}_splitTile(i){ei(i.isLeaf,"Tile that is already split should not be split again!"),ei(i.rendered,"Tile marked to split is not rendered"),Jv(i);const e=i.level+1,t=2*i.lij[1],s=2*i.lij[2],r=i.setChildren(this._createTile(e,t,s,i),this._createTile(e,t,s+1,i),this._createTile(e,t+1,s,i),this._createTile(e,t+1,s+1,i));this._allTiles.pushArray(r),i.updateAgentSuspension(),ei(i.rendered,"parent should be rendered"),this._unloadTile(i),r.forEach(a=>this._loadTile(a)),r.forEach(a=>this._pendingTilesToUpdate.add(a)),this._markAllTileNeighborsForUpdate(i),this._emitTileScaleChange(i,i.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),r.forEach(a=>nm(a,a.hasPendingUpdate(se.SPLIT))),++this._performanceInfo.numSplit}_emitTileScaleChange(i,e=i.level){cd.spatialReference=this.spatialReference,cd.extent=i.extent,cd.scale=this._getLodBiasCorrectedScale(e),this.emit("scale-change",cd)}_createTile(i,e,t,s){ei(!!s,"_createTile sanity check");const r=this._acquireTile(i,e,t,s);return r.updateClippingStatus(this.extent),r.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(r)&&r.setPendingUpdate(se.SPLIT),r}get _shortBatches(){return this.view.state.mode!==ft.IDLE}_mergeTile(i){ei(!i.hasPendingUpdate(se.SPLIT),"_mergeTile sanity check"),ei(!i.isLeaf,"Cannot merge a leaf"),i.isLeaf||(this._purgeDescendantTiles(i),ei(!i.renderData,"_mergeTile sanity check"),this._loadTile(i),this._markTileToUpdate(i),this._emitTileScaleChange(i),this._shortBatches&&this._updatePendingTileGeometries(),nm(i,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(i){i.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(i)}_handleLayerViewChanges(i=Ta){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let e=!1;const t=new Set;let s=-1;for(let r=this.view.allLayerViews.length-1;r>=0;r--){const a=this.view.allLayerViews.items[r];if(t.add(a.uid),Am(a)||zl(a))if(this._basemapLayerViewHandles.has(a.uid)&&!zl(a)){const n=this._layerClassFromLayerView(a),o=this._getLayerIdxByUID(n,a.uid);o!=null&&((o<s||s==null)&&(e=!0),s=o)}else this._registerTiledLayerView(a),a.layer.loaded&&(e=!0)}this._basemapLayerViewHandles.forEach((r,a)=>{t.has(a)||(this._unregisterTiledLayerView(a),e=!0)}),e&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),i.madeProgress()}_allSurfaceLayersTransparent(){var e,t;let i=((t=(e=this.view.map)==null?void 0:e.ground)==null?void 0:t.opacity)===0;for(const s of this.view.allLayerViews.items)if(Df(s)&&!vd(s.layer)&&s.fullOpacity!==0)return i=!1,i;return i}_hasCompositeBlendMode(){for(const i of this.view.allLayerViews.items)if((Hh(i)||zl(i))&&cL(g_[i.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(i){return $f(i)?we.ELEVATION:we.MAP}_registerTiledLayerView(i){const e=[];if((Hh(i)||zl(i))&&e.push(M(()=>i.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(ii.UNFADED)})),!zl(i)){const t=this._layerClassFromLayerView(i);e.push(M(()=>i.suspended,()=>this._updateTiledLayers())),e.push(M(()=>i.fullOpacity,()=>this._updateTileTextures(ii.UNFADED))),e.push(M(()=>"effectiveScaleRange"in i.layer?i.layer.effectiveScaleRange:null,()=>this._restartAllAgents(t))),e.push(i.on("data-changed",()=>{const s=this._getLayerIdxByUID(t,i.uid);s!=null&&this._invalidateLayerData(s,t)}))}this._unregisterTiledLayerView(i.uid),this._basemapLayerViewHandles.set(i.uid,e)}_unregisterTiledLayerView(i){const e=this._basemapLayerViewHandles.get(i);if(e){for(const t of e)t.remove();this._basemapLayerViewHandles.delete(i)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const i=this.view.allLayerViews,e=[[],[]];let t=null;i.forEach(s=>{if(!s.layer||s.suspended||!Am(s)||!s.fullExtent)return;const r=this._layerClassFromLayerView(s);if(r===we.MAP){const a=s.displayLevelRange.maxLevel;a!==1/0&&(t===null||a>t)&&(t=a)}e[r].push(s)});for(const s of Xn){const r=this._layerViews[s],a=e[s];a.reverse();const n=a.length;let o=r.length!==n;const l=new Array(n),h=new Array(r.length);this._layerIndexByUid[s].clear();for(let d=0;d<n;d++){const u=a[d].uid;this._layerIndexByUid[s].set(u,d);const m=r.indexOf(a[d]);l[d]=m,d!==m&&(o=!0),m>-1&&(h[m]=d)}if(o){const d=this._postorderIterator;for(d.reset(this._rootTiles);!d.done;)d.next().modifyLayers(h,l,s);this._layerViews[s]=a,this._restartAllAgents(s),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(t)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(i){const e=this._postorderIterator;for(e.reset(this._rootTiles);!e.done;){const t=e.next();t.restartAgents(i),i===we.ELEVATION&&t.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(i,e){return this._layerViews[e][i]}numLayers(i){return this._layerViews[i].length}_updateTileTextures(i){this._allTiles.forAll(e=>{e.updateAgents(we.MAP),i===ii.IMMEDIATE?this.renderer.updateTileTexture(e,se.TEXTURE_NOFADING):e.updateRenderData(we.MAP,i)}),this._evaluateTransparency()}_invalidateLayerData(i,e){this._allTiles.forAll(t=>t.removeLayerAgent(i,e)),this._allTiles.forAll(t=>t.invalidateLayerData(i,e))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(i=st.UPDATE){this.renderer.setNeedsRender(i)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(i,e,t,s){const r=this.layerViewByIndex(e,t),a=r.layer;return!a.tilemapCache||tu(r)?this._requestTileData(i,t,r,s):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(i.lij[0],i.lij[1],i.lij[2],{...s,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(n=>{throw--this._asyncWorkItems,Qi(s),mn(n)||this._dataMissing(i,t,r),n}).then(()=>this._frameTask.schedule(()=>this._requestTileData(i,t,r,s),s.signal)))}_requestTileData(i,e,t,s){const r=e===we.ELEVATION;return s.requester??(s.requester=r?this._elevationDataRequester:this._mapDataRequester),r?$f(t)?this._requestElevationTileData(i,t,s):Promise.reject():Df(t)?this._requestMapTileData(i,t,s):Promise.reject()}_requestElevationTileData(i,e,t){++this._asyncWorkItems;const s=a=>{!xh(t)&&a&&(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(i,e,a))},r=a=>{mn(a)||(Pe.getLogger(this).error(`Tile ${i.lij.toString()} layer ${we.ELEVATION}/${e.uid} error ${a}`),this._dataMissing(i,we.ELEVATION,e),this.requestUpdate())};return e.fetchTile(i.lij,t).then(a=>this._frameTask.schedule(()=>s(a)),r).finally(()=>--this._asyncWorkItems)}_elevationDataArrived(i,e,t){const s=this._layerIndexByUid[we.ELEVATION].get(e.uid);if(s==null)return void Pe.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",we.ELEVATION,i.lij.toString());const r=new H$(i.lij,i.extent,t);i.dataArrived(s,we.ELEVATION,r);const a=[i],n=i.level,o=this._iteratorPool.acquire();for(o.reset(a);!o.done;){const l=o.next();l.findElevationBoundsForLayer(s,n),l.computeElevationBounds()}n===0&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(a)}_requestMapTileData(i,e,t){++this._asyncWorkItems;const s=(o,l)=>{pl(l),xh(t)||(console.error(`Tile ${i.lij.toString()} layer ${we.MAP}/${e.uid} error ${o}`),this._dataMissing(i,we.MAP,e),this.requestUpdate())},r=o=>l=>s(l,o),a=o=>this._frameTask.schedule(()=>{this.requestUpdate(),xh(t)?pl(o):this._mapTileDataArrived(i,e,o)},t.signal,r(o)).catch(r(o)),n=(o,l=null)=>this._frameTask.schedule(()=>s(o,l));return e.fetchTile(i.lij,t).then(a,n).finally(()=>--this._asyncWorkItems)}_mapTileDataArrived(i,e,t){const s=this._getLayerIdxByUID(we.MAP,e.uid);if(s==null)return pl(t),void Pe.getLogger(this).warn("TerrainSurface: received data from unknown layer");i.dataArrived(s,we.MAP,t)}_getLayerIdxByUID(i,e){return this._layerIndexByUid[i].get(e)}_dataMissing(i,e,t){const s=this._getLayerIdxByUID(e,t.uid);s!=null?i.dataMissing(s,e):Pe.getLogger(this).warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(i){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll(e=>{e.renderData&&this.overlayManager.setTileParameters(e)}),this._renderer.setNeedsRender(i))}get performanceInfo(){const i=this._performanceInfo;return i.numNodes=this._allTiles.length,i.numLeaves=i.numVisible=i.numRendered=i.numLoadedPerLevel.length=i.numRenderedPerLevel.length=0,this._allTiles.forAll(e=>{e.isLeaf&&i.numLeaves++;const t=e.level;e.renderData&&(i.numLoadedPerLevel[t]=(i.numLoadedPerLevel[t]||0)+1),e.visible&&(i.numVisible++,e.rendered&&(i.numRenderedPerLevel[t]=(i.numRenderedPerLevel[t]||0)+1,i.numRendered++))}),i}get usedMemory(){return this.tilingScheme?(this._usedMemory==null&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce((i,e)=>i+e.usedMemory,0)):null}getUsedMemoryForLayerView(i){let e=0;const t=this._layerClassFromLayerView(i),s=this._getLayerIdxByUID(t,i.uid);return s!=null&&this._allTiles.forAll(r=>e+=r.getUsedMemoryForLayer(t,s)),e}getTile(i){if(i==null||this._rootTiles==null)return null;const e=i.split("/").map(n=>+n);if(e[0]===0)return this._rootTiles.find(n=>n.lij[1]===e[1]&&n.lij[2]===e[2]);const t=e[0],s=e[1]>>t,r=e[2]>>t;let a;if(this._rootTiles.some(n=>n.lij[1]===s&&n.lij[2]===r&&(a=n,!0)),a){let n=1<<e[0]-1;for(;a.lij[0]<e[0];){let o=e[1]&n?2:0;if((e[2]&n)>0&&o++,!a.children[o])return null;a=a.children[o],n>>=1}return ei(a.lij[0]===e[0]&&a.lij[1]===e[1]&&a.lij[2]===e[2],"not the right tile?"),a}return null}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(i){this._renderer.renderPatchBorders=i}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(i){this._renderer.visualizeNormals=i}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(i){this._renderer.renderingDisabled=i}get test(){}checkAllTilesWaterproofness(){if(!Em)return;const i=this._rootTiles;if(i==null)return;const e=a=>{var n,o,l;return((l=(o=(n=a==null?void 0:a.renderData)==null?void 0:n.geometry)==null?void 0:o.indices)==null?void 0:l.length)>0},t=(a,n)=>{e(a)&&console.error("Tile[",a.lij,"] has geometry although parent[",n.lij,"] has geom")},s=a=>{var n,o;if(a.intersectsClippingArea)if(a.renderData&&!a.renderData.geometryState&&console.error("Tile[",a.lij,"] has renderData but not geometryState"),a.renderData&&!a.renderData.geometry&&console.error("Tile[",a.lij,"] has renderData but not geometryInfo"),!((n=a.renderData)!=null&&n.geometry)||(((o=a.renderData.geometry.indices)==null?void 0:o.length)??0)>0||console.error("Tile[",a.lij,"] has renderData but no indices - geometryInfo: ",a.renderData.geometry),e(a)){a.checkGeometryWaterproofness();for(const l of a.children)t(l,a)}else if(a.isLeaf)console.error("Tile[",a.lij,"] has no geometry and no children, from root to leaf");else for(const l of a.children)s(l)},r=a=>{var h;const n=((h=a.parent)==null?void 0:h.visible)??!0,o=a.visible;a.computeVisibility();const l=a.visible;if(o!==l&&n&&console.error(" Tile[",a.lij,"] has out of date visibility: ",o," instead of ",l),!a.isLeaf)for(const d of a.children)r(d)};for(const a of i)s(a),r(a)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(i){return this._isGlobal&&i[2]===this.lijEastEnd(i[0])-1}isWestEndWrap(i){return this._isGlobal&&i[2]===0}lijEastEnd(i){return 1<<i+(this._isGeographic?1:0)}wrapEastWest(i){const e=this.lijEastEnd(i[0]),t=i[2];if(0<=t&&t<e)return i;if(!this._isGlobal)return null;const s=(t+(t<0?e:0))%e;return[i[0],i[1],s]}enableInternalChecks(i){MS(i)}enableWaterproofnessChecks(i){ES(i)}};Se._tileMemcacheKey="TerrainTileMemcache",c([p()],Se.prototype,"_renderer",void 0),c([p({constructOnly:!0})],Se.prototype,"_scaleRangeQueries",void 0),c([p({constructOnly:!0})],Se.prototype,"view",void 0),c([p({constructOnly:!0})],Se.prototype,"overlayManager",void 0),c([p()],Se.prototype,"_hasPendingUpdates",void 0),c([p()],Se.prototype,"_asyncWorkItems",void 0),c([p()],Se.prototype,"_allTilesDirty",void 0),c([p()],Se.prototype,"_allTilesSorted",void 0),c([p()],Se.prototype,"_viewChanged",void 0),c([p({type:Number})],Se.prototype,"heading",void 0),c([p()],Se.prototype,"_splitLimits",void 0),c([p({readOnly:!0})],Se.prototype,"_watchUpdatingTracking",void 0),c([p()],Se.prototype,"_frameTask",void 0),c([p({readOnly:!0})],Se.prototype,"snapLevel",null),c([p({readOnly:!0})],Se.prototype,"lodSnapping",null),c([p()],Se.prototype,"_userClippingExtent",null),c([p()],Se.prototype,"_rootTilesExtent",void 0),c([p({readOnly:!0})],Se.prototype,"extent",null),c([p({readOnly:!0})],Se.prototype,"groundExtent",null),c([p({readOnly:!0})],Se.prototype,"_tilingSchemeExtent",null),c([p({readOnly:!0})],Se.prototype,"updating",null),c([p({readOnly:!0})],Se.prototype,"running",null),c([p(B$)],Se.prototype,"updatingProgress",void 0),c([p({readOnly:!0})],Se.prototype,"updatingProgressValue",null),c([p()],Se.prototype,"_maxNumUpdating",void 0),c([p()],Se.prototype,"baseOpacity",null),c([p()],Se.prototype,"hasCompositeBlendMode",void 0),c([p({readOnly:!0})],Se.prototype,"viewingMode",null),c([p()],Se.prototype,"maxTextureScale",void 0),c([p({readOnly:!0})],Se.prototype,"ready",null),c([p({value:Sl.FRONT_TO_BACK})],Se.prototype,"renderOrder",null),c([p({readOnly:!0})],Se.prototype,"rootTiles",null),c([p()],Se.prototype,"_rootTiles",void 0),c([p({readOnly:!0})],Se.prototype,"spatialReference",null),c([p({type:uo})],Se.prototype,"backgroundColor",null),c([p({value:!1})],Se.prototype,"slicePlaneEnabled",null),c([p({readOnly:!0})],Se.prototype,"tilingScheme",void 0),c([p({readOnly:!0})],Se.prototype,"tilingSchemeLocked",null),c([p({readOnly:!0})],Se.prototype,"tilingSchemeLogic",void 0),c([p()],Se.prototype,"wireframe",null),c([p({value:!1})],Se.prototype,"suspended",null),c([p()],Se.prototype,"fadeDuration",null),c([p()],Se.prototype,"visibleElevationBounds",void 0),c([p()],Se.prototype,"rootTileElevationBounds",void 0),c([p()],Se.prototype,"_layerViewsDirty",void 0),c([p()],Se.prototype,"renderPatchBorders",null),c([p()],Se.prototype,"visualizeNormals",null),c([p()],Se.prototype,"renderingDisabled",null),Se=qd=c([F("esri.views.3d.terrain.TerrainSurface")],Se);const ZL=Se,th=b(),jo=Sr(),KL=hi();new Gt;const am=new _T("ground"),cd={spatialReference:null,extent:null,scale:0};function Kv(i,e,t){var s;for(const r of i){if(!r.containsPointXY(e,t))continue;let a=r;for(;a&&!a.renderData;){const o=(e>a.extentMidX?1:0)+(t<a.extentMidY?2:0);a=a.children[o]}const n=((s=a==null?void 0:a.renderData)==null?void 0:s.geometryState.samplerData)??null;return Rt(e,t,n)}return null}class JL{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(t===0)return;const s=this._tail;if(!(s+t<=this.capacity))throw new Error("Queue full");for(let r=0;r<t;++r)this._data[s+r]=e[r];this._tail=s+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function nm(i,e){!i.isLeaf||i.level<ti||Fg(i,t=>{e&&lx(t);const s=b_(t);if(t.maxLevelDeltaNeighborCount++,s){let r=t.parent;for(;r;){const a=b_(r);if(r.unmergableChildCount++,!a)break;r=r.parent}}})}function lx(i){if(i.hasPendingUpdate(se.SPLIT))return;let e=i.parent;for(;e!=null&&e.resetPendingUpdate(se.MERGE);)e=e.parent;i.resetPendingUpdate(se.MERGE),i.isLeaf&&i.setPendingUpdate(se.SPLIT),i.level<ti||Fg(i,t=>{lx(t)})}function Jv(i){i.level<ti||Fg(i,e=>{if(e.maxLevelDeltaNeighborCount--,e.maxLevelDeltaNeighborCount===0&&e.unmergableChildCount===0){let t=e.parent;for(;t&&(t.unmergableChildCount--,b_(t));)t=t.parent}})}function b_(i){return i.maxLevelDeltaNeighborCount===0&&i.unmergableChildCount===0}function Fg(i,e){if(i.level<ti)return;const t=i.level-ti,s=i.lij[1]>>ti,r=i.lij[2]>>ti,a=n=>n.isLeaf||n.level===t;for(let n=0;n<4;++n){const o=i.findNeighborTile(yr[n],a);if(!o||o.level!==t)continue;const l=o.lij;l[1]===s&&l[2]===r||e(o)}}let e3=class{constructor(e,t,s,r){this.operation=e,this.geometry=t,this.states=s,this.sync=r}},gh=class extends Re{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commitLayer(e,t){const s=this._dirtyGeomRecords.get(e);s&&(s.forEach((r,a)=>{const n=this._ensureGeomRecord(e,a);r.forEach(({geometry:o,operation:l,states:h},d)=>{let u=!1;if(l===Yt.UPDATE){const m=n.get(d);if(m){if(h&ha.TRANSFORMATION){const _=this.model.getObject(a);this.model.updateRenderGeometryTransformation(_,o,m)&&(u=!0)}u||t.updates.push({renderGeometry:m,updateType:h})}else Cs(!1,"ModelDirtySet.commitLayer: invalid update")}if(l===Yt.REMOVE||u){const m=n.get(d);m?(t.removes.push(m),n.delete(d)):l===Yt.REMOVE&&Cs(!1,"ModelDirtySet.commitLayer: invalid remove")}if(l===Yt.ADD||u){const m=this.model.getObject(a);if(m!=null){const _=this.model.getRenderGeometry(m,o);t.adds.push(_),n.set(d,_)}}}),n.size===0&&this._residentGeomRecords.get(e).delete(a)}),this._residentGeomRecords.get(e).size===0&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)}commitSyncUpdates(e,t){const s=this._dirtyGeomRecords.get(e);s&&s.forEach((r,a)=>{const n=this._ensureGeomRecord(e,a);r.forEach(({geometry:o,operation:l,states:h,sync:d},u)=>{let m=!1;if(l===Yt.UPDATE&&d){const _=n.get(u);if(_){if(h&ha.TRANSFORMATION){const f=this.model.getObject(a);this.model.updateRenderGeometryTransformation(f,o,_)&&(m=!0)}m||t.updates.push({renderGeometry:_,updateType:h})}else Cs(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}})})}getResidentRenderGeometries(e,t){const s=this._residentGeomRecords.get(e);s&&s.forEach(r=>r.forEach(a=>t.push(a)))}_objectStateChanged(e,t){for(const s of t.geometries)this._updateOrCreateDirtyRecord(t,s,null,Yt.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(ha.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(ha.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(ha.OCCLUDEE,e)}attributesChanged({object:e,geometry:t,sync:s}){this._updateOrCreateDirtyRecord(e,t,null,Yt.UPDATE,ha.GEOMETRY,s)}layerAdded(e){e.objects.forAll(t=>this._layerObjectAdded(e,t))}layerRemoved(e){e.objects.forAll(t=>this._layerObjectRemoved(e,t))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const s=e.id;for(const r of t.geometries)this._geometryAdded(t,r,s)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const s=e.id;for(const r of t.geometries)this._geometryRemoved(t,r,s)}transformationChanged(e){const t=this._getParentLayerId(e),s=e.id;this._ensureGeomRecord(t,s).forEach(r=>{this._updateOrCreateDirtyRecord(e,r.geometry,t,Yt.UPDATE,ha.TRANSFORMATION)})}shaderTransformationChanged(e){const t=this._getParentLayerId(e),s=e.id;this._ensureGeomRecord(t,s).forEach(r=>{r.objectShaderTransformationChanged(e.shaderTransformation)})}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t,s=null){this._updateOrCreateDirtyRecord(e,t,s,Yt.ADD)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t,s=null){this._updateOrCreateDirtyRecord(e,t,s,Yt.REMOVE)}_updateOrCreateDirtyRecord(e,t,s,r,a=ha.NONE,n=!1){s=s??this._getParentLayerId(e);const o=e.id,l=t.id,h=this._ensureDirtyRecord(s,o),d=h.get(l);let u=!1;if(d){const m=d.operation;m===Yt.REMOVE&&r===Yt.ADD&&d.states!==ha.NONE?d.operation=Yt.UPDATE:m===Yt.REMOVE&&r===Yt.ADD||m===Yt.ADD&&r===Yt.REMOVE?(h.delete(l),u=!0):m!==Yt.UPDATE||r!==Yt.REMOVE&&r!==Yt.UPDATE?(Cs((m===Yt.REMOVE||m===Yt.ADD)&&r===Yt.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),d.states|=a):(d.operation=r,d.states|=a),d.sync=d.sync||n}else h.set(l,new e3(r,t,a,n));this.dirty=!u||this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let s=this._residentGeomRecords.get(e);s||(s=new Map,this._residentGeomRecords.set(e,s));let r=s.get(t);return r||(r=new Map,s.set(t,r)),r}get _hasDirtyGeometryRecords(){for(const e of this._dirtyGeomRecords.values())for(const t of e.values())if(t.size>0)return!0;return!1}_ensureDirtyRecord(e,t){let s=this._dirtyGeomRecords.get(e);s||(s=new Map,this._dirtyGeomRecords.set(e,s));let r=s.get(t);return r||(r=new Map,s.set(t,r)),r}_getParentLayerId(e){return e.parentLayer?e.parentLayer.id:IC}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach((s,r)=>{s.forEach((a,n)=>{t.length>0&&(t+=`
`),t+=r+"."+n;const o=[];a.forEach(l=>{const h=l.operation;o[h]||(o[h]=[]),o[h].push(l.geometry.id)});for(let l=0;l<o.length;l++)if(o[l]){t+=" "+e[l-1]+": ";for(let h=0;h<o[l].length;h++)t+=o[l][h]+", "}})}),t}get test(){}};c([p({constructOnly:!0})],gh.prototype,"model",void 0),c([p()],gh.prototype,"dirty",void 0),gh=c([F("esri.views.3d.webgl-engine.lib.ModelDirtySet")],gh);const t3=gh;let zd=class extends Re{constructor(){super(...arguments),this.dirtySet=new t3({model:this}),this._content=new Map,this._originFactory=new RP(null)}getObject(e){return this._content.get(e)}add(e){const t=e.id;Cs(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),nu(e)&&this.dirtySet.layerAdded(e)}remove(e){return!!this._content.has(e.id)&&(this._content.delete(e.id),nu(e)&&this.dirtySet.layerRemoved(e),!0)}addMany(e){for(const t of e)t&&(Cs(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)t&&(Cs(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id))}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach(s=>{s.type===e&&t(s)})}getRenderGeometry(e,t){const s=new OP(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation});s.transformation=e.getCombinedStaticTransformation(t,ey);const{localOrigin:r}=t;return s.localOrigin=r??this._originFactory.getOrigin(qt(s.boundingSphere)),s}updateRenderGeometryTransformation(e,t,s){if(e==null)return!1;s.transformation=e.getCombinedStaticTransformation(t,ey);const r=this._originFactory.getOrigin(qt(s.boundingSphere));return s.localOrigin!==r}getStats(){const e={},t=Array.from(this._content.values());for(let s=0;s<O1.COUNT;++s)e[s]=t.filter(r=>r.type===s).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){}};c([p({constructOnly:!0})],zd.prototype,"dirtySet",void 0),zd=c([F("esri.views.3d.webgl-engine.parts.Model")],zd);const ey=Qe();let i3=class{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return this._indexRanges.length===0}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;{const t=this._indexRanges;let s=0,r=t.length/2;if(e<t[2*s]||e>t[2*r]+t[2*r+1])return!1;for(;r-s>0;){const a=Math.floor(.5*(s+r)),n=t[2*a];if(e<n){if(r-s==1)return!1;r=a;continue}if(e<n+t[2*a+1])return!0;if(r-s==1)return!1;s=a+1}return!1}}get componentCount(){if(this._componentCountCache===-1){const e=this._indexRanges;let t=0;for(let s=0;s<e.length;s+=2)t+=e[s+1];this._componentCountCache=t}return this._componentCountCache}reset(e){e==="all"||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=s3(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let s=0;s<t.length;s+=2){const r=t[s],a=r+t[s+1];for(let n=r;n<a;n++)if(!e(n))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let s=0;s<t.length;s+=2){const r=t[s];if(!e(r,r+t[s+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),s=this._indexRanges;for(let r=0;r<s.length;r+=2){const a=s[r],n=a+s[r+1],o=e[a],l=e[n];t[r]=o,t[r+1]=l-o}return t}};function s3(i){const e=new Array;if(i.length===0)return e;let t=i[0],s=1;for(let r=1;r<i.length;r++){const a=i[r];t+s===a?s+=1:(e.push(t),e.push(s),t=a,s=1)}return e.push(t),e.push(s),e}let r3=class{constructor(e,t){this.offsets=t,this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null;const s=this.count;this.visibility=new i3(s),this.materialDataBuffer=e.getBuffer(s),this.materialDataIndices=new Uint16Array(s);for(let r=0;r<s;r++)this.materialDataIndices[r]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return this.cachedGeometryRanges==null&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return this.highlightCounts==null?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return this.highlightCounts==null?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((this.cachedHighlightRanges==null||this.cachedDefaultRanges==null)&&this.highlightCounts!=null){const{highlightRanges:e,defaultRanges:t}=a3(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=t}}};function a3(i,e,t){const s=[],r=[];let a=t.length,n=t.length;return e.forEachComponent(o=>(i[o]>0?(a!==o-1&&(s.length&&s.push(t[a+1]-s[s.length-1]),s.push(t[o])),a=o):(n!==o-1&&(r.length&&r.push(t[n+1]-r[r.length-1]),r.push(t[o])),n=o),!0)),s.length&&s.push(t[a+1]-s[s.length-1]),r.length&&r.push(t[n+1]-r[r.length-1]),{highlightRanges:s,defaultRanges:r}}let n3=class{constructor(e,t,s,r,a,n){this.transform=e,this.toMapSpace=t,this.obb=s,this.components=r,this.renderable=a,this.intersectionGeometry=n,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=Y(this.intersectionGeometry),this.renderable=Y(this.renderable),this.components=Y(this.components)}};function o3(i,e,t,s,r,a,n){const o=a-n,l=e-i,h=new Float64Array(4*l);for(let d=0;d<l;++d){const u=3*(d+i),m=r*t[u+0],_=s[m+0],f=s[m+1],g=o/(s[m+2]-n),y=_*g,w=f*g,x=r*t[u+1],T=s[x+0],S=s[x+1],C=o/(s[x+2]-n),P=T*C,R=S*C,I=r*t[u+2],L=s[I+0],G=s[I+1],H=o/(s[I+2]-n),D=L*H,J=G*H,A=4*d;h[A+0]=Math.min(y,P,D),h[A+1]=Math.min(w,R,J),h[A+2]=Math.max(y,P,D),h[A+3]=Math.max(w,R,J)}return h}function l3(i,e,t,s,r){const a=e-i,n=new Float64Array(4*a);for(let o=0;o<a;++o){const l=3*(o+i),h=r*t[l+0],d=s[h+0],u=s[h+1],m=r*t[l+1],_=s[m+0],f=s[m+1],g=r*t[l+2],y=s[g+0],w=s[g+1],x=4*o;n[x+0]=Math.min(d,_,y),n[x+1]=Math.min(u,f,w),n[x+2]=Math.max(d,_,y),n[x+3]=Math.max(u,f,w)}return n}function h3(i,e){return new(c3(i))(e)}function c3(i){return i<128?Uint8Array:i<32768?Uint16Array:i<1<<31?Uint32Array:Array}let hx=class{constructor(e,t){this.elementCount=e,this.model=t,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=t.localMode,this.planetCenterZ=t.planetCenterZ,this.geometryMinZ=t.geometryMinZ,this.planetCenter=St(0,0,this.planetCenterZ),this.maxBspNodeDepth=t.maxBspNodeDepth??8,this.minElementCountForBVH=t.minElementCountForBVH??15,this.minBspNodeElementCount=t.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||this._bspNodes.length===0&&this._generateBsp()}intersectRay(e,t,s){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(s):this._intersectRayWithBVH(e,t,s))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,t){this.model.intersectRange(e,t)}_intersectRayWithBVH(e,t,s){this._ensureBVH(),s?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}_intersectGeometryWithBVHVerticalRay(e){let t=e[0],s=e[1];if(!this.localMode){const{geometryMinZ:n,planetCenterZ:o}=this,l=(n-o)/(e[2]-o);t=e[0]*l,s=e[1]*l}const{_bspNodes:r}=this;let a=0;for(;a>=0;){const n=r[a],{d:o,dim:l,minIndexIndex:h,minMidIndexIndex:d,maxMidIndexIndex:u,maxIndexIndex:m,aabb2D:_}=n;if(t<_[0]||t>_[2]||s<_[1]||s>_[3])break;if(l===-1||n.child0===-1&&n.child1===-1){this._intersectRange(h,m);break}{this._intersectRange(d,u);const f=(l===0?t:s)-o;if(f<0){if(n.child0===-1){this._intersectRange(h,d);break}a=n.child0}else{if(!(f>0))break;if(n.child1===-1){this._intersectRange(u,m);break}a=n.child1}}}}_intersectGeometryWithBVHGeneralRay(e,t){let s=e[0],r=e[1],a=t[0],n=t[1];const{geometryMinZ:o}=this;if(!this.localMode){let f=0,g=1;const y=Math.min(.5*this.planetCenterZ,o),w=e[2],x=t[2];if(w<y&&x<y||(w<y&&(f=(y-w)/(x-w)),x<y&&(g=(y-w)/(x-w)),f>g))return;const T=(1-f)*e[0]+f*t[0],S=(1-f)*e[1]+f*t[1],C=(1-f)*e[2]+f*t[2],P=(1-g)*e[0]+g*t[0],R=(1-g)*e[1]+g*t[1],I=(1-g)*e[2]+g*t[2],{planetCenterZ:L}=this,G=o-L,H=G/(C-L);s=T*H,r=S*H;const D=G/(I-L);a=P*D,n=R*D}const l=a-s,h=n-r,d=this._bspNodes;let u=1;{const{aabb2D:f}=d[0],g=(x,T,S,C)=>{if(Math.abs(T)<1e-5*Math.max(C-S,1))return!1;const P=T>0,R=P?C:S,I=x+u*T;return(P?I<R:I>R)&&(u=Math.max((R-x)/T,u),!0)},y=()=>g(s,l,f[0],f[2]),w=()=>g(r,h,f[1],f[3]);Math.abs(l)>=Math.abs(h)?y()||w():w()||y()}const m=[0,0,u];let _=0;for(;_<m.length;){const f=m[_];let g=m[_+1],y=m[_+2];if(_+=3,g>y)continue;const w=d[f],{minIndexIndex:x,maxIndexIndex:T}=w,{child0:S,child1:C,minMidIndexIndex:P,maxMidIndexIndex:R,aabb2D:I,d:L,dim:G}=w;{const H=s+g*l,D=s+y*l,J=Math.min(H,D),A=Math.max(H,D),O=I[0],te=I[2];if(A<O||te<J)continue;if(J<O){const $=(O-s)/l;l>0?g=Math.max(g,$):y=Math.min(y,$)}if(te<A){const $=(te-s)/l;l>0?y=Math.min(y,$):g=Math.max(g,$)}}{const H=r+g*h,D=r+y*h,J=Math.min(H,D),A=Math.max(H,D),O=I[1],te=I[3];if(A<O||te<J)continue;if(J<O){const $=(O-r)/h;h>0?g=Math.max(g,$):y=Math.min(y,$)}if(te<A){const $=(te-r)/h;h>0?y=Math.min(y,$):g=Math.max(g,$)}}if(S===-1&&C===-1)this._intersectRange(x,T);else{const H=G===0?s:r,D=G===0?l:h,J=H+g*D,A=H+y*D,O=Math.min(J,A),te=Math.max(J,A),$=Z((L-H)/D,0,u);x<P&&O<=L&&(S!==-1?(m.push(S),m.push(D>=0?g:Math.max(g,$)),m.push(D>=0?Math.min(y,$):y)):this._intersectRange(x,P)),this._intersectRange(P,R),R<T&&L<=te&&(C!==-1?(m.push(C),m.push(D>=0?Math.max(g,$):g),m.push(D>=0?y:Math.min(y,$))):this._intersectRange(R,T))}}}_generateBsp(){const{elementCount:e}=this;if(e<1)return;const t=h3(e,e);this._elementIndexMap=t;for(let _=0;_<e;++_)t[_]=_;const s=this.model.getAabbs2D();let r=0;const a=this._bspNodes;a.length=0;const{localMode:n}=this;let o=!1;if(!n){const{planetCenterZ:_,geometryMinZ:f}=this;o=_>=0||f<.5*_}const l=[],h=(_,f,g,y,w)=>{l.push(_),l.push(f),l.push(g),l.push(y<0?-1:(w?0:1)+2*y)},{maxBspNodeDepth:d,minBspNodeElementCount:u}=this,m=(_,f,g,y,w)=>{const x=a.length;if(x>0&&(o||g>=d||f-_<u))return;const T=[0,0,0,0];m3(T,_,f,t,s);const{d:S,dim:C}=n?d3(T):u3(T),{rangeMidStart:P,rangeMidEnd:R}=p3(_,f,C,S,t,s),I=g===d-1,L=!I&&P>=_+u,G=!I&&f>=R+u;if(L||G||x===0){const H=new _3(_,P,R,f,C,S,T);if(L&&h(_,P,g+1,x,!0),G&&h(R,f,g+1,x,!1),a.push(H),y!==-1){const D=a[y];w?D.child0=x:D.child1=x}}};for(h(0,e,0,-1,!1);r<l.length;){const _=l[r],f=l[r+1],g=l[r+2],y=l[r+3];r+=4;const w=y>>1;m(_,f,g,w,y-(w<<1)==0)}this._generatedBVH=!0}};function d3(i){const e=i[0],t=i[1],s=i[2],r=i[3];let a,n;return s-e>=r-t?(n=.5*(e+s),a=0):(n=.5*(t+r),a=1),{d:n,dim:a}}function u3(i){const e=i[0],t=i[1],s=i[2],r=i[3];let a,n;return s-e>=r-t?(a=0,n=.5*(e+s)):(a=1,n=.5*(t+r)),{dim:a,d:n}}function p3(i,e,t,s,r,a){let n=i;{let d=e;for(;n<d;){const u=r[n];ty(u,t,s,a)<0?++n:(--d,r[n]=r[d],r[d]=u)}}const o=n;let l=n,h=e;for(;l<h;){const d=r[h-1];ty(d,t,s,a)>0?--h:(r[h-1]=r[l],r[l]=d,++l)}return{rangeMidStart:o,rangeMidEnd:h}}function ty(i,e,t,s){const r=4*i,a=s[r+0+e];return s[r+2+e]<t?-1:a>t?1:0}function m3(i,e,t,s,r){let a=1/0,n=1/0,o=-1/0,l=-1/0;for(let h=e;h<t;++h){const d=4*s[h];a=Math.min(a,r[d+0]),n=Math.min(n,r[d+1]),o=Math.max(o,r[d+2]),l=Math.max(l,r[d+3])}i[0]=a,i[1]=n,i[2]=o,i[3]=l}let _3=class{constructor(e,t,s,r,a,n,o){this.minIndexIndex=e,this.minMidIndexIndex=t,this.maxMidIndexIndex=s,this.maxIndexIndex=r,this.dim=a,this.d=n,this.aabb2D=o,this.child0=-1,this.child1=-1}},g3=class{constructor(e,t,s,r,a,n,o,l,h){this.componentIndex=e,this.vertexData=t,this.vertexStride=s,this.indexData=r,this.startTriangleNumber=a,this.endTriangleNumber=n,this.geometryMinZ=o,this.planetCenterZ=l,this.localMode=h,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=b(),this.ray0=b(),this.isVerticalRay=!1,this._triangleHitCallback=iy,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new hx(n-a,this)}getAabbs2D(){return this.localMode?l3(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):o3(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,t,s,r,a,n){le(this.ray0,e),xt(this.rayDirection,t,e),this.isVerticalRay=s,this.totalElevationOffset=r,this.normalRequired=n,this._triangleHitCallback=a,this._bvh.intersectRay(e,t,s),this._triangleHitCallback=iy}intersectRange(e,t){const s=this._bvh.elementIndexMap;cx(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,s,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}};function cx(i,e,t,s,r,a,n,o,l,h,d,u=null,m=0){o!==0?GR(i,e,t,s,r,a,n,o,l,h,d,u,m):nb(i,e,t,s,r,a,n,h,d,u,m)}function iy(){}function f3(i,e,t,s){if(t>=e)return i;i==null&&(i=v3());const r=i.isVisibleBit;let a=i.data;const n=dx(a),o=t/n|0,l=t-n*o,h=(e-1)/n|0,d=a,u=s===r;if(!(t<d.length*n)&&u){const m=o+1,_=Math.ceil(d.length*xC),f=h+1;let g=Math.max(m,_);g=Math.min(g,f),a=new Uint32Array(g),a.set(d)}return o<a.length&&(a[o]=b3(a[o],l,u)),i.data=a,i}function w_(i,e){if(i==null)return!0;const{isVisibleBit:t,data:s}=i,r=dx(s);return e<s.length*r?y3(t,s,e,r):!i.isVisibleBit}function v3(i=!0){return{isVisibleBit:!i,data:new Uint32Array(0)}}function y3(i,e,t,s){const r=t/s|0,a=t-r*s;return w3(e[r],a)===i}function dx(i){return i.BYTES_PER_ELEMENT*8}function b3(i,e,t){return i&~(1<<e)|(t?1:0)<<e}function w3(i,e){return!!(i&1<<e)}let x3=class{constructor(e,t,s,r,a,n,o,l){this.vertexData=e,this.vertexStride=t,this.indexData=s,this._components=r,this._componentAabbs3D=a,this.geometryMinZ=n,this.planetCenterZ=o,this.localMode=l,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=P3,this._ray1=R3,this._invDir=b(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=O3,this._callback=sy,this.rayDirectionC=b(),this._componentIndexMap=null,this._bvh=new hx(r.count,this),this.componentIntersectionData=new Array(r.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:e,planetCenterZ:t,minZGlobal:s}=this,r=new Float64Array(4*e),a=this._componentAabbs3D;for(let n=0;n<e;++n){const o=6*n,l=a[o+0],h=a[o+1],d=a[o+2],u=a[o+3],m=a[o+4],_=s/(d-t),f=s/(a[o+5]-t),g=Math.min(l*_,l*f),y=Math.min(h*_,h*f),w=Math.max(u*_,u*f),x=Math.max(m*_,m*f),T=4*n;r[T+0]=g,r[T+1]=y,r[T+2]=w,r[T+3]=x}return r}getAabbs2DLocal(){const{numComponents:e}=this,t=new Float64Array(4*e),s=this._componentAabbs3D;for(let r=0;r<e;++r){const a=6*r,n=s[a+0],o=s[a+1],l=s[a+3],h=s[a+4],d=4*r;t[d+0]=n,t[d+1]=o,t[d+2]=l,t[d+3]=h}return t}intersectRay(e,t,s,r,a,n,o){const{isVerticalRay:l}=o;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=s,this._verticalOffset=r,this._tolerance=n,this._intersectionOptions=o,this._componentIndexMap=this._bvh.elementIndexMap,kR(e,t,this._invDir),this._callback=a,this._bvh.intersectRay(e,t,l),this._callback=sy}intersectRange(e,t){const s=this._componentIndexMap,r=this._components,a=r.pickability,n=r.visibility;for(let o=e;o<t;++o){const l=s?s[o]:o;w_(a,l)&&n.isVisible(l)&&this._intersectComponent(l)}}getComponentTriangleCount(e){const t=this._components.offsets,s=t[e]/3;return t[e+1]/3-s}getComponentAabb3D(e,t){const s=this._componentAabbs3D,r=6*e;return t[0]=s[r],t[1]=s[r+1],t[2]=s[r+2],t[3]=s[r+3],t[4]=s[r+4],t[5]=s[r+5],t}_intersectComponent(e){if(!w_(this._components.pickability,e))return;const t=this.getComponentAabb3D(e,C3);let s=!1;const{localMode:r,_componentVerticalOffsets:a,_verticalOffset:n,_ray0:o,_ray1:l,_invDir:h,planetCenterZ:d,_tolerance:u,rayDirectionC:m,componentIntersectionData:_}=this,{isVerticalRay:f}=this._intersectionOptions,g=this._components.offsets,y=le(T3,o),w=le(S3,l),x=(a==null?void 0:a[e])??0,T=x+((n==null?void 0:n.offset)??0);if(T!==0&&(r?(y[2]=o[2]-T,w[2]=l[2]-T,s=!0):n!=null&&(n.componentOffset=x)),n==null||s||T===0||n.applyToAabb(t),!jR(t,y,h,u))return;xt(m,w,y);const S=g[e]/3,C=g[e+1]/3,P=C-S,R=(J,A,O)=>{this._callback(J,A,e,O)},{vertexData:I,vertexStride:L,indexData:G,_intersectionOptions:H}=this,{normalRequired:D}=H;if(P>M3){let J=_[e];J==null&&(J=new g3(e,I,L,G,S,C,this.geometryMinZ,d,r),_[e]=J),J.intersectRay(y,w,f,s?0:T,R,D)}else cx(y,m,S,C,G,I,L,s?0:T,d,D,R)}};const C3=Wu(),T3=b(),S3=b(),P3=b(),R3=b(),sy=()=>{},O3=new rg,M3=40;let E3=class{constructor(e,t,s){this.viewingMode=e,this.positionData=t,this._components=s,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=b(),this._componentBvh=null,this._aabb=[0,0,0,0,0,0],this._indices=t.indices?lb(t.indices):sO(t.positions.length/3),this._positions=t.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,t){const s=this._ensureComponentAabbs(),r=6*e;return t[0]=s[r],t[1]=s[r+1],t[2]=s[r+2],t[3]=s[r+3],t[4]=s[r+4],t[5]=s[r+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,s,r,a,n,o,l){this.verticalOffset=r,this.componentVerticalOffsets=a;const{position:h}=n,d=xt(A3,e,h),u=xt(D3,t,h),m=X_($3,n.rotationScale);Pa(d,d,m),Pa(u,u,m);const _=Hu(L3,m);if(this.viewingMode===$e.Global){const g=this._planetCenter;Xr(g,h),Pa(g,g,m)}const f=(g,y,w,x)=>{l(w,g,x?Pa(I3,x,_):null,y)};this._intersectComponents(d,u,a,r,f,s,o)}_computePerComponentAabbs(){const e=this._aabb,t=.5*(e[0]+e[3]),s=.5*(e[1]+e[4]),r=.5*(e[2]+e[5]),a=this._components.count,n=x1(6*a),o=this._indices,l=this._positions,h=this._components.offsets;let d=0,u=1/0,m=1/0,_=1/0,f=-1/0,g=-1/0,y=-1/0;for(let w=0;w<a;w++){const x=h[w],T=h[w+1];let S=1/0,C=1/0,P=1/0,R=-1/0,I=-1/0,L=-1/0;if(x<T)for(let G=x;G<T;G++){const H=3*o[G],D=l[H],J=l[H+1],A=l[H+2];S=Math.min(S,D),C=Math.min(C,J),P=Math.min(P,A),R=Math.max(R,D),I=Math.max(I,J),L=Math.max(L,A)}else S=t,C=s,P=r,R=t,I=s,L=r;n[d++]=S,n[d++]=C,n[d++]=P,n[d++]=R,n[d++]=I,n[d++]=L,u=Math.min(u,S),m=Math.min(m,C),_=Math.min(_,P),f=Math.max(f,R),g=Math.max(g,I),y=Math.max(y,L)}return this._aabb[0]=u,this._aabb[1]=m,this._aabb[2]=_,this._aabb[3]=f,this._aabb[4]=g,this._aabb[5]=y,n}_intersectComponents(e,t,s,r,a,n,o){let l=this._componentBvh;l==null&&(l=new x3(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=l),l.intersectRay(e,t,s,r,a,n,o)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return this.viewingMode===$e.Local}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}};const A3=b(),D3=b(),$3=La(),I3=b(),L3=La();let N3=class{constructor(e,t,s){this.material=e,this.geometry=t,this.meta=s}destroy(){this.material.dispose(),this.geometry.dispose()}},F3=class{constructor(e,t,s,r){this.vao=e,this.primitiveType=t,this.parameters=s,this.indexed=r}dispose(){this.vao.dispose()}},Vg=class{constructor(){this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}};function V3(i,e){return{near:i,far:e}}function yc(i){return V3(1/0,-1/0)}function Du(i,e,t){return i.near=e,i.far=t,i}function Pl(i,e){e!=null&&(i.near=Math.min(i.near,e.near),i.far=Math.max(i.far,e.far))}function dd(i,e){return i.near<=e&&e<=i.far}const x_={near:0,far:0};function U3(i,e){const t=yc(),{eye:s,frustum:r,viewForward:a}=i;e.forAll(n=>{const o=n.offsetObb!=null?n.offsetObb:n.obb,l=ue(xt(Ms,o.center,s),a),h=o.projectedRadius(a);if(dd(t,l-h)&&dd(t,l+h))return;const d=G3(o,r);if(d===-1)return;if(d===0)return ca.far=l+h,ca.near=l-h,void Pl(t,ca);const u=ud.pushNew();u.near=l-h,u.far=l+h,u.mask=d,u.object=n});for(let n=0;n<ud.length;n++){const o=ud.data[n];if(dd(t,o.near)&&dd(t,o.far))continue;ca.far=o.far,ca.near=1/0,H3(o.object.offsetObb!=null?o.object.offsetObb:o.object.obb,s,q3,h=>{let d=z3;for(let u=0;u<ux&&h.length>0;u++){if(!(o.mask&1<<u))continue;B3(r[u],h,d);const m=h;h=d,d=m}for(let u=0;u<h.length;u+=3){it(as,h.data[u],h.data[u+1],h.data[u+2]);const m=ue(xt(as,as,s),a);ca.near=Math.min(ca.near,m)}})===0&&(ca.near=0),Pl(t,ca)}return ud.length=0,t}const ud=new Gt({allocator:i=>i||{near:1/0,far:-1/0,mask:0,object:null},deallocator:i=>(i.object=null,i)}),ca=yc(),as=b(),zn=b(),q3=new Gt({deallocator:null}),z3=new Gt({deallocator:null});function B3(i,e,t){t.length=0;const s=e.length-3;om(as,e,s);const r=bo(i,as);r<=0&&(t.push(as[0]),t.push(as[1]),t.push(as[2]));let a=0,n=r;for(;a<s;a+=3){om(zn,e,a);const o=bo(i,zn);n*o<0&&(Tr(as,zn,as,o/(o-n)),ns(t,as)),o<=0&&ns(t,zn),n=o,le(as,zn)}n*r<0&&(om(zn,e,s),Tr(as,zn,as,r/(r-n)),ns(t,as))}function om(i,e,t){return it(i,e.data[t],e.data[t+1],e.data[t+2])}function ns(i,e){i.push(e[0]),i.push(e[1]),i.push(e[2])}function H3(i,e,t,s){x2(ay,i.quaternion),xt(Ms,e,i.center),kC(Ms,Ms,ay);const r=i.halfSize,a=8*((Ms[0]<-r[0]?-1:Ms[0]>r[0]?1:0)+3*(Ms[1]<-r[1]?-1:Ms[1]>r[1]?1:0)+9*(Ms[2]<-r[2]?-1:Ms[2]>r[2]?1:0)+13),n=ry[a];if(n===0)return n;KP(pd,i.quaternion),V1(pd,pd,i.halfSize);const o=(l,h)=>{const d=ry[a+h+1];return it(l,((1&d)<<1)-1,(2&d)-1,((4&d)>>1)-1),Pa(l,l,pd),_e(l,i.center,l)};return t.length=0,ns(t,o(lm,0)),ns(t,o(ny,1)),ns(t,o(Ms,2)),ns(t,o(oy,3)),s(t),n===1||(t.length=0,ns(t,lm),ns(t,oy),ns(t,o(Ms,4)),ns(t,o(ly,5)),s(t),n===2||(t.length=0,ns(t,lm),ns(t,ly),ns(t,o(Ms,6)),ns(t,ny),s(t))),n}const ry=(()=>{const i=new Array(216);let e=0;const t=s=>{for(let r=0;r<s.length;r++)i[e+r]=s[r];e+=8};return t([3,0,6,2,3,1,5,4]),t([2,0,2,3,1,5,4,0]),t([3,1,0,2,3,7,5,4]),t([2,0,1,3,2,6,4,0]),t([1,0,1,3,2,0,0,0]),t([2,1,5,7,3,2,0,0]),t([3,2,0,1,3,7,6,4]),t([2,2,0,1,3,7,6,0]),t([3,3,0,1,5,7,6,2]),t([2,0,1,5,4,6,2,0]),t([1,0,1,5,4,0,0,0]),t([2,1,3,7,5,4,0,0]),t([1,0,2,6,4,0,0,0]),t([0,0,0,0,0,0,0,0]),t([1,1,3,7,5,0,0,0]),t([2,2,3,7,6,4,0,0]),t([1,2,3,7,6,0,0,0]),t([2,3,1,5,7,6,2,0]),t([3,4,0,1,5,7,6,2]),t([2,5,7,6,4,0,1,0]),t([3,5,0,1,3,7,6,4]),t([2,4,5,7,6,2,0,0]),t([1,4,5,7,6,0,0,0]),t([2,5,1,3,7,6,4,0]),t([3,6,0,2,3,7,5,4]),t([2,6,2,3,7,5,4,0]),t([3,7,6,2,3,1,5,4]),i})(),ux=4;function G3(i,e){let t=0;for(let s=0;s<ux;s++){const r=i.intersectPlane(e[s]);if(r>0)return-1;r===0&&(t|=1<<s)}return t}const pd=La(),ay=C2(),Ms=b(),lm=b(),ny=b(),oy=b(),ly=b();let k3=class{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll(s=>s.renderable.material.submit(e,t,s))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?U3(e,this._objects.visibleObjects):null}};function j3(i){const e=Mn().vec3f(Te.POSITION);return i.hasNormals&&e.vec2i16(Te.NORMALCOMPRESSED,{glNormalized:!0}),i.textureCoordinates===yn.Default?e.vec2f(Te.UV0):i.textureCoordinates===yn.Atlas&&(e.vec2f(Te.UV0),e.vec4u16(Te.UVREGION,{glNormalized:!0})),i.colors&&e.vec4u8(Te.COLOR,{glNormalized:!0}),e}let W3=class{constructor(){this.externalColor=mi(),this.externalColorMixMode=yu.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}};var bs;function Q3(i,e){const t=i.vertex;switch(t.code.add(v`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),e.vertexDiscardMode){case bs.None:t.code.add(v`#define vertexDiscardByOpacity(_opacity_) {}`);break;case bs.Opaque:t.code.add(v`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case bs.Transparent:t.code.add(v`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case bs.COUNT:break;default:Cl(e.vertexDiscardMode)}}(function(i){i[i.None=0]="None",i[i.Transparent=1]="Transparent",i[i.Opaque=2]="Opaque",i[i.COUNT=3]="COUNT"})(bs||(bs={}));var Yr;function UB(i){return i&&h1(i)?Yr.Mars:i&&l1(i)?Yr.Moon:Yr.Earth}(function(i){i[i.Earth=1]="Earth",i[i.Mars=2]="Mars",i[i.Moon=3]="Moon",i[i.COUNT=4]="COUNT"})(Yr||(Yr={}));var Xs;(function(i){i[i.None=0]="None",i[i.NoOverlay=1]="NoOverlay",i[i.ColorOverlay=2]="ColorOverlay",i[i.ColorOverlayWithWater=3]="ColorOverlayWithWater",i[i.COUNT=4]="COUNT"})(Xs||(Xs={}));let De=class extends tr{constructor(){super(...arguments),this.output=E.Color,this.textureCoordinateType=yn.None,this.componentData=gc.Uniform,this.cullFace=ig.Back,this.vertexDiscardMode=bs.None,this.doubleSidedMode=an.WindingOrder,this.alphaDiscardMode=ml.Opaque,this.integratedMeshMode=Xs.None,this.transparencyPassType=wi.NONE,this.ellipsoidMode=Yr.Earth,this.pbrMode=Qt.Disabled,this.normalType=Qs.Attribute,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasVertexColors=!1,this.hasNormals=!1,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.hasScreenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.hasNormalTextureTransform=!1,this.hasCloudsReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1}};c([z({count:E.COUNT})],De.prototype,"output",void 0),c([z({count:yn.COUNT})],De.prototype,"textureCoordinateType",void 0),c([z({count:gc.COUNT})],De.prototype,"componentData",void 0),c([z({count:ig.COUNT})],De.prototype,"cullFace",void 0),c([z({count:bs.COUNT})],De.prototype,"vertexDiscardMode",void 0),c([z({count:an.COUNT})],De.prototype,"doubleSidedMode",void 0),c([z({count:ml.COUNT})],De.prototype,"alphaDiscardMode",void 0),c([z({count:Xs.COUNT})],De.prototype,"integratedMeshMode",void 0),c([z({count:wi.COUNT})],De.prototype,"transparencyPassType",void 0),c([z({count:Yr.COUNT})],De.prototype,"ellipsoidMode",void 0),c([z({count:Qt.COUNT})],De.prototype,"pbrMode",void 0),c([z({count:Qs.COUNT})],De.prototype,"normalType",void 0),c([z()],De.prototype,"spherical",void 0),c([z()],De.prototype,"doublePrecisionRequiresObfuscation",void 0),c([z()],De.prototype,"hasVertexColors",void 0),c([z()],De.prototype,"hasNormals",void 0),c([z()],De.prototype,"hasSlicePlane",void 0),c([z()],De.prototype,"hasColorTexture",void 0),c([z()],De.prototype,"receiveAmbientOcclusion",void 0),c([z()],De.prototype,"receiveShadows",void 0),c([z()],De.prototype,"blendingEnabled",void 0),c([z()],De.prototype,"hasScreenSpaceReflections",void 0),c([z()],De.prototype,"hasPolygonOffset",void 0),c([z()],De.prototype,"hasMetallicRoughnessTexture",void 0),c([z()],De.prototype,"hasEmissionTexture",void 0),c([z()],De.prototype,"hasOcclusionTexture",void 0),c([z()],De.prototype,"hasNormalTexture",void 0),c([z()],De.prototype,"hasOccludees",void 0),c([z()],De.prototype,"multipassEnabled",void 0),c([z()],De.prototype,"cullAboveGround",void 0),c([z()],De.prototype,"hasNormalTextureTransform",void 0),c([z()],De.prototype,"hasCloudsReflections",void 0),c([z()],De.prototype,"snowCover",void 0),c([z()],De.prototype,"objectAndLayerIdColor",void 0),c([z({constValue:!1})],De.prototype,"occlusionPass",void 0),c([z({constValue:fO.Draw})],De.prototype,"pbrTextureBindType",void 0),c([z({constValue:!0})],De.prototype,"hasSliceHighlight",void 0),c([z({constValue:!1})],De.prototype,"hasSliceInVertexProgram",void 0),c([z({constValue:!1})],De.prototype,"useCustomDTRExponentForWater",void 0),c([z({constValue:!1})],De.prototype,"hasVertexTangents",void 0),c([z({constValue:!0})],De.prototype,"supportsTextureAtlas",void 0),c([z({constValue:!1})],De.prototype,"highStepCount",void 0),c([z({constValue:!1})],De.prototype,"instancedDoublePrecision",void 0),c([z({constValue:!1})],De.prototype,"hasModelTransformation",void 0),c([z({constValue:!0})],De.prototype,"useFillLights",void 0),c([z({constValue:!1})],De.prototype,"objectAndLayerIdColorInstanced",void 0);function X3(i,e){i.include(ob,e),i.fragment.include(bR);const t=i.fragment;t.uniforms.add(new vO("baseColor",s=>s.baseColor)),t.uniforms.add(new wR("objectOpacity",s=>s.objectOpacity)),e.hasVertexColors?t.code.add(v`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):t.code.add(v`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),t.code.add(v`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function hy(i,e){const t=i.fragment;switch(e.doubleSidedMode){case an.None:t.code.add(v`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case an.View:i.include(bd,e),t.code.add(v`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case an.WindingOrder:t.code.add(v`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:Cl(e.doubleSidedMode);case an.COUNT:}switch(e.normalType){case Qs.Attribute:case Qs.Compressed:i.include(T1,e),t.code.add(v`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`);break;case Qs.ScreenDerivative:i.include(bd,e),t.code.add(v`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`);break;case Qs.Ground:e.spherical?(i.include(bd,e),t.code.add(v`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):t.code.add(v`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),t.code.add(v`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`);break;default:Cl(e.normalType);case Qs.COUNT:}}function Y3(i,e){const t=i.fragment;if(e.hasColorTexture&&(e.output===E.Color||e.alphaDiscardMode!==ml.Opaque)){i.include(KS,e);const s=e.textureCoordinateType===yn.Atlas;t.uniforms.add(new sg("baseColorTexture",r=>r.texture)),s?(i.include(S1),t.code.add(v`vec4 readBaseColorTexture() {
return textureAtlasLookup(baseColorTexture, vuv0, vuvRegion);
}`)):t.code.add(v`vec4 readBaseColorTexture() {
return texture(baseColorTexture, vuv0);
}`)}else t.code.add(v`vec4 readBaseColorTexture() { return vec4(1.0); }`)}function px(i){const e=new Dt;e.include(bd,i),e.include(T1,i),e.include(ob,i),e.include(qu,i),e.include(rb,i),e.include(nO,i),e.include(xR,i),e.include(JS,i),e.include(Y3,i),e.include(Q3,i);const{vertex:t,fragment:s}=e;i.pbrMode!==Qt.Normal&&i.pbrMode!==Qt.Schematic||(e.include(eP,i),i.hasNormalTexture&&e.include(CR,i));const r=i.output===E.Shadow||i.output===E.ShadowHighlight||i.output===E.ShadowExcludeHighlight;r&&i.componentData===gc.Varying?t.code.add(v`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):t.code.add(v`#define discardShadows(castShadows) {}`);const a=i.integratedMeshMode===Xs.ColorOverlay||i.integratedMeshMode===Xs.ColorOverlayWithWater,n=a&&i.output===E.Color&&i.pbrMode===Qt.WaterOnIntegratedMesh;a&&(e.include(fu,i),e.include(MP,i),i.spherical?t.code.add(v`
      const float invEllipsoidRadius = ${v.float(1/(i.ellipsoidMode===Yr.Earth?Ur.radius:i.ellipsoidMode===Yr.Mars?lS.radius:hS.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):t.code.add(v`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),n&&(e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),e.varyings.add("groundNormal","vec3")),t.code.add(v`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      ${i.output===E.ObjectAndLayerIdColor?v`externalColor.a = 1.0;`:""}

      if (externalColor.a < ${v.float(tP)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }

      forwardPosition(readElevationOffset());
      forwardNormal();
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth();
      ${i.output===E.ObjectAndLayerIdColor?v`forwardObjectAndLayerIdColor();`:""}
      ${n?i.spherical?v`
                groundNormal = normalize(positionWorld());
                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:v`
                groundNormal = vec3(0.0, 0.0, 1.0);
                tbnTangent = vec3(1.0, 0.0, 0.0);
                tbnBiTangent = vec3(0.0, 1.0, 0.0);`:""}
      ${a?v`setOverlayVTC(projectOverlay(position));`:""}
    }
  `),i.output===E.Color&&(s.include(z_),e.include(iP,i),e.include(X3,i),e.include(hy,i),e.include(fu,i),i.transparencyPassType===wi.ColorAlpha&&(e.outputs.add("fragColor","vec4",0),e.outputs.add("fragAlpha","float",1)),i.receiveShadows?(e.include(tg,i),s.code.add(v`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):s.code.add(v`float evaluateShadow() { return 0.0; }`),a&&s.uniforms.add(new Fe("ovColorTex",(l,h)=>EP(l,h))),s.code.add(v`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${i.multipassEnabled?v`terrainDepthTest(vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${a?v`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`:""}
    `),i.pbrMode===Qt.Normal||i.pbrMode===Qt.Schematic?(C1(s),s.code.add(v`
        ${i.pbrMode===Qt.Normal?v`
                applyPBRFactors();
                if (int(externalColorMixMode) == 3) {
                  mrr = vec3(0.0, 0.6, 0.2);
                }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
      `),i.hasNormalTexture?s.code.add(v`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):s.code.add(v`vec3 shadingNormal = normalVertex;`),s.code.add(v`${i.spherical?v`vec3 normalGround = normalize(positionWorld());`:v`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),s.code.add(v`
        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();
        ${i.snowCover?v`
                vec3 surfaceNormal = normalize(shadingNormalWorld());
                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
                materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                ssao = mix(ssao, 0.5 * ssao, snow);
                shadingNormal = mix(shadingNormal, surfaceNormal, snow);`:""}

        ${a?v` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(i.receiveShadows?s.code.add(v`float shadow = evaluateShadow();`):i.spherical?(tb(s),s.code.add(v`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`)):s.code.add(v`float shadow = 0.0;`),n&&s.uniforms.add(new Fe("ovNormalTex",(l,h)=>{var d;return(d=h.overlay)==null?void 0:d.getTexture(mr.WaterNormal)})),i.snowCover&&s.code.add(v`vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`),s.code.add(v`
        float ambientOcclusion = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());

        ${a?v` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${n?v`
              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                // un-gamma the ground color to mix in linear space
                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
              }`:""}
      `)),s.code.add(v`
        fragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${i.transparencyPassType===wi.ColorAlpha?v`
                fragColor = premultiplyAlpha(fragColor);
                fragAlpha = fragColor.a;`:""}
      }
    `));const o=i.output===E.Depth;return(o||r||i.output===E.ViewshedShadow)&&(o||e.include(eb,i),s.code.add(v`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${o?"":v`outputDepth(linearDepth);`}
      }
    `)),i.output===E.Normal&&(e.include(hy,i),s.code.add(v`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material to influence ambient occlusion,
        // see the ssao fragment shader
        float alpha = ${i.normalType===Qs.Ground?"0.0":"1.0"};
        fragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),i.output===E.ObjectAndLayerIdColor&&e.fragment.code.add(v`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${a?v`fragColor = getOverlayColorTexel(vtcOverlay);`:"outputObjectAndLayerIdColor();"}
      }
    `),i.output===E.Highlight&&(e.include(sb),s.code.add(v`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${a?v`
                vec4 overlayColor = getCombinedOverlayColor();
                if (overlayColor.a == 0.0) {
                  fragColor = vec4(0.0);
                  return;
                }`:""}

        outputHighlight();
      }
    `)),e}const Z3=Object.freeze(Object.defineProperty({__proto__:null,build:px},Symbol.toStringTag,{value:"Module"}));let mx=class _x extends It{initializeConfiguration(e,t){t.spherical=e.viewingMode===$e.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Lt(e.rctx,_x.shader.get().build(this.configuration),gx)}_setPipelineState(e){const t=this.configuration,s=t.integratedMeshMode!==Xs.None,r=e===wi.NONE,a=e===wi.FrontFace;return ot({blending:t.output===E.Color&&t.blendingEnabled?r?H_:sP(e):null,culling:vP(t.cullFace),depthTest:{func:rP(e)},depthWrite:r||a?D1:null,drawBuffers:t.output===E.Depth?{buffers:[M1.NONE]}:aP(e),colorWrite:ht,stencilWrite:s||t.hasOccludees?nP:null,stencilTest:s?oP(Ph.IntegratedMeshMaskExcluded):t.hasOccludees?lP:null,polygonOffset:r||a?t.hasPolygonOffset?{factor:2,units:2}:null:hP})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};mx.shader=new $t(Z3,()=>ae(()=>Promise.resolve().then(()=>tF),void 0,import.meta.url));const gx=new Map([[Te.POSITION,0],[Te.NORMAL,1],[Te.NORMALCOMPRESSED,1],[Te.COLOR,2],[Te.UV0,3],[Te.UVREGION,4],[Te.COMPONENTINDEX,5]]);let K3=class extends ri{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}},Ug=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}};function At(i={}){return(e,t)=>{const s=e._parameterCount??0;if(e._parameterCount=s+1,i.vectorOps){const r=i.vectorOps;Object.defineProperty(e,t,{get(){return this[s]},set(a){const n=this[s];if(n==null)this[s]=a;else{if(r.equals(n,a))return;r.copy(n,a)}this._setDirty()}})}else Object.defineProperty(e,t,{get(){return this[s]},set(r){this[s]!==r&&(i.dispose&&this[s]&&this[s].dispose(),this[s]=r,this._setDirty())}})}}function cy(){return(i,e)=>{const t=i._parameterCount??0;i._parameterCount=t+1,i._parameterBlocks=i._parameterBlocks||[],i._parameterBlocks.push(t),Object.defineProperty(i,e,{get(){return this[t]},set(s){this[t]!==s&&(this[t]=s,this._setDirty())}})}}let fx=class{constructor(e){this._low=b(),this._high=b(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){le(this._low,le(dy,e));const t=xt(dy,e,this._low);le(this._high,t)}get(e){return _e(e,this._low,this._high)}getLowScaled(e){return ee(e,this._low,1)}};const dy=n2();let ui=class extends K3{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=er(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=jy(TR),this.emissiveFactor=St(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new Bd,this.componentParameters=new Lh,this.textureAlphaCutoff=cP,this.alphaDiscardMode=ml.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=Yr.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new De;const s=new fx(e.position),r=v2(e.rotationScale);X_(r,r),Hu(r,r),this.transformNormalGlobalFromModel=r,this.transformWorldFromModelTL=s.low,this.transformWorldFromModelTH=s.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=tt(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return this.baseColorTexture!=null?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return this.metallicRoughnessTexture!=null?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return this.emissionTexture!=null?this.emissionTexture.glTexture:null}get textureOcclusion(){return this.occlusionTexture!=null?this.occlusionTexture.glTexture:null}get textureNormal(){return this.normalTexture!=null?this.normalTexture.glTexture:null}prepareTechnique(e,t,s,r){const a=this._techniqueConfiguration;a.hasVertexColors=r.colors,a.hasNormals=r.hasNormals,a.textureCoordinateType=r.textureCoordinates,a.hasMetallicRoughnessTexture=this.metallicRoughnessTexture!=null,a.hasEmissionTexture=this.emissionTexture!=null,a.hasOcclusionTexture=this.occlusionTexture!=null,a.hasNormalTexture=this.normalTexture!=null,a.transparencyPassType=t.identifier===Bn.Material&&s.transparencyPassType!=null?s.transparencyPassType:wi.NONE,a.multipassEnabled=t.identifier===Bn.Material&&s.multipassEnabled,a.cullAboveGround=t.identifier===Bn.Material&&s.multipassTerrain.cullAboveGround,a.ellipsoidMode=this.ellipsoidMode,a.componentData=this.componentParameters.type,a.cullFace=this.commonMaterialParameters.cullFace,a.doubleSidedMode=this.commonMaterialParameters.doubleSided?an.View:an.None,a.hasColorTexture=this.baseColorTexture!=null;const n=this._computeWhichMaterialPass();if(a.blendingEnabled=n===ji.Transparent||n===ji.OpaqueAndTransparent,a.alphaDiscardMode=this.alphaDiscardMode,a.integratedMeshMode=this.isIntegratedMesh?tN(s)?eN(s)?Xs.ColorOverlayWithWater:Xs.ColorOverlay:Xs.NoOverlay:Xs.None,a.hasPolygonOffset=this.polygonOffsetEnabled,a.pbrMode=a.integratedMeshMode===Xs.ColorOverlayWithWater?Qt.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?r.needsNormals&&this.isIntegratedMesh?Qt.Disabled:Qt.Schematic:Qt.Normal:Qt.Disabled,a.normalType=r.needsNormals?a.hasNormals?Qs.Compressed:Qs.ScreenDerivative:Qs.Ground,a.hasSlicePlane=s.slicePlane!=null&&this.commonMaterialParameters.hasSlicePlane,t.identifier===Bn.ShadowMap)a.output=E.Shadow,a.vertexDiscardMode=bs.None;else if(t.identifier===Bn.ViewshedShadowMap)a.output=E.ViewshedShadow,a.vertexDiscardMode=bs.None;else if(t.identifier===Bn.Highlight)a.output=E.Highlight,a.vertexDiscardMode=bs.None;else{switch(n===ji.OpaqueAndTransparent?a.vertexDiscardMode=t.transparent?bs.Opaque:bs.Transparent:a.vertexDiscardMode=bs.None,a.output=t.output,a.receiveAmbientOcclusion=!1,a.receiveShadows=!1,t.output){case E.Color:a.receiveAmbientOcclusion=s.ssao!=null,a.hasOccludees=s.hasOccludees,a.receiveShadows=s.shadowMap.ready,a.hasScreenSpaceReflections=s.ssr.lastFrameColor!=null,a.hasCloudsReflections=s.cloudsFade.data!=null;break;case E.ObjectAndLayerIdColor:a.objectAndLayerIdColor=!0}a.snowCover=this.hasSnowCover(s)}return this._technique=e.releaseAndAcquire(mx,a,this._technique),this._setClean(),this._technique}hasSnowCover(e){return e.weather!=null&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}submit(e,t,s){if(this.objectOpacity===0)return;const r=s.renderable.geometry,a=s.components,n=s.renderable.meta.cameraDepthSquared,o=a.geometryRanges,l=a.highlightRanges,h=a.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case ji.Opaque:e.materialOpaque.submitDraw(this,r,o,n);break;case ji.Transparent:e.materialTransparent.submitDraw(this,r,o,n);break;case ji.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,r,o,n),e.materialTransparent.submitDraw(this,r,o,n);break;case ji.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,r,o,n),J3(t)&&e.highlightIntegratedMesh.submitDraw(this,r,o,n)}const d=this.componentParameters.castShadows!==oi.None;d&&e.shadowMap.submitDraw(this,r,o,n),l!=null&&(e.highlight.submitDraw(this,r,l,n),d&&e.highlightShadowMap.submitDraw(this,r,l,n)),t.viewshedEnabled&&e.viewshedShadowMap.submitDraw(this,r,o,n),d&&h!=null&&e.defaultShadowMap.submitDraw(this,r,h,n)}_computeWhichMaterialPass(){return this.isIntegratedMesh?ji.IntegratedMesh:this.objectOpacity<1?ji.Transparent:this.componentParameters.opaqueOverride===oi.All?ji.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===ml.Blend||this.alphaDiscardMode===ml.MaskBlend?ji.Transparent:this.componentParameters.transparent===oi.None?ji.Opaque:this.componentParameters.transparent===oi.All?ji.Transparent:ji.OpaqueAndTransparent}};var ji,oi;c([At({vectorOps:v1})],ui.prototype,"baseColor",void 0),c([At()],ui.prototype,"usePBR",void 0),c([At()],ui.prototype,"hasParametersFromSource",void 0),c([At({vectorOps:mf})],ui.prototype,"mrrFactors",void 0),c([At({vectorOps:mf})],ui.prototype,"emissiveFactor",void 0),c([At({dispose:!0})],ui.prototype,"baseColorTexture",void 0),c([At({dispose:!0})],ui.prototype,"metallicRoughnessTexture",void 0),c([At({dispose:!0})],ui.prototype,"emissionTexture",void 0),c([At({dispose:!0})],ui.prototype,"occlusionTexture",void 0),c([At({dispose:!0})],ui.prototype,"normalTexture",void 0),c([At()],ui.prototype,"objectOpacity",void 0),c([cy()],ui.prototype,"commonMaterialParameters",void 0),c([cy()],ui.prototype,"componentParameters",void 0),c([At()],ui.prototype,"textureAlphaCutoff",void 0),c([At()],ui.prototype,"alphaDiscardMode",void 0),c([At()],ui.prototype,"isIntegratedMesh",void 0),c([At()],ui.prototype,"polygonOffsetEnabled",void 0),c([At()],ui.prototype,"ellipsoidMode",void 0),c([At()],ui.prototype,"hasOccludees",void 0),function(i){i[i.Opaque=0]="Opaque",i[i.Transparent=1]="Transparent",i[i.OpaqueAndTransparent=2]="OpaqueAndTransparent",i[i.IntegratedMesh=3]="IntegratedMesh"}(ji||(ji={}));let Bd=class extends Ug{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=ig.Back,this.hasSlicePlane=!0}};c([At()],Bd.prototype,"doubleSided",void 0),c([At()],Bd.prototype,"cullFace",void 0),c([At()],Bd.prototype,"hasSlicePlane",void 0);let Lh=class extends Ug{constructor(){super(...arguments),this.externalColor=er(1,1,1,1),this.externalColorMixMode=yu.Multiply,this.castShadows=oi.All}get transparent(){return this.externalColor[3]<1?oi.All:oi.None}get opaqueOverride(){return this.externalColorMixMode===yu.Replace&&this.externalColor[3]===1?oi.All:oi.None}get visible(){return this.externalColor[3]>0?oi.All:oi.None}get type(){return gc.Uniform}};c([At({vectorOps:v1})],Lh.prototype,"externalColor",void 0),c([At()],Lh.prototype,"externalColorMixMode",void 0),c([At()],Lh.prototype,"castShadows",void 0),function(i){i[i.All=0]="All",i[i.Some=1]="Some",i[i.None=2]="None"}(oi||(oi={}));let fh=class extends Ug{constructor(){super(...arguments),this.texture=null,this.transparent=oi.None,this.opaqueOverride=oi.None,this.castShadows=oi.None}get type(){return gc.Varying}};function J3(i){var e;return((e=i.overlay)==null?void 0:e.getTexture(mr.Highlight))!=null}function eN(i){var e;return((e=i.overlay)==null?void 0:e.getTexture(mr.WaterNormal))!=null}function tN(i){var e;return((e=i.overlay)==null?void 0:e.getTexture(mr.ColorNoRasterImage))!=null}c([At()],fh.prototype,"texture",void 0),c([At()],fh.prototype,"transparent",void 0),c([At()],fh.prototype,"opaqueOverride",void 0),c([At()],fh.prototype,"castShadows",void 0);let iN=class{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}},sN=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const s=new gi(this.textureWidth,1);s.samplingMode=Zs.NEAREST,s.wrapMode=Ki.CLAMP_TO_EDGE,this._texture=new Yi(this._rctx,s),this._data=new vu(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,s,r,a,n){const o=e*this._fieldCount+t;this._dirty=!0,this._data.set(o,0,s),this._data.set(o,1,r),this._data.set(o,2,a),this._data.set(o,3,n)}setDataElement(e,t,s,r){const a=e*this._fieldCount+t;this._dirty=!0,this._data.set(a,s,r)}getDataElement(e,t,s){const r=e*this._fieldCount+t;return this._dirty=!0,this._data.get(r,s)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const s=Math.ceil(t/this.textureWidth)*this.textureWidth,r=new vu(new ArrayBuffer(4*s));r.typedBuffer.set(this._data.typedBuffer),this._data=r}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}};const vx=65536;let rN=class{constructor(e,t=1){this.textureBuffer=new sN(e,t),this._indexManager=new iN(vx)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}},aN=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(e=>e.activeCount!==0||(e.dispose(),!1))}destroy(){this._buffers.forEach(e=>e.dispose()),this._buffers=[]}getBuffer(e){for(const s of this._buffers)if(s.availableCount>=e)return s;if(e>vx)return null;const t=new rN(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}};const uy=()=>Pe.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");let nN=class{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._visible=new Gt,this._hidden=new Gt,this._renderSubmit=new k3(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=li("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new aN(e.rctx,2+(this._hasObjectAndLayerId?1:0))}destroy(){Cs(this._hidden.length===0&&this._visible.length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll(e=>e.destroy()),this._hidden.forAll(e=>e.destroy()),this._visible.clear(),this._hidden.clear()}createObject(e){const t=e.geometry,s=new r3(this._componentBufferManager,lb(t.componentOffsets)),r=this._createRenderable(e,s),a=new E3(this._viewingMode,t.positionData,s),n=new n3(e.transform,e.toMapSpace,e.obb.clone(),s,r,a);return(n.visible?this._visible:this._hidden).push(n),n}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const s=e;t!==s.visible&&(t?(this._hidden.removeUnordered(s),this._visible.push(s)):(this._visible.removeUnordered(s),this._hidden.push(s)),s.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll(s=>s.renderable.meta.cameraDepthSquared=ln(t,s.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const s=e.renderable.material;t(s),s.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const s=e;s.components.visibility.reset(t),s.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,s=t.components.visibility.componentCount;return{visible:s,invisible:t.components.count-s}}setComponentData(e,t){const s=e,r=s.renderable.material,a=s.components,n=a.materialDataBuffer,o=a.materialDataIndices,l=new W3,h=n.textureBuffer,d=new Uint8Array(4),u=new Uint32Array(d.buffer);let m=0,_=0,f=0,g=a.verticalOffsets,y=1/0,w=-1/0,x=!1,T=!1,S=0;for(let C=0;C<a.count;C++){t(C,l),m+=+(l.externalColor[3]<1),_+=+(l.externalColorMixMode===yu.Replace&&l.externalColor[3]===1),f+=+l.castShadows,aO(l.externalColor,l.externalColorMixMode,d),d[2]=254&d[2]|+l.castShadows,h.setData(o[C],0,d[0],d[1],d[2],d[3]),x||(x=C>0&&S!==u[0]),S=u[0],T||(T=l.elevationOffset!==0),T&&g==null&&(g=new Array(C).fill(0)),g!=null&&(g[C]=l.elevationOffset),y=Math.min(y,l.elevationOffset),w=Math.max(w,l.elevationOffset),oO(l.elevationOffset,d),h.setData(o[C],1,d[0],d[1],d[2],d[3]);const P=l.objectAndLayerIdColor;P!=null&&h.setData(o[C],2,P[0],P[1],P[2],P[3]),l.pickable!==w_(a.pickability,C)&&(a.pickability=f3(a.pickability,a.count,C,l.pickable))}a.verticalOffsets=T?g:null,s.offsetObb=T?iO(s.obb,y,w,this._viewingMode,s.offsetObb??s.obb.clone()):null,x||T||this._hasObjectAndLayerId?(r.componentParameters=new fh,r.componentParameters.castShadows=hm(f,a.count),r.componentParameters.transparent=hm(m,a.count),r.componentParameters.opaqueOverride=hm(_,a.count),r.componentParameters.texture=h,h.updateTexture()):(r.componentParameters=new Lh,r.componentParameters.castShadows=l.castShadows?oi.All:oi.None,r.componentParameters.externalColor=l.externalColor,r.componentParameters.externalColorMixMode=l.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,s,r=!1){e.intersectionGeometry.getComponentAabb(t,s);const a=e,n=a.components.verticalOffsets;if(r||n==null)return s;const o=n[t];if(this._viewingMode===$e.Local||o===0)return s[2]+=o,s[5]+=o,s;const l=Kf(o);return l.localOrigin=a.transform.position,l.applyToAabb(s)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,s){return e.intersectionGeometry.getComponentPositions(t,s)}expandRangeWithComponentObjectElevationRange(e,t,s,r){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||r.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const a=e,n=a.components,o=n.count,l=n.verticalOffsets,h=a.intersectionGeometry,d=this._viewingMode===$e.Local,u=h.getComponentAabbs(),m=lN;let _=1/0,f=-1/0;for(let g=0;g<o;g++){const y=6*g,w=(l==null?void 0:l[g])??0;let x=1/0,T=-1/0;if(d)x=u[y+2]+w+t,T=u[y+5]+w+t;else{if(m[0]=u[y],m[1]=u[y+1],m[2]=u[y+2],m[3]=u[y+3],m[4]=u[y+4],m[5]=u[y+5],w!==0){const R=Kf(w);R.localOrigin=a.transform.position,R.applyToAabb(m)}const S=Math.max(Math.abs(m[3]),Math.abs(m[0])),C=Math.max(Math.abs(m[4]),Math.abs(m[1])),P=t+m[5]+s;r.expandElevationRangeValues(t+m[2],Math.sqrt(S*S+C*C+P*P)-s)}r.expandElevationRangeValues(x,T),_=Math.min(_,x),f=Math.max(f,T)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=_,this._elevationRangeCacheMax=f}intersect(e,t,s,r,a,n,o){const l=e,{transform:h}=l,{position:d}=h;return a!=null&&(a.localOrigin=d),l.intersectionGeometry.intersect(t,s,r,a,l.components.verticalOffsets,h,n,o)}addEdges(e,t,s,r,a){const n=e,{indices:o,positions:l}=n.intersectionGeometry,h=n.components.offsets;return t.addComponentObject(n,l,o,h,s,r,a)}async extractEdgeInformation(e,t,s){const r=e,a=r.components.visibility;if(a.allInvisible())return{buffer:lO.createBuffer(0),origin:[0,0,0]};const{indices:n,positions:o}=r.intersectionGeometry,l=r.components.offsets,h=hO.createBuffer(o.length/3);SR(h.position.typedBuffer,o,h.position.typedBufferStride,3),rO(h.position,h.position,r.transform.rotationScale),this._setComponentIndices(h.componentIndex,n,l);const d=h.count,u=this._computeVisibilityIndices(n,a,l,d);return{origin:gn(r.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:u,indicesLength:u.length,skipDeduplicate:!0,data:h,writerSettings:{reducedPrecision:!1,variants:0}},s)}}_setComponentIndices(e,t,s){let r=0;for(let a=0;a<s.length-1;a++){const n=s[a],o=s[a+1];for(let l=n;l<o;l++){const h=t?t[l]:l;e.set(h,r)}r++}}_computeVisibilityIndices(e,t,s,r){if(e&&t.allVisible())return e;let a=0;t.forEachComponentRange((l,h)=>(a+=s[h]-s[l],!0));const n=CC(e)?new Array(a):(e==null?void 0:e.BYTES_PER_ELEMENT)===2||r<=65536?new Uint16Array(a):new Uint32Array(a);let o=0;return t.forEachComponentRange((l,h)=>{const d=s[l],u=s[h];for(let m=d;m<u;m++)n[o++]=e?e[m]:m;return!0}),n}addComponentHighlight(e,t){const s=e.components;s.highlightCounts==null&&(s.highlightCounts=new Uint32Array(s.count+1)),s.highlightCounts[t]++===0&&(s.highlightsDirty(),this._notifyDirty()),s.highlightCounts[s.count]++}removeComponentHighlight(e,t){const s=e.components;if(s.highlightCounts==null)return void uy().warn("Removing non-existing highlight.");const r=s.highlightCounts[t],a=s.highlightCounts[s.count];if(r!==0){if(r>1)return s.highlightCounts[t]=r-1,void(s.highlightCounts[s.count]=a-1);s.highlightCounts[t]=0,s.highlightsDirty(),this._notifyDirty(),a===1?s.highlightCounts=null:s.highlightCounts[s.count]=a-1}else uy().warn("Removing non-existing highlight.")}clearHighlights(e){const t=e.components;t.highlightCounts!=null&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const s=this._renderManager.rctx,r=e.geometry,a=r.vertices.layoutParameters,n=Ls.createVertex(s,xr.STATIC_DRAW,r.vertices.data),o=r.indices?Ls.createIndex(s,xr.STATIC_DRAW,r.indices):null,l=On(j3(a)),h=new Uint16Array(r.vertices.count);for(let g=0;g<t.count;g++){const y=t.offsets[g],w=t.offsets[g+1],x=t.materialDataIndices[g];if(r.indices!=null)for(let T=y;T<w;T++)h[r.indices[T]]=x;else for(let T=y;T<w;T++)h[T]=x}const d=Ls.createVertex(s,xr.STATIC_DRAW,h.buffer),u=new ui(e.transform,e.toMapSpace),m=new cO(s,gx,{data:l,componentIndices:oN},{data:n,componentIndices:d},o),_=new F3(m,Ai.TRIANGLES,a,o!=null),f={cameraDepthSquared:.5,gpuMemoryEstimate:n.usedMemory+d.usedMemory+(o!=null?o.usedMemory:0)};return new N3(u,_,f)}_notifyDirty(){this._renderManager.notifyDirty()}};const oN=On(Mn().u16(Te.COMPONENTINDEX));function hm(i,e){return i===e?oi.All:i===0?oi.None:oi.Some}const lN=Wu();let qg=class extends ri{};function yx(){const i=new Dt,{outputs:e,fragment:t}=i;return i.include(Ps),t.uniforms.add(new sg("textureInput",s=>s.input)),t.constants.add("sampleArea","int",Math.ceil(oc/2)),e.add("fragGrid","vec2"),t.code.add(v`
    void main() {
      float red = 0.0;
      float green = 1.0;
      int cellSize = ${v.int(ur)};
      vec2 texelSize = 1.0 / vec2(textureSize(textureInput, 0));
      vec2 offset = floor(gl_FragCoord.xy) * vec2(float(cellSize));

      for(int x = -sampleArea; x < cellSize + sampleArea; x += 2) {
        for(int y = -sampleArea; y < cellSize + sampleArea; y += 2) {
          vec2 coord = (offset + vec2(float(x), float(y))) * texelSize;
          vec4 value = texture(textureInput, coord);
          float mx = floor(max(value.g, value.b));

          red = max(red, ceil(value.r));
          green = min(green, mx);
          if(red == 1.0 && green == 0.0) {
            fragGrid = vec2(red, green);
            return;
          }
        }
      }
      fragGrid = vec2(red, green);
    }`),i}const ur=32,oc=9,zg=.4,hN=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:qg,blurSize:zg,build:yx,gridCellPixelSize:ur,outlineSize:oc},Symbol.toStringTag,{value:"Module"}));function bx(){const i=new Dt,{vertex:e,fragment:t}=i,s=e.code,r=t.code;return i.attributes.add(Te.POSITION,"vec2"),i.varyings.add("uv","vec2"),i.attributes.add(Te.UV0,"vec2"),e.uniforms.add(new Fe("coverageTex",a=>a.coverageTexture),new Bi("coverageRounding",a=>a.coverageRounding)),s.add(v`void main() {
vec4 cov = texture(coverageTex, uv0 * coverageRounding);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
return;
}
gl_Position = vec4(position, 0.0, 1.0);
uv = position.xy * 0.5 + vec2(0.5);
}`),t.uniforms.add(new Fe("tex",a=>a.blurTexture),new Fe("highlightTexture",a=>a.highlightTexture),new cn("uColor",a=>a.color),new cn("haloColor",a=>a.haloColor),new cn("opacities",a=>vn(cN,a.haloOpacity,a.haloOpacityOccluded,a.fillOpacity,a.fillOpacityOccluded))),t.constants.add("inner","float",1-(oc-zg)/oc),r.add(v`void main() {
vec4 blurredHighlightValue = texture(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture(highlightTexture, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = uColor.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = uColor.w * opacities[2];
}
float outlineFactor = smoothstep(0.0, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
fragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);
}`),i}const cN=mi(),dN=Object.freeze(Object.defineProperty({__proto__:null,build:bx},Symbol.toStringTag,{value:"Module"}));let wx=class xx extends It{initializeProgram(e){return new Lt(e.rctx,xx.shader.get().build(),pt)}initializePipeline(){return ot({blending:Ss(K.SRC_ALPHA,K.ONE,K.ONE_MINUS_SRC_ALPHA,K.ONE_MINUS_SRC_ALPHA),colorWrite:ht})}};wx.shader=new $t(dN,()=>ae(()=>Promise.resolve().then(()=>iF),void 0,import.meta.url));let Bg=class extends ri{constructor(){super(...arguments),this.blurSize=Hi()}};function Cx(){const i=new Dt,{attributes:e,varyings:t,vertex:s,fragment:r}=i;return e.add(Te.POSITION,"vec2"),e.add(Te.UV0,"vec2"),t.add("blurCoordinate","vec3"),s.uniforms.add(new Fe("coverageTex",a=>a.coverageTexture),new Bi("coverageRounding",a=>a.coverageRounding)),s.code.add(v`void main() {
gl_Position = vec4(position, 0.0, 1.0);
vec4 cov = texture(coverageTex, uv0 * coverageRounding);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
}
blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), cov.g);
}`),r.uniforms.add(new PR("blurSize",a=>a.blurSize),new sg("tex",a=>a.blurInputTexture)),r.code.add(v`void main() {
vec2 uv = blurCoordinate.xy;
vec4 center = texture(tex, uv);
if (blurCoordinate.z == 1.0) {
fragColor = center;
} else {
vec4 sum = center * 0.204164;
sum += texture(tex, uv + blurSize * 1.407333) * 0.304005;
sum += texture(tex, uv - blurSize * 1.407333) * 0.304005;
sum += texture(tex, uv + blurSize * 3.294215) * 0.093913;
sum += texture(tex, uv - blurSize * 3.294215) * 0.093913;
fragColor = sum;
}
}`),i}const uN=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:Bg,build:Cx},Symbol.toStringTag,{value:"Module"}));let Tx=class Sx extends It{initializeProgram(e){return new Lt(e.rctx,Sx.shader.get().build(),pt)}initializePipeline(){return ot({colorWrite:ht})}};Tx.shader=new $t(uN,()=>ae(()=>Promise.resolve().then(()=>sF),void 0,import.meta.url));let Px=class Rx extends It{initializeProgram(e){return new Lt(e.rctx,Rx.shader.get().build(),pt)}initializePipeline(){return ot({colorWrite:ht})}};Px.shader=new $t(hN,()=>ae(()=>Promise.resolve().then(()=>rF),void 0,import.meta.url));let pN=class extends ri{constructor(){super(...arguments),this.color=er(1,0,1,1),this.haloColor=er(1,0,1,1),this.haloOpacity=1,this.haloOpacityOccluded=.25,this.fillOpacity=.2,this.fillOpacityOccluded=.05,this.coverageRounding=U_(1,1)}},tl=class extends Qu{constructor(e){super(e),this.produces="highlight-color",this.consumes={required:["highlight-color","highlights"]},this._passParameters=new pN,this._downsampleDrawParameters=new qg,this._blurDrawParameters=new Bg,this._blurColorFormat=li("mac")?ni.RGBA:ni.RGBA4,this._grid={coverage:null,vao:null,verticalCellCount:0,horizontalCellCount:0,viewportWidth:0,viewportHeight:0},this._blurTechnique=e.techniques.acquire(Tx),this._downsampleTechnique=e.techniques.acquire(Px),this._applyTechnique=e.techniques.acquire(wx)}initialize(){this.addHandles([M(()=>this.view.highlightOptions.color,e=>{this._passParameters.color=Gh(e??hw),this.view.highlightOptions.haloColor||(this._passParameters.haloColor=this._passParameters.color),this.requestRender(st.UPDATE)},ut),M(()=>this.view.highlightOptions.haloColor,e=>{this._passParameters.haloColor=e!=null?Gh(e):this._passParameters.color,this.requestRender(st.UPDATE)},ut),M(()=>this.view.highlightOptions.haloOpacity,e=>{this._passParameters.haloOpacity=e??cw,this._passParameters.haloOpacityOccluded=.25*this._passParameters.haloOpacity,this.requestRender(st.UPDATE)},ut),M(()=>this.view.highlightOptions.fillOpacity,e=>{this._passParameters.fillOpacity=e??dw,this._passParameters.fillOpacityOccluded=.25*this._passParameters.fillOpacity,this.requestRender(st.UPDATE)},ut)])}destroy(){this._blurTechnique.release(),this._downsampleTechnique.release(),this._applyTechnique.release(),this._grid.coverage=tt(this._grid.coverage),this._grid.vao=je(this._grid.vao)}render(e){var w,x,T;if(this.bindParameters.decorations===Ws.OFF)return e.find(({name:S})=>S==="highlight-color");if(!(this._blurTechnique.compiled&&this._downsampleTechnique.compiled&&this._applyTechnique.compiled))return this.requestRender(st.UPDATE),e.find(({name:S})=>S==="highlight-color");const t=e.find(({name:S})=>S==="highlights").getTexture(),s=this.bindParameters.camera,r=s.fullWidth,a=s.fullHeight,n=s.pixelRatio,o=Math.ceil(r/n),l=Math.ceil(a/n),h=this.renderingContext;this._gridUpdateResources(t),this._gridComputeCoverage(t,this.bindParameters),this._passParameters.highlightTexture=t,this._passParameters.coverageTexture=(w=this._grid.coverage)==null?void 0:w.getTexture();const{width:d,height:u}=t.descriptor;Aa(this._passParameters.coverageRounding,d/(Math.ceil(d/ur)*ur),u/(Math.ceil(u/ur)*ur));const m=this._grid.vao;h.bindVAO(m);const _=this.fboCache.acquire(o,l,"highlight blur",this._blurColorFormat);h.unbindTexture((x=_.fbo)==null?void 0:x.colorTexture),h.bindFramebuffer(_.fbo),h.setClearColor(0,0,0,0),h.clear(Mi.COLOR_BUFFER_BIT),h.setViewport(0,0,o,l),this._blurDrawParameters.blurInputTexture=t,Aa(this._blurDrawParameters.blurSize,1/o,0);const f=h.bindTechnique(this._blurTechnique,this.bindParameters,this._passParameters,this._blurDrawParameters);h.drawArrays(this._blurTechnique.primitiveType,0,$a(m,"geometry"));const g=this.fboCache.acquire(o,l,"highlight blur",this._blurColorFormat);h.unbindTexture((T=g.fbo)==null?void 0:T.colorTexture),h.bindFramebuffer(g.fbo),h.setClearColor(0,0,0,0),h.clear(Mi.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=_.getTexture(),Aa(this._blurDrawParameters.blurSize,0,1/l),f.bindDraw(this._blurDrawParameters,this.bindParameters,this._passParameters),h.drawArrays(this._blurTechnique.primitiveType,0,$a(m,"geometry"));const y=e.find(({name:S})=>S==="highlight-color");return h.bindFramebuffer(y.fbo),h.setViewport4fv(s.fullViewport),this._passParameters.blurTexture=g.getTexture(),h.bindTechnique(this._applyTechnique,this.bindParameters,this._passParameters),h.drawArrays(this._applyTechnique.primitiveType,0,$a(m,"geometry")),_.release(),g.release(),y}_gridUpdateResources(e){var m;const t=this.renderingContext,s=this._grid,r=Math.ceil(e.descriptor.height/ur),a=Math.ceil(e.descriptor.width/ur);if(s.vao&&s.verticalCellCount===r&&s.horizontalCellCount===a)return;s.verticalCellCount=r,s.horizontalCellCount=a;const n=r+1,o=a+1,l=1/r,h=1/a,d=new Float32Array(6*4*n*o);let u=0;for(let _=0;_<n;_++)for(let f=0;f<o;f++)d[u++]=(f-.5)*h*2-1,d[u++]=(_-.5)*l*2-1,d[u++]=f*h,d[u++]=_*l,d[u++]=(f+.5)*h*2-1,d[u++]=(_-.5)*l*2-1,d[u++]=f*h,d[u++]=_*l,d[u++]=(f-.5)*h*2-1,d[u++]=(_+.5)*l*2-1,d[u++]=f*h,d[u++]=_*l,d[u++]=(f-.5)*h*2-1,d[u++]=(_+.5)*l*2-1,d[u++]=f*h,d[u++]=_*l,d[u++]=(f+.5)*h*2-1,d[u++]=(_-.5)*l*2-1,d[u++]=f*h,d[u++]=_*l,d[u++]=(f+.5)*h*2-1,d[u++]=(_+.5)*l*2-1,d[u++]=f*h,d[u++]=_*l;(m=s.vao)==null||m.dispose(),s.vao=new Rn(t,pt,{geometry:fc},{geometry:Ls.createVertex(t,xr.STATIC_DRAW,d)})}_gridComputeCoverage(e,t){var l,h;const s=this.renderingContext,r=this._grid,a=e.descriptor,n=Math.ceil(a.width/ur),o=Math.ceil(a.height/ur);this._downsampleDrawParameters.input=e,(l=r.coverage)==null||l.release(),r.coverage=this.fboCache.acquire(n,o,"highlight coverage",ni.RG),s.unbindTexture((h=r.coverage.fbo)==null?void 0:h.colorTexture),s.bindFramebuffer(r.coverage.fbo),s.bindTechnique(this._downsampleTechnique,t,this._passParameters,this._downsampleDrawParameters),s.setViewport(0,0,n,o),s.screen.draw()}get test(){}};c([p()],tl.prototype,"produces",void 0),c([p()],tl.prototype,"consumes",void 0),c([p({constructOnly:!0})],tl.prototype,"techniques",void 0),tl=c([F("esri.views.3d.webgl-engine.effects.highlight.Highlight")],tl);let Hg=class extends tr{constructor(){super(...arguments),this.receiveShadows=!0}};c([z()],Hg.prototype,"receiveShadows",void 0);function Ox(i){const e=i.fragment;i.include(zu),e.include(uc),e.code.add(v`vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
float leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);
float rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);
float bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);
float topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`)}const mN=.99999,_N=.025;function Mx(i){const e=new Dt;e.include(tg,i),e.include(Ps),e.include(Ox);const t=e.fragment;return t.include(_c),t.uniforms.add(new Fe("defaultDepthTex",(s,r)=>r.shadowMap.getSnapshot(ou.ExcludeHighlight)),new Fe("highlightDepthTex",(s,r)=>r.shadowMap.getSnapshot(ou.Highlight)),new Fe("depthMap",(s,r)=>{var a;return(a=r.depth)==null?void 0:a.attachment}),new Fe("highlightTexture",s=>s.highlight),new cn("uColor",s=>s.shadowColor),new He("opacity",s=>s.shadowOpacity),new He("occludedOpacity",s=>s.occludedShadowOpacity),new He("terminationFactor",s=>s.opacityElevation*s.dayNightTerminator),new Ei("lightingMainDirectionView",(s,r)=>oe(my,Xt(my,r.lighting.mainLight.direction,r.camera.viewInverseTransposeMatrix))),new Ji("inverseViewMatrix",(s,r)=>cu(py,fo(py,r.camera.viewMatrix,r.camera.center)))),t.constants.add("unoccludedHighlightFlag","vec4",WR),t.code.add(v`
    void main(void) {
      vec4 highlightInfo = texture(highlightTexture, uv);
      float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
      if (visiblyHighlighted > ${v.float(mN)}) {
        discard;
      }

      float depth = depthFromTexture(depthMap, uv);

      // 1.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
      if (depth >= 1.0 || depth <= 0.0) {
        discard;
      }

      float currentPixelDepth = linearizeDepth(depth);
      vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
      vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;

      mat4 shadowMatrix;
      float linearDepth = -currentPixelDepth;
      int i = chooseCascade(linearDepth, shadowMatrix);
      if (i >= numCascades) {
        discard;
      }

      vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);

      // vertex completely outside? -> no shadow
      if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
        discard;
      }

      ivec2 texSize = textureSize(highlightDepthTex, 0);
      ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));

      float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
      bool shadowHighlight = depthHighlight < lvpos.z;
      if (!shadowHighlight) {
        discard;
      }

      float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
      bool shadowDefault = depthDefault < lvpos.z;

      vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);
      bool shaded = dot(normal, lightingMainDirectionView) < ${v.float(_N)};

      float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
      fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
    }
  `),e}const py=Qe(),my=b(),gN=Object.freeze(Object.defineProperty({__proto__:null,build:Mx},Symbol.toStringTag,{value:"Module"}));let fN=class extends eg{constructor(){super(...arguments),this.shadowColor=er(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}},Ex=class Ax extends It{constructor(e){super(e,new Hg,()=>this.destroy())}initializeProgram(e){return new Lt(e.rctx,Ax.shader.get().build(this.configuration),pt)}initializePipeline(){return ot({blending:Ss(K.SRC_ALPHA,K.ONE,K.ONE_MINUS_SRC_ALPHA,K.ONE_MINUS_SRC_ALPHA),colorWrite:ht,depthTest:null,depthWrite:null})}get primitiveType(){return Ai.TRIANGLE_STRIP}};Ex.shader=new $t(gN,()=>ae(()=>Promise.resolve().then(()=>aF),void 0,import.meta.url));const vN=.001953125,yN=4e4,bN=5e4;let Yn=class extends Qu{constructor(e){super(e),this.produces="composite-color",this.consumes={required:["composite-color","highlights"]},this._passParameters=new fN,this._maxOpacity=1,this._shadowDifference=.2,this._technique=e.techniques.acquire(Ex)}initialize(){this.addHandles([M(()=>this.view.highlightOptions.shadowOpacity,e=>{this._passParameters.shadowOpacity=e??pw,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()},ut),M(()=>this.view.highlightOptions.shadowDifference,e=>{this._shadowDifference=e??mw,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()},ut),M(()=>this.view.highlightOptions.shadowColor,e=>{this._passParameters.shadowColor=Gh(e??uw),this._updateMaxOpacity()},ut)])}destroy(){this._technique.release()}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}render(e){var a;const t=e.find(({name:n})=>n==="composite-color"),s=this.bindParameters;if(!s.shadowHighlightsVisible||!s.depth||!this._ensureIfVisible(s.camera,s.lighting.mainLight.direction))return t;if(!this._technique.compiled)return this.requestRender(st.UPDATE),t;this._passParameters.highlight=(a=e.find(({name:n})=>n==="highlights"))==null?void 0:a.getTexture(),this._passParameters.origin=s.camera.center;const r=this.renderingContext;return r.bindFramebuffer(t.fbo),r.bindTechnique(this._technique,s,this._passParameters),r.screen.draw(),t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-Vh(yN,bN,e.relativeElevation);const s=this.viewingMode===$e.Global?oe(_y,e.center):it(_y,0,0,1),r=ue(s,t);return this._passParameters.dayNightTerminator=Vh(0,1,Z(30*r,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=vN}};c([p()],Yn.prototype,"produces",void 0),c([p()],Yn.prototype,"consumes",void 0),c([p({constructOnly:!0})],Yn.prototype,"viewingMode",void 0),c([p({constructOnly:!0})],Yn.prototype,"techniques",void 0),Yn=c([F("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],Yn);const _y=b();let Gg=class extends ri{constructor(){super(...arguments),this.mask=null,this.overlay=null,this.input=null,this.size=0}};function Dx(){const i=new Dt;return i.attributes.add(Te.POSITION,"vec2"),i.vertex.uniforms.add(new cn("drawPosition",(e,t)=>wN(e,t))),i.varyings.add("vUV","vec2"),i.vertex.code.add(v`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),i.fragment.uniforms.add(new Fe("textureInput",e=>e.input)),i.fragment.uniforms.add(new Fe("textureMask",e=>e.mask)),i.fragment.uniforms.add(new Fe("textureOverlay",e=>e.overlay)),i.fragment.uniforms.add(new jh("maskEnabled",e=>e.magnifier.maskEnabled)),i.fragment.uniforms.add(new jh("overlayEnabled",e=>e.magnifier.overlayEnabled)),i.fragment.code.add(v`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),i}function wN(i,e){const t=e.camera.pixelRatio,s=i.magnifier.offset.x*t,r=i.magnifier.offset.y*t;Ca(i.magnifier.position,gy);const a=e.camera.screenToRender(gy,xN),n=Math.ceil(t*i.magnifier.size),o=e.camera.fullWidth,l=e.camera.fullHeight;return vn(CN,(a[0]+s)/o*2-1,(a[1]-r)/l*2-1,n/o*2,n/l*2)}const gy=Ht(),xN=ky(),CN=mi(),TN=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:Gg,build:Dx},Symbol.toStringTag,{value:"Module"}));let $x=class Ix extends It{initializeProgram(e){return new Lt(e.rctx,Ix.shader.get().build(),pt)}initializePipeline(){return ot({blending:ta(K.ONE,K.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:ht})}};$x.shader=new $t(TN,()=>ae(()=>Promise.resolve().then(()=>nF),void 0,import.meta.url));let Za=class extends Qu{constructor(e){super(e),this.produces="magnifier-color",this.consumes={required:["magnifier-color"]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new Gg,this._vao=null,this._technique=null,this._magnifier=null,this._tmpScreenPoint=Ht(),this._tmpRenderPoint=ky()}initialize(){this.addHandles([M(()=>this.view.magnifier,e=>this._update(e),ut)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{const s=this._validMagnifier;s?(this._loadResources(s),this.produces="magnifier-color"):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles(M(()=>{var s;return(s=this._magnifier)==null?void 0:s.version},t)),t()}get _validMagnifier(){var e,t,s;return(e=this._magnifier)!=null&&e.visible&&((t=this._magnifier)!=null&&t.position)&&((s=this._magnifier)==null?void 0:s.size)>0?this._magnifier:null}get _factor(){var e;return((e=this._magnifier)==null?void 0:e.factor)||1}destroy(){this._magnifier=null,this._imageLoadTask!=null&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=je(this._vao)}_disposeTextures(){this._passParameters.mask=je(this._passParameters.mask),this._passParameters.overlay=je(this._passParameters.overlay),this._passParameters.input=je(this._passParameters.input)}render(e){var y;const t=this._validMagnifier,s=e.find(({name:w})=>w==="magnifier-color");if(t==null)return s;if(this._imageSources==null)return this.requestRender(st.UPDATE),s;const r=this.renderingContext,a=this.camera.pixelRatio,n=Math.ceil(a*t.size);if(this._vao??(this._vao=ra(r,ng,pt,0,1)),this._technique??(this._technique=this.techniques.acquire($x)),this._ensureTextureResources(r,n),!((y=this._technique)!=null&&y.compiled)||!this._passParameters.input)return this.requestRender(st.UPDATE),s;const o=Math.ceil(1/this._factor*n),l=this._passParameters.input;l.resize(o,o),Ca(t.position,this._tmpScreenPoint);const h=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),d=this.camera.fullWidth,u=this.camera.fullHeight,m=.5*o,_=.5*o;h[0]=Z(h[0],m,d-m-1),h[1]=Z(h[1],_,u-_-1);const f=Math.floor(h[0]-m),g=Math.floor(h[1]-_);return r.bindFramebuffer(s.fbo),this._technique.program.bindTexture("textureInput",l),r.gl.copyTexImage2D(l.descriptor.target,0,l.descriptor.pixelFormat,f,g,o,o,0),this._passParameters.magnifier=t,r.bindTechnique(this._technique,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(Ai.TRIANGLE_STRIP,0,4),s}_loadResources(e){var r,a,n;const{maskUrl:t,overlayUrl:s}=e;((r=this._imageLoadTask)==null?void 0:r.maskUrl)===t&&((a=this._imageLoadTask)==null?void 0:a.overlayUrl)===s||((n=this._imageLoadTask)==null||n.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:t,overlayUrl:s,task:cc(async o=>{const l=t==null||s==null?eO(o):null,h=t!=null?Kh(t,{signal:o}):l.then(u=>u.mask),d=s!=null?Kh(s,{signal:o}):l.then(u=>u.overlay);this._imageSources={mask:await h,overlay:await d}})})}_ensureTextureResources(e,t){if(this._imageSources==null||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay)return;this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t;const s=new gi;s.internalFormat=_i.RGBA,s.wrapMode=Ki.CLAMP_TO_EDGE,s.flipped=!0,s.preMultiplyAlpha=!B1(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result,this._passParameters.overlay=new Yi(e,s,this._imageSources.overlay),s.pixelFormat=s.internalFormat=_i.ALPHA,s.preMultiplyAlpha=!1,this._passParameters.mask=new Yi(e,s,this._imageSources.mask),s.pixelFormat=s.internalFormat=_i.RGBA,s.flipped=!1,this._passParameters.input=new Yi(e,s)}};c([p()],Za.prototype,"produces",void 0),c([p()],Za.prototype,"consumes",void 0),c([p()],Za.prototype,"_imageSources",void 0),c([p()],Za.prototype,"_imageLoadTask",void 0),c([p({constructOnly:!0})],Za.prototype,"techniques",void 0),Za=c([F("esri.views.3d.webgl-engine.effects.magnifier.MagnifierRenderNode")],Za);const Wo={maxSearchSteps:8,maxDistanceAreaTex:16};function Lx(){const i=new Dt;return i.include(Ps),i.fragment.uniforms.add(new Fe("edgesTexture",e=>e.inputTexture),new Fe("areaTexture",e=>e.areaTexture),new Fe("searchTexture",e=>e.searchTexture)),i.fragment.code.add(v`
    #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
    #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

    vec4 sampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset, vec2 resolution) {
      return texture(tex, coord + offset.x * resolution, 0.0);
    }

    float searchLength(sampler2D searchTex, vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture( searchTex, e, 0.0 ).r;
    }

    float searchLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {
      vec2 e = vec2( 0.0, 1.0 );
      for ( int i = 0; i < ${v.int(Wo.maxSearchSteps)}; i ++ ) {
        e = texture( edgesTex, texcoord, 0.0 ).rg;
        texcoord -= vec2( 2.0, 0.0 ) * resolution;
        if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(searchTex, e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {
      vec2 e = vec2( 0.0, 1.0 );
      for ( int i = 0; i < ${v.int(Wo.maxSearchSteps)}; i ++ ) {
        e = texture( edgesTex, texcoord, 0.0 ).rg;
        texcoord += vec2( 2.0, 0.0 ) * resolution;
        if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength( searchTex, e, 0.5, 0.5 );
      return texcoord.x;
    }

    float searchUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {
      vec2 e = vec2( 1.0, 0.0 );
      for ( int i = 0; i < ${v.int(Wo.maxSearchSteps)}; i ++ ) {
        e = texture( edgesTex, texcoord, 0.0 ).rg;
        texcoord += vec2( 0.0, 2.0 ) * resolution;
        if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength( searchTex, e.gr, 0.0, 0.5 );
      return texcoord.y;
    }

    float searchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {
      vec2 e = vec2( 1.0, 0.0 );
      for ( int i = 0; i < ${v.int(Wo.maxSearchSteps)}; i ++ ) {
        e = texture( edgesTex, texcoord, 0.0 ).rg;
        texcoord -= vec2( 0.0, 2.0 ) * resolution;
        if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength( searchTex, e.gr, 0.5, 0.5 );
      return texcoord.y;
    }

    vec2 getArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
      vec2 texcoord = float( ${v.int(Wo.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
      texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
      texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
      return texture( areaTex, texcoord, 0.0 ).rg;
    }

    void main() {
      vec2 size = vec2(textureSize(edgesTexture, 0));
      vec2 resolution = 1.0 / size;
      vec2 pixelCoord = uv * size;
      vec4 offsets[2];
      offsets[0] = uv.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
      offsets[1] = uv.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
      vec4 maxOffset = vec4( offsets[0].xz, offsets[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( ${v.int(Wo.maxSearchSteps)} );

      ivec4 subsampleIndices = ivec4(0.0);
      vec4 weights = vec4(0.0);
      vec2 e = texture( edgesTexture, uv ).rg;
      if ( e.g > 0.0 ) {
        vec2 d;
        vec2 coords;
        coords.x = searchLeft( edgesTexture, searchTexture, offsets[0].xy, maxOffset.x, resolution );
        coords.y = offsets[1].y;
        d.x = coords.x;
        float e1 = texture( edgesTexture, coords, 0.0 ).r;
        coords.x = searchRight( edgesTexture, searchTexture, offsets[0].zw, maxOffset.y, resolution );
        d.y = coords.x;
        d = d * size.x - pixelCoord.x;
        vec2 sqrt_d = sqrt( abs(d) );
        coords.y -= 1.0 * resolution.y;
        float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2( 1.0, 0.0 ), resolution).r;
        weights.rg = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.y ) );
      }

      if ( e.r > 0.0 ) {
        vec2 d;
        vec2 coords;
        coords.y = searchUp( edgesTexture, searchTexture, offsets[1].xy, maxOffset.z, resolution );
        coords.x = offsets[0].x;
        d.x = coords.y;
        float e1 = texture( edgesTexture, coords, 0.0 ).g;
        coords.y = searchYDown( edgesTexture, searchTexture, offsets[1].zw, maxOffset.w, resolution );
        d.y = coords.y;
        d = d * size.y - pixelCoord.y;
        vec2 sqrt_d = sqrt(abs(d));
        coords.y -= 1.0 * resolution.y;
        float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2(0.0, 1.0), resolution).g;
        weights.ba = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.x ) );

        // for some reason the following lines are necessary to prevent
        // texture lookup precision issues on some Intel integrated graphics chips
        vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
        weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
      }
      fragColor = weights;
    }`),i}const SN=Object.freeze(Object.defineProperty({__proto__:null,build:Lx},Symbol.toStringTag,{value:"Module"}));let Nx=class Fx extends It{initializeProgram(e){return new Lt(e.rctx,Fx.shader.get().build(),pt)}initializePipeline(){return ot({colorWrite:ht})}};Nx.shader=new $t(SN,()=>ae(()=>Promise.resolve().then(()=>oF),void 0,import.meta.url));function Vx(){const i=new Dt;return i.include(Ps),i.fragment.uniforms.add(new Fe("blendWeightsTexture",e=>e.inputTexture),new Fe("colorTexture",e=>e.color)),i.fragment.code.add(v`void main() {
vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}
}`),i}const PN=Object.freeze(Object.defineProperty({__proto__:null,build:Vx},Symbol.toStringTag,{value:"Module"}));let Ux=class qx extends It{initializeProgram(e){return new Lt(e.rctx,qx.shader.get().build(),pt)}initializePipeline(){return ot({colorWrite:ht})}};Ux.shader=new $t(PN,()=>ae(()=>Promise.resolve().then(()=>lF),void 0,import.meta.url));const fy={threshold:.05,localConstrastAdaption:2};function zx(){const i=new Dt;return i.include(Ps),i.fragment.uniforms.add(new Fe("colorTexture",e=>e.color)),i.outputs.add("fragEdges","vec2"),i.fragment.code.add(v`
    float absMax3(vec3 v) {
      vec3 t = abs(v);
      return max(max(t.r, t.g), t.b);
    }

    void main() {
      vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
      vec4 offsets[3];
      offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
      offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
      offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

      // Calculate color deltas:
      vec4 delta;
      vec3 C = texture(colorTexture, uv).rgb;

      vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
      delta.x = absMax3(C - Cleft);

      vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
      delta.y = absMax3(C - Ctop);

      vec2 edges = step(vec2(${v.float(fy.threshold)}), delta.xy);

      // discard if there is no edge:
      if (dot(edges, vec2(1.0)) == 0.0) {
        discard;
      }

      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      delta.z = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      delta.w = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      delta.z = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      delta.w = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, delta.z), delta.w);

      // Local contrast adaptation in action:
      edges *= step(maxDelta, float(${v.float(fy.localConstrastAdaption)}) * delta.xy);

      fragEdges = edges;
    }
  `),i}const RN=Object.freeze(Object.defineProperty({__proto__:null,build:zx},Symbol.toStringTag,{value:"Module"}));let Bx=class Hx extends It{initializeProgram(e){return new Lt(e.rctx,Hx.shader.get().build(),pt)}initializePipeline(){return ot({colorWrite:ht})}};Bx.shader=new $t(RN,()=>ae(()=>Promise.resolve().then(()=>hF),void 0,import.meta.url));let ON=class extends ri{},Ka=class extends Qu{constructor(e){super(e),this.produces="disabled",this.consumes={required:["aa-color","composite-color"]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new ON,this._edgeTechnique=e.techniques.acquire(Bx),this._blendTechnique=e.techniques.acquire(Nx),this._blurTechnique=e.techniques.acquire(Ux)}initialize(){this.addHandles([M(()=>this.isEnabled(),e=>e?this.enable():this.disable(),ut)])}async enable(){if(this.produces="aa-color",this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const e=this._abortController.signal;try{const t=await ae(()=>import("./SMAAData-DCEZ61Cs.js"),[],import.meta.url);await this._loadTextures(t,e),this.requestRender(st.UPDATE)}catch{}this._abortController=null}async _loadTextures(e,t){Qi(t);const[s,r]=await Promise.allSettled([Kh(e.areaTexture,{signal:t}),Kh(e.searchTexure,{signal:t})]);if(Qi(t),s.status!=="fulfilled"||r.status!=="fulfilled")return;const a=this.renderingContext;this._areaTexture=vy(a,Zs.LINEAR,_i.RGB,s.value),this._searchTexture=vy(a,Zs.NEAREST,_i.LUMINANCE,r.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=je(this._searchTexture),this._areaTexture=je(this._areaTexture),this._blurTechnique.release(),this._blendTechnique.release(),this._edgeTechnique.release()}render(e){var h,d;const t=e.find(({name:u})=>u==="aa-color");if(!(this._edgeTechnique.compiled&&this._blendTechnique.compiled&&this._blurTechnique.compiled&&this._areaTexture&&this._searchTexture))return this.requestRender(st.UPDATE),t;const s=e.find(({name:u})=>u==="composite-color"),r=s.fbo.width,a=s.fbo.height,n=this.renderingContext;n.setViewport(0,0,r,a);const o=this.fboCache.acquire(r,a,"smaa edges",ni.RG);n.unbindTexture((h=o.fbo)==null?void 0:h.colorTexture),n.bindFramebuffer(o.fbo),n.setClearColor(0,0,0,1),n.clear(Mi.COLOR_BUFFER_BIT),this._smaaParameters.color=s.getTexture(),n.bindTechnique(this._edgeTechnique,null,this._smaaParameters),n.screen.draw();const l=this.fboCache.acquire(r,a,"smaa blend");return n.unbindTexture((d=l.fbo)==null?void 0:d.colorTexture),n.bindFramebuffer(l.fbo),n.setClearColor(0,0,1,1),n.clear(Mi.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=o.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,n.bindTechnique(this._blendTechnique,null,this._smaaParameters),n.screen.draw(),o.release(),n.bindFramebuffer(t.fbo),n.setClearColor(0,1,0,1),n.clear(Mi.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=l.getTexture(),n.bindTechnique(this._blurTechnique,null,this._smaaParameters),n.screen.draw(),l.release(),t}};function vy(i,e,t,s){const r=new gi;return r.pixelFormat=t,r.wrapMode=Ki.CLAMP_TO_EDGE,r.width=s.width,r.height=s.height,r.samplingMode=e,new Yi(i,r,s)}c([p()],Ka.prototype,"produces",void 0),c([p()],Ka.prototype,"consumes",void 0),c([p({constructOnly:!0})],Ka.prototype,"isEnabled",void 0),c([p({constructOnly:!0})],Ka.prototype,"techniques",void 0),c([p()],Ka.prototype,"_abortController",void 0),Ka=c([F("esri.views.3d.webgl-engine.effects.smaa.SMAA")],Ka);let ep=class extends ri{constructor(){super(...arguments),this.opacity=1}};function Gx(i){const e=new Dt;return e.include(Ps),e.fragment.uniforms.add(new Fe("tex",t=>t.texture)),i.hasOpacityFactor&&e.fragment.uniforms.add(new He("opacity",t=>t.opacity)),i.isDepthBlit&&(e.fragment.uniforms.add(new Bi("nearFar",(t,s)=>s.camera.nearFar)),e.fragment.include(uc),e.fragment.include(_c)),e.fragment.code.add(v`
    void main() {
      ${i.isDepthBlit?v`
              float normalizedLinearDepth = (-linearDepthFromTexture(tex, uv) - nearFar[0]) / (nearFar[1] - nearFar[0]);
              fragColor = float2rgba(normalizedLinearDepth);`:v`
              fragColor = texture(tex, uv) ${i.hasOpacityFactor?"* opacity":""};`}
    }`),e}const MN=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:ep,build:Gx},Symbol.toStringTag,{value:"Module"}));var ws;(function(i){i[i.None=0]="None",i[i.Alpha=1]="Alpha",i[i.PremultipliedAlpha=2]="PremultipliedAlpha",i[i.COUNT=3]="COUNT"})(ws||(ws={}));let Nh=class extends tr{constructor(){super(...arguments),this.alphaMode=ws.None,this.hasOpacityFactor=!1,this.isDepthBlit=!1}};c([z({count:ws.COUNT})],Nh.prototype,"alphaMode",void 0),c([z()],Nh.prototype,"hasOpacityFactor",void 0),c([z()],Nh.prototype,"isDepthBlit",void 0);let kg=class kx extends It{initializeProgram(e){return new Lt(e.rctx,kx.shader.get().build(this.configuration),pt)}initializePipeline(){switch(this.configuration.alphaMode){case ws.None:return ot({colorWrite:ht});case ws.Alpha:return ot({blending:Ss(K.SRC_ALPHA,K.ONE,K.ONE_MINUS_SRC_ALPHA,K.ONE_MINUS_SRC_ALPHA),colorWrite:ht});case ws.PremultipliedAlpha:case ws.COUNT:return ot({blending:ta(K.ONE,K.ONE_MINUS_SRC_ALPHA),colorWrite:ht})}}};kg.shader=new $t(MN,()=>ae(()=>Promise.resolve().then(()=>cF),void 0,import.meta.url));let jg=class extends ri{};function jx(){const i=new Dt;return i.include(Ps),i.fragment.uniforms.add(new Fe("tex",e=>e.texture)),i.fragment.code.add(v`void main() {
fragColor = vec4(1.0 - texture(tex, uv).a);
}`),i}const EN=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:jg,build:jx},Symbol.toStringTag,{value:"Module"}));let Wx=class Qx extends It{initializeProgram(e){return new Lt(e.rctx,Qx.shader.get().build(),pt)}initializePipeline(){return ot({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}};Wx.shader=new $t(EN,()=>ae(()=>Promise.resolve().then(()=>dF),void 0,import.meta.url));let Wg=class extends ri{};function Xx(){const i=new Dt;return i.include(Ps),i.fragment.uniforms.add(new Fe("colorTexture",e=>e.colorTexture),new Fe("alphaTexture",e=>e.alphaTexture),new Fe("frontFaceTexture",e=>e.frontFaceTexture)),i.fragment.code.add(v`void main() {
float srcAlpha = texture(alphaTexture, uv).r;
if(srcAlpha <= 1e-5){
discard;
}
vec4 srcColor = texture(colorTexture, uv);
vec4 frontFace = texture(frontFaceTexture, uv);
fragColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);
}`),i}const AN=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:Wg,build:Xx},Symbol.toStringTag,{value:"Module"}));let Qg=class Yx extends It{initializeProgram(e){return new Lt(e.rctx,Yx.shader.get().build(),pt)}initializePipeline(){return ot({blending:Ss(K.SRC_ALPHA,K.ONE,K.ONE_MINUS_SRC_ALPHA,K.ONE_MINUS_SRC_ALPHA),colorWrite:ht})}};Qg.shader=new $t(AN,()=>ae(()=>Promise.resolve().then(()=>uF),void 0,import.meta.url));let DN=class{constructor(e,t){this._rctx=e,this._techniques=t,this._configuration=new Nh,this._passParameters=new ep,this._oitParameters=new Wg,this._hudParameters=new jg}compositeOIT(e,t,s,r){this._oitParameters.colorTexture=t,this._oitParameters.alphaTexture=s,this._oitParameters.frontFaceTexture=r;const a=this._techniques.acquire(Qg);this._rctx.bindTechnique(a,e,this._oitParameters),this._rctx.screen.draw(),a.release()}compositeHUD(e,t){this._hudParameters.texture=t;const s=this._techniques.acquire(Wx);this._rctx.bindTechnique(s,e,this._hudParameters),this._rctx.screen.draw(),s.release()}composite(e,t,s=ws.None,r=1){this._configuration.alphaMode=s,this._configuration.hasOpacityFactor=r!==1,this._passParameters.texture=t,this._passParameters.opacity=r;const a=this._techniques.acquire(kg,this._configuration);this._rctx.bindTechnique(a,e,this._passParameters),this._rctx.screen.draw(),a.release()}blitDepthToLinearDepth(e,t){this._configuration.isDepthBlit=!0,this.composite(e,t),this._configuration.isDepthBlit=!1}};const $N=1e4,C_=100,IN=500,LN=500,NN=.1;function FN(i,e,t){return dO(e,i)*(t[1]-t[0])+t[0]}function VN(i,e,t){let s=0;if(!e.some(a=>!!a.materialReference&&(s+=a.numGeometries,s>=$N)))return WN.compute(i,e);const r=yc();return t.forAll(a=>Pl(r,UN(i,a))),r}function UN(i,e){if(!e.visible)return;const t=yc(),s=e.getSpatialQueryAccelerator();return s?qN(t,i,s):zN(t,i,e.objects),t}function qN(i,e,t){const s=e.eye,r=e.viewForward,a=e.frustum,n=l=>l.visible,o=t.objectCount;if(o<IN)Du(Hs,e.near,Math.min(i.near,e.far)),t.forEachInDepthRange(s,r,ao.DepthOrder.FRONT_TO_BACK,Hs,(l,h)=>{T_(i,e,l),Hs.far=i.near,h.setRange(Hs)},a,n),Du(Hs,Math.max(i.far,e.near),e.far),t.forEachInDepthRange(s,r,ao.DepthOrder.BACK_TO_FRONT,Hs,(l,h)=>{T_(i,e,l),Hs.near=i.far,h.setRange(Hs)},a,n);else{const l=Math.max(Math.min(o,LN),Math.ceil(o*NN)),h=t.findClosest(r,ao.DepthOrder.FRONT_TO_BACK,a,n,l),d=t.findClosest(r,ao.DepthOrder.BACK_TO_FRONT,a,n,l);h&&d&&(yy(i,e,h.boundingVolumeWorldSpace.bounds),yy(i,e,d.boundingVolumeWorldSpace.bounds))}}function zN(i,e,t){Qo.clear(),t.forAll(s=>{s.visible&&s.geometries.length!==0&&Qo.add(s)}),Qo.empty||(Qo.sort(e),Du(Hs,e.near,Math.min(i.near,e.far)),Qo.forEachInDepthRange(Hs,ao.DepthOrder.FRONT_TO_BACK,(s,r)=>{r<i.near&&T_(i,e,s)}),Du(Hs,Math.max(i.far,e.near),e.far),Qo.forEachInDepthRange(Hs,ao.DepthOrder.BACK_TO_FRONT,(s,r,a)=>{i.far=Math.max(i.far,a)}))}function T_(i,e,t){if(!t.visible||!ju(e.frustum,t.boundingVolumeWorldSpace.bounds))return;const s=t.transformation,r=jN;t.geometries.forEach(a=>{Ks(r,s,a.transformation);const n=$m(r);Zx(i,e,a.boundingInfo,r,n)})}function Zx(i,e,t,s,r){if(t==null)return;Xt(qt(Wi),t.center,s);const{eye:a,viewForward:n}=e,o=n[0]*(Wi[0]-a[0])+n[1]*(Wi[1]-a[1])+n[2]*(Wi[2]-a[2]);if(Wi[3]=t.radius*r,!(o-Wi[3]>i.near&&o+Wi[3]<i.far)&&ju(e.frustum,Wi))if(t.radius>C_&&t.getChildren())for(const l of t.getChildren())Zx(i,e,l,s,r);else S_.unionDepthRangeWithAABB(i,e.viewProjectionMatrix,s,t.bbMin,t.bbMax)}function yy(i,e,t){const s=e.eye,r=e.viewForward,a=(t[0]-s[0])*r[0]+(t[1]-s[1])*r[1]+(t[2]-s[2])*r[2];i.near=Math.min(i.near,a-t[3]),i.far=Math.max(i.far,a+t[3])}let BN=class{constructor(){this._items=new Gt({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,s=e.viewForward;this._items.forAll(r=>{const a=r.object.boundingVolumeWorldSpace.bounds,n=(a[0]-t[0])*s[0]+(a[1]-t[1])*s[1]+(a[2]-t[2])*s[2];r.distance=n,r.near=n-a[3],r.far=n+a[3]}),this._items.sort((r,a)=>r.distance-a.distance)}forEachInDepthRange(e,t,s){if(t===ao.DepthOrder.FRONT_TO_BACK)for(let r=0;r<this._items.length;++r){const a=this._items.data[r];a.far<e.near||a.near>e.far||s(a.object,a.near,a.far)}else for(let r=this._items.length-1;r>=0;--r){const a=this._items.data[r];a.far<e.near||a.near>e.far||s(a.object,a.near,a.far)}}},HN=class{constructor(){this._view=Qe(),this._viewProj=Qe(),this._frustum=mu(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,t){this._reset(),pc(this._view,e.viewMatrix),Ks(this._viewProj,e.projectionMatrix,this._view),qm(this._frustum,e.frustum);const s=this._view,r=s[2],a=s[6],n=s[10],o=s[14];t.forAll(m=>{m.materialReference&&m.forEachGeometry&&m.forEachGeometry(_=>{if(!_.visible||!_.castShadow)return;const f=_.boundingSphere,g=r*f[0]+a*f[1]+n*f[2]+o,y=g-f[3],w=g+f[3];this._geometries.push(_),this._near.push(-w),this._far.push(-y)})});const l=new Vg;if(this._geometries.length===0)return l;for(let m=0;m<this._geometries.length;++m)this._near[m]>l.far&&(l.far=this._near[m]),this._near[m]>2&&this._far[m]<l.near&&(l.near=this._far[m]);const h=this._looseRange;h.near=Math.max(.5*l.near,2),h.far=2*l.far;let d=0,u=0;for(let m=0;m<this._geometries.length;++m)this._near[m]<l.near&&(this._near[m]>=h.near?l.near=this._near[m]:this._nearCandidates[d++]=m),this._far[m]>l.far&&(this._far[m]<=h.far?l.far=this._far[m]:this._farCandidates[u++]=m);if(this._nearCandidates.length===0&&this._farCandidates.length===0)return l;this._nearCandidates.sort((m,_)=>this._near[m]<this._near[_]?-1:this._near[m]>this._near[_]?1:0),this._farCandidates.sort((m,_)=>this._far[m]<this._far[_]?1:this._far[m]>this._far[_]?-1:0);for(let m=0;m<this._nearCandidates.length;++m){const _=this._nearCandidates[m];if(this._near[_]<l.near){const f=this._geometries[_],g=f.boundingInfo;this._includeNearBoundingInfoRec(g,f.shaderTransformation,l)}}for(let m=0;m<this._farCandidates.length;++m){const _=this._farCandidates[m];if(this._far[_]>l.far){const f=this._geometries[_],g=f.boundingInfo;this._includeFarBoundingInfoRec(g,f.shaderTransformation,l)}}return this._reset(),l}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,t,s){if(e==null)return;const r=e.center;Xt(qt(Wi),r,t);const a=$m(t),n=Wi[0],o=Wi[1],l=Wi[2],h=e.radius*a,d=this._frustum;if(d[0][0]*n+d[0][1]*o+d[0][2]*l+d[0][3]>h||d[1][0]*n+d[1][1]*o+d[1][2]*l+d[1][3]>h||d[2][0]*n+d[2][1]*o+d[2][2]*l+d[2][3]>h||d[3][0]*n+d[3][1]*o+d[3][2]*l+d[3][3]>h)return;const u=this._view[2]*n+this._view[6]*o+this._view[10]*l+this._view[14],m=u+h;if(!(-(u-h)<2||-m>=s.near))if(-m>this._looseRange.near)s.near=-m;else{if(h>C_){const _=e.getChildren();if(_!==void 0){for(const f of _)this._includeNearBoundingInfoRec(f,t,s);return}}S_.unionDepthRangeWithAABB(s,this._viewProj,t,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,t,s){if(e==null)return;let r=e.radius;const a=e.center;Xt(qt(Wi),a,t);const n=$m(t),o=Wi[0],l=Wi[1],h=Wi[2];r*=n;const d=this._frustum;if(d[0][0]*o+d[0][1]*l+d[0][2]*h+d[0][3]>r||d[1][0]*o+d[1][1]*l+d[1][2]*h+d[1][3]>r||d[2][0]*o+d[2][1]*l+d[2][2]*h+d[2][3]>r||d[3][0]*o+d[3][1]*l+d[3][2]*h+d[3][3]>r)return;const u=this._view[2]*o+this._view[6]*l+this._view[10]*h+this._view[14]-r;if(!(-u<=s.far))if(-u<this._looseRange.far)s.far=-u;else{if(r>C_){const m=e.getChildren();if(m!==void 0){for(const _ of m)this._includeFarBoundingInfoRec(_,t,s);return}}S_.unionDepthRangeWithAABB(s,this._viewProj,t,e.bbMin,e.bbMax)}}},GN=class{constructor(){this._modelViewProj=Qe(),this._clipPosition=[mi(),mi(),mi(),mi(),mi(),mi(),mi(),mi()]}unionDepthRangeWithAABB(e,t,s,r,a){const n=this._modelViewProj;Ks(n,t,s);let o=!1;for(let l=0;l<8;++l){const h=this._clipPosition[l],d=l===0||l===3||l===4||l===7?r[0]:a[0],u=l===0||l===1||l===4||l===5?r[1]:a[1],m=l<4?r[2]:a[2];h[0]=n[0]*d+n[4]*u+n[8]*m+n[12],h[1]=n[1]*d+n[5]*u+n[9]*m+n[13],h[2]=n[2]*d+n[6]*u+n[10]*m+n[14],h[3]=n[3]*d+n[7]*u+n[11]*m+n[15]}for(let l=0;l<12;++l){const h=kN(this._clipPosition[dm[l][0]],this._clipPosition[dm[l][1]],this._clipPosition[dm[l][2]]);let d=!0;for(let u=0;u<h.length;++u)if(h[u][3]>=2){d=!1;break}if(!d){o=!0;for(let u=0;u<h.length;++u){const m=h[u][3];Number.isFinite(m)&&(e.near=Math.min(m,e.near),e.far=Math.max(m,e.far))}}}return o}};function kN(i,e,t){let s=[i,e,t];for(let r=0;r<4;++r){const a=s;s=[];for(let n=0;n<a.length;++n){const o=a[n],l=a[(n+1)%a.length];cm(l,r)?(cm(o,r)||s.push(by(o,l,r)),s.push(l)):cm(o,r)&&s.push(by(o,l,r))}}return s}function cm(i,e){return e===0?i[0]>=-i[3]:e===1?i[1]>=-i[3]:e===2?i[0]<=i[3]:e===3?i[1]<=i[3]:void Cs(!1)}function by(i,e,t){let s=0;return t===0?s=(-i[3]-i[0])/(e[0]-i[0]+e[3]-i[3]):t===1?s=(-i[3]-i[1])/(e[1]-i[1]+e[3]-i[3]):t===2?s=(i[3]-i[0])/(e[0]-i[0]-e[3]+i[3]):t===3&&(s=(i[3]-i[1])/(e[1]-i[1]-e[3]+i[3])),VS(mi(),i,e,s)}const dm=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],Wi=Sr(),jN=Qe(),Hs=yc(),Qo=new BN,WN=new HN,S_=new GN;let QN=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new vu(new ArrayBuffer(4)),this._layerToOidToColor=new zm,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new zm,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,s,r,a,n=null,o=null,l=null){e&&t&&s&&r&&(this._layerUidToId.set(r,s),this._layerUidToPopupEnabled.set(r,a),a&&this._layerUidToGraphicsUidToObjectId.set(r,t,{objectId:e,attributeNodeId:n,attributeIndex:o,subLayerId:l}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return er(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){var n;if(!e.layerUid||!e.graphicUid)return this.colorZero;const t=this._layerUidToPopupEnabled.get(e.layerUid);if(t===void 0)return this.colorZero;if(t===!1)return this.colorZero;const s=(n=this._layerUidToGraphicsUidToObjectId.get(e.layerUid,e.graphicUid))==null?void 0:n.objectId;if(!s)return this.colorZero;let r=this._layerToOidToColor.get(e.layerUid,s);if(!r){for(;!r;){const o=Math.floor(16777214*Math.random())+1;this._colorToUID.has(o)||(r=o)}if(r>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerUid,s,r),this._colorToUID.set(r,e)}const a=new ArrayBuffer(4);return new DataView(a).setUint32(0,r,!1),new vu(a)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,s]of this._colorToUID.entries()){const r=this._layerUidToGraphicsUidToObjectId.get(s.layerUid,s.graphicUid),a=this._layerUidToId.get(s.layerUid);r&&a&&e.set(t,r.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:r.objectId,lid:a,attrId:r.attributeNodeId,attrIdx:r.attributeIndex,subLayerId:r.subLayerId}:{type:"object-and-layer-id",oid:r.objectId,lid:a})}return e}};var rn,oo;(function(i){i.OPAQUE="opaque-color",i.TRANSPARENT="transparent-color",i.COMPOSITE="composite-color",i.FINAL="final-color"})(rn||(rn={})),function(i){i.ANTIALIASING="aa-color",i.HIGHLIGHTS="highlight-color",i.MAGNIFIER="magnifier-color"}(oo||(oo={}));let Kx=class{constructor(e,t){this.key=e,this.free=t,this.incarnation=0,this._refCount=1}retain(e=1){this._refCount+=e}release(){return this._refCount===0?(console.log(`Releasing already released FBO attachment in ${new Error().stack}`),!0):(--this._refCount,this._refCount===0&&(this.free(),!0))}};var Rl;(function(i){i[i.FBO=0]="FBO",i[i.DEPTH=1]="DEPTH",i[i.COLOR=2]="COLOR"})(Rl||(Rl={}));let Jx=class extends Kx{constructor(e,t,s){super(e,s),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get usedMemory(){return this.attachment.usedMemory}},XN=class extends Jx{constructor(e,t,s){super(e,t,s),this.attachment=t,this.type=Rl.COLOR}},wy=class extends Jx{constructor(){super(...arguments),this.type=Rl.DEPTH}};function YN(i){return(i==null?void 0:i.attachment.type)===XP.Texture}let eC=class extends Kx{constructor(e,t,s,r,a,n){super(e,n),this.type=Rl.FBO,this._colors=new Map,this._name="composite-color",this.acquireDepth=null,this.acquireColor=null,this._name=t,this.fbo=s,this.acquireDepth=r,this.acquireColor=a}dispose(){var e;(e=this.fbo)==null||e.dispose()}get usedMemory(){var e;return((e=this.fbo)==null?void 0:e.usedMemory)||0}get name(){return this._name}setName(e){this._name=e}getTexture(e=Wh.COLOR_ATTACHMENT0){var t,s;return e===Nm?(t=this.fbo)==null?void 0:t.depthStencilTexture:(s=this.fbo)==null?void 0:s.getColorTexture(e)}getAttachment(e=Wh.COLOR_ATTACHMENT0){return e===Nm?this._depth:this._colors.get(e)}attachDepth(e){var t;return e==null||e.retain(),this.detachDepth(),e&&((t=this.fbo)==null||t.attachDepthStencil(e.attachment)),this._depth=e,this}detachDepth(){var e,t;(e=this.fbo)==null||e.detachDepthStencilTexture(),(t=this.fbo)==null||t.detachDepthStencilBuffer(),this._depth=tt(this._depth)}obtainDepthTexture(){var t;const e=this._depth;return YN(e)?((t=this.fbo)==null||t.detachDepthStencilTexture(),this._depth=null,e):null}attachColor(e,t){var s;return e.retain(),this.detachColor(t),(s=this.fbo)==null||s.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){var s;(s=this.fbo)==null||s.detachColorTexture(e);const t=this._colors.get(e);this._colors.delete(e),t==null||t.release()}detachAll(){this._colors.forEach((e,t)=>this.detachColor(t)),this.detachDepth()}},um=class{constructor(e,t){this._last=new Gt,this._incarnation=0,this._cache=new Bu(e,t)}destroy(){var e;(e=this._last)==null||e.forAll(t=>t.dispose()),this._last=null,this._cache.destroy()}set interactive(e){var t;e&&!this._last?this._last=new Gt:e||((t=this._last)==null||t.forAll(s=>s.dispose()),this._last=null)}clean(){var e;(e=this._last)==null||e.filterInPlace(t=>!(t.incarnation<this._incarnation)||(this._cache.put(t.key,t),!1))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find(s=>s.key===e);if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){var e;return((e=this._last)==null?void 0:e.reduce((t,s)=>t+s.usedMemory,0))??0}},ZN=class{constructor(e){this.rctx=e,this._acquired=new Set,this._cache=new um(e.newCache,"FBOCache"),this._depthCache=new um(e.newCache,"DepthAttachmentCache"),this._colorCache=new um(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback&&this.debugCallback()}frameEnd(){const e=this.debugCallback;e&&this._acquired.forEach(t=>t.type===Rl.FBO&&e(t.name,t.fbo))}get usedMemory(){return Array.from(this._acquired.values()).reduce((e,t)=>{var s;return e+("getTexture"in t?((s=t.getTexture())==null?void 0:s.usedMemory)??0:t.usedMemory)},this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e}acquire(e,t,s,r=ni.RGBA){const a=pm(r,e,t);let n=this._cache.pop(a);if(n){n.retain(),n.setName(s);const o=this.rctx.getBoundFramebufferObject();this.rctx.bindFramebuffer(n.fbo),this.rctx.setDrawBuffers([Wh.COLOR_ATTACHMENT0]),this.rctx.bindFramebuffer(o)}else n=new eC(a,s,new mc(this.rctx,{...xy[r],width:e,height:t}),o=>{o??(o=Vi.DEPTH_STENCIL_TEXTURE);const l=this._acquireDepth(o,n.fbo.width,n.fbo.height,`${n.name} depth`);return n.attachDepth(l),l.release(),n},(o,l)=>{l??(l=ni.RGBA);const h=this._acquireColor(l,e,t,`${n.name} color ${o}`);return n.attachColor(h,o),h.release(),n},()=>{this.debugCallback&&this.debugCallback(n.name,n.fbo),this._acquired.delete(n),n.detachAll(),this._cache.put(n)});return this._trackHandle(n)}acquireDepth(e,t,s,r){return this._acquireDepth(e,t,s,r)}_acquireDepth(e,t,s,r){const a=pm(e,t,s),n=this._depthCache.pop(a);if(n)return n.retain(),n.name=r,this._trackHandle(n);const o=e===Vi.DEPTH_STENCIL_TEXTURE?new wy(a,new Yi(this.rctx,{...Cy[e],width:t,height:s}),()=>{this._acquired.delete(o),this._depthCache.put(o)}):new wy(a,new o2(this.rctx,{...Cy[e],width:t,height:s}),()=>{this._acquired.delete(o),this._depthCache.put(o)});return o.name=r,this._trackHandle(o)}_acquireColor(e,t,s,r){const a=pm(e,t,s),n=this._colorCache.pop(a);if(n)return n.retain(),n.name=r,this._trackHandle(n);const o=new XN(a,new Yi(this.rctx,{...xy[e],width:t,height:s}),()=>{this._acquired.delete(o),this._colorCache.put(o)});return o.name=r,this._trackHandle(o)}_trackHandle(e){return this._acquired.add(e),e}};const lc=new eC("default","default",null,()=>lc,()=>lc,()=>{});function pm(i,e,t){return`${i}x${e}x${t}`}const Hd=new gi;Hd.pixelFormat=_i.RED,Hd.internalFormat=Ol.R8,Hd.wrapMode=Ki.CLAMP_TO_EDGE;const Gd=new gi;Gd.pixelFormat=_i.RG,Gd.internalFormat=Ol.RG8,Gd.wrapMode=Ki.CLAMP_TO_EDGE;const kd=new gi;kd.internalFormat=Ol.RGBA4,kd.dataType=go.UNSIGNED_SHORT_4_4_4_4,kd.wrapMode=Ki.CLAMP_TO_EDGE;const tC=new gi;tC.wrapMode=Ki.CLAMP_TO_EDGE;const vh=new gi;vh.wrapMode=Ki.CLAMP_TO_EDGE,vh.samplingMode=Zs.LINEAR_MIPMAP_LINEAR,vh.hasMipmap=!0,vh.maxAnisotropy=8;const yh=new gi;yh.pixelFormat=_i.RED,yh.dataType=go.HALF_FLOAT,yh.internalFormat=Ol.R16F,yh.samplingMode=Zs.NEAREST;const jd=new gi;jd.dataType=go.HALF_FLOAT,jd.internalFormat=Ol.RGBA16F,jd.samplingMode=Zs.NEAREST;const xy={[ni.RED]:Hd,[ni.RG]:Gd,[ni.RGBA4]:kd,[ni.RGBA]:tC,[ni.RGBA_MIPMAP]:vh,[ni.R16F]:yh,[ni.RGBA16F]:jd},bh=new gi;bh.pixelFormat=_i.DEPTH_STENCIL,bh.dataType=go.UNSIGNED_INT_24_8,bh.samplingMode=Zs.NEAREST,bh.wrapMode=Ki.CLAMP_TO_EDGE;const Cy={[Vi.DEPTH_STENCIL_TEXTURE]:bh,[Vi.DEPTH16_BUFFER]:new z1(E1.DEPTH_COMPONENT16,4)};var hc;(function(i){i[i.FrontToBack=0]="FrontToBack",i[i.BackToFront=1]="BackToFront"})(hc||(hc={}));class da{constructor(e,t,s=hc.FrontToBack){this._rctx=e,this._techniques=t,this._sorting=s,this._draws=new Gt({initialSize:32,allocator:r=>r||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,s,r){const a=this._draws.pushNew();a.geometry=t,a.geometryRanges=s,a.material=e,a.depthSquaredHint=r,a.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0}prepare(e,t){return this._draws.map(s=>s.material.prepareTechnique(this._techniques,e,t,s.geometry.parameters))}dispatch(e,t,s){const r=this._rctx;this._previouslyBoundDraw.clear();let a=null;const n=this._draws.length;for(let o=0;o<n;o++){const l=s[o];l===a&&l.configuration.transparencyPassType===wi.NONE||(r.bindTechnique(l,t,e),a=l);const h=this._draws.data[o],d=h.geometry;r.bindVAO(d.vao),this._previouslyBoundDraw.get(l)!==h.material&&(l.program.bindDraw(h.material,t,e),this._previouslyBoundDraw.set(l,h.material));const u=h.geometryRanges,m=u.length;if(h.indexType!==0){const _=Wd.get(h.indexType);for(let f=0;f<m;f+=2){const g=u[f],y=u[f+1];r.drawElements(d.primitiveType,y,h.indexType,g*_)}}else for(let _=0;_<m;_+=2){const f=u[_],g=u[_+1];r.drawArrays(d.primitiveType,f,g)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===hc.FrontToBack?1:-1;this._draws.sort((t,s)=>{const r=e*(t.depthSquaredHint-s.depthSquaredHint);return r!==0?r:t.geometry.vao.byteSize-s.geometry.vao.byteSize})}get count(){return this._draws.length}}const Wd=new Map;Wd.set(Da.UNSIGNED_BYTE,1),Wd.set(Da.UNSIGNED_SHORT,2),Wd.set(Da.UNSIGNED_INT,4);let P_=class extends AP{constructor(){super({}),this._passes=null,this.produces=new Map([[j.OPAQUE_MATERIAL,e=>this._produces(e)],[j.TRANSPARENT_MATERIAL,e=>!!(this._passes&&this._passes.materialTransparent.count>0)&&this._produces(e)],[j.INTEGRATED_MESH,e=>this._produces(e)]]),this._materialPassParameters=new DP,this._shadowPassParameters=new $P,this._highlightPassParameters=new IP,this._viewshedPassParameters=new LP,this._systems=new Set}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx,s=e.techniques;this._passes={materialOpaque:new da(t,s),materialTransparent:new da(t,s,hc.BackToFront),materialIntegratedMesh:new da(t,s),shadowMap:new da(t,s),highlight:new da(t,s),highlightIntegratedMesh:new da(t,s),highlightShadowMap:new da(t,s),viewshedShadowMap:new da(t,s),defaultShadowMap:new da(t,s)}}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e){return this._systems.size!==0&&this._passes!==null&&(e===E.Highlight?this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0:e!==E.ShadowHighlight||this._passes.highlight.count>0)}prepareRender(e){if(this._systems.size!==0&&this._passes!==null){for(const t of Object.values(this._passes))t.prepareSubmit();this._systems.forEach(t=>t.submit(this._passes,e.bindParameters));for(const t of Object.values(this._passes))t.finishSubmit();this._context.techniques.frameUpdate()}}prepareTechniques(e){if(this._systems.size===0)return null;const t=e.output===E.Shadow||e.output===E.ShadowHighlight||e.output===E.ShadowExcludeHighlight?this._shadowPassParameters:e.output===E.ViewshedShadow?this._viewshedPassParameters:e.output===E.Highlight?this._highlightPassParameters:this._materialPassParameters,s=e.bindParameters;return this._updateParameters(s.camera,t,s.slot===j.TRANSPARENT_MATERIAL),this._materialPassParameters.output=e.output,this._invoke(e,(r,a)=>r.prepare(a,e.bindParameters))}renderNode(e,t){this._invoke(e,(s,r)=>s.dispatch(r,e.bindParameters,t))}_invoke(e,t){if(this._passes===null)return null;switch(e.bindParameters.slot){case j.OPAQUE_MATERIAL:switch(e.output){case E.Color:case E.Depth:case E.Normal:case E.ObjectAndLayerIdColor:return t(this._passes.materialOpaque,this._materialPassParameters);case E.Highlight:return t(this._passes.highlight,this._highlightPassParameters);case E.Shadow:return t(this._passes.shadowMap,this._shadowPassParameters);case E.ShadowHighlight:return t(this._passes.highlightShadowMap,this._shadowPassParameters);case E.ShadowExcludeHighlight:return t(this._passes.defaultShadowMap,this._shadowPassParameters);case E.ViewshedShadow:return t(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case j.TRANSPARENT_MATERIAL:switch(e.output){case E.Color:case E.Depth:case E.Normal:case E.ObjectAndLayerIdColor:return t(this._passes.materialTransparent,this._materialPassParameters)}break;case j.INTEGRATED_MESH:switch(e.output){case E.Color:case E.Depth:case E.Normal:case E.ObjectAndLayerIdColor:return t(this._passes.materialIntegratedMesh,this._materialPassParameters);case E.Highlight:return t(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new Vg;return this._systems.forEach(s=>Pl(t,s.queryShadowCasterDepthRange(e))),t}_updateParameters(e,t,s){const r=e.viewInverseTransposeMatrix;it(mm,r[3],r[7],r[11]),_m.set(mm),le(t.transformWorldFromViewTH,_m.high),le(t.transformWorldFromViewTL,_m.low),le(t.slicePlaneLocalOrigin,mm),L1(t.transformViewFromCameraRelativeRS,e.viewMatrix),pc(t.transformProjFromView,e.projectionMatrix),t.identifier===Bn.Material&&(this._materialPassParameters.transparent=s,Hu(Ty,t.transformViewFromCameraRelativeRS),X_(t.transformNormalViewFromGlobal,Ty))}};P_=c([F("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],P_);const mm=b(),Ty=La(),_m=new fx;function md(i){return i.name}let KN=class{constructor(e){this._context=e,this._nodes=new Gt}destroy(){this._nodes.forEach(e=>e.destroy()),this._nodes.clear()}add(e){this._nodes.push(e),zf&&console.log(`Registered render nodes: ${this._nodes.map(({declaredClass:t})=>t).join(", ")}`)}remove(e){this._nodes.remove(e),zf&&console.log(`Registered render nodes: ${this._nodes.map(({declaredClass:t})=>t).join(", ")}`)}produces(e){return this._nodes.some(({produces:t})=>t===e)}require(e,...t){const s=this._nodes;return t.reduce((r,a)=>r+s.reduce((n,{consumes:o,produces:l})=>n+(o.required.includes(e)&&l===a?1:0),0),0)}optional(e,...t){const s=this._nodes;return t.reduce((r,a)=>r+s.reduce((n,{consumes:o,produces:l})=>{var h;return n+((h=o.optional)!=null&&h.includes(e)&&l===a?1:0)},0),0)}updateAnimation(){return this._nodes.reduce((e,t)=>t.updateAnimation()||e,!1)}render(e,t,s=()=>{}){const r=md(e)?e.name:e,a=this._nodes.filter(({produces:n})=>n===r);return a.length===0||(a.forEach(n=>{const o=md(e)?[e]:[];for(const l of n.consumes.required){if(l===r)continue;const h=t.get(l);if(!h)return void(s&&s(o));o.push(h)}if(n.consumes.optional)for(const l of n.consumes.optional){if(l===r)continue;const h=t.get(l);h&&o.push(h)}try{const l=n.doRender(o,this._context);l&&l!==e&&(md(e)?(e.release(),e=l,t.set(r,e)):e=l)}catch(l){Pe.getLogger(n).errorOnce(l)}s&&s(o)}),this._context.rctx.enforceState()),md(e)?e:lc}},JN=class{constructor(e){this._context=e,this._renderPlugins=new Gt,this._materialRenderers=new Map,this._slots=new Array,this._renderVersion=Sh(0);for(let t=0;t<j.MAX_SLOTS;++t)this._slots[t]=[]}destroy(){this._renderPlugins.forEach(e=>e.destroy()),this._renderPlugins.clear(),this._materialRenderers.clear()}get plugins(){return this._renderPlugins}add(e,t){const s=()=>{if(t!=null&&t.aborted)throw e.uninitializeRenderContext(),vr();this._renderPlugins.push(e),e.materialReference&&this._materialRenderers.set(e.materialReference,e),e.produces.forEach((a,n)=>{this._slots[n].push(e)}),this._context.requestRender(),this._renderVersion.value++},r=e.initializeRenderContext(this._context,t);if(M_(r))return r.then(s);s()}remove(e){if(e.materialReference!=null&&this._materialRenderers.delete(e.materialReference),this._renderPlugins.removeUnordered(e)!=null){for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter(s=>s!==e);e.uninitializeRenderContext(),this._context.requestRender(),this._renderVersion.value++}}prepareRender(){this._renderPlugins.forAll(e=>{e.prepareRender&&e.prepareRender(this._context.renderContext)})}updateAnimation(e){let t=!1;return this._renderPlugins.forAll(s=>{s.updateAnimation&&(t=s.updateAnimation(e)||t)}),t}renderFeatureChanged(){this._renderPlugins.forAll(e=>{e.renderFeatureChanged&&e.renderFeatureChanged()})}prepare(...e){for(const t of e)this._context.renderContext.bindParameters.slot=t,this._slots[t].forEach(s=>{const r=s.produces.get(t);r!=null&&r(E.Color)&&(Vm(s)&&s.prepareTechnique(this._context.renderContext),Uf(s)&&s.prepareTechniques(this._context.renderContext))})}_getRenderables(){const e=this._context.renderContext.bindParameters.slot,t=this._context.renderContext.output??E.Color,s=new Map;return this._slots[e].forEach(r=>{const a=r.produces.get(e);if(a!=null&&a(t)&&(!r.isDecoration||this._context.renderContext.bindParameters.decorations!==Ws.OFF))if(Vm(r)){const n=r.prepareTechnique(this._context.renderContext);n!=null&&s.set(r,n)}else if(Uf(r)){const n=r.prepareTechniques(this._context.renderContext);n!=null&&s.set(r,n)}else s.set(r,null)}),s}render(e,...t){for(const s of t)this._context.renderContext.bindParameters.slot=s,this._getRenderables().forEach((r,a)=>a.renderNode(this._context.renderContext,r,e))}queryDepthRange(e){const t=new Vg;return this._renderPlugins.forAll(s=>{var a;const r=(a=s.queryDepthRange)==null?void 0:a.call(s,e);Pl(t,r)}),t}get updating(){return this._renderVersion.value>=0&&this._renderPlugins.some(e=>e.running)}produces(e,...t){for(const s of t)if(this._slots[s].some(r=>{const a=r.produces.get(s);return!!a&&a(e)}))return!0;return!1}consumes(e){return this._renderPlugins.some(t=>t.consumes().required.includes(e))}getMaterialRenderer(e){return this._materialRenderers.get(e)}removeEmptyMaterialRenderers(){this._renderPlugins.filterInPlace(e=>!e.materialReference||e.numGeometries!==0||(this._materialRenderers.delete(e.materialReference),e.destroy(),!1))}get hasDecorations(){return this._renderPlugins.some(e=>e.isDecoration)}get hasOccludees(){return this._renderPlugins.some(e=>e.hasOccludees)}get renderOccludedFlags(){return this._renderPlugins.reduce((e,t)=>e|t.renderOccludedFlags,yi.None)}get usedMemory(){return this._renderPlugins.reduce((e,t)=>t.materialReference!==null?e:e+(t.usedMemory??0),0)}get test(){}},e5=class{constructor(e){this.techniques=e,this._blitConfiguration=new Nh,this._blitParameters=new ep}render(e,t,s,r,a){e.bindFramebuffer(s.fbo);const n=this.techniques.acquire(kg,this._blitConfiguration);return e.setClearColor(0,0,0,1),e.clear(Mi.COLOR_BUFFER_BIT),n!=null&&n.compiled?(this._blitParameters.texture=t.getTexture(),e.bindTechnique(n,r,this._blitParameters),e.screen.draw(),n.release(),s):(a(st.UPDATE),s)}},t5=class{constructor(){this._step=Ry,this._dilation=1,this._firstIdleTime=ct(0)}frame(e,t){if(t?this._firstIdleTime===0&&(this._firstIdleTime=ct(performance.now())):this._firstIdleTime=ct(0),li("disable-feature:high-quality-idle"))this._dilation=1;else{const r=t?performance.now()-this._firstIdleTime:0;if(r>=Sy+s5)return this._step=ct(1/0),void(this._dilation=1);this._dilation=r>=Sy?r5:1}const s=Z(e/i5,Ry,n5);this._step===1/0?this._step=ct(s):this._step=ct(this._step*Py+s*(1-Py))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=ct(0)}};const i5=.5,Sy=ct(12e4),s5=ct(1e4),r5=10,Py=.9,a5=30,Ry=ct(1e3/1),n5=ct(1e3/a5);let o5=class{constructor(e,t){this._fbos=e,this.compositingHelper=t,this._width=4,this._height=4,this._clearColor=mi()}dispose(){this._color=tt(this._color),this.releaseBuffers()}get framebuffer(){return this.color.attachDepth(this.depth),this.color.fbo}get colorTexture(){return this.color.getTexture()}get depthTexture(){return this.depth.attachment}initializeFrame(e,t,s){this._fbos.interactive=s===wa.Default;const r=this._fbos.rctx;this._width=e.fullWidth,this._height=e.fullHeight,Y_(this,r.parameters.maxTextureSize);const a=this._color;return this._color=null,this.releaseBuffers(),F_(this._clearColor,t),a}releaseBuffers(){var e;(e=this._color)==null||e.detachDepth(),this._depth=tt(this._depth)}renderHUDVisibility(e,t,s){var r,a;return((r=e==null?void 0:e.fbo)==null?void 0:r.width)===this._width&&((a=e==null?void 0:e.fbo)==null?void 0:a.height)===this._height||(e==null||e.release(),e=this._fbos.acquire(this._width,this._height,"hud visibility",ni.RGBA4)),e.attachDepth(s||this.depth),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(l5),t(),e.detachDepth(),e}compositeToHUDVisibility(e,t){var s;this._fbos.rctx.bindFramebuffer((s=e.hudVisibility)==null?void 0:s.fbo),this.compositingHelper.compositeHUD(e,t)}renderOITPass(e,t,s){let r,a;const{_width:n,_height:o}=this;switch(t){case wi.ColorAlpha:r=this._fbos.acquire(n,o,s?"oit hud color alpha":"oit color alpha",ni.RGBA16F),r.acquireColor(Wh.COLOR_ATTACHMENT1,ni.R16F),a=[0,0,0,1];break;case wi.FrontFace:r=this._fbos.acquire(n,o,s?"oit hud front":"oit front"),a=[0,0,0,0]}return s?r.acquireDepth(Vi.DEPTH16_BUFFER):r.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(r.fbo),this._fbos.rctx.clearFramebuffer(a,s,s),e(),r.detachDepth(),r}compositeToFramebuffer(e,t,s,r){this.bindFbo(),this.compositingHelper.composite(e,t,s,r)}compositeOIT(e,t,s,r){r?(this._fbos.rctx.bindFramebuffer(r.fbo),this._fbos.rctx.setClearColor(0,0,0,1e-13),this._fbos.rctx.clear(Mi.COLOR_BUFFER_BIT)):this.bindFbo(),this.compositingHelper.compositeOIT(e,t.getTexture(),t.getTexture(Wh.COLOR_ATTACHMENT1),s.getTexture())}renderDepthDetached(e){this._bindTarget(this.color),e(),this._bindTarget(this.color,this.depth)}renderToCachedFBO(e,t,s,r,a=ni.RGBA,n=Vi.DEPTH16_BUFFER,o=this._width,l=this._height,h=null){var d,u;return((d=e==null?void 0:e.fbo)==null?void 0:d.width)===o&&((u=e==null?void 0:e.fbo)==null?void 0:u.height)===l||(e=tt(e)),e=e??this._fbos.acquire(o,l,t,a),h==null||h.forEach(m=>e.acquireColor(m.attachment,m.format)),n!=null&&e.acquireDepth(n),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(r,!0,!0),s(),e}renderToTargets(e,t,s,r,a=!1,n=!1){this._bindTarget(t,s),this._fbos.rctx.clearFramebuffer(r,a,n),e(),t.detachDepth()}bindFbo(){const e=this._color==null;if(this._bindTarget(this.color,this.depth),e){const t=this._fbos.rctx;t.setClearStencil(0),t.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),t.clear(Mi.COLOR_BUFFER_BIT|Mi.DEPTH_BUFFER_BIT|Mi.STENCIL_BUFFER_BIT)}}_bindTarget(e,t){e.attachDepth(t),this._fbos.rctx.bindFramebuffer(e.fbo)}get width(){return this._width}get height(){return this._height}get color(){return this._ensureColor()}_ensureColor(){return this._color||(this._color=this._fbos.acquire(this._width,this._height,"composite-color")),this._color}updateColor(e){const t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}get depth(){return this._depth||(this._depth=this._fbos.acquireDepth(Vi.DEPTH_STENCIL_TEXTURE,this._width,this._height,"depth")),this._depth}};const l5=[0,1,0,1];let h5=class{constructor(){this._inputs=new Map}set(e,t){this._inputs.set(e,t)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){var t;(t=this._inputs.get(e))!=null&&t.release()&&this._inputs.delete(e)}};const bc=255,c5=1/bc;function iC(i){const e=new Dt,t=e.fragment;return t.include(_c),t.include(uc),e.include(zu),e.include(Ps),e.include(tg,i),t.uniforms.add(new Fe("shadowMap",(s,r)=>r.shadowMap.depthTexture),new Fe("depthMap",(s,r)=>{var a;return(a=r.depth)==null?void 0:a.attachment}),new Ji("inverseViewMatrix",(s,r)=>cu(Oy,fo(Oy,r.camera.viewMatrix,r.camera.center)))),t.constants.add("sampleValue","float",c5),e.outputs.add("sampleCount","float"),t.code.add(v`void main(void) {
float depth = depthFromTexture(depthMap, uv);
if (depth >= 1.0 || depth <= 0.0) {
discard;
}
float currentPixelDepth = linearizeDepth(depth);
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
ivec2 texSize = textureSize(shadowMap, 0);
ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));
float depthShadow = readShadowMapDepth(uvShadow, shadowMap);
bool shadow = depthShadow < lvpos.z;
if (!shadow) {
discard;
}
sampleCount = sampleValue;
}`),e}const Oy=Qe(),d5=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:bc,build:iC},Symbol.toStringTag,{value:"Module"}));let Xg=class extends ri{constructor(e){super(),this._data=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=y1(u5),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}};const u5=er(.01,0,.25,1);function sC(i){const e=new Dt,t=e.fragment;t.include(_c),t.include(z_),e.include(zu),e.include(Ps);const{visualization:s,bandsEnabled:r}=i;t.constants.add("inverseSampleValue","float",bc),t.uniforms.add(new Fe("shadowCastMap",o=>o.shadowCastMap),new He("sampleScale",o=>o.sampleScale),new He("opacityFromElevation",o=>o.opacityFromElevation),new cn("uColor",o=>o.color));const a=s===jf.Gradient,n=s===jf.Threshold;return a&&r?t.uniforms.add(new He("bandSize",o=>o.bandSize)):n&&t.uniforms.add(new He("threshold",o=>o.threshold)),t.code.add(v`
    void main(void) {
      float record = texture(shadowCastMap, uv).r;
      float pixelSamples = record * inverseSampleValue;
      if (pixelSamples < 1.0) {
        discard;
      }

      float strength = pixelSamples * sampleScale;

      ${n?v`
          if (strength <= threshold) {
            discard;
          }`:""}

      ${a&&r?v`strength = ceil(strength / bandSize) * bandSize;`:""}

      fragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${a?v`* strength`:""});
    }
  `),e}const p5=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:Xg,build:sC},Symbol.toStringTag,{value:"Module"}));let rC=class aC extends It{constructor(e,t){super(e,t,()=>this.destroy())}initializeProgram(e){return new Lt(e.rctx,aC.shader.get().build(this.configuration),pt)}initializePipeline(){return ot({blending:H_,colorWrite:ht,depthTest:null,depthWrite:null})}get primitiveType(){return Ai.TRIANGLE_STRIP}};rC.shader=new $t(p5,()=>ae(()=>Promise.resolve().then(()=>pF),void 0,import.meta.url));const m5=4e4,_5=5e4,nC=1/512;let Qd=class extends Re{constructor(e,t,s,r){super({}),this._techniques=e,this._rctx=t,this._data=s,this._requestRender=r,this._passParameters=new Xg(this._data),this._techniqueConfig=new p2,this._enabled=!1,this._vao=ra(t)}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=je(this._vao),this._techniques.release(this._technique),this._technique=null}get _visualizeShadowCastTechnique(){return this._technique=this._techniques.releaseAndAcquire(rC,this._techniqueConfig,this._technique),this._technique}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const t=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,e,this._passParameters),this._rctx.drawArrays(t.primitiveType,0,$a(this._vao,"geometry"))}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.color!==void 0&&this._setColor(e.color),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize),e.bandsEnabled!==void 0&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>nC}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniques.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniques.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const t=this._passParameters.color;US(e,t)||(F_(this._passParameters.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};c([p()],Qd.prototype,"opacityFromElevation",null),Qd=c([F("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],Qd);let oC=class lC extends It{constructor(e){super(e,new Hg,()=>this.destroy())}initializeProgram(e){return new Lt(e.rctx,lC.shader.get().build(this.configuration),pt)}initializePipeline(){return ot({blending:Ss(K.ONE,K.ONE,K.ONE,K.ONE),colorWrite:ht,depthTest:null,depthWrite:null})}get primitiveType(){return Ai.TRIANGLE_STRIP}};oC.shader=new $t(d5,()=>ae(()=>Promise.resolve().then(()=>mF),void 0,import.meta.url));let ss=class extends Re{constructor(e,t,s,r,a,n){super({}),this.fbos=e,this._stage=s,this._prepareForShadowMapPass=r,this._renderToShadowMap=a,this._requestRender=n,this._progress=0,this._sampleCount=0,this._passParameters=new eg,this._cachedLightDirections=[],this._depthRange=x_,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey="shadowAccumulator",this._rctx=e.rctx,this._bindParameters=new j_(new I1(e,s.viewingMode),null),this._bindParameters.shadowMap.enabled=!0,this._vao=ra(this._rctx),this._accumulationRenderer=new Qd(t,this._rctx,this,n);const o=this._stage.view.resourceController.scheduler;this.addHandles([o.registerTask(ci.SHADOW_ACCUMULATOR,this),M(()=>s.renderView,l=>{this.removeHandles(My),l!=null&&this.addHandles(l.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),My)},ut),M(()=>this._previewing,()=>this._requestRenderIfEnabled(),nt)],this._shadowAccumulatorKey)}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=je(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=je(this._fbo),this._vao=je(this._vao),this._accumulationTechniqueCached=tt(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}get computedSamples(){return this._progress}get shadowCastTexture(){var e;return(e=this._fbo)==null?void 0:e.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get _accumulationTechnique(){if(this._accumulationTechniqueCached==null){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new oC(e)}return this._accumulationTechniqueCached}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._fbo!=null&&this._sampleCount>0}get canAccumulate(){return this._bindParameters.depth!=null&&this._depthRange!==x_&&this._opacityFromElevation>nC}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if(By(t,e,Uh))return;const s=Math.min(bc,e.length);t.length=s,this._sampleCount=s;for(let r=0;r<s;++r)t[r]=le(t[r]??b(),e[r]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,t,s,r){if(this._depthRange=t,this._updateCamera(s),this._bindParameters.contentCamera=r,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return!1;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();const a=this._cameraForcedForScreenshot?this._sampleCount:Math.min(g5,this._sampleCount-this._progress);for(let n=0;n<a;++n)this._accumulateShadow();return this._cameraForcedForScreenshot=!1,this._requestRender(),a>0}render(e){this._accumulationRenderer.render(e)}setOptions(e){if(e.enabled!==void 0){const t=this._fbo!=null;e.enabled!==t&&(e.enabled?this._enable():this._disable())}e.previewing!==void 0&&(this._previewing=e.previewing),e.lightDirections!==void 0&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){return!this._isActive||!this._fbo||this._progress<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,_i.RGBA,go.UNSIGNED_BYTE,Ey),Ey[0]/this._progress)}_enable(){this._progress=0;const e=new gi;e.pixelFormat=_i.RED,e.internalFormat=Ol.R8,e.wrapMode=Ki.CLAMP_TO_EDGE,this._fbo=new mc(this._rctx,e),this._requestRender()}_disable(){this._fbo=je(this._fbo),this._requestRender()}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(Mi.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._lightDirections[this._progress++],this._depthRange);const e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,$a(this._vao,"geometry"))}_updateCamera(e){const t=this._fbo;if(t==null)return;const s=this._bindParameters.camera;e.equals(s)||s.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-Vh(m5,_5,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}};c([p()],ss.prototype,"_progress",void 0),c([p()],ss.prototype,"_sampleCount",void 0),c([p()],ss.prototype,"_fbo",void 0),c([p()],ss.prototype,"_depthRange",void 0),c([p()],ss.prototype,"_previewing",void 0),c([p()],ss.prototype,"_accumulationRenderer",void 0),c([p()],ss.prototype,"_isRefining",null),c([p()],ss.prototype,"_isActive",null),c([p()],ss.prototype,"canAccumulate",null),c([p()],ss.prototype,"_isDoneAccumulating",null),c([p()],ss.prototype,"_opacityFromElevation",null),c([p()],ss.prototype,"running",null),ss=c([F("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],ss);const g5=6,My="renderView",Ey=new Uint8Array(4),Ay=Fu();let f5=class{constructor(){this._plane=Fu()}get isEnabled(){return!xT(this.plane,Ay)}get plane(){return this._plane}set plane(e){A_(e||Ay,this._plane)}},Ja=class extends Ct{constructor(){super(...arguments),this.sectionAngles=mi()}get sectionAnglesDeg(){return Lf(this.sectionAngles.map(e=>Zd(e)))}set sectionAnglesDeg(e){this.sectionAngles=Lf(e.map(t=>Tt(t)))}get projectionMatrix(){const e=Qe();return du(e,this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],s=this.sectionAngles[2],r=this.sectionAngles[3];Cs(e<=t),Cs(s<=r);const a=2*Math.tan(this.fovX/2),n=2*Math.tan(this.fovY/2),o=Math.tan(e),l=Math.tan(t),h=Math.tan(s),d=l-o,u=Math.tan(r)-h,m=a/d,_=n/u,f=-(o+d/2)/a*2,g=-(h+u/2)/n*2,y=Qe();U1(y,[f,g,0]);const w=Qe();i2(w,[m,_,1]);const x=Qe();return du(x,w,y)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),s=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/s)}setViewport(e,t){const s=t*this._sectionRatioX;return this.viewport=[e[0],e[1],s,t],s}};c([p()],Ja.prototype,"sectionAngles",void 0),c([p()],Ja.prototype,"sectionAnglesDeg",null),c([p()],Ja.prototype,"projectionMatrix",null),c([p()],Ja.prototype,"sectionMatrix",null),c([p()],Ja.prototype,"_sectionRatioX",null),Ja=c([F("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Ja);let v5=class{constructor(){this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){return e?this.textureSizeModHighQuality:this.textureSizeModLowQuality}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}};const gm=["front","left","right","back","top","bottom"];function y5(i){return!["top","bottom"].includes(i)}class b5{constructor(e){this._fbos=e,this._enabled=!1,this._faces={},this._textureWidth=0,this._textureHeight=0,this.settings=new v5,this._maxTextureWidth=Math.min(li("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){var e;return(e=this._handle)==null?void 0:e.getTexture()}get enabled(){return this._enabled}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get isTextureZero(){return this._textureWidth===0||this._textureHeight===0}get nearFar(){const e=this.faces;return e.length===0?null:e[0].nearFar}get numActiveFaces(){const e=this._faces;let t=0;return Object.keys(e).forEach(s=>{e[s]&&(t+=1)}),t}get faces(){const e=this._faces,t=[];for(const s of gm){const r=e[s];r&&t.push(r)}return t}get atlasRegions(){return this.faces.map(e=>[e.x/this._textureWidth,(e.x+e.width)/this._textureWidth,e.y/this._textureHeight,(e.y+e.height)/this._textureHeight])}get viewshedProjectionMatrices(){return this.faces.map(e=>e.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(e=>e.viewMatrix)}_setupFaceCamera(e,t,s,r){const{observerRenderSpace:a,tiltedUpVector:n,targetRenderSpace:o,farDistanceRenderSpace:l,horizontalFieldOfView:h,verticalFieldOfView:d}=t,u=b();xt(u,o,a);const m=b(),_=b(),f=(L,G)=>{const H=b(),D=Qe();return bn(D,L,G),Xt(H,u,D),_e(H,a,H),H};let g,y=n;const w=Math.min(90,h),x=Math.min(90,Math.max(0,(h-90)/2));let T=-45,S=45,C=-45,P=45;if(y5(e)){const L=G=>Z(G,-45,45);C=L(-d/2)-this.settings.toleranceBottomTop,P=L(+d/2)+this.settings.toleranceBottomTop}switch(e){case"front":g=o,T=-w/2,S=w/2;break;case"left":g=f(Math.PI/2,n),T=45-x;break;case"right":g=f(-Math.PI/2,n),S=-45+x;break;case"top":g=_e(m,a,n),y=Xr(_,u);break;case"bottom":g=xt(m,a,n),y=u;break;case"back":g=f(Math.PI,n)}const R=new Ja({center:g,eye:a,up:y,far:l});R.sectionAnglesDeg=[T-this.settings.toleranceSides,S+this.settings.toleranceSides,C,P],R.fovY=Math.PI/2;const I=R.setViewport(s,r);return this._faces[e]=R,I}_bindFBO(){var t;const e=this._fbos.rctx;e.unbindTexture(this.depthTexture),e.bindFramebuffer((t=this._handle)==null?void 0:t.fbo)}_computeActiveFaces(e){const t=new Set,{horizontalFieldOfView:s,verticalFieldOfView:r}=e,a=-r/2,n=r/2;return s===0||r===0||(a<=45&&n>=-45&&t.add("front"),s>90&&(t.add("left"),t.add("right")),s>270&&t.add("back"),n>45-this.settings.toleranceBottomTop&&t.add("top"),a<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}_computeBaseTextureSize(e,t,s,r){const a=Math.min(window.devicePixelRatio,t)/e.pixelRatio,n=this.settings.textureSizeModifier(s),o=su(Math.floor(Math.max(e.fullWidth,e.fullHeight)*a*n)),l=Math.floor(this._maxTextureWidth/r),h=Math.min(l,o);return dP(h)}_ensureFBO(){var s,r,a,n,o;const e=this._textureWidth,t=this._textureHeight;((r=(s=this._handle)==null?void 0:s.fbo)==null?void 0:r.width)===e&&((n=(a=this._handle)==null?void 0:a.fbo)==null?void 0:n.height)===t||((o=this._handle)==null||o.release(),this._handle=this._fbos.acquire(e,t,"viewshed shadow map",ni.RGBA4)),this._handle.acquireDepth(Vi.DEPTH16_BUFFER)}clearFBO(){const e=this._fbos.rctx;this._ensureFBO(),this._bindFBO(),e.setClearColor(1,1,1,1),e.clear(Mi.COLOR_BUFFER_BIT|Mi.DEPTH_BUFFER_BIT)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._handle=tt(this._handle)}start(e,t,s,r){if(this._faces={},!this.enabled)return!1;const a=this._computeActiveFaces(t),n=a.size;if(n===0)return!1;const o=this._computeBaseTextureSize(e,r,s,n);if(o===0)return!1;let l=0,h=0,d=0;return gm.filter(u=>a.has(u)).forEach(u=>{const m=w5(u,n);m>h&&(d=Math.max(d,l),l=0),h=m;const _=m*o;l+=this._setupFaceCamera(u,t,[l,_],o)}),d=Math.max(d,l),this._textureWidth=this.settings.textureResizeModulo(d),this._textureHeight=x5(n)*o,this.clearFBO(),!0}finish(){var e;(e=this._handle)==null||e.detachDepth()}get test(){return{faces:this._faces,faceTypes:gm}}}function w5(i,e){if(e<4)return 0;const t=i==="front"||i==="left";return e===4?t?0:1:t||i==="right"?0:1}function x5(i){return i<4?1:2}let C5=class extends ri{constructor(){super(...arguments),this.localOrigin=jC()}};function T5(i){i.include(zu),i.fragment.uniforms.add(new Ji("inverseViewMatrix",(e,t)=>{const s=Qe();return fo(s,t.camera.viewMatrix,e.localOrigin),Ml(s,s)})),i.fragment.code.add(v`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}class Yg extends C5{constructor(){super(...arguments),this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.projectionMatrices=ho.flat(),this.viewMatrices=ho.flat()}}function hC(i){const e=new Dt,t=e.fragment;e.include(Ps),e.include(T5),e.include(S1),t.include(uc),t.include(RR),t.uniforms.add(new Fe("depthTexture",(r,a)=>{var n;return(n=a.depth)==null?void 0:n.attachment})),t.uniforms.add(new Ji("inverseProjectionMatrix",(r,a)=>a.camera.inverseProjectionMatrix),new Ji("inverseViewNormalMatrix",(r,a)=>Ml(S5,a.camera.viewInverseTransposeMatrix))),t.uniforms.add(new Ei("viewshedTargetVector",(r,a)=>r.targetVector),new Ei("viewshedUpVector",(r,a)=>r.upVector),new Bi("viewshedFOVs",(r,a)=>r.fovs),new Bi("viewshedHeadingAndTilt",(r,a)=>r.headingAndTilt),new Bi("viewshedNearFar",(r,a)=>r.shadowMap.nearFar??[1,100])),t.uniforms.add(new Fe("viewshedShadowMap",r=>r.shadowMap.depthTexture),new i0("viewshedProjectionMatrices",(r,a)=>r.projectionMatrices,6),new i0("viewshedViewMatrices",(r,a)=>r.viewMatrices,6),new B_("viewshedNumFaces",(r,a)=>r.shadowMap.numActiveFaces),new Br("viewshedAtlasRegions",(r,a)=>r.shadowMap.atlasRegions.flat(),24)),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]);const s=i.useNormalMap;return s?(t.uniforms.add(new Fe("normalMap",(r,a)=>r.normalTexture)),t.code.add(v`vec3 normalFromTexture() {
vec4 norm4 = texture(normalMap, uv);
vec3 nNormal = vec3(-1.0) + 2.0 * norm4.xyz;
return normalize((inverseViewNormalMatrix * vec4(nNormal, 1.0)).xyz);
}`)):e.include(Ox),t.code.add(v`
    // UV coordinates of point projected onto viewshed shadow map
    vec2 getViewshedUv(vec4 worldPosition, int face) {
      mat4 viewshedMatrix = viewshedProjectionMatrices[face];
      vec4 viewshedUv4 = viewshedMatrix * worldPosition;
      vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
      return viewshedUv.xy;
    }

    float viewshedDepthToFloat(float depth) {
      return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
    }

    // Orthographic depth to viewshed of given point and given cube map face in range [0, 1].
    float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
      mat4 viewshedViewMatrix = viewshedViewMatrices[face];
      vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
      vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
      float depth = -viewshedUv.z;
      return viewshedDepthToFloat(depth);
    }

    // Read depth from shadow map given uv and cube map face
    float getDepthFromShadowMap(vec2 uv, int face) {
      int index = 4 * face;

      float umin = viewshedAtlasRegions[index];
      float umax = viewshedAtlasRegions[index + 1];
      float vmin = viewshedAtlasRegions[index + 2];
      float vmax = viewshedAtlasRegions[index + 3];

      vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
      return rgba4ToFloat(textureAtlasLookup(viewshedShadowMap, uv, atlasRegion));
    }

    struct ViewshedPoint {
      int face;
      vec2 uv;
      bool isWithin;
      float orthographicDepth;
    };

    // Find cube map face the given position lies in and return relevant information about it
    bool getViewshedPoint(vec4 worldPosition, out ViewshedPoint point) {
      vec3 nUp = normalize(viewshedUpVector);

      // Try with all active cube map faces
      for(int i=0; i < viewshedNumFaces; i++) {

        // Check if when projected, point lies within shadow map texture
        vec2 viewshedUv = getViewshedUv(worldPosition, i);
        if (viewshedUv.x > 0.0 && viewshedUv.x < 1.0 && viewshedUv.y > 0.0 && viewshedUv.y < 1.0) {
          float orthoDepth = getOrthographicDepthToViewshed(worldPosition, i);
          if (orthoDepth >= 0.0) { // found a cube map face

            // Check whether point is really inside viewshed geometry, not just within the camera frustum

            // outside farDistance
            vec3 position = worldPosition.xyz;
            bool isWithin = length(position) <= viewshedNearFar[1];

            // horizontally outside fov
            float t = dot(nUp, position);
            bool isBottomHalf = t > 0.0;
            vec3 nProjVector = normalize(position - t * nUp);
            if (isWithin) {
              float angle = acos(dot(normalize(viewshedTargetVector), nProjVector));
              if (angle > viewshedFOVs[0] / 2.0) {
                isWithin = false;
              }
            }

            // vertically outside fov
            if (isWithin) {
              float angle = acos(dot(nProjVector, normalize(position)));
              if (!isBottomHalf) {
                angle = -angle;
              }
              float tilt = viewshedHeadingAndTilt[1];
              float limit = viewshedFOVs[1] / 2.0;
              if (angle > limit || angle < -limit) {
                isWithin = false;
              }
            }

            point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
            return true;
          }
        }
      }

      // no cube face matches
      return false;
    }

    float normalCosAngle(float linearDepth, vec3 localPosition) {
      ${s?v`vec3 normal = normalFromTexture();`:v`
        vec3 cameraSpacePosition = reconstructPosition(gl_FragCoord.xy, linearDepth);
        vec3 normal = normalFromDepth(depthTexture, cameraSpacePosition, gl_FragCoord.xy, uv);
        normal = (inverseViewNormalMatrix * vec4(normal, 1.0)).xyz;
        `};

      vec3 viewingDir = normalize(localPosition);
      return dot(normal, viewingDir);
    }

    void main() {
      float depth = depthFromTexture(depthTexture, uv);

      // Outside camera planes
      if (depth >= 1.0 || depth <= 0.0) {
        return;
      }

      float linearDepth = linearizeDepth(depth);

      // Relative to viewshed position
      vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);

      ViewshedPoint point;
      bool foundFace = getViewshedPoint(localPosition, point);

      // Outside every viewshed
      if (!foundFace || !point.isWithin) {
        return;
      }

      float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
      float distance = point.orthographicDepth;

      bool visible = distance < viewshedDepth;
      fragColor = visible ? visibleColor : occludedColor;

      float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);

      // Everything facing away, and close to parallel is considered occluded.
      // Theshold corresponds to around 0.6 degrees, tuned empirically.
      if (cosAngle > -0.01) {
        fragColor = occludedColor;
      }
    }`),e}const S5=Qe(),P5=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Yg,build:hC},Symbol.toStringTag,{value:"Module"}));let cC=class dC extends It{initializeProgram(e){return new Lt(e.rctx,dC.shader.get().build(this.configuration),pt)}initializePipeline(){return ot({colorWrite:ht,blending:H_})}};cC.shader=new $t(P5,()=>ae(()=>Promise.resolve().then(()=>_F),void 0,import.meta.url));class uC extends tr{constructor(){super(...arguments),this.useNormalMap=!0}}c([z()],uC.prototype,"useNormalMap",void 0);let Zn=class extends $1{get viewshedShadowMap(){return this._viewshedShadowMap}get enabled(){return this._viewsheds.length>0}constructor(i,e){super(i),this._pluginContext=null,this.renderHighQuality=!1,this._parameters=new Yg,this._configuration=new uC,this._viewsheds=new Qr,this.produces=new Map([[j.VIEWSHED,()=>!0]]),this._renderShadowMap=e}initialize(){this.addHandles(M(()=>this.view.qualitySettings.maximumPixelRatio,i=>this._maximumPixelRatio=i,ut))}destroy(){this.uninitializeRenderContext()}consumes(){return this.enabled?W_:Q_}initializeRenderContext(i){this._pluginContext=i,this._viewshedShadowMap=new b5(this.fboCache),this._viewshedShadowMap.enabled=!0}renderNode(i,e,t){var n,o,l;const{bindParameters:s,rctx:r}=i;if(!this.enabled||!s.depth||t==null)return;const a=this._setupNormals(t);if(this._technique!=null&&this._configuration.useNormalMap===a||(this._configuration.useNormalMap=a,this._technique=(n=this._pluginContext)==null?void 0:n.techniques.acquire(cC,this._configuration)),(o=this._technique)==null?void 0:o.compiled)for(const h of this._viewsheds){const d=i.rctx.getBoundFramebufferObject(),u=this._renderViewshedShadowCubeMap(s,h),m=this._viewshedShadowMap;u&&m.depthTexture!=null&&!m.isTextureZero&&(this._setPassParameters(h),i.rctx.bindFramebuffer(d),r.bindTechnique(this._technique,s,this._parameters),r.screen.draw())}else(l=this._pluginContext)==null||l.requestRender()}uninitializeRenderContext(){this._pluginContext=null,this._viewshedShadowMap.dispose(),this._technique=Y(this._technique)}updateViewsheds(i){const e=i.removes;e!=null&&(Qr.isCollection(e)?this._viewsheds.removeMany(e):this._viewsheds.remove(e));const t=i.adds;if(t!=null)if(Qr.isCollection(t)){const s=t.filter(r=>!this._viewsheds.includes(r));this._viewsheds.addMany(s)}else this._viewsheds.includes(t)||this._viewsheds.add(t)}_renderViewshedShadowCubeMap(i,e){const t=this._viewshedShadowMap;if(!t.enabled)return!1;const s=t.start(i.camera,e,this.renderHighQuality,this._maximumPixelRatio);if(s)for(const r of t.faces)this._renderShadowMap(i,r,E.ViewshedShadow);return t.finish(),s}_setPassParameters(i){const e=this._parameters,t=this._viewshedShadowMap,s=i.observerRenderSpace;e.localOrigin=s,e.fovs=[Tt(i.horizontalFieldOfView),Tt(i.verticalFieldOfView)],e.headingAndTilt=[Tt(i.heading),Tt(i.tiltParallelToSurface)],e.upVector=i.tiltedUpVector;const r=R5(i.targetRenderSpace,s);e.targetVector=r,e.shadowMap=t;const a=[],n=[];for(let o=0;o<t.numActiveFaces;o++)fo(fm,t.viewshedViewMatrices[o],s),a.push(...fm.flat()),O5(t.viewshedProjectionMatrices[o],fm,Dy),n.push(...Dy.flat());e.viewMatrices=a,e.projectionMatrices=n}_setupNormals(i){const e=i.get("normals"),t=e==null?void 0:e.getTexture();return this._parameters.normalTexture=t,t!=null}get test(){return{viewsheds:this._viewsheds}}};function R5(i,e){const t=b();return xt(t,i,e)}function O5(i,e,t){const s=St(.5,.5,.5);return U1(t,s),s2(t,t,s),du(t,t,i),du(t,t,e),t}c([p()],Zn.prototype,"_pluginContext",void 0),c([p()],Zn.prototype,"fboCache",void 0),c([p()],Zn.prototype,"view",void 0),c([p()],Zn.prototype,"viewshedShadowMap",null),Zn=c([F("esri.views.3d.webgl-engine.lib.Viewshed")],Zn);const fm=Qe(),Dy=Qe();function M5(i,e){const t=i.capabilities.disjointTimerQuery;return t==null?null:new E5(t,e)}class E5{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach(s=>{const r=this._timer.createQuery(),a=this._timer.createQuery();this._queryPool.push(r,a),this._queryResults.set(s,null)})}start(){uO||(this._currentQuery=this._queryPool.pop(),this._currentQuery!=null&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||this._currentQuery==null||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(t==null)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const s=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,s}abort(){this._currentQuery!=null&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){this._currentQuery!=null&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{e!=null&&this._timer.deleteQuery(e)})}}var Mt;(function(i){i.OVERLAY="overlay",i.PREPARE="prepare",i.SHADOW_MAP="shadow map",i.DEPTH="depth",i.ACCUMULATED_SHADOWS="accumulated shadows",i.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",i.NORMALS="normals",i.SSAO="SSAO",i.OPAQUE_EDGES="opaque edges",i.VOXEL="voxel",i.TRANSPARENT="transparent",i.TRANSPARENT_EDGES="transparent edges",i.HUD_VISIBILITY="HUD visibility",i.TRANSPARENT_TERRAIN="transparent terrain",i.OPAQUE_ENVIRONMENT="opaque environment",i.TRANSPARENT_ENVIRONMENT="transparent environment",i.LASER_LINES="laser lines",i.VIEWSHED="viewshed",i.OCCLUDED="occluded",i.HUD="HUD",i.HUD_OCCLUDED="HUD occluded",i.FINISH="finish"})(Mt||(Mt={}));const vm=Object.values(rn).concat(Object.values(oo)).concat(Object.values(Mt)),$y="Total";class A5{constructor(e){this._rctx=e,this._startTimeStampCPU=ct(0),this._lastTimeStampCPU=ct(0),this._totalCPUTime=new Tc($y),this._cpuTimeSamplers=new Map(vm.map(t=>[t,new Tc(t)])),this._enableGPUTimer=0,this._totalGPUTime=new Tc("GPU"),this._gpuTimeSamplers=new Map(vm.map(t=>[t,new Tc(t)])),this._totalTime=ct(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return this._gpuTimerPool!=null}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return ct(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(this._gpuTimerPool==null){const t=[...vm,$y];this._gpuTimerPool=M5(this._rctx,t)}if(this._gpuTimerPool==null)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,this._enableGPUTimer===0&&(this._gpuTimerPool=je(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=ct(performance.now()),this._gpuTimerPool&&this._gpuTimerPool.start()}advance(e){const t=ct(performance.now());if(this._cpuTimeSamplers.get(e).record(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const s=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(s),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const t=this._gpuTimerPool.stop(Mt.FINISH);this._gpuTimeSamplers.get(Mt.FINISH).record(t),this._rctx.gl.flush()}const e=ct(performance.now()-this._startTimeStampCPU);this._totalTime=ct(this._totalTime+e),this._totalCPUTime.record(e),this._gpuTimerPool&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce((t,s)=>t+(s.last||0),0)),++this._totalFrameCount}}class Xd{constructor(e,t,s,r,a,n){this._stage=e,this._techniques=s,this._rctx=r,this._compositingHelper=a,this._requestRender=n,this._pluginsHas={hudElements:!1,water:!1},this._hasOverlayWater=!1,this.renderOverlay=o=>{},this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=er(0,0,0,1),this._sliceHelper=new f5,this._blit=null,this._state=Sh(ft.IDLE),this._highQualityTransparencyEnabled=!0,this._terrainTransparency=qi.Opaque,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new t5,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=Sh(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new h5,this._releaseNormals=o=>{o.some(({name:l})=>l==="normals")&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this.fboCache=new ZN(r),this._renderStateFeatures=Sh(j0(!li("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._offscreen=new o5(this.fboCache,this._compositingHelper),this.performanceInfo=new A5(this._rctx),this._shadowMap=new I1(this.fboCache,e.viewingMode),this._viewshed=new Zn({fboCache:this.fboCache,view:e.view},(o,l,h)=>{l.setGLViewport(this._rctx);const{camera:d,contentCamera:u}=o;this._ensureBindParametersCamera(l,l),this._renderAllGeometry(h),this._ensureBindParametersCamera(d,u),o.camera.setGLViewport(this._rctx)}),this._shadowAccumulator=new ss(this.fboCache,s,e,o=>{const l=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(o.camera,o.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=l},(o,l,h)=>{const d=this._stage.view.qualitySettings.maximumPixelRatio;o.shadowMap.start(o.camera,l,h,!0,d),this._renderShadowCascades(E.Shadow,o.shadowMap),o.shadowMap.finish(),o.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(o.camera,o.contentCamera)},n),this._renderContext=new NP(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper),this._nodes=new KN(this._renderContext),this._plugins=new JN({renderContext:this._renderContext,techniques:s,materials:t,requestRender:n,controller:e,fbos:this.fboCache,isFeatureEnabled:o=>this.isFeatureEnabled(o)}),this.renderPassManager=new P_,this._plugins.add(this.renderPassManager),this._plugins.add(this._viewshed),this._handles=[M(()=>this._stage.view.state.camera,()=>n(),ut),M(()=>Ts.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,o=>{this._renderHiddenTransparentEdges=o?()=>this._renderEdges($o.TRANSPARENT):()=>{},n()},si),M(()=>{var o;return(o=this._stage.view.environment.background)==null?void 0:o.color},o=>{const l=o?Gh(o):V_;vn(this._backgroundColor,l[0]*l[3],l[1]*l[3],l[2]*l[3],l[3]),n()},ut),M(()=>this._stage.view.state.camera.relativeElevation,o=>{this._inGlobeView=(o??1/0)>=uP},ut)]}destroy(){this._handles.forEach(e=>e.remove()),this._gpuTimerHandle=Zr(this._gpuTimerHandle),this._nodes.destroy(),this._offscreen.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=Pn(this._loadEdgeViewTask),this._edgeView=Y(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),pP.prune()}get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeatures(e=null,t=!li("disable-feature:high-quality-idle")){this._renderStateFeatures.value=j0(t,e),this._plugins.renderFeatureChanged(),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,s){this._renderStateFeatures.mutate(r=>r.set(t,e,s)),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(Vt.HighQualityTransparency)}get hasReflections(){return(this._pluginsHas.water||this._hasOverlayWater)&&(this._ssrEnabled||this.isFeatureEnabled(Vt.WaterReflection))}get hasDecorations(){return this._plugins.hasDecorations||this._nodes.produces("magnifier-color")}get hasHighlights(){return this._plugins.produces(E.Highlight,j.OPAQUE_MATERIAL,j.TRANSPARENT_MATERIAL,j.DRAPED_MATERIAL)}get hasLaserlines(){return this._plugins.produces(this._renderContext.output,j.LASERLINES,j.LASERLINES_CONTRAST_CONTROL)}get hasSSAO(){return(this._stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(Vt.SSAO))&&!this._inGlobeView}get hasSMAA(){return this._stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(Vt.Antialiasing)}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(Vt.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=tt(this._bindParameters.ssr.lastFrameColor),this._bindParameters.multipassTerrain.depth=tt(this._bindParameters.multipassTerrain.depth),this._bindParameters.multipassGeometry.depth=tt(this._bindParameters.multipassGeometry.depth)}_disposeOffscreenBuffers(){this._offscreen.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._viewshed.viewshedShadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=tt(this._bindParameters.depth),this._bindParameters.hudVisibility=tt(this._bindParameters.hudVisibility)}get updating(){return this._edgeView!=null&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=cc(async e=>{const{EdgeView:t}=await ae(()=>import("./EdgeView-Cygm2Z61.js"),__vite__mapDeps([525,1,2,3,9,58,59,60,180,7,8,68,61,53,41,15,12,14,10,11,13,5,6,69,70,43,71,132,133,37,46,47,48,49,50,51,52,54,55,56,57,62,63,64,65,66,67,72,73,74,75,102,125,134,135,77,112,99,76,78,79,16,17,101,111,82,122,121,32,33,34,103,98,42,44,45,80,81,83,84,30,85,86,40,27,28,29,26,87,88,25,31,35,36,22,38,39,89,90,91,4,92,93,94,95,96,97,100,104,105,106,107,108,109,266,130,131,202,196,197,203,199,204,205,206,207,208,170,209,210,211,212,213,155,156,214,215,191,192,200,20,216,217,218,115,116,219,220,221,222,223,224,19,21,225,226,227,228,229,230,231,232,233,526,272,198,527,194,195,24,110,113,114,117,118,119,120,123,124,126,127,128,129,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,157,158,159,160,161,162,163,164,165,166,167,168,169,171,201,183,234,235,236,237,172,173,174,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,188,189,254,255,256,257,258,259,260,261,262,263,264,265,267,268,269,175]),import.meta.url);Qi(e);const s=this._edgeView=new t({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:D5(this._stage.view.resourceController)});return this._handles.push(M(()=>s.updating,()=>this._requestRender(),nt)),this._requestRender(),this._edgeViewCallbacks.forEach(r=>r(s)),this._edgeViewCallbacks.length=0,s})),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),this._edgeView==null?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&r2(this._bindParameters.ssr.reprojectionMatrix,ho)}set _reprojectionMatrix(e){TC(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){var e;return!!((e=this._shadowMap)!=null&&e.enabled)}setParameters(e){var r;const{_shadowMap:t,_bindParameters:s}=this;if(((r=e.qualitySettings)==null?void 0:r.reflections)!==void 0&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),e.shadowMap!==void 0&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),e.shadowMapMaxCascades!==void 0&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),e.environment!=null){e.environment.weather!=null&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const a=e.environment.lighting.type!=="virtual";s.enableFillLights!==a&&(s.enableFillLights=a,this._requestRender())}e.highQualityTransparency!==void 0&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),e.hasOverlayWater!==void 0&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),e.slicePlane!==void 0&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),e.terrainTransparency!==void 0&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),e.shadowCast!==void 0&&this._shadowAccumulator.setOptions(e.shadowCast)}get hasSlicePlane(){return!!this._sliceHelper.plane}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,t){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:s,removes:r,updates:a}=e;if(s.length===0&&r.length===0&&a.length===0)return;const n=FP(e);let o=!1;n.forEach((l,h)=>{if(t.done)return;let d=this._plugins.getMaterialRenderer(h);if(d==null&&l.adds.length>0){const u=new VP({material:h});u.initializeRenderContext(this._plugins._context),d=u,this._plugins.add(d)}d&&(d.modify(l),d.numGeometries===0&&(o=!0)),l.removes.forEach(u=>e.removes.removeUnordered(u)),l.adds.forEach(u=>e.adds.removeUnordered(u)),l.updates.forEach(u=>e.updates.removeUnordered(u)),t.madeProgress()}),o&&this._plugins.removeEmptyMaterialRenderers(),this._updateHasFlags(),this._requestRender()}_updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(E.Color,j.LINE_CALLOUTS_HUD_DEPTH,j.HUD_MATERIAL,j.LABEL_MATERIAL),e.water=this._plugins.produces(E.Normal,j.DRAPED_WATER),this._bindParameters.hasOccludees=this._plugins.hasOccludees}updateAnimation(e){const t=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(e),this._hasAnimations=this._nodes.updateAnimation()||this._hasAnimations,this._hasAnimations!==t&&(this._gpuTimerHandle=t?Zr(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,s=wa.Default,r=Ws.ON){var J,A,O,te;this._isRendering=!0,this.performanceInfo.startFrame(),this.fboCache.frameStart(),this._disposeBindBuffers();const a=this._offscreen,{camera:n,contentCamera:o,mode:l,alignPixelEnabled:h}=e;this._state.value=l,this._bindParameters.overlay=this.renderOverlay(t),this._bindParameters.overlay&&this.performanceInfo.advance(Mt.OVERLAY),this._renderContext.time=t,this._bindParameters.transparencyPassType=wi.NONE,this._bindParameters.alignPixelEnabled=h,this._bindParameters.decorations=r,this._bindParameters.mainColor=this._bindParameters.mainDepth=null,this._bindParameters.viewshedEnabled=this._viewshed.enabled;const d=this._nodes.produces("magnifier-color"),u=this._nodes.produces("final-color"),m=Fu(this._sliceHelper.plane);r===Ws.OFF&&(this._sliceHelper.plane=null),n.setGLViewport(this._rctx);const _=a.initializeFrame(n,this._backgroundColor,s);this.hasReflections?this._bindParameters.ssr.lastFrameColor=_:_==null||_.release(),this._ensureBindParametersCamera(n,o),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&r===Ws.ON;const f=this._plugins.produces(E.Color,j.OPAQUE_TERRAIN)&&(this._terrainTransparency===qi.Semitransparent||this._terrainTransparency===qi.TransparentWithDraped),g=this._highQualityTransparency&&f,y=this._plugins.produces(E.Color,..._d);this._prepareShaders(g,y),this.performanceInfo.advance(Mt.PREPARE);const w=this._computeDepthRange(n);this._renderShadowMap(n,this._bindParameters.lighting.mainLight.direction,w),this._ensureBindParametersCamera(n,o);let x=this._renderNormals();if(this._pluginInput.set("normals",x),x){let $=null;this._needsDepth&&($=x.getAttachment(Nm),$==null||$.retain()),this._pluginInput.set("ssao",this._renderSSAO()),this._renderNoSSAOGeometryDepth($),x=null}else this._renderAllGeometryDepth();this._renderShadowAccumulation(w,n,o),this._ensureBindParametersSSR(t),this._renderContext.output=E.Color,a.bindFbo(),this._bindParameters.mainColor=a.colorTexture,this._bindParameters.mainDepth=a.depthTexture;const T=this.plugins.produces(E.Color,...ym);T&&this._renderOpaqueGeometry(),this._offscreen.updateColor($=>this._renderNodes(rn.OPAQUE,$,T)),(A=(J=this.fboCache).debugCallback)==null||A.call(J,"opaque-color",this._offscreen.color.fbo),this._renderPlugins(j.OPAQUE_ENVIRONMENT,Mt.OPAQUE_ENVIRONMENT),this._renderMultipassTerrainDepth(g),this._setMultipassTerrain(g),this._renderEdges($o.OPAQUE),a.bindFbo(),this._renderPlugins(j.VOXEL,Mt.VOXEL),this._renderHiddenTransparentEdges(),y&&(this._oitEnabled?this._renderOITPass(ul.Geometry):this._renderTransparentMaterial()),this._offscreen.updateColor($=>this._renderNodes(rn.TRANSPARENT,$,y)),(te=(O=this.fboCache).debugCallback)==null||te.call(O,"transparent-color",this._offscreen.color.fbo),this._renderMultipassGeometryDepth(g),this._renderHUDVisibility(),g||this._plugins.render(this._pluginInput,j.LINE_CALLOUTS);const S=s===wa.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;this._renderEdges($o.TRANSPARENT);const C=f?this._renderTransparentTerrain():null;C&&(this.performanceInfo.advance(Mt.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(g?this._renderLineCallouts(Mr.Occluded):a.compositeToHUDVisibility(this._bindParameters,C.getTexture()),this._renderHUD(Mr.Occluded,a.color))),this._setTerrainCulling(!1),C&&(a.compositeToFramebuffer(this._bindParameters,C.getTexture(),ws.PremultipliedAlpha,1),C.release(),g&&(this._renderEdges($o.OPAQUE),y&&(this._oitEnabled?this._renderOITPass(ul.Geometry):this._renderTransparentMaterial(),this.performanceInfo.advance(Mt.TRANSPARENT)),this._renderEdges($o.TRANSPARENT))),this._bindParameters.ssao=tt(this._bindParameters.ssao),g&&this._renderLineCallouts(Mr.NotOccluded),this._setMultipassEnabled(!1),this._renderTransparentEnvironment(),this._renderViewshed(),this._renderLaserlines(),this._renderOccluded(),this._pluginInput.set("highlights",this._renderHighlightPrepass()),this._offscreen.updateColor($=>this._renderNodes(rn.COMPOSITE,$));const P=this._nodes.produces("aa-color"),R=!(s!==wa.Default||u||d&&r===Ws.ON&&s===wa.Default),I=this._pluginInput.get("composite-color"),L=R?lc:this.fboCache.acquire(I.fbo.width,I.fbo.height,"aa-color"),G=P?this._renderNodes(oo.ANTIALIASING,L):this._blitToDefault(I,L,!1);this._pluginInput.set(oo.ANTIALIASING,G),this._renderHUD(Mr.NotOccluded,G);const H=this._renderNodes(oo.HIGHLIGHTS,G);let D=this._renderNodes(oo.MAGNIFIER,H);return d&&r===Ws.ON&&s===wa.Default&&!u&&(D=this._blitToDefault(D)),u?(D.attachDepth(a.depth),this._blitToDefault(this._renderNodes(rn.FINAL,D)),D.detachDepth()):this._pluginInput.set(rn.FINAL,D),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),this._offscreen.releaseBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=m,this._isRendering=!1,this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),s!==wa.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),{screen:this._pluginInput.get("final-color"),oid:S}}_prepareShaders(e,t){this._renderContext.output=E.Color,this._prepareOpaqueGeometry(),this._setMultipassTerrain(e),this._plugins.prepare(j.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),e||this._plugins.prepare(j.LINE_CALLOUTS),t&&this._prepareTransparencySlots(),this._plugins.prepare(j.VIEWSHED,j.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,j.TRANSPARENT_ENVIRONMENT,j.LASERLINES),this._rctx.gl.flush()}_renderObjectAndLayerIdColor(){if(!li("enable-feature:objectAndLayerId-rendering"))return;const e=this._renderContext.output,t=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oid");return t.acquireDepth(Vi.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(t.fbo),this.fboCache.rctx.clearFramebuffer([0,0,0,0],!0,!0),this._renderAllGeometry(E.ObjectAndLayerIdColor),this._rctx.bindFramebuffer(t.fbo),this.fboCache.rctx.clearFramebuffer(void 0,!0,!0),this._bindParameters.hudRenderStyle=Mr.NotOccluded,this._plugins.render(this._pluginInput,j.HUD_MATERIAL),this._renderContext.output=e,this.performanceInfo.advance(Mt.OBJECT_AND_LAYER_ID_COLOR),t}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,s=e===st.BACKGROUND;if(s||t){const r=s?this.performanceInfo.elapsedTime:0,a=t?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),n=Math.max(r,a);this._animationTimestep.frame(n,s)}}readDepthPixels(e,t){var n;if(!this._bindParameters.mainDepth)return;const{width:s,height:r}=this._offscreen,a=this.fboCache.acquire(s,r,"linear-depth");this._rctx.bindFramebuffer(a.fbo),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.clearFramebuffer([0,0,0,0],!0,!0),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,this._bindParameters.mainDepth),(n=a.fbo)==null||n.readPixels(e[0],e[1],e[2],e[3],_i.RGBA,go.UNSIGNED_BYTE,t),a.release()}readHUDVisibility(e,t,s,r,a){var n,o;(o=(n=this._bindParameters.hudVisibility)==null?void 0:n.fbo)==null||o.readPixels(e,t,s,r,_i.RGBA,go.UNSIGNED_BYTE,a)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_setMultipassTerrain(e){this._setMultipassEnabled(e),this._setTerrainCulling(e)}_setMultipassEnabled(e){this._bindParameters.multipassEnabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_renderEdges(e){const t=this._edgeView;if(!(t!=null&&t.shouldRender()))return;const{width:s,height:r,depth:a}=this._offscreen,n=this.fboCache.acquire(s,r,"edges"),o=()=>t.render(this._bindParameters,e),l=this._bindParameters.multipassGeometry.depth;this._offscreen.renderToTargets(o,n,l??a,Ly),this._offscreen.compositeToFramebuffer(this._bindParameters,n.getTexture(),ws.Alpha,1),n.release(),this.performanceInfo.advance(e===$o.OPAQUE?Mt.OPAQUE_EDGES:Mt.TRANSPARENT_EDGES)}_renderShadowMap(e,t,s){const r=this._shadowMap;r.enabled&&(r.start(e,t,s,this.isFeatureEnabled(Vt.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(E.ShadowHighlight,this._shadowMap),r.moveSnapshot(ou.Highlight),this._renderShadowCascades(E.ShadowExcludeHighlight,this._shadowMap),r.copySnapshot(ou.ExcludeHighlight),this._renderShadowCascades(E.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(E.Shadow),r.finish(),e.setGLViewport(this._rctx),this.performanceInfo.advance(Mt.SHADOW_MAP))}_renderShadowCascades(e,t=this._shadowMap){for(const s of t.cascades)s.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(s.camera,s.camera),this._renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(E.Depth)||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast||this._debugNeedsDepth}_renderNoSSAOGeometryDepth(e){if(!this._needsDepth||!e)return void(this._bindParameters.depth=tt(this._bindParameters.depth));const{width:t,height:s}=this._offscreen,r=this.fboCache.acquire(t,s,"depth");r.attachDepth(e),e.release(),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer(void 0,!1,!0),this._renderGeometryExcludedFromSSAO(E.Depth),tt(this._bindParameters.depth),this._bindParameters.depth=r.obtainDepthTexture(),r.release(),this.performanceInfo.advance(Mt.DEPTH)}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=tt(this._bindParameters.depth));const{width:e,height:t}=this._offscreen,s=this.fboCache.acquire(e,t,"depth").acquireDepth(Vi.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(s.fbo),this._rctx.clearFramebuffer(void 0,!0,!0),this._renderAllGeometry(E.Depth),tt(this._bindParameters.depth),this._bindParameters.depth=s.obtainDepthTexture(),s.release(),this.performanceInfo.advance(Mt.DEPTH)}_renderMultipassTerrainDepth(e){if(!e)return void(this._bindParameters.multipassTerrain.depth=tt(this._bindParameters.multipassTerrain.depth));const t=this._renderContext.output;this._renderContext.output=E.Depth;const{width:s,height:r}=this._offscreen,a=this.fboCache.acquire(s,r,"terrain depth").acquireDepth(Vi.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(a.fbo),this._rctx.clearFramebuffer(void 0,!0,!0),this._renderTransparentTerrain(),tt(this._bindParameters.multipassTerrain.depth),this._bindParameters.multipassTerrain.depth=a.obtainDepthTexture(),this._renderContext.output=t,a.release()}_renderMultipassGeometryDepth(e){if(!e)return void(this._bindParameters.multipassGeometry.depth=tt(this._bindParameters.multipassGeometry.depth));const t=this._renderContext.output,{width:s,height:r}=this._offscreen,a=this.fboCache.acquire(s,r,"geometry depth").acquireDepth(Vi.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(a.fbo),this._rctx.clearFramebuffer(void 0,!0,!0),this._renderOpaqueGeometryAndTransparentMaterial(E.Depth),this._renderContext.output=t,tt(this._bindParameters.multipassGeometry.depth),this._bindParameters.multipassGeometry.depth=a.obtainDepthTexture(),a.release()}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(e){if(!this._needsDepthRange)return x_;const t=VN(e,this._plugins.plugins,this._stage.layers);return Pl(t,this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}_renderNormals(){const e=this._nodes.require("normals","final-color","composite-color","opaque-color","transparent-color"),t=(this.hasSSAO?1:0)+(this.hasLaserlines?1:0)+e;if(t===0)return;const s=this._offscreen.renderToCachedFBO(null,"normals",()=>this._renderGeometryForSSAO(E.Normal),[0,0,0,0],ni.RGBA,Vi.DEPTH_STENCIL_TEXTURE),r=this._nodes.optional("normals","final-color","composite-color","opaque-color","transparent-color")+(this._viewshedEnabled?1:0);return s.retain(t+r-1),this.performanceInfo.advance(Mt.NORMALS),s}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return void(e==null?void 0:e.detachDepth());const t=this._nodes.render("ssao",this._pluginInput);return this._bindParameters.ssao=t,e.detachDepth(),this._pluginInput.release("normals"),this.performanceInfo.advance(Mt.SSAO),t}_renderAllGeometry(e){this._renderContext.output=e,this._plugins.prepare(j.TRANSPARENT_TERRAIN),this._renderOpaqueGeometryAndTransparentMaterial(e),this._renderTransparentTerrain()}_renderOpaqueGeometryAndTransparentMaterial(e){this._renderContext.output=e,this._plugins.prepare(j.TRANSPARENT_MATERIAL,j.TRANSPARENT_NO_SSAO_DEPTH),this._renderOpaqueGeometry(),this._renderTransparentMaterial()}_renderGeometryForSSAO(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,j.INTEGRATED_MESH,j.OPAQUE_TERRAIN,j.OPAQUE_MATERIAL,j.TRANSPARENT_MATERIAL),this._renderTransparentTerrain()}_renderGeometryExcludedFromSSAO(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,j.OPAQUE_NO_SSAO_DEPTH,j.TRANSPARENT_NO_SSAO_DEPTH)}_prepareOpaqueGeometry(){this._plugins.prepare(...ym,j.OPAQUE_ENVIRONMENT)}_renderOpaqueGeometry(){this._plugins.render(this._pluginInput,...ym)}_renderTransparentMaterial(){this._plugins.render(this._pluginInput,..._d)}_renderTransparentTerrain(){const e=this._renderContext.output;if(!this._plugins.produces(e,j.TRANSPARENT_TERRAIN))return;const t=()=>this._plugins.render(this._pluginInput,j.TRANSPARENT_TERRAIN);if(e!==E.Color)return void t();const{width:s,height:r,depth:a}=this._offscreen,n=this.fboCache.acquire(s,r,"transparent terrain");return this._offscreen.renderToTargets(t,n,a,[0,0,0,0]),n}_renderHUDVisibility(){this._plugins.produces(this._renderContext.output,j.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,()=>this._plugins.render(this._pluginInput,j.OCCLUSION_PIXELS),this._bindParameters.multipassGeometry.depth),this._offscreen.bindFbo(),this.performanceInfo.advance(Mt.HUD_VISIBILITY)):this._bindParameters.hudVisibility=tt(this._bindParameters.hudVisibility)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===Mr.Occluded){const t=()=>this._plugins.render(this._pluginInput,j.LINE_CALLOUTS),{width:s,height:r,color:a}=this._offscreen,n=this.fboCache.acquireDepth(Vi.DEPTH16_BUFFER,s,r,"line callouts");this._offscreen.renderToTargets(t,a,n,void 0,!0,!0),n.release()}else this._plugins.render(this._pluginInput,j.LINE_CALLOUTS)}_renderLaserlines(){if(this.hasLaserlines){if(this._plugins.render(this._pluginInput,j.LASERLINES),this._plugins.produces(this._renderContext.output,j.LASERLINES_CONTRAST_CONTROL)){const e=this._offscreen,{width:t,height:s,depth:r}=e,a=this.fboCache.acquire(t,s,"laser lines"),n=()=>this._plugins.render(this._pluginInput,j.LASERLINES_CONTRAST_CONTROL);e.renderToTargets(n,a,r,Ly),e.compositeToFramebuffer(this._bindParameters,a.getTexture(),ws.PremultipliedAlpha,1),a.release()}this._pluginInput.release("normals"),this.performanceInfo.advance(Mt.LASER_LINES)}}_renderHUD(e,t){if(this._pluginsHas.hudElements){if(this._oitEnabled){const s=this._renderOITPass(ul.HUD,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.composite(this._bindParameters,s.getTexture(),ws.PremultipliedAlpha),s.release()}else if(e===Mr.Occluded){this._renderContext.output=E.Color;const s=()=>this._renderHUDElements(e),{width:r,height:a,color:n}=this._offscreen,o=this.fboCache.acquireDepth(Vi.DEPTH16_BUFFER,r,a,"hud");this._offscreen.renderToTargets(s,n,o,void 0,!0,!0),o.release()}else this._renderContext.output=E.Color,t.acquireDepth(Vi.DEPTH16_BUFFER),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(e===Mr.Occluded?Mt.HUD_OCCLUDED:Mt.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.prepare(j.LINE_CALLOUTS_HUD_DEPTH,j.HUD_MATERIAL,j.LABEL_MATERIAL),this._plugins.render(this._pluginInput,j.LINE_CALLOUTS_HUD_DEPTH,j.HUD_MATERIAL,j.LABEL_MATERIAL)}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._plugins.produces(E.ShadowHighlight,j.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(!this.hasHighlights)return;const e=()=>{this._renderAllGeometry(E.Highlight),this._rctx.clear(Mi.DEPTH_BUFFER_BIT),this._renderHUDElements(Mr.Both)},t=this._offscreen.renderToCachedFBO(null,"highlights",e,[0,0,0,0],ni.RGBA4,Vi.DEPTH_STENCIL_TEXTURE);return t.detachDepth(),t}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(e,t,s){this._needsShadowCast&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,e,t,s)&&this.performanceInfo.advance(Mt.ACCUMULATED_SHADOWS)}_prepareTransparencySlots(){this._renderContext.output=E.Color,this._bindParameters.transparencyPassType=wi.ColorAlpha,this._plugins.prepare(..._d),this._bindParameters.transparencyPassType=wi.FrontFace,this._plugins.prepare(..._d),this._bindParameters.transparencyPassType=wi.NONE,this._techniques.acquire(Qg).release()}_renderOITPass(e,t=Mr.Both){const s=e===ul.HUD,r=s?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oit hud composite"):null,a=s?()=>this._renderHUDElements(t):()=>this._renderTransparentMaterial(),n=this._renderContext.output;this._renderContext.output=E.Color,this._bindParameters.transparencyPassType=wi.ColorAlpha;const o=this._offscreen.renderOITPass(a,wi.ColorAlpha,s);this._bindParameters.transparencyPassType=wi.FrontFace;const l=this._offscreen.renderOITPass(a,wi.FrontFace,s);return this._offscreen.compositeOIT(this._bindParameters,o,l,r),r==null||r.detachDepth(),l.release(),o.release(),this._bindParameters.transparencyPassType=wi.NONE,this._renderContext.output=n,r}_renderOccluded(){let e=0;Os.clear(),this._plugins.plugins.forAll(l=>{l.materialReference&&l.queryRenderOccludedState(yi.OccludeAndTransparentStencil)&&(e|=yi.OccludeAndTransparentStencil,Os.push(l))});const t=this._offscreen,s=(l,h,d,u,m)=>{if(!(e&h))return;const{width:_,height:f,depth:g}=t,y=this.fboCache.acquire(_,f,"tmp color");t.renderToTargets(d,y,g,[0,0,0,0],u,m),t.compositeToFramebuffer(this._bindParameters,y.getTexture(),ws.PremultipliedAlpha,l),y.release()},r=(l,h)=>{this._bindParameters.slot=l,h.forAll(d=>{if(Vm(d)){const u=d.prepareTechnique(this._renderContext);u&&d.renderNode(this._renderContext,u)}})};Os.length!==0&&(r(j.OCCLUDER_MATERIAL,Os),s(.5,yi.OccludeAndTransparentStencil,()=>r(j.TRANSPARENT_OCCLUDER_MATERIAL,Os),!1,!1));const a=Os.length>0;Os.clear(),this._plugins.plugins.forAll(l=>{if(!l.materialReference)return;const h=l.queryRenderOccludedState(yi.OccludeAndTransparent),d=l.queryRenderOccludedState(yi.Transparent),u=l.queryRenderOccludedState(yi.Opaque);(h||d||u)&&(e|=h?yi.OccludeAndTransparent:d?yi.Transparent:yi.Opaque,Os.push(l))});const n=this._plugins.renderOccludedFlags;if(e|=n,!e)return;const o=l=>{this._renderContext.renderOccludedMask=l,n>yi.Occlude&&this._plugins.render(this._pluginInput,j.OCCLUDED_TERRAIN),r(j.OPAQUE_MATERIAL,Os),r(j.TRANSPARENT_MATERIAL,Os),r(j.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,Os),this._renderContext.renderOccludedMask=UP};this._renderContext.output=E.Color,s(.5,yi.OccludeAndTransparent,()=>o(yi.OccludeAndTransparent),!0,Ph.OutlineVisualElementMask),s(.5,yi.Transparent,()=>o(yi.Transparent),!0,Ph.OutlineVisualElementMask),s(1,yi.Opaque,()=>o(yi.Opaque),!0,Ph.OutlineVisualElementMask),(a||Os.length>0)&&this.performanceInfo.advance(Mt.OCCLUDED),Os.clear()}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this._offscreen.bindFbo(),this._plugins.render(this._pluginInput,j.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,j.TRANSPARENT_ENVIRONMENT),this.performanceInfo.advance(Mt.TRANSPARENT_ENVIRONMENT)}_renderViewshed(){this._viewshedEnabled&&(this._viewshed.renderHighQuality=this.isFeatureEnabled(Vt.HighResolutionViewshed),this._plugins.render(this._pluginInput,j.VIEWSHED),this._pluginInput.release("normals"),this.performanceInfo.advance(Mt.VIEWSHED))}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(this._pluginInput,e),this.performanceInfo.advance(t))}_renderNodes(e,t,s=!1){if(!this._nodes.produces(e))return s&&this.performanceInfo.advance(e),t;t.setName(e),this._pluginInput.set(e,t);const r=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),r}_blitToDefault(e,t=lc,s=!0){this._blit||(this._blit=new e5(this._techniques));const r=this._blit.render(this._rctx,e,t,this._bindParameters,this._requestRender);return this._pluginInput.set(e.name,r),s&&e.release(),r}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){this._ssrEnableTime==null&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=ho:(cu(Fy,this._bindParameters.camera.viewMatrix),cu(Ny,this._bindParameters.camera.projectionMatrix),Ks(Xo,Fy,Ny),Ks(Xo,this._renderContext.lastFrameCamera.viewMatrix,Xo),Ks(Xo,this._renderContext.lastFrameCamera.projectionMatrix,Xo),this._reprojectionMatrix=Xo);const t=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=ho,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}get usedMemory(){var e;return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:((e=this.edgeView)==null?void 0:e.usedMemory)??0}}get _viewshedEnabled(){return this._viewshed.enabled&&this._plugins.produces(this._renderContext.output,j.VIEWSHED)}get test(){}}var ul,Iy;c([p({readOnly:!0})],Xd.prototype,"fullResolutionAtmosphere",null),c([p()],Xd.prototype,"_edgeView",void 0),c([p()],Xd.prototype,"updating",null),function(i){i[i.Geometry=0]="Geometry",i[i.HUD=1]="HUD"}(ul||(ul={})),function(i){i[i.Color=0]="Color",i[i.LinearDepth=1]="LinearDepth",i[i.ShadowMap=2]="ShadowMap",i[i.HudVisibility=3]="HudVisibility",i[i.ViewshedShadowMap=4]="ViewshedShadowMap"}(Iy||(Iy={}));const Ly=[0,0,0,0],ym=[j.INTEGRATED_MESH,j.OPAQUE_TERRAIN,j.OPAQUE_MATERIAL,j.OPAQUE_NO_SSAO_DEPTH],_d=[j.TRANSPARENT_MATERIAL,j.TRANSPARENT_NO_SSAO_DEPTH],Os=new Gt,Ny=Qe(),Fy=Qe(),Xo=Qe();function D5(i){return e=>i.immediate.schedule(e)}class $5{constructor(e){this._rctx=e,this._vao=I5(e)}destroy(){this._vao=je(this._vao)}draw(){this._vao!=null&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(Ai.TRIANGLES,0,3))}get test(){}}function I5(i,e=ng,t=pt){const s=new Float32Array([-1,-1,3,-1,-1,3]);return new Rn(i,t,{geometry:e},{geometry:Ls.createVertex(i,xr.STATIC_DRAW,s)})}class L5 extends pO{constructor(e,t,s){super(e,t),this.gl=e,this.newCache=s,this._appleAmdDriverHelper=null,this._refCount=1,this.screen=new $5(this)}destroy(){--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){var e;super.dispose(),(e=this._appleAmdDriverHelper)==null||e.dispose(),this.screen.destroy()}bindTechnique(e,t,s,r,a){return this.useProgram(e.program),this.setPipelineState(e.getPipeline(!!a)),e.program.bindPass(s,t),r&&e.program.bindDraw(r,t,s),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??(this._appleAmdDriverHelper=new mO(this)),this._appleAmdDriverHelper.run())}get test(){}}function Vy(i){return!!i.frameUpdate}let il=class extends Re{constructor(i,e,t){super({}),this._stage=i,this._techniques=e,this._rctx=t,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new Pr,this._frameTask=i.view.resourceController.scheduler.registerTask(ci.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(O1.Texture,i=>i.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return this._textureTechnique==null&&(this._textureTechnique=this._techniques.acquire(qP,new zP)),this._textureTechnique}acquire(i){const e=this._textures.get(i);return e?(e.ref(),e.loadingPromise??e):this._createNewRef(i)}update(){let i=!1;this._frameUpdates.forEach(e=>{const t=e.texture.frameUpdate(e.previousToken);t>=0&&t!==e.previousToken&&(e.previousToken=t,i=!0)}),i&&this.events.emit("changed",st.BACKGROUND)}_createNewRef(i){const e=this._stage.getObject(i);if(e==null)return Cs(e!==void 0),null;const t=e.events.on("unloaded",()=>{t.remove(),this._onTextureUnloaded(i)}),s=new N5(i,()=>{this._frameTask.schedule(()=>{s.isUnreferenced&&e.unload()})});return this._textures.set(i,s),s.ref(),e.glTexture?(this._updateGLTexture(s,e.glTexture),Vy(e)&&this._frameUpdates.set(i,{texture:e,previousToken:-1}),s):(this._loadingCount++,s.loadingPromise=this._stage.schedule(()=>{const r=e.load(this._rctx),a=o=>(this._loadingCount--,s.loadingPromise=null,this._updateGLTexture(s,o),Vy(e)&&this._frameUpdates.set(i,{texture:e,previousToken:-1}),s),n=o=>(this._loadingCount--,s.loadingPromise=null,mn(o)||Pe.getLogger(this).error(o),null);return M_(r)?r.then(a,n):a(r)}),s.loadingPromise)}_updateGLTexture(i,e){i.glTexture=e,this.events.emit("changed",st.UPDATE)}_onTextureUnloaded(i){this._textures.delete(i),this._frameUpdates.delete(i)}};c([p()],il.prototype,"_loadingCount",void 0),c([p()],il.prototype,"_frameTask",void 0),c([p()],il.prototype,"updating",null),il=c([F("esri.views.3d.webgl-engine.lib.TextureRepository")],il);let N5=class{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(Pe.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}};function F5(i,e){return new BP(t=>HP(t,i),t=>t,e)}let wh=class extends Re{constructor(){super(...arguments),this._passParameters=new V5,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=Pn(this._resourcesTask),this._passParameters.waveNormal=je(this._passParameters.waveNormal),this._passParameters.wavePerturbation=je(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(i){return this._resourcesTask||(this._resourcesTask=cc(async e=>{await Promise.allSettled([this._loadImageResource(i,Gf("esri/images/materials/water/normals.jpg"),t=>this._passParameters.waveNormal=t,e),this._loadImageResource(i,Gf("esri/images/materials/water/perturbation.jpg"),t=>this._passParameters.wavePerturbation=t,e)])})),this._resourcesTask.finished?s0.LOADED:s0.LOADING}async _loadImageResource(i,e,t,s){try{const r=await Kh(e,{signal:s});Qi(s);const a=new gi(r.width,r.height);a.pixelFormat=_i.RGB,a.samplingMode=Zs.LINEAR_MIPMAP_LINEAR,a.hasMipmap=!0,a.maxAnisotropy=8,t(new Yi(i,a,r))}catch(r){Pe.getLogger(this).error("Failed to load water material normal texture.",r)}}};c([p()],wh.prototype,"_resourcesTask",void 0),c([p({type:Boolean,readOnly:!0})],wh.prototype,"updating",null),wh=c([F("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],wh);let V5=class extends ri{};class U5{constructor(e,t,s){this.parameters=e,this.frameHasDecorations=t,this.fbos=s}}class q5{constructor(e,t,s){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=s,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(st.BACKGROUND);const t=R_();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const s of this._screenshotQueue){if(this._rctx==null){s.resolver.reject();continue}const r={...s.settings,pixelRatio:s.settings.pixelRatio*e.parameters.camera.pixelRatio},a=this._renderScreenshot(e,r,t);s.resolver(a)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,s){e.width=t.width,e.height=t.height;const r=e.getContext("2d"),a=s.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),s.region&&r.translate(-s.region.x,-s.region.y),r.scale(a,a),t=this._renderFunctions.renderOverlay(e,s.disableDecorations?Ws.OFF:Ws.ON,t),r.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:s,framebufferHeight:r,region:a,resample:n}=e,o=this._ensureScreenshotEncodeCanvas();let l=gp(s,r,o);this._rctx.gl.readPixels(0,0,s,r,_i.RGBA,Da.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),t(),l=this._renderScreenshotOverlay(o,l,{...e,region:void 0});const h=gp(a.width,a.height,o);return zT(l,h,!0,n.region.x,r-(n.region.y+n.region.height),n.region.width,n.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:s,region:r}=e,a=this._ensureScreenshotEncodeCanvas(),n=gp(r.width,r.height,a);return this._rctx.gl.readPixels(r.x,s-(r.y+r.height),r.width,r.height,_i.RGBA,Da.UNSIGNED_BYTE,new Uint8Array(n.data.buffer)),t(),this._renderScreenshotOverlay(a,n,e)}_renderScreenshot(e,t,s){const r=e.parameters.camera,a={width:t.framebufferWidth,height:t.framebufferHeight};Y_(a,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let n=!1;const o=t.disableDecorations&&e.frameHasDecorations,l=a.width!==r.fullWidth||a.height!==r.fullHeight,h=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,d=l||o||h||t.objectAndLayerIdColor;let u=null,m=null;if(d){const y=r.clone();if(t.ignorePadding){const C=y1(y.padding);for(let P=0;P<4;P++)C[P]=Math.round(C[P]/y.pixelRatio*t.pixelRatio);y.padding=C}y.fullWidth=a.width,y.fullHeight=a.height,y.pixelRatio=t.pixelRatio;const w=r.fovX-y.fovX,x=r.fovY-y.fovY;w<0&&w<x?y.fovX=r.fovX:x<0&&x<w&&(y.fovY=r.fovY);const T={camera:y,contentCamera:y,mode:ft.IDLE,alignPixelEnabled:!0,contentPixelRatio:y.pixelRatio};this._forceCameraHook(T),n=!0;const S=this._renderFunctions.renderScene(T,s,t.objectAndLayerIdColor?wa.ObjectAndLayerID:wa.Screenshot,t.disableDecorations?Ws.OFF:Ws.ON);m=S.screen,u=S.oid}const _=()=>{this._rctx.bindFramebuffer(null),m==null||m.release()};this._rctx.bindFramebuffer(m==null?void 0:m.fbo);const f=this._readbackScreenshot(t,_);let g=null;if(t.objectAndLayerIdColor){const y=()=>{this._rctx.bindFramebuffer(null),u==null||u.release()};this._rctx.bindFramebuffer(u==null?void 0:u.fbo),g=this._readbackScreenshot(t,y),this._rctx.bindFramebuffer(null)}if(d&&!this._rctx.contextAttributes.alpha)for(let y=3;y<f.data.length;y+=4)f.data[y]=255;if(g&&!this._rctx.contextAttributes.alpha)for(let y=3;y<g.data.length;y+=4)g.data[y]=255;return n&&this._forceCameraHook(e.parameters),[f,g]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}let Pi=class extends Re{constructor(i){super({}),this.events=new Pr,this.waterTextures=new wh,this.objectAndLayerIdRenderHelper=li("enable-feature:objectAndLayerId-rendering")?new QN:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=i.container,this._viewingMode=i.viewingMode;try{this._initializeContext(i)}catch(s){return void console.error("Failed to initialize context",s)}const{memoryController:e}=i.view.resourceController;this.stippleTextures=GP(this._rctx,e),this.markerTextures=F5(this._rctx,e),this._techniques=new kP({rctx:this._rctx,viewingMode:i.viewingMode,stippleTextures:this.stippleTextures,waterTextures:this.waterTextures,markerTextures:this.markerTextures}),this._textures=new il(i,this._techniques,this._rctx),this.addHandles(this._textures.events.on("changed",s=>this.requestRender(s))),this._materials=new jP(this._textures,this._techniques,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new DN(this._rctx,this._techniques),this.renderer=new Xd(i,this._materials,this._techniques,this._rctx,this._compositingHelper,s=>this.requestRender(s)),this.addHandles([M(()=>i.view.ready,s=>{s&&this._createRenderNodes(i.view,i.viewingMode)},si),M(()=>{var s;return(s=this.waterTextures)==null?void 0:s.updating},()=>this.requestRender(),si),M(()=>i.view.qualityProfile,s=>{var r;return(r=this.renderer)==null?void 0:r.updateRenderFeatures(s)},ut)]);const t={renderScene:(s,r,a,n)=>this.renderer.render(s,r,a,n),requestRenderScene:s=>this.requestRender(s),prepareOverlay:()=>i.options.screenshot.prepareOverlay(),renderOverlay:(s,r,a)=>i.options.screenshot.renderOverlay(s,r,a)};this._screenshotManager=new q5(this._rctx,t,s=>this.events.emit("force-camera-for-screenshot",s)),this._registerFrameTask(i)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=Zr(this._frameTask),this._techniques=Y(this._techniques),this._componentObjects=Y(this._componentObjects),this._screenshotManager=Y(this._screenshotManager),Y(this.renderer),this._textures=Y(this._textures),Y(this.waterTextures),Y(this.markerTextures),Y(this.stippleTextures),this._canvas=null,this._container=null,this._rctx=Y(this._rctx)}_createRenderNodes(i,e){new OR({view:i,isEnabled:()=>this.renderer.hasSSAO,techniques:this._techniques}),new Ka({view:i,isEnabled:()=>this.renderer.hasSMAA,techniques:this._techniques}),new Za({view:i,techniques:this._techniques}),new tl({view:i,techniques:this._techniques}),new Yn({view:i,viewingMode:e,techniques:this._techniques})}requestRender(i=st.UPDATE){this._needsRender=!0,i===st.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get compositingHelper(){return this._compositingHelper}setIdleSuspend(i){this._idleSuspend!==i&&(this._idleSuspend=i,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(i){return this._screenshotManager.takeScreenshot(i).then(e=>e[0])}takeScreenshotWithOID(i){return i.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(i)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(i,e,t,s,r,a=r){const n=s.constrainWindowSize(e,t,r*s.pixelRatio,a*s.pixelRatio),o=this._ensureDepthBuffer(n);this.renderer.readDepthPixels(n,o);let l=Number.MAX_VALUE;for(let h=0;h<n[2]*n[3];h++){const d=FN(4*h,o,s.nearFar);l>d&&d!==s.nearFar[0]&&d!==s.nearFar[1]&&(l=d)}if(i){const h=i.pickDepth(e*s.pixelRatio,t*s.pixelRatio,s);h!=null&&l>h&&h!==s.nearFar[0]&&h!==s.nearFar[1]&&(l=h)}return l===Number.MAX_VALUE?void 0:l}_ensureDepthBuffer(i){const e=4*i[2]*i[3];return(this._tmpDepthBuffer==null||this._tmpDepthBuffer.byteLength<e)&&(this._tmpDepthBuffer=new Uint8Array(e)),this._tmpDepthBuffer}async reloadShaders(){yw(),await this._techniques.reloadAll(),this.requestRender()}_registerFrameTask(i){const e=i.view.state;let t=!1,s=st.BACKGROUND,r=!1;const a={preRender:({time:n})=>{t=this.updating,s=this._needsUpdate?st.UPDATE:st.BACKGROUND,i.commitSyncLayers();const o=ct(n-this._lastAnimationUpdate);if(o>this.renderer.animationTimestep||e.forcedAnimationTime!=null||t||this._needsRender){const l=ct(o/this.renderer.animationTimeDilation),h=new R1(e.camera,l,e.forcedAnimationTime);this.renderer.updateAnimation(h)&&this.requestRender(st.BACKGROUND),this._lastAnimationUpdate=n}},render:({time:n})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&e.camera.fullWidth>0&&e.camera.fullHeight>0){const o=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this.renderer.render(e,n),r=!0,o&&this.renderer.hasReflections&&(this.requestRender(st.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:n})=>{const o=this.renderer.hasSlicePlane||this.renderer.hasDecorations||this.renderer.hasHighlights,l=new U5(e,o,this.renderer.fboCache);this._textures.update(),this._screenshotManager.update(l,n)},finish:()=>{r&&(this.renderer.finish(e.mode===ft.IDLE?s:st.UPDATE),r=!1)}};this._frameTask=Iu(a)}_initializeContext(i){const e=i.options;this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:e.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:e.preserveDrawingBuffer??!1},s=_O(this._canvas,t);s!=null?(this._rctx=z5(s,i),this._loadShaderOnlyExtensions(),!e.alpha&&this._rctx.contextAttributes.alpha&&Pe.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&li("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)):Pe.getLogger(this).error("A WebGL2 context could not be created.")}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}getObjectAndLayerIdColor(i){return this.objectAndLayerIdRenderHelper!=null?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(i):null}get componentObjectCollection(){return this._componentObjects==null&&(this._componentObjects=new nN(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(i){this._componentObjects=i}};function z5(i,e){const t={disabledExtensions:e.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.options.debugWebGLExtensions||{},maxAnisotropy:8},s=(r,a)=>e.view.resourceController.memoryController.newCache(r,a);return new L5(i,t,s)}c([p({type:Boolean,readOnly:!0})],Pi.prototype,"updating",null),c([p()],Pi.prototype,"_rctx",void 0),c([p()],Pi.prototype,"_container",void 0),c([p()],Pi.prototype,"_canvas",void 0),c([p()],Pi.prototype,"stippleTextures",void 0),c([p()],Pi.prototype,"markerTextures",void 0),c([p()],Pi.prototype,"waterTextures",void 0),c([p({readOnly:!0})],Pi.prototype,"objectAndLayerIdRenderHelper",void 0),c([p()],Pi.prototype,"_textures",void 0),c([p({readOnly:!0})],Pi.prototype,"renderer",void 0),c([p()],Pi.prototype,"_screenshotManager",void 0),c([p()],Pi.prototype,"componentObjectCollection",null),c([p()],Pi.prototype,"_componentObjects",void 0),c([p()],Pi.prototype,"_needsUpdate",void 0),c([p()],Pi.prototype,"_needsWaterReflectionUpdate",void 0),Pi=c([F("esri.views.3d.webgl-engine.parts.RenderView")],Pi);let Es=class extends Re{constructor(i){super(i),this._model=new zd,this._layers=new Gt,this._asyncChangeSet=new qf,this._syncChangeSet=new qf,this._layerSyncSet=new Set}initialize(){this._set("renderView",new Pi(this)),this._frameTask=this.view.resourceController.scheduler.registerTask(ci.STAGE,this),this.addHandles(this._frameTask)}destroy(){this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){var i;return(i=this.renderView)==null?void 0:i.renderer}add(i){this._model.add(i),nu(i)&&this._addLayer(i),this.renderView.requestRender()}remove(i){i!=null&&!this.destroyed&&this._model.remove(i)&&(nu(i)&&this._removeLayer(i),this.renderView.requestRender())}addMany(i){i!=null&&(this._model.addMany(i),this.renderView.requestRender())}removeMany(i){var e,t;i!=null&&((e=this._model)==null||e.removeMany(i),(t=this.renderView)==null||t.requestRender())}forEachOfType(i,e){this._model.forEachOfType(i,e)}handleEvent(i,e){this.destroyed||(this._model.dirtySet[i](e),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(i){if(this._frameTask.processQueue(i),this._commit(i),!i.hasProgressed)return Zi}_commit(i){const e=this._model.dirtySet;this._asyncChangeSet.empty||i.done||(this.renderer.modify(this._asyncChangeSet,i),this.renderView.requestRender(),i.madeProgress()),this._layers.forAll(t=>{if(i.done)return;const s=this._layerSyncSet.has(t.id)||t.updatePolicy===pp.SYNC,r=s?this._syncChangeSet:this._asyncChangeSet;e.commitLayer(t.id,r),this._layerSyncSet.delete(t.id),r.empty||(this.renderer.modify(r,s?Ta:i),this.renderView.requestRender(),i.madeProgress())}),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ta),this.renderView.requestRender(),i.madeProgress()),this._layers.forAll(t=>{i.done||this._layerSyncSet.has(t.id)||t.updatePolicy!==pp.ASYNC||(e.commitLayer(t.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,i),this.renderView.requestRender(),i.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const i=this._model.dirtySet;this._layers.forAll(e=>{this._layerSyncSet.has(e.id)||e.updatePolicy===pp.SYNC?(i.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id)):i.commitSyncUpdates(e.id,this._syncChangeSet)});for(const e of this._layerSyncSet)i.commitLayer(e,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ta),this.renderView.requestRender())}_commitLayer(i){this._model.dirtySet.commitLayer(i.id,this._syncChangeSet),this._layerSyncSet.delete(i.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ta),this.renderView.requestRender())}schedule(i,e){return this._frameTask.schedule(i,e)}reschedule(i,e){return this._frameTask.reschedule(i,e)}syncLayer(i){this._layerSyncSet.add(i),this.renderView.requestRender()}getObject(i){return this._model.getObject(i)}get layers(){return this._layers}_addLayer(i){this._layers.includes(i)||this._layers.push(i)}_removeLayer(i){this._commitLayer(i),this._layers.removeUnordered(i)!=null&&(this._model.dirtySet.getResidentRenderGeometries(i.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,Ta))}addRenderPlugin(i,e){const t=this.renderer.plugins.add(i,e),s=()=>{Pv(i)&&this.view.sceneIntersectionHelper.addIntersectionHandler(i)};if(M_(t))return t.then(s);s()}removeRenderPlugin(i){this.destroyed||(Pv(i)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(i),this.renderer.plugins.remove(i))}get performanceInfo(){return this._model.getStats()}get test(){}};Es.DebugSettings={endFrameContentValidation:!1},c([p({constructOnly:!0})],Es.prototype,"view",void 0),c([p({constructOnly:!0})],Es.prototype,"options",void 0),c([p({readOnly:!0})],Es.prototype,"viewingMode",null),c([p({constructOnly:!0})],Es.prototype,"container",void 0),c([p({readOnly:!0})],Es.prototype,"updating",null),c([p({constructOnly:!0})],Es.prototype,"_model",void 0),c([p()],Es.prototype,"renderView",void 0),c([p({readOnly:!0})],Es.prototype,"renderer",null),c([p({readOnly:!0})],Es.prototype,"running",null),Es=c([F("esri.views.3d.webgl-engine.Stage")],Es);let Yd=class extends s1{constructor(i){super(i),this.components=["attribution","zoom","navigation-toggle","compass"]}};c([p()],Yd.prototype,"components",void 0),Yd=c([F("esri.views.ui.3d.DefaultUI3D")],Yd);const pC=Yd;let X=class extends BT(HT(GT(QT))){constructor(i){super(i),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new xn({slicePlane:CT},this),this._resourceController=b$(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new c_({view:this}),this.labeler=new Qn({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new r1,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new to,this.environment=new Jo,this.environmentManager=new ar,this.floors=new Qr,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new xO({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new QD,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new pC,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.highlightOptions=new _w,FC();const e=(t=null)=>{t!=null&&t.type===of.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(async s=>{try{await s.when()}catch{}this._updatingChanged()}))};this.addHandles([Ma(()=>{var t;return(t=this.map)==null?void 0:t.allLayers},"after-changes",t=>e(t),{onListenerAdd:()=>e(),onListenerRemove:()=>e(),sync:!0}),this.allLayerViews.on("after-changes",t=>this._updateUpdatingMonitors(t)),M(()=>this.map,t=>{t&&"load"in t&&t.load&&t.load().catch(()=>{})})]),this.inputManager=new mA({view:this}),this.stateManager=new zt({view:this})}initialize(){this.groundView=new bO({view:this}),this._updateUpdatingMonitors();const i=()=>this._updateDefaultToMapOptions();this.addHandles(Ma(()=>{var e;return(e=this.map)==null?void 0:e.allLayers},"after-changes",i,{onListenerAdd:i,onListenerRemove:i})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},si),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},si),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,e=>LC(e>0?1e3/Math.ceil(e):0),si),this.updatingHandles.add(()=>{var e;return(e=this.map)==null?void 0:e.ground},i,ut),this.updatingHandles.add(()=>{var e,t;return(t=(e=this.map)==null?void 0:e.ground)==null?void 0:t.opacity},()=>this._updateDefaultHitTestOptions(),ut),this.addHandles(M(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),nt))}destroy(){var i;this.destroyed||(this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=Y(this.sharedSymbolResources),this._set("labeler",Y(this.labeler)),this._set("deconflictor",Y(this.deconflictor)),this._resourceController=Y(this._resourceController),this._set("stateManager",Y(this.stateManager)),this._set("inputManager",Y(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",Y(this.environmentManager)),this._set("environment",Y(this.environment)),this.groundView=Y(this.groundView),this._exitBasemapTerrain(),(i=this._stage)==null||i.destroy())}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){var i;return(i=this.basemapTerrain)==null?void 0:i.spatialReference}get animation(){var i;return(i=this.state)==null?void 0:i.animation}get camera(){var i;return(i=this.stateManager)==null?void 0:i.camera}set camera(i){this.stateManager&&(this.stateManager.camera=i)}get contentCamera(){var i;return(i=this.stateManager)==null?void 0:i.contentCamera}set contentCamera(i){this.stateManager&&(this.stateManager.contentCamera=i)}installContentCameraReset(i={sticky:!1}){return this.stateManager.installContentCameraReset(i)}get center(){var i;return(i=this.stateManager)==null?void 0:i.center}set center(i){this.stateManager&&(this.stateManager.center=i)}get clippingArea(){if(this.viewingMode==="global")return null;const i=this.map;let e=this._userClippingArea||uf(i,"clippingArea");return!this._userClippingArea&&!uf(i,"clippingEnabled")||e==null?(this._clippingArea=null,null):e instanceof zr?this.spatialReference&&(e=gd(e,this.spatialReference),e==null)?(Pe.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),e.intersection(this._groundAndLayersExtent)==null&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(Pe.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(i){this.ready&&this.viewingMode==="global"&&i!=null?Pe.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=i}get renderDataExtent(){if(this.state.viewingMode===$e.Global)return null;const i=this.renderSpatialReference,e=this.dataExtent;return e==null||i==null||e.spatialReference.equals(i)?e:gd(e,i)}get tileInfo(){var i,e;return(e=(i=this.basemapTerrain)==null?void 0:i.tilingScheme)==null?void 0:e.toTileInfo()}get dataExtent(){let i=this._groundAndLayersExtent;const e=this.spatialReference||pi.WGS84,t=gd(this.clippingArea,e);t!=null&&(i=i!=null?i.intersection(t):t);const s=this._get("dataExtent");return i!=null&&i.equals(s)?s:i}get _groundAndLayersExtent(){const i=this.spatialReference||pi.WGS84;let e;const t=a=>{const n=gd(a,i);n!=null&&(e!=null?e.union(n):e=n.clone())},s=this.basemapTerrain;if(s!=null&&s.spatialReference){const a=s.groundExtent;t(new zr({xmin:a[0],ymin:a[1],zmin:0,xmax:a[2],ymax:a[3],zmax:0,spatialReference:s.spatialReference}))}if(this.map){const a=n=>{n.fullExtent==null||n.type==="graphics"&&n.internal||t(n.fullExtent)};this.map.allLayers.forEach(n=>a(n))}if(e==null)return null;e.hasZ?(e.zmin=Math.min(0,e.zmin??0),e.zmax=Math.max(0,e.zmax??0)):(e.zmin=0,e.zmax=0);const r=this._get("_groundAndLayersExtent");return e.equals(r)?r:e}castEnvironment(i){var e;return i?i instanceof Jo?i:i instanceof g1?((e=this.environment)==null?void 0:e.cloneWithWebsceneEnvironment(i))??Jo.fromWebsceneEnvironment(i):SC(Jo,i):new Jo}get extent(){var i;return(i=this.stateManager)==null?void 0:i.extent}set extent(i){this.stateManager&&(this.stateManager.extent=i)}get screenCenter(){var i;return(i=this.stateManager)==null?void 0:i.screenCenter}get frustum(){var i;return(i=this.stateManager)==null?void 0:i.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){var i;return this.navigating||(((i=this.toolViewManager)==null?void 0:i.interacting)??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state==null||this.state.stationary)}get navigating(){var i;return((i=this.state)==null?void 0:i.navigating)??!1}get padding(){var i;return(i=this.stateManager)==null?void 0:i.padding}set padding(i){this.stateManager&&(this.stateManager.padding=i)}set qualityProfile(i){Ad.isValidProfile(i)&&(Ad.apply(i,this.qualitySettings),this._set("qualityProfile",i))}get qualityProfile(){return this._get("qualityProfile")||Ad.getDefaultProfile()}set slicePlane(i){if(this._stage!=null&&this._stage.renderer.setParameters({slicePlane:i}),i==null)return void this._set("slicePlane",null);const e=this._propertiesPool.get("slicePlane");A_(i,e),this._set("slicePlane",e)}get typeSpecificPreconditionsReady(){var i;return!!this.viewingMode&&!!((i=this.stateManager)!=null&&i.preinit(this.spatialReference))}get resolution(){return this.spatialReference!=null?PT(this.scale,this.spatialReference):0}get scale(){var i;return(i=this.stateManager)==null?void 0:i.scale}set scale(i){this.stateManager&&(this.stateManager.scale=i)}get terrainScale(){var i;return(i=this.stateManager)==null?void 0:i.terrainScale}get heightModelInfo(){const i=this.getDefaultHeightModelInfo();return i!=null?QC.deriveUnitFromSR(i,this.spatialReference):null}get updating(){var r,a,n,o;if(this.destroyed)return!1;let i=0,e=this.layerViewManager.updating,t=e?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(l=>{if(l.isFulfilled()){if(l.updating){if(e=!0,l.suspended||Am(l))return;++t,i+=l.updatingProgress}}else++t});for(const l of this._updatingObjects)l!=null&&l.updating&&(t+=.1,i+=.5*.1);for(const l of this._updatingObjectsWithProgress)l!=null&&l.updating&&(++t,i+=l.updatingProgress);const s=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(e=!!(e||t>0||this.updatingHandles.updating||!this.ready||!this.stationary||s||this._createGraphicsViewController||(r=this.inputManager)!=null&&r.updating||(n=(a=this.map)==null?void 0:a.allLayers)!=null&&n.some(l=>!l.isFulfilled())||(o=this.textures)!=null&&o.updating),e?(this._numUpdating=Math.max(t,this._numUpdating),i+=this._numUpdating-t):this._numUpdating=0,this._numUpdating>0?i/=this._numUpdating:i=e?0:1,this._get("updatingProgress")!==i){const l=performance.now();if(i<1){const h=Math.min((l-this._lastUpdateTime)/2e3,1);i=this.updatingProgress*(1-h)+i*h}this._set("updatingProgress",i),this._lastUpdateTime=e&&i<1?l:0}return e}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){var t;const i=this._predeterminedViewingMode;if(i!=null)return cp(i);const e=this.spatialReference;return e?((t=this.defaultsFromMap)==null?void 0:t.viewingMode)!=null&&e.equals(this.defaultsFromMap.spatialReference)?cp(this.defaultsFromMap.viewingMode):n0(e,$e.Global)?"global":"local":"global"}set viewingMode(i){this.ready?Pe.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",i)}get viewpoint(){var i;return(i=this.stateManager)==null?void 0:i.viewpoint}set viewpoint(i){this.stateManager&&(this.stateManager.viewpoint=i)}get zoom(){return this.stateManager.zoom}set zoom(i){this.stateManager&&(this.stateManager.zoom=i)}get resourceController(){return this._resourceController}get quality(){var i,e;return((e=(i=this._resourceController)==null?void 0:i.memoryController)==null?void 0:e.memoryFactor)??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new x$(this)}on(i,e,t,s){return this.viewEvents.on(i,e,t,s)||super.on(i,e)}hasEventListener(i){return super.hasEventListener(i)||this.viewEvents.hasHandler(i)}toMap(i,e){if(!this.ready)return Pe.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const t=r0(i)?a0(this,i):i;return rR(this,t,e,this._defaultToMapOptions)}toScreen(i){if(!this.ready)return Pe.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const e=(i.z==null?w2(this.elevationProvider,i):null)??0;return zh(i,fd,this.renderSpatialReference,e),this.state.camera.projectToScreen(fd,bm),Gy(bm[0],bm[1])}pixelSizeAt(i){return this.ready?i?(zh(i,fd,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(fd)):0:(Pe.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(i){const e=this.basemapTerrain.overlayManager;return e?e.overlayPixelSizeInMapUnits(i,()=>this.pixelSizeAt(i)):1}hitTest(i,e){if(!this.ready)return Pe.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const t=r0(i)?a0(this,i):i;return aR(this,t,e,this._defaultHitTestOptions)}async popupHitTest(i){return t$(this,i)}goTo(i,e){return this.updatingHandles.addPromise(this.stateManager.goTo(i,e))}async whenAnalysisView(i){if(i.parent==null)throw new xs("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:i});switch(i.parent.type){case"line-of-sight":case"dimension":return(await this.whenLayerView(i.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(i)}}whenLayerView(i){return super.whenLayerView(i)}async takeScreenshot(i){const e=this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshot(e);return op(t,e,this._pixelFormat())}async _takeScreenshot(i){const e=this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshot(e);return lp(t,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(i){const e=this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshotWithOID(e);return[lp(t[0],this._pixelFormat()),lp(t[1],this._pixelFormat())]}_completeSettings(i){const e=kT(i,this);return e.pixelRatio/=this.state.pixelRatio,jT(e,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){}async takeScreenshotWithObjectAndLayerId(i){if(!li("enable-feature:objectAndLayerId-rendering"))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");const e=this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshotWithOID(e),s=op(t[0],e,this._pixelFormat()),r=this._completeSettings(i);return r.format="png",[s,op(t[1],r,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){if(this._stage.renderView.objectAndLayerIdRenderHelper==null)throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}addUpdatingPromise(i){return this.updatingHandles.addPromise(i)}importLayerView(i){return h0.importLayerView(i)}hasLayerViewModule(i){return h0.hasLayerViewModule(i)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var i,e,t;return this.map&&"initialViewProperties"in this.map&&((i=this.map.initialViewProperties)==null?void 0:i.spatialReference)||((e=this.defaultsFromMap)==null?void 0:e.spatialReference)||((t=this.defaultsFromMap)==null?void 0:t.ready)&&this._initialDefaultSpatialReference||null}async validate(){let i=WT(this.type);const e=li("safari");if(e&&e<9&&(i=new xs("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:e})),i!=null)throw Pe.getLogger(this).warn("#validate()",i.message),i}get _predeterminedViewingMode(){var e;const i=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?(e=this.map.initialViewProperties)==null?void 0:e.viewingMode:null)??null;return i!=null?If(i):null}getSpatialReferenceSupport(i,e){const t=this._predeterminedViewingMode;if(t!=null)return this._validateSpatialReferenceForViewingMode(i,e,t)?{constraints:this._makeSpatialReferenceConstraints(i,e,t)}:null;const s=this._validateSpatialReferenceForViewingMode(i,e,$e.Local),r=this._validateSpatialReferenceForViewingMode(i,e,$e.Global);return s||r?s&&r?{constraints:this._makeSpatialReferenceConstraints(i,e,null)}:s?{constraints:this._makeSpatialReferenceConstraints(i,e,$e.Local)}:{constraints:this._makeSpatialReferenceConstraints(i,e,$e.Global)}:null}_validateSpatialReferenceForViewingMode(i,e,t){return!!n0(i,t)&&(e==null||!!wf(e)||(!Th(e)||Vu(e,i,t)!=null)&&(!xf(e)||t!==$e.Global))}_makeSpatialReferenceConstraints(i,e,t){if(e==null)return[{spatialReference:i,viewingMode:t}];const{isWebMercator:s,isWGS84:r}=i;return wf(e)&&(s||r)?!r||t===$e.Local||AS(e.tileInfo,e.fullExtent,i,$e.Global)===null?[{spatialReference:i,viewingMode:t},{spatialReference:pi.WebMercator,viewingMode:t}]:[{spatialReference:s?pi.WGS84:pi.WebMercator,viewingMode:t}]:Th(e)||xf(e)||!s&&!r?Th(e)&&s&&t!==$e.Global?[{spatialReference:i,viewingMode:t},{spatialReference:pi.WGS84,viewingMode:$e.Local}]:[{spatialReference:i,viewingMode:t}]:[{spatialReference:i,viewingMode:t},{spatialReference:s?pi.WGS84:pi.WebMercator,viewingMode:t}]}_validateSpatialReference(i){const e=this.getSpatialReferenceSupport(i)!=null,t=this._predeterminedViewingMode;return e||(t!=null?Pe.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${cp(t)} viewing mode.`):i.isGeographic&&Pe.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),e}whenReady(){return new Promise(i=>{this.ready?i(this):this._resolveWhenReady.push(i)})}trackGraphicState(i){if(!i.graphic)return Pe.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const e=this.getViewForGraphic(i.graphic);let t=null,s=!1;const r=a=>{var n;!s&&a!=null&&"processor"in a&&((n=a.processor)==null?void 0:n.type)==="graphics-3d"&&a.processor.graphicsCore&&(t=a.processor.graphicsCore.trackGraphicState(i))};return e!=null?r(e):this.whenViewForGraphic(i.graphic,{waitForLayer:!0}).then(a=>r(a),()=>{}).catch(()=>{}),on(()=>{s=!0,t!=null&&(t.remove(),t=null)})}highlight(i){if(Array.isArray(i))return hf(i.map(t=>this.highlight(t)));if(Qr.isCollection(i))return hf(i.toArray().map(t=>this.highlight(t)));const e=this.getViewForGraphic(i);return e&&"highlight"in e?e.highlight(i):on()}maskOccludee(i){if(!i)return Pe.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const e=this.getViewForGraphic(i);let t=null,s=!1;const r=a=>{!s&&a!=null&&gO(a)&&(t=a.maskOccludee(i))};return e!=null?r(e):this.whenViewForGraphic(i,{waitForLayer:!0}).then(a=>r(a),()=>{}).catch(()=>{}),on(()=>{s=!0,t!=null&&(t.remove(),t=null)})}getViewForGraphic(i){return i.layer===this.graphics?this.graphicsView:i.layer?this.allLayerViews.find(e=>e.layer===i.layer):null}graphicChanged(i){this.graphicsView!=null&&this.graphicsView.graphicChanged(i)}async whenViewForGraphic(i,e){if(i.layer===this)return await wm(()=>this.graphicsView),this.graphicsView;if(!i.layer||!this.map)throw new xs("no-view-for-graphic");return e&&e.waitForLayer&&!this.map.allLayers.includes(i.layer)?new Promise((t,s)=>{const r=this.map.allLayers.on("change",a=>{a.added.includes(i.layer)&&(r.remove(),this.whenLayerView(i.layer).then(t,s))})}):this.whenLayerView(i.layer)}_initBasemapTerrain(){this._set("basemapTerrain",new ZL({view:this})),this._set("elevationProvider",new ph({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new rs({view:this})),this._set("featureTiles",new vi({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const i=()=>{var t;const e=(t=this.basemapTerrain)==null?void 0:t.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const s=this.basemapTerrain.extent!=null&&this.basemapTerrain.spatialReference!=null?Qy(Zy(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;this.clippingArea!=null?this.featureTiles.filterExtent=this.clippingArea.intersection(s):this.featureTiles.filterExtent=s}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add(()=>Ts.FEATURE_TILE_TREE_SHOW_TILES,e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(ae(()=>import("./FeatureTileTree3DDebugger-BaHNP4BP.js"),__vite__mapDeps([528,1,2,3,30,14,10,11,12,13,5,6,15,9,7,8,180,524,32,33,85,86,40,27,28,29,26,87,88,25,31,34,35,36,37,22,38,39,89]),import.meta.url)).then(({FeatureTileTree3DDebugger:t})=>{!this._featureTreeDebugger&&Ts.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new t({view:this}))}):e||!this._featureTreeDebugger||Ts.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)},ut),this.updatingHandles.add(()=>this.clippingArea,i,ut),this.updatingHandles.add(()=>this.basemapTerrain.extent,i,ut)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const i=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(i)||this._set("mapCoordsHelper",new e$(this.map,i));const e=this.state.isGlobal,t=TT(e,i);t!==this.renderSpatialReference&&(this._set("renderCoordsHelper",ST.create(this.state.viewingMode,t)),e||this.addHandles(M(()=>{var s;return(s=this.basemapTerrain)==null?void 0:s.extent},s=>{const r=this.renderCoordsHelper.spatialReference;s==null||s[0]===0&&s[1]===0&&s[2]===0&&s[3]===0||!Yy(s,this.basemapTerrain.spatialReference,Uy,r)||(this.renderCoordsHelper.extent=Uy)},nt),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(pu/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(i=null){i!=null&&i.type===of.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.addHandles(M(()=>[e.updating,e.updatingProgress],()=>this._updatingChanged(),nt),"updatingMonitors"),e.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(i,e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const s=i.getContext("2d");return s.putImageData(t,0,0),this.overlay.renderCanvas(i,{disableDecorations:e===Ws.OFF}),s.getImageData(0,0,t.width,t.height)}_initStage(){const i={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(s,r,a)=>this._renderScreenshotOverlay(s,r,a)}},e=new YD(this.state.viewingMode,s=>this._stage.layers.forAll(s),this);this._set("sceneIntersectionHelper",e);const t=vC(this.surface);this._stage=new Es({view:this,options:i,container:t}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this.addHandles([this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,s=>this._stage.renderer.setParameters({highQualityTransparency:s}),si),this.on("pointer-move",()=>{var s;return(s=this._stage)==null?void 0:s.renderer.resetAnimation()}),NC(this._stage.renderView.canvas,"webglcontextlost",s=>{this.fatalError=new xs("webgl-context-lost",s.statusMessage)})],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(pu/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=Y(this._stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(i){this._exitSurface(),this.state.init(i,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new P$({view:this,viewingMode:i,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;const i=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(i,i),this._updatingChanged()}async _createGraphicsViewAsync(i){const e=(await ae(async()=>{const{default:t}=await import("./GraphicsView3D-DQ96X9Rd.js");return{default:t}},__vite__mapDeps([529,1,2,3,88,407,85,30,14,10,11,12,13,5,6,15,9,86,40,7,8,27,28,29,26,32,33,87,25,31,34,35,36,37,22,38,39,89,282,180,215,191,192,84,90,16,17,91,4,24,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,217,218,219,367,280,281,283,284,285,286,287,288,289,290,291,368,213,205,206,207,208,369,370,371,372,203,199,193,175]),import.meta.url)).default;Qi(i),await wm(()=>{var t;return(t=this.basemapTerrain)==null?void 0:t.ready},i),this._set("graphicsView",new e({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),this.graphicsView!=null&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const i=If(this.viewingMode);i===$e.Global&&(this._clippingArea=null),this._initSurface(i),this._set("ready",!0),this.addHandles(Ma(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded();const e=this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties:null,t=e==null?void 0:e.environment;t&&hb(this.environment,t),this.timeExtent=e==null?void 0:e.timeExtent,this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect(),this._set("textures",new hl(this._stage,this.resourceController.scheduler));const s=this._resolveWhenReady;this._resolveWhenReady=[],s.forEach(r=>r(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._set("textures",Y(this.textures)),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Xh);for(const i of this.map.allLayers.items)Rm(i.type)&&this._defaultToMapOptions.include.add(i.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Xh);for(const i of this.map.allLayers.items)Rm(i.type)&&i.opacity<1&&this._defaultHitTestOptions.exclude.add(i.uid)}}};function gd(i,e){return i!=null&&Cm(i.spatialReference,e)?Qy(i,e):null}X.type="3d",c([p()],X.prototype,"_userClippingArea",void 0),c([p()],X.prototype,"_resourceController",void 0),c([p()],X.prototype,"_stage",void 0),c([p({readOnly:!0})],X.prototype,"deconflictor",void 0),c([p({readOnly:!0})],X.prototype,"labeler",void 0),c([p(WC(r1,"analyses"))],X.prototype,"analyses",void 0),c([p({type:xl,readOnly:!0})],X.prototype,"animation",null),c([p({readOnly:!0})],X.prototype,"basemapTerrain",void 0),c([p({readOnly:!0})],X.prototype,"elevationProvider",void 0),c([p()],X.prototype,"camera",null),c([p({type:_o})],X.prototype,"contentCamera",null),c([p({readOnly:!0})],X.prototype,"canvas",void 0),c([p({type:ea})],X.prototype,"center",null),c([p({type:zr})],X.prototype,"clippingArea",null),c([p({type:to})],X.prototype,"constraints",void 0),c([p({type:zr,readOnly:!0})],X.prototype,"renderDataExtent",null),c([p({readOnly:!0})],X.prototype,"tileInfo",null),c([p({type:zr,readOnly:!0})],X.prototype,"dataExtent",null),c([p({type:zr,readOnly:!0})],X.prototype,"_groundAndLayersExtent",null),c([p({type:Jo})],X.prototype,"environment",void 0),c([bl("environment")],X.prototype,"castEnvironment",null),c([p({readOnly:!0})],X.prototype,"environmentManager",void 0),c([p({type:zr})],X.prototype,"extent",null),c([p()],X.prototype,"floors",void 0),c([p()],X.prototype,"screenCenter",null),c([p()],X.prototype,"frustum",null),c([p({type:Number,readOnly:!0})],X.prototype,"fullOpacity",void 0),c([p({readOnly:!0})],X.prototype,"graphicsView",void 0),c([p({readOnly:!0})],X.prototype,"analysisViewManager",void 0),c([p()],X.prototype,"groundView",void 0),c([p({type:Boolean})],X.prototype,"initialExtentRequired",null),c([p()],X.prototype,"_defaultsFromMapSettings",null),c([p()],X.prototype,"interacting",null),c([p()],X.prototype,"stationary",null),c([p()],X.prototype,"navigating",null),c([p()],X.prototype,"map",void 0),c([p({readOnly:!0})],X.prototype,"mapCoordsHelper",void 0),c([p()],X.prototype,"padding",null),c([p({type:rs,readOnly:!0})],X.prototype,"pointsOfInterest",void 0),c([p({type:vi,readOnly:!0})],X.prototype,"featureTiles",void 0),c([p()],X.prototype,"_featureTreeDebugger",void 0),c([p({type:Boolean})],X.prototype,"screenSizePerspectiveEnabled",void 0),c([p({constructOnly:!0})],X.prototype,"deactivatedWebGLExtensions",void 0),c([p({constructOnly:!0})],X.prototype,"debugWebGLExtensions",void 0),c([p({constructOnly:!0})],X.prototype,"renderCanvas",void 0),c([p({constructOnly:!0})],X.prototype,"state",void 0),c([p({readOnly:!0})],X.prototype,"inputManager",void 0),c([p({readOnly:!0})],X.prototype,"stateManager",void 0),c([p({type:["low","medium","high"]})],X.prototype,"qualityProfile",null),c([p({type:Rv,get(){let i=this._get("qualitySettings");return i||(i=new Rv,Ad.apply(this.qualityProfile,i)),i}})],X.prototype,"qualitySettings",void 0),c([p()],X.prototype,"slicePlane",null),c([p({readOnly:!0})],X.prototype,"typeSpecificPreconditionsReady",null),c([p({readOnly:!0})],X.prototype,"renderCoordsHelper",void 0),c([p({readOnly:!0})],X.prototype,"sceneIntersectionHelper",void 0),c([p({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],X.prototype,"resolution",null),c([p({type:Number})],X.prototype,"scale",null),c([p()],X.prototype,"heightModelInfo",null),c([p()],X.prototype,"spatialReference",void 0),c([p({type:Boolean,constructOnly:!0})],X.prototype,"alphaCompositingEnabled",void 0),c([p({constructOnly:!0})],X.prototype,"preserveDrawingBufferEnabled",void 0),c([p({type:Boolean})],X.prototype,"supersampleScreenshotsEnabled",void 0),c([p({readOnly:!0})],X.prototype,"type",void 0),c([p(),bl(i=>i instanceof s1?i:PC(pC,i))],X.prototype,"ui",void 0),c([p({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],X.prototype,"updating",null),c([p()],X.prototype,"_updatingObjects",null),c([p()],X.prototype,"_updatingObjectsWithProgress",null),c([p({type:Number,readOnly:!0,dependsOn:["updating"]})],X.prototype,"updatingProgress",void 0),c([p({type:["global","local"]})],X.prototype,"viewingMode",null),c([p({type:Fh})],X.prototype,"viewpoint",null),c([p({type:Number})],X.prototype,"zoom",null),c([p({type:_w})],X.prototype,"highlightOptions",void 0),c([p({readOnly:!0})],X.prototype,"quality",null),c([p({readOnly:!0})],X.prototype,"resolutionScale",null),c([p()],X.prototype,"textures",void 0),X=c([F("esri.views.SceneView")],X);const fd=b(),bm=Ht(),Uy=hi(),B5=X,BH=Object.freeze(Object.defineProperty({__proto__:null,default:B5},Symbol.toStringTag,{value:"Module"})),H5=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:_l,build:cb},Symbol.toStringTag,{value:"Module"})),G5=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:og,build:_b},Symbol.toStringTag,{value:"Module"})),k5=Object.freeze(Object.defineProperty({__proto__:null,build:fb},Symbol.toStringTag,{value:"Module"})),j5=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:lg,build:bb},Symbol.toStringTag,{value:"Module"})),W5=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:hg,build:Cb},Symbol.toStringTag,{value:"Module"})),Q5=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:cg,build:Sb},Symbol.toStringTag,{value:"Module"})),X5=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:ug,SimpleAtmospherePassParameters:Yu,build:Ob},Symbol.toStringTag,{value:"Module"})),Y5=Object.freeze(Object.defineProperty({__proto__:null,build:Eb},Symbol.toStringTag,{value:"Module"})),Z5=Object.freeze(Object.defineProperty({__proto__:null,build:Db},Symbol.toStringTag,{value:"Module"})),K5=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:Mg,build:Tw},Symbol.toStringTag,{value:"Module"})),J5=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return Sn},build:Xw},Symbol.toStringTag,{value:"Module"})),eF=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:ex,ColorizerStretchUniforms:Jw,ColorizerUniforms:Ju,build:tx},Symbol.toStringTag,{value:"Module"})),tF=Object.freeze(Object.defineProperty({__proto__:null,build:px},Symbol.toStringTag,{value:"Module"})),iF=Object.freeze(Object.defineProperty({__proto__:null,build:bx},Symbol.toStringTag,{value:"Module"})),sF=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:Bg,build:Cx},Symbol.toStringTag,{value:"Module"})),rF=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:qg,blurSize:zg,build:yx,gridCellPixelSize:ur,outlineSize:oc},Symbol.toStringTag,{value:"Module"})),aF=Object.freeze(Object.defineProperty({__proto__:null,build:Mx},Symbol.toStringTag,{value:"Module"})),nF=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:Gg,build:Dx},Symbol.toStringTag,{value:"Module"})),oF=Object.freeze(Object.defineProperty({__proto__:null,build:Lx},Symbol.toStringTag,{value:"Module"})),lF=Object.freeze(Object.defineProperty({__proto__:null,build:Vx},Symbol.toStringTag,{value:"Module"})),hF=Object.freeze(Object.defineProperty({__proto__:null,build:zx},Symbol.toStringTag,{value:"Module"})),cF=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:ep,build:Gx},Symbol.toStringTag,{value:"Module"})),dF=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:jg,build:jx},Symbol.toStringTag,{value:"Module"})),uF=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:Wg,build:Xx},Symbol.toStringTag,{value:"Module"})),pF=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:Xg,build:sC},Symbol.toStringTag,{value:"Module"})),mF=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:bc,build:iC},Symbol.toStringTag,{value:"Module"})),_F=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Yg,build:hC},Symbol.toStringTag,{value:"Module"}));export{Gr as A,Yc as B,Zn as C,oi as I,BH as S,Vt as a,j3 as b,nn as c,UB as d,gz as e,B5 as f,Gn as g,ah as h,AU as i,n$ as j,Ov as k,EU as l,fx as m,ra as n,rc as o,aN as r,B$ as t,Ju as v,Mz as x};
