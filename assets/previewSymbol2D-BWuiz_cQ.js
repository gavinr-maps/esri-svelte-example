import{h as Z}from"./Color-VJEMvW-n.js";import{L as T}from"./colorUtils-DaPfwnk3.js";import{s as G}from"./Accessor-BmwT4B0c.js";import{c as J}from"./fontUtils-CGi-tOxo.js";import{u as x}from"./screenUtils-_ZIvrt5o.js";import{U as K,k as Q}from"./quantizationUtils-DgFbqZi7.js";import{u as V,y as W,g as X,f as Y}from"./utils-aIx1khaq.js";import{t as A,e as _,d as U,l as $}from"./symbolUtils-CHmFfSx2.js";import{s as P}from"./TextSymbol-BLIQ6RKX.js";import"./colorUtils-Rxh2V3ai.js";import"./mathUtils-Cfq9PL9W.js";import"./vec42-YcqnINSP.js";import"./common-DQOJ18NT.js";import"./vec4f64-o2zAXfmz.js";import"./Extent-g5W9hy0j.js";import"./Point-Cz2JYYmX.js";import"./cast-CsZslgGN.js";import"./index-4eY77cms.js";import"./JSONSupport-DcrLLGjL.js";import"./writer-DKgfqj4X.js";import"./Polyline-s-JzsQqo.js";import"./reactiveUtils-XM7cS2OP.js";import"./Evented-Dw4_VOGn.js";import"./SimpleObservable-CvOkykwM.js";import"./vec3f64-BLpZdpfb.js";import"./jsonUtils-DZz5FrgB.js";import"./utils-DYurMneM.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-Fi6iAz29.js";import"./cimSymbolUtils-DzhKvmq_.js";import"./utils-UPZJIDfz.js";import"./defaultCIMValues-Bb-CUowV.js";import"./enums-BTM-fOHQ.js";import"./LRUCache-CXiGQWMN.js";import"./MemCache-CmojB_Z1.js";import"./Graphic-Dt0LgVGU.js";import"./Clonable-Z-AWS-16.js";import"./opacityUtils-Dim20wpZ.js";import"./Promise-DfET-uns.js";import"./enumeration-DpvDkLNI.js";import"./ActionToggle-D7439N1A.js";import"./Identifiable-BHVfzH03.js";import"./jsonUtils-CwFG8yN4.js";import"./typeUtils-B6WBEKDM.js";import"./collectionUtils-CTT-51g7.js";import"./Portal-CmmHxpLg.js";import"./aaBoundingBox-Dw3yBk2f.js";import"./jsxFactory-Cnml7uXM.js";import"./intl-Duiy0OzY.js";import"./uuid-Cl5lrJ4c.js";import"./mat2df32-orApM5a3.js";import"./mat2d-D9DBP-jx.js";import"./webStyleSymbolUtils-C6Yokq8v.js";import"./devEnvironmentUtils-CnNDiFMM.js";import"./jsonUtils-B-voMz-i.js";import"./layerUtils-B__v9OBu.js";import"./defaults-FkBa0ybj.js";import"./defaultsJSON-GKolV7NZ.js";import"./styleUtils-ColFrJ-Z.js";import"./webStyleAcceptedFormats-CG7ZQ6BV.js";const H="picture-fill",tt="picture-marker",it="simple-fill",ot="simple-line",nt="simple-marker",at="text",et="Aa",lt=A.size,z=A.maxSize,rt=A.maxOutlineSize,q=A.lineWidth,O=225,st=document.createElement("canvas");function R(i,t,r){if(i.type==="polygon"){const n=i.extent,p=n.width===0?1:n.width,m=n.height===0?1:n.height;i=K({originPosition:"upperLeft",scale:[p/t,m/r],translate:[n.xmin,n.ymax]},{},i);let s="";for(let e=0;e<i.rings.length;e++){const l=i.rings[e];for(let h=0;h<l.length;h++){const u=l[h][0],d=l[h][1];let o="";h===0?(o=`M${u.toString()} ${d.toString()}`,s!==""&&(o=` ${o}`),s+=o):h===l.length-1?(o=`l${u.toString()} ${d.toString()} Z`,s!==""&&(o=` ${o}`),s+=o):(o=`l${u.toString()} ${d.toString()}`,s!==""&&(o=` ${o}`),s+=o)}}return s}if(i.type==="polyline"){const n=i.extent,p=n.width===0?1:n.width,m=n.height===0?1:n.height;i=Q({originPosition:"upperLeft",scale:[p/t,m/r],translate:[n.xmin,n.ymax]},{},i);let s="";for(let e=0;e<i.paths.length;e++){const l=i.paths[e];for(let h=0;h<l.length;h++){const u=l[h][0],d=l[h][1];let o="";h===0?(o=`M${u.toString()} ${d.toString()}`,s!==""&&(o=` ${o}`),s+=o):(o=`l${u.toString()} ${d.toString()}`,s!==""&&(o=` ${o}`),s+=o)}}return s}return""}function I(i,t){const r=st.getContext("2d"),n=[];t&&(t.weight&&n.push(t.weight),t.size&&n.push(t.size+"px"),t.family&&n.push(t.family)),r.font=n.join(" ");const{width:p,actualBoundingBoxLeft:m,actualBoundingBoxRight:s,actualBoundingBoxAscent:e,actualBoundingBoxDescent:l}=r.measureText(i);return{width:Math.ceil(Math.max(p,m+s)),height:Math.ceil(e+l),x:Math.floor(m),y:Math.floor((e-l)/2)}}function k(i){const t=i==null?void 0:i.size;return{width:t!=null&&typeof t=="object"&&"width"in t?x(t.width):null,height:t!=null&&typeof t=="object"&&"height"in t?x(t.height):null}}async function ht(i,t){const r=t.fill,n=i.color;if((r==null?void 0:r.type)==="pattern"&&n&&i.type!==H){const p=await Y(r.src,n.toCss(!0));r.src=p,t.fill=r}}async function mt(i,t,r,n){var s,e,l;if(!("font"in i)||!i.font||t.shape.type!=="text")return;try{await J(i.font)}catch{}const{width:p,height:m}=k(n);if(!/[\uE600-\uE6FF]/.test(t.shape.text)){const{width:h,height:u,x:d,y:o}=I(t.shape.text,{weight:(s=t.font)==null?void 0:s.weight,size:(e=t.font)==null?void 0:e.size,family:(l=t.font)==null?void 0:l.family});r[0]=p??h,r[1]=m??u,t.shape.x=d,t.shape.y=o;let a="angle"in i?i.angle:null;if((n==null?void 0:n.rotation)!=null&&(a=(a??0)+n.rotation),a){const M=a*(Math.PI/180),L=Math.abs(Math.sin(M)),C=Math.abs(Math.cos(M));r[1]=r[0]*L+r[1]*C}}}function pt(i,t,r,n,p){var m;if(i.haloColor!=null&&i.haloSize!=null){p.masking??(p.masking=r.map(()=>[]));const s=x(i.haloSize);n[0]+=s,n[1]+=s,r.unshift([{...t,fill:null,stroke:{color:i.haloColor,width:2*s,join:"round",cap:"round"}}]),p.masking.unshift([{shape:{type:"rect",x:0,y:0,width:n[0]+2*P,height:n[1]+2*P},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}i.backgroundColor==null&&i.borderLineColor==null||(n[0]+=2*P,n[1]+=2*P,r.unshift([{shape:{type:"rect",x:0,y:0,width:n[0],height:n[1]},fill:i.backgroundColor,stroke:{color:i.borderLineColor,width:x(i.borderLineSize)}}]),(m=p.masking)==null||m.unshift([]))}function N(i,t){return i>t?"dark":"light"}function ct(i,t){var L,C,j,D,E;const r=typeof(t==null?void 0:t.size)=="number"?t==null?void 0:t.size:null,n=r!=null?x(r):null,p=(t==null?void 0:t.maxSize)!=null?x(t.maxSize):null;let m="angle"in i?i.angle:null;(t==null?void 0:t.rotation)!=null&&(m=(m??0)+t.rotation);const s=V(i);let e=W(i);ut(i,245)!=="dark"||t!=null&&t.ignoreWhiteSymbols||(e={width:.75,...e,color:"#bdc3c7"});let l=null;const h={shape:null,fill:s,stroke:e,offset:[0,0]};e!=null&&e.width&&(e.width=Math.min(e.width,rt));const u=(e==null?void 0:e.width)||0;let d=(t==null?void 0:t.size)!=null&&((t==null?void 0:t.scale)==null||(t==null?void 0:t.scale)),o=0,a=0,M=!1;switch(i.type){case nt:{const f=i.style,{width:g,height:c}=k(t);let b=g===c&&g!=null?g:n??Math.min(x(i.size),p||z);if((t==null?void 0:t.useMarkerSymbolSize)===!0&&g!==null&&c!==null){const y=Math.min(x(i.size),p||z);b=y>g&&y>c?Math.min(g,c):y}switch(o=b,a=b,f){case"circle":h.shape={type:"circle",cx:0,cy:0,r:.5*b},d||(o+=u,a+=u);break;case"cross":h.shape={type:"path",path:[{command:"M",values:[0,.5*a]},{command:"L",values:[o,.5*a]},{command:"M",values:[.5*o,0]},{command:"L",values:[.5*o,a]}]};break;case"diamond":h.shape={type:"path",path:[{command:"M",values:[0,.5*a]},{command:"L",values:[.5*o,0]},{command:"L",values:[o,.5*a]},{command:"L",values:[.5*o,a]},{command:"Z",values:[]}]},d||(o+=u,a+=u);break;case"square":h.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[o,0]},{command:"L",values:[o,a]},{command:"L",values:[0,a]},{command:"Z",values:[]}]},d||(o+=u,a+=u),m&&(M=!0);break;case"triangle":h.shape={type:"path",path:[{command:"M",values:[.5*o,0]},{command:"L",values:[o,a]},{command:"L",values:[0,a]},{command:"Z",values:[]}]},d||(o+=u,a+=u),m&&(M=!0);break;case"x":h.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[o,a]},{command:"M",values:[o,0]},{command:"L",values:[0,a]}]},m&&(M=!0);break;case"path":h.shape={type:"path",path:i.path||""},d||(o+=u,a+=u),m&&(M=!0),d=!0}break}case ot:{const{width:f,height:g}=k(t),c=X(e).reduce((v,S)=>v+S,0),b=c&&Math.ceil(q/c),y=g??n??u,w=f??(c*b||q);if(d=!0,((L=t==null?void 0:t.geometry)==null?void 0:L.type)==="polyline"&&((C=t==null?void 0:t.geometry)==null?void 0:C.extent)){o=w,a=g??o;const v=1e3,S=.15*v;l=[o,a],a=l[0]>l[1]?v*l[1]/l[0]:v,o=l[0]>l[1]?v:v*l[0]/l[1],e!=null&&e.width&&(e.width=e.width*v/(l[1]>l[0]?l[1]:l[0]),e.width>S&&(e.width=S)),h.shape={type:"path",path:R(t.geometry,o,a)}}else o=(t==null?void 0:t.maxSize)!=null?Math.min(w,t.maxSize):w,a=y,e&&(e.width=y),h.shape={type:"path",path:[{command:"M",values:[y/2,a/2]},{command:"L",values:[o-y/2,a/2]}]};break}case H:case it:{const f=typeof(t==null?void 0:t.symbolConfig)=="object"&&!!((j=t==null?void 0:t.symbolConfig)!=null&&j.isSquareFill),{width:g,height:c}=k(t);o=!f&&g!==c||g==null?n??lt:g,a=!f&&g!==c||c==null?o:c,d||(o+=u,a+=u),d=!0,(D=t==null?void 0:t.geometry)!=null&&D.extent&&((E=t==null?void 0:t.geometry)==null?void 0:E.type)==="polygon"?(l=[o,a],a=l[0]>l[1]?1e3*l[1]/l[0]:1e3,o=l[0]>l[1]?1e3:1e3*l[0]/l[1],h.shape={type:"path",path:R(t.geometry,o,a)}):h.shape=f?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[o,0]},{command:"L",values:[o,a]},{command:"L",values:[0,a]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:_.fill[0];break}case tt:{const f=Math.min(x(i.width),p||z),g=Math.min(x(i.height),p||z),{width:c,height:b}=k(t),y=c===b&&c!=null?c:n??Math.max(f,g),w=i.width/i.height;o=w<=1?Math.ceil(y*w):y,a=w<=1?y:Math.ceil(y/w),h.shape={type:"image",x:-Math.round(o/2),y:-Math.round(a/2),width:o,height:a,src:i.url||""},m&&(M=!0);break}case at:{const f=i,g=(t==null?void 0:t.overrideText)||f.text||et,c=f.font,{width:b,height:y}=k(t),w=y??n??Math.min(x(c.size),p||z),{width:v,height:S}=I(g,{weight:c.weight,size:w,family:c.family}),B=/[\uE600-\uE6FF]/.test(g);o=b??(B?w:v),a=B?w:S;let F=.5*(B?w:S);B&&(F+=5),h.shape={type:"text",text:g,x:f.xoffset||0,y:f.yoffset||F,align:"middle",alignBaseline:f.verticalAlignment,decoration:c&&c.decoration,rotated:f.rotated,kerning:f.kerning},h.font=c&&{size:w,style:c.style,decoration:c.decoration,weight:c.weight,family:c.family};break}}return{shapeDescriptor:h,size:[o,a],outputSize:l,renderOptions:{node:t==null?void 0:t.node,scale:d,opacity:t==null?void 0:t.opacity,rotations:[m],useRotationSize:M,effectView:t==null?void 0:t.effectView,ariaLabel:t==null?void 0:t.ariaLabel}}}async function bi(i,t){var l,h,u,d,o;const{shapeDescriptor:r,size:n,renderOptions:p,outputSize:m}=ct(i,t);if(!r.shape)throw new G("symbolPreview: renderPreviewHTML2D","symbol not supported.");await ht(i,r),await mt(i,r,n,t);const s=[[r]];if(typeof(t==null?void 0:t.symbolConfig)=="object"&&((l=t==null?void 0:t.symbolConfig)!=null&&l.applyColorModulation)){const a=.6*n[0];s.unshift([{...r,offset:[-a,0],fill:U(r.fill,-.3)}]),s.push([{...r,offset:[a,0],fill:U(r.fill,.3)}]),n[0]+=2*a,p.scale=!1}i.type==="text"&&pt(i,r,s,n,p);const e=$(s,n,p);if(m&&e){const a=e.nodeName.toLowerCase()==="img"?e:e.firstChild;a.nodeName.toLowerCase()==="svg"&&a.setAttribute("viewBox",`0 0 ${n[0].toString()} ${n[1].toString()}`),a.setAttribute("width",m[0].toString()),a.setAttribute("height",m[1].toString()),m.length>2&&(a.style.setProperty("padding-left",((h=m[2])==null?void 0:h.toString())+"px"),a.style.setProperty("padding-right",((u=m[2])==null?void 0:u.toString())+"px"),a.style.setProperty("padding-top",((d=m[3])==null?void 0:d.toString())+"px"),a.style.setProperty("padding-bottom",((o=m[3])==null?void 0:o.toString())+"px"),a.style.setProperty("box-sizing","border-box"))}return e}function ut(i,t=O){const r=V(i),n=W(i),p=!r||"type"in r?null:new Z(r),m=n!=null&&n.color?new Z(n==null?void 0:n.color):null,s=p?N(T(p),t):null,e=m?N(T(m),t):null;return e?s?s===e?s:t>=O?"light":"dark":e:s}export{ut as getContrastingBackgroundTheme,ct as getRenderSymbolParameters,bi as previewSymbol2D};
