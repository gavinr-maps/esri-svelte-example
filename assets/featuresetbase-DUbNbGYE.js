import{m as Fe}from"./TimeOnly-DOn_Hy89.js";import{N as Z,t as De,D as Te,l as X}from"./arcadeUtils-BE8Aletj.js";import{i as b,l as xe,t as Y,K as A,a as u,r as c,P as v,d as E,C as be,B as me,e as de,W as ue,Y as L,S as $,E as N,U as G,X as k,v as Ee,h as O,J as Ne,D as B,V as Ae}from"./languageUtils-JGnUBrxZ.js";import{M as Se,q as ce,f as Le,c as K,e as Ce,a as Ze,b as ve,T as q,E as Pe,N as Re,O as Ue,L as M,B as Me,d as _,R as C,k as ee}from"./featureSetUtils-C3LRTCPx.js";import{t as ke}from"./ImmutableArray-BPVd6ESQ.js";import{l as $e}from"./portalUtils-DzVhPDyr.js";import{u as Oe,O as pe}from"./SpatialFilter-v6dSAig4.js";import{y as te}from"./shared-OyXfj1UM.js";import{S as ze}from"./Accessor-BLX9ikPh.js";import{Z as x}from"./WhereClause-BNiy948d.js";import ne from"./FeatureLayer-wa_7EIxE.js";import{y as j}from"./Field-ybkHhtnK.js";import{b as ye}from"./Portal-C10FKnaA.js";import"./subclass-BZA_h8Db.js";import"./UnknownTimeZone-BkowvBs8.js";import"./date-DlqISzcw.js";import"./jsonMap-0cxwUWs2.js";import"./locale-C9TlLpzi.js";import"./Extent-Bf3YTe7m.js";import"./tslib.es6-B3Jf3DVX.js";import"./Point-Cg0-ChZE.js";import"./cast-Bjksrh93.js";import"./writer-DNAwXnhG.js";import"./assets-C43MgM-v.js";import"./index-Bh2oEzTI.js";import"./geometry-D964gYQX.js";import"./Polyline-D9YkgmM_.js";import"./mathUtils-C4_ghTv4.js";import"./deepClone-CWS5qiGp.js";import"./jsonUtils-CEfjT-BK.js";import"./featureConversionUtils-D14h8iad.js";import"./aaBoundingBox-BE7cC1jD.js";import"./OptimizedFeature-6cJ-QFG5.js";import"./OptimizedGeometry-BF8iz5FO.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./FieldsIndex-DpwHKAMX.js";import"./fieldUtils-tmQlKvWo.js";import"./intl-CChhNOV8.js";import"./messages-OmQvZhAg.js";import"./number-CUaGJe2K.js";import"./hash-CcEbRgUF.js";import"./uuid-fwrPAdZb.js";import"./Query-5Xpquc1r.js";import"./enumeration-Ba5njXdz.js";import"./DataLayerSource-BKkswDvG.js";import"./FullTextSearch-Csd1Hktu.js";import"./Clonable-D3rtuBWg.js";import"./TimeExtent-DocT5yPf.js";import"./timeUtils-8fb_2oAt.js";import"./Graphic-DsxsIjhH.js";import"./PopupTemplate-BHMhS05j.js";import"./Collection-CEdjem1-.js";import"./Evented-BHRw9x22.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./Color-BCS62Hs5.js";import"./colorUtils-0bJDPow9.js";import"./ActionToggle-iT4slXc7.js";import"./Identifiable-B1UbsKNt.js";import"./symbols-CNimns--.js";import"./TextSymbol-D8QO_KUV.js";import"./screenUtils-_ZIvrt5o.js";import"./materialUtils-DarhapKC.js";import"./opacityUtils-C68Tlu6_.js";import"./vec3f64-BLpZdpfb.js";import"./persistableUrlUtils-fa1mAujs.js";import"./collectionUtils-D_lHIu88.js";import"./reactiveUtils-C5zUhJQJ.js";import"./asyncUtils-CWX51uTe.js";import"./MD5-C9MwAd2G.js";import"./AttachmentQuery-BUlkjzkx.js";import"./FeatureType-C0q_coeM.js";import"./FeatureTemplate-CssMa1yk.js";import"./RelationshipQuery-DPPNeuLK.js";import"./fieldType-BuzM0UHS.js";import"./Loadable-BabW5Xcc.js";import"./Promise-B2Hu02L7.js";import"./Layer-CVt7Hb5J.js";import"./PortalItem-DzgXrpyc.js";import"./geometryEngineAsync-Bu-rYQUP.js";import"./workers-D4HfeYKj.js";import"./Queue-yu3bZ02p.js";import"./ClassBreaksRenderer-BuHwSyVK.js";import"./UniqueValueRenderer-BQtAHUSo.js";import"./diffUtils-BP7jmOAy.js";import"./colorRamps-pKd7I5WZ.js";import"./SizeVariable-936USOrb.js";import"./sizeVariableUtils-Cmcuvw-4.js";import"./visualVariableUtils-DX1kS9Se.js";import"./compilerUtils-Dw3R0f-Z.js";import"./lengthUtils-DL1-FDQQ.js";import"./ColorStop-Dk3U5tCk.js";import"./jsonUtils-Ds2Sqto-.js";import"./layerUtils-BrNoooE9.js";import"./defaults-DZ1kfMRx.js";import"./defaultsJSON-GKolV7NZ.js";import"./RendererLegendOptions-B-4se3aU.js";import"./styleUtils-BYTm14n3.js";import"./jsonUtils-DxpLMo6d.js";import"./LRUCache-B_PHMSGm.js";import"./MemCache-Dx1v3xLC.js";import"./Version-BSlAgupz.js";import"./OverrideHelper-ti072FkP.js";import"./colorUtils-aL8wj-8G.js";import"./vec42-YcqnINSP.js";import"./common-DQOJ18NT.js";import"./vec4f64-o2zAXfmz.js";import"./utils-D2PLyMFF.js";import"./enums-CmIX1y88.js";import"./quantizationUtils-uj_P09aO.js";import"./HeatmapColorStop-BJc5nbwr.js";import"./heatmapUtils-Dwiv9IEa.js";import"./SimpleRenderer-BV2L9G_n.js";import"./MultiOriginJSONSupport-B5nfqtQh.js";import"./layerContainerType-C5CzMsLd.js";import"./FeatureLayerBase-Ck7-w8TE.js";import"./formUtils-ylzKAM7E.js";import"./HeightModelInfo-9nOoV6LU.js";import"./arcgisLayerUrl-BX1FE5Hm.js";import"./commonProperties-CPyIG_-u.js";import"./ElevationInfo-CA5m_tHv.js";import"./unitConversionUtils-BMfW9yAe.js";import"./AttributeTableTemplate-BZeVyq-j.js";import"./featureLayerUtils-DBsQMhTm.js";import"./featureQueryAll-DnVoEjkM.js";import"./LayerFloorInfo-CIQjg5Vk.js";import"./Relationship-COPq3qM4.js";import"./serviceCapabilitiesUtils-DAE5z8FP.js";import"./editsZScale-Bs7_pSzI.js";import"./queryZScale-w66xFVGx.js";import"./projection-B971H0Re.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";import"./FeatureSet-BHEkYP03.js";import"./APIKeyMixin-Di9kcRBS.js";import"./ArcGISService-B5qxetOY.js";import"./BlendLayer-CXM4n_Ge.js";import"./jsonUtils-CSnQD004.js";import"./parser-CTsgEym6.js";import"./utils-93yNk4Xc.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-GpOFENPA.js";import"./CustomParametersMixin-B4u7wiBT.js";import"./EditBusLayer-DoTks2sU.js";import"./FeatureEffectLayer-CpM66wLd.js";import"./FeatureEffect-BEzQmzeC.js";import"./FeatureFilter-BMHRQSxq.js";import"./FeatureReductionLayer-Ddbk727V.js";import"./FeatureReductionSelection-7vaL4DYT.js";import"./labelingInfo-DYPSPZCH.js";import"./labelUtils-B8petyBk.js";import"./OperationalLayer-CVyVfSPu.js";import"./OrderedLayer-C5VLMHgA.js";import"./OrderByInfo-IYmS1EXF.js";import"./PortalLayer-CKja4bdW.js";import"./portalItemUtils-BzVoFAku.js";import"./RefreshableLayer-D7lXUJRS.js";import"./ScaleRangeLayer-Bb8Ig1Hz.js";import"./TemporalLayer-Dpq2hKKV.js";import"./TimeInfo-LUiaSFyX.js";import"./TimeInterval-CNlkea1s.js";import"./fieldProperties-Cgxj08ZE.js";import"./versionUtils-CQ_WhYSP.js";import"./styleUtils-KMFBtb6u.js";import"./popupUtils-BBuPGAHd.js";import"./AlphaCutoff-UcccL64p.js";import"./interfaces-CL2NbQte.js";function We(i){if(i.length===1){if(N(i[0]))return X("distinct",i[0],-1);if(k(i[0]))return X("distinct",i[0].toArray(),-1)}return X("distinct",i,-1)}async function ie(i,t,r){const y=i.getVariables();if(y.length>0){const F=[];for(let n=0;n<y.length;n++){const o={name:y[n]};F.push(await t.evaluateIdentifier(r,o))}const e={};for(let n=0;n<y.length;n++)e[y[n]]=F[n];return i.parameters=e,i}return i}function d(i,t,r=null){for(const y in i)if(y.toLowerCase()===t.toLowerCase())return i[y];return r}function we(i){if(i===null)return null;const t={type:d(i,"type",""),name:d(i,"name","")};if(t.type==="range")t.range=d(i,"range",[]);else{t.codedValues=[];for(const r of d(i,"codedValues",[]))t.codedValues.push({name:d(r,"name",""),code:d(r,"code",null)})}return t}function re(i){if(i===null)return null;const t={},r=d(i,"wkt");r!==null&&(t.wkt=r);const y=d(i,"wkid");return y!==null&&(t.wkid=y),t}function he(i){if(i===null)return null;const t={hasZ:d(i,"hasz",!1),hasM:d(i,"hasm",!1)},r=d(i,"spatialreference");r!=null&&(t.spatialReference=re(r));const y=d(i,"x",null);if(y!==null)return t.x=y,t.y=d(i,"y",null),t.hasZ&&(t.z=d(i,"z",null)),t.hasM&&(t.m=d(i,"m",null)),t;const F=d(i,"rings",null);if(F!==null)return t.rings=F,t;const e=d(i,"paths",null);if(e!==null)return t.paths=e,t;const n=d(i,"points",null);if(n!==null)return t.points=n,t;for(const o of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const f=d(i,o,null);f!==null&&(t[o]=f)}return t}function He(i,t){for(const r of t)if(r===i)return!0;return!1}function je(i){return!!i.layerDefinition&&!!i.featureSet&&He(i.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&N(i.layerDefinition.fields)!==!1&&N(i.featureSet.features)!==!1}function z(i){return(i==null?void 0:i.toLowerCase())==="utc"?"UTC":(i==null?void 0:i.toLowerCase())==="unknown"?"Unknown":i}function Qi(i){i.mode==="async"&&(i.functions.timezone=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{var f,p;if(b(e,1,2,t,r),xe(e[0])||Y(e[0]))return"Unknown";if(A(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?z("unknown"):z(e[0].dateFieldsTimeZone);if(!(e[1]instanceof Z)||e[1].hasField("type")===!1)throw new u(t,c.InvalidParameter,r);const l=e[1].field("type");if(v(l)===!1)throw new u(t,c.InvalidParameter,r);switch(E(l).toLowerCase()){case"preferredtimezone":return z(e[0].preferredTimeZone);case"editfieldsinfo":return z(((f=e[0].editFieldsInfo)==null?void 0:f.timeZone)??null);case"timeinfo":return z(((p=e[0].timeInfo)==null?void 0:p.timeZone)??null);case"field":if(e[1].hasField("fieldname")&&v(e[1].field("fieldname")))return z(e[0].fieldTimeZone(E(e[1].field("fieldname"))))}throw new u(t,c.InvalidParameter,r)}const n=be(e[0],me(t));if(n===null)return null;const o=n.timeZone;return o==="system"?Fe.systemTimeZoneCanonicalName:o.toLowerCase()==="utc"?"UTC":o.toLowerCase()==="unknown"?"Unknown":o})},i.functions.sqltimestamp=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{b(e,1,3,t,r);const n=e[0];if(de(n)){if(e.length===1)return n.toSQLWithKeyword();if(e.length===2)return n.changeTimeZone(E(e[1])).toSQLWithKeyword();throw new u(t,c.InvalidParameter,r)}if(Y(n))return n.toSQLWithKeyword();if(A(n)){if(e.length!==3)throw new u(t,c.InvalidParameter,r);await n.load();const o=E(e[1]);if(Y(e[2]))return e[2].toSQLWithKeyword();if(de(e[2])===!1)throw new u(t,c.InvalidParameter,r);const f=n.fieldTimeZone(o);return f===null?e[2].toSQLWithKeyword():e[2].changeTimeZone(f).toSQLWithKeyword()}throw new u(t,c.InvalidParameter,r)})},i.signatures.push({name:"sqltimestamp",min:2,max:4}),i.functions.featuresetbyid=function(t,r){return i.standardFunctionAsync(t,r,(y,F,e)=>{if(b(e,2,4,t,r),ue(e[0])){const n=E(e[1]);let o=L(e[2],null);const f=$(L(e[3],!0));if(o===null&&(o=["*"]),N(o)===!1)throw new u(t,c.InvalidParameter,r);return e[0].featureSetById(n,f,o)}throw new u(t,c.InvalidParameter,r)})},i.signatures.push({name:"featuresetbyid",min:2,max:4}),i.functions.getfeatureset=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{if(b(e,1,2,t,r),G(e[0])){let n=L(e[1],"datasource");return n===null&&(n="datasource"),n=E(n).toLowerCase(),Se(e[0].fullSchema(),n,t.lrucache,t.interceptor,t.spatialReference??null)}throw new u(t,c.InvalidParameter,r)})},i.signatures.push({name:"getfeatureset",min:1,max:2}),i.functions.featuresetbyportalitem=function(t,r){return i.standardFunctionAsync(t,r,(y,F,e)=>{var l,a;if(b(e,2,5,t,r),e[0]===null)throw new u(t,c.PortalRequired,r);if(e[0]instanceof De){const s=E(e[1]),m=E(e[2]);let w=L(e[3],null);const D=$(L(e[4],!0));if(w===null&&(w=["*"]),N(w)===!1)throw new u(t,c.InvalidParameter,r);let h;return h=(l=t.services)!=null&&l.portal?t.services.portal:ye.getDefault(),h=$e(e[0],h),ce(s,m,t.spatialReference??null,w,D,h,t.lrucache,t.interceptor)}if(v(e[0])===!1)throw new u(t,c.PortalRequired,r);const n=E(e[0]),o=E(e[1]);let f=L(e[2],null);const p=$(L(e[3],!0));if(f===null&&(f=["*"]),N(f)===!1)throw new u(t,c.InvalidParameter,r);return ce(n,o,t.spatialReference??null,f,p,((a=t.services)==null?void 0:a.portal)??ye.getDefault(),t.lrucache,t.interceptor)})},i.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),i.functions.featuresetbyname=function(t,r){return i.standardFunctionAsync(t,r,(y,F,e)=>{if(b(e,2,4,t,r),ue(e[0])){const n=E(e[1]);let o=L(e[2],null);const f=$(L(e[3],!0));if(o===null&&(o=["*"]),N(o)===!1)throw new u(t,c.InvalidParameter,r);return e[0].featureSetByName(n,f,o)}throw new u(t,c.InvalidParameter,r)})},i.signatures.push({name:"featuresetbyname",min:2,max:4}),i.functions.featureset=function(t,r){return i.standardFunction(t,r,(y,F,e)=>{b(e,1,1,t,r);const n={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(v(e[0])){const o=JSON.parse(e[0]);o.layerDefinition!==void 0?(n.layerDefinition=o.layerDefinition,n.featureSet=o.featureSet,o.layerDefinition.spatialReference&&(n.layerDefinition.spatialReference=o.layerDefinition.spatialReference)):(n.featureSet.features=o.features,n.featureSet.geometryType=o.geometryType,n.layerDefinition.geometryType=n.featureSet.geometryType,n.layerDefinition.objectIdField=o.objectIdFieldName??"",n.layerDefinition.typeIdField=o.typeIdFieldName,n.layerDefinition.globalIdField=o.globalIdFieldName,n.layerDefinition.fields=o.fields,o.spatialReference&&(n.layerDefinition.spatialReference=o.spatialReference))}else{if(!(e[0]instanceof Z))throw new u(t,c.InvalidParameter,r);{const o=JSON.parse(e[0].castToText(!0)),f=d(o,"layerdefinition");if(f!==null){n.layerDefinition.geometryType=d(f,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.globalIdField=d(f,"globalidfield",""),n.layerDefinition.objectIdField=d(f,"objectidfield",""),n.layerDefinition.typeIdField=d(f,"typeidfield",""),n.layerDefinition.hasZ=d(f,"hasz",!1)===!0,n.layerDefinition.hasM=d(f,"hasm",!1)===!0;const p=d(f,"spatialreference");p&&(n.layerDefinition.spatialReference=re(p));const l=[];for(const s of d(f,"fields",[])){const m={name:d(s,"name",""),alias:d(s,"alias",""),type:d(s,"type",""),nullable:d(s,"nullable",!0),editable:d(s,"editable",!0),length:d(s,"length",null),domain:we(d(s,"domain"))};l.push(m)}n.layerDefinition.fields=l;const a=d(o,"featureset");if(a){const s={};for(const m of l)s[m.name.toLowerCase()]=m.name;for(const m of d(a,"features",[])){const w={},D=d(m,"attributes",{});for(const h in D)w[s[h.toLowerCase()]]=D[h];n.featureSet.features.push({attributes:w,geometry:he(d(m,"geometry"))})}}}else{n.layerDefinition.hasZ=d(o,"hasz",!1)===!0,n.layerDefinition.hasM=d(o,"hasm",!1)===!0,n.layerDefinition.geometryType=d(o,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.objectIdField=d(o,"objectidfieldname",""),n.layerDefinition.typeIdField=d(o,"typeidfieldname","");const p=d(o,"spatialreference");p&&(n.layerDefinition.spatialReference=re(p));const l=[],a=d(o,"fields",null);if(!N(a))throw new u(t,c.InvalidParameter,r);for(const w of a){const D={name:d(w,"name",""),alias:d(w,"alias",""),type:d(w,"type",""),nullable:d(w,"nullable",!0),editable:d(w,"editable",!0),length:d(w,"length",null),domain:we(d(w,"domain"))};l.push(D)}n.layerDefinition.fields=l;const s={};for(const w of l)s[w.name.toLowerCase()]=w.name;let m=d(o,"features",null);if(N(m))for(const w of m){const D={},h=d(w,"attributes",{});for(const T in h)D[s[T.toLowerCase()]]=h[T];n.featureSet.features.push({attributes:D,geometry:he(d(w,"geometry",null))})}else m=null,n.featureSet.features=m}}}if(je(n)===!1)throw new u(t,c.InvalidParameter,r);return n.layerDefinition.geometryType||(n.layerDefinition.geometryType="esriGeometryNull"),Le.create(n,t.spatialReference)})},i.signatures.push({name:"featureset",min:1,max:1}),i.functions.filter=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{if(b(e,2,2,t,r),N(e[0])||k(e[0])){const n=[];let o,f=e[0];if(f instanceof ke&&(f=f.toArray()),!Ee(e[1]))throw new u(t,c.InvalidParameter,r);o=e[1].createFunction(t);for(const p of f){const l=o(p);ze(l)?await l===!0&&n.push(p):l===!0&&n.push(p)}return n}if(A(e[0])){const n=await e[0].load(),o=x.create(e[1],{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),f=o.getVariables();if(f.length>0){const p=[];for(let a=0;a<f.length;a++){const s={name:f[a]};p.push(await i.evaluateIdentifier(t,s))}const l={};for(let a=0;a<f.length;a++)l[f[a]]=p[a];return o.parameters=l,new K({parentfeatureset:e[0],whereclause:o})}return new K({parentfeatureset:e[0],whereclause:o})}throw new u(t,c.InvalidParameter,r)})},i.signatures.push({name:"filter",min:2,max:2}),i.functions.orderby=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{if(b(e,2,2,t,r),A(e[0])){const n=new Ce(e[1]);return new Ze({parentfeatureset:e[0],orderbyclause:n})}throw new u(t,c.InvalidParameter,r)})},i.signatures.push({name:"orderby",min:2,max:2}),i.functions.top=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{if(b(e,2,2,t,r),A(e[0]))return new ve({parentfeatureset:e[0],topnum:e[1]});if(N(e[0]))return O(e[1])>=e[0].length?e[0].slice():e[0].slice(0,O(e[1]));if(k(e[0]))return O(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,O(e[1]));throw new u(t,c.InvalidParameter,r)})},i.signatures.push({name:"top",min:2,max:2}),i.functions.first=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{if(b(e,1,1,t,r),A(e[0])){const n=await e[0].first(y.abortSignal);if(n!==null){const o=Te.createFromGraphicLikeObject(n.geometry,n.attributes,e[0],t.timeZone);return o._underlyingGraphic=n,o}return n}return N(e[0])?e[0].length===0?null:e[0][0]:k(e[0])?e[0].length()===0?null:e[0].get(0):null})},i.signatures.push({name:"first",min:1,max:1}),i.functions.attachments=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{b(e,1,2,t,r);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof Z){if(e[1].hasField("minsize")&&(n.minsize=O(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=$(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=O(e[1].field("maxsize"))),e[1].hasField("types")){const o=Ne(e[1].field("types"),!1);o.length>0&&(n.types=o)}}else if(e[1]!==null)throw new u(t,c.InvalidParameter,r)}if(G(e[0])){let o=e[0]._layer;return o instanceof ne&&(o=q(o,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),o===null?[]:A(o)===!1?[]:(await o.load(),o.queryAttachments(e[0].field(o.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata))}if(e[0]===null)return[];throw new u(t,c.InvalidParameter,r)})},i.signatures.push({name:"attachments",min:1,max:2}),i.functions.featuresetbyrelationshipname=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{b(e,2,4,t,r);const n=e[0],o=E(e[1]);let f=L(e[2],null);const p=$(L(e[3],!0));if(f===null&&(f=["*"]),N(f)===!1)throw new u(t,c.InvalidParameter,r);if(e[0]===null)return null;if(!G(e[0]))throw new u(t,c.InvalidParameter,r);let l=n._layer;if(l instanceof ne&&(l=q(l,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),l===null||A(l)===!1)return null;l=await l.load();const a=l.relationshipMetaData().filter(h=>h.name===o);if(a.length===0)return null;if(a[0].relationshipTableId!==void 0&&a[0].relationshipTableId!==null&&a[0].relationshipTableId>-1)return Pe(l,a[0],n.field(l.objectIdField),l.spatialReference,f,p,t.lrucache,t.interceptor);let s=l.serviceUrl();if(!s)return null;s=s.charAt(s.length-1)==="/"?s+a[0].relatedTableId.toString():s+"/"+a[0].relatedTableId.toString();const m=await Re(s,l.spatialReference,f,p,t.lrucache,t.interceptor);await m.load();let w=m.relationshipMetaData();if(w=w.filter(h=>h.id===a[0].id),n.hasField(a[0].keyField)===!1||n.field(a[0].keyField)===null){const h=await l.getFeatureByObjectId(n.field(l.objectIdField),[a[0].keyField]);if(h){const T=x.create(w[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return T.parameters={id:h.attributes[a[0].keyField]},m.filter(T)}return new Oe({parentfeatureset:m})}const D=x.create(w[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return D.parameters={id:n.field(a[0].keyField)},m.filter(D)})},i.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),i.functions.featuresetbyassociation=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{b(e,2,3,t,r);const n=e[0],o=E(L(e[1],"")).toLowerCase(),f=v(e[2])?E(e[2]):null;if(e[0]===null)return null;if(!G(e[0]))throw new u(t,c.InvalidParameter,r);let p=n._layer;if(p instanceof ne&&(p=q(p,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),p===null||A(p)===!1)return null;await p.load();const l=p.serviceUrl(),a=await Ue(l,t.spatialReference);let s=null,m=null,w=!1;if(f!==null&&f!==""&&f!==void 0){for(const g of a.terminals)g.terminalName===f&&(m=g.terminalId);m===null&&(w=!0)}const D=a.associations.getFieldsIndex(),h=D.get("TOGLOBALID").name,T=D.get("FROMGLOBALID").name,V=D.get("TOTERMINALID").name,J=D.get("FROMTERMINALID").name,W=D.get("FROMNETWORKSOURCEID").name,H=D.get("TONETWORKSOURCEID").name,U=D.get("ASSOCIATIONTYPE").name,Ie=D.get("ISCONTENTVISIBLE").name,ge=D.get("OBJECTID").name;for(const g of p.fields)if(g.type==="global-id"){s=n.field(g.name);break}let P=null,ae=new M(new j({name:"percentalong",alias:"percentalong",type:"double"}),x.create("0",{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC})),oe=new M(new j({name:"side",alias:"side",type:"string"}),x.create("''",{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC}));const S="globalid",se="globalId",le={};for(const g in a.lkp)le[g]=a.lkp[g].sourceId;const R=new Me(new j({name:"classname",alias:"classname",type:"string"}),null,le);let I="";switch(o){case"midspan":{I=`((${h}='${s}') OR ( ${T}='${s}')) AND (${U} IN (5))`,R.codefield=x.create(`CASE WHEN (${h}='${s}') THEN ${W} ELSE ${H} END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC});const g=te(C.findField(a.associations.fields,T));g.name=S,g.alias=S,P=new M(g,x.create(`CASE WHEN (${T}='${s}') THEN ${h} ELSE ${T} END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC})),ae=a.unVersion>=4?new ee(C.findField(a.associations.fields,D.get("PERCENTALONG").name)):new M(new j({name:"percentalong",alias:"percentalong",type:"double"}),x.create("0",{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{I=`((${h}='${s}') OR ( ${T}='${s}')) AND (${U} IN (4,6))`,R.codefield=x.create(`CASE WHEN (${h}='${s}') THEN ${W} ELSE ${H} END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC});const g=te(C.findField(a.associations.fields,T));g.name=S,g.alias=S,P=new M(g,x.create(`CASE WHEN (${T}='${s}') THEN ${h} ELSE ${T} END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC})),oe=new M(new j({name:"side",alias:"side",type:"string"}),x.create(`CASE WHEN (${U}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let g=`${h}='@T'`,fe=`${T}='@T'`;m!==null&&(g+=` AND ${V}=@A`,fe+=` AND ${J}=@A`),I="(("+g+") OR ("+fe+"))",I=B(I,"@T",s??""),g=B(g,"@T",s??""),m!==null&&(g=B(g,"@A",m.toString()),I=B(I,"@A",m.toString())),R.codefield=x.create("CASE WHEN "+g+` THEN ${W} ELSE ${H} END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC});const Q=te(C.findField(a.associations.fields,T));Q.name=S,Q.alias=S,P=new M(Q,x.create("CASE WHEN "+g+` THEN ${T} ELSE ${h} END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC}));break}case"container":I=`${h}='${s}' AND ${U} = 2`,m!==null&&(I+=` AND ${V} = `+m.toString()),R.codefield=W,I="( "+I+" )",P=new _(C.findField(a.associations.fields,T),S,S);break;case"content":I=`(${T}='${s}' AND ${U} = 2)`,m!==null&&(I+=` AND ${J} = `+m.toString()),R.codefield=H,I="( "+I+" )",P=new _(C.findField(a.associations.fields,h),S,S);break;case"structure":I=`(${h}='${s}' AND ${U} = 3)`,m!==null&&(I+=` AND ${V} = `+m.toString()),R.codefield=W,I="( "+I+" )",P=new _(C.findField(a.associations.fields,T),S,se);break;case"attached":I=`(${T}='${s}' AND ${U} = 3)`,m!==null&&(I+=` AND ${J} = `+m.toString()),R.codefield=H,I="( "+I+" )",P=new _(C.findField(a.associations.fields,h),S,se);break;default:throw new u(t,c.InvalidParameter,r)}return w&&(I="1 <> 1"),new C({parentfeatureset:a.associations,adaptedFields:[new ee(C.findField(a.associations.fields,ge)),new ee(C.findField(a.associations.fields,Ie)),P,oe,R,ae],extraFilter:I?x.create(I,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC}):null})})},i.signatures.push({name:"featuresetbyassociation",min:2,max:6}),i.functions.groupby=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{if(b(e,3,3,t,r),!A(e[0]))throw new u(t,c.InvalidParameter,r);const n=await e[0].load(),o=[],f=[];let p=!1,l=[];if(v(e[1]))l.push(e[1]);else if(e[1]instanceof Z)l.push(e[1]);else if(N(e[1]))l=e[1];else{if(!k(e[1]))throw new u(t,c.InvalidParameter,r);l=e[1].toArray()}for(const a of l)if(v(a)){const s=x.create(E(a),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),m=pe(s)===!0?E(a):"%%%%FIELDNAME";o.push({name:m,expression:s}),m==="%%%%FIELDNAME"&&(p=!0)}else{if(!(a instanceof Z))throw new u(t,c.InvalidParameter,r);{const s=a.hasField("name")?a.field("name"):"%%%%FIELDNAME",m=a.hasField("expression")?a.field("expression"):"";if(s==="%%%%FIELDNAME"&&(p=!0),!s)throw new u(t,c.InvalidParameter,r);o.push({name:s,expression:x.create(m||s,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(l=[],v(e[2]))l.push(e[2]);else if(N(e[2]))l=e[2];else if(k(e[2]))l=e[2].toArray();else{if(!(e[2]instanceof Z))throw new u(t,c.InvalidParameter,r);l.push(e[2])}for(const a of l){if(!(a instanceof Z))throw new u(t,c.InvalidParameter,r);{const s=a.hasField("name")?a.field("name"):"",m=a.hasField("statistic")?a.field("statistic"):"",w=a.hasField("expression")?a.field("expression"):"";if(!s||!m||!w)throw new u(t,c.InvalidParameter,r);f.push({name:s,statistic:m.toLowerCase(),expression:x.create(w,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(p){const a={};for(const m of n.fields)a[m.name.toLowerCase()]=1;for(const m of o)m.name!=="%%%%FIELDNAME"&&(a[m.name.toLowerCase()]=1);for(const m of f)m.name!=="%%%%FIELDNAME"&&(a[m.name.toLowerCase()]=1);let s=0;for(const m of o)if(m.name==="%%%%FIELDNAME"){for(;a["field_"+s.toString()]===1;)s++;a["field_"+s.toString()]=1,m.name="FIELD_"+s.toString()}}for(const a of o)await ie(a.expression,i,t);for(const a of f)await ie(a.expression,i,t);return e[0].groupby(o,f)})},i.signatures.push({name:"groupby",min:3,max:3}),i.functions.distinct=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{if(A(e[0])){b(e,2,2,t,r);const n=await e[0].load(),o=[];let f=[];if(v(e[1]))f.push(e[1]);else if(e[1]instanceof Z)f.push(e[1]);else if(N(e[1]))f=e[1];else{if(!k(e[1]))throw new u(t,c.InvalidParameter,r);f=e[1].toArray()}let p=!1;for(const l of f)if(v(l)){const a=x.create(E(l),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),s=pe(a)===!0?E(l):"%%%%FIELDNAME";o.push({name:s,expression:a}),s==="%%%%FIELDNAME"&&(p=!0)}else{if(!(l instanceof Z))throw new u(t,c.InvalidParameter,r);{const a=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",s=l.hasField("expression")?l.field("expression"):"";if(a==="%%%%FIELDNAME"&&(p=!0),!a)throw new u(t,c.InvalidParameter,r);o.push({name:a,expression:x.create(s||a,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(p){const l={};for(const s of n.fields)l[s.name.toLowerCase()]=1;for(const s of o)s.name!=="%%%%FIELDNAME"&&(l[s.name.toLowerCase()]=1);let a=0;for(const s of o)if(s.name==="%%%%FIELDNAME"){for(;l["field_"+a.toString()]===1;)a++;l["field_"+a.toString()]=1,s.name="FIELD_"+a.toString()}}for(const l of o)await ie(l.expression,i,t);return e[0].groupby(o,[])}return We(e)})},i.functions.getfeaturesetinfo=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{if(b(e,1,1,t,r),!A(e[0]))return null;const n=await e[0].getFeatureSetInfo();return n?Z.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},me(t),!1,!1):null})},i.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),i.functions.filterbysubtypecode=function(t,r){return i.standardFunctionAsync(t,r,async(y,F,e)=>{if(b(e,2,2,t,r),A(e[0])){const n=await e[0].load(),o=e[1];if(!Ae(o))throw new u(t,c.InvalidParameter,r);if(n.subtypeField){const p=x.create(`${n.subtypeField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new K({parentfeatureset:e[0],whereclause:p})}if(n.typeIdField===null||n.typeIdField==="")throw new u(t,c.FeatureSetDoesNotHaveSubtypes,r);const f=x.create(`${n.typeIdField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new K({parentfeatureset:e[0],whereclause:f})}throw new u(t,c.InvalidParameter,r)})},i.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{Qi as registerFunctions};
