import{b as Te}from"./Graphic-CFXUQZlS.js";import{i as U,z as De,R as v,V as xe}from"./opacityUtils-CSd4XoR2.js";import{c as j,t as Ee,D as Ne,l as $}from"./arcade-CrJG569S.js";import{a as p,r as y}from"./executionError-HS8X1L-B.js";import{R as Ae,q as me,p as ve,c as ee,e as Se,a as Le,b as Ce,N as J,j as Ze,F as ke,E as Pe,L as H,B as Re,d as q,f as P,k as te}from"./featureSetUtils-ClqRM5RZ.js";import{t as Ue}from"./ImmutableArray-BPVd6ESQ.js";import{o as E,g as je,h as ne,B as L,y as N,N as Me,i as ce,t as ue,Q as pe,q as Z,Z as V,H as K,a as W,G as Oe,b as G,j as ze,P as Q}from"./deepClone-DC5Ed1NQ.js";import{l as He}from"./portalUtils-3wOWt06C.js";import{u as We,O as ye}from"./SpatialFilter-CYuTxFd5.js";import{x as we,s as ie}from"./shared-M7rSkUll.js";import{S as Ve}from"./Accessor-BHnuXKD2.js";import{D as T}from"./WhereClause-diW5rNp6.js";import Fe from"./FeatureLayer-9fyQxXYm.js";import{y as R}from"./Field-Cyk7Ur5d.js";import{C as Ie}from"./Portal-CTRRujjZ.js";import{queryAssociations as Ge}from"./queryAssociations-C12Ya1_E.js";import{p as _e}from"./NetworkElement-Dpf4duUb.js";import Be from"./QueryAssociationsParameters-Dmd3yoIN.js";import"./Clonable-DvJsj5LF.js";import"./reactiveUtils-BR0C1Kq4.js";import"./Evented-DCWccWGU.js";import"./SimpleObservable-7oieNGD8.js";import"./JSONSupport-CGdeqxpk.js";import"./cast-BA_-jlhc.js";import"./index-tefRSezt.js";import"./writer-B2bQV2uU.js";import"./enumeration-Cr5WIZs4.js";import"./Promise-CmQqe-ke.js";import"./Color-gncXBiLc.js";import"./colorUtils-Rxh2V3ai.js";import"./mathUtils-DV9iOXpW.js";import"./ActionToggle-__-l4AdQ.js";import"./Identifiable-BrT7zvUW.js";import"./jsonUtils-Cu7OBRmN.js";import"./Extent-CBBGeHb-.js";import"./Point-XGrwlf63.js";import"./Polyline-BmuD2-ZN.js";import"./typeUtils-BSg8Y507.js";import"./TextSymbol-BQ_NW9Xo.js";import"./screenUtils-_ZIvrt5o.js";import"./collectionUtils-CbaToa73.js";import"./vec3f64-BLpZdpfb.js";import"./aaBoundingBox-CeBivBRq.js";import"./TimeOnly-yGYcAQQJ.js";import"./featureConversionUtils-DpmsPUmt.js";import"./OptimizedFeature-DcMLlxvB.js";import"./memoryEstimations-5gFNwkKK.js";import"./OptimizedGeometry-7IxBWtHr.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./FieldsIndex-DFdVonga.js";import"./timeZoneUtils-COos5xIr.js";import"./unitConversion-BDsSPToO.js";import"./number-BWHn6sm2.js";import"./hash-CcEbRgUF.js";import"./uuid-Cl5lrJ4c.js";import"./MD5-C9MwAd2G.js";import"./AttachmentQuery-BceVlzuF.js";import"./Query-DCBIeen2.js";import"./FullTextSearch-BWm_kPUE.js";import"./TimeExtent-J5qnUFx_.js";import"./timeUtils-D2X862bk.js";import"./FeatureType-DjGGrg1i.js";import"./FeatureTemplate-DqbLvkbZ.js";import"./RelationshipQuery-W-4bfgaH.js";import"./fieldType-L-VlbZqy.js";import"./Layer-C9uQlTBT.js";import"./PortalItem-CXk7DqVv.js";import"./operatorsWorkerConnection-Cx2N5ggJ.js";import"./workers-D8Q3pEzK.js";import"./Queue-BOnccek2.js";import"./intl-Do3GEEJ7.js";import"./MultiOriginJSONSupport-nGLpCFeg.js";import"./layerContainerType-C5CzMsLd.js";import"./FeatureLayerBase-DsahGowz.js";import"./formUtils-DXUHP5lI.js";import"./HeightModelInfo-B3GZyQFz.js";import"./commonProperties-C0eC30J9.js";import"./ElevationInfo-Di4W6v5U.js";import"./unitConversionUtils-C4AR5obr.js";import"./lengthUtils-DjJgJFRg.js";import"./AttributeTableTemplate-B7rH2qLr.js";import"./featureLayerUtils-BzWCGee1.js";import"./featureQueryAll-xezK3WCp.js";import"./layerUtils-dJgsXxkC.js";import"./SimpleRenderer-gSw1WaJS.js";import"./commonProperties-bGHL1a5M.js";import"./colorRamps-Dkx8zIVn.js";import"./SizeVariable-IzD1bP2e.js";import"./visualVariableUtils-Bp9QCb8E.js";import"./ColorStop-CDpeFWOz.js";import"./jsonUtils-Dzgxk9pw.js";import"./defaults-Dwxdhopq.js";import"./defaultsJSON-GKolV7NZ.js";import"./UniqueValueRenderer-Cri3tgP5.js";import"./diffUtils-CMkuJvD2.js";import"./RendererLegendOptions-mgfHoilI.js";import"./styleUtils-BB-zx7mT.js";import"./NormalizationBinParametersMixin-D6iHLB7I.js";import"./LayerFloorInfo-BXAHB-yQ.js";import"./Relationship-BBBusoKs.js";import"./serviceCapabilitiesUtils-BuKg0yWx.js";import"./infoFor3D-CsJzgCF0.js";import"./editsZScale-BKYnJc2O.js";import"./queryZScale-DwN6mTru.js";import"./projection-B2I9Bzj_.js";import"./projectBuffer-DOU0xvVi.js";import"./geodesicConstants-yASAK_zX.js";import"./FeatureSet-DpCN730g.js";import"./APIKeyMixin-Btq102Nx.js";import"./ArcGISService-BHkTabnw.js";import"./ScaleRangeLayer-C59zG_yk.js";import"./jsonUtils-TjZmCq6l.js";import"./utils-DYurMneM.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-Fi6iAz29.js";import"./common-DQOJ18NT.js";import"./CustomParametersMixin-uo3x70vd.js";import"./DisplayFilteredLayer-BFGyM6i5.js";import"./scaleUtils-CfLu-sg1.js";import"./displayFilterUtils-DV_nOx_h.js";import"./EditBusLayer-Cx9SJosU.js";import"./FeatureEffectLayer-D3Dl2pXD.js";import"./FeatureEffect-xxsfLT-y.js";import"./FeatureFilter-DEE1jTWq.js";import"./FeatureReductionLayer-x8j38_gH.js";import"./FeatureReductionSelection-BpUGF9oj.js";import"./labelingInfo-BvMdv93l.js";import"./labelUtils-Dq8OkaT-.js";import"./jsonUtils-DD1NMzWj.js";import"./typeUtils-CfF4cYo5.js";import"./ClassBreaksRenderer-BBSNkSFx.js";import"./LRUCache-DS2O1kTf.js";import"./MemCache-CDoaVBHf.js";import"./Version-9k2AOv05.js";import"./utils-B91u8350.js";import"./defaultCIMValues-DII_GG3u.js";import"./enums-BJSSbDkD.js";import"./HeatmapColorStop-c4wClnpW.js";import"./heatmapUtils-DA7NmY3d.js";import"./vec42-YcqnINSP.js";import"./vec4f64-o2zAXfmz.js";import"./OperationalLayer-Bts9W3HA.js";import"./OrderedLayer-BP2hvfL_.js";import"./OrderByInfo-E-O9nvtm.js";import"./PortalLayer-jhi5QQgB.js";import"./portalItemUtils-rm7sAgcm.js";import"./RefreshableLayer-Cn2UpWQD.js";import"./TemporalLayer-CYEvmdjr.js";import"./TimeInfo-LjqhhubF.js";import"./TimeInterval-BDTTJ9Uw.js";import"./TrackableLayer-D6paP6wl.js";import"./fieldProperties-B9JP3-ue.js";import"./TitleCreator-Zm6TQ_ec.js";import"./versionUtils-DSsYFI36.js";import"./styleUtils-BQ_uVsZf.js";import"./popupUtils-pQ0CVidQ.js";import"./interfaces-CL2NbQte.js";import"./typeUtils-CUNOqFiB.js";import"./utils-Cy8wFNQo.js";import"./Association-OQzB-QIu.js";function qe(i){if(i.length===1){if(v(i[0]))return $("distinct",i[0],-1);if(W(i[0]))return $("distinct",i[0].toArray(),-1)}return $("distinct",i,-1)}function re(i,t,r){const w=i.getVariables();if(w.length>0){const g={};for(const e of w)g[e]=t.evaluateIdentifier(r,{name:e});i.parameters=g}return i}function m(i,t,r=null){for(const w in i)if(w.toLowerCase()===t.toLowerCase())return i[w];return r}function ge(i){if(i===null)return null;const t={type:m(i,"type",""),name:m(i,"name","")};if(t.type==="range")t.range=m(i,"range",[]);else{t.codedValues=[];for(const r of m(i,"codedValues",[]))t.codedValues.push({name:m(r,"name",""),code:m(r,"code",null)})}return t}function ae(i){if(i===null)return null;const t={},r=m(i,"wkt");r!==null&&(t.wkt=r);const w=m(i,"wkid");return w!==null&&(t.wkid=w),t}function he(i){if(i===null)return null;const t={hasZ:m(i,"hasz",!1),hasM:m(i,"hasm",!1)},r=m(i,"spatialreference");r!=null&&(t.spatialReference=ae(r));const w=m(i,"x",null);if(w!==null)return t.x=w,t.y=m(i,"y",null),t.hasZ&&(t.z=m(i,"z",null)),t.hasM&&(t.m=m(i,"m",null)),t;const g=m(i,"rings",null);if(g!==null)return t.rings=g,t;const e=m(i,"paths",null);if(e!==null)return t.paths=e,t;const n=m(i,"points",null);if(n!==null)return t.points=n,t;for(const o of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const s=m(i,o,null);s!==null&&(t[o]=s)}return t}function Ke(i,t){for(const r of t)if(r===i)return!0;return!1}function Qe(i){return!!i.layerDefinition&&!!i.featureSet&&Ke(i.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&v(i.layerDefinition.fields)!==!1&&v(i.featureSet.features)!==!1}function _(i){return(i==null?void 0:i.toLowerCase())==="utc"?"UTC":(i==null?void 0:i.toLowerCase())==="unknown"?"Unknown":i}async function Je(i,t,r,w,g,e,n){var u,D,h;const o=await i.getFeatureSetInfo();if(((o==null?void 0:o.layerId)??null)===null||!g.layerIdLookup.get(o.layerId))return null;const s=i.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),c=[];switch(r){case"connected":c.push("connectivity"),c.push("junction-edge-from-connectivity"),c.push("junction-edge-to-connectivity"),c.push("junction-edge-midspan-connectivity"),c.push("junction-junction-connectivity");break;case"container":case"content":c.push("containment");break;case"structure":case"attached":c.push("attachment");break;case"junctionedge":c.push("junction-edge-from-connectivity"),c.push("junction-edge-to-connectivity");break;case"midspan":c.push("junction-edge-midspan-connectivity");break;default:throw new p(e,y.InvalidParameter,n)}let d=null,l=!1;if(w!==null&&w!==""&&w!==void 0){for(const I of g.terminals)I.terminalName===w&&(d=I.terminalId);d===null&&(l=!0)}const a=[];if(!l){const I=new _e({globalId:t.field(i.globalIdField),networkSourceId:g.layerIdLookup.get(o.layerId).sourceId,...d?{terminalId:d}:""}),x=await Ge(s,new Be({types:c,elements:[I]}));let B=0;for(const A of x.associations){let k=null,M="",S="";if(((u=A.fromNetworkElement)==null?void 0:u.globalId)===I.globalId?(k=A.toNetworkElement,S="to"):((D=A.toNetworkElement)==null?void 0:D.globalId)===I.globalId&&(k=A.fromNetworkElement,S="from"),!k)continue;switch(r){case"attached":if(A.associationType!=="attachment"||S!=="to")continue;break;case"structure":if(A.associationType!=="attachment"||S!=="from")continue;break;case"container":if(A.associationType!=="containment"||S!=="from")continue;break;case"content":if(A.associationType!=="containment"||S!=="to")continue;break;case"connected":break;case"junctionedge":A.associationType==="junction-edge-to-connectivity"?M="to":A.associationType==="junction-edge-from-connectivity"&&(M="from");break;case"midspan":if(A.associationType!=="junction-edge-midspan-connectivity")continue}const Y=((h=g.sourceIdLookup.get(k.networkSourceId))==null?void 0:h.className)??"";a.push(new Te({geometry:null,attributes:{objectId:B++,globalId:k.globalId,percentAlong:A.percentAlong??0,isContentVisible:A.isContentVisible?0:1,className:Y,side:M}}))}}const f=new Fe({source:a,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new R({name:"objectId",alias:"objectId",type:"oid"}),new R({name:"globalId",alias:"globalId",type:"global-id"}),new R({name:"percentAlong",alias:"percentAlong",type:"double"}),new R({name:"side",alias:"side",type:"string"}),new R({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new R({name:"className",alias:"className",type:"string"})]});return J(f)}function Ji(i){i.mode==="async"&&(i.functions.timezone=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{var s,c;if(E(e,1,2,t,r),je(e[0])||ne(e[0]))return"Unknown";if(L(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?_("unknown"):_(e[0].dateFieldsTimeZone);if(!(e[1]instanceof j)||e[1].hasField("type")===!1)throw new p(t,y.InvalidParameter,r);const d=e[1].field("type");if(U(d)===!1)throw new p(t,y.InvalidParameter,r);switch(N(d).toLowerCase()){case"preferredtimezone":return _(e[0].preferredTimeZone);case"editfieldsinfo":return _(((s=e[0].editFieldsInfo)==null?void 0:s.timeZone)??null);case"timeinfo":return _(((c=e[0].timeInfo)==null?void 0:c.timeZone)??null);case"field":if(e[1].hasField("fieldname")&&U(e[1].field("fieldname")))return _(e[0].fieldTimeZone(N(e[1].field("fieldname"))))}throw new p(t,y.InvalidParameter,r)}const n=Me(e[0],ce(t));if(n===null)return null;const o=n.timeZone;return o==="system"?De.systemTimeZoneCanonicalName:o.toLowerCase()==="utc"?"UTC":o.toLowerCase()==="unknown"?"Unknown":o})},i.functions.sqltimestamp=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{E(e,1,3,t,r);const n=e[0];if(ue(n)){if(e.length===1)return n.toSQLWithKeyword();if(e.length===2)return n.changeTimeZone(N(e[1])).toSQLWithKeyword();throw new p(t,y.InvalidParameter,r)}if(ne(n))return n.toSQLWithKeyword();if(L(n)){if(e.length!==3)throw new p(t,y.InvalidParameter,r);await n.load();const o=N(e[1]);if(ne(e[2]))return e[2].toSQLWithKeyword();if(ue(e[2])===!1)throw new p(t,y.InvalidParameter,r);const s=n.fieldTimeZone(o);return s==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(s).toSQLWithKeyword()}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"sqltimestamp",min:2,max:4}),i.functions.featuresetbyid=function(t,r){return i.standardFunctionAsync(t,r,(w,g,e)=>{if(E(e,2,4,t,r),pe(e[0])){const n=N(e[1]);let o=Z(e[2],null);const s=V(Z(e[3],!0));if(o===null&&(o=["*"]),v(o)===!1)throw new p(t,y.InvalidParameter,r);return e[0].featureSetById(n,s,o)}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"featuresetbyid",min:2,max:4}),i.functions.getfeatureset=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(E(e,1,2,t,r),K(e[0])){let n=Z(e[1],"datasource");return n===null&&(n="datasource"),n=N(n).toLowerCase(),Ae(e[0].fullSchema(),n,t.lrucache,t.interceptor,t.spatialReference??null)}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"getfeatureset",min:1,max:2}),i.functions.featuresetbyportalitem=function(t,r){return i.standardFunctionAsync(t,r,(w,g,e)=>{var d,l;if(E(e,2,5,t,r),e[0]===null)throw new p(t,y.PortalRequired,r);if(e[0]instanceof Ee){const a=N(e[1]),f=N(e[2]);let u=Z(e[3],null);const D=V(Z(e[4],!0));if(u===null&&(u=["*"]),v(u)===!1)throw new p(t,y.InvalidParameter,r);let h;return h=(d=t.services)!=null&&d.portal?t.services.portal:Ie.getDefault(),h=He(e[0],h),me(a,f,t.spatialReference??null,u,D,h,t.lrucache,t.interceptor)}if(U(e[0])===!1)throw new p(t,y.PortalRequired,r);const n=N(e[0]),o=N(e[1]);let s=Z(e[2],null);const c=V(Z(e[3],!0));if(s===null&&(s=["*"]),v(s)===!1)throw new p(t,y.InvalidParameter,r);return me(n,o,t.spatialReference??null,s,c,((l=t.services)==null?void 0:l.portal)??Ie.getDefault(),t.lrucache,t.interceptor)})},i.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),i.functions.featuresetbyname=function(t,r){return i.standardFunctionAsync(t,r,(w,g,e)=>{if(E(e,2,4,t,r),pe(e[0])){const n=N(e[1]);let o=Z(e[2],null);const s=V(Z(e[3],!0));if(o===null&&(o=["*"]),v(o)===!1)throw new p(t,y.InvalidParameter,r);return e[0].featureSetByName(n,s,o)}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"featuresetbyname",min:2,max:4}),i.functions.featureset=function(t,r){return i.standardFunction(t,r,(w,g,e)=>{E(e,1,1,t,r);const n={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(U(e[0])){const o=JSON.parse(e[0]);o.layerDefinition!==void 0?(n.layerDefinition=o.layerDefinition,n.featureSet=o.featureSet,o.layerDefinition.spatialReference&&(n.layerDefinition.spatialReference=o.layerDefinition.spatialReference)):(n.featureSet.features=o.features,n.featureSet.geometryType=o.geometryType,n.layerDefinition.geometryType=n.featureSet.geometryType,n.layerDefinition.objectIdField=o.objectIdFieldName??"",n.layerDefinition.typeIdField=o.typeIdFieldName,n.layerDefinition.globalIdField=o.globalIdFieldName,n.layerDefinition.fields=o.fields,o.spatialReference&&(n.layerDefinition.spatialReference=o.spatialReference))}else{if(!(e[0]instanceof j))throw new p(t,y.InvalidParameter,r);{const o=JSON.parse(e[0].castToText(!0)),s=m(o,"layerdefinition");if(s!==null){n.layerDefinition.geometryType=m(s,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.globalIdField=m(s,"globalidfield",""),n.layerDefinition.objectIdField=m(s,"objectidfield",""),n.layerDefinition.typeIdField=m(s,"typeidfield",""),n.layerDefinition.hasZ=m(s,"hasz",!1)===!0,n.layerDefinition.hasM=m(s,"hasm",!1)===!0;const c=m(s,"spatialreference");c&&(n.layerDefinition.spatialReference=ae(c));const d=[];for(const a of m(s,"fields",[])){const f={name:m(a,"name",""),alias:m(a,"alias",""),type:m(a,"type",""),nullable:m(a,"nullable",!0),editable:m(a,"editable",!0),length:m(a,"length",null),domain:ge(m(a,"domain"))};d.push(f)}n.layerDefinition.fields=d;const l=m(o,"featureset");if(l){const a={};for(const f of d)a[f.name.toLowerCase()]=f.name;for(const f of m(l,"features",[])){const u={},D=m(f,"attributes",{});for(const h in D)u[a[h.toLowerCase()]]=D[h];n.featureSet.features.push({attributes:u,geometry:he(m(f,"geometry"))})}}}else{n.layerDefinition.hasZ=m(o,"hasz",!1)===!0,n.layerDefinition.hasM=m(o,"hasm",!1)===!0,n.layerDefinition.geometryType=m(o,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.objectIdField=m(o,"objectidfieldname",""),n.layerDefinition.typeIdField=m(o,"typeidfieldname","");const c=m(o,"spatialreference");c&&(n.layerDefinition.spatialReference=ae(c));const d=[],l=m(o,"fields",null);if(!v(l))throw new p(t,y.InvalidParameter,r);for(const u of l){const D={name:m(u,"name",""),alias:m(u,"alias",""),type:m(u,"type",""),nullable:m(u,"nullable",!0),editable:m(u,"editable",!0),length:m(u,"length",null),domain:ge(m(u,"domain"))};d.push(D)}n.layerDefinition.fields=d;const a={};for(const u of d)a[u.name.toLowerCase()]=u.name;let f=m(o,"features",null);if(v(f))for(const u of f){const D={},h=m(u,"attributes",{});for(const I in h)D[a[I.toLowerCase()]]=h[I];n.featureSet.features.push({attributes:D,geometry:he(m(u,"geometry",null))})}else f=null,n.featureSet.features=f}}}if(Qe(n)===!1)throw new p(t,y.InvalidParameter,r);return n.layerDefinition.geometryType||(n.layerDefinition.geometryType="esriGeometryNull"),ve.create(n,t.spatialReference)})},i.signatures.push({name:"featureset",min:1,max:1}),i.functions.filter=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(E(e,2,2,t,r),v(e[0])||W(e[0])){const n=[];let o,s=e[0];if(s instanceof Ue&&(s=s.toArray()),!Oe(e[1]))throw new p(t,y.InvalidParameter,r);o=e[1].createFunction(t);for(const c of s){const d=o(c);Ve(d)?await d===!0&&n.push(c):d===!0&&n.push(c)}return n}if(L(e[0])){const n=await e[0].load(),o=T.create(e[1],{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),s=o.getVariables();if(s.length>0){const c={};for(const d of s)c[d]=i.evaluateIdentifier(t,{name:d});o.parameters=c}return new ee({parentfeatureset:e[0],whereclause:o})}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"filter",min:2,max:2}),i.functions.orderby=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(E(e,2,2,t,r),L(e[0])){const n=new Se(e[1]);return new Le({parentfeatureset:e[0],orderbyclause:n})}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"orderby",min:2,max:2}),i.functions.top=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(E(e,2,2,t,r),L(e[0]))return new Ce({parentfeatureset:e[0],topnum:e[1]});if(v(e[0]))return G(e[1])>=e[0].length?e[0].slice():e[0].slice(0,G(e[1]));if(W(e[0]))return G(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,G(e[1]));throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"top",min:2,max:2}),i.functions.first=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(E(e,1,1,t,r),L(e[0])){const n=await e[0].first(w.abortSignal);if(n!==null){const o=Ne.createFromGraphicLikeObject(n.geometry,n.attributes,e[0],t.timeZone);return o._underlyingGraphic=n,o}return n}return v(e[0])?e[0].length===0?null:e[0][0]:W(e[0])?e[0].length()===0?null:e[0].get(0):null})},i.signatures.push({name:"first",min:1,max:1}),i.functions.attachments=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{E(e,1,2,t,r);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof j){if(e[1].hasField("minsize")&&(n.minsize=G(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=V(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=G(e[1].field("maxsize"))),e[1].hasField("types")){const o=ze(e[1].field("types"),!1);o.length>0&&(n.types=o)}}else if(e[1]!==null)throw new p(t,y.InvalidParameter,r)}if(K(e[0])){const o=e[0]._layer;let s;if(L(o))s=o;else{if(o==null||!we(o))return[];s=J(o,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await s.load(),s.queryAttachments(e[0].field(s.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata)}if(e[0]===null)return[];throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"attachments",min:1,max:2}),i.functions.featuresetbyrelationshipname=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{E(e,2,4,t,r);const n=e[0],o=N(e[1]);let s=Z(e[2],null);const c=V(Z(e[3],!0));if(s===null&&(s=["*"]),v(s)===!1)throw new p(t,y.InvalidParameter,r);if(e[0]===null)return null;if(!K(e[0]))throw new p(t,y.InvalidParameter,r);const d=n._layer;let l;if(L(d))l=d;else{if(d==null||!we(d))return null;l=J(d,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}l=await l.load();const a=l.relationshipMetaData().filter(I=>I.name===o);if(a.length===0)return null;if(a[0].relationshipTableId!==void 0&&a[0].relationshipTableId!==null&&a[0].relationshipTableId>-1)return Ze(l,a[0],n.field(l.objectIdField),l.spatialReference,s,c,t.lrucache,t.interceptor);let f=l.serviceUrl();if(!f)return null;f=f.charAt(f.length-1)==="/"?f+a[0].relatedTableId.toString():f+"/"+a[0].relatedTableId.toString();const u=await ke(f,l.spatialReference,s,c,t.lrucache,t.interceptor);await u.load();let D=u.relationshipMetaData();if(D=D.filter(I=>I.id===a[0].id),n.hasField(a[0].keyField)===!1||n.field(a[0].keyField)===null){const I=await l.getFeatureByObjectId(n.field(l.objectIdField),[a[0].keyField]);if(I){const x=T.create(D[0].keyField+"= @id",{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC});return x.parameters={id:I.attributes[a[0].keyField]},u.filter(x)}return new We({parentfeatureset:u})}const h=T.create(D[0].keyField+"= @id",{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC});return h.parameters={id:n.field(a[0].keyField)},u.filter(h)})},i.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),i.functions.featuresetbyassociation=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{E(e,2,3,t,r);const n=e[0],o=N(Z(e[1],"")).toLowerCase(),s=U(e[2])?N(e[2]):null;if(e[0]===null)return null;if(!K(e[0]))throw new p(t,y.InvalidParameter,r);let c=n._layer;if(c instanceof Fe&&(c=J(c,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),c===null||L(c)===!1)return null;await c.load();const d=c.serviceUrl(),l=await Pe(d,t.spatialReference,!0);if(l.unVersion>=8)return await Je(c,n,o,s,l,t,r);const a=l.associations;let f=null,u=null,D=!1;if(s!==null&&s!==""&&s!==void 0){for(const b of l.terminals)b.terminalName===s&&(u=b.terminalId);u===null&&(D=!0)}const h=a.getFieldsIndex(),I=h.get("TOGLOBALID").name,x=h.get("FROMGLOBALID").name,B=h.get("TOTERMINALID").name,A=h.get("FROMTERMINALID").name,k=h.get("FROMNETWORKSOURCEID").name,M=h.get("TONETWORKSOURCEID").name,S=h.get("ASSOCIATIONTYPE").name,Y=h.get("ISCONTENTVISIBLE").name,be=h.get("OBJECTID").name;for(const b of c.fields)if(b.type==="global-id"){f=n.field(b.name);break}let O=null,oe=new H(new R({name:"percentalong",alias:"percentalong",type:"double"}),T.create("0",{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),le=new H(new R({name:"side",alias:"side",type:"string"}),T.create("''",{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));const C="globalid",se="globalId",de={};for(const b in l.lkp)de[b]=l.lkp[b].sourceId;const z=new Re(new R({name:"classname",alias:"classname",type:"string"}),null,de);let F="";switch(o){case"midspan":{F=`((${I}='${f}') OR ( ${x}='${f}')) AND (${S} IN (5))`,z.codefield=T.create(`CASE WHEN (${I}='${f}') THEN ${k} ELSE ${M} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});const b=ie(P.findField(a.fields,x));b.name=C,b.alias=C,O=new H(b,T.create(`CASE WHEN (${x}='${f}') THEN ${I} ELSE ${x} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),oe=l.unVersion>=4?new te(P.findField(a.fields,h.get("PERCENTALONG").name)):new H(new R({name:"percentalong",alias:"percentalong",type:"double"}),T.create("0",{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{F=`((${I}='${f}') OR ( ${x}='${f}')) AND (${S} IN (4,6))`,z.codefield=T.create(`CASE WHEN (${I}='${f}') THEN ${k} ELSE ${M} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});const b=ie(P.findField(a.fields,x));b.name=C,b.alias=C,O=new H(b,T.create(`CASE WHEN (${x}='${f}') THEN ${I} ELSE ${x} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),le=new H(new R({name:"side",alias:"side",type:"string"}),T.create(`CASE WHEN (${S}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let b=`${I}='@T'`,fe=`${x}='@T'`;u!==null&&(b+=` AND ${B}=@A`,fe+=` AND ${A}=@A`),F="(("+b+") OR ("+fe+"))",F=Q(F,"@T",f??""),b=Q(b,"@T",f??""),u!==null&&(b=Q(b,"@A",u.toString()),F=Q(F,"@A",u.toString())),z.codefield=T.create("CASE WHEN "+b+` THEN ${k} ELSE ${M} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});const X=ie(P.findField(a.fields,x));X.name=C,X.alias=C,O=new H(X,T.create("CASE WHEN "+b+` THEN ${x} ELSE ${I} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));break}case"container":F=`${I}='${f}' AND ${S} = 2`,u!==null&&(F+=` AND ${B} = `+u.toString()),z.codefield=k,F="( "+F+" )",O=new q(P.findField(a.fields,x),C,C);break;case"content":F=`(${x}='${f}' AND ${S} = 2)`,u!==null&&(F+=` AND ${A} = `+u.toString()),z.codefield=M,F="( "+F+" )",O=new q(P.findField(a.fields,I),C,C);break;case"structure":F=`(${I}='${f}' AND ${S} = 3)`,u!==null&&(F+=` AND ${B} = `+u.toString()),z.codefield=k,F="( "+F+" )",O=new q(P.findField(a.fields,x),C,se);break;case"attached":F=`(${x}='${f}' AND ${S} = 3)`,u!==null&&(F+=` AND ${A} = `+u.toString()),z.codefield=M,F="( "+F+" )",O=new q(P.findField(a.fields,I),C,se);break;default:throw new p(t,y.InvalidParameter,r)}return D&&(F="1 <> 1"),new P({parentfeatureset:a,adaptedFields:[new te(P.findField(a.fields,be)),new te(P.findField(a.fields,Y)),O,le,z,oe],extraFilter:F?T.create(F,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}):null})})},i.signatures.push({name:"featuresetbyassociation",min:2,max:6}),i.functions.groupby=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(E(e,3,3,t,r),!L(e[0]))throw new p(t,y.InvalidParameter,r);const n=await e[0].load(),o=[],s=[];let c=!1,d=[];if(U(e[1]))d.push(e[1]);else if(e[1]instanceof j)d.push(e[1]);else if(v(e[1]))d=e[1];else{if(!W(e[1]))throw new p(t,y.InvalidParameter,r);d=e[1].toArray()}for(const l of d)if(U(l)){const a=T.create(N(l),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),f=ye(a)===!0?N(l):"%%%%FIELDNAME";o.push({name:f,expression:a}),f==="%%%%FIELDNAME"&&(c=!0)}else{if(!(l instanceof j))throw new p(t,y.InvalidParameter,r);{const a=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",f=l.hasField("expression")?l.field("expression"):"";if(a==="%%%%FIELDNAME"&&(c=!0),!a)throw new p(t,y.InvalidParameter,r);o.push({name:a,expression:T.create(f||a,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(d=[],U(e[2]))d.push(e[2]);else if(v(e[2]))d=e[2];else if(W(e[2]))d=e[2].toArray();else{if(!(e[2]instanceof j))throw new p(t,y.InvalidParameter,r);d.push(e[2])}for(const l of d){if(!(l instanceof j))throw new p(t,y.InvalidParameter,r);{const a=l.hasField("name")?l.field("name"):"",f=l.hasField("statistic")?l.field("statistic"):"",u=l.hasField("expression")?l.field("expression"):"";if(!a||!f||!u)throw new p(t,y.InvalidParameter,r);s.push({name:a,statistic:f.toLowerCase(),expression:T.create(u,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(c){const l={};for(const f of n.fields)l[f.name.toLowerCase()]=1;for(const f of o)f.name!=="%%%%FIELDNAME"&&(l[f.name.toLowerCase()]=1);for(const f of s)f.name!=="%%%%FIELDNAME"&&(l[f.name.toLowerCase()]=1);let a=0;for(const f of o)if(f.name==="%%%%FIELDNAME"){for(;l["field_"+a.toString()]===1;)a++;l["field_"+a.toString()]=1,f.name="FIELD_"+a.toString()}}for(const l of o)re(l.expression,i,t);for(const l of s)re(l.expression,i,t);return e[0].groupby(o,s)})},i.signatures.push({name:"groupby",min:3,max:3}),i.functions.distinct=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(L(e[0])){E(e,2,2,t,r);const n=await e[0].load(),o=[];let s=[];if(U(e[1]))s.push(e[1]);else if(e[1]instanceof j)s.push(e[1]);else if(v(e[1]))s=e[1];else{if(!W(e[1]))throw new p(t,y.InvalidParameter,r);s=e[1].toArray()}let c=!1;for(const d of s)if(U(d)){const l=T.create(N(d),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),a=ye(l)===!0?N(d):"%%%%FIELDNAME";o.push({name:a,expression:l}),a==="%%%%FIELDNAME"&&(c=!0)}else{if(!(d instanceof j))throw new p(t,y.InvalidParameter,r);{const l=d.hasField("name")?d.field("name"):"%%%%FIELDNAME",a=d.hasField("expression")?d.field("expression"):"";if(l==="%%%%FIELDNAME"&&(c=!0),!l)throw new p(t,y.InvalidParameter,r);o.push({name:l,expression:T.create(a||l,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(c){const d={};for(const a of n.fields)d[a.name.toLowerCase()]=1;for(const a of o)a.name!=="%%%%FIELDNAME"&&(d[a.name.toLowerCase()]=1);let l=0;for(const a of o)if(a.name==="%%%%FIELDNAME"){for(;d["field_"+l.toString()]===1;)l++;d["field_"+l.toString()]=1,a.name="FIELD_"+l.toString()}}for(const d of o)re(d.expression,i,t);return e[0].groupby(o,[])}return qe(e)})},i.functions.getfeaturesetinfo=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(E(e,1,1,t,r),!L(e[0]))return null;const n=await e[0].getFeatureSetInfo();return n?j.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},ce(t),!1,!1):null})},i.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),i.functions.filterbysubtypecode=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(E(e,2,2,t,r),L(e[0])){const n=await e[0].load(),o=e[1];if(!xe(o))throw new p(t,y.InvalidParameter,r);if(n.subtypeField){const c=T.create(`${n.subtypeField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new ee({parentfeatureset:e[0],whereclause:c})}if(n.typeIdField===null||n.typeIdField==="")throw new p(t,y.FeatureSetDoesNotHaveSubtypes,r);const s=T.create(`${n.typeIdField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new ee({parentfeatureset:e[0],whereclause:s})}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{Ji as registerFunctions};
