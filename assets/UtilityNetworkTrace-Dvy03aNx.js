const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./calcite-action-eUVYjjgY.js","./action-CFB8-9mS.js","./jsxFactory-Be5PKa9i.js","./Evented-CXIxDjmW.js","./Accessor-D6mNnsWy.js","./subclass-BR3PhgZG.js","./intl-CArXn1et.js","./Promise-CZrWwByK.js","./jsonMap-DCC6W5ex.js","./assets-BNizZMOZ.js","./index-BVncS3aY.js","./index-CjOb8WjV.css","./reactiveUtils-BFQ0BtrB.js","./shared-B3wH2qpO.js","./uuid-fwrPAdZb.js","./dom-BkQ_hHOr.js","./interactive-QOqfpSSx.js","./loadable-Bgtgv1lm.js","./locale-BvYy6Wxh.js","./key-D5DPfjW0.js","./observers-DSkGD1TQ.js","./component-ByvC-PUv.js","./t9n-Atzq4sOi.js","./icon-D6t4qKDg.js","./loader-ew3V3w9x.js","./calcite-action-group-D9tipI-Z.js","./action-group-CCGYUHoR.js","./conditionalSlot-eNLH0S30.js","./action-menu-M1XR2Dkh.js","./array-DofFqflK.js","./popover-DLRbisRr.js","./floating-ui-5U9KNmUg.js","./debounce-C5YDvsuO.js","./focusTrapComponent-Bepj0OOn.js","./openCloseComponent-Bqj9CrBJ.js","./Heading-DQrTi3L3.js","./FloatingArrow-BN7WHE4B.js","./calcite-action-pad-DvLPXFZn.js","./ExpandToggle-CaJlw3EB.js","./calcite-block-CcSPCrEC.js","./handle-DVEsJI64.js","./scrim-fRLdjgt6.js","./calcite-block-section-9pC8uHW6.js","./switch-DRZSyDYK.js","./form-BOCdnUd9.js","./label-1rGx7O4B.js","./calcite-button-BbY9lAf2.js","./button-D5KuIed_.js","./calcite-checkbox-CABI4-6U.js","./calcite-color-picker-swatch-BAIP6a3p.js","./color-picker-swatch-C2F5t2iN.js","./calcite-combobox-DBG5Dw4c.js","./combobox-DrLFL3DM.js","./core-2D-WamSI.js","./filter-BHzLPuAd.js","./Validation-Dm76Kltf.js","./utils2-D-J1ilxn.js","./chip-Rm2iopRG.js","./combobox-item-D_DcFbZQ.js","./input-message-BGlL44gg.js","./calcite-combobox-item-Dz8KyY88.js","./calcite-flow-BBEB5sRb.js","./calcite-flow-item-BTLah491.js","./panel-LE_lpRLv.js","./calcite-icon-DtUarwQp.js","./calcite-input-number-C7vjRhaS.js","./input-number-C3dlLe78.js","./input-Dt5r39B0.js","./progress-CMyqabfC.js","./calcite-label-Ddcwlp7C.js","./calcite-list-CauCCaYV.js","./resources4-CT6dxwoZ.js","./utils3-SlIPNAt8.js","./input2-BjqyiC1c.js","./calcite-list-item-DnfVo5id.js","./calcite-loader-Cyav0WwQ.js","./calcite-notice-CVdHfJFK.js","./calcite-option-CMhra6rd.js","./calcite-panel-mkG8pQHp.js","./calcite-popover-B_Wlc0k9.js","./calcite-scrim-CYwFbyZL.js","./calcite-select-BWZbWbHD.js","./calcite-tab-IAhpRZkk.js","./tab-psBOJ1x8.js","./calcite-tab-nav-Bj63Es3k.js","./tab-nav-BjrokqfG.js","./calcite-tab-title-BDSk-HVn.js","./tab-title--qtRp7SP.js","./calcite-tabs-BW3hYh2l.js","./tabs-BWuMbxNy.js","./calcite-tooltip-5IY_tl60.js"])))=>i.map(i=>d[i]);
import{_ as g}from"./index-BVncS3aY.js";import{o as _e,e as h}from"./Evented-CXIxDjmW.js";import{V as oe,w as we,d as L,p as Z}from"./reactiveUtils-BFQ0BtrB.js";import{n as fe,c as K,y as p,b as ne}from"./subclass-BR3PhgZG.js";import{a as ce}from"./Field-poIiHWUc.js";import{e as B,B as ve,n as l,r as be,s as Ae}from"./jsxFactory-Be5PKa9i.js";import{e as x}from"./globalCss-CZa70j6i.js";import{e as Te}from"./vmEvent-D4Ubqkbq.js";import{t as Re}from"./assets-BNizZMOZ.js";import{u as Q,l as Se}from"./jsonUtils-DtWlwXHP.js";import{h as ue}from"./Promise-CZrWwByK.js";import ke from"./FeatureLayer-UOSH_sw8.js";import he from"./GraphicsLayer-DACkzSwx.js";import{r as z,x as Fe}from"./layerUtils-BzjQnEdj.js";import{T as Ie,n as X,e as Ce}from"./UtilityNetwork-C968dv8s.js";import{C as Me}from"./Portal-DCqdz-K4.js";import{t as Ge}from"./utils-BO9vnABf.js";import{trace as Ne}from"./trace-DC1OA9Cf.js";import{m as Ee,a as H}from"./TraceParameters-DBTJ4Bod.js";import"./geometry-CnaxvJsv.js";import{geodesicBuffer as Y,buffer as ee,convexHull as D,geodesicArea as Pe,planarArea as Oe,cut as te,planarLength as N}from"./geometryEngine-DyRMGqqp.js";import{m as Le}from"./Polyline-BQFeqYXi.js";import{K as V,W as Be}from"./projection-tSh-0UvX.js";import{f as $}from"./Point-TlcsOcXV.js";import{d as pe}from"./Graphic-Bi5hWHps.js";import{S as q,d as xe,y as ie}from"./TextSymbol-zZq0BA1M.js";import{l as He,k as De}from"./SnappingManager-DFm0py-D.js";import{p as Ve}from"./SketchViewModel-D-Ol7ZML.js";import{n as $e,k as Ue}from"./PopupTemplate-D8mXPxzU.js";import"./Accessor-D6mNnsWy.js";import"./shared-B3wH2qpO.js";import"./jsonMap-DCC6W5ex.js";import"./enumeration--HlxOQ_N.js";import"./writer-3zufXUNV.js";import"./fieldType-CIG5ey7e.js";import"./intl-CArXn1et.js";import"./uuid-fwrPAdZb.js";import"./Extent-B4rrMrqp.js";import"./ClassBreaksRenderer-B2uJHW90.js";import"./symbols-CfvYGR4J.js";import"./fieldUtils-C5R42-PY.js";import"./mathUtils-ClvKsMak.js";import"./Color-DDUWtbqR.js";import"./colorUtils-CS9vdHXB.js";import"./screenUtils-PfxkaaMN.js";import"./materialUtils-CQ3JLQ1x.js";import"./opacityUtils-BT7mQkwC.js";import"./aaBoundingBox-BGxkJAW0.js";import"./persistableUrlUtils-Dx61-x4K.js";import"./collectionUtils-Dm1icNvk.js";import"./Clonable-cKbRam6-.js";import"./UniqueValueRenderer-Q9ooDuxf.js";import"./diffUtils--7ofoPN-.js";import"./colorRamps-BBM5Timv.js";import"./SizeVariable-Bq7jlw1r.js";import"./ColorStop-DEfc5Idt.js";import"./sizeVariableUtils-Cmcuvw-4.js";import"./visualVariableUtils-CrTsYJ9f.js";import"./compilerUtils-BA04t1lN.js";import"./lengthUtils-vgIBtB6M.js";import"./ActionToggle-C0Z1k2jc.js";import"./Identifiable-BLvpQbOc.js";import"./jsonUtils-aUmUTP_F.js";import"./defaults-CIM29kXM.js";import"./defaultsJSON-GKolV7NZ.js";import"./styleUtils-C7rrjuqd.js";import"./jsonUtils-DsFdmTaK.js";import"./LRUCache-ju6LnIBZ.js";import"./MemCache-C6WUx-5V.js";import"./Version-_Vxue7Ui.js";import"./FieldsIndex-DHql50vu.js";import"./UnknownTimeZone-D0GlcniK.js";import"./OverrideHelper-0-cH6aQ2.js";import"./colorUtils-D5nOabzP.js";import"./vec42-B1mBkh1w.js";import"./vec4f64-CBQL1T0x.js";import"./utils-D8D39sLt.js";import"./quantizationUtils-DFd0XKEL.js";import"./HeatmapColorStop-7F2_sZ2U.js";import"./heatmapUtils-C-uT6ZIV.js";import"./SimpleRenderer-FL1Ywtqd.js";import"./MultiOriginJSONSupport-CvjUw5hc.js";import"./layerContainerType-C5CzMsLd.js";import"./FeatureLayerBase-BE0EfCO4.js";import"./inputs-BiRi4vRH.js";import"./formUtils-Dni92j4V.js";import"./HeightModelInfo-CzO-kRMK.js";import"./arcgisLayerUrl-ETqee4Bd.js";import"./commonProperties-BTyJ6vjt.js";import"./ElevationInfo-jptbPjRY.js";import"./unitConversionUtils-BUA_O87q.js";import"./featureLayerUtils-t2Um2-kg.js";import"./featureQueryAll-ClGLkoIX.js";import"./Query-BpMwiNVl.js";import"./TimeExtent-Dl-qaORu.js";import"./timeUtils-DQR2jUPL.js";import"./DataLayerSource-BX7Ap_tY.js";import"./FullTextSearch-BhJOgh_r.js";import"./AttachmentQuery-Ccywtvr9.js";import"./RelationshipQuery-DuLVs9A4.js";import"./LayerFloorInfo-Bx-Ddgjy.js";import"./Relationship-Cktwo5cM.js";import"./serviceCapabilitiesUtils-C8Sa1o3S.js";import"./Layer-CfUiPX3n.js";import"./workers-D8NOwm_V.js";import"./Queue-DpHko4Yk.js";import"./editsZScale-Bh8FjDvn.js";import"./queryZScale-DGW6qDy9.js";import"./FeatureSet-4rZsDUx9.js";import"./APIKeyMixin-DpJrW91V.js";import"./ArcGISService-aI6tC6k0.js";import"./BlendLayer-DmvCcS5c.js";import"./jsonUtils-C4Wp5KpV.js";import"./parser-BN6zmHl-.js";import"./utils-D20M4_S8.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-ybYUU6jq.js";import"./CustomParametersMixin-BStBpako.js";import"./EditBusLayer-BXrQoGfQ.js";import"./FeatureEffectLayer-DB6VToGX.js";import"./FeatureEffect-By-hP1x9.js";import"./FeatureFilter-DqmBE6ye.js";import"./FeatureReductionLayer-DLpK6ddX.js";import"./FeatureReductionSelection-BoaPXZg2.js";import"./labelingInfo-DAjvnaKu.js";import"./labelUtils-Cczy0uDR.js";import"./MD5-C9MwAd2G.js";import"./OperationalLayer-Bq6MAeyc.js";import"./OrderedLayer-DxmkHdYI.js";import"./OrderByInfo-D0jsxwzL.js";import"./PortalLayer-CX96aZTI.js";import"./PortalItem-CaeKabGc.js";import"./portalItemUtils-C4O2jNL5.js";import"./RefreshableLayer-B26jSd3d.js";import"./ScaleRangeLayer-CKYXLXxK.js";import"./TemporalLayer-DwHwsJsP.js";import"./TimeInterval-DtVUy51q.js";import"./TimeInfo-C84oEL3g.js";import"./FeatureTemplate-DbIjVC84.js";import"./FeatureType-o-GvSMTI.js";import"./fieldProperties-Lf6CXfwL.js";import"./versionUtils-BzPsp3a1.js";import"./styleUtils-BATHgMyw.js";import"./TopFeaturesQuery-CoSK-G18.js";import"./popupUtils-D3OP9u3f.js";import"./interfaces-CL2NbQte.js";import"./projectBuffer-iyGwL2dv.js";import"./geodesicConstants-kj1AtlGg.js";import"./GraphicsCollection-B0IuEpT5.js";import"./utils-Blh5cXWv.js";import"./geometryEngineBase-RmbNeFm7.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./hydrated-CRSW297p.js";import"./elevationInfoUtils-C0SzfJu0.js";import"./projectVectorToVector-BLdiwuTJ.js";import"./projectPointToVector-C-hGM2ap.js";import"./vec2-B_ymkwGp.js";import"./UpdatingHandles-CMtXpTiG.js";import"./vec2f64-Diu2Kaa8.js";import"./geodesicUtils-DyOqnDq-.js";import"./plane-Bz78OrLf.js";import"./mat3f64-BBpwCtoL.js";import"./mat4f64-Dk4dwAN8.js";import"./quatf64-BrpT0VRp.js";import"./mathUtils-kvswLROa.js";import"./sphere-DIv2hmik.js";import"./geometry2dUtils-BraNT6Fs.js";import"./floorFilterUtils-DZ5C6FQv.js";import"./InputManager-C4xu1R9l.js";import"./signal-DzOfzcfh.js";import"./keybindings-DYR2fa8r.js";import"./utils-CXgSw6Sd.js";import"./layerViewUtils-D2JqIDZ8.js";import"./geodesicLengthMeasurementUtils-YCCCQWpE.js";import"./quantityUtils-Cz8e0KG8.js";import"./Cyclical-BY_I03kj.js";import"./isSupportedObject-BcgHzf3B.js";import"./SketchLabelOptions-10TdxHmI.js";import"./layerUtils-BS1Di3Pm.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./screenUtils-BGG3AyYa.js";function U(e){return e.type==="polygon"||e.type==="polyline"}function je(e){return e.hasOwnProperty("points")}function We(e){return je(e)&&e.points.length===2}class de{createBuffer(t,i,s,r){if(Array.isArray(t)){if(t.length>0){const o=$.fromJSON(t[0].spatialReference);return o.isWGS84||o.isWebMercator?Y(t,i,s):ee(t,i,s,r)}return}const a=$.fromJSON(t.spatialReference);return a.isWGS84||a.isWebMercator?Y(t,i[0],s):ee(t,i[0],s)}createConvexHull(t){if(Array.isArray(t)){if(t.length===1&&We(t[0])){const s=D(t[0]);if(U(s))return s}return D(t,!0).filter(U)}const i=D(t);if(U(i))return i}calculateArea(t,i){const s=new $({wkid:t.spatialReference.wkid});return s.isWGS84||s.isWebMercator?parseFloat(Pe(t,i).toFixed(2)):parseFloat(Oe(t,i).toFixed(2))}mergeAggregatedToGeometries(t){const i=[],{line:s,multipoint:r,polygon:a}=t;return s&&i.push(s),r&&i.push(r),a&&i.push(a),i}getPercentageAlong(t,i,s){let r=t;const a=this._createPolyline(t.paths,s.wkid);if(i.type==="point"){const n=i.x-.5,c=i.x+.5,u=[[n,i.y-.5],[c,i.y+.5]];r=this._createPolyline(u,i.spatialReference.wkid),r=V(r,s);const d=te(a,r);if(d.length>0){const y=N(a,"feet");let _;return _=d[0].paths[0][0][0]===a.paths[0][0][0]?N(d[0],"feet"):N(d[1],"feet"),[_/y]}return[.5]}r=V(i,s);const o=te(a,r);if(o.length>0){const n=N(a,"feet");return[N(o[0],"feet")/n]}return[.5]}async projectGeometry(t,i){return await Be(),V(t,i)}_createPolyline(t,i){return new Le({hasZ:!1,hasM:!0,paths:t,spatialReference:{wkid:i}})}}const me=[227,27,21,.6],ge=[21,244,21,.6],O=12,J=[{color:[255,0,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ff0000"},{color:[255,0,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ff00ff"},{color:[217,188,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#D9BCFF"},{color:[0,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#00ff00"},{color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ffff00"},{color:[0,0,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#0000ff"},{color:[255,165,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#ffa500"},{color:[0,0,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#000000"}];let ze=class{constructor(){this.highlightColor=[...J]}addCustomColor(t){this.highlightColor=[...J],this.highlightColor.some(i=>i.hex.toLowerCase()===t.hex.toLowerCase())||this.highlightColor.push(t)}getFlagGraphic(t,i,s,r){const a=i==="starting-point"?ge:me;if(t.type==="polygon"){const o=t;o.centroid&&(t=o.centroid)}return r?this.makeGraphic(t,a,s==null?void 0:s.attributes,null,r):this.makeGraphic(t,a,s==null?void 0:s.attributes)}initializeSketch(t,i,s){const r=new oe;return s.forEach(a=>r.add(new He({layer:a,enabled:!0}))),new Ve({layer:i,view:t,snappingOptions:new De({enabled:!0,featureEnabled:!0,featureSources:r})})}makeGraphic(t,i,s,r,a){let o,n=t;switch(t.type){case"multipoint":o=new ie({color:i,size:O,outline:{color:i,width:0}}),r&&(n=t);break;case"point":o=a||new ie({color:i,size:O,outline:{color:i,width:0}}),r&&(n=t);break;case"polyline":o=new xe({color:i,width:O}),r&&(n=t);break;case"polygon":o=new q({color:i,outline:{color:i,width:O}}),r&&(n=t)}return new pe({geometry:n,symbol:o,attributes:s??null})}};const k=`utility-network-trace-result-area-${Date.now()}`;function E(e){return e.type==="graphics"}class qe{constructor(){this.traceInformation={},this._geometryHandler=new de}addResultAreaToMap(t,i){const s=this.createGraphicLayer(i);s&&E(s)&&s.add(t)}changeResultAreaColor(t,i,s){const r=new q({color:i.color,style:"solid",outline:{color:i.color,width:1}}),a=this._findGraphicsByTraceId(t,s);return a&&a.forEach(o=>{o.symbol=r}),r}createBuffer(t,i,s,r){return this._geometryHandler.createBuffer(t,i,s,r)}createConvexHull(t,i,s){const r=this._geometryHandler.createConvexHull(t);return i>0&&r?this.createBuffer(r,[i],s,!1):r}createResultAreaGraphic(t,i,s,r,a,o){var u;const n=new q({color:o.color,style:"solid",outline:{color:o.color,width:1}}),c=[];for(const d in i)c.push(new $e({fieldName:d,label:d==="areaStatistic"?r.attributeStrings[d]+" ("+((u=a.units[s])==null?void 0:u.abbr)+")":r.attributeStrings[d]}));return new pe({geometry:t,symbol:n,attributes:i,popupTemplate:new Ue({title:i.traceName,content:[{type:"fields",fieldInfos:c}]})})}removeResultArea(t,i){const s=i.findLayerById(k);if(s&&E(s)){const r=this._findGraphicsByTraceId(t,i);return r&&s.removeMany(r),r}return null}removeAllResultAreaGraphics(t){if(t){const i=t.findLayerById(k);i&&E(i)&&i.removeAll()}}createGraphicLayer(t,i){const s=t.findLayerById(k);if(s&&E(s))return s;const r=new he({title:i??k,listMode:"hide",id:k});return t.add(r),r}_findGraphicsByTraceId(t,i){const s=i.findLayerById(k);if(s&&E(s)){const r=s.graphics.filter(a=>a.attributes.traceId===t);return r.length>0?r.toArray():null}return null}}function se(e){return e.type==="feature"}function j(e,t){return e.url.includes(t)}function re(e,t){var i;return(((i=e.dataElement)==null?void 0:i.domainNetworks)||[]).some(s=>s.subnetworkLayerId===t.layerId)}class Je{getValidUtilityNetworkLayers(t,i){const s=[];return t==null||t.allLayers.forEach(r=>{r.type==="group"?s.push(...r.layers.filter(z).filter(a=>se(a)&&i.isUtilityLayer(a)&&!re(i,a)).filter(a=>j(a,i.featureServiceUrl)).toArray()):r.type==="subtype-group"?s.push(...r.sublayers.filter(a=>j(a,i.featureServiceUrl)).toArray()):z(r)&&se(r)&&i.isUtilityLayer(r)&&!re(i,r)&&j(r,i.featureServiceUrl)&&s.push(r)}),s}}const Ze=()=>ue("esri/widgets/UtilityNetworkTrace/t9n/UtilityNetworkTrace"),Ke=()=>ue("esri/core/t9n/Units"),S=`utility-network-trace-flags-${Date.now()}`,P=`utility-network-trace-results-${Date.now()}`;function Qe(e){return e instanceof ce}function Xe(e){return e.layer.type==="feature"||e.layer.type==="subtype-group"}function Ye(e){return"layer"in e}function et(e){return e.layerViews!==void 0}function tt(e){return e.type==="graphics"}async function it(e){var s;const t=new ke({url:e.networkSystemLayers.dirtyAreasLayerUrl});await t.load();const i=t.version;if(Number(i)<=11.1){const r=await Fe(e.layerUrl),a=new Me({url:r});await a.load();const o=(s=a==null?void 0:a.user)==null?void 0:s.username;return!!o&&Ge(a,o,"utilityNetwork")}return!0}let w=class extends _e.EventedAccessor{constructor(e){super(e),this._activeProgress=!1,this._clickHandler=null,this._flags=[],this._flagId=0,this._geometryHandler=null,this._highlightHandler=[],this._resultAreaHandler=null,this._utilityHelper=new Je,this._watchHandler=null,this._validUNLayers=[],this._traceTimeout=6e5,this._sketchViewModel=null,this.traces=[],this.graphicHandler=null,this.defaultGraphicColor={color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#FFFF00"},this.enableResultArea=!1,this.flags=[],this.gdbVersion="sde.DEFAULT",this.messages=null,this.messagesUnits=null,this.defaultResultAreaProperties={type:"convexhull",distance:10,unit:"meters",areaUnit:"square-meters",color:{color:[255,165,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#ffa500"},show:!1},this.selectedTraces=[],this.selectOnComplete=!0,this.showGraphicsOnComplete=!0,this.showSelectionAttributes=!0,this.traceResults=[],this.utilityNetwork=null}initialize(){this._geometryHandler=new de,this.graphicHandler=new ze,this._resultAreaHandler=new qe,(async()=>{const[e,t]=await Promise.all([Ze(),Ke()]);this.set({messages:e,messagesUnits:t})})()}destroy(){this.view=null}get resultAreaProperties(){return this.defaultResultAreaProperties}set resultAreaProperties(e){this._set("resultAreaProperties",{...this.defaultResultAreaProperties,...e}),this.graphicHandler.addCustomColor(this.resultAreaProperties.color),this.traceResults.forEach(t=>{var s;const i=(s=t.resultArea)==null?void 0:s.show;t.resultArea={...this.defaultResultAreaProperties,...e},this.removeResultAreaFromMap(t),this.enableResultArea&&this.createResultAreaGraphic(t).then(r=>{if(r){t.resultAreaGraphic=r;const a=(e==null?void 0:e.show)??i;t.resultArea&&(t.resultArea.show=a),a&&this.addResultAreaToMap(t,r)}})})}get state(){var e;return(e=this.view)!=null&&e.ready?"ready":"loading"}get view(){return this._get("view")}set view(e){e&&e.type!=="2d"&&fe.getLogger(this).error(new K("view:invalid-view","SceneView is not supported",{view:e})),this._set("view",e),this.utilityNetwork&&this.reset(),this.utilityNetwork=null,this.loadUtilityNetwork().then(t=>{t&&this.selectTracesOnLoad()})}addFlagByHit(e,t){const i=s=>{var r;(r=this.view)!=null&&r.popup&&(this.view.popupEnabled=s)};return new Promise((s,r)=>{var a;i(!1),(a=this._clickHandler)==null||a.remove(),this._clickHandler=this._sketchViewModel.on("create",o=>{if(o.state==="complete"){const n=this._getGraphicLayer(S);n&&o.graphic&&n.remove(o.graphic),this.queryFlagByHitTest(o,e,t).then(c=>{var u;i(!0),(u=this._clickHandler)==null||u.remove(),this.emit("add-flag-complete",{type:e,symbol:t}),s(c)}).catch(c=>{var u;i(!0),(u=this._clickHandler)==null||u.remove(),this.emit("add-flag-error",{type:e,symbol:t}),r(c)})}}),this._sketchViewModel.create("point"),this.emit("add-flag",{type:e})})}async addFlagsOnLoad(){return this._flags.length>0?[]:(await we(()=>this.view!=null&&!this.view.updating),(await Promise.all(this.flags.map(async e=>{if(!e.mapPoint)return null;const{type:t}=e,i=e.mapPoint.clone(),s=t==="barrier"?me:ge,r={graphic:this.graphicHandler.makeGraphic(i,s),state:"complete",tool:"point",toolEventInfo:null,type:"create"};try{return await this.queryFlagByHitTest(r,e.type,null),this.emit("add-flag-complete",{type:t}),null}catch{return this.emit("add-flag-error",{type:t}),t==="barrier"?"barrier":"starting-point"}}))).filter(e=>!e))}async addResultAreaToMap(e,t){var i,s;if(this.view){if(e.resultArea.show=!0,t)(i=this._resultAreaHandler)==null||i.addResultAreaToMap(t,this.view.map),this.emit("add-result-area",{graphic:t});else if(e.results){const r=await this.createResultAreaGraphic(e);r&&(e.resultAreaGraphic=r,(s=this._resultAreaHandler)==null||s.addResultAreaToMap(r,this.view.map),this.emit("add-result-area",{graphic:r}))}}}async addResultGraphicToView(e,t){var r;const{view:i}=this,{results:s}=e;if(i&&s&&this.utilityNetwork){for(const a in s.aggregatedGeometry)if("line,multipoint,polygon".includes(a)){const o=a,n=s.aggregatedGeometry[o];if(n!=null){n.spatialReference=this.utilityNetwork.spatialReference,e.graphicEnabled=!0;const c=await this._geometryHandler.projectGeometry(n,i.spatialReference),u={globalid:e.trace.globalId};if(c!==null){const d=this.graphicHandler.makeGraphic(c,t.color,u,i.spatialReference);(r=this._getGraphicLayer(P))==null||r.add(d)}}}}}addTerminal(e,t){const i=[...this._flags];i.forEach(s=>{var r,a;s.globalId===t.globalId&&((r=t.selectedTerminals)!=null&&r.includes(parseInt(e,10))||((a=s.selectedTerminals)==null||a.push(parseInt(e,10))))}),this._flags=i}async callTrace(){const e=this.traces.filter(t=>t.selected);return e.length>0&&(this.traceResults.length>0&&this.traceResults.forEach(t=>{this.removeResultGraphicFromView(t)}),this.traceResults=[],this.removeSelection(),await Promise.all(e.map(async(t,i)=>{var a;const s=t,r=new Ee({gdbVersion:this.utilityNetwork?this.utilityNetwork.gdbVersion:this.gdbVersion,moment:null,traceType:s.traceType,traceLocations:this._flags,namedTraceConfigurationGlobalId:s.globalId,traceConfiguration:null,outSpatialReference:null,resultTypes:null});await this.executeTrace(s,(a=this.utilityNetwork)==null?void 0:a.networkServiceUrl,r).then(o=>{if(o.hasOwnProperty("results")){const n={...o};if(n.results!==null){n.resultArea={...this.resultAreaProperties};const c=[...n.results.elements];n.results.elements.length=0;const u=new Map;for(const y of c)u.has(y.globalId)||(u.set(y.globalId,!0),n.results.elements.push(y));const d=[...this.traceResults];d.splice(i,0,n),this.traceResults=d,n.results!==null&&(this.selectOnComplete&&this.mergeSelection(!0,n.trace),this.showGraphicsOnComplete&&this.addResultGraphicToView(n,n.graphicColor),this.enableResultArea&&this.createResultAreaGraphic(n).then(y=>{var _;y&&(n.resultAreaGraphic=y,(_=n.resultArea)!=null&&_.show&&this.addResultAreaToMap(n,n.resultAreaGraphic))}))}else{const c=[...this.traceResults];c.splice(i,0,o),this.traceResults=c}this._activeProgress=!1}else{this._activeProgress=!1;const n=[...this.traceResults];n.splice(i,0,o),this.traceResults=n}}).catch(o=>{throw this._activeProgress=!1,o})})),!0)}changeResultAreaColor(e,t){var s;if(!e.resultArea)return;e.resultArea.color=t;const i=(s=this._resultAreaHandler)==null?void 0:s.changeResultAreaColor(e.trace.globalId,t,this.view.map);e.resultAreaGraphic&&(e.resultAreaGraphic.symbol=i)}changeResultGraphicColor(e,t){const i=[...this.traceResults];i.length>0&&i.forEach(s=>{s.trace.globalId===t.trace.globalId&&(s.graphicColor=e,s.graphicEnabled=!0)}),this.traceResults=i,this.removeResultGraphicFromView(t),this.addResultGraphicToView(t,e)}changeFlagSymbol(e,t){this._flags.length>0&&this._flags.forEach(i=>{i.type===e&&t&&i.mapGraphic&&(i.mapGraphic.symbol=t)})}checkCanTrace(){const e={status:!0,issues:[]};let t=!1;const i=this._flags.some(a=>a.type==="starting-point"),s=this._flags.filter(a=>a.allTerminals!==null);s.length>0&&(t=s.some(a=>a.selectedTerminals.length<=0));let r=[];return i?(r=this.traces.filter(a=>a.selected),r.length<=0?(e.status=!1,e.issues=["noTrace"],t&&(e.status=!1,e.issues=["noTrace","noTerminalSelected"])):t&&(e.status=!1,e.issues=["noTerminalSelected"])):(r=this.traces.filter(a=>a.selected===!0),r.length>0?(e.status=!1,e.issues=["noStart"],t&&(e.status=!1,e.issues=["noStart","noTerminalSelected"])):(e.status=!1,e.issues=["noStart","noTrace"],t&&(e.status=!1,e.issues=["noStart","noTrace","noTerminalSelected"]))),e}checkSelectionExist(){return this._highlightHandler.some(e=>e)}clearResult(e){if(!this.view)return;let t=this.traceResults;if(t.length>0){const i=t.filter(s=>s.trace.globalId===e.globalId);i.length>0&&(this.removeResultGraphicFromView(i[0]),this.removeResultAreaFromMap(i[0])),t=t.filter(s=>s.trace.globalId!==e.globalId)}this.traceResults=t,t.length===0?(this.removeAllResultAreaGraphics(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]})):this.mergeSelection(!1,e)}createResultAreaGeometries(e,t,i){var a,o,n,c,u,d,y,_,A,T,F,I,C,M;if(!this.view||!this.resultAreaProperties)return;let s;if(s=((a=this.resultAreaProperties)==null?void 0:a.type)==="convexhull"?t.length===1&&(Q(t[0])||Se(t[0])&&t[0].points.length===1)?(n=this._resultAreaHandler)==null?void 0:n.createBuffer(t,i,(o=e.resultArea)==null?void 0:o.unit,!0):(d=this._resultAreaHandler)==null?void 0:d.createConvexHull(t,(c=e.resultArea)==null?void 0:c.distance,(u=e.resultArea)==null?void 0:u.unit):(_=this._resultAreaHandler)==null?void 0:_.createBuffer(t,i,(y=e.resultArea)==null?void 0:y.unit,!0),!s)return;if(Array.isArray(s)){for(const f of s){const R=this.getResultAreaAttributes(e,f),G=(F=this._resultAreaHandler)==null?void 0:F.createResultAreaGraphic(f,R,(A=e.resultArea)==null?void 0:A.areaUnit,this.messages,this.messagesUnits,(T=e.resultArea)==null?void 0:T.color);if(G)return G}return}const r=this.getResultAreaAttributes(e,s);return(M=this._resultAreaHandler)==null?void 0:M.createResultAreaGraphic(s,r,(I=e.resultArea)==null?void 0:I.areaUnit,this.messages,this.messagesUnits,(C=e.resultArea)==null?void 0:C.color)}async createResultAreaGraphic(e){var t;if(e.results){const i=await this._createResultAreaInputGeometry(e.results);if(i.length>0){const s=Array(i.length).fill((t=e.resultArea)==null?void 0:t.distance),r=this.createResultAreaGeometries(e,i,s);return this.emit("create-result-area",{graphic:r}),r}}}executeTrace(e,t,i){const s=this._processFlags(i.traceLocations);return i.traceLocations=s,Ne(t,i,{timeout:this._traceTimeout}).then(r=>({trace:e,results:r,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:"success",date:new Date})).catch(r=>({trace:e,results:null,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:r.message,date:new Date}))}getResultAreaAttributes(e,t){var o,n,c;const{messages:i}=this,s=[],r=[];this._flags.forEach(u=>{var y,_,A,T;const d=((y=u.displayValue)==null?void 0:y.field)+":"+((_=u.displayValue)==null?void 0:_.value)+";"+i.attributeStrings.globalid+":"+u.globalId+";"+i.attributeStrings.terminalid+":"+u.terminalId+";"+i.attributeStrings.x+":"+((A=u.mapPoint)==null?void 0:A.x)+";"+i.attributeStrings.y+":"+((T=u.mapPoint)==null?void 0:T.y);u.type==="starting-point"?s.push(d):r.push(d)});const a=this.utilityNetwork?this.utilityNetwork.gdbVersion:this.gdbVersion;return{traceId:e.trace.globalId,traceName:e.trace.title,traceDescription:e.trace.description??"",startingPoints:s.toString(),barriers:r.toString(),version:a??void 0,username:Re.credentials[0].userId,date:e.date,elementCount:(o=e.results)==null?void 0:o.elements.length,functionResult:JSON.stringify((n=e.results)==null?void 0:n.globalFunctionResults),areaStatistic:t?this._geometryHandler.calculateArea(t,(c=e.resultArea)==null?void 0:c.areaUnit):0}}getValidSources(){var i,s;let e=[];const t=((s=(i=this.utilityNetwork)==null?void 0:i.dataElement)==null?void 0:s.domainNetworks)??[];for(const r of t)e=e.concat(r.junctionSources),e=e.concat(r.edgeSources);return e}groupResultsByNetworkSource(e){return e.length===0?[]:this._groupBy(e,"networkSourceId")}async loadUtilityNetwork(){var s;const{view:e}=this;if(!e)return null;if(await e.when(),this.utilityNetwork){if(this.utilityNetwork.loaded||await this.utilityNetwork.load(),this.utilityNetwork instanceof Ie){try{await e.map.loadAll(),this._loadUNSupportItems()}catch{this._loadUNSupportItems()}return this.utilityNetwork}return null}const t=e.map,i=(s=t.utilityNetworks)==null?void 0:s.at(0);if(i){if(await i.load(),this.utilityNetwork=i,!await it(i))throw new K("utility-network:no-user-type-extension","User type extension not found");try{await t.loadAll(),this._loadUNSupportItems()}catch{}finally{this._loadUNSupportItems()}return i}return null}manageFilterBarrier(e,t){const i=[...this._flags];i.forEach(s=>{s.globalId===t.globalId&&t.type==="barrier"&&s.id===t.id&&(s.isFilterBarrier=e)}),this._flags=i}mergeSelection(e,t){let i=[];const s=[...this.traceResults],r=t.globalId;s.forEach(a=>{var o,n;r===a.trace.globalId&&(a.selectionEnabled=e),a.selectionEnabled&&((o=a.results)==null?void 0:o.elements)!==null&&(i=[...i,...((n=a.results)==null?void 0:n.elements)??[]])}),this.selectResults([...new Set(i)])}async queryFeaturesById(e){var o;const{view:t}=this;if(!t||!this.utilityNetwork)return null;const i=X(this.utilityNetwork,e),s={layerUrl:i[0].layerUrl,objectIds:i[0].objectIds,outFields:["*"]},r=((o=t.map)==null?void 0:o.allTables.toArray().filter(n=>{var c;return((c=n==null?void 0:n.parsedUrl)==null?void 0:c.path)===i[0].layerUrl}).filter(z))??[];this._getUniqueMapLayerViews(t).filter(({layer:n})=>{var c;return((c=n==null?void 0:n.parsedUrl)==null?void 0:c.path)===i[0].layerUrl}).forEach(({layer:n})=>{n.type!=="feature"&&n.type!=="subtype-group"||r.push(n)});const a=(await Promise.all(r.map(async n=>{const c={layers:new oe([n]),layerInfos:[s],returnGeometry:!0,outSpatialReference:t.spatialReference},[u]=await Ce(c);return u}))).filter(({featureSet:n})=>n.features.length>0);return a.length>0?a:null}queryFlagByHitTest(e,t,i){return this._lookupFlagByHit(e).then(s=>{const{view:r}=this;if(!r)return!1;if(s.length>0){const a=[...this._flags],o=i;return s.forEach(n=>{var d,y;const c=n.graphic,u=c.attributes.hasOwnProperty("GLOBALID")?c.attributes.GLOBALID:c.attributes.globalid;if(a.filter(_=>_.globalId===u).length<=0){const _=this.graphicHandler.getFlagGraphic(c.attributes.mapPoint,t,c,o);(d=this._getGraphicLayer(S))==null||d.add(_);const A=this._createFlagProperty(c,t,_);a.push(A)}else if(c.attributes.percentAlong!==null){const _=this.graphicHandler.getFlagGraphic(c.attributes.mapPoint,t,c,o);(y=this._getGraphicLayer(S))==null||y.add(_);const A=this._createFlagProperty(c,t,_);a.push(A)}}),this._flags=a,!0}return!1})}removeResultGraphicFromView(e){var r;const{view:t}=this;if(!t)return;const i=(r=this._getGraphicLayer(P))==null?void 0:r.graphics;e.graphicEnabled=!1;const s=i==null?void 0:i.filter(a=>a.attributes[a.attributes.hasOwnProperty("GLOBALID")?"GLOBALID":"globalid"]===e.trace.globalId);s==null||s.forEach(a=>{var o;(o=this._getGraphicLayer(P))==null||o.remove(a)})}removeFlag(e){const t=this._flags.filter(i=>{if(i.id!==e.id)return i});this._removeGraphic(e),this._flags=t}removeAllResultAreaGraphics(){var e;(e=this._resultAreaHandler)==null||e.removeAllResultAreaGraphics(this.view.map)}removeResultAreaFromMap(e){var t,i;if(e.resultArea){e.resultArea.show=!1;const s=(i=this._resultAreaHandler)==null?void 0:i.removeResultArea(e.trace.globalId,(t=this.view)==null?void 0:t.map);s&&this.emit("remove-result-area",{graphic:s})}}removeSelection(){this._highlightHandler.forEach(e=>{e&&e.remove()}),this._highlightHandler=[]}removeTerminal(e,t){const i=[...this._flags];i.forEach(s=>{var r,a;if(s.globalId===t.globalId&&((r=t.selectedTerminals)!=null&&r.includes(parseInt(e,10)))){const o=t.selectedTerminals.indexOf(parseInt(e,10));(a=s.selectedTerminals)==null||a.splice(o,1)}}),this._flags=i}removeFlagsOnLoadWatcher(){this._watchHandler&&this._watchHandler!==null&&this._watchHandler.remove()}removeClickHandler(){this._clickHandler&&(this._sketchViewModel.cancel(),this._clickHandler.remove())}reset(){var t,i;this._flags=[],this.traceResults=[];const e=[...this.traces];e.forEach(s=>{s.selected=!1}),this.traces=e,this.view&&((t=this._getGraphicLayer(P))==null||t.removeAll(),(i=this._getGraphicLayer(S))==null||i.removeAll(),this.removeAllResultAreaGraphics(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]}))}selectFeaturesById(e){const{view:t}=this;if(!t||!this.utilityNetwork)return;const i=X(this.utilityNetwork,e);this._getUniqueMapLayerViews(t).forEach(s=>{var r,a;Ye(s)&&((a=(r=s.layer)==null?void 0:r.parsedUrl)==null?void 0:a.path)===i[0].layerUrl&&Xe(s)&&this._highlightHandler.push(s.highlight(i[0].objectIds))})}selectResults(e){if(e.length>0){this.removeSelection();const t=this.groupResultsByNetworkSource(e),i=[];for(const s in t)this.selectFeaturesById(t[s]),i.push(this.queryFeaturesById(t[s]));Promise.all(i).then(s=>{this.emit("select-features",{resultSet:s})})}else this.removeSelection(),this.emit("clear-selection",{resultSet:[]})}selectTraces(e,t){const i=[...this.traces];i.forEach(s=>{t===s.globalId&&(s.selected=e)}),this.traces=i}selectTracesOnLoad(){var e;(e=this.utilityNetwork)!=null&&e.hasOwnProperty("sharedNamedTraceConfigurations")&&(this.traces=[...this.utilityNetwork.sharedNamedTraceConfigurations],this.traces.forEach(t=>{t.selected=!1,this.selectedTraces.includes(t.globalId)&&(t.selected=!0)}))}zoomToAsset(e){var t;(t=this.view)==null||t.goTo(e).catch(i=>console.error(i))}async _createResultAreaInputGeometry(e){if(e.aggregatedGeometry!=null)return this._geometryHandler.mergeAggregatedToGeometries(e.aggregatedGeometry);const t=this.groupResultsByNetworkSource(e.elements),i=[];for(const s in t)i.push(this.queryFeaturesById(t[s]));try{const s=await Promise.all(i),r=[];for(const a of s)if(a)for(const o of a)for(const n of o.featureSet.features)r.push(n.geometry);return r}catch{return[]}}_loadUNSupportItems(){var i;if(!this.utilityNetwork)return;const{map:e}=this.view,{messages:t}=this;this._populateOutfields(),this._createGraphicLayer(S),this._createGraphicLayer(P),(i=this._resultAreaHandler)==null||i.createGraphicLayer(e,t==null?void 0:t.alertsStrings.genericResultHeader),this._validUNLayers=this._utilityHelper.getValidUtilityNetworkLayers(e,this.utilityNetwork),this._sketchViewModel=this.graphicHandler.initializeSketch(this.view,this._getGraphicLayer(S),this._validUNLayers)}_getUniqueMapLayerViews(e){const t=[];return e.layerViews.filter(({layer:{type:i}})=>i==="feature"||i==="group"||i==="subtype-group").toArray().forEach(i=>{switch(i.layer.type){case"group":if(et(i))for(const s of i.layerViews)t.push(s);break;case"subtype-group":t.push(i);break;default:t.some(s=>s.layer.id===i.layer.id)||t.push(i)}}),t}_processFlags(e){const t=[];return e.forEach(i=>{if(i.selectedTerminals!==null&&i.selectedTerminals.length>0)i.selectedTerminals.forEach(s=>{const r=new H({globalId:i.globalId,percentAlong:i.percentAlong,terminalId:s,type:i.type,isFilterBarrier:i.isFilterBarrier});t.push(r)});else{const s=new H({globalId:i.globalId,percentAlong:i.percentAlong,type:i.type,isFilterBarrier:i.isFilterBarrier});t.push(s)}}),t}_getDisplayField(e){var t;return((t=e==null?void 0:e.layer)==null?void 0:t.type)==="subtype-sublayer"?this._getDisplayFieldBySublayer(e):this._getDisplayFieldByFeatureLayer(e)}_getDisplayFieldBySublayer(e){let t="",i="";const s=e.layer;t=this._checkParentForData(s,"displayField");for(const r in e.attributes){const a=r.toLowerCase();a===(t==null?void 0:t.toLowerCase())?(i=e.attributes[r],a==="assetgroup"||a==="assettype"?i=this._checkSubtype(s,s.subtypeCode):(i=this._checkDomain(s.fields,r,i),typeof i=="string"&&(i=this._defaultDisplayField(i,s)))):(i=this._checkDomain(s.fields,r,i),typeof i=="string"&&(i=this._defaultDisplayField(i,s)))}return{field:t,value:i.toString()}}_getDisplayFieldByFeatureLayer(e){var r,a;const t=e.layer;let i=t.displayField,s="";for(const o in e.attributes){const n=o.toLowerCase();if(n===(i==null?void 0:i.toLowerCase()))if(s=e.attributes[o],n==="assetgroup"||n==="assettype"){let c=e.attributes[t.typeIdField.toUpperCase()];c||(c=e.attributes[t.typeIdField.toLowerCase()]),i=t.typeIdField,s=this._checkSubtype(t,c),i===""&&(t.templates&&t.templates.length>0?(i=(r=t.templates[0])==null?void 0:r.name,s=(a=t.templates[0])==null?void 0:a.name):(i=t.displayField,s=e.attributes[o]))}else s=this._checkDomain(t.fields,o,s),typeof s=="string"&&(s=this._defaultDisplayField(s,t));else s=this._checkDomain(t.fields,o,s),typeof s=="string"&&(s=this._defaultDisplayField(s,t))}return{field:i,value:s?s.toString():""}}_checkSubtype(e,t){let i=t;if(e.type==="subtype-sublayer"){const s=this._checkParentForData(e,"subtypes");(s==null?void 0:s.length)>0&&s.forEach(r=>{r.code===t&&(i=r.name)})}else if(e.types!=null&&e.types.length>0){const s=e.types.filter(r=>r.id===t);s.length>0&&(i=s[0].name)}return i}_checkDomain(e,t,i){var a;let s=i;const r=e.filter(o=>o.name.toLowerCase()===t.toLowerCase());if(r.length>0&&Qe(r[0].domain)&&((a=r[0].domain)!=null&&a.codedValues)){const o=r[0].domain.codedValues.filter(({code:n})=>n===i);o.length>0&&(s=o[0].name)}return s}_checkParentForData(e,t){var i;return((i=e.parent)==null?void 0:i[t])??null}_defaultDisplayField(e,t){var i;return e.trim()?e:t.templates&&((i=t.templates)==null?void 0:i.length)>0?t.templates[0].name:t.title}get _uniqueFlagId(){return this._flagId++}_groupBy(e,t){return e.reduce((i,s)=>((i[s[t]]=i[s[t]]||[]).push(s),i),{})}async _lookupFlagByHit(e){var s,r,a,o;const t=(s=e.graphic)==null?void 0:s.geometry,i=[];if(t&&Q(t)&&this.view){const n=this.view.toScreen(t);if(n){const c=await this.view.hitTest(n,{include:this._validUNLayers});if(c&&c.results.length>0){const u=c.results.find(d=>d.layer!==null);if(((r=u.graphic)==null?void 0:r.geometry)!=null){if(u.graphic.geometry.type==="polyline"){const d={terminalId:null,isFilterBarrier:!1,allTerminals:null,selectedTerminals:null,percentAlong:this._geometryHandler.getPercentageAlong(u.graphic.geometry,(a=e.graphic)==null?void 0:a.geometry,u.graphic.geometry.spatialReference),displayValue:this._getDisplayField(u.graphic),mapPoint:u.mapPoint};u.graphic.attributes={...u.graphic.attributes,...d},i.push(u)}else if((u.graphic.geometry.type==="point"||u.graphic.geometry.type==="polygon")&&this.utilityNetwork!==null){const d=(o=this.utilityNetwork)==null?void 0:o.getTerminalConfiguration(u.graphic),y=this._getDisplayField(u.graphic),_={terminalId:d?d.terminals[0].id||null:1,isFilterBarrier:!1,allTerminals:d??null,selectedTerminals:[d?d.terminals[0].id||null:1],percentAlong:null,displayValue:y,mapPoint:u.mapPoint};u.graphic.attributes={...u.graphic.attributes,..._},i.push(u)}}}}}return i}_createFlagProperty(e,t,i){const s=new H;s.terminalId=e.attributes.terminalId,s.isFilterBarrier=e.attributes.isFilterBarrier,s.percentAlong=e.attributes.percentAlong,s.globalId=e.attributes.globalid||e.attributes.GLOBALID,s.type=t;const r=s;return r.details=e,r.mapGraphic=i,r.id=this._uniqueFlagId,r.allTerminals=e.attributes.allTerminals,r.selectedTerminals=e.attributes.selectedTerminals,r.displayValue=e.attributes.displayValue,r.mapPoint=e.attributes.mapPoint,r}async _populateOutfields(){var i;const e=(i=this.view)==null?void 0:i.map,t=this.getValidSources();e==null||e.layers.forEach(s=>{s.type==="group"?s.layers.forEach(r=>{t.some(a=>a.layerId===r.layerId)&&r.fields.some(a=>a.name.toLowerCase()==="assetgroup")&&(r.outFields=["assetgroup","assettype","globalid","objectid"])}):t.some(r=>r.layerId===s.layerId)&&s.fields.some(r=>r.name.toLowerCase()==="assetgroup")&&(s.outFields=["assetgroup","assettype","globalid","objectid"])})}_removeGraphic(e){var t;(t=this._getGraphicLayer(S))==null||t.remove(e.mapGraphic)}_createGraphicLayer(e){const{map:t}=this.view;if(!t.findLayerById(e)){const i=new he({title:e,listMode:"hide",id:e});t.add(i)}}_getGraphicLayer(e){const{map:t}=this.view;if(t){const i=t.findLayerById(e);if(i&&tt(i))return i}return null}};h([p()],w.prototype,"_activeProgress",void 0),h([p()],w.prototype,"_flags",void 0),h([p()],w.prototype,"traces",void 0),h([p()],w.prototype,"defaultGraphicColor",void 0),h([p()],w.prototype,"enableResultArea",void 0),h([p()],w.prototype,"flags",void 0),h([p()],w.prototype,"gdbVersion",void 0),h([p()],w.prototype,"messages",void 0),h([p()],w.prototype,"messagesUnits",void 0),h([p()],w.prototype,"resultAreaProperties",null),h([p()],w.prototype,"selectedTraces",void 0),h([p()],w.prototype,"selectOnComplete",void 0),h([p()],w.prototype,"showGraphicsOnComplete",void 0),h([p()],w.prototype,"showSelectionAttributes",void 0),h([p({readOnly:!0})],w.prototype,"state",null),h([p()],w.prototype,"traceResults",void 0),h([p()],w.prototype,"utilityNetwork",void 0),h([p({value:null})],w.prototype,"view",null),w=h([ne("esri.widgets.UtilityNetworkTrace.UtilityNetworkTraceViewModel")],w);const ye=w,v="esri-utility-trace-network",b={base:v,loaderContainer:`${v}__loader-container`,loader:`${v}__loader`,fadeIn:`${v}--fade-in`,addButtonContainer:`${v}__add-button-container`,noticeContainer:`${v}__notice-container`,listContainer:`${v}__list-container`,resultsContainer:`${v}__results-container`,flow:`${v}__flow`,numberInput:`${v}__number-input`,clearPrompt:`${v}__reset-prompt`,promptDivider:`${v}__divider`,paddingTop:`${v}__padTop`};function st(e){return{height:e+"px"}}function rt(e){return{width:e+"px"}}function at(){return{width:"75%"}}function ae(){return{textAlign:"center",padding:"1rem"}}function lt(e){return{width:"100%",height:window.getComputedStyle(e).getPropertyValue("max-height")}}function W(){return{height:"100%"}}function le(e){return{display:"flex",flexDirection:e}}function ot(e){return e instanceof ce}const nt={noExtension:-2147208474};let m=class extends ve{constructor(e,t){super(e,t),this._selectToolActive=!1,this._activeTrace=null,this._activeSwatch="",this._traceHeaderForFlow="",this._assetGroupHeader="",this._assetTypeHeader="",this._traceResultsFunctions=[],this._traceResultsAssetGroup=[],this._traceResultsAssetType=[],this._traceResultsIndividual=[],this._showTraceResultFunctions=!1,this._showTraceResultAssetGroup=!1,this._showTraceResultAssetType=!1,this._showIndividualRecords=!1,this._activeTab="input",this._flagViewType="starting-point",this._alertRemoveModal=!1,this._warningNoFlag=!1,this._warningNoTraceSelected=!1,this._warningNoStartAssetFound=!1,this._warningNoBarrierAssetFound=!1,this._warningNoTerminal=!1,this._confirmReset=!1,this._showResultOptions=!1,this._resultObjectIdField="objectid",this._resultDisplayField="objectid",this._resultSortField="objectid",this._resultSortOrder="desc",this._swatchNode=null,this._individualResultNode=null,this._symbolStartFlag=null,this._symbolBarrier=null,this._watchHandler=null,this._loadUNError=!0,this._errorMessage="",this.disabled=!0,this.inputSettings=[],this.messages=null,this.messagesCommon=null,this.messagesUnits=null,this.viewModel=new ye,this._afterComponentCreate=this._afterComponentCreate.bind(this)}initialize(){this._utilityNetworkTraceInitialized(),this.addHandles(L(()=>{var e;return(e=this.viewModel)==null?void 0:e.resultAreaProperties},()=>this.scheduleRender()))}get defaultGraphicColor(){return this.viewModel.defaultGraphicColor}set defaultGraphicColor(e){this.viewModel.defaultGraphicColor=e}get flags(){return this.viewModel.flags}set flags(e){this.viewModel.flags=e}get gdbVersion(){return this.viewModel.gdbVersion}set gdbVersion(e){this.viewModel.gdbVersion=e}get icon(){return"utility-network-trace"}set icon(e){this._overrideIfSome("icon",e)}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}get resultAreaProperties(){return this.viewModel.resultAreaProperties}set resultAreaProperties(e){this.viewModel.resultAreaProperties=e}get selectedTraces(){return this.viewModel.selectedTraces}set selectedTraces(e){this.viewModel.selectedTraces=e}get selectOnComplete(){return this.viewModel.selectOnComplete}set selectOnComplete(e){this.viewModel.selectOnComplete=e}get showGraphicsOnComplete(){return this.viewModel.showGraphicsOnComplete}set showGraphicsOnComplete(e){this.viewModel.showGraphicsOnComplete=e}get enableResultArea(){return this.viewModel.enableResultArea}set enableResultArea(e){this.viewModel.enableResultArea=e}get showSelectionAttributes(){return this.viewModel.showSelectionAttributes}set showSelectionAttributes(e){this.viewModel.showSelectionAttributes=e}get utilityNetwork(){return this.viewModel.utilityNetwork}set utilityNetwork(e){this.viewModel.utilityNetwork=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}async checkCanTrace(){this._confirmReset=!1;const e=this.viewModel.checkCanTrace();e.status?(this._warningNoFlag=!1,this._warningNoTraceSelected=!1,this._warningNoTraceSelected=!1,this._warningNoTerminal=!1,this._showTraceResultFunctions=!1,this._showTraceResultAssetGroup=!1,this._showTraceResultAssetType=!1,this._showIndividualRecords=!1,this.switchTab("result"),this.viewModel._activeProgress=!0,this.viewModel.removeAllResultAreaGraphics(),await this.viewModel.callTrace(),this.viewModel._activeProgress=!1):e.issues.forEach(t=>{switch(t){case"noStart":this._warningNoFlag=!0;break;case"noTerminalSelected":this._warningNoTerminal=!0;break;default:this._warningNoTraceSelected=!0}})}confirmReset(){this._confirmReset=!0}render(){const{state:e}=this.viewModel;this._mixCustomStrings(),this._overrideFlagSymbol();const t=e==="loading"?this._renderWarningMessage("noTraceConfig",!1):this._renderUtilityNetworkTrace();return l("div",{class:this.classes(b.base,x.widget,x.panel,{[x.widgetDisabled]:this.disabled}),styles:W()},t)}loadDependencies(){return be({action:()=>g(()=>import("./calcite-action-eUVYjjgY.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]),import.meta.url),"action-group":()=>g(()=>import("./calcite-action-group-D9tipI-Z.js"),__vite__mapDeps([25,26,2,3,4,5,6,7,8,9,10,11,12,13,14,27,20,17,18,15,19,22,28,29,1,16,21,23,24,30,31,32,33,34,35,36]),import.meta.url),"action-pad":()=>g(()=>import("./calcite-action-pad-DvLPXFZn.js"),__vite__mapDeps([37,2,3,4,5,6,7,8,9,10,11,12,13,14,27,20,15,17,18,19,22,38,26,28,29,1,16,21,23,24,30,31,32,33,34,35,36]),import.meta.url),block:()=>g(()=>import("./calcite-block-CcSPCrEC.js"),__vite__mapDeps([39,2,3,4,5,6,7,8,9,10,11,12,13,14,27,20,15,16,18,19,22,35,17,34,1,21,23,24,28,29,30,31,32,33,36,40,41]),import.meta.url),"block-section":()=>g(()=>import("./calcite-block-section-9pC8uHW6.js"),__vite__mapDeps([42,2,3,4,5,6,7,8,9,10,11,12,13,14,15,19,18,20,22,17,23,43,44,16,45,21]),import.meta.url),button:()=>g(()=>import("./calcite-button-BbY9lAf2.js"),__vite__mapDeps([46,47,2,3,4,5,6,7,8,9,10,11,12,13,14,44,15,16,45,21,17,18,19,20,22,23,24]),import.meta.url),checkbox:()=>g(()=>import("./calcite-checkbox-CABI4-6U.js"),__vite__mapDeps([48,2,3,4,5,6,7,8,9,10,11,12,13,14,15,44,16,19,45,21,17]),import.meta.url),"color-picker-swatch":()=>g(()=>import("./calcite-color-picker-swatch-BAIP6a3p.js"),__vite__mapDeps([49,50,2,3,4,5,6,7,8,9,10,11,12,13,14,15]),import.meta.url),combobox:()=>g(()=>import("./calcite-combobox-DBG5Dw4c.js"),__vite__mapDeps([51,52,2,3,4,5,6,7,8,9,10,11,12,13,14,53,54,32,15,31,44,16,45,21,17,18,19,20,34,22,55,56,57,23,58,27,59]),import.meta.url),"combobox-item":()=>g(()=>import("./calcite-combobox-item-Dz8KyY88.js"),__vite__mapDeps([60,58,2,3,4,5,6,7,8,9,10,11,12,13,14,27,20,15,16,56,21,23]),import.meta.url),flow:()=>g(()=>import("./calcite-flow-BBEB5sRb.js"),__vite__mapDeps([61,2,3,4,5,6,7,8,9,10,11,12,13,14,20,17]),import.meta.url),"flow-item":()=>g(()=>import("./calcite-flow-item-BTLah491.js"),__vite__mapDeps([62,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,22,63,28,29,1,21,23,24,30,31,32,33,34,35,36,41]),import.meta.url),icon:()=>g(()=>import("./calcite-icon-DtUarwQp.js"),__vite__mapDeps([64,23,2,3,4,5,6,7,8,9,10,11,12,13,14,15,20]),import.meta.url),"input-number":()=>g(()=>import("./calcite-input-number-C7vjRhaS.js"),__vite__mapDeps([65,66,2,3,4,5,6,7,8,9,10,11,12,13,14,15,44,16,19,45,21,17,18,20,22,55,67,23,59,68]),import.meta.url),label:()=>g(()=>import("./calcite-label-Ddcwlp7C.js"),__vite__mapDeps([69,2,3,4,5,6,7,8,9,10,11,12,13,14,45,15,21]),import.meta.url),list:()=>g(()=>import("./calcite-list-CauCCaYV.js"),__vite__mapDeps([70,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,20,71,72,17,22,18,19,54,32,23,73,44,45,21,55,67,59,68,24,41]),import.meta.url),"list-item":()=>g(()=>import("./calcite-list-item-DnfVo5id.js"),__vite__mapDeps([74,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,19,20,22,17,72,71,1,21,23,24,40]),import.meta.url),loader:()=>g(()=>import("./calcite-loader-Cyav0WwQ.js"),__vite__mapDeps([75,24,2,3,4,5,6,7,8,9,10,11,12,13,14,15,18,19,20]),import.meta.url),notice:()=>g(()=>import("./calcite-notice-CVdHfJFK.js"),__vite__mapDeps([76,2,3,4,5,6,7,8,9,10,11,12,13,14,27,20,15,17,18,19,22,34,21,23]),import.meta.url),option:()=>g(()=>import("./calcite-option-CMhra6rd.js"),__vite__mapDeps([77,2,3,4,5,6,7,8,9,10,11,12,13,14,20]),import.meta.url),panel:()=>g(()=>import("./calcite-panel-mkG8pQHp.js"),__vite__mapDeps([78,63,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,20,28,29,19,1,18,21,22,23,24,30,31,32,33,34,35,36,41]),import.meta.url),popover:()=>g(()=>import("./calcite-popover-B_Wlc0k9.js"),__vite__mapDeps([79,30,2,3,4,5,6,7,8,9,10,11,12,13,14,31,15,32,33,34,35,18,19,20,22,17,36,21,1,16,23,24]),import.meta.url),scrim:()=>g(()=>import("./calcite-scrim-CYwFbyZL.js"),__vite__mapDeps([80,41,2,3,4,5,6,7,8,9,10,11,12,13,14,18,15,19,20,22,24]),import.meta.url),select:()=>g(()=>import("./calcite-select-BWZbWbHD.js"),__vite__mapDeps([81,2,3,4,5,6,7,8,9,10,11,12,13,14,15,44,16,45,21,17,20,55,23,59]),import.meta.url),tab:()=>g(()=>import("./calcite-tab-IAhpRZkk.js"),__vite__mapDeps([82,83,2,3,4,5,6,7,8,9,10,11,12,13,14,15]),import.meta.url),"tab-nav":()=>g(()=>import("./calcite-tab-nav-Bj63Es3k.js"),__vite__mapDeps([84,85,2,3,4,5,6,7,8,9,10,11,12,13,14,53,15,20,18,19,22,47,44,16,45,21,17,23,24]),import.meta.url),"tab-title":()=>g(()=>import("./calcite-tab-title-BDSk-HVn.js"),__vite__mapDeps([86,87,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,20,18,19,22,21,23]),import.meta.url),tabs:()=>g(()=>import("./calcite-tabs-BW3hYh2l.js"),__vite__mapDeps([88,89,2,3,4,5,6,7,8,9,10,11,12,13,14,15]),import.meta.url),tooltip:()=>g(()=>import("./calcite-tooltip-5IY_tl60.js"),__vite__mapDeps([90,2,3,4,5,6,7,8,9,10,11,12,13,14,15,31,32,34,36]),import.meta.url)})}switchTab(e){this._activeTab=e}switchToFunctions(e,t){this._traceResultsFunctions=e,this._showTraceResultFunctions=t}switchToAssetGroup(e,t,i){this._traceHeaderForFlow=t,this._traceResultsAssetGroup=e,this._showTraceResultAssetGroup=i}switchToAssetType(e,t,i){this._assetGroupHeader=t,this._traceResultsAssetType=e,this._showTraceResultAssetType=i}switchToIndividualRecords(e,t,i){this._assetTypeHeader=t,this._traceResultsIndividual=e,this._showIndividualRecords=i}_renderUtilityNetworkTrace(){const{messages:e,messagesCommon:t}=this;let i=l("calcite-tabs",{layout:"center",position:"top",styles:lt(this.container)},l("calcite-tab-nav",{slot:"title-group"},l("calcite-tab-title",{onclick:()=>{this.switchTab("input")},selected:this._activeTab==="input"},e.inputsStrings.headerTabInputs),l("calcite-tab-title",{onclick:()=>{this.switchTab("result")},selected:this._activeTab==="result"},e.resultsStrings.headerTabResults)),l("calcite-tab",{selected:this._activeTab==="input"},this._renderInputPanel()),l("calcite-tab",{selected:this._activeTab==="result"},this.viewModel._activeProgress?l("calcite-loader",{label:e.alertsStrings.traceExecuting,text:e.alertsStrings.traceExecuting,type:"indeterminate"}):this.viewModel.traceResults.length>0?this._renderResultPanel():this._renderWarningMessage("noTraceExecuted",!1),this._confirmReset?l("calcite-scrim",{key:"prompt"},l("div",{class:b.clearPrompt},l("h3",{slot:"header"},e.resultsStrings.startOverButton),l("div",{slot:"content"},e.resultsStrings.startOverValidation),l("div",{class:b.promptDivider}),l("div",{styles:le("row")},l("calcite-button",{appearance:"outline",onclick:()=>{this._confirmReset=!1},slot:"secondary",width:"full"},t.cancel),l("calcite-button",{onclick:()=>{this._confirmReset=!1,this.viewModel.reset(),this.switchTab("input")},slot:"primary",width:"full"},t.form.ok)))):null));return this.viewModel.traces.length===0&&(i=l("calcite-panel",null,this._renderWarningMessage("noTraceConfig",!1))),this._loadUNError||(i=l("calcite-panel",null,this._renderWarningMessage("loadUNError",!1,this._errorMessage))),i}_renderInputPanel(){const{messages:e}=this;return l("calcite-flow",{class:b.flow},l("calcite-flow-item",null,this._warningNoFlag?this._renderWarningMessage("flag",!0):null,this._warningNoTerminal?this._renderWarningMessage("noTerminal",!0):null,this._warningNoTraceSelected?this._renderWarningMessage("trace",!0):null,this._renderTraceSelectorContainer(),this._renderStartFlagsContainer(),this._renderBarriersFlagsContainer(),this._warningNoFlag&&this._warningNoTraceSelected?l("div",{styles:st(10)}):null,l("calcite-button",{kind:"brand",onclick:()=>{this.checkCanTrace()},slot:"footer",width:"full"},e.tracingStrings.runTrace)),this._selectToolActive?this._renderActiveTool():null)}_renderResultPanel(){return l("calcite-flow",{styles:W()},this._renderTraceResults(),this._showTraceResultFunctions?this._renderTraceResultFunctions():null,this._showTraceResultAssetGroup?this._renderTraceResultByAssetGroup():null,this._showTraceResultAssetType?this._renderTraceResultByAssetType():null,this._showIndividualRecords?this._renderTraceResultIndividual():null,this._showIndividualRecords?this._renderTraceResultIndividualPopover():null)}_renderStartFlagsContainer(){const{messages:e}=this,t=[];let i=[];i=this.viewModel._flags.filter(r=>r.type==="starting-point"),i.forEach(r=>{r.displayValue&&t.push(this._renderFlagRow(r,"start"))});let s=null;return this._symbolStartFlag&&(s=this._getSymbolIcon(this._symbolStartFlag)),l("calcite-block",{collapsible:!0,heading:e.inputsStrings.headerStartingPoint+" ("+i.length+")",open:!0,overlayPositioning:"fixed"},l("div",{slot:"icon"},s||l("calcite-icon",{icon:"pin",scale:"s"})),l("div",null,e.inputsStrings.startingPointHint),l("div",{class:b.listContainer},t),this._warningNoStartAssetFound?this._renderWarningMessage("noStartAsset",!0):null,l("div",{class:b.addButtonContainer},l("calcite-button",{alignment:"center",appearance:"outline",href:"",iconStart:"plus",label:e.inputsStrings.addPointOption,onclick:()=>{this._changeCursor("crosshair"),this._flagViewType="starting-point",this._selectToolActive=!0,this._warningNoStartAssetFound=!1,this.viewModel.addFlagByHit("starting-point",this._symbolStartFlag).then(r=>{this._changeCursor("default"),r?this._warningNoFlag=!1:this._warningNoStartAssetFound=!0,this._selectToolActive=!1})},round:!0})))}_renderBarriersFlagsContainer(){const{messages:e}=this,t=[];let i=[];i=this.viewModel._flags.filter(r=>r.type==="barrier"),i.forEach(r=>{r.displayValue&&t.push(this._renderFlagRow(r,"barrier"))});let s=null;return this._symbolBarrier&&(s=this._getSymbolIcon(this._symbolBarrier)),l("calcite-block",{collapsible:!0,heading:e.inputsStrings.headerBarrier+" ("+i.length+")",open:!1,overlayPositioning:"fixed"},l("div",{slot:"icon"},s||l("calcite-icon",{icon:"x-circle-f",scale:"s"})),l("div",null,e.inputsStrings.barrierPointHint),l("div",{class:b.listContainer},t),this._warningNoBarrierAssetFound?this._renderWarningMessage("noBarrierAsset",!0):null,l("div",{class:b.addButtonContainer},l("calcite-button",{alignment:"center",appearance:"outline",href:"",iconStart:"plus",kind:"brand",label:e.inputsStrings.addPointOption,onclick:()=>{this._changeCursor("crosshair"),this._flagViewType="barrier",this._selectToolActive=!0,this._warningNoBarrierAssetFound=!1,this.viewModel.addFlagByHit("barrier",this._symbolBarrier).then(r=>{this._changeCursor("default"),r||(this._warningNoBarrierAssetFound=!0),this._selectToolActive=!1})},round:!0})))}_renderFlagRow(e,t){var o;const{messages:i,messagesCommon:s}=this,r=[];let a=!1;return e.allTerminals!=null&&e.allTerminals.terminals.length>0&&(a=!0,e.allTerminals.terminals.forEach(n=>{var u;let c=!1;(u=e==null?void 0:e.selectedTerminals)!=null&&u.includes(n.id)&&(c=!0),r.push(l("calcite-combobox-item",{key:n.name,selected:c,textLabel:n.name,value:n.id}))})),l("calcite-block",{collapsible:e.allTerminals!==null||e.type==="barrier",heading:((o=e.displayValue)==null?void 0:o.value)??"",key:"pop"+e.globalId+e.type+e.id+t,overlayPositioning:"fixed"},l("calcite-action",{icon:"trash",label:s.remove,onclick:()=>{this.viewModel.removeFlag(e)},scale:"s",slot:"header-menu-actions",text:s.remove,textEnabled:!0}),l("calcite-action",{icon:"zoom-to-object",label:i.globalStrings.zoomToFeature,onclick:()=>{this.viewModel.zoomToAsset(e.details.geometry)},scale:"s",slot:"header-menu-actions",text:i.globalStrings.zoomToFeature,textEnabled:!0}),e.type==="barrier"?l("calcite-label",{layout:"inline",scale:"s"},l("calcite-checkbox",{checked:e.isFilterBarrier,onclick:()=>{this.viewModel.manageFilterBarrier(!e.isFilterBarrier,e)},scale:"s"}),i.inputsStrings.barrierFilter):null,a?l("calcite-combobox",{label:i.globalStrings.selectTerminalPlaceholder,maxItems:0,placeholder:i.globalStrings.selectTerminalPlaceholder,scale:"s",selectionMode:"multiple",onCalciteComboboxChange:n=>{n.target.selectedItems.length>0?(e.selectedTerminals=[],n.target.selectedItems.forEach(c=>{this.viewModel.addTerminal(c.value,e)})):e.selectedTerminals=[]},onCalciteComboboxChipClose:n=>{n.preventDefault(),this.viewModel.removeTerminal(n.target.value,e)}},r):null)}_renderActiveTool(){const{messages:e}=this;let t=null;return this._flagViewType==="starting-point"?this._symbolStartFlag&&(t=this._getSymbolIcon(this._symbolStartFlag)):this._symbolBarrier&&(t=this._getSymbolIcon(this._symbolBarrier)),l("calcite-flow-item",{heading:e.inputsStrings.addPointOption,onCalciteFlowItemBack:()=>{var i;this.viewModel.removeClickHandler(),(i=this.view)!=null&&i.popup&&(this.view.popupEnabled=!0),this._changeCursor("default"),this._selectToolActive=!1}},l("calcite-block",{collapsible:!1,heading:"",open:!0,overlayPositioning:"fixed"},l("div",{styles:ae()},t||l("calcite-icon",{icon:this._flagViewType==="starting-point"?"pin-plus":"x-circle-f"})),l("div",{styles:ae()},e.inputsStrings.addPointHint)))}_renderTraceSelectorContainer(){const{messages:e}=this,t=[];let i=e.tracingStrings.traceOperation,s=0;return this.viewModel.traces.length>0&&this.viewModel.traces.forEach(r=>{t.push(l("calcite-combobox-item",{key:r.globalId,selected:r.selected,textLabel:r.title,value:r.globalId,onCalciteComboboxItemChange:a=>{const o=a.target;this.viewModel.selectTraces(o.selected,o.value),this.viewModel.traces.length>0&&(this._warningNoTraceSelected=!1)}})),r.selected&&s++}),i+=` (${s})`,l("calcite-block",{collapsible:!0,heading:i,open:!0,overlayPositioning:"fixed"},l("calcite-icon",{icon:"utility-network-trace",scale:"s",slot:"icon"}),l("calcite-combobox",{label:e.inputsStrings.selectTraces,maxItems:0,overlayPositioning:"fixed",placeholder:e.inputsStrings.selectTraces,scale:"s",selectionMode:"multiple"},t))}_renderStartOverContainer(){const{messages:e}=this;return l("calcite-button",{kind:"brand",onclick:()=>{this.confirmReset()},slot:"footer",width:"full"},e.resultsStrings.startOverButton)}_renderWarningMessage(e,t,i){const{messages:s}=this;let r=s.alertsStrings.NoRunAlertHeader,a=s.alertsStrings.noResultsInfo;switch(e){case"flag":r=s.alertsStrings.startingPointAlertHeader,a=s.alertsStrings.startingPointAlert;break;case"noTerminal":r=s.alertsStrings.noTerminalDefinedHeader,a=s.alertsStrings.noTerminalDefined;break;case"trace":r=s.alertsStrings.selectTraceAlertHeader,a=s.alertsStrings.selectTraceAlert;break;case"noTraceExecuted":r=s.alertsStrings.NoRunAlertHeader,a=s.alertsStrings.noResultsInfo;break;case"noBarrierAsset":case"noStartAsset":r=s.alertsStrings.noAssetsFoundHeader,a=s.alertsStrings.noAssetFound;break;case"noTraceConfig":r="",a=s.alertsStrings.noTraceSupported;break;default:r=s.alertsStrings.genericErrorHeader,a=i||""}return l("div",{class:b.noticeContainer,key:e},l("calcite-notice",{closable:t,icon:!0,key:e,kind:"danger",open:!0,scale:"s",width:"auto",onCalciteNoticeClose:()=>{switch(e){case"flag":this._warningNoFlag=!1;break;case"noTerminal":this._warningNoTerminal=!1;break;case"trace":this._warningNoTraceSelected=!1;break;case"noStartAsset":this._warningNoStartAssetFound=!1;break;case"noBarrierAsset":this._warningNoBarrierAssetFound=!1}}},l("div",{slot:"title"},r),l("div",{slot:"message"},a)))}_renderRemoveTraceContainer(e){const{messages:t}=this;return l("calcite-action",{icon:"trash",label:t.globalStrings.clearResults,onclick:()=>{this._alertRemoveModal=!0,this._activeTrace=e.trace},scale:"s",slot:"header-menu-actions",text:t.globalStrings.clearResults,textEnabled:!0})}_renderHighlightColorPicker(e,t,i){const{messages:s}=this,{graphicHandler:r}=this.viewModel,a=[],o=new RegExp(`^${e.hex}$`,"i"),n=r.highlightColor.length>J.length?5:4;for(const c of r.highlightColor)a.push(l("calcite-action",{active:o.test(c.hex),key:c.hex,label:s.resultsStrings.graphicColor,onclick:()=>{i==="aggregate"?this.viewModel.changeResultGraphicColor(c,t):this.viewModel.changeResultAreaColor(t,c)},scale:"s",text:s.resultsStrings.graphicColor},l("calcite-color-picker-swatch",{active:o.test(c.hex),color:c.hex,scale:"s"})));return l("calcite-action-pad",{expandDisabled:!0,layout:"grid",position:"start"},l("calcite-action-group",{columns:n,layout:"grid"},a))}_renderTraceResults(){const{messages:e,messagesCommon:t}=this,{selectFeatures:i}=e.resultsStrings,s=this.viewModel.traceResults,r=[];return s.forEach((a,o)=>{var A,T,F,I,C,M;let n=[],c=[],u=!1,d=!1,y=!1,_="";a.results!==null&&a.results.hasOwnProperty("elements")?(a.results.aggregatedGeometry!==null&&(d=!0),a.results.globalFunctionResults!==null&&a.results.globalFunctionResults.length>0&&(c=a.results.globalFunctionResults,c.length>0&&(y=!0)),a.results.elements&&a.results.elements.length>0&&(n=a.results.elements,n.length>0&&(u=!0)),(d||u)&&(_=(T=this.messagesUnits.units[(A=a.resultArea)==null?void 0:A.unit])==null?void 0:T.abbr),r.push(l("calcite-block",{collapsible:!0,description:a.trace.description??"",heading:a.trace.title,key:`${a.trace.title}${o}`,open:!0,overlayPositioning:"fixed"},this._renderRemoveTraceContainer(a),l("calcite-list",null,y?l("calcite-list-item",{label:e.resultsStrings.functionHeader+" ("+c.length+")",onCalciteListItemSelect:()=>{this.switchToFunctions(c,!0)}},l("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"})):null,u&&this.viewModel.showSelectionAttributes?l("calcite-list-item",{key:this.id,label:e.resultsStrings.viewFeatures+" ("+n.length+")",onCalciteListItemSelect:()=>{this.switchToAssetGroup(this._groupResultsByAssetGroup(a),a.trace.title+" ("+n.length+")",!0)}},l("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"})):this.viewModel.showSelectionAttributes?l("calcite-label",{layout:"inline",scale:"s"},e.resultsStrings.noSelectionResults):null),u?l("div",{class:b.paddingTop},l("calcite-label",{layout:"inline",onclick:f=>{f.preventDefault(),f.stopPropagation(),this.viewModel.mergeSelection(!a.selectionEnabled,a.trace)},scale:"s"},l("calcite-checkbox",{checked:a.selectionEnabled,onclick:f=>{f.preventDefault(),f.stopPropagation(),this.viewModel.mergeSelection(!a.selectionEnabled,a.trace)}}),this.viewModel.showSelectionAttributes?i:`${i} (${n.length})`)):null,d?l("calcite-block-section",{key:`aggregate-${a.trace.title}-${o}`,open:a.graphicEnabled,text:e.resultsStrings.highlightTrace,toggleDisplay:"switch",onCalciteBlockSectionToggle:f=>{f.target.open?this.viewModel.changeResultGraphicColor(a.graphicColor,a):this.viewModel.removeResultGraphicFromView(a)}},l("calcite-list",{selectionMode:"none"},l("calcite-list-item",{label:e.resultsStrings.graphicColor,onclick:f=>{const R=f.target;this._swatchNode=R,this._activeSwatch="aggGeom_"+o}},l("calcite-color-picker-swatch",{color:a.graphicColor.hex,scale:"s",slot:"actions-end"})))):null,this.enableResultArea&&(d||u)?l("calcite-block-section",{key:`area-${a.trace.title}-${o}`,open:(F=a.resultArea)==null?void 0:F.show,text:e.resultsStrings.resultAreaHeader,toggleDisplay:"switch",onCalciteBlockSectionToggle:f=>{f.target.open?a.resultAreaGraphic?this.viewModel.addResultAreaToMap(a,a.resultAreaGraphic):this.viewModel.addResultAreaToMap(a):this.viewModel.removeResultAreaFromMap(a)}},l("calcite-list",{selectionMode:"none"},l("calcite-list-item",{label:e.resultsStrings.graphicColor,onclick:f=>{const R=f.target;this._swatchNode=R,this._activeSwatch="resultArea_"+o}},l("calcite-color-picker-swatch",{color:(I=a.resultArea)==null?void 0:I.color.hex,scale:"s",slot:"actions-end"}))),l("calcite-list",{selectionMode:"none"},l("calcite-list-item",{label:e.resultsStrings.resultAreaBuffer},l("calcite-input-number",{afterCreate:this._afterComponentCreate,class:b.numberInput,max:999999,maxLength:999999,min:0,scale:"s",slot:"actions-end",suffixText:_,value:(C=a.resultArea)==null?void 0:C.distance.toString(),onCalciteInputNumberChange:f=>{var G;if(!((G=this.view)!=null&&G.popup))return;this.view.popup.visible&&this.view.closePopup();const R=f.target;a.resultArea.distance>=0?(a.resultArea.distance=parseInt(R.value,10),this.viewModel.removeResultAreaFromMap(a),this.viewModel.addResultAreaToMap(a)):(a.resultArea.distance=0,this.viewModel.removeResultAreaFromMap(a),this.viewModel.addResultAreaToMap(a))}})))):null,l("calcite-popover",{autoClose:!0,closable:!0,label:e.resultsStrings.graphicColor,offsetDistance:0,offsetSkidding:0,open:this._activeSwatch==="aggGeom_"+o||this._activeSwatch==="resultArea_"+o,placement:"auto-start",referenceElement:this._swatchNode,scale:"s",onCalcitePopoverClose:()=>{this._swatchNode=null,this._activeSwatch=null}},this._renderHighlightColorPicker(this._activeSwatch==="resultArea_"+o?(M=a.resultArea)==null?void 0:M.color:a.graphicColor,a,this._activeSwatch==="resultArea_"+o?"resultArea":"aggregate"))))):r.push(l("calcite-block",{collapsible:!1,heading:a.trace.title,key:"error-"+o,open:!0,overlayPositioning:"fixed"},this._renderRemoveTraceContainer(a),this._renderWarningMessage("noController",!1,a.status)))}),l("calcite-flow-item",{key:"traceResults",styles:W()},r,this._renderStartOverContainer(),this._alertRemoveModal?l("calcite-scrim",{key:"prompt"},l("div",{class:b.clearPrompt},l("h3",{slot:"header"},e.globalStrings.clearResults),l("div",{slot:"content"},e.alertsStrings.clearResultsAlert),l("div",{class:b.promptDivider}),l("div",{styles:le("row")},l("calcite-button",{appearance:"outline",onclick:()=>{this._alertRemoveModal=!1},slot:"secondary",width:"full"},t.cancel),l("calcite-button",{onclick:()=>{this._activeTrace&&this.viewModel.clearResult(this._activeTrace),this._alertRemoveModal=!1,this.viewModel.traceResults.length===0?this.switchTab("input"):(this._activeTrace=this.viewModel.traceResults[0].trace,this._showTraceResultFunctions=!1,this._showTraceResultAssetGroup=!1,this._showTraceResultAssetType=!1,this._showIndividualRecords=!1)},slot:"primary",width:"full"},t.form.ok)))):null)}_renderTraceResultFunctions(){const{messages:e}=this,t=this._traceResultsFunctions,i=[];return t.forEach(s=>{i.push(this._renderResultRowFunctions(s))}),l("calcite-flow-item",{heading:e.resultsStrings.functionHeader,key:"functionResultMultiple",onCalciteFlowItemBack:()=>{this.switchToFunctions([],!1)}},i,this._renderStartOverContainer())}_renderTraceResultByAssetGroup(){const e=this._traceResultsAssetGroup,t=[];for(const i in e){const s=e[i];for(const r in s)t.push(this._renderResultRowAssetGroup(s[r]))}return l("calcite-flow-item",{heading:this._traceHeaderForFlow,key:"assetGroupResultMultiple",onCalciteFlowItemBack:()=>{this.switchToAssetGroup([],"",!1)}},l("calcite-list",null,t),this._renderStartOverContainer())}_renderTraceResultByAssetType(){const e=this._traceResultsAssetType,t=[];for(const i in e)e[i].length>0&&t.push(this._renderResultRowAssetType(e[i]));return l("calcite-flow-item",{heading:this._assetGroupHeader,key:"assetTypeResult",onCalciteFlowItemBack:()=>{this.switchToAssetType([],"",!1)}},l("calcite-list",{selectionMode:"none"},t),this._renderStartOverContainer())}_renderTraceResultIndividual(){var s;const{messages:e}=this,t=this._traceResultsIndividual;t.sort(this._compare(this._resultSortField,this._resultSortOrder));const i=[];return t.length>0&&((((s=t[0].details)==null?void 0:s.fields.some(({name:r})=>r.toLowerCase()===this._resultDisplayField.toLocaleLowerCase()))??!1)||(this._resultDisplayField=this._resultObjectIdField,this._resultSortField=this._resultObjectIdField),t.forEach(r=>{r!=null&&r.details&&i.push(this._renderResultRowIndividual(r))}),i.length===0&&i.push(l("calcite-list-item",{label:e.resultsStrings.noFeaturesInMap}))),l("calcite-flow-item",{heading:this._assetTypeHeader,key:"individualResult",onCalciteFlowItemBack:()=>{this._showResultOptions=!1,this.switchToIndividualRecords([],"",!1)}},l("calcite-action",{afterCreate:Ae,bind:this,"data-node-ref":"_individualResultNode",icon:"gear",id:"field_options"+this.id,label:e.resultsStrings.displayAttribute,onclick:()=>{this._showResultOptions=!0},slot:"header-actions-end",text:e.resultsStrings.displayAttribute}),l("calcite-list",{selectionMode:"none"},i),this._renderStartOverContainer())}_renderTraceResultIndividualPopover(){const{messages:e}=this,t=this._traceResultsIndividual,i=[],s=[];return t.length>0&&(t[0].details?t[0].details.fields.forEach(({name:r,alias:a})=>{i.push(l("calcite-option",{key:`display-${r}`,label:a??r,selected:r===this._resultDisplayField,value:r})),s.push(l("calcite-option",{key:`sort-${r}`,label:a??r,selected:r===this._resultSortField,value:r}))}):(i.push(l("calcite-option",{key:`display-${this._resultDisplayField}`,label:this._resultDisplayField,value:this._resultDisplayField})),s.push(l("calcite-option",{key:`sort-${this._resultDisplayField}`,label:this._resultDisplayField,value:this._resultDisplayField})))),l("calcite-popover",{autoClose:!0,label:e.resultsStrings.displayAttribute,offsetDistance:0,offsetSkidding:0,open:this._showResultOptions,overlayPositioning:"fixed",placement:"left-start",referenceElement:this._individualResultNode,styles:this.domNode!==null?rt(.75*this.domNode.clientWidth):at()},l("calcite-block",{heading:"",open:!0,overlayPositioning:"fixed"},l("calcite-label",{scale:"s"},e.resultsStrings.displayAttribute,l("calcite-select",{label:e.resultsStrings.displayAttribute,scale:"s",onCalciteSelectChange:r=>{const a=r.target;this._resultDisplayField=a.selectedOption.value,this._showResultOptions=!1}},i)),l("calcite-label",{scale:"s"},e.resultsStrings.sortBy,l("calcite-select",{label:e.resultsStrings.sortBy,scale:"s",onCalciteSelectChange:r=>{const a=r.target;this._resultSortField=a.selectedOption.value,t.sort(this._compare(this._resultSortField,this._resultSortOrder)),this._traceResultsIndividual=t,this._showResultOptions=!1}},s))))}_renderResultRowFunctions(e){return l("calcite-block",{collapsible:!1,heading:e.networkAttributeName+" "+e.functionType+" = "+e.result,overlayPositioning:"fixed"})}_renderResultRowAssetGroup(e){const t=this._getAssetGroupName(e[0]);return l("calcite-list-item",{label:t+" ("+e.length+")",onCalciteListItemSelect:()=>{this.switchToAssetType(this._groupResultsByAssetType(e),t+" ("+e.length+")",!0)}},l("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"}))}_renderResultRowAssetType(e){const t=this._getAssetTypeName(e[0]);return l("calcite-list-item",{label:t+" ("+e.length+")",onCalciteListItemSelect:()=>{this.viewModel.queryFeaturesById(e).then(i=>{if(i!=null&&i.length){this._resultObjectIdField=i[0].layer.objectIdField,this._resultDisplayField==="objectid"&&(this._resultDisplayField=i[0].layer.objectIdField),this._resultSortField==="objectid"&&(this._resultSortField=i[0].layer.objectIdField);const s=this._appendAttributes(e,i,"objectId");this.switchToIndividualRecords(s,t+" ("+e.length+")",!0)}else this.switchToIndividualRecords(e,t+" ("+e.length+")",!0)})}},l("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"}))}_renderResultRowIndividual(e){var n,c,u;const{messages:t}=this,i=`display-${e.objectId}-nso`,{nonSpatialObject:s,zoomToFeature:r}=t.globalStrings;let a="",o=null;if(o=(n=e==null?void 0:e.details)==null?void 0:n.fields.find(({name:d})=>d===this._resultDisplayField),(o==null?void 0:o.type)==="date")a=new Date(e.details.attributes[this._resultDisplayField]).toDateString();else if(this._resultDisplayField.toLowerCase()==="assetgroup")a=this._getAssetGroupName(e);else if(this._resultDisplayField.toLowerCase()==="assettype")a=this._getAssetTypeName(e);else if(o!=null&&o.domain&&ot(o.domain)){const d=o.domain.codedValues.find(({code:y})=>y===e.details.attributes[this._resultDisplayField]);a=d==null?void 0:d.name}else a=((c=e.details)==null?void 0:c.attributes[this._resultDisplayField])??e.objectId;return a&&a!==""&&a!==null?typeof a=="string"&&(a.trim()||(a=t.resultsStrings.noValue)):a=t.resultsStrings.noValue,((u=e==null?void 0:e.details)==null?void 0:u.geometry)!==null?l("calcite-list-item",{label:a,onCalciteListItemSelect:()=>{this.viewModel.zoomToAsset(e.details.geometry)}},l("calcite-icon",{icon:"zoom-to-object",scale:"s",slot:"content-end",textLabel:r})):l("calcite-list-item",{label:a},l("calcite-icon",{icon:"table",id:i,scale:"s",slot:"content-end",textLabel:s}),l("calcite-tooltip",{label:s,referenceElement:i},l("span",null,s)))}_afterComponentCreate(e){"value"in e&&e.value!=null&&"setNumberValue"in e&&e.setNumberValue({committing:!1,value:e.value,origin:"direct"})}_mixCustomStrings(){const{messages:e}=this;this.inputSettings.length>0&&this.inputSettings.forEach(t=>{t.type==="starting-point"&&(e.inputsStrings.headerStartingPoint=t.label,e.inputsStrings.startingPointHint=t.description),t.type==="barrier"&&(e.inputsStrings.headerBarrier=t.label,e.inputsStrings.barrierPointHint=t.description)})}_overrideFlagSymbol(){this.inputSettings.length>0&&this.inputSettings.forEach(e=>{e.type==="starting-point"?this._symbolStartFlag=e.symbol:this._symbolBarrier=e.symbol,this.viewModel.changeFlagSymbol(e.type,e.symbol)})}_utilityNetworkTraceInitialized(){return this.viewModel.loadUtilityNetwork().then(e=>{var t;if(e)return this.viewModel.selectTracesOnLoad(),this._registerWatchers(),this.viewModel.flags.length>0&&this._processFlagOnLoad(),(t=this.view)==null?void 0:t.when().then(()=>{this._watchViewState()});this.disabled=!1}).catch(e=>{const{messages:t}=this;this._loadUNError=!1,e.name==="utility-network:no-user-type-extension"||e.details.raw.extendedCode===nt.noExtension?this._errorMessage=t.alertsStrings.noUserExtension:this._errorMessage=e.message,this.disabled=!1})}_processFlagOnLoad(){var e;return(e=this.view)==null?void 0:e.when().then(()=>{this._watchHandler=Z(()=>{var t;return!((t=this.view)!=null&&t.updating)},async()=>{this._warningNoFlag=!1,this._warningNoBarrierAssetFound=!1,this._warningNoStartAssetFound=!1;const t=await this.viewModel.addFlagsOnLoad();this.viewModel.removeFlagsOnLoadWatcher(),t.includes("barrier")&&(this._warningNoBarrierAssetFound=!0),t.includes("starting-point")&&(this._warningNoStartAssetFound=!0),this.disabled=!1,this._watchHandler!==null&&this._watchHandler.remove()})})}_registerWatchers(){this.addHandles([L(()=>this.selectedTraces,()=>{this.viewModel.selectTracesOnLoad(),this.scheduleRender()}),L(()=>this.defaultGraphicColor,()=>{this.viewModel.traceResults.length>0&&this.viewModel.traceResults.forEach(e=>{this.viewModel.changeResultGraphicColor(this.viewModel.defaultGraphicColor,e)}),this.scheduleRender()})])}_groupResultsByAssetGroup(e){var r;const t=[],i=(r=e.results)==null?void 0:r.elements,s=this._groupBy(i??[],"networkSourceId");for(const a in s)t.push(this._groupBy(s[a],"assetGroupCode"));return t}_groupResultsByAssetType(e){return this._groupBy(e,"assetTypeCode")}_appendAttributes(e,t,i){const s=[];return e.forEach(r=>{t.forEach(a=>{a.featureSet.features.forEach(o=>{r[i]===o.attributes[this._resultObjectIdField]&&(r.details=o,r.details.fields=a.featureSet.fields,s.push(r))})})}),s}_getAssetGroupName(e){let t=e.assetGroupCode.toString();const i=e.assetGroupCode,s=this.viewModel.getValidSources().find(r=>r.sourceId===e.networkSourceId);if(s){const r=s.assetGroups.find(a=>a.assetGroupCode===i);r&&(t=r.assetGroupName)}return t}_getAssetTypeName(e){let t=e.assetTypeCode.toString();const i=e.assetGroupCode,s=this.viewModel.getValidSources().find(r=>r.sourceId===e.networkSourceId);if(s){const r=s.assetGroups.find(a=>a.assetGroupCode===i);if(r){const a=r.assetTypes.find(o=>o.assetTypeCode===e.assetTypeCode);a&&(t=a.assetTypeName)}}return t}_compare(e,t){return(i,s)=>{var n,c;let r=0,a=((n=i.details)==null?void 0:n.attributes[e])??i.objectId,o=((c=s.details)==null?void 0:c.attributes[e])??s.objectId;return isNaN(a)&&(a=a.toLowerCase()),isNaN(o)&&(o=o.toLowerCase()),t==="desc"?a>o?r=1:a<o&&(r=-1):a<o?r=1:a>o&&(r=-1),r}}_groupBy(e,t){return e.reduce((i,s)=>((i[s[t]]=i[s[t]]||[]).push(s),i),{})}_getSymbolIcon(e){return e.type==="picture-marker"?l("img",{height:e.height,src:e.url??void 0,width:e.width}):null}_watchViewState(){this._watchHandler=Z(()=>{var e;return!((e=this.view)!=null&&e.updating)},()=>{this.disabled=!1,this._watchHandler!==null&&this._watchHandler.remove()},{initial:!0})}_changeCursor(e="default"){var i,s;const t=(s=(i=this.view)==null?void 0:i.container)==null?void 0:s.style;t&&(t.cursor=e)}};h([p()],m.prototype,"_selectToolActive",void 0),h([p()],m.prototype,"_activeTrace",void 0),h([p()],m.prototype,"_activeSwatch",void 0),h([p()],m.prototype,"_traceHeaderForFlow",void 0),h([p()],m.prototype,"_assetGroupHeader",void 0),h([p()],m.prototype,"_assetTypeHeader",void 0),h([p()],m.prototype,"_traceResultsFunctions",void 0),h([p()],m.prototype,"_traceResultsAssetGroup",void 0),h([p()],m.prototype,"_traceResultsAssetType",void 0),h([p()],m.prototype,"_traceResultsIndividual",void 0),h([p()],m.prototype,"_showTraceResultFunctions",void 0),h([p()],m.prototype,"_showTraceResultAssetGroup",void 0),h([p()],m.prototype,"_showTraceResultAssetType",void 0),h([p()],m.prototype,"_showIndividualRecords",void 0),h([p()],m.prototype,"_activeTab",void 0),h([p()],m.prototype,"_alertRemoveModal",void 0),h([p()],m.prototype,"_warningNoFlag",void 0),h([p()],m.prototype,"_warningNoTraceSelected",void 0),h([p()],m.prototype,"_confirmReset",void 0),h([p()],m.prototype,"_swatchNode",void 0),h([p()],m.prototype,"_errorMessage",void 0),h([p()],m.prototype,"defaultGraphicColor",null),h([p()],m.prototype,"disabled",void 0),h([p()],m.prototype,"flags",null),h([p()],m.prototype,"gdbVersion",null),h([p()],m.prototype,"icon",null),h([p()],m.prototype,"inputSettings",void 0),h([p()],m.prototype,"label",null),h([p(),B("esri/widgets/UtilityNetworkTrace/t9n/UtilityNetworkTrace")],m.prototype,"messages",void 0),h([p(),B("esri/t9n/common")],m.prototype,"messagesCommon",void 0),h([p(),B("esri/core/t9n/Units")],m.prototype,"messagesUnits",void 0),h([p()],m.prototype,"resultAreaProperties",null),h([p()],m.prototype,"selectedTraces",null),h([p()],m.prototype,"selectOnComplete",null),h([p()],m.prototype,"showGraphicsOnComplete",null),h([p()],m.prototype,"enableResultArea",null),h([p()],m.prototype,"showSelectionAttributes",null),h([p()],m.prototype,"utilityNetwork",null),h([p()],m.prototype,"view",null),h([Te(["add-flag","add-flag-complete","add-flag-error","select-features","clear-selection","add-result-area","remove-result-area","create-result-area"]),p({type:ye})],m.prototype,"viewModel",void 0),m=h([ne("esri.widgets.UtilityNetworkTrace")],m);const Cr=m;export{Cr as default};
