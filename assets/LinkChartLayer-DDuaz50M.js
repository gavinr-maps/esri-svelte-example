import{b0 as dt,F as te,d as L,y as w,f as we,$ as yt,s as de,Q as ae,aX as he,az as at,cn as ue,aA as Re,aF as ce,eo as qe,aC as it,hR as ut,cP as le,a_ as Me,eX as ct,aD as ve,i as mt,bR as nt,_ as ft,gd as gt,V as Pe,aq as Tt,aB as je}from"./index-B1qcMJFy.js";import{z as oe}from"./geohashUtils-My25KraH.js";import{o as ie}from"./featureConversionUtils-D_5zMG16.js";import{t as Qe,e as Ue}from"./OptimizedGeometry-CQuTPb9g.js";import{G as be,p as bt,t as Lt,T as kt}from"./knowledgeGraphService-C8VXI2Z6.js";import{a as ye}from"./GraphQueryStreaming-B04DCDxu.js";import"./UniqueValueRenderer-0DBTeu6a.js";import{t as Ee,a as wt}from"./jsonUtils-T1v-OExy.js";import{m as Ct}from"./FeatureStore-mlAGUwqz.js";import{$ as Mt}from"./QueryEngine-2qC7hmvu.js";import{l as Et,o as xe}from"./clientSideDefaults-DGdAzQWt.js";import{s as xt}from"./fieldProperties-BBlnK2BG.js";import{n as ot}from"./BlendLayer-YVwXaff0.js";import{c as Dt}from"./FeatureReductionLayer-CcnR_gQV.js";import{f as It}from"./RefreshableLayer-FPVobzY-.js";import{t as st}from"./ScaleRangeLayer-BFzm67-h.js";import{y as Nt}from"./commonProperties-DknRhH4V.js";import{d as Rt}from"./FeatureSet-B0ca9TdS.js";import{p as vt}from"./popupUtils-Be21TX_a.js";import"./timeSupport-Bruw3RGT.js";import"./json-Wa8cmqdu.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./ColorStop-CWeLc-IV.js";import"./diffUtils-ArzxlFJn.js";import"./colorRamps-DdzVD7Op.js";import"./sizeVariableUtils-Cmcuvw-4.js";import"./visualVariableUtils-BGai42lJ.js";import"./lengthUtils-DbqEO4K7.js";import"./jsonUtils-D4lwJas0.js";import"./styleUtils-CCLgKLZt.js";import"./LRUCache-BtWa1HuP.js";import"./Version-D0C4RPiX.js";import"./FieldsIndex-DA0UbGLz.js";import"./UnknownTimeZone-B5Qf1DoL.js";import"./OverrideHelper-DlLhMkRM.js";import"./colorUtils-46-ov8wK.js";import"./vec42-B-sS29RP.js";import"./vec4f64-CCf6w8sj.js";import"./utils-y0bK7WMB.js";import"./quantizationUtils-D0A0ACzz.js";import"./heatmapUtils-BYQ7d-zD.js";import"./BoundsStore-BDFtn7iW.js";import"./PooledRBush-BnxZtrpS.js";import"./WhereClause-DXTTyoUO.js";import"./TimeOnly-CBRxWEF1.js";import"./QueryEngineCapabilities-CTDe3LlQ.js";import"./utils-4bh_PmhH.js";import"./utils-UzmcrzgV.js";import"./utils-BF94kSpP.js";import"./ClassBreaksDefinition-BdUWX84V.js";import"./RenderState-DaVlEYWY.js";import"./defaultsJSON-CHAaurhX.js";import"./jsonUtils-PeZxWKr8.js";import"./parser-BMJzm2a2.js";import"./FeatureReductionSelection-D0qp3RiB.js";import"./featureLayerUtils-CSLwh38G.js";import"./AttachmentQuery-B2yhFws1.js";import"./RelationshipQuery-DLL_bDIJ.js";import"./LabelClass-BsrtqKpM.js";import"./labelUtils-BAW6mwzs.js";import"./MD5-C9MwAd2G.js";import"./ElevationInfo-C7Yz1Jr6.js";const At="ESRI__DESTINATION_ID",_t="ESRI__ORIGIN_ID";let De=class ne{constructor(){this._featureLookup=new Map}static getInstance(){return ne.instance||(ne.instance=new ne),ne.instance}static resetInstance(){ne.instance&&(ne.instance=null)}deleteFromStore(a){a.forEach(t=>{this._featureLookup.delete(t)})}readFromStoreByList(a){const t=[];return a.forEach(o=>{const r=this.readFromStoreById(o);r&&t.push(r)}),t}readFromStoreById(a){return this._featureLookup.get(a)??null}writeToStore(a,t,o){const r=[];return a.forEach(s=>{if(!(s!=null&&s.id))return;s.properties||(s.properties=[]);let i,n=null;if(o&&s.properties[o]&&(n=ie(s.properties[o])),"originId"in s&&"destinationId"in s&&(s.properties[_t]=s.originId,s.properties[At]=s.destinationId),s.properties[t]=s.id,s.id&&this._featureLookup.has(s.id)&&this._featureLookup.get(s.id).attributes){const d=this._featureLookup.get(s.id),p=JSON.parse(JSON.stringify(Object.assign(d.attributes,s.properties)));o&&s.properties[o]&&(p[o]=dt(s.properties[o])),i=new Qe(n?JSON.parse(JSON.stringify(n)):d!=null&&d.geometry?JSON.parse(JSON.stringify(d.geometry)):null,p,null,s.properties[t])}else i=new Qe(n?JSON.parse(JSON.stringify(n)):null,s.properties,null,s.properties[t]);this._featureLookup.set(s.id,i),r.push(i)}),r}};var Le;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(Le||(Le={}));Le.ELEMENTUID,Le.TYPENAME;var He,Be;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(He||(He={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(Be||(Be={}));var Je,ze,Ye,Ve;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(Je||(Je={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(ze||(ze={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(Ye||(Ye={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(Ve||(Ve={}));function $t(e){if(!e.spatialReference.isWGS84)throw new te("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");let a;return a=e.xmax>180&&e.xmin<180?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[-180,e.ymin]]]:e.xmax>180&&e.xmin>180?[[[e.xmin-360,e.ymin],[e.xmin-360,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[e.xmin-360,e.ymin]]]:e.xmax>-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin+360,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[-180,e.ymin]]]:e.xmax<-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[e.xmax+360,e.ymax],[e.xmax+360,e.ymin],[e.xmin+360,e.ymin]]]:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]],a}async function St(e,a){var s,i;const t=[],o=new Map,r=[];if((s=a.dataModel)!=null&&s.relationshipTypes)for(const n of a.dataModel.relationshipTypes)n.name&&o.set(n.name,[]);for(const n of e)o.has(n.typeName)&&((i=o.get(n.typeName))==null||i.push(n.id));for(const[n,d]of o){if(d.length<1)continue;const p=new ye({openCypherQuery:`MATCH (n)-[r:${n}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:d}});r.push(be(a,p).then(async m=>{const u=m.resultRowsStream.getReader();for(;;){const{done:g,value:b}=await u.read();if(g)break;for(const f of b)t.push({id:f[0],typeName:f[1]}),t.push({id:f[2],typeName:f[3]})}}))}return await Promise.all(r),t}const R="ESRI__ID",ge="ESRI__ORIGIN_ID",Te="ESRI__DESTINATION_ID",G="ESRI__LAYOUT_GEOMETRY",Ae="ESRI__AGGREGATION_COUNT",se=12;let B=class extends yt{constructor(a){var o,r,s;super(a),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;(o=a.knowledgeGraph.dataModel.entityTypes)==null||o.forEach(i=>{var n,d;i.name&&(t.set(i.name,"entity"),this._processingCacheUpdatesLookup.set(i.name,[]),a.inclusionModeDefinition&&!((n=a.inclusionModeDefinition)!=null&&n.generateAllSublayers)||this.entityTypeNames.add(i.name),(d=i.properties)==null||d.forEach(p=>{p.geometryType&&p.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:p.name??"",geometryType:p.geometryType})}))}),(r=a.knowledgeGraph.dataModel.relationshipTypes)==null||r.forEach(i=>{var n,d;i.name&&(t.set(i.name,"relationship"),this._processingCacheUpdatesLookup.set(i.name,[]),a.inclusionModeDefinition&&!((n=a.inclusionModeDefinition)!=null&&n.generateAllSublayers)||this.relationshipTypeNames.add(i.name),(d=i.properties)==null||d.forEach(p=>{p.geometryType&&p.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:p.name??"",geometryType:p.geometryType})}))}),(s=a.inclusionModeDefinition)==null||s.namedTypeDefinitions.forEach((i,n)=>{var p,m;if(t.get(n)==="entity")this.entityTypeNames.add(n);else{if(t.get(n)!=="relationship")return de.getLogger(this).warn(`A named type, ${n}, was in the inclusion list that wasn't in the data model and will be removed`),void((p=a.inclusionModeDefinition)==null?void 0:p.namedTypeDefinitions.delete(n));this.relationshipTypeNames.add(n)}const d=new Map;(m=i.members)==null||m.forEach(u=>{ae(this.memberIdTypeLookup,u.id,()=>new Set).add(n);const g=this.getById(u.id);g&&d.set(u.id,g)}),this.sublayerCaches.set(n,d)})}addToLayer(a){a.forEach(({typeName:t,id:o})=>{if(!this.inclusionModeDefinition)throw new te("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){const r=this.inclusionModeDefinition.namedTypeDefinitions.get(t);r.members||(r.members=new Map),r.members.set(o,{id:o}),ae(this.memberIdTypeLookup,o,()=>new Set).add(t)}}else{const r=new Map;r.set(o,{id:o}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:r}),ae(this.memberIdTypeLookup,o,()=>new Set).add(t)}})}getById(a){return De.getInstance().readFromStoreById(a)}async getData(a,t,o){var s,i;if(t.objectType.name&&((s=this.inclusionModeDefinition)!=null&&s.namedTypeDefinitions)&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let r;if(r=a||new he({where:"1=1",outFields:["*"]}),t.parentCompositeLayer.type==="link-chart"){const n=t.parentCompositeLayer,d=this._processingCacheUpdatesLookup.get(t.objectType.name??""),p=r.outFields,m=r.geometry;let u="",g="";m&&m.extent&&(u=oe(m.extent.ymin,m.extent.xmin,se),g=oe(m.extent.ymax,m.extent.xmax,se)),p&&p.length===1&&p[0]===R&&r.where==="1=1"||await Promise.all(d??[]);const b=this.sublayerCaches.has(t.objectType.name??"")?Array.from((i=this.sublayerCaches.get(t.objectType.name))==null?void 0:i.values()):[],f=[];return b.forEach(M=>{if(this.relationshipTypeNames.has(t.objectType.name)?M.geometry=n.relationshipLinkChartDiagramLookup.get(M.attributes[t.objectIdField]):M.geometry=n.entityLinkChartDiagramLookup.get(M.attributes[t.objectIdField]),M.attributes[G]=M.geometry,u&&g){const h=n.linkChartGeohashLookup.get(M.attributes[t.objectIdField]);h?h>=u&&h<=g&&f.push(M):f.push(M)}else f.push(M)}),f}return this.retrieveDataFromService(r,t,o)}async getConnectedRecordIds(a,t){const o=[];let r="";const s=[],i=new Map;if(a.forEach(n=>{var d;if(this.memberIdTypeLookup.has(n))for(const p of this.memberIdTypeLookup.get(n)){if(!this.entityTypeNames.has(p))return;i.has(p)?(d=i.get(p))==null||d.push(n):i.set(p,[n])}}),t&&(t==null?void 0:t.length)!==0){for(const n of t)r=r+n+"|";r=r.slice(0,-1)}return i.forEach((n,d)=>{let p;p=t&&(t==null?void 0:t.length)!==0?`MATCH (n:${d})-[r:${r}]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${d})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`;const m=new Promise(u=>{(async()=>{const g=(await be(this.knowledgeGraph,new ye({openCypherQuery:p,bindParameters:{ids:n}}))).resultRowsStream.getReader();try{for(;;){const{done:b,value:f}=await g.read();if(b)break;for(let M=0;M<f.length;M++){const h=f[M];o.push({id:h[0],typeName:h[1]}),o.push({id:h[2],typeName:h[3]})}}}catch(b){if(b.name!=="AbortError")throw b;de.getLogger(this).info("Request aborted as expected")}})().then(()=>{u()})});s.push(m)}),this.refreshCacheContent(),await Promise.all(s),o}async refreshCacheContent(a,t,o,r=!0){var p,m,u,g,b,f,M;const s=De.getInstance(),i=[],n=new Map,d=new Map;(p=this.knowledgeGraph.dataModel.entityTypes)==null||p.forEach(h=>{h.name&&d.set(h.name,h)}),(m=this.knowledgeGraph.dataModel.relationshipTypes)==null||m.forEach(h=>{h.name&&d.set(h.name,h)}),a||this.inclusionModeDefinition?a?a.forEach(h=>{var D;if(this.memberIdTypeLookup.has(h))for(const F of this.memberIdTypeLookup.get(h))n.has(F)?(D=n.get(F))==null||D.push(h):n.set(F,[h])}):(g=(u=this.inclusionModeDefinition)==null?void 0:u.namedTypeDefinitions)==null||g.forEach((h,D)=>{h.useAllData?n.set(D,null):h.members&&h.members.forEach(F=>{var E;n.has(D)&&n.get(D)!==null?(E=n.get(D))==null||E.push(F.id):n.set(D,[F.id])})}):((b=this.knowledgeGraph.dataModel.entityTypes)==null||b.forEach(h=>{h.name&&n.set(h.name,null)}),(f=this.knowledgeGraph.dataModel.entityTypes)==null||f.forEach(h=>{h.name&&n.set(h.name,null)}));for(const[h,D]of n){const F=new Promise(E=>{(async()=>{var z,V,W,Z,K,l,y;const U=new Set,H=[];let ee,v="",P=!1;if(t||((V=(z=d.get(h))==null?void 0:z.properties)==null||V.forEach(c=>{c.name&&U.add(c.name)})),o&&this.geographicLookup.has(h)){const c=(W=this.geographicLookup.get(h))==null?void 0:W.name;c&&U.add(c)}if(this.entityTypeNames.has(h))v=`MATCH (n:${h}) ${D?"WHERE id(n) IN $ids ":""}return ID(n)`,U.forEach(c=>{v+=`, n.${c}`,H.push(c)});else{if(!this.relationshipTypeNames.has(h))throw new te("knowledge-graph:layer-data-manager",`The graph type of ${h} could not be determined. Was this type set in the KG data model and inclusion definition?`);P=!0,v=`MATCH ()-[n:${h}]->() ${D?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,U.forEach(c=>{v+=`, n.${c}`,H.push(c)})}ee=new ye(D?{openCypherQuery:v,bindParameters:{ids:D}}:{openCypherQuery:v});const J=(await be(this.knowledgeGraph,ee)).resultRowsStream.getReader();for(;;){const{done:c,value:I}=await J.read();if(c)break;const N=[];for(let x=0;x<I.length;x++){const C=I[x];let A=0,O=0;const j={properties:{}};for(j.id=C[A],A++,O++,P&&(j.originId=C[A],A++,O++,j.destinationId=C[A],A++,O++,ae(this.nodeConnectionsLookup,j.originId,()=>new Set).add(j.id),ae(this.nodeConnectionsLookup,j.destinationId,()=>new Set).add(j.id),ae(this.relationshipConnectionsLookup,j.id,()=>[j.originId,j.destinationId]));A<C.length;A++)j.properties[H[A-O]]=C[A];N.push(j)}const T=s.writeToStore(N,R,(Z=this.geographicLookup.get(h))==null?void 0:Z.name);this.sublayerCaches.has(h)||this.sublayerCaches.set(h,new Map),r&&!((K=this.inclusionModeDefinition)!=null&&K.namedTypeDefinitions.has(h))&&((l=this.inclusionModeDefinition)==null||l.namedTypeDefinitions.set(h,{useAllData:!1,members:new Map})),r&&!((y=this.inclusionModeDefinition)!=null&&y.namedTypeDefinitions.get(h).members)&&(this.inclusionModeDefinition.namedTypeDefinitions.get(h).members=new Map);const k=this.sublayerCaches.get(h);T.forEach(x=>{var C,A;k==null||k.set(x.attributes[R],x),r&&!((C=this.inclusionModeDefinition)!=null&&C.namedTypeDefinitions.get(h).members.has(x.attributes[R]))&&((A=this.inclusionModeDefinition)==null||A.namedTypeDefinitions.get(h).members.set(x.attributes[R],{id:x.attributes[R]}),ae(this.memberIdTypeLookup,x.attributes[R],()=>new Set).add(h))})}})().then(()=>{E(null)})});i.push(F),(M=this._processingCacheUpdatesLookup.get(h))==null||M.push(F)}await Promise.all(i)}removeFromLayer(a){var r,s,i;const t=new Set,o=new Set(a.map(n=>n.id));for(const n of a)t.add(n.typeName),((r=this.memberIdTypeLookup.get(n.id))==null?void 0:r.size)===1?this.memberIdTypeLookup.delete(n.id):(s=this.memberIdTypeLookup.get(n.id))==null||s.delete(n.typeName),(i=this.inclusionModeDefinition)==null||i.namedTypeDefinitions.forEach((d,p)=>{var m;p===n.typeName&&((m=d.members)!=null&&m.has(n.id))&&d.members.delete(n.id)});t.forEach(n=>{var d;(d=this.sublayerCaches.get(n))==null||d.forEach((p,m)=>{var u;o.has(m)&&((u=this.sublayerCaches.get(n))==null||u.delete(m))})})}async retrieveDataFromService(a,t,o){var M,h,D,F,E,Q,U,H,ee,v,P,J,z,V,W,Z,K;const r=De.getInstance(),s=new Set,i=[];let n,d="",p=[];const m=t.graphType==="relationship",u=(D=(h=(M=this.inclusionModeDefinition)==null?void 0:M.namedTypeDefinitions)==null?void 0:h.get(t.objectType.name))==null?void 0:D.useAllData,g=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let b=!u&&g?Array.from(g).sort():null;if((Q=(E=(F=this.inclusionModeDefinition)==null?void 0:F.namedTypeDefinitions)==null?void 0:E.get(t.objectType.name))!=null&&Q.useAllData)(ee=(H=(U=this.inclusionModeDefinition)==null?void 0:U.namedTypeDefinitions)==null?void 0:H.get(t.objectType.name))!=null&&ee.useAllData&&a.objectIds!=null&&(b=a.objectIds);else if(a.objectIds!=null&&b&&b.length>0){const l=a.objectIds;a.objectIds=b.filter(y=>l.includes(y))}else if(a.objectIds!=null)b=a.objectIds;else{if((v=this.inclusionModeDefinition)!=null&&v.namedTypeDefinitions.has(t.objectType.name)&&(!((P=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))!=null&&P.members)||((z=(J=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))==null?void 0:J.members)==null?void 0:z.size)<1))return a.objectIds=[],[];a.objectIds=b}if(a.outFields!=null){const l=a.outFields;l.includes("*")?t.fields.forEach(y=>{s.add(y.name)}):l.forEach(y=>{y!==R&&y!==t.geometryFieldName&&s.add(y)})}if(a.geometry!=null){const l=a.geometry;let y;const c=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,I=c==null?void 0:c.spatialReference,N=(V=c==null?void 0:c.serviceCapabilities)==null?void 0:V.geometryCapabilities;let T=N==null?void 0:N.geometryMaxBoundingRectangleSizeX,k=N==null?void 0:N.geometryMaxBoundingRectangleSizeY;if((W=l==null?void 0:l.extent)!=null&&W.spatialReference&&!((Z=l.spatialReference)!=null&&Z.isWGS84)?(await at(l.extent.spatialReference,ue),y=Re(l.extent,ue)):y=l.extent,T&&k&&I){if(I.wkid!==4326){const x=new ce({spatialReference:I,xmax:T,ymax:k}),C=Re(x,ue);T=C.xmax,k=C.ymax}if(y.xmax-y.xmin>T)throw new te("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${T}° latitude, limit exceeded`);if(y.ymax-y.ymin>k)throw new te("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${k}° longitude, limit exceeded`)}if(a.where!=null&&a.where!=="1=1"){const x=await qe(a.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(C=>{x.fieldNames.includes(C.name)&&s.add(C.name)})}d=m?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&s.add(t.geometryFieldName),s.forEach(x=>{d+=`, n.${x}`,i.push(x)}),n=new ye({openCypherQuery:d,bindParameters:{param_filter_geom:new it({rings:$t(y)})}})}else{let l="";if(a.where!=null&&a.where!=="1=1"){const I=await qe(a.where,t.fieldsIndex);t.fields.forEach(C=>{I.fieldNames.includes(C.name)&&s.add(C.name)});const N=new Set(["column-reference","string","number","binary-expression"]),T=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let k=!1;const x=C=>{if(C.type==="column-reference")return`n.${C.column}`;if(C.type==="string")return`'${C.value}'`;if(C.type==="number")return`${C.value}`;if(C.type==="binary-expression"&&N.has(C.left.type)&&N.has(C.right.type)&&T.has(C.operator))return`${x(C.left)} ${C.operator} ${x(C.right)}`;if(C.type==="binary-expression"&&C.operator==="LIKE"){let A="";if(C.left.type==="function"&&C.left.args.value[0].type==="column-reference")A+=`lower(n.${C.left.args.value[0].column})`;else{if(C.left.type!=="column-reference")return k=!0,"";A+=`lower(n.${C.left.column})`}if(A+=" CONTAINS (",C.right.type!=="string")return k=!0,"";{let O=C.right.value;O.charAt(0)==="%"&&(O=O.slice(1)),O.charAt(O.length-1)==="%"&&(O=O.slice(0,-1)),A+=`'${O.toLowerCase()}')`}return A}return k=!0,""};l=x(I.parseTree),k&&(l="")}let y="";y=m?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let c=!1;b&&(c=!0,y+=" WHERE ID(n) IN $ids"),l&&(y+=c?" AND":" WHERE",y+=` ${l}`),y+=" return ID(n)",m&&(y+=", id(startNode(n)), id(endNode(n))"),a.returnGeometry&&t.geometryFieldName&&s.add(t.geometryFieldName),s.forEach(I=>{y+=`, n.${I}`,i.push(I)}),n=new ye(b?{openCypherQuery:y,bindParameters:{ids:b}}:{openCypherQuery:y})}const f=(await be(t.parentCompositeLayer.dataManager.knowledgeGraph,n,o)).resultRowsStream.getReader();for(;;){const{done:l,value:y}=await f.read();if(l)break;const c=[];for(let I=0;I<y.length;I++){const N=y[I];let T=0,k=0;const x={properties:{}};for(x.id=N[T],T++,k++,m&&(x.originId=N[T],T++,k++,x.destinationId=N[T],T++,k++);T<N.length;T++)x.properties[i[T-k]]=N[T];c.push(x)}p=p.concat(r.writeToStore(c,R,(K=t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name))==null?void 0:K.name))}return p}};L([w()],B.prototype,"knowledgeGraph",void 0),L([w()],B.prototype,"inclusionModeDefinition",void 0),L([w()],B.prototype,"entityTypeNames",void 0),L([w()],B.prototype,"relationshipTypeNames",void 0),L([w()],B.prototype,"geographicLookup",void 0),L([w()],B.prototype,"sublayerCaches",void 0),L([w()],B.prototype,"nodeConnectionsLookup",void 0),L([w()],B.prototype,"relationshipConnectionsLookup",void 0),L([w()],B.prototype,"memberIdTypeLookup",void 0),B=L([we("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],B);const We=xt(),Gt=e=>{let a=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return L([w(We.fields)],a.prototype,"fields",void 0),L([w(We.fieldsIndex)],a.prototype,"fieldsIndex",void 0),a=L([we("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],a),a};let _=class extends Dt(Gt(ot(st(It(nt))))){constructor(e){var a,t,o,r,s;if(super(e),this.capabilities=Et(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=R,this.objectType=null,this.parentCompositeLayer=null,this.popupEnabled=!0,this.popupTemplate=null,this.source={openPorts:()=>this.load().then(()=>{const i=new MessageChannel;return new ut(i.port1,{channel:i,client:{queryFeatures:(n,d={})=>{const p=he.fromJSON(n);return this.queryFeaturesJSON(p,d)}}}),[i.port2]})},this.type="knowledge-graph-sublayer",e.parentCompositeLayer.type==="link-chart")e.graphType==="relationship"?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=G;else if((a=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name))!=null&&a.geometryType&&((t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name))==null?void 0:t.geometryType)!=="esriGeometryNull"){const i=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=(i==null?void 0:i.name)??null,this.geometryType=i!=null&&i.geometryType?le.fromJSON(i.geometryType):null;const n=i==null?void 0:i.name,d=n?(o=e.objectType.properties)==null?void 0:o[n]:null;d?(this.hasM=d.hasM??!1,this.hasZ=d.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;(r=e.objectType.properties)==null||r.forEach(i=>{let n=null,d=i.fieldType;d==="esriFieldTypeOID"&&(d="esriFieldTypeInteger"),this.fields.push(Me.fromJSON({name:i.name,type:d,alias:i.alias,defaultValue:n,editable:i.editable,nullable:i.nullable}))}),this.fields.push(Me.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this.fields.push(Me.fromJSON({name:Ae,type:"esriFieldTypeInteger",alias:Ae,editable:!1})),this._set("fields",[...this.fields]),(s=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel)!=null&&s.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),e.parentCompositeLayer.type==="link-chart"?e.graphType==="relationship"?this.renderer=Ee(xe(le.toJSON("polyline")).renderer):this.renderer=Ee(xe(le.toJSON("point")).renderer):this.renderer=Ee(xe(le.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){ct(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return vt(this,e)}createQuery(){return new he({where:"1=1",outFields:["*"]})}getField(e){for(let a=0;a<this.fields.length;a++)if(this.fields[a].name===e)return this.fields[a];return null}getFieldDomain(e,a){return null}async queryFeatures(e,a){const{resolvedQuery:t,queryEngine:o}=await this._setupQueryObjects(e),r=Rt.fromJSON(await o.executeQuery(t.toJSON(),a==null?void 0:a.signal));return r.features.forEach(s=>{s.sourceLayer=this}),r}async queryFeaturesJSON(e,a){const{resolvedQuery:t,queryEngine:o}=await this._setupQueryObjects(e);return await o.executeQuery(t.toJSON(),a==null?void 0:a.signal)}async queryFeatureCount(e,a){const{resolvedQuery:t,queryEngine:o}=await this._setupQueryObjects(e);return o.executeQueryForCount(t.toJSON(),a==null?void 0:a.signal)}async queryExtent(e={},a){var n,d,p,m;const t={...e,returnGeometry:!0},{resolvedQuery:o,queryEngine:r}=await this._setupQueryObjects(t),s=await r.executeQueryForExtent(o.toJSON(),a==null?void 0:a.signal);let i;return i=((n=s.extent)==null?void 0:n.xmin)!=null&&((d=s.extent)==null?void 0:d.xmax)!=null&&((p=s.extent)==null?void 0:p.ymin)!=null&&((m=s.extent)==null?void 0:m.ymax)!=null?new ce(s.extent):new ce,{count:s.count,extent:i}}async queryObjectIds(e,a){const t=he.from(e);let o;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)o=this._cachedQueryEngine;else{const r=await this.parentCompositeLayer.dataManager.getData(t,this,a);o=this.loadQueryEngine(r)}return o.executeQueryForIds(t.toJSON(),a==null?void 0:a.signal)}loadQueryEngine(e){const a=new Ct({geometryType:le.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),t=new Mt({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:le.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:a});return t.featureStore.addMany(e),t}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new he({where:"1=1",outFields:[R]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,a){var s;const t=he.from(e),o=t.geometry;let r;if(o&&!((s=o.spatialReference)!=null&&s.isWGS84)&&(await at(o.spatialReference,ue),t.geometry=Re(o instanceof it||o instanceof ve?o:o.extent,ue)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)r=this._cachedQueryEngine;else{const i=await this.parentCompositeLayer.dataManager.getData(t,this,a);r=this.loadQueryEngine(i)}return{resolvedQuery:t,queryEngine:r}}};L([w()],_.prototype,"capabilities",void 0),L([w({readOnly:!0})],_.prototype,"defaultPopupTemplate",null),L([w()],_.prototype,"definitionExpression",void 0),L([w()],_.prototype,"displayField",void 0),L([w()],_.prototype,"elevationInfo",void 0),L([w()],_.prototype,"geometryType",void 0),L([w()],_.prototype,"geometryFieldName",void 0),L([w()],_.prototype,"graphType",void 0),L([w()],_.prototype,"hasM",void 0),L([w()],_.prototype,"hasZ",void 0),L([w()],_.prototype,"labelsVisible",void 0),L([w()],_.prototype,"labelingInfo",void 0),L([w()],_.prototype,"objectIdField",void 0),L([w()],_.prototype,"objectType",void 0),L([w()],_.prototype,"parentCompositeLayer",void 0),L([w(Nt)],_.prototype,"popupEnabled",void 0),L([w({type:mt,json:{name:"popupInfo",write:!0}})],_.prototype,"popupTemplate",void 0),L([w({types:wt,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],_.prototype,"renderer",null),L([w()],_.prototype,"source",void 0),L([w({json:{read:!1}})],_.prototype,"type",void 0),_=L([we("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],_);const Ie=_;let Ne,$=null;function Ft(){return Ne||(Ne=ft(()=>import("./lclayout-CPJoo6B5.js"),__vite__mapDeps([0,1,2]),import.meta.url).then(e=>e.l).then(({default:e})=>e({locateFile:a=>gt(`esri/libs/linkchartlayout/${a}`)})).then(e=>{Ot(e)}),Ne)}function Ot(e){$=e}var X,ke;function pe(e,a,t,o,r,s){const i=t.length,n=r.length,d=Float64Array.BYTES_PER_ELEMENT,p=Uint32Array.BYTES_PER_ELEMENT,m=Uint8Array.BYTES_PER_ELEMENT,u=16,g=u-1+i*(m+2*d)+n*(2*p),b=$._malloc(g);try{const f=b+u-b%u,M=f+i*d,h=M+i*d,D=h+n*p,F=D+n*p,E=()=>[$.HEAPF64.subarray(f>>3,(f>>3)+i),$.HEAPF64.subarray(M>>3,(M>>3)+i),$.HEAPU32.subarray(h>>2,(h>>2)+n),$.HEAPU32.subarray(D>>2,(D>>2)+n),$.HEAPU8.subarray(F,F+i)],[Q,U,H,ee,v]=E();Q.set(t),U.set(o),H.set(r),ee.set(s),v.set(a);let P=e(i,F,f,M,n,h,D),J=null;if(P){const l=$.getLayoutLinksTypes(),y=$.getLayoutLinksVerticesEndIndices(),c=$.getLayoutLinksVertices(),I=$.countLayoutLinksVertices();!n||l&&y?I&&!c?P=!1:J={types:new Uint8Array($.HEAPU8.subarray(l,l+n)),vertexEndIndex:new Uint32Array($.HEAPU32.subarray(y>>2,(y>>2)+n)),vertices:new Float64Array($.HEAPF64.subarray(c>>3,(c>>3)+2*I))}:P=!1}const[z,V,W,Z,K]=E();return t.set(z),o.set(V),r.set(W),s.set(Z),a.set(K),{success:P,links:J}}finally{$._free(b),$.cleanupLayout()}}(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"})(X||(X={})),function(e){e[e.Regular=0]="Regular",e[e.Orthogonal=1]="Orthogonal",e[e.Curved=2]="Curved",e[e.Recursive=3]="Recursive"}(ke||(ke={}));const Ze=2,Ke=1,Xe=-1;var _e,$e,Se,Ge,Fe,Oe,et,tt;(function(e){function a(){return $.getMinIdealEdgeLength()}function t(o,r,s,i,n,d=Ze,p=Ke,m=Xe){return pe((u,g,b,f,M,h,D)=>$.applyForceDirectedLayout(u,g,b,f,M,h,D,d,p,m),o,r,s,i,n)}e.getMinIdealEdgeLength=a,e.apply=t})(_e||(_e={})),function(e){function a(t,o,r,s,i,n=Ze,d=Ke,p=Xe){return pe((m,u,g,b,f,M,h)=>$.applyCommunityLayout(m,u,g,b,f,M,h,n,d,p),t,o,r,s,i)}e.apply=a}($e||($e={})),function(e){function a(t,o,r,s,i){return pe($.applySimpleLayout,t,o,r,s,i)}e.apply=a}(Se||(Se={})),function(e){function a(t,o,r,s,i){return pe($.applyHierarchicalLayout,t,o,r,s,i)}e.apply=a}(Ge||(Ge={})),function(e){function a(t,o,r,s,i){return pe($.applyRadialTreeLayout,t,o,r,s,i)}e.apply=a}(Fe||(Fe={})),function(e){function a(t,o,r,s,i){return pe($.applySmartTreeLayout,t,o,r,s,i)}e.apply=a}(Oe||(Oe={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(et||(et={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(tt||(tt={}));const qt=(e,a,t)=>(e.has(a)||e.set(a,t()),e.get(a));let q=class extends ot(st(nt)){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new Pe,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new ce({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new Pe,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new te("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){var s,i,n,d,p,m;if(!this.title&&this.url){const u=this.url.split("/");this.title=u[u.length-2]}const a=new Set;let t=[],o=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new te("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");(s=e.knowledgeGraph.dataModel.entityTypes)==null||s.forEach(u=>{u.name&&this._graphTypeLookup.set(u.name,u)}),(i=e.knowledgeGraph.dataModel.relationshipTypes)==null||i.forEach(u=>{u.name&&this._graphTypeLookup.set(u.name,u)}),(n=e.inclusionModeDefinition)!=null&&n.generateAllSublayers?(t=e.knowledgeGraph.dataModel.entityTypes??[],o=e.knowledgeGraph.dataModel.relationshipTypes??[]):(d=e.inclusionModeDefinition)!=null&&d.namedTypeDefinitions&&((p=e.inclusionModeDefinition)==null?void 0:p.namedTypeDefinitions.size)>0?(m=e.inclusionModeDefinition)==null||m.namedTypeDefinitions.forEach((u,g)=>{var b,f;if(!this._graphTypeLookup.get(g))return de.getLogger(this).warn(`A named type, ${g}, was in the inclusion list that wasn't in the data model and will be removed`),void((b=e.inclusionModeDefinition)==null?void 0:b.namedTypeDefinitions.delete(g));this._graphTypeLookup.get(g)instanceof bt||"strictOrigin"in this._graphTypeLookup.get(g)?a.has(g)||(a.add(g),o.push(this._graphTypeLookup.get(g))):this._graphTypeLookup.get(g)instanceof Lt||"properties"in this._graphTypeLookup.get(g)?a.has(g)||(a.add(g),t.push(this._graphTypeLookup.get(g))):(de.getLogger(this).warn(`A named type, ${g}, was in the inclusion list that wasn't properly modeled and will be removed`),(f=e.inclusionModeDefinition)==null||f.namedTypeDefinitions.delete(g))}):(t=e.knowledgeGraph.dataModel.entityTypes??[],o=e.knowledgeGraph.dataModel.relationshipTypes??[]);const r=new B({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=t,this.memberRelationshipTypes=o,this.dataManager=r}load(e){return this.addResolvingPromise(new Promise(a=>{kt(this.url).then(t=>{var o,r,s,i,n,d;if(this._initializeLayerProperties({knowledgeGraph:t,inclusionModeDefinition:this._originalInclusionList}),(r=(o=this.dataManager.inclusionModeDefinition)==null?void 0:o.namedTypeDefinitions)!=null&&r.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},(s=this.dataManager.knowledgeGraph.dataModel.entityTypes)==null||s.forEach(p=>{var m;p.name&&((m=this.dataManager.inclusionModeDefinition)==null||m.namedTypeDefinitions.set(p.name,{useAllData:!0}))}),(i=this.dataManager.knowledgeGraph.dataModel.relationshipTypes)==null||i.forEach(p=>{var m;p.name&&((m=this.dataManager.inclusionModeDefinition)==null||m.namedTypeDefinitions.set(p.name,{useAllData:!0}))})),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),(n=this.dataManager.inclusionModeDefinition)==null||n.namedTypeDefinitions.forEach(p=>{var m;p.useAllData=!1,(m=p.members)==null||m.forEach(u=>{let g;g=u.linkChartLocation instanceof Ue?u.linkChartLocation:u.linkChartLocation?ie(u.linkChartLocation):null,g&&g.coords.length===2&&g.lengths.length===0?(this.linkChartGeohashLookup.set(u.id,oe(g.coords[1],g.coords[0],se)),this.entityLinkChartDiagramLookup.set(u.id,g)):(this.linkChartGeohashLookup.set(u.id,""),this.relationshipLinkChartDiagramLookup.set(u.id,g))}),this.addResolvingPromise(this._initializeDiagram().then(async()=>{this.layers.forEach(async u=>{await u.refreshCachedQueryEngine()}),this.tables.forEach(async u=>{await u.refreshCachedQueryEngine()})}))});else{const p=((d=this.defaultLinkChartConfig)==null?void 0:d.layoutMode)==="GEOGRAPHIC";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,p,!0).then(async()=>{Tt(e);const m=[],u=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach(g=>{g.useAllData=!1})),await this._initializeDiagram(),this.layers.forEach(g=>{u.push(g.refreshCachedQueryEngine()),m.push(new Promise(b=>{g.on("layerview-create",()=>{b(null)})}))}),this.tables.forEach(g=>{u.push(g.refreshCachedQueryEngine())}),await Promise.all(u)}))}a(null)})})),Promise.resolve(this)}async addRecords(e,a){let t=[];a!=null&&a.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(t=await St(e,this.dataManager.knowledgeGraph));const o=e.concat(t).filter(r=>{var s;return!((s=this.sublayerIdsCache.get(r.typeName))!=null&&s.has(r.id))});await this._handleNewRecords(o)}async removeRecords(e,{cascadeRemoveRelationships:a=!0,recalculateLayout:t=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){var s,i,n,d,p,m,u,g;let o=[];for(const b of e)((n=(i=(s=this.dataManager.inclusionModeDefinition)==null?void 0:s.namedTypeDefinitions)==null?void 0:i.get(b.typeName))==null?void 0:n.useAllData)===!1&&((u=(m=(p=(d=this.dataManager.inclusionModeDefinition)==null?void 0:d.namedTypeDefinitions)==null?void 0:p.get(b.typeName))==null?void 0:m.members)!=null&&u.has(b.id))&&o.push(b);if(a){const b=new Set,f=[];for(const M of o)if(this.dataManager.nodeConnectionsLookup.has(M.id))for(const h of this.dataManager.nodeConnectionsLookup.get(M.id))b.add(h);for(const M of b)if(this.dataManager.memberIdTypeLookup.has(M))for(const h of this.dataManager.memberIdTypeLookup.get(M))this.dataManager.relationshipTypeNames.has(h)&&f.push({id:M,typeName:h});o=o.concat(f)}this.dataManager.removeFromLayer(o);for(const b of o)(g=this.sublayerIdsCache.get(b.typeName))==null||g.delete(b.id),this.dataManager.relationshipTypeNames.has(b.typeName)?this.relationshipLinkChartDiagramLookup.delete(b.id):this.entityLinkChartDiagramLookup.delete(b.id);t&&await this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,{});const r=[];return this.layers.forEach(b=>{r.push(b.refreshCachedQueryEngine())}),await Promise.all(r),this._refreshNamedTypes(),o}async expand(e,a){const t=await this.dataManager.getConnectedRecordIds(e,a),o=t.filter(r=>{var s;return!((s=this.sublayerIdsCache.get(r.typeName))!=null&&s.has(r.id))});return await this._handleNewRecords(t),{records:o}}loadLayerAssumingLocalCache(){var e,a;this.memberRelationshipTypes.forEach(t=>{const o=new Ie({objectType:t,parentCompositeLayer:this,graphType:"relationship",title:t.name});o.geometryType?this.layers.push(o):this.tables.push(o),this.dataManager.sublayerCaches.has(t.name)||this.dataManager.sublayerCaches.set(t.name,new Map)}),this.memberEntityTypes.forEach(t=>{const o=new Ie({objectType:t,parentCompositeLayer:this,graphType:"entity",title:t.name});o.geometryType?this.layers.push(o):this.tables.push(o),this.dataManager.sublayerCaches.has(t.name)||this.dataManager.sublayerCaches.set(t.name,new Map)}),(e=this.dataManager.inclusionModeDefinition)!=null&&e.namedTypeDefinitions&&((a=this.dataManager.inclusionModeDefinition)==null||a.namedTypeDefinitions.forEach((t,o)=>{var s;const r=qt(this.sublayerIdsCache,o,()=>new Set);(s=t.members)==null||s.forEach(i=>{if(r.add(i.id),i.linkChartLocation)if(i.linkChartLocation instanceof Ue)this.dataManager.relationshipTypeNames.has(o)?this.relationshipLinkChartDiagramLookup.set(i.id,i.linkChartLocation):this.entityLinkChartDiagramLookup.set(i.id,i.linkChartLocation),i.linkChartLocation.coords.length===2&&i.linkChartLocation.lengths.length===0?this.linkChartGeohashLookup.set(i.id,oe(i.linkChartLocation.coords[1],i.linkChartLocation.coords[0],se)):this.linkChartGeohashLookup.set(i.id,"");else{const n=ie(i.linkChartLocation);this.dataManager.relationshipTypeNames.has(o)?this.relationshipLinkChartDiagramLookup.set(i.id,i.linkChartLocation?n:null):this.entityLinkChartDiagramLookup.set(i.id,i.linkChartLocation?n:null),"x"in i.linkChartLocation&&"y"in i.linkChartLocation?this.linkChartGeohashLookup.set(i.id,oe(i.linkChartLocation.x,i.linkChartLocation.y,se)):this.linkChartGeohashLookup.set(i.id,"")}})}))}async calculateLinkChartLayout(e="RADIAL_TREE",a){var W,Z,K;const t=[],o=[],r=[];this.dataManager.sublayerCaches.forEach((l,y)=>{this.dataManager.entityTypeNames.has(y)?l.forEach(c=>{t.push({typeName:y,feature:c})}):this.dataManager.relationshipTypeNames.has(y)&&l.forEach(c=>{o.push({typeName:y,feature:c})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const s=new Map,i=new Map,n=new Map,d=new Map,p=new Uint8Array(t.length),m=new Float64Array(t.length),u=new Float64Array(t.length),g=new Uint32Array(o.length),b=new Uint32Array(o.length),f=[],M="FORCE_DIRECTED",h=new ce({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let D,F="FORCE_DIRECTED",E=0,Q=0;switch(F=e==="GEOGRAPHIC"?M:e,F){case"FORCE_DIRECTED":D=_e.apply;break;case"COMMUNITY":D=$e.apply;break;case"HIERARCHICAL":D=Ge.apply;break;case"RADIAL_TREE":D=Fe.apply;break;case"SMART_TREE":D=Oe.apply;break;default:D=Se.apply}t.forEach(({typeName:l,feature:y})=>{var c,I,N;if((c=a==null?void 0:a.lockedNodeLocations)!=null&&c.has(y.attributes[R])){e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(l)?p[E]=X.IsGeographic:p[E]=X.None;const T=a.lockedNodeLocations.get(y.attributes[R]);m[E]=T.x,u[E]=T.y}else if(e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(l)){p[E]=X.IsGeographic;let T=null;const k=y.attributes[this.dataManager.geographicLookup.get(l).name];switch((I=this.dataManager.geographicLookup.get(l))==null?void 0:I.geometryType){case"esriGeometryPoint":m[E]=k==null?void 0:k.x,u[E]=k==null?void 0:k.y;break;case"esriGeometryPolygon":T=k==null?void 0:k.centroid,(T==null?void 0:T.x)!=null&&(T==null?void 0:T.y)!=null?(m[E]=T.x,u[E]=T.y):p[E]=X.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":T=(N=k==null?void 0:k.extent)==null?void 0:N.center,(T==null?void 0:T.x)!=null&&(T==null?void 0:T.y)!=null?(m[E]=T.x,u[E]=T.y):p[E]=X.IsMovable;break;default:p[E]=X.IsMovable}(m[E]==null||u[E]==null||Number.isNaN(m[E])||Number.isNaN(u[E]))&&(p[E]=X.IsMovable,m[E]=0,u[E]=0)}else p[E]=X.IsMovable,m[E]=0,u[E]=0;d.set(y.attributes[R],E),f[E]={feature:y,typeName:l},E++});let U=!1;const H=new Map;o.forEach(l=>{const y=l.feature.attributes[ge],c=l.feature.attributes[Te],I=d.get(y),N=d.get(c);if(I!==void 0&&N!==void 0){const T=y+"-"+c,k=H.get(T);(k==null?void 0:k.has(l.typeName))||(g[Q]=I,b[Q]=N,k===void 0?H.set(T,new Map([[l.typeName,Q]])):k.set(l.typeName,Q),Q++),r.push(l)}else U=!0,this.relationshipLinkChartDiagramLookup.set(y,null),this.linkChartGeohashLookup.set(y,null)}),U&&de.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await Ft();const{success:ee,links:v}=D(p,m,u,g.subarray(0,Q),b.subarray(0,Q));if(!ee)throw new te("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let l=0;l<f.length;l++){if(u[l]>84.9999?u[l]=84.9999:u[l]<-84.9999&&(u[l]=-84.9999),m[l]>179.9999?m[l]=179.9999:m[l]<-179.9999&&(m[l]=-179.9999),f[l].feature.attributes[G]=new je(m[l],u[l]),s.has(f[l].typeName)){const c=s.get(f[l].typeName);c==null||c.set(f[l].feature.attributes[R],f[l].feature)}else{const c=new Map;c.set(f[l].feature.attributes[R],f[l].feature),s.set(f[l].typeName,c)}n.set(f[l].feature.attributes[R],f[l].feature);const y=ie(f[l].feature.attributes[G]);this.entityLinkChartDiagramLookup.set(f[l].feature.attributes[R],f[l].feature.attributes[G]?y:null),this.linkChartGeohashLookup.set(f[l].feature.attributes[R],oe(f[l].feature.attributes[G].y,f[l].feature.attributes[G].x,se)),f[l].feature.attributes[G].x<h.xmin&&(h.xmin=f[l].feature.attributes[G].x),f[l].feature.attributes[G].x>h.xmax&&(h.xmax=f[l].feature.attributes[G].x),f[l].feature.attributes[G].y<h.ymin&&(h.ymin=f[l].feature.attributes[G].y),f[l].feature.attributes[G].y>h.ymax&&(h.ymax=f[l].feature.attributes[G].y)}if(this.linkChartExtent.xmin=h.xmin,this.linkChartExtent.xmax=h.xmax,this.linkChartExtent.ymin=h.ymin,this.linkChartExtent.ymax=h.ymax,!v)throw new te("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const P=new Map,J=new Map,z=new Map,V=new Set;for(let l=0;l<r.length;l++){const y=[],c=r[l],I=c.feature.attributes[ge],N=c.feature.attributes[Te],T=I+"-"+N,k=H.get(T).get(c.typeName),x=k===0?0:v==null?void 0:v.vertexEndIndex[k-1];if(!V.has(k)){if(V.add(k),v.types[k]===ke.Recursive){const S=[v.vertices[2*x],v.vertices[2*x+1]],Ce=[v.vertices[2*(x+1)],v.vertices[2*(x+1)+1]],re=[.5*(S[0]+Ce[0]),.5*(S[1]+Ce[1])],fe=[re[0]-S[0],re[1]-S[1]],pt=[re[0]+fe[1],re[1]-fe[0]],ht=[re[0]-fe[1],re[1]+fe[0]];y.push(S),y.push(pt),y.push(Ce),y.push(ht),y.push(S)}else{if(v.types[k]!==ke.Regular){de.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let S=x;S<v.vertexEndIndex[k];S++)y.push([v.vertices[2*S],v.vertices[2*S+1]])}const Y=(W=f[d.get(I)])==null?void 0:W.feature.attributes[G],me=(Z=f[d.get(N)])==null?void 0:Z.feature.attributes[G];y[0][0]===Y.x&&y[0][1]===Y.y||(y[0]=[Y.x,Y.y]),y[y.length-1][0]===me.x&&y[y.length-1][1]===me.y||(y[y.length-1]=[me.x,me.y]);for(let S=1;S<y.length-1;S++)y[S][1]>85.5?y[S][1]=85.5:y[S][1]<-85.5&&(y[S][1]=-85.5),y[S][0]>179.9999?y[S][0]=179.9999:y[S][0]<-179.9999&&(y[S][0]=-179.9999);P.has(T)?P.get(T).push(y):P.set(T,[y])}const C=P.get(T);J.has(T)||(J.set(T,new Map),z.set(T,new Map));const A=J.get(T),O=z.get(T);A.has(c.typeName)||(A.set(c.typeName,C.shift()),O.set(c.typeName,0));const j=A.get(c.typeName);O.set(c.typeName,O.get(c.typeName)+1);const rt=new ve({paths:j});if(c.feature.attributes[G]=rt,i.has(c.typeName)){const Y=i.get(c.typeName);Y==null||Y.set(c.feature.attributes[R],c.feature)}else{const Y=new Map;Y.set(c.feature.attributes[R],c.feature),i.set(c.typeName,Y)}n.set(c.feature.attributes[R],c.feature);const lt=ie(c.feature.attributes[G]);this.relationshipLinkChartDiagramLookup.set(c.feature.attributes[R],c.feature.attributes[G]?lt:null),this.linkChartGeohashLookup.set(c.feature.attributes[R],"")}for(const l of r)l.feature.attributes[Ae]=((K=z.get(l.feature.attributes[ge]+"-"+l.feature.attributes[Te]))==null?void 0:K.get(l.typeName))??null;return this._currentLinkChartConfig={layoutMode:e},{nodes:s,links:i,idMap:n}}async applyNewLinkChartLayout(e="RADIAL_TREE",a){const t=[];await this.calculateLinkChartLayout(e,a),this.layers.forEach(o=>{t.push(o.refreshCachedQueryEngine())}),await Promise.all(t),this._refreshNamedTypes()}getCurrentNodeLocations(){var a,t;const e=new Map;return(t=(a=this.dataManager.inclusionModeDefinition)==null?void 0:a.namedTypeDefinitions)==null||t.forEach(o=>{var r;(r=o==null?void 0:o.members)==null||r.forEach(s=>{const i=s.linkChartLocation;let n;const d=s.id;i&&(n="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]},e.set(d,new je({x:n.x,y:n.y})))})}),e}async synchronizeInclusionListWithCache(){return new Promise(e=>{var a;(a=this.dataManager.inclusionModeDefinition)==null||a.namedTypeDefinitions.forEach((t,o)=>{if(t.useAllData=!1,t.members&&t.members.size>0){if(!this.dataManager.sublayerCaches.get(o))return;const r=new Set(Array.from(this.dataManager.sublayerCaches.get(o).keys()));Array.from(t.members.keys()).filter(s=>!r.has(s)).forEach(s=>{var i;(i=t.members)==null||i.delete(s)})}}),e()})}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const a=[];this.layers.forEach(t=>{a.push(t.refreshCachedQueryEngine())}),await Promise.all(a),this._refreshNamedTypes()}async _handleNewRecords(e){const a=[];this.dataManager.addToLayer(e);for(const t of e)this.sublayerIdsCache.has(t.typeName)||(this.sublayerIdsCache.set(t.typeName,new Set),a.push(t.typeName)),this.sublayerIdsCache.get(t.typeName).add(t.id);for(const t of a)if(this._graphTypeLookup.has(t)){const o=this._graphTypeLookup.get(t),r="endPoints"in o?"relationship":"entity",s=new Ie({objectType:o,parentCompositeLayer:this,graphType:r,title:t});r==="entity"?this.dataManager.entityTypeNames.add(t):this.dataManager.relationshipTypeNames.add(t),s.geometryType?this.layers.push(s):this.tables.push(s),this.dataManager.sublayerCaches.set(t,new Map)}await this.dataManager.refreshCacheContent(e.map(t=>t.id)),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode)}async _initializeDiagram(){var e,a;this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?((a=(e=this.dataManager.inclusionModeDefinition)==null?void 0:e.namedTypeDefinitions)==null||a.forEach((t,o)=>{var r;(r=t==null?void 0:t.members)==null||r.forEach(s=>{const i=s.linkChartLocation;let n;const d=s.id;if(!i)return;n="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]};const p=ie(n);this.dataManager.relationshipTypeNames.has(o)?this.relationshipLinkChartDiagramLookup.set(d,p):this.entityLinkChartDiagramLookup.set(d,p),this.linkChartGeohashLookup.set(d,oe(n.x,n.y,se)),this.linkChartExtent.xmin>n.x&&(this.linkChartExtent.xmin=n.x),this.linkChartExtent.xmax<n.x&&(this.linkChartExtent.xmax=n.x),this.linkChartExtent.ymin>n.y&&(this.linkChartExtent.ymin=n.y),this.linkChartExtent.ymax<n.y&&(this.linkChartExtent.ymax=n.y)})}),this.memberRelationshipTypes.forEach(t=>{var o;t.name&&((o=this.dataManager.sublayerCaches.get(t.name))==null||o.forEach(r=>{const s=this.relationshipLinkChartDiagramLookup.get(r.attributes[ge]),i=this.relationshipLinkChartDiagramLookup.get(r.attributes[Te]);if(s&&i){const n=ie(new ve({paths:[[s.coords[0],s.coords[1]],[i.coords[0],i.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(r.attributes[R],n)}else this.relationshipLinkChartDiagramLookup.set(r.attributes[R],null);this.linkChartGeohashLookup.set(r.attributes[R],"")}))})):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}};L([w()],q.prototype,"dataPreloadedInLocalCache",void 0),L([w()],q.prototype,"defaultLinkChartConfig",void 0),L([w()],q.prototype,"dataManager",void 0),L([w()],q.prototype,"knowledgeGraph",void 0),L([w()],q.prototype,"layers",void 0),L([w()],q.prototype,"entityLinkChartDiagramLookup",void 0),L([w()],q.prototype,"relationshipLinkChartDiagramLookup",void 0),L([w()],q.prototype,"linkChartExtent",void 0),L([w()],q.prototype,"linkChartGeohashLookup",void 0),L([w()],q.prototype,"memberEntityTypes",void 0),L([w()],q.prototype,"memberRelationshipTypes",void 0),L([w()],q.prototype,"sublayerIdsCache",void 0),L([w()],q.prototype,"tables",void 0),L([w({json:{read:!1}})],q.prototype,"type",void 0),q=L([we("esri.layers.LinkChartLayer")],q);const Va=q;export{Va as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["./lclayout-CPJoo6B5.js","./index-B1qcMJFy.js","./index-DAhQBRAS.css"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
