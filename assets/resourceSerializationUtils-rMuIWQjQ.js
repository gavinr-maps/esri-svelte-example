import{P as x}from"./cast-BA_-jlhc.js";import{s as I,o as V}from"./Accessor-BHnuXKD2.js";import{s as se}from"./featureConversionUtils-DpmsPUmt.js";import{e as re}from"./OptimizedGeometry-7IxBWtHr.js";import{g as ie}from"./Point-XGrwlf63.js";import{i as U,r as L,a as N}from"./knowledgeGraphService-BDS0AlFK.js";class ae{constructor(){this.version="",this.queryResult=new ne}}let ne=class{constructor(){this.featureResult=new oe}};class oe{constructor(){this.objectIdFieldName="",this.uniqueIdField=new le,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new ce,this.geometryType=null,this.spatialReference=new ie,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new $,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}}class le{constructor(){this.name="",this.isSystemMaintained=!1}}class ce{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}}let $=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new de,this.translate=new ue}};class de{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}}class ue{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}}class ye{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}}let pe=class{constructor(){this.attributes=[],this.compressedGeometry=new k,this.centroid=new k,this.aggregateGeometries=[]}},k=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};var b;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(b||(b={}));const fe=[b.ELEMENTUID,b.TYPENAME];var v,_;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(v||(v={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(_||(_={}));var C,A,R,q;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(C||(C={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(A||(A={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(R||(R={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(q||(q={}));function me(e){const t=new ae;t.version=e.version;const i=e.get_query_result();if(i.results_type.value!==0)throw new Error("Got a non-feature collection type");const s=i.get_feature_result(),r=t.queryResult.featureResult;r.objectIdFieldName=s.objectid_field_name,r.exceededTransferLimit=s.exceeded_transfer_limit,r.hasM=s.has_m,r.hasZ=s.has_z,r.geometryType=U[s.geometry_type.value],r.globalIdFieldName=s.globalid_field_name,r.geohashFieldName=s.geohash_field_name;const o=r.uniqueIdField,p=s.unique_id_field;o.name=p.name,o.isSystemMaintained=p.isSystemMaintained;const l=r.geometryProperties,a=s.geometry_properties;l.shapeAreaFieldName=a.shapeAreaFieldName,l.shapeLengthFieldName=a.shapeLengthFieldName,l.units=a.units;const y=r.spatialReference,c=s.spatial_reference;y.wkid=c.wkid,y.latestWkid=c.latestWkid,y.vcsWkid=c.vcsWkid,y.latestVcsWkid=c.latestVcsWkid,y.wkt=c.wkt,r.transform=he(s.transform);const d=r.fields,u=r.fieldNameToAttributeIndexMap,n=s.fields,g=n.size();for(let f=0;f<g;f++){const T=n.get(f),h=j(T);d.push(h),u[h.name]=f,T.delete()}n.delete();const m=r.values,E=s.values_count();for(let f=0;f<E;f++)m.push(s.get_value_at(f));const X=r.features,F=s.features,G=F.size();if(G>0){for(const f of fe)if(u[f]===void 0)throw new Error(`Feature collection missing required attribute: ${f}`)}for(let f=0;f<G;f++){const T=new pe,h=F.get(f),H=T.attributes,J=h.attributes_count();for(let w=0;w<J;w++)H.push(h.get_attribute_at(w));const O=h.get_compressed_geometry();O&&(T.compressedGeometry=S(O),T.centroid=S(h.get_centroid()));const K=T.aggregateGeometries,M=h.aggregate_geometries,ee=M.size();for(let w=0;w<ee;w++){const P=M.get(w),te=S(P);K.push(te),P.delete()}M.delete(),X.push(T),h.delete()}F.delete();const Z=r.geometryFields,D=s.geometry_fields,Q=D.size();for(let f=0;f<Q;f++){const T=D.get(f),h=Te(T);Z.push(h),T.delete()}return D.delete(),t}function S(e){const t=new k;t.geometryType=U[e.geometry_type.value];const i=[],s=[];for(let r=0;r<e.lengths.length;r++)i.push(e.lengths[r]);for(let r=0;r<e.coords.length;r++)s.push(e.coords[r]);return t.lengths=i,t.coords=s,t}function j(e){const t=new ye;return t.name=e.name,t.alias=e.alias,t.fieldType=L[e.field_type.value],t.sqlType=R[e.sql_type.value],t.domain=e.domain,t.defaultValue=e.default_value,t}function Te(e){const t=j(e);return t.geometryType=U[e.geometry_type.value],t}function he(e){const t=new $;t.quantizeOriginPosition=A[e.quantizeOriginPosition.value];const i=t.scale,s=e.scale;i.xScale=s.xScale,i.yScale=s.yScale,i.mScale=s.mScale,i.zScale=s.zScale;const r=t.translate,o=e.translate;return r.xTranslate=o.xTranslate,r.yTranslate=o.yTranslate,r.mTranslate=o.mTranslate,r.zTranslate=o.zTranslate,t}async function _e(e){const t=[],i={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(Y(e.entitiesUrl).then(s=>{z(s,i)})),e.relationshipsUrl&&t.push(Y(e.relationshipsUrl).then(s=>{z(s,i)})),await Promise.all(t),i}async function ve(e,t){t??(t=!1);const i={generateAllSublayers:t,namedTypeDefinitions:new Map};return await Ee(e).then(s=>{be(s,i)}),i}async function Ue(e,t,i){const s=await N(),r=new s.FeatureCollection;try{B(r,s,e,"entities",t,i);const o=new s.FeatureCollectionEncoder,p=W(r,o),l=structuredClone(p);return o.delete(),l}finally{r.delete()}}async function Ge(e,t,i){const s=await N(),r=new s.FeatureCollection;try{B(r,s,e,"relationships",t,i);const o=new s.FeatureCollectionEncoder,p=W(r,o),l=structuredClone(p);return o.delete(),l}finally{r.delete()}}async function Oe(e){const t=await N(),i=new t.MapOfObjectIdentifierSets;ge(i,t,e);const s=new t.MapOfObjectIdentifierSetsEncoder;try{s.set_map_of_identifier_sets(i),s.encode();const r=s.get_encoding_result();if(r.error.error_code!==0)throw new I("knowledge-graph:layer-support-utils",r.error.error_message);const o=structuredClone(r.get_byte_buffer());return s.delete(),o}finally{i.delete()}}function B(e,t,i,s,r,o){e.version="";const p=new t.QueryResult,l=new t.FeatureResult,a=s==="entities"?v:_;l.unique_id_field={name:a[a.ELEMENTUID],isSystemMaintained:!1},l.globalid_field_name=a[a.ELEMENTUID],l.geohash_field_name="",l.geometry_properties={shapeAreaFieldName:"",shapeLengthFieldName:"",units:""},l.spatial_reference={wkid:4326,latestWkid:4326,vcsWkid:0,latestVcsWkid:0,wkt:""},l.exceeded_transfer_limit=!1,l.has_z=!1,l.has_m=!1,l.transform={quantizeOriginPosition:{value:A.upperLeft},scale:{xScale:1e-9,yScale:1e-9,mScale:1e-4,zScale:1e-4},translate:{xTranslate:-400,yTranslate:-400,mTranslate:-1e5,zTranslate:-1e5}};for(const c of Object.keys(a).filter(d=>isNaN(Number(d)))){const d=new t.Field;if(d.name=c,d.alias=c,d.sql_type={value:R.sqlTypeBigInt},s==="entities")switch(c){case a[a.ELEMENTUID]:case a[a.TYPENAME]:d.field_type={value:L.esriFieldTypeString}}else switch(c){case a[a.ELEMENTUID]:case a[a.TYPENAME]:case _[_.FROMUID]:case _[_.TOUID]:d.field_type={value:L.esriFieldTypeString}}d.domain="",l.add_field(d),d.delete()}const y=new Map;for(const c of r.dataModel.entityTypes)y.set(c.name,"entities");for(const c of r.dataModel.relationshipTypes)y.set(c.name,"relationships");for(const[c,d]of i.namedTypeDefinitions)if(s===y.get(c))for(const u of d.members.values()){const n=new t.Feature;for(const m of Object.keys(a).filter(E=>isNaN(Number(E))))if(s==="entities")switch(m){case a[a.ELEMENTUID]:n.add_attribute(u.id,t.esriFieldType.esriFieldTypeString);break;case a[a.TYPENAME]:n.add_attribute(c,t.esriFieldType.esriFieldTypeString)}else switch(m){case a[a.ELEMENTUID]:n.add_attribute(u.id,t.esriFieldType.esriFieldTypeString);break;case _[_.FROMUID]:n.add_attribute(o.has(u.id)?o.get(u.id)[0]:"",t.esriFieldType.esriFieldTypeString);break;case _[_.TOUID]:n.add_attribute(o.has(u.id)?o.get(u.id)[1]:"",t.esriFieldType.esriFieldTypeString);break;case a[a.TYPENAME]:n.add_attribute(c,t.esriFieldType.esriFieldTypeString)}let g;if(u.linkChartLocation&&"x"in u.linkChartLocation?g=se(u.linkChartLocation):u.linkChartLocation&&(g=u.linkChartLocation),u.linkChartLocation&&g){const m=new t.FeatureCollectionGeometry;let E=!1;switch(s){case"entities":m.geometry_type=t.esriGeometryType.esriGeometryPoint,E=!0;break;case"relationships":m.geometry_type=t.esriGeometryType.esriGeometryPolyline}m.coords=new Float64Array(g.coords),m.lengths=new Uint32Array(E?[1]:g.lengths),n.set_compressed_geometry(m),m.delete()}l.add_feature(n),n.delete()}switch(s){case"entities":l.geometry_type=t.esriGeometryType.esriGeometryPoint;break;case"relationships":l.geometry_type=t.esriGeometryType.esriGeometryPolyline}return p.set_feature_result(l),e.set_query_result(p),l.delete(),p.delete(),e}function ge(e,t,i){for(const[s,r]of i.namedTypeDefinitions){if(!r.members||r.useAllData)continue;const o=r.members.keys();let p=!1,l=!0;const a=new t.ObjectIdArray,y=new t.StringArray,c=new t.GlobalIdArray,d=new t.IdentifierArray,u=new t.ObjectIdentifierSet;for(const n of o)l&&(p=!isNaN(Number(n)),l=!1),p?a.add_objectid(Number(n)):(y.add_string(n),c.add_globalid(n)),d.add_identifier(n);u.set_oid_array(a),u.set_string_array(y),u.set_globalid_array(c),u.set_identifier_array(d),a.delete(),y.delete(),c.delete(),d.delete(),e.put_identifier_set(s,u),u.delete()}return e}async function Y(e){const t=await x(e,{responseType:"array-buffer"});return we(await t.data)}async function we(e){const t=new(await N()).FeatureCollectionDecoder,i=t.decode(new Uint8Array(e));if(i.error_code!==0)throw new I("knowledge-graph:layer-support-utils",i.error_message);const s=t.get_feature_collection(),r=me(s);return t.delete(),r}async function Ee(e){const t=await x(e,{responseType:"array-buffer"}),i=await t.data;return qe(new Uint8Array(i))}async function qe(e){const t=new(await N()).MapOfObjectIdentifierSetsDecoder,i=t.decode(new Uint8Array(e)),s=new Map;if(i.error_code!==0)throw new I("knowledge-graph:layer-support-utils",i.error_message);const r=t.get_map_of_identifier_sets(),o=r.keys,p=o.size();for(let l=0;l<p;l++){const a=o.get(l),y=r.query_identifier_set(a),c=[];if(y.id_array_type.value===q.GLOBALID_ARRAY){const d=y.get_globalid_array(),u=d.count();for(let n=0;n<u;n++)c.push(d.get_globalid_at(n))}else if(y.id_array_type.value===q.IDENTIFIER_ARRAY){const d=y.get_identifier_array(),u=d.count();for(let n=0;n<u;n++)c.push(d.get_identifier_at(n).toString())}else if(y.id_array_type.value===q.STRING_ARRAY){const d=y.get_string_array(),u=d.count();for(let n=0;n<u;n++)c.push(d.get_string_at(n))}else{if(y.id_array_type.value!==q.OID_ARRAY)throw new I("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const d=y.get_oid_array(),u=d.count();for(let n=0;n<u;n++)c.push(d.get_objectid_at(n).toString())}}s.set(a,c)}return t.delete(),s}function z(e,t){var s,r,o;if(!((s=e==null?void 0:e.queryResult)!=null&&s.featureResult))return t;const i=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const p of e.queryResult.featureResult.features){const l=p.attributes[i[b.TYPENAME]],a=V(t.namedTypeDefinitions,l,()=>({useAllData:!1,members:new Map})),y=p.attributes[i[b.ELEMENTUID]];if(((o=(r=p.compressedGeometry)==null?void 0:r.coords)==null?void 0:o.length)>0){let c=p.compressedGeometry.lengths;p.compressedGeometry.geometryType==="esriGeometryPoint"&&(c=[]),a.members.set(y,{id:y,linkChartLocation:new re(c,p.compressedGeometry.coords)})}else a.members.set(y,{id:y})}return t}function be(e,t){for(const[i,s]of e){const r=V(t.namedTypeDefinitions,i,()=>({useAllData:!1,members:new Map}));for(const o of s)r.members.has(o)||r.members.set(o,{id:o})}return t}const W=(e,t)=>{t.set_feature_collection(e),t.encode();const i=t.get_encoding_result();if(i.error.error_code!==0)throw new I("knowledge-graph:layer-support-utils",i.error.error_message);return i.get_byte_buffer()},Pe={fetchAndConvertSerializedLinkChart:e=>_e(e)};export{Pe as D,Ge as g,Oe as h,ve as m,Ue as w};
