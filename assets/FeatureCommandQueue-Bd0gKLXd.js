import{g,_ as w,h as jt,P as pe,j as Kt,i as j,G as z,m as Q,B as Se,p as n,q as H,H as S,u as Zt,v as Xt,w as A,C as b,S as U,F as bt,x as Ri,y as Te,z as Z,A as Ve,D as je,E as Ke,I as He,L as rt,M as zt,N as Yt,O as Qt,a as B,Q as Ci,R as Oi,T as Ei,V as Di,X as Li,Y as Bi,$ as ki,a0 as ce,a1 as $t,a2 as Jt,a3 as at,a4 as Mt,a5 as Ft,a6 as Pt,a7 as D,a8 as ei,a9 as ti,aa as ot,ab as Ni,ac as le,ad as Tt,ae as nt,af as ii,ag as Ui,ah as Hi,ai as Ye,aj as Wi,ak as Gi,al as qi,am as ji,an as Ki,ao as si,ap as ri,aq as ai,ar as oi,as as ni,at as li,au as vt,av as ui,aw as Zi,ax as At,ay as lt,az as ci,aA as ut,aB as Qe,aC as Xi,aD as Yi,aE as Qi,aF as Ji,aG as es,aH as ts,aI as is,aJ as ss,aK as rs,aL as as,aM as os,aN as ns,aO as ls,aP as re,aQ as he,aR as ae,aS as $e,aT as us,K as cs,d as ps}from"./UpdateTracking2D-DqQVxF7b.js";import{t as ds}from"./utils-y0bK7WMB.js";import{a as N,K as It,L as hs,d as Rt,u as fs,i as ms}from"./definitions-C14Q9bsB.js";import{E as xe,S as de,f as ct,m as P,c as E,y as I,M as L,d as ys,e as W,w as Ze,L as Oe}from"./Container-Cu2mymaD.js";import{d as c,jp as R,ha as bs,F as De,f9 as Ct,s as pi,hH as vs,eq as Ot,hY as gt,bo as we,bs as gs,q as xs,iE as ws}from"./index-B1qcMJFy.js";import{C as X,F as Et,L as _e,D as pt,B as di,E as Ss,U as We,_ as dt,G as fe,P as Dt,O as Vs,I as Je}from"./enums-CYMvjYBC.js";import{h as Lt,s as _s,i as hi,x as fi}from"./Program-D73aiqol.js";import{o as zs}from"./ProgramTemplate-PPTPfqvG.js";import{t as $s}from"./VertexElementDescriptor-BOD-G50G.js";import{o as mi}from"./LabelMetric-C-5nd1ih.js";import{e as Ge,m as yi}from"./Texture-geJFW1sL.js";import{o as Ms}from"./constants-D5zmR9t2.js";import{c as Bt}from"./WGLContainer-CbQ7-c9v.js";import{m as Fs}from"./lengthUtils-DbqEO4K7.js";let k=class{constructor(e){this.registryName=e,this.postProcessingEnabled=!1,this.overrideStencilRef=null,this.drawPhase=xe.MAP|xe.HITTEST|xe.HIGHLIGHT|xe.DEBUG,this.symbologyPlane=de.FILL}startup(){}shutdown(){}postProcess(e,t){}},bi=class extends jt{};c([g(0,b)],bi.prototype,"pos",void 0);let Ps=class extends Te{},vi=class extends pe{};c([w(n)],vi.prototype,"dotSize",void 0);let Le=class extends pe{};c([w(U)],Le.prototype,"locations",void 0),c([w(n)],Le.prototype,"pixelRatio",void 0),c([w(n)],Le.prototype,"tileZoomFactor",void 0);const Ts=1e-6;class ye extends Kt{vertex(e){const t=new j(1,0,0,0,-1,0,0,1,1).multiply(new z(e.pos.xy.divide(N),1)),i=Q(this.draw.locations,t.xy),r=Se(this.instance.dotSize.divide(2),new n(1));let a=new n(0);a=a.add(H(i.a,new n(Ts)).multiply(2));let o=r.add(this.instance.dotSize);const l=this.view.displayViewScreenMat3.multiply(new z(e.pos.add(.5),1)),u=new S(l.xy,a,1),p=this.instance.dotSize.divide(o),d=new n(-1).divide(r.divide(o));return o=o.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:u,glPointSize:o,color:i,ratio:p,invEdgeRatio:d}}fragment(e){const t=Zt(e.glPointCoord.subtract(.5)).multiply(2),i=Xt(new n(0),new n(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),r=new bt;return r.glFragColor=e.color.multiply(i),r}}c([w(vi)],ye.prototype,"instance",void 0),c([w(Le)],ye.prototype,"draw",void 0),c([w(Ri)],ye.prototype,"view",void 0),c([R(0,A(bi))],ye.prototype,"vertex",null),c([R(0,A(Ps))],ye.prototype,"fragment",null);class gi extends je{}c([g(3,n)],gi.prototype,"inverseArea",void 0);let Be=class extends pe{};c([w(Z.ofType(S,2))],Be.prototype,"isActive",void 0),c([w(Z.ofType(S,8))],Be.prototype,"colors",void 0),c([w(n)],Be.prototype,"dotValue",void 0);let be=class extends pe{};c([w(U)],be.prototype,"dotTexture0",void 0),c([w(U)],be.prototype,"dotTexture1",void 0),c([w(n)],be.prototype,"tileZoomFactor",void 0),c([w(n)],be.prototype,"pixelRatio",void 0),c([w(n)],be.prototype,"tileDotsOverArea",void 0);class ve extends Ke{_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){const t=new j(2/N,0,0,0,-2/N,0,-1,1,1).multiply(new z(e.pos,1)),i=this.clip(e.id),r=new S(t.xy,i,1),a=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),o=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),l=this.draw.tileZoomFactor.multiply(N).divide(this.draw.pixelRatio),u=this._dotThreshold(a,this.instance.dotValue,this.draw.tileDotsOverArea),p=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),d=e.pos.add(.5).divide(l);return{glPosition:r,color:new S(0,0,0,0),textureCoords:d,thresholds0:u,thresholds1:p}}fragment(e){const t=new bt,i=Q(this.draw.dotTexture0,e.textureCoords),r=Q(this.draw.dotTexture1,e.textureCoords),a=e.thresholds0.subtract(i),o=e.thresholds1.subtract(r);let l;const u=He.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),p=He.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const d=H(new n(0),a),h=H(new n(0),o),f=rt(d,a).add(rt(h,o)),m=H(f,new n(0)),y=new n(1).subtract(m),v=f.add(m),V=a.multiply(d).divide(v),x=o.multiply(h).divide(v),_=u.multiply(V).add(p.multiply(x));l=y.multiply(_)}else{const d=Se(zt(a),zt(o)),h=H(d,new n(0)),f=new n(1).subtract(h),m=H(d,a),y=H(d,o),v=u.multiply(m).add(p.multiply(y));l=f.multiply(v)}return t.glFragColor=l,t}hittest(e){return Yt(this.hittestRequest)}}c([Ve],ve.prototype,"blending",void 0),c([w(Be)],ve.prototype,"instance",void 0),c([w(be)],ve.prototype,"draw",void 0),c([R(0,A(gi))],ve.prototype,"vertex",null),c([R(0,A(Te))],ve.prototype,"fragment",null);const ht={[X.BYTE]:1,[X.UNSIGNED_BYTE]:1,[X.SHORT]:2,[X.UNSIGNED_SHORT]:2,[X.INT]:4,[X.UNSIGNED_INT]:4,[X.FLOAT]:4};let As=class{constructor(e,t){this._boundPart=null;const i=[];for(const a of t.vertex){const o=Lt.createVertex(e,Et.STATIC_DRAW,a);i.push(o)}const r=[];for(const a of t.index||[]){const o=Lt.createIndex(e,Et.STATIC_DRAW,a);r.push(o)}this.groups=[];for(const a of t.groups){let o;if(a.index!=null){if(!t.index)throw new Error("No index data.");const{BYTES_PER_ELEMENT:f}=t.index[a.index];f===2?o=X.UNSIGNED_SHORT:f===4&&(o=X.UNSIGNED_INT)}const l=a.index!=null?r[a.index]:null,u=new Map,p={},d={};for(const f of a.attributes){const{name:m,count:y,type:v,offset:V,normalized:x,divisor:_,stride:F,vertex:T,location:C}=f,$=`vertex-buffer-${T}`;let K=p[$];K||(K=p[$]=[]);const ue=new $s(m,y,v,V,F,x,_);K.push(ue),u.set(m,C),d[$]=i[T]}const h=new zs(e,u,p,d,l);this.groups.push({...a,vertexArray:h,locations:u,layout:p,indexing:o})}this.parts=t.parts}bind(e,t){this._boundPart=t;const{group:i}=this.parts[this._boundPart],{vertexArray:r}=this.groups[i];e.bindVAO(r)}draw(e){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");const{start:t,count:i}=this.parts[this._boundPart],{group:r}=this.parts[this._boundPart],{indexing:a,primitive:o}=this.groups[r];a?e.drawElements(o,i,a,t*ht[a]):e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(const{vertexArray:e}of this.groups)e.dispose()}},Is=class xi extends As{static create(e,t){const i=[];let{stride:r,hash:a}=t.layout;if(r==null){r=0;for(const{count:f,type:m,offset:y}of t.layout.attributes){if(y!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");r+=f*ht[m]}}let o=0,l=0;for(const{count:f,name:m,offset:y,type:v,normalized:V}of t.layout.attributes){y!=null&&(l=y);const x={name:m,location:o,vertex:0,count:f,type:v,offset:l,stride:r,divisor:0,normalized:V!=null&&V};i.push(x),o++,l+=f*ht[v]}const u={attributes:i,primitive:t.primitive};t.index!=null&&(u.index=0);let{count:p}=t;if(p==null&&(p=t.index?t.index.length:t.vertex.byteLength/r,Math.floor(p)!==p))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${r}.`);const d={start:0,count:p,group:0,primitive:t.primitive},h={vertex:[t.vertex],parts:[d],groups:[u]};return t.index!=null&&(h.index=[t.index]),a==null&&(a=mi(i)),new xi(e,h,{hash:a,attributes:i,stride:r})}constructor(e,t,i){super(e,t),this.layout=i}bind(e,t=0){super.bind(e,t)}},Rs=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(this._dotFBO==null){const t=N,i=N,r=new Ge(t,i);r.samplingMode=_e.NEAREST,r.wrapMode=pt.CLAMP_TO_EDGE;const a=new _s(e,new hi(di.DEPTH_STENCIL,t,i));this._dotFBO=new fi(e,r,a)}return this._dotFBO}getDotDensityMesh(e){if(this._dotMesh==null){const t=N,i=t*t,r=2,a=new Int16Array(i*r);for(let u=0;u<t;u++)for(let p=0;p<t;p++)a[r*(p+u*t)]=p,a[r*(p+u*t)+1]=u;const o=[{count:2,type:X.UNSIGNED_SHORT,name:"a_position",offset:0}],l={hash:mi(o),attributes:o,stride:4};this._dotMesh=Is.create(e,{primitive:Ss.POINTS,vertex:a,count:i,layout:l})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),this._dotTextures===null){const r=new bs(i);this._dotTextures=[this._allocDotDensityTexture(e,t,r),this._allocDotDensityTexture(e,t,r)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){const r=new Float32Array(t*t*4);for(let o=0;o<r.length;o++)r[o]=i.getFloat();const a=new Ge;return a.dataType=We.FLOAT,a.samplingMode=_e.NEAREST,a.width=t,a.height=t,new yi(e,a,r)}},Cs=class extends k{constructor(){super(...arguments),this.shaders={polygon:new ve,point:new ye,fill:new Qt},this.meshWriter=B.DotDensityMeshWriter}render(e,t){ct(e)||P(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.fill,uniforms:{...E(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...I(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}_renderDotDensity(e,t){const{context:i,painter:r,requiredLevel:a}=e,o=t.instance.getInput();this._resources||(this._resources=new Rs);const l=this._resources.getDotDensityTextures(i,N,o.seed),u=1/2**(a-t.target.key.level),p=N,d=p*window.devicePixelRatio*p*window.devicePixelRatio,h=1/u*(1/u),f=o.dotScale?e.state.scale/o.dotScale:1,m=o.dotValue*f*h;r.setShader({shader:this.shaders.polygon,uniforms:{...E(e,t.target),instance:{isActive:o.isActive,colors:o.colors,dotValue:Math.max(1,m)},draw:{dotTexture0:{unit:It,texture:l[0]},dotTexture1:{unit:hs,texture:l[1]},tileZoomFactor:u,pixelRatio:window.devicePixelRatio,tileDotsOverArea:d/(N*window.devicePixelRatio*N*window.devicePixelRatio)}},defines:{...I(e),blending:o.blending},optionalAttributes:{},useComputeBuffer:!1}),r.setPipelineState(L(e));const y=i.getViewport();i.setViewport(0,0,N,N);const v=i.getBoundFramebufferObject(),V=this._resources.getFBO(i);i.bindFramebuffer(V),i.setClearColor(0,0,0,0),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.updatePipelineState(i),i.clear(dt.COLOR_BUFFER_BIT),r.submitDraw(i,t),i.bindFramebuffer(v),i.setViewport(y.x,y.y,y.width,y.height);const x=this._resources.getFBO(i).colorTexture;r.setShader({shader:this.shaders.point,uniforms:{view:ys(e,t.target),instance:{dotSize:o.dotSize},draw:{locations:{unit:It,texture:x},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...I(e)},optionalAttributes:{},useComputeBuffer:!1}),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.submitDrawMesh(i,this._resources.getDotDensityMesh(i))}shutdown(){super.shutdown(),this._resources&&this._resources.destroy(),this._resources=null}},Os=class extends k{constructor(){super(...arguments),this.meshWriter=B.ComplexFillMeshWriter,this.shaders={geometry:new Ci}}render(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...E(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Ze(t.target)},defines:{...I(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};function Ae(s){const e=1/s;return{antialiasing:e,blur:0+e}}let Es=class extends k{constructor(){super(...arguments),this.meshWriter=B.ComplexOutlineFillMeshWriter,this.shaders={geometry:new Oi}}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...E(e,t.target),antialiasingControls:Ae(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Ze(t.target)},defines:{...I(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},Ds=class extends k{constructor(){super(...arguments),this.meshWriter=B.FillMeshWriter,this.shaders={geometry:new Qt}}render(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...E(e,t.target)},defines:I(e),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},Ls=class extends k{constructor(){super(...arguments),this.meshWriter=B.OutlineFillMeshWriter,this.shaders={geometry:new Ei}}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...E(e,t.target),antialiasingControls:Ae(a)},defines:{...I(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},Bs=class extends k{constructor(){super(...arguments),this.meshWriter=B.PatternFillMeshWriter,this.shaders={geometry:new Di}}render(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...E(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Ze(t.target)},defines:{...I(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},ks=class extends k{constructor(){super(...arguments),this.meshWriter=B.PatternOutlineFillMeshWriter,this.shaders={geometry:new Li}}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...E(e,t.target),antialiasingControls:Ae(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Ze(t.target)},defines:{...I(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};function wi(s){return s?.25:1}let Si=class extends je{};c([g(5,b)],Si.prototype,"offset",void 0);let Ns=class extends Te{},ft=class extends pe{};c([w(n)],ft.prototype,"radius",void 0),c([w(n)],ft.prototype,"isFieldActive",void 0);let Fe=class extends Ke{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){const{radius:t,isFieldActive:i}=this.kernelControls,r=e.offset,a=i.multiply(this.storage.getVVData(e.id).x).add(new n(1).subtract(i)),o=this.view.displayViewScreenMat3.multiply(new z(e.pos,1)).add(this.view.displayViewMat3.multiply(new z(r,0)).multiply(t)),l=this.clip(e.id);return{glPosition:new S(o.xy,l,1),offset:r,fieldValue:a,color:new S(0),...this.maybeRunHittest(e,{},null)}}fragment(e){const{offset:t,fieldValue:i}=e,r=Zt(t),a=H(r,new n(1)),o=new n(1).subtract(r.multiply(r)),l=o.multiply(o),u=a.multiply(l).multiply(i).multiply(new n(wi(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new S(u),e)}hittest(e){const{viewMat3:t,tileMat3:i}=this.view,r=t.multiply(i).multiply(new z(e.pos,1));return Bi(r.xy,this.kernelControls.radius,this.hittestRequest.position)}};c([Ve],Fe.prototype,"usesHalfFloatPrecision",void 0),c([w(ft)],Fe.prototype,"kernelControls",void 0),c([R(0,A(Si))],Fe.prototype,"vertex",null),c([R(0,A(Ns))],Fe.prototype,"fragment",null);let Vi=class extends jt{};c([g(0,b)],Vi.prototype,"pos",void 0);let Us=class extends ki{},ke=class extends pe{};c([w(U)],ke.prototype,"texture",void 0),c([w(b)],ke.prototype,"minAndInvRange",void 0),c([w(n)],ke.prototype,"normalization",void 0);class _i extends pe{}c([w(U)],_i.prototype,"texture",void 0);let ge=class extends Kt{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new S(e.pos.multiply(2).subtract(1),1,1),uv:e.pos}}fragment(e){const{accumulatedDensity:t,gradient:i}=this;let r=Q(t.texture,e.uv).r.multiply(new n(wi(this.usesHalfFloatPrecision)));r=r.multiply(t.normalization),r=r.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);const a=Q(i.texture,new b(r,.5)),o=new bt;return o.glFragColor=new S(a.rgb.multiply(a.a),a.a),o}};c([Ve],ge.prototype,"usesHalfFloatPrecision",void 0),c([w(ke)],ge.prototype,"accumulatedDensity",void 0),c([w(_i)],ge.prototype,"gradient",void 0),c([R(0,A(Vi))],ge.prototype,"vertex",null),c([R(0,A(Us))],ge.prototype,"fragment",null);let kt=class{constructor(e,t,i,r){this.dataType=e,this.samplingMode=t,this.pixelFormat=i,this.internalFormat=r}};function Hs(s,e){const{textureFloat:t,colorBufferFloat:i}=s.capabilities,r=t==null?void 0:t.textureFloatLinear,a=i==null?void 0:i.textureFloat,o=i==null?void 0:i.textureHalfFloat,l=i==null?void 0:i.floatBlend,u=s.driverTest.floatBufferBlend.result;if(!a&&!o)throw new De("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(l&&u||o))throw new De("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(u?"":" This device claims support for EXT_float_blend, but does not actually support it."));const p=a&&l&&u,d=o,h=r,f=!!(i!=null&&i.R32F),m=!!(i!=null&&i.R16F);if(p&&h)return h||e.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new kt(We.FLOAT,h?_e.LINEAR:_e.NEAREST,f?fe.RED:fe.RGBA,f?Dt.R32F:fe.RGBA);if(d)return new kt(We.HALF_FLOAT,_e.LINEAR,m?fe.RED:fe.RGBA,m?Dt.R16F:fe.RGBA);throw new De("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}const Ws=()=>pi.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapTechnique");let Gs=class extends k{constructor(){super(...arguments),this.meshWriter=B.HeatmapMeshWriter,this.shaders={accumulate:new Fe,resolve:new ge},this.postProcessingEnabled=!0,this._isBound=!1,this.overrideStencilRef=zi}shutdown(){super.shutdown(),this._prevFBO=null,this._accumulateFramebuffer=Ct(this._accumulateFramebuffer),this._resolveGradientTexture=Ct(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null,this._unbind()}render(e,t){const{context:i,painter:r,state:a}=e,o=t.instance.getInput(),{isFieldActive:l}=o,u=this._loadQualityProfile(i);if(ct(e))return;P(e)||this._ensureBound(e,o),r.setShader({shader:this.shaders.accumulate,uniforms:{...E(e,t.target),kernelControls:{radius:et(o,a),isFieldActive:l?1:0}},defines:{...I(e),...u.defines},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)});const p=P(e)?qs:$i;r.setPipelineState(p),r.submitDraw(i,t)}postProcess(e,t){if(P(e)||ct(e)||this._prevFBO==null||this._prevViewport==null||this._accumulateFramebuffer==null||this._resolveGradientTexture==null)return;const{context:i,painter:r}=e,{defines:a}=this._loadQualityProfile(i),{minDensity:o,maxDensity:l,radius:u}=t.getInput(),p=8,d=9;r.setShader({shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:p,texture:this._accumulateFramebuffer.colorTexture},minAndInvRange:[o,1/(l-o)],normalization:3/(u*u*Math.PI)},gradient:{texture:{unit:d,texture:this._resolveGradientTexture}}},defines:a,optionalAttributes:{},useComputeBuffer:!1}),i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(this._accumulateFramebuffer.colorTexture,p),i.bindTexture(this._resolveGradientTexture,d),r.setPipelineState(js),r.submitDrawQuad(i),this._unbind()}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_ensureBound(e,t){if(this._isBound)return;const{context:i}=e;this._prevFBO=i.getBoundFramebufferObject(),this._prevViewport=i.getViewport(),this._ensureResources(e,t),this._updateResources(e,t),i.bindFramebuffer(this._accumulateFramebuffer),i.setViewport(0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height),i.setColorMask(!0,!0,!0,!0),i.setClearColor(0,0,0,0),i.clear(dt.COLOR_BUFFER_BIT),this._isBound=!0}_ensureResources({context:e,state:t,pixelRatio:i},r){if(this._accumulateFramebuffer==null){const{dataType:a,samplingMode:o,pixelFormat:l,internalFormat:u}=this._loadQualityProfile(e),{width:p,height:d}=this._prevViewport,h=Nt(et(r,t),i),f=p*h,m=d*h,y=new Ge(f,m);y.pixelFormat=l,y.internalFormat=u,y.dataType=a,y.samplingMode=o,y.wrapMode=pt.CLAMP_TO_EDGE;const v=new hi(di.DEPTH_STENCIL,f,m);this._accumulateFramebuffer=new fi(e,y,v)}if(this._resolveGradientTexture==null){const a=new Ge;a.wrapMode=pt.CLAMP_TO_EDGE,this._resolveGradientTexture=new yi(e,a)}}_updateResources({context:e,state:t,pixelRatio:i},r){const{gradient:a,gradientHash:o}=r;this._prevGradientHash!==o&&(this._resolveGradientTexture.resize(a.length/4,1),this._resolveGradientTexture.setData(a),this._prevGradientHash=o);const l=Nt(et(r,t),i),{width:u,height:p}=this._prevViewport,d=u*l,h=p*l,{width:f,height:m}=this._accumulateFramebuffer;f===d&&m===h||this._accumulateFramebuffer.resize(d,h),e.blitFramebuffer(this._prevFBO,this._accumulateFramebuffer,0,0,this._prevFBO.width,this._prevFBO.height,0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height,dt.STENCIL_BUFFER_BIT,_e.NEAREST)}_loadQualityProfile(e){if(this._qualityProfile==null){const t=Hs(e,Ws());this._qualityProfile={...t,defines:{usesHalfFloatPrecision:t.dataType!==We.FLOAT}}}return this._qualityProfile}};function Nt(s,e){const t=e>1.5?.25:.5;return s<1/(2*t)?1:t}function zi(s){return s.key.level+1}const $i={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:zi,compare:Vs.GEQUAL,mask:255,op:{fail:Je.KEEP,zFail:Je.KEEP,zPass:Je.REPLACE}}}},qs={...$i,stencil:!1},js={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function et(s,e){const{referenceScale:t,radius:i}=s;return i*(t!==0?t/e.scale:1)}let xt=class extends pe{getVVRotationMat4(e){return ce($t(e),He.identity(),()=>{const t=this._getNormalizedAngle(e).multiply(Mt),i=Ft(t),r=Pt(t);return new He(r,i,0,0,i.multiply(new n(-1)),r,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(e){return ce($t(e),j.identity(),()=>{const t=this._getNormalizedAngle(e).multiply(Mt),i=Ft(t),r=Pt(t);return new j(r,i,0,i.multiply(new n(-1)),r,0,0,0,1)})}_getNormalizedAngle(e){const t=Jt(this.rotationType,new n(at.Arithmatic));return ce(t,new n(90).subtract(e),e)}};c([w(n)],xt.prototype,"rotationType",void 0);const Ks=360/254;class G extends je{}c([g(3,S)],G.prototype,"color",void 0),c([g(4,b)],G.prototype,"offset",void 0),c([g(5,b)],G.prototype,"textureUV",void 0),c([g(6,n)],G.prototype,"fontSize",void 0),c([g(7,n)],G.prototype,"referenceSize",void 0),c([g(8,n)],G.prototype,"haloFontSize",void 0),c([g(9,S)],G.prototype,"haloColor",void 0),c([g(10,b)],G.prototype,"zoomRange",void 0),c([g(11,n)],G.prototype,"clipAngle",void 0),c([g(12,S)],G.prototype,"referenceSymbol",void 0);let mt=class extends ei{};c([g(13,b)],mt.prototype,"offsetNextVertex1",void 0),c([g(14,b)],mt.prototype,"offsetNextVertex2",void 0);class Zs extends Te{}class O extends Ke{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.isHaloPass=!1,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,i){const r=t.multiply(Ks),a=ti(this.view.rotation.subtract(r)),o=ot(new n(360).subtract(a),a);let l=new n(0);const u=Ni(this.view.currentZoom.multiply(Rt)).divide(Rt),p=e.x,d=e.y,h=new n(1).subtract(H(p,u)).multiply(2),f=H(new n(90),o).multiply(2),m=new n(2).multiply(new n(1).subtract(H(u,d)));return l=l.add(i.multiply(h)),l=l.add(i.multiply(f)),l=l.add(m),l}vertex(e,t){const i=le(e.bitset,ji),r=new n(1).subtract(i);let a=e.fontSize,o=a.divide(Tt);const l=this.isHaloPass?e.haloColor:this._getVertexColor(e),u=this.isLabel?l.multiply(this.storage.getAnimationValue(e.id)):l,p=this.view.displayViewScreenMat3.multiply(new z(e.pos,1));let d=e.offset,h=new n(1),f=j.identity();if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const F=e.referenceSymbol,T=F.xy,C=F.z,$=this._unpackDirection(F.w),K=nt(this,e.id,C).divide(2),ue=$.multiply(K.add(fs));d=d.add(T).add(ue)}else h=nt(this,e.id,e.referenceSize).divide(e.referenceSize),a=a.multiply(h),o=o.multiply(h),d=d.multiply(h),f=ii(this,e.id),d=f.multiply(new z(d,0)).xy;const m=le(e.bitset,Ki),y=this._getViewRotationMatrix(m).multiply(new z(d,0));let v=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,m):this.clip(e.id,e.zoomRange);v=this.isBackgroundPass?v.add(r.multiply(2)):v.add(i.multiply(2));const V=new S(p.xy.add(y.xy),v,1),x=e.textureUV.divide(this.mosaicInfo.size);let _=new n(0);return this.isHaloPass&&(_=e.haloFontSize.divide(o).divide(Ui)),{glPosition:V,color:u,size:o,textureUV:x,antialiasingWidth:new n(.105*Tt).divide(a).divide(this.view.pixelRatio),haloDistanceOffset:_,...this.maybeRunHittest(e,t,{vvSizeAdjustment:h,vvRotation:f})}}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}fragment(e){const t=new n(.25),i=new n(1).subtract(t),r=Q(this.mosaicInfo.texture,e.textureUV).a;let a=i.subtract(e.haloDistanceOffset);this.highlight&&(a=a.divide(2));const o=e.antialiasingWidth,l=Xt(a.subtract(o),a.add(o),r);return this.getFragmentOutput(e.color.multiply(l),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:r}){const a=r.multiply(new z(e.offset.multiply(i),0)),o=r.multiply(new z(t.offsetNextVertex1.multiply(i),0)),l=r.multiply(new z(t.offsetNextVertex2.multiply(i),0)),{viewMat3:u,tileMat3:p}=this.view,d=u.multiply(p).multiply(new z(e.pos,1)),h=d.add(p.multiply(a)).xy,f=d.add(p.multiply(o)).xy,m=d.add(p.multiply(l)).xy;return Hi(this.hittestRequest.position,h.xy,f.xy,m.xy)}_unpackDirection(e){const t=new Ye(e),i=Wi(t,new Ye(2)),r=Gi(t,new Ye(3));return new b(new n(i).subtract(1),new n(r).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){const i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new qi(!1))}if(this.visualVariableOpacity){const i=this.storage.getOpacityValue(e.id),r=this.visualVariableOpacity.getOpacity(i);t=t.multiply(r)}return t}}c([D(si)],O.prototype,"visualVariableColor",void 0),c([D(ri)],O.prototype,"visualVariableOpacity",void 0),c([D(xt)],O.prototype,"visualVariableRotation",void 0),c([D(ai)],O.prototype,"visualVariableSizeMinMaxValue",void 0),c([D(oi)],O.prototype,"visualVariableSizeScaleStops",void 0),c([D(ni)],O.prototype,"visualVariableSizeStops",void 0),c([D(li)],O.prototype,"visualVariableSizeUnitValue",void 0),c([w(vt)],O.prototype,"mosaicInfo",void 0),c([Ve],O.prototype,"isHaloPass",void 0),c([Ve],O.prototype,"isBackgroundPass",void 0),c([Ve],O.prototype,"isLabel",void 0),c([R(0,A(G)),R(1,A(mt))],O.prototype,"vertex",null),c([R(0,A(Zs))],O.prototype,"fragment",null);let Xs=class extends k{constructor(){super(...arguments),this.meshWriter=B.LabelMeshWriter,this.shaders={geometry:new O},this.drawPhase=xe.LABEL|xe.LABEL_ALPHA,this.symbologyPlane=de.TEXT}render(e,t){const{context:i,painter:r}=e,a=I(e),o={...L(e)},l={shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...E(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...a,isHaloPass:!1,isBackgroundPass:!0,isLabel:!0},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:!1};r.setShader(l),r.setPipelineState(o),r.submitDraw(i,t),r.setShader({...l,defines:{...a,isHaloPass:!0,isBackgroundPass:!1,isLabel:!0}}),r.setPipelineState(o),r.submitDraw(i,t),r.setShader({...l,defines:{...a,isHaloPass:!1,isBackgroundPass:!1,isLabel:!0}}),r.setPipelineState(o),r.submitDraw(i,t)}},Ys=class extends k{constructor(){super(...arguments),this.meshWriter=B.LineMeshWriter,this.shaders={geometry:new ui},this.symbologyPlane=de.LINE}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...E(e,t.target),antialiasingControls:Ae(a)},defines:{...I(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};class Ne extends Zi{}c([g(9,n)],Ne.prototype,"accumulatedDistance",void 0),c([g(10,b)],Ne.prototype,"segmentDirection",void 0),c([g(11,S)],Ne.prototype,"tlbr",void 0);class yt extends ui{_getLineWidthRatio(e,t){const i=new n(Ms),r=le(e.bitset,Qi);return r.multiply(Se(t,new n(.25))).add(new n(1).subtract(r)).divide(i)}_getSDFAlpha(e){const{halfWidth:t,normal:i,tlbr:r,patternSize:a,accumulatedDistance:o,lineWidthRatio:l}=e,u=a.x.multiply(new n(2)).multiply(l),p=At(o.divide(u)),d=new n(.25).multiply(i.y).add(new n(.5)),h=lt(r.xy,r.zw,new b(p,d)),f=ci(Q(this.mosaicInfo.texture,h)).subtract(new n(.5)).multiply(t),m=ut(new n(.5).subtract(f),new n(0),new n(1));return new S(m)}_getPatternColor(e){const{halfWidth:t,normal:i,color:r,accumulatedDistance:a,patternSize:o,sampleAlphaOnly:l,tlbr:u}=e,p=o.y.multiply(new n(2).multiply(t).divide(o.x)),d=At(a.divide(p)),h=new n(.5).multiply(i.y).add(new n(.5)),f=lt(u.xy,u.zw,new b(h,d));let m=Q(this.mosaicInfo.texture,f);return this.visualVariableColor!=null&&(m=ce(Qe(l,new n(.5)),new S(r.a),r)),m}vertex(e,t){const{segmentDirection:i,tlbr:r,bitset:a}=e,o=Xi(this,e),l=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(rt(i,o.scaledOffset)),u=new b(r.z.subtract(r.x),r.w.subtract(r.y)),p=r.divide(this.mosaicInfo.size.xyxy),d=le(a,Ji),h=le(a,es),f=ce(Qe(d,new n(.5)),this._getLineWidthRatio(e,o.scaledHalfWidth),new n(1));return{...o,tlbr:p,patternSize:u,accumulatedDistance:l,isSDF:d,sampleAlphaOnly:h,lineWidthRatio:f,...this.maybeRunHittest(e,t,o.halfWidth)}}fragment(e){const{color:t,opacity:i,isSDF:r}=e,a=Yi(e,this.antialiasingControls.blur),o=ce(Qe(r,new n(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),l=t.multiply(i).multiply(a).multiply(o);return this.getFragmentOutput(l,e)}}c([w(vt)],yt.prototype,"mosaicInfo",void 0),c([R(0,A(Ne)),R(1,A(ts))],yt.prototype,"vertex",null);let Qs=class extends k{constructor(){super(...arguments),this.meshWriter=B.TexturedLineMeshWriter,this.shaders={geometry:new yt},this.symbologyPlane=de.LINE}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...E(e,t.target),antialiasingControls:Ae(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...I(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};class ne extends je{}c([g(3,S)],ne.prototype,"color",void 0),c([g(4,S)],ne.prototype,"outlineColor",void 0),c([g(5,b)],ne.prototype,"offset",void 0),c([g(6,b)],ne.prototype,"textureUV",void 0),c([g(7,S)],ne.prototype,"sizing",void 0),c([g(8,n)],ne.prototype,"placementAngle",void 0),c([g(9,n)],ne.prototype,"sizeRatio",void 0),c([g(10,b)],ne.prototype,"zoomRange",void 0);class Pe extends ei{}c([g(12,b)],Pe.prototype,"offsetNextVertex1",void 0),c([g(13,b)],Pe.prototype,"offsetNextVertex2",void 0),c([g(14,b)],Pe.prototype,"textureUVNextVertex1",void 0),c([g(15,b)],Pe.prototype,"textureUVNextVertex2",void 0);class Js extends Te{}function oe(s,e,t,i){return e.multiply(s.x).add(t.multiply(s.y)).add(i.multiply(s.z))}function tt(s){return s.multiply(s).divide(128)}class q extends Ke{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=tt(e.sizing.x),r=tt(e.sizing.y),a=tt(e.sizing.z),o=e.placementAngle,l=le(e.bitset,$e.bitset.isSDF),u=le(e.bitset,$e.bitset.isMapAligned),p=le(e.bitset,$e.bitset.scaleSymbolsProportionally),d=is(e.bitset,$e.bitset.colorLocked),h=ss(this,e.id),f=rs(this,e.id,e.color,d).multiply(h),m=this.view.displayViewScreenMat3.multiply(new z(e.pos.xy,1)),y=nt(this,e.id,a).divide(a),v=i.multiply(y),V=e.offset.xy.multiply(y);let x=r.multiply(p.multiply(y.subtract(1)).add(1));x=ot(x,Se(v.subtract(.99),new n(0)));const _=Se(x,new n(1)),F=ot(x,new n(1)),T=j.fromRotation(o.multiply(as)),C=ii(this,e.id),$=this._getViewRotationMatrix(u).multiply(C).multiply(T).multiply(new z(V.xy,0)),K=this.clip(e.id,e.zoomRange),ue=new S(m.xy.add($.xy),K,1),Ie=e.textureUV.divide(this.mosaicInfo.size),Re=e.outlineColor.multiply(F),Ce=le(e.bitset,$e.bitset.overrideOutlineColor),ze=e.sizeRatio.multiply(v).multiply(.5);return{glPosition:ue,color:f,textureUV:Ie,outlineColor:Re,outlineSize:_,distanceToPx:ze,isSDF:l,overrideOutlineColor:Ce,...this.maybeRunHittest(e,t,{pos:e.pos,size:v,sizeCorrection:y,isMapAligned:u,outlineSize:_,distanceToPx:ze,isSDF:l})}}fragment(e){const t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return ce(os(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getViewScreenMatrix(e){const t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getColor(e,t){return ce(Jt(t.isSDF,new n(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return Q(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=Q(this.mosaicInfo.texture,e),r=new n(.5).subtract(ci(i)).multiply(t.distanceToPx).multiply(ns),a=ut(new n(.5).subtract(r),new n(0),new n(1)),o=t.color.multiply(a);let l=t.outlineSize;this.highlight&&(l=Se(l,t.overrideOutlineColor.multiply(4)));const u=l.multiply(.5),p=ti(r).subtract(u),d=ut(new n(.5).subtract(p),new n(0),new n(1)),h=lt(t.outlineColor,t.color,t.overrideOutlineColor).multiply(d);return new n(1).subtract(h.a).multiply(o).add(h)}_hittestSmallMarker(e,t,i){const{position:r,distance:a,smallSymbolDistance:o}=this.hittestRequest,l=a.subtract(o),{viewMat3:u,tileMat3:p}=this.view,d=u.multiply(p).multiply(new z(i.pos,1)).xy,h=i.size.multiply(.5);return ls(d,r).subtract(h).add(l)}_hittestMarker(e,t,i){const{pos:r,size:a,sizeCorrection:o,isMapAligned:l,outlineSize:u,isSDF:p,distanceToPx:d}=i,h=new z(e.offset.multiply(o),0),f=new z(t.offsetNextVertex1.multiply(o),0),m=new z(t.offsetNextVertex2.multiply(o),0),{viewMat3:y,tileMat3:v}=this.view,V=y.multiply(v).multiply(new z(r,1)),x=this._getViewScreenMatrix(l),_=V.add(x.multiply(h)).xy,F=V.add(x.multiply(f)).xy,T=V.add(x.multiply(m)).xy,C=this.hittestRequest.position,$=this.hittestRequest.distance,K=re(C.add(new b(he($),he($))),_,F,T),ue=re(C.add(new b(0,he($))),_,F,T),Ie=re(C.add(new b($,he($))),_,F,T),Re=re(C.add(new b(he($),0)),_,F,T),Ce=re(C,_,F,T),ze=re(C.add(new b($,0)),_,F,T),St=re(C.add(new b(he($),$)),_,F,T),Vt=re(C.add(new b(0,$)),_,F,T),_t=re(C.add(new b($,$)),_,F,T),ee=e.textureUV.divide(this.mosaicInfo.size),te=t.textureUVNextVertex1.divide(this.mosaicInfo.size),ie=t.textureUVNextVertex2.divide(this.mosaicInfo.size),se={color:new S(1),outlineColor:new S(1),overrideOutlineColor:new n(1),outlineSize:u,distanceToPx:d,isSDF:p};let M=new n(0);return M=M.add(ae(K).multiply(this._getColor(oe(K,ee,te,ie),se).a)),M=M.add(ae(ue).multiply(this._getColor(oe(ue,ee,te,ie),se).a)),M=M.add(ae(Ie).multiply(this._getColor(oe(Ie,ee,te,ie),se).a)),M=M.add(ae(Re).multiply(this._getColor(oe(Re,ee,te,ie),se).a)),M=M.add(ae(Ce).multiply(this._getColor(oe(Ce,ee,te,ie),se).a)),M=M.add(ae(ze).multiply(this._getColor(oe(ze,ee,te,ie),se).a)),M=M.add(ae(St).multiply(this._getColor(oe(St,ee,te,ie),se).a)),M=M.add(ae(Vt).multiply(this._getColor(oe(Vt,ee,te,ie),se).a)),M=M.add(ae(_t).multiply(this._getColor(oe(_t,ee,te,ie),se).a)),H(M,new n(.05)).multiply(Yt(this.hittestRequest))}}c([D(si)],q.prototype,"visualVariableColor",void 0),c([D(ri)],q.prototype,"visualVariableOpacity",void 0),c([D(xt)],q.prototype,"visualVariableRotation",void 0),c([D(ai)],q.prototype,"visualVariableSizeMinMaxValue",void 0),c([D(oi)],q.prototype,"visualVariableSizeScaleStops",void 0),c([D(ni)],q.prototype,"visualVariableSizeStops",void 0),c([D(li)],q.prototype,"visualVariableSizeUnitValue",void 0),c([w(vt)],q.prototype,"mosaicInfo",void 0),c([R(0,A(ne)),R(1,A(Pe))],q.prototype,"vertex",null),c([R(0,A(Js))],q.prototype,"fragment",null);let er=class extends k{constructor(){super(...arguments),this.meshWriter=B.MarkerMeshWriter,this.shaders={geometry:new q},this.symbologyPlane=de.MARKER}render(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...E(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey,!0)},defines:{...I(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};class tr{constructor(){this.computeAttributes={}}get locationsMap(){const e=new Map;for(const t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map(([r,a])=>`${r}.${a}`).join("."),i=vs(t);this._locationInfo={hash:i,locations:e}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){const r=Object.keys(i).filter(o=>i[o]).map(o=>`${o}_${i[o].toString()}`).join("."),a=Object.keys(t).filter(o=>this.optionPropertyKeys.has(o)).join(".");return`${e.hash}.${r}.${a}`}getProgram(e,t,i,r){let a="",o="";for(const l in i)if(i[l]){const u=typeof i[l]=="boolean"?`#define ${l}
`:`#define ${l} ${i[l]}
`;a+=u,o+=u}return a+=this.vertexShader,o+=this.fragmentShader,new us(a,o,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){const t=[];for(const i in this.required){const r=this.required[i];t.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:r.type,uniformArrayElementType:Ut(r),uniformArrayLength:Ht(r)})}for(const i in e){const r=this.options[i];if(e[i])for(const a in r){const o=r[a];t.push({uniformHydrated:null,shaderModulePath:`${i}.${a}`,uniformName:a,uniformType:o.type,uniformArrayElementType:Ut(o),uniformArrayLength:Ht(o)})}}return t}}const Ut=s=>{var e;return s.type==="array"?(e=s.elementType)==null?void 0:e.type:void 0},Ht=s=>s.type==="array"?s.size:void 0,ir={hittestDist:n,hittestPos:b},sr={filterFlags:U,animation:U,visualVariableData:U,dataDriven0:U,dataDriven1:U,dataDriven2:U,gpgpu:U,size:n},rr={displayViewScreenMat3:j,displayViewMat3:j,displayMat3:j,viewMat3:j,tileMat3:j,displayZoomFactor:n,requiredZoomFactor:n,tileOffset:b,currentScale:n,currentZoom:n,metersPerSRUnit:n};let ar=class extends tr{constructor(){super(...arguments),this.vertexShader=Bt("materials/pie/pie.vert"),this.fragmentShader=Bt("materials/pie/pie.frag"),this.required={...sr,...rr,outlineWidth:n,colors:Z,defaultColor:S,othersColor:S,outlineColor:S,donutRatio:n,sectorThreshold:n},this.options={hittestUniforms:ir,visualVariableSizeMinMaxValue:{minMaxValueAndSize:S},visualVariableSizeScaleStops:{sizes:{...Z.ofType(n,8),type:"array",elementType:n,size:8},values:{...Z.ofType(n,8),type:"array",elementType:n,size:8}},visualVariableSizeStops:{sizes:{...Z.ofType(n,8),type:"array",elementType:n,size:8},values:{...Z.ofType(n,8),type:"array",elementType:n,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:n},visualVariableOpacity:{opacities:{...Z.ofType(n,8),type:"array",elementType:n,size:8},opacityValues:{...Z.ofType(n,8),type:"array",elementType:n,size:8}}},this.locations={pos:{index:0,type:b},id:{index:1,type:z},bitset:{index:2,type:n},offset:{index:3,type:b},texCoords:{index:4,type:b},size:{index:5,type:b},referenceSize:{index:6,type:n},zoomRange:{index:7,type:b}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors={...Z.ofType(S,e),type:"array",elementType:S,size:e}}},or=class extends k{constructor(){super(...arguments),this.meshWriter=B.PieChartMeshWriter,this.shaders={geometry:new ar},this.symbologyPlane=de.MARKER}render(e,t){var m,y;const{context:i,painter:r}=e,{instance:a,target:o}=t,l=this.shaders.geometry,u=a.getInput(),p=u.numberOfFields,d=P(e),h=E(e,o),f=I(e);l.setNumberOfFields(p),r.setShader({shader:l,uniforms:{...W(e,t.target,u.geometry),...h.storage,...h.view,hittestUniforms:h.hittestRequest?{hittestDist:(m=h.hittestRequest)==null?void 0:m.distance,hittestPos:(y=h.hittestRequest)==null?void 0:y.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!u.geometry.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!u.geometry.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!u.geometry.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!u.geometry.visualVariableSizeUnitValue,VV_OPACITY:!!u.geometry.visualVariableOpacity,HITTEST:d,highlight:h.highlight?1:0,...f,numberOfFields:p},optionalAttributes:{},useComputeBuffer:d}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},nr=class extends k{constructor(){super(...arguments),this.meshWriter=B.TextMeshWriter,this.shaders={geometry:new O},this.symbologyPlane=de.TEXT}render(e,t){const{context:i,painter:r}=e,a=I(e),o={shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...E(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...a,isHaloPass:!1,isBackgroundPass:!0,isLabel:!1},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)};r.setShader(o),r.setPipelineState(L(e)),r.submitDraw(i,t),r.setShader({...o,defines:{...a,isHaloPass:!0,isBackgroundPass:!1,isLabel:!1}}),r.submitDraw(i,t),r.setShader({...o,defines:{...a,isHaloPass:!1,isBackgroundPass:!1,isLabel:!1}}),r.submitDraw(i,t)}};const J={fill:new Ds("fill"),patternFill:new Bs("patternFill"),complexFill:new Os("complexFill"),outlineFill:new Ls("outlineFill"),patternOutlineFill:new ks("patternOutlineFill"),complexOutlineFill:new Es("complexOutlineFill"),marker:new er("marker"),pieChart:new or("pieChart"),line:new Ys("line"),texturedLine:new Qs("texturedLine"),text:new nr("text"),label:new Xs("label"),heatmap:new Gs("heatmap"),dotDensity:new Cs("dotDensity")};function ka(){for(const s in J)J[s].startup()}function Na(){for(const s in J)J[s].shutdown()}function qe(s,e){const t=s.slice(0,e),i=e-t.length;for(let r=0;r<i;r++){const a=t[t.length-1];t.push(a)}return t}function lr(s){if(!s)return[0,0,0,0];const{r:e,g:t,b:i,a:r}=s;return[e*(r/255),t*(r/255),i*(r/255),r]}const Ue=8,Mi=Ue-2,Fi=()=>pi.getLogger("esri.views.2d.layers.features.support.rendererUtils");function Pi(s){return s.map(e=>ur(e)?cr(e.clone()):e)}function ur(s){return(s.type==="size"||s.type==="color"||s.type==="opacity")&&s.stops!=null}function cr(s){return s.stops=hr(s.type,s.stops??[]),s}function me(s,e,t){return(1-t)*s+t*e}function pr(s,e){const[t,...i]=e,r=i.pop(),a=i[0].value,o=i[i.length-1].value,l=(o-a)/Mi,u=[];for(let p=a;p<o;p+=l){let d=0;for(;p>=i[d].value;)d++;const h=i[d],f=e[d-1],m=p-f.value,y=h.value===f.value?1:m/(h.value-f.value);if(s==="color"){const v=i[d],V=e[d-1],x=v.color.clone();x.r=me(V.color.r,x.r,y),x.g=me(V.color.g,x.g,y),x.b=me(V.color.b,x.b,y),x.a=me(V.color.a,x.a,y),u.push({value:p,color:x,label:v.label})}else if(s==="size"){const v=i[d],V=e[d-1],x=Ot(v.size),_=me(Ot(V.size),x,y);u.push({value:p,size:_,label:v.label})}else{const v=i[d],V=me(e[d-1].opacity,v.opacity,y);u.push({value:p,opacity:V,label:v.label})}}return[t,...u,r]}function dr(s){const[e,...t]=s,i=t.pop();for(;t.length>Mi;){let r=0,a=0;for(let o=1;o<t.length;o++){const l=t[o-1],u=t[o],p=Math.abs(u.value-l.value);p>a&&(a=p,r=o)}t.splice(r,1)}return[e,...t,i]}function hr(s,e){return e.length<=Ue?e:(Fi().warn(`Found ${e.length} Visual Variable stops, but MapView only supports ${Ue}. Displayed stops will be simplified.`),e.length>2*Ue?pr(s,e):dr(e))}function fr(){const{supportsColorBufferFloat:s,supportsColorBufferFloatBlend:e,supportsColorBufferHalfFloat:t}=gt();return s&&e||t}function Ua(s){if(!s)return!0;switch(s.type){case"dot-density":break;case"heatmap":if(!fr()){const e=gt(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(i=>!e[i]).join(", ");return Fi().errorOnce(new De("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}const mr=1.25,Ee=128,yr=128;function br(s){var a;if(!((a=s.stops)!=null&&a.length))return null;const e=s.stops.sort((o,l)=>o.value-l.value),t=qe(e,8),i=t.map(({value:o})=>o),r=t.map(({color:o})=>lr(o));return{values:i,colors:r}}function vr(s){var i;if(!((i=s.stops)!=null&&i.length))return null;const e=s.stops.sort((r,a)=>r.value-a.value),t=qe(e,8);return{opacityValues:t.map(({value:r})=>r),opacities:t.map(({opacity:r})=>r)}}function gr(s){return{rotationType:s.rotationType==="geographic"?at.Geographic:at.Arithmatic}}function it(s){var i;if(!((i=s.stops)!=null&&i.length))return null;if(s.stops.some(r=>r.useMaxValue||r.useMinValue))return(r,a)=>{const o=r.statisticsByLevel.get(a.key.level),l=s.stops.map(p=>{var d,h;return{value:p.useMaxValue?((d=o==null?void 0:o.get(s.field))==null?void 0:d.maxValue)??0:p.useMinValue?((h=o==null?void 0:o.get(s.field))==null?void 0:h.minValue)??0:p.value,size:p.size?we(p.size):ms}}).sort((p,d)=>p.value-d.value),u=qe(l,8);return{values:u.map(({value:p})=>p),sizes:u.map(({size:p})=>p)}};const e=s.stops.sort((r,a)=>r.value-a.value),t=qe(e,8);return{values:t.map(({value:r})=>r),sizes:t.map(({size:r})=>we(r))}}function xr(s){return e=>{const{state:t}=e;return{unitValueToPixelsRatio:gs(t.spatialReference)/Fs[s.valueUnit]/t.resolution}}}function Wt(s,e){const t=e.length;if(s<e[0].value||t===1)return e[0].size;for(let i=1;i<t;i++)if(s<e[i].value){const r=(s-e[i-1].value)/(e[i].value-e[i-1].value);return e[i-1].size+r*(e[i].size-e[i-1].size)}return e[t-1].size}function wr(s){const{minDataValue:e,maxDataValue:t,minSize:i,maxSize:r}=s;if(typeof i=="object"&&typeof r=="object")return(a,o)=>{const l=a.state.scale,u=we(Wt(l,i.stops)),p=we(Wt(l,r.stops));return{minMaxValueAndSize:[e,t,u,p]}};if(typeof i=="object"||typeof r=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[e,t,we(i),we(r)]}}const wt={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function Ti(s,e=yr,t=mr){if(s.visualVariableSizeMinMaxValue)return s.visualVariableSizeMinMaxValue instanceof Function?Ee:Math.max(s.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*t,e);if(s.visualVariableSizeScaleStops){if(s.visualVariableSizeScaleStops instanceof Function)return Ee;const i=s.visualVariableSizeScaleStops.sizes;return Math.max(i[i.length-1]*t,e)}if(s.visualVariableSizeStops){if(s.visualVariableSizeStops instanceof Function)return Ee;const i=s.visualVariableSizeStops.sizes;return Math.max(i[i.length-1]*t,e)}return s.visualVariableSizeUnitValue?2*Ee:0}function Ha(s){const e={...wt};if(!s||!("visualVariables"in s)||!s.visualVariables)return e;for(const t of Pi(s.visualVariables))switch(t.type){case"color":e.visualVariableColor=br(t);break;case"opacity":e.visualVariableOpacity=vr(t);break;case"rotation":e.visualVariableRotation=gr(t);break;case"size":switch(Sr(t)){case"field-stops":e.visualVariableSizeStops=it(t);break;case"scale-stops":t.target==="outline"?e.visualVariableSizeOutlineScaleStops=it(t):e.visualVariableSizeScaleStops=it(t);break;case"min-max":e.visualVariableSizeMinMaxValue=wr(t);break;case"unit-value":e.visualVariableSizeUnitValue=xr(t)}break;default:console.error("Unable to handle VV type")}return e}function Sr(s){if(typeof s.minDataValue=="number"&&typeof s.maxDataValue=="number"&&s.minSize!=null&&s.maxSize!=null)return"min-max";if((s.expression&&s.expression==="view.scale"||s.valueExpression&&s.valueExpression==="$view.scale")&&Array.isArray(s.stops))return"scale-stops";if((s.field!=null||s.expression&&s.expression!=="view.scale"||s.valueExpression&&s.valueExpression!=="$view.scale")&&(Array.isArray(s.stops)||"levels"in s&&s.levels))return"field-stops";if((s.field!=null||s.expression&&s.expression!=="view.scale"||s.valueExpression&&s.valueExpression!=="$view.scale")&&s.valueUnit!=null)return"unit-value";throw new Error("InternalError: Found unknown sizeVV type")}function Vr(s){return s.minScale||s.maxScale?{minScale:s.minScale??0,maxScale:s.maxScale??0}:null}function Y(s){if(s==null)return null;if(Array.isArray(s)){const[e,t,i,r]=s;return[e,t,i,255*r]}return typeof s=="string"?s:{...s,defaultValue:Y(s==null?void 0:s.defaultValue)}}function _r(s){return!!(s.visualVariableSizeMinMaxValue||s.visualVariableSizeScaleStops||s.visualVariableSizeStops||s.visualVariableSizeUnitValue||s.visualVariableSizeOutlineScaleStops)}async function Wa(s,e){const{cimResourceManager:t,cimAnalyzer:i,scaleExpression:r}=e.schemaOptions;await Promise.all(cs.fetchResources(s.symbol,t,[]));const a=i.analyzeSymbolReference(s,!1),o={scaleInfo:Vr(s),scaleExpression:r},l=[];for(const u of a)switch(u.type){case"marker":l.push(...zr(u,e,o));break;case"fill":l.push(...Pr(u,e,o));break;case"line":l.push(...Ar(u,e,o));break;case"text":l.push(...Cr(u,e,o))}return l}function zr(s,e,t){const{uniforms:i,schemaOptions:r}=e,{store:a}=r,o=s.isOutline?{...wt,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation};return $r(a.ensureInstance(J.marker,{geometry:o},{zoomRange:!!t.scaleInfo}),s,i,t)}function $r(s,e,t,{scaleInfo:i,scaleExpression:r}){const a=_r(t);return[s.createMeshInfo({params:{size:e.size,scaleX:e.scaleX,anchorX:e.anchorPoint.x,anchorY:e.anchorPoint.y,angle:e.rotation,color:Y(e.color)??[0,0,0,0],colorLocked:e.colorLocked,frameHeight:e.frameHeight,widthRatio:e.widthRatio,scaleInfo:i,offsetX:e.offsetX,offsetY:e.offsetY,outlineColor:Y(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineWidth,referenceSize:e.referenceSize||ds.CIMVectorMarker.size,rotateClockwise:e.rotateClockwise,scaleFactor:r??1,sizeRatio:e.sizeRatio,alignment:e.alignment,isAbsoluteAnchorPoint:e.isAbsoluteAnchorPoint,scaleSymbolsProportionally:e.scaleSymbolsProportionally,sprite:e.spriteRasterizationParam,hasSizeVV:a,placement:e.markerPlacement,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,transforms:e.transform,minPixelBuffer:Ti(t)}})]}function Mr(s,e,t){const{uniforms:i,schemaOptions:r}=e,{store:a}=r;return Fr(a.ensureInstance(J.fill,{geometry:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!!t.scaleInfo}),s,t)}function Fr(s,e,{scaleInfo:t}){return[s.createMeshInfo({params:{color:Y(e.color)??[0,0,0,0],scaleInfo:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}})]}function Pr(s,e,t){if(!s.spriteRasterizationParam)return Mr(s,e,t);const{uniforms:i,schemaOptions:r}=e,{store:a}=r;return Tr(a.ensureInstance(J.complexFill,{geometry:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!!t.scaleInfo}),s,i.visualVariableColor!=null,t)}function Tr(s,e,t,{scaleInfo:i}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const r=!!e.hasUnresolvedReplacementColor&&(!t||e.colorLocked),a=e.sampleAlphaOnly&&!r,o=e.spriteRasterizationParam;return[s.createMeshInfo({params:{color:Y(e.color)??[0,0,0,0],height:e.height,aspectRatio:e.scaleX,offsetX:e.offsetX,offsetY:e.offsetY,scaleX:1,scaleY:1,angle:e.angle,applyRandomOffset:e.applyRandomOffset,sampleAlphaOnly:a,scaleProportionally:o.resource.type==="CIMHatchFill",sprite:o,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}})]}function Ar(s,e,t){const{uniforms:i,schemaOptions:r}=e,{store:a}=r,o=s.isOutline?{...wt,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},l={geometry:o},u=!!(o.visualVariableSizeMinMaxValue||o.visualVariableSizeScaleStops||o.visualVariableSizeStops||o.visualVariableSizeUnitValue);return s.spriteRasterizationParam?Rr(a.ensureInstance(J.texturedLine,l,{zoomRange:!!t.scaleInfo}),s,u,t):Ir(a.ensureInstance(J.line,l,{zoomRange:!!t.scaleInfo}),s,u,t)}function Ai(s,e,{scaleInfo:t}){return{params:{color:Y(s.color)??[0,0,0,0],width:s.width,referenceWidth:s.referenceWidth,capType:s.cap,joinType:s.join,miterLimit:s.miterLimit,scaleInfo:t,hasSizeVV:e,effects:s.effects?{type:"cim-effect-infos",effectInfos:s.effects}:null}}}function Ir(s,e,t,i){if(e.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");return[s.createMeshInfo({params:Ai(e,t,i).params})]}function Rr(s,e,t,i){const{spriteRasterizationParam:r,scaleDash:a,sampleAlphaOnly:o}=e;if(!r)throw new Error("InternalError: Sprite should be defined");return[s.createMeshInfo({params:{...Ai(e,t,i).params,shouldScaleDash:a??!1,shouldSampleAlphaOnly:o,isSDF:r.resource.type!=="CIMPictureStroke",sprite:r}})]}function Cr(s,e,t){const{uniforms:i,schemaOptions:r}=e,{store:a}=r;return Or(a.ensureInstance(J.text,{geometry:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue}},{zoomRange:!!t.scaleInfo,referenceSymbol:!1,clipAngle:!1}),s,i,t)}function Or(s,e,t,{scaleInfo:i,scaleExpression:r}){return[s.createMeshInfo({params:{boxBackgroundColor:Y(e.backgroundColor),boxBorderLineColor:Y(e.borderLineColor),boxBorderLineSize:e.borderLineWidth??0,color:Y(e.color)??[0,0,0,0],offsetX:e.offsetX,offsetY:e.offsetY,postAngle:e.angle,fontSize:e.size,referenceSize:e.referenceSize,decoration:e.decoration,haloColor:Y(e.outlineColor)??[0,0,0,0],haloFontSize:e.outlineSize,lineWidth:e.lineWidth||512,lineHeightRatio:1,horizontalAlignment:e.horizontalAlignment??"center",verticalAlignment:e.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:e.textRasterizationParam,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,placement:e.markerPlacement,transforms:e.transform,scaleFactor:r??1,minPixelBuffer:Ti(t),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1}})]}function Ga(s,e){return{type:"simple",filters:e,capabilities:{maxTextureSize:gt().maxTextureSize},bindings:Er(s)}}function Xe(s){switch(s){case"opacity":return Oe.OPACITY;case"color":return Oe.COLOR;case"rotation":return Oe.ROTATION;case"size":return Oe.SIZE;default:return null}}function Er(s){if(!s)return[];switch(s.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return Ii(s);case"dot-density":return Dr(s);case"pie-chart":return Lr(s);case"heatmap":return Br(s)}}function Dr(s){const e=[];for(const t of s.attributes)e.push({binding:e.length,expression:t.valueExpression,field:t.field});return e}function Lr(s){const e=Ii(s);let t=4;for(const i of s.attributes)e.push({binding:t++,expression:i.valueExpression,field:i.field});return e}function Br({valueExpression:s,field:e}){return s||e?[{binding:0,expression:s,field:e}]:[]}function Ii(s){var e;return!("visualVariables"in s)||!((e=s.visualVariables)!=null&&e.length)?[]:Pi(s.visualVariables).map(t=>Wr(t)).filter(xs)}function kr(s){return s.valueExpression==="$view.scale"?null:{binding:Xe(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression,valueRepresentation:s.valueRepresentation}}function Nr(s){return{binding:Xe(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function Ur(s){return{binding:Xe(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function Hr(s){return{binding:Xe(s.type),expression:s.valueExpression,field:s.field}}function Wr(s){switch(s.type){case"size":return kr(s);case"color":return Nr(s);case"opacity":return Ur(s);case"rotation":return Hr(s)}}function st(s){return s.some(e=>e.globalId)}function Me(s){return s.filter(e=>!e.error).map(e=>e.objectId??e.globalId).filter(e=>e!=null)}function Gt(s,e){const t=new Set(s);for(const i of e.values())t.add(i);return t}function qt(s,e){const t=new Set(s);for(const i of e.values())t.delete(i);return t}class qa{constructor(e){this.updateTracking=new ps({debugName:"FeatureCommandQueue"}),this._hasGlobalIds=!1,this._queueProcessor=new ws({concurrency:1,process:e.process})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return this.updateTracking.addPromise(this._doPush(e))}async _doPush(e){const t=this._queueProcessor,i=t.last(),r=[];switch(e.type){case"update":if((i==null?void 0:i.type)===e.type)return;r.push(t.push(e));break;case"edit":{const a=(i==null?void 0:i.type)==="processed-edit"?i:null;a&&t.popLast();const o=this._mergeEdits(a,e);for(const l of o)l&&r.push(t.push(l));break}}await Promise.all(r)}_mergeEdits(e,t){const{addedFeatures:i,deletedFeatures:r,updatedFeatures:a}=t.edits;if(this._hasGlobalIds=this._hasGlobalIds||st(i)||st(a)||st(r),this._hasGlobalIds)return[e,{type:"processed-edit",edits:{addOrModified:[...i,...a],removed:r}}];const o=new Set(Me((e==null?void 0:e.edits.addOrModified)??[])),l=new Set(Me((e==null?void 0:e.edits.removed)??[])),u=new Set([...Me(i),...Me(a)]),p=new Set(Me(r));return[{type:"processed-edit",edits:{addOrModified:Array.from(Gt(qt(o,p),u)).map(d=>({objectId:d})),removed:Array.from(Gt(qt(l,u),p)).map(d=>({objectId:d}))}}]}}export{ka as F,Tr as S,Na as T,Rr as a,qa as b,Ha as c,lr as d,Ti as e,_r as f,Ii as g,J as h,Ua as m,Wa as n,Fr as p,Vr as r,Ga as t,$r as u,wt as x,Or as y,Ir as z};
