import{b as j}from"./Graphic-Dt0LgVGU.js";import{B as y,s as x}from"./Accessor-BmwT4B0c.js";import{c as T,X as F}from"./Point-Cz2JYYmX.js";import{c as X}from"./cast-CsZslgGN.js";import{N as G,L as M,$ as N}from"./projection-CyCZAIaD.js";import{f as Y}from"./jsonUtils-CwFG8yN4.js";import{N as Z}from"./MeshTransform-mu8wTSqx.js";import{isFeatureIdentifierArrayWithGlobalId as v,isFeatureIdentifierArrayWithObjectId as L}from"./editingSupport-DwgIc4Po.js";async function D(e,t,s){const{geometry:o}=t,a={...t.attributes};if(s!=null&&(o==null?void 0:o.type)==="mesh"){const{transformFieldRoles:r}=s,{origin:u,spatialReference:n,vertexSpace:p}=o,l=o.transform??new Z,d=p.type==="local",i=e.spatialReference,h=i.isGeographic,w=T(i,n),$=G(n,i)&&M(n,i);if(!(d&&h&&$||!d&&!h&&w))return null;const m=N(u,n,i);if(m==null)return null;if(a[r.originX]=m.x,a[r.originY]=m.y,a[r.originZ]=m.z??0,l!=null){const{translation:b,scale:I,rotation:f}=l,R=d?1:F(n)/F(i);a[r.translationX]=b[0]*R,a[r.translationY]=b[2]*R,a[r.translationZ]=-b[1]*R,a[r.scaleX]=I[0],a[r.scaleY]=I[2],a[r.scaleZ]=I[1],a[r.rotationX]=f[0],a[r.rotationY]=f[2],a[r.rotationZ]=-f[1],a[r.rotationDeg]=f[3]}return{attributes:a}}return o==null?{attributes:a}:o.type==="mesh"||o.type==="extent"?null:{geometry:o.toJSON(),attributes:a}}async function J(e,t){const s=await Promise.all((t.addAttachments??[]).map(r=>A(e,r))),o=await Promise.all((t.updateAttachments??[]).map(r=>A(e,r))),a=t.deleteAttachments??[];return s.length||o.length||a.length?{adds:s,updates:o,deletes:[...a]}:null}async function A(e,t){var d;const{feature:s,attachment:o}=t,{globalId:a,name:r,contentType:u,data:n,uploadId:p}=o,l={globalId:a};if(s&&("attributes"in s?l.parentGlobalId=(d=s.attributes)==null?void 0:d[e.globalIdField]:s.globalId&&(l.parentGlobalId=s.globalId)),p)l.uploadId=p;else if(n){const i=await X(n);i&&(l.contentType=i.mediaType,l.data=i.data),n instanceof File&&(l.name=n.name)}return r&&(l.name=r),u&&(l.contentType=u),l}function k(e,t,s){if(!t||t.length===0)return[];if(s&&v(t))return t.map(a=>a.globalId);if(L(t))return t.map(a=>a.objectId);const o=s?e.globalIdField:e.objectIdField;return o?t.map(a=>a.getAttribute(o)):[]}function q(e){var a,r,u;const t=e==null?void 0:e.assetMaps;if(t){for(const n of t.addResults)n.success||y.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${n.globalId}.`);for(const n of t.updateResults)n.success||y.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${n.globalId}.`)}const s=e==null?void 0:e.attachments,o={addFeatureResults:((a=e==null?void 0:e.addResults)==null?void 0:a.map(c))??[],updateFeatureResults:((r=e==null?void 0:e.updateResults)==null?void 0:r.map(c))??[],deleteFeatureResults:((u=e==null?void 0:e.deleteResults)==null?void 0:u.map(c))??[],addAttachmentResults:s!=null&&s.addResults?s.addResults.map(c):[],updateAttachmentResults:s!=null&&s.updateResults?s.updateResults.map(c):[],deleteAttachmentResults:s!=null&&s.deleteResults?s.deleteResults.map(c):[]};return e!=null&&e.editMoment&&(o.editMoment=e.editMoment),o}function c(e){const t=e.success===!0?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new x("feature-layer-source:edit-failure",t.description,{code:t.code}):null}}function g(e,t){return new j({attributes:e.attributes,geometry:Y({...e.geometry,spatialReference:t})})}function E(e,t){var s,o,a;return{adds:((s=e==null?void 0:e.adds)==null?void 0:s.map(r=>g(r,t)))||[],updates:((o=e==null?void 0:e.updates)==null?void 0:o.map(r=>({original:g(r[0],t),current:g(r[1],t)})))||[],deletes:((a=e==null?void 0:e.deletes)==null?void 0:a.map(r=>g(r,t)))||[],spatialReference:t}}function H(e){const t=e.details.raw,s=+t.code,o=+t.extendedCode;return s===500&&(o===-2147217144||o===-2147467261)}export{E as I,c as R,k as b,J as f,H as j,D as m,q as y};
