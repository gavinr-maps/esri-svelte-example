import{aq as I,c as S}from"./Accessor-BHnuXKD2.js";import{f as w}from"./jsonUtils-Cu7OBRmN.js";import{R as h}from"./normalizeUtils-XRAPXbWa.js";import{c as T}from"./Point-XGrwlf63.js";import{B as q,x as v,j as g}from"./queryUtils-DBeaQ3x_.js";import{c as Q,C as j,V as E}from"./QueryEngine-BJMZSAnZ.js";import{I as M}from"./timeSupport-Cvj97qZO.js";async function Z(e,i,f){const a=I(f),{point:t,distance:r,returnEdge:p,vertexMode:o}=i;if(!p&&o==="none")return{candidates:[]};let n=S(i.query);n=await e.schedule(()=>q(n,e.definitionExpression,e.spatialReference),a),n=await e.reschedule(()=>Q(n,{availableFields:e.availableFields,fieldsIndex:e.fieldsIndex,geometryType:e.geometryType,spatialReference:e.spatialReference}),a);const m=!T(t.spatialReference,e.spatialReference);m&&await v(t.spatialReference,e.spatialReference);const u=typeof r=="number"?r:r.x,d=typeof r=="number"?r:r.y,y={xmin:t.x-u,xmax:t.x+u,ymin:t.y-d,ymax:t.y+d,spatialReference:t.spatialReference},s=m?g(y,e.spatialReference):y;if(!s)return{candidates:[]};const c=(await h(w(t),null,{signal:a}))[0],x=(await h(w(s),null,{signal:a}))[0];if(c==null||x==null)return{candidates:[]};const l=new j(await e.reschedule(()=>e.searchFeatures(E(x.toJSON())),a),n,e);await e.reschedule(()=>e.executeObjectIdsQuery(l),a),await e.reschedule(()=>e.executeTimeQuery(l),a),await e.reschedule(()=>e.executeAttributesQuery(l),a),await e.reschedule(()=>O(e,l,a),a);const R=c.toJSON(),b=m?g(R,e.spatialReference):R,F=m?Math.max(s.xmax-s.xmin,s.ymax-s.ymin)/2:r;return l.createSnappingResponse({...i,point:b,distance:F},t.spatialReference)}async function O(e,i,f){var o;const{query:a}=i,{spatialRel:t}=a;if(!((o=i==null?void 0:i.items)!=null&&o.length)||!a.geometry||!t)return;const r=await M(t,a.geometry,e.geometryType,e.hasZ,e.hasM),p=await e.runSpatialFilter(i.items,n=>r(n.geometry),f);i.items=p}export{Z as u};
