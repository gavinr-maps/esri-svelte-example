import{r as i}from"./tslib.es6-B3Jf3DVX.js";import{o as E}from"./Evented-BHRw9x22.js";import{m as n,a as y,i as v,O as f}from"./subclass-BZA_h8Db.js";import{initial as P,watch as b,sync as $,syncAndInitial as x,on as j}from"./reactiveUtils-C5zUhJQJ.js";import"./geometry-D964gYQX.js";import{b as _}from"./Accessor-BLX9ikPh.js";import{h as O}from"./UpdatingHandles-GfwcIh5z.js";import{N as R,K as G,I as A}from"./projection-B971H0Re.js";import{E as H}from"./EditGeometryOperations-Cl8Sbfxr.js";import{v as V}from"./Polyline-D9YkgmM_.js";import{j as D}from"./Point-Cg0-ChZE.js";import{p as S}from"./vec32-Dvg_eL9J.js";import{n as I}from"./vec3f64-BLpZdpfb.js";import{c as N}from"./projectPointToVector-GINIbYMz.js";import{E as T,j as z}from"./VideoElement-DlpZ7VDv.js";import"./asyncUtils-CWX51uTe.js";import"./Collection-CEdjem1-.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./Extent-Bf3YTe7m.js";import"./jsonMap-0cxwUWs2.js";import"./index-Bh2oEzTI.js";import"./projectBuffer-Bs7GwaPY.js";import"./mathUtils-C4_ghTv4.js";import"./geodesicConstants-DWQLYX7F.js";import"./compilerUtils-Dw3R0f-Z.js";import"./vec2-maR1OrZI.js";import"./common-DQOJ18NT.js";import"./vec2f64-miziP1SN.js";import"./vec42-YcqnINSP.js";import"./vec4f64-o2zAXfmz.js";import"./ViewingMode-Dodu7ZZk.js";import"./plane-IENfwZlB.js";import"./mat3f64-BBpwCtoL.js";import"./mat4f64-Dk4dwAN8.js";import"./quatf64-CCm9z-pX.js";import"./mathUtils-BG-eq9fO.js";import"./geometry2dUtils-DdyQE7AQ.js";import"./writer-DNAwXnhG.js";import"./cast-Bjksrh93.js";import"./assets-C43MgM-v.js";import"./imageUtils-CtmzXUTE.js";import"./uuid-fwrPAdZb.js";import"./resourceExtension-D8MnQ6oV.js";import"./persistableUrlUtils-fa1mAujs.js";import"./Identifiable-B1UbsKNt.js";import"./Loadable-BabW5Xcc.js";import"./Promise-B2Hu02L7.js";import"./MultiOriginJSONSupport-B5nfqtQh.js";import"./Clonable-D3rtuBWg.js";import"./perspectiveUtils-DUm6VYra.js";import"./normalizeUtilsSync-BUrHV6iS.js";import"./jsonUtils-CEfjT-BK.js";import"./normalizeUtilsCommon-dT81xWiM.js";import"./mat3-BRl2i9Bz.js";import"./screenUtils-_ZIvrt5o.js";let d=class extends _{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(t){super(t),this._updatingHandles=new O}initialize(){this.addHandles([v(this._updatingHandles),this._updatingHandles.add(()=>{const t=this.element.georeference;return(t==null?void 0:t.type)==="control-points"?t.controlPoints:null},t=>this._elementControlPointsChanged(t),P)])}_elementControlPointsChanged(t){if(this._updatedElementControlPoints===t)return;const e=t==null?void 0:t.map(({mapPoint:r})=>r).filter(f),o=this.view.spatialReference;this._updatingHandles.addPromise(this._whenProjected(e,o,r=>{if(!r)return void this._replaceOperations(null);const{_operations:s}=this,m=new V({rings:[r.map(({x:h,y:p})=>[h,p])],spatialReference:o});s!=null&&s.trySetGeometry(m)?this.onModifiedExternally():this._replaceOperations(H.fromGeometry(m,this.view.state.viewingMode))}))}_operationsGeometryChanged(){var h;const{element:{georeference:t},_operations:e}=this;if(!e||!t||t.type!=="control-points"||!t.controlPoints)return;const o=e.data.geometry,r=t.controlPoints.map(({mapPoint:p})=>p).filter(f);if(((h=o.rings[0])==null?void 0:h.length)!==r.length)return void this._updateElementControlPoints(null);const s=o.rings[0].map(([p,u])=>new D({x:p,y:u,spatialReference:o.spatialReference})),m=r.map(({spatialReference:p})=>p);this._updatingHandles.addPromise(this._whenProjected(s,m,p=>this._updateElementControlPoints(p)))}_updateElementControlPoints(t){var r;const{georeference:e}=this.element;if(!e||!t||e.type!=="control-points"||((r=e.controlPoints)==null?void 0:r.length)!==(t==null?void 0:t.length))return;t||(e.controlPoints=null);const o=e.controlPoints;if((o==null?void 0:o.length)===t.length)for(let s=0;s<o.length;s++)o[s].mapPoint=t[s]}async _whenProjected(t,e,o){if(!t)return void o(t);const{_operations:r,element:{georeference:s}}=this,m=t.map(({spatialReference:u})=>u),h=Array.isArray(e)?e:new Array(m.length).fill(e);await R(Array.from(m).map((u,g)=>({source:u,dest:h[g]})));const p=t.map((u,g)=>G(u,h[g]));r===this._operations&&s===this.element.georeference&&o(p)}_replaceOperations(t){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=t,t&&this.addHandles(t.data.on("change",()=>this._operationsGeometryChanged()),t)}};i([n({constructOnly:!0})],d.prototype,"view",void 0),i([n({constructOnly:!0})],d.prototype,"layer",void 0),i([n({constructOnly:!0})],d.prototype,"element",void 0),i([n({constructOnly:!0})],d.prototype,"onModifiedExternally",void 0),i([n()],d.prototype,"_operations",void 0),i([n()],d.prototype,"operations",null),i([n()],d.prototype,"updating",null),d=i([y("esri.views.3d.interactive.editingTools.media.MediaElementControllerControlPoints")],d);let c=class extends _{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(t){super(t),this._updatingHandles=new O}initialize(){this.addHandles([v(this._updatingHandles),this._updatingHandles.add(()=>{var t;return(t=this.element.georeference)==null?void 0:t.coords},t=>this._elementCoordinatesChanged(t),P)])}_elementCoordinatesChanged(t){this._updatedElementCoordinates!==t&&this._updatingHandles.addPromise(this._whenProjected(t,this.view.spatialReference,e=>{if(!e)return void this._replaceOperations(null);const{_operations:o}=this;o!=null&&o.trySetGeometry(e)?this.onModifiedExternally():this._replaceOperations(H.fromGeometry(e,this.view.state.viewingMode))}))}_operationsGeometryChanged(){const{element:{georeference:t},_operations:e}=this;if(!e||!t)return;const o=e.data.geometry;if(!t.coords)return void this._updateElementCoordinates(o);const r=t.coords.spatialReference;this._updatingHandles.addPromise(this._whenProjected(o,r,s=>this._updateElementCoordinates(s)))}_updateElementCoordinates(t){const{georeference:e}=this.element;e&&(e.coords=t,this._updatedElementCoordinates=e.coords)}async _whenProjected(t,e,o){if(!t)return void o(t);const{_operations:r,element:{georeference:s}}=this,m=await A(t,e);r===this._operations&&s===this.element.georeference&&o(m)}_replaceOperations(t){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=t,t&&this.addHandles(t.data.on("change",()=>this._operationsGeometryChanged()),t),this.onModifiedExternally()}};i([n({constructOnly:!0})],c.prototype,"view",void 0),i([n({constructOnly:!0})],c.prototype,"layer",void 0),i([n({constructOnly:!0})],c.prototype,"element",void 0),i([n({constructOnly:!0})],c.prototype,"onModifiedExternally",void 0),i([n()],c.prototype,"_operations",void 0),i([n()],c.prototype,"operations",null),i([n()],c.prototype,"updating",null),c=i([y("esri.views.3d.interactive.editingTools.media.MediaElementControllerShape")],c);function F(t,e,o){return M(t.allLayerViews.find(r=>r.layer===e),o)}function M(t,e){if(!t||t.type!=="media-3d"||t.suspended)return!1;const o=t.layer.source;return!!o&&(o instanceof T||o instanceof z?o===e:"hasElement"in o&&o.hasElement(e))}let a=class extends _{grabbableForEvent(){return!0}constructor(t){super(t),this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.grabbing=!1,this.dragging=!1,this.hovering=!0,this.selected=!1,this.cursor=null,this.consumesClicks=!0,this.events=new E.EventEmitter,this.addHandles(b(()=>this.selected,e=>this.events.emit("select-changed",{action:e?"select":"deselect"}),$))}destroy(){this._set("view",null)}intersectionDistance(t){const{view:e,layer:o,element:r}=this;if(!F(e,o,r))return null;const s=e.toMap(t,{include:{layer:o,element:r}});return s&&N(s,w,e.renderSpatialReference)?S(w,e.state.camera.eye):null}onElevationChange(){}onViewChange(){}};i([n({constructOnly:!0,nonNullable:!0})],a.prototype,"element",void 0),i([n({constructOnly:!0,nonNullable:!0})],a.prototype,"layer",void 0),i([n({constructOnly:!0,nonNullable:!0})],a.prototype,"view",void 0),i([n()],a.prototype,"interactive",void 0),i([n()],a.prototype,"selectable",void 0),i([n()],a.prototype,"grabbable",void 0),i([n()],a.prototype,"grabbing",void 0),i([n()],a.prototype,"dragging",void 0),i([n()],a.prototype,"hovering",void 0),i([n()],a.prototype,"selected",void 0),i([n()],a.prototype,"cursor",void 0),a=i([y("esri.views.3d.interactive.editingTools.media.MediaElementManipulator3D")],a);const w=I(),C=Symbol();let l=class extends E.EventedAccessor{get operations(){var t;return(t=this._controller)==null?void 0:t.operations}get elevationInfo(){return{mode:"on-the-ground",offset:0}}get _layerView(){const t=this.view.allLayerViews.find(e=>e.layer===this.layer);return(t==null?void 0:t.type)==="media-3d"?t:null}get visible(){return M(this._layerView,this.element)}get isDraped(){return!0}get origin(){return null}get updating(){var t;return!!((t=this._controller)!=null&&t.updating)}get _controllerClass(){var t;return this.tool==="transform"||((t=this.element.georeference)==null?void 0:t.type)!=="control-points"?c:d}constructor(t){super(t),this.tool="transform"}initialize(){this.addHandles([b(()=>this._controllerClass,t=>this._updateController(t),x),j(()=>this._layerView,"element-render-changed",({element:t})=>{this.element===t&&this.emit("committed")})])}toMap(t){const{layer:e,element:o}=this;return this.view.toMap(t,{include:{layer:e,element:o}})}createManipulator(t){const{view:e,layer:o,element:r}=this;return new a({view:e,layer:o,element:r,...t})}_updateController(t){if(this._controller&&this._controller instanceof t)return;this.removeHandles(C);const{view:e,layer:o,element:r}=this,s=()=>{this.emit("modified-externally")};this._controller=new t({view:e,layer:o,element:r,onModifiedExternally:s}),s(),this.addHandles(v(this._controller),C)}};i([n({constructOnly:!0})],l.prototype,"view",void 0),i([n({constructOnly:!0})],l.prototype,"layer",void 0),i([n({constructOnly:!0})],l.prototype,"element",void 0),i([n()],l.prototype,"tool",void 0),i([n()],l.prototype,"_controller",void 0),i([n()],l.prototype,"elevationInfo",null),i([n()],l.prototype,"_layerView",null),i([n()],l.prototype,"visible",null),i([n()],l.prototype,"updating",null),i([n()],l.prototype,"_controllerClass",null),l=i([y("esri.views.3d.interactive.editingTools.ManipulatedObject3DMediaElement")],l);export{l as ManipulatedObject3DMediaElement};
