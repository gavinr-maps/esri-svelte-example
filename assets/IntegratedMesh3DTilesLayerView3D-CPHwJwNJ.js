import{M as fe,s as J,N as ge,f as Se,B as be,r as I,m as L,a as Fe}from"./Accessor-BHnuXKD2.js";import{d as ye,P as He}from"./reactiveUtils-BR0C1Kq4.js";import{n as Ve,s as Le}from"./mat3-CR8GKnhD.js";import{e as _e,o as X}from"./mat3f64-BBpwCtoL.js";import{i as Be,I as De}from"./mat4-Fi6iAz29.js";import{e as we}from"./mat4f64-Dk4dwAN8.js";import{n as je}from"./quatf64-CCm9z-pX.js";import{u as ke,N as Ne}from"./vec32-Dvg_eL9J.js";import{u as Ge,n as K}from"./vec3f64-BLpZdpfb.js";import{r as $e}from"./vec4f64-o2zAXfmz.js";import{d as ze}from"./Point-XGrwlf63.js";import{m as We}from"./computeTranslationToOriginAndRotation-BT43Xu5d.js";import{x as qe,n as Je,t as Xe,i as Ke}from"./Transform-Do4F9st0.js";import{n as Ye}from"./projectVectorToVector-dS8io47t.js";import{c as Qe,x as Ze,L as et,i as Y,O as tt,E as rt,u as it,k as ot,B as ve,g as xe}from"./BufferView-_QDXRCew.js";import{o as E,i as Q,l as B,r as O,t as f,m as st,d as at,S as Te,e as C,g as Z,a as R}from"./ILyr3DWasmPerSceneView-QwgNPJGT.js";import{R as Ce}from"./elevationInfoUtils-RSZ4Logn.js";import{l as nt}from"./ViewingMode-Dodu7ZZk.js";import{t as mt}from"./LineCallout.glsl-BFpkOc4i.js";import{t as lt}from"./GridLocalOriginFactory-BvhZ_UoU.js";import{l as pt}from"./LayerView3D-dAX18iJt.js";import{n as ct,s as Me,r as dt}from"./DefaultUI-DqLHkAzt.js";import{i as N,e as U,u as ee}from"./basicInterfaces-CZwQPxTp.js";import{E as Pe,D as T}from"./enums-D9v74xTE.js";import{b as ht}from"./Graphic-CFXUQZlS.js";import{l as ut}from"./intersectorUtilsConversions-CZnn6t-z.js";import{R as ft}from"./Intersector-DqUGp7Vs.js";import{i as gt,e as bt}from"./intersectorUtils-l6zkk4nF.js";import{h as yt,F as _t}from"./DefaultBufferWriter-D4XUxbP-.js";import{e as wt}from"./ElevationRange-BrgM1moX.js";import{I as vt,J as xt}from"./orientedBoundingBox-9z4w3ZAL.js";import{s as Tt,a as Ct,k as Mt,b as Pt}from"./ShadowCastAccumulate.glsl-7ziGQBCy.js";import{s as Et}from"./RenderTexture-ubDviEW5.js";import{q as Ee,r as Ot,N as Ut}from"./FloatArray-BCfeX8wo.js";import{t as D}from"./Attribute-B-NAci_J.js";import{c as At}from"./Normals-OOhKYumi.js";import{e as j}from"./VertexAttribute-Cq4MnHjR.js";import{y as It}from"./LayerView-DF8EqCYi.js";import{r as Rt}from"./layerViewUtils-tkZ5z_iY.js";import"./Evented-DCWccWGU.js";import"./SimpleObservable-7oieNGD8.js";import"./common-DQOJ18NT.js";import"./cast-BA_-jlhc.js";import"./index-tefRSezt.js";import"./JSONSupport-CGdeqxpk.js";import"./writer-B2bQV2uU.js";import"./mathUtils-DV9iOXpW.js";import"./projectBuffer-DOU0xvVi.js";import"./geodesicConstants-yASAK_zX.js";import"./Polyline-BmuD2-ZN.js";import"./Extent-CBBGeHb-.js";import"./sphere-DQxj5tsv.js";import"./vec42-YcqnINSP.js";import"./plane-4dpuo6-e.js";import"./vec2f64-Dy6m9Nrb.js";import"./mathUtils-B9R7G-2c.js";import"./projectPointToVector-BS0u8fq6.js";import"./projection-B2I9Bzj_.js";import"./vec2-maR1OrZI.js";import"./unitConversionUtils-C4AR5obr.js";import"./lengthUtils-DjJgJFRg.js";import"./Color-gncXBiLc.js";import"./colorUtils-Rxh2V3ai.js";import"./visualVariableUtils-Bp9QCb8E.js";import"./screenUtils-_ZIvrt5o.js";import"./ElevationContext-jcnAn7VT.js";import"./dehydratedFeatureUtils-1rrRm6hF.js";import"./ElevationProvider-aS5xrHHy.js";import"./hydratedFeatures-BVVSs98j.js";import"./jsonUtils-Cu7OBRmN.js";import"./opacityUtils-CSd4XoR2.js";import"./Promise-CmQqe-ke.js";import"./Material-Ba8x5bbY.js";import"./boundedPlane-Dyz2ub5d.js";import"./lineSegment-C-CDF7QX.js";import"./NoParameters-t-PuNrgq.js";import"./Indices-Db9lERgy.js";import"./triangle-D_E6eTS3.js";import"./graphicUtils-Daa6cjYT.js";import"./aaBoundingBox-CeBivBRq.js";import"./meshVertexSpaceUtils-SW0WEjNN.js";import"./MeshLocalVertexSpace-C0YDTRex.js";import"./Clonable-DvJsj5LF.js";import"./enumeration-Cr5WIZs4.js";import"./RibbonLine.glsl-D3IEIaDR.js";import"./InterleavedLayout-Dvj-Snan.js";import"./types-D0PSWh4d.js";import"./sdfPrimitives-B8Jbwvqs.js";import"./doublePrecisionUtils-B0owpBza.js";import"./floatRGBA-CR2j2c7-.js";import"./Octree-B-jwmuW2.js";import"./Matrix3PassUniform-Bhi2fM3C.js";import"./BindType-BBwFZqyN.js";import"./renderState-e7QeQoUO.js";import"./glsl-BH37Aalp.js";import"./Texture-D-SqNa4i.js";import"./signal-DSa0yokC.js";import"./getDataTypeBytes-BTGR5GyG.js";import"./ShaderTechniqueConfiguration-YrUOztAU.js";import"./ShaderBuilder-DV1s2efh.js";import"./RgbaFloatEncoding.glsl-_io2eW3M.js";import"./vec2f32-BbH2jxlN.js";import"./memoryEstimations-5gFNwkKK.js";import"./projectBoundingRect-BA_jRNoI.js";import"./dehydratedFeatures-Nwhn-hep.js";import"./quantizationUtils-2Az-xHPA.js";import"./typeUtils-BSg8Y507.js";import"./Field-Cyk7Ur5d.js";import"./fieldType-L-VlbZqy.js";import"./featureConversionUtils-DpmsPUmt.js";import"./OptimizedFeature-DcMLlxvB.js";import"./OptimizedGeometry-7IxBWtHr.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./edgeUtils-52Urp6s4.js";import"./NormalAttribute.glsl-BPQl43kJ.js";import"./Float4DrawUniform-C_Hqa-pI.js";import"./Matrix3DrawUniform-B_gSHO7v.js";import"./webStyleAcceptedFormats-CG7ZQ6BV.js";import"./GeometryUtil-vHI0hYMT.js";import"./vec3f32-nZdmKIgz.js";import"./RealisticTree.glsl-BIYA2y1x.js";import"./Intersector-DPK4WnQE.js";import"./DefaultMaterial-B5sYRDQR.js";import"./SceneLighting-fZH2UQ_L.js";import"./GLTextureMaterial-BXvkeRxQ.js";import"./verticalOffsetUtils-CUH6QZ7-.js";import"./VertexColor.glsl-C67vI27I.js";import"./Matrix4PassUniform-LFIUaE9i.js";import"./VerticalOffset.glsl-0YVQE7vQ.js";import"./Matrix4sPassUniform--uPzDbTP.js";import"./Float2PassUniform-Blij1ug3.js";import"./BooleanBindUniform-xvVHJCDz.js";import"./CameraSpace.glsl-BZ4Eapt3.js";import"./Scheduler-B_GuBefw.js";import"./debugFlags-ZrDyTcDc.js";import"./HUDRenderStyle-BhGvVxgm.js";import"./HUDVisibility.glsl-DSeZY4v-.js";import"./heightModelInfoUtils-CMg1cdju.js";import"./HeightModelInfo-B3GZyQFz.js";import"./jsxFactory-CLjKarlq.js";import"./intl-Do3GEEJ7.js";import"./uuid-Cl5lrJ4c.js";import"./UpdatingHandles-ptqz1ck8.js";import"./InputManager-Bs9UE-jw.js";import"./Queue-BOnccek2.js";import"./Basemap-BHdJ6wQH.js";import"./collectionUtils-CbaToa73.js";import"./Portal-CTRRujjZ.js";import"./loadAll-Do8S8AWH.js";import"./PortalItem-CXk7DqVv.js";import"./basemapDefinitions-BmB40s1J.js";import"./writeUtils-C3ZSK02Z.js";import"./layerUtils-dJgsXxkC.js";import"./groundInstanceUtils-Ben03ZCf.js";import"./CollectionFlattener-B9CFCLSp.js";import"./editableLayers-BZGjz8nI.js";import"./catalogUtils-CK4eMvD1.js";import"./basemapEnsureType-BVU7UGJp.js";import"./basemapUtils-DQr5T1wn.js";import"./utils-DYurMneM.js";import"./mat4f32-DcsiF_Rp.js";import"./TablesMixin-BzMj7HDl.js";import"./Layer-C9uQlTBT.js";import"./Identifiable-BrT7zvUW.js";import"./TimeExtent-J5qnUFx_.js";import"./timeUtils-D2X862bk.js";import"./GraphicsCollection-CkliHSk1.js";import"./timeZoneUtils-COos5xIr.js";import"./ReactiveMap-Dwhwbx9R.js";import"./Query-DCBIeen2.js";import"./FullTextSearch-BWm_kPUE.js";import"./selectionUtils-DYi6daQO.js";import"./ViewEvents-Hl5AOQnu.js";import"./IViewEvents-Bci6PjlS.js";import"./interfaces-D6pIddIh.js";import"./screenUtils-DyhV4TAA.js";import"./HighlightDefaults-ESbuT2uR.js";import"./a11yUtils-CSYUX1kC.js";import"./unitBezier-B1N-tmtC.js";import"./imageUtils-brik-GLm.js";import"./capabilities-DwlKKScG.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-CZa70j6i.js";import"./accessibleHandler-rIBXQ52V.js";import"./CompassViewModel-BAJa4WdS.js";import"./GoTo-BsXOAO95.js";import"./ZoomViewModel-BZXEbLSs.js";import"./ActionToggle-__-l4AdQ.js";import"./TextSymbol-BQ_NW9Xo.js";import"./quat-4pa1e6ds.js";import"./spatialReferenceEllipsoidUtils-DM073JUd.js";import"./Camera-DJtV7zYb.js";import"./Cyclical-CPiNl4ru.js";import"./Viewpoint-Cv8Otrne.js";import"./workers-D8Q3pEzK.js";import"./RenderCoordsHelper-BbefYyBA.js";import"./projectVectorToPoint-d6Mr4zvQ.js";import"./scaleUtils-CfLu-sg1.js";import"./NormalUtils.glsl-CV524hT5.js";import"./earcut-Lltz9D9k.js";import"./vec3-Bn81gjoR.js";import"./SnappingCandidate-O5eRSE6e.js";import"./triangulationUtils-ChyeOnqC.js";import"./deduplicate-8uOXlcvp.js";import"./OverlayCompositing.glsl-BbJKjUZQ.js";import"./RenderCamera-BovI3JTe.js";import"./axisAngleDegrees-8Sw4vC28.js";import"./weather-DtiKeY2t.js";import"./RenderPlugin-B2sz29jJ.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./VertexArrayObject-DcVjXzZo.js";import"./BufferObject-CIl3vJtA.js";import"./NestedMap-GuqgquCN.js";import"./fontUtils-D0SfAiSy.js";import"./cameraUtils-D51h-KGF.js";import"./earthUtils-5Ip67eD0.js";import"./spatialReferenceSupport-CJqi4Nvp.js";import"./ElevationSamplerData-ejt2NMnl.js";import"./terrainUtils-NB9gChf5.js";import"./TileInfo-CRfZy5zq.js";import"./TileKey-DZd6gJy7.js";import"./FramebufferObject-DHwDHMWe.js";import"./glUtil-D0YUa0ow.js";import"./ShadowCastVisualizeTechniqueConfiguration-WdqoNZsk.js";import"./SunCalc-uwgdo0BB.js";import"./VirtualLighting-CTSkZQzH.js";import"./ray-D3Okb4cY.js";import"./RenderFeature-3I21ZjJq.js";import"./unitFormatUtils-Dbksq3U5.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./quantityUtils-1LswOhxZ.js";import"./ZoomMomentumEstimator-Igei2Npb.js";import"./HUDMaterial-DRUv4rua.js";import"./labelFormatUtils-B--9rEVY.js";import"./labelUtils-Dq8OkaT-.js";import"./DepthRange-C25RnOB3.js";import"./hitTest-CblPROa1.js";import"./LayerConstants-B33OP6sh.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./MemCache-CDoaVBHf.js";import"./DefaultLoadingContext-b8vwa5ZD.js";import"./wosrLoader-F8PxTYxV.js";import"./Version-9k2AOv05.js";import"./requestImageUtils-Brn0e8z8.js";import"./DrawParameters-C0gywgJQ.js";import"./TileStrategy-DlGVvP4C.js";import"./TileKey-BtGhNUzq.js";import"./ScheduledQueueProcessor-DfrR8pp0.js";import"./RenderableTile-Ewnw5ULl.js";import"./config-MDUrh2eL.js";import"./StyleDefinition-DxJzQnGW.js";import"./enums-BJSSbDkD.js";import"./enums-BRzLM11V.js";import"./GeometryUtils-B5FJlfZD.js";import"./DefaultVertexAttributeLayouts-DMsCtEEh.js";import"./DisplayObject-S19ALweP.js";import"./resources-CcZcI9oR.js";import"./WorkerHandle-B2QLNs3X.js";import"./colorUtils-BAowQmkN.js";import"./vec33-KumQEj7U.js";import"./ShaderTechniqueRepository-CuJwDr2t.js";import"./Blit-D5AxBSxC.js";import"./testSVGPremultipliedAlpha-CpxLiQJP.js";import"./RenderingContext-BkhmhK8E.js";import"./ProgramCache-D9MJNX7j.js";import"./Program-DD6La1z3.js";import"./makeScheduleFunction-CggzEh3c.js";import"./TextureFormat-1mYWTFa-.js";class St extends mt{constructor(e,p,o,d,a,s,c){super(e,0,0,0,p),this.nodesCached=o,this.vboMB=d,this.textureMB=a,this.vboMBCached=s,this.textureMBCached=c}}const Ft={[E.Points]:null,[E.Lines]:null,[E.LineStrip]:null,[E.Triangles]:Pe.TRIANGLES,[E.TriangleStrip]:Pe.TRIANGLE_STRIP,[E.NotSet]:null},Oe={[Q.Opaque]:N.Opaque,[Q.Mask]:N.Mask,[Q.Blend]:N.Blend},Ht={[B.Back]:U.Back,[B.Front]:U.Front,[B.None]:U.None,[B.NotSet]:U.Back},Vt={[O.WrapYBit]:{s:T.CLAMP_TO_EDGE,t:T.REPEAT},[O.WrapXBit]:{s:T.REPEAT,t:T.CLAMP_TO_EDGE},[O.WrapXy]:{s:T.REPEAT,t:T.REPEAT},[O.None]:{s:T.CLAMP_TO_EDGE,t:T.CLAMP_TO_EDGE},[O.NotSet]:{s:T.CLAMP_TO_EDGE,t:T.CLAMP_TO_EDGE}},Lt={[f.U8]:1,[f.I8]:1,[f.U16]:2,[f.I16]:2,[f.U32]:4,[f.I32]:4,[f.F32]:4,[f.F64]:8,[f.Utf8String]:1,[f.NotSet]:1};class Bt{constructor(e){this.layerUid=[],this.type=gt.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,p,o,d,a,s){const c=e.results,v=e.options.store===bt.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const y=this.layerView.view._stage.renderView.componentObjectCollection,u=new yt(s??!1,e.options.normalRequired);this.layerView.objects.forEach(n=>{n.visible&&n.intersectionGeometry&&y.intersect(n,o,d,e.tolerance,null,u,(m,r,l,g)=>{if(r>=0){if(p!=null&&!p(o,d,r))return;const h=w=>{const _=new ut(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));w.set(this.type,_,r,l)};if(this.isGround&&(c.ground.dist==null||r<c.ground.dist)&&h(c.ground),e.options.isFiltered)return;if((c.min.dist==null||r<c.min.dist)&&h(c.min),(c.max.dist==null||r>c.max.dist)&&h(c.max),v){const w=ft(e.ray);h(w),e.results.all.push(w)}}})})}_createTiles3DGraphic(e,p){return new ht({layer:e,sourceLayer:e,attributes:p})}}var b;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(b||(b={}));class Dt{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}get usedMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}get cachedMemory(){return this.usedMemory}}function k(t){return Math.round(t/1048.576)/1e3}let P=class extends pt(It){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=lt.WithoutRasterImage,this._applySSAO=!fe("disable-feature:im-ssao"),this._shadeNormals=!!fe("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(b.Error),this._dbg(b.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new J("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=ct(this).then(e=>{this._intersectionHandler=new Bt(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,o=>this._slicePlaneEnabledChange(o)),this._elevationProvider=new qe({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const p=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,o=>this._onRemoveFromCache(o));this._memCache=p,this.addHandles([ye(()=>this.layer.elevationInfo,o=>this._elevationInfoChanged(o))]),this._suspendedHandle=ye(()=>this.suspended,o=>{var d;return(d=this._wasm)==null?void 0:d.setEnabled(this,!o)},He)}).catch(e=>{if(Me(this),this._wasmLayerId=-1,e===st)throw new J("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===at)throw new J("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(b.VerboseAPI,"Tiles3DLayerView3D destroy() called"),Me(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=ge(this._memCache),this._updatingHandles=ge(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??(this._visibleGeometryChangedSchedulerHandle=Se(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const p=this._collection.getMaterial(e);p.commonMaterialParameters.hasSlicePlane=t,p.commonMaterialParameters.cullFace=t?U.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){var e;(e=this._wasm)==null||e.setLayerOffset(this,Ce(t))}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get _wasm(){return dt(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.usedMemory)}),t}get unloadedMemory(){return 0}get cachedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.usedMemory)}),t}get visibleAtCurrentScale(){return Rt(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let t=0,e=0,p=0,o=0,d=0,a=0;return this._lyrHandleToObjects.forEach(s=>{s.isVisible?(t+=s.texMemoryUsage,e+=s.vboMemoryUsage,d++):(p+=s.texMemoryUsage,o+=s.vboMemoryUsage,a++)}),new St(this.usedMemory,d,a,k(e),k(t),k(o),k(p))}_canProjectWithoutEngine(){var t,e;if(this.view.state.viewingMode===nt.Local){const p=(t=this.view.renderSpatialReference)!=null&&t.isWebMercator?3857:((e=this.view.renderSpatialReference)==null?void 0:e.wkid)??-1;if(p!==3857&&p!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return Ce(this.layer.elevationInfo)}get elevationRange(){const t=this.fullExtent;return t!=null&&t.zmin&&(t!=null&&t.zmax)?new wt(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=this._wasm;return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){var r;const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const p=Ge(e.desc.origin),o=new Array,d=new Map,a=new Dt;a.handle=t.handle,this._lyrHandleToObjects.set(t.handle,a);const s=this.view.basemapTerrain.spatialReference;let c,v;if(this.view.viewingMode==="global"){const l=we();We(ze,p,l,s),c=Ve(_e(),l),v=Le(_e(),c)}else c=X,v=X;const y=we();Be(y,y,p);const u=De(K(),y);let n=null;const m=K();if(e.desc.obb){const l=e.desc.obb.quaternion;n=new vt(e.desc.obb.center,e.desc.obb.halfSize,je(l[0],l[1],l[2],l[3]))}for(let l=0;l<e.desc.prims.length;l++){const g=e.desc.prims[l];if(this._dbg(b.VerboseAPI,JSON.stringify(g)),Ft[g.ptype]==null||e.data==null){this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+g.ptype+"). Skipping primitive.");continue}const h=(r=e.desc)!=null&&r.materials&&g.materialId!=null?e.desc.materials[g.materialId]:null,w=h!=null?h.lightingModel:Te.Unlit,{positionView:_,positionAttr:M,normalsView:Ue,normalsAttr:G,colorAttr:S,texCoord0Attr:F,indicesView:A}=this.getBufferViews(g,e.data.buffer,c);if(M==null||_==null||A==null)continue;const te=new Tt(S!=null,F!=null?Ee.Default:Ee.None,Ue!=null,this._shadeNormals,this._applySSAO),Ae=M.data.length/M.size,$=(i,x)=>!i||i.data.length/i.size===Ae||(this._dbg(b.Error,`${x} !== numPos. Skipping primitive.`),!1);if(!$(F,"numTexcoord")||!$(S,"numColors")||!$(G,"normals"))continue;const re=Ct(te);if(n!=null?n=n.clone():(n=xt(M),ke(m,n.center,p),n.center=m),c!==X)for(let i=0;i<_.count;i++)_.getVec(i,m),Ne(m,m,c),_.setVec(i,m);const z=re.createBuffer(M.data.length),H=new Map([[j.POSITION,M]]);F!=null&&H.set(j.UV0,F),S!=null&&H.set(j.COLOR,S),G!=null&&H.set(j.NORMALCOMPRESSED,G),H.forEach((i,x)=>{i!=null&&_t(x,i,null,null,z,0)});const Ie=new Uint32Array([0,A.typedBuffer.length]),Re={vertices:{data:z.buffer,count:z.byteLength/re.stride,layoutParameters:te},positionData:{positions:_.typedBuffer,indices:A.typedBuffer},indices:A.typedBuffer,componentOffsets:Ie};a.cpuMemoryUsage+=_.count,a.cpuMemoryUsage+=A.count;const ie=this.view.renderSpatialReference,W=K(),q=[1,1,1];Je(u,ie,q,s)||this._dbg(b.Error,"Unsupported coordinate system for IM overlay"),Ye(u,ie,W,s);const V=this._collection.createObject(new Xe($e(W[0],W[1],q[0],q[1]),new Ke(u,v),n,Re));h&&this._collection.updateMaterial(V,i=>{i.baseColor=h.baseColorFactor,i.usePBR=w===Te.Pbr,i.hasParametersFromSource=!1,i.baseColorTexture=this._getTexture(h.baseColorTex,e,d),i.usePBR&&(i.mrrFactors=[h.metallicFactor,h.roughnessFactor,0],i.emissiveFactor=h.emissiveFactor??[0,0,0],i.metallicRoughnessTexture=this._getTexture(h.metalTex,e,d),i.emissionTexture=this._getTexture(h.emissiveTex,e,d),i.occlusionTexture=this._getTexture(h.occlusionTex,e,d),i.normalTexture=this._getTexture(h.normalTex,e,d)),i.objectOpacity=0,i.alphaDiscardMode=N.Mask;const x=[];i.baseColorTexture&&x.push(i.baseColorTexture.loadPromise),i.usePBR&&i.metallicRoughnessTexture&&x.push(i.metallicRoughnessTexture.loadPromise),i.usePBR&&i.emissionTexture&&x.push(i.emissionTexture.loadPromise),i.usePBR&&i.occlusionTexture&&x.push(i.occlusionTexture.loadPromise),i.usePBR&&i.normalTexture&&x.push(i.normalTexture.loadPromise);const oe=Promise.all(x);o.push(oe),oe.then(()=>{var se,ae,ne,me,le,pe,ce,de,he,ue;i.alphaDiscardMode=Oe[h.alphaMode],i.objectOpacity=1,a.texMemoryUsage+=((ae=(se=i.baseColorTexture)==null?void 0:se.glTexture)==null?void 0:ae.usedMemory)||0,i.usePBR&&(a.texMemoryUsage+=((me=(ne=i.metallicRoughnessTexture)==null?void 0:ne.glTexture)==null?void 0:me.usedMemory)||0,a.texMemoryUsage+=((pe=(le=i.emissionTexture)==null?void 0:le.glTexture)==null?void 0:pe.usedMemory)||0,a.texMemoryUsage+=((de=(ce=i.occlusionTexture)==null?void 0:ce.glTexture)==null?void 0:de.usedMemory)||0,a.texMemoryUsage+=((ue=(he=i.normalTexture)==null?void 0:he.glTexture)==null?void 0:ue.usedMemory)||0)}),i.commonMaterialParameters.doubleSided=h.isDoubleSided,i.commonMaterialParameters.cullFace=h.faceCulling?Ht[h.faceCulling]:U.Back,this._initialCullFace.set(V,i.commonMaterialParameters.cullFace),i.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,i.componentParameters.castShadows=Mt.All,i.textureAlphaCutoff=h.alphaCutoff??Ot,i.alphaDiscardMode=Oe[h.alphaMode],i.isIntegratedMesh=!0,i.polygonOffsetEnabled=!1,i.hasOccludees=!1,i.ellipsoidMode=Pt(this.view.spatialReference)}),a.components.push(V),a.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(V)}if(await Promise.all(o),d.forEach(l=>{a.textures.push(l)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${a.handle}`,a),{memUsageBytes:a.usedMemory}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(p=>{this._stage.remove(p)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,p){if(this._memCache){for(let o=0;o<p;++o){const d=t[o],a=e[o];if(!a)continue;const s=this._lyrHandleToObjects.get(d);s&&(this._visibleGeometryChanged(),s.isVisible=a,s.components.forEach(c=>{this._collection.setObjectVisibility(c,a),this._elevationProvider.objectChanged(this._collection.getComponentObb(c))}),this._memCache.pop(`${d}`))}for(let o=0;o<p;++o){const d=t[o],a=e[o];if(a)continue;const s=this._lyrHandleToObjects.get(d);s&&(this._visibleGeometryChanged(),s.isVisible=a,s.components.forEach(c=>{this._collection.setObjectVisibility(c,a),this._elevationProvider.objectChanged(this._collection.getComponentObb(c))}),this._memCache.put(`${d}`,s))}}}_getTexture(t,e,p){var d,a;let o=null;if(t&&((d=e.desc)!=null&&d.images)&&((a=e.data)!=null&&a.buffer)){const s=e.desc.images[t==null?void 0:t.imageId];if(o=p.get(s),!o&&s){const c=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,v=!!s.mipCount||c>1,y=Vt[t.wrapMode??O.None];let u=s.alpha?4:3;const n=new Uint8Array(e.data.buffer,s.data.byteOffset,s.data.byteCount);let m=null,r=null,l=null;switch(s.format){case C.Raw:s.pixelFormat===Z.R8?(m=n,u=1,r=""):s.pixelFormat===Z.Rgb8?(m=n,u=3,r=""):s.pixelFormat===Z.Rgba8&&(m=n,u=4,r="");break;case C.Dxt1:m=n,u=3,r=ee.DDS_ENCODING;break;case C.Dxt5:m=n,u=4,r=ee.DDS_ENCODING;break;case C.Basis:m=n,u=3,r=ee.KTX2_ENCODING;break;case C.Png:r="image/png",l=document.createElement("img");break;case C.Jpeg:r="image/jpeg",l=document.createElement("img");break;case C.Etc2:r="image/ktx",l=document.createElement("img");break;case C.Astc:this._dbg(b.Error,"Astc texture not supported");break;case C.Pvrtc:this._dbg(b.Error,"Pvrtc texture not supported")}if(l&&r){const g=new Blob([n],{type:r});l.src=URL.createObjectURL(g),m=l}m&&r!=null&&(o=new Ut(m,{mipmap:v,maxAnisotropy:c,encoding:r,wrap:y,components:u,noUnpackFlip:!0,width:s.mip0Width,height:s.mip0Height}),this._stage.add(o),p.set(s,o))}}return o?new Et(this.view._stage.renderView.textures,o.id):null}getBufferViews(t,e,p){let o,d,a,s,c,v,y,u=null;for(let n=0;n<t.atrbs.length;n++){const m=t.atrbs[n],r=m.view,l=void 0,g=r.byteOffset+r.byteCount,h=r.byteCount/Lt[r.type],w=[...Array(h).keys()].map(_=>_);try{switch(m.sem){case R.Position:r.ncomp!==3||r.type!==f.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Position ("+r+")"):(o=new Y(e,r.byteOffset,l,g),d=new D(o.typedBuffer,w,3));break;case R.Normal:if(r.ncomp!==3||r.type!==f.F32)this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Normal ("+r+")");else{const _=new Y(e,r.byteOffset,l,g),M=At(_.typedBuffer,p);c=new ot(M),v=new D(c.typedBuffer,w,2)}break;case R.TexCoord:r.ncomp!==2||r.type!==f.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+r+")"):s===void 0&&(s=new D(new it(e,r.byteOffset,l,g).typedBuffer,w,2));break;case R.Color:r.ncomp===4?(r.type===f.F32&&(u=new Qe(e,r.byteOffset,l,g)),r.type===f.U8&&(u=new Ze(e,r.byteOffset,l,g)),r.type===f.U16&&(u=new et(e,r.byteOffset,l,g))):r.ncomp===3&&(r.type===f.F32&&(u=new Y(e,r.byteOffset,l,g)),r.type===f.U8&&(u=new tt(e,r.byteOffset,l,g)),r.type===f.U16&&(u=new rt(e,r.byteOffset,l,g))),u==null?this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+r+")"):a=new D(u.typedBuffer,w,r.ncomp);break;case R.FeatureIndex:break;default:this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+m.sem+"). Skipping vertex attribute.")}}catch(_){this._dbg(b.VerboseAPI,"Error Creating buffer ("+_+"). Skipping vertex attribute.")}}if(t.index){const n=t.index.view,m=void 0,r=n.byteOffset+n.byteCount;switch(t.index.view.type){case f.U16:y=new xe(e,n.byteOffset,m,r);break;case f.U32:y=new ve(e,n.byteOffset,m,r);break;case f.U8:default:this._dbg(b.Error,"[Unsupported Feature] index type not supported ("+n.type+").")}}if(y==null&&o!=null){const n=o.count;if(n<65535){const m=new Uint16Array(n);y=new xe(m)}else{const m=new Uint32Array(n);y=new ve(m)}for(let m=0;m<n;m++)y.set(m,m)}return{positionView:o,positionAttr:d,colorAttr:a,texCoord0Attr:s,indicesView:y,normalsView:c,normalsAttr:v}}_onRemoveFromCache(t){var e;(e=this._wasm)==null||e.onRenderableEvicted(this,t.handle,t.usedMemory),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===b.Error?be.getLogger(this).error(e):be.getLogger(this).warn(e))}};I([L()],P.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),I([L()],P.prototype,"layer",void 0),I([L({readOnly:!0})],P.prototype,"visibleAtCurrentScale",null),I([L()],P.prototype,"elevationOffset",null),P=I([Fe("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],P);const Da=P;export{Da as default};
