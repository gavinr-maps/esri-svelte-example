import{T as p,a7 as T,au as d,ap as v,av as S}from"./index-e8c6bcc0.js";import{t as b,r as F}from"./fetchService-c852bf28.js";import{e as G}from"./jsonContext-cb79343f.js";import{s as $}from"./portalItemUtils-9c4b4c29.js";import{t as D}from"./styleUtils-1146cb85.js";async function H(e,r){const t=e.instance.portalItem;if(t&&t.id)return await t.load(r),M(e),O(e,r)}function M(e){const r=e.instance.portalItem;if(!(r!=null&&r.type)||!e.supportedTypes.includes(r.type))throw new p("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:r==null?void 0:r.type,expectedType:e.supportedTypes.join(", ")})}async function O(e,r){const t=e.instance,a=t.portalItem;if(!a)return;const{url:n,title:l}=a,s=G(a);if(t.type==="group")return t.read({title:l},s),x(t,e);n&&t.read({url:n},s);const o=await g(e,r);return o&&t.read(o,s),t.resourceReferences={portalItem:a,paths:s.readResourcePaths??[]},t.type!=="subtype-group"&&t.read({title:l},s),D(t,s)}async function x(e,r){let t;const{portalItem:a}=e;if(!a)return;const n=a.type,l=r.layerModuleTypeMap,s=$(a,"Oriented Imagery Layer")??!1;switch(n){case"Feature Service":t=s?l.OrientedImageryLayer:l.FeatureLayer;break;case"Stream Service":t=l.StreamLayer;break;case"Scene Service":t=l.SceneLayer;break;case"Feature Collection":t=l.FeatureLayer;break;default:throw new p("portal:unsupported-item-type-as-group",`The item type '${n}' is not supported as a 'IGroupLayer'`)}let[o,i]=await Promise.all([t(),g(r)]),u=()=>o;if(n==="Feature Service"){if(i=a.url?await j(i,a.url):{},h(i).length){const w=l.SubtypeGroupLayer,I=await w();u=L=>L.layerType==="SubtypeGroupLayer"?I:o}return c(e,u,i,await R(a.url))}return y(i)>0?c(e,u,i):P(e,u)}async function P(e,r){var n,l;const{portalItem:t}=e;if(!(t!=null&&t.url))return;const a=await b(t.url);a&&c(e,r,{layers:(n=a.layers)==null?void 0:n.map(f),tables:(l=a.tables)==null?void 0:l.map(f)})}function f(e){return{id:e.id,name:e.name}}function c(e,r,t,a){var s;let n=t.layers||[];const l=t.tables||[];if(((s=e.portalItem)==null?void 0:s.type)==="Feature Collection"&&(n.forEach(o=>{var i;((i=o==null?void 0:o.layerDefinition)==null?void 0:i.type)==="Table"&&l.push(o)}),n=n.filter(o=>{var i;return((i=o==null?void 0:o.layerDefinition)==null?void 0:i.type)!=="Table"})),"coverage"in t){const o=N(t);o&&e.add(o)}n.reverse().forEach(o=>{const i=a==null?void 0:a(o);if(i||!a){const u=m(e,r(o),t,o,i);e.add(u)}}),l.reverse().forEach(o=>{const i=a==null?void 0:a(o);if(i||!a){const u=m(e,r(o),t,o,i);e.tables.add(u)}})}function m(e,r,t,a,n){const l=e.portalItem,s=new r({portalItem:l.clone(),layerId:a.id});if("sourceJSON"in s&&(s.sourceJSON=n),s.type!=="subtype-group"&&(s.sublayerTitleMode="service-name"),l.type==="Feature Collection"){const o={origin:"portal-item",portal:l.portal||T.getDefault()};s.read(a,o);const i=t.showLegend;i!=null&&s.read({showLegend:i},o)}return s}async function g(e,r){if(e.supportsData===!1)return;const t=e.instance,a=t.portalItem;if(!a)return;let n=null;try{n=await a.fetchData("json",r)}catch{}if(E(t)){let l=null,s=!0;if(n&&y(n)>0){if(t.layerId==null){const o=h(n);t.layerId=t.type==="subtype-group"?o==null?void 0:o[0]:k(n)}l=C(n,t),l&&(y(n)===1&&(s=!1),n.showLegend!=null&&(l.showLegend=n.showLegend))}return s&&"sublayerTitleMode"in t&&t.sublayerTitleMode!=="service-name"&&(t.sublayerTitleMode="item-title-and-service-name"),l}return n}async function j(e,r){if((e==null?void 0:e.layers)==null||(e==null?void 0:e.tables)==null){const t=await b(r);(e=e||{}).layers=e.layers||(t==null?void 0:t.layers),e.tables=e.tables||(t==null?void 0:t.tables)}return e}function k(e){const r=e.layers;if(r&&r.length)return r[0].id;const t=e.tables;return t&&t.length?t[0].id:null}function C(e,r){var n,l;const{layerId:t}=r,a=((n=e.layers)==null?void 0:n.find(s=>s.id===t))||((l=e.tables)==null?void 0:l.find(s=>s.id===t));return a&&J(a,r)?a:null}function y(e){var r,t;return(((r=e==null?void 0:e.layers)==null?void 0:r.length)??0)+(((t=e==null?void 0:e.tables)==null?void 0:t.length)??0)}function E(e){return e.type!=="stream"&&e.type!=="oriented-imagery"&&"layerId"in e}function N(e){const{coverage:r}=e;if(!r)return null;const t=new URL(r);if(r.toLowerCase().includes("item.html")){const a=t.searchParams.get("id"),n=t.origin;return d.fromPortalItem({portalItem:new v({id:a,url:n})})}if(S(r))return d.fromArcGISServerUrl({url:r});throw new p("portal:oriented-imagery-layer-coverage","the provided coverage url couldn't be loaded as a layer")}function h(e){var t;const r=[];return(t=e==null?void 0:e.layers)==null||t.forEach(a=>{a.layerType==="SubtypeGroupLayer"&&r.push(a.id)}),r}function J(e,r){return!(r.type==="feature"&&"layerType"in e&&e.layerType==="SubtypeGroupLayer"||r.type==="subtype-group"&&!("layerType"in e))}async function R(e){const{layersJSON:r}=await F(e);if(!r)return null;const t=[...r.layers,...r.tables];return a=>t.find(n=>n.id===a.id)}export{k as getFirstLayerOrTableId,y as getNumLayersAndTables,h as getSubtypeGroupLayerIds,H as load,j as preprocessFSItemData};
