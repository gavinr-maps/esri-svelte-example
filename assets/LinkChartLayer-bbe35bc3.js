import{a as s,b as p,c as G,P as Ee,ao as oe,N as Ht,v as mr,_ as at,dN as ot,T as _,dk as bt,aB as Jt,az as ve,M as ce,aA as xe,s as Te,a1 as Le,aR as fr,ax as Vt,ca as Qe,ay as Wt,iX as gr,eh as ye,ek as wr,aC as Ue,k as _r,au as Kt,V as xt,as as br}from"./index-e8c6bcc0.js";import{p as de}from"./geohashUtils-77d8429b.js";import{r as se}from"./featureConversionUtils-096a49d9.js";import{a as Dt,t as Gt}from"./OptimizedGeometry-33b2eb0d.js";import{e as Rt}from"./LabelClass-669bcee9.js";import{b as fe}from"./Query-ce383482.js";import"./UniqueValueRenderer-6847f026.js";import{t as Je,a as Tr}from"./jsonUtils-f94670aa.js";import{m as Er}from"./FeatureStore-69342fcb.js";import{e as kr}from"./QueryEngine-fe077530.js";import{c as Mr,o as Ve}from"./clientSideDefaults-f0d03b7e.js";import{s as Ir}from"./fieldProperties-0a0dca54.js";import{a as Zt}from"./BlendLayer-63dc08ea.js";import{n as Cr}from"./FeatureReductionLayer-2ee74cd2.js";import{p as Lr}from"./RefreshableLayer-4a8676fc.js";import{t as Xt}from"./ScaleRangeLayer-4cc0b1db.js";import{y as St}from"./Field-fadcb771.js";import{d as vr}from"./FeatureSet-72ed3e08.js";import{p as xr}from"./popupUtils-b796c605.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./labelUtils-98630c63.js";import"./defaultsJSON-b087dd4d.js";import"./featureFlags-bf3d5654.js";import"./LegendOptions-0ffe455e.js";import"./diffUtils-f8f9fc73.js";import"./SizeVariable-dc6fe734.js";import"./colorRamps-7c0167a8.js";import"./lengthUtils-b9fae671.js";import"./ColorStop-3149a864.js";import"./styleUtils-d6218d7e.js";import"./DictionaryLoader-67262ed1.js";import"./LRUCache-3922d825.js";import"./Version-651090e3.js";import"./FieldsIndex-888b8bd2.js";import"./heatmapUtils-ee8bc01a.js";import"./vec4f64-aa64c7e9.js";import"./BoundsStore-dc194457.js";import"./PooledRBush-4ae7c2cc.js";import"./projectionSupport-380694fd.js";import"./json-48e3ea08.js";import"./timeSupport-d59847c8.js";import"./normalizeUtils-f64efc29.js";import"./normalizeUtilsCommon-123fc71f.js";import"./utils-c9a76eea.js";import"./WhereClause-0a306758.js";import"./executionError-c92d3b85.js";import"./QueryEngineCapabilities-42e44ded.js";import"./quantizationUtils-4ff178e4.js";import"./utils-68382e8f.js";import"./generateRendererUtils-5874bc54.js";import"./jsonUtils-45b2dffb.js";import"./parser-c8281db0.js";import"./clusterUtils-a6986c79.js";import"./commonProperties-a06e23a3.js";import"./ElevationInfo-9f2bd050.js";import"./featureLayerUtils-07676dd2.js";import"./AttachmentQuery-35d4fb4f.js";import"./RelationshipQuery-5b5a1cfb.js";import"./fieldType-a79b2e2e.js";const Dr="ESRI__DESTINATION_ID",Gr="ESRI__ORIGIN_ID";let We=class le{constructor(){this._featureLookup=new Map}static getInstance(){return le.instance||(le.instance=new le),le.instance}static resetInstance(){le.instance&&(le.instance=null)}deleteFromStore(t){t.forEach(r=>{this._featureLookup.delete(r)})}readFromStoreByList(t){const r=[];return t.forEach(i=>{const n=this.readFromStoreById(i);n&&r.push(n)}),r}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,r,i){const n=[];return t.forEach(o=>{if(!o||!o.id)return;o.properties||(o.properties=[]);let a,l=null;if(i&&(l=o.properties[i]?se(o.properties[i]):null),"originId"in o&&"destinationId"in o&&(o.properties[Gr]=o.originId,o.properties[Dr]=o.destinationId),o.properties[r]=o.id,o.id&&this._featureLookup.has(o.id)&&this._featureLookup.get(o.id).attributes){const d=this._featureLookup.get(o.id);a=new Dt(l?JSON.parse(JSON.stringify(l)):d!=null&&d.geometry?JSON.parse(JSON.stringify(d.geometry)):null,JSON.parse(JSON.stringify(Object.assign(d.attributes,o.properties))),null,o.properties[r])}else a=new Dt(l?JSON.parse(JSON.stringify(l)):null,o.properties,null,o.properties[r]);this._featureLookup.set(o.id,a),n.push(a)}),n}},$e=class extends Ee{constructor(t){super(t),this.resultRows=[]}};s([p()],$e.prototype,"resultRows",void 0),$e=s([G("esri.rest.knowledgeGraph.GraphQueryResult")],$e);const Nt=$e;let Pe=class extends Ee{constructor(t){super(t),this.resultRowsStream=new ReadableStream}};s([p()],Pe.prototype,"resultRowsStream",void 0),Pe=s([G("esri.rest.knowledgeGraph.GraphQueryResult")],Pe);const $t=Pe;let ne=class extends oe{constructor(t){super(t),this.name=null,this.unique=null,this.ascending=null,this.description=null,this.fieldNames=null}};s([p({type:String,json:{write:!0}})],ne.prototype,"name",void 0),s([p({type:Boolean,json:{write:!0}})],ne.prototype,"unique",void 0),s([p({type:Boolean,json:{write:!0}})],ne.prototype,"ascending",void 0),s([p({type:String,json:{write:!0}})],ne.prototype,"description",void 0),s([p({type:[String],json:{write:!0}})],ne.prototype,"fieldNames",void 0),ne=s([G("esri.rest.knowledgeGraph.FieldIndex")],ne);const er=ne;let F=class extends oe{constructor(t){super(t),this.name=null,this.alias=null,this.fieldType=null,this.geometryType=null,this.hasM=null,this.hasZ=null,this.nullable=null,this.editable=null,this.required=null,this.defaultVisibility=null,this.systemMaintained=null,this.role=null,this.defaultValue=null}};s([p({type:String,json:{write:!0}})],F.prototype,"name",void 0),s([p({type:String,json:{write:!0}})],F.prototype,"alias",void 0),s([p({type:String,json:{write:!0}})],F.prototype,"fieldType",void 0),s([p({type:String,json:{write:!0}})],F.prototype,"geometryType",void 0),s([p({type:Boolean,json:{write:!0}})],F.prototype,"hasM",void 0),s([p({type:Boolean,json:{write:!0}})],F.prototype,"hasZ",void 0),s([p({type:Boolean,json:{write:!0}})],F.prototype,"nullable",void 0),s([p({type:Boolean,json:{write:!0}})],F.prototype,"editable",void 0),s([p({type:Boolean,json:{write:!0}})],F.prototype,"required",void 0),s([p({type:Boolean,json:{write:!0}})],F.prototype,"defaultVisibility",void 0),s([p({type:Boolean,json:{write:!0}})],F.prototype,"systemMaintained",void 0),s([p()],F.prototype,"role",void 0),s([p({type:Object,json:{type:String,write:{writer:(e,t)=>{t.defaultValue=e!=null?e.toString():null}}}})],F.prototype,"defaultValue",void 0),F=s([G("esri.rest.knowledgeGraph.GraphProperty")],F);const tr=F;let re=class extends oe{constructor(t){super(t),this.name=null,this.alias=null,this.role=null,this.strict=null,this.properties=null,this.fieldIndexes=null}};s([p({type:String,json:{write:!0}})],re.prototype,"name",void 0),s([p({type:String,json:{write:!0}})],re.prototype,"alias",void 0),s([p({type:String,json:{write:!0}})],re.prototype,"role",void 0),s([p({type:Boolean,json:{write:!0}})],re.prototype,"strict",void 0),s([p({type:[tr],json:{write:!0}})],re.prototype,"properties",void 0),s([p({type:[er],json:{write:!0}})],re.prototype,"fieldIndexes",void 0),re=s([G("esri.rest.knowledgeGraph.GraphObjectType")],re);const rr=re;let st=class extends rr{constructor(t){super(t)}};st=s([G("esri.rest.knowledgeGraph.EntityType")],st);const Tt=st;let je=class extends rr{constructor(t){super(t),this.endPoints=[]}};s([p()],je.prototype,"endPoints",void 0),je=s([G("esri.rest.knowledgeGraph.RelationshipType")],je);const Et=je;let J=class extends oe{constructor(t){super(t),this.timestamp=null,this.spatialReference=null,this.strict=null,this.objectIdField=null,this.globalIdField=null,this.arcgisManaged=null,this.identifierInfo=null,this.searchIndexes=null,this.entityTypes=null,this.relationshipTypes=null}};s([p({type:Date,json:{type:Number,write:{writer:(e,t)=>{t.timestamp=e==null?void 0:e.getTime()}}}})],J.prototype,"timestamp",void 0),s([p({type:Ht,json:{write:!0}})],J.prototype,"spatialReference",void 0),s([p({type:Boolean,json:{write:!0}})],J.prototype,"strict",void 0),s([p({type:String,json:{write:!0}})],J.prototype,"objectIdField",void 0),s([p({type:String,json:{write:!0}})],J.prototype,"globalIdField",void 0),s([p()],J.prototype,"arcgisManaged",void 0),s([p()],J.prototype,"identifierInfo",void 0),s([p()],J.prototype,"searchIndexes",void 0),s([p({type:[Tt],json:{write:!0}})],J.prototype,"entityTypes",void 0),s([p({type:[Et],json:{write:!0}})],J.prototype,"relationshipTypes",void 0),J=s([G("esri.rest.knowledgeGraph.DataModel")],J);const ir=J;let P=class extends oe{constructor(t){super(t),this.capabilities=[],this.supportsSearch=!1,this.supportedQueryFormats=[],this.allowGeometryUpdates=!1,this.searchMaxRecordCount=null,this.serviceCapabilities=null,this.maxRecordCount=null,this.description="",this.copyrightText="",this.units="",this.spatialReference=null,this.currentVersion=null,this.dateFieldsTimeReference=null,this.serviceItemId="",this.supportsDocuments=!1,this.dataEditingNotSupported=!1,this.schemaEditingNotSupported=!1}};s([p({type:[String],json:{write:!0}})],P.prototype,"capabilities",void 0),s([p({type:Boolean,json:{write:!0}})],P.prototype,"supportsSearch",void 0),s([p({type:[String],json:{write:!0}})],P.prototype,"supportedQueryFormats",void 0),s([p({type:Boolean,json:{write:!0}})],P.prototype,"allowGeometryUpdates",void 0),s([p({type:Number,json:{write:!0}})],P.prototype,"searchMaxRecordCount",void 0),s([p({type:Object,json:{write:!0}})],P.prototype,"serviceCapabilities",void 0),s([p({type:Number,json:{write:!0}})],P.prototype,"maxRecordCount",void 0),s([p({type:String,json:{write:!0}})],P.prototype,"description",void 0),s([p({type:String,json:{write:!0}})],P.prototype,"copyrightText",void 0),s([p({type:String,json:{write:!0}})],P.prototype,"units",void 0),s([p({type:Object,json:{write:!0}})],P.prototype,"spatialReference",void 0),s([p({type:Number,json:{write:!0}})],P.prototype,"currentVersion",void 0),s([p({type:Object,json:{write:!0}})],P.prototype,"dateFieldsTimeReference",void 0),s([p({type:String,json:{write:!0}})],P.prototype,"serviceItemId",void 0),s([p({type:Boolean,json:{write:!0}})],P.prototype,"supportsDocuments",void 0),s([p({type:Boolean,json:{write:!0}})],P.prototype,"dataEditingNotSupported",void 0),s([p({type:Boolean,json:{write:!0}})],P.prototype,"schemaEditingNotSupported",void 0),P=s([G("esri.rest.knowledgeGraph.ServiceDefinition")],P);const nr=P;let ge=class extends oe{constructor(t){super(t),this.dataModel=null,this.serviceDefinition=null}};s([p({type:String,json:{write:!0}})],ge.prototype,"url",void 0),s([p({type:ir,json:{write:!0}})],ge.prototype,"dataModel",void 0),s([p({type:nr,json:{write:!0}})],ge.prototype,"serviceDefinition",void 0),ge=s([G("esri.rest.knowledgeGraph.KnowledgeGraph")],ge);const Rr=ge,Pt="esri/rest/knowledgeGraph/wasmInterface/";let Ke;async function ae(){const e=Ke;if(e)return e;const t=mr("wasm-simd");return Ke=Sr(t),Ke}async function Sr(e){if(e){const{default:r}=await at(()=>import("./arcgis-knowledge-client-core-simd-c9195cdb.js"),["./arcgis-knowledge-client-core-simd-c9195cdb.js","./index-e8c6bcc0.js","./index-0da2eac5.css"],import.meta.url).then(i=>i.a);return r({locateFile:i=>ot(Pt+i)})}const{default:t}=await at(()=>import("./arcgis-knowledge-client-core-5d6147b4.js"),["./arcgis-knowledge-client-core-5d6147b4.js","./index-e8c6bcc0.js","./index-0da2eac5.css"],import.meta.url).then(r=>r.a);return t({locateFile:r=>ot(Pt+r)})}function ar(e,t){const r=new t.ArrayValue;return r.deleteLater(),e.forEach(i=>{r.add_value(Mt(i,t))}),r}function or(e,t){const r=new t.ObjectValue;r.deleteLater();for(const[i,n]of Object.entries(e))r.set_key_value(i,Mt(n,t));return r}function kt(e,t){if(e instanceof Jt)return jr(e,t);if(e instanceof ve)return Or(e,t);if(e instanceof ce||e instanceof xe)return Pr(e,t);throw new _("knowledge-graph:unsupported-geometry","Only Point, Multipoint, Polyline, and Polygon geometry are supported by ArcGIS Knowledge",{geometry:e})}function Nr(e,t){t.input_quantization_parameters={xy_resolution:e.xyResolution,x_false_origin:e.xFalseOrigin,y_false_origin:e.yFalseOrigin,z_resolution:e.zResolution,z_false_origin:e.zFalseOrigin,m_resolution:e.mResolution,m_false_origin:e.mFalseOrigin}}function $r(e,t,r){if(!e.extent)throw new _("knowledge-graph:illegal-output-quantization","The Output quantization provided to the encoder had an illegal value as part of its extent",e.extent);if(!e.quantizeMode)throw new _("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal mode setting",e.quantizeMode);if(!e.tolerance)throw new _("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal tolerance setting",e.quantizeMode);t.output_quantization_parameters={extent:{xmax:e.extent.xmax,ymax:e.extent.ymax,xmin:e.extent.xmin,ymin:e.extent.ymin},quantize_mode:r.esriQuantizeMode[e.quantizeMode],tolerance:e.tolerance}}function Mt(e,t){if(e==null)return"";if(typeof e!="object"||e instanceof Date)return e;if(e instanceof bt)return kt(e,t);if(Array.isArray(e)){const r=new t.ArrayValue;return r.deleteLater(),e.forEach(i=>{r.add_value(Mt(i,t))}),r}return or(e,t)}function Pr(e,t){const r=new t.GeometryValue;r.deleteLater(),r.has_z=e.hasZ,r.has_m=e.hasM;const i=[],n=[];let o=[];e instanceof ce?(r.geometry_type=t.esriGeometryType.esriGeometryPolyline,o=e.paths):e instanceof xe&&(r.geometry_type=t.esriGeometryType.esriGeometryPolygon,o=e.rings);let a=0,l=0;return o.forEach(d=>{let u=0;d.forEach(y=>{u++,y.forEach(m=>{i[l]=m,l++})}),n[a]=u,a++}),r.coords=new Float64Array(i),r.lengths=new Uint32Array(n),r}function jr(e,t){const r=new t.GeometryValue;r.deleteLater(),r.geometry_type=r.geometry_type=t.esriGeometryType.esriGeometryMultipoint,r.has_z=e.hasZ,r.has_m=e.hasM;const i=[],n=[];n[0]=e.points.length;let o=0;return e.points.forEach(a=>{a.forEach(l=>{i[o]=l,o++})}),r.coords=new Float64Array(i),r.lengths=new Uint32Array(n),r}function Or(e,t){const r=new t.GeometryValue;r.deleteLater(),r.geometry_type=t.esriGeometryType.esriGeometryPoint,r.has_z=e.hasZ,r.has_m=e.hasM;const i=[],n=[];n[0]=1,i[0]=e.x,i[1]=e.y;let o=2;return e.hasZ&&(i[o]=e.z,o++),e.hasM&&(i[o]=e.m,o++),r.coords=new Float64Array(i),r.lengths=new Uint32Array(n),r}let Oe=class extends oe{constructor(t){super(t),this.properties=null}};s([p({json:{write:!0}})],Oe.prototype,"properties",void 0),Oe=s([G("esri.rest.knowledgeGraph.GraphObject")],Oe);const It=Oe;let Ce=class extends It{constructor(t){super(t),this.typeName=null,this.id=null}};s([p({type:String,json:{write:!0}})],Ce.prototype,"typeName",void 0),s([p({type:String,json:{write:!0}})],Ce.prototype,"id",void 0),Ce=s([G("esri.rest.knowledgeGraph.GraphNamedObject")],Ce);const sr=Ce;let Fe=class extends sr{constructor(t){super(t),this.layoutGeometry=null}};s([p({type:ve,json:{write:!0}})],Fe.prototype,"layoutGeometry",void 0),Fe=s([G("esri.rest.knowledgeGraph.Entity")],Fe);const lr=Fe;let we=class extends sr{constructor(t){super(t),this.originId=null,this.destinationId=null,this.layoutGeometry=null}};s([p({type:String,json:{write:!0}})],we.prototype,"originId",void 0),s([p({type:String,json:{write:!0}})],we.prototype,"destinationId",void 0),s([p({type:ce,json:{write:!0}})],we.prototype,"layoutGeometry",void 0),we=s([G("esri.rest.Relationship.Relationship")],we);const pr=we;function Re(e,t){if(!e.typeName)throw new _("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits");if(e instanceof lr){const r=new t.EntityValue;r.deleteLater(),r.type_name=e.typeName;for(const[i,n]of Object.entries(e.properties))r.set_key_value(i,jt(n,t));return e.id&&r.set_id(e.id),r}if(e instanceof pr){const r=new t.RelationshipValue;r.deleteLater(),r.type_name=e.typeName;for(const[i,n]of Object.entries(e.properties))r.set_key_value(i,jt(n,t));return e.id&&r.set_id(e.id),e.originId&&e.destinationId&&r.set_related_entity_ids(e.originId,e.destinationId),r}throw new _("knowledge-graph:applyEdits-encoding-failure","Could not determine the type of a named graph object passed to the encoder")}function Fr(e){return{xy_resolution:e.xyResolution,x_false_origin:e.xFalseOrigin,y_false_origin:e.yFalseOrigin,z_resolution:e.zResolution,z_false_origin:e.zFalseOrigin,m_resolution:e.mResolution,m_false_origin:e.mFalseOrigin}}function jt(e,t){return e==null?"":typeof e!="object"||e instanceof Date?e:e instanceof bt?kt(e,t):""}let pe=class extends Ee{constructor(t){super(t),this.name=null,this.supportedCategory=null,this.analyzers=[],this.searchProperties=new Map}};s([p()],pe.prototype,"name",void 0),s([p()],pe.prototype,"supportedCategory",void 0),s([p()],pe.prototype,"analyzers",void 0),s([p()],pe.prototype,"searchProperties",void 0),pe=s([G("esri.rest.knowledgeGraph.SearchIndex")],pe);const Ar=pe;var qe,Ye,Be,lt,pt,dt,ut;(function(e){e[e.Regular=0]="Regular",e[e.Provenance=1]="Provenance",e[e.Document=2]="Document"})(qe||(qe={})),function(e){e[e.esriFieldTypeSmallInteger=0]="esriFieldTypeSmallInteger",e[e.esriFieldTypeInteger=1]="esriFieldTypeInteger",e[e.esriFieldTypeSingle=2]="esriFieldTypeSingle",e[e.esriFieldTypeDouble=3]="esriFieldTypeDouble",e[e.esriFieldTypeString=4]="esriFieldTypeString",e[e.esriFieldTypeDate=5]="esriFieldTypeDate",e[e.esriFieldTypeOID=6]="esriFieldTypeOID",e[e.esriFieldTypeGeometry=7]="esriFieldTypeGeometry",e[e.esriFieldTypeBlob=8]="esriFieldTypeBlob",e[e.esriFieldTypeRaster=9]="esriFieldTypeRaster",e[e.esriFieldTypeGUID=10]="esriFieldTypeGUID",e[e.esriFieldTypeGlobalID=11]="esriFieldTypeGlobalID",e[e.esriFieldTypeXML=12]="esriFieldTypeXML",e[e.esriFieldTypeBigInteger=13]="esriFieldTypeBigInteger"}(Ye||(Ye={})),function(e){e[e.esriGeometryNull=0]="esriGeometryNull",e[e.esriGeometryPoint=1]="esriGeometryPoint",e[e.esriGeometryMultipoint=2]="esriGeometryMultipoint",e[e.esriGeometryPolyline=3]="esriGeometryPolyline",e[e.esriGeometryPolygon=4]="esriGeometryPolygon",e[e.esriGeometryEnvelope=5]="esriGeometryEnvelope",e[e.esriGeometryAny=6]="esriGeometryAny",e[e.esriGeometryMultiPatch=7]="esriGeometryMultiPatch"}(Be||(Be={})),function(e){e[e.esriMethodHintUNSPECIFIED=0]="esriMethodHintUNSPECIFIED",e[e.esriUUIDESRI=1]="esriUUIDESRI",e[e.esriUUIDRFC4122=2]="esriUUIDRFC4122"}(lt||(lt={})),function(e){e[e.esriTypeUNSPECIFIED=0]="esriTypeUNSPECIFIED",e[e.esriTypeEntity=1]="esriTypeEntity",e[e.esriTypeRelationship=2]="esriTypeRelationship",e[e.esriTypeBoth=4]="esriTypeBoth"}(pt||(pt={})),function(e){e[e.esriGraphPropertyUNSPECIFIED=0]="esriGraphPropertyUNSPECIFIED",e[e.esriGraphPropertyRegular=1]="esriGraphPropertyRegular",e[e.esriGraphPropertyDocumentName=2]="esriGraphPropertyDocumentName",e[e.esriGraphPropertyDocumentTitle=3]="esriGraphPropertyDocumentTitle",e[e.esriGraphPropertyDocumentUrl=4]="esriGraphPropertyDocumentUrl",e[e.esriGraphPropertyDocumentText=5]="esriGraphPropertyDocumentText",e[e.esriGraphPropertyDocumentKeywords=6]="esriGraphPropertyDocumentKeywords",e[e.esriGraphPropertyDocumentContentType=7]="esriGraphPropertyDocumentContentType",e[e.esriGraphPropertyDocumentMetadata=8]="esriGraphPropertyDocumentMetadata",e[e.esriGraphPropertyDocumentFileExtension=9]="esriGraphPropertyDocumentFileExtension"}(dt||(dt={})),function(e){e[e.esriIdentifierInfoTypeUNSPECIFIED=0]="esriIdentifierInfoTypeUNSPECIFIED",e[e.esriIdentifierInfoTypeDatabaseNative=1]="esriIdentifierInfoTypeDatabaseNative",e[e.esriIdentifierInfoTypeUniformProperty=2]="esriIdentifierInfoTypeUniformProperty"}(ut||(ut={}));function zr(e){var t,r,i,n,o,a,l,d,u,y,m;return e.deleteLater(),new ir({timestamp:e.timestamp,spatialReference:new Ht(e.spatial_reference),strict:e.strict,objectIdField:e.objectid_property,globalIdField:e.globalid_property,arcgisManaged:e.arcgis_managed,identifierInfo:{identifierMappingInfo:{identifierInfoType:ut[(i=(r=(t=e.identifier_info)==null?void 0:t.identifier_mapping_info)==null?void 0:r.identifier_info_type)==null?void 0:i.value],databaseNativeIdentifier:(o=(n=e.identifier_info)==null?void 0:n.identifier_mapping_info)==null?void 0:o.database_native_identifier,uniformPropertyIdentifier:{identifierPropertyName:(d=(l=(a=e.identifier_info)==null?void 0:a.identifier_mapping_info)==null?void 0:l.uniform_property_identifier)==null?void 0:d.identifier_property_name}},identifierGenerationInfo:{uuidMethodHint:lt[(m=(y=(u=e.identifier_info)==null?void 0:u.identifier_generation_info)==null?void 0:y.uuid_method_hint)==null?void 0:m.value]}},searchIndexes:Kr(e.search_indexes),entityTypes:Br(e.entity_types),relationshipTypes:Wr(e.relationship_types)})}function Qr(e){return e.deleteLater(),new Tt(dr(e))}function Ur(e){return e.deleteLater(),new er({name:e.name,unique:e.unique,ascending:e.ascending,description:e.description,fieldNames:Hr(e.fields)})}function dr(e){return{name:e.name,alias:e.alias,role:qe[e.role.value]?qe[e.role.value]:null,strict:e.strict,properties:Jr(e.properties),fieldIndexes:Vr(e.field_indexes)}}function qr(e){return e.deleteLater(),new tr({alias:e.alias,name:e.name,fieldType:Ye[e.field_type.value]?Ye[e.field_type.value]:null,geometryType:Be[e.geometry_type.value]?Be[e.geometry_type.value]:null,hasM:e.has_m,hasZ:e.has_z,nullable:e.nullable,editable:e.editable,required:e.required,defaultVisibility:e.default_visibility,systemMaintained:e.system_maintained,role:dt[e.role.value],defaultValue:e.default_value})}function Yr(e){e.deleteLater();const t=dr(e),r=[];for(let i=0;i<e.end_points.size();i++){const n=e.end_points.get(i);r.push({originEntityType:n.origin_entity_type,destinationEntityType:n.dest_entity_type})}return new Et(Object.assign({endPoints:r},t))}function Br(e){const t=[];for(let r=0;r<e.size();r++)t.push(Qr(e.get(r)));return t}function Hr(e){const t=[];for(let r=0;r<e.size();r++)t.push(e.get(r));return t}function Jr(e){const t=[];for(let r=0;r<e.size();r++)t.push(qr(e.get(r)));return t}function Vr(e){const t=[];for(let r=0;r<e.size();r++)t.push(Ur(e.get(r)));return t}function Wr(e){const t=[];for(let r=0;r<e.size();r++)t.push(Yr(e.get(r)));return t}function Kr(e){const t=[];for(let r=0;r<e.size();r++){const i=new Ar,n=e.get(0);i.name=n.name,i.supportedCategory=pt[n.supported_category.value];const o=n.analyzers.size();for(let a=0;a<o;a++)i.analyzers.push({name:n.analyzers.get(a).name});for(let a=0;a<n.search_properties.keys().size();a++){const l=n.search_properties.keys().get(a),d=n.search_properties.get(l),u=[];for(let y=0;y<d.property_names.size();y++)u.push(d.property_names.get(y));i.searchProperties.set(l,{propertyNames:u})}t.push(i)}return t}let ht=class extends It{constructor(t){super(t)}};ht=s([G("esri.rest.knowledgeGraph.ObjectValue")],ht);const Zr=ht;let Ae=class extends oe{constructor(t){super(t),this.path=null}};s([p({type:[It],json:{write:!0}})],Ae.prototype,"path",void 0),Ae=s([G("esri.rest.knowledgeGraph.Path")],Ae);const Xr=Ae;var W;(function(e){e[e.ESRI_GEOMETRY_NULL=0]="ESRI_GEOMETRY_NULL",e[e.ESRI_GEOMETRY_POINT=1]="ESRI_GEOMETRY_POINT",e[e.ESRI_GEOMETRY_MULTIPOINT=2]="ESRI_GEOMETRY_MULTIPOINT",e[e.ESRI_GEOMETRY_POLYLINE=3]="ESRI_GEOMETRY_POLYLINE",e[e.ESRI_GEOMETRY_POLYGON=4]="ESRI_GEOMETRY_POLYGON",e[e.ESRI_GEOMETRY_ENVELOPE=5]="ESRI_GEOMETRY_ENVELOPE",e[e.ESRI_GEOMETRY_ANY=6]="ESRI_GEOMETRY_ANY",e[e.ESRI_GEOMETRY_MULTI_PATCH=7]="ESRI_GEOMETRY_MULTI_PATCH"})(W||(W={}));var ue,Ot;(function(e){e[e.OBJECT=0]="OBJECT",e[e.ENTITY=1]="ENTITY",e[e.RELATIONSHIP=2]="RELATIONSHIP",e[e.PATH=3]="PATH",e[e.ARRAY=4]="ARRAY"})(ue||(ue={})),function(e){e[e.view=0]="view",e[e.edit=1]="edit"}(Ot||(Ot={}));function ei(e){const t={},r=Ct(e,t),i=e.lengths,n=e.coords,o=i[0];t.points=[];let a=0;for(let l=0;l<o;l++){const d=[];for(let u=0;u<r;u++)d[u]=n[a],a++;t.points.push(d)}return new Jt(t)}function ti(e){const t={};let r=2;Ct(e,t);const i=e.coords;return t.x=i[0],t.y=i[1],e.has_z&&(t.z=i[r],r++),e.has_m&&(t.m=i[r]),new ve(t)}function ri(e){return new ce(ur(e))}function ii(e){return new xe(ur(e))}function ur(e){const t={},r=Ct(e,t),i=e.lengths,n=e.coords;let o="";if(e.geometry_type.value===W.ESRI_GEOMETRY_POLYGON)o="rings";else{if(e.geometry_type.value!==W.ESRI_GEOMETRY_POLYLINE)throw new _("KnowledgeGraph:illegal-geometry-type","Illegal Geometry type for multipath conversion");o="paths"}t[o]=[];let a=0;return i.forEach(l=>{const d=[];for(let u=0;u<l;u++){const y=[];for(let m=0;m<r;m++)y[m]=n[a],a++;d.push(y)}t[o].push(d)}),t}function Ct(e,t){let r=2;return e.has_z?(t.hasZ=e.has_z,r++):t.hasZ=!1,e.has_m?(t.hasM=e.has_m,r++):t.hasM=!1,r}const Se=Te.getLogger("esri.rest.knowledgeGraph.WasmToQueryResponseObjConstructors"),ni={decodedWasmObjToQueryResponseObj:(e,t)=>{if(e==null)return null;if(typeof e!="object"||"getDate"in e)return e;if("geometry_type"in e)switch(e.geometry_type.value){case null:return null;case W.ESRI_GEOMETRY_POINT:return ti(e);case W.ESRI_GEOMETRY_MULTIPOINT:return ei(e);case W.ESRI_GEOMETRY_POLYLINE:return ri(e);case W.ESRI_GEOMETRY_POLYGON:return ii(e);case W.ESRI_GEOMETRY_ENVELOPE:case W.ESRI_GEOMETRY_MULTI_PATCH:return Se.warnOnce("Envelope and Multipatch are not supported on knowledge entities, but one of those geometry types was detected. Result interpreted as null"),null;case W.ESRI_GEOMETRY_NULL:case W.ESRI_GEOMETRY_ANY:default:return Se.warnOnce("Unknown or blank geometry type returned - Result interpreted as null"),null}else{if(!("object_value_type"in e))return Se.warnOnce("A decoded value came back of a type that is not supported. Result interpreted as null"),null;switch(e.object_value_type.value){case ue.OBJECT:return oi(e,t);case ue.ENTITY:return hr(e,t);case ue.RELATIONSHIP:return cr(e,t);case ue.PATH:return si(e,t);case ue.ARRAY:return ai(e,t);default:return Se.warnOnce("Unknown graph object type detected!  Result interpreted as null"),null}}}};function ai(e,t){const r=[],i=e.count();for(let n=0;n<i;n++){const o=e.get_value_at(n);r.push(Lt(o,t))}return r}function Lt(e,t){return ni.decodedWasmObjToQueryResponseObj(e,t)}function hr(e,t){const r=e.type_name,i=vt(e,t),n=e.get_id();return new lr(Object.assign({typeName:r,id:n},i))}function vt(e,t){const r={},i=e.key_count();for(let n=0;n<i;n++)r[e.get_key_at(n)]=Lt(e.get_value_at(n),t);return{properties:r}}function oi(e,t){return new Zr(vt(e,t))}function si(e,t){const r=e.entity_count(),i=e.relationship_count(),n=[];for(let o=0;o<r;o++)n.push(hr(e.get_entity_at(o),t)),o<i&&n.push(cr(e.get_relationship_at(o),t));return new Xr({path:n})}function cr(e,t){const r=e.type_name,i=vt(e,t);return new pr(Object.assign({typeName:r,id:e.get_id(),originId:e.get_origin_entity_id(),destinationId:e.get_destination_entity_id()},i))}let _e=class extends Ee{constructor(t){super(t),this.hasError=null,this.error=null,this.editResults=[]}};s([p()],_e.prototype,"hasError",void 0),s([p()],_e.prototype,"error",void 0),s([p()],_e.prototype,"editResults",void 0),_e=s([G("esri.rest.knowledgeGraph.GraphApplyEdits")],_e);const li=_e;function pi(e){const t=new li;t.hasError=e.has_error(),t.hasError&&(t.error={errorCode:e.error.error_code,errorMessage:e.error.error_message});const r=e.get_edit_results_count();for(let i=0;i<r;i++){const n=e.get_edit_results_at(i),o=e.get_edit_results_type_name_at(i),a=[],l=[],d=[],u=n.get_add_results_count(),y=n.get_update_results_count(),m=n.get_delete_results_count();for(let g=0;g<u;g++){const f=n.get_add_result_at(g);a.push({id:f.id,error:{errorCode:f.error.error_code,errorMessage:f.error.error_message}})}for(let g=0;g<y;g++){const f=n.get_update_result_at(g);l.push({id:f.id,error:{errorCode:f.error.error_code,errorMessage:f.error.error_message}})}for(let g=0;g<m;g++){const f=n.get_delete_result_at(g);d.push({id:f.id,error:{errorCode:f.error.error_code,errorMessage:f.error.error_message}})}t.editResults.push({typeName:o,adds:a,updates:l,deletes:d})}return t}const De={fetchKnowledgeGraph:async e=>{const t=new Rr({url:e}),r=[];return r.push(He(t)),r.push(ui(t)),await Promise.all(r),t},refreshDataModel:async e=>{e.dataModel=await yr(e)},refreshServiceDefinition:async e=>{var r,i;const t=(await Le(e.url,{query:{f:"json"}})).data;return t.capabilities=(r=t==null?void 0:t.capabilities)==null?void 0:r.split(","),t.supportedQueryFormats=(i=t==null?void 0:t.supportedQueryFormats)==null?void 0:i.split(","),e.serviceDefinition=new nr(t),e.serviceDefinition},executeQueryStreaming:async(e,t,r)=>{const i=`${e.url}/graph/query`;await et(e);const n=await tt(i,r);n.data.body=await yi(t,e);const o=await Xe(n.data.url,n.data);if(e.dataModel)return new $t({resultRowsStream:await Ft(o,e.dataModel)});throw new _("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")},executeApplyEdits:async(e,t,r)=>{var o;if((o=e.serviceDefinition)!=null&&o.dataEditingNotSupported)throw new _("knowledge-graph:data-editing-not-supported","The Knowledge Graph Service definition indicated that data editing is not supported");const i=`${e.url}/graph/applyEdits`;await et(e);const n=await tt(i,r);return n.data.body=await ci(t,e),fi(await Xe(n.data.url,n.data))},executeQuery:async(e,t,r)=>{var l;const i=`${e.url}/graph/query`,n=await Le(i,{responseType:"array-buffer",query:{f:"pbf",openCypherQuery:t.openCypherQuery,...r==null?void 0:r.query},signal:r==null?void 0:r.signal,timeout:r==null?void 0:r.timeout}),o=(l=n.getHeader)==null?void 0:l.call(n,"content-type"),a=n.data;if(o!=null&&o.includes("application/x-protobuf")){const d=new(await ae()).GraphQueryDecoder;if(d.deleteLater(),e.dataModel)return new Nt({resultRows:ct(d,a,e.dataModel)});throw new _("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new _("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:o,data:n.data})},executeSearch:async(e,t,r)=>{var d;const i=t.typeCategoryFilter,n=`${e.url}/graph/search`,o=await Le(n,{responseType:"array-buffer",query:{f:"pbf",searchQuery:`"${t.searchQuery}"`,typeCategoryFilter:i,...r==null?void 0:r.query},signal:r==null?void 0:r.signal,timeout:r==null?void 0:r.timeout}),a=(d=o.getHeader)==null?void 0:d.call(o,"content-type"),l=o.data;if(a!=null&&a.includes("application/x-protobuf")){const u=new(await ae()).GraphQueryDecoder;if(u.deleteLater(),e.dataModel)return new Nt({resultRows:ct(u,l,e.dataModel)});throw new _("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new _("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:a,data:o.data})},executeSearchStreaming:async(e,t,r)=>{const i=`${e.url}/graph/search`;await et(e);const n=await tt(i,r);n.data.body=await mi(t);const o=await Xe(n.data.url,n.data);if(e.dataModel)return new $t({resultRowsStream:await Ft(o,e.dataModel)});throw new _("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")},_fetchWrapper:async(e,t)=>fetch(e,t)};async function Ze(e,t,r){return De.executeQueryStreaming(e,t,r)}async function di(e){return De.fetchKnowledgeGraph(e)}async function He(e){return De.refreshDataModel(e)}async function ui(e){return De.refreshServiceDefinition(e)}async function Xe(e,t){return De._fetchWrapper(e,t)}async function et(e){var r;((r=fr)==null?void 0:r.findCredential(e.url))||(e.dataModel?await yr(e):await He(e))}function Me(e,t,r){if(e.error_code!==0)throw new _(t,r,{errorCode:e.error_code,errorMessage:e.error_message})}function hi(e,t,r,i){t==null?r.set_param_key_value(e,""):typeof t!="object"||t instanceof Date?r.set_param_key_value(e,t):t instanceof bt?r.set_param_key_value(e,kt(t,i)):t instanceof Array?r.set_param_key_value(e,ar(t,i)):r.set_param_key_value(e,or(t,i))}async function ci(e,t){var a,l,d,u,y,m,g,f,I;if(t.dataModel||await He(t),!t.dataModel)throw new _("knowledge-graph:data-model-undefined","Encoding could not proceed because a data model was not provided and it could not be determined from the service");const r=await ae(),i=!!((a=e.options)!=null&&a.cascadeDelete),n=new r.GraphApplyEditsEncoder(r.SpatialReferenceUtil.WGS84(),(l=e.options)!=null&&l.inputQuantizationParameters?Fr((d=e.options)==null?void 0:d.inputQuantizationParameters):r.InputQuantizationUtil.WGS84_lossless());n.deleteLater(),n.cascade_delete=i;try{let b;(u=e.entityAdds)==null||u.forEach(h=>{b=n.add_entity(Re(h,r)),Me(b,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")}),(y=e.relationshipAdds)==null||y.forEach(h=>{if(!h.originId||!h.destinationId)throw new _("knowledge-graph:relationship-origin-destination-missing","When adding a new relationship, you must provide both an origin and destination id on the appropriate class property");b=n.add_relationship(Re(h,r)),Me(b,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")}),(m=e.entityUpdates)==null||m.forEach(h=>{if(!h.id)throw new _("knowledge-graph:entity-id-missing","When updating an entity or relationship, you must specify the id on the class level property");b=n.update_entity(Re(h,r)),Me(b,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")}),(g=e.relationshipUpdates)==null||g.forEach(h=>{if(!h.id)throw new _("knowledge-graph:relationship-id-missing","When updating an entity or relationship, you must specify the id on the class level property");b=n.update_relationship(Re(h,r)),Me(b,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")}),(f=e.entityDeletes)==null||f.forEach(h=>{var L;if(!h.typeName)throw new _("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const w=n.make_delete_helper(h.typeName,!0);w.deleteLater(),(L=h.ids)==null||L.forEach(O=>{w.delete_by_id(O)})}),(I=e.relationshipDeletes)==null||I.forEach(h=>{var L;if(!h.typeName)throw new _("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const w=n.make_delete_helper(h.typeName,!1);(L=h.ids)==null||L.forEach(O=>{w.delete_by_id(O)})}),n.encode()}catch(b){throw new _("knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed",{error:b})}const o=n.get_encoding_result();return Me(o.error,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed"),o.get_byte_buffer()}async function yi(e,t){var o,a;const r=await ae(),i=new r.GraphQueryRequestEncoder;if(i.deleteLater(),i.output_spatial_reference=r.SpatialReferenceUtil.WGS84(),i.open_cypher_query=e.openCypherQuery,e.bindParameters)for(const[l,d]of Object.entries(e.bindParameters))hi(l,d,i,r);if(e.bindGeometryQuantizationParameters)Nr(e.bindGeometryQuantizationParameters,i);else{if(t.dataModel||await He(t),((a=(o=t.dataModel)==null?void 0:o.spatialReference)==null?void 0:a.wkid)!==4326)throw new _("knowledge-graph:SR-quantization-mismatch","If the DataModel indicates a coordinate system other than WGS84, inputQuantizationParameters must be provided to the query encoder");i.input_quantization_parameters=r.InputQuantizationUtil.WGS84_lossless()}e.outputQuantizationParameters&&$r(e.outputQuantizationParameters,i,r);try{i.encode()}catch(l){throw new _("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{error:l})}const n=i.get_encoding_result();if(n.error.error_code!==0)throw new _("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{errorCode:n.error.error_code,errorMessage:n.error.error_message});return n.get_byte_buffer()}async function mi(e){var n;const t=await ae(),r=new t.GraphSearchRequestEncoder;if(r.deleteLater(),r.search_query=e.searchQuery,r.type_category_filter=t.esriNamedTypeCategory[e.typeCategoryFilter],e.returnSearchContext===!0&&(r.return_search_context=e.returnSearchContext),e.start!=null&&e.start>0&&(r.start_index=e.start),e.num!=null&&(r.max_num_results=e.num),e.idsFilter!=null&&Array.isArray(e.idsFilter)&&e.idsFilter.length>0)try{r.set_ids_filter(ar(e.idsFilter,t))}catch(o){throw new _("knowledge-graph:ids-format-error","Attempting to set ids filter failed.  This is usually caused by an incorrectly formatted UUID string",{error:o})}(n=e.namedTypesFilter)==null||n.forEach(o=>{r.add_named_type_filter(o)});try{r.encode()}catch(o){throw new _("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{error:o})}const i=r.get_encoding_result();if(i.error.error_code!==0)throw new _("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{errorCode:i.error.error_code,errorMessage:i.error.error_message});return i.get_byte_buffer()}async function tt(e,t){return Le(e,{responseType:"native-request-init",method:"post",query:{f:"pbf",...t==null?void 0:t.query},body:"x",headers:{"Content-Type":"application/octet-stream"},signal:t==null?void 0:t.signal,timeout:t==null?void 0:t.timeout})}async function fi(e){const t=e.headers.get("content-type");if(t!=null&&t.includes("application/x-protobuf")){const r=await e.arrayBuffer(),i=new(await ae()).GraphApplyEditsDecoder;return i.deleteLater(),i.decode(new Uint8Array(r)),pi(i)}throw new _("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:t,data:e.text()})}function ct(e,t,r){e.push_buffer(new Uint8Array(t));const i=[];let n=0;for(;e.next_row();){n||(n=e.get_header_keys().size());const o=new Array(n);for(let a=0;a<n;a++){const l=e.get_value(a);o[a]=Lt(l,r)}i.push(o)}if(e.has_error())throw new _("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:e.error.error_code,errorMessage:e.error.error_message});return i}async function Ft(e,t){var i;const r=e.headers.get("content-type");if(e.headers.get("content-length")&&Te.getLogger("esri.rest.knowledgeGraph.knowledgeGraphService").warnOnce("Found `Content-Length` header when expecting a streaming HTTP response! Please investigate whether all intermediate HTTP proxies and/or load balancers are configured such that they don't forcefully buffer the entire response before returning it to the client. A valid HTTP streaming response should use Chunked Transfer Encoding and not have a Content Length defined."),r==null?void 0:r.includes("application/x-protobuf")){const n=(i=e.body)==null?void 0:i.getReader(),o=new(await ae()).GraphQueryDecoder;return o.deleteLater(),new ReadableStream({async start(a){try{return l()}catch(d){n==null||n.releaseLock(),a.error(new _("knowledge-graph:stream-decoding-error","The server returned a valid response, but there was an error decoding the response stream",{error:d})),a.close()}function l(){return n==null?void 0:n.read().then(({done:d,value:u})=>{if(d){let m;if(o.has_error()&&(m=new _("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:o.error.error_code,errorMessage:o.error.error_message})),n.releaseLock(),m)throw a.error(m),m;return void a.close()}const y=ct(o,u,t);return y.length>0&&a.enqueue(y),l()})}}})}throw new _("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:r,data:e.text()})}async function yr(e){var o;const t=`${e.url}/dataModel/queryDataModel`,r=await Le(t,{responseType:"array-buffer",query:{f:"pbf"}}),i=(o=r.getHeader)==null?void 0:o.call(r,"content-type"),n=r.data;if(i!=null&&i.includes("application/x-protobuf")){const a=(await ae()).decode_data_model_from_protocol_buffer(new Uint8Array(n));if(!a)throw new _("knowledge-graph:data-model-decode-failure","The server responded to the data model query, but the response failed to be decoded.  This typically occurs when the Knowledge JS API (4.26 or later) is used with an unsupported backend (11.0 or earlier)");return zr(a)}throw new _("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:i,data:r.data})}let ze=class extends Ee{constructor(t){super(t),this.openCypherQuery=""}};s([p()],ze.prototype,"openCypherQuery",void 0),ze=s([G("esri.rest.knowledgeGraph.GraphQuery")],ze);const gi=ze;let be=class extends gi{constructor(t){super(t),this.bindParameters=null,this.bindGeometryQuantizationParameters=null,this.outputQuantizationParameters=null}};s([p()],be.prototype,"bindParameters",void 0),s([p()],be.prototype,"bindGeometryQuantizationParameters",void 0),s([p()],be.prototype,"outputQuantizationParameters",void 0),be=s([G("esri.rest.knowledgeGraph.GraphQueryStreaming")],be);const Ne=be,x="ESRI__ID",Ie="ESRI__ORIGIN_ID",rt="ESRI__DESTINATION_ID",j="ESRI__LAYOUT_GEOMETRY",he=12,At=Te.getLogger("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager");let ie=class extends Ee{constructor(t){var i,n,o;super(t),this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this._processingCacheUpdatesLookup=new Map,this._memberIdTypeLookup=new Map;const r=new Map;(i=t.knowledgeGraph.dataModel.entityTypes)==null||i.forEach(a=>{var l,d;a.name&&(r.set(a.name,"entity"),this._processingCacheUpdatesLookup.set(a.name,[]),t.inclusionModeDefinition&&!((l=t.inclusionModeDefinition)!=null&&l.generateAllSublayers)||this.entityTypeNames.add(a.name),(d=a.properties)==null||d.forEach(u=>{u.geometryType&&u.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(a.name,{name:u.name??"",geometryType:u.geometryType})}))}),(n=t.knowledgeGraph.dataModel.relationshipTypes)==null||n.forEach(a=>{var l,d;a.name&&(r.set(a.name,"relationship"),this._processingCacheUpdatesLookup.set(a.name,[]),t.inclusionModeDefinition&&!((l=t.inclusionModeDefinition)!=null&&l.generateAllSublayers)||this.relationshipTypeNames.add(a.name),(d=a.properties)==null||d.forEach(u=>{u.geometryType&&u.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(a.name,{name:u.name??"",geometryType:u.geometryType})}))}),(o=t.inclusionModeDefinition)==null||o.namedTypeDefinitions.forEach((a,l)=>{var u,y;if(r.get(l)==="entity")this.entityTypeNames.add(l);else{if(r.get(l)!=="relationship")return At.warn(`A named type, ${l}, was in the inclusion list that wasn't in the data model and will be removed`),void((u=t.inclusionModeDefinition)==null?void 0:u.namedTypeDefinitions.delete(l));this.relationshipTypeNames.add(l)}const d=new Map;(y=a.members)==null||y.forEach(m=>{this._memberIdTypeLookup.set(m.id,l);const g=this.getById(m.id);g&&d.set(m.id,g)}),this.sublayerCaches.set(l,d)})}addToLayerInclusionSet(t){t.forEach(({typeName:r,id:i})=>{if(!this.inclusionModeDefinition)throw new _("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(r)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(r)){const n=this.inclusionModeDefinition.namedTypeDefinitions.get(r);if(n.useAllData)throw new _("knowledge-graph:layer-data-manager","You cannot add members to an exclusion list for a sublayer where the sublayer is set to always retrieve its entire data set");n.members||(n.members=new Map),n.members.set(i,{id:i}),this._memberIdTypeLookup.set(i,r)}}else{const n=new Map;n.set(i,{id:i}),this.inclusionModeDefinition.namedTypeDefinitions.set(r,{useAllData:!1,members:n}),this._memberIdTypeLookup.set(i,r)}})}getById(t){return We.getInstance().readFromStoreById(t)}async getData(t,r,i){var o,a;if(r.objectType.name&&((o=this.inclusionModeDefinition)!=null&&o.namedTypeDefinitions)&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(r.objectType.name))return[];let n;if(n=t||new fe({where:"1=1",outFields:["*"]}),r.parentCompositeLayer.type==="link-chart"){const l=r.parentCompositeLayer,d=this._processingCacheUpdatesLookup.get(r.objectType.name??""),u=n.outFields,y=n.geometry;let m="",g="";y&&y.extent&&(m=de(y.extent.ymin,y.extent.xmin,he),g=de(y.extent.ymax,y.extent.xmax,he)),u&&u.length===1&&u[0]===x&&n.where==="1=1"||await Promise.all(d??[]);const f=this.sublayerCaches.has(r.objectType.name??"")?Array.from((a=this.sublayerCaches.get(r.objectType.name))==null?void 0:a.values()):[],I=[];return f.forEach(b=>{if(b.geometry=l.linkChartDiagramLookup.get(b.attributes[r.objectIdField]),b.attributes[j]=b.geometry,m&&g){const h=l.linkChartGeohashLookup.get(b.attributes[r.objectIdField]);h?h>=m&&h<=g&&I.push(b):I.push(b)}else I.push(b)}),I}return this.retrieveDataFromService(n,r,i)}async getConnectedRecordIds(t){const r=[],i=[],n=new Map;return t.forEach(o=>{var a;if(this._memberIdTypeLookup.has(o)){const l=this._memberIdTypeLookup.get(o);if(!this.entityTypeNames.has(l))return;n.has(l)?(a=n.get(l))==null||a.push(o):n.set(l,[o])}}),n.forEach((o,a)=>{const l=`MATCH (n:${a})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`,d=new Promise(u=>{(async()=>{const y=(await Ze(this.knowledgeGraph,new Ne({openCypherQuery:l,bindParameters:{ids:o}}))).resultRowsStream.getReader();try{for(;;){const{done:m,value:g}=await y.read();if(m)break;for(let f=0;f<g.length;f++){const I=g[f];r.push({id:I[0],typeName:I[1]}),r.push({id:I[2],typeName:I[3]})}}}catch(m){if(m.name!=="AbortError")throw m;At.info("Request aborted as expected")}})().then(()=>{u()})});i.push(d)}),await Promise.all(i),r}async refreshCacheContent(t,r,i,n=!0){var u,y,m,g,f,I,b;const o=We.getInstance(),a=[],l=new Map,d=new Map;(u=this.knowledgeGraph.dataModel.entityTypes)==null||u.forEach(h=>{h.name&&d.set(h.name,h)}),(y=this.knowledgeGraph.dataModel.relationshipTypes)==null||y.forEach(h=>{h.name&&d.set(h.name,h)}),t||this.inclusionModeDefinition?t?t.forEach(h=>{var w;if(this._memberIdTypeLookup.has(h)){const L=this._memberIdTypeLookup.get(h);l.has(L)?(w=l.get(L))==null||w.push(h):l.set(L,[h])}}):(g=(m=this.inclusionModeDefinition)==null?void 0:m.namedTypeDefinitions)==null||g.forEach((h,w)=>{h.useAllData?l.set(w,null):h.members&&h.members.forEach(L=>{var O;l.has(w)&&l.get(w)!==null?(O=l.get(w))==null||O.push(L.id):l.set(w,[L.id])})}):((f=this.knowledgeGraph.dataModel.entityTypes)==null||f.forEach(h=>{h.name&&l.set(h.name,null)}),(I=this.knowledgeGraph.dataModel.entityTypes)==null||I.forEach(h=>{h.name&&l.set(h.name,null)}));for(const[h,w]of l){const L=new Promise(O=>{(async()=>{var V,M,R,z,S,T,B;const Y=new Set,K=[];let c,C="",v=!1;if(r||((M=(V=d.get(h))==null?void 0:V.properties)==null||M.forEach(D=>{D.name&&Y.add(D.name)})),i&&this.geographicLookup.has(h)){const D=(R=this.geographicLookup.get(h))==null?void 0:R.name;D&&Y.add(D)}if(this.entityTypeNames.has(h))C=`MATCH (n:${h}) ${w?"WHERE id(n) IN $ids ":""}return ID(n)`,Y.forEach(D=>{C+=`, n.${D}`,K.push(D)});else{if(!this.relationshipTypeNames.has(h))throw new _("knowledge-graph:layer-data-manager",`The graph type of ${h} could not be determined. Was this type set in the KG data model and inclusion definition?`);v=!0,C=`MATCH ()-[n:${h}]->() ${w?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,Y.forEach(D=>{C+=`, n.${D}`,K.push(D)})}c=new Ne(w?{openCypherQuery:C,bindParameters:{ids:w}}:{openCypherQuery:C});const Z=(await Ze(this.knowledgeGraph,c)).resultRowsStream.getReader();for(;;){const{done:D,value:X}=await Z.read();if(D)break;const Q=[];for(let E=0;E<X.length;E++){const q=X[E];let N=0,Ge=0;const ke={properties:{}};for(ke.id=q[N],N++,Ge++,v&&(ke.originId=q[N],N++,Ge++,ke.destinationId=q[N],N++,Ge++);N<q.length;N++)ke.properties[K[N-Ge]]=q[N];Q.push(ke)}const ee=o.writeToStore(Q,x,(z=this.geographicLookup.get(h))==null?void 0:z.name);this.sublayerCaches.has(h)||this.sublayerCaches.set(h,new Map),n&&!((S=this.inclusionModeDefinition)!=null&&S.namedTypeDefinitions.has(h))&&((T=this.inclusionModeDefinition)==null||T.namedTypeDefinitions.set(h,{useAllData:!1,members:new Map})),n&&!((B=this.inclusionModeDefinition)!=null&&B.namedTypeDefinitions.get(h).members)&&(this.inclusionModeDefinition.namedTypeDefinitions.get(h).members=new Map);const H=this.sublayerCaches.get(h);ee.forEach(E=>{var q,N;H==null||H.set(E.attributes[x],E),n&&!((q=this.inclusionModeDefinition)!=null&&q.namedTypeDefinitions.get(h).members.has(E.attributes[x]))&&((N=this.inclusionModeDefinition)==null||N.namedTypeDefinitions.get(h).members.set(E.attributes[x],{id:E.attributes[x]}),this._memberIdTypeLookup.set(E.attributes[x],h))})}})().then(()=>{O(null)})});a.push(L),(b=this._processingCacheUpdatesLookup.get(h))==null||b.push(L)}await Promise.all(a)}removeFromLayer(t){const r=new Set;t.forEach(i=>{var n;this._memberIdTypeLookup.get(i)&&r.add(this._memberIdTypeLookup.get(i)),this._memberIdTypeLookup.delete(i),(n=this.inclusionModeDefinition)==null||n.namedTypeDefinitions.forEach(o=>{var a;(a=o.members)!=null&&a.has(i)&&o.members.delete(i)})}),r.forEach(i=>{var n;(n=this.sublayerCaches.get(i))==null||n.forEach((o,a)=>{var l;t.includes(a)&&((l=this.sublayerCaches.get(i))==null||l.delete(a))})})}async retrieveDataFromService(t,r,i){var b,h,w,L,O,k,Y,K,c,C,v,Z,V,M,R,z;const n=We.getInstance(),o=new Set,a=[];let l,d="",u=[];const y=r.graphType==="relationship",m=(w=(h=(b=this.inclusionModeDefinition)==null?void 0:b.namedTypeDefinitions)==null?void 0:h.get(r.objectType.name))==null?void 0:w.useAllData,g=r.parentCompositeLayer.sublayerIdsCache.get(r.objectType.name);let f=!m&&g?Array.from(g).sort():null;if((k=(O=(L=this.inclusionModeDefinition)==null?void 0:L.namedTypeDefinitions)==null?void 0:O.get(r.objectType.name))!=null&&k.useAllData)(c=(K=(Y=this.inclusionModeDefinition)==null?void 0:Y.namedTypeDefinitions)==null?void 0:K.get(r.objectType.name))!=null&&c.useAllData&&t.objectIds!=null&&(f=t.objectIds);else if(t.objectIds!=null&&f&&f.length>0){const S=t.objectIds;t.objectIds=f.filter(T=>S.includes(T))}else if(t.objectIds!=null)f=t.objectIds;else{if((C=this.inclusionModeDefinition)!=null&&C.namedTypeDefinitions.has(r.objectType.name)&&(!((v=this.inclusionModeDefinition.namedTypeDefinitions.get(r.objectType.name))!=null&&v.members)||((V=(Z=this.inclusionModeDefinition.namedTypeDefinitions.get(r.objectType.name))==null?void 0:Z.members)==null?void 0:V.size)<1))return t.objectIds=[],[];t.objectIds=f}if(t.outFields!=null){const S=t.outFields;S.includes("*")?r.fields.forEach(T=>{o.add(T.name)}):S.forEach(T=>{T!==x&&T!==r.geometryFieldName&&o.add(T)})}if(t.geometry!=null){const S=t.geometry;let T;if((M=S==null?void 0:S.extent)!=null&&M.spatialReference&&!((R=S.spatialReference)!=null&&R.isWGS84)?(await Vt(S.extent.spatialReference,Qe),T=Wt(S.extent,Qe)):T=S.extent,t.where!=null&&t.where!=="1=1"){const B=await Rt(t.where.toUpperCase(),r.fieldsIndex);r.fields.forEach(D=>{B.fieldNames.includes(D.name)&&o.add(D.name)})}d=y?`Match ()-[n:${r.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${r.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${r.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${r.geometryFieldName}) return ID(n)`,r.geometryFieldName&&o.add(r.geometryFieldName),o.forEach(B=>{d+=`, n.${B}`,a.push(B)}),l=new Ne({openCypherQuery:d,bindParameters:{param_filter_geom:new xe({rings:[[[T.xmin,T.ymin],[T.xmin,T.ymax],[T.xmax,T.ymax],[T.xmax,T.ymin],[T.xmin,T.ymin]]]})}})}else{let S="";if(t.where!=null&&t.where!=="1=1"){const D=await Rt(t.where,r.fieldsIndex);r.fields.forEach(E=>{D.fieldNames.includes(E.name)&&o.add(E.name)});const X=["column-reference","string","number","binary-expression"],Q=["=","<","<=","<>",">",">=","AND","OR","LIKE"];let ee=!1;const H=E=>{if(E.type==="column-reference")return`n.${E.column}`;if(E.type==="string")return`'${E.value}'`;if(E.type==="number")return`${E.value}`;if(E.type==="binary-expression"&&X.includes(E.left.type)&&X.includes(E.right.type)&&Q.includes(E.operator))return`${H(E.left)} ${E.operator} ${H(E.right)}`;if(E.type==="binary-expression"&&E.operator==="LIKE"){let q="";if(E.left.type==="function"&&E.left.args.value[0].type==="column-reference")q+=`lower(n.${E.left.args.value[0].column})`;else{if(E.left.type!=="column-reference")return ee=!0,"";q+=`lower(n.${E.left.column})`}if(q+=" CONTAINS (",E.right.type!=="string")return ee=!0,"";{let N=E.right.value;N.charAt(0)==="%"&&(N=N.slice(1)),N.charAt(N.length-1)==="%"&&(N=N.slice(0,-1)),q+=`'${N.toLowerCase()}')`}return q}return ee=!0,""};S=H(D.parseTree),ee&&(S="")}let T="";T=y?`Match ()-[n:${r.objectType.name}]->()`:`Match (n:${r.objectType.name})`;let B=!1;f&&(B=!0,T+=" WHERE ID(n) IN $ids"),S&&(T+=B?" AND":" WHERE",T+=` ${S}`),T+=" return ID(n)",y&&(T+=", id(startNode(n)), id(endNode(n))"),t.returnGeometry&&r.geometryFieldName&&o.add(r.geometryFieldName),o.forEach(D=>{T+=`, n.${D}`,a.push(D)}),l=new Ne(f?{openCypherQuery:T,bindParameters:{ids:f}}:{openCypherQuery:T})}const I=(await Ze(r.parentCompositeLayer.dataManager.knowledgeGraph,l,i)).resultRowsStream.getReader();for(;;){const{done:S,value:T}=await I.read();if(S)break;const B=[];for(let D=0;D<T.length;D++){const X=T[D];let Q=0,ee=0;const H={properties:{}};for(H.id=X[Q],Q++,ee++,y&&(H.originId=X[Q],Q++,ee++,H.destinationId=X[Q],Q++,ee++);Q<X.length;Q++)H.properties[a[Q-ee]]=X[Q];B.push(H)}u=u.concat(n.writeToStore(B,x,(z=r.parentCompositeLayer.dataManager.geographicLookup.get(r.objectType.name))==null?void 0:z.name))}return u}};s([p()],ie.prototype,"knowledgeGraph",void 0),s([p()],ie.prototype,"inclusionModeDefinition",void 0),s([p()],ie.prototype,"entityTypeNames",void 0),s([p()],ie.prototype,"relationshipTypeNames",void 0),s([p()],ie.prototype,"geographicLookup",void 0),s([p()],ie.prototype,"sublayerCaches",void 0),ie=s([G("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],ie);const zt=Ir(),wi=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return s([p(zt.fields)],t.prototype,"fields",void 0),s([p(zt.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=s([G("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],t),t};let $=class extends Cr(wi(Zt(Xt(Lr(Kt))))){constructor(e){var t,r,i,n,o;if(super(e),this.capabilities=Mr(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=x,this.objectType=null,this.parentCompositeLayer=null,this.popupTemplate=null,this.source={openPorts:()=>this.load().then(()=>{const a=new MessageChannel;return new gr(a.port1,{channel:a,client:{queryFeatures:(l,d={})=>{const u=fe.fromJSON(l);return this.queryFeaturesJSON(u,d)}}},()=>null),[a.port2]})},this.type="knowledge-graph-sublayer",e.parentCompositeLayer.type==="link-chart")e.graphType==="relationship"?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=j;else if((t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name))!=null&&t.geometryType&&((r=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name))==null?void 0:r.geometryType)!=="esriGeometryNull"){const a=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=(a==null?void 0:a.name)??null,this.geometryType=a!=null&&a.geometryType?ye.fromJSON(a.geometryType):null;const l=a==null?void 0:a.name,d=l?(i=e.objectType.properties)==null?void 0:i[l]:null;d?(this.hasM=d.hasM??!1,this.hasZ=d.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;(n=e.objectType.properties)==null||n.forEach(a=>{let l=null,d=a.fieldType;d==="esriFieldTypeOID"&&(d="esriFieldTypeInteger"),this.fields.push(St.fromJSON({name:a.name,type:d,alias:a.alias,defaultValue:l,editable:a.editable,nullable:a.nullable}))}),this.fields.push(St.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this._set("fields",[...this.fields]),(o=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel)!=null&&o.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),e.parentCompositeLayer.type==="link-chart"?e.graphType==="relationship"?this.renderer=Je(Ve(ye.toJSON("polyline")).renderer):this.renderer=Je(Ve(ye.toJSON("point")).renderer):this.renderer=Je(Ve(ye.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){wr(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return xr(this,e)}createQuery(){return new fe({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];throw new Error("Field not found")}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(e),n=vr.fromJSON(await i.executeQuery(r.toJSON(),t==null?void 0:t.signal));return n.features.forEach(o=>{o.sourceLayer=this}),n}async queryFeaturesJSON(e,t){const{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(e);return await i.executeQuery(r.toJSON(),t==null?void 0:t.signal)}async queryFeatureCount(e,t){const{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(e);return i.executeQueryForCount(r.toJSON(),t==null?void 0:t.signal)}async queryExtent(e={},t){var l,d,u,y;const r={...e,returnGeometry:!0},{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(r),o=await n.executeQueryForExtent(i.toJSON(),t==null?void 0:t.signal);let a;return a=((l=o.extent)==null?void 0:l.xmin)!=null&&((d=o.extent)==null?void 0:d.xmax)!=null&&((u=o.extent)==null?void 0:u.ymin)!=null&&((y=o.extent)==null?void 0:y.ymax)!=null?new Ue(o.extent):new Ue,{count:o.count,extent:a}}async queryObjectIds(e,t){const r=fe.from(e);let i;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const n=await this.parentCompositeLayer.dataManager.getData(r,this,t);i=this.loadQueryEngine(n)}return i.executeQueryForIds(r.toJSON(),t==null?void 0:t.signal)}loadQueryEngine(e){const t=new Er({geometryType:ye.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),r=new kr({fields:this.fields.map(i=>i.toJSON()),geometryType:ye.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return r.featureStore.addMany(e),r}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new fe({where:"1=1",outFields:[x]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){var o;const r=fe.from(e),i=r.geometry;let n;if(i&&!((o=i.spatialReference)!=null&&o.isWGS84)&&(await Vt(i.spatialReference,Qe),r.geometry=Wt(i instanceof xe||i instanceof ce?i:i.extent,Qe)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{const a=await this.parentCompositeLayer.dataManager.getData(r,this,t);n=this.loadQueryEngine(a)}return{resolvedQuery:r,queryEngine:n}}};s([p()],$.prototype,"capabilities",void 0),s([p({readOnly:!0})],$.prototype,"defaultPopupTemplate",null),s([p()],$.prototype,"definitionExpression",void 0),s([p()],$.prototype,"displayField",void 0),s([p()],$.prototype,"elevationInfo",void 0),s([p()],$.prototype,"geometryType",void 0),s([p()],$.prototype,"geometryFieldName",void 0),s([p()],$.prototype,"graphType",void 0),s([p()],$.prototype,"hasM",void 0),s([p()],$.prototype,"hasZ",void 0),s([p()],$.prototype,"labelsVisible",void 0),s([p()],$.prototype,"labelingInfo",void 0),s([p()],$.prototype,"objectIdField",void 0),s([p()],$.prototype,"objectType",void 0),s([p()],$.prototype,"parentCompositeLayer",void 0),s([p({type:_r,json:{name:"popupInfo",write:!0}})],$.prototype,"popupTemplate",void 0),s([p({types:Tr,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],$.prototype,"renderer",null),s([p()],$.prototype,"source",void 0),s([p({json:{read:!1}})],$.prototype,"type",void 0),$=s([G("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],$);const it=$;let nt,U=null;function _i(){return nt||(nt=at(()=>import("./lclayout-4d0275ad.js"),["./lclayout-4d0275ad.js","./index-e8c6bcc0.js","./index-0da2eac5.css"],import.meta.url).then(e=>e.l).then(({default:e})=>e({locateFile:t=>ot(`esri/libs/linkchartlayout/${t}`)})).then(e=>{bi(e)}),nt)}function bi(e){U=e}var te;function me(e,t,r,i,n,o){const a=r.length,l=n.length,d=Float64Array.BYTES_PER_ELEMENT,u=Uint32Array.BYTES_PER_ELEMENT,y=Uint8Array.BYTES_PER_ELEMENT,m=16,g=m-1+a*(y+2*d)+l*(2*u),f=U._malloc(g);try{const I=f+m-f%m,b=I+a*d,h=b+a*d,w=h+l*u,L=w+l*u,O=()=>[U.HEAPF64.subarray(I>>3,(I>>3)+a),U.HEAPF64.subarray(b>>3,(b>>3)+a),U.HEAPU32.subarray(h>>2,(h>>2)+l),U.HEAPU32.subarray(w>>2,(w>>2)+l),U.HEAPU8.subarray(L,L+a)],[k,Y,K,c,C]=O();k.set(r),Y.set(i),K.set(n),c.set(o),C.set(t);const v=e(a,L,I,b,l,h,w),[Z,V,M,R,z]=O();return r.set(Z),i.set(V),n.set(M),o.set(R),t.set(z),v}finally{U._free(f)}}(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"})(te||(te={}));const Qt=2,Ut=1,qt=-1;var yt,mt,ft,gt,wt,_t,Yt,Bt;(function(e){function t(){return U.getMinIdealEdgeLength()}function r(i,n,o,a,l,d=Qt,u=Ut,y=qt){return me((m,g,f,I,b,h,w)=>U.applyForceDirectedLayout(m,g,f,I,b,h,w,d,u,y),i,n,o,a,l)}e.getMinIdealEdgeLength=t,e.apply=r})(yt||(yt={})),function(e){function t(r,i,n,o,a,l=Qt,d=Ut,u=qt){return me((y,m,g,f,I,b,h)=>U.applyCommunityLayout(y,m,g,f,I,b,h,l,d,u),r,i,n,o,a)}e.apply=t}(mt||(mt={})),function(e){function t(r,i,n,o,a){return me(U.applySimpleLayout,r,i,n,o,a)}e.apply=t}(ft||(ft={})),function(e){function t(r,i,n,o,a){return me(U.applyHierarchicalLayout,r,i,n,o,a)}e.apply=t}(gt||(gt={})),function(e){function t(r,i,n,o,a){return me(U.applyRadialTreeLayout,r,i,n,o,a)}e.apply=t}(wt||(wt={})),function(e){function t(r,i,n,o,a){return me(U.applySmartTreeLayout,r,i,n,o,a)}e.apply=t}(_t||(_t={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(Yt||(Yt={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(Bt||(Bt={}));const Ti=(e,t,r)=>(e.has(t)||e.set(t,r()),e.get(t));let A=class extends Zt(Xt(Kt)){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE",xScaleFactor:1,yScaleFactor:1},this._graphTypeLookup=new Map,this.layers=new xt,this.linkChartDiagramLookup=new Map,this.linkChartExtent=new Ue({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.sublayerIdsCache=new Map,this.tables=new xt,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new _("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){var o,a,l,d,u,y;if(!this.title&&this.url){const m=this.url.split("/");this.title=m[m.length-2]}const t=new Set;let r=[],i=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new _("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");(o=e.knowledgeGraph.dataModel.entityTypes)==null||o.forEach(m=>{m.name&&this._graphTypeLookup.set(m.name,m)}),(a=e.knowledgeGraph.dataModel.relationshipTypes)==null||a.forEach(m=>{m.name&&this._graphTypeLookup.set(m.name,m)}),(l=e.inclusionModeDefinition)!=null&&l.generateAllSublayers?(r=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]):(d=e.inclusionModeDefinition)!=null&&d.namedTypeDefinitions&&((u=e.inclusionModeDefinition)==null?void 0:u.namedTypeDefinitions.size)>0?(y=e.inclusionModeDefinition)==null||y.namedTypeDefinitions.forEach((m,g)=>{var f,I;if(!this._graphTypeLookup.get(g))return Te.getLogger(this).warn(`A named type, ${g}, was in the inclusion list that wasn't in the data model and will be removed`),void((f=e.inclusionModeDefinition)==null?void 0:f.namedTypeDefinitions.delete(g));this._graphTypeLookup.get(g)instanceof Et||"strictOrigin"in this._graphTypeLookup.get(g)?t.has(g)||(t.add(g),i.push(this._graphTypeLookup.get(g))):this._graphTypeLookup.get(g)instanceof Tt||"properties"in this._graphTypeLookup.get(g)?t.has(g)||(t.add(g),r.push(this._graphTypeLookup.get(g))):(Te.getLogger(this).warn(`A named type, ${g}, was in the inclusion list that wasn't properly modeled and will be removed`),(I=e.inclusionModeDefinition)==null||I.namedTypeDefinitions.delete(g))}):(r=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]);const n=new ie({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=r,this.memberRelationshipTypes=i,this.dataManager=n}load(e){return this.addResolvingPromise(new Promise(t=>{di(this.url).then(r=>{var i,n,o,a,l,d;if(this._initializeLayerProperties({knowledgeGraph:r,inclusionModeDefinition:this._originalInclusionList}),(n=(i=this.dataManager.inclusionModeDefinition)==null?void 0:i.namedTypeDefinitions)!=null&&n.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},(o=this.dataManager.knowledgeGraph.dataModel.entityTypes)==null||o.forEach(u=>{var y;u.name&&((y=this.dataManager.inclusionModeDefinition)==null||y.namedTypeDefinitions.set(u.name,{useAllData:!0}))}),(a=this.dataManager.knowledgeGraph.dataModel.relationshipTypes)==null||a.forEach(u=>{var y;u.name&&((y=this.dataManager.inclusionModeDefinition)==null||y.namedTypeDefinitions.set(u.name,{useAllData:!0}))})),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),(l=this.dataManager.inclusionModeDefinition)==null||l.namedTypeDefinitions.forEach(u=>{var y;u.useAllData=!1,(y=u.members)==null||y.forEach(m=>{let g;g=m.linkChartLocation instanceof Gt?m.linkChartLocation:m.linkChartLocation?se(m.linkChartLocation):null,this.linkChartDiagramLookup.set(m.id,g),g&&g.coords.length===2&&g.lengths.length===0?this.linkChartGeohashLookup.set(m.id,de(g.coords[1],g.coords[0],he)):this.linkChartGeohashLookup.set(m.id,"")}),this.addResolvingPromise(this._initializeDiagram().then(async()=>{this.layers.forEach(async m=>{await m.refreshCachedQueryEngine()}),this.tables.forEach(async m=>{await m.refreshCachedQueryEngine()})}))});else{const u=((d=this.defaultLinkChartConfig)==null?void 0:d.layoutMode)==="GEOGRAPHIC";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,u,!0).then(async()=>{br(e);const y=[],m=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach(g=>{g.useAllData=!1})),await this._initializeDiagram(),this.layers.forEach(g=>{m.push(g.refreshCachedQueryEngine()),y.push(new Promise(f=>{g.on("layerview-create",()=>{f(null)})}))}),this.tables.forEach(g=>{m.push(g.refreshCachedQueryEngine())}),await Promise.all(m)}))}t(null)})})),Promise.resolve(this)}async addRecords(e){await this._handleNewRecords(e)}async expand(e){const t=await this.dataManager.getConnectedRecordIds(e),r=t.filter(i=>{var n;return!((n=this.sublayerIdsCache.get(i.typeName))!=null&&n.has(i.id))});return await this._handleNewRecords(t),{records:r}}loadLayerAssumingLocalCache(){var e,t;this.memberRelationshipTypes.forEach(r=>{const i=new it({objectType:r,parentCompositeLayer:this,graphType:"relationship",title:r.name});i.geometryType?this.layers.push(i):this.tables.push(i),this.dataManager.sublayerCaches.has(r.name)||this.dataManager.sublayerCaches.set(r.name,new Map)}),this.memberEntityTypes.forEach(r=>{const i=new it({objectType:r,parentCompositeLayer:this,graphType:"entity",title:r.name});i.geometryType?this.layers.push(i):this.tables.push(i),this.dataManager.sublayerCaches.has(r.name)||this.dataManager.sublayerCaches.set(r.name,new Map)}),(e=this.dataManager.inclusionModeDefinition)!=null&&e.namedTypeDefinitions&&((t=this.dataManager.inclusionModeDefinition)==null||t.namedTypeDefinitions.forEach((r,i)=>{var o;const n=Ti(this.sublayerIdsCache,i,()=>new Set);(o=r.members)==null||o.forEach(a=>{if(n.add(a.id),a.linkChartLocation)if(a.linkChartLocation instanceof Gt)this.linkChartDiagramLookup.set(a.id,a.linkChartLocation),a.linkChartLocation.coords.length===2&&a.linkChartLocation.lengths.length===0?this.linkChartGeohashLookup.set(a.id,de(a.linkChartLocation.coords[1],a.linkChartLocation.coords[0],he)):this.linkChartGeohashLookup.set(a.id,"");else{const l=se(a.linkChartLocation);this.linkChartDiagramLookup.set(a.id,a.linkChartLocation?l:null),"x"in a.linkChartLocation&&"y"in a.linkChartLocation?this.linkChartGeohashLookup.set(a.id,de(a.linkChartLocation.x,a.linkChartLocation.y,he)):this.linkChartGeohashLookup.set(a.id,"")}})}))}async calculateLinkChartLayout(e="RADIAL_TREE",t){const r=[],i=[];this.dataManager.sublayerCaches.forEach((c,C)=>{this.dataManager.entityTypeNames.has(C)?c.forEach(v=>{r.push({typeName:C,feature:v})}):this.dataManager.relationshipTypeNames.has(C)&&c.forEach(v=>{i.push({typeName:C,feature:v})})}),this.linkChartDiagramLookup=new Map;const n=new Map,o=new Map,a=new Map,l=new Map,d=new Uint8Array(r.length),u=new Float64Array(r.length),y=new Float64Array(r.length),m=new Uint32Array(i.length),g=new Uint32Array(i.length),f=[],I="FORCE_DIRECTED",b=(t==null?void 0:t.xScaleFactor)??1,h=(t==null?void 0:t.yScaleFactor)??1,w=new Ue({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let L,O="FORCE_DIRECTED",k=0,Y=0;switch(O=e==="GEOGRAPHIC"?I:e,O){case"FORCE_DIRECTED":L=yt.apply;break;case"COMMUNITY":L=mt.apply;break;case"HIERARCHICAL":L=gt.apply;break;case"RADIAL_TREE":L=wt.apply;break;case"SMART_TREE":L=_t.apply;break;default:L=ft.apply}r.forEach(({typeName:c,feature:C})=>{var v,Z,V;if((v=t==null?void 0:t.lockedNodeLocations)!=null&&v.has(C.attributes[x])){e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(c)?d[k]=te.IsGeographic:d[k]=te.None;const M=t.lockedNodeLocations.get(C.attributes[x]);u[k]=M.x,y[k]=M.y}else if(e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(c)){d[k]=te.IsGeographic;let M=null;const R=C.attributes[this.dataManager.geographicLookup.get(c).name];switch((Z=this.dataManager.geographicLookup.get(c))==null?void 0:Z.geometryType){case"esriGeometryPoint":u[k]=R==null?void 0:R.x,y[k]=R==null?void 0:R.y;break;case"esriGeometryPolygon":M=R==null?void 0:R.centroid,(M==null?void 0:M.x)!=null&&(M==null?void 0:M.y)!=null?(u[k]=M.x,y[k]=M.y):d[k]=te.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":M=(V=R==null?void 0:R.extent)==null?void 0:V.center,(M==null?void 0:M.x)!=null&&(M==null?void 0:M.y)!=null?(u[k]=M.x,y[k]=M.y):d[k]=te.IsMovable;break;default:d[k]=te.IsMovable}(u[k]==null||y[k]==null||Number.isNaN(u[k])||Number.isNaN(y[k]))&&(d[k]=te.IsMovable,u[k]=0,y[k]=0)}else d[k]=te.IsMovable,u[k]=0,y[k]=0;l.set(C.attributes[x],k),f[k]={feature:C,typeName:c},k++});let K=!1;if(i.forEach(c=>{const C=l.get(c.feature.attributes[Ie]),v=l.get(c.feature.attributes[rt]);C!==void 0&&v!==void 0?(m[Y]=C,g[Y]=v,Y++):(K=!0,this.linkChartDiagramLookup.set(c.feature.attributes[Ie],null),this.linkChartGeohashLookup.set(c.feature.attributes[Ie],null))}),K&&Te.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await _i(),!L(d,u,y,m,g))throw new _("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let c=0;c<f.length;c++){if(d[c]===te.IsMovable&&(u[c]=u[c]*b,y[c]=y[c]*h),y[c]>84.9999&&(y[c]=84.9999),y[c]<-84.9999&&(y[c]=-84.9999),u[c]>179.9999&&(u[c]=179.9999),u[c]<-179.9999&&(u[c]=-179.9999),f[c].feature.attributes[j]=new ve(u[c],y[c]),n.has(f[c].typeName)){const v=n.get(f[c].typeName);v==null||v.set(f[c].feature.attributes[x],f[c].feature)}else{const v=new Map;v.set(f[c].feature.attributes[x],f[c].feature),n.set(f[c].typeName,v)}a.set(f[c].feature.attributes[x],f[c].feature);const C=se(f[c].feature.attributes[j]);this.linkChartDiagramLookup.set(f[c].feature.attributes[x],f[c].feature.attributes[j]?C:null),this.linkChartGeohashLookup.set(f[c].feature.attributes[x],de(f[c].feature.attributes[j].y,f[c].feature.attributes[j].x,he)),f[c].feature.attributes[j].x<w.xmin&&(w.xmin=f[c].feature.attributes[j].x),f[c].feature.attributes[j].x>w.xmax&&(w.xmax=f[c].feature.attributes[j].x),f[c].feature.attributes[j].y<w.ymin&&(w.ymin=f[c].feature.attributes[j].y),f[c].feature.attributes[j].y>w.ymax&&(w.ymax=f[c].feature.attributes[j].y)}return this.linkChartExtent.xmin=w.xmin,this.linkChartExtent.xmax=w.xmax,this.linkChartExtent.ymin=w.ymin,this.linkChartExtent.ymax=w.ymax,i.forEach(c=>{var M,R;const C=(M=f[l.get(c.feature.attributes[Ie])])==null?void 0:M.feature.attributes[j],v=(R=f[l.get(c.feature.attributes[rt])])==null?void 0:R.feature.attributes[j];if(!C||!v)return;const Z=new ce({paths:[[C.x,C.y],[v.x,v.y]]});if(c.feature.attributes[j]=Z,o.has(c.typeName)){const z=o.get(c.typeName);z==null||z.set(c.feature.attributes[x],c.feature)}else{const z=new Map;z.set(c.feature.attributes[x],c.feature),o.set(c.typeName,z)}a.set(c.feature.attributes[x],c.feature);const V=se(c.feature.attributes[j]);this.linkChartDiagramLookup.set(c.feature.attributes[x],c.feature.attributes[j]?V:null),this.linkChartGeohashLookup.set(c.feature.attributes[x],"")}),this._currentLinkChartConfig={layoutMode:e,xScaleFactor:b,yScaleFactor:h},{nodes:n,links:o,idMap:a}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const r=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach(i=>{r.push(i.refreshCachedQueryEngine())}),await Promise.all(r),this.layers.forEach(i=>{i.emit("refresh",{dataChanged:!0})})}getCurrentNodeLocations(){var t,r;const e=new Map;return(r=(t=this.dataManager.inclusionModeDefinition)==null?void 0:t.namedTypeDefinitions)==null||r.forEach(i=>{var n;(n=i==null?void 0:i.members)==null||n.forEach(o=>{const a=o.linkChartLocation;let l;const d=o.id;a&&(l="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]},e.set(d,new ve({x:l.x,y:l.y})))})}),e}async synchronizeInclusionListWithCache(){return new Promise(e=>{var t;(t=this.dataManager.inclusionModeDefinition)==null||t.namedTypeDefinitions.forEach((r,i)=>{if(r.useAllData=!1,r.members&&r.members.size>0){if(!this.dataManager.sublayerCaches.get(i))return;const n=Array.from(this.dataManager.sublayerCaches.get(i).keys());Array.from(r.members.keys()).filter(o=>!n.includes(o)).forEach(o=>{var a;(a=r.members)==null||a.delete(o)})}}),e()})}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach(r=>{t.push(r.refreshCachedQueryEngine())}),await Promise.all(t),this.layers.forEach(r=>{r.emit("refresh",{dataChanged:!0})})}async _handleNewRecords(e){const t=[];this.dataManager.addToLayerInclusionSet(e);for(const r of e)this.sublayerIdsCache.has(r.typeName)||(this.sublayerIdsCache.set(r.typeName,new Set),t.push(r.typeName)),this.sublayerIdsCache.get(r.typeName).add(r.id);for(const r of t)if(this._graphTypeLookup.has(r)){const i=this._graphTypeLookup.get(r),n="endPoints"in i?"relationship":"entity",o=new it({objectType:i,parentCompositeLayer:this,graphType:n,title:r});n==="entity"?this.dataManager.entityTypeNames.add(r):this.dataManager.relationshipTypeNames.add(r),o.geometryType?this.layers.push(o):this.tables.push(o),this.dataManager.sublayerCaches.set(r,new Map)}await this.dataManager.refreshCacheContent(e.map(r=>r.id)),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,{xScaleFactor:this._currentLinkChartConfig.xScaleFactor,yScaleFactor:this._currentLinkChartConfig.xScaleFactor})}async _initializeDiagram(){var e,t;this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?((t=(e=this.dataManager.inclusionModeDefinition)==null?void 0:e.namedTypeDefinitions)==null||t.forEach(r=>{var i;(i=r==null?void 0:r.members)==null||i.forEach(n=>{const o=n.linkChartLocation;let a;const l=n.id;if(!o)return;a="x"in o?{x:o.x,y:o.y}:{x:o.coords[0],y:o.coords[1]};const d=se(a);this.linkChartDiagramLookup.set(l,d),this.linkChartGeohashLookup.set(l,de(a.x,a.y,he)),this.linkChartExtent.xmin>a.x&&(this.linkChartExtent.xmin=a.x),this.linkChartExtent.xmax<a.x&&(this.linkChartExtent.xmax=a.x),this.linkChartExtent.ymin>a.y&&(this.linkChartExtent.ymin=a.y),this.linkChartExtent.ymax<a.y&&(this.linkChartExtent.ymax=a.y)})}),this.memberRelationshipTypes.forEach(r=>{var i;r.name&&((i=this.dataManager.sublayerCaches.get(r.name))==null||i.forEach(n=>{const o=this.linkChartDiagramLookup.get(n.attributes[Ie]),a=this.linkChartDiagramLookup.get(n.attributes[rt]);if(o&&a){const l=se(new ce({paths:[[o.coords[0],o.coords[1]],[a.coords[0],a.coords[1]]]}));this.linkChartDiagramLookup.set(n.attributes[x],l)}else this.linkChartDiagramLookup.set(n.attributes[x],null);this.linkChartGeohashLookup.set(n.attributes[x],"")}))})):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{xScaleFactor:this.defaultLinkChartConfig.xScaleFactor,yScaleFactor:this.defaultLinkChartConfig.yScaleFactor,lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}};s([p()],A.prototype,"dataPreloadedInLocalCache",void 0),s([p()],A.prototype,"defaultLinkChartConfig",void 0),s([p()],A.prototype,"dataManager",void 0),s([p()],A.prototype,"knowledgeGraph",void 0),s([p()],A.prototype,"layers",void 0),s([p()],A.prototype,"linkChartDiagramLookup",void 0),s([p()],A.prototype,"linkChartExtent",void 0),s([p()],A.prototype,"linkChartGeohashLookup",void 0),s([p()],A.prototype,"memberEntityTypes",void 0),s([p()],A.prototype,"memberRelationshipTypes",void 0),s([p()],A.prototype,"sublayerIdsCache",void 0),s([p()],A.prototype,"tables",void 0),s([p({json:{read:!1}})],A.prototype,"type",void 0),A=s([G("esri.layers.LinkChartLayer")],A);const Vn=A;export{Vn as default};
