import"./geometry-D964gYQX.js";import{d as j}from"./Graphic-DsxsIjhH.js";import{R as M}from"./Accessor-BLX9ikPh.js";import{f as V,g as A}from"./screenUtils-_ZIvrt5o.js";import{n as F}from"./vec3f64-BLpZdpfb.js";import{n as b}from"./projectVectorToVector-G2uWGoIb.js";import{o as G}from"./LayerConstants-B33OP6sh.js";import{m as T}from"./layerUtils-BrNoooE9.js";import{t as H}from"./Material-_xx7OZxD.js";import{a as W}from"./ElevationProvider-C95wyCKc.js";import{T as C}from"./dehydratedFeatureUtils-B--Sgpdi.js";import{e as E,a as X,i as k}from"./intersectorUtils-BK9EUwUf.js";import{f as D,h as N}from"./intersectorUtilsConversions-D_fcRVdX.js";import{w as U}from"./verticalOffsetUtils-BDQLpfho.js";import{g as R,j as z}from"./Point-Cg0-ChZE.js";async function ue(e,t,n,i){const r=n?_(e,n):i,c=V(t.x,t.y);r.requiresGroundFeedback=!0,r.enableDraped=!0;const o=C(e.state.viewingMode);o.options.selectionMode=!0,o.options.store=E.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(c,o,r);const u=q(e,o.results.all,r.graphics),s=o.results.ground,a=D(s,e),d=a!=null&&"type"in a&&T(a.type)?a:null,l={screenPoint:t,results:u,ground:{mapPoint:m(e,s),distance:X(s)?s.distanceInRenderSpace:0,layer:d}};return H.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(l.intersector=o),l}function de(e,t,n,i){var d,l,S,x,w;const r=n?_(e,n):i,c=!(!((d=r.graphics)!=null&&d.include)&&!((l=r.graphics)!=null&&l.exclude)),o=!(!((S=r.mediaElements)!=null&&S.include)&&!((x=r.mediaElements)!=null&&x.exclude)),u=A(t);r.enableDraped=r.include&&!r.include.has(U)||((w=r.exclude)==null?void 0:w.has(U));const s=e.sceneIntersectionHelper,a=C(e.state.viewingMode);if(a.options.selectionMode=!0,a.options.store=c||o?E.ALL:E.MIN,a.options.excludeLabels=(n==null?void 0:n.excludeLabels)??!1,s.intersectIntersectorScreen(u,a,r),c||o){for(const y of a.results.all){const h=N(y,e);if(h==null||c&&(h.type!=="graphic"||v(r.graphics,h.graphic))||o&&(h.type!=="media"||P(r.mediaElements,h.element)))return m(e,y)}return null}return m(e,a.results.min)}function q(e,t,n){const i=new Array;let r=null;for(let c=0;c<t.length;c++){const o=t[c],u=D(o,e);if(u!=null&&(u===e.map.ground||"type"in u&&T(u.type)))break;const s=N(o,e);if(s==null)continue;if(s.type==="graphic"){if(r==null&&c!==t.length-1&&(r=new Set),r!=null){const l=L(s.graphic);if(r.has(l))continue;r.add(l)}if(!v(n,s.graphic))continue}const a=m(e,o),d=o.distanceInRenderSpace;if(s.type==="media"){const l=s.element.toSource(a);i.push({...s,mapPoint:a,distance:d,sourcePoint:l})}else i.push({...s,mapPoint:a,distance:d})}return i}function m(e,t,n){return t.getIntersectionPoint(f)?(n=O(e,f,n),t.intersector===k.TERRAIN&&e.basemapTerrain&&(n.z=W(e.basemapTerrain,n)??0),n):null}function L(e){var r;const t=e.sourceLayer,n=e.layer,i=t&&"objectIdField"in t?t:n&&"objectIdField"in n?n:t;if(i){const c=i.objectIdField??G,o=(r=e.attributes)==null?void 0:r[c];if(o)return`o-${i.id}-${o}`}return`u-${e.uid}`}function v(e,t){return P(e,L(t))}function P(e,t){return e==null||(e.include==null||e.include.has(t))&&(e.exclude==null||!e.exclude.has(t))}function O(e,t,n){let i=e.spatialReference||R.WGS84;return b(t,e.renderSpatialReference,f,i)?t=f:(i=R.WGS84,b(t,e.renderSpatialReference,f,i)&&(t=f)),n?(n.x=t[0],n.y=t[1],n.z=t[2],n.spatialReference=i):n=new z(t,i),n}function _(e,t){const n=I(e,t.include,g.INCLUDE),i=I(e,t.exclude,g.EXCLUDE);return{include:n.layerUids,exclude:i.layerUids,graphics:{include:n.graphicUids,exclude:i.graphicUids},mediaElements:{include:n.mediaElements,exclude:i.mediaElements}}}function I(e,t,n,i={layerUids:void 0,graphicUids:void 0,mediaElements:void 0}){if(!t)return i;if(t instanceof j)B(i,L(t)),n===g.INCLUDE&&(e.graphicsView!=null&&t.layer===e?p(i,e.graphicsView.processor.layer.id):t.layer&&p(i,t.layer.uid));else if("layer"in t&&"element"in t)J(i,t.element),n===g.INCLUDE&&p(i,t.layer.uid);else if(M(t))for(const r of t)r===e.graphics&&e.graphicsView!=null?p(i,e.graphicsView.processor.layer.id):r===e.map.ground?p(i,U):I(e,r,n,i);else"uid"in t&&p(i,t.uid);return i}function p(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function B(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}function J(e,t){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(t)}const f=F();var g;(function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"})(g||(g={}));class pe{constructor(t){this._store=t}destroy(){this._store.destroy()}get(t){return this._store.get(t)}put(t,n){this._store.put(t,n,n.values.byteLength+256)}}export{_ as R,ue as U,de as b,pe as t,O as x};
