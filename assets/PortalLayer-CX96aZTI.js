const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./layersLoader-D4ZBUOPl.js","./subclass-BR3PhgZG.js","./arcgisLayerUrl-ETqee4Bd.js","./assets-BNizZMOZ.js","./index-BVncS3aY.js","./index-CjOb8WjV.css","./Evented-CXIxDjmW.js","./Accessor-D6mNnsWy.js","./persistableUrlUtils-Dx61-x4K.js","./lazyLayerLoader-Dvz94v5M.js","./requestPresets-xNTV8VKT.js","./portalLayers-C03kizKz.js","./associatedFeatureServiceUtils-DrLOVkk4.js","./Portal-DCqdz-K4.js","./Promise-CZrWwByK.js","./jsonMap-DCC6W5ex.js","./writer-3zufXUNV.js","./Extent-B4rrMrqp.js","./Point-TlcsOcXV.js","./PortalItem-CaeKabGc.js","./layerUtils-BzjQnEdj.js","./portalItemUtils-C4O2jNL5.js","./projection-tSh-0UvX.js","./reactiveUtils-BFQ0BtrB.js","./shared-B3wH2qpO.js","./mathUtils-ClvKsMak.js","./Polyline-BQFeqYXi.js","./projectBuffer-iyGwL2dv.js","./geodesicConstants-kj1AtlGg.js","./layersCreator-pwoFFBtV.js","./styleUtils-BATHgMyw.js","./jsonContext-CAJ7-auS.js"])))=>i.map(i=>d[i]);
import{_ as w}from"./index-BVncS3aY.js";import{e as o}from"./Evented-CXIxDjmW.js";import{y as m,b as E,n as U,s as $,c as b}from"./subclass-BR3PhgZG.js";import{W as H,t as g,N as F,K as I,U as L}from"./assets-BNizZMOZ.js";import{_ as T}from"./reactiveUtils-BFQ0BtrB.js";import{u as O,s as S,b as D,a as n}from"./Accessor-D6mNnsWy.js";import{o as M,r as R}from"./writer-3zufXUNV.js";import{x as k}from"./layerUtils-BzjQnEdj.js";import{C as v,a as x}from"./Portal-DCqdz-K4.js";import y from"./PortalItem-CaeKabGc.js";import{p as P}from"./portalItemUtils-C4O2jNL5.js";const G=_=>{let a=class extends _{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1}destroy(){this.portalItem=O(this.portalItem),this.resourceReferences.portalItem=null,this.resourceReferences.paths.length=0}set portalItem(r){r!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",r))}readPortalItem(r,t,e){if(t.itemId)return new y({id:t.itemId,portal:e==null?void 0:e.portal})}writePortalItem(r,t){r!=null&&r.id&&(t.itemId=r.id)}async loadFromPortal(r,t){var e;if((e=this.portalItem)!=null&&e.id)try{const{load:i}=await w(()=>import("./layersLoader-D4ZBUOPl.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31]),import.meta.url);return S(t),await i({instance:this,supportedTypes:r.supportedTypes,validateItem:r.validateItem,supportsData:r.supportsData,layerModuleTypeMap:r.layerModuleTypeMap},t)}catch(i){throw D(i)||U.getLogger(this).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})
  ${i}`),i}}async finishLoadEditablePortalLayer(r){this._set("userHasEditingPrivileges",await this._fetchUserHasEditingPrivileges(r).catch(t=>(n(t),!0)))}async setUserPrivileges(r,t){if(!$.userPrivilegesApplied)return this.finishLoadEditablePortalLayer(t);if(this.url)try{const{features:{edit:e,fullEdit:i},content:{updateItem:s}}=await this._fetchUserPrivileges(r,t);this._set("userHasEditingPrivileges",e),this._set("userHasFullEditingPrivileges",i),this._set("userHasUpdateItemPrivileges",s)}catch(e){n(e)}}async _fetchUserPrivileges(r,t){var d;let e=this.portalItem;if(!r||!e||!e.loaded||e.sourceUrl)return this._fetchFallbackUserPrivileges(t);const i=r===e.id;if(i&&e.portal.user)return P(e);let s,c;if(i)s=e.portal.url;else try{s=await k(this.url,t)}catch(l){n(l)}if(!s||!H(s,e.portal.url))return this._fetchFallbackUserPrivileges(t);try{const l=t!=null?t.signal:null;c=await((d=g)==null?void 0:d.getCredential(`${s}/sharing`,{prompt:!1,signal:l}))}catch(l){n(l)}const h=!0,u=!1,p=!1;if(!c)return{features:{edit:h,fullEdit:u},content:{updateItem:p}};try{if(i?await e.reload():(e=new y({id:r,portal:{url:s}}),await e.load(t)),e.portal.user)return P(e)}catch(l){n(l)}return{features:{edit:h,fullEdit:u},content:{updateItem:p}}}async _fetchFallbackUserPrivileges(r){let t=!0;try{t=await this._fetchUserHasEditingPrivileges(r)}catch(e){n(e)}return{features:{edit:t,fullEdit:!1},content:{updateItem:!1}}}async _fetchUserHasEditingPrivileges(r){var i;const t=this.url?(i=g)==null?void 0:i.findCredential(this.url):null;if(!t)return!0;const e=f.credential===t?f.user:await this._fetchEditingUser(r);return f.credential=t,f.user=e,(e==null?void 0:e.privileges)==null||e.privileges.includes("features:user:edit")}async _fetchEditingUser(r){var p,d,l;const t=(d=(p=this.portalItem)==null?void 0:p.portal)==null?void 0:d.user;if(t)return t;const e=(l=g)==null?void 0:l.findServerInfo(this.url??"");if(!(e!=null&&e.owningSystemUrl))return null;const i=`${e.owningSystemUrl}/sharing/rest`,s=v.getDefault();if(s&&s.loaded&&I(s.restUrl)===I(i))return s.user;const c=`${i}/community/self`,h=r!=null?r.signal:null,u=await T(L(c,{authMode:"no-prompt",query:{f:"json"},signal:h}));return u.ok?x.fromJSON(u.value.data):null}read(r,t){t&&(t.layer=this),super.read(r,t)}write(r,t){var s;const e=t==null?void 0:t.portal,i=((s=this.portalItem)==null?void 0:s.id)&&(this.portalItem.portal||v.getDefault());return e&&i&&!F(i.restUrl,e.restUrl)?(t.messages&&t.messages.push(new b("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):super.write(r,{...t,layer:this})}};return o([m({type:y})],a.prototype,"portalItem",null),o([M("web-document","portalItem",["itemId"])],a.prototype,"readPortalItem",null),o([R("web-document","portalItem",{itemId:{type:String}})],a.prototype,"writePortalItem",null),o([m({clonable:!1})],a.prototype,"resourceReferences",void 0),o([m({type:Boolean,readOnly:!0})],a.prototype,"userHasEditingPrivileges",void 0),o([m({type:Boolean,readOnly:!0})],a.prototype,"userHasFullEditingPrivileges",void 0),o([m({type:Boolean,readOnly:!0})],a.prototype,"userHasUpdateItemPrivileges",void 0),a=o([E("esri.layers.mixins.PortalLayer")],a),a},f={credential:null,user:null};export{G as j};
