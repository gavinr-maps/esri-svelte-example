import{aP as $e,aw as ye,au as he,s as ae,f as Ie,c9 as x,r as E,y as Xe,ca as V,aY as le,bK as Ae,ba as Re,b7 as ze}from"./index.ebaf2ed0.js";import{o as He,t as Je,b as Ye,A as ge,x as Ee,f as de,Z as z,h as j,i as R,M as C,k as Fe,l as Te,d as Oe,p as Ge,C as De}from"./CIMSymbolHelper.500b7abd.js";import{H as ne,x as te,D as oe,s as We}from"./enums.6e42a319.js";import{q as Ue,C as je,B as Be,v as qe}from"./quantizationUtils.e5537b97.js";import{b as Q,S as Ve}from"./Utils.2c7f2924.js";import{f as Ke}from"./MaterialKey.50366530.js";function Ze(e){var o;if(!e)return null;switch(e.type){case"CIMPointSymbol":{const t=e.symbolLayers;return t&&t.length===1?Ze(t[0]):null}case"CIMVectorMarker":{const t=e.markerGraphics;if(!t||t.length!==1)return null;const r=t[0];if(!r)return null;const i=r.geometry;if(!i)return null;const n=r.symbol;return!n||n.type!=="CIMPolygonSymbol"&&n.type!=="CIMLineSymbol"||((o=n.symbolLayers)==null?void 0:o.some(l=>!!l.effects))?null:{geom:i,asFill:n.type==="CIMPolygonSymbol"}}case"sdf":return{geom:e.geom,asFill:e.asFill}}return null}function _e(e){return e?e.rings?e.rings:e.paths?e.paths:e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]:null:null}function Qe(e){let o=1/0,t=-1/0,r=1/0,i=-1/0;for(const n of e)for(const l of n)l[0]<o&&(o=l[0]),l[0]>t&&(t=l[0]),l[1]<r&&(r=l[1]),l[1]>i&&(i=l[1]);return new Je(o,r,t-o,i-r)}function Se(e){let o=1/0,t=-1/0,r=1/0,i=-1/0;for(const n of e)for(const l of n)l[0]<o&&(o=l[0]),l[0]>t&&(t=l[0]),l[1]<r&&(r=l[1]),l[1]>i&&(i=l[1]);return[o,r,t,i]}function ke(e){return e?e.rings?Se(e.rings):e.paths?Se(e.paths):$e(e)?[e.xmin,e.ymin,e.xmax,e.ymax]:null:null}function Me(e,o,t,r,i){const[n,l,a,s]=e;if(a<n||s<l)return[0,0,0];const c=a-n,f=s-l,p=128,m=1,u=Math.floor(.5*(.5*p-m)),h=(p-2*(u+m))/Math.max(c,f),y=Math.round(c*h)+2*u,d=Math.round(f*h)+2*u;let S=1;o&&(S=d/h/(o.ymax-o.ymin));let N=0,b=0;if(r)if(i){if(o&&t&&o.ymax-o.ymin>0){const v=(o.xmax-o.xmin)/(o.ymax-o.ymin);N=r.x/(t*v),b=r.y/t}}else N=r.x,b=r.y;return N=.5*(o.xmax+o.xmin)+N*(o.xmax-o.xmin),b=.5*(o.ymax+o.ymin)+b*(o.ymax-o.ymin),N-=n,b-=l,N*=h,b*=h,N+=u,b+=u,[S,N/y-.5,-(b/d-.5)]}function Gt(e){const o=_e(e.geom),t=Qe(o),r=128,i=1,n=Math.floor(.5*(.5*r-i)),l=(r-2*(n+i))/Math.max(t.width,t.height),a=Math.round(t.width*l)+2*n,s=Math.round(t.height*l)+2*n,c=[];for(const p of o)if(p&&p.length>1){const m=[];for(const u of p){let[h,y]=u;h-=t.x,y-=t.y,h*=l,y*=l,h+=n-.5,y+=n-.5,e.asFill?m.push([h,y]):m.push([Math.round(h),Math.round(y)])}if(e.asFill){const u=m.length-1;m[0][0]===m[u][0]&&m[0][1]===m[u][1]||m.push(m[0])}c.push(m)}const f=et(c,a,s,n);return e.asFill&&tt(c,a,s,n,f),[ot(f,n),a,s]}function et(e,o,t,r){const i=o*t,n=new Array(i),l=r*r+1;for(let a=0;a<i;++a)n[a]=l;for(const a of e){const s=a.length;for(let c=1;c<s;++c){const f=a[c-1],p=a[c];let m,u,h,y;f[0]<p[0]?(m=f[0],u=p[0]):(m=p[0],u=f[0]),f[1]<p[1]?(h=f[1],y=p[1]):(h=p[1],y=f[1]);let d=Math.floor(m)-r,S=Math.floor(u)+r,N=Math.floor(h)-r,b=Math.floor(y)+r;d<0&&(d=0),S>o&&(S=o),N<0&&(N=0),b>t&&(b=t);const v=p[0]-f[0],k=p[1]-f[1],X=v*v+k*k;for(let P=d;P<S;P++)for(let $=N;$<b;$++){let w,O,M=(P-f[0])*v+($-f[1])*k;M<0?(w=f[0],O=f[1]):M>X?(w=p[0],O=p[1]):(M/=X,w=f[0]+M*v,O=f[1]+M*k);const L=(P-w)*(P-w)+($-O)*($-O),H=(t-$-1)*o+P;L<n[H]&&(n[H]=L)}}}for(let a=0;a<i;++a)n[a]=Math.sqrt(n[a]);return n}function tt(e,o,t,r,i){for(const n of e){const l=n.length;for(let a=1;a<l;++a){const s=n[a-1],c=n[a];let f,p,m,u;s[0]<c[0]?(f=s[0],p=c[0]):(f=c[0],p=s[0]),s[1]<c[1]?(m=s[1],u=c[1]):(m=c[1],u=s[1]);let h=Math.floor(f),y=Math.floor(p)+1,d=Math.floor(m),S=Math.floor(u)+1;h<r&&(h=r),y>o-r&&(y=o-r),d<r&&(d=r),S>t-r&&(S=t-r);for(let N=d;N<S;++N){if(s[1]>N==c[1]>N)continue;const b=(t-N-1)*o;for(let v=h;v<y;++v)v<(c[0]-s[0])*(N-s[1])/(c[1]-s[1])+s[0]&&(i[b+v]=-i[b+v]);for(let v=r;v<h;++v)i[b+v]=-i[b+v]}}}}function ot(e,o){const t=2*o,r=e.length,i=new Uint8Array(4*r);for(let n=0;n<r;++n){const l=.5-e[n]/t;He(l,i,4*n)}return i}const it=96/72;class ve{static executeEffects(o,t,r){const i=Ye(t),n=it;let l=new de(i);for(const a of o){const s=ge(a);s&&(l=s.execute(l,a,n,r))}return l}static next(o){const t=o.next();return Ee(t),t}static applyEffects(o,t,r){if(!o)return t;let i=new de(t);for(const a of o){const s=ge(a);s&&(i=s.execute(i,a,1,r))}let n,l=null;for(;n=i.next();)l?ye(l)?ye(n)&&l.paths.push(...n.paths):he(l)&&he(n)&&l.rings.push(...n.rings):l=n;return l}}function K(e,o,t,r,i){const n=e.referencesGeometry()&&i?rt(o,r,i):o,l=e.repurposeFeature(n);try{return e.evaluate({...t,$feature:l})}catch(a){return ae.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",a),null}}const ie=new Map;function rt(e,o,t){const{transform:r,hasZ:i,hasM:n}=t;ie.has(o)||ie.set(o,nt(o));const l=ie.get(o)(e.geometry,r,i,n);return{...e,geometry:l}}function nt(e){const o={};switch(e){case"esriGeometryPoint":return(t,r,i,n)=>qe(r,o,t,i,n);case"esriGeometryPolygon":return(t,r,i,n)=>Be(r,o,t,i,n);case"esriGeometryPolyline":return(t,r,i,n)=>je(r,o,t,i,n);case"esriGeometryMultipoint":return(t,r,i,n)=>Ue(r,o,t,i,n);default:return ae.getLogger("esri.views.2d.support.arcadeOnDemand").error(new Ie("mapview-arcade",`Unable to handle geometryType: ${e}`)),t=>t}}function xe(e){const o=e.toLowerCase().split(" ").join("-");switch(o){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return o}}function Dt(e){const o=at(e)+lt(e);return xe(e.family)+(o.length>0?o:"-regular")}function at(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}function lt(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}function st(e,o){let t;if(typeof e=="string")t=x(e+`-seed(${o})`);else{let r=12;t=e^o;do t=107*(t>>8^t)+r|0;while(--r!=0)}return(1+t/(1<<31))/2}function ct(e){return Math.floor(st(e,ft)*mt)}const ft=53290320,mt=10,se=ae.getLogger("esri.symbols.cim.cimAnalyzer");function ce(e){switch(e){case"Butt":return te.BUTT;case"Square":return te.SQUARE;default:return te.ROUND}}function fe(e){switch(e){case"Bevel":return oe.BEVEL;case"Miter":return oe.MITER;default:return oe.ROUND}}function ut(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return se.warnOnce("Horizontal alignment 'justify' is not implemented. Falling back to 'center'."),"center"}}function pt(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function yt(e){let o="",t="";if(e){const r=e.toLowerCase();r.includes("italic")?o="italic":r.includes("oblique")&&(o="oblique"),r.includes("bold")?t="bold":r.includes("light")&&(t="lighter")}return{style:o,weight:t}}function ht(e){return e.underline?"underline":e.strikethrough?"line-through":"none"}function be(e,o,t,r){let i;e[o]?i=e[o]:(i={},e[o]=i),i[t]=r}function Ne(e){const o=e.markerPlacement;return o&&o.angleToLine?ne.MAP:ne.SCREEN}async function Wt(e,o,t,r,i){const n=r!=null?r:[];if(!e)return n;let l,a;const s={};if(e.type!=="CIMSymbolReference")return se.error("Expect cim type to be 'CIMSymbolReference'"),n;if(l=e.symbol,a=e.primitiveOverrides,a){const f=[];for(const p of a){const m=p.valueExpressionInfo;if(m&&o){const u=m.expression,h=Ae(u,o.spatialReference,o.fields).then(y=>{y&&be(s,p.primitiveName,p.propertyName,y)});f.push(h)}else p.value!=null&&be(s,p.primitiveName,p.propertyName,p.value)}f.length>0&&await Promise.all(f)}const c=[];switch(we(l,t,c),c.length>0&&await Promise.all(c),l.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":gt(l,a,s,o,n,t,i)}return n}function gt(e,o,t,r,i,n,l){if(!e)return;const a=e.symbolLayers;if(!a)return;const s=e.effects;let c;const f=z.getSize(e);e.type==="CIMPointSymbol"&&e.angleAlignment==="Map"&&(c=ne.MAP);let p=a.length;for(;p--;){const m=a[p];if(!m||m.enable===!1)continue;let u;s&&s.length&&(u=[...s]);const h=m.effects;h&&h.length&&(s?u.push(...h):u=[...h]);const y=[];let d;j.findEffectOverrides(u,o,y),d=y.length>0?$t(u,y,t,r):u;const S=[];switch(j.findApplicableOverrides(m,o,S),m.type){case"CIMSolidFill":dt(m,d,t,S,r,i);break;case"CIMPictureFill":St(m,d,t,S,r,n,i);break;case"CIMHatchFill":vt(m,d,t,S,r,i);break;case"CIMGradientFill":bt(m,d,t,S,r,i);break;case"CIMSolidStroke":Nt(m,d,t,S,r,i,e.type==="CIMPolygonSymbol",f);break;case"CIMPictureStroke":Ct(m,d,t,S,r,i,e.type==="CIMPolygonSymbol",f);break;case"CIMGradientStroke":Ot(m,d,t,S,r,i,e.type==="CIMPolygonSymbol",f);break;case"CIMCharacterMarker":if(re(m,d,t,S,r,i))break;break;case"CIMPictureMarker":if(re(m,d,t,S,r,i))break;e.type==="CIMLineSymbol"&&(c=Ne(m)),kt(m,d,t,S,r,n,i,c,f);break;case"CIMVectorMarker":if(re(m,d,t,S,r,i))break;e.type==="CIMLineSymbol"&&(c=Ne(m)),Mt(m,d,t,S,r,i,n,c,f,l);break;default:se.error("Cannot analyze CIM layer",m.type)}}}function dt(e,o,t,r,i,n){const l=e.primitiveName,a=R(e.color),[s,c]=Y(r,l,o,null,null),f=x(JSON.stringify(e)+c).toString();n.push({type:"fill",templateHash:f,materialHash:s?()=>f:f,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:g(l,t,"Color",i,a,J),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:o,applyRandomOffset:!1,sampleAlphaOnly:!0})}function St(e,o,t,r,i,n,l){const a=e.primitiveName,s=e.tintColor?R(e.tintColor):{r:255,g:255,b:255,a:1},[c,f]=Y(r,a,o,null,null),p=x(JSON.stringify(e)+f).toString(),m=x(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let u=C(e.scaleX);if("width"in e){const h=e.width;let y=1;const d=n.getResource(e.url);E(d)&&(y=d.width/d.height),u/=y*(e.height/h)}l.push({type:"fill",templateHash:p,materialHash:c?()=>m:m,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:o,color:g(a,t,"TintColor",i,s,J),height:g(a,t,"Height",i,e.height),scaleX:g(a,t,"ScaleX",i,u),angle:g(a,t,"Rotation",i,C(e.rotation)),offsetX:g(a,t,"OffsetX",i,C(e.offsetX)),offsetY:g(a,t,"OffsetY",i,C(e.offsetY)),url:e.url,applyRandomOffset:!1,sampleAlphaOnly:!1})}function vt(e,o,t,r,i,n){var h;const l=["Rotation","OffsetX","OffsetY"],a=r.filter(y=>y.primitiveName!==e.primitiveName&&!l.includes(y.propertyName)),s=e.primitiveName,[c,f]=Y(r,s,o,null,null),p=x(JSON.stringify(e)+f).toString(),m=x(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();let u={r:255,g:255,b:255,a:1};if(e.lineSymbol){const y=(h=e.lineSymbol)==null?void 0:h.symbolLayers.find(d=>d.type==="CIMSolidStroke");y&&(u=R(y.color))}n.push({type:"fill",templateHash:p,materialHash:c?Z(m,t,a,i):m,cim:e,materialOverrides:a,colorLocked:e.colorLocked,effects:o,color:u,height:g(s,t,"Separation",i,e.separation),scaleX:1,angle:g(s,t,"Rotation",i,C(e.rotation)),offsetX:g(s,t,"OffsetX",i,C(e.offsetX)),offsetY:g(s,t,"OffsetY",i,C(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0})}function bt(e,o,t,r,i,n){const l=e.primitiveName,[a,s]=Y(r,l,o,null,null),c=x(JSON.stringify(e)+s).toString();n.push({type:"fill",templateHash:c,materialHash:a?Z(c,t,r,i):c,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:o,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1})}function Nt(e,o,t,r,i,n,l,a){const s=e.primitiveName,c=R(e.color),f=e.width!==void 0?e.width:4,p=ce(e.capStyle),m=fe(e.joinStyle),u=e.miterLimit,[h,y]=Y(r,s,o,null,null),d=x(JSON.stringify(e)+y).toString();let S,N;if(o&&o instanceof Array&&o.length>0){const b=o[o.length-1];if(b.type==="CIMGeometricEffectDashes"&&b.lineDashEnding==="NoConstraint"&&b.offsetAlongLine===null){const v=(o=[...o]).pop();S=v.dashTemplate,N=v.scaleDash}}n.push({type:"line",templateHash:d,materialHash:h?()=>d:d,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:o,color:g(s,t,"Color",i,c,J),width:g(s,t,"Width",i,f),cap:g(s,t,"CapStyle",i,p),join:g(s,t,"JoinStyle",i,m),miterLimit:g(s,t,"MiterLimit",i,u),referenceWidth:a,zOrder:me(e.name),dashTemplate:S,scaleDash:N,sampleAlphaOnly:!0})}function Ct(e,o,t,r,i,n,l,a){const s=x(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),c=e.primitiveName,f=R(e.tintColor),p=e.width!==void 0?e.width:4,m=ce(e.capStyle),u=fe(e.joinStyle),h=e.miterLimit,[y,d]=Y(r,c,o,null,null),S=x(JSON.stringify(e)+d).toString();n.push({type:"line",templateHash:S,materialHash:y?()=>s:s,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:o,color:g(c,t,"TintColor",i,f,J),width:g(c,t,"Width",i,p),cap:g(c,t,"CapStyle",i,m),join:g(c,t,"JoinStyle",i,u),miterLimit:g(c,t,"MiterLimit",i,h),referenceWidth:a,zOrder:me(e.name),dashTemplate:null,scaleDash:!1,url:e.url,sampleAlphaOnly:!1})}function Ot(e,o,t,r,i,n,l,a){const s=e.primitiveName,c=e.width!==void 0?e.width:4,f=ce(e.capStyle),p=fe(e.joinStyle),m=e.miterLimit,[u,h]=Y(r,s,o,null,null),y=x(JSON.stringify(e)+h).toString();n.push({type:"line",templateHash:y,materialHash:u?Z(y,t,r,i):y,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:o,color:{r:128,g:128,b:128,a:1},width:g(s,t,"Width",i,c),cap:g(s,t,"CapStyle",i,f),join:g(s,t,"JoinStyle",i,p),miterLimit:g(s,t,"MiterLimit",i,m),referenceWidth:a,zOrder:me(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}function re(e,o,t,r,i,n){const l=e.markerPlacement;if(!l||l.type!=="CIMMarkerPlacementInsidePolygon")return!1;const a=l,s=Math.abs(a.stepX),c=Math.abs(a.stepY);if(s===0||c===0)return!0;const f=["Rotation","OffsetX","OffsetY"],p=r.filter(v=>v.primitiveName!==e.primitiveName&&!f.includes(v.propertyName)),m="url"in e?e.url:null,[u,h]=Y(r,a.primitiveName,o,null,null),y=x(JSON.stringify(e)+h).toString();let d,S,N=null;if(l.gridType==="Random"){const v=ze(We),k=Math.max(Math.floor(v/s),1),X=Math.max(Math.floor(v/c),1);d=c*X,N=P=>P?P*X:0,S=k*s/d}else l.shiftOddRows?(d=2*c,N=v=>v?2*v:0,S=s/c*.5):(d=c,N=null,S=s/c);let b={r:255,g:255,b:255,a:1};return"tintColor"in e&&(b=R(e.tintColor)),n.push({type:"fill",templateHash:y,materialHash:u?Z(y,t,p,i):y,cim:e,materialOverrides:p,colorLocked:e.colorLocked,effects:o,color:g(a.primitiveName,t,"TintColor",i,b,J),height:g(a.primitiveName,t,"StepY",i,d,N),scaleX:S,angle:g(a.primitiveName,t,"GridAngle",i,a.gridAngle),offsetX:g(a.primitiveName,t,"OffsetX",i,C(a.offsetX)),offsetY:g(a.primitiveName,t,"OffsetY",i,C(a.offsetY)),url:m,applyRandomOffset:l.gridType==="Random",sampleAlphaOnly:!m}),!0}function kt(e,o,t,r,i,n,l,a,s){var w;const c=e.primitiveName,f=C(e.size);let p=C(e.scaleX);const m=C(e.rotation),u=C(e.offsetX),h=C(e.offsetY),y=e.tintColor?R(e.tintColor):{r:255,g:255,b:255,a:1},d=x(`${e.url}${JSON.stringify(e.colorSubstitutions)}${JSON.stringify(e.animatedSymbolProperties)}`).toString(),S=Pe(e.markerPlacement,r,t,i),N=It(e.animatedSymbolProperties,r,t,i),[b,v]=Y(r,c,o,S,N),k=x(JSON.stringify(e)+v).toString(),X=(w=e.anchorPoint)!=null?w:{x:0,y:0};if("width"in e){const O=e.width;let M=1;const L=n.getResource(e.url);E(L)&&(M=L.width/L.height),p/=M*(f/O)}function P(O,M){return Oe(N,O,M)}const $=e.animatedSymbolProperties&&e.animatedSymbolProperties.randomizeStartTime===!0?(O,M,L,H)=>{const F=ct(H),T=P(O,M);return d+`-MATERIALGROUP(${F})-ASP(${JSON.stringify(T)})`}:b?(O,M)=>{const L=P(O,M);return d+`-ASP(${JSON.stringify(L)})`}:d;l.push({type:"marker",templateHash:k,materialHash:$,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:o,scaleSymbolsProportionally:!1,alignment:a,size:g(c,t,"Size",i,f),scaleX:g(c,t,"ScaleX",i,p),rotation:g(c,t,"Rotation",i,m),offsetX:g(c,t,"OffsetX",i,u),offsetY:g(c,t,"OffsetY",i,h),color:g(c,t,"TintColor",i,y,J),anchorPoint:{x:X.x,y:-X.y},isAbsoluteAnchorPoint:e.anchorPointUnits!=="Relative",outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:s,sizeRatio:1,markerPlacement:S,url:e.url,animatedSymbolProperties:N})}function Mt(e,o,t,r,i,n,l,a,s,c){const f=e.markerGraphics;if(!f)return;let p=0;if(e.scaleSymbolsProportionally){const u=e.frame;u&&(p=u.ymax-u.ymin)}const m=Pe(e.markerPlacement,r,t,i);for(const u of f)if(u){const h=u.symbol;if(!h)continue;switch(h.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":Pt(e,o,m,null,u,r,t,i,n,l,a,s,p,c);break;case"CIMTextSymbol":xt(e,o,m,u,t,r,i,n,a,s,p)}}}function xt(e,o,t,r,i,n,l,a,s,c,f){const p=[];j.findApplicableOverrides(r,n,p);const m=r.geometry;if(!("x"in m)||!("y"in m))return;const u=r.symbol,h=ht(u),y=yt(u.fontStyleName),d=xe(u.fontFamilyName);u.font={family:d,decoration:h,...y};const S=e.frame,N=m.x-.5*(S.xmin+S.xmax),b=m.y-.5*(S.ymin+S.ymax),v=e.size/f,k=e.primitiveName,X=C(u.height)*v,P=C(u.angle),$=C(e.offsetX)+(C(u.offsetX)+N)*v,w=C(e.offsetY)+(C(u.offsetY)+b)*v,O=R(z.getFillColor(u));let M=R(z.getStrokeColor(u)),L=z.getStrokeWidth(u);L||(M=R(z.getFillColor(u.haloSymbol)),L=u.haloSize*v);const[H,F]=Y(n,k,o,t,null),T=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),G=x(JSON.stringify(r)+T+F).toString();let I=g(r.primitiveName,i,"TextString",l,r.textString,Fe,u.textCase);if(I==null)return;const{fontStyleName:B}=u,D=d+(B?"-"+B.toLowerCase():"-regular"),W=D;typeof I=="string"&&I.includes("[")&&u.fieldMap&&(I=Te(u.fieldMap,I,u.textCase)),a.push({type:"text",templateHash:G,materialHash:H||typeof I=="function"||I.match(/\[(.*?)\]/)?(A,_,ee)=>W+"-"+Oe(I,A,_,ee):W+"-"+x(I),cim:u,materialOverrides:null,colorLocked:e.colorLocked,effects:o,alignment:s,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:e.anchorPointUnits!=="Relative",fontName:D,decoration:h,weight:g(k,i,"Weight",l,y.weight),style:g(k,i,"Size",l,y.style),size:g(k,i,"Size",l,X),angle:g(k,i,"Rotation",l,P),offsetX:g(k,i,"OffsetX",l,$),offsetY:g(k,i,"OffsetY",l,w),horizontalAlignment:ut(u.horizontalAlignment),verticalAlignment:pt(u.verticalAlignment),text:I,color:O,outlineColor:M,outlineSize:L,referenceSize:c,sizeRatio:1,markerPlacement:t})}function Pt(e,o,t,r,i,n,l,a,s,c,f,p,m,u){var N;const h=i.symbol,y=h.symbolLayers;if(!y)return;if(u)return void Ce(e,o,t,r,i,l,n,a,s,c,f,p,m);let d=y.length;if(Xt(y))return void wt(e,o,t,r,i,y,n,l,a,s,f,p,m);const S=ve.applyEffects(h.effects,i.geometry,c.geometryEngine);if(S)for(;d--;){const b=y[d];if(b&&b.enable!==!1)switch(b.type){case"CIMSolidFill":case"CIMSolidStroke":{const v=ve.applyEffects(b.effects,S,c.geometryEngine),k=ke(v);if(!k)continue;const[X,P,$]=Me(k,e.frame,e.size,e.anchorPoint,e.anchorPointUnits!=="Relative"),w=b.type==="CIMSolidFill",O={type:"sdf",geom:v,asFill:w},M=e.primitiveName,L=(N=C(e.size))!=null?N:10,H=C(e.rotation),F=C(e.offsetX),T=C(e.offsetY),G=b.path,I=b.primitiveName,B=R(w?z.getFillColor(b):z.getStrokeColor(b)),D=w?{r:0,g:0,b:0,a:0}:R(z.getStrokeColor(b)),W=z.getStrokeWidth(b);if(!w&&!W)break;let A=!1,_="";for(const U of n)U.primitiveName!==I&&U.primitiveName!==M||(U.value!==void 0?_+=`-${U.primitiveName}-${U.propertyName}-${JSON.stringify(U.value)}`:U.valueExpressionInfo&&(A=!0));E(o)&&typeof o=="function"&&(A=!0);const ee=JSON.stringify({...e,markerGraphics:null}),pe=x(JSON.stringify(O)+G).toString(),Le={type:"marker",templateHash:x(JSON.stringify(i)+JSON.stringify(b)+ee+_).toString(),materialHash:A?()=>pe:pe,cim:O,materialOverrides:null,colorLocked:e.colorLocked,effects:o,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:P,y:$},isAbsoluteAnchorPoint:!1,size:g(e.primitiveName,l,"Size",a,L),rotation:g(e.primitiveName,l,"Rotation",a,H),offsetX:g(e.primitiveName,l,"OffsetX",a,F),offsetY:g(e.primitiveName,l,"OffsetY",a,T),scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:X,color:g(I,l,"Color",a,B,J),outlineColor:g(I,l,"Color",a,D,J),outlineWidth:g(I,l,"Width",a,W),markerPlacement:t,animatedSymbolProperties:r,path:G};s.push(Le);break}default:Ce(e,o,t,r,i,l,n,a,s,c,f,p,m)}}}function wt(e,o,t,r,i,n,l,a,s,c,f,p,m){const u=i.geometry,h=n[0],y=n[1],d=ke(u);if(!d)return;const[S,N,b]=Me(d,e.frame,e.size,e.anchorPoint,e.anchorPointUnits!=="Relative"),v={type:"sdf",geom:u,asFill:!0},k=e.primitiveName,X=C(e.size),P=C(e.rotation),$=C(e.offsetX),w=C(e.offsetY),O=y.path,M=y.primitiveName,L=h.primitiveName,H=R(z.getFillColor(y)),F=R(z.getStrokeColor(h)),T=z.getStrokeWidth(h);let G=!1,I="";for(const A of l)A.primitiveName!==M&&A.primitiveName!==L&&A.primitiveName!==k||(A.value!==void 0?I+=`-${A.primitiveName}-${A.propertyName}-${JSON.stringify(A.value)}`:A.valueExpressionInfo&&(G=!0));const B=JSON.stringify({...e,markerGraphics:null}),D=x(JSON.stringify(v)+O).toString(),W={type:"marker",templateHash:x(JSON.stringify(i)+JSON.stringify(y)+JSON.stringify(h)+B+I).toString(),materialHash:G?()=>D:D,cim:v,materialOverrides:null,colorLocked:e.colorLocked,effects:o,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:N,y:b},isAbsoluteAnchorPoint:!1,size:g(e.primitiveName,a,"Size",s,X),rotation:g(e.primitiveName,a,"Rotation",s,P),offsetX:g(e.primitiveName,a,"OffsetX",s,$),offsetY:g(e.primitiveName,a,"OffsetY",s,w),scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:S,color:g(M,a,"Color",s,H,J),outlineColor:g(L,a,"Color",s,F,J),outlineWidth:g(L,a,"Width",s,T),markerPlacement:t,path:O,animatedSymbolProperties:r};c.push(W)}function Ce(e,o,t,r,i,n,l,a,s,c,f,p,m){const u=Lt(e,i);let h=[];const y=["Rotation","OffsetX","OffsetY"];h=l.filter(O=>O.primitiveName!==e.primitiveName||!y.includes(O.propertyName));let d="";for(const O of l)O.value!==void 0&&(d+=`-${O.primitiveName}-${O.propertyName}-${JSON.stringify(O.value)}`);const[S,N,b]=z.getTextureAnchor(u,c),v=e.primitiveName,k=C(e.rotation),X=C(e.offsetX),P=C(e.offsetY),$=x(JSON.stringify(u)+d).toString(),w={type:"marker",templateHash:$,materialHash:h.length>0||E(o)&&typeof o=="function"?Z($,n,h,a):$,cim:u,materialOverrides:h,colorLocked:e.colorLocked,effects:o,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:S,y:N},isAbsoluteAnchorPoint:!1,size:e.size,rotation:g(v,n,"Rotation",a,k),offsetX:g(v,n,"OffsetX",a,X),offsetY:g(v,n,"OffsetY",a,P),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:b/Xe(e.size),markerPlacement:t,animatedSymbolProperties:r};s.push(w)}function Lt(e,o){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[o],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}function me(e){if(e&&e.indexOf("Level_")===0){const o=parseInt(e.substr(6),10);if(!isNaN(o))return o}return 0}function J(e){if(!e||e.length===0)return null;const o=new Re(e).toRgba();return{r:o[0],g:o[1],b:o[2],a:o[3]}}function g(e,o,t,r,i,n,l){const a=o[e];if(a){const s=a[t];if(typeof s=="string"||typeof s=="number"||s instanceof Array)return n?n.call(null,s,l):s;if(s!=null&&s instanceof V)return(c,f,p)=>{let m=K(s,c,{$view:p},r.geometryType,f);return m!==null&&n&&(m=n.call(null,m,l)),m!==null?m:i}}return i}function ue(e){return e&&e.charAt(0).toLowerCase()+e.substr(1)}function $t(e,o,t,r){for(const i of o)if(i.valueExpressionInfo){const n=t[i.primitiveName]&&t[i.primitiveName][i.propertyName];n instanceof V&&(i.fn=(l,a,s)=>K(n,l,{$view:s},r.geometryType,a))}return(i,n,l)=>{for(const s of o)s.fn&&(s.value=s.fn(i,n,l));const a=[];for(let s of e){const c=s==null?void 0:s.primitiveName;if(c){let f=!1;for(const p of o)if(p.primitiveName===c){const m=ue(p.propertyName);p.value!=null&&p.value!==s[m]&&(f||(s=le(s),f=!0),s[m]=p.value)}}a.push(s)}return a}}function Pe(e,o,t,r){const i=[];if(j.findApplicableOverrides(e,o,i),i.length===0)return e;for(const n of i)if(n.valueExpressionInfo){const l=t[n.primitiveName]&&t[n.primitiveName][n.propertyName];l instanceof V&&(n.fn=(a,s,c)=>K(l,a,{$view:c},r.geometryType,s))}return(n,l,a)=>{for(const f of i)f.fn&&(f.value=f.fn(n,l,a));const s=le(e),c=e.primitiveName;for(const f of i)if(f.primitiveName===c){const p=ue(f.propertyName);f.value!=null&&f.value!==s[p]&&(s[p]=f.value)}return s}}function It(e,o,t,r){const i=[];if(j.findApplicableOverrides(e,o,i),i.length===0)return e;for(const n of i)if(n.valueExpressionInfo){const l=t[n.primitiveName]&&t[n.primitiveName][n.propertyName];l instanceof V&&(n.fn=(a,s,c)=>K(l,a,{$view:c},r.geometryType,s))}return(n,l,a)=>{for(const f of i)f.fn&&(f.value=f.fn(n,l,a));const s=le(e),c=e.primitiveName;for(const f of i)if(f.primitiveName===c){const p=ue(f.propertyName);f.value!=null&&f.value!==s[p]&&(s[p]=f.value)}return s}}function Z(e,o,t,r){for(const i of t)if(i.valueExpressionInfo){const n=o[i.primitiveName]&&o[i.primitiveName][i.propertyName];n instanceof V&&(i.fn=(l,a,s)=>K(n,l,{$view:s},r.geometryType,a))}return(i,n,l)=>{for(const a of t)a.fn&&(a.value=a.fn(i,n,l));return x(e+j.buildOverrideKey(t)).toString()}}function Ut(e,o){if(!o||o.length===0)return e;const t=JSON.parse(JSON.stringify(e));return j.applyOverrides(t,o),t}function Y(e,o,t,r,i){let n=!1,l="";for(const a of e)a.primitiveName===o&&(a.value!==void 0?l+=`-${a.primitiveName}-${a.propertyName}-${JSON.stringify(a.value)}`:a.valueExpressionInfo&&(n=!0));return E(t)&&typeof t=="function"&&(n=!0),E(r)&&typeof r=="function"&&(n=!0),E(i)&&typeof i=="function"&&(n=!0),[n,l]}function we(e,o,t){if(e&&o)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const r=e.symbolLayers;if(!r)return;for(const i of r)switch(At(i,o,t),i.type){case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMCharacterMarker":case"CIMPictureMarker":"url"in i&&i.url&&t.push(o.fetchResource(i.url,null));break;case"CIMVectorMarker":{const n=i.markerGraphics;if(!n)continue;for(const l of n)if(l){const a=l.symbol;a&&we(a,o,t)}}}}}}const Xt=e=>e&&e.length===2&&e[0].enable&&e[1].enable&&e[0].type==="CIMSolidStroke"&&e[1].type==="CIMSolidFill"&&!e[0].effects&&!e[1].effects;let q;function At(e,o,t){if(!(!e.effects||E(o.geometryEngine))){if(q)return void t.push(q);Ge(e.effects)&&(q=De(),t.push(q),q.then(r=>o.geometryEngine=r))}}const Rt={marker:Q.MARKER,fill:Q.FILL,line:Q.LINE,text:Q.TEXT};class jt{constructor(o,t,r,i){const n={minScale:t==null?void 0:t.minScale,maxScale:t==null?void 0:t.maxScale},l=zt(n);this.layers=o,this.data=t,this.hash=this._createHash()+l,this.rendererKey=r;const a={isOutline:!1,placement:null,symbologyType:Ve.DEFAULT,vvFlags:r};for(const s of o){const c=Rt[s.type];a.isOutline=s.type==="line"&&s.isOutline,s.materialKey=Ke(c,a),s.maxVVSize=i,s.scaleInfo=n,s.templateHash+=l}}get type(){return"expanded-cim"}_createHash(){let o="";for(const t of this.layers)o+=t.templateHash;return o}}function zt(e){return e.minScale||e.maxScale?e.minScale+"-"+e.maxScale:""}export{Wt as Y,Gt as a,K as b,st as e,ve as f,jt as l,Dt as n,ct as o,Ze as r,Ut as s};
