import{r as l,m as r,a as x,G as W,aN as X,s as Y,B as ee,L as te,c as y,bl as se}from"./Accessor-BmwT4B0c.js";import{d as M}from"./reactiveUtils-XM7cS2OP.js";import{a as B,p as ie,j as le}from"./cast-CsZslgGN.js";import{r as oe}from"./enumeration-DpvDkLNI.js";import{r as z,o as H}from"./writer-DKgfqj4X.js";import{y as ue}from"./diffUtils-BanfihCO.js";import{o as L,_ as re,Z as N}from"./opacityUtils-Dim20wpZ.js";import{C}from"./Portal-CmmHxpLg.js";import{a as D,y as T,m as ne,v as ae,p as pe,n as de}from"./commonProperties-ZfGquLPI.js";import{u as fe}from"./RendererLegendOptions-CYAPr8D6.js";import{a as A}from"./Clonable-Z-AWS-16.js";import{S as E}from"./JSONSupport-DcrLLGjL.js";import{l as he,A as ce}from"./Graphic-Dt0LgVGU.js";import{i as ye}from"./styleUtils-ColFrJ-Z.js";let I=class extends A.ClonableMixin(E){constructor(t){super(t),this.value=null,this.value2=null,this.value3=null}};l([r(D)],I.prototype,"value",void 0),l([r(D)],I.prototype,"value2",void 0),l([r(D)],I.prototype,"value3",void 0),I=l([x("esri.renderers.support.UniqueValue")],I);const S=I;let v=class extends A.ClonableMixin(E){constructor(t){super(t),this.description=null,this.label=null,this.symbol=null,this.values=null}castValues(t){if(t==null)return null;const s=typeof(t=Array.isArray(t)?t:[t])[0];return s==="string"||s==="number"?t.map(i=>new S({value:i})):s==="object"?t[0]instanceof S?t:t.map(i=>new S(i)):null}};l([r({type:String,json:{write:!0}})],v.prototype,"description",void 0),l([r({type:String,json:{write:!0}})],v.prototype,"label",void 0),l([r(T)],v.prototype,"symbol",void 0),l([r({type:[S],json:{type:[[String]],read:{reader:e=>e?e.map(t=>new S({value:t[0],value2:t[1],value3:t[2]})):null},write:{writer:(e,t)=>{const s=[];for(const i of e){const o=[i.value,i.value2,i.value3].filter(W).map(u=>u.toString());s.push(o)}t.values=s}}}})],v.prototype,"values",void 0),l([B("values")],v.prototype,"castValues",null),v=l([x("esri.renderers.support.UniqueValueClass")],v);const Z=v;let O=class extends A.ClonableMixin(E){constructor(e){super(e),this.heading=null,this.classes=null}};l([r({type:String,json:{write:!0}})],O.prototype,"heading",void 0),l([r({type:[Z],json:{write:{isRequired:!0}}})],O.prototype,"classes",void 0),O=l([x("esri.renderers.support.UniqueValueGroup")],O);const R=O;var P;let g=P=class extends E{constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.value=null}clone(){return new P({value:this.value,description:this.description,label:this.label,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){var t;const e=JSON.stringify((t=this.symbol)==null?void 0:t.toJSON());return`${this.value}.${e}`}};l([r({type:String,json:{write:!0}})],g.prototype,"description",void 0),l([r({type:String,json:{write:!0}})],g.prototype,"label",void 0),l([r(ne)],g.prototype,"symbol",void 0),l([r(D)],g.prototype,"value",void 0),g=P=l([x("esri.renderers.support.UniqueValueInfo")],g);const G=g;var $;const K="esri.renderers.UniqueValueRenderer",m=()=>ee.getLogger(K),k="uvInfos-watcher",J="uvGroups-watcher",me=",",ve=te(G);function be(e){const{field1:t,field2:s,field3:i,fieldDelimiter:o,uniqueValueInfos:u,valueExpression:a}=e,p=!(!t||!s);return[{classes:(u??[]).map(d=>{var V;const{symbol:b,label:_,value:f,description:h}=d,[w,U,F]=p?((V=f==null?void 0:f.toString())==null?void 0:V.split(o||""))||[]:[f],c=[];return(t||a)&&c.push(w),s&&c.push(U),i&&c.push(F),{symbol:b,label:_,values:[c],description:h}})}]}function q(e){return e!=null&&e!==""&&(typeof e!="string"||e.trim()!==""&&e.toLowerCase()!=="<null>")||(e=null),e+""}let n=$=class extends ae(pe){constructor(e){super(e),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this._isInfosSource=null,this.type="unique-value",this.backgroundFillSymbol=null,this.orderByClassesEnabled=!1,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(t,s){if(!t&&!s)return;if(!t||!s)return{type:"complete",oldValue:t,newValue:s};let i=!1;const o={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let u=0;u<s.length;u++){const a=t.find(p=>p.value===s[u].value);a?ue(a,s[u])?(o.changed.push({type:"complete",oldValue:a,newValue:s[u]}),i=!0):o.unchanged.push({oldValue:a,newValue:s[u]}):(o.added.push(s[u]),i=!0)}for(let u=0;u<t.length;u++)s.find(a=>a.value===t[u].value)||(o.removed.push(t[u]),i=!0);return i?o:void 0}},this._set("uniqueValueInfos",[]),this._set("uniqueValueGroups",[])}get _cache(){return{compiledFunc:null}}set field(e){this._set("field",e),this._updateFieldDelimiter(),this._updateUniqueValues()}castField(e){return e==null||typeof e=="function"?e:X(e)}writeField(e,t,s,i){typeof e=="string"?t[s]=e:i!=null&&i.messages?i.messages.push(new Y("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):m().error(".field: cannot write field to JSON since it's not a string value")}set field2(e){this._set("field2",e),this._updateFieldDelimiter(),this._updateUniqueValues()}set field3(e){this._set("field3",e),this._updateUniqueValues()}set valueExpression(e){this._set("valueExpression",e),this._updateUniqueValues()}set defaultSymbol(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}set fieldDelimiter(e){this._set("fieldDelimiter",e),this._updateUniqueValues()}readPortal(e,t,s){return s.portal||C.getDefault()}readStyleOrigin(e,t,s){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const i=ie(t.styleUrl,s);return Object.freeze({styleUrl:i})}}writeStyleOrigin(e,t,s,i){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=le(e.styleUrl,i))}set uniqueValueGroups(e){this.styleOrigin?m().error("#uniqueValueGroups=","Cannot modify unique value groups of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueGroups",e),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups())}set uniqueValueInfos(e){this.styleOrigin?m().error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())}addUniqueValueInfo(e,t){var i;if(this.styleOrigin)return void m().error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let s;s=typeof e=="object"?ve(e):new G({value:e,symbol:he(t)}),(i=this.uniqueValueInfos)==null||i.push(s),this._valueInfoMap[q(s.value)]=s,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}removeUniqueValueInfo(e){if(this.styleOrigin)return void m().error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");const t=this.uniqueValueInfos;if(t)for(let s=0;s<t.length;s++){const i=t[s];if(String(i.value)===String(e)){delete this._valueInfoMap[q(e)],t.splice(s,1);break}}this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}async getUniqueValueInfo(e,t){let s=t;return this.valueExpression&&(t==null?void 0:t.arcade)==null&&(s={...s,arcade:await L()}),this._getUniqueValueInfo(e,s)}getSymbol(e,t){if(this.valueExpression&&(t==null?void 0:t.arcade)==null)return void m().error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const s=this._getUniqueValueInfo(e,t);return(s==null?void 0:s.symbol)||this.defaultSymbol}async getSymbolAsync(e,t){let s=t;if(this.valueExpression&&(s==null?void 0:s.arcade)==null){const o=await L(),{arcadeUtils:u}=o;u.hasGeometryOperations(this.valueExpression)&&await u.enableGeometryOperations(),s={...s,arcade:o}}const i=this._getUniqueValueInfo(e,s);return(i==null?void 0:i.symbol)||this.defaultSymbol}get symbols(){const e=[];for(const t of this.uniqueValueInfos??[])t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){var e;return((e=this.visualVariables)==null?void 0:e.reduce((t,s)=>t+s.getAttributeHash(),""))??""}getMeshHash(){var i;const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),s=(i=this.uniqueValueInfos)==null?void 0:i.reduce((o,u)=>o+u.getMeshHash(),"");return`${e}.${t}.${s}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`}clone(){const e=new $({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:y(this.defaultSymbol),orderByClassesEnabled:this.orderByClassesEnabled,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:y(this.visualVariables),legendOptions:y(this.legendOptions),authoringInfo:y(this.authoringInfo),backgroundFillSymbol:y(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=y(this.uniqueValueInfos),s=y(this.uniqueValueGroups);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(y(this.styleOrigin))),Object.freeze(t),Object.freeze(s)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e._set("uniqueValueGroups",s),e._isInfosSource=this._isInfosSource,e._watchUniqueValueInfosAndGroups(),e}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(e,t){const s=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(s)}async collectSymbolFields(e,t){const s=[...this.symbols.map(i=>i.collectRequiredFields(e,t)),re(e,t,this.valueExpression)];N(e,t,this.field),N(e,t,this.field2),N(e,t,this.field3),await Promise.all(s)}populateFromStyle(){return ye(this.styleOrigin,{portal:this.portal}).then(e=>{var s;const t=[];return this._valueInfoMap={},e!=null&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach(i=>{const o=new ce({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:i.name});this.defaultSymbol||i.name!==e.data.defaultItem||(this.defaultSymbol=o,this._isDefaultSymbolDerived=!0);const u=new G({value:i.name,symbol:o});t.push(u),this._valueInfoMap[q(i.name)]=u}),this._set("uniqueValueInfos",Object.freeze(t)),this._updateGroupsFromInfos(!0),this._isInfosSource=null,this._watchUniqueValueInfos(),!this.defaultSymbol&&((s=this.uniqueValueInfos)!=null&&s.length)&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateFieldDelimiter(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",me)}_updateUniqueValues(){this._isInfosSource!=null&&(this._isInfosSource?this._updateGroupsFromInfos():this._updateInfosFromGroups())}_updateValueInfoMap(){this._valueInfoMap={};const{uniqueValueInfos:e}=this;if(e)for(const t of e)this._valueInfoMap[q(t.value)]=t}_watchUniqueValueInfosAndGroups(){this._watchUniqueValueInfos(),this._watchUniqueValueGroups()}_watchUniqueValueInfos(){this.removeHandles(k);const{uniqueValueInfos:e}=this;if(e){const t=[];for(const s of e)t.push(M(()=>({symbol:s.symbol,value:s.value,label:s.label,description:s.description}),(i,o)=>{i!==o&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)},{sync:!0}));this.addHandles(t,k)}}_watchUniqueValueGroups(){this.removeHandles(J);const{uniqueValueGroups:e}=this;if(e){const t=[];for(const s of e){t.push(M(()=>({classes:s.classes}),(i,o)=>{i!==o&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}));for(const i of s.classes??[])t.push(M(()=>({symbol:i.symbol,values:i.values,label:i.label,description:i.description}),(o,u)=>{o!==u&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}))}this.addHandles(t,J)}}_updateInfosFromGroups(){if(!this.uniqueValueGroups)return this._set("uniqueValueInfos",null),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const e=[],{field:t,field2:s,field3:i,fieldDelimiter:o,uniqueValueGroups:u,valueExpression:a}=this;if(!t&&!a)return this._set("uniqueValueInfos",e),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const p=!(!t||!s);for(const d of u)for(const b of d.classes??[]){const{symbol:_,label:f,values:h,description:w}=b;for(const U of h??[]){const{value:F,value2:c,value3:V}=U,j=[F];s&&j.push(c),i&&j.push(V);const Q=p?j.join(o||""):j[0]??void 0;e.push(new G({symbol:_,label:f,value:Q,description:w}))}}this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._watchUniqueValueInfos()}_updateGroupsFromInfos(e=!1){if(!this.uniqueValueInfos)return this._set("uniqueValueGroups",null),void this._watchUniqueValueGroups();const{field:t,field2:s,valueExpression:i,fieldDelimiter:o,uniqueValueInfos:u}=this;if(!t&&!i||!u.length)return this._set("uniqueValueGroups",[]),void this._watchUniqueValueGroups();const a=!(!t||!s),p=u.map(b=>{var V;const{symbol:_,label:f,value:h,description:w}=b,[U,F,c]=a?((V=h==null?void 0:h.toString())==null?void 0:V.split(o||""))||[]:[h];return new Z({symbol:_,label:f,description:w,values:[new S({value:U,value2:F,value3:c})]})}),d=[new R({classes:p})];e&&Object.freeze(d),this._set("uniqueValueGroups",d),this._watchUniqueValueGroups()}_getUniqueValueInfo(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)}_getUnqiueValueInfoForExpression(e,t){const{viewingMode:s,scale:i,spatialReference:o,arcade:u,timeZone:a}=t??{};let p=this._cache.compiledFunc;const d=u.arcadeUtils;if(!p){const _=d.createSyntaxTree(this.valueExpression);p=d.createFunction(_),this._cache.compiledFunc=p}const b=d.executeFunction(p,d.createExecContext(e,d.getViewInfo({viewingMode:s,scale:i,spatialReference:o}),a));return this._valueInfoMap[q(b)]}_getUnqiueValueInfoForFields(e){const t=this.field,s=e.attributes;let i;if(this.field2){const o=this.field2,u=this.field3,a=[];t&&a.push(s[t]),o&&a.push(s[o]),u&&a.push(s[u]),i=a.join(this.fieldDelimiter||"")}else t&&(i=s[t]);return this._valueInfoMap[q(i)]}static fromPortalStyle(e,t){const s=new $(t==null?void 0:t.properties);s._set("styleOrigin",Object.freeze({styleName:e})),s._set("portal",(t==null?void 0:t.portal)||C.getDefault());const i=s.populateFromStyle();return i.catch(o=>{m().error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",o)}),i}static fromStyleUrl(e,t){const s=new $(t==null?void 0:t.properties);s._set("styleOrigin",Object.freeze({styleUrl:e}));const i=s.populateFromStyle();return i.catch(o=>{m().error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",o)}),i}};l([r({readOnly:!0})],n.prototype,"_cache",null),l([oe({uniqueValue:"unique-value"})],n.prototype,"type",void 0),l([r(de)],n.prototype,"backgroundFillSymbol",void 0),l([r({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],n.prototype,"field",null),l([B("field")],n.prototype,"castField",null),l([z("field")],n.prototype,"writeField",null),l([r({type:String,value:null,json:{write:!0}})],n.prototype,"field2",null),l([r({type:String,value:null,json:{write:!0}})],n.prototype,"field3",null),l([r({type:Boolean,json:{name:"drawInClassOrder",default:!1,write:!0,origins:{"web-scene":{write:!1}}}})],n.prototype,"orderByClassesEnabled",void 0),l([r({type:String,value:null,json:{write:!0}})],n.prototype,"valueExpression",null),l([r({type:String,json:{write:!0}})],n.prototype,"valueExpressionTitle",void 0),l([r({type:fe,json:{write:!0}})],n.prototype,"legendOptions",void 0),l([r({type:String,json:{write:!0}})],n.prototype,"defaultLabel",void 0),l([r(se({...T},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],n.prototype,"defaultSymbol",null),l([r({type:String,value:null,json:{write:!0}})],n.prototype,"fieldDelimiter",null),l([r({type:C,readOnly:!0})],n.prototype,"portal",void 0),l([H("portal",["styleName"])],n.prototype,"readPortal",null),l([r({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],n.prototype,"styleOrigin",void 0),l([H("styleOrigin",["styleName","styleUrl"])],n.prototype,"readStyleOrigin",null),l([z("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],n.prototype,"writeStyleOrigin",null),l([r({type:[R],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(e,t,s)=>(t.uniqueValueGroups||be(t)).map(i=>R.fromJSON(i,s))},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],n.prototype,"uniqueValueGroups",null),l([r({type:[G],json:{read:!1,write:{isRequired:!0,overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0,isRequired:!0}}}}})],n.prototype,"uniqueValueInfos",null),n=$=l([x(K)],n);const Me=n;export{Me as A,G as n};
