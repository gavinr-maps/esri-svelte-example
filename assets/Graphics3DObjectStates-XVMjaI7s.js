import{g as H,r as d,m as u,a as T,aO as q,e as j}from"./Accessor-BmwT4B0c.js";import{i as W}from"./Evented-Dw4_VOGn.js";import{d as y,C as Y,P as J}from"./reactiveUtils-XM7cS2OP.js";import{a as K}from"./Graphics3DScaleVisibility-CyLlAoK9.js";import{C as Q}from"./RibbonLine.glsl-DwJpAQ1c.js";import{g as S,o as X}from"./Scheduler-i_u8qdlN.js";import{C as G}from"./Point-Cz2JYYmX.js";import{o as D}from"./mathUtils-Cfq9PL9W.js";import{h as Z}from"./mat4-Fi6iAz29.js";import{e as U}from"./mat4f64-Dk4dwAN8.js";import{u as ee,g as C,K as te,E as R,o as _,P as A}from"./vec32-Dvg_eL9J.js";import{n as m}from"./vec3f64-BLpZdpfb.js";import{m as ie}from"./computeTranslationToOriginAndRotation-DYUrDrjE.js";import{i as se}from"./projectBoundingRect-C2OcwCLZ.js";import{n as re}from"./projectVectorToVector-CCOy_B5J.js";import{q as ne,l as ae,u as oe}from"./aaBoundingBox-Dw3yBk2f.js";import{J as he,a as ce}from"./Polyline-s-JzsQqo.js";import{j as c}from"./Octree-CmoRJhci.js";import{b as le,v as de}from"./lineSegment-v806maA5.js";import{M as E,P as B,L as N,h as pe,V as P}from"./plane-CpXmOyqq.js";import{k as M}from"./sphere-Cin5efBj.js";import{l as w}from"./ViewingMode-Dodu7ZZk.js";import{g as ue}from"./LineCallout.glsl-BQyjm-mE.js";import{t as v}from"./basicInterfaces-CZwQPxTp.js";let g=class extends H{constructor(s){super(s),this._dirtyExtents=new K,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new W}initialize(){var t;const s=this.elevationProvider,e=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=e.registerTask(V((t=this.graphicsCore.layer.elevationInfo)==null?void 0:t.mode),this),this.addHandles([s.on("elevation-change",i=>this._elevationChanged(i)),y(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,y(()=>{var i;return V((i=this.graphicsCore.layer.elevationInfo)==null?void 0:i.mode)},i=>this._task.priority=i)])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){this.graphicsCoreOwner.suspended===!0?this._updateElevation=!1:this.graphicsCoreOwner.suspended===!1&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(s){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,s.madeProgress()),s.run(()=>this._dirtyExtents.merge(s));this.running&&!s.done;)this._updateDirtyGraphics(s),this._updateDirtyExtents(s);this.notifyChange("updating")}_updateDirtyGraphics(s){var i;const e=this.graphicsCoreOwner.view.renderCoordsHelper,t=this.graphicsCore.effectiveUpdatePolicy===Q.ASYNC;for(const n of this._dirtyGraphicsSet.keys()){const r=this.graphicsCore.getGraphics3DGraphicById(n);if(this._dirtyGraphicsSet.delete(n),r!=null&&(r.alignWithElevation(this.elevationProvider,e,t),(i=this.graphicsCore.deconflictor)==null||i.setDirty(),s.madeProgress()),s.done)return}}_updateDirtyExtents(s){for(;!this._dirtyExtents.empty&&!s.done;){const e=this._dirtyExtents.pop(),t=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:e,spatialReference:t});const i=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(e,t,n=>{const r=this.graphicsCore.getGraphics3DGraphicById(n);r!=null&&r.needsElevationUpdates()&&this._dirtyGraphicsSet.add(n)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-i)+.9*this._averageExtentUpdateSize,s.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((s,e)=>this._dirtyGraphicsSet.add(e))}_elevationChanged(s){if(s.context==="scene"&&(!this.graphicsCore.layer.elevationInfo||this.graphicsCore.layer.elevationInfo.mode!=="relative-to-scene"))return;const e=s.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const t=this.graphicsCore.computedExtent;t&&e[2]>t.xmin&&e[0]<t.xmax&&e[3]>t.ymin&&e[1]<t.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",s)}else e[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(e),this.notifyChange("updating")}};function V(s){return s==null?S.ELEVATION_ALIGNMENT:s==="relative-to-scene"?S.ELEVATION_ALIGNMENT_SCENE:S.ELEVATION_ALIGNMENT}d([u()],g.prototype,"graphicsCoreOwner",void 0),d([u()],g.prototype,"graphicsCore",void 0),d([u()],g.prototype,"queryGraphicUIDsInExtent",void 0),d([u()],g.prototype,"elevationProvider",void 0),d([u({readOnly:!0})],g.prototype,"updating",null),d([u({readOnly:!0})],g.prototype,"updatingRemaining",null),g=d([T("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],g);const F=.5*Math.PI,_e=F/Math.PI*180;class ge{constructor(e){this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:m(),direction:m()},this._renderCoordsHelper=e.renderCoordsHelper;for(let t=0;t<4;t++)this._extent[t]={origin:m(),direction:m(),cap:{next:null,direction:m()}},this._planes[t]=E();this._planes[c.NEAR]=E(),this._planes[c.FAR]=E(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,i,n=!0){const r=this._extent;this._toRenderBoundingExtent(e,t,i),ee(this._center.origin,r[0].origin,r[2].origin),C(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),n||C(this._center.direction,this._center.direction,-1);for(let a=0;a<4;a++){const h=r[a];this._renderCoordsHelper.worldUpAtPosition(h.origin,h.direction);const x=r[a===3?0:a+1];h.cap.next=x.origin,te(h.cap.direction,h.origin,x.origin),B(h.direction,h.cap.direction,h.origin,this._planes[a]),n||C(h.direction,h.direction,-1)}B(r[0].cap.direction,r[1].cap.direction,r[0].origin,this._planes[c.NEAR]),n?N(this._planes[c.NEAR],this._planes[c.FAR]):(pe(this._planes[c.FAR],this._planes[c.NEAR]),N(this._planes[c.NEAR],this._planes[c.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*G(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,i=!1){if(e==null)return!1;if(this._renderCoordsHelper.viewingMode===w.Global){const r=this._maxSpanSpatialReference.isGeographic?_e:F*t;if(this._maxSpan>r)return!0;if(e.altitude!=null&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(this._maxSpan===0){const r=this._extent[0];return!(i||!e.intersectsRay(M(r.origin,r.direction)))}for(let r=0;r<this._extent.length;r++){const a=this._extent[r];if(!i&&e.intersectsRay(M(a.origin,a.direction))||e.intersectsLineSegment(le(a.origin,a.cap.next,fe),a.cap.direction))return!0}const n=i?this._planes:this._planesWithoutFar;for(let r=0;r<e.lines.length;r++){const a=e.lines[r];if(ue(n,a.origin,a.endpoint,a.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,i){he(e,l),l[2]=i,ie(t,l,I,this._renderCoordsHelper.spatialReference),Z(k,I),ne(o);for(const{x0:r,x1:a,y0:h,y1:x}of me)for(let b=0;b<5;b++){const $=b/4;l[0]=D(e[r],e[a],$),l[1]=D(e[h],e[x],$),l[2]=i,re(l,t,l,this._renderCoordsHelper.spatialReference),R(l,l,k),ae(o,l)}_(this._extent[0].origin,o[0],o[1],o[2]),_(this._extent[1].origin,o[3],o[1],o[2]),_(this._extent[2].origin,o[3],o[4],o[2]),_(this._extent[3].origin,o[0],o[4],o[2]);for(let r=0;r<4;++r)R(this._extent[r].origin,this._extent[r].origin,I)}_toRenderBoundingExtentLocal(e,t,i){se(e,t,p,this._renderCoordsHelper.spatialReference),_(this._extent[0].origin,p[0],p[1],i),_(this._extent[1].origin,p[2],p[1],i),_(this._extent[2].origin,p[2],p[3],i),_(this._extent[3].origin,p[0],p[3],i)}_toRenderBoundingExtent(e,t,i){switch(this._renderCoordsHelper.viewingMode){case w.Global:this._toRenderBoundingExtentGlobal(e,t,i);break;case w.Local:this._toRenderBoundingExtentLocal(e,t,i);break;default:q(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if(P(e.planes[c.NEAR],this._center.origin)<0&&A(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const i=this._extent[t];if(P(e.planes[c.NEAR],i.origin)<0&&A(i.direction,e.direction)<0)return!0}return!1}}const me=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],l=m(),I=U(),k=U(),o=oe(),p=ce(),fe=de(),ye=1.2;let f=class extends H{constructor(s){super(s),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:s}=this;this._extentIntersection=new ge({renderCoordsHelper:s.view.renderCoordsHelper});const e=s.view,t=e.basemapTerrain,i=e.resourceController.scheduler;this.addHandles([e.on("resize",()=>this._viewChange()),y(()=>e.state.camera,()=>this._viewChange(),Y),i.registerTask(S.FRUSTUM_VISIBILITY,this),y(()=>t.visibleElevationBounds,()=>this._elevationBoundsChange())]),e.viewingMode==="local"?this._isVisibleBelowSurface=!0:this.addHandles([y(()=>{var n,r,a;return[t.baseOpacity,t.wireframe,(a=(r=(n=e.map)==null?void 0:n.ground)==null?void 0:r.navigationConstraint)==null?void 0:a.type]},()=>this._updateIsVisibleBelowSurface(),J)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(s){this._extent=s,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(s){this._isVisibleBelowSurfaceInternal=s,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){var n,r;const s=this.graphicsCoreOwner.view,e=s.basemapTerrain,t=s.viewingMode==="local",i=((r=(n=s.map.ground)==null?void 0:n.navigationConstraint)==null?void 0:r.type)==="none";this._isVisibleBelowSurface=t||!e.opaque||i}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const s=this.graphicsCoreOwner.view;let e;if(this._isVisibleBelowSurfaceInternal)e=-.3*G(s.spatialReference).radius;else{const{min:t,max:i}=s.basemapTerrain.visibleElevationBounds;e=t-Math.max(1,(i-t)*(ye-1))}this._extentIntersection.update(this._extent,s.spatialReference,e)}get running(){return this.updating}runTask(s){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),X;this._updateExtentIntersection();const e=this.graphicsCoreOwner.view.frustum,t=G(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(e,t)),s.madeProgress()}};d([u({readOnly:!0})],f.prototype,"suspended",void 0),d([u({constructOnly:!0})],f.prototype,"graphicsCoreOwner",void 0),d([u({readOnly:!0})],f.prototype,"updating",void 0),f=d([T("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],f);class O{}class xe extends O{constructor(e,t){super(),this.objectStateId=e,this.object=t}remove(){this.object.removeStateID(this.objectStateId)}}class Se extends O{constructor(e,t,i){super(),this.objectStateId=e,this.object=t,this.owner=i}remove(){this.owner.removeRenderGeometryObjectState(this.object,this.objectStateId)}}let ve=class extends O{constructor(e,t){super(),this.objectStateId=e,this._removeCallback=t,this.object=null}remove(){this._removeCallback(this.objectStateId)}};class z{constructor(){this._items=[]}addObject(e,t){this._items.push(new xe(t,e))}addRenderGeometry(e,t,i){this._items.push(new Se(t,e,i))}addExternal(e,t){this._items.push(new ve(t,e))}remove(e){this._remove(t=>t.objectStateId===e)}removeByObject(e){this._remove(t=>t.object===e)}removeAll(){this._items.forEach(e=>e.remove()),this._items=[]}_remove(e){const{_items:t}=this;for(let i=t.length-1;i>=0;--i){const n=t[i];e(n)&&(n.remove(),t.splice(i,1))}}}let be=class extends z{constructor(){super(...arguments),this.stateType=v.MaskOccludee}},Ce=class extends z{constructor(e){super(),this.highlightName=e,this.stateType=v.Highlight}};class L{constructor(e){this.objectIdField=e,this.ids=new Set,this.paused=!1}hasGraphic(e){const t=this.objectIdField?e.graphic.attributes[this.objectIdField]:e.graphic.uid;return this.ids.has(t)}}class Ee extends L{constructor(e){super(e),this.stateType=v.MaskOccludee,this.objectStateSet=new be}}class we extends L{constructor(e,t){super(t),this.highlightName=e,this.stateType=v.Highlight,this.objectStateSet=new Ce(e)}}class Ze{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(e=>e.objectStateSet.removeAll()),this._stateSets.length=0)}acquireOccludeeSet(e){const t=new Ee(e);this._stateSets.push(t);const i=j(()=>this.releaseSet(t));return{set:t,handle:i}}acquireHighlightSet(e,t){const i=new we(e,t);this._stateSets.push(i);const n=j(()=>this.releaseSet(i));return{set:i,handle:n}}releaseSet(e){e.objectStateSet.removeAll();const t=this._stateSets?this._stateSets.indexOf(e):-1;t!==-1&&this._stateSets.splice(t,1)}setUid(e,t){e.ids.add(t);const i=this._graphicsCore.graphics3DGraphics.get(t);i&&i.addObjectStateSet(e.objectStateSet)}setUids(e,t){t.forEach(i=>this.setUid(e,i))}setObjectIds(e,t){t.forEach(i=>e.ids.add(i)),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach(t=>{!t.paused&&t.hasGraphic(e)&&e.addObjectStateSet(t.objectStateSet)})}removeGraphic(e){this._stateSets.forEach(t=>{t.hasGraphic(e)&&e.removeObjectState(t.objectStateSet)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(e=>e.objectStateSet.removeAll())}_initializeSet(e){const t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach(i=>{i&&e.hasGraphic(i)&&i.addObjectStateSet(e.objectStateSet)}):e.ids.forEach(i=>{const n=t.get(i);n&&n.addObjectStateSet(e.objectStateSet)})}get test(){}}export{Ze as a,g as p,f as u};
