import{m as v}from"./Viewpoint-Cv8Otrne.js";import{V as st}from"./reactiveUtils-BR0C1Kq4.js";import{s as ut}from"./mathUtils-DV9iOXpW.js";import{N as Q,Q as ft,L as lt,j as B,b as P,c as K,g as mt}from"./Point-XGrwlf63.js";import{u as yt}from"./common-DQOJ18NT.js";import{f as pt,s as T,c as D,i as N,h as gt,M as xt,u as ht}from"./mat2d-D9DBP-jx.js";import{e as j}from"./mat2df64-CBKYtunK.js";import{x as bt,l as M,o as m,r as wt,B as E,e as z,v as C,y as dt,j as Gt,q as I,u as Rt,S as F}from"./vec2-maR1OrZI.js";import{n as l,t as At}from"./vec2f64-Dy6m9Nrb.js";import{w as W}from"./Extent-CBBGeHb-.js";import{k as H,L as J,K as X,O as Y}from"./projection-B2I9Bzj_.js";import{P as Z,v as kt}from"./normalizeUtils-XRAPXbWa.js";const _=96,U=39.37,St=180/Math.PI;function tt(t){return t.wkid?t:t.spatialReference||mt.WGS84}function L(t,e){return e.type?m(t,e.x,e.y):wt(t,e)}function et(t){return ft(t)}function nt(t,e,n=0){let r=t.width,o=t.height;if(n!==0){const u=ut(n),c=Math.abs(Math.cos(u)),s=Math.abs(Math.sin(u));r=t.width*c+t.height*s,o=t.width*s+t.height*c}const a=Math.max(1,e[0]),i=Math.max(1,e[1]);return Math.max(r/a,o/i)*Ft(t.spatialReference)}async function S(t,e,n,r){var u,c,s;let o,a;if(!t||Array.isArray(t)&&!t.length)return null;if(st.isCollection(t)&&(t=t.toArray()),Array.isArray(t)&&t.length&&typeof t[0]=="object"){const g=t.every(f=>"attributes"in f),y=t.some(f=>!f.geometry);let p=t;if(g&&y&&e&&e.allLayerViews){const f=new Map;for(const h of t){const b=h.layer,G=f.get(b)||[],A=h.attributes[b.objectIdField];A!=null&&G.push(A),f.set(b,G)}const x=[];f.forEach((h,b)=>{var A;const G=(A=e.allLayerViews)==null?void 0:A.find(k=>k.layer.id===b.id);if(G&&"queryFeatures"in G){const k=b.createQuery();k.objectIds=h,k.returnGeometry=!0,x.push(G.queryFeatures(k))}});const d=await Promise.all(x),R=[];for(const h of d)if(h&&h.features&&h.features.length)for(const b of h.features)b.geometry!=null&&R.push(b.geometry);p=R}for(const f of p)r=await S(f,e,n,r);return r}if(Array.isArray(t)&&t.length===2&&typeof t[0]=="number"&&typeof t[1]=="number")o=new B(t);else if(t instanceof P)o=t;else if("geometry"in t){if(t.geometry)o=t.geometry;else if(t.layer){const g=t.layer,y=(u=e.allLayerViews)==null?void 0:u.find(p=>p.layer.id===g.id);if(y&&"queryFeatures"in y){const p=g.createQuery();p.objectIds=[t.attributes[g.objectIdField]],p.returnGeometry=!0;const f=await y.queryFeatures(p);o=(s=(c=f==null?void 0:f.features)==null?void 0:c[0])==null?void 0:s.geometry}}}if(o==null)return null;switch(o.type){case"point":a=new W({xmin:o.x,ymin:o.y,xmax:o.x,ymax:o.y,spatialReference:o.spatialReference});break;case"extent":case"multipoint":case"polygon":case"polyline":a=kt(o);break;default:a=o.extent}if(!a)return null;H()||J(a.spatialReference,n)||await X();const i=Y(a,n);if(!i)return null;if(r){const g=i.center,y=g.clone();y.x=Z(g.x,r.center.x,n),y.x!==g.x&&i.centerAt(y),r=r.union(i)}else r=i;return r}function $t(t){var e;if(t&&(!Array.isArray(t)||typeof t[0]!="number")&&(typeof t=="object"||Array.isArray(t)&&typeof t[0]=="object")){if("layer"in t&&((e=t.layer)==null?void 0:e.minScale)!=null&&t.layer.maxScale!=null){const n=t.layer;return{min:n.minScale,max:n.maxScale}}if(Array.isArray(t)&&t.length&&t.every(n=>"layer"in n)){let n=0,r=0;for(const o of t){const a=o.layer;a!=null&&a.minScale&&a.maxScale&&(n=a.minScale<n?a.minScale:n,r=a.maxScale>r?a.maxScale:r)}return n&&r?{min:n,max:r}:null}}}function O(t,e){const n=tt(t);return K(n,e)||n.imageCoordinateSystem||e.imageCoordinateSystem?t:Y(t,e)}async function Xt(t,e){var R;if(!t||!e)return new v({targetGeometry:new B,scale:0,rotation:0});let n=e.spatialReference;const{constraints:r,padding:o,viewpoint:a,size:i}=e,u=[o?i[0]-o.left-o.right:i[0],o?i[1]-o.top-o.bottom:i[1]];let c=null;t instanceof v?c=t:t.viewpoint?c=t.viewpoint:t.target&&t.target.declaredClass==="esri.Viewpoint"&&(c=t.target);let s=null;c!=null&&c.targetGeometry?s=c.targetGeometry:t instanceof W?s=t:t instanceof P?s=await S(t,e,n):t&&(s=await S(t.center,e,n)||await S(t.target,e,n)||await S(t,e,n)),!s&&(a!=null&&a.targetGeometry)?s=a.targetGeometry:!s&&e.extent&&(s=e.extent),n||(n=tt(e.spatialReference||e.extent||s)),H()||K(s.spatialReference,n)||J(s.spatialReference,n)||await X();const g=O(s,n),y="center"in g?g.center:g;e.pickClosestTarget!==!1&&y.type==="point"&&((R=a.targetGeometry)==null?void 0:R.type)==="point"&&(y.x=Z(y.x,a.targetGeometry.x,y.spatialReference));let p=0;c?p=c.rotation:t.hasOwnProperty("rotation")?p=t.rotation:a&&(p=a.rotation);let f=0;f=(c==null?void 0:c.targetGeometry)!=null&&c.targetGeometry.type==="point"?c.scale:"scale"in t&&t.scale?t.scale:"zoom"in t&&t.zoom!==-1&&r&&r.effectiveLODs?r.zoomToScale(t.zoom):Array.isArray(s)||s.type==="point"||s.type==="extent"&&s.width===0&&s.height===0?a.scale:nt(O(s.extent,n),u,p);const x=$t(t.target??t);x&&(x.min&&x.min<f?f=x.min:x.max&&x.max>f&&(f=x.max));let d=new v({targetGeometry:y,scale:f,rotation:p});return r&&(d=r.fit(d),r.constrainByGeometry(d),r.rotationEnabled||(d.rotation=a.rotation)),d}function w(t,e){const n=t.targetGeometry,r=e.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}function jt(t,e,n){return n?m(t,.5*(e[0]-n.right+n.left),.5*(e[1]-n.bottom+n.top)):M(t,e,.5)}const Yt=function(){const t=l();return function(e,n,r){const o=n.targetGeometry;L(t,o);const a=.5*$(n);return e.xmin=t[0]-a*r[0],e.ymin=t[1]-a*r[1],e.xmax=t[0]+a*r[0],e.ymax=t[1]+a*r[1],e.spatialReference=o.spatialReference,e}}();function Zt(t,e,n,r,o){var a;return qt(t,e,n.center),t.scale=nt(n,r),(a=o==null?void 0:o.constraints)==null||a.constrain(t),t}function Mt(t,e,n,r){return ot(t,e,n,r),ht(t,t)}const rt=function(){const t=l();return function(e,n,r){return E(e,Lt(e,n),jt(t,n,r))}}(),vt=function(){const t=j(),e=l();return function(n,r,o,a){const i=$(r),u=V(r);return m(e,i,i),gt(t,e),T(t,t,u),N(t,t,rt(e,o,a)),N(t,t,[0,a.top-a.bottom]),m(n,t[4],t[5])}}();function $(t){var e;return t.scale*Nt((e=t.targetGeometry)==null?void 0:e.spatialReference)}function Nt(t){return Q(t)?1/(et(t)*U*_):1}function V(t){return yt(t.rotation)||0}function Ft(t){return Q(t)?et(t)*U*_:1}function Lt(t,e){return M(t,e,.5)}const at=function(){const t=l(),e=l(),n=l();return function(r,o,a,i,u,c){return bt(t,o),M(e,a,.5*c),m(n,1/i*c,-1/i*c),pt(r,e),u&&T(r,r,u),D(r,r,n),N(r,r,t),r}}(),ot=function(){const t=l();return function(e,n,r,o){const a=$(n),i=V(n);return L(t,n.targetGeometry),at(e,t,r,a,i,o)}}(),_t=function(){const t=l();return function(e,n,r,o){const a=$(n);return L(t,n.targetGeometry),at(e,t,r,a,0,o)}}();function Vt(t){const e=lt(t);return e?e.valid[1]-e.valid[0]:0}function Ut(t,e){return Math.round(Vt(t)/e)}const te=function(){const t=l(),e=l(),n=[0,0,0];return function(r,o,a){z(t,r,o),C(t,t),z(e,r,a),C(e,e),dt(n,t,e);let i=Math.acos(Gt(t,e)/(I(t)*I(e)))*St;return n[2]<0&&(i=-i),isNaN(i)&&(i=0),i}}(),ee=function(){const t=l();return function(e,n,r,o){const a=e.targetGeometry;return w(e,n),vt(t,n,r,o),a.x+=t[0],a.y+=t[1],e}}(),qt=function(t,e,n){w(t,e);const r=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,t},ne=function(){const t=l();return function(e,n,r,o,a){a||(a="center"),E(t,r,o),M(t,t,.5);const i=t[0],u=t[1];switch(a){case"center":m(t,0,0);break;case"left":m(t,-i,0);break;case"top":m(t,0,u);break;case"right":m(t,i,0);break;case"bottom":m(t,0,-u);break;case"top-left":m(t,-i,u);break;case"bottom-left":m(t,-i,-u);break;case"top-right":m(t,i,u);break;case"bottom-right":m(t,i,-u)}return q(e,n,t),e}}();function re(t,e,n){return w(t,e),t.rotation+=n,t}function ae(t,e,n){return w(t,e),t.rotation=n,t}const zt=function(){const t=l();return function(e,n,r,o,a){return w(e,n),isNaN(r)||r===0||(it(t,o,n,a),e.scale=n.scale*r,ct(t,t,e,a),q(e,e,m(t,t[0]-o[0],o[1]-t[1]))),e}}();function oe(t,e,n){return w(t,e),t.scale=n,t}const Ct=function(){const t=l();return function(e,n,r,o,a,i){return w(e,n),isNaN(r)||r===0||(it(t,a,n,i),e.scale=n.scale*r,e.rotation+=o,ct(t,t,e,i),q(e,e,m(t,t[0]-a[0],a[1]-t[1]))),e}}(),ie=function(){const t=l(),e=l();return function(n,r,o,a,i,u,c){return rt(e,u,c),Rt(t,i,e),a?Ct(n,r,o,a,t,u):zt(n,r,o,t,u)}}(),it=function(){const t=j();return function(e,n,r,o){return F(e,n,Mt(t,r,o,1))}}(),ct=function(){const t=j();return function(e,n,r,o){return F(e,n,ot(t,r,o,1))}}(),q=function(){const t=l(),e=j();return function(n,r,o){w(n,r);const a=$(r),i=n.targetGeometry;return xt(e,V(r)),D(e,e,At(a,a)),F(t,o,e),i.x+=t[0],i.y+=t[1],n}}();export{jt as $,Ct as G,nt as H,ie as R,Xt as Y,w as Z,Yt as _,Nt as a,re as b,Ft as c,_t as f,ee as g,ne as h,oe as j,q as k,ot as l,Vt as m,$ as o,te as p,rt as r,Zt as t,at as u,ae as w,qt as x,Ut as y};
