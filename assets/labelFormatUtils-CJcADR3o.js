import{c as f,n as w}from"./subclass-BR3PhgZG.js";import{d as g,e as h,m as v,a as y,p as b}from"./fieldUtils-C5R42-PY.js";import{j as x,E as $}from"./Promise-CZrWwByK.js";import{l as E}from"./intl-CArXn1et.js";import{x as F,_ as A}from"./labelUtils-Cczy0uDR.js";const p=()=>w.getLogger("esri.layers.support.labelFormatUtils"),m={type:"simple",evaluate:()=>null},T={getAttribute:(r,t)=>r.field(t)};async function U(r,t,c){if(!r||!r.symbol||!t)return m;const l=r.where,u=F(r);let n;if(u.type==="arcade"){const e=await g(u.expression,c,t);if(e==null)return m;n={type:"arcade",evaluate(s,a){try{const o="attributes"in s?e.repurposeFeature(s):s;o.contextTimeZone=a??null;const i=e.evaluate({$view:{timeZone:a},$feature:o},e.services);if(i!=null)return i.toString()}catch(o){p().error(new f("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:o,feature:s,expression:u}))}return null},needsHydrationToEvaluate:()=>A(u.expression)==null}}else n={type:"simple",evaluate:e=>u.expression.replaceAll(/{[^}]*}/g,s=>{const a=s.slice(1,-1),o=t.get(a);if(!o)return s;let i=null;return"attributes"in e?e&&e.attributes&&(i=e.attributes[o.name]):i=e.field(o.name),i==null?"":V(i,o)})};if(l){let e;try{e=await h(l,t)}catch(a){return p().error(new f("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:l,error:a})),m}const s=n.evaluate;n.evaluate=(a,o)=>{const i="attributes"in a?void 0:T;try{if(e.testFeature(a,i))return s(a,o)}catch(d){p().error(new f("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:l,feature:a,error:d}))}return null}}return n}function V(r,t){if(r==null)return"";const c=t.domain;if(c){if(c.type==="codedValue"||c.type==="coded-value"){const u=r;for(const n of c.codedValues)if(n.code===u)return n.name}else if(c.type==="range"){const{max:u,min:n}=v(t),e=+r;if(n!=null&&u!=null&&n<=e&&e<=u)return c.name}}let l=r;return y(t)?l=x(l,$("short-date")):b(t)&&(l=E(+l)),l||""}export{V as g,U as w};
