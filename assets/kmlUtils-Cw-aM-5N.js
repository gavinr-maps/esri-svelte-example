import{a as d,s as I}from"./subclass-BR3PhgZG.js";import{t as w,E as k,U as E}from"./assets-C2mb-ea2.js";import{k as x}from"./PopupTemplate-ByHks6sq.js";import{f as v}from"./Point-DB4Hp4hH.js";import{i as P,C as h,o as g,B as O}from"./aaBoundingBox-rJEWaOSN.js";import{f as S}from"./Polyline-D97hl-6E.js";import{t as F}from"./jsonUtils-CuoSmH2q.js";import{d as M}from"./FeatureSet-DyOnd9Rj.js";const $={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function q(n){var u;const r=n.folders||[],e=r.slice(),o=new Map,f=new Map,a=new Map,i=new Map,m=new Map,l={esriGeometryPoint:f,esriGeometryPolyline:a,esriGeometryPolygon:i};(((u=n.featureCollection)==null?void 0:u.layers)||[]).forEach(t=>{const p=d(t);p.featureSet.features=[];const y=t.featureSet.geometryType;o.set(y,p);const c=t.layerDefinition.objectIdField;y==="esriGeometryPoint"?G(f,c,t.featureSet.features):y==="esriGeometryPolyline"?G(a,c,t.featureSet.features):y==="esriGeometryPolygon"&&G(i,c,t.featureSet.features)}),n.groundOverlays&&n.groundOverlays.forEach(t=>{m.set(t.id,t)}),r.forEach(t=>{t.networkLinkIds.forEach(p=>{const y=C(p,t.id,n.networkLinks);y&&e.push(y)})}),e.forEach(t=>{var p;if(t.featureInfos){t.points=d(o.get("esriGeometryPoint")),t.polylines=d(o.get("esriGeometryPolyline")),t.polygons=d(o.get("esriGeometryPolygon")),t.mapImages=[];for(const y of t.featureInfos)switch(y.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const c=l[y.type].get(y.id);c&&((p=t[$[y.type]])==null||p.featureSet.features.push(c));break}case"GroundOverlay":{const c=m.get(y.id);c&&t.mapImages.push(c);break}}t.fullExtent=b([t])}});const s=b(e);return{folders:r,sublayers:e,extent:s}}function A(n,r,e,o){var i;const f=(i=w)==null?void 0:i.findCredential(n);n=k(n,{token:f==null?void 0:f.token});const a=I.kmlServiceUrl;return E(a,{query:{url:n,model:"simple",folders:"",refresh:e!==0||void 0,outSR:JSON.stringify(r)},responseType:"json",signal:o})}function B(n,r,e=null,o=[]){const f=[],a={},i=r.sublayers,m=new Set(r.folders.map(l=>l.id));return i.forEach(l=>{var u;const s=new n;if(e?s.read(l,e):s.read(l),o.length&&m.has(s.id)&&(s.visible=o.includes(s.id)),a[l.id]=s,l.parentFolderId!=null&&l.parentFolderId!==-1){const t=a[l.parentFolderId];t.sublayers||(t.sublayers=[]),(u=t.sublayers)==null||u.unshift(s)}else f.unshift(s)}),f}function G(n,r,e){e.forEach(o=>{n.set(o.attributes[r],o)})}function j(n,r){let e;return r.some(o=>o.id===n&&(e=o,!0)),e}function C(n,r,e){const o=j(n,e);return o&&(o.parentFolderId=r,o.networkLink=o),o}async function W(n){const r=M.fromJSON(n.featureSet).features,e=n.layerDefinition,o=F(e.drawingInfo.renderer),f=x.fromJSON(n.popupInfo),a=[];for(const i of r){const m=await o.getSymbolAsync(i);i.symbol=m,i.popupTemplate=f,i.visible=!0,a.push(i)}return a}function b(n){var o,f,a,i,m,l;const r=P(h),e=P(h);for(const s of n){if((f=(o=s.polygons)==null?void 0:o.featureSet)!=null&&f.features)for(const u of s.polygons.featureSet.features)S(r,u.geometry),g(e,r);if((i=(a=s.polylines)==null?void 0:a.featureSet)!=null&&i.features)for(const u of s.polylines.featureSet.features)S(r,u.geometry),g(e,r);if((l=(m=s.points)==null?void 0:m.featureSet)!=null&&l.features)for(const u of s.points.featureSet.features)S(r,u.geometry),g(e,r);if(s.mapImages)for(const u of s.mapImages)S(r,u.extent),g(e,r)}return O(e,h)?void 0:{xmin:e[0],ymin:e[1],zmin:e[2],xmax:e[3],ymax:e[4],zmax:e[5],spatialReference:v.WGS84}}export{B as S,W as b,q as d,A as g,b as j};
