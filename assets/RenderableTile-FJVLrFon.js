import{a as R,e as v}from"./DefaultUI-BwWVKFUS.js";import{t as L,e as O}from"./config-BOD8--da.js";import{n as J,l as x,r as I}from"./StyleDefinition-C2Flw6Qv.js";import{E as P}from"./enums-BRzLM11V.js";import{w as k}from"./GeometryUtils-F7QfOKlc.js";import{r as A}from"./DefaultVertexAttributeLayouts-wSIZdMhB.js";let V=class{constructor(e,s){this.sourceTile=s,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}};class Z{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function C(u,e,s,t,o,l){const a=s-o;if(a>=0)return(e>>a)+(t-(l<<a))*(u>>a);const r=-a;return e-(l-(t<<r))*(u>>r)<<r}let q=class{constructor(e,s,t){this._rows=Math.ceil(s/t),this._columns=Math.ceil(e/t),this._cellSize=t,this.cells=new Array(this._rows);for(let o=0;o<this._rows;o++){this.cells[o]=new Array(this._columns);for(let l=0;l<this._columns;l++)this.cells[o][l]=[]}}getCell(e,s){const t=Math.min(Math.max(Math.floor(s/this._cellSize),0),this._rows-1),o=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[t]&&this.cells[t][o]||null}getCellSpan(e,s,t,o){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(o/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}};function te(u,e,s,t,o,l,a){const r=e[t++];for(let n=0;n<r;n++){const c=new V(l,a);c.xTile=e[t++],c.yTile=e[t++],c.hash=e[t++],c.priority=e[t++],c.featureIndex=e[t++];const f=e[t++];for(let i=0;i<f;i++){const m=e[t++],b=e[t++],_=e[t++],d=e[t++],p=!!e[t++],g=e[t++],S=s[t++],w=s[t++],T=e[t++],M=e[t++];c.colliders.push({xTile:m,yTile:b,dxPixels:_,dyPixels:d,hard:p,partIndex:g,width:T,height:M,minLod:S,maxLod:w})}const h=u[t++];for(let i=0;i<h;i++)c.textVertexRanges.push([u[t++],u[t++]]);const y=u[t++];for(let i=0;i<y;i++)c.iconVertexRanges.push([u[t++],u[t++]]);o.push(c)}return t}function se(u,e,s){for(const[t,o]of u.symbols)z(u,e,s,o,t)}function z(u,e,s,t,o){const l=u.layerData.get(o);if(l.type===P.SYMBOL){for(const a of t){const r=a.unique;let n;if(a.selectedForRendering){const c=r.parts[0],f=c.startOpacity,h=c.targetOpacity;u.allSymbolsFadingOut=u.allSymbolsFadingOut&&h===0;const y=s?Math.floor(127*f)|h<<7:h?255:0;n=y<<24|y<<16|y<<8|y}else n=0;for(const[c,f]of a.iconVertexRanges)for(let h=c;h<c+f;h+=4)l.iconOpacity[h/4]=n;if(a.selectedForRendering){const c=r.parts[1],f=c.startOpacity,h=c.targetOpacity;u.allSymbolsFadingOut=u.allSymbolsFadingOut&&h===0;const y=s?Math.floor(127*f)|h<<7:h?255:0;n=y<<24|y<<16|y<<8|y}else n=0;for(const[c,f]of a.textVertexRanges)for(let h=c;h<c+f;h+=4)l.textOpacity[h/4]=n}l.lastOpacityUpdate=e,l.opacityChanged=!0}}function $(u,e,s,t){const o=u.colliders;let l,a,r,n;for(const c of o)if(u.unique.show&&u.unique.parts[c.partIndex].show&&(l=c.xScreen-t[0]+c.dxScreen,a=c.yScreen-t[1]+c.dyScreen,r=l+c.width,n=a+c.height,k(s,e.x,e.y,l,a,r,n)))return!0;return!1}function U(u,e,s,t,o,l){const{iconRotationAlignment:a,textRotationAlignment:r,iconTranslate:n,iconTranslateAnchor:c,textTranslate:f,textTranslateAnchor:h}=t;let y=0;for(const i of u.colliders){const[m,b]=i.partIndex===0?n:f,_=i.partIndex===0?c:h,d=i.minLod<=l&&l<=i.maxLod;y+=d?0:1,i.enabled=d,i.xScreen=i.xTile*o[0]+i.yTile*o[3]+o[6],i.yScreen=i.xTile*o[1]+i.yTile*o[4]+o[7],_===I.MAP?(i.xScreen+=s*m-e*b,i.yScreen+=e*m+s*b):(i.xScreen+=m,i.yScreen+=b),x.VIEWPORT===(i.partIndex===0?a:r)?(i.dxScreen=i.dxPixels,i.dyScreen=i.dyPixels):(i.dxScreen=s*(i.dxPixels+i.width/2)-e*(i.dyPixels+i.height/2)-i.width/2,i.dyScreen=e*(i.dxPixels+i.width/2)+s*(i.dyPixels+i.height/2)-i.height/2)}u.colliders.length>0&&y===u.colliders.length&&(u.unique.show=!1)}class oe{constructor(e,s,t,o,l,a){this._symbols=e,this._styleRepository=o,this._zoom=l,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new q(s,t,L),this._si=Math.sin(Math.PI*a/180),this._co=Math.cos(Math.PI*a/180);for(const r of e)for(const n of r.symbols)this._allNeededMatrices.has(n.tile)||this._allNeededMatrices.set(n.tile,R(n.tile.transforms.tileUnitsToPixels))}work(e){const s=this._gridIndex;function t(l){const a=l.xScreen+l.dxScreen,r=l.yScreen+l.dyScreen,n=a+l.width,c=r+l.height,[f,h,y,i]=s.getCellSpan(a,r,n,c);for(let m=h;m<=i;m++)for(let b=f;b<=y;b++){const _=s.cells[m][b];for(const d of _){const p=d.xScreen+d.dxScreen,g=d.yScreen+d.dyScreen,S=p+d.width,w=g+d.height;if(!(n<p||a>S||c<g||r>w))return!0}}return!1}const o=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const l=this._symbols[this._currentLayerCursor],a=this._getProperties(l.styleLayerUID);for(;this._currentSymbolCursor<l.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-o>e)return!1;const r=l.symbols[this._currentSymbolCursor];if(!r.unique.show)continue;U(r,this._si,this._co,a,this._allNeededMatrices.get(r.tile),this._zoom);const n=r.unique;if(!n.show)continue;const{iconAllowOverlap:c,iconIgnorePlacement:f,textAllowOverlap:h,textIgnorePlacement:y}=a;for(const i of r.colliders){if(!i.enabled)continue;const m=n.parts[i.partIndex];m.show&&!(i.partIndex?h:c)&&t(i)&&(i.hard?n.show=!1:m.show=!1)}if(n.show)for(const i of r.colliders){if(!i.enabled||(i.partIndex?y:f)||!n.parts[i.partIndex].show)continue;const m=i.xScreen+i.dxScreen,b=i.yScreen+i.dyScreen,_=m+i.width,d=b+i.height,[p,g,S,w]=this._gridIndex.getCellSpan(m,b,_,d);for(let T=g;T<=w;T++)for(let M=p;M<=S;M++)this._gridIndex.cells[T][M].push(i)}}}return!0}_getProperties(e){const s=this._styleProps.get(e);if(s)return s;const t=this._zoom,o=this._styleRepository.getStyleLayerByUID(e),l=o.getLayoutValue("symbol-placement",t)!==J.POINT;let a=o.getLayoutValue("icon-rotation-alignment",t);a===x.AUTO&&(a=l?x.MAP:x.VIEWPORT);let r=o.getLayoutValue("text-rotation-alignment",t);r===x.AUTO&&(r=l?x.MAP:x.VIEWPORT);const n=o.getPaintValue("icon-translate",t),c=o.getPaintValue("icon-translate-anchor",t),f=o.getPaintValue("text-translate",t),h=o.getPaintValue("text-translate-anchor",t),y={iconAllowOverlap:o.getLayoutValue("icon-allow-overlap",t),iconIgnorePlacement:o.getLayoutValue("icon-ignore-placement",t),textAllowOverlap:o.getLayoutValue("text-allow-overlap",t),textIgnorePlacement:o.getLayoutValue("text-ignore-placement",t),iconRotationAlignment:a,textRotationAlignment:r,iconTranslateAnchor:c,iconTranslate:n,textTranslateAnchor:h,textTranslate:f};return this._styleProps.set(e,y),y}}function F(u,e){if(u.priority-e.priority)return u.priority-e.priority;const s=u.tile.key,t=e.tile.key;return s.world-t.world?s.world-t.world:s.level-t.level?s.level-t.level:s.row-t.row?s.row-t.row:s.col-t.col?s.col-t.col:u.xTile-e.xTile?u.xTile-e.xTile:u.yTile-e.yTile}let le=class{get running(){return this._running}constructor(e,s,t,o,l,a){this._visibleTiles=e,this._symbolRepository=s,this._createCollisionJob=t,this._assignTileSymbolsOpacity=o,this._symbolLayerSorter=l,this._isLayerVisible=a,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,s){this._screenWidth===e&&this._screenHeight===s||this.restart(),this._screenWidth=e,this._screenHeight=s}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const s=performance.now();if(!this._selectionJob.work(e)||(this._selectionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-s)))===0))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const s=performance.now();if(!this._collisionJob.work(e)||(this._collisionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-s)))===0))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const s=performance.now();if(!this._opacityJob.work(e)||(this._opacityJobCompleted=!0,(e=Math.max(0,e-(performance.now()-s)))===0))return!1}return this._running=!1,!0}_createSelectionJob(){const e=this._symbolRepository.uniqueSymbols;for(let n=0;n<e.length;n++){const c=e[n];for(let f=0;f<c.uniqueSymbols.length;f++){const h=c.uniqueSymbols[f];for(const y of h.tileSymbols)y.selectedForRendering=!1}}const s=[];let t=0,o=0;const l=this._isLayerVisible;function a(n){let c;const f=performance.now();for(;o<e.length;o++,t=0){const h=e[o],y=h.styleLayerUID;if(!l(y)){s[o]||(s[o]={styleLayerUID:y,symbols:[]});continue}s[o]=s[o]||{styleLayerUID:y,symbols:[]};const i=s[o];for(;t<h.uniqueSymbols.length;t++){if(c=h.uniqueSymbols[t],t%100==99&&performance.now()-f>n)return!1;let m=null,b=!1,_=!1;for(const d of c.tileSymbols)if(!_||!b){const p=d.tile;(!m||p.isCoverage||p.neededForCoverage&&!b)&&(m=d,(p.neededForCoverage||p.isCoverage)&&(_=!0),p.isCoverage&&(b=!0))}if(m.selectedForRendering=!0,_){i.symbols.push(m),c.show=!0;for(const d of c.parts)d.show=!0}else c.show=!1}}for(const h of s)h.symbols.sort(F);return!0}const r=this._symbolLayerSorter;return{work:a,get sortedSymbols(){return s.sort(r)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,s=this._visibleTiles;let t=0;function o(l,a){for(const r of l.symbols.values())D(r,a);e(l,a);for(const r of l.childrenTiles)o(r,a)}return{work(l){const a=performance.now();for(;t<s.length;t++){if(performance.now()-a>l)return!1;const r=s[t];r.parentTile==null&&o(r,performance.now())}return!0}}}};function D(u,e){for(const s of u){const t=s.unique;for(const o of t.parts){const l=o.targetOpacity>.5?1:-1;o.startOpacity+=l*((e-o.startTime)/O),o.startOpacity=Math.min(Math.max(o.startOpacity,0),1),o.startTime=e,o.targetOpacity=t.show&&o.show?1:0}}}const W=32,N=8,E=64,H=20;class ie{constructor(e,s,t){this.tileCoordRange=e,this._visibleTiles=s,this._createUnique=t,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return this._uniqueSymbolLayerArray==null&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}get uniqueSymbolsReferences(){return this._uniqueSymbolsReferences}add(e,s){this._uniqueSymbolLayerArray=null;let t=this._tiles.get(e.id);t||(t={symbols:new Map},this._tiles.set(e.id,t));const o=new Map;if(s)for(const r of s)t.symbols.has(r)&&(o.set(r,t.symbols.get(r)),t.symbols.delete(r));else for(const[r,n]of e.layerData)t.symbols.has(r)&&(o.set(r,t.symbols.get(r)),t.symbols.delete(r));this._removeSymbols(o);const l=e.symbols,a=new Map;for(const[r,n]of l){let c=n.length;if(c>=W){let f=this.tileCoordRange;do f/=2,c/=4;while(c>N&&f>E);const h=new q(this.tileCoordRange,this.tileCoordRange,f);a.set(r,{flat:n,index:h}),t.symbols.set(r,{flat:n,index:h});for(const y of n)h.getCell(y.xTile,y.yTile).push(y)}else a.set(r,{flat:n}),t.symbols.set(r,{flat:n})}this._addSymbols(e.key,l)}deleteStyleLayers(e){this._uniqueSymbolLayerArray=null;for(const[s,t]of this._tiles){const o=new Map;for(const l of e)t.symbols.has(l)&&(o.set(l,t.symbols.get(l)),t.symbols.delete(l));this._removeSymbols(o),t.symbols.size===0&&this._tiles.delete(s)}}removeTile(e){this._uniqueSymbolLayerArray=null;const s=this._tiles.get(e.id);if(!s)return;const t=new Map;for(const[o,l]of e.symbols)s.symbols.has(o)&&(t.set(o,s.symbols.get(o)),s.symbols.delete(o));this._removeSymbols(t),s.symbols.size===0&&this._tiles.delete(e.id)}querySymbols(e,s,t,o){const l=[],a=this.uniqueSymbols;for(const r of a){const n=r.styleLayerUID,c=r.uniqueSymbols;for(const f of c){const h=f.tileSymbols.find(y=>y.selectedForRendering);h&&$(h,e,s*(window.devicePixelRatio||1),t)&&l.push({vtlSymbol:h,styleLayerUID:n,tileKey:h.tile.key})}}return l}_removeSymbols(e){for(const[s,{flat:t}]of e)for(const o of t){const l=o.unique,a=l.tileSymbols,r=a.length-1;for(let n=0;n<r;n++)if(a[n]===o){a[n]=a[r];break}if(a.length=r,r===0){const n=this._uniqueSymbolsReferences.get(s);n.delete(l),n.size===0&&this._uniqueSymbolsReferences.delete(s)}o.unique=null}}_addSymbols(e,s){if(s.size===0)return;const t=this._visibleTiles;for(const o of t)o.parentTile||o.key.world!==e.world||o.key.level===e.level&&!o.key.equals(e)||this._matchSymbols(o,e,s);for(const[o,l]of s)for(const a of l)if(a.unique==null){const r=this._createUnique();a.unique=r,r.tileSymbols.push(a);let n=this._uniqueSymbolsReferences.get(o);n||(n=new Set,this._uniqueSymbolsReferences.set(o,n)),n.add(r)}}_matchSymbols(e,s,t){if(e.key.level>s.level){const l=e.key.level-s.level;if(e.key.row>>l!==s.row||e.key.col>>l!==s.col)return}if(s.level>e.key.level){const l=s.level-e.key.level;if(s.row>>l!==e.key.row||s.col>>l!==e.key.col)return}if(s.equals(e.key)){for(const l of e.childrenTiles)this._matchSymbols(l,s,t);return}const o=new Map;for(const[l,a]of t){const r=[];for(const h of a){const y=C(this.tileCoordRange,h.xTile,s.level,s.col,e.key.level,e.key.col),i=C(this.tileCoordRange,h.yTile,s.level,s.row,e.key.level,e.key.row);y>=0&&y<this.tileCoordRange&&i>=0&&i<this.tileCoordRange&&r.push({symbol:h,xTransformed:y,yTransformed:i})}const n=[],c=(e.key.level<s.level?1:1<<e.key.level-s.level)+H,f=this._tiles.get(e.id).symbols.get(l);if(f){const h=f.flat;for(const y of r){let i,m=!1;const b=y.xTransformed,_=y.yTransformed;i=f.index!=null?f.index.getCell(b,_):h;const d=y.symbol,p=d.hash;for(const g of i)if(p===g.hash&&Math.abs(b-g.xTile)<=c&&Math.abs(_-g.yTile)<=c){const S=g.unique;d.unique=S,S.tileSymbols.push(d),m=!0;break}m||n.push(d)}}n.length>0&&o.set(l,n)}for(const l of e.childrenTiles)this._matchSymbols(l,s,o)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsReferences,s=new Array(e.size);let t,o=0;for(const[l,a]of e){const r=new Array(a.size);t=0;for(const n of a)r[t++]=n;s[o]={styleLayerUID:l,uniqueSymbols:r},o++}return s}}class ne extends A{_createTransforms(){return{displayViewScreenMat3:v(),tileMat3:v()}}}export{se as a,ne as b,te as c,oe as l,ie as r,Z as s,le as t};
