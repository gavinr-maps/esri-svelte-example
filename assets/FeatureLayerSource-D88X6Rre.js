const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./uploadAssets-CVZP1yQ9.js","./geometry-D964gYQX.js","./subclass-BZA_h8Db.js","./Extent-Bf3YTe7m.js","./tslib.es6-B3Jf3DVX.js","./Point-Cg0-ChZE.js","./Accessor-BLX9ikPh.js","./cast-Bjksrh93.js","./writer-DNAwXnhG.js","./assets-C43MgM-v.js","./index-Bh2oEzTI.js","./index-2kwcjS9-.css","./jsonMap-0cxwUWs2.js","./Polyline-D9YkgmM_.js","./mathUtils-C4_ghTv4.js","./uuid-fwrPAdZb.js","./External-B2-Xb0PD.js","./infoFor3D-C0hFfS1m.js","./uploadAssetErrors-CA2vkP4k.js","./progressUtils-DPI25tXa.js","./arcgisLayerUrl-BX1FE5Hm.js","./persistableUrlUtils-fa1mAujs.js","./meshSpatialReferenceScaleUtils-zow-o13f.js","./MeshTransform-D2t3aEmK.js","./mat4-GpOFENPA.js","./vec3f64-BLpZdpfb.js","./common-DQOJ18NT.js","./mat4f64-Dk4dwAN8.js","./quat-4pa1e6ds.js","./mat3f64-BBpwCtoL.js","./quatf64-CCm9z-pX.js","./vec32-Dvg_eL9J.js","./vec42-YcqnINSP.js","./axisAngleDegrees-Ci2HA7Jo.js","./meshFeatureAttributes-ch2d0Ntd.js","./convertMeshVertexSpace-C7nuA9_b.js","./MeshVertexAttributes-BgxxMxrG.js","./meshProperties-C4iW0Ukm.js","./vertexSpaceConversion-CPh5QK5U.js","./mat3-BRl2i9Bz.js","./spatialReferenceEllipsoidUtils-DBE_OFra.js","./computeTranslationToOriginAndRotation-Q27G6TBL.js","./projectBuffer-Bs7GwaPY.js","./geodesicConstants-DWQLYX7F.js","./projectPointToVector-GINIbYMz.js","./projection-B971H0Re.js","./SimpleObservable-KocWTzVy.js","./meshVertexSpaceUtils-CXzOFlTI.js","./MeshLocalVertexSpace-LEHwMUnu.js","./Clonable-D3rtuBWg.js","./enumeration-Ba5njXdz.js","./vec3-kbEkneOB.js","./BufferView-_QDXRCew.js","./vec2-maR1OrZI.js","./vec4-BpYqBTK4.js"])))=>i.map(i=>d[i]);
import{_ as M}from"./index-Bh2oEzTI.js";import{r as b}from"./tslib.es6-B3Jf3DVX.js";import{m as A,a as U,j as N,O as v,b as E,h as D,C as L,c as Q,n as J}from"./subclass-BZA_h8Db.js";import"./geometry-D964gYQX.js";import{U as h,V as x}from"./assets-C43MgM-v.js";import{n as k}from"./jsonMap-0cxwUWs2.js";import{m as j}from"./Loadable-BabW5Xcc.js";import{C as P,I as V,p as G}from"./Accessor-BLX9ikPh.js";import{watch as H}from"./reactiveUtils-C5zUhJQJ.js";import{r as B}from"./uuid-fwrPAdZb.js";import{w as z}from"./Extent-Bf3YTe7m.js";import{b as K}from"./MeshLocalVertexSpace-LEHwMUnu.js";import{a as W}from"./meshVertexSpaceUtils-CXzOFlTI.js";import{A as X}from"./External-B2-Xb0PD.js";import{R as T,m as C,b as Y,f as Z,j as $,y as tt,I as et}from"./applyEditsUtils-BWidamMq.js";import{u as rt}from"./clientSideDefaults-BCN5Jkqv.js";import{j as st}from"./QueryTask-C8VdGZ7z.js";import{g as at}from"./arcgisLayerUrl-BX1FE5Hm.js";import{U as I}from"./featureLayerUtils-DBsQMhTm.js";import{M as it}from"./infoFor3D-C0hFfS1m.js";import{s as ot}from"./executeQueryJSON-Cis2sczl.js";import{i as nt}from"./editsZScale-Bs7_pSzI.js";import{b as ut}from"./Query-5Xpquc1r.js";import{p as lt}from"./TimeExtent-DocT5yPf.js";import{i as pt,a as ct,o as dt,t as ht}from"./EditBusLayer-DoTks2sU.js";import{g as mt}from"./Point-Cg0-ChZE.js";import"./Polyline-D9YkgmM_.js";import"./writer-DNAwXnhG.js";import"./mathUtils-C4_ghTv4.js";import"./Promise-B2Hu02L7.js";import"./asyncUtils-CWX51uTe.js";import"./Collection-CEdjem1-.js";import"./Evented-BHRw9x22.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./Clonable-D3rtuBWg.js";import"./enumeration-Ba5njXdz.js";import"./vec3f64-BLpZdpfb.js";import"./vec32-Dvg_eL9J.js";import"./common-DQOJ18NT.js";import"./Graphic-DsxsIjhH.js";import"./PopupTemplate-BHMhS05j.js";import"./cast-Bjksrh93.js";import"./fieldUtils-tmQlKvWo.js";import"./intl-CChhNOV8.js";import"./date-DlqISzcw.js";import"./locale-C9TlLpzi.js";import"./messages-OmQvZhAg.js";import"./Color-BCS62Hs5.js";import"./colorUtils-0bJDPow9.js";import"./ActionToggle-iT4slXc7.js";import"./Identifiable-B1UbsKNt.js";import"./symbols-CNimns--.js";import"./TextSymbol-D8QO_KUV.js";import"./screenUtils-_ZIvrt5o.js";import"./materialUtils-DarhapKC.js";import"./opacityUtils-C68Tlu6_.js";import"./aaBoundingBox-BE7cC1jD.js";import"./persistableUrlUtils-fa1mAujs.js";import"./collectionUtils-D_lHIu88.js";import"./Portal-C10FKnaA.js";import"./jsonUtils-CEfjT-BK.js";import"./projection-B971H0Re.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";import"./MeshTransform-D2t3aEmK.js";import"./mat4-GpOFENPA.js";import"./mat4f64-Dk4dwAN8.js";import"./quat-4pa1e6ds.js";import"./mat3f64-BBpwCtoL.js";import"./quatf64-CCm9z-pX.js";import"./vec42-YcqnINSP.js";import"./axisAngleDegrees-Ci2HA7Jo.js";import"./editingSupport-CA_XWXsU.js";import"./normalizeUtils-EVmAQ-ak.js";import"./normalizeUtilsCommon-dT81xWiM.js";import"./utils-6jMaHUrH.js";import"./utils-Bema0iXE.js";import"./layerUtils-BrNoooE9.js";import"./QueryEngineCapabilities-DjYb9CEb.js";import"./capabilities-Y9lFlGVh.js";import"./defaultsJSON-GKolV7NZ.js";import"./DataLayerSource-BKkswDvG.js";import"./Field-ybkHhtnK.js";import"./fieldType-BuzM0UHS.js";import"./executeForIds-BCHBDnMa.js";import"./query-Dw-gv3BA.js";import"./pbfQueryUtils-B0fU-MiS.js";import"./pbf-BtDZ1BpD.js";import"./OptimizedGeometry-BF8iz5FO.js";import"./OptimizedFeature-6cJ-QFG5.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./queryZScale-w66xFVGx.js";import"./featureConversionUtils-D14h8iad.js";import"./FeatureSet-BHEkYP03.js";import"./featureQueryAll-DnVoEjkM.js";import"./SimpleRenderer-BV2L9G_n.js";import"./UniqueValueRenderer-BQtAHUSo.js";import"./diffUtils-BP7jmOAy.js";import"./colorRamps-pKd7I5WZ.js";import"./SizeVariable-936USOrb.js";import"./sizeVariableUtils-Cmcuvw-4.js";import"./visualVariableUtils-DX1kS9Se.js";import"./compilerUtils-Dw3R0f-Z.js";import"./lengthUtils-DL1-FDQQ.js";import"./ColorStop-Dk3U5tCk.js";import"./jsonUtils-Ds2Sqto-.js";import"./defaults-DZ1kfMRx.js";import"./RendererLegendOptions-B-4se3aU.js";import"./styleUtils-BYTm14n3.js";import"./AttachmentQuery-BUlkjzkx.js";import"./RelationshipQuery-DPPNeuLK.js";import"./FullTextSearch-Csd1Hktu.js";import"./timeUtils-8fb_2oAt.js";const yt=new k({originalAndCurrentFeatures:"original-and-current-features",none:"none"}),ft=new k({Started:"published",Publishing:"publishing",Stopped:"unavailable"});let g=class extends j{constructor(e){super(e),this.type="feature-layer",this.supportedSourceTypes=new Set(["Feature Layer","Oriented Imagery Layer","Table","Catalog Layer"]),this.refresh=P(async()=>{var s,a;await this.load();const t=(s=this.sourceJSON.editingInfo)==null?void 0:s.lastEditDate;if(t==null)return{dataChanged:!0,updates:{}};try{await this._fetchService(null)}catch{return{dataChanged:!0,updates:{}}}const r=t!==((a=this.sourceJSON.editingInfo)==null?void 0:a.lastEditDate);return{dataChanged:r,updates:r?{editingInfo:this.sourceJSON.editingInfo,extent:this.sourceJSON.extent}:null}}),this._ongoingAssetUploads=new Map}load(e){const t=this.layer.sourceJSON,r=this._fetchService(t,{...e}).then(()=>this.layer.setUserPrivileges(this.sourceJSON.serviceItemId,e)).then(()=>this._ensureLatestMetadata(e));return this.addResolvingPromise(r),Promise.resolve(this)}initialize(){this.addHandles([H(()=>{const e=this.layer;return e&&"lastEditsEventDate"in e?e.lastEditsEventDate:null},e=>this._handleLastEditsEventChange(e))])}destroy(){this._removeEditInterceptor()}get queryTask(){var p;const{capabilities:e,parsedUrl:t,gdbVersion:r,spatialReference:s,fieldsIndex:a}=this.layer,o="infoFor3D"in this.layer?this.layer.infoFor3D:null,i="dynamicDataSource"in this.layer?this.layer.dynamicDataSource:null,n=N("featurelayer-pbf")&&(e==null?void 0:e.query.supportsFormatPBF)&&o==null,u=((p=e==null?void 0:e.operations)==null?void 0:p.supportsQueryAttachments)??!1;return new st({url:t.path,pbfSupported:n,fieldsIndex:a,infoFor3D:o,dynamicDataSource:i,gdbVersion:r,sourceSpatialReference:s,queryAttachmentsSupported:u})}async addAttachment(e,t){await this.load();const{layer:r}=this;await I(r,"editing");const s=e.attributes[r.objectIdField],a=r.parsedUrl.path+"/"+s+"/addAttachment",o=this._getLayerRequestOptions(),i=this._getFormDataForAttachment(t,o.query);try{const n=await h(a,{body:i});return T(n.data.addAttachmentResult)}catch(n){throw this._createAttachmentErrorResult(s,n)}}async updateAttachment(e,t,r){await this.load();const{layer:s}=this;await I(s,"editing");const a=e.attributes[s.objectIdField],o=s.parsedUrl.path+"/"+a+"/updateAttachment",i=this._getLayerRequestOptions({query:{attachmentId:t}}),n=this._getFormDataForAttachment(r,i.query);try{const u=await h(o,{body:n});return T(u.data.updateAttachmentResult)}catch(u){throw this._createAttachmentErrorResult(a,u)}}async applyEdits(e,t){var S,R;await this.load();const{layer:r}=this;await I(r,"editing");const s="infoFor3D"in r?r.infoFor3D:null,a=s!=null,o=a||((t==null?void 0:t.globalIdUsed)??!1),i=a?await this._uploadMeshesAndGetAssetMapEditsJSON(e):null,n=((S=e.addFeatures)==null?void 0:S.map(_=>C(this.layer,_,s)))??[],u=(await Promise.all(n)).filter(v),p=((R=e.updateFeatures)==null?void 0:R.map(_=>C(this.layer,_,s)))??[],l=(await Promise.all(p)).filter(v),f=Y(this.layer,e.deleteFeatures,o);nt(u,l,r.spatialReference);const O=await Z(this.layer,e),w=r.capabilities.editing.supportsAsyncApplyEdits&&a,c=(t==null?void 0:t.gdbVersion)||r.gdbVersion,d={gdbVersion:c,rollbackOnFailure:t==null?void 0:t.rollbackOnFailureEnabled,useGlobalIds:o,returnEditMoment:t==null?void 0:t.returnEditMoment,usePreviousEditMoment:t==null?void 0:t.usePreviousEditMoment,async:w};await pt(this.layer.url,c,!0);const F=ct(this.layer.url,c||null);if(await dt(r.url,c,r.historicMoment))throw new E("feature-layer-source:historic-version","Editing a historic version is not allowed");t!=null&&t.returnServiceEditsOption?(d.edits=JSON.stringify([{id:r.layerId,adds:u.length?u:null,updates:l.length?l:null,deletes:f.length?f:null,attachments:O,assetMaps:i}]),d.returnServiceEditsOption=yt.toJSON(t==null?void 0:t.returnServiceEditsOption),d.returnServiceEditsInSourceSR=t==null?void 0:t.returnServiceEditsInSourceSR):(d.adds=u.length?JSON.stringify(u):null,d.updates=l.length?JSON.stringify(l):null,d.deletes=f.length?o?JSON.stringify(f):f.join(","):null,d.attachments=O&&JSON.stringify(O),d.assetMaps=i!=null?JSON.stringify(i):void 0);const m=this._getLayerRequestOptions({method:"post",query:d});F&&(m.authMode="immediate",m.query.returnEditMoment=!0,m.query.sessionId=ht);const q=t!=null&&t.returnServiceEditsOption?r.url:r.parsedUrl.path;let y;try{y=w?await this._asyncApplyEdits(q+"/applyEdits",m):await h(q+"/applyEdits",m)}catch(_){if(!$(_))throw _;m.authMode="immediate",y=w?await this._asyncApplyEdits(q+"/applyEdits",m):await h(q+"/applyEdits",m)}return this._createEditsResult(y)}async deleteAttachments(e,t){await this.load();const{layer:r}=this;await I(r,"editing");const s=e.attributes[r.objectIdField],a=r.parsedUrl.path+"/"+s+"/deleteAttachments";try{return(await h(a,this._getLayerRequestOptions({query:{attachmentIds:t.join(",")},method:"post"}))).data.deleteAttachmentResults.map(T)}catch(o){throw this._createAttachmentErrorResult(s,o)}}fetchRecomputedExtents(e={}){const t=e.signal;return this.load({signal:t}).then(async()=>{const r=this._getLayerRequestOptions({...e,query:{returnUpdates:!0}}),{layerId:s,url:a}=this.layer,{data:o}=await h(`${a}/${s}`,r),{id:i,extent:n,fullExtent:u,timeExtent:p}=o,l=n||u;return{id:i,fullExtent:l&&z.fromJSON(l),timeExtent:p&&lt.fromJSON({start:p[0],end:p[1]})}})}async queryAttachments(e,t={}){await this.load();const r=this._getLayerRequestOptions(t);return this.queryTask.executeAttachmentQuery(e,r)}async queryFeatures(e,t){var s;await this.load();const r=await this.queryTask.execute(e,{...t,query:this._createRequestQueryOptions(t)});return(s=e.outStatistics)!=null&&s.length&&r.features.length&&r.features.forEach(a=>{var i;const o=a.attributes;(i=e.outStatistics)==null||i.forEach(({outStatisticFieldName:n})=>{if(n){const u=n.toLowerCase();u&&u in o&&n!==u&&(o[n]=o[u],delete o[u])}})}),r}async queryFeaturesJSON(e,t){return await this.load(),this.queryTask.executeJSON(e,{...t,query:this._createRequestQueryOptions(t)})}async queryObjectIds(e,t){return await this.load(),this.queryTask.executeForIds(e,{...t,query:this._createRequestQueryOptions(t)})}async queryFeatureCount(e,t){return await this.load(),this.queryTask.executeForCount(e,{...t,query:this._createRequestQueryOptions(t)})}async queryExtent(e,t){return await this.load(),this.queryTask.executeForExtent(e,{...t,query:this._createRequestQueryOptions(t)})}async queryRelatedFeatures(e,t){return await this.load(),this.queryTask.executeRelationshipQuery(e,{...t,query:this._createRequestQueryOptions(t)})}async queryRelatedFeaturesCount(e,t){return await this.load(),this.queryTask.executeRelationshipQueryForCount(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopFeatures(e,t){return await this.load(),this.queryTask.executeTopFeaturesQuery(e,{...t,query:this._createRequestQueryOptions(t)})}async queryBins(e,t){return await this.load(),this.queryTask.executeBinsQuery(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopObjectIds(e,t){return await this.load(),this.queryTask.executeForTopIds(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopExtents(e,t){return await this.load(),this.queryTask.executeForTopExtents(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopCount(e,t){return await this.load(),this.queryTask.executeForTopCount(e,{...t,query:this._createRequestQueryOptions(t)})}async fetchPublishingStatus(){if(!at(this.layer.url))return"unavailable";const e=x(this.layer.url,"status"),t=await h(e,{query:{f:"json"}});return ft.fromJSON(t.data.status)}async uploadAssets(e,t){const{uploadAssets:r}=await M(()=>import("./uploadAssets-CVZP1yQ9.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34]),import.meta.url);return r(e,{layer:this.layer,ongoingUploads:this._ongoingAssetUploads},t)}_handleLastEditsEventChange(e){var s,a,o,i;const t=this.layer;if(e==null||!("capabilities"in t)||!("effectiveCapabilities"in t)||!(!((a=(s=t.capabilities)==null?void 0:s.operations)!=null&&a.supportsEditing)&&((i=(o=t.effectiveCapabilities)==null?void 0:o.operations)!=null&&i.supportsEditing)))return;const r=t.url;r!=null&&("layerId"in t&&x(r,t.layerId.toString()),this._getOrCreateEditInterceptor(r).before=n=>{const u=n.requestOptions.method??"auto";if(u==="auto"||u==="head"){const p=n.requestOptions.query??{};p._ts=e.getTime(),n.requestOptions.query=p}})}_getOrCreateEditInterceptor(e){return this._editInterceptor==null&&(this._editInterceptor={urls:e},D.request.internalInterceptors.push(this._editInterceptor)),this._editInterceptor}_removeEditInterceptor(){this._editInterceptor!=null&&(L(D.request.internalInterceptors,this._editInterceptor),this._editInterceptor=null)}async _asyncApplyEdits(e,t){const r=(await h(e,t)).data.statusUrl;for(;;){const s=(await h(r,{query:{f:"json"},responseType:"json"})).data;switch(s.status){case"Completed":return h(s.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new E("async-applyEdits-failed","asynchronous applyEdits call failed.");case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new E("async-applyEdits-failed","asynchronous applyEdits call failed (undefined response status)")}await V(gt)}}_createRequestQueryOptions(e){const t={...this.layer.customParameters,token:this.layer.apiKey,...e==null?void 0:e.query};return this.layer.datesInUnknownTimezone&&(t.timeReferenceUnknownClient=!0),t}async _fetchService(e,t){if(!e){const s={};N("featurelayer-advanced-symbols")&&(s.returnAdvancedSymbols=!0),t!=null&&t.cacheBust&&(s._ts=Date.now());const{data:a}=await h(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:s,signal:t==null?void 0:t.signal}));e=a}this.sourceJSON=await this._patchServiceJSON(e,t==null?void 0:t.signal);const r=e.type;if(!this.supportedSourceTypes.has(r))throw new E("feature-layer-source:unsupported-type",`Source type "${r}" is not supported`)}async _patchServiceJSON(e,t){var r;if(e.type!=="Table"&&e.geometryType&&!((r=e==null?void 0:e.drawingInfo)!=null&&r.renderer)&&!e.defaultSymbol){const s=rt(e.geometryType).renderer;Q("drawingInfo.renderer",s,e)}if(e.geometryType==="esriGeometryMultiPatch"&&e.infoFor3D&&(e.geometryType="mesh"),e.extent==null)try{const{data:s}=await h(this.layer.url,this._getLayerRequestOptions({signal:t}));s.spatialReference&&(e.extent={xmin:0,ymin:0,xmax:0,ymax:0,spatialReference:s.spatialReference})}catch(s){G(s)}return e}async _ensureLatestMetadata(e){if(this.layer.userHasUpdateItemPrivileges&&this.sourceJSON.cacheMaxAge>0)return this._fetchService(null,{...e,cacheBust:!0})}async _uploadMeshesAndGetAssetMapEditsJSON(e){const{addAssetFeatures:t}=e;if(!(t!=null&&t.length)||await this._areAllAssetsAlreadyMapped(t))return null;const r=e.addFeatures.filter(o=>o.geometry);if(t.length!==r.length+e.updateFeatures.length)throw new E("feature-layer-source:unsupported-mesh-edits","Mixing attribute only edits with mesh geometry edits is not currently supported");const s=new Array,a=new Map;for(const o of t){const{geometry:i}=o,{vertexSpace:n}=i;if(W(n))s.push(i);else{const u=i.origin,{convertMeshVertexSpace:p}=await M(async()=>{const{convertMeshVertexSpace:f}=await import("./convertMeshVertexSpace-C7nuA9_b.js");return{convertMeshVertexSpace:f}},__vite__mapDeps([35,2,6,36,4,9,10,11,7,37,38,14,5,8,12,39,26,29,24,25,27,31,40,41,42,43,44,45,46,3,13,47,48,49,50,51,52,53,32,54]),import.meta.url),l=await p(i,new K({origin:[u.x,u.y,u.z??0]}));a.set(l,i),o.geometry=l,s.push(l)}}await this.uploadAssets(s);for(const[o,i]of a)i.addExternalSources(o.metadata.externalSources.items);return{adds:this._getAssetMapEditsJSON(t),updates:[],deletes:[]}}_getAssetMapEditsJSON(e){const t=new Array,r=this.layer.globalIdField,s=this.layer.parsedUrl;for(const a of e){const o=a.geometry,{metadata:i}=o,n=i.getExternalSourcesOnService(s),u=a.getAttribute(r);if(n.length===0){J.getLogger(this).error(`Skipping feature ${u}. The mesh it is associated with has not been uploaded to the service and cannot be mapped to it.`);continue}const{source:p}=n.find(X)??n[0];for(const l of p)l.parts.length===1?t.push({globalId:B(),parentGlobalId:u,assetName:l.assetName,assetHash:l.parts[0].partHash,flags:[]}):J.getLogger(this).error(`Skipping asset ${l.assetName}. It does not have exactly one part, so we cannot map it to a feature.`)}return t}_createEditsResult(e){const t=e.data,{layerId:r}=this.layer,s=[];let a=null;if(Array.isArray(t))for(const i of t)s.push({id:i.id,editedFeatures:i.editedFeatures}),i.id===r&&(a={addResults:i.addResults??[],updateResults:i.updateResults??[],deleteResults:i.deleteResults??[],attachments:i.attachments,editMoment:i.editMoment});else a=t;const o=tt(a);if(s.length>0){o.editedFeatureResults=[];for(const i of s){const{editedFeatures:n}=i,u=n!=null&&n.spatialReference?new mt(n.spatialReference):null;o.editedFeatureResults.push({layerId:i.id,editedFeatures:et(n,u)})}}return o}_createAttachmentErrorResult(e,t){var a;const r=((a=t.details.messages)==null?void 0:a[0])||t.message,s=t.details.httpStatus||t.details.messageCode;return{objectId:e,globalId:null,error:new E("feature-layer-source:attachment-failure",r,{code:s})}}_getFormDataForAttachment(e,t){const r=e instanceof FormData?e:e&&e.elements?new FormData(e):null;if(r)for(const s in t){const a=t[s];a!=null&&(r.set?r.set(s,a):r.append(s,a))}return r}_getLayerRequestOptions(e={}){const{layer:t,layer:{parsedUrl:r,gdbVersion:s}}=this;return{...e,query:{gdbVersion:s,layer:"dynamicDataSource"in t&&t.dynamicDataSource?JSON.stringify({source:t.dynamicDataSource}):void 0,...r.query,f:"json",...this._createRequestQueryOptions(e)},responseType:"json"}}async _areAllAssetsAlreadyMapped(e){const{layer:t}=this,{globalIdField:r,parsedUrl:s}=t,a="infoFor3D"in t?t.infoFor3D:null;if(a==null||r==null)return!1;const o=it(a);if(o==null)return!1;const i=x(s.path,`../${o.id}`),n=new Array;for(const c of e){if(!(c.geometry.metadata.getExternalSourcesOnService(s).length>0))return!1;n.push(c)}const u=n.map(c=>c.getAttribute(r)).filter(v);if(u.length===0)return!1;const{assetMapFieldRoles:{parentGlobalId:p,assetHash:l}}=a,f=new ut({where:`${p} IN (${u.map(c=>`'${c}'`)})`,outFields:[l,p],returnGeometry:!1}),O=await ot(i,f),{features:w}=O;return w.length!==0&&!n.some(c=>{const d=c.getAttribute(r);if(!d)return!0;const{metadata:F}=c.geometry,m=w.filter(y=>y.getAttribute(p)===d);if(m.length===0)return!0;const q=m.map(y=>y.getAttribute(l));return F.getExternalSourcesOnService(s).flatMap(({source:y})=>y.flatMap(S=>S.parts.map(R=>R.partHash))).some(y=>q.every(S=>y!==S))})}};b([A()],g.prototype,"type",void 0),b([A({constructOnly:!0})],g.prototype,"layer",void 0),b([A({constructOnly:!0})],g.prototype,"supportedSourceTypes",void 0),b([A({readOnly:!0})],g.prototype,"queryTask",null),g=b([U("esri.layers.graphics.sources.FeatureLayerSource")],g);const gt=1e3,br=g;export{br as default};
