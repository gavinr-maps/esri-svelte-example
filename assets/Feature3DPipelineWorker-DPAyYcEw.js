import{r as w,m as I,a as ie,g as pe,a6 as se,G as fe,M as V,E as ge,s as _e,D as N}from"./Accessor-BHnuXKD2.js";import{i as oe}from"./Evented-DCWccWGU.js";import{d as we,P as ye}from"./reactiveUtils-BR0C1Kq4.js";import{w as xe}from"./Extent-CBBGeHb-.js";import{Q as be,O as Ie}from"./projection-B2I9Bzj_.js";import{g as X}from"./Point-XGrwlf63.js";import{L as Ce}from"./QueryEngine-BJMZSAnZ.js";import{b as Y}from"./Query-DCBIeen2.js";import{s as Z}from"./ReactiveMap-Dwhwbx9R.js";import{r as ve}from"./signal-DSa0yokC.js";import{c as $e,R as Ae,k as Se,J as Re}from"./Polyline-BmuD2-ZN.js";import{s as M,n as ae,a as Te,i as Oe}from"./memoryEstimations-5gFNwkKK.js";import{s as Ee,E as de}from"./PooledRBush-BHbZLwLz.js";import{n as Me}from"./OptimizedFeature-DcMLlxvB.js";import{e as W}from"./OptimizedGeometry-7IxBWtHr.js";import{d as Be}from"./query-BS_L6I0Q.js";import{a as Fe}from"./pbf-CFI-xDDp.js";import{n as k,u as K}from"./vec3f64-BLpZdpfb.js";import{a as Pe,u as je,b as Le}from"./aaBoundingBox-CeBivBRq.js";import{u as Ge}from"./quantizationUtils-2Az-xHPA.js";import{Z as ke}from"./FieldsIndex-DFdVonga.js";import{b as De,h as Qe}from"./pbfQueryUtils-AwPAOS5M.js";import{l as Ne}from"./ViewingMode-Dodu7ZZk.js";import{o as We,t as Ue}from"./Indices-Db9lERgy.js";import{R as ze}from"./FeaturePipelineRenderManager-Sg5Liknk.js";import{n as He,h as Je,s as qe,o as Ve,f as Xe}from"./mat4-Fi6iAz29.js";import{e as B}from"./mat4f64-Dk4dwAN8.js";import{V as Ye,X as Ze}from"./FloatArray-BCfeX8wo.js";import{e as f}from"./VertexAttribute-Cq4MnHjR.js";import{z as Ke}from"./DefaultMaterial-B5sYRDQR.js";import{o as et}from"./projectBuffer-DOU0xvVi.js";import{n as tt}from"./projectVectorToVector-dS8io47t.js";import{m as rt}from"./computeTranslationToOriginAndRotation-BT43Xu5d.js";import{g as nt,U as it}from"./Graphic-CFXUQZlS.js";import{D as st}from"./graphicUtils-Daa6cjYT.js";import{c as ot}from"./GeometryUtil-vHI0hYMT.js";import{t as A}from"./Attribute-B-NAci_J.js";import{B as at}from"./RenderCoordsHelper-BbefYyBA.js";import"./SimpleObservable-7oieNGD8.js";import"./index-tefRSezt.js";import"./cast-BA_-jlhc.js";import"./JSONSupport-CGdeqxpk.js";import"./writer-B2bQV2uU.js";import"./jsonUtils-Cu7OBRmN.js";import"./featureConversionUtils-DpmsPUmt.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./WhereClauseCache-CrfkeLux.js";import"./LRUCache-DS2O1kTf.js";import"./MemCache-CDoaVBHf.js";import"./WhereClause-diW5rNp6.js";import"./TimeOnly-yGYcAQQJ.js";import"./opacityUtils-CSd4XoR2.js";import"./Promise-CmQqe-ke.js";import"./mathUtils-DV9iOXpW.js";import"./fieldType-L-VlbZqy.js";import"./timeSupport-Cvj97qZO.js";import"./queryUtils-DBeaQ3x_.js";import"./normalizeUtils-XRAPXbWa.js";import"./normalizeUtilsCommon-D0zPTJCj.js";import"./utils-Cy8wFNQo.js";import"./utils-CkSELPnj.js";import"./json-Wa8cmqdu.js";import"./QueryEngineCapabilities-DZTubngj.js";import"./timeUtils-D2X862bk.js";import"./utils-D8exU0T6.js";import"./screenUtils-_ZIvrt5o.js";import"./heatmapUtils-DA7NmY3d.js";import"./vec42-YcqnINSP.js";import"./common-DQOJ18NT.js";import"./vec4f64-o2zAXfmz.js";import"./utils-DLmnG8WZ.js";import"./mat4f32-DcsiF_Rp.js";import"./intl-Do3GEEJ7.js";import"./timeZoneUtils-COos5xIr.js";import"./utils-B8VMZhYy.js";import"./ClassBreaksDefinition-DvZJqFCP.js";import"./enumeration-Cr5WIZs4.js";import"./SnappingCandidate-O5eRSE6e.js";import"./FixedIntervalBinParameters-uigAmvtd.js";import"./NormalizationBinParametersMixin-D6iHLB7I.js";import"./Clonable-DvJsj5LF.js";import"./Scheduler-B_GuBefw.js";import"./debugFlags-ZrDyTcDc.js";import"./typeUtils-BSg8Y507.js";import"./Field-Cyk7Ur5d.js";import"./FullTextSearch-BWm_kPUE.js";import"./TimeExtent-J5qnUFx_.js";import"./quickselect-QQC62dOK.js";import"./queryZScale-DwN6mTru.js";import"./DepthRange-C25RnOB3.js";import"./vec2-maR1OrZI.js";import"./vec2f64-Dy6m9Nrb.js";import"./Material-Ba8x5bbY.js";import"./boundedPlane-Dyz2ub5d.js";import"./sphere-DQxj5tsv.js";import"./vec32-Dvg_eL9J.js";import"./mat3-CR8GKnhD.js";import"./mat3f64-BBpwCtoL.js";import"./plane-4dpuo6-e.js";import"./quatf64-CCm9z-pX.js";import"./mathUtils-B9R7G-2c.js";import"./lineSegment-C-CDF7QX.js";import"./NoParameters-t-PuNrgq.js";import"./basicInterfaces-CZwQPxTp.js";import"./glUtil-D0YUa0ow.js";import"./enums-D9v74xTE.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./Matrix3PassUniform-Bhi2fM3C.js";import"./BindType-BBwFZqyN.js";import"./RenderPlugin-B2sz29jJ.js";import"./DrawParameters-C0gywgJQ.js";import"./LodRenderer-DrfQ8MMz.js";import"./InterleavedLayout-Dvj-Snan.js";import"./BufferView-_QDXRCew.js";import"./types-D0PSWh4d.js";import"./RenderCamera-BovI3JTe.js";import"./Octree-B-jwmuW2.js";import"./intersectorUtils-l6zkk4nF.js";import"./BufferObject-CIl3vJtA.js";import"./Texture-D-SqNa4i.js";import"./getDataTypeBytes-BTGR5GyG.js";import"./VertexArrayObject-DcVjXzZo.js";import"./sdfPrimitives-B8Jbwvqs.js";import"./doublePrecisionUtils-B0owpBza.js";import"./floatRGBA-CR2j2c7-.js";import"./HighlightDefaults-ESbuT2uR.js";import"./Color-gncXBiLc.js";import"./colorUtils-Rxh2V3ai.js";import"./RealisticTree.glsl-BIYA2y1x.js";import"./Intersector-DqUGp7Vs.js";import"./verticalOffsetUtils-CUH6QZ7-.js";import"./orientedBoundingBox-9z4w3ZAL.js";import"./quat-4pa1e6ds.js";import"./spatialReferenceEllipsoidUtils-DM073JUd.js";import"./Intersector-DPK4WnQE.js";import"./glsl-BH37Aalp.js";import"./ShaderBuilder-DV1s2efh.js";import"./NormalAttribute.glsl-BPQl43kJ.js";import"./SceneLighting-fZH2UQ_L.js";import"./HUDMaterial-DRUv4rua.js";import"./HUDVisibility.glsl-DSeZY4v-.js";import"./VerticalOffset.glsl-0YVQE7vQ.js";import"./BooleanBindUniform-xvVHJCDz.js";import"./HUDRenderStyle-BhGvVxgm.js";import"./GLTextureMaterial-BXvkeRxQ.js";import"./DefaultBufferWriter-D4XUxbP-.js";import"./RgbaFloatEncoding.glsl-_io2eW3M.js";import"./Float2PassUniform-Blij1ug3.js";import"./Float4DrawUniform-C_Hqa-pI.js";import"./renderState-e7QeQoUO.js";import"./ShaderTechniqueConfiguration-YrUOztAU.js";import"./triangle-D_E6eTS3.js";import"./lengthUtils-DjJgJFRg.js";import"./requestImageUtils-Brn0e8z8.js";import"./TextureFormat-1mYWTFa-.js";import"./VertexColor.glsl-C67vI27I.js";import"./Matrix3DrawUniform-B_gSHO7v.js";import"./Matrix4PassUniform-LFIUaE9i.js";import"./Matrix4sPassUniform--uPzDbTP.js";import"./CameraSpace.glsl-BZ4Eapt3.js";import"./geodesicConstants-yASAK_zX.js";import"./projectPointToVector-BS0u8fq6.js";import"./ActionToggle-__-l4AdQ.js";import"./Identifiable-BrT7zvUW.js";import"./TextSymbol-BQ_NW9Xo.js";import"./collectionUtils-CbaToa73.js";import"./Portal-CTRRujjZ.js";import"./meshVertexSpaceUtils-SW0WEjNN.js";import"./MeshLocalVertexSpace-C0YDTRex.js";import"./hydratedFeatures-BVVSs98j.js";import"./vec3f32-nZdmKIgz.js";import"./projectVectorToPoint-d6Mr4zvQ.js";import"./dehydratedFeatureUtils-1rrRm6hF.js";let _=class extends pe{constructor(e){super(e),this._updatingCount=0,this._tileHandles=new Z,this._wanted=new Z}destroy(){for(const e of this._tileHandles.values())e.abort();this._tileHandles.clear(),this._wanted.clear()}get updating(){return this._updatingCount>0}get _boundingRect(){const{extent:e}=this;return e==null?null:$e(e)}get _missingTiles(){const e=new Array,t=this._wanted;for(const r of this._tileHandles.values())t.has(r.id)&&!E(r)&&e.push(r);return e}async onTileTreeChange(e){++this._updatingCount;try{const{added:t,removed:r}=e,n=this._tileHandles,{_boundingRect:i}=this,o=i!=null?t.filter(c=>Ae(i,c.extent)):t,a=this._wanted,l=new Array;for(const c of r){const{id:d}=c;if(a.delete(d),t.some(p=>$(p,c)||$(c,p)))continue;const u=n.get(d);u!=null&&l.push(this._removeTile(u))}for(const c of o)a.set(c.id,c),l.push(this._addTile(c));await Promise.allSettled(l)}finally{--this._updatingCount}}async _removeTile(e){this._tileHandles.delete(e.id),e.abort(),this._validate();const{tile:t}=e,r=new T(e.untilSettled(),t!=null?this.createRemoveTileCommand(t):null);e.nextEvent=null;const{command:n}=await r.getCommand();n==null||n.execute()}async _addTile(e){const{_tileHandles:t}=this,r=t.get(e.id);if(r!=null)return!E(r)||r.tile.isComplete||(r.tile=r.tile.reset(),r.nextEvent=this._onTileLoad(r)),void await r.untilSettled();const n=new dt(e);this._tileHandles.set(n.id,n);const i=this.loadTile(e,n.signal);n.nextEvent=i;const o=await i;if(n.aborted)throw se();n.tile=o,lt(n),n.nextEvent=this._onTileLoad(n),await n.untilSettled()}async _onTileLoad(e){const{_wanted:t,_tileHandles:r,_missingTiles:n}=this,i=e.descriptor,o=new Array,a=new Array,l=new Set;for(const d of r.values()){if(d===e)continue;const{descriptor:u,id:p}=d;if(t.has(p)||n.some(({descriptor:m})=>$(m,u)||$(u,m))){if(E(d)){if($(i,u)){const m=d.tile;for(const h of m.objectIds())l.add(h)}if($(u,i)){const m=e.tile,h=new Set(m.objectIds()),g=d.tile,y=g.exclude(h);d.tile=y;const x=AbortSignal.any([d.signal,e.signal]),b=d.untilSettled();o.push(new T(b,this.createRemoveTileCommand(g))),o.push(new T(b,this.createAddTileCommand(y,x),x)),a.push(d),this._validateRemoval(y,h)}}}else{d.abort(),r.delete(p);const{tile:m}=d;m!=null&&o.push(new T(d.untilSettled(),this.createRemoveTileCommand(m))),d.nextEvent=null}}l.size>0&&(e.tile=e.tile.exclude(l),this._validateRemoval(e.tile,l)),o.push(new T(e.untilSettled(),this.createAddTileCommand(e.tile,e.signal),e.signal)),a.push(e),this._validate();const c=this._joinCommands(o);for(const d of a)d.nextEvent=c;await c}async _joinCommands(e){const t=(await Promise.allSettled(e.map(async r=>r.getCommand()))).map(r=>{var n;return r.status!=="fulfilled"||(n=r.value.signal)!=null&&n.aborted?null:r.value.command}).filter(fe);t.length!==0&&t.reduce((r,n)=>(r.append(n),r)).execute()}_validate(){if(!V("feature-pipeline-3d-test-validation"))return;const e=new Array;for(const t of this._tileHandles.values()){if(!E(t))continue;const{tile:r}=t,n=r.featureCount,i=new Uint32Array(n);r.readObjectIds(i),e.push({tile:r,objectIds:new Set(i)})}for(let t=0;t<e.length;++t){const{tile:r,objectIds:n}=e[t];for(let i=t+1;i<e.length;++i){const{tile:o,objectIds:a}=e[i];for(const l of a)if(n.has(l)){const c=$(o.descriptor,r.descriptor),d=$(r.descriptor,o.descriptor);throw new Error(`${r.descriptor.id} and ${o.descriptor.id} both contain ${l}. aInB: ${c}; bInA: ${d}`)}}}}_validateRemoval(e,t){if(V("feature-pipeline-3d-test-validation")){for(const r of e.objectIds())if(t.has(r))throw new Error(`Failed to remove ${r} from ${e.descriptor.id}!`)}}};function $({lij:[s,e,t]},{lij:[r,n,i]}){const o=r-s;return o>=0&&e===n>>o&&t===i>>o}w([I()],_.prototype,"updating",null),w([I({constructOnly:!0})],_.prototype,"loadTile",void 0),w([I({constructOnly:!0})],_.prototype,"createAddTileCommand",void 0),w([I({constructOnly:!0})],_.prototype,"createRemoveTileCommand",void 0),w([I()],_.prototype,"_updatingCount",void 0),w([I()],_.prototype,"extent",void 0),w([I()],_.prototype,"_boundingRect",null),w([I()],_.prototype,"_missingTiles",null),_=w([ie("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],_);let dt=class{constructor(e){this.descriptor=e,this._controller=new AbortController,this._tile=ve(null),this.nextEvent=null}get id(){return this.descriptor.id}get tile(){return this._tile.value}set tile(e){this._tile.value=e}get signal(){return this._controller.signal}abort(){this._controller.abort()}get aborted(){return this._controller.signal.aborted}async untilSettled(){try{await this.nextEvent}catch(e){ge(e)||console.error(e)}}};function E(s){return s.tile!=null}function lt(s){if(!E(s))throw new Error}let T=class{constructor(e,t,r){this.previousEventSettled=e,this.commandPromise=t,this.signal=r}async getCommand(){const{previousEventSettled:e,commandPromise:t,signal:r}=this,[n]=await Promise.all([t,e]);if(r!=null&&r.aborted)throw se();return{command:n,signal:r}}},ct=class U{constructor(e,t){this.tile=e,this._tileIndices=t}get id(){return this.tile.id}get featureCount(){var e;return((e=this._tileIndices)==null?void 0:e.length)??this.tile.featureCount}get usedMemory(){var e;return M+(((e=this._tileIndices)==null?void 0:e.byteLength)??0)}get extent(){return this.tile.descriptor.extent}readObjectIds(e,t){const{_tileIndices:r,tile:n}=this;return n.readObjectIds(e,r,t)}readCoordinates(e,t){const{_tileIndices:r,tile:n}=this;return n.readCoordinates(e,r,t)}subset(e){const{_tileIndices:t,tile:r}=this;if(t==null)return new U(r,e);const n=new Uint32Array(e.length);for(let i=0;i<n.length;++i)n[i]=t[e[i]];return new U(r,n)}},ut=class{constructor(){this._tileToFeatureData=new Map}add(e){this._tileToFeatureData.set(e.tile,e)}remove(e){this._tileToFeatureData.delete(e)}get(e){return this._tileToFeatureData.get(e)}},z=class{constructor(e,t){this._index=e,this._view=t}get usedMemory(){return M+ae}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(e){return this._view.getAttribute(this._index,e)}getAttributeAsTimestamp(e){return this._view.getAttributeAsTimestamp(this._index,e)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(e){return this._view.getCentroid(this._index,e)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(e){return new mt(this._index,this._view,e)}},mt=class extends z{constructor(e,t,r){super(e,t),this._geometryOverride=r}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return Me(new W,this._geometryOverride,e.hasZ,e.hasM)}};class ht{constructor(){this._tileBounds=new Map,this.events=new oe,this.featureAdapter=H.shared}get usedMemory(){return M+M*this._tileBounds.size}addTile(e){const{featureCount:t}=e;if(t===0)return;const r=new Ee(9,i=>e.getBounds(i)),n=new Array;for(let i=0;i<t;++i)n[i]=i;r.load(n),this._tileBounds.set(e,r),this.events.emit("changed")}removeTile(e){this._tileBounds.delete(e),this.events.emit("changed")}clear(){this._tileBounds.clear(),this.events.emit("changed")}forEach(e){for(const[t,r]of this._tileBounds)r.all(n=>e(new z(n,t)))}forEachInBounds(e,t){O.minX=e[0],O.minY=e[1],O.maxX=e[2],O.maxY=e[3];for(const[r,n]of this._tileBounds)n.search(O,i=>t(new z(i,r)))}forEachBounds(e,t){for(const r of e)t(r.getBoundingBox())}getFullExtent(e){let t=1/0,r=1/0,n=-1/0,i=-1/0;for(const o of this._tileBounds.values()){const{minX:a,minY:l,maxX:c,maxY:d}=o.toJSON();t=Math.min(t,a),r=Math.min(r,l),n=Math.min(n,c),i=Math.min(i,d)}return{xmin:t,ymin:r,xmax:n,ymax:i,spatialReference:e}}}let H=class{getObjectId(e){return e.getObjectId()}getAttribute(e,t){return e.getAttribute(t)}getAttributeAsTimestamp(e,t){return e.getAttributeAsTimestamp(t)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,t){return e.getCentroid(t)}cloneWithGeometry(e,t){return e.cloneWithGeometry(t)}};H.shared=new H;const O=new de;let pt=class J{constructor(e,t,r=ft(t)){this.descriptor=e,this._pages=t,this._addressTable=r;const n=Te+t.reduce((a,{usedMemory:l})=>a+l,0),i=3*ae,o=Oe(r);this.usedMemory=M+n+i+o,this.featureCount=Math.floor(this._addressTable.length/2),this.isComplete=this.featureCount===t.reduce((a,l)=>a+l.featureCount,0)}get id(){return this.descriptor.id}getObjectId(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getObjectId(r)}getAttribute(e,t){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getAttribute(n,t)}getAttributeAsTimestamp(e,t){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getAttributeAsTimestamp(n,t)}getAttributes(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getAttributes(r)}getCoordinates(e,t,r){const{pageIndex:n,featurePageIndex:i}=this._translateIndex(e);this._pages[n].getCoordinates(i,t,r)}getOptimizedGeometry(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getOptimizedGeometry(r)}getCentroid(e,t){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getCentroid(n,t)}getBounds(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getBounds(r)}getBoundingBox(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getBoundingBox(r)}readObjectIds(e,t=this._allFeatureIndices(),r=0){let n=r;for(const{page:i,indices:o}of this._batchPageIndices(t))n=i.readObjectIds(e,o,n);return n}readCoordinates(e,t=this._allFeatureIndices(),r=0){let n=r;for(const{page:i,indices:o}of this._batchPageIndices(t))n=i.readCoordinates(e,o,n);return n}*objectIds(e=this._allFeatureIndices()){for(const{page:t,indices:r}of this._batchPageIndices(e))for(const n of t.objectIds(r))yield n}exclude(e){if(e.size===0)return this;const{_addressTable:t,featureCount:r}=this,n=new Array;for(let i=0;i<r;++i){const o=this.getObjectId(i);e.has(o)||(n.push(t[2*i]),n.push(t[2*i+1]))}return new J(this.descriptor,this._pages,n)}reset(){const{isComplete:e,_pages:t}=this;return e?this:new J(this.descriptor,t)}*_allFeatureIndices(){const{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_translateIndex(e){const{_addressTable:t}=this;return{pageIndex:t[2*e],featurePageIndex:t[2*e+1]}}*_batchPageIndices(e){const t=new Array;{let n=0,i=new Array;for(const o of e){const{pageIndex:a,featurePageIndex:l}=this._translateIndex(o);n!==a&&(i.length!==0&&t.push({pageIndex:n,indices:i}),n=a,i=[]),i.push(l)}i.length!==0&&t.push({pageIndex:n,indices:i})}const{_pages:r}=this;for(const{pageIndex:n,indices:i}of t)yield{page:r[n],indices:i}}};function ft(s){const e=s.reduce((n,{featureCount:i})=>n+i,0),t=new Array;if(e===0)return t;const r=s[0].featureCount;for(let n=0;n<e;++n)t[2*n]=Math.floor(n/r),t[2*n+1]=n%r;return t}let gt=class{constructor(e){this._reader=new Fe(new Uint8Array(e),new DataView(e)),this._index=_t(this._reader)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}get usedMemory(){return this._reader.usedMemory}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){var l;const{_index:{fieldsIndex:r,attributeIndices:n}}=this,i=(l=r.get(t))==null?void 0:l.index;if(i==null)return;const o=n[e*r.fields.length+i],a=this._reader;return a.move(o),F(a)}getAttributeAsTimestamp(e,t){const r=this.getAttribute(e,t);return typeof r=="string"?new Date(r).getTime():typeof r=="number"||r==null?r:null}getAttributes(e){const{_index:{fieldsIndex:t,attributeIndices:r}}=this,n=e*t.fields.length,i=this._reader,o={};for(const a of t.fields){const l=r[n+a.index];i.move(l),o[a.name]=F(i)}return o}getCoordinates(e,t,r=0){const n=this._reader,{transform:i,featureIndices:o}=this._index,{scale:a,translate:l}=i;n.move(o[e]),this._readCoordinates(a,l,t,r)}getOptimizedGeometry(e){const t=k();return this.getCoordinates(e,t),new W([],t)}getCentroid(e,{hasZ:t,hasM:r}){this.getCoordinates(e,S);const[n,i,o]=S,a=[n,i];return t&&(a[3]=o),r&&(a[t?4:3]=0),new W([],a)}getBounds(e){this.getCoordinates(e,S);const[t,r]=S,n=new de;return n.minX=t,n.minY=r,n.maxX=t,n.maxY=r,n}getBoundingBox(e){this.getCoordinates(e,S);const[t,r,n]=S;return Pe(t,r,n,t,r,n)}readObjectIds(e,t=this._allFeatureIndices(),r=0){const n=this._reader,{objectIdFieldName:i,attributeIndices:o,fieldsIndex:a}=this._index,l=a.get(i).index,c=a.fields.length;for(const d of t){const u=o[d*c+l];n.move(u),e[r++]=F(n)}return r}readCoordinates(e,t=this._allFeatureIndices(),r=0){const n=this._reader,{transform:i,featureIndices:o}=this._index,{scale:a,translate:l}=i;for(const c of t){const d=o[c];n.move(d),r=this._readCoordinates(a,l,e,r)}return r}*objectIds(e=this._allFeatureIndices()){const t=this._reader,{objectIdFieldName:r,attributeIndices:n,fieldsIndex:i}=this._index,o=i.get(r).index,a=i.fields.length;for(const l of e){const c=n[l*a+o];t.move(c),yield F(t)}}*_allFeatureIndices(){const{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_readCoordinates([e,t,r],[n,i,o],a,l){const u=this._reader,p=u.getLength(),m=u.pos()+p;for(;u.pos()<m&&u.next();)switch(u.tag()){case 2:{const h=u.getLength(),g=u.pos()+h;for(;u.pos()<g&&u.next();)u.tag()===3?(u.getUInt32(),a[l++]=n+e*u.getSInt64(),a[l++]=i+t*u.getSInt64(),a[l++]=o+r*u.getSInt64()):u.skip();break}default:u.skip()}return l}};function _t(s){for(;s.next();){if(s.tag()===2)return wt(s.getMessage());s.skip()}G()}function wt(s){for(;s.next();){if(s.tag()===1)return yt(s.getMessage());s.skip()}G()}function yt(s){let d,u,p=!1,m=!1,h=0;const g=new Array,y=new Array,x=new Array;for(;s.next();)switch(s.tag()){case 1:u=s.getString();break;case 7:s.getEnum()!==0&&G();break;case 9:p=s.getBool()??!1;break;case 12:d=Ge(s.processMessage(Qe));break;case 13:{const C=s.processMessage(De);C.index=h++,g.push(C);break}case 15:{y.push(s.pos());const C=s.getUInt32(),D=s.pos()+C;for(;s.pos()<D&&s.next();)s.tag()===1&&x.push(s.pos()),s.skip();break}case 10:m=s.getBool()??!1;break;default:s.skip()}const b=new ke(g);return d!=null&&m&&u!=null&&b.has(u)||G(),{transform:d,exceededTransferLimit:p,fieldsIndex:b,objectIdFieldName:u,featureIndices:y,attributeIndices:x}}function G(){const s=new _e("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(s),s}function F(s){const d=s.getLength(),u=s.pos()+d;for(;s.pos()<u&&s.next();)switch(s.tag()){case 1:return s.getString();case 2:return s.getFloat();case 3:return s.getDouble();case 4:return s.getSInt32();case 5:return s.getUInt32();case 6:return s.getInt64();case 7:return s.getUInt64();case 8:return s.getSInt64();case 9:return s.getBool();default:return s.skip(),null}return null}const S=k(),ee=8e3,xt=4,bt=4;let It=class{constructor(e,t,r,n,i){this.spatialReference=e,this.url=r,this.objectIdField=n,this.capabilities=i;const{supportsMaxRecordCountFactor:o,maxRecordCount:a}=this.capabilities.query,l=o?xt:1,c=(a??ee)*l;this._pageSize=Math.min(ee,c);const d=t.clone();d.cacheHint=!0,d.resultType="tile",d.outSpatialReference=e,d.returnGeometry=!0,d.returnZ=!0,d.maxRecordCountFactor=l,d.num=this._pageSize,d.outFields=[n],this._baseQuery=d}async fetch(e,t){const{spatialReference:r}=this,n=Se(e.extent,r),i=this._baseQuery.clone();i.geometry=n;const o=new Array;let a=0,l=!1,c=1;for(;!l;){const d=[];for(let p=0;p<c;++p)d.push(this._fetchPage(i,a++,t));const u=await Promise.all(d);N(t);for(const p of u){const m=p.featureCount!==0;l||(l=!p.exceededTransferLimit||!m),m&&o.push(p)}c=Math.min(c+1,bt)}return new pt(e,o)}async _fetchPage(e,t,r){const n=e.clone();n.start=t*this._pageSize;const i=(await Be(this.url,n,{signal:r})).data;return N(r),new gt(i)}},te=class{constructor(e){this._bufferWriter=null,this._bufferWriter=e.createBufferWriter()}createBuffer(e,t){const r=this._bufferWriter;let n=null;if(e.transformation&&t)He(R,e.transformation),R[12]-=t[0],R[13]-=t[1],R[14]-=t[2],n=R;else{if(t)throw new Error("not implemented");e.transformation&&(n=e.transformation)}let i=null;n&&(Je(P,R),qe(P,P),i=P);const o=e.attributes,a=r.elementCount(o),l=r.vertexBufferLayout.stride/4;a>Math.floor(Ct/l)&&console.warn("geometry with very large number of elements encountered");const c=r.vertexBufferLayout.createBuffer(a);return r.write(n,i,o,e.objectAndLayerIdColor,c,0),{data:c.buffer,elementCount:a}}};const R=B(),P=B(),Ct=16777216/4;let vt=class{constructor(e){this._context=e,this._commands=[],this._transferables=new Set}createMaterial(e){const t=this._context,r=t.generateId("material");switch(e){case"default":{const n=new Ke({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),i=new te(n);t.registerRenderGeometryBufferWriter(r,i)}break;case"hud":{const n=ze(null,this._context.globalViewingMode)[0],i=new te(n);t.registerRenderGeometryBufferWriter(r,i)}}return this._commands.push({id:"create-material",type:e,materialId:r}),r}createDirectRenderer(e){const t=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:t,materialId:e}),t}addDirectRendererGeometry(e,t,r){const n=t.materialId,i=this._context.getRenderGeometryBufferWriter(n);if(i==null)throw new Error(`no bufferwriter found for material ${n}`);const o=i.createBuffer(t,r);this._transferables.add(o.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:e,materialId:n,renderGeometryBuffer:o,localOrigin:r})}removeDirectRendererGeometry(e){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:e})}createLodRenderer(e){const t=this._context.generateId("lod-renderer"),r={levels:e.levels.map(n=>({components:n.components.map(i=>{const o=i.attributes.get(f.POSITION);if(!o||o.indices.length===0)throw new Error("positions attribute expected");const a=3,l=We(o.indices.length/a),c=new Ye(l,a,o),d=this._context.getRenderGeometryBufferWriter(i.materialId);if(d==null)throw new Error("writer not found");const u=d.createBuffer(i,null);return this._transferables.add(u.data),{materialId:i.materialId,renderGeometryBuffer:u,boundingInfo:{bbMax:c.bbMax,bbMin:c.bbMin}}}),minScreenSpaceRadius:n.minScreenSpaceRadius}))};return this._commands.push({id:"create-lod-renderer",lodRendererId:t,lodRenderGeometry:r}),t}addLodInstances(e,t){this._commands.push({id:"add-lod-instances",lodRendererId:e,data:t}),this._transferables.add(t.featureIds.buffer),this._transferables.add(t.globalTransforms.buffer),this._transferables.add(t.localTransforms.buffer)}removeLodInstances(e,t){this._commands.push({id:"remove-lod-instances",lodRendererId:e,featureIds:t}),this._transferables.add(t.buffer)}append(e){if(e._context!==this._context)throw new Error("Cannot append encoders from different contexts");const{_commands:t,_transferables:r}=this;for(const n of e._commands)t.push(n);for(const n of e._transferables)r.add(n)}async dispatch(){const e=this._commands,t=Array.from(this._transferables);this._clearCommandBuffer(),await this._context.dispatchRenderCommands(e,t)}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}};class $t{constructor(e){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=async()=>{},this.globalViewingMode=!1,this.globalViewingMode=e.viewingMode===Ne.Global,this._dispatchRenderCommandsCallback=e.dispatchRenderCommandsCallback}generateId(e=""){return`${e}${this._idCounter++}`}createEncoder(){return new vt(this)}async dispatchRenderCommands(e,t){e.length!==0&&await this._dispatchRenderCommandsCallback(e,t)}registerRenderGeometryBufferWriter(e,t){this._bufferWriters.set(e,t)}getRenderGeometryBufferWriter(e){return this._bufferWriters.get(e)}}let Q=class{constructor(e,t){this._renderCommands=e,this._pipelineStateCommands=t}append(e){this.appendRenderCommands(e._renderCommands),this.appendPipelineStateCommands(e._pipelineStateCommands)}appendRenderCommands(e){this._renderCommands.append(e)}appendPipelineStateCommand(e){this._pipelineStateCommands.push(e)}appendPipelineStateCommands(e){const{_pipelineStateCommands:t}=this;for(const r of e)t.push(r)}execute(){for(const e of this._pipelineStateCommands)e();this._renderCommands.dispatch()}};function q(s,e){const{featureCount:t}=s;if(t===0)return new Uint32Array;const r=new Uint32Array(t);return s.readObjectIds(r),r}function le(s,e){const{featureCount:t}=s;if(t===0)return new Float64Array;const r=new Float64Array(3*t);return s.readCoordinates(r),r}function At(s,e){const{featureCount:t}=s;if(t===0)return new Float64Array;const r=le(s),n=e.viewSpatialReference,i=e.renderSpatialReference,o=new Float64Array(3*t);if(!et(r,n,0,o,i,0,t))throw new Error("Failed to project coordinates");return o}function St(s,e){const t=e.viewSpatialReference,r=e.renderSpatialReference,{extent:n}=s,i=Re(n),o=k();return tt([i[0],i[1],0],t,o,r),o}function ce(s){const e=new Map;for(const[t,r]of s)e.set(t,{...r,indices:Ue(r.indices)});return e}function Rt(s,e){const t=(r,n,i=!1)=>({levels:r.map(o=>{const a=ce(n(o.tesselation));return i&&Tt(a),{components:[{attributes:a,objectAndLayerIdColor:void 0,transformation:null,materialId:e}],minScreenSpaceRadius:o.minScreenSpaceRadius}})});switch(s){case"cone":return t(Ot,r=>ot(1,.5,r,!1),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function Tt(s){const e=s,t=e.get(f.POSITION).data,r=e.get(f.NORMAL).data;if(r){const n=re(s,f.NORMAL).data;for(let i=0;i<r.length;i+=3){const o=r[i+1];n[i+1]=-r[i+2],n[i+2]=o}}if(t){const n=re(s,f.POSITION).data;for(let i=0;i<t.length;i+=3){const o=t[i+1];n[i+1]=-t[i+2],n[i+2]=o}}}function re(s,e){let t=s.get(e);return t&&!t.exclusive&&(t={...t,exclusive:!0,data:Ze(t.data)},s.set(e,t)),t}const Ot=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];class Et{constructor(e){this._context=e,this.lodRendererId=null,this._loaded=!1,this._loadingPromise=null,this._primitive="cone"}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const e=this._context.renderCommandContext.createEncoder(),t=e.createMaterial("default"),r=Rt(this._primitive,t);this.lodRendererId=e.createLodRenderer(r),await e.dispatch(),this._loaded=!0}async createAddCommand(e){const t=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)throw new Error("expected lod renderer id to not be null");const{featureCount:r}=e;if(r===0)return t;const n=!0,i=je(nt(this._primitive)),o=K(Le(i)),a=K(it(o,{isPrimitive:n,width:100,depth:null,height:null})),l=new Float64Array(16*r),c=new Float64Array(16*r),d=le(e,this._context);for(let m=0;m<r;++m){const h=m,g=d[3*m+0],y=d[3*m+1],x=d[3*m+2],b=this._computeGlobalTransform(g,y,x,this._context.viewSpatialReference,Bt),C=this._computeLocalTransform(a,o,Mt);this._writeMatrixToTypedBuffer(l,h,C),this._writeMatrixToTypedBuffer(c,h,b)}const u=q(e,this._context),p={featureIds:new Uint32Array(u),localTransforms:l,globalTransforms:c};return t.addLodInstances(this.lodRendererId,p),t}async createRemoveCommand(e){const t=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)return t;const r=q(e,this._context);return t.removeLodInstances(this.lodRendererId,r),t}_writeMatrixToTypedBuffer(e,t,r){let n=16*t;for(let i=0;i<16;i++)e[n++]=r[i]}_computeGlobalTransform(e,t,r,n,i){return j[0]=e,j[1]=t,j[2]=r,rt(n,j,i,this._context.renderSpatialReference),i}_computeLocalTransform(e,t,r){return Ve(r),this._applyObjectScale(e,t,r),r}_applyObjectScale(e,t,r){const n=st(e,e,t,this._context.renderCoordsHelper.unitInMeters);n[0]===1&&n[1]===1&&n[2]===1||Xe(r,r,n)}}const j=k(),Mt=B(),Bt=B();class Ft{constructor(e){this._context=e,this.materialId=null,this._loaded=!1,this._loadingPromise=null}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const e=this._context.renderCommandContext.createEncoder();this.materialId=e.createMaterial("hud"),e.createDirectRenderer(this.materialId),await e.dispatch(),this._loaded=!0}async createAddCommand(e){const t=this._context.renderCommandContext.createEncoder();if(this.materialId==null)throw new Error("expected material not to be null");const{featureCount:r,id:n}=e;if(r===0)return t;const i=At(e,this._context),o=St(e,this._context),a=new Float64Array([0,0,1]),l=new Float64Array([255,255,255,255]),c=new Float64Array([24,24]),d=new Float64Array([0,0,0,1]),u=new Float64Array([0,0]),p=new Float64Array([0]),m=new Uint32Array(r);for(let v=0;v<r;++v)m[v]=v;const h=new Uint32Array(r);for(let v=0;v<r;++v)h[v]=0;const g=new A(i,m,3,!0),y=new A(a,h,3,!0),x=new A(u,h,2,!0),b=new A(l,h,4,!0),C=new A(p,h,1,!0),D=new A(c,h,2,!0),ue=new A(d,h,4,!0),me=[[f.POSITION,g],[f.NORMAL,y],[f.UV0,x],[f.COLOR,b],[f.ROTATION,C],[f.SIZE,D],[f.CENTEROFFSETANDDISTANCE,ue]],he={attributes:ce(me),objectAndLayerIdColor:void 0,transformation:B(),materialId:this.materialId};return t.addDirectRendererGeometry(n,he,o),t}async createRemoveCommand(e){const t=this._context.renderCommandContext.createEncoder();return t.removeDirectRendererGeometry(e.id),t}}class Pt{constructor(e){this._symbols=new Array,this._featureDataPartitioning=new Map,this._context=e}async load(){this._symbols[0]=new Ft(this._context),this._symbols[1]=new Et(this._context)}async createAddCommand(e){const t=this._partition(e),r=await Promise.all(t.map(async({index:i,features:o})=>{const a=await this._provisionSymbol(i);return await(a==null?void 0:a.createAddCommand(o))})),n=this._context.renderCommandContext.createEncoder();for(const i of r)i!=null&&n.append(i);return new Q(n,[()=>{this._featureDataPartitioning.set(e,t)}])}async createRemoveCommand(e){const{_featureDataPartitioning:t}=this,r=t.get(e),n=this._context.renderCommandContext.createEncoder();if(r==null)return new Q(this._context.renderCommandContext.createEncoder(),[]);const i=await Promise.all(r.map(async({index:o,features:a})=>{const l=this._getLoadedSymbol(o);return await(l==null?void 0:l.createRemoveCommand(a))}));for(const o of i)o!=null&&n.append(o);return new Q(n,[()=>{t.delete(e)}])}async _provisionSymbol(e){if(e==null)return null;const t=this._symbols[e];return t?(t.loaded||await t.load(),t):null}_getLoadedSymbol(e){if(e==null)return null;const t=this._symbols[e];return t!=null&&t.loaded?t:null}_partition(e){const t=q(e,this._context);if(t==null)throw new Error("unable to fetch objectIds");const{featureCount:r}=e,n=[[],[]];for(let i=0;i<r;++i)n[t[i]%2].push(i);return n.map((i,o)=>new jt(o,e.subset(new Uint32Array(i)))).filter(i=>i.features.featureCount>0)}}class jt{constructor(e,t){this.index=e,this.features=t}}let L=class extends oe.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureDataStore=new ut,this._featureStore=new ht,this._tileManager=null,this._renderer=null,this._fetcher=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){var s;this._featureStore.clear(),(s=this._tileManager)==null||s.destroy()}async setup({viewSpatialReference:s,renderSpatialReference:e,viewingMode:t,baseQuery:r,url:n,objectIdField:i,capabilities:o,fieldsIndex:a,timeInfo:l,fullExtent:c}){const d=X.fromJSON(s),u=X.fromJSON(e);this._fetcher=new It(d,Y.fromJSON(r),n,i,o),this._queryEngine=new Ce({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:i,fieldsIndex:a,availableFields:[i],spatialReference:s,featureStore:this._featureStore,timeInfo:l}),this._renderer=new Pt({viewSpatialReference:d,renderSpatialReference:u,renderCoordsHelper:at.create(t,u),renderCommandContext:new $t({viewingMode:t,dispatchRenderCommandsCallback:(m,h)=>this.remoteClient.invoke("dispatchRenderCommands",m,{transferList:h})})}),this._defaultQueryJSON=new Y({outSpatialReference:d}).toJSON();let p=null;if(c!=null){const m=xe.fromJSON(c);await be(m.spatialReference,d),p=Ie(m,d)}return this._tileManager=new _({loadTile:(m,h)=>this._fetcher.fetch(m,h),createAddTileCommand:(m,h)=>this._createAddTileCommand(m,h),createRemoveTileCommand:m=>this._createRemoveTileCommand(m),extent:p}),this.addHandles(we(()=>this.updating,m=>{this.emit("notify-updating",{updating:m})}),ye),await this._renderer.load(),ne}async executeQuery(s,e){return{result:await this._queryEngine.executeQuery(this._ensureQuery(s),e)}}async executeQueryForIds(s,e){const t=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(s),e);return{result:Array.from(t)}}async executeQueryForCount(s,e){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(s),e)}}async executeQueryForExtent(s,e){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(s),e)}}async executeQueryForLatestObservations(s,e){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(s),e)}}async onTileTreeChange(s){return await this._tileManager.onTileTreeChange(s),ne}async _createAddTileCommand(s,e){const t=new ct(s),r=await this._renderer.createAddCommand(t);return N(e),r.appendPipelineStateCommand(()=>{this._featureDataStore.add(t),this._featureStore.addTile(s)}),r}async _createRemoveTileCommand(s){const e=this._featureStore,t=this._featureDataStore,r=this._renderer,n=t.get(s);if(n==null)return null;const i=await r.createRemoveCommand(n);return i.appendPipelineStateCommand(()=>{t.remove(s),e.removeTile(s)}),i}_ensureQuery(s){return s??this._defaultQueryJSON}};w([I()],L.prototype,"updating",null),L=w([ie("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],L);const as=L,ne={result:void 0};export{as as default};
