import{r}from"./tslib.es6-B3Jf3DVX.js";import{d as F}from"./Viewshed-Dhyh7k32.js";import"./geometry-D964gYQX.js";import{c as H}from"./Analysis-605EM8LG.js";import{V as N}from"./Collection-CEdjem1-.js";import{t as J,n as D}from"./collectionUtils-D_lHIu88.js";import{a as _}from"./Cyclical-oTUX3aX7.js";import{s as R,r as A}from"./mathUtils-C4_ghTv4.js";import{watch as S,syncAndInitial as T}from"./reactiveUtils-C5zUhJQJ.js";import{m as o,a as j}from"./subclass-BZA_h8Db.js";import{X as G}from"./projection-B971H0Re.js";import{w as I}from"./Extent-Bf3YTe7m.js";import{S as U}from"./MultiOriginJSONSupport-B5nfqtQh.js";import{r as X}from"./writer-DNAwXnhG.js";import k from"./Layer-CVt7Hb5J.js";import{b as B}from"./OperationalLayer-CVyVfSPu.js";import"./featureReferenceUtils-DBGXy8CW.js";import"./vec32-Dvg_eL9J.js";import"./vec3f64-BLpZdpfb.js";import"./common-DQOJ18NT.js";import"./sphere-C77djCO6.js";import"./mat4-GpOFENPA.js";import"./vec42-YcqnINSP.js";import"./vec4f64-o2zAXfmz.js";import"./Polyline-D9YkgmM_.js";import"./Point-Cg0-ChZE.js";import"./Accessor-BLX9ikPh.js";import"./cast-Bjksrh93.js";import"./assets-C43MgM-v.js";import"./index-Bh2oEzTI.js";import"./jsonMap-0cxwUWs2.js";import"./mat3-BRl2i9Bz.js";import"./mat3f64-BBpwCtoL.js";import"./plane-IENfwZlB.js";import"./mat4f64-Dk4dwAN8.js";import"./quatf64-CCm9z-pX.js";import"./vec2f64-miziP1SN.js";import"./mathUtils-BG-eq9fO.js";import"./intersectorUtils-BK9EUwUf.js";import"./boundedPlane-EV1sS2Ke.js";import"./lineSegment-D7sKPPYf.js";import"./intersectorUtilsConversions-D_fcRVdX.js";import"./aaBoundingBox-BE7cC1jD.js";import"./Intersector-wXoCuQ8W.js";import"./Intersector-BQ92CPLA.js";import"./Clonable-D3rtuBWg.js";import"./Identifiable-B1UbsKNt.js";import"./Evented-BHRw9x22.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./asyncUtils-CWX51uTe.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";import"./Loadable-BabW5Xcc.js";import"./Promise-B2Hu02L7.js";import"./TimeExtent-DocT5yPf.js";import"./timeUtils-8fb_2oAt.js";import"./date-DlqISzcw.js";import"./locale-C9TlLpzi.js";import"./layerContainerType-C5CzMsLd.js";import"./commonProperties-CPyIG_-u.js";import"./persistableUrlUtils-fa1mAujs.js";import"./ElevationInfo-CA5m_tHv.js";import"./fieldUtils-tmQlKvWo.js";import"./intl-CChhNOV8.js";import"./messages-OmQvZhAg.js";import"./unitConversionUtils-BMfW9yAe.js";import"./lengthUtils-DL1-FDQQ.js";import"./AttributeTableTemplate-BZeVyq-j.js";import"./opacityUtils-C68Tlu6_.js";const z=N.ofType(F);let l=class extends H{constructor(e){super(e),this.type="viewshed",this._extent=null}initialize(){this.addHandles(S(()=>this._computeExtent(),e=>{e.pending==null&&(this._extent=e.extent)},T))}get viewsheds(){return this._get("viewsheds")||new z}set viewsheds(e){this._set("viewsheds",D(e,this.viewsheds,z))}get spatialReference(){for(const e of this.viewsheds)if(e.observer!=null)return e.observer.spatialReference;return null}get extent(){return this._extent}get requiredPropertiesForEditing(){return this.viewsheds.items.map(({observer:e})=>e)}async waitComputeExtent(){const e=this._computeExtent();e.pending!=null&&await e.pending}_computeExtent(){const{spatialReference:e}=this;if(e==null)return{pending:null,extent:null};const a=this.viewsheds.filter(i=>i.observer!=null),h=a.map(i=>i.observer).toArray(),n=G(h,e);return n.pending!=null?{pending:n.pending,extent:null}:{pending:null,extent:n.geometries.map((i,m)=>{const g=a.at(m);return i!=null&&g!=null?this._computeViewshedExtent(this.viewsheds.at(m),i):null}).filter(i=>i!=null).reduce((i,m)=>K(i,m),null)}}_computeViewshedExtent(e,a){const{farDistance:h,heading:n,tilt:i,horizontalFieldOfView:m,verticalFieldOfView:g}=e,{spatialReference:f}=a,O=m/2,V=g/2,b=h/f.metersPerUnit,q=[_.normalize(n-O),n,_.normalize(n+O)],u=I.fromPoint(a),v=w=>{const d=q.map(p=>_.normalize(p-w));if(d[0]>d[2]||m===360)return b;const c=d.map(p=>Math.abs(p>180?360-p:p)).reduce((p,x)=>p>x?x:p);return c>90?0:b*Math.cos(R(c))};u.xmax+=v(90),u.xmin-=v(-90),u.ymax+=v(0),u.ymin-=v(180);const y=a.z;if(y!=null){let w=y,d=y;const c=i-90,p=A(c+V,-90,90),x=A(c-V,-90,90),E=f!=null&&f.isGeographic?h:b;w+=E*$(p),d+=E*$(x);const C=L(V)*E,M=$(c)*C*(1-L(O));i<90&&(w-=M),i>90&&(d-=M),u.zmax=Math.max(w,y),u.zmin=Math.min(d,y)}return u}clear(){this.viewsheds.removeAll()}};function K(t,e){return t==null?e:e==null?t:t.union(e)}function L(t){return Math.cos(R(t))}function $(t){return Math.sin(R(t))}r([o({type:["viewshed"]})],l.prototype,"type",void 0),r([o({cast:J,type:z,nonNullable:!0})],l.prototype,"viewsheds",null),r([o({readOnly:!0})],l.prototype,"spatialReference",null),r([o()],l.prototype,"_extent",void 0),r([o({readOnly:!0})],l.prototype,"extent",null),r([o({readOnly:!0})],l.prototype,"requiredPropertiesForEditing",null),l=r([j("esri.analysis.ViewshedAnalysis")],l);const P=l;let s=class extends B(U(k)){constructor(t){super(t),this.type="viewshed",this.operationalLayerType="ViewshedLayer",this.source=new P,this.opacity=1}initialize(){this.addHandles(S(()=>this.source,(t,e)=>{e!=null&&e.parent===this&&(e.parent=null),t!=null&&(t.parent=this)},T))}async load(){return this.addResolvingPromise(this.source.waitComputeExtent()),this}get spatialReference(){return this.source.spatialReference}get fullExtent(){return this.source.extent}releaseAnalysis(t){this.source===t&&(this.source=new P)}get analysis(){return this.source}set analysis(t){this.source=t}get viewsheds(){return this.source.viewsheds}set viewsheds(t){this.source.viewsheds=t}writeViewsheds(t,e,a,h){e.viewsheds=t.filter(n=>n.isValid()).map(n=>n.toJSON(h)).toJSON()}};r([o({json:{read:!1},readOnly:!0})],s.prototype,"type",void 0),r([o({type:["ViewshedLayer"]})],s.prototype,"operationalLayerType",void 0),r([o({nonNullable:!0})],s.prototype,"source",void 0),r([o({readOnly:!0})],s.prototype,"spatialReference",null),r([o({readOnly:!0})],s.prototype,"fullExtent",null),r([o({readOnly:!0,json:{read:!1,write:!1,origins:{service:{read:!1,write:!1},"portal-item":{read:!1,write:!1},"web-document":{read:!1,write:!1}}}})],s.prototype,"opacity",void 0),r([o({type:["show","hide"]})],s.prototype,"listMode",void 0),r([o({type:N.ofType(F),json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{ignoreOrigin:!0}}}}})],s.prototype,"viewsheds",null),r([X("web-scene","viewsheds")],s.prototype,"writeViewsheds",null),s=r([j("esri.layers.ViewshedLayer")],s);const ht=s;export{ht as default};
