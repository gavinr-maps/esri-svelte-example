import{j as R,br as N,s as k,a1 as C}from"./index-B1qcMJFy.js";import{m as U}from"./lengthUtils-DbqEO4K7.js";import{i as x,n as S,l as y,e as T}from"./sizeVariableUtils-Cmcuvw-4.js";const g=()=>k.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),D=new R,w=Math.PI,X=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function q(r,t,a){const e="visualVariables"in r&&r.visualVariables?r.visualVariables.find(c=>c.type==="color"):r;if(!e)return;if(e.declaredClass!=="esri.renderers.visualVariables.ColorVariable")return void g().warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const s=typeof t=="number",n=s?null:t,l=n==null?void 0:n.attributes;let o=s?t:null;const i=e.field,{ipData:f,hasExpression:p}=e.cache;let u=e.cache.compiledFunc;if(!i&&!p){const c=e.stops;return c&&c[0]&&c[0].color}if(typeof o!="number")if(p){if((a==null?void 0:a.arcade)==null)return void g().error("Use of arcade expressions requires an arcade context");const c={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},d=a.arcade.arcadeUtils,m=d.getViewInfo(c),V=d.createExecContext(n,m,a.timeZone);if(!u){const z=d.createSyntaxTree(e.valueExpression);u=d.createFunction(z),e.cache.compiledFunc=u}o=d.executeFunction(u,V)}else l&&(o=l[i]);const v=e.normalizationField,b=l!=null&&v!=null?parseFloat(l[v]):void 0;if(o!=null&&(!v||s||!isNaN(b)&&b!==0)){isNaN(b)||s||(o/=b);const c=E(o,f);if(c){const d=c[0],m=c[1],V=d===m?e.stops[d].color:C.blendColors(e.stops[d].color,e.stops[m].color,c[2],a!=null?a.color:void 0);return new C(V)}}}function I(r,t,a){const e="visualVariables"in r&&r.visualVariables?r.visualVariables.find(c=>c.type==="opacity"):r;if(!e)return;if(e.declaredClass!=="esri.renderers.visualVariables.OpacityVariable")return void g().warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const s=typeof t=="number",n=s?null:t,l=n==null?void 0:n.attributes;let o=s?t:null;const i=e.field,{ipData:f,hasExpression:p}=e.cache;let u=e.cache.compiledFunc;if(!i&&!p){const c=e.stops;return c&&c[0]&&c[0].opacity}if(typeof o!="number")if(p){if((a==null?void 0:a.arcade)==null)return void g().error("Use of arcade expressions requires an arcade context");const c={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},d=a.arcade.arcadeUtils,m=d.getViewInfo(c),V=d.createExecContext(n,m,a.timeZone);if(!u){const z=d.createSyntaxTree(e.valueExpression);u=d.createFunction(z),e.cache.compiledFunc=u}o=d.executeFunction(u,V)}else l&&(o=l[i]);const v=e.normalizationField,b=l!=null&&v!=null?parseFloat(l[v]):void 0;if(o!=null&&(!v||s||!isNaN(b)&&b!==0)){isNaN(b)||s||(o/=b);const c=E(o,f);if(c){const d=c[0],m=c[1];if(d===m)return e.stops[d].opacity;{const V=e.stops[d].opacity;return V+(e.stops[m].opacity-V)*c[2]}}}}function A(r,t,a){const e="visualVariables"in r&&r.visualVariables?r.visualVariables.find(b=>b.type==="rotation"):r;if(!e)return;if(e.declaredClass!=="esri.renderers.visualVariables.RotationVariable")return void g().warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const s=e.axis||"heading",n=s==="heading"&&e.rotationType==="arithmetic"?90:0,l=s==="heading"&&e.rotationType==="arithmetic"?-1:1,o=typeof t=="number"?null:t,i=o==null?void 0:o.attributes,f=e.field,{hasExpression:p}=e.cache;let u=e.cache.compiledFunc,v=0;if(!f&&!p)return v;if(p){if((a==null?void 0:a.arcade)==null)return void g().error("Use of arcade expressions requires an arcade context");const b={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},c=a.arcade.arcadeUtils,d=c.getViewInfo(b),m=c.createExecContext(o,d,a.timeZone);if(!u){const V=c.createSyntaxTree(e.valueExpression);u=c.createFunction(V),e.cache.compiledFunc=u}v=c.executeFunction(u,m)}else i&&(v=i[f]||0);return v=typeof v!="number"||isNaN(v)?null:n+l*v,v}function O(r,t,a){const e=typeof t=="number",s=e?null:t,n=s==null?void 0:s.attributes;let l=e?t:null;const{isScaleDriven:o}=r.cache;let i=r.cache.compiledFunc;if(o){const p=a!=null?a.scale:void 0,u=a!=null?a.view:void 0;l=p==null||u==="3d"?Z(r):p}else if(!e)switch(r.inputValueType){case S.Expression:{if((a==null?void 0:a.arcade)==null)return void g().error("Use of arcade expressions requires an arcade context");const p={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},u=a.arcade.arcadeUtils,v=u.getViewInfo(p),b=u.createExecContext(s,v,a.timeZone);if(!i){const c=u.createSyntaxTree(r.valueExpression);i=u.createFunction(c),r.cache.compiledFunc=i}l=u.executeFunction(i,b);break}case S.Field:n&&(l=n[r.field]);break;case S.Unknown:l=null}if(!y(l))return null;if(e||!r.normalizationField)return l;const f=n?parseFloat(n[r.normalizationField]):null;return y(f)&&f!==0?l/f:null}function Z(r){let t=null,a=null;const e=r.stops;return e?(t=e[0].value,a=e[e.length-1].value):(t=r.minDataValue||0,a=r.maxDataValue||0),(t+a)/2}function F(r,t,a){const e="visualVariables"in r&&r.visualVariables?r.visualVariables.find(n=>n.type==="size"):r;if(!e)return;if(e.declaredClass!=="esri.renderers.visualVariables.SizeVariable")return void g().warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const s=H(O(e,t,a),e,t,a,e.cache.ipData);return s==null||isNaN(s)?0:s}function h(r,t,a){return r==null?null:T(r)?F(r,t,a):y(r)?r:null}function M(r,t,a){return y(a)&&r>a?a:y(t)&&r<t?t:r}function L(r,t,a,e){return r+((h(t.minSize,a,e)||t.minDataValue)??0)}function P(r,t,a){const e=r.stops;let s=(e==null?void 0:e.length)&&e[0].size;return s==null&&(s=r.minSize),h(s,t,a)}function j(r,t,a,e){const s=(r-t.minDataValue)/(t.maxDataValue-t.minDataValue),n=h(t.minSize,a,e),l=h(t.maxSize,a,e),o=e!=null?e.shape:void 0;if(r<=t.minDataValue)return n;if(r>=t.maxDataValue)return l;if(n==null||l==null)return null;if(t.scaleBy==="area"&&o){const i=o==="circle",f=i?w*(n/2)**2:n*n,p=f+s*((i?w*(l/2)**2:l*l)-f);return i?2*Math.sqrt(p/w):Math.sqrt(p)}return n+s*(l-n)}function B(r,t,a,e){const s=e!=null?e.shape:void 0,n=r/t.minDataValue,l=h(t.minSize,a,e),o=h(t.maxSize,a,e);let i=null;return i=s==="circle"?2*Math.sqrt(n*(l/2)**2):s==="square"||s==="diamond"||s==="image"?Math.sqrt(n*l**2):n*l,M(i,l,o)}function W(r,t,a,e,s){var i,f,p;const[n,l,o]=E(r,s);if(n===l)return h((i=t.stops)==null?void 0:i[n].size,a,e);{const u=h((f=t.stops)==null?void 0:f[n].size,a,e);return u+(h((p=t.stops)==null?void 0:p[l].size,a,e)-u)*o}}function G(r,t,a,e){const s=((e==null?void 0:e.resolution)??1)*U[t.valueUnit],n=h(t.minSize,a,e),l=h(t.maxSize,a,e),{valueRepresentation:o}=t;let i=null;return i=o==="area"?2*Math.sqrt(r/w)/s:o==="radius"||o==="distance"?2*r/s:r/s,M(i,n,l)}function H(r,t,a,e,s){switch(t.transformationType){case x.Additive:return L(r,t,a,e);case x.Constant:return P(t,a,e);case x.ClampedLinear:return j(r,t,a,e);case x.Proportional:return B(r,t,a,e);case x.Stops:return W(r,t,a,e,s);case x.RealWorldSize:return G(r,t,a,e);case x.Identity:return r;case x.Unknown:return null}}function Y(r,t,a){const{isScaleDriven:e}=r.cache;if(!(e&&a==="3d"||t))return null;const s={scale:t,view:a};let n=h(r.minSize,D,s),l=h(r.maxSize,D,s);if(n!=null||l!=null){if(n>l){const o=l;l=n,n=o}return{minSize:n,maxSize:l}}}function _(r,t,a){if(!r.visualVariables)return;const e=[],s=[],n=[],l=[],o=[];for(const i of r.visualVariables)switch(i.type){case"color":s.push(i);break;case"opacity":n.push(i);break;case"rotation":o.push(i);break;case"size":l.push(i)}return s.forEach(i=>{const f=q(i,t,a);e.push({variable:i,value:f})}),n.forEach(i=>{const f=I(i,t,a);e.push({variable:i,value:f})}),o.forEach(i=>{const f=A(i,t,a);e.push({variable:i,value:f})}),l.forEach(i=>{const f=F(i,t,a);e.push({variable:i,value:f})}),e.filter(i=>i.value!=null)}function E(r,t){if(!t)return;let a=0,e=t.length-1;return t.some((s,n)=>r<s?(e=n,!0):(a=n,!1)),[a,e,(r-t[a])/(t[e]-t[a])]}function $(r,t,a){const e=["proportional","proportional","proportional"];for(const s of r){const n=s.useSymbolValue?"symbol-value":F(s,t,a);switch(s.axis){case"width":e[0]=n;break;case"depth":e[1]=n;break;case"height":e[2]=n;break;case"width-and-depth":e[0]=n,e[1]=n;break;case"all":case void 0:case null:e[0]=n,e[1]=n,e[2]=n;break;default:N(s.axis)}}return e}export{$ as getAllSizes,q as getColor,I as getOpacity,A as getRotationAngle,F as getSize,H as getSizeForValue,h as getSizeFromNumberOrVariable,Y as getSizeRangeAtScale,_ as getVisualVariableValues,X as viewScaleRE};
