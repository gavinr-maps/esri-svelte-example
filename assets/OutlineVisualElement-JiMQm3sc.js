import{o as y}from"./Evented-BHRw9x22.js";import{o as C,u as R,g as w}from"./vec32-Dvg_eL9J.js";import{n as f}from"./vec3f64-BLpZdpfb.js";import{E as o,a as c}from"./vec42-YcqnINSP.js";import{r as d,t as v}from"./vec4f64-o2zAXfmz.js";import{n as D}from"./projectBuffer-Bs7GwaPY.js";import{t as P,s as b}from"./aaBoundingBox-BE7cC1jD.js";import{e as E}from"./projectVectorToVector-G2uWGoIb.js";import{i as G}from"./elevationInfoUtils-BC_66_Fg.js";import{h as $}from"./ElevationInfo-CA5m_tHv.js";import{t as A}from"./EngineVisualElement-DAbK0X3b.js";import{c as S}from"./LaserlineVisualElement-CUgS0u0n.js";import{W as m,o as I}from"./RibbonLine.glsl-BZu1FDpE.js";import{b as p}from"./line-CML3g7Ng.js";import{l as M,p as j}from"./line-DxZlo8wx.js";import{p as l}from"./Material-_xx7OZxD.js";import{g as W}from"./OverlayCompositing.glsl-CiE3Tt8y.js";import{e as H}from"./VertexAttribute-Cq4MnHjR.js";class te extends A{constructor(e){super(e),this._attachmentOrigin=E(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new y,this._geometry=null,this._width=1,this._color=d(1,0,1,1),this._innerWidth=0,this._innerColor=d(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=l.OccludeAndTransparentStencil,this._attachmentOrigin.spatialReference=e.view.spatialReference,this._laserline=new S({view:e.view,isDecoration:e.isDecoration}),this.applyProperties(e),this.attached=e.attached??!0}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:_,recreateGeometry:(t,r)=>{t.geometries.length=0,this._recreateGeometry(r,t.material,t.geometries)}}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:_,recreateGeometry:t=>{t.geometries=this._createRenderGeometriesDraped(t.material),this._attachmentOriginChanged()}}}get _laserlineAttached(){return this.attached&&this.visible&&this._laserlineStyle!=null&&!this.isDraped&&this.laserlineEnabled}onAttachedChange(e){this._laserline.attached=this._laserlineAttached,e&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){o(e,this._color)||(c(this._color,e),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){o(e,this._innerColor)||(c(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=e!=null!=(this._stipplePattern!=null);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&o(e,this._stippleOffColor)||(this._stippleOffColor=e?v(e):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,e!=null&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get attachmentOrigin(){var r;if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=(r=this.object3dResources.resources)==null?void 0:r.geometries;if(!e||e.length===0)return null;C(a,0,0,0);let t=0;for(const i of e)i.computeAttachmentOrigin(u)&&(R(a,a,u),t++);return t===0?null:(w(a,a,1/t),this.view.renderCoordsHelper.fromRenderCoords(a,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){var e,t;(e=this.object3dResources.resources)==null||e.material.setParameters(this._materialParameters),(t=this.drapedResources.resources)==null||t.material.setParameters(this._materialParameters)}get _isClosed(){return this.geometry!=null&&this.geometry.type==="polygon"}get _materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this._isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this._normalizedRenderOccluded,isDecoration:this.isDecoration}}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===l.OccludeAndTransparentStencil?l.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(e,t,r){this._createRenderGeometries(t,r);for(const i of r)e.addGeometry(i);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_createObject3DResources(e){const t=new m(this._materialParameters),r=new Array;return this._recreateGeometry(e,t,r),{material:t,geometries:r,forEach:i=>{i(t),r.forEach(i)}}}_createDrapedResources(){const e=new m(this._materialParameters);return{material:e,geometries:this._createRenderGeometriesDraped(e)}}_createRenderGeometriesDraped(e){const{geometry:t,view:r}=this,i=r.basemapTerrain.spatialReference;return t==null||i==null?[]:M(t,i).lines.map(({position:s})=>{const n={overlayInfo:{spatialReference:i,renderCoordsHelper:r.renderCoordsHelper},attributeData:{position:s},removeDuplicateStartEnd:this._isClosed};return new W(p(e,n))})}calculateMapBounds(e){if(this.object3dResources.resources==null)return!1;const t=this.view.renderCoordsHelper;for(const r of this.object3dResources.resources.geometries){const i=r.attributes.get(H.POSITION),s=P(i.data.length);D(i.data,t.spatialReference,0,s,this.view.spatialReference,0),b(e,s)}return!0}_createRenderGeometries(e,t){const r=this.geometry;if(r==null)return;const i=j(r,this.view.elevationProvider,this.view.renderCoordsHelper,I.fromElevationInfo(this.elevationInfo??new $({mode:G(r,null)}))),s=new Array;for(const{position:n,mapPositions:g}of i.lines){const O={mapPositions:g,attributeData:{position:n},removeDuplicateStartEnd:this._isClosed};t.push(p(e,O)),s.push(n)}this._laserline.pathVerticalPlane=s}}function _(h){h.geometries=[]}const u=f(),a=f();export{te as j};
