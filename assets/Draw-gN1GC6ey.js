import{o as D,e as s}from"./Evented-CXIxDjmW.js";import{u as L,t as Z,S as M}from"./Accessor-D6mNnsWy.js";import{a as R,y as n,b as u}from"./subclass-BR3PhgZG.js";import"./geometry-DpwwkAX1.js";import{i as S}from"./screenUtils-PfxkaaMN.js";import $ from"./GraphicsLayer-D2NeCfd2.js";import{e as z}from"./projectVectorToVector-Chzd0Pq0.js";import{l as T}from"./ViewingMode-Dodu7ZZk.js";import{f as F}from"./SnappingVisualizer2D-ChAoR0om.js";import{P as N,E as I,p as U,a as E}from"./EditGeometryOperations-BgVEmauk.js";import{e as K}from"./SnappingContext-lR2hMWGP.js";import{p as Y}from"./SnappingOperation-CqqVcxu4.js";import{_ as o}from"./InputManager-C4xu1R9l.js";import{p as a}from"./keybindings-DYR2fa8r.js";import{n as p}from"./screenUtils-BGG3AyYa.js";import{_ as O}from"./Point-DB4Hp4hH.js";import{u as B}from"./elevationInfoUtils-Bl7QRRwv.js";import{F as j,l as q,c as J,a as k,e as G,b as Q}from"./surfaceCoordinateSystems-CdeJZGsb.js";import{n as W}from"./InteractiveToolBase-SWVoyXWH.js";var f;let l=f=class extends D.EventedAccessor{constructor(e){super(e),this._hasZ=null,this._cursorScreenPoint=null,this._activePointerId=null,this._stagedVertexUnsnapped=null,this._lastVertexUnsnapped=null,this.interactiveUndoDisabled=!1,this.history=[],this.redoHistory=[],this.snapToScene=!1,this.view=null,this.elevationInfo=null,this.defaultZ=0,this._coordinateHelper=N(!!e.hasZ,!1,e.view.spatialReference),this._snappingManager=e.snappingManager,this._editGeometryOperations=new I(new U(e.editGeometryType??"polygon",this._coordinateHelper),T.Local),this._snappingGraphicsLayer=new $({id:f.SNAPPING_GRAPHICS_LAYER_ID,listMode:"hide",internal:!0}),this._snappingContext=new K({editGeometryOperations:this._editGeometryOperations,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new F(this._snappingGraphicsLayer)}),this._activeComponent=new E(e.view.spatialReference,T.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}normalizeCtorArgs(e){const t={...e};return delete t.editGeometryType,delete t.snappingManager,t}initialize(){this._snappingOperation=new Y({view:this.view}),this.view.type==="2d"&&this.view.map.layers.add(this._snappingGraphicsLayer)}destroy(){this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this._snappingOperation=L(this._snappingOperation),this._editGeometryOperations.destroy()}get _committedVertices(){return this._editGeometryOperations.data.components[0].vertices.map(e=>e.pos)}get vertices(){return this._stagedVertex!=null?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}get hasZ(){return this._hasZ!=null?this._hasZ:this.view.type==="3d"}set hasZ(e){this._hasZ=e,this.notifyChange("hasZ")}get _stagedVertex(){return this._snappingOperation.stagedPoint}set _stagedVertex(e){this._snappingOperation.stagedPoint=R(e)}canUndo(){return this._editGeometryOperations.canUndo}canRedo(){return this._editGeometryOperations.canRedo}undo(){this.canUndo&&this._editGeometryOperations.undo()}redo(){this.canRedo&&this._editGeometryOperations.redo()}getCoordsFromScreenPoint(e){const t=e&&this.screenToMap(e);return t==null?null:t.hasZ?[t.x,t.y,t.z]:[t.x,t.y]}getCoordsAndPointFromScreenPoint(e){const t=this.screenToMap(e);return t==null?null:t.hasZ?{vertex:[t.x,t.y,t.z],mapPoint:t}:{vertex:[t.x,t.y],mapPoint:t}}screenToMap(e){let t=null;if(this.view.type==="3d")if(this.hasZ){const i=this.elevationInfo??X;t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(S(e.x,e.y),i,this._getGeometryZValue())}else{const i=this.elevationInfo??ee;t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(S(e.x,e.y),i,0),t!=null&&(t.z=void 0)}else t=this.view.toMap(e),t!=null&&(t.z=this.hasZ?this._getGeometryZValue():void 0);return t}_pushCursorVertex(e,t){const i=z(e[0],e[1],void 0,this.view.spatialReference);this._stagedVertexUnsnapped=i;const r=this._snappingManager;if(r==null)return this._stagedVertex=i,void t();Z(this._snappingOperation.snap({point:i},r,this._snappingContext)).then(()=>{t()})}_popCursorVertex(){this._stagedVertexUnsnapped=null,this._stagedVertex=null}_getGeometryZValue(){return this.defaultZ}_abortSnapping(){this._snappingOperation.abort()}_isDuplicateOfLastVertex(e){var h;const t=(h=this._editGeometryOperations.data.components[0].getLastVertex())==null?void 0:h.pos;if(t&&e[0]===t[0]&&e[1]===t[1])return!0;const{x:i,y:r}=this._coordinateHelper.vectorToDehydratedPoint(e);return this._lastVertexUnsnapped!=null&&i===this._lastVertexUnsnapped.x&&r===this._lastVertexUnsnapped.y}_shouldHandlePointerEvent(e){return te(e)&&(this._activePointerId==null||this._activePointerId===e.pointerId)}_vertexAddHandler(e){const t=this._stagedVertex!=null?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);t!=null&&this._addVertex(t,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}};l.SNAPPING_GRAPHICS_LAYER_ID="DrawAction-snapping-graphics-layer",s([n({readOnly:!0})],l.prototype,"vertices",null),s([n({type:Boolean,nonNullable:!0})],l.prototype,"interactiveUndoDisabled",void 0),s([n({readOnly:!0})],l.prototype,"history",void 0),s([n({readOnly:!0})],l.prototype,"redoHistory",void 0),s([n()],l.prototype,"snapToScene",void 0),s([n()],l.prototype,"view",void 0),s([n()],l.prototype,"elevationInfo",void 0),s([n({nonNullable:!0})],l.prototype,"defaultZ",void 0),s([n()],l.prototype,"hasZ",null),s([n()],l.prototype,"_snappingOperation",void 0),s([n()],l.prototype,"_stagedVertex",null),l=f=s([u("esri.views.draw.DrawAction")],l);const X={mode:"absolute-height",offset:0},ee={mode:"on-the-ground",offset:0};function te(e){return e.pointerType!=="mouse"||e.button===0}const V=l;class c{constructor(t,i,r){this.view=t,this.vertexIndex=i,this.vertices=r,this.defaultPrevented=!1,this.type="vertex-add"}preventDefault(){this.defaultPrevented=!0}}class w{constructor(t,i,r){this.view=t,this.vertexIndex=i,this.vertices=r,this.defaultPrevented=!1,this.type="vertex-remove"}preventDefault(){this.defaultPrevented=!0}}class _{constructor(t,i,r,h=null){this.view=t,this.vertexIndex=i,this.vertices=r,this.mapPoint=h,this.coordinates=null,this.defaultPrevented=!1,this.type="cursor-update",this.coordinates=r.length===1?r[0]:null}preventDefault(){this.defaultPrevented=!0}}class v{constructor(t){this.vertices=t,this.coordinates=null,this.defaultPrevented=!1,this.type="draw-complete",this.coordinates=t.length===1?t[0]:null}preventDefault(){this.defaultPrevented=!0}}const b=Symbol("view-handles"),A=Symbol("undo-redo-handles");let H=class extends V{constructor(e){super(e),this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1}initialize(){this._addViewHandles(),this._addUndoRedoHandles()}destroy(){this._removeViewHandles(),this._removeUndoRedoHandles(),this.emit("destroy")}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){this._completeDrawing()}_addViewHandles(){this._removeViewHandles(),this.addHandles([this.view.on("click",e=>{e.stopPropagation()},o.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(e),e.pointerType==="touch"&&this._updateCursor())},o.TOOL),this.view.on("pointer-move",e=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=p(e),e.pointerType!=="touch"&&this._updateCursor()},o.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},o.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp)this._vertexAddHandler(e);else{const t=e.pointerType==="touch";this._updateCursor(t)}},o.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},o.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},o.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},o.TOOL),this.view.on("key-down",e=>{const{key:t,repeat:i}=e;t===a.vertexAdd&&!i&&this._cursorScreenPoint?(e.stopPropagation(),this._abortSnapping(),this._vertexAddHandler(e)):t!==a.complete||i?t!==a.undo||this.interactiveUndoDisabled||i?t!==a.redo||this.interactiveUndoDisabled||i?t!==a.pan||i||e.stopPropagation():(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e))},o.TOOL),this.view.on("key-up",e=>{e.key===a.pan&&e.stopPropagation()},o.TOOL)],b)}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this.addHandles([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){const t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new w(this.view,e.vertices[0].index,t))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){const t=this._committedVertices.length-1,i=new c(this.view,t,this.vertices);this.emit("vertex-add",i),i.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){const t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new c(this.view,e.vertices[0].index,t))}})],A)}_removeViewHandles(){this.removeHandles(b)}_removeUndoRedoHandles(){this.removeHandles(A)}_addVertex(e){const t=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(t)||this._editGeometryOperations.appendVertex(t)}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t==null||e||this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new _(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new O(this._stagedVertex):null)))}_completeDrawing(){if(this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const e=new v(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this._removeViewHandles()}};H=s([u("esri.views.draw.MultipointDrawAction")],H);let d=class extends D.EventedMixin(W){constructor(t){super(t),this.defaultZ=0,this.elevationInfo=null,this.hasZ=!0,this.mode=null,this.snapToScene=null,this.type="draw-3d"}initialize(){const t=this.view,i=B(this.hasZ,this.elevationInfo);this.drawOperation=new j({view:t,manipulators:this.manipulators,geometryType:this.geometryType,drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:t.type==="3d"?new q(t,i):null,elevationDrawSurface:t.type==="3d"?new J(i,this.defaultZ,t):null,hasM:!1,elevationInfo:i}),this.addHandles([this.drawOperation.on("vertex-add",r=>this.onVertexAdd(r)),this.drawOperation.on("vertex-remove",r=>this.onVertexRemove(r)),this.drawOperation.on("vertex-update",r=>this.onVertexUpdate(r)),this.drawOperation.on("cursor-update",r=>this.onCursorUpdate(r)),this.drawOperation.on("complete",r=>this.onComplete(r))]),this.finishToolCreation()}destroy(){this.drawOperation=L(this.drawOperation),this._set("view",null)}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}get updating(){var t;return((t=this.drawOperation)==null?void 0:t.updating)??!1}completeCreateOperation(){this.drawOperation.complete()}onDeactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}getVertexCoords(){return this.drawOperation.geometryIncludingUncommittedVertices}onInputEvent(t){this.drawOperation.onInputEvent(t)}canRedo(){return this.drawOperation.canRedo}canUndo(){return this.drawOperation.canUndo}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo()}onComplete(t){this.emit("complete",t)}onCursorUpdate(t){this.emit("cursor-update",t)}onVertexAdd(t){this.emit("vertex-add",t)}onVertexRemove(t){this.emit("vertex-remove",t)}onVertexUpdate(t){this.emit("vertex-update",t)}};s([n({constructOnly:!0,nonNullable:!0})],d.prototype,"defaultZ",void 0),s([n()],d.prototype,"drawOperation",void 0),s([n({constructOnly:!0})],d.prototype,"elevationInfo",void 0),s([n({value:!0})],d.prototype,"enabled",null),s([n({constructOnly:!0})],d.prototype,"geometryType",void 0),s([n({constructOnly:!0})],d.prototype,"hasZ",void 0),s([n({constructOnly:!0})],d.prototype,"mode",void 0),s([n()],d.prototype,"snapToScene",void 0),s([n({readOnly:!0})],d.prototype,"type",void 0),s([n({readOnly:!0})],d.prototype,"updating",null),s([n({constructOnly:!0,nonNullable:!0})],d.prototype,"view",void 0),d=s([u("esri.views.draw.DrawTool")],d);let C=class extends V{constructor(e){super(e),this._addVertexOnPointerUp=!1,this._drawTool=null}initialize(){this._addViewHandles(),this.view.type==="3d"&&this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}complete(){this._completeDrawing()}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles([this.view.on("key-down",e=>{e.key===a.complete&&(this._drawTool?this.complete():(this._abortSnapping(),this._vertexAddHandler(e)))},o.TOOL)])}_addViewHandles2DOnly(){this.view.type==="2d"&&this.addHandles([this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(e),e.pointerType==="touch"&&this._updateCursor())},o.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._cursorScreenPoint=p(e),e.pointerType!=="touch"&&this._updateCursor()},o.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},o.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp)e.stopPropagation(),this._vertexAddHandler(e);else{const t=e.pointerType==="touch";this._updateCursor(t)}},o.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},o.TOOL)])}_addDrawTool(){const e=new d({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"point",mode:"click"});this._drawTool=e,this.view.addAndActivateTool(e),this.addHandles([e.on("cursor-update",t=>{t.vertices.length===1&&this.emit("cursor-update",new _(this.view,t.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("complete",t=>{this.emit("draw-complete",new v(e.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})])}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){const t=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(t)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(t),this.notifyChange("vertices"),this._completeDrawing())}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t==null||e||this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new _(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new O(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const e=new v(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}};C=s([u("esri.views.draw.PointDrawAction")],C);let m=class extends V{constructor(t){super(t),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.mode=G}initialize(){this._addViewHandles(),this.view.type==="3d"&&this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}undo(){this._drawTool?this._drawTool.undo():(super.undo(),this.notifyChange("vertices"))}redo(){this._drawTool?this._drawTool.redo():(super.redo(),this.notifyChange("vertices"))}canUndo(){var t;return((t=this._drawTool)==null?void 0:t.canUndo())??super.canUndo()}canRedo(){var t;return((t=this._drawTool)==null?void 0:t.canRedo())??super.canRedo()}complete(){this._completeDrawing()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles(this.view.on("key-down",t=>{const{key:i,repeat:r}=t;i!==a.vertexAdd||r?i!==a.complete||r?i!==a.undo||this.interactiveUndoDisabled||r?i!==a.redo||this.interactiveUndoDisabled||r||(t.stopPropagation(),this.redo()):(t.stopPropagation(),this.undo()):(t.stopPropagation(),this._drawCompleteHandler(t)):(t.stopPropagation(),this._handleVertexAddKey(t))},o.TOOL))}_addViewHandles2DOnly(){this.view.type==="2d"&&(this.addHandles([this.view.on("click",t=>{t.stopPropagation()},o.TOOL),this.view.on("pointer-down",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._activePointerId=t.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(t),t.pointerType==="touch"&&this._updateCursor())},o.TOOL),this.view.on("pointer-move",t=>{this._abortSnapping(),this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._cursorScreenPoint=p(t),t.pointerType!=="touch"&&this._updateCursor()},o.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._cursorScreenPoint=p(t),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(t):this._addVertexOnPointerUp=!1)},o.TOOL),this.view.on("pointer-up",t=>{if(this._shouldHandlePointerEvent(t))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(t);this._vertexAddHandler(t)}else{const i=t.pointerType==="touch";this._updateCursor(i)}},o.TOOL),this.view.on("drag",t=>{this._dragEnabled&&this._activePointerId!=null&&!this._panEnabled&&t.stopPropagation()},o.TOOL),this.view.on("drag",["Shift"],t=>{t.stopPropagation()},o.TOOL),this.view.on("double-click",t=>{t.stopPropagation(),this._drawCompleteHandler(t)},o.TOOL),this.view.on("double-click",["Control"],t=>{t.stopPropagation(),this._drawCompleteHandler(t)},o.TOOL),this.view.on("key-down",t=>{const{key:i,repeat:r}=t;i!==a.pan||r||(t.stopPropagation(),this._panEnabled=!0)},o.TOOL),this.view.on("key-up",t=>{t.key===a.pan&&(t.stopPropagation(),this._panEnabled=!1)},o.TOOL)]),this._addUndoRedoHandles())}_handleVertexAddKey(t){this._drawTool?this._drawTool.drawOperation.commitStagedVertex():this._cursorScreenPoint&&(this._abortSnapping(),this._vertexAddHandler(t))}_addUndoRedoHandles(){this.addHandles([this._editGeometryOperations.on("vertex-remove",t=>{if(this.notifyChange("vertices"),t.operation==="undo"){const i=[...this._committedVertices];this._stagedVertex!=null&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new w(this.view,t.vertices[0].index,i))}}),this._editGeometryOperations.on("vertex-add",t=>{if(this.notifyChange("vertices"),t.operation==="apply"){const i=this._committedVertices.length-1,r=new c(this.view,i,this.vertices);this.emit("vertex-add",r),r.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(t.operation==="redo"){const i=[...this._committedVertices];this._stagedVertex!=null&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new c(this.view,t.vertices[0].index,i))}})])}_addDrawTool(){const t=new d({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polygon",mode:this.mode});this._drawTool=t,this.view.addAndActivateTool(t),t.on("vertex-add",i=>{if(i.vertices.length===1){const{view:r}=this,h=i.vertices[0].vertexIndex,x=t.getVertexCoords();this.emit("vertex-add",new c(r,h,x)),i.operation!=="undo"&&i.operation!=="redo"||this.emit(i.operation,new c(r,h,x))}}),t.on("vertex-remove",i=>{if(i.vertices.length===1){const{view:r}=this,h=i.vertices[0].vertexIndex,x=t.getVertexCoords();this.emit("vertex-remove",new w(r,h,x)),i.operation!=="undo"&&i.operation!=="redo"||this.emit(i.operation,new w(r,h,x))}}),t.on("cursor-update",i=>{i.vertices.length===1&&this.emit("cursor-update",new _(this.view,i.vertices[0].vertexIndex,t.getVertexCoords()))}),t.on("complete",i=>{this.emit("draw-complete",new v(t.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(t){const i=this._coordinateHelper.arrayToVector(t);this._isDuplicateOfLastVertex(i)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(i))}_updateCursor(t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);i==null||t||this._pushCursorVertex(i.vertex,()=>this.emit("cursor-update",new _(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new O(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<3)return;this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const t=new v(this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this.removeAllHandles()}};s([n()],m.prototype,"_dragEnabled",null),s([n()],m.prototype,"_clickEnabled",null),s([n({type:k})],m.prototype,"mode",void 0),m=s([u("esri.views.draw.PolygonDrawAction")],m);let g=class extends V{constructor(e){super(e),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.mode=G}initialize(){this._addViewHandles(),this.view.type==="3d"&&this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}undo(){this._drawTool?this._drawTool.undo():(super.undo(),this.notifyChange("vertices"))}redo(){this._drawTool?this._drawTool.redo():(super.redo(),this.notifyChange("vertices"))}canUndo(){var e;return((e=this._drawTool)==null?void 0:e.canUndo())??super.canUndo()}canRedo(){var e;return((e=this._drawTool)==null?void 0:e.canRedo())??super.canRedo()}complete(){this._completeDrawing()}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles([this.view.on("key-down",e=>{const{key:t,repeat:i}=e;t!==a.vertexAdd||i?t!==a.complete||i?t!==a.undo||this.interactiveUndoDisabled||i?t!==a.redo||this.interactiveUndoDisabled||i||(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e)):(e.stopPropagation(),this._handleVertexAddKey(e))},o.TOOL)])}_addViewHandles2DOnly(){this.view.type==="2d"&&(this.addHandles([this.view.on("click",e=>{e.stopPropagation()},o.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&!this._panEnabled&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(e),e.pointerType==="touch"&&this._updateCursor())},o.TOOL),this.view.on("pointer-move",e=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=p(e),e.pointerType!=="touch"&&this._updateCursor()},o.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._cursorScreenPoint=p(e),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(e):this._addVertexOnPointerUp=!1)},o.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(e);this._vertexAddHandler(e)}else{const t=e.pointerType==="touch";this._updateCursor(t)}},o.TOOL),this.view.on("drag",e=>{this._dragEnabled&&this._activePointerId!=null&&!this._panEnabled&&e.stopPropagation()},o.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},o.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},o.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},o.TOOL),this.view.on("key-down",e=>{const{key:t,repeat:i}=e;t!==a.pan||i||(e.stopPropagation(),this._panEnabled=!0)},o.TOOL),this.view.on("key-up",e=>{e.key===a.pan&&(e.stopPropagation(),this._panEnabled=!1)},o.TOOL)]),this._addUndoRedoHandles())}_handleVertexAddKey(e){this._drawTool?this._drawTool.drawOperation.commitStagedVertex():this._cursorScreenPoint&&(this._abortSnapping(),this._vertexAddHandler(e))}_addUndoRedoHandles(){this.addHandles([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){const t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new w(this.view,e.vertices[0].index,t))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){const t=this._committedVertices.length-1,i=new c(this.view,t,this.vertices);this.emit("vertex-add",i),i.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){const t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new c(this.view,e.vertices[0].index,t))}})])}_addDrawTool(){const e=new d({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polyline",mode:this.mode});this._drawTool=e,this.view.addAndActivateTool(e),this.addHandles([e.on("vertex-add",t=>{if(t.vertices.length!==1)return;const{view:i}=this,r=t.vertices[0].vertexIndex,h=e.getVertexCoords();this.emit("vertex-add",new c(i,r,h)),t.operation!=="undo"&&t.operation!=="redo"||this.emit(t.operation,new c(i,r,h))}),e.on("vertex-remove",t=>{if(t.vertices.length!==1)return;const{view:i}=this,r=t.vertices[0].vertexIndex,h=e.getVertexCoords();this.emit("vertex-remove",new w(i,r,h)),t.operation!=="undo"&&t.operation!=="redo"||this.emit(t.operation,new w(i,r,h))}),e.on("cursor-update",t=>{t.vertices.length===1&&this.emit("cursor-update",new _(this.view,t.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("complete",t=>{this.emit("draw-complete",new v(e.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})])}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){const t=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(t)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(t))}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t==null||e||this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new _(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new O(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<2)return;this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const e=new v(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}};s([n()],g.prototype,"_clickEnabled",null),s([n()],g.prototype,"_dragEnabled",null),s([n({type:k})],g.prototype,"mode",void 0),g=s([u("esri.views.draw.PolylineDrawAction")],g);const ie=["freehand","click"];let P=class extends V{constructor(e){super(e),this._isDragging=!1,this._panEnabled=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.viewAlignedCoordinateSystem=null,this.mode="freehand"}initialize(){this.view.type==="2d"?this._addViewHandles():this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}complete(){this._completeDrawing()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this.mode==="click"?this.addHandles(this._getClickModeViewHandles()):this.addHandles(this._getDragModeViewHandles())}_getDragModeViewHandles(){return[this.view.on("immediate-click",e=>{e.stopPropagation(),e.mapPoint&&!this._panEnabled&&this.getCoordsFromScreenPoint(p(e))!=null&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))},o.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._panEnabled||(this._resetGeometry(),this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(e),this._activePointerId=e.pointerId,this._vertexAddHandler(e),this._isDragging=!1,e.pointerType==="touch"&&this._updateCursor()))},o.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._activePointerId==null&&e.pointerType!=="touch"&&(this._cursorScreenPoint=p(e),this._updateCursor())},o.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._isDragging=!0,this._cursorScreenPoint=p(e),this._updateCursor())},o.TOOL),this.view.on("pointer-up",e=>{this._shouldHandlePointerEvent(e)&&this._addVertexOnPointerUp&&(this._abortSnapping(),this._activePointerId=null,this._isDragging&&this._vertexAddHandler(e),this._committedVertices.length===2&&this._drawCompleteHandler(e),this._isDragging=!1)},o.TOOL),this.view.on("key-down",e=>{e.key===a.complete&&this._cursorScreenPoint?(this._abortSnapping(),this._vertexAddHandler(e),this._drawCompleteHandler(e)):e.key===a.pan&&(this._panEnabled=!0)},o.TOOL),this.view.on("key-up",e=>{e.key===a.pan&&(this._panEnabled=!1)},o.TOOL),this.view.on("drag",e=>{this._activePointerId!=null&&e.stopPropagation()},o.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},o.TOOL)]}_getClickModeViewHandles(){return[this.view.on("pointer-down",e=>{this._abortSnapping(),this._cursorScreenPoint=p(e),this._activePointerId=e.pointerId,this._isDragging=!1,e.pointerType==="touch"&&this._updateCursor()},o.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._cursorScreenPoint=p(e),this._activePointerId==null&&e.pointerType!=="touch"&&this._updateCursor()},o.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._isDragging=!0)},o.TOOL),this.view.on("pointer-up",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=null,e.stopPropagation(),this._isDragging||this._vertexAddHandler(e),this.vertices.length!==2||this._isDragging||this._drawCompleteHandler(e),this._isDragging=!1)},o.TOOL),this.view.on("key-down",e=>{e.key===a.vertexAdd&&this._cursorScreenPoint&&(this._vertexAddHandler(e),this.vertices.length===2&&this._drawCompleteHandler(e)),e.key===a.complete&&this._cursorScreenPoint&&this.vertices.length===2&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))},o.TOOL)]}_addDrawTool(){const e=new d({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"segment",mode:this.mode});this._drawTool=e,this.view.addAndActivateTool(e),this.addHandles([e.on("vertex-add",t=>{t.vertices.length===1&&this.emit("vertex-add",new c(this.view,t.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("cursor-update",t=>{t.vertices.length===1&&this.emit("cursor-update",new _(this.view,t.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("complete",t=>{this.emit("draw-complete",new v(e.getVertexCoords())),this._removeDrawTool()}),this.view.on("key-down",t=>{t.key!==a.vertexAdd||t.repeat||this.mode!=="click"?t.key!==a.complete||t.repeat||e.completeCreateOperation():e.drawOperation.numCommittedVertices>0?e.completeCreateOperation():e.drawOperation.commitStagedVertex()},o.TOOL)])}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){const t=this._coordinateHelper.arrayToVector(e);if(this._isDuplicateOfLastVertex(t))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(t),this._committedVertices.length===1&&(this.viewAlignedCoordinateSystem=Q(this.view,this._committedVertices[0]));const i=this._committedVertices.length-1,r=new c(this.view,i,this.vertices);this.emit("vertex-add",r)}_updateCursor(){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const e=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);e!=null&&this._pushCursorVertex(e.vertex,()=>this.emit("cursor-update",new _(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new O(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return this._drawTool.completeCreateOperation(),void this.removeAllHandles();if(this._activePointerId=null,this._popCursorVertex(),this._cursorScreenPoint=null,this._isDragging=!1,this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const e=new v(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}_resetGeometry(){this._editGeometryOperations.destroy(),this._editGeometryOperations=new I(new U("polygon",this._coordinateHelper),T.Local),this._activeComponent=new E(this._coordinateHelper.spatialReference,T.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}};s([n({type:ie})],P.prototype,"mode",void 0),P=s([u("esri.views.draw.SegmentDrawAction")],P);let y=class extends M{constructor(){super(...arguments),this.activeAction=null,this.type="draw",this.view=null}destroy(){this.activeAction&&(this.activeAction.destroy(),this.activeAction=null)}create(e,t){this.reset();const i={view:this.view,...t};switch(e){case"point":i.editGeometryType="point",this.activeAction=new C(i);break;case"polyline":i.editGeometryType="polyline",this.activeAction=new g(i);break;case"multipoint":i.editGeometryType="polygon",this.activeAction=new H(i);break;case"polygon":i.editGeometryType="polygon",this.activeAction=new m(i);break;case"rectangle":case"circle":case"ellipse":case"triangle":i.editGeometryType="polygon",this.activeAction=new P(i)}return this.activeAction}complete(){this.activeAction&&this.activeAction.complete(),this.activeAction=null}reset(){this.activeAction&&this.activeAction.destroy(),this.activeAction=null}};s([n()],y.prototype,"activeAction",void 0),s([n({readOnly:!0})],y.prototype,"type",void 0),s([n()],y.prototype,"view",void 0),y=s([u("esri.views.draw.Draw")],y);const Te=y;export{Te as l};
