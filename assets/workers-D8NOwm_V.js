const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./statsWorker-zO9R-4ij.js","./utils-hH5IaWNz.js","./geometry-CnaxvJsv.js","./subclass-BR3PhgZG.js","./Extent-B4rrMrqp.js","./Evented-CXIxDjmW.js","./Accessor-D6mNnsWy.js","./Point-TlcsOcXV.js","./jsonMap-DCC6W5ex.js","./writer-3zufXUNV.js","./assets-BNizZMOZ.js","./index-BVncS3aY.js","./index-CjOb8WjV.css","./Polyline-BQFeqYXi.js","./mathUtils-ClvKsMak.js","./screenUtils-PfxkaaMN.js","./timeUtils-DQR2jUPL.js","./Promise-CZrWwByK.js","./quantizationUtils-DFd0XKEL.js","./fieldUtils-C5R42-PY.js","./intl-CArXn1et.js","./heatmapUtils-C-uT6ZIV.js","./vec42-B1mBkh1w.js","./vec4f64-CBQL1T0x.js","./utils-HfpQY-3e.js","./Basemap-CKBB4cRW.js","./reactiveUtils-BFQ0BtrB.js","./shared-B3wH2qpO.js","./collectionUtils-Dm1icNvk.js","./Portal-DCqdz-K4.js","./loadAll-z9YY33Kx.js","./PortalItem-CaeKabGc.js","./persistableUrlUtils-Dx61-x4K.js","./writeUtils-BUKZUL8X.js","./layerUtils-BzjQnEdj.js","./mat4f32-DcsiF_Rp.js","./mat4-ybYUU6jq.js","./utils-DUUw13Ab.js","./ClassBreaksDefinition-BpZNgsmK.js","./enumeration--HlxOQ_N.js","./geometryEngineWorker-BZW3bPki.js","./geometryEngineJSON-DeYwub9C.js","./geometryEngineBase-RmbNeFm7.js","./_commonjsHelpers-DCkdB7M8.js","./json-Wa8cmqdu.js","./CSVSourceWorker-So1X1y6S.js","./date-M6n_RqpC.js","./projection-tSh-0UvX.js","./projectBuffer-iyGwL2dv.js","./geodesicConstants-kj1AtlGg.js","./OptimizedFeature-7juV2tZm.js","./OptimizedGeometry-vU5jWBvU.js","./FeatureStore-GQfqFqRN.js","./aaBoundingBox-BGxkJAW0.js","./featureConversionUtils-B-SknPj_.js","./jsonUtils-DtWlwXHP.js","./OptimizedFeatureSet-Blu9Ckm7.js","./BoundsStore-BYcuS8_t.js","./PooledRBush-CGlhTzFe.js","./quickselect-D0_cvEX6.js","./timeSupport-86-Lo3YD.js","./normalizeUtils-CuTX3yb4.js","./normalizeUtilsCommon-DNPu20r0.js","./utils-Blh5cXWv.js","./utils-Bh7lx_TM.js","./optimizedFeatureQueryEngineAdapter-Buta7wlw.js","./centroid-DdLmOD72.js","./QueryEngine-BaqPXEl6.js","./MemCache-C6WUx-5V.js","./LRUCache-ju6LnIBZ.js","./WhereClause-CO6Fm86l.js","./TimeOnly-BtK5SiqG.js","./UnknownTimeZone-D0GlcniK.js","./fieldType-CIG5ey7e.js","./QueryEngineCapabilities-CTDe3LlQ.js","./SnappingCandidate-O5eRSE6e.js","./FieldsIndex-DHql50vu.js","./Scheduler-CDoWuxMK.js","./signal-DzOfzcfh.js","./debugFlags-B3L9P_UW.js","./number-CrcpkfNb.js","./clientSideDefaults-DDr2PCsV.js","./defaultsJSON-GKolV7NZ.js","./EdgeProcessingWorker-CBu5HN5j.js","./workerHelper-DszV5Eae.js","./InterleavedLayout-UIhsB8jd.js","./BufferView-B7Z-dzh4.js","./vec2-B_ymkwGp.js","./Util-BMqL_pkg.js","./vec2f64-Diu2Kaa8.js","./edgeProcessing-kh6EVSro.js","./deduplicate-DxTSMkFY.js","./Indices-B6BGScAS.js","./VertexAttribute-BnAa5VW0.js","./glUtil-C6KhMg1m.js","./enums-BlUEVwJR.js","./VertexElementDescriptor-BOD-G50G.js","./Normals-D1LdtP06.js","./ElevationSamplerWorker-aT4XUEyD.js","./MeshLocalVertexSpace-sBjAuOT3.js","./Clonable-cKbRam6-.js","./vertexSpaceConversion-CtySDdI9.js","./mat3-DRqs2t5W.js","./mat3f64-BBpwCtoL.js","./mat4f64-Dk4dwAN8.js","./spatialReferenceEllipsoidUtils-DuE2W35w.js","./computeTranslationToOriginAndRotation-CFxYfzBj.js","./projectPointToVector-C-hGM2ap.js","./meshVertexSpaceUtils-BfF6O78E.js","./vec3-C3Q-RF_i.js","./projection-CODyCdLE.js","./DoubleArray-CF_CpVBS.js","./vec4-L9zJLV3y.js","./FeatureServiceSnappingSourceWorker-CiC2RR-g.js","./UpdatingHandles-CMtXpTiG.js","./TileInfo-Dm24FfTU.js","./TileKey-DZd6gJy7.js","./Query-BpMwiNVl.js","./TimeExtent-Dl-qaORu.js","./DataLayerSource-BX7Ap_tY.js","./Field-poIiHWUc.js","./FullTextSearch-BhJOgh_r.js","./ElevationInfo-jptbPjRY.js","./unitConversionUtils-BUA_O87q.js","./lengthUtils-vgIBtB6M.js","./symbologySnappingCandidates-DjmIkAOi.js","./arcgisLayerUrl-ETqee4Bd.js","./pbfQueryUtils-BxTeJmn3.js","./pbf-CmaozfCN.js","./query-DQxxoK17.js","./queryZScale-DGW6qDy9.js","./ByteSizeUnit-BsxeN7wM.js","./GeoJSONSourceWorker-s3ArB08A.js","./geojson-B6ajRYE7.js","./sourceUtils-BvhUgfwA.js","./LercWorker-B9ljw5Q5.js","./MemorySourceWorker-PqzQSD6k.js","./objectIdUtils-4dd1rf9p.js","./PBFDecoderWorker-BINoMsoh.js","./compilerUtils-BA04t1lN.js","./dehydratedFeatures-DzTz-nWK.js","./FeaturePipelineWorker-DWDbpBsA.js","./TileStrategy-Dx1mrlzq.js","./TileKey-CIqLSCov.js","./QueueProcessor-Bu6RBZRX.js","./Queue-DpHko4Yk.js","./ReactiveMap-Dl_3-Rm5.js","./definitions-ByNBSgP9.js","./diffUtils--7ofoPN-.js","./AttributeStore-BezdLLOX.js","./LabelMetric-Agz2doNK.js","./enums-BRXbslMp.js","./Texture-BbJIOVx_.js","./Program-BE7XUO18.js","./BufferObject-CjYoWxgZ.js","./BoundingBox-BhuXqU4L.js","./vec2f32-BbH2jxlN.js","./UpdateTracking2D-CBckaO4D.js","./BindType-BmZEZMMh.js","./highlightReasons-CQmHiFo_.js","./Color-DDUWtbqR.js","./colorUtils-CS9vdHXB.js","./HighlightOptions-BG8_qaKQ.js","./labelFormatUtils-CJcADR3o.js","./labelUtils-Cczy0uDR.js","./CIMSymbolHelper-Ei9DhmLE.js","./BidiEngine-BwB1Df7c.js","./TextSymbol-zZq0BA1M.js","./fontUtils-CILP_6vp.js","./GeometryUtils-CXWuBstD.js","./utils-D8D39sLt.js","./mat2d-DPkeMmgR.js","./mat2df32-orApM5a3.js","./Rect-CUzevAry.js","./defaults-CIM29kXM.js","./tileUtils-B7X19rIS.js","./MeshWriterRegistry-CaHsWeZB.js","./PieChartMeshWriter-6zNUQ6Fs.js","./TurboLine-DWtK5y8s.js","./earcut-BqgeR2O3.js","./constants-D5zmR9t2.js","./grouping-D5xAxFjR.js","./ogcFeatureUtils-af300Yrd.js","./StreamFeatureManager-CxTvjNd5.js","./CircularArray-CujHzHWW.js","./createConnection-CvfGxtUS.js","./PointCloudWorker-BSjiuvsp.js","./quat-ChS85qAG.js","./quatf64-BrpT0VRp.js","./vec3f32-Cw9Q6TO_.js","./PointCloudWorkerUtil-CVRnvUqm.js","./PointCloudUniqueValueRenderer-CrJCBPy2.js","./ColorStop-DEfc5Idt.js","./I3SBinaryReader-CtwiVPE4.js","./orientedBoundingBox-WyW1LZfF.js","./plane-Bz78OrLf.js","./mathUtils-kvswLROa.js","./ViewingMode-Dodu7ZZk.js","./RasterWorker-Dx6E5VLp.js","./dataUtils-BTw6iaAi.js","./pixelRangeUtils-DR2RxTkt.js","./RasterSymbolizer-BzK6A2vQ.js","./colorUtils-D5nOabzP.js","./rasterFunctionHelper-B8WvtUqY.js","./colorRamps-BBM5Timv.js","./rasterProjectionHelper-CuUa3waC.js","./SceneLayerSnappingSourceWorker-DXsDGMU1.js","./lineSegment-A3_mEhFF.js","./sphere-DIv2hmik.js","./Octree-BnKLop8B.js","./frustum-6KI4j9vx.js","./SceneLayerWorker-DZoOFbHf.js","./I3SNode-D1Sym7pQ.js","./I3SUtil-CLj2BKbM.js","./projectVectorToVector-BLdiwuTJ.js","./edgeUtils-BIb6yRHm.js","./floatRGBA-C8rGFKJ0.js","./DecodeSymbolColor.glsl-CeBC4xQe.js","./interfaces-B8ge7Jg9.js","./NormalAttribute.glsl-Dqf1UPF9.js","./Float4DrawUniform-CWdxHXQ-.js","./ElevationRange-BrgM1moX.js","./WFSSourceWorker-D_mAsbPA.js","./wfsUtils-ClEy5UL0.js","./xmlUtils-CtUoQO7q.js","./WorkerTileHandler-BkKSvMUF.js","./enums-BRzLM11V.js","./config-MDUrh2eL.js","./StyleDefinition-BK3ROBTO.js","./SourceLayerData-BCkczum9.js","./StyleRepository-CcGT0u4w.js","./unitBezier-BX6NeAEr.js","./Lyr3DWorker-DWjL3zBc.js","./ILyr3DWasmPerSceneView-vPx4somd.js","./Lyr3DModule-BKvydwE6.js"])))=>i.map(i=>d[i]);
import{h as l,c as $,k as ae,E as le,s as P,n as Y}from"./subclass-BR3PhgZG.js";import{b as J,y as ce,g as N,m as ue,f as k,h as C,K as he,L as de,s as j,N as T,w as pe}from"./Accessor-D6mNnsWy.js";import{s as _e}from"./Queue-DpHko4Yk.js";import{a2 as Z,a3 as ge,U as me,_ as f,n as fe}from"./assets-BNizZMOZ.js";import{_ as u}from"./index-BVncS3aY.js";import"./intl-CArXn1et.js";import{d as H}from"./Promise-CZrWwByK.js";const ee="20240724",te="ac51c09e1d17be02f839eb2e22bd05fd7a16c2d3",re=new FinalizationRegistry(t=>{t.close()});function be(t,e){re.register(t,e,e)}function ye(t){re.unregister(t)}function se(t,e){return new Proxy({},{get:(s,r,o)=>(...n)=>{let i,a;const c=n[n.length-1];return ke(c)&&(i=c.signal,a=c.transferList,n.pop()),t.apply(e?`${e}.${r.toString()}`:r.toString(),n,{transferList:a,signal:i})}})}function ke(t){return typeof t=="object"&&!Array.isArray(t)&&t!=null&&("signal"in t||"transferList"in t||Object.keys(t).length===0)}const ve={statsWorker:()=>u(()=>import("./statsWorker-zO9R-4ij.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39]),import.meta.url),geometryEngineWorker:()=>u(()=>import("./geometryEngineWorker-BZW3bPki.js"),__vite__mapDeps([40,41,42,43,44]),import.meta.url),CSVSourceWorker:()=>u(()=>import("./CSVSourceWorker-So1X1y6S.js"),__vite__mapDeps([45,2,3,4,5,6,7,8,9,10,11,12,13,14,26,27,46,47,48,49,44,50,51,52,53,54,55,56,57,58,59,43,60,61,62,63,64,65,66,67,68,69,70,71,72,17,73,74,18,19,20,1,15,16,21,22,23,24,25,28,29,30,31,32,33,34,35,36,37,38,39,75,76,77,78,79,80,81,82]),import.meta.url),EdgeProcessingWorker:()=>u(()=>import("./EdgeProcessingWorker-CBu5HN5j.js"),__vite__mapDeps([83,84,85,86,87,14,22,88,89,23,90,91,92,3,93,94,95,96,97,6]),import.meta.url),ElevationSamplerWorker:()=>u(()=>import("./ElevationSamplerWorker-aT4XUEyD.js"),__vite__mapDeps([98,3,58,6,59,43,99,5,100,10,11,12,39,8,14,101,7,9,102,103,36,104,105,106,48,49,107,47,26,27,4,13,108,109,110,111,86,87,22,112]),import.meta.url),FeatureServiceSnappingSourceWorker:()=>u(()=>import("./FeatureServiceSnappingSourceWorker-CiC2RR-g.js"),__vite__mapDeps([113,5,6,3,2,4,7,8,9,10,11,12,13,14,26,27,114,52,53,54,55,50,51,56,57,58,59,43,60,47,48,49,61,62,63,64,44,65,66,67,68,69,70,71,72,17,73,74,18,19,20,1,15,16,21,22,23,24,25,28,29,30,31,32,33,34,35,36,37,38,39,75,76,77,78,79,115,116,117,118,119,120,121,100,122,123,124,125,126,127,128,129,130,131]),import.meta.url),GeoJSONSourceWorker:()=>u(()=>import("./GeoJSONSourceWorker-s3ArB08A.js"),__vite__mapDeps([132,10,3,11,12,5,6,26,27,55,4,7,8,9,13,14,54,53,50,51,56,52,57,58,59,43,60,47,48,49,61,62,2,63,64,44,65,66,67,68,69,70,71,72,17,73,74,18,19,20,1,15,16,21,22,23,24,25,28,29,30,31,32,33,34,35,36,37,38,39,75,76,77,78,79,133,46,81,82,134]),import.meta.url),LercWorker:()=>u(()=>import("./LercWorker-B9ljw5Q5.js"),__vite__mapDeps([135,14]),import.meta.url),MemorySourceWorker:()=>u(()=>import("./MemorySourceWorker-PqzQSD6k.js"),__vite__mapDeps([136,3,55,4,5,6,7,8,9,10,11,12,13,14,54,53,50,51,56,137,52,57,58,59,43,60,47,26,27,48,49,61,62,2,63,64,44,65,66,67,68,69,70,71,72,17,73,74,18,19,20,1,15,16,21,22,23,24,25,28,29,30,31,32,33,34,35,36,37,38,39,75,76,77,78,79,81,82,134,46]),import.meta.url),PBFDecoderWorker:()=>u(()=>import("./PBFDecoderWorker-BINoMsoh.js"),__vite__mapDeps([138,139,3,6,7,5,8,9,10,11,12,47,26,27,14,4,13,48,49,140,53,18,2,120,39,73,54,55,50,51,56,127,128]),import.meta.url),FeaturePipelineWorker:()=>u(()=>import("./FeaturePipelineWorker-DWDbpBsA.js"),__vite__mapDeps([141,3,6,26,5,27,15,115,8,10,11,12,7,9,13,4,14,116,142,143,87,144,145,146,78,147,148,149,150,151,152,95,153,154,43,96,155,156,53,157,158,88,89,22,23,159,160,161,162,59,117,2,118,16,17,39,55,119,120,73,121,100,114,19,20,163,164,76,72,71,165,166,167,168,51,169,170,171,172,173,174,82,66,54,50,56,60,47,48,49,61,62,63,64,44,175,176,177,178,179,180,181,65,67,68,69,70,74,18,1,21,24,25,28,29,30,31,32,33,34,35,36,37,38,75,77,79,129,127,128,130,126,182,133,46,81,134,183,184,185]),import.meta.url),PointCloudWorker:()=>u(()=>import("./PointCloudWorker-BSjiuvsp.js"),__vite__mapDeps([186,3,187,103,188,14,22,189,7,5,6,8,9,10,11,12,48,49,190,191,39,192,160,161,193,93,194,102,104,23,105,106,36,195,89,196,197]),import.meta.url),RasterWorker:()=>u(()=>import("./RasterWorker-Dx6E5VLp.js"),__vite__mapDeps([198,2,3,4,5,6,7,8,9,10,11,12,13,14,47,26,27,48,49,199,200,201,43,202,160,161,22,23,203,39,55,204,120,73,205]),import.meta.url),SceneLayerSnappingSourceWorker:()=>u(()=>import("./SceneLayerSnappingSourceWorker-DXsDGMU1.js"),__vite__mapDeps([206,5,6,3,14,207,208,36,22,23,13,9,4,7,8,10,11,12,195,103,104,188,89,196,209,210,88,90,91,92,85,86,87,93,94,95,96,97]),import.meta.url),SceneLayerWorker:()=>u(()=>import("./SceneLayerWorker-DZoOFbHf.js").then(t=>t.S),__vite__mapDeps([211,11,12,14,7,5,6,3,8,9,10,111,99,100,39,109,212,23,208,36,22,13,4,195,103,104,188,89,196,213,2,47,26,27,48,49,105,214,107,117,118,16,17,55,119,120,73,121,193,93,106,215,160,161,15,139,216,217,218,219,158,220,194,102,187,197,221]),import.meta.url),WFSSourceWorker:()=>u(()=>import("./WFSSourceWorker-D_mAsbPA.js"),__vite__mapDeps([222,26,5,6,3,27,7,8,9,10,11,12,54,53,4,13,14,55,50,51,56,52,57,58,59,43,60,47,48,49,61,62,2,63,64,44,65,66,67,68,69,70,71,72,17,73,74,18,19,20,1,15,16,21,22,23,24,25,28,29,30,31,32,33,34,35,36,37,38,39,75,76,77,78,79,133,46,134,223,224,126,120]),import.meta.url),WorkerTileHandler:()=>u(()=>import("./WorkerTileHandler-BkKSvMUF.js"),__vite__mapDeps([225,6,3,226,169,13,5,9,4,7,8,10,11,12,14,173,227,228,151,128,178,147,229,230,95,96,160,161,202,22,23,231,179,43,166]),import.meta.url),Lyr3DWorker:()=>u(()=>import("./Lyr3DWorker-DWjL3zBc.js"),__vite__mapDeps([232,233,234,11,12,10,3,5,6]),import.meta.url)},oe="worker:port-closed";var h;(function(t){t[t.HANDSHAKE=0]="HANDSHAKE",t[t.OPEN=1]="OPEN",t[t.OPENED=2]="OPENED",t[t.RESPONSE=3]="RESPONSE",t[t.INVOKE=4]="INVOKE",t[t.ABORT=5]="ABORT",t[t.CLOSE=6]="CLOSE",t[t.OPEN_PORT=7]="OPEN_PORT",t[t.ON=8]="ON"})(h||(h={}));let we=0;function ne(){return we++}function Ee(t){return t&&typeof t=="object"&&("result"in t||"transferList"in t)}function v(t){return t?typeof t=="string"?JSON.stringify({name:"message",message:t}):t.toJSON?JSON.stringify(t):JSON.stringify({name:t.name,message:t.message,details:t.details||{stack:t.stack}}):null}function W(t,e,s,r){if(e.type===h.OPEN_PORT)return void t.postMessage(e,[e.port]);if(e.type!==h.INVOKE&&e.type!==h.RESPONSE)return void t.postMessage(e);let o;if(Ee(s)?(o=V(s.transferList),e.data=s.result):(o=V(r),e.data=s),o){if(l("ff")){for(const n of o)if("byteLength"in n&&n.byteLength>267386880){const i="Worker call with large ArrayBuffer would crash Firefox";switch(e.type){case h.INVOKE:throw i;case h.RESPONSE:return void W(t,{type:h.RESPONSE,jobId:e.jobId,error:v(i)})}}}t.postMessage(e,o)}else t.postMessage(e)}function w(t){if(!t)return null;const e=t.data;return e?typeof e=="string"?JSON.parse(e):e:null}function V(t){if(!(t!=null&&t.length))return null;if(l("esri-workers-arraybuffer-transfer"))return t;const e=t.filter(s=>!Pe(s));return e.length?e:null}function Pe(t){var e;return t instanceof ArrayBuffer||((e=t==null?void 0:t.constructor)==null?void 0:e.name)==="ArrayBuffer"}async function Be(t){try{return await t}catch(e){const s=(e==null?void 0:e.name)===oe;if(!(J(e)||s))throw e;return}}const{CLOSE:U,ABORT:x,INVOKE:q,RESPONSE:b,OPEN_PORT:F,ON:Oe}=h,Ie=2;class Se{constructor(e){this._invoke=e,this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._timer=null,this._process=this._process.bind(this)}push(e){e.type===h.ABORT?this._cancelledJobIds.add(e.jobId):(this._invokeMessages.push(e),this._timer===null&&(this._timer=setTimeout(this._process,0)))}clear(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null}_process(){this._timer=null;for(const e of this._invokeMessages)this._cancelledJobIds.has(e.jobId)||this._invoke(e);this._cancelledJobIds.clear(),this._invokeMessages.length=0}}class _{static connect(e,s){const r=new MessageChannel;let o;o=typeof e=="function"?new e:"default"in e&&typeof e.default=="function"?new e.default:e;const n=new _(r.port1,{channel:r,client:o,schedule:s});return typeof o=="object"&&"remoteClient"in o&&(o.remoteClient=n),_.clients.set(n,o),r.port2}static loadWorker(e){const s=ve[e];return s?s():Promise.resolve(null)}constructor(e,s,r){this._port=e,this._jobQueue=r,this._outJobs=new Map,this._inJobs=new Map,this._invokeQueue=new Se(o=>this._onInvokeMessage(o)),this._client=s.client,this._onMessage=this._onMessage.bind(this),this._channel=s.channel,this._schedule=s.schedule,this._port.addEventListener("message",this._onMessage),this._port.start()}close(){this._post({type:U}),this._close()}isBusy(){return this._outJobs.size>0}invoke(e,s,r){return this.apply(e,[s],r)}apply(e,s,r){const o=r==null?void 0:r.signal,n=r==null?void 0:r.transferList;if(!this._port)return Promise.reject(new $(oe,`Cannot call invoke('${e}'), port is closed`,{methodName:e,data:s}));const i=ne();return new Promise((a,c)=>{if(ce(o))return this._processWork(),void c(N());const d=ue(o,()=>{const g=this._outJobs.get(i);g&&(this._outJobs.delete(i),this._processWork(),k(g.abortHandle),this._post({type:x,jobId:i}),c(N()))}),p={resolve:a,reject:c,abortHandle:d,debugInfo:e};this._outJobs.set(i,p),this._post({type:q,jobId:i,methodName:e,abortable:o!=null},s,n)})}createInvokeProxy(e){return se(this,e)}on(e,s){const r=new MessageChannel;function o(n){s(n.data)}return this._port.postMessage({type:h.ON,eventType:e,port:r.port2},[r.port2]),r.port1.addEventListener("message",o),r.port1.start(),ae(()=>{r.port1.postMessage({type:h.CLOSE}),r.port1.close(),r.port1.removeEventListener("message",o)})}jobAdded(){this._processWork()}openPort(){const e=new MessageChannel;return this._post({type:F,port:e.port2}),e.port1}_processWork(){var i;if(this._outJobs.size>=Ie)return;const e=(i=this._jobQueue)==null?void 0:i.pop();if(!e)return;const{methodName:s,data:r,invokeOptions:o,resolver:n}=e;this.apply(s,r,o).then(a=>n.resolve(a)).catch(a=>n.reject(a))}_close(){this._channel&&(this._channel=void 0),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach(e=>{k(e.abortHandle),e.reject(N(`Worker closing, aborting job calling '${e.debugInfo}'`))}),this._inJobs.clear(),this._outJobs.clear(),this._invokeQueue.clear(),this._port=null,this._client=null,this._schedule=null}_onMessage(e){this._schedule!=null?this._schedule(()=>this._processMessage(e,!0)):this._processMessage(e,!1)}_processMessage(e,s){const r=w(e);if(r)switch(r.type){case b:this._onResponseMessage(r);break;case q:s?this._onInvokeMessage(r):this._invokeQueue.push(r);break;case x:this._onAbortMessage(r);break;case U:this._onCloseMessage();break;case F:this._onOpenPortMessage(r);break;case Oe:this._onOnMessage(r)}}_onAbortMessage(e){const s=this._inJobs,r=e.jobId,o=s.get(r);this._invokeQueue.push(e),o&&(o.controller&&o.controller.abort(),s.delete(r))}_onCloseMessage(){const e=this._client;this._close(),e&&"destroy"in e&&_.clients.get(this)===e&&e.destroy(),_.clients.delete(this),e!=null&&e.remoteClient&&(e.remoteClient=null)}_onInvokeMessage(e){const{methodName:s,jobId:r,data:o=[],abortable:n}=e,i=n?new AbortController:null,a=this._inJobs;let c,d=this._client,p=d[s];try{if(!p&&s&&s.includes(".")){const g=s.split(".");for(let E=0;E<g.length-1;E++)d=d[g[E]],p=d[g[E+1]]}if(typeof p!="function")throw new TypeError(`${s} is not a function`);o.push({client:this,signal:i?i.signal:null}),c=p.apply(d,o)}catch(g){return void this._post({type:b,jobId:r,error:v(g)})}C(c)?(a.set(r,{controller:i,promise:c}),c.then(g=>{a.has(r)&&(a.delete(r),this._post({type:b,jobId:r},g))},g=>{a.has(r)&&(a.delete(r),J(g)||this._post({type:b,jobId:r,error:v(g||{message:`Error encountered at method ${s}`})}))})):this._post({type:b,jobId:r},c)}_onOpenPortMessage(e){new _(e.port,{client:this._client})}_onOnMessage(e){const{port:s}=e,r=this._client.on(e.eventType,n=>{s.postMessage(n)}),o=he(e.port,"message",n=>{const i=w(n);(i==null?void 0:i.type)===h.CLOSE&&(o.remove(),r.remove(),s.close())})}_onResponseMessage(e){const{jobId:s,error:r,data:o}=e,n=this._outJobs;if(!n.has(s))return;const i=n.get(s);n.delete(s),this._processWork(),k(i.abortHandle),r?i.reject($.fromJSON(JSON.parse(r))):i.resolve(o)}_post(e,s,r){return W(this._port,e,s,r)}}_.kernelInfo={buildDate:ee,fullVersion:Z,revision:te},_.clients=new Map;let Me=class{constructor(){this._inUseClients=new Array,this._clients=new Array,this._clientPromises=new Array,this._ongoingJobsQueue=new _e}destroy(){this.close()}get closed(){var e;return!((e=this._clients)!=null&&e.length)}open(e,s){return new Promise((r,o)=>{let n=!0;const i=a=>{j(s.signal),n&&(n=!1,a())};this._clients.length=e.length,this._clientPromises.length=e.length,this._inUseClients.length=e.length;for(let a=0;a<e.length;++a){const c=e[a];C(c)?this._clientPromises[a]=c.then(d=>(this._clients[a]=new _(d,s,this._ongoingJobsQueue),i(r),this._clients[a]),()=>(i(o),null)):(this._clients[a]=new _(c,s,this._ongoingJobsQueue),this._clientPromises[a]=Promise.resolve(this._clients[a]),i(r))}})}broadcast(e,s,r){const o=new Array(this._clientPromises.length);for(let n=0;n<this._clientPromises.length;++n){const i=this._clientPromises[n];o[n]=i.then(a=>a==null?void 0:a.invoke(e,s,r))}return o}close(){let e;for(;e=this._ongoingJobsQueue.pop();)e.resolver.reject(N(`Worker closing, aborting job calling '${e.methodName}'`));for(const s of this._clientPromises)s.then(r=>r==null?void 0:r.close());this._clients.length=0,this._clientPromises.length=0,this._inUseClients.length=0,ye(this)}invoke(e,s,r){return this.apply(e,[s],r)}apply(e,s,r){const o=de();this._ongoingJobsQueue.push({methodName:e,data:s,invokeOptions:r,resolver:o});for(let n=0;n<this._clientPromises.length;n++){const i=this._clients[n];i?i.jobAdded():this._clientPromises[n].then(a=>a==null?void 0:a.jobAdded())}return o.promise}createInvokeProxy(e){return se(this,e)}on(e,s){return Promise.all(this._clientPromises).then(()=>le(this._clients.map(r=>r.on(e,s))))}openPorts(){return new Promise(e=>{const s=new Array(this._clientPromises.length);let r=s.length;for(let o=0;o<this._clientPromises.length;++o)this._clientPromises[o].then(n=>{n&&(s[o]=n.openPort()),--r==0&&e(s)})})}get test(){}};const Ne={async request(t,e){var i,a;const s=t.options,r=s.responseType;s.signal=e==null?void 0:e.signal,s.responseType=r==="native"||r==="native-request-init"?"native-request-init":r&&["blob","json","text"].includes(r)&&((i=ge(t.url))!=null&&i.after)?r:"array-buffer";const o=await me(t.url,s),n={data:o.data,httpStatus:o.httpStatus,ssl:o.ssl};switch((a=o.requestOptions)==null?void 0:a.responseType){case"native-request-init":return delete n.data.signal,n;case"blob":n.data=await n.data.arrayBuffer();break;case"json":n.data=new TextEncoder().encode(JSON.stringify(n.data)).buffer;break;case"text":n.data=new TextEncoder().encode(n.data).buffer}return{result:n,transferList:[n.data]}}},K={};function Le(t){var s;const e={async:t.async,isDebug:t.isDebug,locale:t.locale,baseUrl:t.baseUrl,has:{...t.has},map:{...t.map},packages:((s=t.packages)==null?void 0:s.concat())||[],paths:{...K.paths,...t.paths}};return t.hasOwnProperty("async")||(e.async=!0),t.hasOwnProperty("isDebug")||(e.isDebug=!1),t.baseUrl||(e.baseUrl=K.baseUrl),e}class Ae{constructor(){const e=document.createDocumentFragment();["addEventListener","dispatchEvent","removeEventListener"].forEach(s=>{this[s]=(...r)=>e[s](...r)})}}let L=class{constructor(){this._dispatcher=new Ae,this._workerPostMessage({type:h.HANDSHAKE})}terminate(){}get onmessage(){return this._onmessageHandler}set onmessage(e){this._onmessageHandler&&this.removeEventListener("message",this._onmessageHandler),this._onmessageHandler=e,e&&this.addEventListener("message",e)}get onmessageerror(){return this._onmessageerrorHandler}set onmessageerror(e){this._onmessageerrorHandler&&this.removeEventListener("messageerror",this._onmessageerrorHandler),this._onmessageerrorHandler=e,e&&this.addEventListener("messageerror",e)}get onerror(){return this._onerrorHandler}set onerror(e){this._onerrorHandler&&this.removeEventListener("error",this._onerrorHandler),this._onerrorHandler=e,e&&this.addEventListener("error",e)}postMessage(e){T(()=>{this._workerMessageHandler(new MessageEvent("message",{data:e}))})}dispatchEvent(e){return this._dispatcher.dispatchEvent(e)}addEventListener(e,s,r){this._dispatcher.addEventListener(e,s,r)}removeEventListener(e,s,r){this._dispatcher.removeEventListener(e,s,r)}_workerPostMessage(e){T(()=>{this.dispatchEvent(new MessageEvent("message",{data:e}))})}async _workerMessageHandler(e){const s=w(e);if(s&&s.type===h.OPEN){const{modulePath:r,jobId:o}=s;let n=await _.loadWorker(r);n||(n=await import(r));const i=_.connect(n);this._workerPostMessage({type:h.OPENED,jobId:o,data:i})}}};const R=()=>Y.getLogger("esri.core.workers.workerFactory"),{HANDSHAKE:$e}=h,je='let globalId=0;const outgoing=new Map,configuration={CONFIGURATION};self.esriConfig=configuration.esriConfig;const workerPath=self.esriConfig.workers.workerPath,HANDSHAKE=0,OPEN=1,OPENED=2,RESPONSE=3,INVOKE=4,ABORT=5;function createAbortError(){const e=new Error("Aborted");return e.name="AbortError",e}function receiveMessage(e){return e&&e.data?"string"==typeof e.data?JSON.parse(e.data):e.data:null}function invokeStaticMessage(e,o,r){const t=r&&r.signal,n=globalId++;let s=null;return new Promise(((r,i)=>{if(t){if(t.aborted)return i(createAbortError());s=()=>{outgoing.get(n)&&(outgoing.delete(n),self.postMessage({type:5,jobId:n}),i(createAbortError()))},t.addEventListener("abort",s)}outgoing.set(n,{resolve:r,reject:i}),self.postMessage({type:4,jobId:n,methodName:e,abortable:null!=t,data:o})})).finally((()=>{t&&t.removeEventListener("abort",s)}))}let workerRevisionChecked=!1;function checkWorkerRevision(e){if(!workerRevisionChecked&&e.kernelInfo){workerRevisionChecked=!0;const{revision:o,fullVersion:r}=configuration.kernelInfo,{revision:t,fullVersion:n,version:s}=e.kernelInfo;esriConfig.assetsPath!==esriConfig.defaultAssetsPath&&o!==t&&console.warn(`Version mismatch detected between ArcGIS Maps SDK for JavaScript modules and assets. For more information visit https://bit.ly/3QnsuSo.\nModules version: ${r}\nAssets version: ${n??s}\nAssets path: ${esriConfig.assetsPath}`)}}function messageHandler(e){const o=receiveMessage(e);if(!o)return;const r=o.jobId;switch(o.type){case 1:let n;function t(e){const o=n.connect(e);self.postMessage({type:2,jobId:r,data:o},[o])}"function"==typeof define&&define.amd?require([workerPath],(e=>{n=e.default||e,checkWorkerRevision(n),n.loadWorker(o.modulePath).then((e=>e||new Promise((e=>{require([o.modulePath],e)})))).then(t)})):"System"in self&&"function"==typeof System.import?System.import(workerPath).then((e=>(n=e.default,checkWorkerRevision(n),n.loadWorker(o.modulePath)))).then((e=>e||System.import(o.modulePath))).then(t):esriConfig.workers.useDynamicImport?import(workerPath).then((e=>{n=e.default||e,checkWorkerRevision(n),n.loadWorker(o.modulePath).then((e=>e||import(o.modulePath))).then(t)})):(self.RemoteClient||importScripts(workerPath),n=self.RemoteClient.default||self.RemoteClient,checkWorkerRevision(n),n.loadWorker(o.modulePath).then(t));break;case 3:if(outgoing.has(r)){const s=outgoing.get(r);outgoing.delete(r),o.error?s.reject(JSON.parse(o.error)):s.resolve(o.data)}}}self.dojoConfig=configuration.loaderConfig,esriConfig.workers.loaderUrl&&(self.importScripts(esriConfig.workers.loaderUrl),"function"==typeof require&&"function"==typeof require.config&&require.config(configuration.loaderConfig)),self.addEventListener("message",messageHandler),self.postMessage({type:0});';let O,I;const B="Failed to create Worker. Fallback to execute module in main thread";async function Re(){if(!l("esri-workers"))return Q(new L);if(!O&&!I)try{const e=je.split("{CONFIGURATION}").join(Je());O=URL.createObjectURL(new Blob([e],{type:"text/javascript"}))}catch(e){I=e||{}}let t;if(O)try{t=new Worker(O,{name:"esri-worker-"+Ce++})}catch{R().warn(B,I),t=new L}else R().warn(B,I),t=new L;return Q(t)}async function Q(t){return new Promise(e=>{function s(o){const n=w(o);n&&n.type===$e&&(t.removeEventListener("message",s),t.removeEventListener("error",r),e(t))}function r(o){o.preventDefault(),t.removeEventListener("message",s),t.removeEventListener("error",r),R().warn("Failed to create Worker. Fallback to execute module in main thread",o),(t=new L).addEventListener("message",s),t.addEventListener("error",r)}t.addEventListener("message",s),t.addEventListener("error",r)})}function Je(){let t;if(P.default!=null){const o={...P};delete o.default,t=JSON.parse(JSON.stringify(o))}else t=JSON.parse(JSON.stringify(P));t.assetsPath=f(t.assetsPath),t.defaultAssetsPath=t.defaultAssetsPath?f(t.defaultAssetsPath):void 0,t.request.interceptors=[],t.log.interceptors=[],t.locale=H(),t.has={"esri-csp-restrictions":l("esri-csp-restrictions"),"esri-2d-debug":!1,"esri-2d-update-debug":l("esri-2d-update-debug"),"esri-2d-log-updating":l("esri-2d-log-updating"),"featurelayer-pbf":l("featurelayer-pbf"),"featurelayer-fast-triangulation-enabled":l("featurelayer-fast-triangulation-enabled"),"featurelayer-simplify-thresholds":l("featurelayer-simplify-thresholds"),"featurelayer-simplify-payload-size-factors":l("featurelayer-simplify-payload-size-factors"),"featurelayer-simplify-mobile-factor":l("featurelayer-simplify-mobile-factor"),"featurelayer-query-max-depth":l("featurelayer-query-max-depth"),"featurelayer-query-pausing-enabled":l("featurelayer-query-pausing-enabled"),"featurelayer-snapshot-enabled":l("featurelayer-snapshot-enabled"),"esri-atomics":l("esri-atomics"),"esri-shared-array-buffer":l("esri-shared-array-buffer"),"esri-tiles-debug":l("esri-tiles-debug"),"esri-workers-arraybuffer-transfer":l("esri-workers-arraybuffer-transfer"),"feature-polyline-generalization-factor":l("feature-polyline-generalization-factor"),"host-webworker":1},t.workers.loaderUrl&&(t.workers.loaderUrl=f(t.workers.loaderUrl)),t.workers.workerPath?t.workers.workerPath=f(t.workers.workerPath):t.workers.workerPath=f(fe("esri/core/workers/RemoteClient.js")),t.workers.useDynamicImport=!1;const e=P.workers.loaderConfig,s=Le({baseUrl:e==null?void 0:e.baseUrl,locale:H(),has:{"csp-restrictions":1,"dojo-test-sniff":0,"host-webworker":1,...e==null?void 0:e.has},map:{...e==null?void 0:e.map},paths:{...e==null?void 0:e.paths},packages:(e==null?void 0:e.packages)||[]});return JSON.stringify({esriConfig:t,loaderConfig:s,kernelInfo:{buildDate:ee,fullVersion:Z,revision:te}})}let Ce=0;const{ABORT:z,INVOKE:We,OPEN:De,OPENED:Te,RESPONSE:y}=h;class D{static async create(e){const s=await Re();return new D(s,e)}constructor(e,s){this._outJobs=new Map,this._inJobs=new Map,this.worker=e,this.id=s,e.addEventListener("message",this._onMessage.bind(this)),e.addEventListener("error",r=>{r.preventDefault(),Y.getLogger("esri.core.workers.WorkerOwner").error(r)})}terminate(){this.worker.terminate()}async open(e,s={}){const{signal:r}=s,o=ne();return new Promise((n,i)=>{const a={resolve:n,reject:i,abortHandle:pe(r,()=>{this._outJobs.delete(o),this._post({type:z,jobId:o})})};this._outJobs.set(o,a),this._post({type:De,jobId:o,modulePath:e})})}_onMessage(e){const s=w(e);if(s)switch(s.type){case Te:this._onOpenedMessage(s);break;case y:this._onResponseMessage(s);break;case z:this._onAbortMessage(s);break;case We:this._onInvokeMessage(s)}}_onAbortMessage(e){const s=this._inJobs,r=e.jobId,o=s.get(r);o&&(o.controller&&o.controller.abort(),s.delete(r))}_onInvokeMessage(e){const{methodName:s,jobId:r,data:o,abortable:n}=e,i=n?new AbortController:null,a=this._inJobs,c=Ne[s];let d;try{if(typeof c!="function")throw new TypeError(`${s} is not a function`);d=c.call(null,o,{signal:i?i.signal:null})}catch(p){return void this._post({type:y,jobId:r,error:v(p)})}C(d)?(a.set(r,{controller:i,promise:d}),d.then(p=>{a.has(r)&&(a.delete(r),this._post({type:y,jobId:r},p))},p=>{a.has(r)&&(a.delete(r),p||(p={message:"Error encountered at method"+s}),J(p)||this._post({type:y,jobId:r,error:v(p||{message:`Error encountered at method ${s}`})}))})):this._post({type:y,jobId:r},d)}_onOpenedMessage(e){const{jobId:s,data:r}=e,o=this._outJobs.get(s);o&&(this._outJobs.delete(s),k(o.abortHandle),o.resolve(r))}_onResponseMessage(e){const{jobId:s,error:r,data:o}=e,n=this._outJobs.get(s);n&&(this._outJobs.delete(s),k(n.abortHandle),r?n.reject($.fromJSON(JSON.parse(r))):n.resolve(o))}_post(e,s,r){return W(this.worker,e,s,r)}}const G=l("host-browser")?Math.min(navigator.hardwareConcurrency-1,l("workers-pool-size")):0;let m=l("esri-mobile")?Math.min(G,3):G;m||(m=l("safari")&&l("mac")?7:2);let X=0;const A=[];function Ge(){ie()}async function S(t,e){const s=new Me,{registryTarget:r,...o}=e;return await s.open(t,o),r&&be(r,s),s}async function Xe(t,e={}){if(typeof t!="string")throw new $("workers:undefined-module","modulePath is missing");let s=e.strategy||"distributed";if(l("host-webworker")&&!l("esri-workers")&&(s="local"),s==="local"){let r=await _.loadWorker(t);r||(r=await import(t)),j(e.signal);const o=e.client||r;return S([_.connect(r,e.schedule)],{...e,client:o})}if(await ie(),j(e.signal),s==="dedicated"){const r=X++%m;return S([await A[r].open(t,e)],e)}if(e.maxNumWorkers&&e.maxNumWorkers>0){const r=Math.min(e.maxNumWorkers,m);if(r<m){const o=new Array(r);for(let n=0;n<r;++n){const i=X++%m;o[n]=A[i].open(t,e)}return S(o,e)}}return S(A.map(r=>r.open(t,e)),e)}let M=null;async function ie(){if(M)return M;new AbortController;const t=[];for(let e=0;e<m;e++){const s=D.create(e).then(r=>(A[e]=r,r));t.push(s)}return M=Promise.all(t),M}export{_ as E,Be as O,Me as c,Ge as m,Xe as p};
