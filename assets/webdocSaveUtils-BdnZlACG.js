const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./geometryServiceUtils-K7u_-O-B.js","./subclass-BR3PhgZG.js","./Portal-liet8xHC.js","./index-CeCSsEgo.js","./index-CjOb8WjV.css","./Evented-CXIxDjmW.js","./Accessor-D6mNnsWy.js","./assets-C2mb-ea2.js","./Promise-CZrWwByK.js","./jsonMap-DCC6W5ex.js","./writer-3zufXUNV.js","./Extent-DHjqVB-p.js","./Point-DB4Hp4hH.js","./project-C_6NxEch.js","./jsonUtils-Cma_7A64.js","./Polyline-D97hl-6E.js","./mathUtils-ClvKsMak.js","./utils-D61i9O7E.js","./utils-Dx8bgRIB.js"])))=>i.map(i=>d[i]);
import{_ as U}from"./index-CeCSsEgo.js";import{c as f}from"./subclass-BR3PhgZG.js";import{m as F}from"./MultiOriginJSONSupport-DjAXzJun.js";import{w as y}from"./reactiveUtils-BFQ0BtrB.js";import{W as K,I as H}from"./assets-C2mb-ea2.js";import{i as J}from"./originUtils-D69mHv66.js";import{G as q,R as z,f as Q}from"./Point-DB4Hp4hH.js";import{I as X}from"./arcgisLayerUrl-Cgl5IQFD.js";import{L as A,w as Y}from"./layerUtils-erzwAANv.js";import{C as Z}from"./Portal-liet8xHC.js";import $ from"./PortalItem-BuTU9OuN.js";import{o as ee}from"./jsonContext-9yrMdsS4.js";import{a as n,i as l,s as u,f as _}from"./portalItemUtils-DIZSrm3T.js";import{p as ae,n as oe}from"./project-C_6NxEch.js";import{U as te,w as re,j as ie}from"./basemapUtils-CkCKogG3.js";import{p as P}from"./resourceUtils-DVLIxTBF.js";import{i as O}from"./saveAPIKeyUtils--6vvrYdZ.js";import{r as T,t as S}from"./saveUtils-BlgyRdsU.js";import"./Evented-CXIxDjmW.js";import"./Accessor-D6mNnsWy.js";import"./shared-B3wH2qpO.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./jsonMap-DCC6W5ex.js";import"./writer-3zufXUNV.js";import"./persistableUrlUtils-BcifXQ1Z.js";import"./Promise-CZrWwByK.js";import"./Extent-DHjqVB-p.js";import"./projection-A9yUaaTs.js";import"./mathUtils-ClvKsMak.js";import"./Polyline-D97hl-6E.js";import"./projectBuffer-vsa0P_cF.js";import"./geodesicConstants-XRAvAZCD.js";import"./jsonUtils-Cma_7A64.js";import"./utils-D61i9O7E.js";import"./utils-Dx8bgRIB.js";import"./Basemap-DhGpUWGY.js";import"./collectionUtils-Dm1icNvk.js";import"./loadAll-DDw-urzS.js";import"./writeUtils-3wz9AuW7.js";import"./utils-D20M4_S8.js";import"./colorUtils-CS9vdHXB.js";import"./screenUtils-PfxkaaMN.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-ybYUU6jq.js";import"./uuid-fwrPAdZb.js";import"./resourceUtils-CLi0K8NA.js";const ne=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map(a=>a.toLowerCase());async function Wa(a,e,o){o??(o={}),se(a,e),await y(()=>!e.updatingFromView),await e.load(),await V(e),await T(e),await E(a,e);const t=e.portalItem,{json:r,jsonContext:i}=await C(e,t);return S(i,{errorName:`${a.name}:save`},o),await G(e,t),await Oe(a,e,t,r,i),await Promise.all([e.updateItemThumbnail(),P(e.resourceReferences,i)]),t}async function C(a,e){const o=ee(e,"web-map",!0),t=a.write({},o);return await Promise.all(o.resources.pendingOperations),{json:t,jsonContext:o}}async function Ia(a,e,o,t){t??(t={});const r=pe(a,o);await y(()=>!e.updatingFromView),await e.load(),await V(e),await T(e),await E(a,e);const{json:i,jsonContext:s}=await C(e,r);S(s,{errorName:`${a.name}:save`},t),await ue(e,r);const p=e.getThumbnailState();return await Te(a,e,r,i,s,t)&&(e.resourceReferences.portalItem=r),e.restoreThumbnailFromState(p),await Promise.all([e.updateItemThumbnail(),P(e.resourceReferences,s)]),r}function se(a,e){if(!e.portalItem)throw new f(`${a.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");O(e.portalItem),D(a,e.portalItem)}function D(a,e){if(e.type!==a.itemType)throw new f(`${a.name}:portal-item-wrong-type`,`Portal item needs to have type "${a.itemType}"`)}async function E(a,e){var t;if(!((t=e.basemap)!=null&&t.baseLayers.length))throw new f(`${a.name}:save`,"Map does not have a valid basemap with a base layer.");let o=null;if(await y(()=>{const r=te(e.initialViewProperties,e.basemap);return o=r.spatialReference,!r.updating}),!q(o,e.initialViewProperties.spatialReference))throw new f(`${a.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:e.initialViewProperties.spatialReference,actual:o})}function pe(a,e){let o=$.from(e);return o.id&&(o=o.clone(),o.id=null),o.type||(o.type=a.itemType),o.portal||(o.portal=Z.getDefault()),O(o),D(a,o),o}function V(a){const e=[];return a.basemap&&e.push(a.basemap.load()),a.ground&&e.push(a.ground.load()),Promise.allSettled(e).then(()=>{})}async function G(a,e){e.extent=await ve(a.portalItem,a.initialViewProperties.viewpoint.targetGeometry),await fe(a,e)}const le=_.JSAPI,L="CollectorDisabled",g="Collector",b="Data Editing",M="OfflineDisabled",R="Offline",k="Workforce Project",x="Workforce Worker",j="Workforce Dispatcher",me="Offline Map Areas",ce="FieldMapsDisabled",v=_.DEVELOPER_BASEMAP,W="UtilityNetwork",I="IPS";async function ue(a,e){n(e,L),n(e,ce),n(e,_.METADATA),n(e,M),n(e,me),n(e,j),n(e,k),n(e,x),await G(a,e)}async function fe(a,e){l(e,le),await de(a),ye(a,e),_e(a,e),he(a,e),ge(a,e),be(a,e),Re(a,e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((o,t,r)=>r.indexOf(o)===t))}function de(a){const e=h(a).map(o=>o.load()).toArray();return Promise.allSettled(e).then(()=>{})}function h(a){return a.allLayers.concat(a.allTables)}function B(a){return h(a).some(e=>e.loaded&&A(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&(e.type!=="subtype-group"||e.sublayers.some(o=>o.editingEnabled)))}function we(a){return h(a).filter(e=>e.type!=="group").every(e=>e.loaded&&Ae(a,e))}function ye(a,e){u(e,L)||u(e,k)||u(e,x)||u(e,j)||!B(a)?n(e,g):l(e,g)}function _e(a,e){B(a)?l(e,b):n(e,b)}function he(a,e){!u(e,M)&&we(a)?l(e,R):n(e,R)}function ge(a,e){re(a.basemap)?l(e,v):n(e,v)}function be(a,e){var o;(o=a.utilityNetworks)!=null&&o.length?l(e,W):n(e,W)}function Re(a,e){a.ipsInfo?l(e,I):n(e,I)}async function ve(a,e){const o=e.clone().normalize();let t;if(o.length>1)for(const r of o)t?r.width>t.width&&(t=r):t=r;else t=o[0];return We(a,t)}async function We(a,e){const o=e.spatialReference;if(o.isWGS84)return e.clone();if(o.isWebMercator)return z(e);const{getGeometryServiceURL:t}=await U(()=>import("./geometryServiceUtils-K7u_-O-B.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]),import.meta.url),r=await t(a),i=new ae({geometries:[e],outSpatialReference:Q.WGS84});return(await oe(r,i))[0]}function Ie(a){return Y(a)||a.type==="map-notes"||a.type==="route"}function Ae(a,e){return A(e)&&e.capabilities.operations.supportsSync||Ie(e)&&!e.portalItem||(e.type==="tile"||e.type==="vector-tile")&&(e.capabilities.operations.supportsExportTiles||Pe(e)||ie(e))&&e.spatialReference.equals(a.initialViewProperties.spatialReference)}function Pe(a){return a.type==="tile"&&X(a.url)&&ne.some(e=>{var o;return(o=a.url)==null?void 0:o.toLowerCase().includes("/"+e+"/")})}async function Oe(a,e,o,t,r){await o.update({data:t}),N(a,e,o,t,r)}async function Te(a,e,o,t,r,i){const s=e.portalItem,p={item:s,authenticated:!(!(s!=null&&s.id)||!s.portal.user)},m=o.portal;await m.signIn();const{copyAllowed:d,itemReloaded:c}=await Se(p,m);if(p.authenticated||(p.authenticated=c),!d)throw new f(`${a.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const w=await Ce(o,p,t,i);return e.portalItem=o,N(a,e,o,t,r),w}async function Se(a,e){var r;const{item:o,authenticated:t}=a;return o!=null&&o.id&&((r=o.typeKeywords)!=null&&r.includes("useOnly"))?o.portal.portalHostname!==e.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(t||await o.reload(),{copyAllowed:o.itemControl==="admin"||o.itemControl==="update",itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function Ce(a,e,o,t){var d;const r=a.portal,{item:i}=e,{folder:s,copyAllResources:p}=t;let m=!1;if(p&&(i!=null&&i.id)&&K(i.portal.url,r.url)&&parseInt(i.portal.currentVersion,10)>=2023){const{total:c}=await i.fetchResources();m=!!c}if(m){const c=await i.copy({copyResources:"all",folder:s});a.id=c.id,a.portal=c.portal;const w=a.toJSON();await a.load(),a.read(w),await a.update({data:o})}else await((d=r.user)==null?void 0:d.addItem({item:a,folder:s,data:o}));return m}function N(a,e,o,t,r){F.prototype.read.call(e,{version:t.version,authoringApp:t.authoringApp,authoringAppVersion:t.authoringAppVersion},{origin:a.origin,ignoreDefaults:!0,url:o.itemUrl?H(o.itemUrl):void 0}),J(r),e.resourceInfo=t}export{C as createJSON,Wa as save,Ia as saveAs};
