import{D as v}from"./subclass-BR3PhgZG.js";import{o as B,M as F,h as $,f as z}from"./mat3-DRqs2t5W.js";import{e as L,r as W}from"./DefaultUI-DVON9ypr.js";import{E as S}from"./enums-BRzLM11V.js";import{r as M}from"./Accessor-D6mNnsWy.js";import"./TileStrategy-_ezroEyM.js";import{e as E}from"./TileKey-CIqLSCov.js";import{c as x}from"./BufferObject-CjYoWxgZ.js";import{F as w}from"./enums-BlUEVwJR.js";import{o as T}from"./VertexArrayObject-Cwnso4un.js";import{e as U,t as N}from"./config-MDUrh2eL.js";import{r as k}from"./DefaultVertexAttributeLayouts-BIPVF1RK.js";import{n as Y,l as A,r as H}from"./StyleDefinition-BK3ROBTO.js";import{w as j}from"./GeometryUtils-BSPpv37S.js";let K=class{constructor(e,o){this.sourceTile=o,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}};class Me{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function P(y,e,o,t,s,r){const i=o-s;if(i>=0)return(e>>i)+(t-(r<<i))*(y>>i);const n=-i;return e-(r-(t<<n))*(y>>n)<<n}let V=class{constructor(e,o,t){this._rows=Math.ceil(o/t),this._columns=Math.ceil(e/t),this._cellSize=t,this.cells=new Array(this._rows);for(let s=0;s<this._rows;s++){this.cells[s]=new Array(this._columns);for(let r=0;r<this._columns;r++)this.cells[s][r]=[]}}getCell(e,o){const t=Math.min(Math.max(Math.floor(o/this._cellSize),0),this._rows-1),s=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[t]&&this.cells[t][s]||null}getCellSpan(e,o,t,s){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(o/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}};function X(y,e,o,t,s,r,i){const n=e[t++];for(let l=0;l<n;l++){const a=new K(r,i);a.xTile=e[t++],a.yTile=e[t++],a.hash=e[t++],a.priority=e[t++],a.featureIndex=e[t++];const f=e[t++];for(let c=0;c<f;c++){const d=e[t++],p=e[t++],g=e[t++],m=e[t++],b=!!e[t++],_=e[t++],I=o[t++],C=o[t++],D=e[t++],O=e[t++];a.colliders.push({xTile:d,yTile:p,dxPixels:g,dyPixels:m,hard:b,partIndex:_,width:D,height:O,minLod:I,maxLod:C})}const h=y[t++];for(let c=0;c<h;c++)a.textVertexRanges.push([y[t++],y[t++]]);const u=y[t++];for(let c=0;c<u;c++)a.iconVertexRanges.push([y[t++],y[t++]]);s.push(a)}return t}function Ce(y,e,o){for(const[t,s]of y.symbols)G(y,e,o,s,t)}function G(y,e,o,t,s){const r=y.layerData.get(s);if(r.type===S.SYMBOL){for(const i of t){const n=i.unique;let l;if(i.selectedForRendering){const a=n.parts[0],f=a.startOpacity,h=a.targetOpacity;y.allSymbolsFadingOut=y.allSymbolsFadingOut&&h===0;const u=o?Math.floor(127*f)|h<<7:h?255:0;l=u<<24|u<<16|u<<8|u}else l=0;for(const[a,f]of i.iconVertexRanges)for(let h=a;h<a+f;h+=4)r.iconOpacity[h/4]=l;if(i.selectedForRendering){const a=n.parts[1],f=a.startOpacity,h=a.targetOpacity;y.allSymbolsFadingOut=y.allSymbolsFadingOut&&h===0;const u=o?Math.floor(127*f)|h<<7:h?255:0;l=u<<24|u<<16|u<<8|u}else l=0;for(const[a,f]of i.textVertexRanges)for(let h=a;h<a+f;h+=4)r.textOpacity[h/4]=l}r.lastOpacityUpdate=e,r.opacityChanged=!0}}function Q(y,e,o,t){const s=y.colliders;let r,i,n,l;for(const a of s)if(y.unique.show&&y.unique.parts[a.partIndex].show&&(r=a.xScreen-t[0]+a.dxScreen,i=a.yScreen-t[1]+a.dyScreen,n=r+a.width,l=i+a.height,j(o,e.x,e.y,r,i,n,l)))return!0;return!1}class R{constructor(e,o){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let t=1;const s=new Uint32Array(e);this.layerUIDs=[];const r=s[t++];for(let i=0;i<r;i++)this.layerUIDs[i]=s[t++];this.bufferDataOffset=t,o&&(this.layer=o.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return this._data==null}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(e){this._data!=null&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}}class Z extends R{constructor(e,o){super(e,o),this.type=S.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const t=new Uint32Array(e);let s=this.bufferDataOffset;this.lineIndexStart=t[s++],this.lineIndexCount=t[s++];const r=t[s++];if(r>0){this.patternMap=new Map;for(let i=0;i<r;i++){const n=t[s++],l=t[s++],a=t[s++];this.patternMap.set(n,[l,a])}}this.bufferDataOffset=s}get memoryUsed(){var e,o;return(((e=this.data)==null?void 0:e.byteLength)??0)+(((o=this.vao)==null?void 0:o.usedMemory)??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=M(this.vao)}doPrepareForRendering(e,o,t){const s=new Uint32Array(o),r=new Int32Array(s.buffer),i=s[t++],n=x.createVertex(e,w.STATIC_DRAW,new Int32Array(r.buffer,4*t,i));t+=i;const l=s[t++],a=x.createIndex(e,w.STATIC_DRAW,new Uint32Array(s.buffer,4*t,l));t+=l;const f=this.layer.lineMaterial;this.vao=new T(e,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:n},a)}}let ee=class extends R{constructor(e,o){super(e,o),this.type=S.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const t=new Uint32Array(e);let s=this.bufferDataOffset;this.fillIndexStart=t[s++],this.fillIndexCount=t[s++],this.outlineIndexStart=t[s++],this.outlineIndexCount=t[s++];const r=t[s++];if(r>0){this.patternMap=new Map;for(let i=0;i<r;i++){const n=t[s++],l=t[s++],a=t[s++];this.patternMap.set(n,[l,a])}}this.bufferDataOffset=s}get memoryUsed(){var e,o,t;return(((e=this.data)==null?void 0:e.byteLength)??0)+(((o=this.fillVAO)==null?void 0:o.usedMemory)??0)+(((t=this.outlineVAO)==null?void 0:t.usedMemory)??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=M(this.fillVAO),this.outlineVAO=M(this.outlineVAO)}doPrepareForRendering(e,o,t){const s=new Uint32Array(o),r=new Int32Array(s.buffer),i=s[t++],n=x.createVertex(e,w.STATIC_DRAW,new Int32Array(r.buffer,4*t,i));t+=i;const l=s[t++],a=x.createIndex(e,w.STATIC_DRAW,new Uint32Array(s.buffer,4*t,l));t+=l;const f=s[t++],h=x.createVertex(e,w.STATIC_DRAW,new Int32Array(r.buffer,4*t,f));t+=f;const u=s[t++],c=x.createIndex(e,w.STATIC_DRAW,new Uint32Array(s.buffer,4*t,u));t+=u;const d=this.layer,p=d.fillMaterial,g=d.outlineMaterial;this.fillVAO=new T(e,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:n},a),this.outlineVAO=new T(e,g.getAttributeLocations(),g.getLayoutInfo(),{geometry:h},c)}};class te extends R{constructor(e,o,t){super(e,o),this.type=S.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const s=new Uint32Array(e),r=new Int32Array(e),i=new Float32Array(e);let n=this.bufferDataOffset;this.isIconSDF=!!s[n++];const l=s[n++],a=s[n++],f=s[n++],h=new E(l,a,f,0),u=s[n++];for(let g=0;g<u;g++){const m=s[n++],b=s[n++],_=s[n++];this.iconPerPageElementsMap.set(m,[b,_])}const c=s[n++];for(let g=0;g<c;g++){const m=s[n++],b=s[n++],_=s[n++];this.glyphPerPageElementsMap.set(m,[b,_])}const d=s[n++],p=s[n++];this.iconOpacity=new Int32Array(d),this.textOpacity=new Int32Array(p),n=X(s,r,i,n,this.symbols,t,h),this.bufferDataOffset=n}get memoryUsed(){var e,o,t;return(((e=this.data)==null?void 0:e.byteLength)??0)+(((o=this.iconVAO)==null?void 0:o.usedMemory)??0)+(((t=this.textVAO)==null?void 0:t.usedMemory)??0)+v(this.iconOpacity)+v(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const[o,t]of this.iconPerPageElementsMap)e+=t[1];for(const[o,t]of this.glyphPerPageElementsMap)e+=t[1];return e/3}doDestroy(){this.iconVAO=M(this.iconVAO),this.textVAO=M(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,o=this.iconVAO.vertexBuffers.opacity;e.length>0&&e.byteLength===o.usedMemory&&o.setSubData(e,0,0,e.length);const t=this.textOpacity,s=this.textVAO.vertexBuffers.opacity;t.length>0&&t.byteLength===s.usedMemory&&s.setSubData(t,0,0,t.length)}doPrepareForRendering(e,o,t){const s=new Uint32Array(o),r=new Int32Array(s.buffer),i=s[t++],n=x.createVertex(e,w.STATIC_DRAW,new Int32Array(r.buffer,4*t,i));t+=i;const l=s[t++],a=x.createIndex(e,w.STATIC_DRAW,new Uint32Array(s.buffer,4*t,l));t+=l;const f=s[t++],h=x.createVertex(e,w.STATIC_DRAW,new Int32Array(r.buffer,4*t,f));t+=f;const u=s[t++],c=x.createIndex(e,w.STATIC_DRAW,new Uint32Array(s.buffer,4*t,u));t+=u;const d=x.createVertex(e,w.STATIC_DRAW,this.iconOpacity.buffer),p=x.createVertex(e,w.STATIC_DRAW,this.textOpacity.buffer),g=this.layer,m=g.iconMaterial,b=g.textMaterial;this.iconVAO=new T(e,m.getAttributeLocations(),m.getLayoutInfo(),{geometry:n,opacity:d},a),this.textVAO=new T(e,b.getAttributeLocations(),b.getLayoutInfo(),{geometry:h,opacity:p},c)}}let se=class extends R{constructor(e,o){super(e,o),this.type=S.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const t=new Uint32Array(e);let s=this.bufferDataOffset;this.circleIndexStart=t[s++],this.circleIndexCount=t[s++],this.bufferDataOffset=s}get memoryUsed(){var e,o;return(((e=this.data)==null?void 0:e.byteLength)??0)+(((o=this.vao)==null?void 0:o.usedMemory)??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=M(this.vao)}doPrepareForRendering(e,o,t){const s=new Uint32Array(o),r=new Int32Array(s.buffer),i=s[t++],n=x.createVertex(e,w.STATIC_DRAW,new Int32Array(r.buffer,4*t,i));t+=i;const l=s[t++],a=x.createIndex(e,w.STATIC_DRAW,new Uint32Array(s.buffer,4*t,l));t+=l;const f=this.layer.circleMaterial;this.vao=new T(e,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:n},a)}};class q extends k{constructor(e,o,t,s,r,i,n,l=null){super(e,o,t,s,r,i,4096,4096),this.styleRepository=n,this._memCache=l,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this._referenced=1,this.id=e.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<U}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<U)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){var t,s;let o=!1;for(const r of e){const i=this.layerData.get(r);i&&(this._memoryUsedByLayerData-=i.memoryUsed,i.type===S.SYMBOL&&this.symbols.delete(r)&&(o=!0),i.destroy(),this.layerData.delete(r))}(t=this._memCache)==null||t.updateSize(this.key.id,this,this._memoryUsedByLayerData),o&&((s=this.featureIndex)==null||s.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}dispose(){this.status!=="unloaded"&&(this.featureIndex=null,J.delete(this),q._destroyRenderBuckets(this.layerData),this.layerData.clear(),this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return--this._referenced==0&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get usedMemory(){return this._memoryUsedByLayerData+256}changeDataImpl(e){var t,s;(t=this.featureIndex)==null||t.clear();let o=!1;if(e){const{bucketsWithData:r,emptyBuckets:i}=e,n=this._createRenderBuckets(r);if(i&&i.byteLength>0){const l=new Uint32Array(i);for(const a of l)this._deleteLayerData(a)}for(const[l,a]of n)this._deleteLayerData(l),a.type===S.SYMBOL&&(this.symbols.set(l,a.symbols),o=!0),this._memoryUsedByLayerData+=a.memoryUsed,this.layerData.set(l,a);(s=this._memCache)==null||s.updateSize(this.key.id,this,this.usedMemory)}this._hasSymbolBuckets=!1;for(const[r,i]of this.layerData)i.type===S.SYMBOL&&(this._hasSymbolBuckets=!0);o&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(o){o.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const o=this.resolution/(e.resolution*e.pixelRatio),t=this.width/this.rangeX*o,s=this.height/this.rangeY*o,r=[0,0];e.toScreen(r,[this.x,this.y]);const i=this.transforms.tileUnitsToPixels;B(i),F(i,i,r),$(i,i,Math.PI*e.rotation/180),z(i,i,[t,s,1])}_createTransforms(){return{displayViewScreenMat3:L(),tileMat3:L(),tileUnitsToPixels:L()}}static _destroyRenderBuckets(e){if(!e)return;const o=new Set;for(const t of e.values())o.has(t)||(t.destroy(),o.add(t));e.clear()}_createRenderBuckets(e){const o=new Map,t=new Map;for(const s of e){const r=this._deserializeBucket(s,t);for(const i of r.layerUIDs)o.set(i,r)}return o}_deserializeBucket(e,o){let t=o.get(e);if(t)return t;switch(new Uint32Array(e)[0]){case S.FILL:t=new ee(e,this.styleRepository);break;case S.LINE:t=new Z(e,this.styleRepository);break;case S.SYMBOL:t=new te(e,this.styleRepository,this);break;case S.CIRCLE:t=new se(e,this.styleRepository)}return o.set(e,t),t}_deleteLayerData(e){if(!this.layerData.has(e))return;const o=this.layerData.get(e);this._memoryUsedByLayerData-=o.memoryUsed,o.destroy(),this.layerData.delete(e)}}const J=new Map;function Le(){J.forEach((y,e)=>{console.log(`
${e.key}:`),y[0].forEach(o=>console.log(o)),console.log("========"),y[1].forEach(o=>console.log(o))})}function oe(y,e,o,t,s,r){const{iconRotationAlignment:i,textRotationAlignment:n,iconTranslate:l,iconTranslateAnchor:a,textTranslate:f,textTranslateAnchor:h}=t;let u=0;for(const c of y.colliders){const[d,p]=c.partIndex===0?l:f,g=c.partIndex===0?a:h,m=c.minLod<=r&&r<=c.maxLod;u+=m?0:1,c.enabled=m,c.xScreen=c.xTile*s[0]+c.yTile*s[3]+s[6],c.yScreen=c.xTile*s[1]+c.yTile*s[4]+s[7],g===H.MAP?(c.xScreen+=o*d-e*p,c.yScreen+=e*d+o*p):(c.xScreen+=d,c.yScreen+=p),A.VIEWPORT===(c.partIndex===0?i:n)?(c.dxScreen=c.dxPixels,c.dyScreen=c.dyPixels):(c.dxScreen=o*(c.dxPixels+c.width/2)-e*(c.dyPixels+c.height/2)-c.width/2,c.dyScreen=e*(c.dxPixels+c.width/2)+o*(c.dyPixels+c.height/2)-c.height/2)}y.colliders.length>0&&u===y.colliders.length&&(y.unique.show=!1)}class Re{constructor(e,o,t,s,r,i){this._symbols=e,this._styleRepository=s,this._zoom=r,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new V(o,t,N),this._si=Math.sin(Math.PI*i/180),this._co=Math.cos(Math.PI*i/180);for(const n of e)for(const l of n.symbols)this._allNeededMatrices.has(l.tile)||this._allNeededMatrices.set(l.tile,W(l.tile.transforms.tileUnitsToPixels))}work(e){const o=this._gridIndex;function t(r){const i=r.xScreen+r.dxScreen,n=r.yScreen+r.dyScreen,l=i+r.width,a=n+r.height,[f,h,u,c]=o.getCellSpan(i,n,l,a);for(let d=h;d<=c;d++)for(let p=f;p<=u;p++){const g=o.cells[d][p];for(const m of g){const b=m.xScreen+m.dxScreen,_=m.yScreen+m.dyScreen,I=b+m.width,C=_+m.height;if(!(l<b||i>I||a<_||n>C))return!0}}return!1}const s=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const r=this._symbols[this._currentLayerCursor],i=this._getProperties(r.styleLayerUID);for(;this._currentSymbolCursor<r.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-s>e)return!1;const n=r.symbols[this._currentSymbolCursor];if(!n.unique.show)continue;oe(n,this._si,this._co,i,this._allNeededMatrices.get(n.tile),this._zoom);const l=n.unique;if(!l.show)continue;const{iconAllowOverlap:a,iconIgnorePlacement:f,textAllowOverlap:h,textIgnorePlacement:u}=i;for(const c of n.colliders){if(!c.enabled)continue;const d=l.parts[c.partIndex];d.show&&!(c.partIndex?h:a)&&t(c)&&(c.hard?l.show=!1:d.show=!1)}if(l.show)for(const c of n.colliders){if(!c.enabled||(c.partIndex?u:f)||!l.parts[c.partIndex].show)continue;const d=c.xScreen+c.dxScreen,p=c.yScreen+c.dyScreen,g=d+c.width,m=p+c.height,[b,_,I,C]=this._gridIndex.getCellSpan(d,p,g,m);for(let D=_;D<=C;D++)for(let O=b;O<=I;O++)this._gridIndex.cells[D][O].push(c)}}}return!0}_getProperties(e){const o=this._styleProps.get(e);if(o)return o;const t=this._zoom,s=this._styleRepository.getStyleLayerByUID(e),r=s.getLayoutValue("symbol-placement",t)!==Y.POINT;let i=s.getLayoutValue("icon-rotation-alignment",t);i===A.AUTO&&(i=r?A.MAP:A.VIEWPORT);let n=s.getLayoutValue("text-rotation-alignment",t);n===A.AUTO&&(n=r?A.MAP:A.VIEWPORT);const l=s.getPaintValue("icon-translate",t),a=s.getPaintValue("icon-translate-anchor",t),f=s.getPaintValue("text-translate",t),h=s.getPaintValue("text-translate-anchor",t),u={iconAllowOverlap:s.getLayoutValue("icon-allow-overlap",t),iconIgnorePlacement:s.getLayoutValue("icon-ignore-placement",t),textAllowOverlap:s.getLayoutValue("text-allow-overlap",t),textIgnorePlacement:s.getLayoutValue("text-ignore-placement",t),iconRotationAlignment:i,textRotationAlignment:n,iconTranslateAnchor:a,iconTranslate:l,textTranslateAnchor:h,textTranslate:f};return this._styleProps.set(e,u),u}}function re(y,e){if(y.priority-e.priority)return y.priority-e.priority;const o=y.tile.key,t=e.tile.key;return o.world-t.world?o.world-t.world:o.level-t.level?o.level-t.level:o.row-t.row?o.row-t.row:o.col-t.col?o.col-t.col:y.xTile-e.xTile?y.xTile-e.xTile:y.yTile-e.yTile}class Ue{get running(){return this._running}constructor(e,o,t,s,r,i){this._visibleTiles=e,this._symbolRepository=o,this._createCollisionJob=t,this._assignTileSymbolsOpacity=s,this._symbolLayerSorter=r,this._isLayerVisible=i,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,o){this._screenWidth===e&&this._screenHeight===o||this.restart(),this._screenWidth=e,this._screenHeight=o}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const o=performance.now();if(!this._selectionJob.work(e)||(this._selectionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-o)))===0))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const o=performance.now();if(!this._collisionJob.work(e)||(this._collisionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-o)))===0))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const o=performance.now();if(!this._opacityJob.work(e)||(this._opacityJobCompleted=!0,(e=Math.max(0,e-(performance.now()-o)))===0))return!1}return this._running=!1,!0}_createSelectionJob(){const e=this._symbolRepository.uniqueSymbols;for(let l=0;l<e.length;l++){const a=e[l];for(let f=0;f<a.uniqueSymbols.length;f++){const h=a.uniqueSymbols[f];for(const u of h.tileSymbols)u.selectedForRendering=!1}}const o=[];let t=0,s=0;const r=this._isLayerVisible;function i(l){let a;const f=performance.now();for(;s<e.length;s++,t=0){const h=e[s],u=h.styleLayerUID;if(!r(u)){o[s]||(o[s]={styleLayerUID:u,symbols:[]});continue}o[s]=o[s]||{styleLayerUID:u,symbols:[]};const c=o[s];for(;t<h.uniqueSymbols.length;t++){if(a=h.uniqueSymbols[t],t%100==99&&performance.now()-f>l)return!1;let d=null,p=!1,g=!1;for(const m of a.tileSymbols)if(!g||!p){const b=m.tile;(!d||b.isCoverage||b.neededForCoverage&&!p)&&(d=m,(b.neededForCoverage||b.isCoverage)&&(g=!0),b.isCoverage&&(p=!0))}if(d.selectedForRendering=!0,g){c.symbols.push(d),a.show=!0;for(const m of a.parts)m.show=!0}else a.show=!1}}for(const h of o)h.symbols.sort(re);return!0}const n=this._symbolLayerSorter;return{work:i,get sortedSymbols(){return o.sort(n)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,o=this._visibleTiles;let t=0;function s(r,i){const n=r.symbols;for(const[l,a]of n)ie(a,i);e(r,i);for(const l of r.childrenTiles)s(l,i)}return{work(r){const i=performance.now();for(;t<o.length;t++){if(performance.now()-i>r)return!1;const n=o[t];n.parentTile==null&&s(n,performance.now())}return!0}}}}function ie(y,e){for(const o of y){const t=o.unique;for(const s of t.parts){const r=s.targetOpacity>.5?1:-1;s.startOpacity+=r*((e-s.startTime)/U),s.startOpacity=Math.min(Math.max(s.startOpacity,0),1),s.startTime=e,s.targetOpacity=t.show&&s.show?1:0}}}const ne=32,le=8,ae=64,ce=20;class ve{constructor(e,o,t){this.tileCoordRange=e,this._visibleTiles=o,this._createUnique=t,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return this._uniqueSymbolLayerArray==null&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}get uniqueSymbolsReferences(){return this._uniqueSymbolsReferences}add(e,o){this._uniqueSymbolLayerArray=null;let t=this._tiles.get(e.id);t||(t={symbols:new Map},this._tiles.set(e.id,t));const s=new Map;if(o)for(const n of o)t.symbols.has(n)&&(s.set(n,t.symbols.get(n)),t.symbols.delete(n));else for(const[n,l]of e.layerData)t.symbols.has(n)&&(s.set(n,t.symbols.get(n)),t.symbols.delete(n));this._removeSymbols(s);const r=e.symbols,i=new Map;for(const[n,l]of r){let a=l.length;if(a>=ne){let f=this.tileCoordRange;do f/=2,a/=4;while(a>le&&f>ae);const h=new V(this.tileCoordRange,this.tileCoordRange,f);i.set(n,{flat:l,index:h}),t.symbols.set(n,{flat:l,index:h});for(const u of l)h.getCell(u.xTile,u.yTile).push(u)}else i.set(n,{flat:l}),t.symbols.set(n,{flat:l})}this._addSymbols(e.key,r)}deleteStyleLayers(e){this._uniqueSymbolLayerArray=null;for(const[o,t]of this._tiles){const s=new Map;for(const r of e)t.symbols.has(r)&&(s.set(r,t.symbols.get(r)),t.symbols.delete(r));this._removeSymbols(s),t.symbols.size===0&&this._tiles.delete(o)}}removeTile(e){this._uniqueSymbolLayerArray=null;const o=this._tiles.get(e.id);if(!o)return;const t=new Map;for(const[s,r]of e.symbols)o.symbols.has(s)&&(t.set(s,o.symbols.get(s)),o.symbols.delete(s));this._removeSymbols(t),o.symbols.size===0&&this._tiles.delete(e.id)}querySymbols(e,o,t,s){const r=[],i=this.uniqueSymbols;for(const n of i){const l=n.styleLayerUID,a=n.uniqueSymbols;for(const f of a){const h=f.tileSymbols.find(u=>u.selectedForRendering);h&&Q(h,e,o*(window.devicePixelRatio||1),t)&&r.push({vtlSymbol:h,styleLayerUID:l,tileKey:h.tile.key})}}return r}_removeSymbols(e){for(const[o,{flat:t}]of e)for(const s of t){const r=s.unique,i=r.tileSymbols,n=i.length-1;for(let l=0;l<n;l++)if(i[l]===s){i[l]=i[n];break}if(i.length=n,n===0){const l=this._uniqueSymbolsReferences.get(o);l.delete(r),l.size===0&&this._uniqueSymbolsReferences.delete(o)}s.unique=null}}_addSymbols(e,o){if(o.size===0)return;const t=this._visibleTiles;for(const s of t)s.parentTile||s.key.world!==e.world||s.key.level===e.level&&!s.key.equals(e)||this._matchSymbols(s,e,o);for(const[s,r]of o)for(const i of r)if(i.unique==null){const n=this._createUnique();i.unique=n,n.tileSymbols.push(i);let l=this._uniqueSymbolsReferences.get(s);l||(l=new Set,this._uniqueSymbolsReferences.set(s,l)),l.add(n)}}_matchSymbols(e,o,t){if(e.key.level>o.level){const r=e.key.level-o.level;if(e.key.row>>r!==o.row||e.key.col>>r!==o.col)return}if(o.level>e.key.level){const r=o.level-e.key.level;if(o.row>>r!==e.key.row||o.col>>r!==e.key.col)return}if(o.equals(e.key)){for(const r of e.childrenTiles)this._matchSymbols(r,o,t);return}const s=new Map;for(const[r,i]of t){const n=[];for(const h of i){const u=P(this.tileCoordRange,h.xTile,o.level,o.col,e.key.level,e.key.col),c=P(this.tileCoordRange,h.yTile,o.level,o.row,e.key.level,e.key.row);u>=0&&u<this.tileCoordRange&&c>=0&&c<this.tileCoordRange&&n.push({symbol:h,xTransformed:u,yTransformed:c})}const l=[],a=(e.key.level<o.level?1:1<<e.key.level-o.level)+ce,f=this._tiles.get(e.id).symbols.get(r);if(f){const h=f.flat;for(const u of n){let c,d=!1;const p=u.xTransformed,g=u.yTransformed;c=f.index!=null?f.index.getCell(p,g):h;const m=u.symbol,b=m.hash;for(const _ of c)if(b===_.hash&&Math.abs(p-_.xTile)<=a&&Math.abs(g-_.yTile)<=a){const I=_.unique;m.unique=I,I.tileSymbols.push(m),d=!0;break}d||l.push(m)}}l.length>0&&s.set(r,l)}for(const r of e.childrenTiles)this._matchSymbols(r,o,s)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsReferences,o=new Array(e.size);let t,s=0;for(const[r,i]of e){const n=new Array(i.size);t=0;for(const l of i)n[t++]=l;o[s]={styleLayerUID:r,uniqueSymbols:n},s++}return o}}class Pe extends k{_createTransforms(){return{displayViewScreenMat3:L(),tileMat3:L()}}}export{Ce as a,q as d,Ue as e,Re as l,ve as r,Me as s,Pe as t,Le as u};
