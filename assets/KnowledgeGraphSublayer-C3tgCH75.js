import{e as l}from"./Evented-CXIxDjmW.js";import{o as U}from"./geometry-DpwwkAX1.js";import{k as _e}from"./PopupTemplate-ByHks6sq.js";import"./ClassBreaksRenderer-DMO3d0Rn.js";import{t as ae,m as ke}from"./jsonUtils-CuoSmH2q.js";import"./UniqueValueRenderer-dci9bLM8.js";import"./SimpleRenderer-DvJZ7cyq.js";import{c as G,r as F,y,b as ce,n as pe,a as C}from"./subclass-BR3PhgZG.js";import{S as ve}from"./MultiOriginJSONSupport-DjAXzJun.js";import{E as Ce}from"./workers-8Q6jrI18.js";import{r as je}from"./writer-3zufXUNV.js";import{S as Oe,e as xe}from"./Accessor-D6mNnsWy.js";import{N as De,K as ye}from"./projection-A9yUaaTs.js";import{a5 as ie,f as qe}from"./Point-DB4Hp4hH.js";import{f as Ae}from"./Layer-C96_yo4i.js";import{m as Fe}from"./FeatureStore-BudYmSEo.js";import{$ as Ge}from"./QueryEngine-CDSTFuau.js";import{l as Qe,o as le}from"./clientSideDefaults-DDr2PCsV.js";import{e as me,N as Je}from"./fieldUtils-CNduWQU9.js";import{j as Me,m as Pe}from"./Polyline-D97hl-6E.js";import{o as Ue}from"./featureConversionUtils-DdoZh_25.js";import{e as he}from"./OptimizedFeature-7juV2tZm.js";import{y as Be}from"./jsonUtils-Cma_7A64.js";import{U as Ye}from"./assets-C2mb-ea2.js";import"./aaBoundingBox-rJEWaOSN.js";import"./mathUtils-ClvKsMak.js";import{w as ue}from"./Extent-DHjqVB-p.js";import{T as ee,r as Se}from"./knowledgeGraphService-wZbdTEQH.js";import{s as B}from"./Relationship-CTef30N3.js";import{b as Y}from"./Query-Cx4awVKu.js";import{s as Ve}from"./fieldProperties-DJEV41A1.js";import{l as He,s as We,a as Ke}from"./BlendLayer-DmvCcS5c.js";import{c as ze,p as Ze}from"./FeatureEffectLayer-B3ucpbgh.js";import{c as Xe,p as et}from"./FeatureReductionLayer-7Q3CJbxJ.js";import{p as tt,c as it}from"./OrderedLayer-CfmzojSk.js";import{f as nt}from"./RefreshableLayer-B26jSd3d.js";import{t as rt}from"./ScaleRangeLayer-CKYXLXxK.js";import{l as ot,f as st}from"./TemporalLayer-D6vkocFU.js";import{l as at,y as pt,j as lt,u as dt,w as yt,s as ut}from"./commonProperties-C-F8Nu9F.js";import{y as de}from"./Field-C8SaaeoI.js";import{C as ct,l as mt}from"./labelingInfo-C8CHVUWS.js";import{d as ht}from"./FeatureSet-DyOnd9Rj.js";import{p as ft}from"./popupUtils-fsHWupnf.js";const gt="ESRI__DESTINATION_ID",Tt="ESRI__ORIGIN_ID";class q{constructor(){this._featureLookup=new Map}static getInstance(){return q.instance||(q.instance=new q),q.instance}static resetInstance(){q.instance&&(q.instance=null)}deleteFromStore(t){t.forEach(n=>{this._featureLookup.delete(n)})}readFromStoreByList(t){const n=[];return t.forEach(i=>{const s=this.readFromStoreById(i);s&&n.push(s)}),n}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,n,i){const s=[];return t.forEach(r=>{if(!(r!=null&&r.id))return;r.properties||(r.properties=[]);let o,a=null;if(i&&r.properties[i]&&(a=Ue(r.properties[i])),"originId"in r&&"destinationId"in r&&(r.properties[Tt]=r.originId,r.properties[gt]=r.destinationId),r.properties[n]=r.id,r.id&&this._featureLookup.has(r.id)&&this._featureLookup.get(r.id).attributes){const p=this._featureLookup.get(r.id),m=JSON.parse(JSON.stringify(Object.assign(p.attributes,r.properties)));i&&r.properties[i]&&(m[i]=Be(r.properties[i])),o=new he(a?JSON.parse(JSON.stringify(a)):p!=null&&p.geometry?JSON.parse(JSON.stringify(p.geometry)):null,m,null,r.properties[n])}else o=new he(a?JSON.parse(JSON.stringify(a)):null,r.properties,null,r.properties[n]);this._featureLookup.set(r.id,o),s.push(o)}),s}}var re;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(re||(re={}));re.ELEMENTUID,re.TYPENAME;var fe,ge;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(fe||(fe={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(ge||(ge={}));var Te,we,be,oe;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(Te||(Te={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(we||(we={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(be||(be={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(oe||(oe={}));function wt(e){if(!e.spatialReference.isWGS84)throw new G("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");return e.clone().normalize().map(t=>[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]])}async function hi(e,t){var r,o;const n=[],i=new Map,s=[];if((r=t.dataModel)!=null&&r.relationshipTypes)for(const a of t.dataModel.relationshipTypes)a.name&&i.set(a.name,[]);for(const a of e)i.has(a.typeName)&&((o=i.get(a.typeName))==null||o.push(a.id));for(const[a,p]of i){if(p.length<1)continue;const m=new B({openCypherQuery:`MATCH (n)-[r:${a}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:p}});s.push(ee(t,m).then(async w=>{const g=w.resultRowsStream.getReader();for(;;){const{done:b,value:S}=await g.read();if(b)break;for(const R of S)n.push({id:R[0],typeName:R[1]}),n.push({id:R[2],typeName:R[3]})}}))}return await Promise.all(s),n}async function fi(e,t){t??(t=!1);const n={generateAllSublayers:t,namedTypeDefinitions:new Map};return await It(e).then(i=>{Nt(i,n)}),n}async function gi(e){const t=await Se(),n=new t.MapOfObjectIdentifierSets;bt(n,t,e);const i=new t.MapOfObjectIdentifierSetsEncoder;try{i.set_map_of_identifier_sets(n),i.encode();const s=i.get_encoding_result();if(s.error.error_code!==0)throw new G("knowledge-graph:layer-support-utils",s.error.error_message);const r=structuredClone(s.get_byte_buffer());return i.delete(),r}finally{n.delete()}}function bt(e,t,n){for(const[i,s]of n.namedTypeDefinitions){if(!s.members||s.useAllData)continue;const r=s.members.keys(),o=new t.GlobalIdArray,a=new t.ObjectIdentifierSet;for(const p of r)o.add_globalid(p);a.set_globalid_array(o),o.delete(),e.put_identifier_set(i,a),a.delete()}return e}async function It(e){const t=await Ye(e,{responseType:"array-buffer"}),n=await t.data;return Et(new Uint8Array(n))}async function Et(e){const t=new(await Se()).MapOfObjectIdentifierSetsDecoder,n=t.decode(new Uint8Array(e)),i=new Map;if(n.error_code!==0)throw new G("knowledge-graph:layer-support-utils",n.error_message);const s=t.get_map_of_identifier_sets(),r=s.keys,o=r.size();for(let a=0;a<o;a++){const p=r.get(a),m=s.query_identifier_set(p),w=[];if(m.id_array_type.value===oe.GLOBALID_ARRAY){const g=m.get_globalid_array(),b=g.count();for(let S=0;S<b;S++)w.push(g.get_globalid_at(S))}else{if(m.id_array_type.value!==oe.IDENTIFIER_ARRAY)throw new G("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const g=m.get_identifier_array(),b=g.count();for(let S=0;S<b;S++)w.push(g.get_identifier_at(S).toString())}}i.set(p,w)}return t.delete(),i}function Nt(e,t){for(const[n,i]of e){const s=F(t.namedTypeDefinitions,n,()=>({useAllData:!1,members:new Map}));for(const r of i)s.members.has(r)||s.members.set(r,{id:r})}return t}const x="ESRI__ID",Ti="ESRI__ORIGIN_ID",wi="ESRI__DESTINATION_ID",Le="ESRI__LAYOUT_GEOMETRY",Ie="ESRI__AGGREGATION_COUNT";let O=class extends Oe{constructor(e){var n,i,s;super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;(n=e.knowledgeGraph.dataModel.entityTypes)==null||n.forEach(r=>{var o,a;r.name&&(t.set(r.name,"entity"),this._processingCacheUpdatesLookup.set(r.name,[]),e.inclusionModeDefinition&&!((o=e.inclusionModeDefinition)!=null&&o.generateAllSublayers)||this.entityTypeNames.add(r.name),(a=r.properties)==null||a.forEach(p=>{p.geometryType&&p.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(r.name,{name:p.name??"",geometryType:p.geometryType})}))}),(i=e.knowledgeGraph.dataModel.relationshipTypes)==null||i.forEach(r=>{var o,a;r.name&&(t.set(r.name,"relationship"),this._processingCacheUpdatesLookup.set(r.name,[]),e.inclusionModeDefinition&&!((o=e.inclusionModeDefinition)!=null&&o.generateAllSublayers)||this.relationshipTypeNames.add(r.name),(a=r.properties)==null||a.forEach(p=>{p.geometryType&&p.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(r.name,{name:p.name??"",geometryType:p.geometryType})}))}),(s=e.inclusionModeDefinition)==null||s.namedTypeDefinitions.forEach((r,o)=>{var p,m;if(t.get(o)==="entity")this.entityTypeNames.add(o);else{if(t.get(o)!=="relationship")return pe.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't in the data model and will be removed`),void((p=e.inclusionModeDefinition)==null?void 0:p.namedTypeDefinitions.delete(o));this.relationshipTypeNames.add(o)}const a=new Map;(m=r.members)==null||m.forEach(w=>{F(this.memberIdTypeLookup,w.id,()=>new Set).add(o);const g=this.getById(w.id);g&&a.set(w.id,g)}),this.sublayerCaches.set(o,a)})}addToLayer(e){e.forEach(({typeName:t,id:n})=>{if(!this.inclusionModeDefinition)throw new G("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){const i=this.inclusionModeDefinition.namedTypeDefinitions.get(t);i.members||(i.members=new Map),i.members.set(n,{id:n}),F(this.memberIdTypeLookup,n,()=>new Set).add(t)}}else{const i=new Map;i.set(n,{id:n}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:i}),F(this.memberIdTypeLookup,n,()=>new Set).add(t)}})}getById(e){return q.getInstance().readFromStoreById(e)}async getData(e,t,n){var s,r;if(t.objectType.name&&((s=this.inclusionModeDefinition)!=null&&s.namedTypeDefinitions)&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let i;if(i=e||new Y({where:"1=1",outFields:["*"]}),t.parentCompositeLayer.type==="link-chart"){const o=t.parentCompositeLayer,a=this._processingCacheUpdatesLookup.get(t.objectType.name??""),p=i.outFields;p&&p.length===1&&p[0]===x&&i.where==="1=1"||await Promise.all(a??[]);const m=this.sublayerCaches.has(t.objectType.name??"")?Array.from((r=this.sublayerCaches.get(t.objectType.name))==null?void 0:r.values()):[],w=[];return m.forEach(g=>{this.relationshipTypeNames.has(t.objectType.name)?g.geometry=o.relationshipLinkChartDiagramLookup.get(g.attributes[t.objectIdField]):g.geometry=o.entityLinkChartDiagramLookup.get(g.attributes[t.objectIdField]),g.attributes[Le]=g.geometry,w.push(g)}),w}return this.retrieveDataFromService(i,t,n)}async getConnectedRecordIds(e,t){const n=[];let i="";const s=[],r=new Map;if(e.forEach(o=>{var a;if(this.memberIdTypeLookup.has(o))for(const p of this.memberIdTypeLookup.get(o)){if(!this.entityTypeNames.has(p))return;r.has(p)?(a=r.get(p))==null||a.push(o):r.set(p,[o])}}),t&&(t==null?void 0:t.length)!==0){for(const o of t)i=i+o+"|";i=i.slice(0,-1)}return r.forEach((o,a)=>{let p;p=t&&(t==null?void 0:t.length)!==0?`MATCH (n:${a})-[r:${i}]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${a})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`;const m=new Promise(w=>{(async()=>{const g=(await ee(this.knowledgeGraph,new B({openCypherQuery:p,bindParameters:{ids:o}}))).resultRowsStream.getReader();try{for(;;){const{done:b,value:S}=await g.read();if(b)break;for(let R=0;R<S.length;R++){const d=S[R];n.push({id:d[0],typeName:d[1]}),n.push({id:d[2],typeName:d[3]})}}}catch(b){if(b.name!=="AbortError")throw b;pe.getLogger(this).info("Request aborted as expected")}})().then(()=>{w()})});s.push(m)}),this.refreshCacheContent(),await Promise.all(s),n}async getAttachedRelationships(e,t){const n=[],i="MATCH (n)-[r]->(m) WHERE id(n) IN $nodeIds AND id(m) in $nodeIds AND NOT id(r) IN $relationshipExclusionIds return id(r), type(r)",s=(await ee(this.knowledgeGraph,new B({openCypherQuery:i,bindParameters:{nodeIds:e,relationshipExclusionIds:t}}))).resultRowsStream.getReader();try{for(;;){const{done:r,value:o}=await s.read();if(r)break;for(let a=0;a<o.length;a++){const p=o[a];n.push({id:p[0],typeName:p[1]})}}}catch(r){if(r.name!=="AbortError")throw r;pe.getLogger(this).info("Request aborted as expected")}return n}async refreshCacheContent(e,t,n,i=!0){var p,m,w,g,b,S,R;const s=q.getInstance(),r=[],o=new Map,a=new Map;(p=this.knowledgeGraph.dataModel.entityTypes)==null||p.forEach(d=>{d.name&&a.set(d.name,d)}),(m=this.knowledgeGraph.dataModel.relationshipTypes)==null||m.forEach(d=>{d.name&&a.set(d.name,d)}),e||this.inclusionModeDefinition?e?e.forEach(d=>{var L;if(this.memberIdTypeLookup.has(d))for(const k of this.memberIdTypeLookup.get(d))o.has(k)?(L=o.get(k))==null||L.push(d):o.set(k,[d])}):(g=(w=this.inclusionModeDefinition)==null?void 0:w.namedTypeDefinitions)==null||g.forEach((d,L)=>{d.useAllData?o.set(L,null):d.members&&d.members.forEach(k=>{var Q;o.has(L)&&o.get(L)!==null?(Q=o.get(L))==null||Q.push(k.id):o.set(L,[k.id])})}):((b=this.knowledgeGraph.dataModel.entityTypes)==null||b.forEach(d=>{d.name&&o.set(d.name,null)}),(S=this.knowledgeGraph.dataModel.entityTypes)==null||S.forEach(d=>{d.name&&o.set(d.name,null)}));for(const[d,L]of o){const k=new Promise(Q=>{(async()=>{var W,K,z,Z,X,I,h;const J=new Set,P=[];let V,A="",H=!1;if(t||((K=(W=a.get(d))==null?void 0:W.properties)==null||K.forEach(T=>{T.name&&J.add(T.name)})),n&&this.geographicLookup.has(d)){const T=(z=this.geographicLookup.get(d))==null?void 0:z.name;T&&J.add(T)}if(this.entityTypeNames.has(d))A=`MATCH (n:${d}) ${L?"WHERE id(n) IN $ids ":""}return ID(n)`,J.forEach(T=>{A+=`, n.${T}`,P.push(T)});else{if(!this.relationshipTypeNames.has(d))throw new G("knowledge-graph:layer-data-manager",`The graph type of ${d} could not be determined. Was this type set in the KG data model and inclusion definition?`);H=!0,A=`MATCH ()-[n:${d}]->() ${L?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,J.forEach(T=>{A+=`, n.${T}`,P.push(T)})}V=new B(L?{openCypherQuery:A,bindParameters:{ids:L}}:{openCypherQuery:A});const ne=(await ee(this.knowledgeGraph,V)).resultRowsStream.getReader();for(;;){const{done:T,value:$}=await ne.read();if(T)break;const M=[];for(let f=0;f<$.length;f++){const c=$[f];let D=0,_=0;const v={properties:{}};for(v.id=c[D],D++,_++,H&&(v.originId=c[D],D++,_++,v.destinationId=c[D],D++,_++,F(this.nodeConnectionsLookup,v.originId,()=>new Set).add(v.id),F(this.nodeConnectionsLookup,v.destinationId,()=>new Set).add(v.id),F(this.relationshipConnectionsLookup,v.id,()=>[v.originId,v.destinationId]));D<c.length;D++)v.properties[P[D-_]]=c[D];M.push(v)}const E=s.writeToStore(M,x,(Z=this.geographicLookup.get(d))==null?void 0:Z.name);this.sublayerCaches.has(d)||this.sublayerCaches.set(d,new Map),i&&!((X=this.inclusionModeDefinition)!=null&&X.namedTypeDefinitions.has(d))&&((I=this.inclusionModeDefinition)==null||I.namedTypeDefinitions.set(d,{useAllData:!1,members:new Map})),i&&!((h=this.inclusionModeDefinition)!=null&&h.namedTypeDefinitions.get(d).members)&&(this.inclusionModeDefinition.namedTypeDefinitions.get(d).members=new Map);const N=this.sublayerCaches.get(d);E.forEach(f=>{var c,D;N==null||N.set(f.attributes[x],f),i&&!((c=this.inclusionModeDefinition)!=null&&c.namedTypeDefinitions.get(d).members.has(f.attributes[x]))&&((D=this.inclusionModeDefinition)==null||D.namedTypeDefinitions.get(d).members.set(f.attributes[x],{id:f.attributes[x]}),F(this.memberIdTypeLookup,f.attributes[x],()=>new Set).add(d))})}})().then(()=>{Q(null)})});r.push(k),(R=this._processingCacheUpdatesLookup.get(d))==null||R.push(k)}await Promise.all(r)}removeFromLayer(e){var i,s,r;const t=new Set,n=new Set(e.map(o=>o.id));for(const o of e)t.add(o.typeName),((i=this.memberIdTypeLookup.get(o.id))==null?void 0:i.size)===1?this.memberIdTypeLookup.delete(o.id):(s=this.memberIdTypeLookup.get(o.id))==null||s.delete(o.typeName),(r=this.inclusionModeDefinition)==null||r.namedTypeDefinitions.forEach((a,p)=>{var m;p===o.typeName&&((m=a.members)!=null&&m.has(o.id))&&a.members.delete(o.id)});t.forEach(o=>{var a;(a=this.sublayerCaches.get(o))==null||a.forEach((p,m)=>{var w;n.has(m)&&((w=this.sublayerCaches.get(o))==null||w.delete(m))})})}async retrieveDataFromService(e,t,n){var R,d,L,k,Q,se,J,P,V,A,H,ne,W,K,z,Z,X;const i=q.getInstance(),s=new Set,r=[];let o,a="",p=[];const m=t.graphType==="relationship",w=(L=(d=(R=this.inclusionModeDefinition)==null?void 0:R.namedTypeDefinitions)==null?void 0:d.get(t.objectType.name))==null?void 0:L.useAllData,g=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let b=!w&&g?Array.from(g).sort():null;if((se=(Q=(k=this.inclusionModeDefinition)==null?void 0:k.namedTypeDefinitions)==null?void 0:Q.get(t.objectType.name))!=null&&se.useAllData)(V=(P=(J=this.inclusionModeDefinition)==null?void 0:J.namedTypeDefinitions)==null?void 0:P.get(t.objectType.name))!=null&&V.useAllData&&e.objectIds!=null&&(b=e.objectIds);else if(e.objectIds!=null&&b&&b.length>0){const I=e.objectIds;e.objectIds=b.filter(h=>I.includes(h))}else if(e.objectIds!=null)b=e.objectIds;else{if((A=this.inclusionModeDefinition)!=null&&A.namedTypeDefinitions.has(t.objectType.name)&&(!((H=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))!=null&&H.members)||((W=(ne=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))==null?void 0:ne.members)==null?void 0:W.size)<1))return e.objectIds=[],[];e.objectIds=b}if(e.outFields!=null){const I=e.outFields;I.includes("*")?t.fields.forEach(h=>{s.add(h.name)}):I.forEach(h=>{h!==x&&h!==t.geometryFieldName&&s.add(h)})}if(e.geometry!=null){const I=e.geometry;let h;const T=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,$=T==null?void 0:T.spatialReference,M=(K=T==null?void 0:T.serviceCapabilities)==null?void 0:K.geometryCapabilities;let E=M==null?void 0:M.geometryMaxBoundingRectangleSizeX,N=M==null?void 0:M.geometryMaxBoundingRectangleSizeY;if((z=I==null?void 0:I.extent)!=null&&z.spatialReference&&!((Z=I.spatialReference)!=null&&Z.isWGS84)?(await De(I.extent.spatialReference,ie),h=ye(I.extent,ie)):h=I.extent,E&&N&&$){if($.wkid!==4326){const f=new ue({spatialReference:$,xmax:E,ymax:N}),c=ye(f,ie);E=c.xmax,N=c.ymax}if(h.xmax-h.xmin>E)throw new G("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${E}° latitude, limit exceeded`);if(h.ymax-h.ymin>N)throw new G("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${N}° longitude, limit exceeded`)}if(e.where!=null&&e.where!=="1=1"){const f=await me(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(c=>{f.fieldNames.includes(c.name)&&s.add(c.name)})}a=m?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&s.add(t.geometryFieldName),s.forEach(f=>{a+=`, n.${f}`,r.push(f)}),o=new B({openCypherQuery:a,bindParameters:{param_filter_geom:new Me({rings:wt(h)})}})}else{let I="";if(e.where!=null&&e.where!=="1=1"){const $=await me(e.where,t.fieldsIndex);t.fields.forEach(c=>{$.fieldNames.includes(c.name)&&s.add(c.name)});const M=new Set(["column-reference","string","number","binary-expression"]),E=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let N=!1;const f=c=>{if(c.type==="column-reference")return`n.${c.column}`;if(c.type==="string")return`'${c.value}'`;if(c.type==="number")return`${c.value}`;if(c.type==="binary-expression"&&M.has(c.left.type)&&M.has(c.right.type)&&E.has(c.operator))return`${f(c.left)} ${c.operator} ${f(c.right)}`;if(c.type==="binary-expression"&&c.operator==="LIKE"){let D="";if(c.left.type==="function"&&c.left.args.value[0].type==="column-reference")D+=`lower(n.${c.left.args.value[0].column})`;else{if(c.left.type!=="column-reference")return N=!0,"";D+=`lower(n.${c.left.column})`}if(D+=" CONTAINS (",c.right.type!=="string")return N=!0,"";{let _=c.right.value;_.charAt(0)==="%"&&(_=_.slice(1)),_.charAt(_.length-1)==="%"&&(_=_.slice(0,-1)),D+=`'${_.toLowerCase()}')`}return D}return N=!0,""};I=f($.parseTree),N&&(I="")}let h="";h=m?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let T=!1;b&&(T=!0,h+=" WHERE ID(n) IN $ids"),I&&(h+=T?" AND":" WHERE",h+=` ${I}`),h+=" return ID(n)",m&&(h+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&s.add(t.geometryFieldName),s.forEach($=>{h+=`, n.${$}`,r.push($)}),o=new B(b?{openCypherQuery:h,bindParameters:{ids:b}}:{openCypherQuery:h})}const S=(await ee(t.parentCompositeLayer.dataManager.knowledgeGraph,o,n)).resultRowsStream.getReader();for(;;){const{done:I,value:h}=await S.read();if(I)break;const T=[];for(let $=0;$<h.length;$++){const M=h[$];let E=0,N=0;const f={properties:{}};for(f.id=M[E],E++,N++,m&&(f.originId=M[E],E++,N++,f.destinationId=M[E],E++,N++);E<M.length;E++)f.properties[r[E-N]]=M[E];T.push(f)}p=p.concat(i.writeToStore(T,x,(X=t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name))==null?void 0:X.name))}return p}};l([y()],O.prototype,"knowledgeGraph",void 0),l([y()],O.prototype,"inclusionModeDefinition",void 0),l([y()],O.prototype,"entityTypeNames",void 0),l([y()],O.prototype,"relationshipTypeNames",void 0),l([y()],O.prototype,"geographicLookup",void 0),l([y()],O.prototype,"sublayerCaches",void 0),l([y()],O.prototype,"nodeConnectionsLookup",void 0),l([y()],O.prototype,"relationshipConnectionsLookup",void 0),l([y()],O.prototype,"memberIdTypeLookup",void 0),O=l([ce("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],O);const Ee=Ve(),Dt=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return l([y(Ee.fields)],t.prototype,"fields",void 0),l([y(Ee.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=l([ce("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],t),t};function j(e){if(!e.json)return e;e.json.write=Ne(e.json.write);const t=e.json.origins;if(!t)return e;let n;for(n in t){const i=t[n];i&&(i.write=Ne(i.write))}return e}function Ne(e){return typeof e=="object"&&e?(e.enabled!==!1&&(e.overridePolicy=Mt(e)),e):e===!0?te():e}function Mt(e){const{target:t,writer:n,overridePolicy:i,...s}=e;return function(r,o){const a=$e.call(this,r,o);return a.enabled?{...s,...a}:a}}function te(){return{overridePolicy:$e}}function $e(e,t){const n=!!this.geometryType;let i={enabled:n};return n&&(i={...i,...Re.call(this,e,t)}),i}function Re(e,t){return{ignoreOrigin:this.originIdOf(t)>xe.DEFAULTS}}let u=class extends Dt(Xe(ze(He(tt(ot(rt(nt(ve(Ae))))))))){constructor(e){super(e),this.blendMode="normal",this.capabilities=Qe(!1,!1),this.charts=null,this.definitionExpression=null,this.displayField="",this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.labelingInfo=null,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=x,this.objectType=null,this.opacity=1,this.orderBy=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const t=new MessageChannel;return new Ce(t.port1,{channel:t,client:{queryFeatures:(n,i={})=>{const s=Y.fromJSON(n);return this.queryFeaturesJSON(s,i)}}}),[t.port2]})},this.title=null,this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(e){const t=this._normalizeFeatureReduction(e);this._set("featureReduction",t)}get fields(){var t,n;const e=[];return(n=(t=this.objectType)==null?void 0:t.properties)==null||n.forEach(i=>{const s=i.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":i.fieldType;e.push(de.fromJSON({name:i.name,type:s,alias:i.alias,defaultValue:i.defaultValue,editable:i.editable,nullable:i.nullable}))}),e.push(de.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),de.fromJSON({name:Ie,type:"esriFieldTypeInteger",alias:Ie,editable:!1})),e}get geometryType(){var n,i,s;if(((n=this.parentCompositeLayer)==null?void 0:n.type)==="link-chart")return this.graphType==="relationship"?"polyline":"point";const e=(s=this.parentCompositeLayer)==null?void 0:s.dataManager.geographicLookup.get((i=this.objectType)==null?void 0:i.name),t=e==null?void 0:e.geometryType;return t&&t!=="esriGeometryNull"?U.fromJSON(t):null}get geometryFieldName(){var t,n,i;if(((t=this.parentCompositeLayer)==null?void 0:t.type)==="link-chart")return Le;const e=(i=this.parentCompositeLayer)==null?void 0:i.dataManager.geographicLookup.get((n=this.objectType)==null?void 0:n.name);return(e==null?void 0:e.name)??null}get graphTypeName(){var e;return(e=this.objectType)==null?void 0:e.name}get hasM(){var i,s,r,o;const e=(s=this.parentCompositeLayer)==null?void 0:s.dataManager.geographicLookup.get((i=this.objectType)==null?void 0:i.name),t=e==null?void 0:e.name,n=t?(o=(r=this.objectType)==null?void 0:r.properties)==null?void 0:o[t]:null;return(n==null?void 0:n.hasM)??!1}get hasZ(){var i,s,r,o;const e=(s=this.parentCompositeLayer)==null?void 0:s.dataManager.geographicLookup.get((i=this.objectType)==null?void 0:i.name),t=e==null?void 0:e.name,n=t?(o=(r=this.objectType)==null?void 0:r.properties)==null?void 0:o[t]:null;return(n==null?void 0:n.hasZ)??!1}set renderer(e){Je(e,this.fieldsIndex),this._set("renderer",e)}get renderer(){var e;return this._isOverridden("renderer")?this._get("renderer"):((e=this.parentCompositeLayer)==null?void 0:e.type)==="link-chart"?this.graphType==="relationship"?ae(le(U.toJSON("polyline")).renderer):ae(le(U.toJSON("point")).renderer):ae(le(U.toJSON(this.geometryType)).renderer)}get spatialReference(){var e,t,n,i;return((i=(n=(t=(e=this.parentCompositeLayer)==null?void 0:e.dataManager)==null?void 0:t.knowledgeGraph)==null?void 0:n.dataModel)==null?void 0:i.spatialReference)??qe.WGS84}writeTitle(e,t){t.title=e??"Layer"}createPopupTemplate(e){return ft(this,e)}createQuery(){return new Y({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];return null}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e),s=ht.fromJSON(await i.executeQuery(n.toJSON(),t==null?void 0:t.signal));return s.features.forEach(r=>{r.sourceLayer=this}),s}async queryFeaturesJSON(e,t){const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e);return await i.executeQuery(n.toJSON(),t==null?void 0:t.signal)}async queryFeatureCount(e,t){const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e);return i.executeQueryForCount(n.toJSON(),t==null?void 0:t.signal)}async queryExtent(e={},t){var a,p,m,w;const n={...e,returnGeometry:!0},{resolvedQuery:i,queryEngine:s}=await this._setupQueryObjects(n),r=await s.executeQueryForExtent(i.toJSON(),t==null?void 0:t.signal);let o;return o=((a=r.extent)==null?void 0:a.xmin)!=null&&((p=r.extent)==null?void 0:p.xmax)!=null&&((m=r.extent)==null?void 0:m.ymin)!=null&&((w=r.extent)==null?void 0:w.ymax)!=null?new ue(r.extent):new ue,{count:r.count,extent:o}}async queryObjectIds(e,t){const n=Y.from(e);let i;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const s=await this.parentCompositeLayer.dataManager.getData(n,this,t);i=this.loadQueryEngine(s)}return i.executeQueryForIds(n.toJSON(),t==null?void 0:t.signal)}loadQueryEngine(e){const t=new Fe({geometryType:U.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),n=new Ge({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:U.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return n.featureStore.addMany(e),n}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new Y({where:"1=1",outFields:[x]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){var r;const n=Y.from(e),i=n.geometry;let s;if(i&&!((r=i.spatialReference)!=null&&r.isWGS84)&&(await De(i.spatialReference,ie),n.geometry=ye(i instanceof Me||i instanceof Pe?i:i.extent,ie)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)s=this._cachedQueryEngine;else{const o=await this.parentCompositeLayer.dataManager.getData(n,this,t);s=this.loadQueryEngine(o)}return{resolvedQuery:n,queryEngine:s}}};l([y(j(C(We)))],u.prototype,"blendMode",void 0),l([y()],u.prototype,"capabilities",void 0),l([y({json:{origins:{"web-scene":{write:!1}},write:te()}})],u.prototype,"charts",void 0),l([y({readOnly:!0})],u.prototype,"defaultPopupTemplate",null),l([y({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],u.prototype,"definitionExpression",void 0),l([y()],u.prototype,"displayField",void 0),l([y(j(C(Ke)))],u.prototype,"effect",void 0),l([y()],u.prototype,"elevationInfo",void 0),l([y(j(C(Ze)))],u.prototype,"featureEffect",void 0),l([y(j(C(et)))],u.prototype,"featureReduction",null),l([y()],u.prototype,"fields",null),l([y()],u.prototype,"geometryType",null),l([y()],u.prototype,"geometryFieldName",null),l([y({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],u.prototype,"graphType",void 0),l([y({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],u.prototype,"graphTypeName",null),l([y()],u.prototype,"hasM",null),l([y()],u.prototype,"hasZ",null),l([y({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],u.prototype,"id",void 0),l([y(j(C(at)))],u.prototype,"labelsVisible",void 0),l([y({type:[ct],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:mt,write:te()}})],u.prototype,"labelingInfo",void 0),l([y({readOnly:!0,json:{read:!1,write:{writer(e,t){t.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],u.prototype,"layerType",void 0),l([y(j(C(pt)))],u.prototype,"legendEnabled",void 0),l([y(j(C(lt)))],u.prototype,"maxScale",void 0),l([y(j(C(dt)))],u.prototype,"minScale",void 0),l([y()],u.prototype,"objectIdField",void 0),l([y()],u.prototype,"objectType",void 0),l([y(j(C(yt)))],u.prototype,"opacity",void 0),l([y(j(C(it)))],u.prototype,"orderBy",void 0),l([y()],u.prototype,"parentCompositeLayer",void 0),l([y(j(C(ut)))],u.prototype,"popupEnabled",void 0),l([y({type:_e,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],u.prototype,"popupTemplate",void 0),l([y({type:Number,json:{write:{overridePolicy:Re}}})],u.prototype,"refreshInterval",void 0),l([y({types:ke,json:{name:"layerDefinition.drawingInfo.renderer",write:te()}})],u.prototype,"renderer",null),l([y()],u.prototype,"source",void 0),l([y()],u.prototype,"spatialReference",null),l([y({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],u.prototype,"title",void 0),l([je("title")],u.prototype,"writeTitle",null),l([y({json:{read:!1}})],u.prototype,"type",void 0),l([y(j(C(st)))],u.prototype,"useViewTime",void 0),l([y({type:Boolean,json:{name:"visibility",write:te()}})],u.prototype,"visible",void 0),u=l([ce("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],u);const bi=u;export{Le as D,gi as E,Ie as I,O as M,fi as T,bi as a,Ti as b,wi as c,hi as h,x as w};
