import{r as I}from"./tslib.es6-B3Jf3DVX.js";import{j as ue,b as J,n as fe,m as j,a as Re}from"./subclass-BZA_h8Db.js";import{q as ge,x as Fe}from"./Accessor-BLX9ikPh.js";import{watch as be,initial as Ve}from"./reactiveUtils-C5zUhJQJ.js";import{n as He,s as je}from"./mat3-BRl2i9Bz.js";import{e as ye,o as X}from"./mat3f64-BBpwCtoL.js";import{i as De,I as Le}from"./mat4-GpOFENPA.js";import{e as _e}from"./mat4f64-Dk4dwAN8.js";import{n as Be}from"./quatf64-CCm9z-pX.js";import{u as ke,N as Ge}from"./vec32-Dvg_eL9J.js";import{u as Ne,n as Y}from"./vec3f64-BLpZdpfb.js";import{r as $e}from"./vec4f64-o2zAXfmz.js";import{T as ze}from"./Point-Cg0-ChZE.js";import{C as We}from"./computeTranslationToOriginAndRotation-Q27G6TBL.js";import{x as qe,f as Je,t as Xe,i as Ye}from"./Transform-7wmboOkN.js";import{n as Ke}from"./projectVectorToVector-G2uWGoIb.js";import{c as Qe,x as Ze,L as et,i as K,O as tt,E as rt,u as it,k as ot,B as we,g as ve}from"./BufferView-_QDXRCew.js";import{r as E,a as Q,S as D,N as O,e as u,m as st,d as at,g as xe,t as M,n as Z,i as S}from"./ILyr3DWasmPerSceneView-KC8PJi3s.js";import{R as Ce}from"./elevationInfoUtils-BC_66_Fg.js";import{l as nt}from"./ViewingMode-Dodu7ZZk.js";import{t as lt}from"./LineCallout.glsl-C1R4fy2f.js";import{t as mt}from"./RibbonLine.glsl-BZu1FDpE.js";import{l as pt}from"./LayerView3D-Dkb0AiwM.js";import{i as ct,r as Te,l as dt}from"./DefaultUI-C0utm694.js";import{i as G,e as U,u as Me}from"./renderState-DQLu6AJX.js";import{E as Pe,D as C}from"./enums-D9v74xTE.js";import{d as ht}from"./Graphic-DsxsIjhH.js";import{l as ut}from"./intersectorUtilsConversions-D_fcRVdX.js";import{G as ft}from"./dehydratedFeatureUtils-B--Sgpdi.js";import{i as gt,e as bt}from"./intersectorUtils-BK9EUwUf.js";import{m as yt,F as _t}from"./VertexColor.glsl-_ARMpsAT.js";import{e as wt}from"./ElevationRange-BrgM1moX.js";import{I as vt,J as xt,t as L}from"./orientedBoundingBox-DOAJUK5g.js";import{s as Ct,b as Tt,W as Mt,c as Pt}from"./ShadowCastAccumulate.glsl-BNKV7IEU.js";import{s as Et}from"./RenderTexture-CDO7DfmT.js";import{k as Ee,C as Ot}from"./Texture-Fac_8AOC.js";import{o as Ut}from"./AlphaCutoff-UcccL64p.js";import{c as At}from"./Normals-DzBXR8Bg.js";import{e as B}from"./VertexAttribute-Cq4MnHjR.js";import{y as It}from"./LayerView-CGYm21KA.js";import{r as St}from"./layerViewUtils-DhFEu8Rd.js";import"./asyncUtils-CWX51uTe.js";import"./Collection-CEdjem1-.js";import"./Evented-BHRw9x22.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./common-DQOJ18NT.js";import"./cast-Bjksrh93.js";import"./writer-DNAwXnhG.js";import"./assets-C43MgM-v.js";import"./index-Bh2oEzTI.js";import"./jsonMap-0cxwUWs2.js";import"./mathUtils-C4_ghTv4.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";import"./Polyline-D9YkgmM_.js";import"./Extent-Bf3YTe7m.js";import"./sphere-C77djCO6.js";import"./vec42-YcqnINSP.js";import"./plane-IENfwZlB.js";import"./vec2f64-miziP1SN.js";import"./mathUtils-BG-eq9fO.js";import"./projectPointToVector-GINIbYMz.js";import"./projection-B971H0Re.js";import"./vec2-maR1OrZI.js";import"./unitConversionUtils-BMfW9yAe.js";import"./lengthUtils-DL1-FDQQ.js";import"./symbols-CNimns--.js";import"./enumeration-Ba5njXdz.js";import"./fieldUtils-tmQlKvWo.js";import"./intl-CChhNOV8.js";import"./date-DlqISzcw.js";import"./locale-C9TlLpzi.js";import"./messages-OmQvZhAg.js";import"./geometry-D964gYQX.js";import"./TextSymbol-D8QO_KUV.js";import"./Color-BCS62Hs5.js";import"./colorUtils-0bJDPow9.js";import"./screenUtils-_ZIvrt5o.js";import"./materialUtils-DarhapKC.js";import"./opacityUtils-C68Tlu6_.js";import"./aaBoundingBox-BE7cC1jD.js";import"./persistableUrlUtils-fa1mAujs.js";import"./collectionUtils-D_lHIu88.js";import"./Portal-C10FKnaA.js";import"./Loadable-BabW5Xcc.js";import"./Promise-B2Hu02L7.js";import"./Clonable-D3rtuBWg.js";import"./Material-_xx7OZxD.js";import"./interfaces-DDtDqZYj.js";import"./boundedPlane-EV1sS2Ke.js";import"./lineSegment-D7sKPPYf.js";import"./ElevationProvider-C95wyCKc.js";import"./Indices-DflDlU4Z.js";import"./triangle-PTGDC_xJ.js";import"./graphicUtils-CWEFaVJb.js";import"./Matrix3DrawUniform-CiBFaSz6.js";import"./BindType-BmZEZMMh.js";import"./compilerUtils-Dw3R0f-Z.js";import"./sdfPrimitives-CUWZbMRe.js";import"./vec3f32-nZdmKIgz.js";import"./Util-BIfApRF5.js";import"./doublePrecisionUtils-B0owpBza.js";import"./floatRGBA-CfH_2xsy.js";import"./meshVertexSpaceUtils-CXzOFlTI.js";import"./MeshLocalVertexSpace-LEHwMUnu.js";import"./hydratedFeatures-DBKLr8hT.js";import"./jsonUtils-CEfjT-BK.js";import"./vec2f32-BbH2jxlN.js";import"./InterleavedLayout-e-di2fxs.js";import"./ShaderTechniqueConfiguration-CBbn2DCi.js";import"./dehydratedFeatures-BiOblf0d.js";import"./quantizationUtils-uj_P09aO.js";import"./Field-ybkHhtnK.js";import"./fieldType-BuzM0UHS.js";import"./featureConversionUtils-D14h8iad.js";import"./OptimizedFeature-6cJ-QFG5.js";import"./OptimizedGeometry-BF8iz5FO.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./edgeUtils-BUKTgPFR.js";import"./DecodeSymbolColor.glsl-BPIX0fAF.js";import"./Float4DrawUniform-N58YDhuZ.js";import"./RealisticTree.glsl-CAmeC2w1.js";import"./DefaultMaterial-DgOvtNL9.js";import"./verticalOffsetUtils-BDQLpfho.js";import"./Texture-Begq2x5n.js";import"./Scheduler-CJu5awNf.js";import"./signal-D4lghLjV.js";import"./debugFlags-BF6Z0j0F.js";import"./Octree-C8d4sqjv.js";import"./frustum-CQrOepbv.js";import"./heightModelInfoUtils-C6gW75mB.js";import"./HeightModelInfo-9nOoV6LU.js";import"./arcgisLayerUrl-BX1FE5Hm.js";import"./jsxFactory-CJa39Fro.js";import"./uuid-fwrPAdZb.js";import"./UpdatingHandles-GfwcIh5z.js";import"./InputManager-Ba9xzDpe.js";import"./Queue-yu3bZ02p.js";import"./Map-iWpb5DpI.js";import"./Basemap-DVYOaWHz.js";import"./loadAll-B6mYSptb.js";import"./PortalItem-DzgXrpyc.js";import"./writeUtils-Dz7BsE1e.js";import"./layerUtils-BrNoooE9.js";import"./Ground-CAIVlzbd.js";import"./CollectionFlattener-CQN6i8ZK.js";import"./editableLayers-Cn9dHzhB.js";import"./catalogUtils-DyGHPM81.js";import"./basemapUtils-B9TjOm47.js";import"./utils-93yNk4Xc.js";import"./mat4f32-DcsiF_Rp.js";import"./TablesMixin-5umgS75f.js";import"./Layer-CVt7Hb5J.js";import"./Identifiable-B1UbsKNt.js";import"./TimeExtent-DocT5yPf.js";import"./timeUtils-8fb_2oAt.js";import"./GraphicsCollection-FfahqxsR.js";import"./ReactiveMap-6CfRGOlR.js";import"./Query-5Xpquc1r.js";import"./DataLayerSource-BKkswDvG.js";import"./FullTextSearch-Csd1Hktu.js";import"./selectionUtils-DYi6daQO.js";import"./IViewEvents-Bci6PjlS.js";import"./interfaces-D6pIddIh.js";import"./screenUtils-WcqhHU65.js";import"./a11yUtils-cyWndM8Q.js";import"./HighlightDefaults-D4ckYWWJ.js";import"./imageUtils-CtmzXUTE.js";import"./capabilities-A2uoe7dc.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-CZa70j6i.js";import"./accessibleHandler-hWbBTR_7.js";import"./CompassViewModel-C7G3VWNL.js";import"./utils-DsJqvptN.js";import"./GoTo-Wtu9mgoE.js";import"./NavigationToggle-BIWeotJk.js";import"./ZoomViewModel-oUfjVFgI.js";import"./PopupTemplate-BHMhS05j.js";import"./ActionToggle-iT4slXc7.js";import"./Intersector-wXoCuQ8W.js";import"./Intersector-BQ92CPLA.js";import"./quat-4pa1e6ds.js";import"./spatialReferenceEllipsoidUtils-DBE_OFra.js";import"./Viewpoint-C4FqWA2d.js";import"./Cyclical-oTUX3aX7.js";import"./workers-D4HfeYKj.js";import"./RenderCoordsHelper-C50UGjbb.js";import"./projectVectorToPoint-DcLtSZYw.js";import"./scaleUtils-D_Nw3nhM.js";import"./viewpointUtils-Bq9TFP4R.js";import"./earthUtils-ByXwmaX5.js";import"./spatialReferenceSupport-yRFduOSO.js";import"./ElevationSamplerData-DF8Bl6I9.js";import"./terrainUtils-CPZNZdjg.js";import"./TileInfo-Dphjf6xH.js";import"./TileKey-DZd6gJy7.js";import"./OverlayCompositing.glsl-CiE3Tt8y.js";import"./MergedRenderer-Dli9s1X5.js";import"./VertexArrayObject-lPxPk5E-.js";import"./NestedMap-GuqgquCN.js";import"./glUtil-D0YUa0ow.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./axisAngleDegrees-Ci2HA7Jo.js";import"./weather-eV4wTXCK.js";import"./BufferObject-BVi1lwBq.js";import"./Program-mfcb06fW.js";import"./ShadowCastVisualizeTechniqueConfiguration-Bb-Uir0o.js";import"./Environment-BDo9QJi6.js";import"./Compositing.glsl-DMM7CJmu.js";import"./Blit-B-VutIER.js";import"./unitFormatUtils-CZ2bRlFg.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./quantityUtils-D0GB2dMc.js";import"./ZoomMomentumEstimator-DA-HeSfK.js";import"./HUDMaterial.glsl-D6WRipwF.js";import"./labelFormatUtils-DFKxfrJb.js";import"./labelUtils-B8petyBk.js";import"./NormalUtils.glsl-DwmdcsLR.js";import"./fontUtils-BKHqaMFz.js";import"./LodRenderer-EVrH9dsH.js";import"./FeaturePipelineRenderManager-DjjUkvYY.js";import"./ElevationQueryTileCache-D4sXpJpw.js";import"./LayerConstants-B33OP6sh.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./MemCache-Dx1v3xLC.js";import"./vec33-DUxPafiq.js";import"./Version-BSlAgupz.js";import"./requestImageUtils-DgMiQwsm.js";import"./TileStrategy-DT04gaWW.js";import"./TileKey-Cs1awCRX.js";import"./QueueProcessor-DZiVr5XH.js";import"./RenderableTile-Dl7jrqnB.js";import"./config-MDUrh2eL.js";import"./StyleDefinition-BTt_i6C1.js";import"./enums-CmIX1y88.js";import"./enums-BRzLM11V.js";import"./GeometryUtils-Dyjqugo6.js";import"./DefaultVertexAttributeLayouts-PrbBmwty.js";import"./DisplayObject-DGZ6h7sV.js";import"./resources-CLJpJAXm.js";import"./colorUtils-aL8wj-8G.js";import"./vec3-kbEkneOB.js";import"./ShaderTechniqueRepository-hTzew41Z.js";import"./testSVGPremultipliedAlpha-uTaDUvFS.js";import"./RenderingContext-C2W2PIoX.js";import"./ProgramCache-BcuuBWLJ.js";class Rt extends lt{constructor(e,p,o,d,a,s,c){super(e,0,0,0,p),this.nodesCached=o,this.vboMB=d,this.textureMB=a,this.vboMBCached=s,this.textureMBCached=c}}const Ft={[E.Points]:null,[E.Lines]:null,[E.LineStrip]:null,[E.Triangles]:Pe.TRIANGLES,[E.TriangleStrip]:Pe.TRIANGLE_STRIP,[E.NotSet]:null},Oe={[Q.Opaque]:G.Opaque,[Q.Mask]:G.Mask,[Q.Blend]:G.Blend},Vt={[D.Back]:U.Back,[D.Front]:U.Front,[D.None]:U.None,[D.NotSet]:U.Back},Ht={[O.WrapYBit]:{s:C.CLAMP_TO_EDGE,t:C.REPEAT},[O.WrapXBit]:{s:C.REPEAT,t:C.CLAMP_TO_EDGE},[O.WrapXy]:{s:C.REPEAT,t:C.REPEAT},[O.None]:{s:C.CLAMP_TO_EDGE,t:C.CLAMP_TO_EDGE},[O.NotSet]:{s:C.CLAMP_TO_EDGE,t:C.CLAMP_TO_EDGE}},jt={[u.U8]:1,[u.I8]:1,[u.U16]:2,[u.I16]:2,[u.U32]:4,[u.I32]:4,[u.F32]:4,[u.F64]:8,[u.Utf8String]:1,[u.NotSet]:1};class Dt{constructor(e){this.layerUid=[],this.type=gt.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,p,o,d,a,s){const c=e.results,v=e.options.store===bt.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const y=this.layerView.view._stage.renderView.componentObjectCollection,f=new yt(s??!1,e.options.normalRequired);this.layerView.objects.forEach(n=>{n.visible&&n.intersectionGeometry&&y.intersect(n,o,d,e.tolerance,null,f,(l,r,m,g)=>{if(r>=0){if(p!=null&&!p(o,d,r))return;const h=w=>{const _=new ut(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));w.set(this.type,_,r,m)};if(this.isGround&&(c.ground.dist==null||r<c.ground.dist)&&h(c.ground),e.options.isFiltered)return;if((c.min.dist==null||r<c.min.dist)&&h(c.min),(c.max.dist==null||r>c.max.dist)&&h(c.max),v){const w=ft(e.ray);h(w),e.results.all.push(w)}}})})}_createTiles3DGraphic(e,p){return new ht({layer:e,sourceLayer:e,attributes:p})}}var b;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(b||(b={}));class Lt{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function k(t){return Math.round(t/1048.576)/1e3}let P=class extends pt(It){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=mt.WithoutRasterImage,this._applySSAO=!ue("disable-feature:im-ssao"),this._shadeNormals=!!ue("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(b.Error),this._dbg(b.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new J("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=ct(this).then(e=>{this._intersectionHandler=new Dt(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,o=>this._slicePlaneEnabledChange(o)),this._elevationProvider=new qe({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const p=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,o=>this._onRemoveFromCache(o));this._memCache=p,this.addHandles([be(()=>this.layer.elevationInfo,o=>this._elevationInfoChanged(o))]),this._suspendedHandle=be(()=>this.suspended,o=>{var d;return(d=this._wasm)==null?void 0:d.setEnabled(this,!o)},Ve)}).catch(e=>{if(Te(this),this._wasmLayerId=-1,e===st)throw new J("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===at)throw new J("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(b.VerboseAPI,"Tiles3DLayerView3D destroy() called"),Te(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=ge(this._memCache),this._updatingHandles=ge(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??(this._visibleGeometryChangedSchedulerHandle=Fe(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const p=this._collection.getMaterial(e);p.commonMaterialParameters.hasSlicePlane=t,p.commonMaterialParameters.cullFace=t?U.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){var e;(e=this._wasm)==null||e.setLayerOffset(this,Ce(t))}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get _wasm(){return dt(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.totalMemory())}),t}get unloadedMemory(){return 0}get cachedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.totalMemory())}),t}get visibleAtCurrentScale(){return St(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let t=0,e=0,p=0,o=0,d=0,a=0;return this._lyrHandleToObjects.forEach(s=>{s.isVisible?(t+=s.texMemoryUsage,e+=s.vboMemoryUsage,d++):(p+=s.texMemoryUsage,o+=s.vboMemoryUsage,a++)}),new Rt(this.usedMemory,d,a,k(e),k(t),k(o),k(p))}_canProjectWithoutEngine(){var t,e;if(this.view.state.viewingMode===nt.Local){const p=(t=this.view.renderSpatialReference)!=null&&t.isWebMercator?3857:((e=this.view.renderSpatialReference)==null?void 0:e.wkid)??-1;if(p!==3857&&p!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return Ce(this.layer.elevationInfo)}get elevationRange(){const t=this.fullExtent;return t!=null&&t.zmin&&(t!=null&&t.zmax)?new wt(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=this._wasm;return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){var r;const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const p=Ne(e.desc.origin),o=new Array,d=new Map,a=new Lt;a.handle=t.handle,this._lyrHandleToObjects.set(t.handle,a);const s=this.view.basemapTerrain.spatialReference;let c,v;if(this.view.viewingMode==="global"){const m=_e();We(ze,p,m,s),c=He(ye(),m),v=je(ye(),c)}else c=X,v=X;const y=_e();De(y,y,p);const f=Le(Y(),y);let n=null;const l=Y();if(e.desc.obb){const m=e.desc.obb.quaternion;n=new vt(e.desc.obb.center,e.desc.obb.halfSize,Be(m[0],m[1],m[2],m[3]))}for(let m=0;m<e.desc.prims.length;m++){const g=e.desc.prims[m];if(this._dbg(b.VerboseAPI,JSON.stringify(g)),Ft[g.ptype]==null||e.data==null){this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+g.ptype+"). Skipping primitive.");continue}const h=(r=e.desc)!=null&&r.materials&&g.materialId!=null?e.desc.materials[g.materialId]:null,w=h!=null?h.lightingModel:xe.Unlit,{positionView:_,positionAttr:T,normalsView:Ue,normalsAttr:N,colorAttr:R,texCoord0Attr:F,indicesView:A}=this.getBufferViews(g,e.data.buffer,c);if(T==null||_==null||A==null)continue;const ee=new Ct(R!=null,F!=null?Ee.Default:Ee.None,Ue!=null,this._shadeNormals,this._applySSAO),Ae=T.data.length/T.size,$=(i,x)=>!i||i.data.length/i.size===Ae||(this._dbg(b.Error,`${x} !== numPos. Skipping primitive.`),!1);if(!$(F,"numTexcoord")||!$(R,"numColors")||!$(N,"normals"))continue;const te=Tt(ee);if(n!=null?n=n.clone():(n=xt(T),ke(l,n.center,p),n.center=l),c!==X)for(let i=0;i<_.count;i++)_.getVec(i,l),Ge(l,l,c),_.setVec(i,l);const z=te.createBuffer(T.data.length),V=new Map([[B.POSITION,T]]);F!=null&&V.set(B.UV0,F),R!=null&&V.set(B.COLOR,R),N!=null&&V.set(B.NORMALCOMPRESSED,N),V.forEach((i,x)=>{i!=null&&_t(x,i,null,null,z,0)});const Ie=new Uint32Array([0,A.typedBuffer.length]),Se={vertices:{data:z.buffer,count:z.byteLength/te.stride,layoutParameters:ee},positionData:{positions:_.typedBuffer,indices:A.typedBuffer},indices:A.typedBuffer,componentOffsets:Ie};a.cpuMemoryUsage+=_.count,a.cpuMemoryUsage+=A.count;const re=this.view.renderSpatialReference,W=Y(),q=[1,1,1];Je(f,re,q,s)||this._dbg(b.Error,"Unsupported coordinate system for IM overlay"),Ke(f,re,W,s);const H=this._collection.createObject(new Xe($e(W[0],W[1],q[0],q[1]),new Ye(f,v),n,Se));h&&this._collection.updateMaterial(H,i=>{i.baseColor=h.baseColorFactor,i.usePBR=w===xe.Pbr,i.hasParametersFromSource=!1,i.baseColorTexture=this._getTexture(h.baseColorTex,e,d),i.usePBR&&(i.mrrFactors=[h.metallicFactor,h.roughnessFactor,0],i.emissiveFactor=h.emissiveFactor??[0,0,0],i.metallicRoughnessTexture=this._getTexture(h.metalTex,e,d),i.emissionTexture=this._getTexture(h.emissiveTex,e,d),i.occlusionTexture=this._getTexture(h.occlusionTex,e,d),i.normalTexture=this._getTexture(h.normalTex,e,d)),i.objectOpacity=0,i.alphaDiscardMode=G.Mask;const x=[];i.baseColorTexture&&x.push(i.baseColorTexture.loadPromise),i.usePBR&&i.metallicRoughnessTexture&&x.push(i.metallicRoughnessTexture.loadPromise),i.usePBR&&i.emissionTexture&&x.push(i.emissionTexture.loadPromise),i.usePBR&&i.occlusionTexture&&x.push(i.occlusionTexture.loadPromise),i.usePBR&&i.normalTexture&&x.push(i.normalTexture.loadPromise);const ie=Promise.all(x);o.push(ie),ie.then(()=>{var oe,se,ae,ne,le,me,pe,ce,de,he;i.alphaDiscardMode=Oe[h.alphaMode],i.objectOpacity=1,a.texMemoryUsage+=((se=(oe=i.baseColorTexture)==null?void 0:oe.glTexture)==null?void 0:se.usedMemory)||0,i.usePBR&&(a.texMemoryUsage+=((ne=(ae=i.metallicRoughnessTexture)==null?void 0:ae.glTexture)==null?void 0:ne.usedMemory)||0,a.texMemoryUsage+=((me=(le=i.emissionTexture)==null?void 0:le.glTexture)==null?void 0:me.usedMemory)||0,a.texMemoryUsage+=((ce=(pe=i.occlusionTexture)==null?void 0:pe.glTexture)==null?void 0:ce.usedMemory)||0,a.texMemoryUsage+=((he=(de=i.normalTexture)==null?void 0:de.glTexture)==null?void 0:he.usedMemory)||0)}),i.commonMaterialParameters.doubleSided=h.isDoubleSided,i.commonMaterialParameters.cullFace=h.faceCulling?Vt[h.faceCulling]:U.Back,this._initialCullFace.set(H,i.commonMaterialParameters.cullFace),i.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,i.componentParameters.castShadows=Mt.All,i.textureAlphaCutoff=h.alphaCutoff??Ut,i.alphaDiscardMode=Oe[h.alphaMode],i.isIntegratedMesh=!0,i.polygonOffsetEnabled=!1,i.hasOccludees=!1,i.ellipsoidMode=Pt(this.view.spatialReference)}),a.components.push(H),a.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(H)}if(await Promise.all(o),d.forEach(m=>{a.textures.push(m)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${a.handle}`,a,a.totalMemory()),{memUsageBytes:a.totalMemory()}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(p=>{this._stage.remove(p)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,p){if(this._memCache){for(let o=0;o<p;++o){const d=t[o],a=e[o];if(!a)continue;const s=this._lyrHandleToObjects.get(d);s&&(this._visibleGeometryChanged(),s.isVisible=a,s.components.forEach(c=>{this._collection.setObjectVisibility(c,a),this._elevationProvider.objectChanged(this._collection.getComponentObb(c))}),this._memCache.pop(`${d}`))}for(let o=0;o<p;++o){const d=t[o],a=e[o];if(a)continue;const s=this._lyrHandleToObjects.get(d);s&&(this._visibleGeometryChanged(),s.isVisible=a,s.components.forEach(c=>{this._collection.setObjectVisibility(c,a),this._elevationProvider.objectChanged(this._collection.getComponentObb(c))}),this._memCache.put(`${d}`,s,s.totalMemory()))}}}_getTexture(t,e,p){var d,a;let o=null;if(t&&((d=e.desc)!=null&&d.images)&&((a=e.data)!=null&&a.buffer)){const s=e.desc.images[t==null?void 0:t.imageId];if(o=p.get(s),!o&&s){const c=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,v=!!s.mipCount||c>1,y=Ht[t.wrapMode??O.None];let f=s.alpha?4:3;const n=new Uint8Array(e.data.buffer,s.data.byteOffset,s.data.byteCount);let l=null,r=null,m=null;switch(s.format){case M.Raw:s.pixelFormat===Z.R8?(l=n,f=1,r=""):s.pixelFormat===Z.Rgb8?(l=n,f=3,r=""):s.pixelFormat===Z.Rgba8&&(l=n,f=4,r="");break;case M.Dxt1:l=n,f=3,r=Me.DDS_ENCODING;break;case M.Dxt5:l=n,f=4,r=Me.DDS_ENCODING;break;case M.Png:r="image/png",m=document.createElement("img");break;case M.Jpeg:r="image/jpeg",m=document.createElement("img");break;case M.Etc2:r="image/ktx",m=document.createElement("img");break;case M.Astc:this._dbg(b.Error,"Astc texture not supported");break;case M.Pvrtc:this._dbg(b.Error,"Pvrtc texture not supported")}if(m&&r){const g=new Blob([n],{type:r});m.src=URL.createObjectURL(g),l=m}l&&r!=null&&(o=new Ot(l,{mipmap:v,maxAnisotropy:c,encoding:r,wrap:y,components:f,noUnpackFlip:!0,width:s.mip0Width,height:s.mip0Height}),this._stage.add(o),p.set(s,o))}}return o?new Et(this.view._stage.renderView.textures,o.id):null}getBufferViews(t,e,p){let o,d,a,s,c,v,y,f=null;for(let n=0;n<t.atrbs.length;n++){const l=t.atrbs[n],r=l.view,m=void 0,g=r.byteOffset+r.byteCount,h=r.byteCount/jt[r.type],w=[...Array(h).keys()].map(_=>_);try{switch(l.sem){case S.Position:r.ncomp!==3||r.type!==u.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Position ("+r+")"):(o=new K(e,r.byteOffset,m,g),d=new L(o.typedBuffer,w,3));break;case S.Normal:if(r.ncomp!==3||r.type!==u.F32)this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Normal ("+r+")");else{const _=new K(e,r.byteOffset,m,g),T=At(_.typedBuffer,p);c=new ot(T),v=new L(c.typedBuffer,w,2)}break;case S.TexCoord:r.ncomp!==2||r.type!==u.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+r+")"):s===void 0&&(s=new L(new it(e,r.byteOffset,m,g).typedBuffer,w,2));break;case S.Color:r.ncomp===4?(r.type===u.F32&&(f=new Qe(e,r.byteOffset,m,g)),r.type===u.U8&&(f=new Ze(e,r.byteOffset,m,g)),r.type===u.U16&&(f=new et(e,r.byteOffset,m,g))):r.ncomp===3&&(r.type===u.F32&&(f=new K(e,r.byteOffset,m,g)),r.type===u.U8&&(f=new tt(e,r.byteOffset,m,g)),r.type===u.U16&&(f=new rt(e,r.byteOffset,m,g))),f==null?this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+r+")"):a=new L(f.typedBuffer,w,r.ncomp);break;case S.FeatureIndex:break;default:this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+l.sem+"). Skipping vertex attribute.")}}catch(_){this._dbg(b.VerboseAPI,"Error Creating buffer ("+_+"). Skipping vertex attribute.")}}if(t.index){const n=t.index.view,l=void 0,r=n.byteOffset+n.byteCount;switch(t.index.view.type){case u.U16:y=new ve(e,n.byteOffset,l,r);break;case u.U32:y=new we(e,n.byteOffset,l,r);break;case u.U8:default:this._dbg(b.Error,"[Unsupported Feature] index type not supported ("+n.type+").")}}if(y==null&&o!=null){const n=o.count;if(n<65535){const l=new Uint16Array(n);y=new ve(l)}else{const l=new Uint32Array(n);y=new we(l)}for(let l=0;l<n;l++)y.set(l,l)}return{positionView:o,positionAttr:d,colorAttr:a,texCoord0Attr:s,indicesView:y,normalsView:c,normalsAttr:v}}_onRemoveFromCache(t){var e;(e=this._wasm)==null||e.onRenderableEvicted(this,t.handle,t.totalMemory()),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===b.Error?fe.getLogger(this).error(e):fe.getLogger(this).warn(e))}};I([j()],P.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),I([j()],P.prototype,"layer",void 0),I([j({readOnly:!0})],P.prototype,"visibleAtCurrentScale",null),I([j()],P.prototype,"elevationOffset",null),P=I([Re("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],P);const ya=P;export{ya as default};
