const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CatalogLayer-BTYBsEWG.js","./index-tefRSezt.js","./index-Cx51aysm.css","./Accessor-BHnuXKD2.js","./cast-BA_-jlhc.js","./JSONSupport-CGdeqxpk.js","./reactiveUtils-BR0C1Kq4.js","./Evented-DCWccWGU.js","./SimpleObservable-7oieNGD8.js","./MultiOriginJSONSupport-nGLpCFeg.js","./Layer-C9uQlTBT.js","./Identifiable-BrT7zvUW.js","./Portal-CTRRujjZ.js","./Promise-CmQqe-ke.js","./writer-B2bQV2uU.js","./Extent-CBBGeHb-.js","./Point-XGrwlf63.js","./TimeExtent-J5qnUFx_.js","./timeUtils-D2X862bk.js","./LRUCache-DS2O1kTf.js","./MemCache-CDoaVBHf.js","./ReactiveMap-Dwhwbx9R.js","./signal-DSa0yokC.js","./ScaleRangeLayer-C59zG_yk.js","./layerContainerType-C5CzMsLd.js","./jsonUtils-TjZmCq6l.js","./colorUtils-Rxh2V3ai.js","./utils-DYurMneM.js","./screenUtils-_ZIvrt5o.js","./mat4f32-DcsiF_Rp.js","./mat4-Fi6iAz29.js","./vec3f64-BLpZdpfb.js","./common-DQOJ18NT.js","./commonProperties-C0eC30J9.js","./ElevationInfo-Di4W6v5U.js","./opacityUtils-CSd4XoR2.js","./unitConversionUtils-C4AR5obr.js","./lengthUtils-DjJgJFRg.js","./AttributeTableTemplate-B7rH2qLr.js","./OrderByInfo-E-O9nvtm.js","./utils-B8VMZhYy.js","./ClassBreaksDefinition-DvZJqFCP.js","./enumeration-Cr5WIZs4.js","./Graphic-CFXUQZlS.js","./Clonable-DvJsj5LF.js","./Color-gncXBiLc.js","./mathUtils-DV9iOXpW.js","./ActionToggle-__-l4AdQ.js","./jsonUtils-Cu7OBRmN.js","./Polyline-BmuD2-ZN.js","./typeUtils-BSg8Y507.js","./TextSymbol-BQ_NW9Xo.js","./collectionUtils-CbaToa73.js","./aaBoundingBox-CeBivBRq.js","./FeatureLayerBase-DsahGowz.js","./formUtils-DXUHP5lI.js","./Field-Cyk7Ur5d.js","./fieldType-L-VlbZqy.js","./HeightModelInfo-B3GZyQFz.js","./timeZoneUtils-COos5xIr.js","./featureLayerUtils-BzWCGee1.js","./uuid-Cl5lrJ4c.js","./featureQueryAll-xezK3WCp.js","./Query-DCBIeen2.js","./FullTextSearch-BWm_kPUE.js","./layerUtils-dJgsXxkC.js","./SimpleRenderer-gSw1WaJS.js","./commonProperties-bGHL1a5M.js","./colorRamps-Dkx8zIVn.js","./SizeVariable-IzD1bP2e.js","./visualVariableUtils-Bp9QCb8E.js","./ColorStop-CDpeFWOz.js","./jsonUtils-Dzgxk9pw.js","./defaults-Dwxdhopq.js","./defaultsJSON-GKolV7NZ.js","./UniqueValueRenderer-Cri3tgP5.js","./diffUtils-CMkuJvD2.js","./RendererLegendOptions-mgfHoilI.js","./styleUtils-BB-zx7mT.js","./AttachmentQuery-BceVlzuF.js","./NormalizationBinParametersMixin-D6iHLB7I.js","./RelationshipQuery-W-4bfgaH.js","./LayerFloorInfo-BXAHB-yQ.js","./Relationship-BBBusoKs.js","./serviceCapabilitiesUtils-BuKg0yWx.js","./infoFor3D-CsJzgCF0.js","./FeatureEffectLayer-D3Dl2pXD.js","./FeatureEffect-xxsfLT-y.js","./FeatureFilter-DEE1jTWq.js","./labelingInfo-BvMdv93l.js","./labelUtils-Dq8OkaT-.js","./typeUtils-CfF4cYo5.js","./ClassBreaksRenderer-BBSNkSFx.js","./Version-9k2AOv05.js","./FieldsIndex-DFdVonga.js","./utils-B91u8350.js","./defaultCIMValues-DII_GG3u.js","./enums-BJSSbDkD.js","./HeatmapColorStop-c4wClnpW.js","./heatmapUtils-DA7NmY3d.js","./vec42-YcqnINSP.js","./vec4f64-o2zAXfmz.js","./popupUtils-pQ0CVidQ.js","./FeatureLayerSource-CL-YPivI.js","./MeshLocalVertexSpace-C0YDTRex.js","./meshVertexSpaceUtils-SW0WEjNN.js","./vec32-Dvg_eL9J.js","./External-Dk8Y8WWd.js","./applyEditsUtils-B-dfj_XI.js","./projection-B2I9Bzj_.js","./projectBuffer-DOU0xvVi.js","./geodesicConstants-yASAK_zX.js","./MeshTransform-CIhaTwDv.js","./mat4f64-Dk4dwAN8.js","./quat-4pa1e6ds.js","./mat3f64-BBpwCtoL.js","./quatf64-CCm9z-pX.js","./axisAngleDegrees-8Sw4vC28.js","./editingSupport-Dr0ErgB3.js","./normalizeUtils-XRAPXbWa.js","./normalizeUtilsCommon-D0zPTJCj.js","./utils-Cy8wFNQo.js","./utils-CkSELPnj.js","./EditBusLayer-Cx9SJosU.js","./clientSideDefaults-BOCfNRNG.js","./QueryEngineCapabilities-DZTubngj.js","./QueryTask-BTjeI7Co.js","./executeForIds-CUQYF7Pj.js","./query-BS_L6I0Q.js","./pbfQueryUtils-AwPAOS5M.js","./pbf-CFI-xDDp.js","./memoryEstimations-5gFNwkKK.js","./OptimizedGeometry-7IxBWtHr.js","./OptimizedFeature-DcMLlxvB.js","./OptimizedFeatureSet-Blu9Ckm7.js","./queryZScale-DwN6mTru.js","./executeQueryJSON-CLYdIUdF.js","./FeatureSet-DpCN730g.js","./featureConversionUtils-DpmsPUmt.js","./editsZScale-BKYnJc2O.js","./APIKeyMixin-Btq102Nx.js","./ArcGISService-BHkTabnw.js","./CustomParametersMixin-uo3x70vd.js","./DisplayFilteredLayer-BFGyM6i5.js","./scaleUtils-CfLu-sg1.js","./displayFilterUtils-DV_nOx_h.js","./OperationalLayer-Bts9W3HA.js","./OrderedLayer-BP2hvfL_.js","./PortalLayer-jhi5QQgB.js","./PortalItem-CXk7DqVv.js","./portalItemUtils-rm7sAgcm.js","./RefreshableLayer-Cn2UpWQD.js","./TemporalLayer-CYEvmdjr.js","./TimeInfo-LjqhhubF.js","./TimeInterval-BDTTJ9Uw.js","./FeatureType-DjGGrg1i.js","./FeatureTemplate-DqbLvkbZ.js","./fieldProperties-B9JP3-ue.js","./versionUtils-DSsYFI36.js","./FeatureLayer-9fyQxXYm.js","./workers-D8Q3pEzK.js","./Queue-BOnccek2.js","./intl-Do3GEEJ7.js","./FeatureReductionLayer-x8j38_gH.js","./FeatureReductionSelection-BpUGF9oj.js","./jsonUtils-DD1NMzWj.js","./MD5-C9MwAd2G.js","./TrackableLayer-D6paP6wl.js","./TitleCreator-Zm6TQ_ec.js","./styleUtils-BQ_uVsZf.js","./interfaces-CL2NbQte.js","./OrientedImageryLayer-Bc1gSq-N.js"])))=>i.map(i=>d[i]);
import{_ as P}from"./index-tefRSezt.js";import{ad as B,ap as K,G as V,s as u}from"./Accessor-BHnuXKD2.js";import{i as w}from"./originUtils-D69mHv66.js";import{P as z,w as O,$ as j,d as q,v as H,p as x,f as Q,I as N,m as L}from"./utils-rirLb0Sq.js";import{d}from"./cast-BA_-jlhc.js";import{t as W,i as X}from"./fetchService-zLGBmq3X.js";import{L as Z}from"./layerUtils-dJgsXxkC.js";import{o as aa}from"./jsonContext-CdRtpU_S.js";import{l as g,u as y,E as p,a as ea}from"./portalItemUtils-rm7sAgcm.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./Portal-CTRRujjZ.js";import"./JSONSupport-CGdeqxpk.js";import"./Promise-CmQqe-ke.js";import"./writer-B2bQV2uU.js";import"./Extent-CBBGeHb-.js";import"./Point-XGrwlf63.js";import"./PortalItem-CXk7DqVv.js";import"./saveUtils-DLMLWtvP.js";import"./requestPresets-v9_cUP4i.js";import"./projection-B2I9Bzj_.js";import"./SimpleObservable-7oieNGD8.js";import"./vec3f64-BLpZdpfb.js";import"./Polyline-BmuD2-ZN.js";import"./mathUtils-DV9iOXpW.js";import"./projectBuffer-DOU0xvVi.js";import"./geodesicConstants-yASAK_zX.js";const v="Feature Service",T="feature-layer-utils",ta=`${T}-save`,ra=`${T}-save-as`,f=`${T}-saveall`,m=`${T}-saveall-as`;function $(a){return{isValid:Z(a)&&(!("dynamicDataSource"in a)||!a.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function b(a,e){const t=aa(a,"portal-item");return e!=null&&e.isTable&&(t.layerContainerType="tables"),t}function R(a){const e=b(a),t=b(a);return t.layerContainerType="tables",{forLayers:e,forTables:t}}function D(a){const e=[],t=[];for(const{layer:r,layerJSON:n}of a)r.isTable?t.push(n):e.push(n);return{layers:e,tables:t}}function J(a){return D([a])}async function G(a,e){return/\/\d+\/?$/.test(a.url)?J(e[0]):U(e,a)}async function U(a,e){if(a.reverse(),!e)return D(a);const t=await oa(e,a);for(const r of a)F(r.layer,r.layerJSON,t);return ia(t,a),t}async function oa(a,e){let t=await a.fetchData("json");if(sa(t))return t;t||(t={}),na(t);const{layer:{url:r,customParameters:n,apiKey:o}}=e[0];return await la(t,{url:r??"",customParameters:n,apiKey:o},e.map(s=>s.layer.layerId)),t}function sa(a){return!!(a&&Array.isArray(a.layers)&&Array.isArray(a.tables))}function na(a){a.layers||(a.layers=[]),a.tables||(a.tables=[])}function ia(a,e){const t=[],r=[];for(const{layer:n}of e){const{isTable:o,layerId:s}=n;o?r.push(s):t.push(s)}E(a.layers,t),E(a.tables,r)}function E(a,e){if(a.length<2)return;const t=[];for(const{id:r}of a)t.push(r);B(t.sort(S),e.slice().sort(S))&&a.sort((r,n)=>{const o=e.indexOf(r.id),s=e.indexOf(n.id);return o<s?-1:o>s?1:0})}function S(a,e){return a<e?-1:a>e?1:0}async function la(a,e,t){const{url:r,customParameters:n,apiKey:o}=e,{serviceJSON:s,layersJSON:i}=await W(r,{customParameters:n,apiKey:o}),l=_(a.layers,s.layers,t),c=_(a.tables,s.tables,t);a.layers=l.itemResources,a.tables=c.itemResources;const h=[...l.added,...c.added],k=i?[...i.layers,...i.tables]:[];await ca(a,h,r,k)}function _(a,e,t){const r=K(a,e,(o,s)=>o.id===s.id);a=a.filter(o=>!r.removed.some(s=>s.id===o.id));const n=r.added;return n.forEach(({id:o})=>{a.push({id:o})}),{itemResources:a,added:n.filter(({id:o})=>!t.includes(o))}}async function ca(a,e,t,r){const n=await ua(e),o=e.map(({id:s,type:i})=>new(n.get(i))({url:t,layerId:s,sourceJSON:r.find(({id:l})=>l===s)}));await Promise.allSettled(o.map(s=>s.load())),o.forEach(s=>{const{layerId:i,loaded:l,defaultPopupTemplate:c}=s;if(!l||c==null)return;const h={id:i,popupInfo:c.toJSON()};s.operationalLayerType!=="ArcGISFeatureLayer"&&(h.layerType=s.operationalLayerType),F(s,h,a)})}async function ua(a){const e=[];a.forEach(({type:n})=>{switch(X(n)){case"CatalogLayer":e.push(P(()=>import("./CatalogLayer-BTYBsEWG.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158]),import.meta.url).then(o=>o.default));break;case"FeatureLayer":e.push(P(()=>import("./FeatureLayer-9fyQxXYm.js"),__vite__mapDeps([159,1,2,3,43,44,6,7,8,5,4,14,35,13,16,42,45,26,46,47,11,48,15,49,50,51,28,52,12,31,53,9,24,54,55,56,57,58,33,34,36,37,38,59,60,61,62,63,64,17,18,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,10,160,161,162,139,135,109,110,111,137,140,141,23,25,27,29,30,32,142,143,144,145,123,86,87,88,163,164,89,90,165,91,92,19,20,93,94,95,96,97,98,99,100,101,166,146,147,39,148,149,150,151,152,153,154,167,156,155,157,168,158,169,102,170]),import.meta.url).then(o=>o.default));break;case"OrientedImageryLayer":e.push(P(()=>import("./OrientedImageryLayer-Bc1gSq-N.js").then(o=>o.O),__vite__mapDeps([171,3,159,1,2,43,44,6,7,8,5,4,14,35,13,16,42,45,26,46,47,11,48,15,49,50,51,28,52,12,31,53,9,24,54,55,56,57,58,33,34,36,37,38,59,60,61,62,63,64,17,18,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,10,160,161,162,139,135,109,110,111,137,140,141,23,25,27,29,30,32,142,143,144,145,123,86,87,88,163,164,89,90,165,91,92,19,20,93,94,95,96,97,98,99,100,101,166,146,147,39,148,149,150,151,152,153,154,167,156,155,157,168,158,169,102,170]),import.meta.url).then(o=>o.default))}});const t=await Promise.all(e),r=new Map;return a.forEach(({type:n},o)=>{r.set(n,t[o])}),r}function F(a,e,t){a.isTable?A(t.tables,e):A(t.layers,e)}function A(a,e){const t=a.findIndex(({id:r})=>r===e.id);t===-1?a.push(e):a[t]=e}function M(a,e){if(!a.length)throw new u(`${e}:missing-parameters`,"'layers' array should contain at least one feature layer")}function pa(a,e){const t=a.map(r=>r.portalItem.id);if(new Set(t).size>1)throw new u(`${e}:invalid-parameters`,"All layers in the 'layers' array should be loaded from the same portal item")}function Y(a,e){const t=a.map(r=>r.layerId);if(new Set(t).size!==t.length)throw new u(`${e}:invalid-parameters`,"'layers' array should contain only one instance each of layer or table in a feature service")}async function ya(a){M(a,f),await Promise.all(a.map(e=>e.load()));for(const e of a)x(e,f,$),Q({layer:e,itemType:v,errorNamePrefix:f});pa(a,f),Y(a,f)}function I(a,e){let t=0,r=0,n=0;for(const{layerType:o}of[...e.layers,...e.tables])switch(o){case"OrientedImageryLayer":t++;break;case"SubtypeGroupLayer":r++;break;case"SubtypeGroupTable":n++}y(a,p.ORIENTED_IMAGERY_LAYER,t>0),y(a,p.SUBTYPE_GROUP_LAYER,r>0),y(a,p.SUBTYPE_GROUP_TABLE,n>0)}function C(a,e,t){ea(e,p.METADATA),y(e,p.MULTI_LAYER,a.length>1),y(e,p.SINGLE_LAYER,a.length===1),y(e,p.TABLE,t.tables.length>0&&t.layers.length===0),I(e,t)}async function fa(a,e,t){I(e,t)}async function ma(a,e,t){const{url:r,layerId:n,title:o,fullExtent:s,isTable:i}=a,l=d(r);e.url=((l==null?void 0:l.serverType)==="FeatureServer"?r:`${r}/${n}`)??null,e.title||(e.title=o),e.extent=null,i||s==null||(e.extent=await g(s)),C([a],e,t)}function da(a,e){for(const o of a){const s=o.parsedUrl.path,i=d(s);if(!(i==null?void 0:i.url.path))throw new u(`${e}:invalid-parameters`,L(o,`has unsupported url pattern: ${s}`),{layer:o});const c=i==null?void 0:i.serverType;if(c!=="FeatureServer"&&c!=="MapServer")throw new u(`${e}:invalid-parameters`,L(o,`has unsupported server type: ${c}`),{layer:o});if(c==="MapServer"&&a.length>1)throw new u(`${e}:invalid-parameters`,"Only one layer or table in a map service can be saved")}const t=d(a[0].parsedUrl.path),r=t==null?void 0:t.url.path;if(!a.every(o=>{const s=d(o.parsedUrl.path);return(s==null?void 0:s.url.path)===r}))throw new u(`${e}:invalid-parameters`,"'layers' array should only contain layers or tables that belong to the same feature service")}async function ha(a){M(a,m),await Promise.all(a.map(e=>e.load()));for(const e of a)x(e,m,$);da(a,m),Y(a,m)}function wa(a,e){I(a,e),N(a)}async function ba(a,e,t){let r=0;for(const{isTable:s}of a)s||r++;const n=a[0].parsedUrl.path,o=d(n);if(e.url=(o==null?void 0:o.serverType)==="FeatureServer"?o.url.path:n,e.title||(e.title=o.title),e.extent=null,r>0){const s=a.map(i=>i.fullExtent).filter(V).reduce((i,l)=>i.clone().union(l));s&&(e.extent=await g(s))}C(a,e,t),N(e)}async function Va(a,e){return z({layer:a,itemType:v,validateLayer:$,createJSONContext:t=>b(t,a),createItemData:(t,r)=>G(r,[t]),errorNamePrefix:ta,setItemProperties:fa},e)}async function za(a,e){await ya(a);const t=a[0].portalItem,r=R(t),n=await Promise.all(a.map(s=>O(s,s.isTable?r.forTables:r.forLayers,e))),o=await G(t,a.map((s,i)=>({layer:s,layerJSON:n[i]})));return wa(t,o),await t.update({data:o}),await Promise.all(a.slice(1).map(s=>s.portalItem.reload())),w(r.forLayers),w(r.forTables),t.clone()}async function ja(a,e,t){return j({layer:a,itemType:v,validateLayer:$,createJSONContext:r=>b(r,a),createItemData:(r,n)=>Promise.resolve(J(r)),errorNamePrefix:ra,newItem:e,setItemProperties:ma},t)}async function qa(a,e,t){await ha(a);const r=q({itemType:v,errorNamePrefix:m,newItem:e}),n=R(r),o=await Promise.all(a.map(i=>O(i,i.isTable?n.forTables:n.forLayers,t))),s=await U(a.map((i,l)=>({layer:i,layerJSON:o[l]})));await ba(a,r,s),await H(r,s,t);for(const i of a)i.portalItem=r.clone();return w(n.forLayers),w(n.forTables),r}export{Va as save,za as saveAll,qa as saveAllAs,ja as saveAs};
