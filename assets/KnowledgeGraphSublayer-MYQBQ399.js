import{g as Ae,B as Re,o as U,s as ye,a6 as Qe,r as p,m as d,a as Ee,c as $,u as Pe}from"./Accessor-BmwT4B0c.js";import{e as Se,$ as Je,f as He}from"./opacityUtils-Dim20wpZ.js";import{w as ce}from"./Extent-g5W9hy0j.js";import{j as _e,P as We}from"./Polyline-s-JzsQqo.js";import{Q as Te,O as he}from"./projection-CyCZAIaD.js";import{a4 as q,g as qe,j as Ue}from"./Point-Cz2JYYmX.js";import{I as fe,t as ge,_ as F,E as ae,S as Ne,o as Ie}from"./constants-B4mRqufT.js";import{f as ze}from"./jsonUtils-CwFG8yN4.js";import{s as Be}from"./featureConversionUtils-CvnFcmH_.js";import{s as Me}from"./OptimizedFeature-P2towpqD.js";import{S as Ke}from"./supportUtils-CQNKrihr.js";import{F as ne,W as Ve}from"./knowledgeGraphService-DXS9bis6.js";import{p as B}from"./GraphQueryStreaming-BUC_KzGu.js";import{b as K}from"./Query-B_2mhyL4.js";import{d as Ze,q as Ye}from"./Graphic-Dt0LgVGU.js";import{S as Xe}from"./MultiOriginJSONSupport-DbmrbwMa.js";import{E as et}from"./workers-Cds_sd9m.js";import{r as tt}from"./writer-DKgfqj4X.js";import{y as re}from"./typeUtils-B6WBEKDM.js";import{f as it}from"./Layer-DH4_Pn8a.js";import{f as nt}from"./FeatureStore-BuDu5Iw5.js";import{L as rt}from"./QueryEngine-BokU27l9.js";import{y as ot,u as Le}from"./clientSideDefaults-DyCV_B9d.js";import{s as at}from"./fieldProperties-DDN0PSrH.js";import{h as Ce}from"./Color-VJEMvW-n.js";import{C as V,b as se,n as st}from"./labelingInfo-BgG6IH9B.js";import{m as le}from"./TextSymbol-BLIQ6RKX.js";import{p as lt,t as pt,n as dt,l as ut}from"./ScaleRangeLayer-Cnzwr9PT.js";import{a as yt,p as mt,l as ht}from"./DisplayFilteredLayer-CzliK74b.js";import{c as ct,p as ft}from"./FeatureEffectLayer-BZmannck.js";import{d as gt,p as bt}from"./FeatureReductionLayer-B6VhUfZv.js";import{p as wt,c as Tt}from"./OrderedLayer-ucEg87Tu.js";import{f as It}from"./RefreshableLayer-C90FXoHt.js";import{l as Et,f as Nt}from"./TemporalLayer-CMqBosxi.js";import{d as St,v as Mt,j as Lt,f as Ct,l as kt}from"./commonProperties-B0GHoNP5.js";import{y as me}from"./Field-BDG0QV_T.js";import{d as Dt}from"./TimeInfo-CctegBed.js";import{p as $t}from"./SimpleRenderer-CEw_geZx.js";import{t as ke}from"./jsonUtils-BZp85R7u.js";import{m as xt}from"./typeUtils-B3iPBwJ2.js";import{d as vt}from"./FeatureSet-B5-Veyin.js";import{p as jt}from"./popupUtils-CmsUVJA0.js";import{a as De}from"./utils-aIx1khaq.js";class Q{constructor(){this._featureLookup=new Map}static getInstance(){return Q.instance||(Q.instance=new Q),Q.instance}static resetInstance(){Q.instance&&(Q.instance=null)}deleteFromStore(e){e.forEach(n=>{this._featureLookup.delete(n)})}readFromStoreByList(e){const n=[];return e.forEach(i=>{const o=this.readFromStoreById(i);o&&n.push(o)}),n}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,n,i){const o=[];return e.forEach(r=>{if(!(r!=null&&r.id))return;r.properties||(r.properties=[]);let a,s=null;if(i&&r.properties[i]&&(s=Be(r.properties[i])),"originId"in r&&"destinationId"in r&&(r.properties[fe]=r.originId,r.properties[ge]=r.destinationId),r.properties[n]=r.id,r.id&&this._featureLookup.has(r.id)&&this._featureLookup.get(r.id).attributes){const l=this._featureLookup.get(r.id),f=JSON.parse(JSON.stringify(Object.assign(l.attributes,r.properties)));i&&r.properties[i]&&(f[i]=ze(r.properties[i])),a=new Me(s?JSON.parse(JSON.stringify(s)):l!=null&&l.geometry?JSON.parse(JSON.stringify(l.geometry)):null,f,null,r.properties[n])}else a=new Me(s?JSON.parse(JSON.stringify(s)):null,r.properties,null,r.properties[n]);this._featureLookup.set(`${r.typeName?`${r.typeName}__${r.id}`:r.id}`,a),o.push(a)}),o}}let O=class extends Ae{constructor(t){var n,i,o;super(t),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const e=new Map;(n=t.knowledgeGraph.dataModel.entityTypes)==null||n.forEach(r=>{var a,s;r.name&&(e.set(r.name,"entity"),this._processingCacheUpdatesLookup.set(r.name,[]),t.inclusionModeDefinition&&!((a=t.inclusionModeDefinition)!=null&&a.generateAllSublayers)||this.entityTypeNames.add(r.name),(s=r.properties)==null||s.forEach(l=>{l.geometryType&&l.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(r.name,{name:l.name??"",geometryType:l.geometryType})}))}),(i=t.knowledgeGraph.dataModel.relationshipTypes)==null||i.forEach(r=>{var a,s;r.name&&(e.set(r.name,"relationship"),this._processingCacheUpdatesLookup.set(r.name,[]),t.inclusionModeDefinition&&!((a=t.inclusionModeDefinition)!=null&&a.generateAllSublayers)||this.relationshipTypeNames.add(r.name),(s=r.properties)==null||s.forEach(l=>{l.geometryType&&l.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(r.name,{name:l.name??"",geometryType:l.geometryType})}))}),(o=t.inclusionModeDefinition)==null||o.namedTypeDefinitions.forEach((r,a)=>{var l,f;if(e.get(a)==="entity")this.entityTypeNames.add(a);else{if(e.get(a)!=="relationship")return Re.getLogger(this).warn(`A named type, ${a}, was in the inclusion list that wasn't in the data model and will be removed`),void((l=t.inclusionModeDefinition)==null?void 0:l.namedTypeDefinitions.delete(a));this.relationshipTypeNames.add(a)}const s=new Map;(f=r.members)==null||f.forEach(g=>{U(this.memberIdTypeLookup,g.id,()=>new Set).add(a);const h=this.getById(g.id);h&&s.set(g.id,h)}),this.sublayerCaches.set(a,s)})}addToLayer(t){t.forEach(({typeName:e,id:n})=>{if(!this.inclusionModeDefinition)throw new ye("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const i=this.inclusionModeDefinition.namedTypeDefinitions.get(e);i.members||(i.members=new Map),i.members.set(n,{id:n}),U(this.memberIdTypeLookup,n,()=>new Set).add(e)}}else{const i=new Map;i.set(n,{id:n}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:i}),U(this.memberIdTypeLookup,n,()=>new Set).add(e)}})}getById(t){return Q.getInstance().readFromStoreById(t)}async getData(t,e,n){var o,r;if(e.objectType.name&&((o=this.inclusionModeDefinition)!=null&&o.namedTypeDefinitions)&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(e.objectType.name))return[];let i;if(i=t||new K({where:"1=1",outFields:["*"]}),e.parentCompositeLayer.type==="link-chart"){const a=e.parentCompositeLayer,s=this._processingCacheUpdatesLookup.get(e.objectType.name??""),l=i.outFields;l&&l.length===1&&l[0]===F&&i.where==="1=1"||await Promise.all(s??[]);const f=this.sublayerCaches.has(e.objectType.name??"")?Array.from((r=this.sublayerCaches.get(e.objectType.name))==null?void 0:r.values()):[],g=[];return f.forEach(h=>{if(this.relationshipTypeNames.has(e.objectType.name)){h.geometry=a.relationshipLinkChartDiagramLookup.get(h.attributes[e.objectIdField]);const c=this.memberIdTypeLookup.get(h.attributes[fe]),E=this.memberIdTypeLookup.get(h.attributes[ge]),R=this._isEndEntitySpatial(c,h,fe),v=this._isEndEntitySpatial(E,h,ge);h.attributes[ae]=Number(R&&v)}else{h.geometry=a.entityLinkChartDiagramLookup.get(h.attributes[e.objectIdField]);const c=this.geographicLookup.get(e.objectType.name);c&&h.attributes[c.name]?h.attributes[ae]=1:h.attributes[ae]=0}h.attributes[Ne]=h.geometry,g.push(h)}),g}return this.retrieveDataFromService(i,e,n)}async getConnectedRecordIds(t,e,n){const i=[];let o="";const r=this._getNamedTypeIdMapFromNodeIds(t);if(e&&(e==null?void 0:e.length)!==0){for(const g of e)o=o+g+"|";o=o.slice(0,-1)}const a={},s=[];for(const[g,h]of r){const c=`${g}_ids`;a[c]=h,e&&(e==null?void 0:e.length)!==0?s.push(`MATCH (n:${g}) WHERE id(n) IN $${c} WITH n MATCH (n)-[r:${o}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):s.push(`MATCH (n:${g}) WHERE id(n) IN $${c} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!s.length)return i;const l=s.join(" UNION "),f=(await ne(this.knowledgeGraph,new B({openCypherQuery:l,bindParameters:a}),{signal:n==null?void 0:n.signal})).resultRowsStream.getReader();for(;;){const{done:g,value:h}=await f.read();if(g)break;for(let c=0;c<h.length;c++){const E=h[c];i.push({id:E[0],typeName:E[1]}),i.push({id:E[2],typeName:E[3]})}}return i}async getRelationshipsBetweenNodes(t,e,n){const i=this._getNamedTypeIdMapFromNodeIds(t);if(i.size===0)return[];const o={relationshipExclusionIds:e,possibleConnectionEntityIds:t},r=[];for(const[f,g]of i.entries()){const h=`${f}_ids`;o[h]=g,r.push(`MATCH (n:${f}) WHERE id(n) IN $${h} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const a=r.join(" UNION "),s=[],l=(await ne(this.knowledgeGraph,new B({openCypherQuery:a,bindParameters:o}),{signal:n==null?void 0:n.signal})).resultRowsStream.getReader();for(;;){const{done:f,value:g}=await l.read();if(f)break;for(let h=0;h<g.length;h++){const c=g[h];s.push({id:c[0],typeName:c[1]})}}return s}async getRelationshipsFromNodes(t,e,n,i){const o=this._getNamedTypeIdMapFromNodeIds(t);if(o.size===0||e.length===0)return[];const r={relationshipExclusionIds:n,possibleConnectionEntityIds:e},a=[];for(const[h,c]of o.entries()){const E=`${h}_ids`;r[E]=c,a.push(`MATCH (n:${h}) WHERE id(n) IN $${E} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const s=a.join(" UNION "),l=new Map,f=(await ne(this.knowledgeGraph,new B({openCypherQuery:s,bindParameters:r}),{signal:i==null?void 0:i.signal})).resultRowsStream.getReader();for(;;){const{done:h,value:c}=await f.read();if(h)break;for(let E=0;E<c.length;E++){const R=c[E];let v=l.get(R[1]);v||(v=new Set,l.set(R[1],v)),v.add(R[0])}}const g=[];for(const[h,c]of l)for(const E of c)g.push({id:E,typeName:h});return g}async refreshCacheContent(t,e,n,i=!0,o){var f,g,h,c,E,R,v,Z;const r=Q.getInstance(),a=[],s=new Map,l=new Map;(f=this.knowledgeGraph.dataModel.entityTypes)==null||f.forEach(u=>{u.name&&l.set(u.name,u)}),(g=this.knowledgeGraph.dataModel.relationshipTypes)==null||g.forEach(u=>{u.name&&l.set(u.name,u)}),t||this.inclusionModeDefinition?t?t.forEach(u=>{var M;if(this.memberIdTypeLookup.has(u))for(const j of this.memberIdTypeLookup.get(u))s.has(j)?(M=s.get(j))==null||M.push(u):s.set(j,[u])}):(c=(h=this.inclusionModeDefinition)==null?void 0:h.namedTypeDefinitions)==null||c.forEach((u,M)=>{u.useAllData?s.set(M,null):u.members&&u.members.forEach(j=>{var J;s.has(M)&&s.get(M)!==null?(J=s.get(M))==null||J.push(j.id):s.set(M,[j.id])})}):((E=this.knowledgeGraph.dataModel.entityTypes)==null||E.forEach(u=>{u.name&&s.set(u.name,null)}),(R=this.knowledgeGraph.dataModel.entityTypes)==null||R.forEach(u=>{u.name&&s.set(u.name,null)}));for(const[u,M]of s){const j=new Set(M),J=new Promise((Y,pe)=>{(async()=>{var ie,T,b,C,L,N,I,S,w;const G=new Set,z=[];let X,P="",ee=!1;if(e||((T=(ie=l.get(u))==null?void 0:ie.properties)==null||T.forEach(y=>{y.name&&G.add(y.name)})),n&&this.geographicLookup.has(u)){const y=(b=this.geographicLookup.get(u))==null?void 0:b.name;y&&G.add(y)}if(this.entityTypeNames.has(u))P=`MATCH (n:${u}) ${M?"WHERE id(n) IN $ids ":""}return ID(n)`,G.forEach(y=>{P+=`, n.${y}`,z.push(y)});else{if(!this.relationshipTypeNames.has(u))throw new ye("knowledge-graph:layer-data-manager",`The graph type of ${u} could not be determined. Was this type set in the KG data model and inclusion definition?`);ee=!0,P=`MATCH ()-[n:${u}]->() ${M?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,G.forEach(y=>{P+=`, n.${y}`,z.push(y)})}X=new B(M?{openCypherQuery:P,bindParameters:{ids:M}}:{openCypherQuery:P});const de=(await ne(this.knowledgeGraph,X,{signal:o==null?void 0:o.signal})).resultRowsStream.getReader();for(;;){const{done:y,value:H}=await de.read();if(y)break;const _=[];for(let A=0;A<H.length;A++){const W=H[A];let k=0,ue=0;const D={properties:{}};for(D.id=W[k],k++,ue++,ee&&(D.originId=W[k],k++,ue++,D.destinationId=W[k],k++,ue++,U(this.nodeConnectionsLookup,D.originId,()=>new Set).add(D.id),U(this.nodeConnectionsLookup,D.destinationId,()=>new Set).add(D.id),U(this.relationshipConnectionsLookup,D.id,()=>[D.originId,D.destinationId]));k<W.length;k++)D.properties[z[k-ue]]=W[k];j.delete(D.id),_.push(D)}const Ge=r.writeToStore(_,F,(C=this.geographicLookup.get(u))==null?void 0:C.name);this.sublayerCaches.has(u)||this.sublayerCaches.set(u,new Map),i&&!((L=this.inclusionModeDefinition)!=null&&L.namedTypeDefinitions.has(u))&&((N=this.inclusionModeDefinition)==null||N.namedTypeDefinitions.set(u,{useAllData:!1,members:new Map})),i&&!((I=this.inclusionModeDefinition)!=null&&I.namedTypeDefinitions.get(u).members)&&(this.inclusionModeDefinition.namedTypeDefinitions.get(u).members=new Map);const we=this.sublayerCaches.get(u);Ge.forEach(A=>{var W,k;we==null||we.set(A.attributes[F],A),i&&!((W=this.inclusionModeDefinition)!=null&&W.namedTypeDefinitions.get(u).members.has(A.attributes[F]))&&((k=this.inclusionModeDefinition)==null||k.namedTypeDefinitions.get(u).members.set(A.attributes[F],{id:A.attributes[F]}),U(this.memberIdTypeLookup,A.attributes[F],()=>new Set).add(u))})}const te=(S=this.inclusionModeDefinition)==null?void 0:S.namedTypeDefinitions.get(u);if(te)for(const y of j)(w=te.members)==null||w.delete(y)})().then(()=>{Y(null)}).catch(G=>{G.name==="AbortError"?Y(null):pe(G)})});a.push(J),(v=this._processingCacheUpdatesLookup.get(u))==null||v.push(J)}if(await Promise.all(a),(Z=o==null?void 0:o.signal)==null?void 0:Z.aborted)throw Qe()}removeFromLayer(t){var i,o,r;const e=new Set,n=new Set(t.map(a=>a.id));for(const a of t)e.add(a.typeName),((i=this.memberIdTypeLookup.get(a.id))==null?void 0:i.size)===1?this.memberIdTypeLookup.delete(a.id):(o=this.memberIdTypeLookup.get(a.id))==null||o.delete(a.typeName),(r=this.inclusionModeDefinition)==null||r.namedTypeDefinitions.forEach((s,l)=>{var f;l===a.typeName&&((f=s.members)!=null&&f.has(a.id))&&s.members.delete(a.id)});e.forEach(a=>{var s;(s=this.sublayerCaches.get(a))==null||s.forEach((l,f)=>{var g;n.has(f)&&((g=this.sublayerCaches.get(a))==null||g.delete(f))})})}async retrieveDataFromService(t,e,n){var R,v,Z,u,M,j,J,Y,pe,be,G,z,X,P,ee,de,te,ie;const i=Q.getInstance(),o=new Set,r=[];let a,s="",l=[];const f=e.graphType==="relationship",g=(Z=(v=(R=this.inclusionModeDefinition)==null?void 0:R.namedTypeDefinitions)==null?void 0:v.get(e.objectType.name))==null?void 0:Z.useAllData,h=e.parentCompositeLayer.sublayerIdsCache.get(e.objectType.name);let c=!g&&h?Array.from(h).sort():null;if((j=(M=(u=this.inclusionModeDefinition)==null?void 0:u.namedTypeDefinitions)==null?void 0:M.get(e.objectType.name))!=null&&j.useAllData)(pe=(Y=(J=this.inclusionModeDefinition)==null?void 0:J.namedTypeDefinitions)==null?void 0:Y.get(e.objectType.name))!=null&&pe.useAllData&&t.objectIds!=null&&(c=t.objectIds);else if(t.objectIds!=null&&c&&c.length>0){const T=t.objectIds;t.objectIds=c.filter(b=>T.includes(b))}else if(t.objectIds!=null)c=t.objectIds;else{if((be=this.inclusionModeDefinition)!=null&&be.namedTypeDefinitions.has(e.objectType.name)&&(!((G=this.inclusionModeDefinition.namedTypeDefinitions.get(e.objectType.name))!=null&&G.members)||((X=(z=this.inclusionModeDefinition.namedTypeDefinitions.get(e.objectType.name))==null?void 0:z.members)==null?void 0:X.size)<1))return t.objectIds=[],[];t.objectIds=c}if(t.outFields!=null){const T=t.outFields;T.includes("*")?e.fields.forEach(b=>{o.add(b.name)}):T.forEach(b=>{b!==F&&b!==e.geometryFieldName&&o.add(b)})}if(t.geometry!=null){const T=t.geometry;let b;const C=e.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,L=C==null?void 0:C.spatialReference,N=(P=C==null?void 0:C.serviceCapabilities)==null?void 0:P.geometryCapabilities;let I=N==null?void 0:N.geometryMaxBoundingRectangleSizeX,S=N==null?void 0:N.geometryMaxBoundingRectangleSizeY;if(T.type==="point"){let w=T;(ee=w.spatialReference)!=null&&ee.isWGS84||(await Te(w.spatialReference,q),w=he(w,q)),b=new ce({spatialReference:q,xmin:w.x-1e-4,ymin:w.y-1e-4,xmax:w.x+1e-4,ymax:w.y+1e-4})}else(de=T==null?void 0:T.extent)!=null&&de.spatialReference&&!((te=T.spatialReference)!=null&&te.isWGS84)?(await Te(T.extent.spatialReference,q),b=he(T.extent,q)):b=T.extent;if(I&&S&&L){if(L.wkid!==4326){const w=new ce({spatialReference:L,xmax:I,ymax:S}),y=he(w,q);I=y.xmax,S=y.ymax}if(b.xmax-b.xmin>I)throw new ye("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${I}° latitude, limit exceeded`);if(b.ymax-b.ymin>S)throw new ye("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${S}° longitude, limit exceeded`)}if(t.where!=null&&t.where!=="1=1"){const w=await Se(t.where.toUpperCase(),e.fieldsIndex);e.fields.forEach(y=>{w.fieldNames.includes(y.name)&&o.add(y.name)})}s=f?`Match ()-[n:${e.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${e.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${e.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${e.geometryFieldName}) return ID(n)`,e.geometryFieldName&&o.add(e.geometryFieldName),o.forEach(w=>{s+=`, n.${w}`,r.push(w)}),a=new B({openCypherQuery:s,bindParameters:{param_filter_geom:new _e({rings:Ke(b)})}})}else{let T="";if(t.where!=null&&t.where!=="1=1"){const L=await Se(t.where,e.fieldsIndex);e.fields.forEach(y=>{L.fieldNames.includes(y.name)&&o.add(y.name)});const N=new Set(["column-reference","string","number","binary-expression"]),I=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let S=!1;const w=y=>{if(y.type==="column-reference")return`n.${y.column}`;if(y.type==="string")return`'${y.value}'`;if(y.type==="number")return`${y.value}`;if(y.type==="binary-expression"&&N.has(y.left.type)&&N.has(y.right.type)&&I.has(y.operator))return`${w(y.left)} ${y.operator} ${w(y.right)}`;if(y.type==="binary-expression"&&y.operator==="LIKE"){let H="";if(y.left.type==="function"&&y.left.args.value[0].type==="column-reference")H+=`lower(n.${y.left.args.value[0].column})`;else{if(y.left.type!=="column-reference")return S=!0,"";H+=`lower(n.${y.left.column})`}if(H+=" CONTAINS (",y.right.type!=="string")return S=!0,"";{let _=y.right.value;_.charAt(0)==="%"&&(_=_.slice(1)),_.charAt(_.length-1)==="%"&&(_=_.slice(0,-1)),H+=`'${_.toLowerCase()}')`}return H}return S=!0,""};T=w(L.parseTree),S&&(T="")}let b="";b=f?`Match ()-[n:${e.objectType.name}]->()`:`Match (n:${e.objectType.name})`;let C=!1;c&&(C=!0,b+=" WHERE ID(n) IN $ids"),T&&(b+=C?" AND":" WHERE",b+=` ${T}`),b+=" return ID(n)",f&&(b+=", id(startNode(n)), id(endNode(n))"),t.returnGeometry&&e.geometryFieldName&&o.add(e.geometryFieldName),o.forEach(L=>{b+=`, n.${L}`,r.push(L)}),a=new B(c?{openCypherQuery:b,bindParameters:{ids:c}}:{openCypherQuery:b})}const E=(await ne(e.parentCompositeLayer.dataManager.knowledgeGraph,a,n)).resultRowsStream.getReader();for(;;){const{done:T,value:b}=await E.read();if(T)break;const C=[];for(let L=0;L<b.length;L++){const N=b[L];let I=0,S=0;const w={properties:{}};for(w.id=N[I],I++,S++,f&&(w.originId=N[I],I++,S++,w.destinationId=N[I],I++,S++);I<N.length;I++)w.properties[r[I-S]]=N[I];C.push(w)}l=l.concat(i.writeToStore(C,F,(ie=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name))==null?void 0:ie.name))}return l}_isEndEntitySpatial(t,e,n){var i;for(const o of t??[])if(this.entityTypeNames.has(o)){const r=this.geographicLookup.get(o),a=r&&((i=this.sublayerCaches.get(o))==null?void 0:i.get(e.attributes[n]));if(r&&(a!=null&&a.attributes[r.name]))return!0}return!1}_getNamedTypeIdMapFromNodeIds(t){const e=new Map;return t.forEach(n=>{var i;if(this.memberIdTypeLookup.has(n))for(const o of this.memberIdTypeLookup.get(n)){if(!this.entityTypeNames.has(o))return;e.has(o)?(i=e.get(o))==null||i.push(n):e.set(o,[n])}}),e}};p([d()],O.prototype,"knowledgeGraph",void 0),p([d()],O.prototype,"inclusionModeDefinition",void 0),p([d()],O.prototype,"entityTypeNames",void 0),p([d()],O.prototype,"relationshipTypeNames",void 0),p([d()],O.prototype,"geographicLookup",void 0),p([d()],O.prototype,"sublayerCaches",void 0),p([d()],O.prototype,"nodeConnectionsLookup",void 0),p([d()],O.prototype,"relationshipConnectionsLookup",void 0),p([d()],O.prototype,"memberIdTypeLookup",void 0),O=p([Ee("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],O);const $e=at(),Rt=t=>{let e=class extends t{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return p([d($e.fields)],e.prototype,"fields",void 0),p([d($e.fieldsIndex)],e.prototype,"fieldsIndex",void 0),e=p([Ee("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],e),e},_t={initializeLayersFromClientData:async(t,e,n)=>{if(e||(e=[...t.layers,...t.tables].map(r=>r.graphTypeName)),(e==null?void 0:e.length)===0)return;const i=new Map;for(const r of e)i.set(r,xe(t,r));const o=await Ve(t.dataManager.knowledgeGraph,Array.from(i.values()),{requestOptions:{signal:n==null?void 0:n.signal}});for(const r of[...t.layers,...t.tables]){const a=r.objectType.name;if(a==null)continue;const s=o.get(xe(t,a));if(s){const l=JSON.parse(s);l===null||typeof l!="object"||l.hasOwnProperty("showLabels")||(l.showLabels=!1),r.read(l,{origin:"service"})}}}},xe=(t,e)=>t.type==="knowledge-graph"?`${e}/Map`:`${e}/LinkChart/LinkChartSubLayer`;async function ji(t,e,n){return _t.initializeLayersFromClientData(t,e,n)}const ve=["#4a0932","#b31515","#18382e","#a64f1b","#102432","#8c213f","#ed9310","#2c6954","#144d59","#ffc730","#75351e","#454f4b","#78b1c2","#191921","#8f8f82","#9be0c0","#dbb658","#87b051","#11495c","#c43541","#9c5596","#44498b","#ad9d63","#86afb3","#5c98ca","#b0bfa2","#73241f","#b86b53","#d9d78c","#3e756d","#f260a1","#a0d17d","#c27c30","#eb82eb","#ffdf3c","#ffb259","#ab52b3","#3cccb4","#0095ba","#d92b30"],Ot="#8f8f82";function Ft(t){return t<0||t>=ve.length?new Ce(Ot):new Ce(ve[t])}function Gt(t){const e=t.toArray();return new Ze({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,style:"solid",width:.75,color:e},{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:e}]}}]}]}}})}function At(t){let e="ESRI__ID",n=4;for(const i of t)if(i.name){if(i.name.toLowerCase()==="name"){e=i.name;break}i.name.toLowerCase().includes("name")?(e=i.name,n=2):i.fieldType==="esriFieldTypeString"&&n>3&&(e=i.name,n=3)}return e}function Qt(t,e,n){const i={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:"normal"}},o=new V({labelExpressionInfo:new se({expression:n==="ESRI__ID"?`${e}`:`$feature.${n}`}),labelPlacement:"above-center",symbol:new le(i)}),r=new V({labelExpressionInfo:new se({expression:`'${e}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:"center-along",labelPosition:"parallel",repeatLabel:!1,symbol:new le({...i,yoffset:"12px"})});return t==="entity"?[o]:[r]}function Pt(t,e,n){const i={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:"bold"}},o=n==="ESRI__ID"?`${t}`:`$feature.${n}`;return e==="point"?[new V({labelExpressionInfo:new se({expression:o}),labelPlacement:"above-center",symbol:new le(i)})]:e==="polyline"?[new V({labelExpressionInfo:new se({expression:o}),labelPlacement:"center-along",repeatLabel:!0,symbol:new le(i)})]:e==="polygon"?[new V({labelExpressionInfo:new se({expression:o}),labelPlacement:"always-horizontal",symbol:new le(i)})]:null}function x(t){if(!t.json)return t;t.json.write=je(t.json.write);const e=t.json.origins;if(!e)return t;let n;for(n in e){const i=e[n];i&&(i.write=je(i.write))}return t}function je(t){return typeof t=="object"&&t?(t.enabled!==!1&&(t.overridePolicy=Jt(t)),t):t===!0?oe():t}function Jt(t){const{target:e,writer:n,overridePolicy:i,...o}=t;return function(r,a){const s=Oe.call(this,r,a);return s.enabled?{...o,...s}:s}}function oe(){return{overridePolicy:Oe}}function Oe(t,e){const n=!!this.geometryType;let i={enabled:n};return n&&(i={...i,...Fe.call(this,t,e)}),i}function Fe(t,e){return{ignoreOrigin:this.originIdOf(e)>Pe.DEFAULTS}}let m=class extends Rt(yt(gt(ct(lt(wt(Et(pt(It(Xe(it)))))))))){constructor(t){super(t),this.blendMode="normal",this.capabilities=ot(!1,!1),this.charts=null,this.definitionExpression=null,this.displayField="",this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=F,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const e=new MessageChannel;return new et(e.port1,{channel:e,client:{queryFeatures:(n,i={})=>{const o=K.fromJSON(n);return this.queryFeaturesJSON(o,i)}}}),[e.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(t){const e=this._normalizeFeatureReduction(t);this._set("featureReduction",e)}get fields(){var e,n;const t=[];return(n=(e=this.objectType)==null?void 0:e.properties)==null||n.forEach(i=>{const o=i.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":i.fieldType;t.push(me.fromJSON({name:i.name,type:o,alias:i.alias,defaultValue:i.defaultValue,editable:i.editable,nullable:i.nullable}))}),t.push(me.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),me.fromJSON({name:Ie,type:"esriFieldTypeInteger",alias:Ie,editable:!1}),me.fromJSON({name:ae,type:"esriFieldTypeInteger",alias:ae,editable:!1})),t}get geometryType(){var n,i,o;if(((n=this.parentCompositeLayer)==null?void 0:n.type)==="link-chart")return this.graphType==="relationship"?"polyline":"point";const t=(o=this.parentCompositeLayer)==null?void 0:o.dataManager.geographicLookup.get((i=this.objectType)==null?void 0:i.name),e=t==null?void 0:t.geometryType;return e&&e!=="esriGeometryNull"?re.fromJSON(e):null}get geometryFieldName(){var e,n,i;if(((e=this.parentCompositeLayer)==null?void 0:e.type)==="link-chart")return Ne;const t=(i=this.parentCompositeLayer)==null?void 0:i.dataManager.geographicLookup.get((n=this.objectType)==null?void 0:n.name);return(t==null?void 0:t.name)??null}get graphTypeName(){var t;return(t=this.objectType)==null?void 0:t.name}get hasM(){var i,o,r,a;const t=(o=this.parentCompositeLayer)==null?void 0:o.dataManager.geographicLookup.get((i=this.objectType)==null?void 0:i.name),e=t==null?void 0:t.name,n=e?(a=(r=this.objectType)==null?void 0:r.properties)==null?void 0:a[e]:null;return(n==null?void 0:n.hasM)??!1}get hasZ(){var i,o,r,a;const t=(o=this.parentCompositeLayer)==null?void 0:o.dataManager.geographicLookup.get((i=this.objectType)==null?void 0:i.name),e=t==null?void 0:t.name,n=e?(a=(r=this.objectType)==null?void 0:r.properties)==null?void 0:a[e]:null;return(n==null?void 0:n.hasZ)??!1}set labelingInfo(t){this._set("labelingInfo",t)}get labelingInfo(){if(this._isOverridden("labelingInfo"))return this._get("labelingInfo");const t=this.objectType.properties?At(this.objectType.properties):"ESRI__ID";return this.parentCompositeLayer.type==="link-chart"?Qt(this.graphType,this.graphTypeName,t):Pt(this.graphTypeName,this.geometryType,t)}set renderer(t){Je(t,this.fieldsIndex),this._set("renderer",t)}get renderer(){var o,r,a,s;if(this._isOverridden("renderer"))return this._get("renderer");const t=(a=(r=(o=this.parentCompositeLayer)==null?void 0:o.dataManager)==null?void 0:r.knowledgeGraph)==null?void 0:a.dataModel,e=[...(t==null?void 0:t.entityTypes)??[],...(t==null?void 0:t.relationshipTypes)??[]].map(l=>l.name).indexOf(this.graphTypeName),n=Ft(e);if(((s=this.parentCompositeLayer)==null?void 0:s.type)==="link-chart"){if(this.graphType==="relationship")return new $t({type:"simple",symbol:Gt(n)});const l=ke(Le(re.toJSON("point")).renderer);return De(l.symbol,n),l}const i=ke(Le(re.toJSON(this.geometryType)).renderer);return De(i.symbol,n),i}get spatialReference(){var t,e,n,i;return((i=(n=(e=(t=this.parentCompositeLayer)==null?void 0:t.dataManager)==null?void 0:e.knowledgeGraph)==null?void 0:n.dataModel)==null?void 0:i.spatialReference)??qe.WGS84}set timeInfo(t){this._set("timeInfo",t)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(t){this._set("title",t)}writeTitle(t,e){e.title=t??"Layer"}createPopupTemplate(t){return jt(this,t)}createQuery(){return new K({where:"1=1",outFields:["*"]})}getField(t){return this.fieldsIndex.get(t)}getFieldDomain(t,e){return null}async queryFeatures(t,e){await this.load();const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(t),o=vt.fromJSON(await i.executeQuery(n.toJSON(),e==null?void 0:e.signal));return o.features.forEach(r=>{r.sourceLayer=this}),o}async queryFeaturesJSON(t,e){await this.load();const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(t);return await i.executeQuery(n.toJSON(),e==null?void 0:e.signal)}async queryFeatureCount(t,e){await this.load();const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(t);return i.executeQueryForCount(n.toJSON(),e==null?void 0:e.signal)}async queryExtent(t={},e){var s,l,f,g;await this.load();const n={...t,returnGeometry:!0},{resolvedQuery:i,queryEngine:o}=await this._setupQueryObjects(n),r=await o.executeQueryForExtent(i.toJSON(),e==null?void 0:e.signal);let a;return a=((s=r.extent)==null?void 0:s.xmin)!=null&&((l=r.extent)==null?void 0:l.xmax)!=null&&((f=r.extent)==null?void 0:f.ymin)!=null&&((g=r.extent)==null?void 0:g.ymax)!=null?new ce(r.extent):new ce,{count:r.count,extent:a}}async queryObjectIds(t,e){await this.load();const n=K.from(t);let i;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const o=await this.parentCompositeLayer.dataManager.getData(n,this,e);i=this.loadQueryEngine(o)}return await i.executeQueryForIds(n.toJSON(),e==null?void 0:e.signal)}loadQueryEngine(t){var i;const e=new nt({geometryType:re.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),n=new rt({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:re.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:(i=this.timeInfo)==null?void 0:i.toJSON(),featureStore:e});return n.featureStore.addMany(t),n}async refreshCachedQueryEngine(){const t=await this.parentCompositeLayer.dataManager.getData(new K({where:"1=1",outFields:[F]}),this);this._cachedQueryEngine=this.loadQueryEngine(t)}load(t){return this.addResolvingPromise(this.parent.load(t).then(()=>He(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(t,e){var r;const n=K.from(t),i=n.geometry;if(i&&!((r=i.spatialReference)!=null&&r.isWGS84)&&(await Te(i.spatialReference,q),n.geometry=he(i instanceof _e||i instanceof We||i instanceof Ue?i:i.extent,q)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)return{resolvedQuery:n,queryEngine:this._cachedQueryEngine};const o=await this.parentCompositeLayer.dataManager.getData(n,this,e);return{resolvedQuery:n,queryEngine:this.loadQueryEngine(o)}}};p([d(x($(dt)))],m.prototype,"blendMode",void 0),p([d()],m.prototype,"capabilities",void 0),p([d({json:{origins:{"web-scene":{write:!1}},write:oe()}})],m.prototype,"charts",void 0),p([d({readOnly:!0})],m.prototype,"defaultPopupTemplate",null),p([d({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],m.prototype,"definitionExpression",void 0),p([d()],m.prototype,"displayField",void 0),p([d(x($(mt)))],m.prototype,"displayFilterEnabled",void 0),p([d(x($(ht)))],m.prototype,"displayFilterInfo",void 0),p([d(x($(ut)))],m.prototype,"effect",void 0),p([d()],m.prototype,"elevationInfo",void 0),p([d(x($(ft)))],m.prototype,"featureEffect",void 0),p([d(x($(bt)))],m.prototype,"featureReduction",null),p([d()],m.prototype,"fields",null),p([d()],m.prototype,"geometryType",null),p([d()],m.prototype,"geometryFieldName",null),p([d({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],m.prototype,"graphType",void 0),p([d({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],m.prototype,"graphTypeName",null),p([d()],m.prototype,"hasM",null),p([d()],m.prototype,"hasZ",null),p([d({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],m.prototype,"id",void 0),p([d({type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],m.prototype,"labelsVisible",void 0),p([d({type:[V],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:Ht,write:oe()}})],m.prototype,"labelingInfo",null),p([d({readOnly:!0,json:{read:!1,write:{writer(t,e){var n;switch((n=this.parentCompositeLayer)==null?void 0:n.type){case"link-chart":e.layerType="LinkChartSubLayer";break;case"knowledge-graph":e.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],m.prototype,"layerType",void 0),p([d(x($(St)))],m.prototype,"legendEnabled",void 0),p([d(x($(Mt)))],m.prototype,"maxScale",void 0),p([d(x($(Lt)))],m.prototype,"minScale",void 0),p([d()],m.prototype,"objectIdField",void 0),p([d()],m.prototype,"objectType",void 0),p([d(x($(Ct)))],m.prototype,"opacity",void 0),p([d(x($(Tt)))],m.prototype,"orderBy",void 0),p([d({clonable:!1})],m.prototype,"parent",void 0),p([d()],m.prototype,"parentCompositeLayer",void 0),p([d(x($(kt)))],m.prototype,"popupEnabled",void 0),p([d({type:Ye,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],m.prototype,"popupTemplate",void 0),p([d({type:Number,json:{write:{overridePolicy:Fe}}})],m.prototype,"refreshInterval",void 0),p([d({types:xt,json:{name:"layerDefinition.drawingInfo.renderer",write:oe()}})],m.prototype,"renderer",null),p([d()],m.prototype,"source",void 0),p([d()],m.prototype,"spatialReference",null),p([d({type:Dt,json:{name:"layerDefinition.timeInfo",write:!0,origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:!0},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:!0}}}})],m.prototype,"timeInfo",null),p([d({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],m.prototype,"title",null),p([tt("title")],m.prototype,"writeTitle",null),p([d({json:{read:!1}})],m.prototype,"type",void 0),p([d(x($(Nt)))],m.prototype,"useViewTime",void 0),p([d({type:Boolean,json:{name:"visibility",write:oe()}})],m.prototype,"visible",void 0),m=p([Ee("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],m);const Ri=m;function Ht(t,e,n){var o,r;const i=[["ESRI__AGGREGATION_COUNT",Ie],["ESRI__ORIGIN_ID",fe],["ESRI__DESTINATION_ID",ge],["ESRI__LAYOUT_GEOMETRY",Ne]];try{for(const a of t)for(const[s,l]of i)a.labelExpression=(o=a.labelExpression)==null?void 0:o.replaceAll(s,l),(r=a.labelExpressionInfo)!=null&&r.expression&&(a.labelExpressionInfo.expression=a.labelExpressionInfo.expression.replaceAll(s,l))}catch(a){Re.getLogger(this).warn("Error updating labelingInfo",a)}return st(t,e,n)}export{O as E,Ri as S,ji as i,Q as o};
