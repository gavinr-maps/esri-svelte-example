const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./TileLayerView3D-CrvnaR3F.js","./tslib.es6-B3Jf3DVX.js","./subclass-BZA_h8Db.js","./projection-B971H0Re.js","./index-Bh2oEzTI.js","./index-2kwcjS9-.css","./Accessor-BLX9ikPh.js","./SimpleObservable-KocWTzVy.js","./vec3f64-BLpZdpfb.js","./Point-Cg0-ChZE.js","./cast-Bjksrh93.js","./writer-DNAwXnhG.js","./assets-C43MgM-v.js","./jsonMap-0cxwUWs2.js","./Extent-Bf3YTe7m.js","./Polyline-D9YkgmM_.js","./mathUtils-C4_ghTv4.js","./projectBuffer-Bs7GwaPY.js","./geodesicConstants-DWQLYX7F.js","./LayerView3D-Dkb0AiwM.js","./reactiveUtils-C5zUhJQJ.js","./asyncUtils-CWX51uTe.js","./Collection-CEdjem1-.js","./Evented-BHRw9x22.js","./shared-B3wH2qpO.js","./heightModelInfoUtils-C6gW75mB.js","./HeightModelInfo-9nOoV6LU.js","./arcgisLayerUrl-BX1FE5Hm.js","./persistableUrlUtils-fa1mAujs.js","./TiledLayerView3D-pcJE9SYU.js","./LineCallout.glsl-C1R4fy2f.js","./vec2f64-miziP1SN.js","./vec32-Dvg_eL9J.js","./common-DQOJ18NT.js","./plane-IENfwZlB.js","./vec42-YcqnINSP.js","./mat3f64-BBpwCtoL.js","./mat4f64-Dk4dwAN8.js","./quatf64-CCm9z-pX.js","./vec4f64-o2zAXfmz.js","./mathUtils-BG-eq9fO.js","./symbols-CNimns--.js","./enumeration-Ba5njXdz.js","./fieldUtils-tmQlKvWo.js","./intl-CChhNOV8.js","./date-DlqISzcw.js","./locale-C9TlLpzi.js","./messages-OmQvZhAg.js","./geometry-D964gYQX.js","./TextSymbol-D8QO_KUV.js","./Color-BCS62Hs5.js","./colorUtils-0bJDPow9.js","./screenUtils-_ZIvrt5o.js","./materialUtils-DarhapKC.js","./opacityUtils-C68Tlu6_.js","./aaBoundingBox-BE7cC1jD.js","./collectionUtils-D_lHIu88.js","./Portal-C10FKnaA.js","./Loadable-BabW5Xcc.js","./Promise-B2Hu02L7.js","./Clonable-D3rtuBWg.js","./mat4-GpOFENPA.js","./computeTranslationToOriginAndRotation-Q27G6TBL.js","./RibbonLine.glsl-BZu1FDpE.js","./dehydratedFeatureUtils-B--Sgpdi.js","./sphere-C77djCO6.js","./mat3-BRl2i9Bz.js","./ViewingMode-Dodu7ZZk.js","./intersectorUtils-BK9EUwUf.js","./boundedPlane-EV1sS2Ke.js","./lineSegment-D7sKPPYf.js","./verticalOffsetUtils-BDQLpfho.js","./orientedBoundingBox-DOAJUK5g.js","./quat-4pa1e6ds.js","./spatialReferenceEllipsoidUtils-DBE_OFra.js","./ElevationProvider-C95wyCKc.js","./VertexAttribute-Cq4MnHjR.js","./unitConversionUtils-BMfW9yAe.js","./lengthUtils-DL1-FDQQ.js","./hydratedFeatures-DBKLr8hT.js","./Graphic-DsxsIjhH.js","./PopupTemplate-BHMhS05j.js","./ActionToggle-iT4slXc7.js","./Identifiable-B1UbsKNt.js","./jsonUtils-CEfjT-BK.js","./projectVectorToVector-G2uWGoIb.js","./projectPointToVector-GINIbYMz.js","./Material-_xx7OZxD.js","./interfaces-DDtDqZYj.js","./Texture-Fac_8AOC.js","./BindType-BmZEZMMh.js","./Util-BIfApRF5.js","./Texture-Begq2x5n.js","./enums-D9v74xTE.js","./renderState-DQLu6AJX.js","./Matrix3DrawUniform-CiBFaSz6.js","./compilerUtils-Dw3R0f-Z.js","./vec2-maR1OrZI.js","./ShaderTechniqueConfiguration-CBbn2DCi.js","./Indices-DflDlU4Z.js","./triangle-PTGDC_xJ.js","./AlphaCutoff-UcccL64p.js","./requestImageUtils-DgMiQwsm.js","./sdfPrimitives-CUWZbMRe.js","./vec3f32-nZdmKIgz.js","./doublePrecisionUtils-B0owpBza.js","./floatRGBA-CfH_2xsy.js","./Octree-C8d4sqjv.js","./frustum-CQrOepbv.js","./InterleavedLayout-e-di2fxs.js","./BufferView-_QDXRCew.js","./Float4DrawUniform-N58YDhuZ.js","./graphicUtils-CWEFaVJb.js","./VertexColor.glsl-_ARMpsAT.js","./meshVertexSpaceUtils-CXzOFlTI.js","./MeshLocalVertexSpace-LEHwMUnu.js","./vec2f32-BbH2jxlN.js","./dehydratedFeatures-BiOblf0d.js","./quantizationUtils-uj_P09aO.js","./Field-ybkHhtnK.js","./fieldType-BuzM0UHS.js","./featureConversionUtils-D14h8iad.js","./OptimizedFeature-6cJ-QFG5.js","./OptimizedGeometry-BF8iz5FO.js","./OptimizedFeatureSet-Blu9Ckm7.js","./edgeUtils-BUKTgPFR.js","./DecodeSymbolColor.glsl-BPIX0fAF.js","./RealisticTree.glsl-CAmeC2w1.js","./DefaultMaterial-DgOvtNL9.js","./Scheduler-CJu5awNf.js","./signal-D4lghLjV.js","./debugFlags-BF6Z0j0F.js","./terrainUtils-CPZNZdjg.js","./layerUtils-BrNoooE9.js","./TileInfo-Dphjf6xH.js","./TileKey-DZd6gJy7.js","./layerViewUtils-DhFEu8Rd.js","./fetchTile-_oldERW-.js","./RefreshableLayer-D7lXUJRS.js","./layerContainerType-C5CzMsLd.js","./LayerView-CGYm21KA.js","./UpdatingHandles-GfwcIh5z.js","./RefreshableLayerView-BVliPdnr.js","./MapServiceLayerViewHelper-DgpEHijA.js","./languageUtils-JGnUBrxZ.js","./TimeOnly-DOn_Hy89.js","./UnknownTimeZone-BkowvBs8.js","./ImmutableArray-BPVd6ESQ.js","./shared-OyXfj1UM.js","./number-CUaGJe2K.js","./Query-5Xpquc1r.js","./DataLayerSource-BKkswDvG.js","./FullTextSearch-Csd1Hktu.js","./TimeExtent-DocT5yPf.js","./timeUtils-8fb_2oAt.js","./scaleUtils-D_Nw3nhM.js","./floorFilterUtils-DZ5C6FQv.js","./drapedUtils-HWKOCxgF.js","./normalizeUtils-EVmAQ-ak.js","./normalizeUtilsCommon-dT81xWiM.js","./utils-6jMaHUrH.js","./utils-Bema0iXE.js","./sublayerUtils-DEyYrAdA.js","./highlightUtils-BYmbiZ48.js","./popupUtils-BaLxn3kI.js","./Viewpoint-C4FqWA2d.js","./Cyclical-oTUX3aX7.js","./jsxFactory-CJa39Fro.js","./uuid-fwrPAdZb.js","./workers-D4HfeYKj.js","./Queue-yu3bZ02p.js","./GraphicsCollection-FfahqxsR.js","./RenderCoordsHelper-C50UGjbb.js","./projectVectorToPoint-DcLtSZYw.js","./DefaultUI-C0utm694.js","./InputManager-Ba9xzDpe.js","./Map-iWpb5DpI.js","./Basemap-DVYOaWHz.js","./loadAll-B6mYSptb.js","./PortalItem-DzgXrpyc.js","./writeUtils-Dz7BsE1e.js","./Ground-CAIVlzbd.js","./CollectionFlattener-CQN6i8ZK.js","./editableLayers-Cn9dHzhB.js","./catalogUtils-DyGHPM81.js","./basemapUtils-B9TjOm47.js","./utils-93yNk4Xc.js","./mat4f32-DcsiF_Rp.js","./TablesMixin-5umgS75f.js","./Layer-CVt7Hb5J.js","./ReactiveMap-6CfRGOlR.js","./selectionUtils-DYi6daQO.js","./IViewEvents-Bci6PjlS.js","./interfaces-D6pIddIh.js","./screenUtils-WcqhHU65.js","./a11yUtils-cyWndM8Q.js","./HighlightDefaults-D4ckYWWJ.js","./imageUtils-CtmzXUTE.js","./capabilities-A2uoe7dc.js","./themeUtils-C3zvZbsE.js","./globalCss-CZa70j6i.js","./accessibleHandler-hWbBTR_7.js","./CompassViewModel-C7G3VWNL.js","./utils-DsJqvptN.js","./GoTo-Wtu9mgoE.js","./NavigationToggle-BIWeotJk.js","./ZoomViewModel-oUfjVFgI.js","./viewpointUtils-Bq9TFP4R.js","./earthUtils-ByXwmaX5.js","./spatialReferenceSupport-yRFduOSO.js","./ElevationSamplerData-DF8Bl6I9.js","./OverlayCompositing.glsl-CiE3Tt8y.js","./MergedRenderer-Dli9s1X5.js","./VertexArrayObject-lPxPk5E-.js","./NestedMap-GuqgquCN.js","./glUtil-D0YUa0ow.js","./VertexElementDescriptor-BOD-G50G.js","./axisAngleDegrees-Ci2HA7Jo.js","./weather-eV4wTXCK.js","./BufferObject-BVi1lwBq.js","./Intersector-wXoCuQ8W.js","./Program-mfcb06fW.js","./ShadowCastVisualizeTechniqueConfiguration-Bb-Uir0o.js","./Environment-BDo9QJi6.js","./Compositing.glsl-DMM7CJmu.js","./Blit-B-VutIER.js","./unitFormatUtils-CZ2bRlFg.js","./ByteSizeUnit-BsxeN7wM.js","./quantityUtils-D0GB2dMc.js","./ZoomMomentumEstimator-DA-HeSfK.js","./HUDMaterial.glsl-D6WRipwF.js","./labelFormatUtils-DFKxfrJb.js","./labelUtils-B8petyBk.js","./NormalUtils.glsl-DwmdcsLR.js","./fontUtils-BKHqaMFz.js","./LodRenderer-EVrH9dsH.js","./Intersector-BQ92CPLA.js","./FeaturePipelineRenderManager-DjjUkvYY.js","./elevationInfoUtils-BC_66_Fg.js","./ElevationQueryTileCache-D4sXpJpw.js","./LayerConstants-B33OP6sh.js","./intersectorUtilsConversions-D_fcRVdX.js","./ElevationRange-BrgM1moX.js","./hitTestSelectUtils-UXJPjatw.js","./MemCache-Dx1v3xLC.js","./vec33-DUxPafiq.js","./Version-BSlAgupz.js","./Normals-DzBXR8Bg.js","./TileStrategy-DT04gaWW.js","./TileKey-Cs1awCRX.js","./QueueProcessor-DZiVr5XH.js","./RenderableTile-Dl7jrqnB.js","./config-MDUrh2eL.js","./StyleDefinition-BTt_i6C1.js","./enums-CmIX1y88.js","./enums-BRzLM11V.js","./GeometryUtils-Dyjqugo6.js","./DefaultVertexAttributeLayouts-PrbBmwty.js","./DisplayObject-DGZ6h7sV.js","./resources-CLJpJAXm.js","./colorUtils-aL8wj-8G.js","./vec3-kbEkneOB.js","./ShaderTechniqueRepository-hTzew41Z.js","./testSVGPremultipliedAlpha-uTaDUvFS.js","./RenderingContext-C2W2PIoX.js","./ProgramCache-BcuuBWLJ.js","./ElevationLayerView3D-DET2ewxW.js","./LercDecoder-fMWPataJ.js","./WorkerHandle-T1sH-Myb.js","./BaseDynamicLayerView3D-CJS9qY7F.js","./DynamicLayerView3D-D11gbUHt.js","./projectExtentUtils-BJX_ptLZ.js","./geometryServiceUtils-C6Kg3Uew.js","./project-DlMfXva8.js","./ImageMaterial.glsl-toQN6zid.js","./DefaultLayouts-BuE1efcQ.js","./TriangleMaterial-BiHR3MKx.js","./BuildingSceneLayerView3D-D5tmOQKT.js","./BuildingGroupSublayer-CjfizLnN.js","./BuildingComponentSublayer-BK6r0wKX.js","./ClassBreaksRenderer-BuHwSyVK.js","./UniqueValueRenderer-BQtAHUSo.js","./diffUtils-BP7jmOAy.js","./colorRamps-pKd7I5WZ.js","./SizeVariable-936USOrb.js","./sizeVariableUtils-Cmcuvw-4.js","./visualVariableUtils-DX1kS9Se.js","./ColorStop-Dk3U5tCk.js","./jsonUtils-Ds2Sqto-.js","./defaults-DZ1kfMRx.js","./defaultsJSON-GKolV7NZ.js","./RendererLegendOptions-B-4se3aU.js","./styleUtils-BYTm14n3.js","./jsonUtils-DxpLMo6d.js","./LRUCache-B_PHMSGm.js","./FieldsIndex-DpwHKAMX.js","./OverrideHelper-ti072FkP.js","./utils-D2PLyMFF.js","./HeatmapColorStop-BJc5nbwr.js","./heatmapUtils-Dwiv9IEa.js","./SimpleRenderer-BV2L9G_n.js","./FeatureLayer-wa_7EIxE.js","./MultiOriginJSONSupport-B5nfqtQh.js","./FeatureLayerBase-Ck7-w8TE.js","./formUtils-ylzKAM7E.js","./commonProperties-CPyIG_-u.js","./ElevationInfo-CA5m_tHv.js","./AttributeTableTemplate-BZeVyq-j.js","./featureLayerUtils-DBsQMhTm.js","./featureQueryAll-DnVoEjkM.js","./AttachmentQuery-BUlkjzkx.js","./RelationshipQuery-DPPNeuLK.js","./LayerFloorInfo-CIQjg5Vk.js","./Relationship-COPq3qM4.js","./serviceCapabilitiesUtils-DAE5z8FP.js","./editsZScale-Bs7_pSzI.js","./queryZScale-w66xFVGx.js","./FeatureSet-BHEkYP03.js","./APIKeyMixin-Di9kcRBS.js","./ArcGISService-B5qxetOY.js","./BlendLayer-CXM4n_Ge.js","./jsonUtils-CSnQD004.js","./parser-CTsgEym6.js","./CustomParametersMixin-B4u7wiBT.js","./EditBusLayer-DoTks2sU.js","./FeatureEffectLayer-CpM66wLd.js","./FeatureEffect-BEzQmzeC.js","./FeatureFilter-BMHRQSxq.js","./FeatureReductionLayer-Ddbk727V.js","./FeatureReductionSelection-7vaL4DYT.js","./labelingInfo-DYPSPZCH.js","./MD5-C9MwAd2G.js","./OperationalLayer-CVyVfSPu.js","./OrderedLayer-C5VLMHgA.js","./OrderByInfo-IYmS1EXF.js","./PortalLayer-CKja4bdW.js","./portalItemUtils-BzVoFAku.js","./ScaleRangeLayer-Bb8Ig1Hz.js","./TemporalLayer-Dpq2hKKV.js","./TimeInfo-LUiaSFyX.js","./TimeInterval-CNlkea1s.js","./FeatureTemplate-CssMa1yk.js","./FeatureType-C0q_coeM.js","./fieldProperties-Cgxj08ZE.js","./versionUtils-CQ_WhYSP.js","./styleUtils-KMFBtb6u.js","./popupUtils-BBuPGAHd.js","./interfaces-CL2NbQte.js","./capabilities-Y9lFlGVh.js","./I3SIndexInfo-CzWbq05q.js","./I3SLayerDefinitions-BZ_CeKMl.js","./I3SUtil-BALmNw_P.js","./I3SBinaryReader-D1r70N_w.js","./WhereClause-BNiy948d.js","./I3SMeshView3D-BgdxgRIr.js","./Transform-7wmboOkN.js","./RenderTexture-CDO7DfmT.js","./I3SOverrides-CoXeuGic.js","./resourceUtils-B0XGoEvl.js","./I3SNode-DvnboJA7.js","./ReactiveSet-BU2iaegS.js","./meshFeatureSet-CeeA_du7.js","./Mesh-Dq3yHM_F.js","./MeshComponent-C3VFvn4B.js","./meshProperties-C4iW0Ukm.js","./MeshTransform-D2t3aEmK.js","./MeshVertexAttributes-BgxxMxrG.js","./triangulationUtils-DWWEtF_0.js","./earcut-Lltz9D9k.js","./deduplicate-DIJK2kGw.js","./vertexSpaceConversion-CPh5QK5U.js","./vec4-BpYqBTK4.js","./External-B2-Xb0PD.js","./infoFor3D-C0hFfS1m.js","./meshFeatureAttributes-ch2d0Ntd.js","./SceneModification-CtZuw6Xr.js","./persistable-DjaiFmiM.js","./multiOriginJSONSupportUtils-C0wm8_Yw.js","./resourceExtension-D8MnQ6oV.js","./ExtentSet-BhWFQ8Zv.js","./rendererConversion-CcWsy4Z5.js","./optimizedFeatureQueryEngineAdapter-BOPMFOve.js","./centroid-DdLmOD72.js","./PooledRBush-D7s4d_Fs.js","./quickselect-QQC62dOK.js","./SceneLayerWorker-BKtczrfS.js","./attributeUtils-Dc8--CBJ.js","./makeScheduleFunction-CggzEh3c.js","./I3SQueryFeatureStore-DVD1aleg.js","./TemporalSceneLayerView-D_Uh4zcF.js","./timeSupport-T1g9-JyG.js","./queryUtils-O-WFKoZd.js","./json-Wa8cmqdu.js","./timeSupport-CXKPoROL.js","./timeUtils-BnYjW4Rc.js","./utils-BpB3MnW1.js","./tagSymbols-BPcGfZon.js","./QueryEngine-DrzbS-Dm.js","./QueryEngineCapabilities-DjYb9CEb.js","./utils-Bh2cHa3t.js","./utils-BwQ00KBJ.js","./utils-rwwdQ1Ui.js","./ClassBreaksDefinition-CS8Z_VNX.js","./SnappingCandidate-O5eRSE6e.js","./CatalogLayerView3D-BtJvfOdv.js","./CatalogLayerView-CS_p-h1f.js","./CatalogDynamicGroupLayerView3D-Da0LJGIt.js","./CatalogDynamicGroupLayerView-BoSKVbyH.js","./CatalogFootprintLayerView3D-DVfFiaqr.js","./FeatureLayerViewBase3D-BZHLCvNd.js","./HeatmapDensity.glsl-BkA5uXmE.js","./dehydratedFeatureComparison-06VFTqH5.js","./utils-Ce7L3imC.js","./cimSymbolUtils-DXvZxabN.js","./queryForSymbologySnapping-KE3-mimJ.js","./Graphics3DFeatureProcessor-BY1APY3j.js","./hash-CcEbRgUF.js","./renderingInfoUtils-DAsRBUXK.js","./Graphics3DObjectStates-DLTNWJbN.js","./FeatureStore-Dr0GQdbp.js","./BoundsStore-BhV7QrYA.js","./heatmapTextureUtils-DJXJBog1.js","./query-Dw-gv3BA.js","./pbfQueryUtils-B0fU-MiS.js","./pbf-BtDZ1BpD.js","./EventedSet-CCZpNUPJ.js","./FeatureLayerView-DOc7IdzL.js","./CatalogFootprintLayerView-DwEB2R3l.js","./CSVLayerView3D-h3Cwsuuc.js","./DimensionLayerView3D-D7Ttabms.js","./FeatureLayerView3D-Cs3MpqGy.js","./FocusAreaLayerView3D-DI4OV6Gr.js","./Graphics3DExtrudeSymbolLayer-DKsUjopW.js","./GeoJSONLayerView3D-eVZkiKXS.js","./GraphicsLayerView3D-DNNmqDUu.js","./GraphicsProcessor-CRgvUk3O.js","./GroupLayerView-oNFJZ3OU.js","./ImageryLayerView3D-BJy7V5nj.js","./ImageryLayerView-CNV-g8kh.js","./IntegratedMeshLayerView3D-BzP3tS51.js","./IntegratedMesh3DTilesLayerView3D-YpTU0-hZ.js","./ILyr3DWasmPerSceneView-KC8PJi3s.js","./LineOfSightLayerView3D-CYKsBibS.js","./MapImageLayerView3D-g-gm5_id.js","./MapImageLayerView-DyhmJE-L.js","./ExportImageParameters-D2m0BUqR.js","./MediaLayerView3D-BRpI8cw6.js","./perspectiveUtils-DUm6VYra.js","./normalizeUtilsSync-BUrHV6iS.js","./mat2d-D9DBP-jx.js","./mat2df64-CBKYtunK.js","./keybindings-DoOdil3D.js","./SnappingManagerPool-CewNAGGP.js","./SnappingManager-BJPyuu7J.js","./geodesicUtils-FCYOaNwu.js","./geometry2dUtils-DdyQE7AQ.js","./viewUtils-DrPohWV3.js","./MediaLayerView-Bo-1OY3C.js","./OGCFeatureLayerView3D-DeDb95nh.js","./OGCFeatureLayerView-Bc1jM4So.js","./PointCloudLayerView3D-qA4xyZdQ.js","./PointCloudWorkerUtil-BMHmT1-d.js","./PointCloudUniqueValueRenderer-CiNZlN7O.js","./PopupSceneLayerView-DLoyiTmg.js","./ViewshedLayerView3D-DXKShm0x.js","./VoxelLayerView3D-D8rJBUZw.js","./VoxelGraphic-5QgTpebs.js","./RouteLayerView3D-5aW7a_rW.js","./RouteInfo-rv88L0ho.js","./networkEnums-Be43aAGx.js","./Stop-6kXbZ9Pk.js","./SceneLayerView3D-BUZFH02A.js","./SceneLayerView-D0WPx7Fp.js","./SceneLayerGraphicsView3D-CQxNJ0CW.js","./StreamLayerView3D-DkumgHJH.js","./StreamFeatureManager-CcWkr8oc.js","./CircularArray-CujHzHWW.js","./createConnection-CCcalz4a.js","./StreamLayerView-3-MkXhr3.js","./ImageryTileLayerView3D-B7qA3qC-.js","./rasterProjectionHelper-Cyb7j9c9.js","./rasterUtils-jq3RMBD1.js","./ImageryTileLayerView-CZ8hJ3FI.js","./VectorTileLayerView3D-B3GFwrUd.js","./TileInfoViewPOT-O-uCyzFw.js","./Rect-CUzevAry.js","./rasterizingUtils-xGBMUAML.js","./constants-F8oTIn7N.js","./WGLBrushVTLSymbol-jiuyIxHa.js","./definitions-DfvbPdMm.js","./VTLMaterialManager-B10yUbF1.js","./ShaderCompiler-G2XYGDs6.js","./programUtils-CwiKxPbA.js","./StyleRepository-B0FilPGd.js","./unitBezier-BX6NeAEr.js","./WFSLayerView3D-D6bRl2kF.js","./WMSLayerView3D-zQSDkp1k.js","./WMSLayerView-uR8DrC8v.js","./ExportWMSImageParameters-BMrYvLms.js","./WMTSLayerView3D-C4RrsnCH.js","./AreaMeasurementAnalysisView3D-C3deOagp.js","./defaultUnit-_T4IY-sW.js","./getDefaultUnitForView-Ce2vZZap.js","./AnalysisView3D-BBHxe6zf.js","./interfaces-js1RL7O8.js","./measurementUtils-r7d11TSK.js","./geodesicAreaMeasurementUtils-BILXFcc4.js","./geometryEngine-DGiYLHJy.js","./geometryEngineBase-yFIvKOkM.js","./_commonjsHelpers-DCkdB7M8.js","./hydrated-C9rxSL4a.js","./geodesicMeasurementUtils-Bt9h4589.js","./euclideanAreaMeasurementUtils-CfO9bFtV.js","./quantityFormatUtils-CX8UdSzC.js","./geodesicLengthMeasurementUtils-he3vjGJN.js","./LineVisualElement-mUtX7dGi.js","./Object3DVisualElement-BVfa8i_P.js","./VisualElement-Bz1W-x8t.js","./line-CML3g7Ng.js","./EditGeometryOperations-Cl8Sbfxr.js","./Segment-DZGyf3mS.js","./TextOverlayItem-zxgmE06K.js","./lineStippleUtils-C89mzWlO.js","./DimensionAnalysisView3D-Dbl80QUU.js","./LengthDimension-D9TQS3Kc.js","./automaticLengthMeasurementUtils-BXgXm1JY.js","./RenderObject-CuwfmXYe.js","./ColorMaterial.glsl-BF1fDRqL.js","./dragEventPipeline3D-BzC_kbE1.js","./InteractiveToolBase-vg6J8uyT.js","./memoize-DsJmrG76.js","./Factory-Bm3bRF5y.js","./SnappingVisualizer3D-BL4wyEeI.js","./ExtendedLineVisualElement-BaVIzd5h.js","./EngineVisualElement-DAbK0X3b.js","./LaserlineVisualElement-CUgS0u0n.js","./LaserlinePath.glsl-CV6hrJ4l.js","./RightAngleQuadVisualElement-9e1qCkJI.js","./SnappingVisualizer-BtjTdiTG.js","./PointSnappingHint-D7X20mlb.js","./VerticesVisualElement-B1xfXpYJ.js","./SnappingContext-lR2hMWGP.js","./SnappingDragPipelineStep-rzVcndp8.js","./SnappingOperation-CaI4DIP4.js","./ShadedColorMaterial.glsl-BhqCcqcp.js","./ToolIntersector-LAq5Sd_3.js","./LineMarker.glsl-C-3AQmcq.js","./analysisViewUtils-E34vvAuK.js","./DirectLineMeasurementAnalysisView3D-BAVm5ASh.js","./interfaces-CjSZqm0S.js","./LineOfSightAnalysisView3D-BeFpWkAO.js","./featureReferenceUtils-DBGXy8CW.js","./LineOfSightAnalysisTarget-Czs0z8lJ.js","./manipulatorUtils--FgdKArx.js","./SliceAnalysisView3D-BqYAO0fU.js","./SlicePlane-CdDvBULA.js","./SlicePlaneMaterial.glsl-CvGYpiku.js","./sliceToolConfig-D0gkc1PF.js","./ViewshedAnalysisView3D--VE6lIRQ.js","./Viewshed-Dhyh7k32.js","./MoveManipulation-DDXwpmjU.js","./settings-BHWvAK7h.js","./VoxelWasmPerSceneView-BQX7kK6C.js","./loader-Ca9EgBla.js","./TerrainTileTree3DDebugger-C7jfecMr.js","./TileTreeDebugger-OrVa2xuv.js","./edgeProcessing-CaTaoQ4d.js","./bufferLayouts-viU4JW-U.js","./EdgeView-00iz-8BD.js","./EdgeWorkerHandle-CDPg5Y22.js","./workerHelper-DDJ6ziyx.js","./FeatureTileTree3DDebugger-CxMwaQYn.js","./GraphicsView3D-C6YJDCo6.js"])))=>i.map(i=>d[i]);
import{_ as X}from"./index-Bh2oEzTI.js";import{r as c}from"./tslib.es6-B3Jf3DVX.js";import{m as $h,d as Kn}from"./Viewpoint-C4FqWA2d.js";import"./geometry-D964gYQX.js";import{V as wn,E as Kg}from"./Collection-CEdjem1-.js";import{e as Jg,B as yx,n as Cc,t as vx}from"./jsxFactory-CJa39Fro.js";import{d as ef,n as Pe,m,a as I,b as Bi,e as Wn,j as Li,i as bx,a1 as wx,g as _m,k as Bv,S as Gv,X as xx,aq as Cx,E as Tx,af as Sx,aX as Px,w as Ex,t as tf,N as Mx}from"./subclass-BZA_h8Db.js";import{d as sf,b as De,u as hr,x as Ox,l as Hr,q as de,e as ha,i as bh,L as y_,F as ii,B as We,as as kv,M as nt,Z as Rx,n as Ax,m as v_,X as Ru,W as b_,t as Lt,s as Gi,c as Jn,a as Dx,af as $x,p as Ix,D as Lx,v as Ya,at as Nx,S as w_,a3 as Tc,au as Vx,a0 as rf,h as Fx}from"./Accessor-BLX9ikPh.js";import{when as ml,watch as E,sync as je,initial as dt,syncAndInitial as Ge,whenOnce as gm,on as yn}from"./reactiveUtils-C5zUhJQJ.js";import{f as ri,c as jv,g as dn,y as Au,p as nf,s as Wv}from"./screenUtils-_ZIvrt5o.js";import{g as pi,t as rs,s as Yd,a8 as x_,S as af,a9 as C_,i as Ot,ae as Ux,z as fm,j as ea,W as zx,ac as qx,a7 as Qv,e as Hx,b as Bx}from"./Point-Cg0-ChZE.js";import{m as Gx}from"./workers-D4HfeYKj.js";import{s as _l}from"./cast-Bjksrh93.js";import{c as kx,n as v,r as Pt,t as ta,N as jx,y as Wx,m as Qx,u as Xx,_ as js,e as T_,l as Yx}from"./vec3f64-BLpZdpfb.js";import{l as Zx}from"./GraphicsCollection-FfahqxsR.js";import{v as Kx}from"./HeightModelInfo-9nOoV6LU.js";import{B as Lo,U as Jx,Q as eC,J as tC,K as Xv}from"./projection-B971H0Re.js";import{Q as iC,h as qs,L as or,o as sC,m as rC,R as nC,A as aC,T as oC,c as lC,u as Yv,U as hC,V as cC,i as Zv,b as dC}from"./LineCallout.glsl-C1R4fy2f.js";import{c as Ih}from"./projectPointToVector-GINIbYMz.js";import{i as Kv,v as uC,b as mi,D as Za,a6 as Jv,q as Ia,s as Zd,j as al,E as Du,a8 as pC,r as ym,K as mC,k as _C,H as e1,o as gC,a3 as of,I as Ga,U as vm,R as lf,w as fC,a as yC,a9 as hf}from"./Polyline-D9YkgmM_.js";import{f as vC,W as S_,Z as P_,h as bC,G as wC}from"./boundedPlane-EV1sS2Ke.js";import{z as bm,w as cf,a as xC,B as CC}from"./RenderCoordsHelper-C50UGjbb.js";import{o as TC}from"./scaleUtils-D_Nw3nhM.js";import{m as wm,d as SC,y as wh,p as gl,j as gd,v as df,h as uf}from"./layerUtils-BrNoooE9.js";import{J as PC,d as EC,c as fl,K as MC,L as t1,f as OC,M as E_,N as RC,j as pf,s as ep,O as mf,k as AC,g as DC,o as $C,q as IC,v as LC,w as NC,x as VC,y as FC,z as UC,e as zC,P as qC,E as i1,F as HC,G as BC,H as GC,Q as s1,I as kC,$ as jC}from"./DefaultUI-C0utm694.js";import{z as r1,f as M_,c as ia,u as n1,d as WC,N as Ln,O as a1,B as _f,A as QC,_ as XC,a as YC,G as ZC,g as KC,C as tp,X as Sc,b as JC,e as eT,I as tT,l as iT,Y as sT,h as rT,$ as nT}from"./viewpointUtils-Bq9TFP4R.js";import{o as Cr}from"./Evented-BHRw9x22.js";import{e as aT,w as Nr}from"./Extent-Bf3YTe7m.js";import{p as oT,t as lT}from"./ElevationSamplerData-DF8Bl6I9.js";import{l as O_,r as R_,m as hT,c as cT,V as $u,_ as o1,a as F,d as sh,I as l1,E as Ii,z as A_,$ as cr,e as Zt,n as Kd,T as mt,B as Qr,G as gf,g as h1,C as ol,S as ti,t as Vl,h as dT,i as uT,A as Lh,q as Jd,Z as ff,Y as yf,Q as vf,X as bf,P as Us,p as xm,J as pT,K as mT,R as eu,j as _T,o as gT,s as fT,w as yT,v as vT,f as fo,u as bT,x as wT,y as Pc,H as xT,L as CT,N as TT,O as Cm,W as Fl,U as wf,a0 as xf,a1 as ST,a2 as PT,M as ET}from"./terrainUtils-CPZNZdjg.js";import{l as Ne,o as Tm,a as ip}from"./ViewingMode-Dodu7ZZk.js";import{d as lc,a as MT,_ as OT}from"./asyncUtils-CWX51uTe.js";import{l as Iu}from"./Clonable-D3rtuBWg.js";import{r as W,s as Et,M as Nh,o as ke,b as sa,l as tu,u as Vh,P as Fh}from"./mathUtils-C4_ghTv4.js";import{d as fd,v as D_,j as RT,b as Ec,m as Sm}from"./mathUtils-BG-eq9fO.js";import{M as AT,o as $e,R as St,g as ie,A as ae,P as ce,I as vr,r as Ce,s as ue,c as Te,u as ye,p as ki,K as $_,E as Wt,j as Hs,N as mn,_ as gt,v as Qn,y as Xn,q as No,W as ws,Y as qi,H as Lu,J as Uh,X as DT,Q as $T,$ as Cf}from"./vec32-Dvg_eL9J.js";import{l as IT,f as LT,a as NT}from"./spatialReferenceEllipsoidUtils-DBE_OFra.js";import{r as ka}from"./signal-D4lghLjV.js";import{e as zh,n as rh,b as sp,Z as VT,v as FT,E as Es,O as zt,f as iu,c as Ul,d as Ns,A as Lr,h as c1,i as UT,l as d1,t as Tf,g as zT,j as Nu,k as I_,p as qT,C as HT,q as BT,s as Hn,P as su,u as GT,w as kT,x as jT,y as WT,z as QT,X as u1,B as XT,D as Sf,W as YT,F as ZT,G as KT,H as JT,I as eS}from"./OverlayCompositing.glsl-CiE3Tt8y.js";import{n as Pl}from"./compilerUtils-Dw3R0f-Z.js";import{n as p1,u as Vu,o as m1,M as ru,h as _1,f as g1,r as tS,i as iS,s as L_,p as sS}from"./mat3-BRl2i9Bz.js";import{Y as rS,p as Ka,B as nS,c as _r,b as _n,i as qh,o as nu,e as f1,n as hc,X as aS,h as au,x as Pf,C as oS}from"./mat4-GpOFENPA.js";import{e as Nt,o as xh,t as y1}from"./mat4f64-Dk4dwAN8.js";import{o as ro,T as v1,r as ra,m as Hh,e as lS}from"./vec2-maR1OrZI.js";import{n as Ss,r as b1,t as hS,a as Bh,u as cS}from"./vec2f64-miziP1SN.js";import{r as Vr,n as dS}from"./vec3f32-nZdmKIgz.js";import{o as qt,i as Xs,b as et,c as br,h as Ht,j as Bt,H as no,I as Ie,aJ as uS,aB as pS,aK as mS,C as _S,n as Gh,a6 as gS,R as w1,d as fS,T as x1,a as Ef,$ as jt,P as yS,f as vS,as as bS,a3 as Fu,a4 as C1,aL as wS,s as kh,Q as T1,ak as un,r as S1,E as P1,k as jh,A as J,e as cc,Y as Ti,a2 as xS,t as E1,x as Cs,F as Ch,v as yd,U as M1,W as CS,aM as TS,a7 as SS,u as PS,q as ES,y as MS,a9 as OS,B as RS,aa as AS,aN as DS,ac as $S,D as IS,au as Ui,g as N_,G as V_,aO as zi,Z as LS,N as NS}from"./Texture-Fac_8AOC.js";import{T as VS,R as Rt,O as ji,M as Pm,D as Yi,E as _i,F as gr,f as O1,G as ai,I as rp,B as R1,L as Ws,_ as Kt,t as ou,X as yl,P as El,U as Ja,C as Th}from"./enums-D9v74xTE.js";import{B as Qt,l as F_,g as Jt,_ as U_,r as dc,o as z_,a as Me,j as A1,p as D1,s as q_,c as uc,e as H_,i as ll,f as FS,h as US,O as Mf}from"./renderState-DQLu6AJX.js";import{E as pc,A as B_,i as $1,s as zS}from"./Program-mfcb06fW.js";import{e as hi,E as qS,_ as HS,m as Qi,i as vl,b as BS,n as Of}from"./Texture-Begq2x5n.js";import{g as ni,o as Xi,a as _t,C as pn,F as lu,I as GS}from"./Scheduler-CJu5awNf.js";import{o as b,t as gi,r as He}from"./interfaces-DDtDqZYj.js";import{e as Ae}from"./VertexAttribute-Cq4MnHjR.js";import{t as ca}from"./glUtil-D0YUa0ow.js";import{H as da}from"./InterleavedLayout-e-di2fxs.js";import{r as ua,u as G_,a as xt,b as ms,i as kS,d as jS,e as WS,E as Gt,I as Xr,c as I1,n as QS,x as XS,f as $r,s as Rf}from"./MergedRenderer-Dli9s1X5.js";import{E as Ts}from"./BufferObject-BVi1lwBq.js";import{p as Em}from"./weather-eV4wTXCK.js";import{c as Af}from"./earthUtils-ByXwmaX5.js";import{I as Df,j as YS,O as ZS,z as KS,t as $f,r as JS}from"./ShadowCastVisualizeTechniqueConfiguration-Bb-Uir0o.js";import{p as L1,a as N1,b as V1,c as eP}from"./Environment-BDo9QJi6.js";import{k as bl,F as Uu,O as tP,K as zu,L as k_,u as j_,b as ao,U as At,E as wr,t as iP,q as F1,a as sP}from"./sphere-C77djCO6.js";import{e as xn,r as rP}from"./mat3f64-BBpwCtoL.js";import{T as Cn,E as hu,G as nP}from"./dehydratedFeatureUtils-B--Sgpdi.js";import{s as na,n as If}from"./Cyclical-oTUX3aX7.js";import{O as aP}from"./quat-4pa1e6ds.js";import{e as oP}from"./quatf64-CCm9z-pX.js";import{r as lP,b as U1,M as Wh,a as hP,x as W_,c as bt,C as z1,l as q1,O as Nn,y as Lf,L as cP,U as yo,V as eo,u as dP}from"./plane-IENfwZlB.js";import{p as Ml,g as H1,f as B1}from"./Compositing.glsl-DMM7CJmu.js";import{w as Qh,I as uP,L as Nf}from"./verticalOffsetUtils-BDQLpfho.js";import{a as Tr,o as aa,d as pP,_ as Vf}from"./InputManager-Ba9xzDpe.js";import{s as oa,z as Mm,m as G1,o as mP,a as Q_,H as k1,_ as _P,E as gP}from"./vec42-YcqnINSP.js";import{n as Ci,r as xr,s as ar,e as fP,t as j1}from"./vec4f64-o2zAXfmz.js";import{t as cu}from"./NestedMap-GuqgquCN.js";import{w as yP,g as vP}from"./unitFormatUtils-CZ2bRlFg.js";import{t as np,b as bP,s as W1,a as Q1,c as X1}from"./ZoomMomentumEstimator-DA-HeSfK.js";import{t as fs,b as wP,s as Y1,f as xP,O as Ol,p as Di,e as Z1}from"./Material-_xx7OZxD.js";import{a as X_,t as CP}from"./HUDMaterial.glsl-D6WRipwF.js";import{c as TP}from"./hydratedFeatures-DBKLr8hT.js";import{w as SP}from"./labelFormatUtils-DFKxfrJb.js";import{K as PP,w as EP,H as MP,z as OP}from"./symbols-CNimns--.js";import{i as RP,k as Ff,s as AP,a as DP,r as $P}from"./NormalUtils.glsl-DwmdcsLR.js";import{u as qu,p as IP,E as LP,q as du,H as NP,t as VP,a as Uf,f as FP}from"./aaBoundingBox-BE7cC1jD.js";import{b as UP,c as zf,l as zP,f as qP,r as HP}from"./LodRenderer-EVrH9dsH.js";import{t as K1,l as BP}from"./Indices-DflDlU4Z.js";import"./FeaturePipelineRenderManager-DjjUkvYY.js";import{o as Be,f as GP,h as Wi,i as Tn,a as Hu,t as kP,n as D,b as gn,u as wl,s as jP,e as Xh}from"./Matrix3DrawUniform-CiBFaSz6.js";import{m as Y_,c as J1,p as uu,g as WP,x as QP,j as XP,u as Om,l as YP,k as kn,q as ZP,b as KP,v as JP,T as e2,w as Z_,t as t2,O as i2}from"./DefaultMaterial-DgOvtNL9.js";import{a as eb,j as s2,i as r2,n as tb,w as ib,l as sb,m as K_,x as n2,y as a2,q as o2,k as l2,e as rb}from"./VertexColor.glsl-_ARMpsAT.js";import{i as h2,x as pu}from"./BufferView-_QDXRCew.js";import{a as c2}from"./BindType-BmZEZMMh.js";import{n as mu,r as d2}from"./DecodeSymbolColor.glsl-BPIX0fAF.js";import{a as u2,G as p2,_ as m2,H as _u,I as _2,J as g2,K as f2,C as ap}from"./RibbonLine.glsl-BZu1FDpE.js";import{j as Vo,u as qf,l as Hf,s as J_,d as y2,H as Rm,N as Am}from"./frustum-CQrOepbv.js";import{G as Dm,E as v2,f as b2,n as w2,C as x2}from"./projectBuffer-Bs7GwaPY.js";import{R as C2}from"./elevationInfoUtils-BC_66_Fg.js";import{x as Bf,t as T2,b as S2,U as P2}from"./ElevationQueryTileCache-D4sXpJpw.js";import{e as ja,a as E2,i as Jr,f as Gf}from"./intersectorUtils-BK9EUwUf.js";import{e as gu}from"./ElevationRange-BrgM1moX.js";import{a as M2}from"./ElevationProvider-C95wyCKc.js";import{l as eg}from"./Color-BCS62Hs5.js";import{n as nb,t as ab,a as ob,c as fu,m as O2,p as R2}from"./HighlightDefaults-D4ckYWWJ.js";import{t as A2}from"./hitTestSelectUtils-UXJPjatw.js";import{h as D2,r as $2,i as kf,s as I2}from"./MemCache-Dx1v3xLC.js";import{U as op,a8 as lb,ab as L2,c as jf}from"./assets-C43MgM-v.js";import{s as Gs,a as Wf}from"./Util-BIfApRF5.js";import{E as N2}from"./ByteSizeUnit-BsxeN7wM.js";import{n as V2,A as F2,t as U2}from"./vec33-DUxPafiq.js";import{d as z2}from"./Graphic-DsxsIjhH.js";import{n as q2}from"./CollectionFlattener-CQN6i8ZK.js";import{h as H2}from"./UpdatingHandles-GfwcIh5z.js";import{n as Yh}from"./projectVectorToVector-G2uWGoIb.js";import{f as B2,s as Zh}from"./Normals-DzBXR8Bg.js";import{u as hb}from"./common-DQOJ18NT.js";import"./TileStrategy-DT04gaWW.js";import{e as G2}from"./TileKey-Cs1awCRX.js";import{r as k2,s as j2,t as W2,l as Q2,a as X2,b as Y2}from"./RenderableTile-Dl7jrqnB.js";import{i as Z2,a as K2}from"./StyleDefinition-BTt_i6C1.js";import{s as J2,a as eE}from"./resources-CLJpJAXm.js";import{i as pe,a as pa}from"./ShaderTechniqueConfiguration-CBbn2DCi.js";import{s as tE,L as iE}from"./orientedBoundingBox-DOAJUK5g.js";import{r as sE}from"./floatRGBA-CfH_2xsy.js";import{D as tg}from"./colorUtils-aL8wj-8G.js";import{x as rE,d as Js}from"./sdfPrimitives-CUWZbMRe.js";import{r as nE}from"./vec3-kbEkneOB.js";import{b as mc,d as aE,m as oE,A as vo}from"./edgeUtils-BUKTgPFR.js";import{o as Qo}from"./AlphaCutoff-UcccL64p.js";import{o as lE}from"./VertexArrayObject-lPxPk5E-.js";import{o as hE}from"./ShaderTechniqueRepository-hTzew41Z.js";import{o as cb,i as Pa,r as cE,m as dE,a as zl}from"./Blit-B-VutIER.js";import{t as Kh}from"./requestImageUtils-DgMiQwsm.js";import{Y as za}from"./Octree-C8d4sqjv.js";import{l as uE}from"./DefaultVertexAttributeLayouts-PrbBmwty.js";import{E as pE}from"./testSVGPremultipliedAlpha-uTaDUvFS.js";import{y as mE,n as _E}from"./RenderingContext-C2W2PIoX.js";import{s as lp}from"./imageUtils-CtmzXUTE.js";import{t as gE}from"./layerViewUtils-DhFEu8Rd.js";import{o as Qf,r as Xf}from"./screenUtils-WcqhHU65.js";import{r as Yf}from"./spatialReferenceSupport-yRFduOSO.js";import{t as ig,o as fE}from"./Float4DrawUniform-N58YDhuZ.js";function db(i,e){const t=ef(i),s=ef(e),r=t.store,n=s.store,a=s.metadata;for(const o in a){const l=a[o],h=r.originOf(o),d=n.originOf(o);if(!l.readOnly&&d!==sf.DEFAULTS)if(h===sf.DEFAULTS)i.set(o,n.get(o));else{const u=r.get(o),p=n.get(o);u&&p&&p instanceof De&&u instanceof De&&u instanceof p.constructor&&db(u,p)}}}let Vn=class extends Cr.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=O_}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const e=this.view.basemapTerrain;if((e==null?void 0:e.extent)==null||e.spatialReference==null)return null;const t=Kv(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){var e;return((e=this.view.basemapTerrain)==null?void 0:e.spatialReference)??pi.WGS84}elevationAt(e,t){var s;if(this.extent==null||!aT(this.extent,e,t)){const r=this.extent!=null?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return Pe.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${r})`),this.noDataValue}return((s=this.view.elevationProvider)==null?void 0:s.getElevation(e,t,0,this.spatialReference,"ground"))??this.noDataValue}queryElevation(e){return oT(e.clone(),this)}};c([m({readOnly:!0})],Vn.prototype,"demResolution",void 0),c([m({readOnly:!0})],Vn.prototype,"extent",null),c([m({readOnly:!0})],Vn.prototype,"noDataValue",void 0),c([m()],Vn.prototype,"spatialReference",null),c([m({constructOnly:!0})],Vn.prototype,"view",void 0),Vn=c([I("esri.views.support.GroundViewElevationSampler")],Vn);const yE=Vn;let en=class extends De{constructor(e){super(e),this.view=null,this.layerViews=new wn}initialize(){this.addHandles(ml(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground},e=>e.load())),this.addHandles(this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()))}destroy(){this._set("view",null);for(const e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new yE({view:this.view}):null:null}get extent(){const e=this.view;return e&&e.type!=="2d"&&e.ready?r1(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return!this.view||this.view.suspended}_layerViewsAfterChangesHandler(){this.removeHandles("updating"),this.addHandles(this.layerViews.map(e=>E(()=>e.updating,()=>this._updateUpdating(),je)).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};c([m({readOnly:!0})],en.prototype,"elevationSampler",null),c([m({readOnly:!0})],en.prototype,"extent",null),c([m({type:Boolean,readOnly:!0})],en.prototype,"updating",null),c([m({constructOnly:!0})],en.prototype,"view",void 0),c([m({type:wn,readOnly:!0})],en.prototype,"layerViews",void 0),c([m({readOnly:!0})],en.prototype,"suspended",null),en=c([I("esri.views.GroundView")],en);const vE=en,ql=()=>X(()=>import("./TileLayerView3D-CrvnaR3F.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265]),import.meta.url),Zf=()=>X(()=>import("./ElevationLayerView3D-DET2ewxW.js"),__vite__mapDeps([266,1,2,6,267,268,169,170,7,12,4,5,44,45,13,46,47,19,20,21,22,23,24,25,26,9,10,11,27,28,29,30,31,32,8,33,34,16,35,36,37,38,39,40,41,42,43,48,14,15,49,50,51,52,53,54,55,56,57,58,59,60,61,62,17,18,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,3,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,140,141,165,166,167,168,171,172,173,155,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,153,154,190,150,151,152,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265]),import.meta.url),Kf={"base-dynamic":()=>X(()=>import("./BaseDynamicLayerView3D-CJS9qY7F.js"),__vite__mapDeps([269,1,2,270,21,6,20,22,23,24,7,14,9,10,11,12,4,5,13,15,16,63,61,8,33,37,62,17,18,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,79,48,80,81,60,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,55,28,56,57,58,59,84,85,86,3,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,19,25,26,27,271,272,273,160,161,211,212,213,214,215,216,130,217,218,196,219,220,129,131,274,113,275,276,140,141,136,142]),import.meta.url),"base-elevation":Zf,"base-tile":ql,"bing-maps":ql,"building-scene":()=>X(()=>import("./BuildingSceneLayerView3D-D5tmOQKT.js"),__vite__mapDeps([277,1,144,2,12,4,5,6,145,146,45,13,46,14,9,10,11,147,148,119,42,120,149,15,16,84,150,48,151,152,60,153,154,22,23,24,7,20,21,278,178,58,59,279,80,81,43,44,47,50,51,82,83,41,49,52,53,54,8,55,28,56,57,280,281,282,283,284,285,286,96,78,287,288,133,289,290,291,292,293,294,244,246,295,296,260,35,33,39,297,254,118,298,299,300,301,302,139,303,304,26,27,305,306,77,307,308,309,310,311,312,313,314,189,169,170,315,316,3,17,18,317,318,319,320,321,322,186,187,61,323,324,168,325,326,327,328,329,330,232,331,332,333,334,335,179,336,138,337,338,339,340,341,342,343,344,345,346,101,347,348,349,350,351,37,32,85,86,65,66,36,34,38,31,40,352,76,62,125,106,126,88,95,90,111,72,73,74,67,136,164,353,354,227,141,355,356,242,30,63,64,68,69,70,71,75,79,87,89,91,92,93,94,97,98,99,100,102,103,104,105,107,108,109,110,112,113,114,115,116,117,121,122,123,124,127,128,129,130,131,240,357,358,359,360,361,362,217,363,197,364,365,366,367,368,369,370,261,371,372,373,374,375,376,377,378,185,177,180,238,379,380,381,382,383,384,175,268,385,241,220,236,386,163,387,215,216,196,388,389,390,391,158,159,160,161,392,393,394,395,396,397,398,399,400,401,402,403,19,25,140,165,166,167,171,172,173,155,174,176,181,182,183,184,188,190,191,192,193,194,195,198,199,200,201,202,203,204,205,206,207,208,209,210,132,134,135,211,212,213,214,218,219,221,222,223,224,225,226,228,229,230,231,233,234,235,237,239,243,245,247,248,249,250,251,252,253,255,256,257,258,259,262,263,264,265]),import.meta.url),catalog:()=>X(()=>import("./CatalogLayerView3D-BtJvfOdv.js"),__vite__mapDeps([404,1,22,6,2,23,24,7,19,20,21,25,26,13,12,4,5,9,10,11,27,28,405,140,83,59,141,136]),import.meta.url),"catalog-dynamic-group":()=>X(()=>import("./CatalogDynamicGroupLayerView3D-Da0LJGIt.js"),__vite__mapDeps([406,1,22,6,2,23,24,7,19,20,21,25,26,13,12,4,5,9,10,11,27,28,407,43,44,45,46,47,16,48,14,15,140,83,59,141,136]),import.meta.url),"catalog-footprint":()=>X(()=>import("./CatalogFootprintLayerView3D-DVfFiaqr.js"),__vite__mapDeps([408,1,2,409,4,5,6,20,21,22,23,24,7,117,9,10,11,12,13,55,14,15,16,118,48,119,42,120,410,79,80,81,60,43,44,45,46,47,50,51,82,83,41,49,52,53,54,8,28,56,57,58,59,84,85,17,18,86,3,393,394,154,153,395,246,396,150,151,152,271,272,273,160,161,63,61,33,37,62,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,196,141,27,133,190,130,411,112,113,114,115,129,131,132,134,135,412,321,322,186,187,413,297,254,294,244,414,238,415,416,282,281,283,284,285,286,287,288,289,290,291,292,417,30,116,121,122,123,124,125,126,127,128,379,280,293,295,146,296,260,298,299,300,189,380,185,177,178,179,180,381,382,383,384,164,175,170,136,418,386,327,156,397,158,159,353,145,390,391,392,398,399,400,401,402,403,317,163,144,147,148,149,155,419,420,211,212,213,214,215,216,217,218,219,220,221,421,19,25,26,422,423,424,316,268,169,425,426,326,140,142,427,165,166,167,168,171,172,173,174,176,181,182,183,184,188,191,192,193,194,195,197,198,199,200,201,202,203,204,205,206,207,208,209,210,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,245,247,248,249,250,251,252,253,255,256,257,258,259,261,262,263,264,265]),import.meta.url),csv:()=>X(()=>import("./CSVLayerView3D-h3Cwsuuc.js"),__vite__mapDeps([428,1,2,409,4,5,6,20,21,22,23,24,7,117,9,10,11,12,13,55,14,15,16,118,48,119,42,120,410,79,80,81,60,43,44,45,46,47,50,51,82,83,41,49,52,53,54,8,28,56,57,58,59,84,85,17,18,86,3,393,394,154,153,395,246,396,150,151,152,271,272,273,160,161,63,61,33,37,62,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,196,141,27,133,190,130,411,112,113,114,115,129,131,132,134,135,412,321,322,186,187,413,297,254,294,244,414,238,415,416,282,281,283,284,285,286,287,288,289,290,291,292,417,30,116,121,122,123,124,125,126,127,128,379,280,293,295,146,296,260,298,299,300,189,380,185,177,178,179,180,381,382,383,384,164,175,170,136,418,386,327,156,397,158,159,353,145,390,391,392,398,399,400,401,402,403,317,163,144,147,148,149,155,419,420,211,212,213,214,215,216,217,218,219,220,221,421,19,25,26,422,423,424,316,268,169,425,426,326,140,142,165,166,167,168,171,172,173,174,176,181,182,183,184,188,191,192,193,194,195,197,198,199,200,201,202,203,204,205,206,207,208,209,210,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,245,247,248,249,250,251,252,253,255,256,257,258,259,261,262,263,264,265]),import.meta.url),dimension:()=>X(()=>import("./DimensionLayerView3D-D7Ttabms.js"),__vite__mapDeps([429,4,5,1,21,6,2,20,22,23,24,7,19,25,26,13,12,9,10,11,27,28,140,83,59,141,136]),import.meta.url),elevation:Zf,feature:()=>X(()=>import("./FeatureLayerView3D-Cs3MpqGy.js"),__vite__mapDeps([430,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,133,409,20,21,22,23,24,117,55,118,48,119,42,120,410,79,80,81,60,43,44,45,46,47,50,51,82,83,41,49,52,53,54,28,56,57,58,59,84,85,86,393,394,154,153,395,246,396,150,151,152,271,272,273,160,161,63,61,33,37,62,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,196,141,27,190,130,411,112,113,114,115,129,131,132,134,135,412,321,322,186,187,413,297,254,294,244,414,238,415,416,282,281,283,284,285,286,287,288,289,290,291,292,417,30,116,121,122,123,124,125,126,127,128,379,280,293,295,146,296,260,298,299,300,189,380,185,177,178,179,180,381,382,383,384,164,175,170,136,418,386,327,156,397,158,159,353,145,390,391,392,398,399,400,401,402,403,317,163,144,147,148,149,155,419,420,211,212,213,214,215,216,217,218,219,220,221,421,19,25,26,422,423,424,316,268,169,425,426,326,140,142,165,166,167,168,171,172,173,174,176,181,182,183,184,188,191,192,193,194,195,197,198,199,200,201,202,203,204,205,206,207,208,209,210,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,245,247,248,249,250,251,252,253,255,256,257,258,259,261,262,263,264,265]),import.meta.url),focusArea:()=>X(()=>import("./FocusAreaLayerView3D-DI4OV6Gr.js"),__vite__mapDeps([431,1,6,2,20,21,22,23,24,7,368,37,32,8,33,62,16,61,17,9,10,11,12,4,5,13,18,55,14,15,99,261,67,19,25,26,27,28,63,64,35,39,65,66,36,34,38,31,40,68,69,70,71,72,73,74,75,76,77,78,79,48,80,81,60,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,56,57,58,59,84,85,86,3,87,88,89,90,91,92,93,94,95,96,97,98,100,101,102,103,104,105,106,107,108,109,110,111,432,403,417,286,285,30,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,367,369,211,212,213,214,215,216,217,218,196,219,220,247,140,141,136]),import.meta.url),geojson:()=>X(()=>import("./GeoJSONLayerView3D-eVZkiKXS.js"),__vite__mapDeps([433,1,2,409,4,5,6,20,21,22,23,24,7,117,9,10,11,12,13,55,14,15,16,118,48,119,42,120,410,79,80,81,60,43,44,45,46,47,50,51,82,83,41,49,52,53,54,8,28,56,57,58,59,84,85,17,18,86,3,393,394,154,153,395,246,396,150,151,152,271,272,273,160,161,63,61,33,37,62,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,196,141,27,133,190,130,411,112,113,114,115,129,131,132,134,135,412,321,322,186,187,413,297,254,294,244,414,238,415,416,282,281,283,284,285,286,287,288,289,290,291,292,417,30,116,121,122,123,124,125,126,127,128,379,280,293,295,146,296,260,298,299,300,189,380,185,177,178,179,180,381,382,383,384,164,175,170,136,418,386,327,156,397,158,159,353,145,390,391,392,398,399,400,401,402,403,317,163,144,147,148,149,155,419,420,211,212,213,214,215,216,217,218,219,220,221,421,19,25,26,422,423,424,316,268,169,425,426,326,140,142,165,166,167,168,171,172,173,174,176,181,182,183,184,188,191,192,193,194,195,197,198,199,200,201,202,203,204,205,206,207,208,209,210,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,245,247,248,249,250,251,252,253,255,256,257,258,259,261,262,263,264,265]),import.meta.url),graphics:()=>X(()=>import("./GraphicsLayerView3D-DNNmqDUu.js"),__vite__mapDeps([434,1,2,6,20,21,22,23,24,7,19,25,26,13,12,4,5,9,10,11,27,28,414,48,14,15,16,8,86,3,17,18,85,238,77,78,63,61,33,37,62,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,79,80,81,60,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,55,56,57,58,59,84,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,435,282,141,189,153,154,417,286,285,150,151,119,120,152,30,112,113,114,115,116,117,118,121,122,123,124,125,126,127,128,129,130,131,379,280,281,283,284,287,288,133,289,290,291,292,293,294,244,246,295,146,296,260,297,254,298,299,300,380,185,177,178,179,180,186,187,381,382,383,384,164,175,170,136,418,163,144,145,147,148,149,271,272,273,160,161,140,196]),import.meta.url),group:()=>X(()=>import("./GroupLayerView-oNFJZ3OU.js"),__vite__mapDeps([436,1,22,6,2,23,24,7,56,20,21,140,83,59,141,136]),import.meta.url),imagery:()=>X(()=>import("./ImageryLayerView3D-BJy7V5nj.js"),__vite__mapDeps([437,1,6,2,20,21,22,23,24,7,270,14,9,10,11,12,4,5,13,15,16,63,61,8,33,37,62,17,18,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,79,48,80,81,60,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,55,28,56,57,58,59,84,85,86,3,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,19,25,26,27,271,272,273,160,161,211,212,213,214,215,216,130,217,218,196,219,220,129,131,274,113,275,276,140,141,136,142,438,393,394,154,153,395,246,396,150,151,119,120,152,164]),import.meta.url),"integrated-mesh":()=>X(()=>import("./IntegratedMeshLayerView3D-BzP3tS51.js"),__vite__mapDeps([439,1,80,48,2,14,9,6,10,11,12,4,5,13,15,16,81,60,22,23,24,7,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,8,55,28,56,57,58,59,20,21,84,354,144,145,146,147,148,119,120,149,150,151,152,153,154,227,66,33,36,61,37,38,32,35,39,141,74,355,17,18,356,65,34,31,40,242,30,62,63,64,67,68,69,70,71,72,73,75,76,77,78,79,85,86,3,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,121,122,123,124,125,126,127,128,129,130,131,240,357,244,168,358,359,351,352,136,360,309,361,362,217,363,197,364,365,366,367,368,369,370,261,371,372,373,317,374,375,376,331,377,378,286,285,185,177,178,179,180,133,186,187,238,282,379,280,281,283,284,287,288,289,290,291,292,293,294,246,295,296,260,297,254,298,299,300,189,380,381,382,383,384,164,175,170,268,169,385,241,220,236,386,163,387,215,216,196,19,25,26,27,140,165,166,167,171,172,173,155,174,176,181,182,183,184,188,190,191,192,193,194,195,198,199,200,201,202,203,204,205,206,207,208,209,210,132,134,135,211,212,213,214,218,219,221,222,223,224,225,226,228,229,230,231,232,233,234,235,237,239,243,245,247,248,249,250,251,252,253,255,256,257,258,259,262,263,264,265]),import.meta.url),"integrated-mesh-3dtiles":()=>X(()=>import("./IntegratedMesh3DTilesLayerView3D-YpTU0-hZ.js"),__vite__mapDeps([440,1,2,6,20,21,22,23,24,7,66,33,36,61,8,37,38,32,39,9,10,11,12,4,5,13,62,16,17,18,355,356,15,14,65,35,34,31,40,242,30,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,28,56,57,58,59,60,63,64,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,3,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,441,238,19,25,26,27,174,167,168,141,175,170,176,177,178,179,180,133,181,182,183,184,185,186,187,188,189,153,154,171,190,150,151,152,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,241,220,236,247,140,136,165,166,169,172,173,155,207,208,209,210,132,134,135,211,212,213,214,215,216,217,218,219,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,237,239,240,243,244,245,246,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265]),import.meta.url),"line-of-sight":()=>X(()=>import("./LineOfSightLayerView3D-CYKsBibS.js"),__vite__mapDeps([442,4,5,1,21,6,2,20,22,23,24,7,19,25,26,13,12,9,10,11,27,28,140,83,59,141,136]),import.meta.url),"map-image":()=>X(()=>import("./MapImageLayerView3D-g-gm5_id.js"),__vite__mapDeps([443,1,2,270,21,6,20,22,23,24,7,14,9,10,11,12,4,5,13,15,16,63,61,8,33,37,62,17,18,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,79,48,80,81,60,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,55,28,56,57,58,59,84,85,86,3,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,19,25,26,27,271,272,273,160,161,211,212,213,214,215,216,130,217,218,196,219,220,129,131,274,113,275,276,140,141,136,142,444,445,155,156,162,393,394,154,153,395,246,396,143,144,145,146,147,148,119,120,149,150,151,152,157,158,159,163,164]),import.meta.url),media:()=>X(()=>import("./MediaLayerView3D-BRpI8cw6.js"),__vite__mapDeps([446,1,2,447,6,15,11,14,9,10,12,4,5,13,16,3,7,8,17,18,448,84,159,66,33,36,97,32,20,21,22,23,24,63,61,37,62,64,35,39,65,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,79,48,80,81,60,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,55,28,56,57,58,59,85,86,87,88,89,90,91,92,93,94,95,96,98,99,100,101,102,103,104,105,106,107,108,109,110,111,19,25,26,27,449,450,141,175,170,130,451,452,453,238,154,150,151,119,120,152,153,395,246,454,455,456,211,212,213,214,215,216,217,218,196,219,220,129,131,274,113,275,276,140,136,457]),import.meta.url),"ogc-feature":()=>X(()=>import("./OGCFeatureLayerView3D-DeDb95nh.js"),__vite__mapDeps([458,1,2,409,4,5,6,20,21,22,23,24,7,117,9,10,11,12,13,55,14,15,16,118,48,119,42,120,410,79,80,81,60,43,44,45,46,47,50,51,82,83,41,49,52,53,54,8,28,56,57,58,59,84,85,17,18,86,3,393,394,154,153,395,246,396,150,151,152,271,272,273,160,161,63,61,33,37,62,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,196,141,27,133,190,130,411,112,113,114,115,129,131,132,134,135,412,321,322,186,187,413,297,254,294,244,414,238,415,416,282,281,283,284,285,286,287,288,289,290,291,292,417,30,116,121,122,123,124,125,126,127,128,379,280,293,295,146,296,260,298,299,300,189,380,185,177,178,179,180,381,382,383,384,164,175,170,136,418,386,327,156,397,158,159,353,145,390,391,392,398,399,400,401,402,403,317,163,144,147,148,149,155,419,420,211,212,213,214,215,216,217,218,219,220,221,421,19,25,26,422,423,424,316,268,169,425,426,326,140,142,459,165,166,167,168,171,172,173,174,176,181,182,183,184,188,191,192,193,194,195,197,198,199,200,201,202,203,204,205,206,207,208,209,210,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,245,247,248,249,250,251,252,253,255,256,257,258,259,261,262,263,264,265]),import.meta.url),"open-street-map":ql,"oriented-imagery":()=>X(()=>import("./FeatureLayerView3D-Cs3MpqGy.js"),__vite__mapDeps([430,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,133,409,20,21,22,23,24,117,55,118,48,119,42,120,410,79,80,81,60,43,44,45,46,47,50,51,82,83,41,49,52,53,54,28,56,57,58,59,84,85,86,393,394,154,153,395,246,396,150,151,152,271,272,273,160,161,63,61,33,37,62,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,196,141,27,190,130,411,112,113,114,115,129,131,132,134,135,412,321,322,186,187,413,297,254,294,244,414,238,415,416,282,281,283,284,285,286,287,288,289,290,291,292,417,30,116,121,122,123,124,125,126,127,128,379,280,293,295,146,296,260,298,299,300,189,380,185,177,178,179,180,381,382,383,384,164,175,170,136,418,386,327,156,397,158,159,353,145,390,391,392,398,399,400,401,402,403,317,163,144,147,148,149,155,419,420,211,212,213,214,215,216,217,218,219,220,221,421,19,25,26,422,423,424,316,268,169,425,426,326,140,142,165,166,167,168,171,172,173,174,176,181,182,183,184,188,191,192,193,194,195,197,198,199,200,201,202,203,204,205,206,207,208,209,210,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,245,247,248,249,250,251,252,253,255,256,257,258,259,261,262,263,264,265]),import.meta.url),"point-cloud":()=>X(()=>import("./PointCloudLayerView3D-qA4xyZdQ.js"),__vite__mapDeps([460,1,2,21,6,22,23,24,7,20,52,32,8,33,104,55,14,9,10,11,12,4,5,13,15,16,34,35,36,37,38,31,39,40,119,42,120,43,44,45,46,47,48,129,130,131,238,77,78,19,25,26,27,28,30,41,49,50,51,53,54,56,57,58,59,60,61,62,17,18,63,64,65,66,67,68,69,70,71,72,73,74,75,76,79,80,81,82,83,84,85,86,3,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,105,106,107,108,109,110,111,112,113,114,115,116,117,118,121,122,123,124,125,126,127,128,268,169,170,351,150,151,152,153,154,352,136,461,462,291,287,241,220,236,212,213,214,215,216,219,163,144,145,146,147,148,149,463,164,239,240,133,140,141,196,165,166,167,168,171,172,173,155,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,197,198,199,200,201,202,203,204,205,206,207,208,209,210,132,134,135,211,217,218,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,237,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265]),import.meta.url),viewshed:()=>X(()=>import("./ViewshedLayerView3D-DXKShm0x.js"),__vite__mapDeps([464,4,5,1,21,6,2,20,22,23,24,7,19,25,26,13,12,9,10,11,27,28,140,83,59,141,136]),import.meta.url),voxel:()=>X(()=>import("./VoxelLayerView3D-D8rJBUZw.js"),__vite__mapDeps([465,1,48,2,14,9,6,10,11,12,4,5,13,15,16,20,21,22,23,24,7,32,8,33,85,17,18,86,3,55,19,25,26,27,28,466,80,81,60,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,56,57,58,59,84,30,31,34,35,36,37,38,39,40,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,463,164,140,141,136,165,166,167,168,169,170,171,172,173,155,133,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,153,154,190,150,151,152,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,132,134,135,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265]),import.meta.url),route:()=>X(()=>import("./RouteLayerView3D-5aW7a_rW.js"),__vite__mapDeps([467,1,22,6,2,23,24,7,182,20,21,468,80,48,14,9,10,11,12,4,5,13,15,16,81,60,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,8,55,28,56,57,58,59,84,469,470,19,25,26,27,435,282,141,189,153,154,79,85,17,18,86,3,417,286,96,78,285,150,151,119,120,152,63,61,33,37,62,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,87,88,89,90,91,92,93,94,95,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,30,112,113,114,115,116,117,118,121,122,123,124,125,126,127,128,129,130,131,379,280,281,283,284,287,288,133,289,290,291,292,293,294,244,246,295,146,296,260,297,254,298,299,300,380,185,177,178,179,180,186,187,381,382,383,384,164,175,170,136,418,163,144,145,147,148,149,271,272,273,160,161,425,140,196]),import.meta.url),scene:i=>i.profile==null||i.profile==="mesh-pyramids"?X(()=>import("./SceneLayerView3D-BUZFH02A.js"),__vite__mapDeps([471,1,80,48,2,14,9,6,10,11,12,4,5,13,15,16,81,60,22,23,24,7,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,8,55,28,56,57,58,59,20,21,84,360,353,145,146,327,150,151,119,120,152,153,154,156,354,144,147,148,149,227,66,33,36,61,37,38,32,35,39,141,74,355,17,18,356,65,34,31,40,242,30,62,63,64,67,68,69,70,71,72,73,75,76,77,78,79,85,86,3,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,121,122,123,124,125,126,127,128,129,130,131,240,357,244,168,358,359,351,352,136,309,361,362,217,363,197,364,365,366,367,368,369,370,261,371,372,373,317,374,375,376,331,377,378,286,285,185,177,178,179,180,133,186,187,238,282,379,280,281,283,284,287,288,289,290,291,292,293,294,246,295,296,260,297,254,298,299,300,189,380,381,382,383,384,164,175,170,268,169,385,241,220,236,386,163,387,215,216,196,19,25,26,27,472,389,390,391,158,159,160,161,392,393,394,395,396,140,388,397,398,399,400,401,402,403,463,165,166,167,171,172,173,155,174,176,181,182,183,184,188,190,191,192,193,194,195,198,199,200,201,202,203,204,205,206,207,208,209,210,132,134,135,211,212,213,214,218,219,221,222,223,224,225,226,228,229,230,231,232,233,234,235,237,239,243,245,247,248,249,250,251,252,253,255,256,257,258,259,262,263,264,265]),import.meta.url):X(()=>import("./SceneLayerGraphicsView3D-CQxNJ0CW.js"),__vite__mapDeps([473,4,5,1,2,6,20,21,22,23,24,7,32,8,33,17,16,9,10,11,12,13,18,85,14,15,86,3,55,240,117,118,48,119,42,120,79,80,81,60,43,44,45,46,47,50,51,82,83,41,49,52,53,54,28,56,57,58,59,84,357,30,31,34,35,36,37,38,39,40,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,121,122,123,124,125,126,127,128,129,130,131,244,168,356,358,359,351,150,151,152,153,154,352,136,242,360,309,361,362,217,363,197,364,365,366,367,368,369,370,261,371,372,373,317,374,327,185,177,178,179,180,133,186,187,268,169,170,19,25,26,27,415,416,282,141,281,283,284,285,286,287,288,289,290,291,292,417,379,280,293,294,246,295,146,296,260,297,254,298,299,300,189,380,381,382,383,384,164,175,418,386,156,397,158,159,160,161,353,145,390,391,392,398,399,400,401,402,403,163,144,147,148,149,196,472,389,393,394,395,396,140,463,165,166,167,171,172,173,155,174,176,181,182,183,184,188,190,191,192,193,194,195,198,199,200,201,202,203,204,205,206,207,208,209,210,132,134,135,211,212,213,214,215,216,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,241,243,245,247,248,249,250,251,252,253,255,256,257,258,259,262,263,264,265]),import.meta.url),stream:()=>X(()=>import("./StreamLayerView3D-DkumgHJH.js"),__vite__mapDeps([474,1,2,20,21,6,22,23,24,7,48,14,9,10,11,12,4,5,13,15,16,80,81,60,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,8,55,28,56,57,58,59,84,475,476,477,3,17,18,422,158,159,160,161,423,424,123,122,124,316,150,151,119,120,152,153,154,425,130,410,79,85,86,393,394,395,246,396,271,272,273,63,61,33,37,62,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,196,141,27,133,190,117,118,411,112,113,114,115,129,131,132,134,135,412,321,322,186,187,413,297,254,294,244,414,238,415,416,282,281,283,284,285,286,287,288,289,290,291,292,417,30,116,121,125,126,127,128,379,280,293,295,146,296,260,298,299,300,189,380,185,177,178,179,180,381,382,383,384,164,175,170,136,418,386,327,156,397,353,145,390,391,392,398,399,400,401,402,403,317,163,144,147,148,149,155,419,420,211,212,213,214,215,216,217,218,219,220,221,421,19,25,26,140,478,165,166,167,168,169,171,172,173,174,176,181,182,183,184,188,191,192,193,194,195,197,198,199,200,201,202,203,204,205,206,207,208,209,210,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,245,247,248,249,250,251,252,253,255,256,257,258,259,261,262,263,264,265]),import.meta.url),tile:ql,"imagery-tile":()=>X(()=>import("./ImageryTileLayerView3D-B7qA3qC-.js"),__vite__mapDeps([479,1,2,20,21,6,22,23,24,7,480,4,5,48,14,9,10,11,12,13,15,16,3,8,17,18,19,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,481,482,393,394,154,153,395,246,396,164,140,141,142,157,198,165,166,167,168,169,170,171,172,173,155,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,150,151,152,191,192,193,194,195,196,197,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265]),import.meta.url),"vector-tile":()=>X(()=>import("./VectorTileLayerView3D-B3GFwrUd.js"),__vite__mapDeps([483,1,2,6,20,21,22,23,24,7,244,174,167,44,45,13,46,47,12,4,5,59,168,10,141,175,170,130,176,177,56,58,178,11,9,57,14,179,28,180,133,181,50,51,16,96,42,54,182,183,184,185,186,52,187,61,8,33,188,189,48,15,83,153,154,171,80,81,60,43,82,41,49,53,55,84,26,190,150,151,119,120,152,191,192,193,194,195,25,27,67,3,17,18,32,196,197,198,199,200,201,202,203,204,205,206,484,169,255,485,93,92,424,486,106,487,249,66,248,97,250,251,252,253,254,256,257,258,216,219,213,134,135,488,489,116,490,491,492,493,260,35,39,494,19,29,30,31,34,36,37,38,40,62,63,64,65,68,69,70,71,72,73,74,75,76,77,78,79,85,86,87,88,89,90,91,94,95,98,99,100,101,102,103,104,105,107,108,109,110,111,112,113,114,115,117,118,121,122,123,124,125,126,127,128,129,131,132,136,140,165,166,172,173,155,207,208,209,210,211,212,214,215,217,218,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,245,246,247,259,261,262,263,264,265]),import.meta.url),wcs:()=>X(()=>import("./ImageryTileLayerView3D-B7qA3qC-.js"),__vite__mapDeps([479,1,2,20,21,6,22,23,24,7,480,4,5,48,14,9,10,11,12,13,15,16,3,8,17,18,19,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,481,482,393,394,154,153,395,246,396,164,140,141,142,157,198,165,166,167,168,169,170,171,172,173,155,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,150,151,152,191,192,193,194,195,196,197,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265]),import.meta.url),"web-tile":ql,wfs:()=>X(()=>import("./WFSLayerView3D-D6bRl2kF.js"),__vite__mapDeps([495,1,2,409,4,5,6,20,21,22,23,24,7,117,9,10,11,12,13,55,14,15,16,118,48,119,42,120,410,79,80,81,60,43,44,45,46,47,50,51,82,83,41,49,52,53,54,8,28,56,57,58,59,84,85,17,18,86,3,393,394,154,153,395,246,396,150,151,152,271,272,273,160,161,63,61,33,37,62,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,196,141,27,133,190,130,411,112,113,114,115,129,131,132,134,135,412,321,322,186,187,413,297,254,294,244,414,238,415,416,282,281,283,284,285,286,287,288,289,290,291,292,417,30,116,121,122,123,124,125,126,127,128,379,280,293,295,146,296,260,298,299,300,189,380,185,177,178,179,180,381,382,383,384,164,175,170,136,418,386,327,156,397,158,159,353,145,390,391,392,398,399,400,401,402,403,317,163,144,147,148,149,155,419,420,211,212,213,214,215,216,217,218,219,220,221,421,19,25,26,422,423,424,316,268,169,425,426,326,140,142,165,166,167,168,171,172,173,174,176,181,182,183,184,188,191,192,193,194,195,197,198,199,200,201,202,203,204,205,206,207,208,209,210,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,245,247,248,249,250,251,252,253,255,256,257,258,259,261,262,263,264,265]),import.meta.url),wms:()=>X(()=>import("./WMSLayerView3D-zQSDkp1k.js"),__vite__mapDeps([496,1,2,14,9,6,10,11,12,4,5,13,270,21,20,22,23,24,7,15,16,63,61,8,33,37,62,17,18,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,78,79,48,80,81,60,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,55,28,56,57,58,59,84,85,86,3,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,19,25,26,27,271,272,273,160,161,211,212,213,214,215,216,130,217,218,196,219,220,129,131,274,113,275,276,140,141,136,142,497,498,393,394,154,153,395,246,396]),import.meta.url),wmts:()=>X(()=>import("./WMTSLayerView3D-C4RrsnCH.js"),__vite__mapDeps([499,1,22,6,2,23,24,7,20,21,133,12,4,5,19,25,26,13,9,10,11,27,28,29,30,31,32,8,33,34,16,35,36,37,38,39,40,41,42,43,44,45,46,47,48,14,15,49,50,51,52,53,54,55,56,57,58,59,60,61,62,17,18,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,3,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,134,135,136,137,138,139,140,141,142,165,166,167,168,169,170,171,172,173,155,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,153,154,190,150,151,152,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265]),import.meta.url),parquet:null,"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};function bE(i){const e=i.declaredClass?i.declaredClass.slice(i.declaredClass.lastIndexOf(".")+1):"Unknown",t=e.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new Bi(`${t}:view-not-supported`,`${e} is not supported in 3D`)}const Jf={hasLayerViewModule:i=>Kf[i.type]!=null,importLayerView:i=>{const e=Kf[i.type];if(e==null)throw bE(i);return e(i)}},e0="analyses-owner-handles";var Xo,La;(function(i){i[i.PENDING=0]="PENDING",i[i.CREATED=1]="CREATED"})(Xo||(Xo={})),function(i){i[i.ADDED=0]="ADDED",i[i.REMOVED=1]="REMOVED"}(La||(La={}));let Ea=class extends De{constructor(e){super(e),this._allAnalysisViews=new wn,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=t0(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(hr("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(hr()),this._attachedToViewResolver=t0()}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(t==null||t.state.list===La.REMOVED)throw new Bi("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),e0)}_disconnectOwners(){this.removeHandles(e0),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const r of e)this._addAnalysis(r);const t=e.on("after-add",r=>this._addAnalysis(r.item)),s=e.on("after-remove",r=>this._removeAnalysis(r.item));return Wn(()=>{t.remove(),s.remove();for(const r of e)this._removeAnalysis(r)})}_addAnalysis(e){const t=this._items.get(e);if(t==null){const s={state:{view:Xo.PENDING,list:La.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,s),s.createAnalysisViewTask=lc(r=>this._createAnalysisViewPromise(s,r))}else t.state.list=La.ADDED}_removeAnalysis(e){const t=this._items.get(e);t!=null?(t.state.list=La.REMOVED,this._scheduleUpdate()):Pe.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){this._scheduledUpdateHandle==null&&(this._scheduledUpdateHandle=Ox(()=>this._update()))}_update(){this._scheduledUpdateHandle=Hr(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list===La.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case Xo.PENDING:e.createAnalysisViewTask=ha(e.createAnalysisViewTask);break;case Xo.CREATED:e.view!=null&&(this._allAnalysisViews.remove(e.view),e.view=de(e.view),e.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(e,t){const s=e.analysis,r=s.type,n=this._analysisModules[r];if(this._creatingViewCount+=1,n.module==null)try{n.module=await this._loadAnalysisModule(r)}catch(o){throw this._creatingViewCount-=1,o}if(bh(t))throw this._creatingViewCount-=1,hr("AnalysisView creation aborted");const a=new n.module.default({analysis:s,view:this.view});try{await a.when()}catch(o){throw this._creatingViewCount-=1,o}if(bh(t))throw this._creatingViewCount-=1,a.destroy(),hr("AnalysisView creation aborted");return e.view=a,e.state.view=Xo.CREATED,this._allAnalysisViews.add(a),this._creatingViewCount-=1,a}_loadAnalysisModule(e){switch(e){case"area-measurement":return X(()=>import("./AreaMeasurementAnalysisView3D-C3deOagp.js"),__vite__mapDeps([500,1,6,2,501,502,9,10,11,12,4,5,13,57,58,59,14,46,503,504,20,21,22,23,24,7,16,228,97,33,31,32,8,39,3,15,17,18,74,85,86,99,65,61,35,66,36,34,37,38,40,100,70,505,506,507,48,508,509,510,454,511,75,64,67,68,69,71,72,73,62,512,368,513,166,226,227,44,45,47,514,515,516,517,63,76,77,78,79,80,81,60,43,42,50,51,82,83,41,49,52,53,54,55,28,56,84,87,88,89,90,91,92,93,94,95,96,98,101,102,103,104,105,106,107,108,109,110,111,518,519,455,260,520,456,238,167,168,521,113,275,276,522]),import.meta.url);case"dimension":return X(()=>import("./DimensionAnalysisView3D-Dbl80QUU.js"),__vite__mapDeps([523,1,6,2,20,21,22,23,24,7,503,59,524,48,14,9,10,11,12,4,5,13,15,16,60,166,502,57,58,46,228,61,8,33,37,32,34,35,36,38,31,39,40,85,17,18,86,3,79,80,81,43,44,45,47,42,50,51,82,83,41,49,52,53,54,55,28,56,84,520,97,456,238,77,78,517,167,168,521,74,525,513,226,227,514,507,508,509,510,454,511,260,526,96,66,62,70,65,75,64,67,68,69,71,72,73,224,88,76,90,89,91,87,92,93,94,95,98,99,100,101,102,225,111,212,213,108,214,215,216,63,103,104,105,106,107,109,110,193,112,113,114,115,527,276,528,529,519,455,274,275,530,141,531,532,533,534,535,219,211,130,217,218,196,220,129,131,536,516,230,537,453,154,150,151,119,120,152,153,175,170,451,395,246,538,539,515,518,540,522,541,542,411,452,543,544,545,194,257,258,249,546,547]),import.meta.url);case"direct-line-measurement":return X(()=>import("./DirectLineMeasurementAnalysisView3D-BAVm5ASh.js"),__vite__mapDeps([548,1,6,2,501,502,9,10,11,12,4,5,13,57,58,59,14,46,503,504,20,21,22,23,24,7,515,3,8,15,16,17,18,75,64,61,33,37,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,62,516,517,63,76,77,78,79,48,80,81,60,43,44,45,47,42,50,51,82,83,41,49,52,53,54,55,28,56,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,518,513,228,166,226,227,514,507,508,509,510,454,511,260,549,456,238,520,167,168,521,207,165,173,155,208,209,537,534,212,213,214,215,216,211,130,217,218,196,219,220,129,131,527,113,276,522]),import.meta.url);case"line-of-sight":return X(()=>import("./LineOfSightAnalysisView3D-BeFpWkAO.js"),__vite__mapDeps([550,1,6,2,22,23,24,7,8,503,59,48,14,9,10,11,12,4,5,13,15,16,551,32,33,65,61,35,39,66,36,34,37,38,31,40,68,69,70,241,55,220,236,21,20,141,3,17,18,30,41,42,43,44,45,46,47,49,50,51,52,53,54,28,56,57,58,60,62,63,64,67,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,238,224,225,515,516,517,518,552,376,331,377,168,378,306,260,526,212,213,214,215,216,193,527,276,553,535,219,174,167,175,170,176,177,178,179,180,133,181,182,183,184,185,186,187,188,189,153,154,171,26,190,150,151,152,191,192,194,195,25,27,196,197,198,199,200,201,202,203,204,205,206,544,529,519,455,536,230,547]),import.meta.url);case"slice":return X(()=>import("./SliceAnalysisView3D-BqYAO0fU.js"),__vite__mapDeps([554,1,6,2,503,59,555,48,14,9,10,11,12,4,5,13,15,16,60,166,376,331,377,168,378,28,20,21,22,23,24,7,69,65,61,8,33,32,35,39,66,36,34,37,38,31,40,70,189,83,58,153,154,45,46,279,80,81,43,44,47,42,50,51,82,41,49,52,53,54,55,56,57,84,280,281,282,283,284,285,286,96,78,287,288,133,289,290,291,292,293,294,244,246,295,146,296,260,297,254,118,298,299,300,301,302,139,303,304,119,120,26,27,305,306,77,307,308,309,150,151,152,310,311,312,313,314,169,170,315,316,3,17,18,317,318,319,320,321,322,186,187,323,324,325,326,327,328,329,330,232,332,333,334,335,179,336,138,337,338,339,340,341,342,343,344,345,346,101,347,348,349,350,351,85,86,352,76,62,125,106,126,88,95,90,111,72,73,74,67,136,164,556,557,526,97,79,238,75,64,68,71,224,89,91,87,92,93,94,98,99,100,102,225,212,213,108,214,215,216,63,103,104,105,107,109,110,193,112,113,114,115,527,276,274,275,515,516,517,518,262,172,173,531,528,529,519,455,544,545,194,522,547]),import.meta.url);case"viewshed":return X(()=>import("./ViewshedAnalysisView3D--VE6lIRQ.js"),__vite__mapDeps([558,1,551,32,8,33,65,2,16,61,35,39,15,11,14,9,6,10,12,4,5,13,66,36,34,37,38,31,40,68,69,70,241,55,220,236,20,21,22,23,24,7,3,17,18,503,59,515,75,64,67,71,72,73,74,62,516,517,63,76,77,78,79,48,80,81,60,43,44,45,46,47,42,50,51,82,83,41,49,52,53,54,28,56,57,58,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,518,559,166,526,238,224,225,212,213,214,215,216,193,260,112,113,114,115,527,276,528,529,519,455,207,165,173,155,208,209,560,561,533,534,535,219,211,130,217,218,196,129,131,522,557,544,451,175,170,545,194,536,230,547,128,126,167,168,169,171,26,30,116,117,118,119,120,121,122,123,124,125,127,172,133,174,141,176,177,178,179,180,181,182,183,184,185,186,187,188,189,153,154,190,150,151,152,191,192,195,25,27,197,198,199,200,201,202,203,204,205,206,210,132,134,135,221,222,223,226,227,228,229,231,232,233,234,235,237,239,240,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,261,262,263,264,265,136]),import.meta.url)}}};function t0(){const i=y_();return i.promise.catch(()=>{}),i}c([m()],Ea.prototype,"updating",null),c([m({constructOnly:!0})],Ea.prototype,"view",void 0),c([m()],Ea.prototype,"_allAnalysisViews",void 0),c([m()],Ea.prototype,"_creatingViewCount",void 0),Ea=c([I("esri.views.3d.analysis.AnalysisViewManager3D")],Ea);const wE=Ea;let tn=class extends De{constructor(e){super(e),this.collision=new nh,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===Ne.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Ne.Local?this._set("altitude",e):Pe.getLogger(this).warn("Altitude constraint is ignored in local scenes")}get mode(){return this.state.viewingMode}clampAltitude(e){return this.altitude?W(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const s=this.tilt(e);return W(t,s.min,s.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Ne.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,s=hp)=>(s.min=xi.min,s.max=e,s)}_createDefaultTiltLocal(){const e=this.collision.enabled?fd([[4e3,xi.max],[1e4,Et(88)],[6e6,Et(88)]]):()=>xi.max;return(t,s=hp)=>(s.min=xi.min,s.max=e(t),s)}_createDefaultTiltGlobal(){const e=this.collision.enabled?fd([[4e3,xi.max],[5e4,Et(88)],[6e6,Et(88)],[2e7,xi.min]]):fd([[3e5,xi.max],[3e6,Et(88)],[6e6,Et(88)],[2e7,xi.min]]);return(t,s=hp)=>(s.min=xi.min,s.max=e(t),s)}};function xE(i){return{min:-2e5,max:4*i.radius}}c([m()],tn.prototype,"altitude",null),c([m({readOnly:!0})],tn.prototype,"collision",void 0),c([m()],tn.prototype,"distance",void 0),c([m({readOnly:!0})],tn.prototype,"minimumPoiDistance",void 0),c([m()],tn.prototype,"tilt",void 0),c([m({constructOnly:!0})],tn.prototype,"state",void 0),tn=c([I("esri.views.3d.state.Constraints")],tn);const i0=xE(rs),xi={min:Et(.5),max:Et(179.5)},hp={min:0,max:0};let nh=class extends De{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};c([m({type:Boolean})],nh.prototype,"enabled",void 0),c([m({type:Number})],nh.prototype,"elevationMargin",void 0),nh=c([I("esri.views.3d.state.Constraints.CollisionConstraint")],nh);let Yo=class extends Iu{constructor(){super(...arguments),this.min=i0.min,this.max=i0.max}};c([m({type:Number})],Yo.prototype,"min",void 0),c([m({type:Number})],Yo.prototype,"max",void 0),Yo=c([I("esri.views.3d.constraints.AltitudeConstraint")],Yo);let on=class extends Iu{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};c([m({type:Number,value:1e-8})],on.prototype,"near",null),c([_l("near")],on.prototype,"castNear",null),c([m({type:Number,value:1e-8})],on.prototype,"far",null),c([_l("far")],on.prototype,"castFar",null),c([m({type:["auto","manual"]})],on.prototype,"mode",void 0),on=c([I("esri.views.3d.constraints.ClipDistanceConstraint")],on);const $m={min:Nh(xi.min),max:Nh(xi.max)};let Na=class extends Iu{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return W(e,$m.min,$m.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};c([m({type:["auto","manual"]})],Na.prototype,"mode",void 0),c([m({type:Number,value:$m.max})],Na.prototype,"max",null),c([_l("max")],Na.prototype,"castMax",null),Na=c([I("esri.views.3d.constraints.TiltConstraint")],Na);let Va=class extends Iu{constructor(e){super(e),this.tilt=new Na,this.altitude=new Yo,this.clipDistance=new on}};c([m({type:Na})],Va.prototype,"tilt",void 0),c([m({type:Yo})],Va.prototype,"altitude",void 0),c([m({type:on})],Va.prototype,"clipDistance",void 0),Va=c([I("esri.views.3d.constraints.Constraints")],Va);function s0(i){return Yd(i,IT)||x_(i)?{wkid:af.GCSMARS2000}:Yd(i,LT)||C_(i)?{wkid:af.GCSMOON2000}:pi.WGS84}var ns;(function(i){i[i.SIXTEEN=0]="SIXTEEN",i[i.HUNDRED=1]="HUNDRED",i[i.TWOHUNDRED=2]="TWOHUNDRED",i[i.COUNT=3]="COUNT"})(ns||(ns={}));let Im=class extends pa{constructor(){super(...arguments),this.steps=ns.SIXTEEN,this.writeTextureChannels=zh.RG}};c([pe({count:ns.COUNT})],Im.prototype,"steps",void 0),c([pe({count:zh.COUNT})],Im.prototype,"writeTextureChannels",void 0);let Hl=class{constructor(e,t,s,r,n,a,o,l,h=.5){this.coverage=e,this.density=t,this.absorption=s,this.cloudSize=r,this.detailSize=n,this.smoothness=a,this.cloudHeight=o,this.raymarchingSteps=l,this.median=h}};const wi={sunny:new Hl([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],ns.SIXTEEN),cloudy:new Hl([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],ns.TWOHUNDRED,.6),rainy:new Hl([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],ns.TWOHUNDRED,.4),snowy:new Hl([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],ns.HUNDRED,.65),foggy:new Hl([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],ns.SIXTEEN)};wi.default=wi.sunny;const Vs=Li("esri-mobile")?64:128,CE=Vs/128,nr=Math.ceil(Math.sqrt(Vs)),vn=(Vs+2)*nr,TE=1e5,Mc=128,SE=vn/1560;function Bu(i){i.code.add(b`vec2 sphereIntersect(vec3 start, vec3 dir, float distance) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * distance;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`)}let sg=class extends gi{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.viewMatrix=xn()}};const hl=Li("esri-mobile")?1024:2048;function ub(i){const e=new qt;e.include(Xs,!1);const t=e.fragment;return t.include(Bu),t.uniforms.add(new Be("cloudRadius",s=>s.cloudRadius),new Be("power",s=>ke(35,120,s.absorption)),new Be("sigmaE",s=>1+s.absorption),new Be("density",s=>ke(0,.3,s.density)),new Be("cloudSize",s=>ke(0,.02,Math.max(.01,1-s.cloudSize))),new Be("detailSize",s=>ke(0,.2,Math.max(.01,1-s.detailSize))),new Be("smoothness",s=>ke(0,.5,1-s.smoothness)),new Be("cloudHeight",s=>ke(0,1500,s.cloudHeight)),new Be("coverage",s=>s.coverage),new GP("view",s=>s.viewMatrix),new et("cloudShapeTexture",s=>s.noiseTexture!=null?s.noiseTexture.textureAtlas:null),new br("cloudVariables",s=>ro(PE,s.coverage,s.absorption))),t.constants.add("halfCubeMapSize","float",.5*hl),t.code.add(b`
    const int STEPS = ${i.steps===ns.SIXTEEN?b`16`:i.steps===ns.HUNDRED?b`100`:b`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),t.code.add(b`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${b.float(vn)};
      const float dataWidth = ${b.float(vn)};
      const float tileRows = ${b.float(nr)};
      const vec3 atlasDimensions = vec3(${b.float(Vs)}, ${b.float(Vs)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${b.float(CE)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${b.float(SE)} * p) / ${b.float(vn)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),t.code.add(b`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),t.code.add(b`float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}
float multipleOctaves(float extinction, float mu, float stepL) {
float attenuation = 1.0;
float contribution = 1.0;
float phaseAttenuation = 1.0;
float luminance = 0.0;
for (int i = 0; i < 4; i++) {
float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
attenuation *= 0.2;
contribution *= 0.6;
phaseAttenuation *= 0.5;
}
return luminance;
}`),t.code.add(b`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),t.code.add(b`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),t.main.add(b`if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
if (hitsPlanet) {
shading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);
totalTransmittance = hazeFactor;
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
return;
}
float cloudDistance = cloudRadius + cloudStart;
float rayStartDistance = dot(viewPos, viewPos) - (cloudDistance * cloudDistance);
vec2 rayStartIntersect = sphereIntersect(viewPos, rayDir, rayStartDistance);
float rayEndDistance = dot(viewPos, viewPos) - ((cloudDistance + cloudHeight) * (cloudDistance + cloudHeight));
vec2 rayEndIntersect = sphereIntersect(viewPos, rayDir, rayEndDistance);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);`),e}const PE=Ss(),EE=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:sg,build:ub,cubeMapSize:hl},Symbol.toStringTag,{value:"Module"}));let cp=class extends Ht{constructor(e,t,s){super(e,t,new Bt(EE,()=>X(()=>Promise.resolve().then(()=>VN),void 0,import.meta.url)),s)}initializePipeline(e){return Qt({blending:F_(Rt.CONSTANT_COLOR,Rt.ONE_MINUS_CONSTANT_COLOR,VS.ADD,e.writeTextureChannels===zh.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:ji.LEQUAL},colorWrite:Jt})}};var dr;(function(i){i[i.Full=0]="Full",i[i.WeatherMap=1]="WeatherMap",i[i.COUNT=2]="COUNT"})(dr||(dr={}));let pb=class extends pa{constructor(){super(...arguments),this.mode=dr.Full}};c([pe({count:dr.COUNT})],pb.prototype,"mode",void 0);let rg=class extends gi{constructor(){super(...arguments),this.weatherTile=b1(0,0)}};function mb(i){const e=new qt;return e.include(Xs,!1),e.fragment.code.add(b`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),i.mode===dr.Full&&(e.fragment.code.add(b`float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),e.fragment.code.add(b`vec3 modulo(vec3 m, float n) {
return mod(mod(m, n) + n, n);
}
vec3 hash(vec3 p3, float frequency) {
p3 = modulo(p3, frequency);
p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yxz + 33.33);
return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
}`),e.fragment.code.add(b`vec3 fade(vec3 t) {
return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
}`),e.fragment.code.add(b`
    float gradientNoise(vec3 p, float frequency) {
      vec3 i = floor(p);
      vec3 f = fract(p);
      vec3 u = fade(f);
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequency = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequency;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${b.float(nr)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${b.float(8)});

      float worley0 = worley(p, ${b.float(2)} * 2.0);
      float worley1 = worley(p, ${b.float(2)} * 8.0);
      float worley2 = worley(p, ${b.float(2)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${b.float(2)});
      float worley1 = worley(p, ${b.float(2)} * 2.0);
      float worley2 = worley(p, ${b.float(2)} * 4.0);
      float worley3 = worley(p, ${b.float(2)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)),e.fragment.uniforms.add(new br("weatherTile",t=>t.weatherTile)).code.add(b`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${b.float(Mc)});

      // Get global coordinates of p
      p += weatherTile * ${b.float(Mc)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${b.float(TE)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),i.mode===dr.Full?e.fragment.main.add(b`
      float padWidth = 1.0;
      float paddedSize = ${b.float(Vs)} + 2.0 * padWidth;
      float tileCount = ${b.float(nr)} * ${b.float(nr)};
      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

      bool padCell = false;
      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      bool startPadX = false;
      bool startPadY = false;
      bool endPadX = false;
      bool endPadY = false;

      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
        startPadX = true;
      }

      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
        startPadY = true;
      }

      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
        endPadX = true;
      }

      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
        endPadY = true;
      }

      vec2 padding = vec2(2.0 * padWidth) * tile;
      vec2 uv;

      if (padCell) {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;

        if (startPadX) {
          pixel.x += ${b.float(Vs)};
        }

        if (startPadY) {
          pixel.y += ${b.float(Vs)};
        }

        if (endPadX) {
          pixel.x -= ${b.float(Vs)};
        }

        if (endPadY) {
          pixel.y -= ${b.float(Vs)};
        }

        uv = vec2(pixel.xy / ${b.float(Vs)});
      } else {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;
        uv = vec2(pixel.xy / ${b.float(Vs)});
      }

      vec3 p_ = get3Dfrom2D(uv);
      vec3 p = p_;
      p.z /= (${b.float(nr)} * ${b.float(nr)});

      float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      float worleyNoise = getTextureForPointWorley(p);

      fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      p_ = mod(p_ + 1.0, ${b.float(nr)} * ${b.float(nr)});
      p = p_;
      p.z /= (${b.float(nr)} * ${b.float(nr)});

      worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      worleyNoise = getTextureForPointWorley(p);

      fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      vec2 mapUV = ${b.float(Mc)} * (gl_FragCoord.xy / ${b.float(vn)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor.ba = vec2(0.0, map);
      `):e.fragment.main.add(b`
      vec2 mapUV = ${b.float(Mc)} * (gl_FragCoord.xy / ${b.float(vn)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor = vec4(map);
    `),e}const ME=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:rg,build:mb},Symbol.toStringTag,{value:"Module"}));let dp=class extends Ht{constructor(e,t,s){super(e,t,new Bt(ME,()=>X(()=>Promise.resolve().then(()=>FN),void 0,import.meta.url)),s)}initializePipeline(e){return Qt({blending:e.mode===dr.Full?U_:dc(Rt.ZERO,Rt.ONE,Rt.ONE,Rt.ZERO),depthTest:{func:ji.ALWAYS},colorWrite:Jt})}},vd=class extends De{constructor(e){super(e),this._needsRender=!0,this._passParameters=new rg,this._configuration=new pb,this._fbo=new pc(e.context.renderContext.rctx,new hi(vn)),this._configuration.mode=dr.Full,e.context.techniques.precompile(dp,this._configuration),this._configuration.mode=dr.WeatherMap,e.context.techniques.precompile(dp,this._configuration)}get textureAtlas(){if(this._texture&&!this._needsRender)return this._texture;this._configuration.mode=this._texture?dr.WeatherMap:dr.Full;const e=this.context.techniques.acquire(dp,this._configuration);return e.compiled&&(this._texture=this._render(e)),e.release(),this._texture}updateWeatherMap(e){v1(this._passParameters.weatherTile,e)||(ra(this._passParameters.weatherTile,e),this._needsRender=!0)}destroy(){this._weatherMapTechniqueCached=ii(this._weatherMapTechniqueCached),this._fbo=We(this._fbo)}_render(e){if(!this._fbo)return null;const t=this.context.renderContext.rctx,s=t.getViewport();return t.setViewport(0,0,vn,vn),t.bindFramebuffer(this._fbo),t.bindTechnique(e,this.context.renderContext.bind,this._passParameters),t.screen.draw(),t.setViewport(s.x,s.y,s.width,s.height),this._needsRender=!1,this._fbo.colorTexture}};c([m({constructOnly:!0})],vd.prototype,"context",void 0),vd=c([I("esri.views.3d.environment.NoiseTextureAtlas")],vd);let Ki=class extends De{constructor(e){super(e),this._state=ka(rh.Idle),this._passParameters=new sg,this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this._tilesPerFace=1,this.coverage=ke(wi.default.coverage[0],wi.default.coverage[1],.5),this.density=ke(wi.default.density[0],wi.default.density[1],.5),this.absorption=ke(wi.default.absorption[0],wi.default.absorption[1],.5),this.cloudSize=ke(wi.default.cloudSize[0],wi.default.cloudSize[1],.5),this.detailSize=ke(wi.default.detailSize[0],wi.default.detailSize[1],.5),this.smoothness=ke(wi.default.smoothness[0],wi.default.smoothness[1],.5),this.cloudHeight=ke(wi.default.cloudHeight[0],wi.default.cloudHeight[1],.5),this.raymarchingSteps=wi.default.raymarchingSteps,this._viewMatrix=Nt(),this._dirty=!0,this.running=!0,this._configuration=new Im}initialize(){const e=Ot(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius;const t=()=>this.setDirty();this.addHandles([this.view.resourceController.scheduler.registerTask(ni.CLOUDS_GENERATOR,this),E(()=>this.coverage,t,dt),E(()=>this.density,t,dt),E(()=>this.absorption,t,dt),E(()=>this.cloudSize,t,dt),E(()=>this.detailSize,t,dt),E(()=>this.smoothness,t,dt),E(()=>this.cloudHeight,t,dt),E(()=>this.raymarchingSteps,t,dt)]);const s=hS(this._computeWeatherTile());let r=0;this.addHandles(E(()=>{const n=this._computeWeatherTile();return v1(s,n)||(++r,ra(s,n)),r},t))}destroy(){this.destroyCubeMap(),this._passParameters.noiseTexture=de(this._passParameters.noiseTexture)}_precompileTechniques(){this._configuration.steps=this.raymarchingSteps,this._configuration.writeTextureChannels=zh.RG,this.context.techniques.precompile(cp,this._configuration),this._configuration.writeTextureChannels=zh.BA,this.context.techniques.precompile(cp,this._configuration)}_acquireTechnique(){switch(this.raymarchingSteps){case ns.SIXTEEN:this._tilesPerFace=1;break;case ns.HUNDRED:this._tilesPerFace=4;break;case ns.COUNT:case ns.TWOHUNDRED:this._tilesPerFace=8;break;default:Pl(this.raymarchingSteps)}return this._configuration.writeTextureChannels=1-this.parameters.readChannels,this._configuration.steps=this.raymarchingSteps,this.context.techniques.acquire(cp,this._configuration)}_computeWeatherTile(){var l,h;const{camera:e,environment:t}=this.view,{latitude:s,longitude:r}=e.position;if(s==null||r==null)return Bh;ro(Ys,(s+90)/180,(r+180)/360);const n=Math.floor(this._weatherTileCount*Math.abs(2*Ys[0]-1));Ys[0]=Math.floor(2*this._weatherTileCount*Ys[0]),Ys[1]=Math.floor(4*(this._weatherTileCount-n)*Ys[1]);let a=0,o=0;if(((l=t==null?void 0:t.lighting)==null?void 0:l.type)!=="virtual"&&((h=t==null?void 0:t.lighting)==null?void 0:h.date)!=null){const d=new Date(t.lighting.date);d.setUTCHours(t.lighting.date.getUTCHours()+(t.lighting.displayUTCOffset??0)),a=31*d.getUTCMonth()+d.getUTCDate(),o=d.getUTCFullYear()}return Ys[0]=(Ys[0]+a)%(2*this._weatherTileCount),Ys[1]=(Ys[1]+o%100)%(4*this._weatherTileCount),Ys}get state(){return this._state.value}set state(e){this._state.value=e}get usedMemory(){var e,t,s;return(((e=this._fbo)==null?void 0:e.usedMemory)??0)+(((s=(t=this._passParameters.noiseTexture)==null?void 0:t.textureAtlas)==null?void 0:s.usedMemory)??0)}_ensureNoiseTexture(){var e;return(e=this._passParameters).noiseTexture??(e.noiseTexture=new vd({context:this.context})),this._passParameters.noiseTexture}_ensureFrameBufferCube(e){const t=this.context.renderContext.rctx;if(this._fbo==null){const s=new hi(e);s.target=Pm.TEXTURE_CUBE_MAP,s.wrapMode=Yi.CLAMP_TO_EDGE,this._fbo=new pc(t,s),this.parameters.data=this}return t.unbindTexture(this._fbo.colorTexture),this._fbo}get cubeMap(){return this._fbo}get parameters(){return this.context.renderContext.bind.clouds}destroyCubeMap(){this._fbo=We(this._fbo),this.parameters.data=null}applyPreset(e,t){const s=e.median,r=n=>{const a=ke(n[0],n[1],s);return t<.5?ke(n[0],a,2*t):ke(a,n[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps,this._precompileTechniques()}setDirty(){this._dirty=this.running=!0}runTask(e){if(this.state===rh.Fading)return Xi;this._dirty&&(this._faceIndex=this._tileIndex=0,this.state=rh.Rendering,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._ensureNoiseTexture().updateWeatherMap(this._computeWeatherTile()),this._dirty=!1);const t=this._acquireTechnique();if(!this._ensureNoiseTexture().textureAtlas||!t.compiled)return t.release(),Xi;const s=OE[this._faceIndex],r=RE[this._faceIndex];rS(this._viewMatrix,AE,s,r),p1(this._passParameters.viewMatrix,this._viewMatrix);const n=this.context.renderContext.rctx,a=n.getViewport(),o=hl/this._tilesPerFace,l=this._tileIndex*o;n.setViewport(0,l,hl,o);const h=this._ensureFrameBufferCube(hl);n.bindFramebuffer(h),n.bindTechnique(t,this.context.renderContext.bind,this._passParameters);const d=Pm.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return h.setColorTextureTarget(d),n.screen.draw(),t.release(),n.gl.flush(),n.setViewport(a.x,a.y,a.width,a.height),this.requestRender(),++this._tileIndex,this._faceIndex===4&&this._tileIndex===this._tilesPerFace?(this._faceIndex=this._tileIndex=0,this.state=rh.Ready,this.running=!1):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),Xi}};c([m({constructOnly:!0})],Ki.prototype,"context",void 0),c([m({constructOnly:!0})],Ki.prototype,"view",void 0),c([m({constructOnly:!0})],Ki.prototype,"requestRender",void 0),c([m()],Ki.prototype,"coverage",void 0),c([m()],Ki.prototype,"density",void 0),c([m()],Ki.prototype,"absorption",void 0),c([m()],Ki.prototype,"cloudSize",void 0),c([m()],Ki.prototype,"detailSize",void 0),c([m()],Ki.prototype,"smoothness",void 0),c([m()],Ki.prototype,"cloudHeight",void 0),c([m()],Ki.prototype,"raymarchingSteps",void 0),c([m()],Ki.prototype,"running",void 0),Ki=c([I("esri.views.3d.environment.CloudsRenderer")],Ki);const OE=[Vr(1,0,0),Vr(-1,0,0),Vr(0,1,0),Vr(0,-1,0),Vr(0,0,1)],RE=[Vr(0,1,0),Vr(0,1,0),Vr(0,0,-1),Vr(0,0,1),Vr(0,1,0)],AE=kx(),Ys=cS();var Sn;(function(i){i[i.Rain=0]="Rain",i[i.Snow=1]="Snow",i[i.COUNT=2]="COUNT"})(Sn||(Sn={}));let _b=class extends pa{constructor(){super(...arguments),this.type=Sn.Rain}};c([pe({count:Sn.COUNT})],_b.prototype,"type",void 0);function gb(i){const e=new qt;return e.attributes.add(Ae.POSITION,"vec3"),e.attributes.add(Ae.INSTANCEFEATUREATTRIBUTE,"float"),e.vertex.uniforms.add(new Wi("cameraPosition",(t,s)=>s.camera.eye),new Wi("offset",(t,s)=>DE(t,s)),new Be("width",t=>t.width),new Be("time",t=>t.time),new Tn("proj",(t,s)=>s.camera.projectionMatrix),new Tn("view",(t,s)=>s.camera.viewMatrix)),e.varyings.add("vUv","vec2"),e.vertex.code.add(b`vec3 hash31(float p){
vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yzx + 33.33);
return fract((p3.xxy + p3.yzz) * p3.zyx);
}
float hash11(float p){
p = fract(p * 0.1031);
p *= p + 33.33;
p *= p + p;
return fract(p);
}
vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
}`),e.vertex.main.add(b`
      vUv = position.xz;
      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundredths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${i.type===Sn.Rain?b`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:b`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
  `),e.fragment.uniforms.add(new Be("opacity",t=>t.opacity),new Wi("particleColor",(t,s)=>$E(s,i))),e.fragment.main.add(b`
    float d = length(vUv - vec2(0.5));

    ${i.type===Sn.Rain?b`d = 0.35 * smoothstep(0.5, 0.0, d);`:b`d = smoothstep(0.5, 0.1, d);`}
    fragColor = opacity * vec4(particleColor * d, d);
  `),e}function DE(i,e){const t=e.camera.eye,s=.5*i.width,r=1/i.width,n=AT(Lm,$e(Lm,(t[0]+s)*r,(t[1]+s)*r,(t[2]+s)*r));return St(n,t,ie(n,n,i.width))}function $E(i,e){const t=e.type===Sn.Rain?LE:IE,s=ie(Lm,t,NE),r=i.camera.eye;ae(r0,r);const n=Math.max(0,ce(r0,i.lighting.mainLight.direction));return vr(s,s,t,n)}const Lm=v(),r0=v(),IE=Pt(1,1,1),LE=Pt(.85,.85,.85),NE=.7,VE=Object.freeze(Object.defineProperty({__proto__:null,build:gb},Symbol.toStringTag,{value:"Module"}));let FE=class extends gi{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=0}},n0=class extends Ht{constructor(e,t,s){super(e,t,new Bt(VE,()=>X(()=>Promise.resolve().then(()=>UN),void 0,import.meta.url)),s,new Map([[Ae.POSITION,0],[Ae.INSTANCEFEATUREATTRIBUTE,1]]))}initializePipeline(){return Qt({blending:z_,depthTest:{func:ji.LEQUAL},colorWrite:Jt})}},Ma=class extends no{constructor(e){super(e),this.consumes={required:[Ie.TRANSPARENT_ENVIRONMENT]},this.produces=Ie.TRANSPARENT_ENVIRONMENT,this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new FE,this._configuration=new _b;const{view:t,type:s,techniques:r}=e;this._configuration.type=s==="rainy"?Sn.Rain:Sn.Snow,r.precompile(n0,this._configuration),this._passParameters.time=0,this._passParameters.radius=Ot(t.spatialReference).radius,this.addHandles(E(()=>t.environment.weather,n=>{n.type===s&&this.addHandles(E(()=>n.precipitation,a=>this._adjustParticles(a),Ge))},Ge)),this.addHandles(E(()=>{var n;return((n=t._stage)==null?void 0:n.renderer.renderContext.bind.clouds.fadeFactor)??1},n=>{this._passParameters.opacity=n,n===1&&(this.removeHandles("opacity"),this.addHandles(E(()=>{var a;return((a=t._stage)==null?void 0:a.renderer.renderContext.bind.clouds.opacity)??1},a=>this._passParameters.opacity=a,Ge),"opacity"))},je),"opacity")}_adjustParticles(e){const s=e<.5?ke(0,.35,2*e):ke(.35,1,2*(e-.5));this._numParticles=a0*s}destroy(){this._numParticles=0,this._vao=We(this._vao),this._instanceIdBuffer=We(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles(E(()=>{var t;return((t=this.renderContext)==null?void 0:t.bind.clouds.fadeFactor)??1},t=>{this._passParameters.opacity=1-t,t===1&&(this.removeAllHandles(),e())}),"opacity")}updateAnimation(e){const t=(this.type==="rainy"?this._rainSpeed:this._snowSpeed)*kv(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){const t=this.renderingContext;this._instanceIdBuffer??(this._instanceIdBuffer=this._createInstanceIndices(t));const s=Math.round(this._numParticles*this._passParameters.opacity),r=e.find(({name:o})=>o===Ie.TRANSPARENT_ENVIRONMENT);if(s<1)return r;const n=this.techniques.acquire(n0,this._configuration);if(!n.compiled)return n.release(),this.requestRender(Me.UPDATE),r;const a=t.bindTechnique(n,this.bindParameters,this._passParameters);return this._vao??(this._vao=UE(t,n.locations)),t.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),qS(t,n.locations,this._instanceIdBuffer,o0,0),t.drawArraysInstanced(_i.TRIANGLES,0,3,s),HS(t,n.locations,this._instanceIdBuffer,o0),n.release(),r}_createInstanceIndices(e){const t=[];for(let s=0;s<a0;s++)t.push(s);return Ts.createVertex(e,gr.STATIC_DRAW,new Float32Array(t))}};function UE(i,e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new ua(i,e,new Map([["geometry",ca(zE)]]),new Map([["geometry",Ts.createVertex(i,gr.STATIC_DRAW,t)]]))}c([m()],Ma.prototype,"consumes",void 0),c([m()],Ma.prototype,"produces",void 0),c([m({constructOnly:!0})],Ma.prototype,"type",void 0),c([m({constructOnly:!0})],Ma.prototype,"techniques",void 0),Ma=c([I("esri.views.3d.environment.Precipitation")],Ma);const a0=25e4,zE=da().vec3f(Ae.POSITION),o0=ca(da().f32(Ae.INSTANCEFEATUREATTRIBUTE),1);let Oa=class extends G_{constructor(e){super(e),this.produces=new Map([]),this._clouds=ka(null),this._incarnation=0,this._precipitation=null}initialize(){this.view._stage.addRenderPlugin(this)}destroy(){var e,t;this.removeHandles(),this.uninitializeRenderContext(),(t=(e=this.view)==null?void 0:e._stage)==null||t.removeRenderPlugin(this),this._set("view",null)}get updating(){var e;return!!((e=this._clouds.value)!=null&&e.running)}get weatherVisible(){return Ce(this.view.state.camera.eye)-Ot(this.view.spatialReference).radius<=Em}get usedMemory(){var e;return((e=this._clouds.value)==null?void 0:e.usedMemory)??0}_fadeOutPrecipitation(){var e;this._precipitation&&((e=this._precipitationOutgoing)==null||e.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut(()=>{this._precipitationOutgoing=de(this._precipitationOutgoing)}),this._precipitation=null,++this._incarnation)}get weather(){var e,t;return(t=(e=this.view)==null?void 0:e.environmentManager)!=null&&t.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(e){this._context=e;const t=this.view,s=()=>this._requestRender();this.addHandles([E(()=>this._precipitation,s,je),E(()=>{var r;return(r=this._clouds.value)==null?void 0:r.state},s,je),E(()=>t.state.mode,s,je),E(()=>this._updateClouds(),s,je),E(()=>this._updatePrecipitation(),s,je),E(()=>this.weather,r=>this._initWeather(r))])}uninitializeRenderContext(){this._context=null,this._clouds.value=de(this._clouds.value),this._precipitation=de(this._precipitation),this._precipitationOutgoing=de(this._precipitationOutgoing)}prepareRender(e){const{bind:t,time:s}=e;if(this.view.viewingMode!=="local"&&t.clouds.data){t.clouds.fade(t.camera,s,this.view.qualitySettings.fadeDuration);const r=this._clouds.value;r&&r.state===rh.Idle&&r.coverage===0&&!r.running&&r.destroyCubeMap()}}acquireTechniques(){return[]}render(){}_requestRender(){var e;(e=this._context)==null||e.requestRender()}_initWeather(e){const t=this._context;if(!e||!t)return void(this._clouds.value=de(this._clouds.value));if(this._clouds.value)return;const s=this.view;this._clouds.value=new Ki({context:t,view:s,requestRender:()=>this._requestRender()})}_updateClouds(){const e=this.view.environment.weather;return e==null||this._clouds.value==null||this._clouds.value.applyPreset(wi[e.type],qE(e)),++this._incarnation}_updatePrecipitation(){var r;const e=this.view.environment.weather;if(e.type===((r=this._precipitation)==null?void 0:r.type))return this._incarnation;this._fadeOutPrecipitation();const t=e.type==="rainy"||e.type==="snowy",s=this._context;return t&&s&&(this._precipitation=new Ma({view:this.view,techniques:s.techniques,type:e.type}),++this._incarnation),this._incarnation}get test(){}};function qE(i){switch(i.type){case"rainy":case"snowy":case"cloudy":case"sunny":return i.cloudCover;case"foggy":return i.fogStrength}}c([m({constructOnly:!0})],Oa.prototype,"view",void 0),c([m({type:Boolean,readOnly:!0})],Oa.prototype,"updating",null),c([m({readOnly:!0})],Oa.prototype,"weatherVisible",null),c([m()],Oa.prototype,"_context",void 0),Oa=c([I("esri.views.3d.environment.EnvironmentRenderer")],Oa);let Os=class extends Cr.EventedAccessor{constructor(){super(),this._tmpLightParameters=new Df,this._defaultLightParameters=new Df,this._tmpDate=new Date,this._tmpTz={hours:0,minutes:0,seconds:0},this._viewHandlesKey="viewHandles",this._trackingEnabled=!1,this._mainLight=new uS,this._ambientLight=new pS,this._moonLight=new mS,this._disableProjectionEngineAutoLoad=!1,this._disableWeather=!1,this._renderer=null,this._referencePositionGeographic=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){var e;return(e=this._renderer)==null?void 0:e.view}get updating(){var e;return!!((e=this._renderer)!=null&&e.updating)||!this._canProjectCameraPosition}get weatherEnabled(){var e,t,s;return((e=this._view)==null?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&((s=(t=this._view)==null?void 0:t.state)==null?void 0:s.viewingMode)===Ne.Global&&Ux(this._view.spatialReference)}get weatherVisible(){var e;return this.weatherEnabled&&((e=this._renderer)==null?void 0:e.weatherVisible)}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){var s,r,n,a;const e=((a=(n=(r=(s=this._view)==null?void 0:s.stateManager)==null?void 0:r.camera)==null?void 0:n.position)==null?void 0:a.spatialReference)??pi.WGS84,t=s0(e);return this._disableProjectionEngineAutoLoad||Lo(e,t)}connectView(e){if(this._renderer)return;this._renderer=new Oa({view:e});const t=()=>this._updateRenderParameters(),s=()=>this._cameraHandler();this.addHandles([E(()=>e.environment.lighting,r=>this._updateLightingHandler(r),je),E(()=>e.environment.lighting.type!=="virtual"?e.environment.lighting.date:null,r=>this._lightingDateHandler(r),je),E(()=>e.environment.lighting.directShadowsEnabled,t,je),E(()=>e.qualitySettings.ambientOcclusion,t,je),E(()=>e.qualitySettings.reflections,t,je),E(()=>e.spatialReference,()=>this._resetReferencePosition(!0),je),E(()=>e.environment.weather.type,()=>this._updateLighting(null,sp.FadeWithWeather),je),E(()=>this.weatherEnabled,()=>this._updateLighting(null,sp.FadeWithWeather),je),E(()=>e.viewingMode,()=>this._resetReferencePosition(!0),Ge),E(()=>e.environment.lighting.type!=="virtual"&&e.environment.lighting.cameraTrackingEnabled,r=>this._updateCameraTracking(r),Ge),E(()=>e.state.camera,s,Ge),ml(()=>this._canProjectCameraPosition,s,je)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=de(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type!=="virtual"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.type!=="virtual"?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const t=this._view.environment.lighting;(t==null?void 0:t.type)!=="virtual"&&(t.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if((t==null?void 0:t.type)!=="virtual"){if(e){if(!t.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(e),this._referencePositionGeographic!=null)){const s=Af(this._referencePositionGeographic,this._tmpTz);s!=null&&(t.autoUpdate(null,s),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type!=="virtual"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const s=t.stateManager.camera;if(!s)return;const{position:r}=s,n=r.spatialReference??pi.WGS84,a=s0(n),o=this._referencePositionGeographic??v();if(!Ih(r,o,a))return this._referencePositionGeographic=null,void this._updateLighting();this._referencePositionGeographic=o,this.notifyChange("referencePositionGeographic"),this._autoUpdateTimezone(o,e)||this._updateLighting(e)}_updateLighting(e,t=sp.Immediate){const s=this._view,{lighting:r}=s.environment,n=r.type==="virtual",a=this._referencePositionGeographic,o=a!=null?this._tmpLightParameters:this._defaultLightParameters;if(a){e??(e=n?null:r.date);const _=this.weatherVisible?s.environment.weather.type:"disabled";YS(e,a,s.state.viewingMode,_,s.state.camera,o)}else n&&ZS(s.state.camera,s.state.viewingMode,o.direct.directionToLightSource);const l=this._mainLight,h=o.direct;ie(l.intensity,h.color,h.intensity*Math.PI),ue(l.direction,h.directionToLightSource),l.specularStrength=o.specularStrength,l.environmentStrength=o.environmentStrength;const d=this._ambientLight;ie(d.intensity,o.ambient.color,o.ambient.intensity);const u=this._moonLight;vr(u.intensity,HE,BE,o.globalFactor);const p=(1-.5*o.globalFactor)*(1-.4*o.noonFactor*(1-o.globalFactor));ie(u.intensity,u.intensity,p),ue(u.direction,h.directionToLightSource),this._view._stage.renderer.updateLighting([l,d,u],o.noonFactor,o.globalFactor,t),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||e==null)return!1;const s=this._tmpDate;s.setTime((t||this._view.environment.lighting.date).getTime());const r=Af(e,this._tmpTz);if(r==null)return!1;let n=this._view.environment.lighting.positionTimezoneInfo;if(n.autoUpdated){if(n.hours===r.hours&&n.minutes===r.minutes&&n.seconds===r.seconds)return!1}else n=r;const a=s.getUTCHours()-(r.hours-n.hours),o=s.getUTCMinutes()-(r.minutes-n.minutes),l=s.getUTCSeconds()-(r.seconds-n.seconds);return s.setUTCHours(a),s.setUTCMinutes(o),s.setUTCSeconds(l),!t&&this._view.environment.lighting.autoUpdate(s,r)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=this._referencePositionGeographic==null||KS(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._referencePositionGeographic=null,e&&this._cameraHandler()}get test(){}};c([m({type:Boolean,readOnly:!0})],Os.prototype,"updating",null),c([m()],Os.prototype,"_disableProjectionEngineAutoLoad",void 0),c([m()],Os.prototype,"_disableWeather",void 0),c([m()],Os.prototype,"weatherEnabled",null),c([m()],Os.prototype,"weatherVisible",null),c([m()],Os.prototype,"referencePositionGeographic",null),c([m()],Os.prototype,"_renderer",void 0),c([m()],Os.prototype,"_referencePositionGeographic",void 0),c([m()],Os.prototype,"_canProjectCameraPosition",null),Os=c([I("esri.views.3d.environment.EnvironmentManager")],Os);const HE=Pt(.22,.22,.33),BE=Pt(.22,.22,.22);var Fo;let Fn=Fo=class extends Cr.EventedMixin(L1){constructor(i){super(i),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const e=new Date().getFullYear(),t=new Date("March 15, "+e+" 12:00:00 UTC");this._set("defaultDate",t),this._set("date",t)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(i){return new Fo(i.cloneConstructProperties())}set defaultDate(i){const e=this._get("date")===this._get("defaultDate");i=new Date(i.getTime()),this._set("defaultDate",i),e&&this._set("date",i)}set date(i){i!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(i.getTime())))}autoUpdate(i,e){const t=Fo.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=e.hours,this.positionTimezoneInfo.minutes=e.minutes,this.positionTimezoneInfo.seconds=e.seconds;let s=null;i!=null&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(i.getTime())?(s=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(s=this.date&&this.date.getTime(),this._set("date",new Date(i.getTime()))));const r=Fo.calculateTimezoneOffset(this.positionTimezoneInfo);if(t!==r&&(Oc.target=this,Oc.timezoneOffset=r,this.emit("timezone-will-change",Oc),Oc.target=null),i!=null)return isNaN(i.getTime())||s!==i.getTime()}clone(){const i=this._get("date")===this._get("defaultDate"),e=new Fo({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled});return i&&e._set("date",e._get("defaultDate")),e.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,e.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,e.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,e.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,e}cloneWithWebsceneLighting(i){const e=this.clone();return i.date!=null&&(e.date=i.date),e.directShadowsEnabled=i.directShadowsEnabled,e.displayUTCOffset=i.displayUTCOffset,e}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};c([m({type:Boolean})],Fn.prototype,"cameraTrackingEnabled",void 0),c([m({type:Date})],Fn.prototype,"defaultDate",null),c([m({type:Date})],Fn.prototype,"date",null),Fn=Fo=c([I("esri.views.3d.environment.SunLighting")],Fn),function(i){function e({hours:t,minutes:s,seconds:r}){return Math.round(t+s/60+r/3600)}i.calculateTimezoneOffset=e}(Fn||(Fn={}));const Oc={target:null,timezoneOffset:0},Ra=Fn;var bd;let wd=bd=class extends Cr.EventedMixin(N1){constructor(i){super(i),this.cameraTrackingEnabled=!0}clone(){return new bd({...this.cloneConstructProperties(),cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(i){return new bd(i.cloneConstructProperties())}cloneWithWebsceneLighting(i){const e=this.clone();return e.directShadowsEnabled=i.directShadowsEnabled,e}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};c([m({type:Boolean})],wd.prototype,"cameraTrackingEnabled",void 0),wd=bd=c([I("esri.views.3d.environment.VirtualLighting")],wd);const ah=wd,GE={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Ra,virtual:ah}};var oh;let lh=oh=class extends V1{constructor(i){super(i),this.lighting=this.castLighting(),this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(i){const e=i.cloneConstructProperties();return new oh({...e,lighting:e.lighting?e.lighting.type==="virtual"?ah.fromWebsceneLighting(e.lighting):Ra.fromWebsceneLighting(e.lighting):void 0})}castLighting(i){return this._convertLightingWithDestroy(i)}applyLighting(i){this.lighting=this._convertLightingWithDestroy(i)}_convertLightingWithDestroy(i){const e=this._convertLighting(i);return e!==i&&this.addHandles(bx(e)),e}_convertLighting(i){var e,t;return i?i instanceof Ra||i instanceof ah?i:i instanceof L1?this.lighting&&this.lighting.type!=="virtual"?this.lighting.cloneWithWebsceneLighting(i):new Ra({...i.cloneConstructProperties(),...(e=this.lighting)==null?void 0:e.cloneNonPersistentConstructProperties()}):i instanceof N1?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(i):new ah({...i.cloneConstructProperties(),...(t=this.lighting)==null?void 0:t.cloneNonPersistentConstructProperties()}):wx(GE,i):new Ra}clone(){return new oh({lighting:this.lighting.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:_m(this.background)})}cloneWithWebsceneEnvironment(i){return new oh({weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:_m(this.background),...i.cloneConstructProperties(),lighting:this._getLighting(i)})}_getLighting(i){switch(i.lighting.type){case"sun":return this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(i.lighting):Ra.fromWebsceneLighting(i.lighting);case"virtual":return this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(i.lighting):ah.fromWebsceneLighting(i.lighting);default:return Pl(i.lighting),Ra.fromWebsceneLighting(i.lighting)}}};c([m({nonNullable:!0})],lh.prototype,"lighting",void 0),c([_l("lighting")],lh.prototype,"castLighting",null),lh=oh=c([I("esri.views.3d.environment.SceneViewEnvironment")],lh);const Uo=lh;var ht;(function(i){i[i.NONE=0]="NONE",i[i.TILT=1]="TILT",i[i.ALTITUDE=2]="ALTITUDE",i[i.DISTANCE=4]="DISTANCE",i[i.COLLISION=8]="COLLISION",i[i.ALL=15]="ALL",i[i.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"})(ht||(ht={}));var Re;(function(i){i[i.NONE=0]="NONE",i[i.ZOOM=1]="ZOOM",i[i.TUMBLE=2]="TUMBLE",i[i.LOOK_AROUND=3]="LOOK_AROUND",i[i.PAN=4]="PAN",i[i.ASCEND=5]="ASCEND"})(Re||(Re={}));var Br;(function(i){i[i.TUMBLE=0]="TUMBLE",i[i.LOOK_AROUND=1]="LOOK_AROUND"})(Br||(Br={}));let Ps=class{constructor(e=ht.ALL,t=Re.NONE,s=0,r=null,n=null,a=Br.TUMBLE){this.selection=e,this.interactionType=t,this.interactionFactor=s,this.interactionStartCamera=r,this.interactionDirection=n,this.tiltMode=a}};function Jh(i,e){return!!(i&e)}function yu(i,e,t,s,r,n){i!==0&&(t?(n.min=Math.min(n.min,e),n.max=Math.max(n.max,e)):s!=null?(n.min-=Math.max(0,(e-n.min)*(1-s)),n.max+=Math.max(0,(e-n.max)*(1-s))):r&&(n.min-=Math.max(0,e-n.min-r),n.max+=Math.max(0,e-n.max-r)))}const oo=new Ps(ht.NONE);function fb(i,e,t,s){return e=e||i.viewForward,ue(s,e),ie(s,s,Math.sign(ce(e,t))),s}function kE(i,e,t=oo){const s=ng(i,e,t);if(s===0)return!1;const r=i.renderCoordsHelper,n=r.getAltitude(e.eye)+s,a=fb(e,t.interactionDirection,QE(i,e,Math.sign(s),KE),ZE),o=ue(JE,e.viewForward),l=r.intersectInfiniteManifold(bl(e.eye,a),n,up);return e.eye=l??r.setAltitude(up,n,e.eye),e.center=iC(up,e.eye,o,e.center),!0}function ng(i,e,t=oo){if(!jE(i,t)||!i.state.constraints.altitude)return 0;const s=XE(i.state.constraints.altitude,YE);WE(i,t,s);const r=i.renderCoordsHelper.getAltitude(e.eye),n=W(r,s.min,s.max)-r;return Math.abs(n)<=1e-6?0:n}function jE(i,e){const t=i.state.constraints.altitude;return!(!i.state.isGlobal||!t)&&(e.interactionType!==Re.TUMBLE||!Jh(e.selection,ht.TILT))}function WE(i,e,t){const s=e.interactionType;if(s===Re.NONE)return;const{min:r,max:n}=t,{interactionStartCamera:a,interactionFactor:o}=e;if(!a)return;const l=s===Re.TUMBLE||s===Re.ZOOM,h=ng(i,a),d=h===0?0:i.renderCoordsHelper.getAltitude(a.eye);t.min=r,t.max=n,yu(h,d,l,o,.05*d,t)}function QE(i,e,t,s){return i.renderCoordsHelper.worldUpAtPosition(e.eye,s),ie(s,s,t),s}function XE(i,e){return e.min=i.min,e.max=i.max,e}const YE={min:0,max:0},ZE=v(),KE=v(),JE=v(),up=v();function ag(i,e,t=oo){if(!i.state.isLocal)return 0;const s=i.state.constraints.distance;if(!i.pointsOfInterest.surfaceOrigin.renderLocation||s===1/0)return 0;Rc.min=0,Rc.max=s,tM(i,t,Rc);const r=og(i,e),n=Rc.max-r;return n>=-1e-6?0:n}function eM(i,e,t=oo){const s=ag(i,e,t);if(s===0)return!1;const r=i.pointsOfInterest.surfaceOrigin;if(!r.renderLocation)return!1;const n=og(i,e)+s,a=ue(sM,e.eye),o=fb(e,t.interactionDirection,iM(e,r.renderLocation,aM),nM);if(!Uu(tP(r.renderLocation,n),bl(e.eye,o),Ac))return!1;e.eye=Ac;const l=Te(rM,e.eye,a);e.center=ye(Ac,e.center,l);const h=i.renderCoordsHelper.getAltitude(e.center),d=i.renderCoordsHelper.intersectInfiniteManifold(e.ray,h,Ac);return d!=null&&(e.center=d),!0}function tM(i,e,t){const s=e.interactionType;if(s===Re.NONE)return;const{min:r,max:n}=t,{interactionStartCamera:a,interactionFactor:o}=e;if(!a)return;const l=s===Re.ZOOM||s===Re.PAN,h=ag(i,a),d=h===0?0:og(i,a);t.min=r,t.max=n,yu(h,d,l,o,.05*d,t)}function og(i,e){const t=i.pointsOfInterest.surfaceOrigin;return t.renderLocation?ki(e.eye,t.renderLocation):0}function iM(i,e,t){return $_(t,i.eye,e)}const Rc={min:0,max:0},sM=v(),rM=v(),nM=v(),aM=v(),Ac=v();function Rl(i,e,t=ks.EYE){const s=i.state.constraints;if(!s.collision.enabled)return!1;const r=M_(i,e.eye),n=i.renderCoordsHelper.getAltitude(e.eye),a=r+s.collision.elevationMargin;if(n>=a)return!1;const o=Ce(e.eye);if(Te(Dc,e.center,e.eye),e.eye=i.renderCoordsHelper.setAltitude(oM,a,e.eye),t===ks.EYE_AND_CENTER)e.center=ye(Dc,e.eye,Dc);else if(t===ks.EYE_AND_CENTER_SCALE){const l=(o-n+a)/o;e.center=ie(Dc,e.center,l)}return!0}var ks;(function(i){i[i.EYE=0]="EYE",i[i.EYE_AND_CENTER=1]="EYE_AND_CENTER",i[i.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})(ks||(ks={}));const Dc=v(),oM=v();function yb(i,e,t,s=!0){Bl.eyeCenterDistance=0,Bl.requiresTwoSteps=!1;const r=lg(i,e,t,oo,Bl);if(r===0)return!1;switch(Ka($c,-r,e.viewRight),t.tiltMode){case Br.LOOK_AROUND:Wt(On,e.viewForward,$c),ie(On,On,Bl.eyeCenterDistance),e.center=ye(Bn,e.eye,On);break;case Br.TUMBLE:Te(On,e.center,e.eye),Wt(On,On,$c),e.eye=Te(Bn,e.center,On);break;default:Pl(t.tiltMode)}return e.up=Wt(Bn,e.up,$c),!Bl.requiresTwoSteps||!s||yb(i,e,t,!1)}function lg(i,e,t,s=oo,r){if(!i.state.constraints.tilt)return 0;const n=e.distance,a=i.state.constraints.tilt(n,fM);return gM(i,t,a),s.interactionType===Re.TUMBLE&&Jh(s.selection,ht.ALTITUDE)&&vb(i,s.interactionStartCamera,a),t.tiltMode===Br.LOOK_AROUND||s.tiltMode===Br.LOOK_AROUND?hM(i,e,a,r):lM(i,e,a)}function lM(i,e,t){const s=ia(i.renderCoordsHelper,e.center,e.eye),r=s-W(s,t.min,t.max);return ec(r)?r:0}function hM(i,e,t,s){switch(s&&(s.requiresTwoSteps=!1),i.viewingMode){case"global":return dM(i,e,t,s);case"local":return cM(i,e,t,s)}}function cM(i,e,t,s){const r=ia(i.renderCoordsHelper,e.center,e.eye),n=W(r,t.min,t.max),a=r-n;if(!ec(a))return 0;if(s){const o=Math.abs(i.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude),l=i.renderCoordsHelper.getAltitude(e.eye)-o,h=Math.max(Math.cos(n),1e-4);Math.abs(h)>1e-4?s.eyeCenterDistance=l/h:s.eyeCenterDistance=e.distance}return a}function dM(i,e,t,s){const r=uM(i,e,yM),n=W(r.tiltAtCenter,t.min,t.max);if(!ec(r.tiltAtCenter-n))return 0;let a,o;return r.centerIsOnSurface?(a=pM(r),o=mM(r,a)):(a=r.constraints.clampTilt(r.eyeCenterDistance,r.tiltAtCenter),s&&a<Math.PI/2&&(s.requiresTwoSteps=!0,a=Math.PI/2-1e-5),o=_M(r,a)),s&&(s.eyeCenterDistance=Nm(r,a)),o}function uM(i,e,t){const s=i.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=s+Ot(i.spatialReference).radius,n=i.renderCoordsHelper.intersectManifold(e.ray,s,Bn);return t.eyeCenterDistance=e.distance,t.centerIsOnSurface=!1,n!=null?(t.eyeCenterDistance=ki(e.eye,n),t.tiltAtCenter=ia(i.renderCoordsHelper,n,e.eye),t.centerIsOnSurface=!0):i.state.isLocal?t.tiltAtCenter=ia(i.renderCoordsHelper,e.center,e.eye):(zu(k_(j_,r),e.ray,Bn),t.eyeCenterDistance=ki(e.eye,Bn),t.tiltAtCenter=sa(-ce(e.viewForward,ae(Bn,Bn)))),t.radius=r,t.eyeRadius=Ce(e.eye),t.constraints=i.state.constraints,t}function ec(i){return Math.abs(i)>1e-9}function pM(i){const{constraints:e,eyeCenterDistance:t,tiltAtCenter:s}=i;let r=s,n=e.clampTilt(t,s);const a=Nm(i,n);if(e.clampTilt(a,s)===n)return n;let o=0;for(;o<10&&ec(n-r);){const l=(r+n)/2,h=Nm(i,l);ec(e.clampTilt(h,l)-l)?r=l:n=l,o++}return n}function Nm(i,e){if(!i.centerIsOnSurface)return i.eyeCenterDistance;const t=Math.PI-W(e,0,Math.PI),s=tu(i.radius/i.eyeRadius*Math.sin(t)),r=Math.PI-t-s,n=Math.sin(r)/Math.sin(t);if(i.eyeRadius<i.radius&&n>1){const a=Math.PI-s,o=Math.PI-t-a;return Math.sin(o)/Math.sin(t)*i.eyeRadius}return n*i.eyeRadius}function mM(i,e){const t=tu(i.radius/i.eyeRadius*Math.sin(i.tiltAtCenter)),s=tu(i.radius/i.eyeRadius*Math.sin(e));return i.eyeRadius>i.radius?t-s:s-t}function _M(i,e){return i.tiltAtCenter-Math.PI/2-(e-Math.PI/2)}function gM(i,e,t){if(e.interactionType===Re.NONE)return;const{interactionStartCamera:s,interactionFactor:r}=e;if(!s)return;const{min:n,max:a}=t,o=lg(i,s,oo,e),l=o===0?0:ia(i.renderCoordsHelper,s.center,s.eye);t.min=n,t.max=a,e.interactionType===Re.TUMBLE?(Jh(e.selection,ht.ALTITUDE)&&vb(i,s,t),yu(o,l,!0,r,l0,t)):yu(o,l,!1,r,l0,t)}function vb(i,e,t){const s=i.state.constraints;if(i.state.isLocal||!s.altitude||!e)return;const r=Hs(e.center),n=Math.sqrt(r),a=e.distance,o=Ot(i.spatialReference).radius,l=s.altitude.min+o,h=s.altitude.max+o,d=(l*l-a*a-r)/(-2*n*a),u=(h*h-a*a-r)/(-2*n*a);t.min=Math.max(t.min,Math.min(Math.PI-sa(u),t.max)),t.max=Math.min(t.max,Math.PI-sa(d))}const On=v(),$c=Nt(),Bn=v(),l0=Et(5),fM={min:0,max:0},yM={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},Bl={eyeCenterDistance:0,requiresTwoSteps:!1};function Mt(i,e,t=xM,s=e){s!==e&&s.copyFrom(e),s.computeUp(i.state.viewingMode);let r=!1;for(let o=0;o<CM;o++){let l=0;for(const h of wM)if(Jh(t.selection,h.type)){const d=Math.abs(h.error(i,s,t));h.apply(i,s,t)&&(r=!0,l+=d)}if(l===0)break}const n=Jh(t.selection,ht.COLLISION),a=vM(t.interactionType,i);return n&&Rl(i,s,a)&&(r=!0),r&&s.computeUp(i.state.viewingMode),r}function vM(i,e){switch(i){case Re.PAN:return ks.EYE_AND_CENTER;case Re.ASCEND:return e.state.isGlobal?ks.EYE_AND_CENTER_SCALE:ks.EYE_AND_CENTER;default:return ks.EYE}}function zs(i){const e=Math.min(1,i/150);return PC(e)}function bM(i,e,t){return lg(i,e,t)*e.distance}const wM=[{type:ht.TILT,error:bM,apply:yb},{type:ht.ALTITUDE,error:ng,apply:kE},{type:ht.DISTANCE,error:ag,apply:eM}],xM=new Ps,CM=5;let h0=class{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=v(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=ta(c0),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotate(){const e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,t){if(this.viewingMode===Ne.Global){const n=(Ce(this.center)+Ce(e.center))/2;t.pan=D_(this.center,e.center)*n}else t.pan=ki(this.center,e.center);let s=Math.abs(e._yaw-this._yaw);s>=Math.PI&&(s=2*Math.PI-s);const r=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(s,r),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}interpolate(e,t,s){this.viewingMode===Ne.Global?RT(e.center,t.center,s.pan,this.center):vr(this.center,e.center,t.center,s.pan),this._distance=isFinite(t.distance)?ke(e.distance,t.distance+s.zoomOffset,s.zoom):e.distance,this._pitch=ke(e.pitch,t.pitch,s.rotate);let r=e._yaw;const n=t._yaw;Math.abs(n-r)>=Math.PI&&(r+=2*(r<n?1:-1)*Math.PI),this._yaw=ke(r,n,s.rotate),this._fov=ke(e.fov,t.fov,s.fov)}copyFrom(e){ue(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,ue(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,d0);ue(this.center,e.center),Te(yi,e.center,e.eye),mn(yi,yi,t),mn(An,e.up,t),this._distance=Ce(yi),this._distance!==0&&(yi[0]/=this._distance,yi[1]/=this._distance,yi[2]/=this._distance),this._pitch=TM(yi),this._yaw=SM(yi,An),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,d0);Vu(t,t),this._axisAngleVec3(xd,this._pitch-Math.PI/2,c0,yi),this._axisAngleVec3(qa,this._yaw,yi,yi),this._axisAngleVec3(xd,this._pitch-Math.PI/2,qa,An),this._axisAngleVec3(qa,this._yaw,An,An),ie(yi,yi,this._distance),mn(yi,yi,t),mn(An,An,t),e.center=this.center,e.eye=Te(yi,this.center,yi),e.up=An,e.fov=this._fov}_axisAngleVec3(e,t,s,r){const n=Math.cos(t),a=Math.sin(t);return ie(ys,s,n),gt(ps,e,s),ie(ps,ps,a),ie(Rn,e,(1-n)*ce(e,s)),ye(r,ye(r,ys,ps),Rn)}_lookAtOrientation(e,t=xn()){return this._upAtLookAt(e,Rn),gt(ys,this.direction,Rn),ae(ys,ys),ys[0]===0&&ys[1]===0&&ys[2]===0&&ue(ys,xd),gt(ps,Rn,ys),ae(ps,ps),t[0]=ys[0],t[1]=ps[0],t[2]=Rn[0],t[3]=ys[1],t[4]=ps[1],t[5]=Rn[1],t[6]=ys[2],t[7]=ps[2],t[8]=Rn[2],t}_upAtLookAt(e,t){return this.viewingMode===Ne.Local?ue(t,qa):ae(t,e)}};function TM(i){return Math.PI-D_(qa,i)}function SM(i,e){const t=PM;return Math.abs(e[2])<.5?(ue(t,e),i[2]>0&&ie(t,t,-1)):ue(t,i),gt(ps,t,qa),ae(ps,ps),D_(xd,ps,qa)}const ys=v(),ps=v(),Rn=v(),yi=v(),An=v(),PM=v(),qa=jx,c0=Wx,xd=Qx,d0=xn();let EM=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=nt(0),this._animation=new EC(()=>new h0(e)),this._current=new h0(e)}update(e,t,s){const{source:r,target:n}=this._animation.definition,a=Te(MM,t.center,e.center),o=Ce(a);o>=1e-5?(a[0]/=o,a[1]/=o,a[2]/=o):(a[0]=0,a[1]=1,a[0]=0),ue(r.direction,a),ue(n.direction,a),r.copyFromRenderCamera(e),n.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,n,s),this.currentTime=nt(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){this._animation.cameraAt(e,this._current),this._current.copyToRenderCamera(t)}step(e,t){this.finished||(this.currentTime=nt(this.currentTime+Rx(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}};const MM=v();var ct;(function(i){i[i.Ready=0]="Ready",i[i.Rejected=1]="Rejected",i[i.Running=2]="Running",i[i.Stopped=3]="Stopped",i[i.Finished=4]="Finished"})(ct||(ct={}));let cn=class extends De{constructor(e){super(e),this.state=ct.Ready}get running(){return this.state===ct.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=ct.Stopped,!0)}finishController(){this.state=ct.Finished}get steppingFinished(){return!1}};c([m({constructOnly:!0})],cn.prototype,"view",void 0),c([m({readOnly:!0})],cn.prototype,"running",null),c([m()],cn.prototype,"state",void 0),c([m({readOnly:!0})],cn.prototype,"isInteractive",null),cn=c([I("esri.views.3d.state.controllers.CameraController")],cn);let tc=class extends cn{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(hr()),this._asyncResult=null),this.state===ct.Finished||this.state===ct.Stopped?(Ax(e),this.state===ct.Finished?e.resolve():e.reject(hr())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=ct.Running,this.viewAnimation!=null&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!this.viewAnimation||this.state!==ct.Ready&&this.state!==ct.Running||(this.viewAnimation.state===fl.State.FINISHED?this.finish():this.viewAnimation.state===fl.State.STOPPED&&(this.state=ct.Stopped))}onControllerEnd(e){this.viewAnimation==null||this.viewAnimation.done||(this.state===ct.Finished?this.viewAnimation.finish():this.state===ct.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===ct.Finished?this._asyncResult.resolve():this._asyncResult.reject(hr()))}finish(){this.finishController()}};tc=c([I("esri.views.3d.state.controllers.AnimationController")],tc);let Ha=class extends tc{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.type="point-to-point",this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new EM(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new fl}get isInteractive(){return this.mode==="interaction"}begin(e,t){this._hasTarget=!0;const s=this.animationSettings(t);Ic.copyFrom(this.view.state.camera);const r=Cn(this.view.state.viewingMode);this._intersectionHelper.intersectRay(Ic.ray,r,u0)&&(Ic.center=u0),this.animation.update(Ic,e,s),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:typeof e.easing=="string"?MC[e.easing]:e.easing}}};c([m({constructOnly:!0})],Ha.prototype,"mode",void 0),c([m({readOnly:!0})],Ha.prototype,"isInteractive",null),Ha=c([I("esri.views.3d.state.controllers.PointToPointAnimationController")],Ha);const Ic=new xt,u0=v();function p0(i){return i!=null&&"type"in i&&i.type==="point-to-point"}function Gu(i=RM){return[i[0],i[1],i[2],i[3]]}function ic(i,e){return OM(i[0],i[1],i[2],e,lP.get())}function OM(i,e,t,s,r=Gu()){return r[0]=i,r[1]=e,r[2]=t,r[3]=s,r}function hg(i,e,t){return gt(t,i,e),ae(t,t),t[3]=U1(i,e),t}const RM=[0,0,1,0];function cg(i,e,t,s){const r=Ml(e,t,AM);return Uu(i,r,s)}const AM=ao();var xl;(function(i){i[i.Ellipsoid=0]="Ellipsoid",i[i.Silhouette=1]="Silhouette"})(xl||(xl={}));const bb=30,vu=[1,3e8],_c=80,wb=8,xb=200,Cb=1508e5,Tb=5,Sb=50,DM=5,$M=10,pp=90,lo={exclude:new Set([Qh])};function Wa(i,e,t){return t[0]=e[0]/(i.fullWidth/i.pixelRatio),t[1]=e[1]/(i.fullHeight/i.pixelRatio),t}function Vm(i){for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}function la(i,e,t){const s=Ka(hP.get(),t[3],t);s==null||nS(s,xh)||(Te(st,i.eye,e),Wt(st,st,s),i.eye=ye(st,st,e),Te(st,i.center,e),Wt(st,st,s),i.center=ye(st,st,e),i.up=Wt(st,i.up,s))}function IM(i,e,t,s){return W_(i,H1(e,t,pg),s)}function Fm(i,e,t,s){return W_(i,Ml(e,t,pg),s)}function dg(i,e,t,s){const r=bt.get();let n=1-t;Te(r,e,i.eye);const a=Ce(r);let o=a*(1-n);n>=0&&o<s&&(o=s,n=-(o-a)/a),Math.abs(a-o)<1e-6||(ie(r,r,n),i.eye=ye(st,i.eye,r),i.center=vr(st,i.center,e,n))}function Pb(i,e,t){e.getScreenCenter(m0),cg(i,e,m0,st)&&(e.center=st);const s=e.distance,r=s*t;if(Math.abs(s-r)<1e-6)return;const n=ie(bt.get(),e.viewForward,r);e.eye=Te(st,e.center,n)}const m0=ri();function mp(i,e){$e(e,0,0,0);for(const t of i)ye(e,e,t);ie(e,e,1/i.length)}function Cd(i,e,t,s){return Math.sin(i/Ce(e))*(t+s.radius)}function _0(i,e,t,s){return Cd(Math.PI/2,e,t,s)+(i-Math.PI/2)}var Pi;(function(i){i[i.Vertical=0]="Vertical",i[i.Horizontal=1]="Horizontal"})(Pi||(Pi={}));const g0={Elevation:3e4,Angle:Et(16)},Lc={Pole:.95,Angle:Et(18),Tilt:45},Eb=Et(80);function Mb(i,e,t,s,r,n){const a=v(),o=wr();let l=!0,h=!0;return i.intersectScreen(t,a,n)?o[3]=Ce(a):(h=!1,e.aboveGround&&r!==xl.Ellipsoid?o[3]=Math.max(Ce(e.center),.9*s.radius):o[3]=Ce(e.eye)-e.relativeElevation,r===xl.Silhouette?sc(o,e,t,a):l=cg(o,e,t,a)),{sphere:o,scenePickPoint:l?a:null,hasGeometryIntersection:h}}function gc(i,e,t,s){const r=i.relativeElevation;if(r>g0.Elevation&&s==="global")return Pi.Horizontal;Ml(i,e,gp);const n=Math.sign(r),a=t.worldUpAtPosition(i.eye,st);return-n*ce(a,gp.direction)<Math.sin(g0.Angle)*Ce(gp.direction)?Pi.Vertical:Pi.Horizontal}function Ob(i,e,t){Te(_p,t,e),i.eye=Te(st,i.eye,_p),i.center=Te(st,i.center,_p)}const _p=v();function sc(i,e,t,s){const r=Ml(e,t,pg);return r!=null&&(zu(i,r,Nc),Uu(i,r,s)?!(Qn(Nc,r.origin)<Qn(s,r.origin))||(ue(s,Nc),!1):(Te(bo,e.eye,e.center),ae(bo,bo),z1(bo,-ce(ae(bo,bo),Nc),f0),W_(f0,r,s),!1))}const Nc=v(),bo=v(),f0=Wh();function Rb(i,e,t,s,r,n){let a=0;if(gt(xu,i,e),Te(zc,i,e),Ce(i)<=r||!s.aboveGround){gt(t,zc,s.eye);const o=ce(i,e)/(Ce(i)*Ce(e));if(o<.9999)a=sa(o);else{const h=Ce(gt(v(),i,e))/(Ce(i)*Ce(e));a=tu(h)}const l=Math.cos(W(na.normalize(Et(n)),0,Eb));a=-a-Math.max(0,Ce(e)-r)/(l*r)}else Te(y0,s.eye,s.center),gt(t,zc,y0),a=-Ce(zc)/r;return ae(t,t),ie(t,t,Ce(xu)),a}const y0=v();function v0(i,e,t,s){let r,n;const a=Math.cos(W(na.normalize(Et(s)),0,Eb));return r=e>t?-(e-t)/(a*t):e<-t?Math.PI-(e+t)/(a*t):sa(e/t),n=i>t?-(i-t)/(a*t):i<-t?Math.PI-(i+t)/(a*t):sa(i/t),(n-r)*t}function LM(i,e,t,s,r,n,a,o,l,h){const d=v0(i[2],e[2],n[3],o),u=l?v0(i[0],e[0],n[3],180):e[0]-i[0],p=Math.sin(a)*u-Math.cos(a)*d,_=Math.cos(a)*u+Math.sin(a)*d;ae(st,r);const f=l?p/Math.sqrt(Math.abs(n[3]**2-ce(t,st)**2)):p/n[3],g=_/Math.sqrt(Math.abs(n[3]**2-ce(t,s)**2));ro(h,f,g)}function Ab(i,e,t,s,r,n,a,o,l,h){gt(xu,i,e),bm(n.up,n.eye,Vc,Fc,Uc),bm([0,0,1],n.eye,bn,Yn,Lb),ue(t,Yn),ue(s,bn),ae(t,t),ie(t,t,Ce(xu)),cf(i,ae(Fc,Fc),ae(Uc,Uc),ae(Vc,Vc),b0),cf(e,Fc,Uc,Vc,w0),LM(b0,w0,i,bn,Yn,a,o,l,h,r)}function NM(i,e,t,s,r,n,a){Ka(bu,r,s),Ka(wu,a,n),_r(Zo,bu,wu),Te(e,i,t),Wt(e,e,Zo),ye(e,e,t)}function Db(i,e,t,s,r,n){Ka(bu,s,t),Ka(wu,n,r),_r(Zo,bu,wu),Te(st,i.eye,e),Wt(st,st,Zo),i.eye=ye(st,st,e),Te(st,i.center,e),Wt(st,st,Zo),i.center=ye(st,st,e),Te(st,i.up,e),Wt(st,st,Zo),i.up=ye(st,st,e)}function ug(i,e,t,s,r,n){return(Math.abs(s)>Math.PI-Lc.Angle||Math.abs(s)<Lc.Angle)&&(Math.abs(i[2])<t*Lc.Pole||Math.abs(e)>t)&&n.aboveGround&&r<Lc.Tilt}function $b(i,e,t,s,r,n){if(n)hg(t,s,x0),la(e,At(i),x0);else{const a=Rb(t,s,C0,e,i[3],r);la(e,At(i),ic(C0,a))}}function Ib(i,e,t,s,r,n,a){const o=a?20:1,l=1e-12;let h,d;ue(fa,s),qc.copyFrom(e);for(let u=0;u<o&&Qn(t,fa)>l&&(h=Qn(t,fa),Ab(t,fa,Yn,bn,Gl,qc,i,r,n,a),Db(qc,At(i),bn,Gl[1],Yn,Gl[0]),NM(fa,fa,At(i),bn,Gl[1],Yn,Gl[0]),d=Qn(t,fa),d<h||u===0);u++)e.copyFrom(qc)}function VM(i,e,t,s,r,n,a){ug(t,ce(e.up,t),i[3],-na.normalize(Et(r)),n,e)?Ib(i,e,t,s,-na.normalize(Et(r)),n,a):$b(i,e,t,s,n,a)}function FM(i,e,t,s,r,n){const{eye:a}=i;bm([0,0,1],a,bn,Yn,Lb);const o=e.translation[0]*t.pan,l=r.mode==="zoom"?0:e.translation[1]*t.pan,h=Math.max(Math.sqrt(Math.abs(1-ce(i.center,bn)**2/Ce(i.center)**2)),.5),d=(Math.sin(n)*l+Math.cos(n)*o)/h,u=-Math.cos(n)*l+Math.sin(n)*o;switch(_n(s.pan.matrix,s.pan.matrix,d,bn),s.pan.enabled=!0,r.mode){case"pan":_n(s.pan.matrix,s.pan.matrix,u,Yn),s.pan.enabled=!0;break;case"zoom":s.zoom=-e.translation[1]*t.zoom}}function UM(i,e,t,s,r){const{eye:n,viewRight:a}=i,o=gt(bt.get(),a,n),l=e.translation[0]*t.pan;switch(l!==0&&(_n(s.pan.matrix,s.pan.matrix,-l,o),s.pan.enabled=!0),r.mode){case"pan":{const h=e.translation[1]*t.pan;h!==0&&(_n(s.pan.matrix,s.pan.matrix,h,a),s.pan.enabled=!0);break}case"zoom":s.zoom=-e.translation[1]*t.zoom}}function zM(i,e,t,s,r,n,a,o,l){ug(i.center,ce(i.up,i.center),Ce(i.center),-na.normalize(Et(n)),a,e)?FM(e,t,s,o,l,-na.normalize(Et(r))):UM(e,t,s,o,l)}const bn=v(),Yn=v(),Lb=v(),Vc=v(),Fc=v(),Uc=v(),b0=v(),w0=v(),Gl=Ss(),x0=Gu(),bu=Nt(),wu=Nt(),Zo=Nt(),fa=v(),st=v(),zc=v(),qc=new xt,xu=v(),C0=v(),pg={origin:v(),direction:v()},gp={origin:v(),direction:v()},T0=.6,fp=4,qM=60;let Cu=class extends Ha{constructor(){super(...arguments),this._zoomLocation=v(),this._tmpCamera=new xt,this._tmpViewDir=v(),this._tmpRayDir=ao(),this._targetOnSphere=v(),this._tmpCenter=v(),this._beginCamera=new xt,this._constraintOptions=new Ps(ht.ALL_EXCEPT_COLLISION,Re.ZOOM,null,this._beginCamera),this._sphere=wr()}initialize(){this._intersector=Cn(this.view.state.viewingMode)}step(e,t){if(!this.running)return;const s=this.view.state;this.animation.finished?this._beginCamera.copyFrom(s.camera):this.animation.cameraAt(1,this._beginCamera);let r=!1,n=!1;this._intersectionHelper.intersectScreen(t,this._zoomLocation,this.view.map.ground.opacity===0?lo:{})&&(r=e>0,n=!0),this._tmpCamera.copyFrom(s.camera),r?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:ue(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,t,n),this.begin(this._tmpCamera)}animationSettings(){return{duration:nt(600),easing:t1}}_updateCamera(e,t,s,r){const n=gc(e,s,this.view.renderCoordsHelper,this.view.viewingMode),a=Math.abs(this.view.camera.position.z),o=this._zoomLocation;ae(Bc,e.eye),ie(Bc,Bc,-1),Ml(e,s,this._tmpRayDir),ae(this._tmpRayDir.direction,this._tmpRayDir.direction);const l=W(Math.min(wb,1/Math.abs(ce(Bc,this._tmpRayDir.direction)))*a,xb,Cb);if(n===Pi.Horizontal){let h=T0**t;this._sphere[3]=Ce(o),Te(this._tmpViewDir,e.center,e.eye);const d=Math.min(Ce(this._tmpViewDir),l);let u=d*h;if(h<=1&&u<fp&&(u=fp,h=u/d),Math.abs(d-u)<1e-6)return;const p=Ce(e.center);if(this._sphere[3]!==p){const _=this._sphere[3]+h*(p-this._sphere[3]);e.center=ie(Hc,e.center,_/p)}ie(this._tmpViewDir,this._tmpViewDir,-h),e.eye=ye(Hc,e.center,this._tmpViewDir),Mt(this.view,e,this._constraintOptions),Qn(o,e.center)>1e-12&&cg(this._sphere,e,s,this._targetOnSphere)&&VM(this._sphere,e,o,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let h=T0**Math.abs(t);const d=t>0?1:-1;Te(this._tmpViewDir,o,e.eye);const u=Ce(this._tmpViewDir),p=this.view._stage.renderView.getMinimalDepthForArea(null,s[0],s[1],this.view.state.camera,qM);let _=p??l;_=r&&t>0?Math.min(_,u):_,ie(this._tmpRayDir.direction,this._tmpRayDir.direction,_),ye(o,this._tmpRayDir.origin,this._tmpRayDir.direction);let f=_*h;const g=Math.max(fp,1.01*e.nearFar[0]);if(t>0&&f<g&&(f=g,h=f/_),Math.abs(_-f)<1e-6)return;ie(this._tmpRayDir.direction,this._tmpRayDir.direction,d*(1-h)),e.eye=ye(Hc,e.eye,this._tmpRayDir.direction),e.center=ye(Hc,e.center,this._tmpRayDir.direction)}Rl(this.view,e)}};Cu=c([I("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],Cu);const Hc=v(),Bc=v();let Td,Sd=null;const cl=new Map;async function fF(i){Sd==null&&(Td==null&&(Td=X(()=>import("./VoxelWasmPerSceneView-BQX7kK6C.js"),__vite__mapDeps([562,1,12,2,4,5,6,20,21,22,23,24,7,154,45,13,46,32,8,33,172,16,9,10,11,61,74,86,3,14,15,17,18,173,85,69,65,35,39,66,36,34,37,38,31,40,70,64,67,68,71,72,73,62,108,466,80,48,81,60,43,44,47,42,50,51,82,83,41,49,52,53,54,55,28,56,57,58,59,84,241,220,236,207,165,166,155,97,208,75,209,212,213,93,92,214,215,216,95,90,96,88,76,94,89,91,87,78,98,99,100,101,102,167,168,169,170,171,26,30,63,77,79,103,104,105,106,107,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,133,174,141,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,153,190,150,151,152,191,192,193,194,195,25,27,196,197,198,199,200,201,202,203,204,205,206,210,132,134,135,211,217,218,219,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,237,238,239,240,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,136]),import.meta.url)),Sd=await Td);const e=i.view;let t=cl.get(e);return t||(t=new Sd.default({view:e}),cl.set(e,t)),t.addVoxelLayer(i)}function rc(i){return cl.get(i)}function yF(i){const e=i.view,t=cl.get(e);t&&t.removeVoxelLayer(i)<1&&(cl.delete(e),cl.size===0&&(Td=null,Sd=null))}const HM=.6,BM=4,GM=60;let Tu=class extends Ha{constructor(){super(...arguments),this._zoomLocation=v(),this._tmpCamera=new xt,this._tmpRayDir=v(),this._tmpCenter=v(),this._beginCamera=new xt,this._constraintOptions=new Ps(ht.ALL,Re.ZOOM,null,this._beginCamera)}step(e,t){if(!this.running)return;const s=this.view.state;this.animation.finished?this._beginCamera.copyFrom(s.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(s.camera);const r=Cn(this.view.state.viewingMode);let n=!1;e>0?(n=this._intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.map.ground.opacity===0?lo:{}),this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:ue(this._zoomLocation,this._tmpCamera.center);const a=HM**e;let o=this.view._stage.renderView.getMinimalDepthForArea(rc(this.view),t[0],t[1],this.view.state.camera,GM);Te(Gc,this._tmpCamera.eye,this._zoomLocation),ae(Gc,Gc);const l=W(Math.min(wb,1/Math.abs(ce(kM,Gc)))*Math.abs(this.view.camera.position.z),xb,Cb);if(o=o??l,o){const h=v();Te(h,this._zoomLocation,this._tmpCamera.eye),(o<Ce(h)||!n)&&(ae(h,h),ye(this._zoomLocation,this._tmpCamera.eye,ie(h,h,o)))}this._updateCamera(this._tmpCamera,a,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:nt(600),easing:t1}}_updateCamera(e,t,s){Te(this._tmpRayDir,s,e.eye);const r=Ce(this._tmpRayDir);let n=r*t;const a=t<=1,o=Math.max(BM,1.01*e.nearFar[0]);n!==0&&(a&&n<o&&(n=o,t=n/r),Math.abs(r-n)<1e-6||(ie(this._tmpRayDir,this._tmpRayDir,t),e.eye=Te(S0,s,this._tmpRayDir),e.center=vr(S0,e.center,s,1-t),Mt(this.view,e,this._constraintOptions)))}};Tu=c([I("esri.views.3d.state.controllers.ZoomStepControllerLocal")],Tu);const S0=v(),kM=Pt(0,0,1),Gc=v();let jM=class extends Tr{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,s=>this._handleDoubleClick(s))}_handleDoubleClick(e){const t=e.data;if(OC(t,"primary")){const s=this._view.state.isGlobal?new Cu({view:this._view,mode:"animation"}):new Tu({view:this._view,mode:"animation"});this._view.state.switchCameraController(s),s.step(Math.log(.5)/Math.log(.6),ri(t.x,t.y)),e.stopPropagation()}}};function mg(i){return W((i-1e5)/9e5,0,1)}const Um=1e4,Pd=Pt(parseFloat(5802e-9.toFixed(6)),parseFloat(13558e-9.toFixed(6)),parseFloat(331e-7.toFixed(6))),yp=3,vp=Pt(yp*parseFloat(65e-8.toFixed(6)),yp*parseFloat(1881e-9.toFixed(6)),yp*parseFloat(85e-9.toFixed(6))),WM=3996e-9,QM=Pt(parseFloat(Number(Pd[0]+vp[0]).toFixed(6)),parseFloat(Number(Pd[1]+vp[1]).toFixed(6)),parseFloat(Number(Pd[2]+vp[2]).toFixed(6)));function XM(i,e,t){return i===Ne.Global?new ZM(t):new YM(e,t)}let YM=class{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=Ot(t),this._unitInMeters=fm(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,s,r,n){var T;n||(n={near:0,far:0});let a=e[2]*this._unitInMeters;const o=a,l=a-r,h=(T=this._elevationProvider)==null?void 0:T.visibleElevationBounds;h&&(a=l>=0?o-this._unitInMeters*h.min:this._unitInMeters*h.max-o);const d={x:(s=s??new Nr({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-s.xmin,y:s.ymax-s.ymin,z:4*Math.max(s.xmax-s.xmin,s.ymax-s.ymin)},u=Math.max(d.x,d.y,d.z);Te(ya,t,e),wo[0]=ya[0]>0?s.xmax:s.xmin,wo[1]=ya[1]>0?s.ymax:s.ymin,wo[2]=ya[2]>0?u/2:-u/2,Te(wo,wo,e),ae(ya,ya);const p=1.1*ce(wo,ya)*this._unitInMeters,_=Math.sqrt(a*(a+2*this._referenceEllipsoid.radius)),f=Math.max(s.xmax-s.xmin,s.ymax-s.ymin),g=f*eO*this._unitInMeters,y=f*tO*this._unitInMeters,w=W((a-y)/(g-y),0,1)**3,x=Math.min(ke(_,p,w),_)*Math.max(Math.log(Math.abs(l)),1);return Nb(Math.min(x,Math.max(34064e4,u))/this._unitInMeters,KM,this._unitInMeters,n)}},ZM=class{constructor(e){this._referenceEllipsoid=Ot(e)}compute(e,t,s,r,n){n||(n={near:0,far:0});const a=Ce(e),o=a-this._referenceEllipsoid.radius,l=this._referenceEllipsoid.radius+Math.min(0,r),h=Math.abs(o-r),d=Math.max(h,Math.abs(o)),u=Math.sqrt(d*(d+2*l)),p=a+this._referenceEllipsoid.radius;return Nb(1.2*ke(u,p,mg(d)),W(2e4-(Math.log(d)-7.983)/9.011*19900,100,2e4),1,n)}};function Nb(i,e,t,s){const r=JM/t;return i/e>r?(s.far=i,s.near=s.far/e):(s.near=r,s.far=s.near*e),s}const KM=2e4,JM=2,eO=.001,tO=1e-4,wo=v(),ya=v();let Ed=class extends De{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;e.spatialReference!=null&&n1(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>Rl(this.view,e,ks.EYE_AND_CENTER))}};c([m({constructOnly:!0})],Ed.prototype,"view",void 0),Ed=c([I("esri.views.3d.state.SurfaceCollisionConstraint")],Ed);let hh=class extends De{constructor(e){super(e),this.nearFarHeuristic=XM(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([E(()=>{var e,t,s,r;return[(t=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:t.near,(r=(s=this.view.constraints)==null?void 0:s.clipDistance)==null?void 0:r.far]},()=>this._clipDistanceNearFarChanged()),E(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:t.mode},()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e)),E(()=>this.view.renderDataExtent,()=>this._updateNearFar(),je),E(()=>{var e,t,s,r;return[(t=(e=this.view.constraints)==null?void 0:e.altitude)==null?void 0:t.min,(r=(s=this.view.constraints)==null?void 0:s.altitude)==null?void 0:r.max]},()=>this._updateAltitude(),je),E(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:t.max},()=>this._updateTiltMax(),je),E(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:t.mode},()=>this._updateTilt(),je),E(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this._updateTiltAutoMax(),je),E(()=>{var e,t,s,r,n,a;return[(s=(t=(e=this.view.map)==null?void 0:e.ground)==null?void 0:t.navigationConstraint)==null?void 0:s.type,(a=(n=(r=this.view.state)==null?void 0:r.constraints)==null?void 0:n.collision)==null?void 0:a.enabled]},()=>this._updateCollision(),je)]),this.view.state.isLocal&&this.addHandles(E(()=>this.view.renderDataExtent,e=>this._updateLocalSurfaceDistance(e),dt)),this._updateNearFar(),this.view.state.viewingMode!==Ne.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new Ed({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var t;const e=(t=this.view.constraints)==null?void 0:t.clipDistance;e&&e.mode!=="auto"&&this.view.state.updateCamera(s=>P0(s,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;(t?t.mode:"auto")==="manual"?P0(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,M_(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCollision(){var r,n,a;const e=(a=(n=(r=this.view.map)==null?void 0:r.ground)==null?void 0:n.navigationConstraint)==null?void 0:a.type,t=!e||e==="stay-above",s=this.view.state.constraints.collision;if(t!==s.enabled){s.enabled=t,t&&this._reapplyConstraints(ht.COLLISION);const o=this.view.constraints&&this.view.constraints.tilt;o&&o.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Ne.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;(e?e.mode:"auto")==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(Et(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||e.mode!=="auto")return;const t=this.view.state.constraints;if(t.tilt){const s=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(Nh(s))}}_updateLocalSurfaceDistance(e){if(e==null)return;let t=Math.max(e.width,e.height);if(t<=0)return;e.zmax!=null&&e.zmin!=null&&(t=Math.max(t,e.zmax-e.zmin));const s=this.view.state,r=3*t/Math.atan(s.camera.fov/2);r!==s.constraints.distance&&(s.constraints.distance=r)}_reapplyConstraints(e=ht.ALL){this.view.state.updateCamera(t=>Mt(this.view,t,new Ps(e,Re.NONE,null)))}};function P0(i,e){e&&(i.near=e.near,i.far=e.far)}c([m({constructOnly:!0})],hh.prototype,"view",void 0),c([m({readOnly:!0})],hh.prototype,"surfaceCollisionConstraint",void 0),hh=c([I("esri.views.3d.state.ConstraintsManager")],hh);let Sh=class extends cn{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=ct.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(e.spatialReference==null||n1(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),Rl(this.view,e,ks.EYE_AND_CENTER)||this.constraintEnabled||(this.state=ct.Stopped)})}};c([m({constructOnly:!0})],Sh.prototype,"desiredCamera",null),Sh=c([I("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],Sh);let iO=class{constructor(e,t,s){this._target=e,this._options=t,this.view=s,this.state="pending",this._animationController=null,this.promise=new Promise((r,n)=>{this._resolveCallback=r,this._rejectCallback=n;const a=new AbortController;this._options.signal!=null&&v_(this._options.signal,()=>this.abort()),this._abortController=a,this._waitForReady()})}_resolve(e){if(this.state!=="finished")return this.state="finished",this._resolveCallback(e)}_reject(e){if(this.state!=="finished")return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),this.state==="wait-for-animation-finish"&&!e&&this._animationController!=null&&this.view.state.cameraController===this._animationController&&this._animationController.running&&this._animationController.stopController(),this._reject(hr())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await gm(()=>this.view.ready,this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()}async _createViewPoint(){if(this.state!=="finished"){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{const e=await WC(this.view,this._target,this._abortController.signal);if(this.state==="finished")return;const t=e?this._getCameraFromViewpoint(e):null;if(t==null)return;if(this._options.animate){if(this._animationController==null)return;this._startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}}_getCameraFromViewpoint(e){var n;const t=!!(this._target instanceof $h&&this._target.camera||this._target instanceof Kn),s=e.camera;if(s==null)return null;if(!this.view.stateManager.isCompatible(s)){const a=s.position,o=a&&a.spatialReference,l=o?o.wkid:"none",h=(n=this.view.spatialReference)==null?void 0:n.wkid;return this._reject(new Bi("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${l}, view: ${h})`,{camera:s})),null}const r=Ln(this.view,s);return r==null?(this._reject(new Bi("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:r,isFullySpecified:t}}_startAnimation(e,t){this.state="wait-for-animation-finish";const s=t.viewAnimation;if(s==null)return void this._reject(new Bi("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(s.update(e.viewpoint,"running"),!t.running||t.viewAnimation==null||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new Sh({view:this.view,desiredCamera:e.camera}),Rl(this.view,e.camera,ks.EYE_AND_CENTER)):Mt(this.view,e.camera),t.begin(e.camera,this._options);const n=()=>{const o=this.view.state.cameraController;r&&(o&&o.running?p0(o)&&o.viewAnimation!=null&&o.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=r):t.viewAnimation!=null&&t.viewAnimation.target===e.viewpoint&&t.state===ct.Finished&&(this.view.state.cameraController=r))},a=o=>{if(this.view.state!=null)switch(t.state){case ct.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case ct.Ready:case ct.Rejected:case ct.Running:case ct.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(o)}}};s.when(n,o=>a(o)),t.asyncResult={resolve:()=>a(),reject:o=>a(o)}}_getAnimationController(){let e=null,t=null;const s=this.view.state.cameraController;return p0(s)&&(s.updateStateFromViewAnimation(),s.running&&(e=s,t=e.viewAnimation)),e==null&&(e=new Ha({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e),e.state===ct.Rejected)?(t==null||t.stop(),this._reject(new Bi("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null):e}};var It;function E0(i=!Li("disable-feature:high-quality-idle"),e=null){const t=new cu;return i?(t.set(_t.IDLE,It.Antialiasing,e!=="low"),t.set(_t.IDLE,It.HighResolutionAtmosphere,e!=="low"),t.set(_t.IDLE,It.HighQualityTransparency,!0),t.set(_t.IDLE,It.SSAO,!0),t.set(_t.IDLE,It.WaterReflection,!0),t.set(_t.IDLE,It.PhysicalPixelRendering,!0)):(t.set(_t.ANIMATING,It.HighResolutionShadows,!0),t.set(_t.ANIMATING,It.HighResolutionViewshed,!0),t.set(_t.INTERACTING,It.HighResolutionShadows,!0),t.set(_t.INTERACTING,It.HighResolutionViewshed,!0)),t.set(_t.IDLE,It.HighResolutionShadows,!0),t.set(_t.IDLE,It.HighResolutionViewshed,!0),t.set(_t.IDLE,It.HighResolutionVoxel,!0),t}(function(i){i[i.Antialiasing=0]="Antialiasing",i[i.HighQualityTransparency=1]="HighQualityTransparency",i[i.HighResolutionVoxel=2]="HighResolutionVoxel",i[i.HighResolutionAtmosphere=3]="HighResolutionAtmosphere",i[i.SSAO=4]="SSAO",i[i.WaterReflection=5]="WaterReflection",i[i.HighResolutionShadows=6]="HighResolutionShadows",i[i.HighResolutionViewshed=7]="HighResolutionViewshed",i[i.PhysicalPixelRendering=8]="PhysicalPixelRendering"})(It||(It={}));let Dt=class extends De{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=M0,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:t=>this._devicePixelRatioOverride=t,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return this.renderState!=null},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(t){this.viewStateManager._idleTimeout=t?M0:0}},this._propertiesPool=new aa({frustum:a1},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new sO}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([yn(()=>this.view.state.events,"before-camera-change",e=>e&&this._updateElevation(e)),E(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},(e,t)=>this._cameraChangedHandler(e,t),je)]),ml(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([Ru({prepare:()=>this._prepareFrame()}),E(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(jc)}),yn(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=de(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=_f(this.view,this.view.state.camera,bp);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){var t,s;this._updatePropertyBeforeReady("camera",e)||((t=this.view.elevationProvider)==null||t.enableCache(!0),this.setStateCamera(Ln(this.view,e),{applyConstraints:!1})||Pe.getLogger(this).error("#camera=","Invalid camera",e),(s=this.view.elevationProvider)==null||s.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=_f(this.view,this.view.state.contentCamera,bp);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=Ln(this.view,e);t!=null?(this._updateElevation(t),this.view.state.contentCamera=t):this.view.state.contentCamera=null}installContentCameraReset(e){if(this.removeHandles(wp),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,s=this.view.state.camera.distance**2,r=Xx(this.view.state.camera.center),n=e.sticky?this.contentCamera.clone():null;return this.addHandles([E(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles(wp),this.test.contentCameraResetState.clear())}),E(()=>this.zoom,a=>{a!==void 0&&t!==void 0&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(a-t)/2),Math.abs(a-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n))}),E(()=>this.view.state.camera,a=>{const o=Qn(r,a.center);this.test.contentCameraResetState.set("camera.center",o/s),o>s?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)})],wp),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){var t;this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():Pe.getLogger(this).error("#center=","Invalid center",e):Pe.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e):Pe.getLogger(this).error("#center=","Center may not be null or undefined"))}get visibleArea(){if(!this.ready){const e=this._get("extent");return e?uC.fromExtent(e):null}return QC(this.view,this.view.pointsOfInterest.focus.renderLocation)}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=r1(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return t??this._get("extent")}set extent(e){var t;this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||Pe.getLogger(this).error("#extent=","Invalid extent",e):Pe.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e):Pe.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){var t;const e=this.view.map;return e&&"initialViewProperties"in e?(t=e.initialViewProperties)==null?void 0:t.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(!this.ready)return this._get("scale");const e=this.view.basemapTerrain.tilingScheme,t=this.view.pointsOfInterest.cameraOnSurface.scale;return e&&t?XC(this.view,t,this.view.state.contentCamera,e):this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||Pe.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,s=e.pixelRatio,r=this._get("padding"),n=Math.round(t[ms.TOP]/s),a=Math.round(t[ms.RIGHT]/s),o=Math.round(t[ms.BOTTOM]/s),l=Math.round(t[ms.LEFT]/s);return r!=null&&r.top===n&&r.right===a&&r.bottom===o&&r.left===l?r:{top:n,right:a,bottom:o,left:l}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,kc),this.view.state.updateCamera(t=>t.padding=kc))}_paddingToArray(e,t,s){e?oa(s,e.top||0,e.right||0,e.bottom||0,e.left||0):oa(s,0,0,0,0);for(let r=0;r<4;r++)s[r]=Math.round(s[r]*t)}get screenCenter(){const e=this.padding;return jv((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?YC(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){var t;if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||Pe.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{const s=e.camera!=null?e.camera.position:e.targetGeometry,r=s!=null&&s.spatialReference;Pe.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(r?r.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e)}else Pe.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?ZC(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||e===void 0||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||Pe.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){var r;if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const s=(r=this.view._stage.renderView.renderingContext)==null?void 0:r.parameters.maxTextureSize;return s&&B_(this._tmpCanvasSize,s),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return this._devicePixelRatioOverride!=null?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){var e,t;return((t=(e=this.view)==null?void 0:e._stage)==null?void 0:t.renderer.isFeatureEnabled(It.PhysicalPixelRendering))??!1}get _usePhysicalPixelRenderingAny(){var t,s;const e=(s=(t=this.view)==null?void 0:t._stage)==null?void 0:s.renderer;return e&&(e.isFeatureEnabled(It.PhysicalPixelRendering,_t.IDLE)||e.isFeatureEnabled(It.PhysicalPixelRendering,_t.INTERACTING)||e.isFeatureEnabled(It.PhysicalPixelRendering,_t.ANIMATING))}preinit(e){var t,s,r;return!(this._isOverridden("center")&&!Lo(this.center.spatialReference,e))&&!(this._isOverridden("camera")&&!Lo(this.camera.position.spatialReference,e))&&!(this._isOverridden("extent")&&!Lo(this.extent.spatialReference,e))&&!!(!this._isOverridden("viewpoint")||Lo((t=this.viewpoint.targetGeometry)==null?void 0:t.spatialReference,e)&&Lo((r=(s=this.viewpoint.camera)==null?void 0:s.position)==null?void 0:r.spatialReference,e))}init(){this._constraintsManager=new hh({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const t=this._initialViewpoint||this.view.initialExtent;t&&this.isCompatible(t)?this._setInitialView(t):this.view.state.viewingMode===Ne.Local&&this.addHandles(ml(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(jc),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),jc)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(jc),this._constraintsManager=de(this._constraintsManager))}async goTo(e,t){return t={animate:!0,...t},this._gotoOperation!=null&&this._gotoOperation.abort(t.animate),this._gotoOperation=new iO(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera(KC(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,s=t==null?void 0:t.cameraController;s&&(t.updateCamera(r=>s.stepController(e,r)),s.steppingFinished&&s.finishController())}_cancelGoToOperation(){this._gotoOperation!=null&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:s,overrides:r}of nO){const n=e.has(s),a=this._isOverridden(s);!n&&a&&t.push({name:s,value:this._get(s)}),this._clearOverride(s),(n||a)&&r.forEach(o=>e.add(o))}return t}_setInitialView(e){if(e==null||this._cameraSetByUser)return;if(e instanceof Kn)return void this.setStateCamera(Ln(this.view,e),{applyConstraints:!1});if(e instanceof $h){if(e.targetGeometry instanceof Nr){const n=tp(this.view,e.targetGeometry,0,.5,Sc.LOCKED);return void(n!=null&&this.setStateCamera(Ln(this.view,n),{applyConstraints:!0}))}const s={applyConstraints:!e.camera},r=this._viewpointToCamera(e);return void this.setStateCamera(r,s)}const t=tp(this.view,e,0,.5,Sc.LOCKED);t!=null&&this.setStateCamera(Ln(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&rO.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return e!=null&&(e instanceof $h?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof Kn?this.isCompatible(e.position):e.spatialReference&&!Jx(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=aO){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,s=Dn){const{heading:r,tilt:n}=this._getPreservingHeadingTilt(),a=JC(this.view,r,n,e,t,Sc.ADJUST);return a==null?null:(s.copyFrom(this.view.state.camera),s.eye=a.eye,s.center=a.center,s.up=a.up,s)}_centerToCamera(e){let t;if(e.hasZ)t=this.view.state.camera.distance;else{const{centerOnContent:s}=this.view.pointsOfInterest;s.runTask(),t=s.distance}return this._centerPointAtDistanceToCamera(e,t)}_extentToCamera(e){const{heading:t,tilt:s}=this._getPreservingHeadingTilt(),r=tp(this.view,e,t,s,Sc.ADJUST,bp);return r?Ln(this.view,r):null}_scaleToCamera(e){if(e==null)return null;const t=this.view,s=t.pointsOfInterest.centerOnContent;s.runTask();const r=s.renderLocation,n=eT(t,e,t.state.contentCamera,r);return this._centerPointAtDistanceToCamera(r,n)}_zoomToCamera(e){return this._scaleToCamera(tT(this.view,e))}_viewpointToCamera(e){return Ln(this.view,iT(this.view,e))}setStateCamera(e,t){return!(e==null||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(s=>{t.positionAndOrientationOnly?(s.eye=e.eye,s.center=e.center,s.up=e.up,s.fov=e.fov):s.copyFrom(e),t.applyConstraints&&Mt(this.view,s)}),t.applyConstraints||(this.view.state.cameraController=new Sh({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const s=this._computeCanvasSize();if(s.width!==0&&s.height!==0&&(t.width===s.width&&t.height===s.height||(t.width=s.width,t.height=s.height),this.view.state)){const r=this.view.state.camera;r.fullWidth===s.width&&r.fullHeight===s.height&&r.pixelRatio===s.pixelRatio||(Dn.copyFrom(r),Dn.pixelRatio!==s.pixelRatio&&(this._paddingToArray(this.padding,s.pixelRatio,kc),Dn.padding=kc),Dn.fullWidth=s.width,Dn.fullHeight=s.height,Dn.pixelRatio=s.pixelRatio,this.view.state.camera=Dn),this._updateViewState()}}_updateElevation(e){var n,a;const t=(n=this.view.basemapTerrain)==null?void 0:n.spatialReference,s=((a=this.view.renderCoordsHelper)==null?void 0:a.getAltitude(e.eye))??0,r=t?M_(this.view,e.eye):0;e.relativeElevation=s-r}_updateViewState(){this.test.renderState!=null?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=_t.ANIMATING:this.view.interacting?this.view.state.mode=_t.INTERACTING:(this.view.state.mode===_t.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=_t.INTERACTING:this.view.state.mode=_t.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};c([m({type:Kn,dependsOn:["view.state.camera","ready"]})],Dt.prototype,"camera",null),c([m({type:Kn,dependsOn:["view.state.contentCamera","ready"]})],Dt.prototype,"contentCamera",null),c([m({type:ea})],Dt.prototype,"center",null),c([m()],Dt.prototype,"visibleArea",null),c([m({type:Nr})],Dt.prototype,"extent",null),c([m({readOnly:!0})],Dt.prototype,"frustum",null),c([m()],Dt.prototype,"_constraintsManager",void 0),c([m({readOnly:!0})],Dt.prototype,"constraintsManager",null),c([m()],Dt.prototype,"_initialViewpoint",null),c([m({readOnly:!0})],Dt.prototype,"hasInitialView",null),c([m({readOnly:!0,type:Boolean})],Dt.prototype,"ready",void 0),c([m({type:Number})],Dt.prototype,"scale",null),c([m()],Dt.prototype,"padding",null),c([m({readOnly:!0})],Dt.prototype,"screenCenter",null),c([m({constructOnly:!0})],Dt.prototype,"view",void 0),c([m({type:$h})],Dt.prototype,"viewpoint",null),c([m({type:Number})],Dt.prototype,"zoom",null),c([m({readOnly:!0})],Dt.prototype,"_rasterPixelRatio",null),c([m({readOnly:!0})],Dt.prototype,"_usePhysicalPixelRendering",null),c([m({readOnly:!0})],Dt.prototype,"_usePhysicalPixelRenderingAny",null),c([m()],Dt.prototype,"_windowDevicePixelRatio",void 0),c([m()],Dt.prototype,"_devicePixelRatioOverride",void 0),Dt=c([I("esri.views.3d.state.ViewStateManager")],Dt);let sO=class{constructor(){this.width=0,this.height=0,this.pixelRatio=1}};const rO=new Set(["camera","viewpoint","extent","scale","center","zoom"]),nO=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],aO={heading:0,tilt:0},bp=new Kn,Dn=new xt,kc=Ci(),jc="pending-initial-view",wp="content-camera-reset",M0=300,O0=100;let ur=class extends cn{constructor(){super(...arguments),this.startCamera=new xt,this.currentCamera=new xt,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<O0}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=ct.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout(()=>this.notifyChange("isInteractive"),O0),this.view.state.updateCamera(e=>this.stepController(0,e)),this.steppingFinished&&this.finishController()}};c([m({readOnly:!0})],ur.prototype,"isInteractive",null),c([m()],ur.prototype,"_lastInteraction",void 0),ur=c([I("esri.views.3d.state.controllers.InteractiveController")],ur);var _s;(function(i){i[i.CENTER=0]="CENTER",i[i.EYE=1]="EYE"})(_s||(_s={}));let Ph=class extends ur{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=_s.CENTER,this._rotScale=0,this._lastPoint=Ss(),this._tmpWorldUp=v(),this._tmpViewDir=v(),this._tmpRotCurPoint=Ss(),this._tmpTransf=Nt(),this._tmpAxis=v(),this._tmpPivotPoint=v(),this._pivotPos=v(),this._constraintOptions=new Ps(ht.ALL,Re.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===_s.CENTER?3:1.5}begin(e){if(this.running){switch(this.pivot){case _s.EYE:ue(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=Re.LOOK_AROUND,this._constraintOptions.tiltMode=Br.LOOK_AROUND,this._constraintOptions.selection=ht.NONE;break;case _s.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.map.ground.opacity===0?lo:{});t||ue(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=Re.TUMBLE,this._constraintOptions.tiltMode=Br.TUMBLE,this._constraintOptions.selection=ht.ALL&~ht.DISTANCE;break}}Wa(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const s=this.startCamera,r=v();Te(r,this._pivotPos,s.eye);const n=Ce(r),a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(s.eye,R0);let o=Math.max(Math.min(DM,1/Math.abs(ce(R0,s.viewForward)))*a,$M);t&&(o=Math.min(n,o));const l=ri(s.width/s.pixelRatio*.5,s.height/s.pixelRatio*.5),h=gc(this.startCamera,l,this.view.renderCoordsHelper,this.view.viewingMode);let d=this.view._stage.renderView.getMinimalDepthForArea(rc(this.view),s.fullWidth/s.pixelRatio*.5,s.fullHeight/s.pixelRatio*.5,s,2.5*pp,pp),u=this.view._stage.renderView.getMinimalDepthForArea(rc(this.view),e[0],e[1],s,pp);d==null&&u==null||(d=d??u??0,u=u==null||h===Pi.Horizontal?d:u,o=d>u?u:d,o=t?Math.min(o,n):o),ae(r,r),ue(this._pivotPos,ye(this._tmpPivotPoint,s.eye,ie(this._tmpPivotPoint,r,o)))}update(e){if(this.running){switch(this.pivot){case _s.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case _s.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Mt(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(e,t,s,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),Wa(e,t,this._tmpRotCurPoint);let n=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,a=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;Te(this._tmpViewDir,s,r);const o=Ce(this._tmpViewDir),l=sa(ce(this._tmpViewDir,this._tmpWorldUp)/o);if(this.pivot===_s.EYE){n*=-.5;const h=.5*Math.PI-l,d=.5*Math.PI*.99;n=h-Math.max(-d,Math.min(d,h+n))}return n=W(n+l,xi.min,xi.max)-l,gt(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===_s.CENTER&&(a=-a),Ka(this._tmpTransf,a,this._tmpWorldUp),_n(this._tmpTransf,this._tmpTransf,n,this._tmpAxis),Wt(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=Wt(xp,e.up,this._tmpTransf),ye(xp,r,this._tmpViewDir),ra(this._lastPoint,this._tmpRotCurPoint),xp}};c([m()],Ph.prototype,"pivot",void 0),Ph=c([I("esri.views.3d.state.controllers.RotateController")],Ph);const xp=v(),R0=v();let Cp=class extends Tr{constructor(e,t,s,r){super(!0),this._view=e,this.pointerAction=t,this._pivot=s,this.registerIncoming("drag",r,n=>this._handleDrag(n))}_handleDrag(e){const t=e.data;if(t.pointers.size>1||!E_(e.data,this.pointerAction))return;const s=ri(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new Ph({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(s);break;case"update":this._cameraController&&this._cameraController.update(s);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}};const Wc="esri-fov-overlay",Qc={base:Wc,outer:`${Wc}-outer`,reset:`${Wc}-reset`,text:`${Wc}-text`};let sn=class extends yx{constructor(e){super(e),this.onReset=()=>{},this._messagesCommon=null,this._messagesUnits=null,this.fov=null}render(){return Cc("div",{class:Qc.outer},Cc("div",{class:Qc.base},Cc("p",{class:Qc.text},this._overlay),Cc("p",{class:Qc.reset,onclick:this.onReset,title:this._messagesCommon.reset},this._reset)))}get _overlay(){const{fov:e,_messagesUnits:t}=this;if(!t||e==null)return"";const s=yP(Nh(e),"degrees","arithmetic","arithmetic",0),r=oO/(2*Math.tan(e/2));return`${s} | ${vP(t,r,"millimeters",0,"abbr")} |`}get _reset(){return this._messagesUnits&&this.fov!=null?"↺":""}};c([m()],sn.prototype,"onReset",void 0),c([m(),Jg("esri/t9n/common")],sn.prototype,"_messagesCommon",void 0),c([m(),Jg("esri/core/t9n/Units")],sn.prototype,"_messagesUnits",void 0),c([m()],sn.prototype,"fov",void 0),c([m()],sn.prototype,"_overlay",null),c([m()],sn.prototype,"_reset",null),sn=c([I("esri.widgets.FovOverlay")],sn);const oO=Math.sqrt(1872);let dl=class extends ur{constructor(e){super(e),this.onStop=null,this._timeOutId=void 0,this._onReset=()=>{this._startSize=this._lastDrag=null,this._setFov(lO),this.updateTimeout()},this._center=v(),this._viewForward=v(),this._constraints=new Ps(ht.ALL,Re.ZOOM)}begin(e){dO(e)?this._showOverlay().fov=e.fov:(this._lastDrag=e[1],this._startSize=null,this._ensureStartSize(this.view.state.camera))}updateTimeout(){clearTimeout(this._timeOutId),this._timeOutId=setTimeout(this.onStop,1500)}update(e){if(this._lastDrag==null)return this._lastDrag=e[1],this._startSize=null,void this._ensureStartSize(this.view.state.camera);const t=-(this._lastDrag-e[1])/2;this._lastDrag=e[1],this.step(t)}step(e){if(!this.running)return void(this._startSize=this._lastDrag=null);const t=this.view.state,s=this.currentCamera.copyFrom(t.camera),r=Nh(s.fov)+e,n=Et(W(r,hO,cO));n!==s.fov?this._setFov(n):this._showOverlay().fov=s.fov}finish(){this.running&&(this._startSize=this._lastDrag=null,this.finishController())}destroy(){this.hideOverlay()}onControllerEnd(e){super.onControllerEnd(e),this._startSize=this._lastDrag=null,this.hideOverlay()}_showOverlay(){return this._overlay||(this._overlay=new RC({id:"esri.FovOverlay",node:new sn({onReset:this._onReset})}),this.view.ui.add(this._overlay)),this._overlay.widget}hideOverlay(){this._overlay&&(this.view.ui.remove(this._overlay),this._overlay=de(this._overlay))}_setFov(e){const t=this.view.state,s=this.currentCamera.copyFrom(t.camera),r=this._ensureStartSize(s)/Math.tan(e/2),n=ye(Tp,this._center,ie(Tp,this._viewForward,-r));s.eye=n,s.fov=e,this._constraints.interactionStartCamera=t.camera,this._constraints.interactionFactor=zs(this.currentCamera.height-t.camera.height),Mt(this.view,this.currentCamera,this._constraints),this.begin(s),this.commitCamera()}_ensureStartSize(e){if(this._startSize==null){ue(this._viewForward,e.viewForward);const t=this.view._stage.renderView.getMinimalDepthForArea(null,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,_c),s=ki(e.eye,this.view.pointsOfInterest.centerOnContent.renderLocation),r=t??s;ye(this._center,e.eye,ie(Tp,this._viewForward,r)),this._startSize=r*Math.tan(e.fov/2)}return this._startSize}};c([m()],dl.prototype,"onStop",void 0),dl=c([I("esri.views.3d.state.controllers.FovController")],dl);const lO=Et(new Kn().fov),hO=10,cO=150,Tp=v();function dO(i){return!Array.isArray(i)}let zm=class extends ur{constructor(){super(...arguments),this._pickPoint=v(),this._tmpP0=Ss(),this._panAxisAngle=Gu(),this._tmpRayDir=v(),this._tmpRayDirPick=v(),this._targetOnSphere=v(),this._navMode=Pi.Horizontal,this._tmpRay={origin:v(),direction:v()},this.dragBeginPoint=ri(),this._normalizedAnchorPoint=Ss(),this._constraintOptions=new Ps(ht.ALL_EXCEPT_COLLISION,Re.ZOOM,0,this.startCamera),this._sphere=wr(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;ra(this.dragBeginPoint,e),Wa(this.startCamera,e,this._normalizedAnchorPoint);const t=Ot(this.view.spatialReference),s=Mb(this._intersectionHelper,this.startCamera,e,t,xl.Ellipsoid,this.view.map.ground.opacity===0?lo:{});if(this._navMode=gc(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===Pi.Horizontal)this._hasPickPoint=!!s.scenePickPoint,this._pickPoint=s.scenePickPoint??this._pickPoint,this._sphere=s.sphere;else{let r;Ml(this.startCamera,e,this._tmpRay),ae(this._tmpRay.direction,this._tmpRay.direction),s.scenePickPoint!=null&&(Te(this._tmpRayDirPick,this.startCamera.eye,s.scenePickPoint),r=Ce(this._tmpRayDirPick));const n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,A0);let a=W(Math.min(bb,1/Math.abs(ce(A0,this._tmpRay.direction)))*n,vu[0],vu[1]);const o=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,_c);a=o??a,a=r!=null?Math.min(a,r):a,this._hasPickPoint=!0,ie(this._tmpRay.direction,this._tmpRay.direction,a),ye(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.running){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===Pi.Horizontal){Te(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=Ce(this._tmpRayDir);Wa(this.currentCamera,e,this._tmpP0);const s=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**s;const n=this.view.state.constraints.minimumPoiDistance;if(s<0&&r<n&&(r=n),Math.abs(t-r)<1e-6)return;if(this._hasPickPoint&&r<t){const a=1-(1-r/t)*(1-this._sphere[3]/Ce(this.currentCamera.center));this.currentCamera.center=ie(Xc,this.currentCamera.center,a)}ie(this._tmpRayDir,this._tmpRayDir,-r/t),this.currentCamera.eye=ye(Xc,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=zs(Hh(this.dragBeginPoint,e)),Mt(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(sc(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),hg(this._pickPoint,this._targetOnSphere,this._panAxisAngle),la(this.currentCamera,At(this._sphere),this._panAxisAngle))}else{const t=Ce(this._tmpRay.direction);Wa(this.currentCamera,e,this._tmpP0);const s=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**s;const n=this.view.state.constraints.minimumPoiDistance;if(s<0&&r<n&&(r=n),Math.abs(t-r)<1e-6)return;ie(this._tmpRayDir,this._tmpRay.direction,1-r/t),this.currentCamera.eye=ye(Xc,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=ye(Xc,this.currentCamera.center,this._tmpRayDir)}Rl(this.view,this.currentCamera),this.commitCamera()}}finish(){this.running&&this.finishController()}};zm=c([I("esri.views.3d.state.controllers.ZoomControllerGlobal")],zm);const Xc=v(),A0=v();let qm=class extends ur{constructor(){super(...arguments),this._tmpP=v(),this._tmpDir=v(),this._tmpN=v(),this._tmpP0=Ss(),this._tmpPoi=v(),this._tmpRayDir=v(),this.dragBeginPoint=ri(),this._normalizedAnchorPoint=Ss(),this._constraintOptions=new Ps(ht.ALL,Re.ZOOM,0,this.startCamera,v()),this._plane=Wh()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;ra(this.dragBeginPoint,e),Wa(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.map.ground.opacity===0?lo:{});Te(this._tmpDir,this._tmpP,this.startCamera.eye);const s=Ce(this._tmpDir);ae(this._tmpDir,this._tmpDir);const r=Math.abs(this.view.camera.position.z);let n=W(Math.min(bb,1/Math.abs(ce(uO,this._tmpDir)))*r,vu[0],vu[1]);const a=this.view._stage.renderView.getMinimalDepthForArea(rc(this.view),e[0],e[1],this.view.state.camera,_c);n=a??n,n=t?Math.min(n,s):n,ie(this._tmpDir,this._tmpDir,n),ye(this._tmpP,this.startCamera.eye,this._tmpDir),Te(this._tmpN,this.startCamera.eye,this.startCamera.center),ae(this._tmpN,this._tmpN),this._tmpN[1]<0&&Xn(this._tmpN,this._tmpN),q1(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.running)return;IM(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||ue(this._tmpPoi,this.currentCamera.center),Wa(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);ra(this._normalizedAnchorPoint,this._tmpP0),Te(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const s=Ce(this._tmpRayDir);let r=s*(1-t);this._constraintOptions.interactionDirection&&(ue(this._constraintOptions.interactionDirection,this._tmpRayDir),ie(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/s));const n=this.view.state.constraints.minimumPoiDistance;t>=0&&r<n&&(r=n,t=-(r-s)/s),Math.abs(s-r)<1e-6||(ie(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=ye(va,this.currentCamera.eye,this._tmpRayDir),vr(va,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?va[2]=Math.max(this.startCamera.center[2],va[2]):va[2]=Math.min(this.startCamera.center[2],va[2]),this.currentCamera.center=va,this._constraintOptions.interactionFactor=zs(Hh(this.dragBeginPoint,e)),Mt(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}finish(){this.running&&this.finishController()}};qm=c([I("esri.views.3d.state.controllers.ZoomControllerLocal")],qm);const va=v(),uO=Pt(0,0,1);let pO=class extends Tr{constructor(e,t,s){super(!0),this._view=e,this.pointerAction=t,this._fovModifier=s,this.registerIncoming("drag",[s],r=>this._handleZoom(r)),this.registerIncoming("drag",r=>this._handleZoom(r))}_handleZoom(e){var r,n;const t=e.data;if(t.pointers.size>1||!E_(e.data,this.pointerAction))return;const s=ri(t.center.x,t.center.y);switch(t.action){case"start":{(r=this._cameraController)==null||r.finish();const a=this._view,o=e.modifiers.has(this._fovModifier);this._cameraController=o?new dl({view:a,onStop:()=>this._stopController()}):a.state.isGlobal?new zm({view:a}):new qm({view:a}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(s);break}case"update":(n=this._cameraController)==null||n.update(s);break;case"end":this._cameraController instanceof dl?this._cameraController.updateTimeout():this._stopController()}e.stopPropagation()}_stopController(){var e;(e=this._cameraController)==null||e.finish(),this._cameraController=null}},Ba=class extends ur{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new xt,this._headingStart=0,this._constraintOptions=new Ps(ht.ALL,Re.NONE,0,new xt,null,Br.LOOK_AROUND)}handleEventGamepad(e){const t=pf(e,this.view.navigation.gamepad,this._transformation);(e.action==="end"||ep(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,mf(this._keysButtonState,this._transformation)}directionActive(e){return this._keysButtonState[e]===1}countActiveDirections(){return this._keysButtonState.reduce((e,t)=>t>0?e+1:e,0)}deactivateDirection(e){this._keysButtonState[e]=0;const t=mf(this._keysButtonState,this._transformation);ep(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z,s=1;this._filteredSurfaceElevation+=s*(t-this._filteredSurfaceElevation)*e}stepController(e,t){var s;this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),(s=this._constraintOptions.interactionStartCamera)==null||s.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,ba),this._applyDisabledMovementTypes(ba),this._applyPan(ba.pan),this._applyRotate(ba.rotate),this._applyZoom(ba.zoom),this._applyAscend(ba.ascend),this._constraintOptions.interactionType=Re.NONE,this._constraintOptions.selection=ht.COLLISION,Mt(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){this._transformation.heading!==0&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;Te(Zi,t.center,t.eye),Wt(Zi,Zi,e.matrix),t.center=ye(Zi,Zi,t.eye),t.up=Wt(Zi,t.up,e.matrix),this._constraintOptions.interactionType=Re.LOOK_AROUND,this._constraintOptions.selection=ht.ALL_EXCEPT_COLLISION,Mt(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=Wt(Zi,t.eye,e.matrix),t.center=Wt(Zi,t.center,e.matrix),this.view.state.isGlobal&&(t.up=Wt(Zi,t.up,e.matrix)),this._constraintOptions.interactionType=Re.PAN,this._constraintOptions.selection=ht.ALL,Mt(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=ye(Zi,this.currentCamera.eye,ie(bt.get(),t,e)),ue(kl,t),Xn(kl,kl),this._constraintOptions.interactionDirection=kl,this._constraintOptions.interactionType=Re.ZOOM,this._constraintOptions.selection=ht.ALL_EXCEPT_COLLISION,Mt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,bt.get());if(this._constraintOptions.interactionDirection=ue(kl,t),this.view.state.isGlobal){const s=Ce(this.currentCamera.eye),r=(s+e)/s;this.currentCamera.eye=ie(Zi,this.currentCamera.eye,r),this.currentCamera.center=ie(Zi,this.currentCamera.center,r)}else{const s=ie(bt.get(),t,e);this.currentCamera.eye=ye(Zi,this.currentCamera.eye,s),this.currentCamera.center=ye(Zi,this.currentCamera.center,s)}this._updateCameraCenter(),this._constraintOptions.interactionType=Re.ASCEND,this._constraintOptions.selection=ht.COLLISION,Mt(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=ht.ALL_EXCEPT_COLLISION,Mt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,s){bO(s);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,s):this._calculateControlTransformationGlobal(r,t,s)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,s=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(s,e,Zi)}_calculateControlTransformationLocal(e,t,s){const{viewRight:r,viewForward:n}=t,a=this._transformation,o=this.view.navigation.gamepad,l=$e(bt.get(),n[0],n[1],0);ae(l,l);const h=a.translation[0]*e.pan;if(h!==0){const g=ie(bt.get(),r,h);qh(s.pan.matrix,s.pan.matrix,g),s.pan.enabled=!0}switch(o.mode){case"pan":{const g=-a.translation[1]*e.pan;if(g!==0){const y=ie(bt.get(),l,g);qh(s.pan.matrix,s.pan.matrix,y),s.pan.enabled=!0}s.zoom=a.zoom*e.zoom;break}case"zoom":s.zoom=(-a.translation[1]+a.zoom)*e.zoom;break;default:Pl(o.mode)}const d=a.translation[2]*e.ascend;s.ascend=d;const u=-a.heading*e.rotate;u!==0&&(_n(s.rotate.matrix,s.rotate.matrix,u,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,bt.get())),s.rotate.enabled=!0);const p=a.tilt*e.rotate,_=ia(this.view.renderCoordsHelper,t.center,t.eye),f=W(_+p,xi.min,xi.max)-_;f&&(_n(s.rotate.matrix,s.rotate.matrix,f,r),s.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,s){const{eye:r,viewRight:n}=t,a=this._transformation,o=this.view.navigation.gamepad,l=gt(bt.get(),n,r);ae(l,l),Xn(l,l),zM(this.startCamera,t,a,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,s,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(ba.pan,this._tmpCamera);const h=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,d=a.translation[2]*e.ascend;s.ascend=d;const u=-a.heading*e.rotate;u!==0&&(_n(s.rotate.matrix,s.rotate.matrix,u,this._tmpCamera.eye),s.rotate.enabled=!0);const p=a.tilt*e.rotate,_=this._clampTiltDeltaGlobalToValidRange(p,t.ray,h);_!==0&&(_n(s.rotate.matrix,s.rotate.matrix,_,this._tmpCamera.viewRight),s.rotate.enabled=!0),s.zoom+=a.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,s){const r=Ot(this.view.spatialReference),n=Cd(xi.min,t.origin,s,r);let a=0,o=0;const l=bt.get();if(this.view.renderCoordsHelper.intersectManifold(t,s,l)){const h=ia(this.view.renderCoordsHelper,l,t.origin);a=Cd(h,t.origin,s,r),o=Cd(xi.max,t.origin,s,r)}else{zu(k_(j_,s+r.radius),t,l);const h=Math.PI+U1(t.direction,l);a=_0(h,t.origin,s,r),o=_0(xi.max,t.origin,s,r)}return W(a+e,n,o)-a}_getPointAbsoluteSurfaceElevation(e,t,s){const{renderCoordsHelper:r}=this.view,n=r.getAltitude(e),a=t+Math.abs(n-t);return r.setAltitude(s,a,e),a}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:s}=this.view,{camera:r}=this.view.state,{direction:n}=sT(this.view,t,0,Vb,vO),a=s.intersectManifoldClosestSilhouette(bl(t,n),e,bt.get()),o=ki(t,a),l=s.intersectManifoldClosestSilhouette(bl(t,$_(bt.get(),t,r.center)),e,bt.get()),h=ki(t,l);return Math.min(o,h)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:s}=this.view,{camera:r,isGlobal:n}=s,a=t.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,bt.get());if(n){const o=Te(bt.get(),e,a),l=Ce(o);ie(o,o,1/l);const h=ae(bt.get(),e),d=sa(ce(h,o));return l*Math.sin(Math.min(_O,d))}{const o=ue(bt.get(),e);return t.setAltitude(o,this._filteredSurfaceElevation),ki(a,o)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:gO}_computeVelocities(e){const t=this._filteredSurfaceElevation,s=t+Ot(this.view.spatialReference).radius,{camera:r,isGlobal:n}=this.view.state,a=bt.get(),o=this._getPointAbsoluteSurfaceElevation(r.eye,t,a),l=this._clampedDistanceToSurface(t,a),h=r.width/2,d=D0*r.width,u=D0*r.width,p=l*Math.tan(.5*r.fovX)/h,_=p/s,f=p/this._computeHeadingRotateRadius(a),g=o-t;return{pan:(n?_:p)*d*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(d*e/h)*g-g),zoom:2**(d*e/h)*l-l,rotate:W(f*u,fO,yO)*e}}_applyDisabledMovementTypes(e){this.disableMovements==null||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&nu(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&nu(e.rotate.matrix))}static activatesFor(e,t){const s=pf(t,e.navigation.gamepad,mO);return!(t.action==="end"||ep(s))}};c([m({constructOnly:!0})],Ba.prototype,"gamepadDevice",void 0),c([m({constructOnly:!0})],Ba.prototype,"disableMovements",void 0),Ba=c([I("esri.views.3d.state.controllers.GamepadKeyboardController")],Ba);const mO={translation:[0,0,0],heading:0,tilt:0,zoom:0},Vb=80,_O=Et(Vb),D0=.75,gO=5,fO=Et(30),yO=Et(80),ba={zoom:0,ascend:0,pan:{enabled:!1,matrix:Nt()},rotate:{enabled:!1,matrix:Nt()}},Zi=v(),kl=v(),vO=rT();function bO(i){i.zoom=0,i.ascend=0,i.pan.enabled=!1,nu(i.pan.matrix),i.rotate.enabled=!1,nu(i.rotate.matrix)}let wO=class extends Tr{constructor(e){super(!0),this._view=e,this._watchHandles=new b_,this._handle=this.registerIncoming("gamepad",t=>this._handleEventGamepad(t)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([E(()=>this._view.navigation.gamepad.enabled,t=>{t?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},dt),E(()=>this._view.navigation.gamepad.device,t=>{this._cameraControllerGamepad&&t&&this._cameraControllerGamepad.gamepadDevice!==t&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){var r;const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const s=(r=this._cameraControllerGamepad)==null?void 0:r.running;if(s||Ba.activatesFor(this._view,e.data)){if(!s){const n=new Ba({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(n),n.state!==ct.Rejected&&(this._cameraControllerGamepad=n)}this._cameraControllerGamepad&&this._cameraControllerGamepad.running&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}};var ds;(function(i){i[i.LEFT=0]="LEFT",i[i.RIGHT=1]="RIGHT",i[i.FORWARD=2]="FORWARD",i[i.BACKWARD=3]="BACKWARD",i[i.UP=4]="UP",i[i.DOWN=5]="DOWN",i[i.HEADINGLEFT=6]="HEADINGLEFT",i[i.HEADINGRIGHT=7]="HEADINGRIGHT",i[i.TILTUP=8]="TILTUP",i[i.TILTDOWN=9]="TILTDOWN",i[i.ZOOMIN=10]="ZOOMIN",i[i.ZOOMOUT=11]="ZOOMOUT"})(ds||(ds={}));let xO=class extends Tr{constructor(e,t){super(!0),this._view=e,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Ne.Local},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._keyToNumber={[t.left]:ds.LEFT,[t.right]:ds.RIGHT,[t.forward]:ds.FORWARD,[t.backward]:ds.BACKWARD,[t.up]:ds.UP,[t.down]:ds.DOWN,[t.headingLeft]:ds.HEADINGLEFT,[t.headingRight]:ds.HEADINGRIGHT,[t.tiltUp]:ds.TILTUP,[t.tiltDown]:ds.TILTDOWN,[t.zoomIn]:ds.ZOOMIN,[t.zoomOut]:ds.ZOOMOUT},this.registerIncoming("key-down",null,s=>this._handleKeyDown(s)),this.registerIncoming("key-up",null,s=>this._handleKeyUp(s)),this.registerIncoming("blur",null,()=>this._handleStop()),this._visibilityHandle=AC(s=>s?null:this._handleStop())}onUninstall(){var e;(e=this._visibilityHandle)==null||e.remove(),this._handleStop()}setStickyKeyDuration(e){this._stickyKeyDuration=e}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];if(t!=null&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new Ba({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(e.stopPropagation(),this._cameraControllerKeyboard.directionActive(t)||(this._cameraControllerKeyboard.activateDirection(t),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(t)))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout(()=>{var s;this._stickyKeyTimeoutHandle=void 0,this._stickyDirection!=null&&this._stickyDirection!==void 0&&((s=this._cameraControllerKeyboard)==null||s.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)},this._stickyKeyDuration))}}_handleStop(){var e;(e=this._cameraControllerKeyboard)!=null&&e.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){var s,r,n;if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];if(t!=null&&((s=this._cameraControllerKeyboard)!=null&&s.running)){e.stopPropagation();const a=this._stickyKeyTimeoutHandle===void 0;if(this._stickyKeyTimeoutHandle!==void 0&&((r=this._cameraControllerKeyboard)==null?void 0:r.countActiveDirections())===1)return void(this._stickyDirection=t);(n=this._cameraControllerKeyboard)==null||n.deactivateDirection(t),a&&(this._stickyDirection=void 0)}}_isPanning(e){return e<=3}},CO=class extends Tr{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",[t],s=>this._handleFov(s)),this.registerIncoming("mouse-wheel",s=>this._handleZoom(s))}_handleZoom(e){var s;if(!this._view.navigation.mouseWheelZoomEnabled)return;const t=e.data;(s=this._zoomController)!=null&&s.running||(this._stopFovController(),this._zoomController=this._view.state.isGlobal?new Cu({view:this._view,mode:"interaction"}):new Tu({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._zoomController)),this._zoomController.step(-t.deltaY/60,ri(t.x,t.y)),e.preventDefault(),e.stopPropagation()}_handleFov(e){var t,s,r;this._view.navigation.mouseWheelZoomEnabled&&((t=this._fovController)!=null&&t.running||((s=this._zoomController)==null||s.finish(),(r=this._fovController)==null||r.hideOverlay(),this._fovController=new dl({view:this._view,onStop:()=>this._stopFovController()}),this._view.state.switchCameraController(this._fovController),this._fovController.state!==ct.Rejected)?(this._fovController.updateTimeout(),this._fovController.step(e.data.deltaY/20),e.preventDefault(),e.stopPropagation()):this._stopFovController())}_stopFovController(){var e;(e=this._fovController)==null||e.finish(),this._fovController=null}},Su=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return this._value===void 0?0:this._value}update(e){this._value===void 0?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}},to=class extends tc{constructor(){super(...arguments),this._beginCamera=new xt,this._elapsedTimeSec=0,this.constraintOptions=new Ps(ht.ALL,Re.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new fl}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),Mt(this.view,t,this.constraintOptions)}};to=c([I("esri.views.3d.state.controllers.momentum.MomentumController")],to);let Eh=class extends to{constructor(e){super(e),this.interactionType=Re.PAN,this._tmpPan=v()}momentumStep(e,t){const s=this.momentum.value(e);ie(this._tmpPan,this.momentum.direction,s),t.eye=Te($0,t.eye,this._tmpPan),t.center=Te($0,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};c([m({constructOnly:!0})],Eh.prototype,"momentum",void 0),Eh=c([I("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Eh);const $0=v(),TO=v(),Yc=v();let Md=class extends to{constructor(e){super(e),this.interactionType=Re.PAN}momentumStep(e,t){const s=this.momentum.value1(e),r=this.momentum.value2(e);ue(Yc,t.eye),ae(Yc,Yc),gt(this.momentum.axis2,Yc,this.momentum.axis1),Db(t,TO,this.momentum.axis1,s,this.momentum.axis2,r)}};c([m({constructOnly:!0})],Md.prototype,"momentum",void 0),Md=c([I("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Md);let Fa=class extends to{set center(e){this._set("center",ta(e))}set axis(e){this._set("axis",ta(e))}constructor(e){super(e),this.interactionType=Re.TUMBLE}momentumStep(e,t){const s=this.momentum.value(e);la(t,this.center,ic(this.axis,s))}};c([m({constructOnly:!0})],Fa.prototype,"momentum",void 0),c([m({constructOnly:!0})],Fa.prototype,"center",null),c([m({constructOnly:!0})],Fa.prototype,"axis",null),Fa=c([I("esri.views.3d.state.controllers.momentum.RotationMomentumController")],Fa);let Ko=class extends to{set zoomCenter(e){this._set("zoomCenter",ta(e))}constructor(e){super(e),this.interactionType=Re.ZOOM,this.constraintOptions.interactionDirection=v()}momentumStep(e,t){const{interactionDirection:s}=this.constraintOptions;if(!s)return;ue(s,t.eye);const r=this.momentum.valueDelta(0,e);dg(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),$_(s,t.eye,s)}};c([m({constructOnly:!0})],Ko.prototype,"momentum",void 0),c([m({constructOnly:!0})],Ko.prototype,"zoomCenter",null),Ko=c([I("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Ko);let Aa=class extends to{set screenCenter(e){this._set("screenCenter",ri(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",ta(e))}constructor(e){super(e),this.interactionType=Re.ZOOM,this.radius=0,this._tmpSceneCenter=v(),this._tmpZoomAxisAngle=Gu(),this._sphere=wr()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const s=this.momentum.valueDelta(0,e);Pb(this._sphere,t,s),this.constraintOptions.interactionType=Re.ZOOM,Mt(this.view,t,this.constraintOptions),sc(this._sphere,t,this.screenCenter,this._tmpSceneCenter),hg(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),la(t,At(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=Re.PAN}};c([m({constructOnly:!0})],Aa.prototype,"momentum",void 0),c([m({constructOnly:!0})],Aa.prototype,"screenCenter",null),c([m({constructOnly:!0})],Aa.prototype,"sceneCenter",null),c([m({constructOnly:!0})],Aa.prototype,"radius",void 0),Aa=c([I("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],Aa);let I0=class{constructor(e){this._gain=e}update(e){this.filteredValue!==void 0?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}};const L0=1e-5;let SO=class extends bP{constructor(e,t,s,r,n,a=0,o){super(e,t,s),this._angularVelocity1=r,this.axis1=n,this.angularVelocity2=a,this.axis2=o}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}},PO=class{constructor(e=300,t=12,s=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=s,this.enabled=!0,this._tmpAxis1=v(),this._tmpAxis2=v(),this._tmpAngles=Ss(),this._time=new np(.3),this._screen=[new np(.4),new np(.4)],this._angle1=new I0(.6),this._angle2=new I0(.6),this._axis1=v(),this._axis2=v(),this._lastScene=v()}addMomentumDirectRotation(e,t,s,r,n,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(s)<.01)return;let o=Rb(this._lastScene,t,this._tmpAxis2,r,n,a);this._angle2.update(0),Hs(this._tmpAxis2)<L0?o=0:ae(this._axis1,this._tmpAxis2),this._angle1.update(o),ue(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(s)}}addMomentumPreserveHeading(e,t,s,r,n,a,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(s)<.01)return;Ab(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,r,n,a,o,!1),Hs(this._tmpAxis2)<L0?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),ae(this._axis1,this._tmpAxis1),ae(this._axis2,this._tmpAxis2)),ue(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(s)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,s=e==null||t==null?null:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,n=s==null||r==null?0:s/r;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(e,t,s){const r=this._time.filteredDelta,n=this._angle1.filteredValue,a=this._angle2.filteredValue,o=r==null||a==null?0:a/r;return new SO(e,t,s,r==null||n==null?0:n/r,this._axis1,o,this._axis2)}},Hm=class extends ur{constructor(){super(...arguments),this._smoothRotation=new Su(.05),this._rotationAxis=v(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=Wh(),this._beginRadius=0,this._smoothScaling=new Su(.05),this._zoomCenterScreen=ri(),this._zoomMomentumEstimator=new W1,this._rotationMomentumEstimator=new Q1,this._panSphericalMomentumEstimator=new PO,this._panPlanarMomentumEstimator=new X1,this._adjustedSphere=wr(),this._tmp3d=v(),this._tmpScreenPointArray=ri(),this._beginScreenPoint=ri(),this._beginScenePoint=v(),this._screenPickPoint=ri(),this._scenePickPoint=v(),this._navMode=Pi.Horizontal,this._sphere=wr(),this._pointerCount=0,this._tmpInteractionDirection=v(),this._beginCamera=new xt,this._constraintOptions=new Ps(ht.ALL,Re.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-na.normalize(Et(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),dn(e.center,this._screenPickPoint),ra(this._beginScreenPoint,this._screenPickPoint);const t=Ot(this.view.spatialReference),s=Mb(this._intersectionHelper,this.startCamera,this._screenPickPoint,t,xl.Silhouette,this.view.map.ground.opacity===0?lo:{});s.scenePickPoint!=null&&(this._scenePickPoint=s.scenePickPoint,this._sphere=s.sphere,ue(this._beginScenePoint,this._scenePickPoint),this._navMode=gc(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===Pi.Vertical&&this._preparePlanarPanMode(e,s.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._navMode===Pi.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._navMode===Pi.Horizontal?new Aa({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new Ko({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const s=this._rotationMomentumEstimator.evaluateMomentum();if(s)return new Fa({view:this.view,momentum:s,center:At(this._sphere),axis:this._rotationAxis});if(this._navMode===Pi.Horizontal){const r=this._panSphericalMomentumEstimator.evaluateMomentum();if(r)return new Md({view:this.view,momentum:r})}else{const r=this._panPlanarMomentumEstimator.evaluateMomentum();if(r)return new Eh({view:this.view,momentum:r})}return null}_preparePlanarPanMode(e,t){const s=Xn(this._tmp3d,this.startCamera.viewForward);q1(this._scenePickPoint,s,this._panningPlane);const r=ri(this._screenPickPoint[0],0),n=v(),a=Ce(this.startCamera.eye);this._adjustedSphere[3]=a<this._sphere[3]?a-100:this._sphere[3],sc(this._adjustedSphere,this.startCamera,r,n);const o=Au();this.startCamera.projectToRenderScreen(n,o);const l=v(),h=v(),d=v();Te(l,this._scenePickPoint,this.currentCamera.eye);const u=Ce(l);ae(l,l);const p=Tb*Math.max(Math.abs(this.view.camera.position.z),Sb),_=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,_c);let f=_??p;f=t?Math.min(f,u):f,ue(d,ye(h,this.currentCamera.eye,ie(h,l,f))),this._panningPlane[3]=-ce(Nn(this._panningPlane),d),this.startCamera.center=ye(h,this.startCamera.eye,ie(h,this.startCamera.viewForward,f));const g=dn(e.center,this._tmpScreenPointArray);Fm(this._panningPlane,this.startCamera,g,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,s=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=s,this._smoothScaling.update(t),Pb(this._sphere,this.currentCamera,this._smoothScaling.value),dn(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=Re.ZOOM,this._constraintOptions.interactionFactor=zs(e.radius-this._beginRadius),Mt(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=dn(e.center,this._tmpScreenPointArray);sc(this._sphere,this.currentCamera,t,this._tmp3d),ug(this._beginScenePoint,ce(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(Ib(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):($b(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=Re.PAN,this._constraintOptions.interactionFactor=zs(Hh(this._screenPickPoint,t)),Mt(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){ae(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||Xn(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,s=t+Vm(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(s);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),la(this.currentCamera,At(this._sphere),ic(this._rotationAxis,n)),this._constraintOptions.interactionType=Re.TUMBLE,this._constraintOptions.interactionFactor=zs(e.radius*s),Mt(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=dn(e.center,this._tmpScreenPointArray);Fm(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(Ob(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=Re.PAN,this._constraintOptions.interactionFactor=zs(Hh(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Mt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,s=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=s,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),dg(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=Re.ZOOM,this._constraintOptions.interactionFactor=zs(e.radius-this._beginRadius),Mt(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){ue(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||Xn(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let s=e.angle-t;s=Vm(s);const r=t+s,n=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=n,this._smoothRotation.update(r);const a=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp),la(this.currentCamera,At(this._sphere),ic(this._rotationAxis,a)),this._constraintOptions.interactionType=Re.TUMBLE,this._constraintOptions.interactionFactor=zs(e.radius*a),Mt(this.view,this.currentCamera,this._constraintOptions)}};Hm=c([I("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],Hm);const N0=Pt(0,0,1);let Bm=class extends ur{constructor(){super(...arguments),this._rotationValueSmooth=new Su(.05),this._scalingValueSmooth=new Su(.05),this._planeHorizontal=Wh(),this._planeVertical=Wh(),this._rotationMomentumEstimator=new Q1,this._panMomentumEstimator=new X1(300,12,.9),this._zoomMomentumEstimator=new W1,this._beginRadius=0,this._beginCenter=v(),this._beginAngle=0,this._tmpPoints=[],this._navMode=Pi.Horizontal,this._beginCenterScreen=ri(),this._tmpCentroid3d=v(),this._tmpCentroid2d=ri(),this._tmp2d=ri(),this._pointerCount=0,this._beginCamera=new xt,this._constraintOptions=new Ps(ht.ALL,Re.NONE,0,this._beginCamera)}begin(e){if(!this.running)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),dn(e.center,this._beginCenterScreen),z1(N0,0,this._planeHorizontal);const s=v(),r=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,s,this.view.map.ground.opacity===0?lo:{}),n=v();Xn(n,this.startCamera.viewForward);const a=v();ue(a,N0);const o=ce(n,a);this._navMode=gc(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);const l=Math.min(Tb,1/Math.abs(ce(a,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),Sb);Lf(this._planeHorizontal,this._planeHorizontal,s),this.startCamera.aboveGround||cP(this._planeHorizontal,this._planeHorizontal);const h=v(),d=v(),u=v();Te(h,s,this.currentCamera.eye);const p=Ce(h);if(ae(h,h),this._navMode===Pi.Vertical){ie(a,a,o),Te(Nn(this._planeVertical),n,a),ae(Nn(this._planeVertical),Nn(this._planeVertical)),Lf(this._planeVertical,this._planeVertical,s);const _=this.view._stage.renderView.getMinimalDepthForArea(rc(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,_c);let f=_??l;f=r?Math.min(f,p):f,ue(u,ye(d,this.currentCamera.eye,ie(d,h,f))),this._planeVertical[3]=-ce(Nn(this._planeVertical),u),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),mp(this._tmpPoints,this._beginCenter)}else{const _=r?p:l;ue(u,ye(d,this.currentCamera.eye,ie(d,h,_))),this._planeHorizontal[3]=-ce(Nn(this._planeHorizontal),u),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),mp(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,s=this._navMode===Pi.Horizontal?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(t){const n=this._beginRadius/e.radius,a=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=a,this._scalingValueSmooth.update(n),dg(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=Re.ZOOM,this._constraintOptions.interactionFactor=zs(Math.abs(e.radius-this._beginRadius)),Mt(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,s,this.currentCamera,this._tmpPoints),mp(this._tmpPoints,this._tmpCentroid3d),dn(e.center,this._tmpCentroid2d),Ob(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=Re.PAN,this._constraintOptions.interactionFactor=zs(Hh(this._beginCenterScreen,this._tmpCentroid2d)),Mt(this.view,this.currentCamera,this._constraintOptions),t){const n=r,a=this._rotationValueSmooth.value,o=a+Vm(e.angle-a),l=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=l,this._rotationValueSmooth.update(o);const h=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(h,.001*e.timestamp);const d=Nn(this._planeHorizontal);la(this.currentCamera,n,ic(d,h)),this._constraintOptions.interactionType=Re.TUMBLE,this._constraintOptions.interactionFactor=zs(Math.abs(e.radius*h)),Mt(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new Ko({view:this.view,momentum:t,zoomCenter:this._beginCenter});const s=this._rotationMomentumEstimator.evaluateMomentum();if(s)return new Fa({view:this.view,momentum:s,center:this._beginCenter,axis:Nn(this._planeHorizontal)});const r=this._panMomentumEstimator.evaluateMomentum();return r?new Eh({view:this.view,momentum:r}):null}_computePlanePoints(e,t,s,r){r.length=e.size;const n=this._tmp2d;let a=0;return e.forEach(o=>{n[0]=o.x,n[1]=o.y,r[a]===void 0&&(r[a]=v()),Fm(t,s,n,r[a]),a+=1}),r}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};Bm=c([I("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],Bm);let V0=class extends Tr{constructor(e,t,s){super(!0),this._view=e,this.pointerAction=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",s,r=>this._handleDrag(r))}_handleDrag(e){if(e.data.pointerType==="mouse"&&!E_(e.data,this.pointerAction))return;const t=e.timestamp-this._lastEndTimestamp,s=40,r=this._momentum&&this._momentum.running&&t<s;switch(e.data.action){case"start":case"update":if(r)break;this._controller&&this._controller.running?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){var s;if((s=this._controller)!=null&&s.running){this._lastEndTimestamp=e.timestamp;const r=this._controller.end(e.data);t&&r&&(this._momentum=r,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new Hm({view:this._view}):new Bm({view:this._view})}},EO=class extends Tr{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,()=>this.view.state.stopActiveCameraController())}},Fb=class extends Tr{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,s=>this._handleKeyDown(s))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}},MO=class extends Fb{constructor(e,t,s){super(t,s),this.view=e}activate(){this.view.goTo({heading:0}).catch(()=>{})}},OO=class extends Fb{constructor(e,t,s){super(t,s),this.view=e}activate(){this.view.goTo({tilt:0}).catch(()=>{})}},RO=class extends Tr{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",s=>this._handleTwoFinger(s))}_handleTwoFinger(e){var r,n,a;const t=this._invert?-1:1,s=ri(0,e.data.delta*t);switch(e.data.action){case"begin":(r=this._cameraController)==null||r.end(),this._cameraController=new Ph({view:this._view,pivot:_s.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(s);break;case"update":(n=this._cameraController)==null||n.update(s);break;case"end":(a=this._cameraController)==null||a.end(),this._cameraController=null}}},AO=class extends Tr{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new DC({start:(s,r)=>this._observeStart(s,r),update:(s,r,n)=>this._observeUpdate(s,r,n),end:(s,r)=>this._observeEnd(r)}),this.registerIncoming("drag",s=>this._dragEventSeparator.handle(s))}get failed(){return this._state==="failed"}_observeStart(e,t){e===1&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=e===2?"ready":"failed"}_observeUpdate(e,t,s){if(this._state!=="failed"&&e===2)return this._state==="active"?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,s.data)?this._checkVerticalThresholdReached(t.data,s.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){this._state==="active"&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let s=-1/0,r=1/0,n=-1/0,a=1/0;for(const{x:g,y}of t.pointers.values())s=Math.max(s,g),r=Math.min(r,g),n=Math.max(n,y),a=Math.min(a,y);let o=-1/0,l=1/0,h=-1/0,d=1/0;for(const{x:g,y}of e.pointers.values())o=Math.max(o,g),l=Math.min(l,g),h=Math.max(h,y),d=Math.min(d,y);const u=s-r,p=n-a,_=o-l,f=h-d;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(_-u)<=this._maxDelta&&Math.abs(f-p)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let s=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((r,n)=>{const a=t.pointers.get(n);s=Math.min(s,Math.abs(r.y-a.y))}),s>=this._threshold}},er=class extends De{destroy(){this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){e!=="pan"&&e!=="rotate"||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){e!=="default"&&e!=="pro"||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get updating(){var e;return!!((e=this._inputManager)!=null&&e.updating)}get latestPointerType(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerType}get latestPointerLocation(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerLocation}get multiTouchActive(){var e;return((e=this._inputManager)==null?void 0:e.multiTouchActive)??!1}disconnect(){this.view.viewEvents.disconnect(),this._inputManager=de(this._inputManager)}connect(){const e=this.view;this._source=new $C(this.view.surface,e.input);const t=[new IC,new LC,new NC,new VC(this.view.navigation),new AO],s=new pP({eventSource:this._source,recognizers:t});this._inputManager=s,s.installHandlers("prevent-context-menu",[new FC],Vf.INTERNAL);const r={fov:"Shift",lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};this._modeDragPan=new V0(e,"primary"),this._modeDragRotate=new Cp(e,"secondary",_s.CENTER),this._modeDragZoom=new pO(e,"tertiary",r.fov),this._modeKeyboardNavigation=new xO(e,r.pan),s.installHandlers("navigation",[new EO(e),new jM(e),new wO(e),new CO(e,r.fov),new OO(e,r.resetTilt),new MO(e,r.resetHeading),new Cp(e,"primary",_s.EYE,[r.lookAround]),new Cp(e,"secondary",_s.CENTER,[r.lookAround]),new V0(e,"tertiary",[r.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,this._modeKeyboardNavigation,new RO(e)],Vf.INTERNAL),this.view.viewEvents.connect(s),this._updateMode(),this.addHandles(E(()=>{var n;return(n=this.view.navigation)==null?void 0:n.browserTouchPanEnabled},n=>{this._source.browserTouchPanningEnabled=!n},dt))}isModifierKeyDown(e){var t;return((t=this._inputManager)==null?void 0:t.isModifierKeyDown(e))??!1}_updateMode(){var r;const e=this.mode,t=this.primaryDragAction,s=(r=Gm.get(e))==null?void 0:r.get(t);s&&(this._modeDragPan&&(this._modeDragPan.pointerAction=s.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=s.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=s.zoom))}get test(){}};c([m()],er.prototype,"view",void 0),c([m({value:"pan"})],er.prototype,"primaryDragAction",null),c([m({value:"default"})],er.prototype,"mode",null),c([m({readOnly:!0})],er.prototype,"updating",null),c([m()],er.prototype,"latestPointerType",null),c([m()],er.prototype,"latestPointerLocation",null),c([m()],er.prototype,"multiTouchActive",null),c([m()],er.prototype,"_inputManager",void 0),er=c([I("esri.views.3d.input.SceneInputManager")],er);const Gm=new Map,Sp=new Map,Pp=new Map;Sp.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),Sp.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),Pp.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),Pp.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),Gm.set("default",Sp),Gm.set("pro",Pp);const DO=er;let xs,ul,km=!1,jm=!1,Wm=!1,Qm=!1,Mh=null;function $O(i,e){if(!jm||!ul)return;Ub();const t=ul;let s=0;for(let r=0;r<i.accBinsNumX;r++)for(let n=0;n<i.accBinsNumY;n++){const a=i.accBins[r][i.accBinsNumY-1-n];s+=a.length;const o=r*i.accBinsSizeX,l=(r+1)*i.accBinsSizeX,h=n*i.accBinsSizeY,d=(n+1)*i.accBinsSizeY;t.fillText(a.length.toFixed(),o+5,h+15),zb(o,l,h,d,"blue")}t.fillText("total totalShownLabels: "+s,70,40),t.fillText("total visible labels: "+e.size,70,50),t.fillText("total numTests: "+i.accNumTests,70,30)}function IO(i){Wm=fs.DECONFLICTOR_SHOW_VISIBLE,Qm=fs.DECONFLICTOR_SHOW_INVISIBLE,km=Wm||Qm,jm=fs.DECONFLICTOR_SHOW_GRID,Mh=null,km||jm?Mh=()=>LO(i):xs&&(xs.parentElement.removeChild(xs),xs=null)}function Ub(){Mh&&(Mh(),Mh=null)}function LO(i){xs==null&&(xs=document.createElement("canvas"),xs.setAttribute("id","debugCanvas2d"),i.surface.parentElement.style.position="relative",i.surface.parentElement.appendChild(xs));const{state:e}=i,{camera:t,pixelRatio:s}=e,{width:r,height:n}=t,a=r*s,o=n*s;xs.setAttribute("width",`${a}px`),xs.setAttribute("height",`${o}px`),xs.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${r}px;height:${n}px`),ul=xs.getContext("2d"),ul.clearRect(0,0,r,n),ul.font="12px Arial"}function zb(i,e,t,s,r){Ub();const n=xs.height,a=ul;a.beginPath(),a.lineWidth=1,a.strokeStyle=r,a.moveTo(i,n-t),a.lineTo(e,n-t),a.stroke(),a.lineTo(e,n-s),a.stroke(),a.lineTo(e,n-t),a.stroke(),a.lineTo(i,n-t),a.stroke(),a.lineTo(i,n-t),a.stroke(),a.closePath()}function NO(i,e){km&&(e&&Wm||!e&&Qm)&&zb(i.aabr[0],i.aabr[2],i.aabr[1],i.aabr[3],e?"green":"red")}const Pr=v(),xo=Ci(),jl=Ci(),Ep=v(),VO=Nt(),FO=wr(),Mp=ao(),UO=v(),zO=mi();class qO{constructor(){this.aabr=mi(),this.distance=0,this.culled=!1,this.visible=!1}}class HO{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info={}}}var us;(function(i){i[i.Idle=0]="Idle",i[i.Process=1]="Process",i[i.Sort=2]="Sort",i[i.Deconflict=3]="Deconflict",i[i.NumStates=4]="NumStates"})(us||(us={}));class BO{constructor(){this.camera=new xt,this.slicePlane=S_(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),P_(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let Jo=class extends De{get dirty(){return this._dirty}get state(){return this._state}constructor(i){super(i),this._dirty=!1,this._viewState=new BO,this._state=us.Idle,this._active=new Map,this._visible=new Map,this._iterators=new WO,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0}destroy(){this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==us.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const i=this._state/us.NumStates;return this._dirty?.5*i:i}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(i){switch(this._state){case us.Idle:this._startUpdate(),i.madeProgress();case us.Process:if(this._state=us.Process,!this._processActiveGraphics(i))return;case us.Sort:if(this._state=us.Sort,!this._sortVisibleGraphics(i))return;case us.Deconflict:if(this._state=us.Deconflict,!this._deconflictVisibleGraphics(i))return;default:$O(this,this._visible),this._state=us.Idle,this.notifyChange("updating")}}modifyGraphics(i,e){e?i.forEach(t=>this.addToActiveGraphics(t)):i.forEach(t=>this.removeFromActiveGraphics(t)),this.setDirty()}layerSupportsDeconfliction(i){if(i==null||i.type!=="object3d")return!1;const e=i.stageObject;if(((e==null?void 0:e.geometries.length)??0)!==1)return!1;const t=e==null?void 0:e.geometries[0];return(t==null?void 0:t.material)instanceof X_}_startUpdate(){IO(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:i,fullHeight:e}=this._viewState.camera;this._initBins(i,e),this._resetIterators()}addToActiveGraphics(i){i.info[this.visibilityGroup]=new qO,this._active.set(i.graphics3DGraphic.graphic.uid,i),this.setDirty()}removeFromActiveGraphics(i){this._visible.delete(i.graphics3DGraphic.graphic.uid),GO(i,this.visibilityGroup),delete i.info[this.visibilityGroup],this._active.delete(i.graphics3DGraphic.graphic.uid),this.setDirty()}_processActiveGraphics(i){const e=this._ensureActiveGraphicsIterator(),t=f1(VO,this._viewState.camera.projectionMatrix),s=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._viewState.camera.relativeElevation>0?FO:null;let r=0;for(s!=null&&(Wt(At(s),js,this._viewState.camera.viewMatrix),s[3]=Ot(this.view.spatialReference).radius,r=iP(s,js));!i.done;){i.madeProgress();const n=e.next();if(n.done===!0)return this._resetActiveGraphicsIterator(),!0;const a=n.value,o=a==null?void 0:a.info[this.visibilityGroup];o&&(this._collectGraphics3DGraphics(a,t,s,r),o.culled?this._visible.delete(a.graphics3DGraphic.graphic.uid):this._visible.set(a.graphics3DGraphic.graphic.uid,a))}return!1}_sortVisibleGraphics(i){const e=this._ensureSortGraphicsIterator();for(;!i.done;){const t=e.next();if(i.madeProgress(),t.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(i){const e=this._ensureVisibleGraphicsIterator(),t=this.visibilityGroup===qs.LABEL;for(;!i.done;){i.madeProgress();const s=e.next();if(s.done===!0)return this._resetVisibleGraphicsIterator(),!0;const r=s.value,n=r.info[this.visibilityGroup];if(!n||n.culled){this._setGraphicVisibility(r,!1);continue}const a=r.graphics3DGraphic,o=!t||a.isVisible();n.visible=o&&!this._isConflicted(r),n.visible&&this._addToBins(r),this._setGraphicVisibility(r,n.visible),NO(n,n.visible)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=F0(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=F0(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=kO(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(i,e,t,s){const r=i.graphics3DGraphic;if(r.destroyed)return;const n=i.info[this.visibilityGroup];if(!r.isVisible(qs.GRAPHIC,or.DECONFLICTION))return void(n.culled=!0);const a=this.getGraphicsLayers(r);Za(n.aabr);let o=null;for(const l of a){if(!this.layerSupportsDeconfliction(l))continue;const h=l.stageObject.geometries[0].material;if(o==null&&(o=ZO,this._getProjectionInfo(l,e,o),o.isOutsideScreen||this._isCulledBySlice(i,Pr)||t!=null&&YO(o,t,s)))return void(n.culled=!0);this._expandBoundingRect(n,l,h,o)}o==null?n.culled=!0:(n.distance=o.distance,n.culled=!1)}_getProjectionInfo(i,e,t){const s=this._viewState.camera,r=i.stageObject,n=r.geometries[0],a=n.material,o=At(r.boundingVolumeWorldSpace.bounds);Wt(Pr,o,s.viewMatrix);const l=n.attributes,h=l.get(Ae.NORMAL).data,d=l.get(Ae.CENTEROFFSETANDDISTANCE).data;a.applyShaderOffsetsView(Pr,h,r.transformation,d,s,t.scaleInfo,Pr),oa(xo,Pr[0],Pr[1],Pr[2],1),Mm(jl,xo,s.projectionMatrix),ie(t.positionNDC,jl,1/jl[3]),a.applyShaderOffsetsNDC(t.positionNDC,d,s,t.positionNDC,Ep),t.distanceWithoutPolygonOffset=s.depthNDCToWorld(Ep[2]),t.distance=Ep[2]===t.positionNDC[2]?t.distanceWithoutPolygonOffset:s.depthNDCToWorld(t.positionNDC[2]),oa(jl,t.positionNDC[0],t.positionNDC[1],t.positionNDC[2],1),Mm(xo,jl,e),G1(xo,xo,1/xo[3]),$e(t.positionView,Pr[0],Pr[1],Pr[2])}_isCulledBySlice(i,e){return i.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&vC(this._viewState.slicePlane,e)}_expandBoundingRect(i,e,t,{positionNDC:s,scaleInfo:r}){const n=this._viewState.camera,a=e.getScreenSize(QO);wP(a,r.factor,a),a[0]*=n.pixelRatio,a[1]*=n.pixelRatio;const o=Jv(t.calculateRelativeScreenBounds(a,r.factorAlignment.scale,zO),ke(0,n.fullWidth,.5+.5*s[0]),ke(0,n.fullHeight,.5+.5*s[1])),l=this.marginFactor;if(l!==0){const h=l*Math.min(Ia(o),Zd(o));o[0]-=h,o[1]-=h,o[2]+=h,o[3]+=h}al(i.aabr,o,i.aabr)}_isConflicted(i){const e=i.graphics3DGraphic.graphic.uid,t=i.info[this.visibilityGroup];let s=!0;for(let r=Math.floor(t.aabr[0]/this._accBinsSizeX);r<=Math.floor(t.aabr[2]/this._accBinsSizeX);r++)if(!(r<0||r>=this._accBinsNumX))for(let n=Math.floor(t.aabr[1]/this._accBinsSizeY);n<=Math.floor(t.aabr[3]/this._accBinsSizeY);n++){if(n<0||n>=this._accBinsNumY)continue;s=!1;const a=this._accBins[r][n];for(let o=0;o<a.length;o++){const l=a.data[o],h=l.info[this.visibilityGroup];if(h&&h.visible&&l.graphics3DGraphic.graphic.uid!==e&&(this.accNumTests++,Du(h.aabr,t.aabr)))return!0}}return s}_initBins(i,e){if(this._accBins==null){this._accBins=[];for(let t=0;t<this._accBinsNumX;t++){this._accBins.push([]);const s=this._accBins[this._accBins.length-1];for(let r=0;r<this._accBinsNumY;r++)s.push(new Lt)}}else for(let t=0;t<this._accBinsNumX;t++)for(let s=0;s<this._accBinsNumY;s++)this._accBins[t][s].clear();this._accBinsSizeX=i/this._accBinsNumX,this._accBinsSizeY=e/this._accBinsNumY,this.accNumTests=0}_addToBins(i){const e=i.info[this.visibilityGroup],t=Math.floor(e.aabr[0]/this._accBinsSizeX),s=Math.floor(e.aabr[2]/this._accBinsSizeX),r=Math.floor(e.aabr[1]/this._accBinsSizeY),n=Math.floor(e.aabr[3]/this._accBinsSizeY);for(let a=t;a<=s;a++)if(!(a<0||a>=this._accBinsNumX))for(let o=r;o<=n;o++)o<0||o>=this._accBinsNumY||this._accBins[a][o].push(i)}_setGraphicVisibility(i,e){const t=i.graphics3DGraphic;t.destroyed||(t.setVisibilityFlag(this.visibilityGroup,or.DECONFLICTION,e),this.visibilityGroup===qs.LABEL&&this.view.labeler.setLabelGraphicVisibility(t,e))}};function GO(i,e){const t=i.graphics3DGraphic;t.destroyed||t.setVisibilityFlag(e,or.DECONFLICTION,!0)}function*F0(i){if(Map.prototype.entries){const e=i.entries();for(let t=e.next();!t.done;t=e.next())yield t.value[1]}else yield*i.values()}function*kO(i,e,t){e.clear(),i.forEach((r,n)=>{var l;const a=e.pushNew();a.id=n,a.visible=r.graphics3DGraphic.getVisibilityFlag(t,or.DECONFLICTION);const o=(l=r.info)==null?void 0:l[t];a.prio=r.graphics3DGraphic.deconflictionPriority,a.distance=o?o.distance:Number.MAX_VALUE}),yield;const s=e.iterableSort((r,n)=>r.prio!==n.prio?n.prio-r.prio:r.distance!==n.distance?r.distance-n.distance:r.visible!==n.visible?r.visible?-1:1:r.id-n.id);for(let r=s.next();!r.done;r=s.next())yield;e.forAll(r=>{const n=i.get(r.id);n&&(i.delete(r.id),i.set(r.id,n))}),e.clear()}c([m({constructOnly:!0})],Jo.prototype,"view",void 0),c([m({type:Boolean,readOnly:!0})],Jo.prototype,"updating",null),Jo=c([I("esri.views.3d.layers.graphics.Deconflictor")],Jo);class jO{constructor(){this.id=0,this.visible=!1,this.prio=0,this.distance=0}}class WO{constructor(e=null,t=null,s=null){this.active=e,this.visible=t,this.sort=s,this.sortArray=new Lt({allocator:r=>r||new jO})}}const QO=Ss();class XO{constructor(){this.positionView=v(),this.positionNDC=v(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new CP}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}}function YO(i,e,t){return ue(Mp.direction,i.positionView),$e(Mp.origin,0,0,0),!!Uu(e,Mp,UO)&&i.distanceWithoutPolygonOffset>t}const ZO=new XO,KO=2e3;let Od=class extends Jo{constructor(e){super(e),this.visibilityGroup=qs.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return Xi;const t=performance.now();if(e.state!==_t.IDLE&&t-this._lastDeconfliction<KO)return Xi;super.runTask(e),this.state===us.Idle&&(this._lastDeconfliction=t)}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};c([m({constructOnly:!0})],Od.prototype,"parent",void 0),Od=c([I("esri.views.3d.layers.graphics.LabelDeconflictor")],Od);let Xm=class extends Jo{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=qs.GRAPHIC,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this.addHandles([E(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.state)==null?void 0:t.camera},()=>{this._updateViewState(),this.setDirty()}),E(()=>{var e,t,s;return(s=(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground)==null?void 0:s.opacity},(e,t)=>{e!==1&&t!==1||this.setDirty()}),E(()=>{var e;return(e=this.view)==null?void 0:e.slicePlane},()=>{this._updateSlicePlane(),this._slicePlaneChanged()},dt)]),this._frameTask=this.view.resourceController.scheduler.registerTask(ni.GRAPHICS_DECONFLICTOR,this),this._labels=new Od({view:this.view,parent:this})}destroy(){this._labels=de(this._labels),this._frameTask=Hr(this._frameTask)}get marginFactor(){return this._marginFactor}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}_updateViewState(){var e;(e=this.view)!=null&&e.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;e!=null&&bC(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=e!=null}_slicePlaneChanged(){for(const e of this._contexts.keys())if(e.symbolCreationContext.slicePlaneEnabled)return void this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:s=>this._addGraphic(e,t,s),removeGraphic:s=>this._removeGraphic(t,s),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach(s=>this._removeGraphic(t,s.graphics3DGraphic)),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(s=>this._removeGraphic(t,s.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,s){const r=s.graphic.uid,n=new HO(s,e.symbolCreationContext.slicePlaneEnabled);t.set(r,n),Op(e)&&this.addToActiveGraphics(n),e.labelsEnabled&&this._labels.addToActiveGraphics(n);const a=!this._graphicSupportsDeconfliction(s)||!Op(e);s.setVisibilityFlag(qs.GRAPHIC,or.DECONFLICTION,a)}_removeGraphic(e,t){const s=t.graphic.uid,r=e.get(s);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(s),this.setDirty())}enabledChanged(e,t){const s=Op(e);s||JO(e),this.modifyGraphics(t,s)}_slicePlaneEnabledChanged(e,t){const s=e.symbolCreationContext.slicePlaneEnabled;t.forEach(r=>r.slicePlaneEnabled=s),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!(t!=null&&t.length))return!1;for(const s of t)if(this.layerSupportsDeconfliction(s))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const s=new Map;return this._contexts.set(e,s),this.setDirty(),s}};function Op(i){const e=i.layer;return!(!(e!=null&&e.featureReduction)||e.featureReduction.type!=="selection")}function JO(i){const e=i.graphics3DGraphics;e&&e.forEach(t=>t.setVisibilityFlag(qs.GRAPHIC,or.DECONFLICTION,!0))}Xm=c([I("esri.views.3d.layers.graphics.GraphicsDeconflictor")],Xm);function _g(i){return i instanceof sC?i.graphics3DSymbol:i instanceof rC?i:null}const nc=()=>Pe.getLogger("esri.views.3d.layers.graphics.labelPlacement");let eR=class{constructor(e,t,s,r=null){this.graphics3DGraphic=e,this.labelSymbol=t,this.labelClass=s,this.disablePlacement=r}};function U0(i){const e=cR(i);if(e==null)return null;const t=tR(i,e);if(t==null)return null;const s=t.anchor,r=!!e.hasLabelVerticalOffset,n=e.verticalOffset;return sR(new RP(n,s,r),t,i)}function tR(i,e){if(e.anchor)return e;const t=i.labelClass.labelPlacement,s=pr[t],r=s||Pu(i);return t&&!s&&nc().warnOncePerTick(`the requested label placement '${t}' is currently unsupported in SceneView.`),iR(r,i)}function ku(i){const e=i.graphics3DGraphic.graphics3DSymbol,t=_g(e);return t!=null?t.symbol.symbolLayers.at(0):null}function iR(i,e){const t=e.graphics3DGraphic.graphic.geometry;if(t==null)return null;if(e.disablePlacement!=null)return e.labelClass.labelPlacement?(nc().warnOncePerTick(z0(i==null?void 0:i.placement,e.disablePlacement.logEntityDescription)),Pu(e)):i;const s=t.type;switch(s){case"polyline":case"polygon":case"extent":case"multipoint":if(e.labelClass.labelPlacement)return nc().warnOncePerTick(z0(i==null?void 0:i.placement,`'${s}' geometries`)),Pu(e);break;case"point":case"mesh":return i}return i}function z0(i,e){return`the requested label placement '${i}' is currently unsupported for ${e} in SceneView.`}function Pu(i){const e=i.graphics3DGraphic.graphic.geometry;if(e==null)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:js,anchor:"center"};case"polygon":{const t=ku(i);return t!=null&&t.type==="extrude"?pr["above-center"]:{placement:"center-center",normalizedOffset:js,anchor:"center"}}case"point":case"mesh":return pr["above-center"];default:return}}function sR(i,e,t){const s=t.graphics3DGraphic.graphic.geometry;if(s==null)return null;switch(s.type){case"point":nR(i,e,t);break;case"mesh":aR(i,e,t);break;case"polygon":rR(i,e,t)}const r=nC-UP;return i.screenOffset[0]+=r*e.normalizedOffset[0],i.screenOffset[1]+=r*e.normalizedOffset[1],i}function rR(i,e,t){const s=ku(t);if(s!=null)switch(s.type){case"extrude":{const r=t.graphics3DGraphic.layers[0];r!=null?(r.getBoundingBoxObjectSpace(Oh),IP(Oh,i.translation),i.translation[2]=LP(Oh)/2):$e(i.translation,0,0,0),gg(i,e,r);break}}}function nR(i,e,t){const s=ku(t);if(s==null)return;const r=t.graphics3DGraphic.layers[0];switch(r!=null?r.getCenterObjectSpace(i.translation):$e(i.translation,0,0,0),s.type){case"icon":case"text":oR(i,e,t,r);break;case"object":gg(i,e,r)}}function aR(i,e,t){const s=ku(t);if(s==null)return;const r=t.graphics3DGraphic.layers[0];s.type==="fill"&&gg(i,e,r)}function oR(i,e,t,s){const{graphics3DGraphic:r}=t,n=s!=null?s.getScreenSize():null;if(r.isDraped||n==null)i.hasLabelVerticalOffset||i.anchor==="center"||(pr[t.labelClass.labelPlacement]&&nc().warnOncePerTick(`the requested placement '${e.placement}' is currently unsupported for draped graphics`),i.anchor="center");else{const a=lR(t);i.screenOffset[0]=n[0]/2*(e.normalizedOffset[0]-a[0]);const o=n[1]/2*(e.normalizedOffset[1]-a[1]);i.hasLabelVerticalOffset?(i.centerOffset[1]=o,i.centerOffsetUnits="screen"):i.screenOffset[1]=o}}function lR(i,e=dR){const{graphics3DGraphic:t}=i,s=t.layers[0],r=(s==null?void 0:s.stageObject.geometries[0].material)??null;if(r&&r instanceof X_){const n=r.parameters.anchorPosition;e[0]=2*(n[0]-.5),e[1]=2*(n[1]-.5)}else e[0]=0,e[1]=0;return e}function gg(i,e,t){const s=t!=null?t.getBoundingBoxObjectSpace(Oh):Oh,r=Pt(s[3]-s[0],s[4]-s[1],s[5]-s[2]),n=Math.sqrt(r[0]*r[0]+r[1]*r[1]);i.centerOffset[0]=n/2*e.normalizedOffset[0];const a=i.translation[2],o=r[2]/2*e.normalizedOffset[1];i.translation[2]=0,i.elevationOffset=a+o;const l=Ce(r);i.centerOffset[2]=l/2*e.normalizedOffset[2]}function hR(i){return i==="above-center"}function cR(i){const e=i.labelClass.labelPlacement,{labelSymbol:t,graphics3DGraphic:s}=i,r=_g(s.graphics3DSymbol),n=(r==null?void 0:r.symbol.type)==="point-3d"?r.symbol:null,a=pr[e]||Pu(i);return n!=null&&n.supportsCallout()&&n.hasVisibleVerticalOffset()&&!s.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:n.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!t||!t.hasVisibleVerticalOffset()||n!=null&&n.supportsCallout()&&n.verticalOffset&&!s.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:a&&hR(a.placement)?{placement:"above-center",verticalOffset:t.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,a.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(nc().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}const pr={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},q0={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const i in q0){const e=q0[i],t=pr[i];e.forEach(s=>{pr[s]=t})}Object.freeze&&(Object.freeze(pr),Object.keys(pr).forEach(i=>{var e;Object.freeze(pr[i]),Object.freeze((e=pr[i])==null?void 0:e.normalizedOffset)}));const dR=[0,0],Oh=qu();let H0=class{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}},B0=class{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.textureAtlasHandles=[],this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}},uR=class{constructor(e,t,s,r,n){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=s,this.textRenderParameters=r,this.labelFunction=n,this.calloutSymbolLayerIndex=0}},pR=class{constructor(e,t,s,r,n,a,o,l){this.layer=t,this.graphics3DCore=s,this.scaleVisibility=r,this.emptySymbolLabelSupported=n,this.elevationInfoOverride=a,this.disablePlacement=o,this.active=l,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new u2(e,{pickable:!0,disableOctree:!0},t.uid)}destroy(){this.stageLayer.destroy()}},Da=class extends De{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([E(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this.setDirty()),E(()=>{var e;return(e=this.view.state)==null?void 0:e.rasterPixelRatio},()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(ni.LABELER,this)]),this._textTextureAtlas=new Ff({view:this.view}),this._hudMaterialCollection=new H0(this.view._stage),this._calloutMaterialCollection=new H0(this.view._stage)}dispose(){this.removeAllHandles(),this._textTextureAtlas=We(this._textTextureAtlas),this._hudMaterialCollection=We(this._hudMaterialCollection),this._calloutMaterialCollection=We(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),Zs.graphic=null,Zs.renderingInfo=null,Zs.layer=null}_activateLabelingContext(e){e.graphics.forEach((t,s)=>{const r=new B0(e,t);this._labels.set(s,r),e.labelsToInitialize.set(s,r),t.setVisibilityFlag(qs.LABEL,or.USER,!0)}),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach((t,s)=>{t.setVisibilityFlag(qs.LABEL,or.USER,!1),this.setLabelGraphicVisibility(t,!1),t.clearLabelGraphics(),this._labels.delete(s)}),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&(e.textureAtlasHandles.push(this._textTextureAtlas.addText(s,r=>_R(t.stageObject,r))),mR(t.stageObject,s))}}_removeLabelTextureFromAtlas(e){e.textureAtlasHandles.forEach(t=>t.remove()),e.textureAtlasHandles.length=0}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),Xi}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active){if(Rp(t))this._dirty=!0;else if(Ap(t.labelClassContexts)){if(t.labelClassContexts===null){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else for(const[s,r]of t.labelsToInitialize)if(this._ensureGraphics3DResources(r)&&(this._labels.set(s,r),this.deconflictor.setDirty(),e.madeProgress()),(r.visible&&r.textInitialized||!r.visible&&r.hasGraphics3DResources)&&(t.labelsToInitialize.delete(s),e.madeProgress()),e.done){this._dirty=!0;break}}this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){var a,o,l;const t=(a=e.labelClassAbortController)==null?void 0:a.signal;e.layer.when&&await e.layer.when(),Gi(t),(o=e.scaleVisibility)==null||o.updateScaleRangeActive();const s=e.graphics3DCore,r=s.layer,n=(l=r.labelingInfo)==null?void 0:l.filter(h=>!!h.symbol);!n||n.length===0||(await MT(n,async(h,d)=>{const u=h.symbol,p=_g(s.getOrCreateGraphics3DSymbol(u));if(p==null)return void Pe.getLogger(this).error("Failed to create Graphics3DSymbol for label");await p.load(),Gi(t);let _=null;PP(u)&&u.hasVisibleCallout()&&(_=lC(u,s.symbolCreationContext),await _.load(),Gi(t));const f=await OT(SP(h,e.layer.fieldsIndex,this.view.spatialReference));if(Gi(t),f.ok===!0){const g=await this._createTextRenderParameters(p.symbol);Gi(t),e.labelClassContexts[d]=new uR(h,p,_,g,f.value)}else Pe.getLogger(this).error(`Label expression failed to evaluate: ${f.error}`)}),Gi(t))}async _createLabelClassContext(e){return e.labelClassPromise==null&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(t=>{if(Jn(t))throw t;e.labelClassContexts.length=0}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return(t==null?void 0:t.type)!=="text"?null:AP.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const s of e.labelClassContexts)--s.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,ha(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,s,r,n,a){const o=new DP(s,zf(s.anchor),zP(s.anchor),e.text,b1(e.displayWidth,e.displayHeight));return Zs.graphic=t,Zs.renderingInfo=null,Zs.layer=r,n.createLabel(Zs,o,this._hudMaterialCollection,this._textTextureAtlas,()=>{const l=U0(a);return l?l.elevationOffset:null})}_createLineCalloutGraphic(e,t,s,r,n){Zs.graphic=e,Zs.layer=n;const a=r.screenOffset[0];return Zs.renderingInfo=new aC(null,t,r.translation,r.centerOffset,a,r.centerOffsetUnits,r.elevationOffset,this._calloutMaterialCollection),s.createGraphics3DGraphic(Zs)}_ensureGraphics3DResources(e){var h,d;if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const s=e.labelingContext,r=s.labelClassContexts;if(Ap(r)||!s.emptySymbolLabelSupported&&t.layers.length===0)return!1;let n=!1;const a=t.graphic,o=s.layer,l=Zc(s.layer);for(let u=0;u<r.length;u++){const p=e.textRenderers[u],_=e.textLabelPlacements[u];if(p==null||_==null)continue;const f=r[u],g=f.graphics3DSymbol,y=g.symbol&&g.symbol.type==="label-3d"?g.symbol:null,w=g.symbolLayers[0];if(!w)continue;w.setElevationInfoOverride(s.elevationInfoOverride);const x=new eR(t,y,f.labelClass),T=this._createTextSymbolGraphic(p,a,_,o,w,x);if(T==null)return!1;T._labelClass=f.labelClass,T._labelIndex=u,t.addLabelGraphic(T,s.stageLayer),t.deconflictionPriority=((h=f.textRenderParameters)==null?void 0:h.definition.size)??0,t.setVisibilityFlag(qs.LABEL,or.USER,l),t.setVisibilityFlag(qs.LABEL,or.SCALE_RANGE,!0),t.setVisibilityFlag(qs.LABEL,or.DECONFLICTION,!1),n=!0;const C=f.graphics3DCalloutSymbolLayer;if(C&&_.hasLabelVerticalOffset){C.setElevationInfoOverride(s.elevationInfoOverride);const S=this._createLineCalloutGraphic(a,y,C,_,o);S!=null&&(f.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(S,s.stageLayer))}break}return n&&((d=s.scaleVisibility)==null||d.updateGraphicLabelScaleVisibility(t)),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const s of e.graphics3DGraphic.labelLayers){if(s._labelClass==null)continue;const r=t[s._labelIndex].graphics3DSymbol.symbolLayers[0];r==null||r.onRemoveGraphic(s)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){var n;if(e.textInitialized)return;const t=e.labelingContext,s=t.labelClassContexts;if(Ap(s))return;const r=e.graphics3DGraphic.graphic;for(let a=0;a<s.length;a++){const o=s[a];if(e.textRenderers[a]=null,e.textLabelPlacements[a]=null,(o==null?void 0:o.textRenderParameters)==null)continue;const l=o.labelFunction;let h;if(l.type==="arcade")try{const x=l.needsHydrationToEvaluate()?TP(r,t.layer):r;h=l.evaluate(x)}catch{h=null}else h=l.evaluate(r);if(h==null||h===""||/^\s+$/.test(h))continue;const d=o.graphics3DSymbol,u=((n=d.symbol)==null?void 0:n.type)==="label-3d"?d.symbol:null;if(!d.symbolLayers[0])continue;const p=e.graphics3DGraphic,_=o.labelClass,f=t.disablePlacement,g=U0({graphics3DGraphic:p,labelSymbol:u,labelClass:_,disablePlacement:f});if(g==null)continue;const y=zf(g.anchor),w=qP(y);e.textRenderers[a]=new HP(h,w,o.textRenderParameters,Ff.maxSize),e.textLabelPlacements[a]=g}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const s=t.graphic.uid;if(e.graphics.set(s,t),e.active){const r=new B0(e,t);this._labels.set(s,r),e.labelsToInitialize.set(s,r)}this.setDirty(),this.deconflictor.setDirty()}_updateGraphicGeometry(e,t){const s=t.graphic.uid,r=this._labels.get(s);if(!r)return!0;for(const n of r.graphics3DGraphic.labelLayers)if(n._labelClass!=null&&!e.labelClassContexts[n._labelIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(n,t.graphic.geometry))return!1;return this.setDirty(),this.deconflictor.setDirty(),!0}_removeGraphic(e,t){const s=t.graphic.uid,r=this._labels.get(s);e.graphics.delete(s),r&&(this._destroyGraphic(r,s),e.labelsToInitialize.delete(s),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const s of t){const r=e.graphics.get(s);r&&(this._removeGraphic(e,r),this._addGraphic(e,r))}}_globalPropertyChanged(e,t){for(const s of t.labelClassContexts){const r=new Map;t.graphics.forEach(a=>r.set(a.graphic.uid,a));const n=a=>a.labelLayers[0];if(s.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,n),s.graphics3DCalloutSymbolLayer){const a=o=>o.labelLayers[s.calloutSymbolLayerIndex];s.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,a)}}}_visibilityInfoChange(e){const t=Zc(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach((t,s)=>{const r=this._labels.get(s);r&&(this._destroyGraphic(r,s),r.visible=!1,e.labelsToInitialize.set(s,r))}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,s){const r=(s==null?void 0:s.emptySymbolLabelSupported)||!1,n=(s==null?void 0:s.elevationInfoOverride)||null,a=(s==null?void 0:s.disablePlacement)||null;if(this._findLabelingContext(e))return;const o=e.layer,l=new pR(this.view._stage,o,e,t,r,n,a,Zc(o));return this._labelingContexts.push(l),this.setDirty(),{addGraphic:h=>this._addGraphic(l,h),removeGraphic:h=>this._removeGraphic(l,h),updateGraphicGeometry:h=>this._updateGraphicGeometry(l,h),layerLabelsEnabled:()=>Zc(l.layer),labelingInfoChange:h=>this._labelingInfoChange(l,h),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",l),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",l),visibilityInfoChange:()=>this._visibilityInfoChange(l),reset:()=>this._resetLabels(l),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const s=this._labelingContexts.indexOf(t);this._labelingContexts.splice(s,1),t.graphics.forEach(r=>this._removeGraphic(t,r)),t.destroy(),this.setDirty()}setLabelGraphicVisibility(e,t){const s=e.graphic.uid,r=this._labels.get(s);r&&r.visible!==t&&(t&&!r.textureAtlasHandles.length?(this._addLabelTextureToAtlas(r),r.textInitialized||r.labelingContext.labelsToInitialize.set(s,r)):!t&&r.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(r),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some(t=>Rp(t))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((t,s)=>t+(Rp(s)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){}};function mR(i,e){i.geometries[0].setAttributeData(Ae.SIZE,[e.displayWidth,e.displayHeight]),i.geometryVertexAttributeUpdated(i.geometries[0],Ae.SIZE)}function _R(i,e){i.geometries[0].setAttributeData(Ae.UV0,e),i.geometryVertexAttributeUpdated(i.geometries[0],Ae.UV0,!0)}function Rp(i){return!!i.labelClassPromise&&!!i.labelClassAbortController}function Ap(i){return!i||i.length===0}function Zc(i){var e;return i.labelsVisible===!0&&!!((e=i.labelingInfo)!=null&&e.some(t=>!!t.symbol))}c([m({constructOnly:!0})],Da.prototype,"view",void 0),c([m({constructOnly:!0})],Da.prototype,"deconflictor",void 0),c([m()],Da.prototype,"_textTextureAtlas",void 0),c([m({type:Boolean,readOnly:!0})],Da.prototype,"updating",null),Da=c([I("esri.views.3d.layers.graphics.Labeler")],Da);const Zs=new oC(null,null,null);let gR=class zo{constructor(e,t,s,r){this.lij=[0,0,0],this.extent=mi(),this.resolution=0,this.loadPriority=0,this.measures=new fR,this.used=!1,this.acquire(e,t,s,r)}get planetRadius(){return Ot(this.tilingScheme.spatialReference).radius}acquire(e,t,s,r){this.tilingScheme=r,this.id=zo.id(e,t,s),this.lij[0]=e,this.lij[1]=t,this.lij[2]=s,r.getExtent(e,t,s,this.extent),this.measures.effectiveLevelForLod=e,this.updateResolution()}updateResolution(){this.resolution=this.tilingScheme.resolutionAtLevel(this.measures.effectiveLevelForLod)}release(){this.tilingScheme=null}getChildren(e){const t=this.lij[0]+1,s=2*this.lij[1],r=2*this.lij[2];return e?e.acquire(t,s,r,this.tilingScheme):[new zo(t,s,r,this.tilingScheme),new zo(t,s+1,r,this.tilingScheme),new zo(t,s,r+1,this.tilingScheme),new zo(t,s+1,r+1,this.tilingScheme)]}copyMeasurementsFrom(e){this.measures.copyFrom(e.measures),this.updateResolution()}static id(e,t,s){return`${e}/${t}/${s}`}};var io;(function(i){i[i.INVISIBLE=0]="INVISIBLE",i[i.VISIBLE=1]="VISIBLE"})(io||(io={}));let fR=class{constructor(){this.visibility=io.VISIBLE,this.distance=0,this.shouldSplit=!1,this.effectiveLevelForLod=0}copyFrom(e){return this.visibility=e.visibility,this.distance=e.distance,this.shouldSplit=e.shouldSplit,this.effectiveLevelForLod=e.effectiveLevelForLod,this}};function yR(i,e,t,s,r,n,a=1){const o=Dm(e,r,v2);if(o==null)return!1;if(o===b2){if(i===s&&t===n)return!0;const h=t+a;for(let d=t,u=n;d<h;++d,++u)ue(s[u],i[d]);return!0}const l=t+a;for(let h=t,d=n;h<l;++h,++d)o(i[h],0,s[d],0);return!0}let vR=class{constructor(e,t){this._renderCoordsHelper=e,this._getIsGroundOpaque=t,this._isGroundOpaque=!1,this._cache=new Map,this._cameraForward=v(),this._cameraEye=v(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=v(),this._frustumBoundingSphereRadius=0,this._frustum=new a1(e),this._renderSR=e.spatialReference;const s=NT(this._renderSR);this._renderSREllipsoidRadius=Ot(s).radius}begin(e){this._aboveGround=e.aboveGround,this._isGroundOpaque=this._getIsGroundOpaque(),this._frustum.update(e),ae(this._cameraForward,e.viewForward),ue(this._cameraEye,e.eye),this._cameraFovY=e.fovY,this._updateFrustumBoundingSphere()}end(){this._cache.clear()}calculate(e){return this._getOrCalculateSingleTileVisibility(e)}_getOrCalculateSingleTileVisibility(e){const t=this._cache.get(e.id);if(t!=null)return t;const s=this._calculateSingleTileVisibility(e);return this._cache.set(e.id,s),s}_calculateSingleTileVisibility(e){return this._calculateSingleTileVisibilitySided(e)}_isTileVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===Ne.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,t=e.origin,s=MR;ae(s,e.direction);const r=e.points,n=OR;St(n,r[4],t);const a=.5*ce(n,n)/ce(s,n),o=this._frustumBoundingSphereCenter;No(o,t,s,a);const l=1+a;this._frustumBoundingSphereRadius=l}_isTileVisibleInFrustumLocal(e){const t=e.tilingScheme.spatialReference,s=e.extent,r=this._renderSR,n=CR;if(n[0]=s[0],n[1]=s[1],n[2]=0,n[3]=s[2],n[4]=s[3],n[5]=0,!w2(n,t,0,n,r,0))return!1;const a=j0;$e(a[0],n[0],n[1],0),$e(a[1],n[3],n[1],0),$e(a[2],n[3],n[4],0),$e(a[3],n[0],n[4],0);const o=W0;$e(o,.5*(n[0]+n[3]),.5*(n[1]+n[4]),.5*(n[2]+n[5]));const l=Y0,h=.5*ws(a[0],a[2]),d=this._frustum,u=this._frustumBoundingSphereRadius,p=this._frustumBoundingSphereCenter,_=AR;St(_,p,o);const f=ce(l,_),g=RR;if(No(g,o,l,f),ws(g,p)>h+u)return!1;const y=this._cameraForward,w=ce(y,Y0),x=this._cameraFovY,T=this._cameraEye;if(Math.abs(w)<Math.abs(Math.cos(.5*x))){let O=!0;const N=$e(rA,y[0],y[1],0),U=ce(T,N);for(let L=0;L<4;++L){const G=a[L];if(ce(G,N)-U>0){O=!1;break}}if(O)return!1}{const O=a[0],N=a[2];if(O[0]<=T[0]&&T[0]<=N[0]&&O[1]<=T[1]&&T[1]<=N[1])return!0}const C=xR,S=this._isGroundOpaque&&this._aboveGround,P=this._isGroundOpaque&&!this._aboveGround,M=Math.min(P?Ql:1/0,f+u),$=Math.max(S?-Ql:-1/0,f-u);for(let O=0;O<4;++O)No(C[O],a[O],l,M),No(C[O+4],a[O],l,$);if(k0(d.planes,C,8))return!1;if(Dp(d.planes,C,8))return!0;for(let O=0;O<4;++O){const N=C[O],U=C[O+4];if(Lp(d.planes,N,U))return!0;const L=C[(O+1)%4];if(Lp(d.planes,N,L))return!0;const G=C[4+(O+1)%4];if(Lp(d.planes,U,G))return!0}if(Er[0][3]=+a[0][0],Er[1][3]=-a[2][0],Er[2][3]=+a[0][1],Er[3][3]=-a[2][1],Er[4][3]=+$,Er[5][3]=-M,Dp(Er,d.points)||Dp(Er,d.points))return!0;for(let O=0;O<4;++O){const N=T,U=d.points[O+4];if(Z0(Er,N,U))return!0;const L=d.points[4+(O+1)%4];if(Z0(Er,U,L))return!0}return!1}_isTileVisibleInFrustumGlobal(e){if(e.lij[0]<Hb)return!0;const t=e.tilingScheme.spatialReference,s=e.extent,r=this._isGroundOpaque&&this._aboveGround,n=this._isGroundOpaque&&!this._aboveGround,a=j0,o=.5*(s[0]+s[2]);if($e(a[0],s[0],s[1],0),$e(a[1],s[2],s[1],0),$e(a[2],s[2],s[3],0),$e(a[3],s[0],s[3],0),$e(a[4],o,s[1],0),$e(a[5],o,s[3],0),!yR(a,t,0,a,this._renderSR,0,6))return!1;const l=a[0][2]>0,h=a[3][2]<0,d=l||h,u=this._renderSREllipsoidRadius;if(d){const te=Pt(0,0,1),he=TR;Un(he,te,a[0]);const oe=SR;if(Un(oe,te,a[1]),l){const K=Q0,we=a[4],Oe=X0;Un(Oe,we,te),Un(K,Oe,we);const se=a[0];gt(se,he,K),Wl(se,u);const _e=a[1];gt(_e,oe,K),Wl(_e,u)}else if(h){const K=Q0,we=a[5],Oe=X0;Un(Oe,we,te),Un(K,we,Oe);const se=a[3];gt(se,K,he),Wl(se,u);const _e=a[2];gt(_e,K,oe),Wl(_e,u)}}const p=W0;{const te=St(LR,a[3],a[0]);ae(te,te);const he=ye(NR,a[0],a[3]);ie(he,he,.5);const oe=-ce(he,te),K=ye(VR,a[0],a[1]);ie(K,K,.5);const we=ye(FR,a[2],a[3]);ie(we,we,.5);const Oe=St(UR,we,K);ae(Oe,Oe);const se=-(oe+ce(te,K))/ce(te,Oe);No(p,K,Oe,se),Wl(p,u)}const _=this._frustumBoundingSphereRadius,f=this._frustumBoundingSphereCenter,g=this._frustum,y=g.planes,w=PR;ae(w,p);const x=ce(a[0],w)/qi(a[0]),T=g.origin,C=g.points;let S=!1;if(r){{S=!0;const he=ae(v(),T);for(let oe=0;oe<4;++oe){const K=C[4+oe],we=St(v(),K,T);ae(we,we);const Oe=gt(v(),he,we);ae(Oe,Oe);const se=gt(v(),we,Oe);if(ae(se,se),ce(T,se)>u){S=!1;break}}}if(S&&ce(T,w)<u*x-Ql)return!1;const te=ae(tA,g.origin);if(ce(te,w)<0)return!1;{const he=ae(iA,g.direction);if(ce(he,w)>sA)return!1}}const P=Math.sqrt(1-x*x);if(P>.9)return!0;let M=!1;{const te=ce(w,f),he=qi(f);if(he<=_&&!y.some(we=>eo(we,$p)>0)){if(!r)return!0;M=!0}const oe=te/he;if(!M&&te<=0&&-te>_)return!1;const K=_/he;if(Math.sqrt(1-oe*oe)*Math.sqrt(1-K*K)-K*oe>P)return!1}if(!S&&(a.some(te=>g.intersectsPoint(te))||g.intersectsPoint(p)))return!0;const $=DR;St($,f,$p);const O=ce($,w),N=ER;ie(N,w,O);const U=ws(N,f),L=t.isWGS84,G=e.lij,A=L&&G[2]===2**G[0]-1,R=L&&G[2]===0,ee=R?XR:A?WR:kR,z=R?YR:A?QR:jR;if(!M){const te=a,he=ZR,oe=zR,K=qR,we=$p;for(const Oe of ee){const se=te[Oe];if(G0(oe,te[(Oe+1)%4],se),G0(K,we,se),Un(he,K,oe),wR(he,C,1))return!1}}let V=null;if(!r&&O<1.01*_){const te=2.5*_;if(U>x*te+_)return!1;const he=IR,oe=te/x;for(let K=0;K<4;++K)ie(he[K],a[K],oe/u);$e(he[4],0,0,0),V=he}else{const te=(n?u+Ql:O+_)/x,he=r?u-Ql:(O-_)/x,oe=$R;for(let K=0;K<4;++K){const we=a[K];ie(oe[K],we,he/u),ie(oe[K+4],we,te/u)}V=oe}if(k0(y,V,V.length))return!1;const Y=g.lines,le=HR,me=BR;for(const te of Y){ae(me,te.direction);for(const he of z){const oe=V[he];if(ae(le,oe),Ip(me,le,V,C))return!1;const K=(he+1)%4;if(r){const we=V[K];if(St(le,we,oe),ae(le,le),Ip(me,le,V,C))return!1}if(n){const we=V[4+he],Oe=V[4+K];if(St(le,Oe,we),ae(le,le),Ip(me,le,V,C))return!1}}}return!0}_calculateSingleTileVisibilitySided(e){return this._isTileVisibleInFrustum(e)?io.VISIBLE:io.INVISIBLE}};function Un(i,e,t){return gt(i,e,t),ae(i,i),i}function G0(i,e,t){return St(i,e,t),ae(i,i),i}function Wl(i,e){return ie(i,i,e/qi(i)),i}const qb=[Vo.LEFT,Vo.RIGHT,Vo.BOTTOM,Vo.TOP,Vo.FAR];function bR(i,e,t){for(let s=0;s<t;++s)if(eo(i,e[s])<=0)return!1;return!0}function k0(i,e,t){for(const s of qb)if(bR(i[s],e,t))return!0;return!1}function Dp(i,e,t=e.length){for(let s=0;s<t;++s){const r=e[s];let n=!0;for(const a of i)if(eo(a,r)>0){n=!1;break}if(n)return!0}return!1}const Hb=2;function wR(i,e,t){for(const s of e)if(ce(s,i)<t)return!1;return!0}const xR=[v(),v(),v(),v(),v(),v(),v(),v()],CR=[0,0,0,0,0,0],j0=[v(),v(),v(),v(),v(),v()],W0=v(),Q0=v(),TR=v(),SR=v(),X0=v(),PR=v(),ER=v(),MR=v(),OR=v(),RR=v(),AR=v(),$p=T_(0,0,0),DR=v(),$R=[v(),v(),v(),v(),v(),v(),v(),v()],IR=[v(),v(),v(),v(),v()],LR=v(),NR=v(),VR=v(),FR=v(),UR=v(),zR=v(),qR=v(),HR=v(),BR=v(),GR=v(),kR=[0,1,2,3],jR=[0,1,2,3],WR=[0,1,3],QR=[0,1,3],XR=[1,2,3],YR=[1,2,3],ZR=v();function KR(i,e,t){let s=1/0,r=-1/0;for(const n of t){const a=ce(e,n);s=Math.min(s,a),r=Math.max(r,a)}i[0]=s,i[1]=r}function JR(i,e,t,s){let r=1/0,n=-1/0;for(const a of s){const o=ce(t,a);if(r=Math.min(r,o),n=Math.max(n,o),r<=e&&n>=i)return!1}return!0}const eA=[0,0];function Ip(i,e,t,s){if(t.length===0||s.length===0)return!0;const r=GR;Un(r,i,e);const n=s[0]<t[0],a=n?t:s,o=eA;return KR(o,r,n?s:t),JR(o[0],o[1],r,a)}const Ql=430,tA=v(),iA=v(),sA=Math.cos(.25*Math.PI),Y0=Pt(0,0,1),rA=v();function Lp(i,e,t){const s={t0:0,t1:1};for(const r of qb)if(!Bb(i[r],e,t,s))return!1;return s.t0<s.t1}function Z0(i,e,t){const s={t0:0,t1:1};for(const r of i)if(!Bb(r,e,t,s))return!1;return s.t0<s.t1}function Bb(i,e,t,s){let{t0:r,t1:n}=s;const a=eo(i,e),o=eo(i,t);if(a>=0&&o>=0)return!1;if(a<0&&o>=0){const l=-a/(o-a);if(l<r)return!1;l<n&&(n=l)}else if(a>=0&&o<0){const l=a/(a-o);if(l>n)return!1;l>r&&(r=l)}return s.t0=r,s.t1=n,!0}const Er=[yo(-1,0,0,1),yo(1,0,0,-1),yo(0,-1,0,1),yo(0,1,0,-1),yo(0,0,-1,1),yo(0,0,1,-1)];let nA=class{constructor(e){this._camera=new xt,this._focusOnMap=[0,0],this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new vR(e.renderCoordsHelper,e.getIsGroundOpaque)}begin(e,t){this._camera.copyFrom(e),this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,this._visibility.begin(this._camera)}end(){this._visibility.end()}updateTile(e){const{measures:t}=e;t.visibility=this._visibility.calculate(e),t.distance=pC(e.extent,this._focusOnMap),t.visibility!==io.INVISIBLE&&this._updateSplitDecisionAndLod(e)}_calculateTileShouldSplitGlobal(e){const t=this._camera,{eye:s}=t,r=qi(s),n=this._renderCoordsHelper,a=n.referenceEllipsoid.radius;if(r>2*a)return e.measures.effectiveLevelForLod=0,!1;const o=e.lij[0];if(o<=Hb)return e.measures.effectiveLevelForLod=o,!0;const l=K0,{extent:h}=e;$e(l[0],h[0],h[1],0),$e(l[1],h[2],h[1],0),$e(l[2],h[2],h[3],0),$e(l[3],h[0],h[3],0);const d=$e(J0,.5*(h[0]+h[2]),.5*(h[1]+h[3]),0),u=this._tilingScheme.spatialReference;for(let y=0;y<4;++y)n.toRenderCoords(l[y],u,l[y]);n.toRenderCoords(d,u,d);const p=ae(ey,d),_=ce(s,p),f=ie(ty,p,_),g=qi(s)-a;return ue(Co.origin,aA),ue(Co.direction,p),this._calculateTileShouldSplitCommon(e,l,d,Co,g,f)}_calculateTileShouldSplitLocal(e){const t=K0,{extent:s}=e;$e(t[0],s[0],s[1],0),$e(t[1],s[2],s[1],0),$e(t[2],s[2],s[3],0),$e(t[3],s[0],s[3],0);const r=this._tilingScheme.spatialReference;for(let f=0;f<4;++f)this._renderCoordsHelper.toRenderCoords(t[f],r,t[f]);const n=$e(J0,.5*(t[0][0]+t[2][0]),.5*(t[0][1]+t[2][1]),.25*(t[0][2]+t[1][2]+t[2][2]+t[3][2])),a=$e(ey,n[0],n[1],0),{eye:o,far:l}=this._camera,h=$e(ty,a[0],a[1],o[2]),d=o[2];$e(Co.origin,a[0],a[1],o[2]-2*l),ue(Co.direction,qo);const u=o[2]-2*l,p=[qo,qo,qo,qo],_=[u,u,u,u];return this._calculateTileShouldSplitCommon(e,t,n,Co,d,h,p,_)}_calculateTileShouldSplitCommon(e,t,s,r,n,a,o,l){const h=Math.max(ws(t[0],t[2]),ws(t[1],t[3]),ws(t[0],s)+ws(s,t[2])),d=this._camera,{eye:u,near:p,far:_,fovY:f,viewForward:g}=d,y=W(ce(r.direction,g),.1,1),w=ce(u,g),x=ce(s,g)-w,T=2*Math.tan(.5*f),C=se=>se<=p?1:1/(se*T),S=Math.abs(n)/h,P=C(x),M=e.lij[0],$=ws(u,s);let O=0,N=1/0;for(const se of t){const _e=ws(u,se);N=Math.min(N,_e),O=Math.max(O,_e)}const U=se=>Math.max(0,M-1,M+Math.ceil(Math.log2(se))-1),L=50*W(y,.1,1),G=50*W(y,.1,1),A=2,R=.7,ee=ws(a,u)>R*h,z=x<p,V=se=>L*h/(se*se),Y=U(ee?V($):z?G*h/Math.abs(n):A*P*h),le=N-p>.33*(_-p)?-1:1;if(e.measures.effectiveLevelForLod=Y+le,M>=Y+1)return!1;const{frustum:me}=d,te=S<oA;if(ce(a,g)-w<0&&Math.abs(y)<.5||ws(a,u)<p)return te;const he=qf(me,r);{const se=U(V(N)),_e=U(V(O));if(Math.abs(se-_e)>2||Math.abs(Y-_e)>2||Math.abs(Y-se)>2)return!0}if(!this.isGlobalMode&&ee&&o&&l){let se=0;for(let _e=0;_e<4;++_e){const Qe=o[_e],Xe=l[_e],Ye=v();No(Ye,t[_e],Qe,Xe);const Ze=F1(Ye,Qe);qf(me,Ze)&&++se}if(se>=3||se>=2&&he)return!1;if(se<=2&&!he&&M<Y+1)return!0}const oe=Hf(me,s);let K=0;for(let se=0;se<4;++se){const _e=t[se];K+=Hf(me,_e)?1:0}if(oe&&K>=2)return!1;if(!oe&&!he&&K<=2)return te;let we=x,Oe=x;for(let se=0;se<4;++se){const _e=t[se],Qe=ce(_e,g)-w;Oe=Math.min(Oe,Qe),we=Math.max(we,Qe)}return Oe<=p?te:C(Oe)*h<.3?!1:C(we)*h>.9||P*h>lA&&K<=2&&!oe&&!he}_updateSplitDecisionAndLod(e){e.measures.shouldSplit=this.isGlobalMode?this._calculateTileShouldSplitGlobal(e):this._calculateTileShouldSplitLocal(e),e.updateResolution()}get isGlobalMode(){return this._renderCoordsHelper.viewingMode===Ne.Global}};const K0=[v(),v(),v(),v()],J0=v(),ey=v(),ty=v(),qo=T_(0,0,1),aA=js,Co=F1(js,qo),oA=1,lA=.9;let di=class extends De{constructor(e){super(e),this.tiles=new wn,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=!1,this._pendingTiles=null,this._newTiles=new Lt,this.tileBudget=70}initialize(){var s;const e=()=>this._setDirty(),t=()=>this._reset();this.addHandles([E(()=>this.tilingScheme,t,Ge),E(()=>this.tileSize,t,Ge),E(()=>{var r;return(r=this.cameraOnSurface)==null?void 0:r.location},e,Ge),E(()=>{var r;return(r=this.viewState)==null?void 0:r.contentCamera},e,Ge),E(()=>{var r;return(r=this.focus)==null?void 0:r.location},e,Ge),E(()=>{var r;return((r=this.terrain)==null?void 0:r.baseOpacity)??1},e)]),this._frameWorker=(s=this.scheduler)==null?void 0:s.registerTask(ni.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=Hr(this._frameWorker)}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(e!=null&&!e.spatialReference.equals(this.viewState.spatialReference))return void Pe.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||t!=null&&e&&t.equals(e))return;const s=e!=null?e.clone():null;this._set("filterExtent",s),this._setDirty()}get _filterExtentRect(){if(this.filterExtent==null)return null;const e=mi();return Yv(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}addClient(){const e=Dx();return this._clients.add(e),this._clients.size===1&&this._setDirty(),Wn(()=>this._removeClient(e))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(pn))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),this._frameWorker!=null&&(this._frameWorker.priority=ni.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),this._pendingTiles||this._frameWorker==null||(this._frameWorker.priority=ni.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new nA({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,getIsGroundOpaque:()=>{var t;return(((t=this.terrain)==null?void 0:t.baseOpacity)??1)===1}}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){const e=this.tilingScheme;return this._rootTileIds.map(t=>new gR(t[0],t[1],t[2],e))}_subdivideTilesForView(e){if(!this._pendingTiles)return;const{tilingScheme:t}=this;for(;this._pendingTiles.length>0&&!e.done;){const s=this._pendingTiles.shift();if(e.madeProgress(),this._filterExtentRect&&!Du(this._filterExtentRect,s.extent))continue;this._tileMeasurements.updateTile(s);const{measures:r}=s;if(r.visibility===io.INVISIBLE)continue;const n=this._newTiles.length+this._pendingTiles.length+1;r.shouldSplit&&n<this.tileBudget?(t.ensureMaxLod(s.lij[0]+1),this._pendingTiles.push(...s.getChildren())):this._newTiles.push(s)}this._pendingTiles.length===0&&(this._updateTiles(this._newTiles.toArray()),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}_updateTiles(e){for(const r of this.tiles.items)r.used=!1;const t=e.filter(r=>{const n=this._idToTile.get(r.id);return n?(n.copyMeasurementsFrom(r),n.used=!0):this._idToTile.set(r.id,r),!n}),s=this.tiles.items.filter(r=>!r.used&&(this._idToTile.delete(r.id),!0));this.tiles.removeMany(s),this.tiles.addMany(t),this._sortTiles(),this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,t)=>e.measures.distance-t.measures.distance),this.tiles.forEach((e,t)=>e.loadPriority=t)}};c([m({constructOnly:!0})],di.prototype,"scheduler",void 0),c([m({constructOnly:!0})],di.prototype,"renderCoordsHelper",void 0),c([m({constructOnly:!0})],di.prototype,"tilingSchemeOwner",void 0),c([m({constructOnly:!0})],di.prototype,"cameraOnSurface",void 0),c([m({constructOnly:!0})],di.prototype,"focus",void 0),c([m({constructOnly:!0})],di.prototype,"viewState",void 0),c([m({constructOnly:!0})],di.prototype,"terrain",void 0),c([m()],di.prototype,"tiles",void 0),c([m()],di.prototype,"tileSize",void 0),c([m({readOnly:!0})],di.prototype,"tilingScheme",null),c([m()],di.prototype,"filterExtent",null),c([m({readOnly:!0})],di.prototype,"_filterExtentRect",null),c([m({readOnly:!0})],di.prototype,"_rootTileIds",null),c([m({value:!1})],di.prototype,"suspended",null),c([m({readOnly:!0})],di.prototype,"updating",null),di=c([I("esri.views.3d.layers.support.FeatureTileTree3D")],di);let Tt=class extends De{constructor(e){super(e),this._propertiesPool=new aa({camera:xt},this),this._lastSeenCameraProjectionValues=new xt,this.mode=_t.ANIMATING,this._cssCamera=new xt,this._camera=new xt,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new tn({state:this}),this.events=new Cr,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new aa({camera:xt},this)}destroy(){var e;this.cameraController=null,(e=this._propertiesPool)==null||e.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===Ne.Global){const e=Ot(this.spatialReference).radius;this.camera=new xt({eye:Pt(4*e,0,0),center:Pt(e,0,0),up:Pt(0,0,1)})}else this.camera=new xt({eye:Pt(0,0,100),center:Pt(0,0,0),up:Pt(0,1,0)})}get animation(){return this.cameraController instanceof tc&&this.cameraController.viewAnimation!=null?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:s,pixelRatio:r}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/r),e.width=Math.round(s/r),e}get camera(){return this._camera}set camera(e){e!==Ms&&Ms.copyFrom(e),Ms.computeUp(this.viewingMode),this.events.emit("before-camera-change",Ms);const t=this._camera;if(cA(this._lastSeenCameraProjectionValues,Ms)&&(this._lastSeenCameraProjectionValues.copyFrom(Ms),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(Ms)&&(this._camera=this._propertiesPool.get("camera").copyFrom(Ms),this._cameraChanged=!t.almostEquals(Ms),this._cameraChanged)){const s=$x(()=>{this._cameraChanged=!1,s.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===_t.IDLE}get updating(){return this.mode!==_t.IDLE}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){this._contentCamera=e!=null?e.clone():null}get fixedContentCamera(){return this._contentCamera!=null}get isGlobal(){return this.viewingMode===Ne.Global}get isLocal(){return this.viewingMode===Ne.Local}get viewingMode(){return Tm(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get navigating(){var e;return!!((e=this.cameraController)!=null&&e.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){var t;this.stopActiveCameraController()?((t=this.cameraController)==null||t.destroy(),e&&(this.removeHandles(iy),this.addHandles(ml(()=>e.state===ct.Finished||e.state===ct.Stopped,()=>{this._set("cameraController",null),this.updateCamera(s=>e.onControllerEnd(s))},{sync:!0,once:!0}),iy),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=ct.Rejected)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this._updateQueue.length===0||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Ms.copyFrom(this._get("camera")),e(Ms),this.camera=Ms,this._processingUpdates=!1,this._processUpdateQueue()}};c([m({constructOnly:!0})],Tt.prototype,"view",void 0),c([m()],Tt.prototype,"mode",void 0),c([m({readOnly:!0,type:fl})],Tt.prototype,"animation",null),c([m({type:xt})],Tt.prototype,"cssCamera",null),c([m()],Tt.prototype,"_cssCamera",void 0),c([m({type:xt})],Tt.prototype,"camera",null),c([m()],Tt.prototype,"_camera",void 0),c([m({readOnly:!0})],Tt.prototype,"pixelRatio",null),c([m()],Tt.prototype,"rasterPixelRatio",void 0),c([m()],Tt.prototype,"contentPixelRatio",void 0),c([m({readOnly:!0})],Tt.prototype,"alignPixelEnabled",null),c([m({readOnly:!0})],Tt.prototype,"updating",null),c([m({})],Tt.prototype,"_contentCamera",void 0),c([m({type:xt})],Tt.prototype,"contentCamera",null),c([m({readOnly:!0})],Tt.prototype,"fixedContentCamera",null),c([m({readOnly:!0})],Tt.prototype,"events",void 0),c([m({readOnly:!0})],Tt.prototype,"isGlobal",null),c([m({readOnly:!0})],Tt.prototype,"isLocal",null),c([m({readOnly:!0})],Tt.prototype,"viewingMode",null),c([m()],Tt.prototype,"navigating",null),c([m()],Tt.prototype,"stationary",null),c([m()],Tt.prototype,"_cameraChanged",void 0),c([m()],Tt.prototype,"cameraController",null),Tt=c([I("esri.views.3d.state.ViewState")],Tt);const hA=Tt;function cA(i,e){return i.fov!==e.fov||i.fullViewport[0]!==e.fullViewport[0]||i.fullViewport[1]!==e.fullViewport[1]||i.fullViewport[2]!==e.fullViewport[2]||i.fullViewport[3]!==e.fullViewport[3]||i.padding[ms.TOP]!==e.padding[ms.TOP]||i.padding[ms.RIGHT]!==e.padding[ms.RIGHT]||i.padding[ms.BOTTOM]!==e.padding[ms.BOTTOM]||i.padding[ms.LEFT]!==e.padding[ms.LEFT]}const Ms=new xt,iy="ViewStateHandles";let dA=class{constructor(e,t,s){this.viewingMode=e,this._forEachLayer=t,this._view=s,this._externalIntersectionHandlers=new Lt,this._tolerance=hu,this._tmpRay=ao(),this._tmpRegion=mi(),this._validateHUDIntersector=Cn(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,s){return this.intersectRay(this._getPickRay(e,this._tmpRay),sy(this.viewingMode),t,s)}intersectScreenFreePointFallback(e,t,s){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,s)}intersectRayFreePointFallback(e,t,s){return this.intersectRay(e,sy(this.viewingMode),t,s)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,s,r){return t.options.selectionMode=!1,t.options.store=ja.MIN,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(s)}getCenterRayWithSubpixelOffset(e,t,s=.5,r=.5){return e.getRenderCenter(Jc,s,r),Jc[0]+=.0466,Jc[1]-=.0123,B1(e,Jc,t)}intersectIntersectorScreen(e,t,s){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,s)}intersectToolIntersectorScreen(e,t,s){const r=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(r,t,s)}intersectToolIntersectorRay(e,t,s){t.options.selectionMode=!0,this.computeIntersection(e,t,s);const r=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||E2(r)&&r.intersector!==Jr.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,s))}setTolerance(e=hu){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((t,s)=>t.type===Jr.TERRAIN?1:s.type===Jr.TERRAIN?-1:0)}removeIntersectionHandler(e){this._externalIntersectionHandlers.removeUnordered(e)!=null&&this._externalIntersectionHandlers.sort((t,s)=>t.type===Jr.TERRAIN?1:s.type===Jr.TERRAIN?-1:0)}_getPickRay(e,t){const s=this._view.state.camera;return H1(s,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==Ne.Local||e==null||ye(t,e.origin,ae(bt.get(),e.direction)),!1}intersectElevationFromScreen(e,t,s=0,r=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,s,r)}_intersectElevation(e,t,s=0,r=null){if(e==null)return null;const n=this._view,{renderCoordsHelper:a}=n,o=zx(n.spatialReference),l=t!=null?t.mode:"absolute-height",h=C2(t)/o,d=(l!=="on-the-ground"?h+s:0)*o/a.unitInMeters,{camera:u}=n.state;if(l==="absolute-height"){const C=a==null?void 0:a.getAltitude(u.eye),S=ce(ae(Xl,e.direction),a.worldUpAtPosition(u.eye,mA));if(C<d&&S<0||C>=d&&S>0)return null;if(a.intersectInfiniteManifold(e,d,Xl)){const P=Bf(n,Xl);return P.z??(P.z=0),P.z-=h,P}return null}const p=nf(bt.get());u.projectToRenderScreen(e.origin,p);const _=new ry(null,this._forEachLayer),{slicePlane:f}=n,g=f!=null?Gf(f):null,y=Cn(this.viewingMode);y.options.store=ja.MIN,y.options.verticalOffset=d,y.options.normalRequired=!1;const w=e.origin,x=ye(bt.get(),w,e.direction);y.reset(w,x,u),y.point=p;const T=r?"type"in r&&r.type==="graphics"?C=>C.layerUid!==r.uid:C=>C.graphicUid!==r.uid:null;switch(l){case"relative-to-scene":{const C=S=>(!T||T(S))&&!!S.lastValidElevationBB;y.intersect(_.layers,p,this._tolerance,null,C),this._externalIntersectionHandlers.forAll(S=>{if(S.type===Jr.I3S||S.type===Jr.TERRAIN||S.type===Jr.TILES3D){const P=S.slicePlaneEnabled?g:null;S.intersect(y,P,y.rayBegin,y.rayEnd,p)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(C=>{if(C.isGround){const S=C.slicePlaneEnabled?g:null;C.intersect(y,S,y.rayBegin,y.rayEnd,p)}})}if(y.results.min.getIntersectionPoint(Xl)){const C=Bf(n,Xl);return C.z=s,C}return null}computeIntersection(e,t,s,r){var g;if(e==null)return;const n=this._view.state.camera,a=nf(bt.get());n.projectToRenderScreen(e.origin,a);const o=new ry(s,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!s||!("include"in s||"exclude"in s);const l=e.origin,h=ye(bt.get(),e.origin,e.direction);t.reset(l,h,n),t.intersect(o.layers,a,this._tolerance);const d=this._view.slicePlane,u=d!=null?Gf(d):null;t.intersect(o.sliceableLayers,a,this._tolerance,u);const p=s&&(s.requiresGroundFeedback||s.enableDraped);this._externalIntersectionHandlers.forAll(y=>{const w=y.layerUid,x=Array.isArray(w),T=x?w:[w];x&&(t.options.filteredLayerUids=[]);let C=!1;for(const S of T)o.filterLayerUid(S)?C=!0:x&&t.options.filteredLayerUids.push(S);if(t.options.isFiltered=!C,y.isGround&&p||!t.options.isFiltered){const S=y.slicePlaneEnabled?u:null;y.intersect(t,S,l,h,a,r)}});const _=bt.get(),f=this._view.basemapTerrain;if(s&&s.enableDraped&&f.spatialReference!=null&&t.results.ground.getIntersectionPoint(_)){const y=f.overlayManager.renderer,w=this._view.renderCoordsHelper.spatialReference,x=bt.get();this._view.renderCoordsHelper.fromRenderCoords(_,x,f.spatialReference),x[2]=((g=this._view.elevationProvider)==null?void 0:g.getElevation(_[0],_[1],_[2],w,"ground"))??0,y.intersect(t,x,t.results.ground,T=>o.filterRenderGeometry(T))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;ym(this._tmpRegion,mC);const s=this._view.state.camera,r=[],n=this._tmpRegion,a=w=>{const x=new pA(w),T=x.result.target.object.geometries.every(C=>C.material instanceof X_&&C.material.parameters.occlusionTest);r.push({item:x,occlusionTest:T}),T&&(s.projectToRenderScreen(w.target.center,x.screenPoint),x.screenPoint[0]=Math.floor(x.screenPoint[0]),x.screenPoint[1]=Math.floor(x.screenPoint[1]),_C(n,x.screenPoint))};e.sortResults(t.all),t.min.dist!=null&&a(t.min);for(const w of t.all)t.min.target.object!==w.target.object&&t.max.target.object!==w.target.object&&a(w);if(t.max.dist!=null&&t.max.target.object!==t.min.target.object&&a(t.max),!r.length)return;n[0]===n[2]&&(n[2]+=1),n[1]===n[3]&&(n[3]+=1);const o=s.fullWidth,l=s.fullHeight,h=Math.max(0,n[0]-ch),d=Math.max(0,n[1]-ch),u=Math.min(Ia(n)+2*ch,o-h),p=Math.min(Zd(n)+2*ch,l-d),_=u>0&&p>0?new Uint8Array(u*p*4):null;_&&this._view._stage.renderer.readHUDVisibility(h,d,u,p,_);let f=!0;const g=e.results.max.dist==null;let y=0;for(const{item:w,occlusionTest:x}of r){let T=!x;if(x&&_)for(const C of uA){const S=4*(Math.min(w.screenPoint[0]+C[0],o)-n[0]+(Math.min(w.screenPoint[1]+C[1],l)-n[1])*u);if(S>=0&&S<_.length&&_[S]){T=!0;break}}T&&(f&&(e.results.min.copy(w.result),f=!1),g&&e.results.max.copy(w.result),e.options.store===ja.ALL&&e.results.all.splice(y++,0,w.result))}}};const ch=1,uA=(()=>{const i=[],e=ch;for(let t=-e;t<=e;t++)for(let s=-e;s<=e;s++)i.push([s+e,t+e]);return i})();let pA=class{constructor(e){this.result=e,this.screenPoint=Au()}},Kc;function sy(i){return Kc&&Kc.viewingMode===i||(Kc=Cn(i)),Kc}let ry=class{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e==null?void 0:e.include,this.exclude=e==null?void 0:e.exclude,t(s=>{s.pickable&&this.filterLayerUid(s.apiLayerUid)&&(s.sliceable?this.sliceableLayers:this.layers).push(s)})}filterLayerUid(e){const{include:t,exclude:s}=this;return e==null?t==null&&s==null:(t==null||t.has(e))&&(s==null||!s.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}};function ny(i){return typeof i=="object"&&"intersect"in i}const Xl=v(),mA=v(),Jc=Au();let dh=class extends Cr.EventedMixin(De){get spatialReference(){var e,t;return(t=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:t.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=de(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,s,r,n){if(this._cacheEnabled&&this.lastElevationQuery!=null){const o=this.lastElevationQuery;if(e===o.x&&t===o.y&&s===o.z&&Yd(r,o.spatialReference)&&n===o.queryContext)return o.result}let a=null;return a=ed(a,this._im,e,t,s,r,n),a==null&&(a=ed(a,this._ground,e,t,s,r,n)),n==="scene"&&(a=ed(a,this._scene,e,t,s,r,n)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:s,spatialReference:r,queryContext:n,result:a}),a}getSphereElevationBounds(e,t,s){const r=new gu;function n(a){for(const o of a)if(o.getSphereElevationBounds){const l=o.getSphereElevationBounds(e,t,s);l!=null&&r.expandElevationRangeValues(l.elevationRangeMin,l.elevationRangeMax)}}return n(this._ground),n(this._im),s==="scene"&&n(this._scene),r}getRootElevationBounds(){const e=new gu;for(const t of[this._im,this._ground,this._scene])t.forEach(s=>{if(s.getRootElevationBounds){const r=s.getRootElevationBounds();r!=null&&e.expandElevationRangeValues(r.elevationRangeMin,r.elevationRangeMax)}});return e}async queryElevation(e,t,s,r,n,a=null,o=0){const l=this._getElevationQuery(r);try{const h=await l.queryElevation(e,t,a,o);return n==="scene"?ed(h,this._scene,e,t,s,r,n):h}catch(h){return Ix(h),this.getElevation(e,t,s,r,n)}}register(e,t){this.addHandles(t.on("elevation-change",s=>this.emit("elevation-change",s)),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const s=t.indexOf(e);s>-1&&t.splice(s,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(t!=null&&Yd(e,t.spatialReference))return t;t==null||t.destroy({completeTasks:!0});const{wkid:s,wkt:r,wkt2:n,latestWkid:a}=e,o=new hC(this.view.resourceController.scheduler,new pi({wkid:s,wkt:r,wkt2:n,latestWkid:a}),()=>{var l;return(l=this.view.map)==null?void 0:l.ground},{maximumAutoTileRequests:4});return this._cachedQuery=o,o}};function ed(i,e,t,s,r,n,a){for(const o of e){const l=o.getElevation(t,s,r,n,a);l!=null&&(i=i!=null?Math.max(l,i):l)}return i}c([m({constructOnly:!0})],dh.prototype,"view",void 0),c([m()],dh.prototype,"spatialReference",null),dh=c([I("esri.views.3d.support.CombinedElevationProvider")],dh);let ac=class Ym{static isValidProfile(e){return e in Ym.profiles}static getDefaultProfile(){return Li("esri-iPhone")?"low":"medium"}static apply(e,t){const s=Ym.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=s.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=s.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=s.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=s.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=s.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=s.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=s.graphics3D.skipHighSymbolLods,t.graphics3D.uncompressedTextureDownsamplingEnabled=s.graphics3D.uncompressedTextureDownsamplingEnabled;const r=t.sceneService.object,n=s.sceneService.object;r.lodFactor=n.lodFactor,t.sceneService.point.lodFactor=s.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=s.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=s.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=s.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=s.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=s.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=s.tiledSurface.vtlContentZoom,t.tiledSurface.elevationLevelDelta=s.tiledSurface.elevationLevelDelta,t.tiledSurface.reduceTileLevelDifferences=s.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=s.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=s.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=s.fadeDuration,t.antialiasingEnabled=s.antialiasingEnabled,t.physicallyBasedRenderingEnabled=s.physicalBasedRenderingEnabled,t.highQualityTransparency=s.highQualityTransparency,t.highResolutionAtmosphere=s.highResolutionAtmosphere,t.reflections=s.reflections,t.ambientOcclusion=s.ambientOcclusion,t.memoryLimit=s.memoryLimit,t.additionalCacheMemory=s.additionalCacheMemory,t.frameRate=s.frameRate,t.maximumPixelRatio=s.maximumPixelRatio}};ac.test={reset(){const i=Gb();for(const e of Object.keys(i))ac.profiles[e]=i[e]}};const Yl={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430};function Gb(){const i=!!Li("esri-mobile"),e=!!Li("ios"),t=nt(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0,uncompressedTextureDownsamplingEnabled:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:nt(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:200+Yl.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:i?.8:1,polylineLodFactor:i?1.2:1.5,snapshotAvailable:!e,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:i},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:i},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!Li("disable-feature:reduce-map-tile-levels")},fadeDuration:t,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:i?600+Yl.GalaxyS20:750+Yl.FullHD,additionalCacheMemory:i?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:i?1.2:2,polylineLodFactor:i?1.2:2,snapshotAvailable:!e,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!Li("disable-feature:reduce-map-tile-levels")},fadeDuration:t,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,memoryLimit:i?900+Yl.SurfacePro7:1500+Yl.FullHDRetina,additionalCacheMemory:i?-150:0,frameRate:0,maximumPixelRatio:i?1:1/0}}}(function(i){i.profiles=Gb()})(ac||(ac={}));const Rd=ac;var Zm;let Ho=Zm=class extends UC{constructor(i){super(i),this.shadowColor=nb.clone(),this.shadowOpacity=ab,this.shadowDifference=ob}equals(i){return this===i||super.equals(i)&&this.shadowColor.equals(i.shadowColor)&&this.shadowOpacity===i.shadowOpacity&&this.shadowDifference===i.shadowDifference}clone(){var i;return new Zm({...this,color:this.color.clone(),haloColor:(i=this.haloColor)==null?void 0:i.clone(),shadowColor:this.shadowColor.clone()})}};c([m({type:eg})],Ho.prototype,"shadowColor",void 0),c([m()],Ho.prototype,"shadowOpacity",void 0),c([m()],Ho.prototype,"shadowDifference",void 0),Ho=Zm=c([I("esri.views.3d.support.HighlightOptions")],Ho);const pl=Ho;var Km;let fn=Km=class extends De{constructor(i){super(i)}clone(){return new Km({name:this.name,options:this.options.clone()})}};c([m({type:String,constructOnly:!0})],fn.prototype,"name",void 0),c([m({type:pl})],fn.prototype,"options",void 0),fn=Km=c([I("esri.views.3d.support.HighlightGroup")],fn);const ay=wn.ofType(fn);function _A(){return Li("enable-feature:multiple-highlights")?new ay([new fn({name:fu,options:new pl}),new fn({name:O2,options:new pl({color:R2})})]):new ay([new fn({name:fu,options:new pl})])}var xe;(function(i){i[i.ELEVATION=0]="ELEVATION",i[i.MAP=1]="MAP"})(xe||(xe={}));const Bo=[xe.ELEVATION,xe.MAP];async function gA(i,e){var p,_,f,g,y;const{results:t,ground:s}=await A2(i,e),r=(!s.layer||!wm(s.layer.type))&&s.mapPoint,n=[],a=vA(i),o=r?fA(i,a):yA;let l=0,h=0;const d=()=>{const w=o.layerViews[h];r&&w&&"fetchPopupFeaturesAtLocation"in w&&n.push({mapPoint:s.mapPoint,layerView:w}),++h};let u=null;for(;l<t.length||h<o.layerViews.length;){const w=t[l];if(w&&w.type!=="graphic")++l;else if(((p=w==null?void 0:w.layer)==null?void 0:p.type)!=="scene"||((_=w==null?void 0:w.layer)==null?void 0:_.parent)!==((f=i==null?void 0:i.map)==null?void 0:f.basemap))if(w){const x=(g=w.layer)==null?void 0:g.uid,T=o.layerUids.has(x)&&w.distance===s.distance,C=a.get((y=w.layer)==null?void 0:y.uid);if(u??(u=w.mapPoint),h<o.layerViews.length&&(T||(w.distance??0)>s.distance)&&o.layerViews[h]!==C){d();continue}n.push({graphic:w.graphic,layerView:C}),++l}else d();else++l}return u??(u=s.mapPoint),{hits:n,location:u}}function fA(i,e){const t=new Set,s=[];for(let n=i.basemapTerrain.numLayers(xe.MAP)-1;n>=0;n--){const a=i.basemapTerrain.layerViewByIndex(n,xe.MAP);t.add(a.layer.uid),s.push(a)}const r=i.basemapTerrain.overlayManager.renderer.layers;for(const{uid:n}of r){const a=e.get(n);a&&(t.add(n),s.push(a))}return s.reverse(),{layerUids:t,layerViews:s}}const yA={layerUids:new Set,layerViews:[]};function vA(i){const e=new Map;for(const t of i.allLayerViews){const s=t.layer.uid;e.set(s,t)}return e}let bs=class extends De{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1,this.uncompressedTextureDownsamplingEnabled=!1}};c([m()],bs.prototype,"minTotalNumberOfFeatures",void 0),c([m()],bs.prototype,"maxTotalNumberOfFeatures",void 0),c([m()],bs.prototype,"maxNumberOfDrawCalls",void 0),c([m()],bs.prototype,"maxTotalNumberOfVertices",void 0),c([m()],bs.prototype,"snapshotAvailable",void 0),c([m()],bs.prototype,"polygonLodFactor",void 0),c([m()],bs.prototype,"polylineLodFactor",void 0),c([m()],bs.prototype,"skipHighSymbolLods",void 0),c([m()],bs.prototype,"uncompressedTextureDownsamplingEnabled",void 0),bs=c([I("esri.views.3d.support.QualitySettings.Graphics3DSettings")],bs);let mr=class extends De{constructor(){super(...arguments),this.lodFactor=1}};c([m()],mr.prototype,"lodFactor",void 0),mr=c([I("esri.views.3d.support.QualitySettings.LoDFactorSettings")],mr);let ln=class extends De{constructor(){super(...arguments),this.object=new mr,this.point=new mr,this.integratedMesh=new mr,this.pointCloud=new mr,this.uncompressedTextureDownsamplingEnabled=!1}};c([m({type:mr})],ln.prototype,"object",void 0),c([m({type:mr})],ln.prototype,"point",void 0),c([m({type:mr})],ln.prototype,"integratedMesh",void 0),c([m({type:mr})],ln.prototype,"pointCloud",void 0),c([m()],ln.prototype,"uncompressedTextureDownsamplingEnabled",void 0),ln=c([I("esri.views.3d.support.QualitySettings.SceneServiceSettings")],ln);let hn=class extends De{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};c([m()],hn.prototype,"lodBias",void 0),c([m()],hn.prototype,"angledSplitBias",void 0),c([m()],hn.prototype,"vtlContentZoom",void 0),c([m()],hn.prototype,"elevationLevelDelta",void 0),c([m()],hn.prototype,"reduceTileLevelDifferences",void 0),hn=c([I("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],hn);let el=class extends De{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};c([m()],el.prototype,"pixelRatio",void 0),c([m()],el.prototype,"maxTotalNumberOfFeatures",void 0),el=c([I("esri.views.3d.support.QualitySettings.HeatmapSettings")],el);let vi=class extends De{constructor(){super(...arguments),this.graphics3D=new bs,this.sceneService=new ln,this.tiledSurface=new hn,this.heatmap=new el,this.fadeDuration=nt(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};c([m({type:bs})],vi.prototype,"graphics3D",void 0),c([m({type:ln})],vi.prototype,"sceneService",void 0),c([m({type:hn})],vi.prototype,"tiledSurface",void 0),c([m({type:el})],vi.prototype,"heatmap",void 0),c([m()],vi.prototype,"fadeDuration",void 0),c([m()],vi.prototype,"antialiasingEnabled",void 0),c([m()],vi.prototype,"physicallyBasedRenderingEnabled",void 0),c([m()],vi.prototype,"highQualityTransparency",void 0),c([m()],vi.prototype,"highResolutionAtmosphere",void 0),c([m()],vi.prototype,"reflections",void 0),c([m()],vi.prototype,"ambientOcclusion",void 0),c([m()],vi.prototype,"memoryLimit",void 0),c([m()],vi.prototype,"additionalCacheMemory",void 0),c([m()],vi.prototype,"frameRate",void 0),c([m()],vi.prototype,"maximumPixelRatio",void 0),vi=c([I("esri.views.3d.support.QualitySettings")],vi);const oy=vi;var Fr;(function(i){i[i.ELEVATION=0]="ELEVATION",i[i.BASEMAP=1]="BASEMAP",i[i.I3S_INDEX=2]="I3S_INDEX",i[i.I3S_DATA=3]="I3S_DATA",i[i.SYMBOLOGY=4]="SYMBOLOGY"})(Fr||(Fr={}));const bA=(()=>{const i=new Array;return i[Fr.ELEVATION]=10,i[Fr.BASEMAP]=10,i[Fr.I3S_INDEX]=10,i[Fr.I3S_DATA]=10,i[Fr.SYMBOLOGY]=5,i})(),wA=30;function xA(i){return"usedMemory"in i&&"unloadedMemory"in i&&"ignoresMemoryFactor"in i}function CA(i){return new Vi({view:i})}const ly=.1,td=1,Np=1,TA=.75,SA=.6,hy=1.3;let Vi=class extends De{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new D2,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles(Ru({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){e==null||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(td),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){e!=null&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t){return new $2(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();this._memoryPredicted<SA&&this._canFastRecover?(this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(td)):e?(this._memoryPredicted>1.1*Np||this._usedMemory>Np)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>ly&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/hy),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1)):(this._downscaleMemoryUsed=0,this._usedMemory>Np?(this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/hy),this._downscaleMemoryUsed=this._memoryPredicted):this._stableQuality!==this._quality&&(this._usedMemory<TA&&this._quality<td?(this._stableQuality=this._quality,e=this._updateQuality(this._quality+.05)):this._quality<1&&(this._canFastRecover=!0))),this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,ly),td))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){var o,l,h,d,u;if(!this.view)return;(l=(o=this.view._stage)==null?void 0:o.renderer)==null||l.tick();const e=(d=(h=this.view._stage)==null?void 0:h.renderer)==null?void 0:d.usedMemory;let t=(((u=this.view.basemapTerrain)==null?void 0:u.usedMemory)??0)+(e?e.fbos+e.edges+e.plugins:0),s=0;this.view.allLayerViews&&this.view.allLayerViews.forEach(p=>{if(xA(p)){const _=p.ignoresMemoryFactor?this._quality:1;t+=p.usedMemory*_,s+=p.unloadedMemory*_}});const r=this._warnMemoryUsage==null||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),n=1048576*this.maxMemory;if(t>n&&r){this._warnMemoryUsage=t;const p=f=>(f/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",_=Math.round(100*this._quality);Pe.getLogger(this).warn(`Memory Limit exceeded! Limit: ${p(n)} Current: ${p(t)} Projected: ${p(t+s)} Quality: ${_}%`)}this._usedMemory=t/n,this._memoryPredicted=(t+s)/n;const a=n-t;this._cacheStorage.maxSize=Math.max(0,a+1048576*this.additionalCacheMemory)}get test(){}};c([m({constructOnly:!0})],Vi.prototype,"view",void 0),c([m()],Vi.prototype,"maxMemory",null),c([m()],Vi.prototype,"additionalCacheMemory",null),c([m({readOnly:!0})],Vi.prototype,"memoryFactor",null),c([m({readOnly:!0})],Vi.prototype,"updating",null),c([m({readOnly:!0})],Vi.prototype,"usedMemory",null),c([m({readOnly:!0})],Vi.prototype,"usedCacheMemory",null),c([m()],Vi.prototype,"_quality",void 0),c([m()],Vi.prototype,"_usedMemory",void 0),c([m()],Vi.prototype,"_updating",void 0),c([m()],Vi.prototype,"_stableQuality",void 0),c([m()],Vi.prototype,"_maxMemory",void 0),c([m()],Vi.prototype,"_additionalCacheMemory",void 0),Vi=c([I("esri.views.3d.support.MemoryController")],Vi);let PA=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},EA=class{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new MA}},MA=class{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}},OA=class{constructor(e,t,s,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=s,this._totalNumWorkers=0,this._clients=r.map(n=>new EA(n))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(s,r)=>this._taskCallback(s,r))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,Gs(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(t,s)=>this._taskCallback(t,s)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){}},RA=class{constructor(e,t){this.element=e,this.type="image+type",this.isOpaque=t==="image/jpeg"}},Ad=class extends De{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,s){this._loadQueue=new OA((r,n)=>this._startLoading(r,n),(r,n)=>this._doneLoadingCB(r,n),e,t),s&&(this._frameTask=s.registerTask(ni.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=Hr(this._frameTask),this._tasks.forEach(e=>ha(e.abortController)),this._loadQueue=de(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,s,r={}){const n=y_();n.__signal=r!=null?r.signal:null;const a=this._createOrUpdateTask(e,t,s,r,n);return v_(r,()=>this._cancelRequest(a,n)),n.promise}_createTask(e,t,s,r,n,a){const o=new $A(e,t,s,r,n);return this._updateTask(o,a),this._tasks.set(n,o),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){var s;Bv(e.resolvers,t),t.reject(hr()),e.resolvers.length===0&&(e.status===$s.DOWNLOADING&&(e.status=$s.CANCELLED,this._loadQueue.cancel(e),(s=e.abortController)==null||s.abort(),e.request=null,e.abortController=null),e.status=$s.CANCELLED,this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,s,r,n){const a=IA((r==null?void 0:r.uid)||e,t,s),o=this._tasks.get(a);return o?(this._updateTask(o,n),o):this._createTask(e,r,t,s,a,n)}_doneLoadingCB(e,t){this._loadQueue&&(Gs(e.status===$s.DOWNLOADING),e.status=$s.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();Gi(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==$s.DOWNLOADED&&(t.err=t.err||hr()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!Jn(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let s=R_(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)Jn(t)?r.reject(t):r.reject(new Bi("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--s;const n=s>0?_m(e.result):e.result;r.resolve(n)}this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,t){if(e.status===$s.CANCELLED)return!1;let s,r;switch(e.startTime=performance.now(),e.status=$s.DOWNLOADING,e.docType){case"binary":r="array-buffer",s=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const n=e.abortController.signal;e.request=op(e.url,{...e.options,responseType:r,timeout:s,signal:n});const a=l=>{e.duration=performance.now()-e.startTime,e.size=l instanceof ArrayBuffer?l.byteLength:e.size||0,e.result=l,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},o=l=>{e.status===$s.DOWNLOADING&&t(e,l)};return e.docType!=="image+type"?(e.request.then(l=>a(l.data),o),!0):(e.request.then(l=>{const h=l.data,d=DA(h);if(r="image",e.size=h.byteLength,d==="unknown")return e.request=op(e.url,{responseType:r,timeout:s,signal:n}),void e.request.then(_=>a(_.data),o);const u=new Blob([h],{type:d}),p=window.URL.createObjectURL(u);e.request=op(p,{responseType:r,timeout:s,signal:n}),e.request.then(_=>a(new RA(_.data,d)),o).finally(()=>window.URL.revokeObjectURL(p))},o),!0)}get test(){}};c([m({readOnly:!0})],Ad.prototype,"updating",void 0),Ad=c([I("esri.views.3d.support.StreamDataLoader")],Ad);const AA={numRetries:0};function DA(i){if(i.byteLength<2)return"unknown";const e=new Uint8Array(i,0,i.byteLength);return e[0]===137&&e[1]===80?"image/png":e[0]===71&&e[1]===73?"image/gif":e[0]===66&&e[1]===77?"image/bmp":e[0]===255&&e[1]===216?"image/jpeg":"unknown"}let $A=class extends PA{constructor(e,t,s,r,n){super(r),this.url=e,this.options=t,this.docType=s,this.key=n,this.result=null,this.status=$s.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=AA.numRetries}};function IA(i,e,t){return`${i}:${e}:${t}`}var $s;(function(i){i[i.QUEUED=1]="QUEUED",i[i.DOWNLOADING=2]="DOWNLOADING",i[i.DOWNLOADED=3]="DOWNLOADED",i[i.CANCELLED=4]="CANCELLED"})($s||($s={}));let Dd=class extends De{constructor(){super(...arguments),this.updating=!1}};function LA(i){return new tr({view:i})}c([m({readOnly:!0})],Dd.prototype,"updating",void 0),Dd=c([I("esri.views.3d.support.ResourceController.ResourceControllerMain")],Dd);let tr=class extends Dd{constructor(){super(...arguments),this._immediateTask=lu,this._normalTask=lu,this._updatingObjects=ka([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=GS(),this._memoryController=CA(this.view),this._streamDataLoader=new Ad,this._streamDataLoader.setup(wA,bA,this._scheduler),this.addHandles([E(()=>{var e;return(e=this.view.state)==null?void 0:e.mode},e=>{e!=null&&(this._scheduler.state=e)},je),E(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=Ru({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(ni.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(ni.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=Hr(this._frameTask),this._streamDataLoader=de(this._streamDataLoader),this._memoryController=de(this._memoryController),this._scheduler=de(this._scheduler),this.view=null}get updating(){var e,t,s,r;return!!((e=this._memoryController)!=null&&e.updating||(t=this._streamDataLoader)!=null&&t.updating||(s=this._immediateTask)!=null&&s.updating)||((r=this._updatingObjects)==null?void 0:r.value.some(n=>n.updating))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(s,r,n)=>t.request(s,r,e,n),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],Wn(()=>{t.value=t.value.filter(s=>s!==e)})}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(kv(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.updateBudget(e)&&this._scheduler.frame())}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};c([m()],tr.prototype,"view",void 0),c([m()],tr.prototype,"_scheduler",void 0),c([m()],tr.prototype,"_memoryController",void 0),c([m()],tr.prototype,"_streamDataLoader",void 0),c([m()],tr.prototype,"_immediateTask",void 0),c([m()],tr.prototype,"_normalTask",void 0),c([m()],tr.prototype,"_updatingObjects",void 0),c([m({readOnly:!0})],tr.prototype,"updating",null),tr=c([I("esri.views.3d.support.ResourceController")],tr);let NA=class{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}},VA=class{constructor(e){var t,s,r,n;if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,e.resourceController!=null){const a=e.resourceController.memoryController;this.totalMemory=(a.maxMemory??0)*N2.MEGABYTES,this.usedMemory=Math.round(a.usedMemory*this.totalMemory),this.quality=e.quality,this.load=e.resourceController.scheduler.load,this.cachedMemory=a.usedCacheMemory}this.terrainMemory=((t=e.basemapTerrain)==null?void 0:t.usedMemory)??0,this.edgesMemory=((s=e._stage)==null?void 0:s.renderer.usedMemory.edges)??0,this.fboMemory=((r=e._stage)==null?void 0:r.renderer.usedMemory.fbos)??0,(n=e.allLayerViews)==null||n.items.forEach(a=>{cC(a)&&this.layerPerformanceInfos.push(new NA(a))}),this.layerPerformanceInfos.sort((a,o)=>o.memory-a.memory)}},FA=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",()=>{}),this._wosrMemCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,s){const r=s?`gltfPBR:${e}`:`gltf:${e}`,n=this._gltfMemCache.get(r);return n!=null?Promise.resolve(n):cy(this._gltfLoading,this._gltfMemCache,r,async a=>{const{loadGLTF:o}=await X(()=>import("./loader-Ca9EgBla.js"),__vite__mapDeps([563,2,37,93,6,12,4,5,1,246,61,8,33,73,36,38,32,35,110,97,358,94]),import.meta.url);return o(new V2(a.streamDataRequester),e,a,s)},t)}loadWOSR(e,t){const s=`wosr:${e}:${t.disableTextures}`,r=this._wosrMemCache.get(s);return r!=null?Promise.resolve(r):cy(this._wosrLoading,this._wosrMemCache,s,n=>F2(e,n),t)}};async function cy(i,e,t,s,r){Gi(r);const n=v_(r,()=>UA(i,t));let a=i.get(t);if(a)a.refCount++;else{const o=new AbortController;a={refCount:1,abortController:o,promise:s({...r,signal:o.signal})},i.set(t,a)}try{const o=await a.promise;return e.put(t,o,o.size),i.delete(t),Gi(r),o}finally{Hr(n)}}function UA(i,e){const t=i.get(e);t!=null&&--t.refCount>0||(i.delete(e),t!=null&&t.abortController.abort())}let tl=class extends De{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=(t==null?void 0:t.registerTask(ni.TEXTURE_UNLOAD))??lu}normalizeCtorArgs(){return{}}destroy(){var e,t,s;super.destroy(),(e=this._frameTask)==null||e.remove(),(t=this._textureRequests)==null||t.forEach(r=>this._releaseTextureRequest(r)),(s=this._textureRequests)==null||s.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const s=this.makeUid(e);let r=this._textureRequests.get(s);if(!r){const n=new jb;n.texture=t(),this._stage&&(n.texture.load(this._stage.renderView.renderingContext),this._stage.add(n.texture)),this._textureRequests.set(s,n),r=n}return r.referenceCount++,new kb(s,r.texture,()=>this._release(s))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){}_releaseNow(e){var s;if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||((s=t.texture)==null||s.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){var t;e.texture?(t=this._stage)==null||t.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return t!=null?`${e}.${t}px`:e}};c([m()],tl.prototype,"_frameTask",void 0),c([m()],tl.prototype,"updating",null),tl=c([I("esri.views.3d.support.TextureCollection")],tl);let kb=class{constructor(e,t,s){this.uid=e,this.texture=t,this.release=s}},jb=class{constructor(){this.referenceCount=0}},zA=class extends tl{constructor(e,t,s){super(t,s),this._streamDataRequester=e}async fromUrl(e,t,s){Gi(s);const r=s==null?void 0:s.signal,n=this.makeUid(e,t);let a=this._textureRequests.get(n);if(!a){const o=new AbortController,l=this._streamDataRequester.request(e,"image",{uid:n,signal:o.signal});a=new jb,a.abortController=o;const h=a;this._textureRequests.set(n,a),a.textureAsync=l.then(async d=>{const u=this._createTexture(e,d,t);return h.texture=u,h.abortController=null,await u.load(this._stage.renderView.renderingContext),this._stage.add(u),new kb(n,u,()=>this._release(n))},d=>{throw h.abortController=null,d})}a.referenceCount++;try{return await Lx(a.textureAsync,r)}catch(o){throw this._release(n),o}}_createTexture(e,t,s){var n;const r={width:t.width,height:t.height,wrap:{s:Yi.CLAMP_TO_EDGE,t:Yi.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if(lb(e)){if(s||t.width===0&&t.height===0){const a=t.width?t.height/t.width:1;s=s||64,a>1?(t.width=Math.round(s/a),t.height=s):(t.width=s,t.height=Math.round(s*a))}(n=this._stage.renderView)!=null&&n.renderingContext.driverTest.svgPremultipliesAlpha.result&&(r.preMultiplyAlpha=!1)}return new _S(t,r)}},qA=class{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(Fr.SYMBOLOGY),this.objectResourceCache=new FA((s,r)=>e.resourceController.memoryController.newCache(s,r)),this.textures=new zA(this.streamDataRequester,e.view._stage,e.resourceController.scheduler);const t=Ot(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=Y1(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=xP(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return Wn();this._graphicsOwners.push(e);const t=E(()=>{var s;return(s=e.layer)==null?void 0:s.screenSizePerspectiveEnabled},()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),Wn(()=>{t.remove(),Bv(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some(t=>{var s;return((s=t.layer)==null?void 0:s.screenSizePerspectiveEnabled)===!0});if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new b_;const t=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([E(()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance,t,je),this._viewState.events.on("camera-projection-changed",t)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=de(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;id.distance=e.centerOnSurfaceInfrequent.distance,id.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(id),this.screenSizePerspectiveSettingsLabels.update(id),this._view._stage.renderView.requestRender()}get test(){}};const id={distance:0,fovY:0};let Go=class{constructor(e,t,s=""){this.graphics=e,this._symbol=new EP({symbolLayers:new wn([new MP({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new OP({text:s,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(t==null)return;this.hide();const s=new ea({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new z2({geometry:s,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){this._graphic!=null&&(this.graphics.remove(this._graphic),this._graphic=null)}},Gn=class extends De{constructor(e){super(e)}};c([m({constructOnly:!0})],Gn.prototype,"renderCoordsHelper",void 0),c([m({constructOnly:!0})],Gn.prototype,"surface",void 0),c([m({constructOnly:!0})],Gn.prototype,"state",void 0),Gn=c([I("esri.views.3d.support.pointsOfInterest.PointOfInterest")],Gn);const HA=Array;let ir=class extends Gn{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new aa({location:ea,renderLocation:HA},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=v(),this._tmpPoint=new ea}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles(yn(()=>{var t,s;return(s=(t=this.map)==null?void 0:t.ground)==null?void 0:s.layers},"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=de(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=ki(e.eye,this.renderLocation),s={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return nT(s,t)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){var r;if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!((r=this.map)!=null&&r.ground))return this._updateSurfaceAltitude(0),Xi;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>BA&&this.renderCoordsHelper.viewingMode===Ne.Global&&(e.isWGS84||e.isWebMercator);let s=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:s.signal,cache:this.cache,minDemResolution:t?GA:0}).then(n=>this._updateSurfaceAltitude(n.geometry.z??0)).catch(n=>{Jn(n)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===s&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),s=null}),this._pendingElevationQueryController=s,Xi}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(Vp,this._estimatedSurfaceAltitude,this._camera.eye),Lu(this._get("renderLocation"),Vp)||(this._set("renderLocation",ue(this._propertiesPool.get("renderLocation"),Vp)),this.notifyChange("renderLocation"))}};c([m({constructOnly:!0})],ir.prototype,"scheduler",void 0),c([m({constructOnly:!0})],ir.prototype,"cache",void 0),c([m({constructOnly:!0})],ir.prototype,"task",void 0),c([m()],ir.prototype,"location",null),c([m({constructOnly:!0})],ir.prototype,"map",void 0),c([m()],ir.prototype,"renderLocation",void 0),c([m()],ir.prototype,"scale",null),c([m()],ir.prototype,"updating",null),ir=c([I("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],ir);const Vp=v(),BA=1e5,GA=1e6,kA=Array;let Is=class extends Gn{constructor(e){super(e),this._propertiesPool=new aa({location:ea,renderLocation:kA},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=v(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=Hr(this._frameWorker),this._propertiesPool=de(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Xi}_updateRenderLocation(){const e=WA;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const s=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&s&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=QA;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(ue(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=ki(this._camera.eye,e):(ie(e,this._camera.viewForward,this._get("distance")),ye(e,e,this._camera.eye)),Lu(this._get("renderLocation"),e)||this._set("renderLocation",ue(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){var r,n;const s=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(s.ray,e,t))return!1;if(this.state.isGlobal){const a=Ot(this.renderCoordsHelper.spatialReference).radius,o=a+e,l=Hs(s.eye),h=l<o*o,d=ki(s.eye,t);if(h&&d>a/4){const u=o-Math.sqrt(l);return ie(t,s.viewForward,u),ye(t,t,s.eye),!0}}else{const a=(r=this.surface)!=null&&r.ready?this.surface.extent:null;a!=null&&Zv(a,(n=this.surface)==null?void 0:n.spatialReference,Zl,this.renderCoordsHelper.spatialReference)&&(t[0]=W(t[0],Zl[0],Zl[2]),t[1]=W(t[1],Zl[1],Zl[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(fs.TESTS_DISABLE_OPTIMIZATIONS)return!0;const s=this._camera.eye,r=ki(s,e),n=ki(s,t);if(Math.abs(n-r)/r>jA)return!0}return!1}};c([m({constructOnly:!0})],Is.prototype,"scheduler",void 0),c([m({constructOnly:!0})],Is.prototype,"task",void 0),c([m()],Is.prototype,"distance",void 0),c([m({constructOnly:!0})],Is.prototype,"estimateSurfaceAltitudeAtCenter",void 0),c([m({readOnly:!0})],Is.prototype,"location",null),c([m({readOnly:!0})],Is.prototype,"renderLocation",void 0),c([m()],Is.prototype,"updating",void 0),Is=c([I("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],Is);const jA=.05,WA=v(),QA=v(),Zl=mi();let XA=class{constructor(e){this._handles=new b_,this.events=new Cr,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",t=>this._layerViewsChanged(t))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=de(this._handles),this._contentLayerViews.destroy()}_layerViewsChanged(e){e.added.forEach(t=>{t.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this._handles.add(t.on("visible-geometry-changed",()=>this._contentChanged()),t.uid)}),e.removed.forEach(t=>this._handles.remove(t.uid))}_contentChanged(){this.events.emit("request-update",YA)}};const YA={},ZA=Array;let sr=class extends Gn{constructor(e){super(e),this._propertiesPool=new aa({location:ea,renderLocation:ZA},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([E(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),E(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.addHandles(this.scheduler.registerTask(ni.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=de(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,s=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,s.worldUpAtPosition(t,dy);const n=Math.max(0,(Math.acos(ce(dy,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(n)){if(!e||!Uh(e,t)){const h=this._propertiesPool.get("renderLocation");ue(h,t),this._set("renderLocation",h)}return Xi}const a=1-W(n/(.5*Math.PI),0,1),o=a*a*a;this._calculateScreenHorizontalEdgeOnSurface(uy);const l=this._propertiesPool.get("renderLocation");return vr(l,t,uy,o),e&&Uh(e,l)||this._set("renderLocation",l),Xi}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,s=t.getRenderCenter(Au());if(s[1]=t.aboveGround?t.padding[ms.BOTTOM]:t.fullHeight-t.padding[ms.TOP],this.estimateSurfaceIntersectionAtRenderPoint(s,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(s,Kl)){Te(Kl,Kl,t.eye);const n=ae(Kl,Kl);if(this.renderCoordsHelper.intersectInfiniteManifold(bl(t.eye,n),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};c([m()],sr.prototype,"_dirty",void 0),c([m({constructOnly:!0})],sr.prototype,"scheduler",void 0),c([m({constructOnly:!0})],sr.prototype,"centerOnSurface",void 0),c([m({constructOnly:!0})],sr.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),c([m()],sr.prototype,"updating",null),c([m()],sr.prototype,"location",null),c([m()],sr.prototype,"renderLocation",void 0),c([m()],sr.prototype,"worldUnitsPerContentPixel",null),sr=c([I("esri.views.3d.support.pointsOfInterest.Focus")],sr);const dy=v(),Kl=v(),uy=v();let rn=class extends De{get surface(){var e;return(e=this.view.map)==null?void 0:e.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=v();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([E(()=>{var e,t;return[(e=this.surfaceView)==null?void 0:e.spatialReference,(t=this.surfaceView)==null?void 0:t.extent]},()=>this._update()),yn(()=>{var e;return(e=this.surface)==null?void 0:e.layers},"change",()=>this._update())]),this._update())}_update(){var s;if(this._updateController&&(this._updateController.abort(),this._updateController=null),((s=this.surfaceView)==null?void 0:s.extent)==null||this.surfaceView.spatialReference==null)return void this._set("location",null);const e=e1(this.surfaceView.extent),t=new ea({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(r=>{this._updateController=null,this._set("location",r.geometry)}).catch(r=>{})):this._set("location",t)}};c([m({constructOnly:!0})],rn.prototype,"view",void 0),c([m({constructOnly:!0})],rn.prototype,"cache",void 0),c([m()],rn.prototype,"surface",null),c([m()],rn.prototype,"surfaceView",null),c([m({readOnly:!0})],rn.prototype,"location",void 0),c([m({readOnly:!0})],rn.prototype,"renderLocation",null),rn=c([I("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],rn);let nn=class extends De{constructor(e){super(e),this._tileGeometryUpdateExtent=Za(),this._tileGeometryUpdateSpatialReference=null,this.events=new Cr,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(ni.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",KA),Za(this._tileGeometryUpdateExtent),this._set("updating",!1),Xi):Xi}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,al(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const s=this.centerOnSurfaces[t];s.distance>e.distance&&(e=s)}return e}_centerIntersectsExtent(e,t){const s=this.state.contentCamera.eye,r=JA,n=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(s,wa,t),this.renderCoordsHelper.fromRenderCoords(n.renderLocation,xa,t),wa[0]<xa[0]?(r[0]=wa[0],r[2]=xa[0]):(r[0]=xa[0],r[2]=wa[0]),wa[1]<xa[1]?(r[1]=wa[1],r[3]=xa[1]):(r[1]=xa[1],r[3]=wa[1]),Du(r,e)}};c([m({constructOnly:!0})],nn.prototype,"state",void 0),c([m({constructOnly:!0})],nn.prototype,"centerOnSurfaces",void 0),c([m({constructOnly:!0})],nn.prototype,"renderCoordsHelper",void 0),c([m({constructOnly:!0})],nn.prototype,"scheduler",void 0),c([m({constructOnly:!0})],nn.prototype,"surface",void 0),c([m({readOnly:!0})],nn.prototype,"updating",void 0),nn=c([I("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],nn);const KA={},wa=v(),xa=v(),JA=Za();let ts=class extends De{constructor(e){super(e),this.renderPointOfView=v(),this._pois=new Array,this._debugCenters=null,this._tmpRay=ao(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new aa({renderPointOfView:eD},this)}initialize(){var h;const{state:e,basemapTerrain:t,renderCoordsHelper:s,map:r}=this.view;this._surfaceIntersector=Cn(e.viewingMode),this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=ja.MIN,this._contentIntersector=Cn(e.viewingMode);const n=()=>this._estimateSurfaceAltitudeAtCenter(),a=this.view.resourceController.scheduler,o=(h=this.view.basemapTerrain)==null?void 0:h.elevationQueryCache,l={state:e,scheduler:a,surface:t,renderCoordsHelper:s};this._set("centerOnSurfaceInfrequent",new Is({...l,task:ni.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnSurfaceFrequent",new Is({...l,task:ni.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnContent",new Is({...l,task:ni.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new ir({...l,cache:o,task:ni.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new nn({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new XA({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:s})),this._set("surfaceOrigin",new rn({cache:o,view:this.view})),this._set("focus",new sr({state:e,scheduler:a,surface:t,renderCoordsHelper:s,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(d,u)=>this._estimateSurfaceIntersectionAtRenderPoint(d,this.view.state.contentCamera,u)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus),this.addHandles([E(()=>e.contentCamera,d=>this._cameraChanged(d),je),E(()=>t.extent,()=>this._updateCenterPointsOfInterest()),E(()=>{var d,u,p;return(p=(u=(d=this.view.map)==null?void 0:d.ground)==null?void 0:u.navigationConstraint)==null?void 0:p.type},d=>{this._surfaceIntersector.options.backfacesTerrain=d==="none"},dt),ml(()=>!t.updating,()=>this._updateCenterPointsOfInterest(),je),yn(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),yn(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),E(()=>fs.SHOW_POI,d=>this._setDebug(d),dt)]),this._cameraChanged(this.view.state.contentCamera);for(const d of this._pois)d.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!(!((e=this.surfaceGeometryUpdates)!=null&&e.updating)&&!this._pois.some(t=>t.updating))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return e==null||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,To,iD)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(To):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(e==null)return this._surfaceAltitudeAtCenter;const t=e.origin,s=ye(To,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,s),this._surfaceIntersector.results.min.getIntersectionPoint(To)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(To)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,s){const r=B1(t,e,tD);if(r==null)return null;const n=r.origin,a=ye(To,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,n,a),this._surfaceIntersector.results.min.getIntersectionPoint(s)?s:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;Lu(this.renderPointOfView,t)||this._set("renderPointOfView",ue(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){var t;if(!e)return(t=this._debugCenters)==null||t.forEach(s=>s.hide()),void this.removeHandles("debug");if(!this._debugCenters){this._debugCenters=new Map;const s=this.view.graphics;this._debugCenters.set(this.centerOnContent,new Go(s,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new Go(s,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new Go(s,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new Go(s,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new Go(s,"green","Focus"))}for(const s of this._pois)this.addHandles(E(()=>s.renderLocation,r=>{var n,a;return(a=(n=this._debugCenters)==null?void 0:n.get(s))==null?void 0:a.show(r,s.renderCoordsHelper.spatialReference)},dt),"debug")}get test(){}};c([m()],ts.prototype,"centerOnContent",void 0),c([m()],ts.prototype,"centerOnSurfaceFrequent",void 0),c([m()],ts.prototype,"centerOnSurfaceInfrequent",void 0),c([m()],ts.prototype,"cameraOnSurface",void 0),c([m()],ts.prototype,"focus",void 0),c([m()],ts.prototype,"renderPointOfView",void 0),c([m()],ts.prototype,"surfaceOrigin",void 0),c([m()],ts.prototype,"contentGeometryUpdates",void 0),c([m()],ts.prototype,"surfaceGeometryUpdates",void 0),c([m({constructOnly:!0})],ts.prototype,"view",void 0),c([m()],ts.prototype,"updating",null),ts=c([I("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],ts);const eD=Array,To=v(),tD=ao(),iD={exclude:new Set([Qh])};let fc=class{constructor(e,t){this._cache=e(t,(s,r,n)=>{switch(r){case kf.ALL:return s.forEach(a=>a.dispose()),0;case kf.SOME:{const a=s.shift();return a&&(n-=Math.round(a.usedMemory),a.dispose()),n}}})}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const s=t.pop();if(t.length>0){if(s){const r=this._cache.getSize(e)-Math.round(s.usedMemory);this._cache.updateSize(e,t,r)}}else this._cache.pop(e);return s}put(e,t,s=I2){const r=this._cache.peek(e);if(!r)return void this._cache.put(e,[t],t.usedMemory,s);r.push(t);const n=this._cache.getSize(e)+Math.round(t.usedMemory);this._cache.updateSize(e,r,n)}};const rz={value:.5,readOnly:!0},sD={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};let il=class{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}},rD=class{constructor(e,t,s){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new lT(s,t)}computeMinMaxValue(e,t,s,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const n=e-this.level;if(n<=0)return r;const a=2**n;if(!(Math.floor(t/a)===this.i&&Math.floor(s/a)===this.j))return r;let o=1/0,l=-1/0;const h=this.samplerData.data.width,d=this.samplerData.data.values,u=.5*O_;let p=(h-1)/a,_=(s-this.j*a)*p,f=(t-this.i*a)*p;if(p<1){const g=Math.floor(_),y=Math.floor(f),w=g+y*h,x=d[w],T=d[w+1],C=d[w+h],S=d[w+h+1];if(x+T+C+S<u){const P=_-g,M=f-y,$=Ec(x,T,C,S,P,M),O=Ec(x,T,C,S,P+p,M),N=Ec(x,T,C,S,P,M+p),U=Ec(x,T,C,S,P+p,M+p);return r.min=Math.min($,O,N,U),r.max=Math.max($,O,N,U),r}_=g,f=y,p=1}else _=Math.floor(_),f=Math.floor(f),p=Math.ceil(p);for(let g=_;g<=_+p;g++)for(let y=f;y<=f+p;y++){const w=d[g+y*h];w<u?(o=Math.min(o,w),l=Math.max(l,w)):r.hasNoDataValues=!0}return r.min=o,r.max=l,r}};const nD=.5*O_;function vt(i,e,t){if(t==null)return null;for(const s of t){if(!s)continue;const r=s.safeWidth;let n=W(s.dy*(s.y1-e),0,r),a=W(s.dx*(i-s.x0),0,r);const o=Math.floor(n),l=Math.floor(a),h=s.data.width,d=o*h+l,u=s.data.values,p=u[d],_=u[d+1],f=d+h,g=u[f],y=u[f+1];if(p+g+_+y<nD){n-=o,a-=l;const w=p+(_-p)*a;return w+(g+(y-g)*a-w)*n}}return null}let Ds=class extends De{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const s=t.layer;if("operationalLayerType"in s&&SC(s.operationalLayerType)&&this.viewSpatialReference!=null){const r=Wb(s.fullExtent,this.viewSpatialReference);r!=null&&e.push(gC(r))}}),e}};function aD(i,e){return i===Ne.Global?new Jm(e):new e_(e)}c([m({readOnly:!0})],Ds.prototype,"layerViewsExtent",null),c([m({readOnly:!0})],Ds.prototype,"tiledLayersExtent",null),c([m({readOnly:!0})],Ds.prototype,"stencilEnabledExtents",null),c([m()],Ds.prototype,"viewSpatialReference",void 0),c([m()],Ds.prototype,"tilingScheme",void 0),c([m()],Ds.prototype,"defaultTiledLayersExtent",void 0),c([m({constructOnly:!0})],Ds.prototype,"layers",void 0),c([m({constructOnly:!0})],Ds.prototype,"layerViews",void 0),Ds=c([I("esri.views.3d.terrain.ExtentHelper")],Ds);let Jm=class extends Ds{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?hT:cT}};Jm=c([I("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],Jm);let e_=class extends Ds{_computeLayerViewsExtent(){const e=Za(),t=this.viewSpatialReference;this.layerViews.forEach(n=>{const a=n.layer;if(n.isResolved()&&(a.type!=="graphics"||!a.internal)){const o=Wb("fullExtentInLocalViewSpatialReference"in n&&n.fullExtentInLocalViewSpatialReference||n.layer.fullExtent,t);al(e,o,e)}});const s=of(e)?e:null,r=this._get("layerViewsExtent");return Ga(s,r)?r:s}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,s=Za();this.layers.forEach(a=>{var o;if(a.loaded&&wh(a)){const l=$u(a,t,Ne.Local);if(l==null)return;const{tileInfo:h,fullExtent:d}=l,u="tilemapCache"in a?(o=a.tilemapCache)==null?void 0:o.effectiveMaxLOD:void 0;h!=null&&d!=null&&(o1(a)||e.compatibleWith(h,u)&&d.spatialReference.equals(e.spatialReference))&&al(s,d,s)}}),al(s,this.defaultTiledLayersExtent,s);const r=of(s)?s:null,n=this._get("tiledLayersExtent");return Ga(r,n)?n:r}};function Wb(i,e){return i==null||i.spatialReference.equals(e)?i:eC(i,i.spatialReference,e)}e_=c([I("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],e_);function Qb(){var e;const i=(e=globalThis.require)==null?void 0:e.modules;if(i){const t=Object.keys(i);for(const s of t)s.includes(".glsl")&&delete i[s]}}let py=class{constructor(e,t){this.screen=e,this.olid=t}};const Xb=1.3,oD=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let $n,Ji=class extends De{constructor(e){super(e),this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=Li("esri-mobile")?2048:4096}initialize(){const e=this.view;this.renderer=new VT({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),e._stage.renderer.plugins.add(this.renderer);const t=()=>this.setDrawTexturesDirty();this._groundIntersector=Cn(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([E(()=>this.renderer.hasHighlights,t),this.renderer.events.on("has-water",()=>{var s;return(s=e._stage)==null?void 0:s.renderer.updateHasFlags()}),this.renderer.events.on("content-changed",t),E(()=>e.state.camera.pixelRatio,t),E(()=>e.state.alignPixelEnabled,t),this.renderer.events.on("textures-disposed",()=>this.surface.requestRender()),E(()=>{var s,r,n;return[(s=e.pointsOfInterest)==null?void 0:s.renderPointOfView,(n=(r=e.pointsOfInterest)==null?void 0:r.centerOnSurfaceFrequent)==null?void 0:n.location]},()=>this.setPlacementDirty()),E(()=>{var s,r;return[(s=e.state)==null?void 0:s.pixelRatio,(r=e.state)==null?void 0:r.contentPixelRatio]},()=>this.setPlacementDirty(),je),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.on("resize",()=>this.setPlacementDirty()),e.resourceController.scheduler.registerTask(ni.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",s=>{this._updateOverlays(pn,s.camera,Me.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(Me.BACKGROUND,s)})]),e._stage.renderer.overlay=this}destroy(){var e;(e=this.view)!=null&&e._stage&&(this.view._stage.renderer.plugins.remove(this.renderer),this.view._stage.renderer.overlay=null),$n&&($n.hide(),$n=null),this.renderer=de(this.renderer)}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||fs.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return this._spatialReference!=null&&this._spatialReference.isGeographic&&!this.view.state.isLocal?Ot(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return Xb/this.view.resolutionScale}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}render(){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._precompileShaders()?this._drawOverlays(Me.UPDATE):null}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;e!=null&&t!=null?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new If(-20037508342787e-6,20037508342787e-6):new If(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}registerDrapeSource(e,t,s){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const r=this.renderer.createDrapeSourceRenderer(e,t,s);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),r}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,FT)}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&e.setDrapingExtent!=null&&this._spatialReference!=null&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,Me.UPDATE)}_updateOverlays(e,t,s){if(!this._spatialReference)return Xi;const r=this._computeOverlayResolution(t);this._computeOverlayExtents(t,r,Mr),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,Mr.stretch);const n=this._updateOverlay(Es.INNER,Mr.inner,r,1*Mr.pixelRatioAdjustment,Mr.mapUnitsPerPixel),a=Ia(Mr.inner)/Ia(Mr.outer),o=this._updateOverlay(Es.OUTER,Mr.outer,r,a*Mr.pixelRatioAdjustment,Mr.mapUnitsPerPixel);n!==Ir.EXTENT&&o!==Ir.EXTENT||(this._drapeSources.forEach(l=>this._updateDrapeSourceExtent(l)),this.surface.updateTileOverlayParams(s)),n===Ir.NONE&&o===Ir.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,s=e.fullWidth/e.pixelRatio*t,r=e.fullHeight/e.pixelRatio*t,n=Math.ceil(1.5*Math.max(s,r));return Math.min(Gh(n),this._maxResolution)}_updateOverlay(e,t,s,r,n){if(this.renderer.overlays.length===0)return Ir.NONE;const a=this.renderer.overlays[e],o=a.mapUnitsPerPixel;if(a.mapUnitsPerPixel=n,a.pixelRatio=r,lD(t,a.extent)&&s===a.resolution)return o===n?Ir.NONE:Ir.RERENDER_ONLY;ym(a.extent,t),a.resolution=s;const l=e1(a.extent);return a.renderLocalOrigin=p2(l[0],l[1],0,"OV_"+this._latestOriginId++),Ir.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const s=this.renderer.overlays[Es.INNER],r=this.renderer.overlays[Es.OUTER],n=e.extent;this._rectInsideRect(s.extent,n)||this._rectanglesOverlap(n,s.extent)||this._rectanglesOverlap(n,r.extent)?(this._setTileOverlayData(n,Es.INNER,t),this._setTileOverlayData(n,Es.OUTER,t)):(this._clearTileOverlayData(Es.INNER,t),this._clearTileOverlayData(Es.OUTER,t))}else this._clearTileOverlayData(Es.INNER,t),this._clearTileOverlayData(Es.OUTER,t)}overlayPixelSizeInMapUnits(e,t){if(this.renderer.overlays.length===0)return t();const s=this.renderer.overlays[Es.INNER],r=this.renderer.overlays[Es.OUTER],n=this._pointIsInExtent(e,s.extent)?s:r;return(n.extent[2]-n.extent[0])/n.resolution}_setTileOverlayData(e,t,s){if(this.renderer.overlays.length===0)return;const r=this.renderer.overlays[t].extent,n=Ia(r),a=Zd(r);let o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(r[0],o);const l=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);o>l&&(o=l-(e[2]-e[0]))}s.setScale(t,Ia(e)/n,Zd(e)/a),s.setOffset(t,(o-r[0])/n,(e[1]-r[1])/a)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}reloadShaders(){Qb(),this.setDrawTexturesDirty(),this.runTask(pn)}updateAnimation(e){return this.renderer.updateAnimation(e)&&(this._drawTexturesAnimateDirty=!0),this._drawTexturesAnimateDirty}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this.view._stage.renderView.requestRender()):this.setPlacementDirty()}_intersectGroundFromView(e,t,s,r){const n=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,uD,t,s);if(n==null)return!1;const a=n.origin,o=ye(sd,n.origin,n.direction);return this._groundIntersector.reset(a,o,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,a,o),this._groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(e,t){let s=.5;const r=.55,n=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,l=W(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:n+o,e.aboveGround?n-o:1/0),h=e.aboveGround;if(this.view.viewingMode==="global"){const d=sd;zu(k_(j_,Ot(this.view.spatialReference).radius+l),bl(e.eye,e.viewForward),d),Te(d,d,e.eye);const u=na.normalize(dP(e.viewForward,d,e.viewRight))/e.fovY+.5,p=u<=0||u>=1?.5:r;s=h?p*u:u+p*(1-u)}else{const d=.5*Math.PI-Math.acos(-e.viewForward[2]),u=Math.tan(d),p=xr(0,u,1,0),_=Mm(p,p,e.projectionMatrix)[1],f=W(.5+.5*_,0,1);s=f===1||f===0?.5:h?f*r:1-(1-f)*r}return!!this._intersectGroundFromView(e,.5,s,t)&&DT(t,e.eye)<a.distance*a.distance}_computeOverlayExtents(e,t,s){var O;const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=v();this._findHorizonBasedPointOfInterest(e,n)||ue(n,r),fs.OVERLAY_SHOW_CENTER?($n==null&&($n=new Go(this.view.graphics,"red")),$n.show(n,this._renderSR)):$n!=null&&$n.hide();const a=Math.max(.1,ki(e.eye,n)),o=ia(this.view.renderCoordsHelper,r,e.eye);this._overlaySREqualsRenderSR||Yh(n,this._renderSR,n,this._spatialReference);const l=this.surface.extent,h=!this._isSpherical&&((O=this._spatialReference)==null?void 0:O.isGeographic),d=h&&this._spatialReference?1/Ot(this._spatialReference).metersPerDegree:1,u=this.view.state.contentPixelRatio,p=e.perScreenPixelRatio/u*a*d;s.mapUnitsPerPixel=p/this._worldToPCSRatio,s.stretch=this._overlayStretch;let _=t*p/2*s.stretch,f=!1,g=h?90:1/0;this._isSpherical&&l&&this._spatialReference&&(this._spatialReference.isWebMercator?(_/=Math.cos(qx(n[1])),g=l[3]):(f=!0,_/=Ot(this._spatialReference).metersPerDegree,g=90),_>=g&&(_=g,n[1]=0,this._spatialReference.isWebMercator&&(n[0]=0)));let y=1;f&&(y=1/Math.max(.2,Math.cos(Math.abs(Et(n[1])))),_*y>180&&(y=180/_),s.mapUnitsPerPixel*=y);const w=Math.log(2)/12;_=Math.exp(Math.round(Math.log(_)/w)*w);const x=_*y,T=32,C=.5*t/(T*x),S=.5*t/(T*_);n[0]=Math.round(n[0]*C)/C,n[1]=Math.round(n[1]*S)/S;const P=s.inner;P[0]=n[0]-x,P[1]=n[1]-_,P[2]=n[0]+x,P[3]=n[1]+_,this._isSpherical&&this._shiftExtentToFitBounds(P,1/0,g);const M=s.outer;if(6*x>Ia(l))ym(M,l);else if(Math.PI/2-Math.abs(o-Math.PI/2)<=.25*Math.PI)M[0]=P[0]-x,M[1]=P[1]-_,M[2]=P[2]+x,M[3]=P[3]+_;else{Yh(e.eye,this._renderSR,sd,this._spatialReference),lS(Ca,n,sd);let N=-Math.atan2(Ca[1],Ca[0])+.125*Math.PI;N<0&&(N+=2*Math.PI);const U=Math.floor(N/(.25*Math.PI));G1(Ca,oD[U],2*_),Ca[0]*=y,Ca[2]*=y,mP(M,P,Ca)}if(this._isSpherical)M[0]=this._longitudeCyclical.clamp(M[0]),M[2]=this._longitudeCyclical.clamp(M[2]),M[1]=Math.max(M[1],-g),M[3]=Math.min(M[3],g);else{const N=vm(P,l,cD),U=vm(M,l,dD);lf(N,U)&&(M[2]=M[0],M[3]=M[1])}const $=Math.abs(P[2]-P[0])/t;s.mapUnitsPerPixel=Math.max(s.mapUnitsPerPixel,$),s.pixelRatioAdjustment=s.mapUnitsPerPixel/$}_precompileShaders(){return!!this.renderer.hasOverlays&&(this.renderer.precompileShaders(this.view.state),!0)}_drawOverlays(e,t=this.view.state){if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const s=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const r=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),r!==this.renderer.computeValidity()&&this.surface.updateTileOverlayParams(Me.UPDATE),s?(this.surface.requestRender(e),e===Me.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(Me.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return e!=null&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):Du(e,t))}_rectInsideRect(e,t){return t!=null&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:lf(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const s=e.x,r=e.y;return s>t[0]&&s<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,s){let r=0,n=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-s?n=e[1]+s:e[3]>s&&(n=s-e[3]),Jv(e,r,n)}get test(){}};function lD(i,e){const s=fs.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(i[2]-i[0],i[3]-i[1],e[2]-e[0],e[3]-e[1]);return Math.abs(e[0]-i[0])<=s&&Math.abs(e[1]-i[1])<=s&&Math.abs(e[2]-i[2])<=s&&Math.abs(e[3]-i[3])<=s}c([m()],Ji.prototype,"_spatialReference",void 0),c([m({readOnly:!0})],Ji.prototype,"running",null),c([m()],Ji.prototype,"_placementDirty",void 0),c([m()],Ji.prototype,"_contentUpdated",void 0),c([m()],Ji.prototype,"_isSpherical",null),c([m()],Ji.prototype,"_worldToPCSRatio",null),c([m()],Ji.prototype,"renderer",void 0),c([m({constructOnly:!0})],Ji.prototype,"view",void 0),c([m({constructOnly:!0})],Ji.prototype,"surface",void 0),c([m()],Ji.prototype,"suspended",null),c([m()],Ji.prototype,"updating",null),c([m({type:Boolean})],Ji.prototype,"rendersOccludedDraped",null),Ji=c([I("esri.views.3d.terrain.OverlayManager")],Ji);let hD=class{constructor(){this.inner=mi(),this.outer=mi(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=Xb}};const Ca=Ci(),sd=v(),Mr=new hD,cD=mi(),dD=mi(),uD=ao();var Ir;(function(i){i[i.NONE=0]="NONE",i[i.EXTENT=1]="EXTENT",i[i.RERENDER_ONLY=2]="RERENDER_ONLY"})(Ir||(Ir={}));let pD=class{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=du(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=ii(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,du(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,s,r){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,r),t),ye(t,t,s)}getEdgeNormal(e,t,s){const{typedBuffer:r,typedBufferStride:n}=this.vertexAttributes.normalCompressed;B2(t,r,this.getEdgeAttributeIndex(e,s),n)}setEdgeNormalFromValues(e,t,s,r,n){this._setNormal(this.getEdgeAttributeIndex(e,t),s,r,n)}setEdgeVertexFromValuesRawPositionUV(e,t,s,r,n,a,o){const l=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(l,s,r,n),this._setUV(l,a,o)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,s,r,n,a,o,l,h,d){const u=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(u,s,r,n),this._setUV(u,a,o),this._setNormal(u,l,h,d)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,s,r){const{typedBuffer:n,typedBufferStride:a}=this.vertexAttributes.normalCompressed;Zh(n,e,t,s,r,a)}_setUV(e,t,s){fr(this.vertexAttributes.uv0,e,t,s)}getEdgeAttributeIndex(e,t){return F(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}};const my=16384;function fr(i,e,t,s){i.setValues(e,t*my,s*my)}let mD=class{constructor(){this.sinLonLUT=new Array(sh+1),this.cosLonLUT=new Array(sh+1),this.sinLatLUT=new Array(sh+1),this.cosLatLUT=new Array(sh+1)}update(e,t,s){const r=t[0],n=t[2];for(let a=0;a<=e;a++){const o=a/e,l=r*(1-o)+n*o;this.sinLonLUT[a]=Math.sin(l),this.cosLonLUT[a]=Math.cos(l);const h=s(o);this.sinLatLUT[a]=Math.sin(h),this.cosLatLUT[a]=Math.cos(h)}}},_D=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}},Yb=class $d{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=de(this._current),this._next=de(this._next),this._waiting=de(this._waiting),this._delayed=de(this._delayed)}get current(){if(this._current==null)return null;if(!this._isFadingEnabled){const t=this._delayed||this._waiting||this._next||this._current;t!==this._current&&(this._current=null,this.clear(),this._current=t)}let e=$d.test.fadeMoment;if(this._delayed!=null&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,Zn.Immediate),this._delayed=null)),this._next!=null){e=e||performance.now();const t=this._fadeDuration,s=this._current!=null&&this._next.texture===this._current.texture,r=this._next.type!==zt.FADING,n=e-this._fadeStart>=t;(s||r||n)&&(de(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(this._next==null)return 1;const e=$d.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),s=this._fadeDuration;return t>s?0:1-t/s}get isFading(){return this._next!=null||this._delayed!=null}push(e,t=Zn.Immediate){this._delayed=de(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),this._current==null)return void(this._current=e);const s=$d.test.fadeMoment||performance.now();return t!==Zn.Immediate?(this._delayed=e,void(this._delayedTime=s+t)):this._next==null?(this._next=e,void(this._fadeStart=this._alignFadeStart(s))):void(e!=null&&(de(this._waiting),this._waiting=e))}get _fadeDuration(){const e=this._getFadeDuration();return this._waiting?.5*e:e}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}};var Zn;Yb.test={fadeMoment:0},function(i){i[i.Immediate=0]="Immediate",i[i.Delayed=5e3]="Delayed"}(Zn||(Zn={}));let Eu=class{constructor(e,t,s,r,n,a){this.texture=e,this.type=t,this.offsetAndScale=s,e.retain(),this.opacities=Pt(r,n,a)}destroy(){this.texture.release()}},gD=class{constructor(){this._scales=xr(-1,-1,-1,-1),this._offsets=xr(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,s){this._scales[2*e]=t,this._scales[2*e+1]=s}setOffset(e,t,s){this._offsets[2*e]=t,this._offsets[2*e+1]=s}get scales(){return this._scales}get offsets(){return this._offsets}};var Cl;(function(i){i[i.BACK_TO_FRONT=-1]="BACK_TO_FRONT",i[i.NONE=0]="NONE",i[i.FRONT_TO_BACK=1]="FRONT_TO_BACK"})(Cl||(Cl={}));let Zb=class{constructor(){this._queue=new Lt,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.leaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),e!=null&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){var t;const e=(t=this._last)==null?void 0:t.children;return e!=null&&e[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}},fD=class{constructor(){this._q=new Lt}get done(){return this._q.length===0}reset(e){if(this._q.clear(),e!=null){this._q.pushArray(e);for(let t=0;t<this._q.length;++t){const s=this._q.data[t];s.leaf||this._q.pushArray(s.children)}}}next(){return this._q.pop()}};function Qa(i,e){if(e==null)return!1;const t=yD(e);if((t==null?void 0:t.fullExtent)==null)return!1;const s=t.fullExtent,r=i.extent;if(s.xmin>r[2]||s.ymin>r[3]||s.xmax<r[0]||s.ymax<r[1])return!1;const n=i.surface.tilingScheme.levels[i.level].scale,a=t.minScale;if(a>0&&n>1.00000001*a)return!1;const o=t.maxScale;return!(o>0&&n<.99999999*o)}function yD(i){return l1(i)?{fullExtent:i.fullExtent,minScale:i.layer.minScale,maxScale:i.layer.maxScale}:i.layer}function vD(i){return!l1(i)&&i.layer&&"tilemapCache"in i.layer?i.layer.tilemapCache:null}function Ur(i,e){const t=i.lij,s=e.lij;return t[0]-s[0]||t[1]-s[1]||t[2]-s[2]}function bD(i,e,t=null){t==null||t.length===0?i===Cl.BACK_TO_FRONT?e.sort(wD):e.sort(xD):e.sort((s,r)=>CD(s,r,i,t))}function wD(i,e){const t=e.screenDepth-i.screenDepth;if(t!==0)return t;const s=i.lij,r=e.lij;return s[0]-r[0]||s[1]-r[1]||s[2]-r[2]}function xD(i,e){const t=i.screenDepth-e.screenDepth;if(t!==0)return t;const s=i.lij,r=e.lij;return s[0]-r[0]||s[1]-r[1]||s[2]-r[2]}function Kb(i,e,t){const s=i.screenDepth,r=e.screenDepth;return s<r?-t:s>r?t:Ur(i,e)}function CD(i,e,t,s){return _y(i,s)===_y(e,s)?Kb(i,e,t):i?t:-t}function _y(i,e){for(const t of e)if(i.intersectsExtent(t))return!0;return!1}function TD(i,e){const t=i.distanceToPOI-e.distanceToPOI;if(t!==0)return t;const s=i.lij,r=e.lij;return s[0]-r[0]||s[1]-r[1]||s[2]-r[2]}function SD(i,e){const t=i.length;for(let s=0;s<t;++s)i.at(s).updateDistanceToPOI(e);i.sort(TD)}function PD(i,e,t){let s=1,r=0,n=0;for(;i!==e;)if(s*=.5,r*=.5,n*=.5,1&i.lij[2]&&(r+=.5),1&i.lij[1]||(n+=.5),(i=i.parent)==null)throw new Error("tile was not a descendant of upsampleTile");t.init(e,r,n,s)}function ED(i){for(let e=0;e<i.length;e++){const t=i[e],s=t.parent;if(s)for(let r=0;r<4;r++){const n=s.children[r];if(n&&n!==t)return!0}}return!1}function bz(i,e){if(!i||!e||i[0]===e[0])return!1;const t=i[0]<e[0],s=t?i:e,r=t?e:i,n=1<<r[0]-s[0];return Math.floor(r[1]/n)===s[1]&&Math.floor(r[2]/n)===s[2]}var Si;(function(i){i[i.Opaque=0]="Opaque",i[i.Transparent=1]="Transparent",i[i.InvisibleWithDraped=2]="InvisibleWithDraped",i[i.Invisible=3]="Invisible",i[i.COUNT=4]="COUNT"})(Si||(Si={}));function MD(i,e){i.varyings.add("tbnTangent","vec3"),i.varyings.add("tbnBiTangent","vec3"),e.spherical?i.vertex.code.add(b`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):i.vertex.code.add(b`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),i.fragment.code.add(b`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function fg(i){i.code.add(b`
    float lineFactorAtPosition(float value) {
      float pos = value * ${b.float(257)};
      if(pos < 0.5 || pos > ${b.float(257-.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}var zr;(function(i){i[i.LayerOnly=0]="LayerOnly",i[i.ColorComposite=1]="ColorComposite",i[i.GridComposite=2]="GridComposite",i[i.COUNT=3]="COUNT"})(zr||(zr={}));let OD=class extends Y_{constructor(){super(...arguments),this.overlayOpacity=1}};function RD(i,e){const{vertex:t,fragment:s,varyings:r}=i;r.add("vtc","vec2"),t.uniforms.add(new gy("texOffsetAndScale")),s.uniforms.add(new fy("tex")),s.uniforms.add(new Fp("textureOpacities"));const n=e.textureFadingEnabled&&!e.renderOccluded;n&&(t.uniforms.add(new gy("nextTexOffsetAndScale")),r.add("nvtc","vec2"),s.uniforms.add(new fy("texNext")),s.uniforms.add(new Fp("nextTexOpacities")),s.uniforms.add(new AD("fadeFactor")));const a=e.tileBlendInput===zr.ColorComposite,o=e.tileBlendInput===zr.GridComposite;o&&s.include(fg),a&&s.uniforms.add(new Fp("backgroundColor")),t.code.add(b`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${n?b`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:b``}
  }`),s.code.add(b`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${o||a?b`
              if (opacities.y <= 0.0) {
                return color * opacities.z * opacities.x;
              }
              vec4 bg = vec4(${a?b`backgroundColor`:b`gridColor(uv)`} * opacities.y, opacities.y);
              vec4 layer = color * opacities.z;
              return (bg * (1.0 - layer.a) + layer) * opacities.x;`:b`return color;`}
    }`),n?s.code.add(b`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):s.code.add(b`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}let AD=class extends Hu{constructor(e){super(e,"float")}},Fp=class extends Hu{constructor(e){super(e,"vec3")}},gy=class extends Hu{constructor(e){super(e,"vec4")}},fy=class extends Hu{constructor(e){super(e,"sampler2D")}},yg=class extends OD{};function Jb(i){const e=new qt,{vertex:t,fragment:s,varyings:r}=e,{output:n,pbrMode:a,overlayMode:o,tileBorders:l,spherical:h,transparencyMode:d,screenSizePerspective:u}=i;e.include(gS),e.include(kP,i),e.include(w1,i);const p=()=>{e.include($P,i),t.code.add(b`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};fS(t,i),e.include(eb,i);const _=d===Si.InvisibleWithDraped||d===Si.Invisible,f=o!==iu.Disabled,g=f&&_;switch(n){case D.ColorEmission:case D.Color:{e.include(RD,i),e.include(uu,i),f&&(i.pbrMode=a===jt.Simplified?jt.TerrainWithWater:jt.Water,e.include(Ul,i),i.pbrMode=a);const y=o===iu.EnabledWithWater;y&&e.include(MD,i),r.add("vnormal","vec3"),r.add("vpos","vec3"),r.add("vup","vec3"),p(),u&&Ef(t);const w=i.receiveShadows&&!i.renderOccluded;w&&e.include(tb,i),u&&(r.add("screenSizeDistanceToCamera","float"),r.add("screenSizeCosAngle","float")),t.main.add(b`
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);
          vnormal = getNormal();
          vup = getLocalUp(position, localOrigin);
          ${He(y,b`forwardVertexTangent(vnormal);`)}

          vec2 uv = getUV0();
          forwardTextureCoordinatesWithTransform(uv);
          ${He(f,"setOverlayVTC(uv);")}
          ${He(l,"forwardTextureCoordinates();")}
          ${He(u,b`vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
                 screenSizeDistanceToCamera = length(viewPos);
                 vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
                 screenSizeCosAngle = abs(viewSpaceNormal.z);`)}
          ${He(w,"forwardLinearDepth();")}`),e.include(yS,i),e.include(uu,i),e.include(WP,i),e.include(QP,i),vS(s,i),XP(s),Om(s),s.uniforms.add(t.uniforms.get("localOrigin"),new Wi("viewDirection",(T,C)=>ae(yy,$e(yy,C.camera.viewMatrix[12],C.camera.viewMatrix[13],C.camera.viewMatrix[14])))),y&&s.uniforms.add(new et("ovWaterTex",(T,C)=>{var S;return(S=C.overlay)==null?void 0:S.getTexture(Ns.WaterNormal)}),new bS("view",(T,C)=>qh(DD,C.camera.viewMatrix,T.origin)));const x=.2;s.code.add(b`float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),Fu(s),C1(s),s.main.add(b`
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${w?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), readShadowMap(vpos, linearDepth))":h?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${He(f,b`vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
                   vec4 overlayColor = overlayOpacity * overlayColorOpaque;
                   ${He(_,`if (overlayColor.a < ${b.float(Qo)}) { discard; }`)}
                   vec4 groundColor = tileColor;
                   tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`)}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a < ${b.float(Qo)}) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= ${b.float(x)};
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${a===jt.Simplified||a===jt.TerrainWithWater?b`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:b`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${He(y,b`vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
                   float waterNormalLength = length(overlayWaterMask);
                   if (waterNormalLength > 0.95) {
                     mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                     vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                     vec4 viewPosition = view*vec4(vpos, 1.0);
                     vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                     vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                     float opacity = sliced ? ${b.float(x)} : 1.0;
                     // un-gamma the ground color to mix in linear space
                     fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
                   }`)}
          ${He(u,b`float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0));
                   if (perspectiveScale <= 0.25) {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
                   } else if (perspectiveScale <= 0.5) {
                     fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
                   } else if (perspectiveScale >= 0.99) {
                     fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
                   } else {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
                   }`)}
          ${He(i.visualizeNormals,h?b`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`:b`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`)}
          ${He(l,b`vec2 dVuv = fwidth(vuv0);
                 vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
                 float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
                 fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`)}
          fragColor = highlightSlice(fragColor, vpos);`)}break;case D.Depth:g&&e.include(Ul,i),t.main.add(b`
        ${He(g,"setOverlayVTC(getUV0());")}
        gl_Position = transformPosition(proj, view, position);`),s.main.add(`${He(g,`if (getCombinedOverlayColor().a < ${b.float(Qo)}) discard;`)}`);break;case D.Shadow:case D.ShadowHighlight:case D.ShadowExcludeHighlight:case D.ViewshedShadow:e.include(J1,i),s2(e),r2(e),t.main.add(b`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);`),s.main.add(b`outputDepth(linearDepth);`);break;case D.Normal:g&&e.include(Ul,i),r.add("vnormal","vec3"),Ef(t),p(),t.main.add(b`
        ${He(g,"setOverlayVTC(getUV0());")}
        gl_Position = transformPosition(proj, view, position);
        vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);`),s.main.add(b`
        ${He(g,`if (getCombinedOverlayColor().a < ${b.float(Qo)}) discard;`)}
        vec3 normal = normalize(vnormal);
        if (gl_FrontFacing == false) {
          normal = -normal;
        }
        fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);`);break;case D.Highlight:f&&e.include(Ul,i),t.main.add(b`
        ${He(f,"setOverlayVTC(getUV0());")}
        gl_Position = transformPosition(proj, view, position);`),e.include(x1,i),s.main.add(b`
        ${He(f,b`
           vec2 overlayHighlightTexel = getAllOverlayHighlightValuesEncoded();
           outputAllHighlights(overlayHighlightTexel);`,"calculateOcclusionAndOutputHighlight();")}
      `)}if(n===D.ObjectAndLayerIdColor)if(f)i.pbrMode=jt.Disabled,e.include(Ul,i),i.pbrMode=a,t.main.add(b`gl_Position = transformPosition(proj, view, position);
setOverlayVTC(getUV0());`),s.main.add(b`fragColor = getOverlayColorTexel(vtcOverlay);`);else{const y=d===Si.Opaque;t.main.add(b`${He(y,"gl_Position = transformPosition(proj, view, position);")}`),s.main.add(b`fragColor = vec4(0.0);`)}return e}const DD=Nt(),yy=v(),$D=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:yg,build:Jb},Symbol.toStringTag,{value:"Module"}));let ID=class extends Ht{constructor(e,t,s){super(e,t,new Bt($D,()=>X(()=>Promise.resolve().then(()=>zN),void 0,import.meta.url)),s,ew),this.type="TerrainTechnique",this.useStencil=!1}initializePipeline(e){return this._stencilPipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}_createPipeline(e,t){const{renderOccluded:s,output:r}=e,n=e.backfaceCullingEnabled&&!s;return Qt({blending:s?z_:null,culling:n?A1:null,depthTest:s?null:{func:ji.LESS},depthWrite:s?null:D1,colorWrite:Jt,stencilTest:t?wS(q_.IntegratedMeshMaskExcluded):null,drawBuffers:r===D.Depth?{buffers:[O1.NONE]}:null})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}};const ew=new Map([[Ae.POSITION,0],[Ae.UV0,1],[Ae.NORMALCOMPRESSED,2]]);let LD=class{constructor(){this.geometry=new pD,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureOpacity=1,this._textureRef=new Yb(()=>this._tile.surface.fadeDuration),this.overlay=new gD,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new _D,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),Ii&&this.tile.intersectsClippingArea)for(let t=0;t<4;++t)F(this.geometry.getEdgeCount(t)===this.geometryState.edgeResolutions[t]+1)}_calculateEdgeResolution(e,t){var l;const s=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!s.surface.isGlobal){const h=s.surface.extent;if(h!=null&&(e===0&&s.extent[3]>h[3]||e===1&&s.extent[2]>h[2]||e===2&&s.extent[1]<h[1]||e===3&&s.extent[0]<h[0]))return r}const n=s.level,a=cr[e];if(!t)return F(((l=s.surface)==null?void 0:l.rootTiles)==null||s.surface.updatingRootTiles||!s.shouldHaveNeighbor(a)),r;if(t.loaded){const h=t,d=h.renderData.geometryState,u=n-h.level;if(F(u>=0),u===0){const f=d.numVerticesPerSide-1;return Math.max(f,r)}const p=2**u,_=d.edgeResolutions[(e+2)%4]/p;return Math.max(1,_)}F(!t.leaf);let o=r;return t.forAllSubtreeOnSide(A_(a),h=>h===s||(h.loaded?(o=Math.max(o,2**(h.level-n)),!0):(F(!h.leaf),!1))),o}updateNeighborData(){var a;const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,s=o=>(o.loaded||o.level===e.level)&&(o==null?void 0:o.intersectsClippingArea),r=t.edgePeerNeighbors,n=t.edgePeerNeighborSamplerVersions;for(let o=0;o<4;++o){const l=e.findNeighborTile(cr[o],s),h=Ua(e,l),d=((a=h==null?void 0:h.renderData)==null?void 0:a.geometryState.samplerDataVersion)??-1,u=r[o],p=h!==Ua(e,u),_=n[o]!==d;Ii&&l&&(F(e.level>=l.level),F(e.level-l.level<=Zt)),r[o]=l,(p||_)&&(n[o]=d,this._markEdgeDirty(o));const f=t.edgeResolutions[o],g=this._calculateEdgeResolution(o,l);F(Vh(g)),F(g>=1),t.edgeResolutions[o]=g,f!==g&&this._markEdgeResolutionDirty(o)}for(let o=0;o<4;++o){const l=e.findNeighborTile(Kd[o],s);t.cornerPeerNeighbors[o]=l;const h=Ua(e,r[o]),d=Ua(e,r[(o+1)%4]),u=Ua(e,l);Ks[o]=u,Ks[(o+1)%4]=d,Ks[(o+2)%4]=e,Ks[(o+3)%4]=h,F(Ks.some(g=>(g==null?void 0:g.loaded)||g===e));const p=Ks.reduce((g,y)=>Math.min(g,(y==null?void 0:y.level)??1/0),1/0);Ks.forEach((g,y)=>{g&&(g==null?void 0:g.level)>p&&(Ks[y]=null)}),F(Ks.some(g=>(g==null?void 0:g.loaded)||g===e));const _=t.cornerNeighborCornerTiles,f=t.cornerNeighborCornerTileSamplerVersions;for(let g=0;g<4;++g){const y=Ks[g],w=(y==null?void 0:y.renderData.geometryState.samplerDataVersion)??-1,x=4*o+g,T=_[x]!==y,C=!T&&f[x]!==w;(T||C)&&(_[x]=y,f[x]=w,this._markCornerDirty(o))}Ii&&F(vg.some(g=>{var y;return((y=_[4*o+g])==null?void 0:y.loaded)||_[4*o+g]===e}))}Ii&&F(this.geometryState.edgeResolutions.every(o=>o>0));for(let o=0;o<4;++o)Ks[o]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;Ii&&F(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every(_=>_>0)),this.intersectionData=null;const{tile:t,_vao:s,geometry:r,geometryState:n}=this,a=!s||!1||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,o=this.dirtyEdgeResolutions!==0,l=n.edgeResolutions.reduce((_,f)=>_+f+1,0),h=a||o&&l>((r==null?void 0:r.maxEdgeVertexCount)??0),d=!h&&o,u=!d&&(this.dirtyEdges!==0||o),p=!u&&this.dirtyCorners!==0;h?(this.releaseGeometry(),this._createGeometry(e)):d?t.updateEdgeElevationsAndResolutions():u||p?t.updateEdgeElevations():p?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=We(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,s,r){const n=t?ai.RGBA:ai.RGB;return this._texture!=null&&(s===zt.FADING&&this._tile.surface.fadeDuration>0&&this._isTextureVisible(this._texture)||this._texture.descriptor.width!==e||this._texture.descriptor.pixelFormat!==n)&&this.releaseTexture(),this._texture==null&&(this._texture=r(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture!=null&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}reuseTexture(e,t){return!(!e||!this._texture)&&(e.setTextureReference(new Eu(this._texture,zt.FADING,t,this._textureOpacity,0,1)),!0)}get numVerticesPerSideChanged(){return!!(this._modifiedFlags&VD)}get samplerDataChanged(){return!!(this._modifiedFlags&FD)}get clippingAreaChanged(){return!!(this._modifiedFlags&UD)}get wireframeChanged(){return!!(this._modifiedFlags&zD)}get dirtyEdges(){return this._modifiedFlags>>Up&15}get dirtyCorners(){return this._modifiedFlags>>zp&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>qp&15}_markCornerDirty(e){const t=1<<e<<zp;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<Up;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<qp;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<zp|15<<Up|15<<qp}updateGeometryState(){const e=this._elevationInfo,t=this.tile,s=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.minimumVerticesPerSide,r=Math.max(s,5);let n=t.clippingArea;t.intersectsClippingArea&&!t.withinClippingArea||(n=null);const a=this.geometryState;let o=!1;a.numVerticesPerSide!==r&&(this._modifiedFlags|=1,a.numVerticesPerSide=r,a.samplerDataVersion++,o=!0),e.changed&&(this._modifiedFlags|=2,a.samplerData=e.samplerData,a.samplerDataVersion++,o=!0),Gv(a.clippingArea,n)||(this._modifiedFlags=4,a.clippingArea=n,o=!0);const l=t.surface.wireframe;return a.wireframe!==l&&(this._modifiedFlags=8,a.wireframe=l,o=!0),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=o),o&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometry.vertexAttributes,s=this.geometry.indices,r=e.gl;this._vao=new ua(e,ew,new Map([["geometry",ca(t.layout)]]),new Map([["geometry",Ts.createVertex(e,r.STATIC_DRAW,t.buffer)]]),Ts.createIndex(e,r.STATIC_DRAW,s)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=Zn.Immediate){(e==null?void 0:e.texture)===this._texture?this._textureOpacity=e.opacities[0]:this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_isTextureVisible(e){var t,s;return((t=this._textureRef.current)==null?void 0:t.texture)===e||((s=this._textureRef.next)==null?void 0:s.texture)===e&&this._textureRef.fadeFactor<1}get _elevationInfo(){var d;const e=this.geometryState.samplerData,t=this.tile.layerInfo[xe.ELEVATION],s=t.length,r=new Array(s);let n=0,a=0,o=!1;for(let u=0;u<s;u++){const p=t[u],_=(d=p.upsampleInfo)==null?void 0:d.tile;if(_){const f=_.layerInfo[xe.ELEVATION][u].data,g=f&&f.samplerData;e&&e[n]===g||(o=!0),r[n++]=g,a=Math.max(a,_.lij[0])}else if(p.data){const f=this.tile.surface.layerViewByIndex(u,xe.ELEVATION);if(Qa(this.tile,f)){const g=p.data;e&&e[n]===g.samplerData||(o=!0),r[n++]=g.samplerData,a=this.tile.level}}}e!=null&&e.length!==n&&(o=!0);const l=n>0,h=l?r:null;return l&&(r.length=n),{changed:o,samplerData:h,maxTileLevel:a}}get estimatedGeometryMemoryUsage(){var t,s,r;const e=((t=this.intersectionData)==null?void 0:t.estimatedMemoryUsage)??0;return(((s=this.geometry.indices)==null?void 0:s.byteLength)??0)+(((r=this.geometry.vertexAttributes)==null?void 0:r.byteLength)??0)+e}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!Ii)return;const e=this.tile;if(!e.loaded||!e.intersectsClippingArea||e.level===0)return void F(e==null?void 0:e.loaded);const t=e.surface.extent;if(t!=null&&!e.intersectsExtent(t))return;const s=cr.map((o,l)=>t!=null&&(l<2?-1:1)*(e.extent[3-l]-t[3-l])<0),r=e.level;F(this.dirtyCorners===0),F(this.dirtyEdges===0),F(this.dirtyEdgeResolutions===0),F(!this.numVerticesPerSideChanged),F(!this.samplerDataChanged),F(!this.clippingAreaChanged),F(!this.wireframeChanged);const n=Kd.map(o=>e.findNeighborCornerTileExact(o,l=>!l.intersectsClippingArea||l.loaded||l.level===e.level)??null).map(o=>o!=null&&o.intersectsClippingArea?o:null),a=this.geometryState;for(let o=0;o<4;++o){const l=a.cornerPeerNeighbors[o],h=n[o];F(h===l,`Tile[${e.lij}].corner[${o}] out of date: cur=[${l==null?void 0:l.lij}] exp=[${h==null?void 0:h.lij}]`)}cr.forEach((o,l)=>{if(s[l])return;const h=e.findNeighborTile(o,me=>(me.level===r||(me==null?void 0:me.loaded))&&(me==null?void 0:me.intersectsClippingArea));if(!h){const me=!e.surface.updatingRootTiles&&e.surface.rootTiles!=null&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(o);return void F(!me)}F(h.loaded||h.level===e.level),F(h===this.geometryState.edgePeerNeighbors[l]);const d=r-h.level;if(!h.loaded)return F(!h.leaf),void F(d===0);const u=h.renderData;F(e.isEdgeNeighbor(h,o)),F(d>=0);const p=2**d;if(d<0)return void F(!1);const _=e.renderData,f=_.geometry,g=_.localOrigin,y=f.getEdgeCount(l),w=f.numVerticesPerSide-1,x=u.geometry;if(!x)return void F(!1);const T=u.localOrigin,C=this.geometryState.edgePeerNeighbors[l];if(C!=null&&C.loaded){const me=C.renderData;F(_.geometryState.edgePeerNeighborSamplerVersions[l]===me.geometryState.samplerDataVersion),F(this.geometryState.edgePeerNeighborSamplerVersions[l]===me.geometryState.samplerDataVersion)}const S=(l+2)%4,P=x.getEdgeCount(S),M=y-1,$=P-1;F(M*p===$,`Tile[${e.lij}]:e${l},res=${M} edgeRes mismatch with Neighbor[${h.lij}]:e${S},res=${$} (expected:${M*p})`);const O=e.extent,N=o===mt.NORTH||o===mt.SOUTH,U=P-1,L=U>>d,G=y-1;if(L<1)return void F(G===1);F(L===G),F(Vh(L));const A=x.numVerticesPerSide-1;F(d>0||L===Math.max(A,w));const R=e.getNeighborEdgeStartVertexIndex(l,h);F(0<=R&&R<p);const ee=R*L;F(0<=ee&&ee<=U-L);let z=0,V=ee;f.getEdgeVertexPosition(l,Or,g,0),f.getEdgeVertexPosition(l,Rr,g,y-1);const Y=ki(Or,Rr),le=Math.max(ND,1e-4*Y);for(let me=0;me<=L;++me){f.getEdgeVertexPosition(l,Or,g,z),x.getEdgeVertexPosition(S,Rr,T,V);const te=me/L,he=N?O[0]+te*(O[2]-O[0]):o===mt.WEST?O[0]:O[2],oe=N?o===mt.SOUTH?O[1]:O[3]:O[1]+te*(O[3]-O[1]),K=e.surface.extent;if(K==null||fC(K,he,oe)){const we=ws(Or,Rr),Oe=qi(Or)-rs.radius,se=qi(Rr)-rs.radius,_e=we<le;if(!_e){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${l}[${z}/${y}] and [${h.lij}].edge${S}[${V}/${P}]`),K!=null&&console.warn("  surface extent= ",K," x,y=",he,",",oe);const Ye=v();Te(Ye,_.localOrigin,u.localOrigin),qi(Ye)>0&&console.warn(`   localOrigins: ${_.localOrigin} vs ${u.localOrigin} d=${qi(Ye)} [${Ye}]`),(()=>{const k=ta(Or),tt=ta(Rr);e.updateEdgeElevations(),h.updateEdgeElevations(),f.getEdgeVertexPosition(l,Or,g,z),x.getEdgeVertexPosition(S,Rr,T,V);const B=v();St(B,Or,k),qi(B)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${k} vs ${Or} d=${qi(B)} [${B}]`),St(B,Rr,tt),qi(B)>0&&console.warn(`  XXX Neighbor[${h.lij}] edge out of date: ${tt} vs ${Rr} d=${qi(B)} [${B}]`)})();const Ze=f.getEdgeCount(l),Ct=x.getEdgeCount(P);F(_e,`Mismatch in tile [${e.lij}].edge[${l}][${z}/${Ze}] vs neighbor [${h.lij}].edge[${S}][${V}/${Ct}] ${Qr(Or)} vs ${Qr(Rr)}  dist=${we} h(t|n|d)=${Oe}|${se}|${se-Oe}`)}f.getEdgeNormal(l,So,z),x.getEdgeNormal(S,Po,V),ae(vy,So),ae(by,Po);const Qe=ce(vy,by),Xe=1-Qe<.01||!1||e===h;if(!Xe){const Ye=v();St(Ye,So,Po);const Ze=()=>`Mismatch in tile edge normal ${gf(e.lij)} (${z}/${y-1}) edge ${l} vs neighbor ${gf(h.lij)}  (${V}/${P-1}) nedge ${S} :${Qr(So)} vs ${Qr(Po)}  dot = ${Qe} : ${Qr(Ye)}`;console.warn("Mismatch in tile edge normal: ",Ze());{e.updateEdgeElevations(),h.updateEdgeElevations();const Ct=v(),k=v();f.getEdgeNormal(l,Ct,z),x.getEdgeNormal(S,k,V),Uh(So,Ct)||console.warn("Missing update in tile normal: ",Qr(So)," => ",Qr(Ct)),Uh(Po,k)||console.warn("Missing update in neighbor normal: ",Qr(Po)," => ",Qr(k))}F(Xe,Ze())}}z+=1,V+=1}})}};const Or=v(),Rr=v(),So=v(),Po=v(),vy=v(),by=v(),ND=1,Ks=[null,null,null,null];function Ua(i,e){return e!=null&&e.loaded||e===i?e:null}const VD=1,FD=2,UD=4,zD=8,Up=4,zp=8,qp=12,vg=[0,1,2,3];let bg=class{get updating(){return!!this._tileRequested}init(e,t,s,r){this.tile=e,this._layerIdx=t,this._layerClass=s,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,s),this._tileRequested=null;const n=this._findAncestorWithData();this._setUpsampleTile(n)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,zt.FADING,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e!=null?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){var w;const e=this._layerIdx,t=this._layerClass,s=this.tile.surface.layerViewByIndex(e,t),{minLevel:r,maxLevel:n}=s.dataLevelRange,a=this._desiredMinLevelDelta,o=this._progressiveLevelModulo+a,l=this._scaleRangeEnabled?Qa:()=>!0;let h=this.tile;const d=h.level;let u;const p=this._tileLayerInfo.upsampleInfo,_=((w=p==null?void 0:p.tile)==null?void 0:w.level)??-1,f=p!=null&&_-d>=a,g=vD(s),y=s.type==="vector-tile-3d"?s.schemaHelper:null;for(;h&&l(h,s)&&h.level>=r;){const x=h.level,T=d-x,C=h.layerInfo[t][e];if(C.data&&T>=a){(!f||x>_)&&this._setUpsampleTile(h),C.dataInvalidated&&(u=h);break}const S=(y==null?void 0:y.getLevelRowColumn(h.lij))??h.lij;if((g==null?void 0:g.getAvailability(S[0],S[1],S[2]))!=="unavailable"&&x<=n&&!C.data&&!C.dataMissing&&((!u||h.level===r||x%h1==0||d-u.level<a)&&(u=h),T>=o))break;h=h.parent}if(u!=null&&d-u.level<a)if(p)u=null;else{const x=this._findAncestorWithData();x!=null&&(this._setUpsampleTile(x),u=x.layerInfo[t][e].dataInvalidated?x:null)}return u}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let s;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;s=r}return s}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,zt.FADING,t)}get test(){}},qD=class extends bg{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw wy}get _progressiveLevelModulo(){throw wy}dispose(){}};const wy=new Error("Abstract method called on TileAgent"),cs=new qD;let HD=class extends bg{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}};function BD(i){return i.type==="elevation"}let GD=class extends bg{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return h1}};function kD(i){return i.type==="map"}var $i;(function(i){i[i.INSIDE=0]="INSIDE",i[i.INTERSECTS=1]="INTERSECTS",i[i.OUTSIDE=2]="OUTSIDE"})($i||($i={}));let Id=class{constructor(){this.waitingAgents=new Lt,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}get upsampleInfo(){return this._upsampleInfo}static acquire(e){const t=Hp.acquire();return t._init(e),t}release(){this.dispose(),Ld.delete(this),Hp.release(this)}dispose(){this.loadingAgent=We(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=ol(this._data)}static prune(){Hp.prune(0)}_init(e){this.waitingAgents.clear(),this._data=ol(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=ha(this.requestAbort),this.requestPromise=null}_unsetUpsampleInfo(){var e;this._upsampleInfo&&((e=this._upsampleInfo.tile)==null||e.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){var s;if(e!==t&&t!=null){if(this._upsampleInfo==null)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;(s=this._upsampleInfo.tile)==null||s.unrefMapData()}t.refMapData(),PD(e,t,this._upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){ol(this._data),this._data=e}};const Hp=new Ya(Id,null,()=>{}),Ld=new Map;function jD(){Ld.size>0&&(console.log(`${Ld.size} live TilePerLayerInfo allocations:`),Ld.forEach(i=>console.log(i,`
`)))}var ne;(function(i){i[i.NONE=0]="NONE",i[i.SPLIT=1]="SPLIT",i[i.ELEVATION=2]="ELEVATION",i[i.MERGE=4]="MERGE",i[i.GEOMETRY=8]="GEOMETRY",i[i.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",i[i.TEXTURE_FADING=32]="TEXTURE_FADING"})(ne||(ne={}));const WD=.1;let wg=class{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=mi(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=mi(),this.centerAtSeaLevel=v(),this._center=[v(),wr(),v()],this.up=Yx(),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=0,this._rasterTileMemory=0,this._vectorTileMemory=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=v(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){xg.prune(0),Cg.prune(0),Id.prune()}get _cached(){return!this.leaf&&this._mapDataRefCount<=0}get withinClippingArea(){return this._withinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[Ut.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent,t=(e==null?void 0:e.frustumVisibility)??$i.INTERSECTS;this._frustumVisibility=t===$i.INSIDE?$i.INSIDE:t===$i.OUTSIDE?$i.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);const s=this._frustumVisibility!==$i.OUTSIDE&&this._intersectsClippingArea;s!==this._visible&&(this._visible=s,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,s,r,n){this._lij[0]=e,this._lij[1]=t,this._lij[2]=s,this.ellipsoid=Ot(n.tilingScheme.spatialReference),n.tilingScheme.getExtent(e,t,s,this.extent),n.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,n.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[Ut.MIDDLE][3]=0,this.elevationLevel=e,r&&!Number.isNaN(r.elevationBoundsMin)?(this._elevationBoundsMin=r.elevationBoundsMin,this._elevationBoundsMax=r.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=r,this.clearChildren(),this._surface=n,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const a of Bo){const o=n.numLayers(a),l=this.layerInfo[a];for(const h of l)h.release();l.length=o;for(let h=0;h<o;h++)l[h]=Id.acquire(this._surface.upsampleInfoPool),a===xe.ELEVATION&&this.findElevationBoundsForLayer(h,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(n.tilingScheme.pixelSize,sh)}dispose(){ti(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key),this.layerInfo.forEach(e=>{e.forEach(t=>t.release()),e.length=0}),this._parent=null,this.clearChildren(),this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._cached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this._cached){const e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}setMemoryDirty(){this._usedMemory=0}get usedMemory(){return this._ensureUsedMemory()+(this._cached?0:this._mapTileMemory)}get _cachedMemory(){return this._ensureUsedMemory(),this._cached?this._mapTileMemory:0}get _mapTileMemory(){return this._rasterTileMemory+this._vectorTileMemory}get _cpuImageMemorySize(){const t=this._surface.tilingScheme.pixelSize;return t*t*4}_ensureUsedMemory(){var t;if(this._usedMemory>0)return this._vectorTileMemory=this.layerInfo[xe.MAP].reduce((s,{data:r})=>s+(Vl(r)?r.usedMemoryPerReference:0),0),this._usedMemory;this._usedMemory=this._baseUsedMemory,this._rasterTileMemory=0,this._vectorTileMemory=0;for(const{data:s}of this.layerInfo[xe.MAP])Vl(s)?this._vectorTileMemory+=s.usedMemoryPerReference:this._rasterTileMemory+=this._getTerrainDataMemory(s);const e=this._cpuImageMemorySize;for(const s of this.layerInfo[xe.ELEVATION])this._usedMemory+=s.data?e:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._rasterTileMemory+=((t=this.renderData.texture)==null?void 0:t.usedMemory)??0),this._cached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemory),this._usedMemory}getUsedMemoryForLayer(e,t){const s=this.layerInfo[e][t];return s!=null&&s.data?e===xe.MAP?this._cached?0:this._getTerrainDataMemory(s.data):e===xe.ELEVATION?this._cpuImageMemorySize:0:0}_getTerrainDataMemory(e){return dT(e)?e.texture.usedMemory:uT(e)?e.memoryUsage:Vl(e)?e.usedMemoryPerReference:R_(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(e){const t=this._center[Ut.MIDDLE],s=e,r=t[0],n=t[1],a=t[2],o=s[2]*r+s[6]*n+s[10]*a+s[14];this.screenDepth=o<0?0:o/(s[3]*r+s[7]*n+s[11]*a+s[15])}shouldSplit(e,t,s){if(!this.visible||e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===$i.OUTSIDE))return ne.NONE;const r=this.level;Te(nd,At(this._center[Ut.MIDDLE]),t);let n=Hs(nd),a=nd,o=At(this._center[Ut.MIDDLE]);Te(Bp,this._center[Ut.TOP],t);const l=Hs(Bp);l<n&&(n=l,a=Bp,o=this._center[Ut.TOP]),Te(Gp,this._center[Ut.BOTTOM],t);const h=Hs(Gp);if(h<n&&(n=h,a=Gp,o=this._center[Ut.BOTTOM]),this._edgeLen2>n&&r<e.maxLod)return ne.SPLIT;const d=Math.sqrt(n),u=e.fovX*d*2,p=this._edgeLen/u,_=()=>{if(r<e.maxLod)return this.elevationLevel=r,ne.NONE;const M=r+Math.ceil(-Math.log2(e.relativeWidthLimit/p));return M!==this.elevationLevel?(this.elevationLevel=M,ne.ELEVATION):ne.NONE},f=s!=null?s-r:1/0;if(f<=.5)return _();const g=ce(this.up,nd),y=this._elevationBoundsMax-this._elevationBoundsMin,w=y/this.edgeLen;if(e.aboveGround&&g>0&&w<.001&&g/d-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-w>0)return ne.NONE;const x=s!=null?3-Math.min(f,2):1;if(p*x<e.relativeWidthLimit||r>=e.maxLod)return _();if(r<7)return ne.SPLIT;ie(ci,this.up,g),Te(ci,ci,a);const T=Hs(ci);if(T<=this.radius*this.radius)return ne.SPLIT;ie(ci,ci,this.radius/Math.sqrt(T)),ye(ci,ci,o),Te(ci,t,ci);const C=Math.min(1,(Math.abs(ce(ci,this.up))+.5*y+this._curvatureHeight)/Ce(ci)),S=WD/e.angledSplitBias,P=e.fovY*d*2;return C*(this._edgeLen/P*x)<S*e.relativeHeightLimit?ne.NONE:ne.SPLIT}createChildren(){const e=this._children,t=this.lij[0]+1,s=2*this.lij[1],r=2*this.lij[2];return e[0]=this.surface.createTile(t,s,r,this),e[1]=this.surface.createTile(t,s,r+1,this),e[2]=this.surface.createTile(t,s+1,r,this),e[3]=this.surface.createTile(t,s+1,r+1,this),e}clearChildren(){this._children[0]=this._children[1]=this._children[2]=this._children[3]=null}get loaded(){var e;return((e=this.renderData)==null?void 0:e.hasGeometry)??!1}load(){this.refMapData();for(const e of Bo)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(e){this.renderData&&this.unrefMapData(),e.unloadTile(this);for(const t of Bo){const s=this.layerInfo[t];for(const r of s)r.loadingAgent&&r.loadingAgent!==cs&&(rd(r.loadingAgent),r.loadingAgent=null),r.pendingUpdates=0}this.resetPendingUpdate(ne.GEOMETRY),this.resetPendingUpdate(ne.TEXTURE_NOFADING),this.resetPendingUpdate(ne.TEXTURE_FADING)}unloadMapData(){const e=this.layerInfo[xe.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==cs&&(rd(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0,t.invalidateSourceData();this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(Ga(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,s=this._withinClippingArea;e!=null?(this._intersectsClippingArea=this.intersectsExtent(e),this._withinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._withinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=s&&this._withinClippingArea,n=!(s||t||this._withinClippingArea||this._intersectsClippingArea);return!this.renderData||r||n||this.setPendingUpdate(ne.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const s=this.layerInfo[t][e];return!(!(s!=null&&s.data)||s.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of Bo){const t=this.layerInfo[e];for(const s of t)if(s.loadingAgent&&s.loadingAgent!==cs&&s.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(ne.SPLIT)||e!==xe.ELEVATION&&!this.loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,e===ne.SPLIT||e===ne.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,s){const r=this.layerInfo[t][e];if(r.waitingAgents.has(s))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),s.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(s),r.data&&!r.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),s.tile.lij.toString(),t,e);const o=Vl(r.data);return s.dataArrived(this,o),!0}if(r.requestPromise)return!0;ha(r.requestAbort),r.requestAbort=new AbortController;const n=this._surface.requestTileData(this,e,t,r.requestAbort);if(!n)return r.requestAbort=null,!1;const a=()=>{r.requestPromise===n&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=n,n.then(a,a),!0}get leaf(){return this._children[0]==null}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return Hs(Te(ci,At(this._center[Ut.MIDDLE]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const s=this.extent;return e>=s[0]&&t>=s[1]&&e<=s[2]&&t<=s[3]}unrequestLayerData(e,t,s){const r=this.layerInfo[t][e],n=r.waitingAgents,a=n.removeUnordered(s)!=null;ti(a,"agent has not requested this piece of map data"),n.length<1&&(r.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,s){const r=Vl(s),n=this.layerInfo[t][e];n.data=s,n.dataInvalidated=!1,n.waitingAgents.forAll(a=>a.dataArrived(this,r)),n.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t){const s=this.layerInfo[t][e];s.dataMissing=!0,s.waitingAgents.forAll(r=>r.dataMissing()),s.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,s){switch(s&&this.forEachLoadedNeighbor(r=>r.updateRenderData(e,t)),e){case xe.MAP:return this._updateTexture(t);case xe.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===zt.FADING?ne.TEXTURE_NOFADING:ne.TEXTURE_FADING),this.setPendingUpdate(e===zt.FADING?ne.TEXTURE_FADING:ne.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(ne.GEOMETRY);for(const e of this.layerInfo[xe.ELEVATION])e.pendingUpdates|=ne.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let s=1/0,r=-1/0;const n=this.layerInfo[xe.ELEVATION];let a=!0;for(const o of n)o.elevationBounds!=null&&(s=Math.min(s,o.elevationBounds.min),r=Math.max(r,o.elevationBounds.max),o.elevationBounds.hasNoDataValues||(a=!1));a&&(s=Math.min(s,0),r=Math.max(r,0)),e===s&&t===r||(this._elevationBoundsMin=s,this._elevationBoundsMax=r,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax,s=.5*(e+t),r=this._center;ie(ci,this.up,s),ye(At(r[Ut.MIDDLE]),this.centerAtSeaLevel,ci),ie(ci,this.up,e),ye(r[Ut.TOP],this.centerAtSeaLevel,ci),ie(ci,this.up,t),ye(r[Ut.BOTTOM],this.centerAtSeaLevel,ci)}findElevationBoundsForLayer(e,t){const s=this.layerInfo[xe.ELEVATION][e],r=this.elevationLevelDelta,n=Math.max(this.elevationLevel-r,0),a=s.elevationBounds;if(a!=null&&a.level>=t&&a.level<=n)return;const o=this._surface.layerViewByIndex(e,xe.ELEVATION);if(!Qa(this,o))return;const l=XD;let h=!1;const d=s.data;if(d&&d.level<=n){const u=s.data;l.min=u.samplerData.data.minValue,l.max=u.samplerData.data.maxValue,l.hasNoDataValues=u.samplerData.data.hasNoDataValues,l.level=this.level,h=!0}else{let u,p,_=0;for(let f=this._parent;f&&(!p||_<r)&&(_=this.elevationLevel-f.level,u=p||u,p=f.layerInfo[xe.ELEVATION][e].data,!(!p&&u&&f.level<=n));f=f.parent);p=p||u,p&&(p.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],l),l.min!==1/0&&(l.level=p.level,h=!0))}h&&(s.elevationBounds==null&&(s.elevationBounds=new il),s.elevationBounds.copyFrom(l))}modifyLayers(e,t,s){const r=this.layerInfo[s];for(const o of r)o.loadingAgent&&o.loadingAgent!==cs&&(rd(o.loadingAgent),o.loadingAgent=null),o.waitingAgents.clear();for(let o=0;o<r.length;++o)e[o]===void 0&&r[o].release();const n=new Array(...r),a=t.length;r.length=a;for(let o=0;o<a;o++){const l=t[o];r[o]=l>-1?n[l]:Id.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,zt.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const s of t)s.loadingAgent===cs&&(s.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of Bo){const t=this._isSuspended(e);for(const s of this.layerInfo[e])s.loadingAgent&&s.loadingAgent!==cs&&(s.loadingAgent.setSuspension(t),s.loadingAgent===cs&&this.updateRenderData(e,zt.FADING))}}removeLayerAgent(e,t){const s=this.layerInfo[t][e];s.loadingAgent&&s.loadingAgent!==cs&&s.loadingAgent.dispose(),s.loadingAgent=null}agentDone(e,t){const s=this.layerInfo[t][e];s.loadingAgent=cs,s.data||s.upsampleInfo!=null||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return e.blendMode!=="normal"||gl(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,s){var r,n,a;for(let o=e;o<t;++o){const l=this._surface.layerViewByIndex(o,s);if(Lh(l)&&((r=l==null?void 0:l.layer)==null?void 0:r.blendMode)!=="normal"||gl((n=l==null?void 0:l.layer)==null?void 0:n.parent)&&this._hasBlendableAncestor((a=l==null?void 0:l.layer)==null?void 0:a.parent))return!0}return!1}_createOrUpdateAgents(e,t){const s=this.layerInfo[t];if(s.length===0)return;const r=this._isSuspended(t);for(let n=e;n<s.length;++n){const a=s[n],o=this._surface.layerViewByIndex(n,t);let l=!1;if(a.loadingAgent?Qa(this,o)?(a.loadingAgent!==cs&&a.loadingAgent.setSuspension(r),a.loadingAgent!==cs&&(l=a.loadingAgent.update())):a.dispose():Qa(this,o)&&(a.loadingAgent=QD(this,n,t,r),l=a.loadingAgent.startLoading(),l?a.loadingAgent===cs&&this.setPendingUpdate(ne.GEOMETRY):(rd(a.loadingAgent),a.loadingAgent=cs)),a.loadingAgent===cs&&this.updateRenderData(t,zt.FADING),!this._hasBlendModes(e,s.length,t)&&l&&o.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,s=Math.max(this.level-e,this.elevationLevelDelta-t),r=W(1+(this._maxTesselation>>s),2,this._maxTesselation+1),n=this.minimumVerticesPerSide;return Math.max(r,n)}_findLIJ(e,t){if(!e)return null;const s=this.surface.rootTiles;if(s!=null){for(const r of s)if(YD(r,e)){let n=r,a=e[0]-n.level-1;for(;a>=0&&!n.leaf&&!t(n);){const o=e[1]>>a&1,l=e[2]>>a&1;n=n.children[2*o+l],a--}return t(n)?n:null}}return null}findNeighborTile(e,t){const s=this._lij,r=this._getNeighborLIJ(s,e);return r?Nd(s,r)?t(this)?this:null:this._findLIJ(r,t):null}findCorner(e,t){const s=e===mt.NORTH_EAST?1:e===mt.NORTH_WEST?0:e===mt.SOUTH_WEST?2:3;let r=this;for(;r.children[0]&&(!t||!t(r));)r=r.children[s];return r}findNeighborCornerTileExact(e,t){var s;return((s=this.findNeighborTile(e,r=>t(r)||r.level===this.level))==null?void 0:s.findCorner(Jd(e),t))||null}forAllSubtreeOnSide(e,t){const s=e===mt.NORTH?[0,1]:e===mt.NORTH_EAST?[1]:e===mt.EAST?[1,3]:e===mt.SOUTH_EAST?[3]:e===mt.SOUTH?[2,3]:e===mt.SOUTH_WEST?[2]:e===mt.WEST?[0,2]:[0],r=n=>{const a=n.children;!t(n)&&a[0]&&s.forEach(o=>r(a[o]))};r(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const s=this.level-t.level;if(F(!Ii||s>=0),s===0)return 0;const r=2**s,n=!(1&~e),a=n?0:1,o=t.lij[a+1]*r,l=this._lij[a+1],h=l-o,d=n?r-1-h:h;return Ii&&(F(o<=l&&l<o+r),F(0<=d&&d<r)),d}forEachLoadedNeighbor(e){const t=this.level,s=r=>r.level===t||r.loaded;cr.forEach(r=>{const n=this.findNeighborTile(r,s);n!=null&&n!==this&&n.forAllSubtreeOnSide(A_(r),a=>!!a.loaded&&(e(a,r),!0))}),Kd.forEach(r=>{var a;const n=(a=this.findNeighborTile(r,s))==null?void 0:a.findCorner(Jd(r),o=>o.loaded);F(!n||t_(this,n,r)),n!=null&&n.loaded&&e(n,r)})}_getNeighborLIJ(e,t){const s=ff(t)?-1:yf(t)?1:0,r=vf(t)?-1:bf(t)?1:0,n=[e[0],e[1]+s,e[2]+r];return n[1]<0?null:this.surface.isGlobal?this._wrapLIJ(n):n[2]<0?null:n}_wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}isEdgeNeighbor(e,t){if(e==null)return!1;if(this.level===0&&e.level===0&&(this._eastEnd&&e._westEnd&&t===mt.EAST||this._westEnd&&e._eastEnd&&t===mt.WEST))return!0;const s=Math.max(1e-6*(this.extent[2]-this.extent[0]),1);switch(t){case mt.NORTH:return Us(this.extent[3],e.extent[1],s);case mt.SOUTH:return Us(this.extent[1],e.extent[3],s);case mt.EAST:return Us(this.extent[2],e.extent[0],s)||Us(this.extent[2],-e.extent[0],s);case mt.WEST:return Us(this.extent[0],e.extent[2],s)||Us(this.extent[0],-e.extent[2],s)}}get _eastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get _westEnd(){return this._lij[2]===0}checkGeometryWaterproofness(){var e;xm&&(F(this.loaded),(e=this.renderData)==null||e.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,s=this.surface.rootTilesExtent,r=.25*(t[2]-t[0]);if(ff(e)&&t[3]+r>=s[3]||yf(e)&&t[1]-r<=s[1])return!1;const n=this.surface.isGlobal;return!(!n&&vf(e)&&t[0]-r<=s[0])&&!(!n&&bf(e)&&t[2]+r>=s[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;ue(this._lastPOI,e);const s=this._center[Ut.MIDDLE],r=e[0]-s[0],n=e[1]-s[1],a=e[2]-s[2];this.distanceToPOI=r*r+n*n+a*a}};function QD(i,e,t,s){const r=t===xe.ELEVATION?Cg.acquire():xg.acquire();return r.init(i,e,t,s),r}function rd(i){i.dispose(),BD(i)?Cg.release(i):kD(i)&&xg.release(i)}const xg=new Ya(GD),Cg=new Ya(HD),XD=new il;var Ut;function YD(i,e){const t=i.lij,s=e[0]-t[0];return!(s<0)&&e[1]>>s===t[1]&&e[2]>>s===t[2]}function Nd(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]}function t_(i,e,t){return i!=null&&e!=null&&e!==i&&(i.level>=e.level?xy(i,e,t):xy(e,i,Jd(t)))}function xy(i,e,t){F(i.level>=e.level);const s=pT(t),r=mT(t),n=i.extent,a=e.extent,o=[s?n[0]:n[2],r?n[3]:n[1]],l=[s?a[2]:a[0],r?a[1]:a[3]],h=1e-5*(n[2]-n[0]),d=Us(o[0],l[0],h)||i.surface.isGlobal&&Us(o[0],-l[0],h),u=Us(o[1],l[1],h);if(d&&u)return!0;if(i.level===e.level)return F(!1),!1;if(!d&&!u)return F(!1),!1;const p=d?Cy(a[1],a[3],n[1],n[3],h):Cy(a[0],a[2],n[0],n[2],h);return F(p),p}function Cy(i,e,t,s,r){return i-r<=t&&t<=s&&s<=e+r}(function(i){i[i.TOP=0]="TOP",i[i.MIDDLE=1]="MIDDLE",i[i.BOTTOM=2]="BOTTOM"})(Ut||(Ut={}));const nd=v(),Bp=v(),Gp=v(),ci=v(),ZD=65536;function KD(i,e){const{tile:t,geometry:s,geometryState:r}=i,{extentInRadians:n,surface:a}=t,{isWebMercator:o,renderer:l}=a,{numVerticesPerSide:h,wireframe:d}=r,u=h-1,p=(h-2)**2,_=o&&(e===Lr.HAS_SOUTH_POLE||e===Lr.HAS_BOTH_POLES),f=o&&(e===Lr.HAS_NORTH_POLE||e===Lr.HAS_BOTH_POLES),g=((_?1:0)+(f?1:0))*Vd*h,y=_w(r),w=p+g+4*y,x=l.tileGeometryCache.acquire(w);s.numVerticesPerSide=h,s.vertexAttributes=x,s.maxEdgeVertexCount=y;const{boundingBox:T}=s;du(T);const C=Sg(i);ui.update(u,n,C),e$(i),s.poleVerticesStartIndex=p;const S=JD(i,_,f);s.edgeVerticesStartIndex=p+g,Eg(i),Tg(i),ow(s,S,d),i.intersectionData=null}function JD(i,e,t){const{tile:s,localOrigin:r,geometry:n}=i,{extent:a,ellipsoid:o}=s,{boundingBox:l,numVerticesPerSide:h,vertexAttributes:d,poleVerticesStartIndex:u}=n,p=h-1,_=r[0],f=r[1],g=r[2],y=o.radius,w=a[1],x=a[3],T=[];let C=u;const S=(P,M)=>{const $=M*h;Qs(-_,-f,P*y-g,l),T.push(new y$(P===1,$,P===1?0:2,C,Vd));const O=sw(P===-1?w:x,y),N=P*Math.PI/2-O,U=.99*(P===1?1:-1),L=y+0,{position:G,uv0:A}=d,{typedBuffer:R,typedBufferStride:ee}=d.normalCompressed;for(let z=1;z<=Vd;++z){const V=O+N*(z/Vd),Y=Math.cos(V),le=Math.sin(V);for(let me=0;me<=p;me++){const te=me/p,he=ui.sinLonLUT[me],oe=ui.cosLonLUT[me]*Y,K=he*Y,we=le,Oe=oe*L-_,se=K*L-f,_e=we*L-g;Qs(Oe,se,_e,l),G.setValues(C,Oe,se,_e),fr(A,C,te,U),Zh(R,C,oe,K,we,ee),++C}}};return e&&S(-1,0),t&&S(1,p),T}function e$(i){const{tile:e}=i;if(!e.intersectsClippingArea)return;const{geometry:t,geometryState:s,localOrigin:r}=i,{numVerticesPerSide:n,samplerData:a}=s,o=n-2,l=n-1,{vertexAttributes:h,boundingBox:d}=t,u=h.position,p=h.uv0,{typedBuffer:_,typedBufferStride:f}=h.normalCompressed,{extent:g}=e,y=g[0],w=g[2],x=g[1],T=g[3],C=e.ellipsoid.radius,S=r[0],P=r[1],M=r[2],$=u.typedBuffer,O=u.typedBufferStride,N=1/l;let U=0;if(1<=o){const L=N,G=x*(1-L)+T*L,A=ui.sinLatLUT[1],R=ui.cosLatLUT[1];for(let ee=1;ee<=o;ee++){const z=ee*N,V=y*(1-z)+w*z,Y=ui.sinLonLUT[ee],le=ui.cosLonLUT[ee],me=C+vt(V,G,a),te=me*le*R-S,he=me*Y*R-P,oe=me*A-M;Qs(te,he,oe,d);const K=(ee-1)*O;$[K]=te,$[K+1]=he,$[K+2]=oe,fr(p,ee-1,z,L)}}for(let L=1;L<=o;L++){const G=L*N,A=x*(1-G)+T*G,R=ui.sinLatLUT[L],ee=ui.cosLatLUT[L],z=L+1,V=z*N,Y=x*(1-V)+T*V,le=ui.sinLatLUT[z],me=ui.cosLatLUT[z],te=ui.sinLonLUT[0],he=ui.cosLonLUT[0],oe=C+vt(y,A,a);let K=he*ee*oe-S,we=te*ee*oe-P,Oe=R*oe-M;const se=U*O;let _e=$[se],Qe=$[se+1],Xe=$[se+2];for(let Ye=1;Ye<=o;Ye++){const Ze=Ye*N,Ct=y*(1-Ze)+w*Ze,k=ui.sinLonLUT[Ye],tt=ui.cosLonLUT[Ye];let B=0,j=0,ge=0;if(Ye<o){const Ve=(U+1)*O;B=$[Ve],j=$[Ve+1],ge=$[Ve+2]}else{const Ve=ui.sinLonLUT[l],ft=ui.cosLonLUT[l],Vt=C+vt(w,A,a);B=ft*ee*Vt-S,j=Ve*ee*Vt-P,ge=R*Vt-M}const Se=K,Z=we,ve=Oe;K=_e,we=Qe,Oe=Xe,_e=B,Qe=j,Xe=ge;const H=B-Se,re=j-Z,be=ge-ve;let lt=0,ut=0,pt=0;if(L>1){const Ve=(U-o)*O;lt=$[Ve],ut=$[Ve+1],pt=$[Ve+2]}else{const Ve=ui.sinLatLUT[0],ft=ui.cosLatLUT[0],Vt=C+vt(Ct,x,a);lt=tt*ft*Vt-S,ut=k*ft*Vt-P,pt=Ve*Vt-M}const Ke=C+vt(Ct,Y,a),it=tt*me*Ke-S,Fe=k*me*Ke-P,Je=le*Ke-M;if(L<o){const Ve=U+o,ft=Ve*O;$[ft]=it,$[ft+1]=Fe,$[ft+2]=Je,Qs(it,Fe,Je,d),fr(p,Ve,Ze,V)}const ze=lt-it,rt=ut-Fe,fe=pt-Je;let Le=tt*ee,qe=k*ee,ot=R;ot*ot<.999&&(Le=be*rt-re*fe,qe=H*fe-be*ze,ot=re*ze-H*rt);const Xt=1/Math.sqrt(Le*Le+qe*qe+ot*ot);Zh(_,U,Le*Xt,qe*Xt,ot*Xt,f),++U}}}function t$(i){i.tile.intersectsClippingArea&&(Tg(i),Al(i),i.intersectionData=null)}function i$(i){i.tile.intersectsClippingArea&&(cw(i),Tg(i),Al(i),pw(i),i.intersectionData=null)}function s$(i){i.tile.intersectsClippingArea&&(iw(i),tw(i,!0),Al(i),i.intersectionData=null)}function Tg(i){i.tile.intersectsClippingArea&&(iw(i),tw(i))}function tw(i,e=!1){const{geometry:t,geometryState:s,tile:r,localOrigin:n}=i,{level:a,extent:o,extentInRadians:l,ellipsoid:h}=r,d=h.radius,u=l[0],p=l[2],_=l[1],f=l[3],{samplerData:g}=s,y=o[0],w=o[2],x=o[1],T=o[3],C=Sg(i),{boundingBox:S,vertexAttributes:P}=t,M=n[0],$=n[1],O=n[2],N=P.position,U=N.typedBuffer,L=N.typedBufferStride,G=P.uv0;for(let A=0;A<4;++A){const R=A===1||A===3,ee=s.edgeResolutions[A];F(Vh(ee));const z=ee+1,V=Ua(r,s.edgePeerNeighbors[A]);if(mw(r,V,A)){dw(i,A,V);continue}const Y=V!=null;F(!Y||V.level===r.level),F(!Y||Ur(r,V)<=0);const le=V==null?void 0:V.renderData,me=le==null?void 0:le.geometryState;if(Ii){const H=r.surface;if(!V&&H&&!H.updatingRootTiles){const re=cr[A],be=r.findNeighborTile(re,lt=>lt.loaded||lt.leaf||lt.level===r.level);be?be.intersectsClippingArea&&(F(!be.loaded),F(!be.leaf),F(be.level===a)):F((H==null?void 0:H.rootTiles)==null||!r.shouldHaveNeighbor(re))}}const te=A===1?o[2]:o[0],he=V==null?void 0:V.extent,oe=he&&R?A===1?he[0]:he[2]:te,K=A===0?o[3]:o[1],we=A===1?1:0,Oe=A===0?1:0,se=A===1?p:u,_e=A===0?f:_,Qe=Math.sin(se),Xe=Math.cos(se),Ye=Math.sin(_e),Ze=Math.cos(_e),Ct=me==null?void 0:me.samplerData,k=Y?(H,re,be)=>.5*(vt(H,re,g)+vt(be,re,Ct)):(H,re,be)=>vt(H,re,g),tt=t.outerEdgesOffsetAndLength[2*A+0],B=e&&z>3?z-3:1,j=g!=null&&g.some(H=>H!=null),ge=Ct!=null&&Ct.some(H=>H!=null),Se=j||ge,Z=1/ee,ve=tt;F(!he||Us(he[2]-he[0],o[2]-o[0])),(()=>{const H=A===1?-1:A===3?1:0,re=A===0?-1:A===2?1:0,be=(o[2]-o[0])*Z,lt=H*be,ut=re*be,pt=R?H*((p-u)*Z):0,Ke=R?0:re*Z,it=Oe,Fe=R?se+pt:se,Je=R?Math.sin(Fe):Qe,ze=R?Math.cos(Fe):Xe,rt=R?se-pt:se,fe=R?Math.sin(rt):Qe,Le=R?Math.cos(rt):Xe,qe=R?_e:C(it+Ke),ot=R?Ye:Math.sin(qe),Xt=R?Ze:Math.cos(qe),Ve=R?_e:C(it-Ke),ft=R?Ye:Math.sin(Ve),Vt=R?Ze:Math.cos(Ve);let Ei=0,as=0,os=0;{const Ue=0*Z,yt=R?te:y*(1-Ue)+w*Ue,oi=R?oe:yt,fi=R?x*(1-Ue)+T*Ue:K,Yt=R?se:u*(1-Ue)+p*Ue,ls=R?Qe:Math.sin(Yt),ho=R?Xe:Math.cos(Yt),kr=R?C(Ue):_e,_a=R?Math.sin(kr):Ye,jr=R?Math.cos(kr):Ze,Wr=d+k(yt,fi,oi);Ei=ho*jr*Wr,as=ls*jr*Wr,os=_a*Wr}let Mi=0,ei=0,Ft=0;{const Ue=1*Z,yt=R?te:y*(1-Ue)+w*Ue,oi=R?oe:yt,fi=R?x*(1-Ue)+T*Ue:K,Yt=R?se:u*(1-Ue)+p*Ue,ls=R?Qe:Math.sin(Yt),ho=R?Xe:Math.cos(Yt),kr=R?C(Ue):_e,_a=R?Math.sin(kr):Ye,jr=R?Math.cos(kr):Ze,Wr=d+k(yt,fi,oi);Mi=ho*jr*Wr,ei=ls*jr*Wr,Ft=_a*Wr}for(let Ue=1;Ue<z-1;Ue+=B){let yt=0,oi=0,fi=0;{const hs=(Ue+1)*Z,Sr=R?te:y*(1-hs)+w*hs,En=R?oe:Sr,Ni=R?x*(1-hs)+T*hs:K,Mn=R?se:u*(1-hs)+p*hs,_o=R?Qe:Math.sin(Mn),wc=R?Xe:Math.cos(Mn),Il=R?C(hs):_e,xc=R?Math.sin(Il):Ye,Ll=R?Math.cos(Il):Ze,go=d+k(Sr,Ni,En);yt=wc*Ll*go,oi=_o*Ll*go,fi=xc*go}const Yt=yt,ls=oi,ho=fi,kr=Mi,_a=ei,jr=Ft;Mi=Yt,ei=ls,Ft=ho;{const hs=ve+Ue,Sr=hs*L,En=kr-M,Ni=_a-$,Mn=jr-O;U[Sr]=En,U[Sr+1]=Ni,U[Sr+2]=Mn,Qs(En,Ni,Mn,S);const _o=Ue*Z;fr(G,hs,R?we:_o,R?_o:Oe)}const Wr=Ei,gx=as,fx=os;Ei=kr,as=_a,os=jr;const Dl=kr,$l=_a,co=jr,bc=1/Math.sqrt(Dl*Dl+$l*$l+co*co),Bg=co*bc;let uo=0,po=0,mo=0;if(Se&&Bg*Bg<.999){let hs=0,Sr=0,En=0;{const Ni=A===0?-1:1;hs=Ni*(Yt-Wr),Sr=Ni*(ls-gx),En=Ni*(ho-fx)}{const Ni=Ue*Z,Mn=R?te:y*(1-Ni)+w*Ni,_o=R?oe:Mn,wc=R?x*(1-Ni)+T*Ni:K,Il=R?se:u*(1-Ni)+p*Ni,xc=R?Qe:Math.sin(Il),Ll=R?Xe:Math.cos(Il),go=R?C(Ni):_e,Gg=R?Math.sin(go):Ye,kg=R?Math.cos(go):Ze;let Xu=Dl,Yu=$l,Zu=co;if(Y){const ga=d+vt(_o-lt,wc-ut,Ct),Nl=R?kg:Vt;Xu=(R?Le:Ll)*Nl*ga,Yu=(R?fe:xc)*Nl*ga,Zu=(R?Gg:ft)*ga}{const ga=d+vt(Mn+lt,wc+ut,g),Nl=R?kg:Xt,jg=(R?ze:Ll)*Nl*ga,Wg=(R?Je:xc)*Nl*ga,Qg=(R?Gg:ot)*ga;Y||(Xu=2*Dl-jg,Yu=2*$l-Wg,Zu=2*co-Qg);const Ku=A===3?-1:1,Xg=Ku*(Xu-jg),Yg=Ku*(Yu-Wg),Zg=Ku*(Zu-Qg);uo=En*Yg-Sr*Zg,po=hs*Zg-En*Xg,mo=Sr*Xg-hs*Yg;const Ju=1/Math.sqrt(uo*uo+po*po+mo*mo);uo*=Ju,po*=Ju,mo*=Ju}}}else uo=Dl*bc,po=$l*bc,mo=co*bc;t.setEdgeNormalFromValues(A,Ue,uo,po,mo)}})()}}function iw(i){uw(i)}function sw(i,e){return Math.PI/2-2*Math.atan(Math.exp(-i/e))}function r$(i,e,t,s){return sw(i*(1-s)+e*s,t)}function n$(i,e,t){return i*(1-t)+e*t}function Sg(i){const{tile:e}=i;if(e.surface.isWebMercator){const s=e.extent,r=e.ellipsoid.radius;return n=>r$(s[1],s[3],r,n)}const t=e.extentInRadians;return s=>n$(t[1],t[3],s)}function a$(i,e){const{tile:t,geometryState:s,geometry:r}=i,{extent:n,surface:a}=t,{wireframe:o}=s,l=n[0],h=n[1],d=n[2]-l,u=n[3]-h,{numVerticesPerSide:p,clippingArea:_}=s,f=_!=null?Math.max(0,(_[0]-l)/d):0,g=_!=null?Math.max(0,(_[1]-h)/u):0,y=_!=null?Math.min(1,(_[2]-l)/d):1,w=_!=null?Math.min(1,(_[3]-h)/u):1,x=(p-2)**2,T=_w(s),C=x+4*T,S=a.renderer.tileGeometryCache.acquire(C),{boundingBox:P}=r;du(P),r.numVerticesPerSide=p,r.vertexAttributes=S,r.maxEdgeVertexCount=T,r.minu=f,r.minv=g,r.maxu=y,r.maxv=w,o$(i),r.edgeVerticesStartIndex=x,Eg(i),Pg(i),ow(r,[],o),i.intersectionData=null}function o$(i){const e=i.tile;if(!e.intersectsClippingArea)return;const{geometry:t,geometryState:s,localOrigin:r}=i,{samplerData:n,clippingArea:a,numVerticesPerSide:o}=s,{surface:l,extent:h,ellipsoid:d}=e,{isWebMercatorOnPlateCarree:u}=l,p=a??Mg,_=h[0],f=h[1],g=h[2],y=h[3],w=Math.max(_,p[0]),x=Math.min(g,p[2]),T=Math.max(f,p[1]),C=Math.min(y,p[3]),S=d.radius,P=e.horizontalScale,M=o-1,$=o-2,{minu:O,minv:N,maxu:U,maxv:L,boundingBox:G,vertexAttributes:A}=t,R=A.position,ee=A.uv0,{typedBuffer:z,typedBufferStride:V}=A.normalCompressed,Y=r[0],le=r[1],me=r[2],te=R.typedBuffer,he=R.typedBufferStride;let oe=0;const K=W(f,T,C),we=u?(Math.PI/2-2*Math.atan(Math.exp(-K/S)))*S:K*P,Oe=1/M,se=W(f*(1-Oe)+y*Oe,T,C);let _e=we,Qe=u?(Math.PI/2-2*Math.atan(Math.exp(-se/S)))*S:se*P;for(let Xe=1;Xe<=$;Xe++){const Ye=Xe/M,Ze=W(f*(1-Ye)+y*Ye,T,C),Ct=W(Ye,N,L),k=Qe,tt=(Xe-1)/M,B=W(f*(1-tt)+y*tt,T,C),j=_e,ge=(Xe+1)/M,Se=W(f*(1-ge)+y*ge,T,C),Z=u?(Math.PI/2-2*Math.atan(Math.exp(-Se/S)))*S:Se*P,ve=W(ge,N,L);_e=Qe,Qe=Z;const H=W(_,w,x);let re=H*P,be=vt(H,Ze,n);const lt=1/M,ut=W(lt,O,U),pt=W(_*(1-ut)+g*ut,w,x);let Ke=ut,it=pt,Fe=pt*P,Je=vt(pt,Ze,n);if(Xe===1){const ze=Fe-Y,rt=_e-le,fe=Je-me,Le=0*he;te[Le]=ze,te[Le+1]=rt,te[Le+2]=fe,Qs(ze,rt,fe,G);const qe=W(lt,O,U);fr(ee,oe,qe,Ct)}for(let ze=1;ze<=$;ze++){const rt=Fe,fe=Je,Le=(ze+1)/M,qe=W(Le,O,U),ot=W(_*(1-Le)+g*Le,w,x),Xt=it;it=ot;{const ei=oe+1,Ft=ei*he;if(Xe===1||ze===$){const Ue=ot*P,yt=vt(ot,Ze,n);if(Xe===1&&ze<$){const oi=Ue-Y,fi=k-le,Yt=yt-me;te[Ft]=oi,te[Ft+1]=fi,te[Ft+2]=Yt,Qs(oi,fi,Yt,G),fr(ee,ei,qe,Ct)}Fe=Ue,Je=yt}else Fe=te[Ft]+Y,Je=te[Ft+2]+me}const Ve=Fe,ft=Je,Vt=re,Ei=be;re=rt,be=fe;const as=(oe-$)*he,os=Xe===1?vt(Xt,B,n):te[as+2]+me,Mi=vt(Xt,Se,n);if(Xe<$){const ei=oe+$,Ft=ei*he,Ue=rt-Y,yt=Z-le,oi=Mi-me;te[Ft]=Ue,te[Ft+1]=yt,te[Ft+2]=oi,Qs(Ue,yt,oi,G);const fi=Ke;Ke=qe,fr(ee,ei,fi,ve)}{const ei=Ve-Vt,Ft=j-Z,Ue=Ft*(ft-Ei),yt=ei*(os-Mi),oi=-Ft*ei,fi=Ue*Ue+yt*yt+oi*oi;if(fi===0)Zh(z,oe,0,0,1,V);else{const Yt=1/Math.sqrt(fi);Zh(z,oe,Ue*Yt,yt*Yt,oi*Yt,V)}}++oe}}}function l$(i,e){i.tile.intersectsClippingArea&&(nw(i),rw(i,!0),Al(i),i.intersectionData=null)}function h$(i,e){i.tile.intersectsClippingArea&&(cw(i),Pg(i),Al(i),pw(i),i.intersectionData=null)}function c$(i,e){i.tile.intersectsClippingArea&&(Pg(i),Al(i),i.intersectionData=null)}function Pg(i,e){i.tile.intersectsClippingArea&&(nw(i),rw(i,!1))}function rw(i,e){const{geometry:t,geometryState:s,localOrigin:r}=i,n=i.tile,{surface:a,extent:o}=n,{clippingArea:l,samplerData:h}=s,d=l??Mg,u=o[0],p=o[2],_=o[1],f=o[3],g=[f>d[3],p>d[2],_<d[1],u<d[0]],y=n.horizontalScale,w=aw(a.isWebMercatorOnPlateCarree,n.ellipsoid.radius,y),{minu:x,minv:T,maxu:C,maxv:S,boundingBox:P}=t,M=Math.max(u,d[0]),$=Math.min(p,d[2]),O=Math.max(_,d[1]),N=Math.min(f,d[3]),U=r[0],L=r[1],G=r[2];for(let A=0;A<4;++A){const R=A===1||A===3,ee=s.edgeResolutions[A];F(Vh(ee));const z=ee+1,V=g[A],Y=Ua(n,s.edgePeerNeighbors[A]);if(!V&&mw(n,Y,A)){dw(i,A,Y);continue}const le=Y!=null&&!V,me=Y==null?void 0:Y.renderData,te=me==null?void 0:me.geometryState;if(Ii&&(F(!le||Y.level===n.level),F(!le||Ur(n,Y)<=0),n&&!Y&&!a.updatingRootTiles)){const Z=cr[A],ve=n.findNeighborTile(Z,H=>H.loaded||H.leaf||H.level===n.level);a.updatingRootTiles||(ve?ve.intersectsClippingArea&&(F(!ve.loaded),F(!ve.leaf),F(ve.level===n.level)):F((a==null?void 0:a.rootTiles)==null||!n.shouldHaveNeighbor(Z)))}const he=W(A===1?p:u,M,$),oe=W(A===0?f:_,O,N),K=te==null?void 0:te.samplerData,we=e&&z>3?z-3:1,Oe=W(A===1?1:0,x,C),se=W(A===0?1:0,T,S),_e=le?(Z,ve)=>.5*(vt(Z,ve,K)+vt(Z,ve,h)):(Z,ve)=>vt(Z,ve,h),Qe=(p-u)/ee,Xe=R?A===1?Qe:-Qe:0,Ye=R?0:A===0?Qe:-Qe,Ze=-Xe,Ct=-Ye;let k=0,tt=0,B=0;{const Z=0/ee,ve=R?he:W(u*(1-Z)+p*Z,M,$),H=R?W(_*(1-Z)+f*Z,O,N):oe,re=_e(ve,H);k=ve*y,tt=w(H),B=re}let j=0,ge=0,Se=0;{const Z=1/ee,ve=R?he:W(u*(1-Z)+p*Z,M,$),H=R?W(_*(1-Z)+f*Z,O,N):oe,re=_e(ve,H);j=ve*y,ge=w(H),Se=re}for(let Z=1;Z<z-1;Z+=we){const ve=Z/ee,H=j,re=ge,be=Se;{const fe=R?Oe:W(ve,x,C),Le=R?W(ve,T,S):se,qe=H-U,ot=re-L,Xt=be-G;Qs(H,ot,Xt,P),t.setEdgeVertexFromValuesRawPositionUV(A,Z,qe,ot,Xt,fe,Le)}{const fe=(Z+1)/ee,Le=R?he:W(u*(1-fe)+p*fe,M,$),qe=R?W(_*(1-fe)+f*fe,O,N):oe,ot=_e(Le,qe);j=Le*y,ge=w(qe),Se=ot}const lt=j,ut=Se,pt=k,Ke=tt,it=B;k=H,tt=re,B=be;let Fe=0,Je=0,ze=0;if(R){const fe=ge-re,Le=ut-be,qe=Ke-re,ot=it-be,Xt=W(_*(1-ve)+f*ve,O,N),Ve=he+Ze,ft=Ve*y-H,Vt=vt(Ve,Xt,h)-be,Ei=A===3?-1:1;if(Fe=Ei*(-qe+fe)*Vt,Je=Ei*ft*(-ot+Le),ze=-Ei*ft*(-qe+fe),le){const as=he+Xe,os=as*y-H;Fe=(-qe+fe)*(Vt-(vt(as,Xt,K)-be)),Je=(ft-os)*(-ot+Le),ze=-(ft-os)*(-qe+fe)}}else{const fe=lt-H,Le=ut-be,qe=pt-H,ot=it-be,Xt=W(u*(1-ve)+p*ve,M,$),Ve=oe+Ct,ft=vt(Xt,Ve,h)-be,Vt=w(Ve)-re,Ei=A===2?-1:1;if(Fe=Ei*Vt*(-ot+Le),Je=Ei*(-qe+fe)*ft,ze=-Ei*Vt*(-qe+fe),le){const as=Xt,os=oe+Ye,Mi=w(os)-re;Fe=(-Vt+Mi)*(-ot+Le),Je=(-qe+fe)*(-ft+(vt(as,os,K)-be)),ze=-(-Vt+Mi)*(-qe+fe)}}const rt=1/Math.sqrt(Fe*Fe+Je*Je+ze*ze);t.setEdgeNormalFromValues(A,Z,Fe*rt,Je*rt,ze*rt)}}}function nw(i,e){uw(i)}function d$(i,e){return(Math.PI/2-2*Math.atan(Math.exp(-i/e)))*e}function u$(i,e){return i*e}function aw(i,e,t){return i?s=>d$(s,e):s=>u$(s,t)}function ow(i,e,t){const{numVerticesPerSide:s,vertexAttributes:r,maxEdgeVertexCount:n}=i,a=s-1,o=r.count,l=2*(s-3)*(s-3),h=4*(a+n-3),d=vg.reduce((g,y)=>g+(a+i.getEdgeCount(y)-3),0),u=e.reduce((g,y)=>g+a*(2*(y.latitudeResolution-1)+1),0),p=3*(t?2:1),_=(l+h+u)*p,f=o>=ZD?new Uint32Array(_):new Uint16Array(_);for(let g=0;g<_;++g)f[g]=0;i.indices=f,i.indexCount=(l+d+u)*p,i.poleIndicesStartIndex=l*p,i.edgeIndicesStartIndex=(l+u)*p,t?(_$(i),g$(i,e),hw(i)):(p$(i),m$(i,e),lw(i))}function p$(i){const{numVerticesPerSide:e,indices:t,vertexAttributes:s}=i,{position:r}=s,{typedBuffer:n,typedBufferStride:a}=r,o=e-2,l=e-3,h=0,d=e-3;let u=0;for(let p=0;p<l;++p){const _=p*o;for(let f=h;f<d;++f){const g=_+f,y=g+1,w=y+o,x=w-1;gw(g,y,w,x,a,n)?(t[u]=g,t[u+1]=y,t[u+2]=w,t[u+3]=w,t[u+4]=x,t[u+5]=g):(t[u]=g,t[u+1]=y,t[u+2]=x,t[u+3]=x,t[u+4]=y,t[u+5]=w),u+=6}}}function m$(i,e){const{numVerticesPerSide:t,indices:s,poleIndicesStartIndex:r}=i,n=t-1;let a=r;for(const o of e){const l=o.isNorth?1:2,h=o.isNorth?2:1,d=o.isNorth?3:4,u=o.isNorth?4:3;let p=i.getEdgeVertexIndex(o.connectedOuterEdgeOffset,0),_=1;for(let f=0;f<o.latitudeResolution;++f){const g=f===0?o.rowOffset:p+t;for(let y=0;y<n;y++){const w=g+y;s[a]=p,s[a+l]=p+1,s[a+h]=w,f<o.latitudeResolution-1?(s[a+d]=p+1,s[a+u]=w+1,s[a+5]=w,a+=6):a+=3,p+=_}p=g,_=1}}}function lw(i){const{indices:e,numVerticesPerSide:t,edgeIndicesStartIndex:s}=i,r=t-1,n=r-2;let a=s;for(let o=0;o<4;++o){const l=Og[o];let h=0,d=0;const u=i.getEdgeCount(o),p=l.count;F(p===r-1);const _=o===1||o===2,f=_?1:2,g=_?2:1,y=i.getEdgeFirstVertexIndex(o),w=1,x=l.vertex0Index,T=l.stride;for(;h<u-1||d<p-1;){const C=x+d*T,S=y+h*w,P=h<u-1,M=d<p-1,$=P&&(!M||(P?0+r*(h+.5)/(u-1):0)<=(M?1+n*(d+.5)/(p-1):0));$?++h:++d;const O=$?S+w:C+T;e[a]=C,e[a+f]=S,e[a+g]=O,a+=3}}i.indexCount=a}function _$(i){const{indices:e,numVerticesPerSide:t,vertexAttributes:s}=i,{position:r}=s,{typedBuffer:n,typedBufferStride:a}=r,o=t-2;let l=0;for(let h=0;h<t-3;++h){const d=h*o;for(let u=0;u<t-3;++u){const p=h*o+u,_=p+1,f=_+o,g=f-1,y=d+u,w=y+1,x=w+o;gw(y,w,x,x-1,a,n)?(sl(e,l,p,_,f),l+=6,sl(e,l,f,g,p)):(sl(e,l,p,_,g),l+=6,sl(e,l,g,f,_)),l+=6}}}function g$(i,e){const{indices:t,numVerticesPerSide:s,poleIndicesStartIndex:r}=i,n=s-1;let a=r;for(const o of e){const l=o.connectedOuterEdgeOffset;let h=i.getEdgeVertexIndex(l,0),d=1;for(let u=0;u<o.latitudeResolution;++u){const p=u===0?o.rowOffset:h+s;for(let _=0;_<n;_++)sl(t,a,h,h+1,p+_),a+=6,u<o.latitudeResolution-1&&(sl(t,a,h+1,p+_+1,p+_),a+=6),h+=d;h=p,d=1}}}function hw(i){const{indices:e,numVerticesPerSide:t,edgeIndicesStartIndex:s}=i,r=t-1,n=r-2;let a=s;for(let o=0;o<4;++o){const l=Og[o];let h=0,d=0;const u=i.getEdgeCount(o),p=l.count;F(p===r-1);const _=o===1||o===2,f=_?1:3,g=_?3:1,y=i.getEdgeFirstVertexIndex(o),w=1,x=l.vertex0Index,T=l.stride;for(;h<u-1||d<p-1;){const C=x+d*T,S=y+h*w,P=h<u-1,M=d<p-1,$=P&&(!M||(P?0+r*(h+.5)/(u-1):0)<=(M?1+n*(d+.5)/(p-1):0));$?++h:++d;const O=$?S+w:C+T;e[a]=C,e[a+f]=S,e[a+f+1]=S,e[a+g]=O,e[a+g+1]=O,e[a+5]=C,a+=6}}i.indexCount=a}function Eg(i){const{geometry:e,geometryState:t}=i,{edgeResolutions:s}=t,{numVerticesPerSide:r,edgeVerticesStartIndex:n}=e,a=r-2;let o=n;for(let l=0;l<4;++l){{const h=l===0||l===2,d=(l===0?a-1:0)*a+(l===1?a-1:0),u=(h?0:1)*a+(h?1:0),p=Og[l];p.vertex0Index=d,p.stride=u,p.count=a}{const h=s[l]+1;e.outerEdgesOffsetAndLength[2*l+0]=o,e.outerEdgesOffsetAndLength[2*l+1]=h,o+=h}}}function cw(i){Eg(i),i.geometryState.wireframe?hw(i.geometry):lw(i.geometry)}function dw(i,e,t){const{geometryState:s,geometry:r,tile:n,localOrigin:a}=i,o=e===1||e===3,l=s.edgeResolutions[e];F(Vh(l));const h=l+1,{boundingBox:d,minu:u,minv:p,maxu:_,maxv:f,vertexAttributes:g}=r,y=W(e===1?1:0,u,_),w=W(e===0?1:0,p,f),x=t.renderData,T=x.geometryState,C=x.geometry,S=(e+2)%4,P=C.getEdgeCount(S),M=n.getNeighborEdgeStartVertexIndex(e,t)*l,$=l*2**(n.level-t.level);F(T.edgeResolutions[S]===$),F(P-1===$);const O=x.localOrigin[0]-a[0],N=x.localOrigin[1]-a[1],U=x.localOrigin[2]-a[2],L=r.getEdgeFirstVertexIndex(e),G=g.position,A=G.typedBuffer,R=G.typedBufferStride,ee=g.normalCompressed,z=ee.typedBuffer,V=ee.typedBufferStride,Y=g.uv0,le=C.vertexAttributes,me=C.getEdgeFirstVertexIndex(S),te=le.position.typedBuffer,he=le.position.typedBufferStride,oe=le.normalCompressed.typedBuffer,K=le.normalCompressed.typedBufferStride;for(let we=1;we<h-1;++we){const Oe=L+we,se=me+(M+we),_e=Oe*R,Qe=se*he,Xe=te[Qe]+O,Ye=te[Qe+1]+N,Ze=te[Qe+2]+U;A[_e]=Xe,A[_e+1]=Ye,A[_e+2]=Ze,Qs(Xe,Ye,Ze,d);const Ct=Oe*V,k=se*K;z[Ct]=oe[k],z[Ct+1]=oe[k+1];const tt=we/l,B=o?y:W(tt,u,_),j=o?W(tt,p,f):w;fr(Y,Oe,B,j)}}function uw(i){var Ct;const{geometry:e,geometryState:t,localOrigin:s}=i,{clippingArea:r,samplerData:n}=t,{minu:a,minv:o,maxu:l,maxv:h,boundingBox:d,vertexAttributes:u}=e,p=i.tile,{surface:_,ellipsoid:f,extent:g,extentInRadians:y,horizontalScale:w}=p,x=((Ct=_.view)==null?void 0:Ct.viewingMode)==="local",T=f.radius;let C=0,S=0,P=0;const M=(k,tt,B)=>{const j=y[tt===0?1:3],ge=y[k===0?0:2],Se=Math.cos(j),Z=Math.sin(j),ve=Math.sin(ge),H=Math.cos(ge),re=T+B;C=H*Se*re,S=ve*Se*re,P=Z*re},$=x?(()=>{const k=r,tt=k!=null&&(g[3]>k[3]||g[2]>k[2]||g[1]<k[1]||g[0]<k[0]),B=aw(_.isWebMercatorOnPlateCarree,T,w);return(j,ge,Se)=>{const Z=j===0?g[0]:g[2],ve=ge===0?g[1]:g[3],H=tt?W(Z,k[0],k[2]):Z,re=tt?W(ve,k[1],k[3]):ve,be=Se;C=H*w,S=B(re),P=be}})():M;let O=0,N=0,U=0,L=0,G=0,A=0,R=0,ee=0,z=0;const V=x&&_.isWebMercatorOnPlateCarree,Y=(k,tt,B,j,ge)=>{let Se=0,Z=0,ve=0;if(x){const H=tt*w,re=V?(Math.PI/2-2*Math.atan(Math.exp(-B/T)))*T:B*w;Se=H-C,Z=re-S,ve=j-P}else{const H=Sg(k),re=k.tile,be=re.extent,lt=re.extentInRadians,ut=(tt-be[0])/(be[2]-be[0]),pt=(B-be[1])/(be[3]-be[1]),Ke=lt[0]*(1-ut)+lt[2]*ut,it=H(pt),Fe=Math.cos(it),Je=Math.sin(it),ze=Math.sin(Ke),rt=Math.cos(Ke),fe=T+j;Se=rt*Fe*fe-C,Z=ze*Fe*fe-S,ve=Je*fe-P}switch(ge){case 0:R+=Se,ee+=Z,z+=ve;break;case 1:L-=Se,G-=Z,A-=ve;break;case 2:R-=Se,ee-=Z,z-=ve;break;case 3:L+=Se,G+=Z,A+=ve}},le=r??Mg,me=g[0],te=g[2],he=g[1],oe=g[3],K=[oe>le[3],te>le[2],he<le[1],me<le[0]],we=Math.max(me,le[0]),Oe=Math.min(te,le[2]),se=Math.max(he,le[1]),_e=Math.min(oe,le[3]),Qe=k=>Math.max(le[0],Math.min(le[2],k)),Xe=k=>Math.max(le[1],Math.min(le[3],k)),Ye=k=>{const tt=t.cornerNeighborCornerTiles;O=0,N=0,U=1,L=0,G=0,A=0,R=0,ee=0,z=0;let B=1/0;for(let H=0;H<4;++H){const re=tt[4*k+H];B=Math.min(B,(re==null?void 0:re.level)??1/0)}for(let H=0;H<4;++H){const re=tt[4*k+H];Jl[H]=(re==null?void 0:re.level)===B?re:null}let j=1,ge=0;for(let H=0;H<4;++H){const re=Jl[H];re&&(j=Math.max(j,re==null?void 0:re.renderData.geometryState.numVerticesPerSide),ge=re.extent[2]-re.extent[0])}const Se=ge,Z=j;F(Z>1);const ve=Se/Z;for(let H=0;H<4;++H){const re=Jl[(H+3)%4],be=Jl[H%4];if(!re&&!be)continue;const lt=H===0?1:H===1?2:H===2?3:0,ut=H===0?2:H===1?3:H===2?0:1;if(re&&be){const pt=kp[H][0]*ve,Ke=kp[H][1]*ve,it=re.extent,Fe=Qe(it[lt===0||lt===1?2:0]+pt),Je=Xe(it[lt===0||lt===3?3:1]+Ke),ze=be.extent,rt=Qe(ze[ut===0||ut===1?2:0]+pt),fe=Xe(ze[ut===0||ut===3?3:1]+Ke),Le=re.renderData,qe=be.renderData,ot=vt(Fe,Je,Le.geometryState.samplerData),Xt=vt(rt,fe,qe.geometryState.samplerData);Y(Le,Fe,Je,.5*(ot+Xt),H)}else{const pt=re??be,Ke=re?lt:ut,it=pt.extent,Fe=kp[H],Je=Qe(it[Ke===0||Ke===1?2:0]+Fe[0]*ve),ze=Xe(it[Ke===0||Ke===3?3:1]+Fe[1]*ve),rt=pt.renderData,fe=vt(Je,ze,rt.geometryState.samplerData);Y(rt,Je,ze,fe,H)}}if(!x){const H=Math.sqrt(C*C+S*S+P*P);O=C/H,N=S/H,U=P/H}if(x||U*U<.999){const H=Math.sqrt(L*L+G*G+A*A);L/=H,G/=H,A/=H;const re=Math.sqrt(R*R+ee*ee+z*z);R/=re,ee/=re,z/=re,O=A*ee-G*z,N=L*z-A*R,U=G*R-L*ee;const be=1/Math.sqrt(O*O+N*N+U*U);O*=be,N*=be,U*=be}},Ze=t.cornerNeighborCornerTiles;for(let k=0;k<4;++k){const tt=k,B=(k+1)%4,j=k===0||k===1?1:0,ge=k===0||k===3?1:0,Se=W(j,a,l),Z=W(ge,o,h),ve=e.getEdgeFirstVertexIndex(tt),H=e.getEdgeCount(tt),re=k===0||k===3?H-1:0,be=e.getEdgeFirstVertexIndex(B),lt=e.getEdgeCount(B),ut=k===0||k===1?lt-1:0;let pt=-1;for(let Fe=0;Fe<4;++Fe){const Je=Ze[4*k+Fe],ze=Ze[4*k+pt];Je&&(pt===-1||Ur(ze,Je)>0)&&(pt=Fe)}const Ke=pt,it=Ze[4*k+Ke];if(it!==p){const Fe=p.level-it.level,Je=2**Fe,ze=[it.lij[0]+Fe,it.lij[1]*Je,it.lij[2]*Je],rt=[ze[1]+Je===p.lij[1],k===0&&(Ke===1||Ke===0&&it!==Ze[4*k+3])||k===1&&(Ke===0||Ke===1&&it!==Ze[4*k+2]),ze[1]===p.lij[1]+1,k===2&&(Ke===3||Ke===2&&it!==Ze[4*k+1])||k===3&&(Ke===2||Ke===3&&it!==Ze[4*k+0])],fe=rt.reduce((Ve,ft)=>Ve+(ft?1:0),0);F(fe===1||fe===2);let Le=-1,qe=-1;const ot=it.renderData;if(fe===1){const Ve=rt.findIndex(Vt=>Vt);F(0<=Ve&&Ve<=3),Le=(Ve+2)%4;const ft=t.edgeResolutions[Ve];qe=p.getNeighborEdgeStartVertexIndex(Ve,it)*ft+ft*(Ve===0&&k===0||Ve===1&&k===0||Ve===2&&k===1||Ve===3&&k===3?1:0)}else{F(rt[1]||rt[3]),Le=rt[1]?3:1;const Ve=ot.geometryState.edgeResolutions[Le];qe=k===0||k===3?0:Ve}const Xt=ot.geometry;{const Ve=ve+re,ft=be+ut,Vt=Xt.getEdgeFirstVertexIndex(Le)+qe,Ei=Xt.vertexAttributes,as=ot.localOrigin;{const Mi=Ei.position,ei=Mi.typedBuffer,Ft=Vt*Mi.typedBufferStride,Ue=ei[Ft]+as[0]-s[0],yt=ei[Ft+1]+as[1]-s[1],oi=ei[Ft+2]+as[2]-s[2];Qs(Ue,yt,oi,d);const fi=u.position,Yt=fi.typedBuffer;{const ls=Ve*fi.typedBufferStride;Yt[ls]=Ue,Yt[ls+1]=yt,Yt[ls+2]=oi}{const ls=ft*fi.typedBufferStride;Yt[ls]=Ue,Yt[ls+1]=yt,Yt[ls+2]=oi}}const os=u.uv0;fr(os,Ve,Se,Z),fr(os,ft,Se,Z);{const Mi=Ei.normalCompressed.typedBuffer,ei=Vt*Ei.normalCompressed.typedBufferStride,Ft=u.normalCompressed,Ue=Ft.typedBuffer;{const yt=Ve*Ft.typedBufferStride;Ue[yt]=Mi[ei],Ue[yt+1]=Mi[ei+1]}{const yt=ft*Ft.typedBufferStride;Ue[yt]=Mi[ei],Ue[yt+1]=Mi[ei+1]}}}}else{const Fe=K[tt],Je=K[B];let ze;if(Fe||Je){const qe=W(me*(1-j)+te*j,we,Oe),ot=W(he*(1-ge)+oe*ge,se,_e);ze=vt(qe,ot,n)}else ze=f$(Ze,k);$(j,ge,ze),Ye(k);const rt=C-s[0],fe=S-s[1],Le=P-s[2];Qs(rt,fe,Le,d),e.setEdgeVertexFromValuesRawPositionUVNormal(tt,re,rt,fe,Le,Se,Z,O,N,U),e.setEdgeVertexFromValuesRawPositionUVNormal(B,ut,rt,fe,Le,Se,Z,O,N,U)}}for(let k=0;k<4;++k)Jl[k]=null}function f$(i,e){var o,l;const t=4*e,s=vg.reduce((h,d)=>{var u;return Math.min(h,((u=i[t+d])==null?void 0:u.level)??1/0)},1/0);Ii&&(F(!i[t+0]||!i[t+2]||t_(i[t+0],i[t+2],mt.SOUTH_WEST)),F(!i[t+1]||!i[t+3]||t_(i[t+1],i[t+3],mt.NORTH_WEST)));let r=0,n=0;for(let h=0;h<4;++h){const d=i[t+h];if(d&&d.level===s){const u=h===0||h===1,p=h===0||h===3,_=d.extent,f=_[u?0:2],g=_[p?1:3],y=(l=(o=d.renderData)==null?void 0:o.geometryState)==null?void 0:l.samplerData;n+=vt(f,g,y),r++}}const a=r?n/r:0;return F(a!=null),a}function Al(i){const{vao:e,geometry:t}=i,{vertexAttributes:s,edgeVerticesStartIndex:r}=t,n=s.position.typedBuffer;e.vertexBuffers.get("geometry").setSubData(n,r,r,n.length)}function pw(i){const{vao:e,geometry:t}=i,{indices:s,indexCount:r,edgeIndicesStartIndex:n}=t;e.indexBuffer.setSubData(s,n,n,r)}class y${constructor(e,t,s,r,n){this.isNorth=e,this.connectedRowOffset=t,this.connectedOuterEdgeOffset=s,this.rowOffset=r,this.latitudeResolution=n}}const kp=[[0,1],[1,0],[0,-1],[-1,0]],ui=new mD,Mg=yC(-1/0,-1/0,1/0,1/0),Jl=[null,null,null,null];function mw(i,e,t){if(!e)return!1;const s=Ur(i,e);return s>0||s===0&&t>=2}class ad{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return F(0<=e&&e<this.count),this.vertex0Index+this.stride*e}}const Og=[new ad,new ad,new ad,new ad];function Qs(i,e,t,s){i<s[0]?s[0]=i:i>s[3]&&(s[3]=i),e<s[1]?s[1]=e:e>s[4]&&(s[4]=e),t<s[2]?s[2]=t:t>s[5]&&(s[5]=t)}function _w(i){const{edgeResolutions:e,numVerticesPerSide:t}=i,s=1+Math.max(...e);return Math.max(t,s)}function gw(i,e,t,s,r,n){const a=i*r,o=n[a],l=n[a+1],h=n[a+2],d=e*r,u=n[d],p=n[d+1],_=n[d+2],f=t*r,g=n[f],y=n[f+1],w=n[f+2],x=s*r,T=n[x],C=n[x+1],S=n[x+2];return(u-T)*(u-T)+(p-C)*(p-C)+(_-S)*(_-S)>(o-g)*(o-g)+(l-y)*(l-y)+(h-w)*(h-w)}function sl(i,e,t,s,r){i[e]=t,i[e+1]=s,i[e+2]=s,i[e+3]=r,i[e+4]=r,i[e+5]=t}const Vd=6;let v$=class extends wg{constructor(e,t,s,r,n){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=mi(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,s,r,n)}init(e,t,s,r,n){super.init(e,t,s,r,n);const a=n.view.renderSpatialReference,o=n.spatialReference,l=a!=null&&Qv(a)&&o!=null&&o.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=l;const{isWebMercatorOnPlateCarree:h}=n,d=this._extentInRenderSR,u=this.extent;if(h){const p=Pt(u[0],u[1],0);Yh(p,pi.WebMercator,p,pi.PlateCarree);const _=Pt(u[2],u[3],0);Yh(_,pi.WebMercator,_,pi.PlateCarree),d[0]=p[0],d[1]=p[1],d[2]=_[0],d[3]=_[1]}else for(let p=0;p<4;++p)d[p]=u[p]*l;this.centerAtSeaLevel[0]=.5*(d[0]+d[2]),this.centerAtSeaLevel[1]=.5*(d[1]+d[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(d[2]-d[0],d[3]-d[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),s=.5*(e[3]-e[1]),r=Math.sqrt(t*t+s*s),n=.5*(this.elevationBoundsMax-this.elevationBoundsMin),a=Math.max(r,n);this._center[Ut.MIDDLE][3]=a}_calculateFrustumVisibilityStatus(e){const t=this._aabb(),s=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5];let h=!0;for(let d=0;d<6;d++){const u=e[d],p=u[0],_=u[1],f=u[2],g=u[3];if(p*(p>0?s:a)+_*(_>0?r:o)+f*(f>0?n:l)+g>=0)return $i.OUTSIDE;h=h&&p*(p<0?s:a)+_*(_<0?r:o)+f*(f<0?n:l)+g<=0}return h?$i.INSIDE:$i.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return NP(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,s,r){return od[0]=1/t[0],od[1]=1/t[1],od[2]=1/t[2],ib(this._aabb(),e,od,s,r)}createGeometry(){a$(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,s=this.renderData;let r=e,n=t;if(s){const a=s.geometry.boundingBox;r=a[2],n=a[5]}else if(!this.leaf){r=1/0,n=-1/0;for(const a of this.children){const o=a;r=Math.min(r,o._subtreeGeometryElevationBoundMin),n=Math.max(n,o._subtreeGeometryElevationBoundMax)}}if(r!==this._subtreeGeometryElevationBoundMin||n!==this._subtreeGeometryElevationBoundMax){this._subtreeGeometryElevationBoundMin=r,this._subtreeGeometryElevationBoundMax=n;const a=this.parent;a==null||a._updateSubtreeGeometryElevationsBounds()}}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){l$(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){c$(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){h$(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}};const od=v();let b$=class{constructor(){this.extent=Ci(),this.minLevel=0,this.maxLevel=0,this.callback=null}},Fd=class extends De{constructor(){super(...arguments),this._queries=new Lt({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new Lt({initialSize:30}),this._queryPool=new Ya(b$)}queryVisibleLevelRange(e,t,s,r){const n=this._queryPool.acquire();Q_(n.extent,e),n.minLevel=t??-Number.MAX_VALUE,n.maxLevel=s??Number.MAX_VALUE,n.callback=r,this._queryQueue.push(n),this.notifyChange("updating")}get updating(){return this._queryQueue.length!==0}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let s=0;for(;s<this._queriesInvPtr;){const r=this._queries.data[s],n=r.extent;t>=r.minLevel&&t<=r.maxLevel&&n[0]<=e.extent[2]&&n[2]>=e.extent[0]&&n[1]<=e.extent[3]&&n[3]>=e.extent[1]?(this._queries.swapElements(s,this._queriesInvPtr-1),this._queriesInvPtr--):s++}}};c([m()],Fd.prototype,"updating",null),Fd=c([I("esri.views.3d.terrain.ScaleRangeQueries")],Fd);function w$(i,e,t,s){const r=Math.cos(t);i[0]=Math.cos(e)*r*s,i[1]=Math.sin(e)*r*s,i[2]=Math.sin(t)*s}let x$=class extends wg{constructor(e,t,s,r,n){super(),this._convexHull=new Array(24),this._boundingSphere=wr(),this._baseUsedMemory=1816,this.init(e,t,s,r,n)}init(e,t,s,r,n){super.init(e,t,s,r,n);const a=this.ellipsoid.radius,o=this.extentInRadians[0],l=this.extentInRadians[1],h=this.extentInRadians[2],d=this.extentInRadians[3],u=ke(l,d,.5),p=ke(o,h,.5),_=e===0?0:Math.min(Math.abs(l),Math.abs(d));this._edgeLen=(h-o)*Math.cos(_)*a,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=a-Math.sqrt(a*a-this._edgeLen2/4),w$(this.centerAtSeaLevel,p,u,this.ellipsoid.radius),ae(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(this.lij[0]===0)$e(At(e[Ut.MIDDLE]),0,0,0),$e(e[Ut.TOP],0,0,0),$e(e[Ut.BOTTOM],0,0,0),e[Ut.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[Ut.MIDDLE],s=this.convexHull;let r=0;for(let n=0;n<8;++n)r=Math.max(r,C$(At(t),s,3*n));e[Ut.MIDDLE][3]=Math.sqrt(r)}}_calculateFrustumVisibilityStatus(e){if(!J_(e,this._boundingSphere))return $i.OUTSIDE;if(this.lij[0]<10)return $i.INTERSECTS;const t=this.convexHull,s=this.surface.view.state.camera.near;let r=!0;for(let n=0;n<y2;n++){const a=n===Vo.NEAR,o=e[n],l=o[0],h=o[1],d=o[2],u=o[3]-(a?s:0);let p=!1;for(let _=0;_<8;++_){const f=3*_;if(l*t[f]+h*t[f+1]+d*t[f+2]+u<0){if(p=!0,!r)break}else r=!1}if(!p)return $i.OUTSIDE}return r?$i.INSIDE:$i.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){KD(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),Ii&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=At(e),s=this.elevationBoundsMin,r=this.elevationBoundsMax,n=this.ellipsoid.radius,a=r;if(this.level===0)$e(t,0,0,0),e[3]=n+a;else{const o=this.extentInRadians,l=.5*(o[0]+o[2]),h=o[1],d=o[3];Ta(Py,l,h,n),Ta(Ey,l,d,n),ye(t,Py,Ey),ie(t,t,(n+.5*(s+r))/qi(t));const u=this.convexHull;let p=0;const _=(g,y)=>{const w=g[0]-u[3*y],x=g[1]-u[3*y+1],T=g[2]-u[3*y+2];return Math.sqrt(w*w+x*x+T*T)};for(let g=0;g<8;++g){const y=_(t,g);p=Math.max(p,y)}const f=p;e[3]=f+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(this.level===0)return;const s=this.elevationBoundsMin,r=this.elevationBoundsMax,n=this._getPatchType(),a=this.surface.isWebMercator,o=a&&n===Lr.HAS_NORTH_POLE,l=a&&n===Lr.HAS_SOUTH_POLE,h=l||o,d=Math.PI/2,u=e[0],p=e[2],_=l?-d:e[1],f=o?d:e[3],g=.5*(u+p),y=s,w=t+(h?Math.min(0,y-1):y),x=(z,V,Y)=>Ta(z,V,Y,w),T=v(),C=v(),S=v(),P=v();x(T,u,_),x(C,u,f),x(S,p,f),x(P,p,_);const M=(z,V)=>{for(let Y=0;Y<3;++Y)this._convexHull[3*V+Y]=z[Y]};M(T,0),M(C,1),M(S,2),M(P,3);const $=r,O=t+(h?Math.max(0,$+1):$),N=v(),U=v(),L=v();Ta(U,g,f,w),Ta(L,g,_,w),ye(N,U,L),ae(N,N);const G=v(),A=v(),R=(z,V)=>{St(A,z,V),ae(A,A);const Y=-ce(z,G)/ce(A,G);F(Y>=0),ie(A,A,Y),ye(z,z,A)};if(2**this.lij[0]>2*this.lij[1]){const z=L,V=v();gt(V,Sy,z),ae(V,V),gt(G,z,V),ae(G,G),F(Us(ce(G,z)/qi(z),0)),R(T,C),R(P,S),M(T,0),M(P,3)}else if(2**this.lij[0]!==2*this.lij[1]){const z=U,V=v();gt(V,Sy,z),ae(V,V),gt(G,V,z),ae(G,G),R(C,T),R(S,P),M(C,1),M(S,2)}const ee=(z,V)=>{const Y=O/ce(V,N);for(let le=0;le<3;++le)this._convexHull[3*z+le]=V[le]*Y};ee(4,T),ee(5,C),ee(6,S),ee(7,P)}_getPatchType(){const e=this.lij[1],t=e===0,s=e===(1<<this.level)-1;return t?s?Lr.HAS_BOTH_POLES:Lr.HAS_NORTH_POLE:s?Lr.HAS_SOUTH_POLE:Lr.REGULAR}intersectsRay(e,t,s,r){const n=this._boundingSphere,a=n[3]+s,o=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],l=n[0]-e[0],h=n[1]-e[1],d=n[2]-e[2],u=(l*t[0]+h*t[1]+d*t[2])/o,p=t[0]*u-l,_=t[1]*u-h,f=t[2]*u-d;return p*p+_*_+f*f<a*a}get minimumVerticesPerSide(){return this.level<Ty.length?Ty[this.level]+1:2}updateCornerElevations(){s$(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){t$(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){i$(this.renderData),this._updateBoundingVolumes()}_checkBVs(){var tt;if(!Ii||this.level<=2)return;const e=this._boundingSphere,t=e[3],s=At(e),r=v(),n=this.ellipsoid.radius,a=this.elevationBoundsMin,o=this.elevationBoundsMax,l=n+a,h=1,d=0,u=this._center[Ut.MIDDLE][3],p=this.convexHull,_=(B,j)=>{for(let ge=0;ge<3;++ge)B[ge]=p[3*j+ge]};{const B=v(),j=v(),ge=v(),Se=v(),Z=v(),ve=(H,re,be,lt)=>{_(j,H),_(ge,re),_(Se,be),St(j,j,ge),St(Se,Se,ge),gt(B,j,Se),ae(B,B);const ut=ce(B,ge);_(Z,lt);const pt=ce(B,Z),Ke=Math.abs(pt-ut);F(Us(Ke,0),`Non coplanar ${H},${re},${be},${lt} diff = ${Ke}`)};ve(0,1,2,3),ve(4,5,6,7),ve(0,1,4,5),ve(1,2,5,6),ve(2,3,6,7),ve(3,0,7,4)}const f=VP(24),g=(B,j,ge)=>{const Se=4*B;for(let Z=0;Z<3;++Z)f[Se+Z]=j[Z];f[Se+3]=ge},y=v(),w=v(),x=v(),T=v(),C=(B,j,ge,Se)=>{_(y,j),_(w,ge),_(x,Se),St(y,y,w),ae(y,y),St(x,x,w),ae(x,x),gt(T,y,x),ae(T,T);const Z=ce(T,w);g(B,T,Z)};C(0,0,1,2),C(1,1,0,4),C(2,1,5,2),C(3,3,2,6),C(4,4,0,3),C(5,4,6,5);const S=1,P=(B,j,ge,Se)=>{const Z=4*B;return f[Z]*j+f[Z+1]*ge+f[Z+2]*Se-f[Z+3]},M=(B,j,ge,Se)=>P(B,j,ge,Se)>=-S,$=(B,j)=>M(B,j[0],j[1],j[2]),O=2**this.lij[0]>2*this.lij[1],N=(B,j,ge)=>Math.sqrt(fw(B,j,ge,s[0],s[1],s[2]))<t,U=B=>N(B[0],B[1],B[2]),L=(B,j)=>N(B[j],B[j+1],B[j+2]),G=this.extentInRadians,A=.5*(G[0]+G[2]),R=G[1],ee=G[3],z=v(),V=v();Ta(z,A,ee,l),Ta(V,A,R,l);const Y=O?"Upper":"Lower";let le=!0;for(let B=0;B<6;++B){for(let j=0;j<8;++j){const ge=3*j,Se=M(B,p[ge],p[ge+1],p[ge+2]);le&&(le=Se),F(Se,`Tile[${this.lij}] Convex hull point ${j} outside of plane ${B}`)}F($(B,V),`Tile[${this.lij}] (${Y}) bottom mid outside of plane ${B}`),F($(B,z),`Tile[${this.lij}] (${Y}) top mid outside of plane ${B}`)}F(le,"Not all convex hull points are inside  convex hull polyhedron"),F(U(V),`Tile[${this.lij}] (${Y}) bottom mid outside of bounding sphere`),F(U(z),`Tile[${this.lij}] (${Y}) top mid outside of bounding sphere`);for(let B=0;B<8;++B){const j=L(p,3*B);F(j,`Tile[${this.lij}] Convex hull point ${B} outside of bounding sphere`)}for(let B=0;B<6;++B)for(let j=0;j<8;++j){const ge=3*j;M(B,p[ge],p[ge+1],p[ge+2])||console.error(`Tile[${this.lij}] Convex hull point ${j} outside of plane ${B}`)}const{extentInRadians:me}=this,te=Math.max(me[2]-me[0],me[3]-me[1]),he=Math.round(te*n),{renderData:oe}=this;if(!oe)return;const{geometry:K,geometryState:we,localOrigin:Oe}=oe,se=(tt=K.vertexAttributes)==null?void 0:tt.position;if(!se)return;const _e=v(),Qe=K.numVerticesPerSide-2,{indices:Xe,indexCount:Ye,edgeVerticesStartIndex:Ze,poleVerticesStartIndex:Ct}=K;if(!Xe)return;const k=new Set;for(let B=0;B<Ye;++B){const j=Xe[B];if(k.has(j))continue;k.add(j);const ge=j<Ct,Se=j>=Ze;let Z=!1,ve=-1;if(Se){let fe=Ze;for(let Le=0;Le<4;++Le){const qe=we.edgeResolutions[Le];if(j===fe||j===fe+qe-1){Z=!0;break}if(fe+=qe,j<fe){ve=Le;break}}}const H=Se?we.edgePeerNeighbors[ve]:null,re=Se&&H&&Ur(this,H)>0;se.getVec(j,r),ye(_e,r,Oe);const be=qi(_e)-n;let lt=0,ut=!1;const pt=a-be,Ke=be-o,it=pt>h,Fe=Ke>h,Je=it||Fe,ze=()=>{const fe=ge?"internal":Se&&!Z?"edge":Z?"corner":"pole";return`Tile[${this.lij}].vertex[${j}]:${fe}`+(it?"(below)":Fe?"(above)":"")+(re?"(Neighbor)":"")},rt=ws(_e,s);if(rt>=t+d){const fe=rt-t;Je||(console.error(`${ze()} is out of the bounding sphere by ${fe.toFixed(0)} / ${t.toFixed(0)}[tol=${d}] h=${be.toFixed(0)} / [${a.toFixed(0)}..${o.toFixed(0)}] (${(fe/t).toFixed(0)})`),ut=!0)}for(let fe=0;fe<6;++fe)if(!M(fe,_e[0],_e[1],_e[2])){const Le=P(fe,_e[0],_e[1],_e[2]),qe=j%Qe,ot=(j-qe)/Qe;fe===0&&pt||fe===5&&Ke||(console.error(`${ze()} (${qe},${ot})|${Qe}] is out of the bounding trapezoid plane ${fe} h=${Math.round(be)} / [${Math.round(a)}..${Math.round(o)}] dist=${Math.round(Le)} radii = ${Math.round(t)}/${Math.round(u)}} : maxL = ${he}`),++lt)}if(ut||lt>0)break}}get convexHull(){return this._convexHull}};const Ty=[128,64,64,32,16,8,8,4];function C$(i,e,t){return fw(i[0],i[1],i[2],e[t],e[t+1],e[t+2])}function fw(i,e,t,s,r,n){const a=s-i,o=r-e,l=n-t;return a*a+o*o+l*l}const Ta=(i,e,t,s)=>{const r=Math.cos(e),n=Math.sin(e),a=Math.cos(t),o=Math.sin(t);i[0]=s*a*r,i[1]=s*a*n,i[2]=s*o},Sy=[0,0,1],Py=v(),Ey=v();let rr=class extends De{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};c([m()],rr.prototype,"fovX",void 0),c([m()],rr.prototype,"fovY",void 0),c([m()],rr.prototype,"relativeWidthLimit",void 0),c([m()],rr.prototype,"relativeHeightLimit",void 0),c([m()],rr.prototype,"maxLod",void 0),c([m()],rr.prototype,"angledSplitBias",void 0),c([m()],rr.prototype,"aboveGround",void 0),c([m()],rr.prototype,"frustum",void 0),rr=c([I("esri.views.3d.terrain.SplitLimits")],rr);const T$=da().vec3f(Ae.POSITION).vec2i16(Ae.UV0).vec2i16(Ae.NORMALCOMPRESSED,{glNormalized:!0});let S$=class{constructor(e){this._storage=new fc((t,s)=>e.newCache(t,s),"TileGeometry")}acquire(e){const s=Math.ceil(e/4)*4,r=this._storage,n=P$(s),a=r.pop(n);if(a)return a;const o=T$.createBuffer(s);return o.release=()=>r.put(n,o),o}clear(){this._storage.clear()}destroy(){this._storage.destroy()}};function P$(i){return i.toString()}let yw=class extends gi{constructor(){super(...arguments),this.scale=1,this.offset=Bh}};function vw(i){i.attributes.add(Ae.POSITION,"vec2"),i.attributes.add(Ae.UV0,"vec2"),i.varyings.add("uv","vec2"),i.varyings.add("vuv","vec2"),i.vertex.uniforms.add(new Be("scale",e=>e.scale),new br("offset",e=>e.offset)),i.vertex.main.add(b`gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;`)}var kt;(function(i){i[i.Composite=0]="Composite",i[i.ColorComposite=1]="ColorComposite",i[i.GridComposite=2]="GridComposite",i[i.GroupBackgroundComposite=3]="GroupBackgroundComposite",i[i.COUNT=4]="COUNT"})(kt||(kt={}));var q;(function(i){i[i.Normal=0]="Normal",i[i.Average=1]="Average",i[i.Lighten=2]="Lighten",i[i.Lighter=3]="Lighter",i[i.Plus=4]="Plus",i[i.Screen=5]="Screen",i[i.ColorDodge=6]="ColorDodge",i[i.Darken=7]="Darken",i[i.Multiply=8]="Multiply",i[i.ColorBurn=9]="ColorBurn",i[i.Overlay=10]="Overlay",i[i.SoftLight=11]="SoftLight",i[i.HardLight=12]="HardLight",i[i.VividLight=13]="VividLight",i[i.Hue=14]="Hue",i[i.Saturation=15]="Saturation",i[i.Luminosity=16]="Luminosity",i[i.Color=17]="Color",i[i.DestinationOver=18]="DestinationOver",i[i.DestinationAtop=19]="DestinationAtop",i[i.DestinationIn=20]="DestinationIn",i[i.DestinationOut=21]="DestinationOut",i[i.SourceAtop=22]="SourceAtop",i[i.SourceIn=23]="SourceIn",i[i.SourceOut=24]="SourceOut",i[i.Xor=25]="Xor",i[i.Difference=26]="Difference",i[i.Exclusion=27]="Exclusion",i[i.Minus=28]="Minus",i[i.Invert=29]="Invert",i[i.Reflect=30]="Reflect",i[i.COUNT=31]="COUNT"})(q||(q={}));const i_={normal:q.Normal,average:q.Average,lighten:q.Lighten,lighter:q.Lighter,screen:q.Screen,plus:q.Plus,"color-dodge":q.ColorDodge,darken:q.Darken,multiply:q.Multiply,"color-burn":q.ColorBurn,overlay:q.Overlay,"soft-light":q.SoftLight,"hard-light":q.HardLight,"vivid-light":q.VividLight,hue:q.Hue,saturation:q.Saturation,luminosity:q.Luminosity,color:q.Color,difference:q.Difference,exclusion:q.Exclusion,minus:q.Minus,invert:q.Invert,reflect:q.Reflect,"destination-over":q.DestinationOver,"destination-atop":q.DestinationAtop,"destination-in":q.DestinationIn,"destination-out":q.DestinationOut,"source-atop":q.SourceAtop,"source-in":q.SourceIn,"source-out":q.SourceOut,xor:q.Xor};function E$(i){return i===q.DestinationOver||i===q.DestinationAtop||i===q.DestinationIn||i===q.DestinationOut||i===q.SourceAtop||i===q.SourceIn||i===q.SourceOut||i===q.Xor}var Ai;(function(i){i[i.NotRequired=0]="NotRequired",i[i.Required=1]="Required",i[i.COUNT=2]="COUNT"})(Ai||(Ai={}));var Fs;(function(i){i[i.Off=0]="Off",i[i.On=1]="On",i[i.COUNT=2]="COUNT"})(Fs||(Fs={}));function M$(i,e){const t=e.blendMode;t!==q.Normal&&(t===q.Reflect&&i.code.add(b`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),t!==q.ColorDodge&&t!==q.VividLight||i.code.add(b`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),t!==q.ColorBurn&&t!==q.VividLight||i.code.add(b`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),t===q.Overlay&&i.code.add(b`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),t===q.HardLight&&i.code.add(b`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),t===q.SoftLight&&i.code.add(b`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),t===q.VividLight&&i.code.add(b`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),t!==q.Hue&&t!==q.Saturation&&t!==q.Color&&t!==q.Luminosity||(i.code.add(b`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),t!==q.Hue&&t!==q.Saturation||i.code.add(b`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),i.code.add(b`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${t===q.Multiply?b`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.Average?b`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.Lighten?b`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.Darken?b`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.Lighter?b`return vec4(cl * ol + cb * ob, ol + ob);`:t===q.Plus?b`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:t===q.Minus?b`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:t===q.Screen?b`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.Difference?b`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.Invert?b`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:t===q.DestinationOver?b`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:t===q.DestinationAtop?b`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:t===q.DestinationOut?b`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:t===q.SourceAtop?b`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:t===q.SourceOut?b`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:t===q.Xor?b`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:t===q.DestinationIn?b`return vec4(cb * ob * ol, ol * ob);`:t===q.SourceIn?b`return vec4(cl * ol * ob, ol * ob);`:t===q.Hue?b`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.Saturation?b`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.Color?b`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.Luminosity?b`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.Exclusion?b`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.Reflect?b`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.ColorDodge?b`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.ColorBurn?b`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.Overlay?b`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.SoftLight?b`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.HardLight?b`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===q.VividLight?b`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:b``}
    }
  `))}function bw(i,e){const t=e.output===kt.GridComposite,s=e.output===kt.ColorComposite,r=e.output===kt.GroupBackgroundComposite,n=e.output===kt.Composite,a=e.baseOpacityMode===Ai.Required,o=i.fragment;a&&o.uniforms.add(new Be("baseOpacity",u=>u.baseOpacity)),t?o.include(fg):s?o.uniforms.add(new Wi("backgroundColor",u=>u.backgroundColor)):n&&o.uniforms.add(new et("fboColor",u=>u.fboTexture));const l=e.blendMode!==q.Normal,h=e.premultipliedSource===Fs.On,d=!l&&!h&&(n&&!a||r);o.include(M$,e),o.code.add(b`
    vec4 getBackground(vec2 uv) {
      return ${a?b`baseOpacity *`:""} ${r?b`vec4(0.0, 0.0, 0.0, 0.0)`:s?b`vec4(backgroundColor, 1.0)`:t?b`vec4(gridColor(uv), 1.0)`:b`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`};
    }

    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {
      ${l?b`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec4 bgColor = getBackground(bgUV);
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:b`
          float composeAlpha = colorLayer.a * opacity;
          ${d?b`return colorLayer * opacity;`:b`
            vec4 bgColor = getBackground(bgUV);
            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}var Pn;function ww(i){const e=new qt,t=e.fragment;if(e.include(vw),i.background===Pn.Only){const s=i.output===kt.ColorComposite;return s?t.uniforms.add(new Wi("backgroundColor",r=>r.backgroundColor)):t.include(fg),t.main.add(b`fragColor = vec4(${s?b`backgroundColor`:b`gridColor(uv)`}, 1.0);`),e}return e.include(bw,i),t.uniforms.add(new et("tex",s=>s.texture),new Be("opacity",s=>s.opacity)),t.main.add(b`fragColor = blendLayers(uv, texture(tex, uv), opacity);`),e}(function(i){i[i.BelowLayer=0]="BelowLayer",i[i.Only=1]="Only",i[i.COUNT=2]="COUNT"})(Pn||(Pn={}));const O$=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return Pn},build:ww},Symbol.toStringTag,{value:"Module"}));let R$=class extends yw{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=js}},My=class extends Ht{constructor(e,t,s){super(e,t,new Bt(O$,()=>X(()=>Promise.resolve().then(()=>qN),void 0,import.meta.url)),s)}};var Xa,so;(function(i){i[i.Stretch=0]="Stretch",i[i.Lut=1]="Lut",i[i.Hillshade=2]="Hillshade",i[i.COUNT=3]="COUNT"})(Xa||(Xa={})),function(i){i[i.Noop=0]="Noop",i[i.PerBand=1]="PerBand",i[i.COUNT=2]="COUNT"}(so||(so={}));function A$(i,e){const t=i.transforms.tileUnitsToPixels,s=hb(e),r=Math.cos(s),n=Math.sin(s),a=Math.ceil(512*(Math.abs(n)+Math.abs(r)));m1(Ar),ru(Ar,Ar,[a/2,a/2]),_1(Ar,Ar,s),ru(Ar,Ar,[-256,-256]),g1(Ar,Ar,[1/8,1/8,1]),i.transforms.tileUnitsToPixels=Ar;const o=[],l=new k2(4096,o,()=>new j2),h=new W2(o,l,(d,u,p)=>new Q2(d,u,p,i.styleRepository,i.key.level,e),(d,u)=>{X2(d,u,!1)},()=>0,d=>{const u=i.styleRepository.getStyleLayerByUID(d).getLayoutProperty("visibility");return!u||u.getValue()!==Z2.NONE});o.push(i),l.add(i),h.setScreenSize(a,a),h.continue(1/0),l.removeTile(i),i.transforms.tileUnitsToPixels=t}const Ar=zC(),D$=.125;let $$=class{constructor(){this._renderParams={reshuffleManager:new J2,context:null,drawPhase:1,state:new I$,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new Y2(new G2(0,0,0,0),0,0,0,512,512,4096,4096),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,t,s,r,n,a,o,l,h,d){const u=this._backgroundTile;this._updateRenderParameters(e,t,u,s,n,a,o,l,h,d),this._renderParams.stencilSymbols=!1,s.drawBackground(this._renderParams,u,r)}renderContent(e,t,s,r,n,a,o,l,h,d,u,p){this._declutter(s),r.forAll(({sourceLayerInfo:{data:g}})=>this._declutter(g));const _=r.length>0;_&&this._stencilSymbols(e,t,s,r,n,a,o,l,h,d,u,p);let f=1;s.stencilRef=_?f:0,e.setStencilFunction(ji.EQUAL,s.stencilRef,255),this._render(e,t,s,n,a,o,l,h,d,u,p),r.forAll(({sourceLod:g,offset:y,sourceLayerInfo:{data:w}})=>{w.stencilRef=++f,this._renderSymbols(e,g,w,n,a,o,l,y,d,u,p)})}_stencilSymbols(e,t,s,r,n,a,o,l,h,d,u,p){let _=1;s.stencilRef=_,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(rp.KEEP,rp.KEEP,rp.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(ji.ALWAYS,s.stencilRef,255),this._stencilTileSymbols(e,t,s,n,a,o,l,h,d,u,p),r.forAll(({sourceLod:f,offset:g,sourceLayerInfo:{data:y}})=>{y.stencilRef=++_,e.setStencilFunction(ji.ALWAYS,y.stencilRef,255),this._stencilTileSymbols(e,f,y,n,a,o,l,g,d,u,p)}),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,s,r,n,a,o,l,h,d,u){e.setStencilFunction(ji.EQUAL,s.stencilRef,255),this._render(e,t,s,r,n,a,o,l,h,d,u,K2.SYMBOL)}_render(e,t,s,r,n,a,o,l,h,d,u,p){this._updateRenderParameters(e,t,s,r,a,o,l,h,d,u),this._renderParams.stencilSymbols=!1,r.drawTile(this._renderParams,s,n,p)}_stencilTileSymbols(e,t,s,r,n,a,o,l,h,d,u){this._updateRenderParameters(e,t,s,r,a,o,l,h,d,u),this._renderParams.stencilSymbols=!0,s.triangleCount=0,r.drawSymbols(this._renderParams,s,n)}_updateRenderParameters(e,t,s,r,n,a,o,l,h,d){"type"in s&&s.type==="vector-tile"&&!s.stage&&s.attachWithContext(e);const u=t[0]-n.getLevelShift(t[0]),p=this._renderParams;p.context=e,p.painter=r,p.glyphMosaic=r.glyphMosaic,p.spriteMosaic=r.spriteMosaic,p.pixelRatio=h*d,p.displayLevel=u,p.requiredLevel=u;const _=n.getScale(t[0]),[f,g]=n.getOffset(t,a*_),y=D$*a*_/l,w=s.transforms.displayViewScreenMat3;w[0]=y,w[4]=-y,w[6]=-1-f-o[0]*a*2,w[7]=1+g+(1-o[1])*a*2-2;const x=p.state,T=l/d;x.size[0]=T,x.size[1]=T,x.pixelRatio=d,x.rotation=(360-this._heading)%360;const C=2/T;tS(x.displayViewMat3,C,0,0,0,-C,0,-1,1,1);const S=m1(x.displayMat3),P=hb(this._heading);ru(S,S,[T/2,T/2]),_1(S,S,P),ru(S,S,[-T/2,-T/2]),iS(S,x.displayViewMat3,S)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(A$(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}},I$=class{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=xn(),this.displayViewMat3=xn(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}},xw=class extends pa{constructor(){super(...arguments),this.blendMode=q.Normal}};c([pe({count:q.COUNT})],xw.prototype,"blendMode",void 0);let Rh=class extends xw{constructor(){super(...arguments),this.output=kt.Composite,this.baseOpacityMode=Ai.NotRequired,this.premultipliedSource=Fs.Off}};c([pe({count:kt.COUNT})],Rh.prototype,"output",void 0),c([pe({count:Ai.COUNT})],Rh.prototype,"baseOpacityMode",void 0),c([pe({count:Fs.COUNT})],Rh.prototype,"premultipliedSource",void 0);let Cw=class extends Rh{constructor(){super(...arguments),this.background=Pn.BelowLayer}};c([pe({count:Pn.COUNT})],Cw.prototype,"background",void 0);function L$(i){i.fragment.uniforms.add(new et("u_colormap",e=>e.u_colormap),new Be("u_colormapOffset",e=>e.colormap.u_colormapOffset),new Be("u_colormapMaxIndex",e=>e.colormap.u_colormapMaxIndex),new Be("u_opacity",e=>e.common.u_opacity)),i.fragment.code.add(b`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}function N$(i){i.fragment.uniforms.add(new et("u_transformGrid",e=>e.u_transformGrid),new br("u_transformSpacing",e=>e.common.u_transformSpacing),new br("u_targetImageSize",e=>e.common.u_targetImageSize)),i.fragment.code.add(b`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}let V$=class extends yw{constructor(e,t,s){super(),this.common=e,this.u_image=t,this.u_transformGrid=s}};function F$(i,e){i.include(N$),i.fragment.uniforms.add(new et("u_image",s=>s.u_image),new kh("u_flipY",s=>s.common.u_flipY),new kh("u_applyTransform",s=>s.common.u_applyTransform));const{requireBilinearWithNN:t}=e;t&&i.fragment.uniforms.add(new br("u_srcImageSize",s=>s.common.u_srcImageSize)),i.fragment.code.add(b`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),t?i.fragment.code.add(b`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):i.fragment.code.add(b`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}let ju=class extends V${constructor(e,t,s,r,n,a){super(e,r,n),this.colormap=t,this.symbolizer=s,this.u_colormap=a,this.backgroundColor=js,this.fboTexture=null,this.baseOpacity=1}},Tw=class extends ju{},Sw=class extends ju{};function Pw(i){const e=new qt;return e.include(vw),e.include(F$,i),e.include(L$,i),e.include(bw,i),e.fragment.code.add(b`vec4 applyBackgroundBlend(vec4 layerColor) {
return blendLayers(vuv, layerColor, u_opacity);
}`),i.colorizerType===Xa.Stretch?z$(e,i):i.colorizerType===Xa.Lut?U$(e):i.colorizerType===Xa.Hillshade&&q$(e,i),e}function U$(i){i.fragment.main.add(b`vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));`)}function z$(i,e){i.fragment.uniforms.add(new T1("u_bandCount",s=>s.symbolizer.u_bandCount),new un("u_minCutOff",s=>s.symbolizer.u_minCutOff,3),new un("u_maxCutOff",s=>s.symbolizer.u_maxCutOff,3),new un("u_factor",s=>s.symbolizer.u_factor,3),new Be("u_minOutput",s=>s.symbolizer.u_minOutput),new Be("u_maxOutput",s=>s.symbolizer.u_maxOutput),new kh("u_useGamma",s=>s.symbolizer.u_useGamma),new un("u_gamma",s=>s.symbolizer.u_gamma,3),new un("u_gammaCorrection",s=>s.symbolizer.u_gammaCorrection,3),new Be("u_opacity",s=>s.common.u_opacity)),i.fragment.code.add(b`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const t=e.applyColormap?b`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:b`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;i.fragment.main.add(b`
    vec2 pixelLocation = getPixelLocation(uv);
    if (isOutside(pixelLocation)) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }

    vec4 currentPixel = getPixel(pixelLocation);
    ${e.stretchType===so.Noop?b`fragColor = applyBackgroundBlend(currentPixel);`:b`
    if (currentPixel.a == 0.0) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }
    if (u_bandCount == 1) {
      float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      ${t}
    } else {
      float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
      float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
      fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
    }`}`)}function q$(i,e){const t=i.fragment;t.uniforms.add(new et("u_image",r=>r.u_image),new T1("u_hillshadeType",r=>r.symbolizer.u_hillshadeType),new un("u_sinZcosAs",r=>r.symbolizer.u_sinZcosAs,6),new un("u_sinZsinAs",r=>r.symbolizer.u_sinZsinAs,6),new un("u_cosZs",r=>r.symbolizer.u_cosZs,6),new un("u_weights",r=>r.symbolizer.u_weights,6),new br("u_factor",r=>r.symbolizer.u_factor),new Be("u_minValue",r=>r.symbolizer.u_minValue),new Be("u_maxValue",r=>r.symbolizer.u_maxValue),new br("u_srcImageSize",r=>r.common.u_srcImageSize)),t.include(S1),t.code.add(b`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),t.code.add(b`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const s=e.applyColormap?b`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:b`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;t.main.add(b`
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${s}`)}const H$=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:Sw,ColorizerStretchUniforms:Tw,ColorizerUniforms:ju,build:Pw},Symbol.toStringTag,{value:"Module"}));let Oy=class extends Ht{constructor(e,t,s){super(e,t,new Bt(H$,()=>X(()=>Promise.resolve().then(()=>HN),void 0,import.meta.url)),s)}},uh=class extends Rh{constructor(){super(...arguments),this.colorizerType=Xa.Stretch,this.stretchType=so.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}};c([pe({count:Xa.COUNT})],uh.prototype,"colorizerType",void 0),c([pe({count:so.COUNT})],uh.prototype,"stretchType",void 0),c([pe()],uh.prototype,"applyColormap",void 0),c([pe()],uh.prototype,"requireBilinearWithNN",void 0);let Ry=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const s=new pc(this._rctx,new hi(e),new $1(R1.DEPTH24_STENCIL8,e));return this._fbos.set(e,s),s}};function ma(i,e=Gr.Pos2,t=Ol,s=-1,r=1){const n=e===Gr.Pos2?new Float32Array([s,s,r,s,s,r,r,r]):new Float32Array([s,s,0,0,r,s,1,0,s,r,0,1,r,r,1,1]);return new ua(i,t,new Map([["geometry",G$.get(e)]]),new Map([["geometry",Ts.createVertex(i,gr.STATIC_DRAW,n)]]))}const B$=4;function Ew(i){const e=new hi(B$);return e.samplingMode=Ws.NEAREST,new Qi(i,e)}var Gr;(function(i){i[i.Pos2=0]="Pos2",i[i.Pos2Tex=1]="Pos2Tex"})(Gr||(Gr={}));const G$=new Map([[Gr.Pos2,c1],[Gr.Pos2Tex,UT]]),k$=()=>Pe.getLogger("esri.views.3d.terrain");let j$=class{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new $$,this._bindParameters=new d1(null),this._blendLayersTechniqueConfig=new Cw,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=ma(this._rctx,Gr.Pos2Tex)}dispose(){this._fbos.forEach(We),this._fbos=null,this._vtFBO=We(this._vtFBO),this._vaoQuad=We(this._vaoQuad),this._vectorTileHelper=We(this._vectorTileHelper)}updateHeading(e){var t;(t=this._vectorTileHelper)==null||t.updateHeading(e)}_acquireBlendLayersTechnique(e,t,s,r=Fs.Off,n=Pn.BelowLayer){return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=s,this._blendLayersTechniqueConfig.premultipliedSource=r,this._blendLayersTechniqueConfig.background=n,this._techniques.precompile(My,this._blendLayersTechniqueConfig),this._techniques.acquire(My,this._blendLayersTechniqueConfig)}drawBackground(e,t){const s=this._acquireBlendLayersTechnique(q.Normal,t?kt.ColorComposite:kt.GridComposite,Ai.NotRequired,Fs.Off,Pn.Only),r=this._rctx.bindTechnique(s,this._bindParameters,e);this._render(r),s.release()}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(_i.TRIANGLE_STRIP,0,vl(this._vaoQuad,"geometry"))}drawGroup(e,t,s,r,n=Fs.On){t===kt.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(s).colorTexture),e.texture=this.currentFBO(s).colorTexture,this.closeGroup(s);const a=e.baseOpacity<1?Ai.Required:Ai.NotRequired,o=this._acquireBlendLayersTechnique(r,t,a,n),l=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(l),o.release()}drawImageData(e,t,s,r,n=Fs.Off){if(e.texture==null)return;const a=e.baseOpacity<1?Ai.Required:Ai.NotRequired;e.fboTexture=t===kt.GroupBackgroundComposite||r===q.Normal&&a===Ai.NotRequired&&n===Fs.Off?null:this.switch(s).colorTexture;const o=this._acquireBlendLayersTechnique(r,t,a,n),l=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(l),o.release()}drawRasterData(e,t,s,r,n){const a=n.sourceLayerInfo.data;if(!a.source||(n.tile.surface.layerViewByIndex(n.layerIndex,xe.MAP).ensureSymbolizerParameters(a),!a.bind(this._rctx)))return;const o=e.baseOpacity<1?Ai.Required:Ai.NotRequired;e.fboTexture=r===q.Normal&&o===Ai.NotRequired?null:this.switch(s).colorTexture;const l=this._acquireRasterColorizerTechnique(a,t,r,o);a.opacity=e.opacity;const h=a.getUniforms();h.scale=n.scale,h.offset=n.offset,h.backgroundColor=e.backgroundColor,h.fboTexture=e.fboTexture,h.baseOpacity=e.baseOpacity;const d=this._rctx.bindTechnique(l,this._bindParameters,h);this._render(d),l.release()}_acquireRasterColorizerTechnique(e,t,s,r){const n=e.symbolizerParameters,a=["stretch","lut","hillshade"].indexOf(n.type);return this._rasterColorizerConfig==null&&(this._rasterColorizerConfig=new uh,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=s,this._rasterColorizerConfig.baseOpacityMode=r,this._rasterColorizerConfig.colorizerType=a,this._rasterColorizerConfig.applyColormap=!!n.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?so.Noop:so.PerBand,this._techniques.precompile(Oy,this._rasterColorizerConfig),this._techniques.acquire(Oy,this._rasterColorizerConfig)}drawVectorData(e,t,s,r,n,a,o,l){const h=this._rctx,d=n.sourceLayerInfo.data,u=n.tile.surface.layerViewByIndex(n.layerIndex,xe.MAP),p=e.baseOpacity<1?Ai.Required:Ai.NotRequired,_=p===Ai.Required||e.opacity<1||r!==q.Normal||t!==kt.Composite,f=_?Fs.On:Fs.Off,g=this._acquireBlendLayersTechnique(r,t,p,f);h.setPipelineState(g.getPipeline());let y=null,w=null;_?(w=this.currentFBO(s),this._vtFBO==null&&(this._vtFBO=new Ry(this._rctx)),y=this._vtFBO.get(s),h.bindFramebuffer(y),this._clearCurrentFBO()):l&&h.clear(Kt.DEPTH);try{this._vectorTileHelper.renderBackground(h,n.sourceLod,u.painter,u.layer.styleRepository,u.schemaHelper,Math.round(1/n.scale),n.offset,o,a,u.contentZoom),d&&this._vectorTileHelper.renderContent(h,n.sourceLod,d,n.vtlNeighborInfos,u.painter,u.layer.styleRepository,u.schemaHelper,Math.round(1/n.scale),n.offset,o,a,u.contentZoom)}catch(x){k$().warnOnce("A render call containing vector tiles did not resolve correctly.",x)}return g.release(),!y||(h.bindFramebuffer(w),e.texture=y.colorTexture,e.offset=Bh,e.scale=1,this.drawImageData(e,t,s,r,f),l)}copyFBOToTexture(e){const t=this._rctx,s=t.bindTexture(e.texture,Qi.TEXTURE_UNIT_FOR_UPDATES),r=e.descriptor;t.gl.copyTexImage2D(Pm.TEXTURE_2D,0,r.pixelFormat,0,0,r.width,r.height,0),e.generateMipmap(),t.bindTexture(s,Qi.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(Kt.COLOR|Kt.DEPTH|Kt.STENCIL)}_initFBO(e,t,s){this._rctx.bindFramebuffer(e),s&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,s=!0){if(this._current=t,t>=this._fbos.length)for(let r=this._fbos.length;r<=t;r++)this._fbos.push(new Ry(this._rctx));this._initFBO(this._fbos[t].get(e),e,s)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),s=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(s),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},W$=class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new Lt({allocator:e=>e||new Q$})}},Q$=class{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}},Ay=class{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){if(--this._refCount,this._refCount===0)if(this._cache){const e=`${this._texture.descriptor.width} ${this._texture.descriptor.pixelFormat}`;this._cache.put(e,this)}else this.dispose()}dispose(){this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get usedMemory(){return this._texture.usedMemory}},X$=class{constructor(e,t,s,r,n,a){this.start=e,this.end=t,this.blendMode=s,this.opacity=r,this.output=n,this.baseOpacity=a}},Y$=class{constructor(e,t,s,r){this._rctx=e,this.tileSize=t,this._techniques=s,this._cache=r,this._passParameters=new R$,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new j$(this._rctx,this._techniques),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._compositor=We(this._compositor),this._backgroundTexture=ii(this._backgroundTexture)}get backgroundIsGrid(){return this._backgroundColor==null}get backgroundColor(){return this._backgroundColor}updateHeading(e){var t;(t=this._compositor)==null||t.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const s=e.surface,r=s.baseOpacity;let n=0,a=0,o=this.tileSize,l=!1,h=!1;const d=s.view.state.contentPixelRatio;let u=!1;Mu.clear(),Eo.length=0;const p=e.layerInfo[xe.MAP];let _=0,f=null;for(;_<p.length;_++){const w=s.layerViewByIndex(_,xe.MAP),x=w.layer,T=!Qa(e,w),C=x.opacity,S=w.fullOpacity;if(h=h||gd(x),Lh(w)){let $=w.layer.blendMode!=="normal";if(gl(x.parent)){const O=x.parent.uid;O!=null&&O!==""&&($=Mw(x.parent)||$)}$&&(u=$,l=!1)}if((T||C===0)&&!u){p[_].pendingUpdates&=~(ne.TEXTURE_NOFADING&ne.TEXTURE_FADING);continue}++a;const P=eu(w),M=jp(e,_,P);if(M){if(p[_].pendingUpdates&=~(ne.TEXTURE_NOFADING&ne.TEXTURE_FADING),gl(x.parent)){const $=x.parent.uid;$!=null&&$!==""&&Ow(x.parent,_)}P?o=Math.max(o,this.tileSize*d):r===1&&S===1&&(w.isOpaque||this._dataToTexture(M)&&M.sourceLayerInfo.data.descriptor.isOpaque)&&(l=!0),++n,f===null&&(f=_)}}const g=o/this.tileSize,y=this._ensureBackgroundTexture(this.tileSize);n!==0&&f!==null?n===1&&!u&&this._useLayerTexture(e,f)||this._composeLayers(e,t,_-1,h,o,g,!l||u,Mu,u):K$(e,a,y,t!==zt.FADING)}_ensureBackgroundTexture(e){return this._backgroundTexture==null&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._compositor.bind(e),this._passParameters.offset=Bh,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,this.backgroundColor!=null),this._compositor.copyFBOToTexture(this._backgroundTexture),this._compositor.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useLayerTexture(e,t){const s=e.surface.layerViewByIndex(t,xe.MAP),r=gd(s.layer),n=r?e.surface.baseOpacity:1,a=r?1:e.surface.baseOpacity,o=s.fullOpacity,l=jp(e,t,!1);return!!this._dataToTexture(l)&&(e.renderData.setTextureReference(new Eu(l.sourceLayerInfo.data,zt.FADING,xr(l.offset[0],l.offset[1],l.scale,l.scale),n,a,o)),!0)}_composeLayers(e,t,s,r,n,a,o,l,h){this._compositor.ensureBuffer(n);const d=e.surface.baseOpacity;let u=!1,p=Ws.LINEAR_MIPMAP_LINEAR,_=!1,f=0;for(let x=s;x>=0;x--){const T=e.surface.layerViewByIndex(x,xe.MAP),C=T.layer,S=eu(T),P=jp(e,x,S),M=C.opacity,$=!Qa(e,T);if(!P||(M===0||$)&&!h)continue;const O=!gd(C)&&!u;O&&(u=!0);let N=!1;l.forEach(A=>{A.start===x&&(A.output=r?kt.Composite:o&&O?this.backgroundIsGrid?kt.GridComposite:kt.ColorComposite:kt.Composite,A.baseOpacity=O?d:1,Eo.push(A),this._compositor.openGroup(n),N=!0)});const U=f===0,L=N?kt.GroupBackgroundComposite:o&&U?this.backgroundIsGrid?kt.GridComposite:kt.ColorComposite:kt.Composite,G=i_[Lh(T)?T.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=O&&!N&&d<1?d:1,this._passParameters.opacity=M,_T(P)?_=this._compositor.drawVectorData(this._passParameters,L,n,G,P,a,this.tileSize,_):gT(P)?(this._compositor.drawRasterData(this._passParameters,L,n,G,P),Z$(P)&&(p=Ws.NEAREST)):this._dataToTexture(P)&&(this._passParameters.texture=P.sourceLayerInfo.data.texture,this._passParameters.offset=P.offset,this._passParameters.scale=P.scale,this._compositor.drawImageData(this._passParameters,L,n,G));Eo.length>0&&Eo[Eo.length-1].end===x;){const A=Eo.pop();this._passParameters.baseOpacity=A.baseOpacity,this._passParameters.opacity=A.opacity,this._passParameters.offset=Bh,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,A.output,n,i_[A.blendMode])}f++}const g=e.renderData,y=h||u&&d<1,w=g.ensureTexture(n,y,t,()=>this._buildTexture(n,y,p));this._compositor.copyFBOToTexture(w),this._compositor.unbind(),g.setTextureReference(new Eu(w,t,Rw,u?1:d,0,1))}_dataToTexture(e){if(fT(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data,!0),e.tile.setMemoryDirty()}return yT(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t,s=Ws.LINEAR_MIPMAP_LINEAR){if(e==null)return null;const r=new hi;r.wrapMode=Yi.CLAMP_TO_EDGE,r.samplingMode=s,r.maxAnisotropy=this._maxAnisotropy,r.preMultiplyAlpha=!0,r.flipped=!0,r.hasMipmap=!0,t||(r.pixelFormat=ai.RGB);const n=this._rctx;let a;if(typeof e=="number")r.width=r.height=e,a=this._buildTileTexture(r,e);else if(R_(e))r.isOpaque=e.isOpaque,r.isOpaque&&(r.pixelFormat=ai.RGB),a=this._buildTileTexture(r,e.element.width,e.element);else try{r.width=e.width,r.height=e.height,a=this._buildTileTexture(r,e.width,e)}catch{a=new Ay(Ew(n)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=n.bindTexture(a.texture,Qi.TEXTURE_UNIT_FOR_UPDATES);return a.generateMipmap(),n.bindTexture(o,Qi.TEXTURE_UNIT_FOR_UPDATES),a}_buildTileTexture(e,t,s){const r=`${t} ${e.pixelFormat}`,n=this._cache.pop(r);return n?(n.retain(),n.texture.setData(s),n):new Ay(new Qi(this._rctx,e,s),this._cache)}get test(){}};function jp(i,e,t){var a;Oi.layerIndex=e,Oi.vtlNeighborInfos.clear();const s=i.layerInfo[xe.MAP][e];if(ro(Oi.offset,0,0),Oi.tile=i,Oi.scale=1,Oi.sourceLod=i.lij,Oi.sourceLayerInfo=s,Oi.isVTLBackground=t,s.data)return t&&i.forEachLoadedNeighbor((o,l)=>{if(o.level!==i.level)return;const h=o.layerInfo[xe.MAP][e];if(!vT(h)||s.data===h.data)return;const d=Oi.vtlNeighborInfos.pushNew();d.offset=an[l],d.sourceLod=o.lij,d.sourceLayerInfo=h}),Oi;const r=s.upsampleInfo,n=(a=r==null?void 0:r.tile)==null?void 0:a.layerInfo[xe.MAP][e];return n?(Oi.tile=r.tile,ra(Oi.offset,r.offset),Oi.scale=r.scale,Oi.sourceLod=r.tile.lij,Oi.sourceLayerInfo=n,Oi):t?Oi:null}function Z$(i){const e=i.sourceLayerInfo.data;return!!e.source&&e.interpolation==="nearest"}function Mw(i){let e=i.blendMode!=="normal";return gl(i.parent)&&(e=Mw(i.parent)||e),e}function Ow(i,e){gl(i.parent)&&Ow(i.parent,e);const t=i.uid;if(t!=null&&t!==""){const s=Mu.get(t);s?s.start=e:Mu.set(t,new X$(e,e,i.blendMode,i.opacity,kt.Composite,1))}}function K$(i,e,t,s){const r=i.renderData,n=!s&&r.textureReference!=null&&(i.surface.view.layerViewManager.updating||e>0)?Zn.Delayed:Zn.Immediate;r.setTextureReference(new Eu(t,zt.FADING,Rw,i.surface.baseOpacity,0,1),n)}const Mu=new Map,Eo=new Array,Oi=new W$,Rw=xr(0,0,1,1),an=new Array;an[mt.NORTH]=[0,-1],an[mt.NORTH_EAST]=[-1,-1],an[mt.EAST]=[-1,0],an[mt.SOUTH_EAST]=[-1,1],an[mt.SOUTH]=[0,1],an[mt.SOUTH_WEST]=[1,1],an[mt.WEST]=[1,0],an[mt.NORTH_WEST]=[1,-1];const J$=200,Wp=40,eI=.8,tI=10,ph=1e-6;function iI(i,e,t){const s=e,r=t;let n=0,a=1/0;for(let o=0;o<3;++o){{const l=i[o];if(s[o]<l){if(r[o]<=ph)return!1;const h=(l-s[o])/r[o];n=Math.max(n,h)}else if(r[o]<=-ph){const h=(l-s[o])/r[o];a=Math.min(a,h)}if(n>a)return!1}{const l=i[o+3];if(s[o]>l){if(r[o]>=-ph)return!1;const h=(l-s[o])/r[o];n=Math.max(n,h)}else if(r[o]>=ph){const h=(l-s[o])/r[o];a=Math.min(a,h)}if(n>a)return!1}}return!0}let Dy=class{constructor(e,t,s,r,n){this.aabb=e,this.axis=t,this.d=s,this.midStartIndex=r,this.rightStartIndex=n}},Aw=class s_{constructor(e,t,s,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positions=r,this._rayDirection=v(),this._callback=Iy,this._intersectionOptions=$y,this.bspNodeTree=new Array;const n=s-t,a=new(n<oI?Uint8Array:n<lI?Uint16Array:Uint32Array)(n);this.triangleIndexMap=a;for(let o=0;o<n;++o)a[o]=o;{const o=aI(e,t,s,r.data,r.stride),l=W(Math.log2(n/Wp),2,tI),h=(d,u,p)=>{const _=rI(a,o,d,u),f=u-d;if(f<=Wp){const C=new Dy(_,void 0,0,d,u);return this.bspNodeTree.push(C),C}const{axis:g,midValue:y}=nI(_),w=sI(a,o,d,u,g,y),x=(C,S)=>{if(p>l)return;const P=S-C;return P<Wp||P>=eI*f?void 0:h(C,S,p+1)},T=new Dy(_,g,y,w.next,w.mid);return this.bspNodeTree.push(T),T.leftNode=x(d,w.next),T.rightNode=x(w.mid,u),T};h(0,n,0)}}intersectRayTriangleRange(e,t){if(e>=t)return;const s=this.positions;sb(this._rayFrom,this._rayDirection,e,t,this.globalTriangleVertexIndices,s.data,s.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),s_.numFacesTested+=t-e}intersectRay(e,t,s,r){s_.numFacesTested=0;const n=e,a=t,o=a[0]-n[0],l=a[1]-n[1],h=a[2]-n[2];if(o*o+l*l+h*h<ph)return;this._rayFrom=n;const d=this._rayDirection;d[0]=o,d[1]=l,d[2]=h;const u=this.triangleIndexMap.length;this._callback=r,this._intersectionOptions=s,this.intersectRayBSP(this.bspNodeTree[0],0,u),this._callback=Iy,this._intersectionOptions=$y}intersectRayBSP(e,t,s){const r=this._rayFrom,n=this._rayDirection;if(!iI(e.aabb,r,n))return;const a=e.axis,o=e.d;if(r[a]<o||n[a]<0){const l=t,h=e.midStartIndex;if(l<h){const d=e.leftNode;d!==void 0?this.intersectRayBSP(d,l,h):this.intersectRayTriangleRange(l,h)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[a]>o||n[a]>0){const l=e.rightStartIndex,h=s;if(l<h){const d=e.rightNode;d!==void 0?this.intersectRayBSP(d,l,h):this.intersectRayTriangleRange(l,h)}}}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}};Aw.numFacesTested=0;const Mo=[1/0,1/0,1/0],Oo=[-1/0,-1/0,-1/0];function sI(i,e,t,s,r,n){let a=t,o=s;for(;a<o;){const h=i[a];e[6*h+r+3]<=n?++a:(--o,i[a]=i[o],i[o]=h)}let l=a;for(o=s;l<o;){const h=i[o-1];e[6*h+r]>=n?--o:(i[o-1]=i[l],i[l]=h,++l)}return{next:a,mid:l}}function rI(i,e,t,s){if(s<=t)return Uf(NaN,NaN,NaN,NaN,NaN,NaN);{const r=6*i[t];for(let n=0;n<3;++n)Mo[n]=e[r+0+n],Oo[n]=e[r+3+n]}for(let r=t+1;r<s;++r){const n=6*i[r];for(let a=0;a<3;++a)Mo[a]=Math.min(Mo[a],e[n+0+a]),Oo[a]=Math.max(Oo[a],e[n+3+a])}return Uf(Mo[0],Mo[1],Mo[2],Oo[0],Oo[1],Oo[2])}function nI(i){const e=i[3]-i[0],t=i[4]-i[1],s=i[5]-i[2],r=e>t?e>s?0:t>s?1:2:t>s?1:s>e?2:0;return{axis:r,midValue:(i[r]+i[r+3])/2}}function aI(i,e,t,s,r){const n=t-e,a=new Float32Array(6*n);for(let o=0;o<n;++o){const l=3*(o+e),h=i[l]*r,d=i[l+1]*r,u=i[l+2]*r;for(let p=0;p<3;++p){const _=s[h+p],f=s[d+p],g=s[u+p];a[6*o+p]=Math.min(_,f,g),a[6*o+3+p]=Math.max(_,f,g)}}return a}const oI=255,lI=65535,$y=new K_,Iy=()=>{};let Ri=class extends P1{constructor(e){super(),this.spherical=e,this.overlayMode=iu.Disabled,this.tileBlendInput=zr.LayerOnly,this.transparencyMode=Si.Opaque,this.pbrMode=jt.Simplified,this.doublePrecisionRequiresObfuscation=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.normalType=gn.Compressed,this.textureCoordinateType=jh.Compressed,this.highStepCount=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!0,this.canHaveOverlay=!0}};c([pe({count:iu.COUNT})],Ri.prototype,"overlayMode",void 0),c([pe({count:zr.COUNT})],Ri.prototype,"tileBlendInput",void 0),c([pe({count:Si.COUNT})],Ri.prototype,"transparencyMode",void 0),c([pe({count:jt.COUNT})],Ri.prototype,"pbrMode",void 0),c([pe()],Ri.prototype,"doublePrecisionRequiresObfuscation",void 0),c([pe()],Ri.prototype,"receiveShadows",void 0),c([pe()],Ri.prototype,"hasSlicePlane",void 0),c([pe()],Ri.prototype,"backfaceCullingEnabled",void 0),c([pe()],Ri.prototype,"textureFadingEnabled",void 0),c([pe()],Ri.prototype,"renderOccluded",void 0),c([pe()],Ri.prototype,"screenSpaceReflections",void 0),c([pe()],Ri.prototype,"cloudReflections",void 0),c([pe()],Ri.prototype,"tileBorders",void 0),c([pe()],Ri.prototype,"visualizeNormals",void 0),c([pe()],Ri.prototype,"screenSizePerspective",void 0),c([pe()],Ri.prototype,"receiveAmbientOcclusion",void 0);const Qp=7,hI=10,Xp=qu();let Rs=class extends G_{get _isGlobal(){return this._stage.viewingMode===Ne.Global}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(i,e,t,s,r){super({}),this._overlayRenderer=i,this._stage=e,this._allTiles=t,this._ellipsoidRadius=s,this.type=Jr.TERRAIN,this.isGround=!0,this._tileSize=256,this._passParameters=new yg,this._drawParameters=new kS,this._renderDataPool=new Ya(LD),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new Zb,this._castShadows=!1,this._inViewshed=!1,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=Di.Occlude,this.produces=new Map([[J.OPAQUE_TERRAIN,()=>this._produces()&&this.transparency===Si.Opaque],[J.TRANSPARENT_TERRAIN,()=>this._produces()&&(this.transparency===Si.Transparent||this.transparency===Si.InvisibleWithDraped)],[J.OCCLUDED_TERRAIN,()=>this._produces()]]),this._configuration=new Ri(e.viewingMode===Ne.Global),this._tileTextureCache=new fc((n,a)=>r.newCache(n,a),"TileTexture"),this.tileGeometryCache=new S$(r)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(E(()=>this._overlayRenderer.rendersOccludedDraped,i=>{this.renderOccludedFlags=i?Tf:Di.Occlude,this.setNeedsRender()},je))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?jS:WS}set renderingDisabled(i){this._set("renderingDisabled",!!i),this.setDirty()}set visible(i){this._set("visible",!!i),this.setDirty()}updateHeading(i){var e;(e=this._tileRenderer)==null||e.updateHeading(i)}set transparency(i){this._configuration.transparencyMode!==i&&(this._configuration.transparencyMode=i,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(i){this._configuration.tileBorders!==i&&(this._configuration.tileBorders=i,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(i){this._configuration.visualizeNormals!==i&&(this._configuration.visualizeNormals=i,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(i){this._configuration.backfaceCullingEnabled!==i&&(this._configuration.backfaceCullingEnabled=i,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(i){this._set("renderOrder",i),this._setSortingDirty()}get layerUid(){return Qh}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(i){this._configuration.hasSlicePlane!==i&&(this._configuration.hasSlicePlane=i,this.setNeedsRender())}set textureFadingEnabled(i){this._configuration.textureFadingEnabled!==i&&(this._configuration.textureFadingEnabled=i,this.setNeedsRender())}set pbrMode(i){this._configuration.pbrMode!==i&&(this._configuration.pbrMode=i,this.setNeedsRender())}setDebugScreenSizePerspective(i){this._configuration.screenSizePerspective!==i&&(this._configuration.screenSizePerspective=i,this.setNeedsRender())}setRootTiles(i){this._rootTiles=i,this.setDirty()}setStencilEnabledLayerExtents(i){this._stencilEnabledLayerExtents=i,this._setSortingDirty()}setTileSize(i){this._tileSize=i,this._tileRenderer!=null&&(this._tileRenderer.tileSize=i),this.setDirty()}_ensureRenderData(i){i.renderData||(i.renderData=this._renderDataPool.acquire(),i.renderData.init(i,this._getLocalOriginOfTile(i)))}loadTile(i){this._ensureRenderData(i),this.updateTileGeometryState(i),this.reuseTextureFromParent(i)||this.updateTileTexture(i,ne.TEXTURE_FADING)}reuseTextureFromParent(i){var s;const e=i.parent;if(!e)return!1;const t=xr(1&i.lij[2]?.5:0,1&i.lij[1]?0:.5,.5,.5);return((s=e.renderData)==null?void 0:s.reuseTexture(i.renderData,t))??!1}updateTileTexture(i,e){this._tileRenderer!=null&&(this._tileRenderer.updateTileTexture(i,e===ne.TEXTURE_FADING?zt.FADING:zt.UNFADED),this.setNeedsRender(),i.resetPendingUpdate(e))}updateTileGeometryState(i){for(const t of i.layerInfo[xe.ELEVATION])t.pendingUpdates&=~ne.GEOMETRY;i.resetPendingUpdate(ne.GEOMETRY);const e=i.renderData.updateGeometryState();return e&&this.setDirty(),e}updateGeometryIfNeeded(i){i.loaded&&i.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(i){const e=i.renderData;e&&(e.releaseGeometry(),this._renderDataPool.release(e),e.clear(),i.renderData=null,i.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(i){const e=hI-Qp,t=Math.max(0,Math.floor((i.level-e)/Qp)*Qp);if(this._isGlobal&&t===0)return js;for(;i.parent&&i.level>t;)i=i.parent;return i.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(i){this._get("wireframe")!==i&&(this._set("wireframe",i),this.setNeedsRender())}setDirty(i=Me.UPDATE){this._patchesByOriginDirty=!0,this._context.requestRender(i)}_setSortingDirty(i=Me.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(i)}setNeedsRender(i=Me.UPDATE){this._context.requestRender(i)}initializeRenderContext(i){this._context=i,this._tileRenderer=new Y$(this._rctx,this._tileSize,this._techniques,this._tileTextureCache),this.updateTileBackground(),this._emptyTex=Ew(this._rctx)}uninitializeRenderContext(){this._emptyTex=We(this._emptyTex),this._tileRenderer=We(this._tileRenderer)}intersect(i,e,t,s){if(!this._rootTiles||i.options.selectOpaqueTerrainOnly&&i.options.selectionMode&&this.transparency!==Si.Opaque)return;const r=cI,n=dI;Te(r,s,t),$e(n,1/r[0],1/r[1],1/r[2]);const a=i.results.min,o=i.results.max,l=i.results.ground,h=i.options.store===ja.MIN,d=!!i.results.ground.target,u=uP(i.verticalOffset),p=i.tolerance;let _,f=h&&a.dist!=null?a.dist:1/0;const g=i.options,y=g.normalRequired||!g.backfacesTerrain,w=new K_(!1,y),x=C=>{const S=C.renderData;if(!(S!=null&&S.vao))return;const P=S.geometry;FP(Xp,P.boundingBox);const M=S.localOrigin;u!=null&&(u.localOrigin=M,u.applyToAabb(Xp));const $=Xp;if(Ro[0]=t[0]-M[0],Ro[1]=t[1]-M[1],Ro[2]=t[2]-M[2],!ib($,Ro,n,p,f))return;const O=(V,Y,le)=>{V.set(this.type,C,Y,le,xh),f=h&&a.dist!=null?a.dist:1/0},N=(V,Y,le)=>{if((!y||le!=null)&&V>=0&&(g.backfacesTerrain||ce(le,r)<0)&&(g.invisibleTerrain||!g.selectionMode||e==null||e(t,s,V))){if((l.dist==null||V<l.dist)&&O(l,V,le),g.isFiltered)return;g.store===ja.ALL&&(_==null?(_=nP(i.ray),O(_,V,le),i.results.all.push(_)):V<_.dist&&O(_,V,le)),(a.dist==null||V<a.dist)&&O(a,V,le),g.store!==ja.MIN&&(o.dist==null||V>o.dist)&&O(o,V,le)}},U=uI;Te(U,s,M);const{indices:L,indexCount:G}=P,A=P.vertexAttributes,R=A.getField(Ae.POSITION,h2),ee=new tE(R.typedBuffer,3,A.stride/4),z=G/3;if(!u&&z>J$){const V=C.renderData;V.intersectionData==null&&(V.intersectionData=new Aw(L,0,z,ee)),V.intersectionData.intersectRay(Ro,U,w,N)}else n2(Ro,U,0,z,L,ee,u,w,N)},T=this._rootTiles;T!=null&&(()=>{const C=this._tileIterator;C.reset(T);const S=i.options.invisibleTerrain;for(let P=C.next();P;P=C.next())!(P.visible||S&&P.intersectsClippingArea)||u==null&&!P.intersectsRay(t,r,p,f)||d&&this._useStencilForTile(P)?C.skipSubtree():x(P)})()}processScaleRangeQueries(i,e){var t;if(!e.done)for(this._updatePatchGroups();i.updating&&!e.done;){i.prepare();for(const s of this._visiblePatchesByOrigin.values())for(const r of s)((t=r.renderData)==null?void 0:t.textureReference)!=null&&i.queriesForTile(r);i.process(),e.madeProgress()}}acquireTechniques(i){const e=!!Li("enable-feature:terrain-shadows")&&i.bind.shadowMap.enabled;e!==this._castShadows&&(this._castShadows=e,this._patchesByOriginDirty=!0);const t=i.bind.viewshedEnabled;if(this._inViewshed!==t&&(this._inViewshed=t,this._patchesByOriginDirty=!0),i.bind.slot===J.OCCLUDED_TERRAIN){if(!(i.renderOccludedMask&Tf))return null}else{const s=this.transparency===Si.Opaque?J.OPAQUE_TERRAIN:J.TRANSPARENT_TERRAIN;if(i.bind.slot!==s)return null}if(this.transparency===Si.Invisible)return null;switch(this._configuration.screenSpaceReflections=this._configuration.cloudReflections=this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=!1,this._configuration.overlayMode=this._overlayRenderer.mode,i.output){case D.Color:case D.ColorEmission:return this._configuration.screenSpaceReflections=i.bind.ssr.lastFrameColor!=null,this._configuration.cloudReflections=i.bind.clouds.data!=null,this._configuration.receiveShadows=i.bind.shadowMap.ready,this._configuration.receiveAmbientOcclusion=i.bind.ssao!=null,this._acquireTechnique(i.output,i.bind.slot===J.OCCLUDED_TERRAIN);case D.Shadow:case D.ShadowExcludeHighlight:return this._castShadows?this._acquireTechnique(D.Shadow,!1):null;case D.ViewshedShadow:return this._inViewshed?this._acquireTechnique(D.ViewshedShadow,!1):null;case D.Depth:case D.Normal:return this._acquireTechnique(i.output,!1);case D.ObjectAndLayerIdColor:return this._acquireTechnique(D.ObjectAndLayerIdColor,!1);case D.Highlight:return this._overlayRenderer.hasHighlights?this._acquireTechnique(D.Highlight,!1):null}return null}render(i,e){switch(this._updatePatchGroups(),e.useStencil=!1,i.output){case D.Color:case D.ColorEmission:{const t=i.bind.slot===J.OCCLUDED_TERRAIN?Ns.Occluded:Ns.Color;this._renderMaterialPass(i,e,t);break}case D.Depth:case D.Normal:this._renderAuxiliaryPass(i,e,Ns.Color,this._visiblePatchesByOrigin);break;case D.Highlight:this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(Ns.Highlight)&&this._renderAuxiliaryPass(i,e,Ns.Highlight,this._visiblePatchesByOrigin);break;case D.Shadow:case D.ShadowExcludeHighlight:case D.ViewshedShadow:this._renderAuxiliaryPass(i,e,null,this._allPatchesByOrigin);break;case D.ObjectAndLayerIdColor:this._renderAuxiliaryPass(i,e,Ns.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(i){if(this._tileRenderer==null)return;const e=this._tileRenderer;let t;if(i!=null){const s=eg.toUnitRGBA(i);t=Pt(s[0]||0,s[1]||0,s[2]||0)}e.setBackground(t),this._allTiles.forAll(s=>e.updateTileTexture(s,zt.FADING)),this._configuration.tileBlendInput=e.backgroundIsGrid?zr.GridComposite:e.backgroundColor!=null?zr.ColorComposite:zr.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==Cl.NONE){const i=Array.from(this._visiblePatchesByOrigin.values()),e=this._stencilEnabledLayerExtents;for(const t of i)bD(this.renderOrder,t,e);i.sort((t,s)=>Kb(t[0],s[0],this.renderOrder)),this._visiblePatchesByOrigin=new Map(i.map(t=>[t[0].renderData.localOrigin,t])),this._patchSortingDirty=!1}}_rebuildPatchGroups(){var e;const i=this._rootTiles;if(i!=null){(e=i[0])==null||e.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of i)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(i){const e=this._tileIterator;for(e.resetOne(i);!e.done;){const t=e.next(),s=t.renderData;if(!s){this._numTilesCulled++;continue}const r=s.localOrigin;if(this._castShadows||this._inViewshed){let a=this._allPatchesByOrigin.get(r);a||(a=[],this._allPatchesByOrigin.set(r,a)),a.push(t)}if(!t.visible){this._numTilesCulled++,e.skipSubtree();continue}let n=this._visiblePatchesByOrigin.get(r);n||(n=[],this._visiblePatchesByOrigin.set(r,n)),n.push(t),e.skipSubtree()}}_useStencilForTile(i){for(const e of this._stencilEnabledLayerExtents)if(i.intersectsExtent(e))return!0;return!1}_renderAuxiliaryPass(i,e,t,s){const r=i.rctx;this._passParameters.overlayContent=t,r.bindTechnique(e,i.bind,this._passParameters);const n=this._stencilEnabledLayerExtents.length>0;s.forEach(a=>{this._drawParameters.origin=a[0].renderData.localOrigin,e.program.bindDraw(i.bind,this._passParameters,this._drawParameters);for(let o=0;o<a.length;o++)this._renderPatch(i,e,a[o],_i.TRIANGLES,n,t)}),i.rctx.bindVAO(null)}_renderMaterialPass(i,e,t){var u;const{rctx:s}=i;this._passParameters.overlayContent=t,s.bindTechnique(e,i.bind,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const r=i.bind.camera,n=e.program;if(this._configuration.screenSizePerspective&&this.pointsOfInterest){const p=Y1(this._stage.viewingMode,this._ellipsoidRadius),_=this.pointsOfInterest.centerOnSurfaceFrequent.distance;p.update({distance:_,fovY:r.fovY})}const a=this._stencilEnabledLayerExtents.length>0,o=t===Ns.Occluded;o&&(n.bindTexture("tex",this._emptyTex),n.setUniform3fv("textureOpacities",js),n.setUniform4fv("texOffsetAndScale",ar));const l=((u=this._tileRenderer)==null?void 0:u.backgroundColor)!=null?this._tileRenderer.backgroundColor:js;this._configuration.tileBlendInput===zr.ColorComposite&&n.setUniform3fv("backgroundColor",l);const h=this.wireframe?_i.LINES:_i.TRIANGLES;this._configuration.textureFadingEnabled&&n.bindTexture("texNext",this._emptyTex);const d=this._visiblePatchesByOrigin;for(const p of d.values()){const _=p[0].renderData.localOrigin;this._drawParameters.origin=_,e.program.bindDraw(i.bind,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(const f of p){const g=f.renderData,y=g.textureReference;if(y!=null){if(!o){n.setUniform4fv("texOffsetAndScale",y.offsetAndScale),n.bindTexture("tex",y.texture.texture);const w=g.textureFadeFactor,x=w<1?g.nextTextureReference:null;this._configuration.textureFadingEnabled&&x!=null&&w<1?(n.setUniform1f("fadeFactor",w),n.setUniform4fv("nextTexOffsetAndScale",x.offsetAndScale),n.setUniform3fv("nextTexOpacities",x.opacities),n.bindTexture("texNext",x.texture.texture)):n.setUniform1f("fadeFactor",1),g.textureIsFading&&this.setNeedsRender(),n.setUniform3fv("textureOpacities",y.opacities)}this._renderPatch(i,e,f,h,a,t),f.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}i.rctx.bindVAO(null)}_renderPatch(i,e,t,s,r,n){const a=t.renderData,o=a.vao,l=o==null?void 0:o.indexBuffer;if(!o||l==null)return void(Ii&&console.error("Rendered tile with no indices: ",t.lij," : ",a));const h=e.program;n==null||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,a.overlay),r&&(e.useStencil=this._useStencilForTile(t),i.rctx.setPipelineState(e.getPipeline()));const d=a.geometry.indexCount;i.rctx.bindVAO(o),h.assertCompatibleVertexAttributeLocations(o),i.rctx.drawElements(s,d,l.indexType,0)}_bindOverlayPatchData(i,e){i.setUniform4fv("overlayTexOffset",e.offsets),i.setUniform4fv("overlayTexScale",e.scales)}_acquireTechnique(i,e){return this._configuration.output=i,this._configuration.renderOccluded=e,this._techniques.acquire(ID,this._configuration)}get test(){}};c([m({readOnly:!0})],Rs.prototype,"_isGlobal",null),c([m()],Rs.prototype,"renderOccludedFlags",void 0),c([m({value:!1})],Rs.prototype,"renderingDisabled",null),c([m({value:!0})],Rs.prototype,"visible",null),c([m()],Rs.prototype,"renderPatchBorders",null),c([m()],Rs.prototype,"visualizeNormals",null),c([m()],Rs.prototype,"cullBackFaces",null),c([m({value:Cl.FRONT_TO_BACK})],Rs.prototype,"renderOrder",null),c([m()],Rs.prototype,"wireframe",null),Rs=c([I("esri.views.3d.terrain.TerrainRenderer")],Rs);const cI=v(),dI=v(),Ro=v(),uI=v();let pI=class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}},Dr=class extends De{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",()=>this._update()),E(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!wh(t)||t.isRejected())&&!(t.isFulfilled()&&!mI(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!((t==null?void 0:t.type)==="vector-tile"||o1(t)))),e)if(e.isResolved()){const t=$u(e,this.viewSpatialReference,this.viewingMode);if(t!=null){const s=new fo(t.tileInfo);this._lockTilingScheme(s)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===Ne.Global){const t=e.levels.length-1,s=e.spatialReference;s.isWebMercator?e=fo.makeWebMercatorAuxiliarySphere(t):bT(s)&&(e=fo.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles(E(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Ne.Global){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=fo.WebMercatorAuxiliarySphere:wT(e)&&(this.tilingScheme=fo.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;e==null||Ga(e,this.extent)||(this.tilingScheme=fo.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}};function mI(i,e,t){return $u(i,e,t)!=null}c([m()],Dr.prototype,"tilingScheme",void 0),c([m({readOnly:!0})],Dr.prototype,"extent",void 0),c([m({value:!1})],Dr.prototype,"tilingSchemeLocked",void 0),c([m({constructOnly:!0})],Dr.prototype,"viewSpatialReference",void 0),c([m({constructOnly:!0})],Dr.prototype,"layers",void 0),c([m({constructOnly:!0})],Dr.prototype,"extentHelper",void 0),c([m({constructOnly:!0})],Dr.prototype,"viewingMode",void 0),Dr=c([I("esri.views.3d.terrain.TilingSchemeLogic")],Dr);let _I=class{constructor(){this._offset=Ss(),this.scale=0}get offset(){return this._offset}init(e,t,s,r){this.tile=e,this._offset[0]=t,this._offset[1]=s,this.scale=r}dispose(){this.tile=null,this._offset[0]=0,this._offset[1]=0,this.scale=0}};var Ud;let Ee=Ud=class extends Cr.EventedMixin(De){constructor(i){var e,t,s;super(i),this._scaleRangeQueries=new Fd,this._iteratorPool=new Ya(Zb,r=>r.remove=()=>this._iteratorPool.release(r)),this._postorderIterator=new fD,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new pI,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=v(),this._eyePosSurfaceSR=v(),this._splitLimits=new rr,this._frustum=Rm(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new H2,this._frameTask=lu,this._allTiles=new Lt,this._upsampleInfoPool=new Ya(_I),this._shouldEmitChangeEvent=!1,this._destroying=!1,this._rootTilesExtent=mi(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=pi.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new il(1/0,-1/0),this.rootTileElevationBounds=new il(1/0,-1/0),this._sebProjectorMap=new Map,this._sebProjectorCache=x2(),this._tilingSchemeSpatialReference=null,this._radiusModifier=Math.cos(Math.PI/16/16),this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this.overlayManager=new Ji({...i,surface:this}),this._isGlobal=!((t=(e=i.view)==null?void 0:e.state)!=null&&t.isLocal),this._isGeographic=((s=this._spatialReference)==null?void 0:s.isGeographic)??!1,this._tileConstructor=this._isGlobal?x$:v$,this._ellipsoid=Ot(i.view.spatialReference)}initialize(){const i=this.view,e=i.resourceController,t=e.memoryController;this._tileCache=new fc((l,h)=>t.newCache(l,h),"terrain-tile"),this._upsampleMapCache=t.newCache("terrain-upsample",l=>l.unloadMapData()),this._elevationQueryCache=new T2(t.newCache("elevation-query"));const s=this.overlayManager;this._renderer=new Rs(s.renderer,i._stage,this._allTiles,this._ellipsoid.radius,t),this.addHandles([E(()=>s.renderer.isEmpty,()=>this._evaluateTransparency()),E(()=>this.renderer.visible,l=>this.suspended=!l),E(()=>this.heading,l=>{this._renderer.updateHeading(l),this._updateTileTextures(zt.FADING)}),E(()=>{var l,h;return{heading:(l=i.camera)==null?void 0:l.heading,state:(h=i.state)==null?void 0:h.mode}},({heading:l,state:h})=>{if(l==null)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(l/90)%360);const d=Math.round(l)%360,u=Math.abs(d-this.heading);(h===_t.IDLE||Math.min(u,360-u)>=30)&&(this.heading=d)})],"overlayManager"),this.addHandles([E(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?zt.UNFADED:zt.IMMEDIATE)},Ge),E(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?zt.UNFADED:zt.IMMEDIATE),Ge),E(()=>this.backgroundColor,(l,h)=>{l!=null&&l.equals(h)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(l))},je),E(()=>this.snapLevel,()=>this._viewChanged=!0,je),E(()=>this.view.pointsOfInterest,l=>{this._renderer.pointsOfInterest=l,this._watchUpdatingTracking.removeAll(),l&&this._watchUpdatingTracking.add(()=>l.focus.renderLocation,()=>this._allTilesSorted=!1)}),E(()=>fs.TERRAIN_TILE_TREE_SHOW_TILES,l=>{l&&!this._treeDebugger?X(()=>import("./TerrainTileTree3DDebugger-C7jfecMr.js"),__vite__mapDeps([564,1,48,2,14,9,6,10,11,12,4,5,13,15,16,20,21,22,23,24,7,565,50,51,80,81,60,43,44,45,46,47,42,82,83,41,49,52,53,54,8,55,28,56,57,58,59,84]),import.meta.url).then(({TerrainTileTree3DDebugger:h})=>{!this._treeDebugger&&fs.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new h({view:i}))}):l||(this._treeDebugger=de(this._treeDebugger))},dt)]);const{spatialReference:r}=i;this._extentHelper=aD(this.viewingMode,{layers:i.map.allLayers,layerViews:i.allLayerViews,viewSpatialReference:r});const n=new q2({getCollections:()=>{var l,h;return(h=(l=i.defaultsFromMap)==null?void 0:l.mapCollections)==null?void 0:h.map(({layers:d})=>d)},getChildrenFunction:l=>l&&"layers"in l?l.layers:null}),a=new Dr({layers:n,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:r});this._set("tilingSchemeLogic",a),this._updateTilingScheme(),this._elevationDataRequester=e.createStreamDataRequester(Fr.ELEVATION),this._mapDataRequester=e.createStreamDataRequester(Fr.BASEMAP);const o=e.scheduler;this._frameTask=o.registerTask(ni.TERRAIN_SURFACE,this),this.addHandles([E(()=>this._extentHelper.stencilEnabledExtents,l=>this._renderer.setStencilEnabledLayerExtents(l),dt),E(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),je),E(()=>this.extent,()=>this._updateRootTiles(),dt),i.on("resize",()=>this._viewChangeUpdate()),E(()=>{const l=i.state;return[this._lodBias,this.lodSnappingEnabled,i.quality,l.camera,l.contentCamera,l.fixedContentCamera]},()=>this._viewChangeUpdate(),Ge),E(()=>{var l;return(l=i.qualitySettings)==null?void 0:l.fadeDuration},l=>this._renderer.textureFadingEnabled=l>0,dt),E(()=>{var l;return(l=i.qualitySettings)==null?void 0:l.physicallyBasedRenderingEnabled},l=>this._renderer.pbrMode=l?jt.Simplified:jt.Disabled,dt),E(()=>{var l;return(l=i.qualitySettings)==null?void 0:l.tiledSurface.elevationLevelDelta},()=>this._updateAllTileGeometries()),E(()=>this._userClippingExtent,()=>this._updateClippingExtent(),je)]),this.addHandles(i.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._destroying=!0,this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",de(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((i,e)=>this._unregisterTiledLayerView(e)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",de(this.overlayManager)),this._tileCache=de(this._tileCache),wg.prune(),this._treeDebugger=de(this._treeDebugger),this._renderer=de(this._renderer),this._iteratorPool=de(this._iteratorPool),this._upsampleMapCache=de(this._upsampleMapCache),this._elevationQueryCache=de(this._elevationQueryCache),this._set("view",null),this._extentHelper=de(this._extentHelper),this._upsampleInfoPool=de(this._upsampleInfoPool),jD()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnappingEnabled){const{view:i,tilingScheme:e}=this,t=i.scale;if(e&&t){const s=e.levelAtScale(t)+i.qualitySettings.tiledSurface.lodBias,r=e.getMaxLod();return s<=0?null:Math.min(s,r||1/0)}}return null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){const{spatialReference:i}=this,{clippingArea:e}=this.view;if(e==null||i==null)return null;const t=mi(),s=Yv(e,t,i)?t:null,r=this._get("extent");return Ga(s,r)?r:s}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const i=vm(this.groundExtent,this._userClippingExtent,mi()),e=this._get("extent");return Ga(i,e)?e:i}get groundExtent(){return this._tilingSchemeExtent!=null?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){var i;return(i=this.tilingSchemeLogic)==null?void 0:i.extent}get updating(){var i,e;return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||(i=this._watchUpdatingTracking)!=null&&i.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||(e=this.overlayManager)!=null&&e.updating)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){var i,e,t;return((t=(e=(i=this.view)==null?void 0:i.map)==null?void 0:e.ground)==null?void 0:t.opacity)??1}set baseOpacity(i){this.view.map.ground.opacity=i}get viewingMode(){return this.view.state.viewingMode}get ready(){return this._rootTiles!=null}set renderOrder(i){this._renderer.renderOrder=i,this._set("renderOrder",i)}get rootTiles(){return this._rootTiles}get spatialReference(){var i;return((i=this.tilingScheme)==null?void 0:i.spatialReference)??null}get backgroundColor(){var i,e,t;return(t=(e=(i=this.view)==null?void 0:i.map)==null?void 0:e.ground)==null?void 0:t.surfaceColor}set backgroundColor(i){this.view.map.ground.surfaceColor=i}set slicePlaneEnabled(i){this._renderer.slicePlaneEnabled=i,this._set("slicePlaneEnabled",i),this._evaluateTransparency()}get tilingSchemeLocked(){var i;return((i=this.tilingSchemeLogic)==null?void 0:i.tilingSchemeLocked)??!1}get wireframe(){var i;return(i=this._renderer)==null?void 0:i.wireframe}set wireframe(i){i!==this._renderer.wireframe&&(this._renderer.wireframe=i,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===Si.Opaque}set suspended(i){this._set("suspended",i),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(i,e,t,s){this._renderer.intersect(i,e,t,s)}getElevationLevelDelta(i){return i<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(i,e,t,s){const r=this._rootTiles;if(!(r!=null&&r.length)||r[0].layerInfo[xe.ELEVATION].length===0)return null;let n=this._elevationProjectorCache.get(s);if(n===void 0&&(n=Dm(s,this._spatialReference)??null,this._elevationProjectorCache.set(s,n)),n==null)return Pe.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const a=$e(eh,i,e,t);return n(a,0,a,0),Ly(r,a[0],a[1])}getElevations(i,e,t){const s=this._rootTiles,r=s?s[0].layerInfo[xe.ELEVATION].length:0;if(s!=null&&s.length&&r!==0)for(let n=0;n<e;++n){const a=3*n;t(n,Ly(s,i[a],i[a+1]))}else for(let n=0;n<e;++n)t(n,null)}getScale(i){if(!this.tilingScheme)return null;if(!Ih(i,eh,this.spatialReference))return Pe.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const e=this._rootTiles;if(e!=null){for(const t of e)if(t!=null&&t.containsPoint(eh)){let s=t;for(;s.children[0]&&!s.rendered;){const r=s.children[0].extent;let n=0;eh[0]>r[2]&&(n+=1),eh[1]<r[1]&&(n+=2),s=s.children[n]}return this._getLodBiasCorrectedScale(s.level)}}return 1/0}_ensureSEBProject(i){const e=this._sebProjectorMap.get(i);if(e)return e;const t=Dm(i,this._tilingSchemeSpatialReference,this._sebProjectorCache)??null;return this._sebProjectorMap.set(i,t),t}getSphereElevationBounds(i,e){const t=this._ensureSEBProject(e);if(t==null)return Pe.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;sP(i,Ao);const s=At(Ao);t(s,0,s,0);const r=new gu,n=this._rootTiles;if(n!=null){const a=[];for(const l of n)a.push(l);let o=0;for(;o<a.length;){const l=a[o];if(++o,!hf(l.extent,Ao))continue;const h=l.children;if(h[0]==null||l.rendered)r.expandElevationRangeValues(l.elevationBoundsMin,l.elevationBoundsMax);else for(const d of h)a.push(d)}}return r}getRootElevationBounds(){return new gu(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getLowerBoundRadius(){const i=(this._ellipsoid.radius+this.visibleElevationBounds.min)*this._radiusModifier;return Math.min(i,this._ellipsoid.radius)}getSphereScale(i,e){if(!this.tilingScheme)return null;if(!Ih(i,At(Ao),this.spatialReference))return Pe.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;Ao[3]=e;let t=null;const s=n=>{if(n&&hf(n.extent,Ao)){const a=n.children;if(a[0]&&!n.rendered)for(const o of a)s(o);else{const o=this._getLodBiasCorrectedScale(n.level);t=t==null?o:Math.min(t,o)}}},r=this._rootTiles;if(r!=null)for(const n of r)s(n);return t}queryVisibleScaleRange(i,e,t,s){const r=e?this.tilingScheme.levelAtScale(e):0,n=t?this.tilingScheme.levelAtScale(t):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(i,r+a,n+a,s)}_evaluateTransparency(){const i=this.baseOpacity,e=this.overlayManager.renderer.isEmpty,t=this._renderer.transparency,s=this._allSurfaceLayersTransparent()?e?Si.Invisible:Si.InvisibleWithDraped:i>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?Si.Opaque:Si.Transparent;return this._renderer.transparency=s,t!==s}_updateTilingScheme(){var t,s,r,n;const i=this.tilingSchemeLogic.tilingScheme;if(i===this.tilingScheme)return;ti(!!i,"tiling scheme cannot be reset to undefined"),this._isGlobal=!((s=(t=this.view)==null?void 0:t.state)!=null&&s.isLocal),this.tilingScheme&&this._removeAllTiles();const e=(i==null?void 0:i.spatialReference)??pi.WebMercator;this._spatialReference=e,this._isWebMercator=!!(e!=null&&e.isWebMercator),this._isWebMercatorOnPlateCarree=this._isWebMercator&&Qv((r=this.view)==null?void 0:r.renderSpatialReference),this._isGeographic=(e==null?void 0:e.isGeographic)??!1,this._set("tilingScheme",i),this._tilingSchemeSpatialReference=(n=this.tilingScheme)==null?void 0:n.spatialReference,this._sebProjectorMap.clear(),this._updateClippingExtent(),i&&(this._updateTiledLayers(),this._renderer.setTileSize(i.pixelSize),this.overlayManager.setSpatialReference(i.spatialReference),this._updateRootTiles())}_acquireTile(i,e,t,s){const r=this._tileCache.pop(Ud._tileMemcacheKey);return r?(r.init(i,e,t,s,this),r):new this._tileConstructor(i,e,t,s,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:i,tilingScheme:e}=this;if(!e)return;const t=fI;let s=e.rootTilesInExtent(i,t,5*Pc);if(this._rootTiles!=null){if(s.length>Pc)return void Pe.getLogger(this).warn(xT);const r=this._rootTiles.map(a=>a.lij),n=xx(r,s,Nd);if(this._updatingRootTiles=!0,n.removed.length>0||n.added.length>0){const a=this._rootTiles.filter(o=>!(n.removed.findIndex(l=>Nd(l,o.lij))>-1)||(this._purgeTile(o),!1));n.added.forEach(o=>a.push(this._newRootTile(o))),this._setRootTiles(a)}}else this._updatingRootTiles=!0,s.length>Pc&&(Pe.getLogger(this).warn(CT),s=e.rootTilesInExtent(i,t,Pc)),this._setRootTiles(s.map(r=>this._newRootTile(r)));Ga(t,this._rootTilesExtent)||(this._rootTilesExtent=mi(t)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const i=this._allTiles.filter(e=>e.loaded&&e.intersectsClippingArea);i.sort(Ur),i.forEach(e=>this._renderer.updateTileGeometryState(e)),i.forEach(e=>e.renderData.updateNeighborData()),this._updateTilesGeometries(i),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(i){if(i.length===0)return;i.sort(Ur);const e=this.renderer;i.forEach(t=>e.updateGeometryIfNeeded(t)),i.forEach(t=>this._pendingTilesForElevationUpdateEvent.add(t))}_shouldSplit(i){return i.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===ne.SPLIT}_newRootTile(i){const e=this._acquireTile(0,i[1],i[2],null);return this._shouldSplit(e)&&e.setPendingUpdate(ne.SPLIT),this._loadTile(e),this._markTileToUpdate(e),this._updateRootTileElevationBounds(),e}_setRootTiles(i){if(this._rootTiles=i,this._allTiles.clear(),i!=null){const e=this._iteratorPool.acquire();for(e.reset(i);!e.done;)this._allTiles.push(e.next());e.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(i)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(i){i.updateClippingStatus(this.extent)&&i.resetPendingUpdate(ne.GEOMETRY)&&this._updateTileGeometryState(i)}_updateTilesVisibility(i){if(i==null)return;const e=ED(i),t=this.visibleElevationBounds;let s=e?t.min:1/0,r=e?t.max:-1/0;const n=this.extent,a=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(i);!o.done;){const l=o.next();l.updateClippingStatus(n)&&l.resetPendingUpdate(ne.GEOMETRY)&&this._updateTileGeometryState(l),l.computeVisibility(),l.updateScreenDepth(a),l.renderData&&(s=Math.min(l.elevationBoundsMin,s),r=Math.max(l.elevationBoundsMax,r))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(s)&&isFinite(r)&&(t.min!==s||t.max!==r)&&(this.visibleElevationBounds=new il(s,r))}_updateRootTileElevationBounds(){let i=1/0,e=-1/0;const t=this._rootTiles;t!=null&&t.forEach(({elevationBoundsMin:r,elevationBoundsMax:n})=>{i=Math.min(i,r),e=Math.max(e,n)});const s=this.rootTileElevationBounds;s.min===i&&s.max===e||(this.rootTileElevationBounds=new il(i,e))}_updateViewDependentParameters(){const{camera:i,contentCamera:e}=this.view.state,t=Math.tan(.5*e.fovX),s=Math.tan(.5*e.fovY),r=this.tilingScheme.pixelSize,n=2**-this._lodBias*i.pixelRatio;this._splitLimits.aboveGround=i.aboveGround,this._splitLimits.fovX=t,this._splitLimits.fovY=s,this._splitLimits.relativeWidthLimit=r/i.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=r/i.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=Am(this._splitLimits.frustum??Rm(),e.frustum):this._splitLimits.frustum=null,Am(this._frustum,i.frustum),ue(this._eyePosRenderSR,e.eye),Yh(i.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(i){i.updateVisibility(),this._renderer.updateTileGeometryState(i)&&this._markTileToUpdate(i),this._usedMemory=null}_markAllTileNeighborsForUpdate(i){i.forEachLoadedNeighbor(e=>{this._layerViews[xe.MAP].some(eu)&&e.setPendingUpdate(ne.TEXTURE_FADING),this._pendingTilesToUpdate.add(e)})}_updateTileTexture(i,e){const t=i.resetPendingUpdate(ne.TEXTURE_FADING)?ne.TEXTURE_FADING:!!i.resetPendingUpdate(ne.TEXTURE_NOFADING)&&ne.TEXTURE_NOFADING;t&&(this._renderer.updateTileTexture(i,t),this._usedMemory=null,e.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const i=Yp.extent;Za(i),this._pendingTilesForElevationUpdateEvent.forEach(e=>al(i,e.extent,i)),this._pendingTilesForElevationUpdateEvent.clear(),Yp.spatialReference=this.spatialReference,this.emit("elevation-change",Yp),this._shouldEmitChangeEvent=!1}runTask(i){this._handleLayerViewChanges(i),this._frameTask.processQueue(i),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,i),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(i),this._sortTiles(i);const e=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(i,e),this._updateElevation(i),this._updateTextures(i),e||this._mergeAndSplit(i,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),i.done&&i.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),Ii&&this._checkTileInvariant(),!i.hasProgressed)return Xi}_checkTileInvariant(){const i=new Map;this._allTiles.forAll(e=>i.set(e,new Set)),this._allTiles.forAll(e=>{var t;if(ti(e.rendered===e.leaf,` rendered ${e.rendered} != ${e.leaf} leaf`),!e.leaf){const s=n=>n.unmergableChildCount===0&&n.maxLevelDeltaNeighborCount===0,r=e.children.reduce((n,a)=>n+(s(a)?0:1),0);if(ti(e.unmergableChildCount===r,` Tile[${e.lij.toString()}] unmergeable child count mismatch: actual ${e.unmergableChildCount} vs ${r}`),e.hasPendingUpdate(ne.MERGE)){ti(!e.hasPendingUpdate(ne.SPLIT),"Tile can be both split and merge at the same time");for(const n of e.children)ti(n.leaf||n.hasPendingUpdate(ne.MERGE),"Child of tile to merge must also merge")}}for(let s=0;s<4;++s){if(e.rendered){const o=(t=e.renderData)==null?void 0:t.geometryState.edgePeerNeighbors[s];if(o!=null){{const l=e.level-o.level<=Zt;l||(console.log(`tile level delta [${e.lij.toString()}] vs [${o.lij.toString()}] > ${Zt}  (edge[${s}])`),ti(l,`tile level delta [${e.level}] vs [${o.level}] > ${Zt}`))}ti(e.level-o.level<=Zt,`Max tile lod delta exceeded: [${e.lij.toString()}] vs [${o.lij.toString()}]`)}}const r=e.level-Zt,n=o=>o.leaf||o.level===e.level,a=e.findNeighborTile(cr[s],n);if(a!=null){if(e.leaf&&e.level>=Zt){let o=a;for(;e.level-o.level<Zt;)o=o.parent;const l=[r,e.lij[1]>>Zt,e.lij[2]>>Zt];if(!Nd(l,o.lij)){const h=i.get(o);ti(!h.has(e),"Cannot already have neighbor"),h.add(e)}}ti(a.rendered||a.level===e.level,"Non-same-level-neighbor of rendered must be rendered"),ti(e.level-a.level<=Zt,`Tile level delta [${e.level}] vs [${a.level}] > ${Zt}`)}}}),this._allTiles.forAll(e=>{const t=e.maxLevelDeltaNeighborCount,s=i.get(e);ti(t===s.size,`Tile[${e.lij.toString()}] merge-blocker mismatch: actual ${t} vs ${s.size}`)})}_updateAllTilesStatus(i){if(!this._viewChanged||!this._rootTiles||i.done)return;this._viewChanged=!1;const e=new yI(this._allTiles.length);e.pushAll(this._rootTiles);const t=this.snapLevel,s=this._splitLimits,r=this._eyePosRenderSR;this._allTiles.forAll(a=>{a.maxLevelDeltaNeighborCount=0,a.unmergableChildCount=0});const n=this.view.state.contentCamera.viewProjectionMatrix;for(;!e.empty;){const a=e.pop(),o=a.parent,l=o!=null&&o.hasPendingUpdate(ne.MERGE),h=l?ne.MERGE:a.shouldSplit(s,r,t),d=h===ne.SPLIT;a.leaf?Zp(a,d):e.pushAll(a.children),l?(a.resetPendingUpdate(ne.SPLIT),a.leaf||a.setPendingUpdate(ne.MERGE),this._updateClippingStatus(a),a.updateVisibility(),a.updateScreenDepth(n)):d?(a.resetPendingUpdate(ne.MERGE),a.leaf&&a.setPendingUpdate(ne.SPLIT)):(a.resetPendingUpdate(ne.SPLIT)&&a.updateAgentSuspension(),h===ne.ELEVATION&&a.updateAgents(xe.ELEVATION),a.leaf||(a.setPendingUpdate(ne.MERGE),a.resetPendingUpdate(ne.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),i.madeProgress()}_sortTiles(i){i.done||this._allTilesSorted||(SD(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),i.madeProgress())}_markTileToUpdate(i){F(i.loaded),i.intersectsClippingArea&&(this._pendingTilesToUpdate.add(i),this._markAllTileNeighborsForUpdate(i))}_updatePendingTileGeometries(){const i=this._pendingTilesToUpdate,e=Array.from(i.keys()).filter(r=>r.loaded&&r.intersectsClippingArea);if(e.length===0)return void i.clear();const t=(r,n)=>{!(n!=null&&n.loaded)||!n.intersectsClippingArea||n.level<r.level||i.has(n)||(i.add(n),e.push(n),n.renderData.updateNeighborData())};e.sort(Ur);const s=e.length;for(let r=0;r<s;++r){const n=e[r];F(n.loaded),F(n.intersectsClippingArea);const a=n.renderData;a.updateNeighborData();const o=a.dirtyEdgeResolutions,l=a.geometryState,h=d=>{var p;const u=Kd[d];t(n,(p=l.cornerPeerNeighbors[d])==null?void 0:p.findCorner(Jd(u),_=>_.loaded))};for(let d=0;d<4;++d)if(o&1<<d){const u=a.geometryState.edgePeerNeighbors[d];u&&(u==null?void 0:u.level)>=n.level&&u.forAllSubtreeOnSide(A_(cr[d]),p=>!(!p.loaded||!p.intersectsClippingArea)&&(F(i.has(p)||Ur(n,p)<0),t(n,p),!0)),h((d+1)%4),h(d)}}i.clear(),this._updateTilesGeometries(e),this._shouldEmitChangeEvent=!0,Ii&&xm&&this.checkAllTilesWaterproofness()}_mergeAndSplit(i,e){if(this.suspended||i.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let t=!1;const s=this.view.state.fixedContentCamera;let r=!1;for(;!i.done;){r=!0;let n=!1;const a=!this._allTiles.some(o=>{if(!t&&!s&&!o.visible)return i.done;let l=o;if(o.hasPendingUpdate(ne.MERGE)){if(!e||o.unmergableChildCount>0)return i.done;for(o.resetPendingUpdate(ne.MERGE);l.parent!=null&&l.parent.unmergableChildCount===0&&l.parent.resetPendingUpdate(ne.MERGE);)l=l.parent;this._mergeTile(l),n=!0,i.madeProgress()}else if(o.resetPendingUpdate(ne.SPLIT)){let h=!0;const d=o.level;if(d>=Zt){const u=p=>p.leaf||d-p.level<Zt;for(let p=0;p<4;++p){const _=o.findNeighborTile(cr[p],u);_!=null&&d-_.level===Zt&&(h=!1,Ii&&(F(_.leaf),F(_.hasPendingUpdate(ne.SPLIT))))}}h?(this._splitTile(o),i.madeProgress(),n=!0):o.setPendingUpdate(ne.SPLIT)}return i.done});if(n&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),a){if(!t){t=!0;continue}if(!n)break}else this._allTilesDirty=!0}r?i.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(i)}_updateElevation(i){i.done||(this._allTiles.some(e=>(e.resetPendingUpdate(ne.GEOMETRY)&&(this._updateTileGeometryState(e),this._shortBatches&&this._updatePendingTileGeometries(),i.madeProgress()),i.done)),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(i){i.done||this._allTiles.some(e=>(this._updateTileTexture(e,i),i.done))}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(Me.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const i=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-i)*TT}_getLodBiasCorrectedScale(i){const e=this.tilingScheme.levels,t=W(i-this._lodBias,0,e.length-1),s=t-Math.floor(t);return e[Math.floor(t)].scale*(1-s)+e[Math.ceil(t)].scale*s}_removeAllTiles(){this._rootTiles!=null&&(this._rootTiles.forEach(i=>this._purgeTile(i)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.renderer.visible=!1}_purgeSubtree(i){const e=i.children;e[0]&&(this._purgeTile(e[0]),this._purgeTile(e[1]),this._purgeTile(e[2]),this._purgeTile(e[3]),i.clearChildren())}_purgeTile(i){i.leaf?Ny(i):this._purgeSubtree(i),this._allTiles.removeUnordered(i),this._unloadTile(i),i.dispose(),this._tileCache.put(Ud._tileMemcacheKey,i)}_unloadTile(i){this._pendingTilesToUpdate.delete(i),this._pendingTilesForElevationUpdateEvent.delete(i),i.unload(this._renderer)}_splitTile(i){ti(i.leaf,"Tile that is already split should not be split again!"),ti(i.rendered,"Tile marked to split is not rendered"),Ny(i);const e=i.createChildren();this._allTiles.pushArray(e),i.updateAgentSuspension(),ti(i.rendered,"parent should be rendered"),e.forEach(t=>this._loadTile(t)),e.forEach(t=>this._pendingTilesToUpdate.add(t)),this._unloadTile(i),this._markAllTileNeighborsForUpdate(i),this._emitTileScaleChange(i,i.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),e.forEach(t=>Zp(t,t.hasPendingUpdate(ne.SPLIT))),++this._performanceInfo.numSplit}_emitTileScaleChange(i,e=i.level){ld.spatialReference=this.spatialReference,ld.extent=i.extent,ld.scale=this._getLodBiasCorrectedScale(e),this.emit("scale-change",ld)}createTile(i,e,t,s){ti(!!s,"createTile sanity check");const r=this._acquireTile(i,e,t,s);return r.updateClippingStatus(this.extent),r.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(r)&&r.setPendingUpdate(ne.SPLIT),r}get _shortBatches(){return this.view.state.mode!==_t.IDLE}_mergeTile(i){ti(!i.hasPendingUpdate(ne.SPLIT),"_mergeTile sanity check"),ti(!i.leaf,"Cannot merge a leaf"),i.leaf||(this._purgeSubtree(i),ti(!i.renderData,"_mergeTile sanity check"),this._loadTile(i),this._markTileToUpdate(i),this._emitTileScaleChange(i),this._shortBatches&&this._updatePendingTileGeometries(),Zp(i,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(i){i.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(i)}_handleLayerViewChanges(i=pn){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let e=!1;const t=new Set;let s=-1;for(let r=this.view.allLayerViews.length-1;r>=0;r--){const n=this.view.allLayerViews.items[r];if(t.add(n.uid),Cm(n)||Fl(n))if(this._basemapLayerViewHandles.has(n.uid)&&!Fl(n)){const a=this._layerClassFromLayerView(n),o=this._getLayerIdxByUID(a,n.uid);o!=null&&((o<s||s==null)&&(e=!0),s=o)}else this._registerTiledLayerView(n),n.layer.loaded&&(e=!0)}this._basemapLayerViewHandles.forEach((r,n)=>{t.has(n)||(this._unregisterTiledLayerView(n),e=!0)}),e&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),i.madeProgress()}_allSurfaceLayersTransparent(){var e,t;let i=((t=(e=this.view.map)==null?void 0:e.ground)==null?void 0:t.opacity)===0;for(const s of this.view.allLayerViews.items)if(wf(s)&&!gd(s.layer)&&s.fullOpacity!==0)return i=!1,i;return i}_hasCompositeBlendMode(){for(const i of this.view.allLayerViews.items)if((Lh(i)||Fl(i))&&E$(i_[i.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(i){return xf(i)?xe.ELEVATION:xe.MAP}_registerTiledLayerView(i){const e=[];if((Lh(i)||Fl(i))&&e.push(E(()=>i.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(zt.UNFADED)})),!Fl(i)){const t=this._layerClassFromLayerView(i);e.push(E(()=>i.suspended,()=>this._updateTiledLayers())),e.push(E(()=>i.fullOpacity,()=>this._updateTileTextures(zt.UNFADED))),e.push(E(()=>"effectiveScaleRange"in i.layer?i.layer.effectiveScaleRange:null,()=>this._restartAllAgents(t))),e.push(i.on("data-changed",()=>{const s=this._getLayerIdxByUID(t,i.uid);s!=null&&this._invalidateLayerData(s,t)}))}this._unregisterTiledLayerView(i.uid),this._basemapLayerViewHandles.set(i.uid,e)}_unregisterTiledLayerView(i){const e=this._basemapLayerViewHandles.get(i);if(e){for(const t of e)t.remove();this._basemapLayerViewHandles.delete(i)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const i=this.view.allLayerViews,e=[[],[]];let t=null;i.forEach(s=>{if(!s.layer||s.suspended||!Cm(s)||!s.fullExtent)return;const r=this._layerClassFromLayerView(s);if(r===xe.MAP){const n=s.displayLevelRange.maxLevel;n!==1/0&&(t===null||n>t)&&(t=n)}e[r].push(s)});for(const s of Bo){const r=this._layerViews[s],n=e[s];n.reverse();const a=n.length;let o=r.length!==a;const l=new Array(a),h=new Array(r.length);this._layerIndexByUid[s].clear();for(let d=0;d<a;d++){const u=n[d].uid;this._layerIndexByUid[s].set(u,d);const p=r.indexOf(n[d]);l[d]=p,d!==p&&(o=!0),p>-1&&(h[p]=d)}if(o){const d=this._postorderIterator;for(d.reset(this._rootTiles);!d.done;)d.next().modifyLayers(h,l,s);this._layerViews[s]=n,this._restartAllAgents(s),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(t)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(i){const e=this._postorderIterator;for(e.reset(this._rootTiles);!e.done;){const t=e.next();t.restartAgents(i),i===xe.ELEVATION&&t.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(i,e){return this._layerViews[e][i]}numLayers(i){return this._layerViews[i].length}_updateTileTextures(i){this._allTiles.forAll(e=>{e.updateAgents(xe.MAP),i===zt.IMMEDIATE?this.renderer.updateTileTexture(e,ne.TEXTURE_NOFADING):e.updateRenderData(xe.MAP,i)}),this._evaluateTransparency()}_invalidateLayerData(i,e){this._allTiles.forAll(t=>t.removeLayerAgent(i,e)),this._allTiles.forAll(t=>t.invalidateLayerData(i,e))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(i=Me.UPDATE){this.renderer.setNeedsRender(i)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(i,e,t,s){const r=this.layerViewByIndex(e,t),n=r.layer;return!n.tilemapCache||eu(r)?this._requestTileData(i,t,r,s):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(i.lij[0],i.lij[1],i.lij[2],{...s,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(a=>{throw--this._asyncWorkItems,Gi(s),Jn(a)||this._dataMissing(i,t,r),a}).then(()=>this._frameTask.schedule(()=>this._requestTileData(i,t,r,s),s.signal)))}_requestTileData(i,e,t,s){if(this._destroying)return Promise.resolve();const r=e===xe.ELEVATION;return s.requester??(s.requester=r?this._elevationDataRequester:this._mapDataRequester),r?xf(t)?this._requestElevationTileData(i,t,s):Promise.reject():wf(t)?this._requestMapTileData(i,t,s):Promise.reject()}_requestElevationTileData(i,e,t){++this._asyncWorkItems;const s=n=>{!bh(t)&&n&&(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(i,e,n))},r=n=>{Jn(n)||(Pe.getLogger(this).error(`Tile ${i.lij.toString()} layer ${xe.ELEVATION}/${e.uid} error ${n}`),this._dataMissing(i,xe.ELEVATION,e),this.requestUpdate())};return e.fetchTile(i.lij,t).then(n=>this._frameTask.schedule(()=>s(n)),r).finally(()=>--this._asyncWorkItems)}_elevationDataArrived(i,e,t){const s=this._layerIndexByUid[xe.ELEVATION].get(e.uid);if(s==null)return void Pe.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",xe.ELEVATION,i.lij.toString());const r=new rD(i.lij,i.extent,t);i.dataArrived(s,xe.ELEVATION,r);const n=[i],a=i.level,o=this._iteratorPool.acquire();for(o.reset(n);!o.done;){const l=o.next();l.findElevationBoundsForLayer(s,a),l.computeElevationBounds()}a===0&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(n)}_requestMapTileData(i,e,t){++this._asyncWorkItems;const s=(o,l)=>{ol(l),bh(t)||(console.error(`Tile ${i.lij.toString()} layer ${xe.MAP}/${e.uid} error ${o}`),this._dataMissing(i,xe.MAP,e),this.requestUpdate())},r=o=>l=>s(l,o),n=o=>this._frameTask.schedule(()=>{this.requestUpdate(),bh(t)?ol(o):this._mapTileDataArrived(i,e,o)},t.signal,r(o)).catch(r(o)),a=(o,l=null)=>this._frameTask.schedule(()=>s(o,l));return e.fetchTile(i.lij,t).then(n,a).finally(()=>--this._asyncWorkItems)}_mapTileDataArrived(i,e,t){const s=this._getLayerIdxByUID(xe.MAP,e.uid);if(s==null)return ol(t),void Pe.getLogger(this).warn("TerrainSurface: received data from unknown layer");i.dataArrived(s,xe.MAP,t)}_getLayerIdxByUID(i,e){return this._layerIndexByUid[i].get(e)}_dataMissing(i,e,t){const s=this._getLayerIdxByUID(e,t.uid);s!=null?i.dataMissing(s,e):Pe.getLogger(this).warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(i){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll(e=>{e.renderData&&this.overlayManager.setTileParameters(e)}),this._renderer.setNeedsRender(i))}get performanceInfo(){const i=this._performanceInfo;return i.numNodes=this._allTiles.length,i.numLeaves=i.numVisible=i.numRendered=i.numLoadedPerLevel.length=i.numRenderedPerLevel.length=0,this._allTiles.forAll(e=>{e.leaf&&i.numLeaves++;const t=e.level;e.renderData&&(i.numLoadedPerLevel[t]=(i.numLoadedPerLevel[t]||0)+1),e.visible&&(i.numVisible++,e.rendered&&(i.numRenderedPerLevel[t]=(i.numRenderedPerLevel[t]||0)+1,i.numRendered++))}),i}get usedMemory(){return this.tilingScheme?(this._usedMemory==null&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce((i,e)=>i+e.usedMemory,0)):null}getUsedMemoryForLayerView(i){let e=0;const t=this._layerClassFromLayerView(i),s=this._getLayerIdxByUID(t,i.uid);return s!=null&&this._allTiles.forAll(r=>e+=r.getUsedMemoryForLayer(t,s)),e}getTile(i){if(i==null||this._rootTiles==null)return null;const e=i.split("/").map(a=>+a);if(e[0]===0)return this._rootTiles.find(a=>a.lij[1]===e[1]&&a.lij[2]===e[2]);const t=e[0],s=e[1]>>t,r=e[2]>>t;let n;if(this._rootTiles.some(a=>a.lij[1]===s&&a.lij[2]===r&&(n=a,!0)),n){let a=1<<e[0]-1;for(;n.lij[0]<e[0];){let o=e[1]&a?2:0;if((e[2]&a)>0&&o++,!n.children[o])return null;n=n.children[o],a>>=1}return ti(n.lij[0]===e[0]&&n.lij[1]===e[1]&&n.lij[2]===e[2],"not the right tile?"),n}return null}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(i){this._renderer.renderPatchBorders=i}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(i){this._renderer.visualizeNormals=i}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(i){this._renderer.renderingDisabled=i}get test(){}checkAllTilesWaterproofness(){if(!xm)return;const i=this._rootTiles;if(i==null)return;const e=n=>{var a,o,l;return((l=(o=(a=n==null?void 0:n.renderData)==null?void 0:a.geometry)==null?void 0:o.indices)==null?void 0:l.length)>0},t=(n,a)=>{e(n)&&console.error("Tile[",n.lij,"] has geometry although parent[",a.lij,"] has geom")},s=n=>{var a,o;if(n.intersectsClippingArea)if(n.renderData&&!n.renderData.geometryState&&console.error("Tile[",n.lij,"] has renderData but not geometryState"),n.renderData&&!n.renderData.geometry&&console.error("Tile[",n.lij,"] has renderData but not geometryInfo"),!((a=n.renderData)!=null&&a.geometry)||(((o=n.renderData.geometry.indices)==null?void 0:o.length)??0)>0||console.error("Tile[",n.lij,"] has renderData but no indices - geometryInfo: ",n.renderData.geometry),e(n)){n.checkGeometryWaterproofness();for(const l of n.children)t(l,n)}else if(n.leaf)console.error("Tile[",n.lij,"] has no geometry and no children, from root to leaf");else for(const l of n.children)s(l)},r=n=>{var h;const a=((h=n.parent)==null?void 0:h.visible)??!0,o=n.visible;n.computeVisibility();const l=n.visible;if(o!==l&&a&&console.error(" Tile[",n.lij,"] has out of date visibility: ",o," instead of ",l),!n.leaf)for(const d of n.children)r(d)};for(const n of i)s(n),r(n)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(i){return this._isGlobal&&i[2]===this.lijEastEnd(i[0])-1}isWestEndWrap(i){return this._isGlobal&&i[2]===0}lijEastEnd(i){return 1<<i+(this._isGeographic?1:0)}wrapEastWest(i){const e=this.lijEastEnd(i[0]),t=i[2];if(0<=t&&t<e)return i;if(!this._isGlobal)return null;const s=(t+(t<0?e:0))%e;return[i[0],i[1],s]}enableInternalChecks(i){ST(i)}enableWaterproofnessChecks(i){PT(i)}};Ee._tileMemcacheKey="TerrainTileMemcache",c([m()],Ee.prototype,"_renderer",void 0),c([m({constructOnly:!0})],Ee.prototype,"_scaleRangeQueries",void 0),c([m({constructOnly:!0})],Ee.prototype,"view",void 0),c([m({constructOnly:!0})],Ee.prototype,"overlayManager",void 0),c([m()],Ee.prototype,"_hasPendingUpdates",void 0),c([m()],Ee.prototype,"_asyncWorkItems",void 0),c([m()],Ee.prototype,"_allTilesDirty",void 0),c([m()],Ee.prototype,"_allTilesSorted",void 0),c([m()],Ee.prototype,"_viewChanged",void 0),c([m({type:Number})],Ee.prototype,"heading",void 0),c([m()],Ee.prototype,"_splitLimits",void 0),c([m({readOnly:!0})],Ee.prototype,"_watchUpdatingTracking",void 0),c([m()],Ee.prototype,"_frameTask",void 0),c([m({readOnly:!0})],Ee.prototype,"snapLevel",null),c([m({readOnly:!0})],Ee.prototype,"lodSnappingEnabled",null),c([m()],Ee.prototype,"_userClippingExtent",null),c([m()],Ee.prototype,"_rootTilesExtent",void 0),c([m({readOnly:!0})],Ee.prototype,"extent",null),c([m({readOnly:!0})],Ee.prototype,"groundExtent",null),c([m({readOnly:!0})],Ee.prototype,"_tilingSchemeExtent",null),c([m({readOnly:!0})],Ee.prototype,"updating",null),c([m({readOnly:!0})],Ee.prototype,"running",null),c([m(sD)],Ee.prototype,"updatingProgress",void 0),c([m({readOnly:!0})],Ee.prototype,"updatingProgressValue",null),c([m()],Ee.prototype,"_maxNumUpdating",void 0),c([m()],Ee.prototype,"baseOpacity",null),c([m()],Ee.prototype,"hasCompositeBlendMode",void 0),c([m({readOnly:!0})],Ee.prototype,"viewingMode",null),c([m()],Ee.prototype,"maxTextureScale",void 0),c([m({readOnly:!0})],Ee.prototype,"ready",null),c([m({value:Cl.FRONT_TO_BACK})],Ee.prototype,"renderOrder",null),c([m({readOnly:!0})],Ee.prototype,"rootTiles",null),c([m()],Ee.prototype,"_rootTiles",void 0),c([m({readOnly:!0})],Ee.prototype,"spatialReference",null),c([m({type:eg})],Ee.prototype,"backgroundColor",null),c([m({value:!1})],Ee.prototype,"slicePlaneEnabled",null),c([m({readOnly:!0})],Ee.prototype,"tilingScheme",void 0),c([m({readOnly:!0})],Ee.prototype,"tilingSchemeLocked",null),c([m({readOnly:!0})],Ee.prototype,"tilingSchemeLogic",void 0),c([m()],Ee.prototype,"wireframe",null),c([m({value:!1})],Ee.prototype,"suspended",null),c([m()],Ee.prototype,"fadeDuration",null),c([m()],Ee.prototype,"visibleElevationBounds",void 0),c([m()],Ee.prototype,"rootTileElevationBounds",void 0),c([m()],Ee.prototype,"_layerViewsDirty",void 0),c([m()],Ee.prototype,"renderPatchBorders",null),c([m()],Ee.prototype,"visualizeNormals",null),c([m()],Ee.prototype,"renderingDisabled",null),Ee=Ud=c([I("esri.views.3d.terrain.TerrainSurface")],Ee);const gI=Ee,eh=v(),Ao=wr(),fI=mi();new Lt;const Yp=new dC("ground"),ld={spatialReference:null,extent:null,scale:0};function Ly(i,e,t){var s;for(const r of i){if(!r.containsPointXY(e,t))continue;let n=r;for(;n&&!n.renderData;){const o=(e>n.extentMidX?1:0)+(t<n.extentMidY?2:0);n=n.children[o]}const a=((s=n==null?void 0:n.renderData)==null?void 0:s.geometryState.samplerData)??null;return vt(e,t,a)}return null}class yI{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(t===0)return;const s=this._tail;if(!(s+t<=this.capacity))throw new Error("Queue full");for(let r=0;r<t;++r)this._data[s+r]=e[r];this._tail=s+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function Zp(i,e){!i.leaf||i.level<Zt||Rg(i,t=>{e&&Dw(t);const s=r_(t);if(t.maxLevelDeltaNeighborCount++,s){let r=t.parent;for(;r;){const n=r_(r);if(r.unmergableChildCount++,!n)break;r=r.parent}}})}function Dw(i){if(i.hasPendingUpdate(ne.SPLIT))return;let e=i.parent;for(;e!=null&&e.resetPendingUpdate(ne.MERGE);)e=e.parent;i.resetPendingUpdate(ne.MERGE),i.leaf&&i.setPendingUpdate(ne.SPLIT),i.level<Zt||Rg(i,t=>{Dw(t)})}function Ny(i){i.level<Zt||Rg(i,e=>{if(e.maxLevelDeltaNeighborCount--,e.maxLevelDeltaNeighborCount===0&&e.unmergableChildCount===0){let t=e.parent;for(;t&&(t.unmergableChildCount--,r_(t));)t=t.parent}})}function r_(i){return i.maxLevelDeltaNeighborCount===0&&i.unmergableChildCount===0}function Rg(i,e){if(i.level<Zt)return;const t=i.level-Zt,s=i.lij[1]>>Zt,r=i.lij[2]>>Zt,n=a=>a.leaf||a.level===t;for(let a=0;a<4;++a){const o=i.findNeighborTile(cr[a],n);if(!o||o.level!==t)continue;const l=o.lij;l[1]===s&&l[2]===r||e(o)}}let vI=class{constructor(e,t,s,r){this.operation=e,this.geometry=t,this.states=s,this.sync=r}},mh=class extends De{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this._dirtyRecordCount=0}get dirty(){return this._dirtyRecordCount>0}commitLayer(e,t){const s=this._dirtyGeomRecords.get(e);if(!s)return;let r=0;s.forEach((n,a)=>{const o=this._ensureGeomRecord(e,a);r+=n.size,n.forEach(({geometry:l,operation:h,states:d},u)=>{let p=!1;if(h===Gt.UPDATE){const _=o.get(u);if(_){if(d&Xr.TRANSFORMATION){const f=this.model.getObject(a);this.model.updateRenderGeometryTransformation(f,l,_)&&(p=!0)}p||t.updates.push({renderGeometry:_,updateType:d})}else Gs(!1,"ModelDirtySet.commitLayer: invalid update")}if(h===Gt.REMOVE||p){const _=o.get(u);_?(t.removes.push(_),o.delete(u)):h===Gt.REMOVE&&Gs(!1,"ModelDirtySet.commitLayer: invalid remove")}if(h===Gt.ADD||p){const _=this.model.getObject(a);if(_!=null){const f=this.model.getRenderGeometry(_,l);t.adds.push(f),o.set(u,f)}}}),o.size===0&&this._residentGeomRecords.get(e).delete(a)}),this._residentGeomRecords.get(e).size===0&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this._dirtyRecordCount-=r}commitSyncUpdates(e,t){const s=this._dirtyGeomRecords.get(e);s&&s.forEach((r,n)=>{const a=this._ensureGeomRecord(e,n);r.forEach(({geometry:o,operation:l,states:h,sync:d},u)=>{let p=!1;if(l===Gt.UPDATE&&d){const _=a.get(u);if(_){if(h&Xr.TRANSFORMATION){const f=this.model.getObject(n);this.model.updateRenderGeometryTransformation(f,o,_)&&(p=!0)}p||t.updates.push({renderGeometry:_,updateType:h})}else Gs(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}})})}getResidentRenderGeometries(e,t){const s=this._residentGeomRecords.get(e);s&&s.forEach(r=>r.forEach(n=>t.push(n)))}_objectStateChanged(e,t){for(const s of t.geometries)this._updateOrCreateDirtyRecord(t,s,null,Gt.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(Xr.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(Xr.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(Xr.OCCLUDEE,e)}attributesChanged({object:e,geometry:t,sync:s}){this._updateOrCreateDirtyRecord(e,t,null,Gt.UPDATE,Xr.GEOMETRY,s)}layerAdded(e){e.objects.forAll(t=>this._layerObjectAdded(e,t))}layerRemoved(e){e.objects.forAll(t=>this._layerObjectRemoved(e,t))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const s=e.id;for(const r of t.geometries)this._geometryAdded(t,r,s)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const s=e.id;for(const r of t.geometries)this._geometryRemoved(t,r,s)}transformationChanged(e){const t=this._getParentLayerId(e),s=e.id;this._ensureGeomRecord(t,s).forEach(r=>{this._updateOrCreateDirtyRecord(e,r.geometry,t,Gt.UPDATE,Xr.TRANSFORMATION)})}shaderTransformationChanged(e){const t=this._getParentLayerId(e),s=e.id;this._ensureGeomRecord(t,s).forEach(r=>{r.objectShaderTransformationChanged(e.shaderTransformation)})}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t,s=null){this._updateOrCreateDirtyRecord(e,t,s,Gt.ADD)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t,s=null){this._updateOrCreateDirtyRecord(e,t,s,Gt.REMOVE)}_updateOrCreateDirtyRecord(e,t,s,r,n=Xr.NONE,a=!1){s=s??this._getParentLayerId(e);const o=e.id,l=t.id,h=this._ensureDirtyRecord(s,o),d=h.get(l);if(d){const u=d.operation;u===Gt.REMOVE&&r===Gt.ADD&&d.states!==Xr.NONE?d.operation=Gt.UPDATE:u===Gt.REMOVE&&r===Gt.ADD||u===Gt.ADD&&r===Gt.REMOVE?(h.delete(l),this._dirtyRecordCount--):u!==Gt.UPDATE||r!==Gt.REMOVE&&r!==Gt.UPDATE?(Gs((u===Gt.REMOVE||u===Gt.ADD)&&r===Gt.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),d.states|=n):(d.operation=r,d.states|=n),d.sync=d.sync||a}else h.set(l,new vI(r,t,n,a)),this._dirtyRecordCount++}_ensureGeomRecord(e,t){let s=this._residentGeomRecords.get(e);s||(s=new Map,this._residentGeomRecords.set(e,s));let r=s.get(t);return r||(r=new Map,s.set(t,r)),r}_ensureDirtyRecord(e,t){let s=this._dirtyGeomRecords.get(e);s||(s=new Map,this._dirtyGeomRecords.set(e,s));let r=s.get(t);return r||(r=new Map,s.set(t,r)),r}_getParentLayerId(e){return e.parentLayer?e.parentLayer.id:Nx}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach((s,r)=>{s.forEach((n,a)=>{t.length>0&&(t+=`
`),t+=r+"."+a;const o=[];n.forEach(l=>{const h=l.operation;o[h]||(o[h]=[]),o[h].push(l.geometry.id)});for(let l=0;l<o.length;l++)if(o[l]){t+=" "+e[l-1]+": ";for(let h=0;h<o[l].length;h++)t+=o[l][h]+", "}})}),t}get test(){}};c([m()],mh.prototype,"_dirtyRecordCount",void 0),c([m({constructOnly:!0})],mh.prototype,"model",void 0),mh=c([I("esri.views.3d.webgl-engine.lib.ModelDirtySet")],mh);const bI=mh;let zd=class extends De{constructor(){super(...arguments),this.dirtySet=new bI({model:this}),this._content=new Map,this._originFactory=new m2(null)}getObject(e){return this._content.get(e)}add(e){const t=e.id;Gs(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),_u(e)&&this.dirtySet.layerAdded(e)}remove(e){return!!this._content.has(e.id)&&(this._content.delete(e.id),_u(e)&&this.dirtySet.layerRemoved(e),!0)}addMany(e){for(const t of e)t&&(Gs(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)t&&(Gs(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id))}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach(s=>{s.type===e&&t(s)})}getRenderGeometry(e,t){const s=new zT(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation});s.transformation=e.getCombinedStaticTransformation(t,Vy);const{localOrigin:r}=t;return s.localOrigin=r??this._originFactory.getOrigin(At(s.boundingSphere)),s}updateRenderGeometryTransformation(e,t,s){if(e==null)return!1;s.transformation=e.getCombinedStaticTransformation(t,Vy);const r=this._originFactory.getOrigin(At(s.boundingSphere));return s.localOrigin!==r}getStats(){const e={},t=Array.from(this._content.values());for(let s=0;s<Z1.COUNT;++s)e[s]=t.filter(r=>r.type===s).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){}};c([m({constructOnly:!0})],zd.prototype,"dirtySet",void 0),zd=c([I("esri.views.3d.webgl-engine.parts.Model")],zd);const Vy=Nt();let $w=class extends gi{constructor(){super(...arguments),this.radii=Ss(),this.heightParameters=Ci()}};function wI(i){i.uniforms.add(new br("radii",e=>e.radii),new cc("heightParameters",e=>e.heightParameters)),i.constants.add("scaleHeight","float",rs.scaleHeight*rs.atmosphereHeight),i.code.add(b`float chapmanApproximation(float thickness, float height, float cosZenith) {
float c = sqrt(thickness + height);
float cExpH = c * exp(-height);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (thickness + height);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(thickness - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),i.code.add(b`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),i.code.add(b`vec4 planetIntersect(vec3 cameraPos, vec3 rayDir) {
float reducedPlanetRadius = radii[0] - 20000.0;
float rayPlanetDistance = heightParameters[1] - reducedPlanetRadius * reducedPlanetRadius;
vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, rayPlanetDistance);
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, heightParameters[2]);
bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
bool insideAtmosphere = heightParameters[0] < radii[1];
if (!(hitsAtmosphere || insideAtmosphere)) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;
float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;
if (heightParameters[0] < reducedPlanetRadius) {
if (dot(rayDir, normalize(cameraPos)) < -0.025) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
start = rayPlanetIntersect.y;
}
float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
return vec4(0.0, hitsPlanet ? 1.0 : 0.0, start, end);
}`)}function Iw(i,e){i.include(wI);const t=6;i.uniforms.add(new Wi("cameraPosition",(s,r)=>r.camera.eye)),i.constants.add("betaRayleigh","vec3",Pd),i.constants.add("betaCombined","vec3",QM),i.constants.add("betaMie","float",WM),i.code.add(b`
    vec3 raymarchAtmosphere(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      vec4 ray = planetIntersect(cameraPos, rayDir);
      if(ray.x == 1.0) {
        return vec3(0);
      }
      ${He(e,"if (terrainDepth != -1.0) { ray.w = terrainDepth; }")}

      vec3 samplePoint = cameraPos + rayDir * ray.w;
      float multiplier = ray.y == 1.0 ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (ray.w - ray.z) / ${b.float(t)};

      for (int i = 0; i < ${b.int(t)}; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
          ${He(!e,"scattering *= mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0))")};
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {
          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);
          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${He(!e,"scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);")}
        }
        lastOpticalDepth = opticalDepth;
      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;
      ${e?"return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;":b`const float g = 0.8;
             const float gg = g * g;
             float phaseMie = 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg));
             phaseMie = clamp(phaseMie, 0.0, 128.0);
             return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }`)}function Wu(i,e={needUVs:!0,needEyeDirection:!0}){i.attributes.add(Ae.POSITION,"vec2"),i.varyings.add("worldRay","vec3");const{needUVs:t,needEyeDirection:s}=e;t&&i.varyings.add("uv","vec2"),s&&i.varyings.add("eyeDir","vec3"),i.vertex.uniforms.add(new Tn("inverseProjectionMatrix",(r,n)=>n.camera.inverseProjectionMatrix),new Tn("inverseViewMatrix",(r,n)=>f1(xI,n.camera.viewMatrix))),i.vertex.main.add(b`
    vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
    ${He(s,"eyeDir = posViewNear;")}
    worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
    ${He(t,"uv = position * 0.5 + vec2(0.5);")}
    gl_Position = vec4(position, 1, 1);
  `)}const xI=Nt();function Lw(i){const e=new qt;e.include(Wu);const{reduced:t}=i,{fragment:s}=e;return s.uniforms.add(new Wi("backgroundColor",r=>r.backgroundColor),new Be("innerFadeDistance",r=>r.innerFadeDistance),new Be("altitudeFade",r=>r.altitudeFade),new et("depthTexture",(r,n)=>n.mainDepth)),Fu(s),e.include(Nu),s.include(Bu),s.include(I_),s.include(Iw,!1),s.code.add(b`vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
float rayPlanetDistance = heightParameters[1] - radii[0] * radii[0];
vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, rayPlanetDistance);
if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
return fragColor;
}
float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
if (relDist > 1.0) {
return surfaceColor;
}
return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
}
float getGlow(float dist, float radius, float intensity) {
return pow(radius / max(dist, 1e-6), intensity);
}
vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){
float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));
vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));
float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));
return normalize(sunTransmittance) * sunDisc;
}`),s.main.add(b`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${He(!t,b`float depthSample = texture(depthTexture, uv).r;
             if (depthSample != 1.0) {
                fragColor = vec4(0);
                return;
             }`)}

      vec3 col = linearizeGamma(backgroundColor);
      col += raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      col += getSun(cameraPosition, rayDir, mainLightDirection);
      float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);
  `),e}const CI=Object.freeze(Object.defineProperty({__proto__:null,build:Lw},Symbol.toStringTag,{value:"Module"}));let TI=class extends $w{constructor(){super(...arguments),this.innerFadeDistance=0,this.altitudeFade=0,this.backgroundColor=v()}},Kp=class extends Ht{constructor(e,t,s){super(e,t,new Bt(CI,()=>X(()=>Promise.resolve().then(()=>BN),void 0,import.meta.url)),s)}initializePipeline(e){return Qt({blending:e.reduced?U_:F_(Rt.SRC_ALPHA,Rt.ONE_MINUS_SRC_ALPHA),depthTest:{func:e.reduced?ji.ALWAYS:ji.LEQUAL},colorWrite:Jt})}},Nw=class extends pa{constructor(){super(...arguments),this.reduced=!1}};c([pe()],Nw.prototype,"reduced",void 0);let lr=class extends no{constructor(e){super(e),this.produces="disabled",this.consumes={required:[Ie.OPAQUE_ENVIRONMENT]}}_enable(){this.produces=Ie.OPAQUE_ENVIRONMENT,this.requestRender(Me.UPDATE)}_disable(){this.produces="disabled",this.requestRender(Me.UPDATE)}};c([m()],lr.prototype,"produces",void 0),c([m()],lr.prototype,"consumes",void 0),c([m({constructOnly:!0})],lr.prototype,"techniques",void 0),lr=c([I("esri.views.3d.webgl-engine.effects.OpaqueEnvironment")],lr);let Ag=class extends gi{};function Vw(){const i=new qt;return i.include(Xs),i.fragment.uniforms.add(new et("colorTexture",e=>e.color),new et("depthTexture",(e,t)=>t.mainDepth)),i.fragment.main.add(b`float depthSample = texture(depthTexture, uv).r;
if (depthSample != 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),i}const SI=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:Ag,build:Vw},Symbol.toStringTag,{value:"Module"}));let Fy=class extends Ht{constructor(e,t,s){super(e,t,new Bt(SI,()=>X(()=>Promise.resolve().then(()=>GN),void 0,import.meta.url)),s)}initializePipeline(){return Qt({blending:F_(Rt.SRC_ALPHA,Rt.ONE_MINUS_SRC_ALPHA),depthTest:{func:ji.ALWAYS},colorWrite:Jt})}},n_=class extends lr{constructor(e){super(e),this.requireGeometryDepth=!0,this._compositingPassParameters=new Ag,this._vao=null,this._passParameters=new TI,this._configuration=new Nw;const{techniques:t}=e;t.precompile(Kp,this._configuration),t.precompile(Fy),this._configuration.reduced=!0,t.precompile(Kp,this._configuration),this._configuration.reduced=!1}initialize(){this.addHandles([E(()=>this.view.environment.background,e=>{const t=e instanceof eP?tg(e.color):ar;$e(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])},Ge),E(()=>{var e,t;return(t=(e=this.view._stage)==null?void 0:e.renderer)==null?void 0:t.fullResolutionAtmosphere},e=>this._configuration.reduced=!e,Ge),E(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ge)])}destroy(){this._vao=We(this._vao)}render(e){const t=e.find(({name:g})=>g===Ie.OPAQUE_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;const s=this.renderingContext;this._vao??(this._vao=ma(s,Gr.Pos2Tex));const r=t.getAttachment(s.gl.DEPTH_STENCIL_ATTACHMENT);this._update();const n=this.techniques.acquire(Kp,this._configuration);if(!n.compiled)return n.release(),this.requestRender(Me.UPDATE),t;if(!this._configuration.reduced)return t.detachDepth(),s.bindFramebuffer(t.fbo),s.bindTechnique(n,this.bindParameters,this._passParameters),s.bindVAO(this._vao),s.drawArrays(_i.TRIANGLE_STRIP,0,4),t.attachDepth(r),n.release(),t;const a=this.techniques.acquire(Fy);if(!a.compiled)return n.release(),a.release(),this.requestRender(Me.UPDATE),t;const o=s.getViewport(),l=this.bindParameters.camera,h=Ce(l.eye)-rs.radius;let d;const u=rs.atmosphereHeight;if(h<u){const g=Math.min(1,Math.max(0,h/u));d=ke(.2,.3,g)}else{const g=Math.min(1,Math.max(0,(h-u)/(15*u)));d=ke(.3,.6,g)}const p=Gh(Math.round(d*l.fullViewport[2])),_=Gh(Math.round(d*l.fullViewport[3]));s.setViewport(0,0,p,_);const f=this.fboCache.acquire(p,_,"chapman",Ti.RGBA);return s.bindFramebuffer(f.fbo),s.clearFramebuffer([0,0,0,1],!0,!0),s.bindTechnique(n,this.bindParameters,this._passParameters),s.bindVAO(this._vao),s.drawArrays(_i.TRIANGLE_STRIP,0,4),s.setViewport(o.x,o.y,o.width,o.height),this._compositingPassParameters.color=f.getTexture(),t.detachDepth(),s.bindFramebuffer(t.fbo),s.bindTechnique(a,this.bindParameters,this._compositingPassParameters),s.screen.draw(),t.attachDepth(r),n.release(),a.release(),f.release(),t}_update(){const e=this.bindParameters.camera,t=Hs(e.eye),s=Math.sqrt(t),r=t-this._passParameters.radii[1]**2,n=W((s-this._passParameters.radii[0])/rs.atmosphereHeight,0,1);oa(this._passParameters.heightParameters,s,t,r,n);const a=this.view.basemapTerrain.getLowerBoundRadius();ro(this._passParameters.radii,a,a+rs.atmosphereHeight),this._passParameters.innerFadeDistance=2*Math.sqrt((2*a-Um)*Um),this._passParameters.altitudeFade=mg(s-a)}};n_=c([I("esri.views.3d.environment.ChapmanAtmosphere")],n_);function Fw(){const i=new qt,{fragment:e}=i;return i.include(Wu,{needUVs:!1,needEyeDirection:!1}),e.include(S1),e.include(ig),i.include(YP,{pbrMode:jt.Disabled,lightingSphericalHarmonicsOrder:2}),i.include(xS),i.include(Nu),i.include(qT),e.uniforms.add(new Wi("cameraPosition",(t,s)=>s.camera.eye),new Be("cloudsOpacity",(t,s)=>s.clouds.opacity)).main.add(b`vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4(cloudsOpacity * cloudsColor.rgb, cloudsColor.a);`),i}const PI=Object.freeze(Object.defineProperty({__proto__:null,build:Fw},Symbol.toStringTag,{value:"Module"}));let Uy=class extends Ht{constructor(e,t,s){super(e,t,new Bt(PI,()=>X(()=>Promise.resolve().then(()=>kN),void 0,import.meta.url)),s)}initializePipeline(){return Qt({blending:dc(Rt.ONE,Rt.ZERO,Rt.SRC_ALPHA,Rt.ONE),depthTest:{func:ji.LEQUAL},colorWrite:Jt})}},a_=class extends lr{constructor(e){super(e),e.techniques.precompile(Uy),this._planetRadius=Ot(e.view.spatialReference).radius}initialize(){this.addHandles([E(()=>this.view.environment.weather!=null&&this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),dt)])}destroy(){this._vao=We(this._vao)}render(e){const t=e.find(({name:o})=>o===Ie.OPAQUE_ENVIRONMENT),s=this.bindParameters.clouds;if(!s.data)return t;const r=this.techniques.acquire(Uy);if(!r.compiled)return this.requestRender(Me.UPDATE),r.release(),t;const n=this.renderingContext;this._vao??(this._vao=ma(n));const a=n.bindTechnique(r,this.bindParameters,EI);return n.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),n.drawArrays(_i.TRIANGLE_STRIP,0,4),r.release(),s.isFading&&this.requestRender(Me.UPDATE),t}};a_=c([I("esri.views.3d.environment.CloudsComposition")],a_);const EI=new gi;let Dg=class extends gi{constructor(){super(...arguments),this.color=v(),this.strength=4e-6,this.atmosphereC=1,this.amount=0}};function Uw(){const i=new qt;i.include(Wu,{needUVs:!0,needEyeDirection:!0});const e=i.fragment;return e.uniforms.add(new Be("atmosphereC",t=>t.atmosphereC),new Wi("cameraPosition",(t,s)=>s.camera.eye),new br("nearFar",(t,s)=>s.camera.nearFar),new et("depthTexture",(t,s)=>s.mainDepth),new Be("fogStrength",t=>t.strength),new Be("fogAmount",t=>t.amount),new Wi("fogColor",t=>t.color)),i.include(Nu),e.include(Bu),e.include(I_),e.code.add(b`float getFogAmount(float dist, vec3 rayDir) {
if(dist == -1.0){
dist = 0.055 * sphereIntersect(cameraPosition, rayDir, atmosphereC).y;
}
return fogAmount * (1.0 - exp(-dist * fogStrength));
}`),e.main.add(b`vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
float depthSample = texture(depthTexture, uv).r;
float zNorm = 2.0 * depthSample - 1.0;
float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
if(depthSample < 1.0 && depthSample > 0.0){
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= linDepth;
terrainDepth = max(0.0, length(cameraSpaceRay));
}
float fogAmount = getFogAmount(terrainDepth, rayDir);
vec4 fog = vec4(fogColor, 1.0) * fogAmount;
fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));`),i}const MI=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:Dg,build:Uw},Symbol.toStringTag,{value:"Module"}));let zy=class extends Ht{constructor(e,t,s){super(e,t,new Bt(MI,()=>X(()=>Promise.resolve().then(()=>jN),void 0,import.meta.url)),s)}initializePipeline(){return Qt({blending:dc(Rt.SRC_ALPHA,Rt.ZERO,Rt.ONE_MINUS_SRC_ALPHA,Rt.ONE),colorWrite:Jt})}},Ah=class extends lr{constructor(e){super(e),this.consumes={required:[Ie.TRANSPARENT_ENVIRONMENT]}}_enable(){this.produces=Ie.TRANSPARENT_ENVIRONMENT,this.requestRender(Me.UPDATE)}};c([m()],Ah.prototype,"consumes",void 0),Ah=c([I("esri.views.3d.webgl-engine.effects.TransparentEnvironment")],Ah);const OI=.95,RI=1;let o_=class extends Ah{constructor(e){super(e),this.requireGeometryDepth=!0,this._newParameters=new Jp,this._oldParameters=new Jp,this._fadedParameters=new Jp,this._parameters=this._newParameters,this._passParameters=new Dg;const{view:t,techniques:s}=e,r=Ot(t.spatialReference);this._planetRadius=r.radius,this._atmosphereRadius=r.radius+r.atmosphereHeight,s.precompile(zy)}toogle(){this.view.environment.atmosphereEnabled&&this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([E(()=>this.view.environment.atmosphereEnabled,()=>this.toogle(),Ge),E(()=>this.view.environment.weather,()=>this.toogle(),Ge),E(()=>this._updateFogParameters(),()=>{},Ge)]),this.addHandles(E(()=>this._fadeFactor,e=>this._fade(e),Ge))}get _fadeFactor(){var e;return((e=this.view._stage)==null?void 0:e.renderer.renderContext.bind.clouds.fadeFactor)??1}_fade(e){const{_newParameters:t,_oldParameters:s}=this;e>=1?(this._parameters=t,this._oldParameters.copyFrom(this._newParameters)):e<=0?this._parameters=s:(this._fadedParameters.lerp(s,t,e),this._parameters=this._fadedParameters)}_updateFogParameters(){const e=this.view.environment.weather,t=e.type==="foggy"||e.type==="snowy"||e.type==="rainy";this._newParameters.strength=e.type==="foggy"?ke(3e-5,.005,e.fogStrength**3):e.type==="snowy"||e.type==="rainy"?ke(4e-6,2e-4,(e.precipitation??0)**3):0,this._newParameters.amount=t?1:0,e.type!=="foggy"&&e.type!=="snowy"||ue(this._newParameters.color,DI),e.type==="rainy"&&ue(this._newParameters.color,AI),this._fadeFactor>=1&&this._oldParameters.copyFrom(this._newParameters),this.requestRender(Me.UPDATE)}render(e){const t=e.find(({name:a})=>a===Ie.TRANSPARENT_ENVIRONMENT);if(this._parameters.amount===0||(this._update(),this._passParameters.amount<=0))return t;const s=this.techniques.acquire(zy);if(!s.compiled)return this.requestRender(Me.UPDATE),s.release(),t;const r=this.renderingContext,n=t.getAttachment(r.gl.DEPTH_STENCIL_ATTACHMENT);return t.attachDepth(null),r.bindFramebuffer(t.fbo),r.bindTechnique(s,this.bindParameters,this._passParameters),r.screen.draw(),t.attachDepth(n),s.release(),t}_update(){const e=this.bindParameters.camera;ae(qy,e.eye);const t=Math.max(0,ce(qy,this.bindParameters.lighting.mainLight.direction)),s=this._parameters.color;ie(Hy,s,.1),vr(this._passParameters.color,Hy,s,t);const r=Ce(e.eye);this._passParameters.atmosphereC=r**2-this._atmosphereRadius**2,this._passParameters.amount=(1-Fh(OI*Em,RI*Em,Math.abs(r-this._planetRadius)))*this._parameters.amount,this._passParameters.strength=this._parameters.strength}};o_=c([I("esri.views.3d.environment.Fog")],o_);let Jp=class{constructor(){this.color=v(),this.strength=0,this.amount=0}copyFrom(e){this.amount=e.amount,this.strength=e.strength,ue(this.color,e.color)}lerp(e,t,s){this.amount=ke(e.amount,t.amount,s),this.strength=ke(e.strength,t.strength,s),vr(this.color,e.color,t.color,s)}};const qy=v(),Hy=v(),AI=Pt(.5,.5,.5),DI=Pt(1.5,1.5,1.5);var yr;(function(i){i[i.Cone=0]="Cone",i[i.Cylinder=1]="Cylinder",i[i.Underground=2]="Underground",i[i.COUNT=3]="COUNT"})(yr||(yr={}));let $g=class extends P1{constructor(){super(...arguments),this.geometry=yr.Cone}};c([pe({count:yr.COUNT})],$g.prototype,"geometry",void 0);let Qu=class extends gi{constructor(){super(...arguments),this.texV=Ss(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new Ig}},Ig=class{constructor(){this.center=v(),this.v1=v(),this.v2=v()}};function zw(i){const e=new qt,{vertex:t,fragment:s}=e;if(Fu(t),i.geometry===yr.Underground)e.attributes.add(Ae.POSITION,"vec2"),e.varyings.add("color","vec4"),t.uniforms.add(new Wi("cameraPosition",(r,n)=>n.camera.eye),new Be("undergroundFadeAlpha",r=>r.undergroundFadeAlpha)),t.main.add(b`float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);`),s.main.add(b`fragColor = color;`);else{e.include(eb,i),e.attributes.add(Ae.POSITION,"vec3"),e.varyings.add("vtc","vec2"),e.varyings.add("falloff","float");const r=i.geometry===yr.Cylinder;t.uniforms.add(new Tn("proj",(o,l)=>l.camera.projectionMatrix),new Tn("view",(o,l)=>l.camera.viewMatrix)),r||(e.varyings.add("innerFactor","float"),t.uniforms.add(new Wi("silCircleCenter",o=>o.silhouette.center)),t.uniforms.add(new Wi("silCircleV1",o=>o.silhouette.v1)),t.uniforms.add(new Wi("silCircleV2",o=>o.silhouette.v2)),t.uniforms.add(new br("texV",o=>o.texV)),t.uniforms.add(new Be("innerScale",o=>o.innerScale)));const n=6.2831853,a=1/128;t.main.add(b`
      ${r?b`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:b`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${b.float(n*a)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${b.float(a)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
	  `),s.uniforms.add(new et("tex",o=>o.texture)),r||s.uniforms.add(new Be("altitudeFade",o=>o.altitudeFade)),s.main.add(b`
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${r?b`fragColor = atmosphereColor;`:b`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));`}`)}return e}const $I=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:Ig,SimpleAtmospherePassParameters:Qu,build:zw},Symbol.toStringTag,{value:"Module"}));let rl=class extends Ht{constructor(e,t,s){super(e,t,new Bt($I,()=>X(()=>Promise.resolve().then(()=>WN),void 0,import.meta.url)),s)}initializePipeline(e){const t=e.geometry===yr.Cylinder;return Qt({blending:uc,culling:t?A1:void 0,depthTest:{func:ji.LEQUAL},colorWrite:Jt})}};const II=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);let l_=class extends lr{constructor(e){super(e),this._configuration=new $g,this._passParameters=new Qu,this._vao=null,this._vaoCount=0;const{techniques:t}=e;this._configuration.geometry=yr.Cylinder,t.precompile(rl,this._configuration)}initialize(){this.addHandles([E(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),dt)])}destroy(){this._passParameters.texture=We(this._passParameters.texture),this._vao=We(this._vao)}render(e){const t=e.find(({name:a})=>a===Ie.OPAQUE_ENVIRONMENT),s=this.techniques.acquire(rl,this._configuration);if(!s.compiled)return s.release(),this.requestRender(Me.UPDATE),t;const r=this.renderingContext;if(this._vao||(this._vao=LI(r),this._vaoCount=vl(this._vao,"geometry")),!this._passParameters.texture){const a=new hi;a.wrapMode=Yi.CLAMP_TO_EDGE,a.flipped=!0,a.width=1,a.height=512,this._passParameters.texture=new Qi(r,a,II)}const n=r.bindTechnique(s,this.bindParameters,this._passParameters);return NI(By,this.bindParameters.camera.viewMatrix),n.setUniformMatrix4fv("view",By),r.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(_i.TRIANGLES,0,this._vaoCount),s.release(),t}};function LI(i){const e=rE(1,2,!1),{data:t,indices:s}=e[0][1],r=Gy.createBuffer(s.length),n=r.position;for(let a=0;a<s.length;++a){const o=3*s[a%3==0?a+2:a%3==2?a-2:a];n.set(a,0,t[o]),n.set(a,1,t[o+1]),n.set(a,2,t[o+2])}return new ua(i,Ol,new Map([["geometry",ca(Gy)]]),new Map([["geometry",Ts.createVertex(i,gr.STATIC_DRAW,r.buffer)]]))}function NI(i,e){hc(i,e),i[12]=0,i[13]=0,i[14]=0,i[15]=1}l_=c([I("esri.views.3d.environment.LocalAtmosphere")],l_);const By=Nt(),Gy=da().vec3f(Ae.POSITION),VI=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),hd=128,ky=-Um,jy=0,em=50,FI=()=>1-511/512,UI=fd([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let h_=class extends lr{constructor(i){super(i),this._passParameters=new Qu,this._configuration=new $g,this._vao=null,this._vaoCount=0,this._fadeVao=null,this._fadeVaoCount=0,this._texV1=1;const{view:e,techniques:t}=i,s=Ot(e.spatialReference),{outerAtmosphereRimWidth:r,radius:n}=s;this._planetRadius=n,this._innerRimFactor=1+ky/n,this._middleRimFactor=1+jy/n,this._outerRimFactor=1+r/n,this._texV0=jy/r,this._texVScale=this._texV1-this._texV0,t.precompile(rl,this._configuration),this._configuration.geometry=yr.Underground,t.precompile(rl,this._configuration)}initialize(){this.addHandles(E(()=>this.view.environment.atmosphereEnabled,i=>i?this._enable():this._disable(),dt))}destroy(){this._passParameters.texture=We(this._passParameters.texture),this._fadeVao=We(this._fadeVao),this._vao=We(this._vao)}render(i){const e=i.find(({name:s})=>s===Ie.OPAQUE_ENVIRONMENT);this._update();const t=this.renderingContext;if(!this._passParameters.texture){const s=new hi;s.wrapMode=Yi.CLAMP_TO_EDGE,s.flipped=!0,s.width=1,s.height=512,this._passParameters.texture=new Qi(t,s,VI)}if(this._passParameters.undergroundFadeAlpha<1){this._vao||(this._vao=this._createRibbon(t),this._vaoCount=vl(this._vao,"geometry")),this._configuration.geometry=yr.Cone;const s=this.techniques.acquire(rl,this._configuration);if(!s.compiled)return s.release(),this.requestRender(Me.UPDATE),e;t.bindTechnique(s,this.bindParameters,this._passParameters),t.bindVAO(this._vao),t.drawArrays(_i.TRIANGLES,0,this._vaoCount),s.release()}if(this._passParameters.undergroundFadeAlpha>0){this._fadeVao||(this._fadeVao=ma(t),this._fadeVaoCount=vl(this._fadeVao,"geometry")),this._configuration.geometry=yr.Underground;const s=this.techniques.acquire(rl,this._configuration);if(!s.compiled)return s.release(),this.requestRender(Me.UPDATE),e;t.bindTechnique(s,this.bindParameters,this._passParameters),t.bindVAO(this._fadeVao),t.drawArrays(_i.TRIANGLE_STRIP,0,this._fadeVaoCount),s.release()}return e}_update(){const i=this.bindParameters.camera,e=v(),t=this._planetRadius,s=Ce(i.eye),r=s-t;if(r<0){const p=Math.min(-r/5e3,1);this._passParameters.undergroundFadeAlpha=p}else this._passParameters.undergroundFadeAlpha=0;const n=Math.max(em,r),a=t+ky;this._passParameters.innerScale=zI(t+n,t,a)-1,this._passParameters.altitudeFade=mg(r),ie(e,i.eye,(t+em)/s),Wy(e,i.center,i.up,t,this._passParameters.silhouette);const o=this._computeScreenRimWidth(i,e,i.up,this._passParameters.silhouette),l=FI(),h=UI(r);let d=this._texV0+l*this._texVScale,u=this._texV0+o*h*this._texVScale;if(r>em){Wy(i.eye,i.center,i.up,t,this._passParameters.silhouette);const p=this._computeScreenRimWidth(i,i.eye,i.up,this._passParameters.silhouette),_=W((p-1.5)/(o-1.5),0,1);d=this._texV0+_*l*this._texVScale,u=this._texV0+ke(this._texV1,o*h,_)*this._texVScale}ro(this._passParameters.texV,d,u)}_createRibbon(i){const e=E1(3+3*hd*3),t=new Uint32Array(3*hd*5);e[0]=0,e[1]=0,e[2]=-1;for(let n=0;n<hd;n++){const a=9*n+3;e[a]=n,e[a+1]=this._innerRimFactor,e[a+2]=-1,e[a+3]=n,e[a+4]=this._middleRimFactor,e[a+5]=0,e[a+6]=n,e[a+7]=this._outerRimFactor,e[a+8]=1;const o=3*n+1,l=n===hd-1?1:o+3,h=15*n;t[h]=o,t[h+1]=o+1,t[h+2]=l+1,t[h+3]=l+1,t[h+4]=l,t[h+5]=o,t[h+6]=o+1,t[h+7]=o+2,t[h+8]=l+2,t[h+9]=l+2,t[h+10]=l+1,t[h+11]=o+1,t[h+12]=o,t[h+13]=l,t[h+14]=0}const s=Qy.createBuffer(t.length),r=s.position;for(let n=0;n<t.length;++n){const a=3*t[n];r.set(n,0,e[a]),r.set(n,1,e[a+1]),r.set(n,2,e[a+2])}return new ua(i,Ol,new Map([["geometry",ca(Qy)]]),new Map([["geometry",Ts.createVertex(i,gr.STATIC_DRAW,s.buffer)]]))}_computeScreenRimWidth(i,e,t,s){return ye(Do,s.center,s.v2),ie(cd,Do,this._outerRimFactor),aS(tm,e,Do,t),Wf(Do,tm,i.projectionMatrix,i.viewport,Do),Wf(cd,tm,i.projectionMatrix,i.viewport,cd),ki(Do,cd)/i.height}};function Wy(i,e,t,s,r){const n=Ce(i),a=s*Math.sqrt(n*n-s*s)/n,o=Math.sqrt(s*s-a*a),l=r.v1,h=r.v2;return ie(r.center,i,o/n),gt(l,i,e),Hs(l)<1&&gt(l,i,t),ie(l,l,a/Ce(l)),gt(h,l,i),ie(h,h,a/Ce(h)),a}h_=c([I("esri.views.3d.environment.MarsAtmosphere")],h_);const tm=Nt(),Do=v(),cd=v();function zI(i,e,t){return i*i/(Math.sqrt(i*i-e*e)*Math.sqrt(i*i-t*t)+e*t)}const Qy=da().vec3f(Ae.POSITION),qI=h_;let HI=class{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return this._indexRanges.length===0}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;{const t=this._indexRanges;let s=0,r=t.length/2;if(e<t[2*s]||e>t[2*r]+t[2*r+1])return!1;for(;r-s>0;){const n=Math.floor(.5*(s+r)),a=t[2*n];if(e<a){if(r-s==1)return!1;r=n;continue}if(e<a+t[2*n+1])return!0;if(r-s==1)return!1;s=n+1}return!1}}get componentCount(){if(this._componentCountCache===-1){const e=this._indexRanges;let t=0;for(let s=0;s<e.length;s+=2)t+=e[s+1];this._componentCountCache=t}return this._componentCountCache}reset(e){e==="all"||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=BI(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let s=0;s<t.length;s+=2){const r=t[s],n=r+t[s+1];for(let a=r;a<n;a++)if(!e(a))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let s=0;s<t.length;s+=2){const r=t[s];if(!e(r,r+t[s+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),s=this._indexRanges;for(let r=0;r<s.length;r+=2){const n=s[r],a=n+s[r+1],o=e[n],l=e[a];t[r]=o,t[r+1]=l-o}return t}};function BI(i){const e=new Array;if(i.length===0)return e;let t=i[0],s=1;for(let r=1;r<i.length;r++){const n=i[r];t+s===n?s+=1:(e.push(t),e.push(s),t=n,s=1)}return e.push(t),e.push(s),e}let GI=class{constructor(e,t){this.offsets=t,this.pickability=null,this.highlightCounts=null,this.highlightGroups=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRangesMap=null,this.cachedDefaultRanges=null;const s=this.count;this.visibility=new HI(s),this.materialDataBuffer=e.getBuffer(s),this.materialDataIndices=new Uint16Array(s);for(let r=0;r<s;r++)this.materialDataIndices[r]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return this.cachedGeometryRanges==null&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return this.highlightCounts==null?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRangesMap)}get defaultShadowMapRanges(){return this.highlightCounts==null?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRangesMap=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((this.cachedHighlightRangesMap==null||this.cachedDefaultRanges==null)&&this.highlightCounts!=null&&this.highlightGroups!=null){const{highlightRangesMap:e,defaultRanges:t}=kI(this.highlightCounts,this.highlightGroups,this.visibility,this.offsets);this.cachedHighlightRangesMap=e,this.cachedDefaultRanges=t}}};function kI(i,e,t,s){const r=new Map,n=[];let a=s.length;return t.forEachComponent(o=>{if(i[o]>0){const l=e[o];let h=r.get(l);h===void 0&&(h=[],r.set(l,h));const d=s[o],u=s[o+1];h.push(d),h.push(u-d)}else a!==o-1&&(n.length&&n.push(s[a+1]-n[n.length-1]),n.push(s[o])),a=o;return!0}),n.length&&n.push(s[a+1]-n[n.length-1]),{highlightRangesMap:r,defaultRanges:n}}let jI=class{constructor(e,t,s,r,n,a){this.transform=e,this.toMapSpace=t,this.obb=s,this.components=r,this.renderable=n,this.intersectionGeometry=a,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=de(this.intersectionGeometry),this.renderable=de(this.renderable),this.components=de(this.components)}};function WI(i,e,t,s,r,n,a){const o=n-a,l=e-i,h=new Float64Array(4*l);for(let d=0;d<l;++d){const u=3*(d+i),p=r*t[u+0],_=s[p+0],f=s[p+1],g=o/(s[p+2]-a),y=_*g,w=f*g,x=r*t[u+1],T=s[x+0],C=s[x+1],S=o/(s[x+2]-a),P=T*S,M=C*S,$=r*t[u+2],O=s[$+0],N=s[$+1],U=o/(s[$+2]-a),L=O*U,G=N*U,A=4*d;h[A+0]=Math.min(y,P,L),h[A+1]=Math.min(w,M,G),h[A+2]=Math.max(y,P,L),h[A+3]=Math.max(w,M,G)}return h}function QI(i,e,t,s,r){const n=e-i,a=new Float64Array(4*n);for(let o=0;o<n;++o){const l=3*(o+i),h=r*t[l+0],d=s[h+0],u=s[h+1],p=r*t[l+1],_=s[p+0],f=s[p+1],g=r*t[l+2],y=s[g+0],w=s[g+1],x=4*o;a[x+0]=Math.min(d,_,y),a[x+1]=Math.min(u,f,w),a[x+2]=Math.max(d,_,y),a[x+3]=Math.max(u,f,w)}return a}function XI(i,e){return new(YI(i))(e)}function YI(i){return i<128?Uint8Array:i<32768?Uint16Array:i<1<<31?Uint32Array:Array}let qw=class{constructor(e,t){this.elementCount=e,this.model=t,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=t.localMode,this.planetCenterZ=t.planetCenterZ,this.geometryMinZ=t.geometryMinZ,this.planetCenter=Pt(0,0,this.planetCenterZ),this.maxBspNodeDepth=t.maxBspNodeDepth??8,this.minElementCountForBVH=t.minElementCountForBVH??15,this.minBspNodeElementCount=t.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||this._bspNodes.length===0&&this._generateBsp()}intersectRay(e,t,s){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(s):this._intersectRayWithBVH(e,t,s))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,t){this.model.intersectRange(e,t)}_intersectRayWithBVH(e,t,s){this._ensureBVH(),s?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}_intersectGeometryWithBVHVerticalRay(e){let t=e[0],s=e[1];if(!this.localMode){const{geometryMinZ:a,planetCenterZ:o}=this,l=(a-o)/(e[2]-o);t=e[0]*l,s=e[1]*l}const{_bspNodes:r}=this;let n=0;for(;n>=0;){const a=r[n],{d:o,dim:l,minIndexIndex:h,minMidIndexIndex:d,maxMidIndexIndex:u,maxIndexIndex:p,aabb2D:_}=a;if(t<_[0]||t>_[2]||s<_[1]||s>_[3])break;if(l===-1||a.child0===-1&&a.child1===-1){this._intersectRange(h,p);break}{this._intersectRange(d,u);const f=(l===0?t:s)-o;if(f<0){if(a.child0===-1){this._intersectRange(h,d);break}n=a.child0}else{if(!(f>0))break;if(a.child1===-1){this._intersectRange(u,p);break}n=a.child1}}}}_intersectGeometryWithBVHGeneralRay(e,t){let s=e[0],r=e[1],n=t[0],a=t[1];const{geometryMinZ:o}=this;if(!this.localMode){let f=0,g=1;const y=Math.min(.5*this.planetCenterZ,o),w=e[2],x=t[2];if(w<y&&x<y||(w<y&&(f=(y-w)/(x-w)),x<y&&(g=(y-w)/(x-w)),f>g))return;const T=(1-f)*e[0]+f*t[0],C=(1-f)*e[1]+f*t[1],S=(1-f)*e[2]+f*t[2],P=(1-g)*e[0]+g*t[0],M=(1-g)*e[1]+g*t[1],$=(1-g)*e[2]+g*t[2],{planetCenterZ:O}=this,N=o-O,U=N/(S-O);s=T*U,r=C*U;const L=N/($-O);n=P*L,a=M*L}const l=n-s,h=a-r,d=this._bspNodes;let u=1;{const{aabb2D:f}=d[0],g=(x,T,C,S)=>{if(Math.abs(T)<1e-5*Math.max(S-C,1))return!1;const P=T>0,M=P?S:C,$=x+u*T;return(P?$<M:$>M)&&(u=Math.max((M-x)/T,u),!0)},y=()=>g(s,l,f[0],f[2]),w=()=>g(r,h,f[1],f[3]);Math.abs(l)>=Math.abs(h)?y()||w():w()||y()}const p=[0,0,u];let _=0;for(;_<p.length;){const f=p[_];let g=p[_+1],y=p[_+2];if(_+=3,g>y)continue;const w=d[f],{minIndexIndex:x,maxIndexIndex:T}=w,{child0:C,child1:S,minMidIndexIndex:P,maxMidIndexIndex:M,aabb2D:$,d:O,dim:N}=w;{const U=s+g*l,L=s+y*l,G=Math.min(U,L),A=Math.max(U,L),R=$[0],ee=$[2];if(A<R||ee<G)continue;if(G<R){const z=(R-s)/l;l>0?g=Math.max(g,z):y=Math.min(y,z)}if(ee<A){const z=(ee-s)/l;l>0?y=Math.min(y,z):g=Math.max(g,z)}}{const U=r+g*h,L=r+y*h,G=Math.min(U,L),A=Math.max(U,L),R=$[1],ee=$[3];if(A<R||ee<G)continue;if(G<R){const z=(R-r)/h;h>0?g=Math.max(g,z):y=Math.min(y,z)}if(ee<A){const z=(ee-r)/h;h>0?y=Math.min(y,z):g=Math.max(g,z)}}if(C===-1&&S===-1)this._intersectRange(x,T);else{const U=N===0?s:r,L=N===0?l:h,G=U+g*L,A=U+y*L,R=Math.min(G,A),ee=Math.max(G,A),z=W((O-U)/L,0,u);x<P&&R<=O&&(C!==-1?(p.push(C),p.push(L>=0?g:Math.max(g,z)),p.push(L>=0?Math.min(y,z):y)):this._intersectRange(x,P)),this._intersectRange(P,M),M<T&&O<=ee&&(S!==-1?(p.push(S),p.push(L>=0?Math.max(g,z):g),p.push(L>=0?y:Math.min(y,z))):this._intersectRange(M,T))}}}_generateBsp(){const{elementCount:e}=this;if(e<1)return;const t=XI(e,e);this._elementIndexMap=t;for(let _=0;_<e;++_)t[_]=_;const s=this.model.getAabbs2D();let r=0;const n=this._bspNodes;n.length=0;const{localMode:a}=this;let o=!1;if(!a){const{planetCenterZ:_,geometryMinZ:f}=this;o=_>=0||f<.5*_}const l=[],h=(_,f,g,y,w)=>{l.push(_),l.push(f),l.push(g),l.push(y<0?-1:(w?0:1)+2*y)},{maxBspNodeDepth:d,minBspNodeElementCount:u}=this,p=(_,f,g,y,w)=>{const x=n.length;if(x>0&&(o||g>=d||f-_<u))return;const T=[0,0,0,0];eL(T,_,f,t,s);const{d:C,dim:S}=a?ZI(T):KI(T),{rangeMidStart:P,rangeMidEnd:M}=JI(_,f,S,C,t,s),$=g===d-1,O=!$&&P>=_+u,N=!$&&f>=M+u;if(O||N||x===0){const U=new tL(_,P,M,f,S,C,T);if(O&&h(_,P,g+1,x,!0),N&&h(M,f,g+1,x,!1),n.push(U),y!==-1){const L=n[y];w?L.child0=x:L.child1=x}}};for(h(0,e,0,-1,!1);r<l.length;){const _=l[r],f=l[r+1],g=l[r+2],y=l[r+3];r+=4;const w=y>>1;p(_,f,g,w,y-(w<<1)==0)}this._generatedBVH=!0}};function ZI(i){const e=i[0],t=i[1],s=i[2],r=i[3];let n,a;return s-e>=r-t?(a=.5*(e+s),n=0):(a=.5*(t+r),n=1),{d:a,dim:n}}function KI(i){const e=i[0],t=i[1],s=i[2],r=i[3];let n,a;return s-e>=r-t?(n=0,a=.5*(e+s)):(n=1,a=.5*(t+r)),{dim:n,d:a}}function JI(i,e,t,s,r,n){let a=i;{let d=e;for(;a<d;){const u=r[a];Xy(u,t,s,n)<0?++a:(--d,r[a]=r[d],r[d]=u)}}const o=a;let l=a,h=e;for(;l<h;){const d=r[h-1];Xy(d,t,s,n)>0?--h:(r[h-1]=r[l],r[l]=d,++l)}return{rangeMidStart:o,rangeMidEnd:h}}function Xy(i,e,t,s){const r=4*i,n=s[r+0+e];return s[r+2+e]<t?-1:n>t?1:0}function eL(i,e,t,s,r){let n=1/0,a=1/0,o=-1/0,l=-1/0;for(let h=e;h<t;++h){const d=4*s[h];n=Math.min(n,r[d+0]),a=Math.min(a,r[d+1]),o=Math.max(o,r[d+2]),l=Math.max(l,r[d+3])}i[0]=n,i[1]=a,i[2]=o,i[3]=l}let tL=class{constructor(e,t,s,r,n,a,o){this.minIndexIndex=e,this.minMidIndexIndex=t,this.maxMidIndexIndex=s,this.maxIndexIndex=r,this.dim=n,this.d=a,this.aabb2D=o,this.child0=-1,this.child1=-1}},iL=class{constructor(e,t,s,r,n,a,o,l,h){this.componentIndex=e,this.vertexData=t,this.vertexStride=s,this.indexData=r,this.startTriangleNumber=n,this.endTriangleNumber=a,this.geometryMinZ=o,this.planetCenterZ=l,this.localMode=h,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=v(),this.ray0=v(),this.isVerticalRay=!1,this._triangleHitCallback=Yy,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new qw(a-n,this)}getAabbs2D(){return this.localMode?QI(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):WI(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,t,s,r,n,a){ue(this.ray0,e),St(this.rayDirection,t,e),this.isVerticalRay=s,this.totalElevationOffset=r,this.normalRequired=a,this._triangleHitCallback=n,this._bvh.intersectRay(e,t,s),this._triangleHitCallback=Yy}intersectRange(e,t){const s=this._bvh.elementIndexMap;Hw(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,s,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}};function Hw(i,e,t,s,r,n,a,o,l,h,d,u=null,p=0){o!==0?a2(i,e,t,s,r,n,a,o,l,h,d,u,p):sb(i,e,t,s,r,n,a,h,d,u,p)}function Yy(){}function sL(i,e,t,s){if(t>=e)return i;i==null&&(i=rL());const r=i.isVisibleBit;let n=i.data;const a=Bw(n),o=t/a|0,l=t-a*o,h=(e-1)/a|0,d=n,u=s===r;if(!(t<d.length*a)&&u){const p=o+1,_=Math.ceil(d.length*Cx),f=h+1;let g=Math.max(p,_);g=Math.min(g,f),n=new Uint32Array(g),n.set(d)}return o<n.length&&(n[o]=aL(n[o],l,u)),i.data=n,i}function c_(i,e){if(i==null)return!0;const{isVisibleBit:t,data:s}=i,r=Bw(s);return e<s.length*r?nL(t,s,e,r):!i.isVisibleBit}function rL(i=!0){return{isVisibleBit:!i,data:new Uint32Array(0)}}function nL(i,e,t,s){const r=t/s|0,n=t-r*s;return oL(e[r],n)===i}function Bw(i){return i.BYTES_PER_ELEMENT*8}function aL(i,e,t){return i&~(1<<e)|(t?1:0)<<e}function oL(i,e){return!!(i&1<<e)}let lL=class{constructor(e,t,s,r,n,a,o,l){this.vertexData=e,this.vertexStride=t,this.indexData=s,this._components=r,this._componentAabbs3D=n,this.geometryMinZ=a,this.planetCenterZ=o,this.localMode=l,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=uL,this._ray1=pL,this._invDir=v(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=mL,this._callback=Zy,this.rayDirectionC=v(),this._componentIndexMap=null,this._bvh=new qw(r.count,this),this.componentIntersectionData=new Array(r.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:e,planetCenterZ:t,minZGlobal:s}=this,r=new Float64Array(4*e),n=this._componentAabbs3D;for(let a=0;a<e;++a){const o=6*a,l=n[o+0],h=n[o+1],d=n[o+2],u=n[o+3],p=n[o+4],_=s/(d-t),f=s/(n[o+5]-t),g=Math.min(l*_,l*f),y=Math.min(h*_,h*f),w=Math.max(u*_,u*f),x=Math.max(p*_,p*f),T=4*a;r[T+0]=g,r[T+1]=y,r[T+2]=w,r[T+3]=x}return r}getAabbs2DLocal(){const{numComponents:e}=this,t=new Float64Array(4*e),s=this._componentAabbs3D;for(let r=0;r<e;++r){const n=6*r,a=s[n+0],o=s[n+1],l=s[n+3],h=s[n+4],d=4*r;t[d+0]=a,t[d+1]=o,t[d+2]=l,t[d+3]=h}return t}intersectRay(e,t,s,r,n,a,o){const{isVerticalRay:l}=o;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=s,this._verticalOffset=r,this._tolerance=a,this._intersectionOptions=o,this._componentIndexMap=this._bvh.elementIndexMap,o2(e,t,this._invDir),this._callback=n,this._bvh.intersectRay(e,t,l),this._callback=Zy}intersectRange(e,t){const s=this._componentIndexMap,r=this._components,n=r.pickability,a=r.visibility;for(let o=e;o<t;++o){const l=s?s[o]:o;c_(n,l)&&a.isVisible(l)&&this._intersectComponent(l)}}getComponentTriangleCount(e){const t=this._components.offsets,s=t[e]/3;return t[e+1]/3-s}getComponentAabb3D(e,t){const s=this._componentAabbs3D,r=6*e;return t[0]=s[r],t[1]=s[r+1],t[2]=s[r+2],t[3]=s[r+3],t[4]=s[r+4],t[5]=s[r+5],t}_intersectComponent(e){if(!c_(this._components.pickability,e))return;const t=this.getComponentAabb3D(e,hL);let s=!1;const{localMode:r,_componentVerticalOffsets:n,_verticalOffset:a,_ray0:o,_ray1:l,_invDir:h,planetCenterZ:d,_tolerance:u,rayDirectionC:p,componentIntersectionData:_}=this,{isVerticalRay:f}=this._intersectionOptions,g=this._components.offsets,y=ue(cL,o),w=ue(dL,l),x=(n==null?void 0:n[e])??0,T=x+((a==null?void 0:a.offset)??0);if(T!==0&&(r?(y[2]=o[2]-T,w[2]=l[2]-T,s=!0):a!=null&&(a.componentOffset=x)),a==null||s||T===0||a.applyToAabb(t),!l2(t,y,h,u))return;St(p,w,y);const C=g[e]/3,S=g[e+1]/3,P=S-C,M=(G,A,R)=>{this._callback(G,A,e,R)},{vertexData:$,vertexStride:O,indexData:N,_intersectionOptions:U}=this,{normalRequired:L}=U;if(P>_L){let G=_[e];G==null&&(G=new iL(e,$,O,N,C,S,this.geometryMinZ,d,r),_[e]=G),G.intersectRay(y,w,f,s?0:T,M,L)}else Hw(y,p,C,S,N,$,O,s?0:T,d,L,M)}};const hL=qu(),cL=v(),dL=v(),uL=v(),pL=v(),Zy=()=>{},mL=new K_,_L=40;let gL=class{constructor(e,t,s){this.viewingMode=e,this.positionData=t,this._components=s,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=v(),this._componentBvh=null,this._aabb=[0,0,0,0,0,0],this._indices=t.indices?K1(t.indices):BP(t.positions.length/3),this._positions=t.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,t){const s=this._ensureComponentAabbs(),r=6*e;return t[0]=s[r],t[1]=s[r+1],t[2]=s[r+2],t[3]=s[r+3],t[4]=s[r+4],t[5]=s[r+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,s,r,n,a,o,l){this.verticalOffset=r,this.componentVerticalOffsets=n;const{position:h}=a,d=St(fL,e,h),u=St(yL,t,h),p=L_(vL,a.rotationScale);mn(d,d,p),mn(u,u,p);const _=Vu(wL,p);if(this.viewingMode===Ne.Global){const g=this._planetCenter;Xn(g,h),mn(g,g,p)}const f=(g,y,w,x)=>{l(w,g,x?mn(bL,x,_):null,y)};this._intersectComponents(d,u,n,r,f,s,o)}_computePerComponentAabbs(){const e=this._aabb,t=.5*(e[0]+e[3]),s=.5*(e[1]+e[4]),r=.5*(e[2]+e[5]),n=this._components.count,a=E1(6*n),o=this._indices,l=this._positions,h=this._components.offsets;let d=0,u=1/0,p=1/0,_=1/0,f=-1/0,g=-1/0,y=-1/0;for(let w=0;w<n;w++){const x=h[w],T=h[w+1];let C=1/0,S=1/0,P=1/0,M=-1/0,$=-1/0,O=-1/0;if(x<T)for(let N=x;N<T;N++){const U=3*o[N],L=l[U],G=l[U+1],A=l[U+2];C=Math.min(C,L),S=Math.min(S,G),P=Math.min(P,A),M=Math.max(M,L),$=Math.max($,G),O=Math.max(O,A)}else C=t,S=s,P=r,M=t,$=s,O=r;a[d++]=C,a[d++]=S,a[d++]=P,a[d++]=M,a[d++]=$,a[d++]=O,u=Math.min(u,C),p=Math.min(p,S),_=Math.min(_,P),f=Math.max(f,M),g=Math.max(g,$),y=Math.max(y,O)}return this._aabb[0]=u,this._aabb[1]=p,this._aabb[2]=_,this._aabb[3]=f,this._aabb[4]=g,this._aabb[5]=y,a}_intersectComponents(e,t,s,r,n,a,o){let l=this._componentBvh;l==null&&(l=new lL(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=l),l.intersectRay(e,t,s,r,n,a,o)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return this.viewingMode===Ne.Local}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}};const fL=v(),yL=v(),vL=xn(),bL=v(),wL=xn();let xL=class{constructor(e,t,s){this.material=e,this.geometry=t,this.meta=s}destroy(){this.material.dispose(),this.geometry.dispose()}},CL=class{constructor(e,t,s,r){this.vao=e,this.primitiveType=t,this.parameters=s,this.indexed=r}dispose(){this.vao.dispose()}},Lg=class{constructor(){this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}};function TL(i,e){return{near:i,far:e}}function yc(i){return TL(1/0,-1/0)}function Ou(i,e,t){return i.near=e,i.far=t,i}function Tl(i,e){e!=null&&(i.near=Math.min(i.near,e.near),i.far=Math.max(i.far,e.far))}function dd(i,e){return i.near<=e&&e<=i.far}const d_={near:0,far:0};function SL(i,e){const t=yc(),{eye:s,frustum:r,viewForward:n}=i;e.forAll(a=>{const o=a.offsetObb!=null?a.offsetObb:a.obb,l=ce(St(vs,o.center,s),n),h=o.projectedRadius(n);if(dd(t,l-h)&&dd(t,l+h))return;const d=RL(o,r);if(d===-1)return;if(d===0)return Yr.far=l+h,Yr.near=l-h,void Tl(t,Yr);const u=ud.pushNew();u.near=l-h,u.far=l+h,u.mask=d,u.object=a});for(let a=0;a<ud.length;a++){const o=ud.data[a];if(dd(t,o.near)&&dd(t,o.far))continue;Yr.far=o.far,Yr.near=1/0,OL(o.object.offsetObb!=null?o.object.offsetObb:o.object.obb,s,PL,h=>{let d=EL;for(let u=0;u<Gw&&h.length>0;u++){if(!(o.mask&1<<u))continue;ML(r[u],h,d);const p=h;h=d,d=p}for(let u=0;u<h.length;u+=3){$e(is,h.data[u],h.data[u+1],h.data[u+2]);const p=ce(St(is,is,s),n);Yr.near=Math.min(Yr.near,p)}})===0&&(Yr.near=0),Tl(t,Yr)}return ud.length=0,t}const ud=new Lt({allocator:i=>i||{near:1/0,far:-1/0,mask:0,object:null},deallocator:i=>(i.object=null,i)}),Yr=yc(),is=v(),Sa=v(),PL=new Lt({deallocator:null}),EL=new Lt({deallocator:null});function ML(i,e,t){t.length=0;const s=e.length-3;im(is,e,s);const r=eo(i,is);r<=0&&(t.push(is[0]),t.push(is[1]),t.push(is[2]));let n=0,a=r;for(;n<s;n+=3){im(Sa,e,n);const o=eo(i,Sa);a*o<0&&(vr(is,Sa,is,o/(o-a)),ss(t,is)),o<=0&&ss(t,Sa),a=o,ue(is,Sa)}a*r<0&&(im(Sa,e,s),vr(is,Sa,is,r/(r-a)),ss(t,is))}function im(i,e,t){return $e(i,e.data[t],e.data[t+1],e.data[t+2])}function ss(i,e){i.push(e[0]),i.push(e[1]),i.push(e[2])}function OL(i,e,t,s){aP(Jy,i.quaternion),St(vs,e,i.center),$T(vs,vs,Jy);const r=i.halfSize,n=8*((vs[0]<-r[0]?-1:vs[0]>r[0]?1:0)+3*(vs[1]<-r[1]?-1:vs[1]>r[1]?1:0)+9*(vs[2]<-r[2]?-1:vs[2]>r[2]?1:0)+13),a=Ky[n];if(a===0)return a;sS(pd,i.quaternion),g1(pd,pd,i.halfSize);const o=(l,h)=>{const d=Ky[n+h+1];return $e(l,((1&d)<<1)-1,(2&d)-1,((4&d)>>1)-1),mn(l,l,pd),ye(l,i.center,l)};return t.length=0,ss(t,o(sm,0)),ss(t,o(ev,1)),ss(t,o(vs,2)),ss(t,o(tv,3)),s(t),a===1||(t.length=0,ss(t,sm),ss(t,tv),ss(t,o(vs,4)),ss(t,o(iv,5)),s(t),a===2||(t.length=0,ss(t,sm),ss(t,iv),ss(t,o(vs,6)),ss(t,ev),s(t))),a}const Ky=(()=>{const i=new Array(216);let e=0;const t=s=>{for(let r=0;r<s.length;r++)i[e+r]=s[r];e+=8};return t([3,0,6,2,3,1,5,4]),t([2,0,2,3,1,5,4,0]),t([3,1,0,2,3,7,5,4]),t([2,0,1,3,2,6,4,0]),t([1,0,1,3,2,0,0,0]),t([2,1,5,7,3,2,0,0]),t([3,2,0,1,3,7,6,4]),t([2,2,0,1,3,7,6,0]),t([3,3,0,1,5,7,6,2]),t([2,0,1,5,4,6,2,0]),t([1,0,1,5,4,0,0,0]),t([2,1,3,7,5,4,0,0]),t([1,0,2,6,4,0,0,0]),t([0,0,0,0,0,0,0,0]),t([1,1,3,7,5,0,0,0]),t([2,2,3,7,6,4,0,0]),t([1,2,3,7,6,0,0,0]),t([2,3,1,5,7,6,2,0]),t([3,4,0,1,5,7,6,2]),t([2,5,7,6,4,0,1,0]),t([3,5,0,1,3,7,6,4]),t([2,4,5,7,6,2,0,0]),t([1,4,5,7,6,0,0,0]),t([2,5,1,3,7,6,4,0]),t([3,6,0,2,3,7,5,4]),t([2,6,2,3,7,5,4,0]),t([3,7,6,2,3,1,5,4]),i})(),Gw=4;function RL(i,e){let t=0;for(let s=0;s<Gw;s++){const r=i.intersectPlane(e[s]);if(r>0)return-1;r===0&&(t|=1<<s)}return t}const pd=xn(),Jy=oP(),vs=v(),sm=v(),ev=v(),tv=v(),iv=v();let AL=class{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll(s=>s.renderable.material.submit(e,t,s))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?SL(e,this._objects.visibleObjects):null}get hasEmissions(){return this._objects.visibleObjects.some(e=>e.renderable.material.hasEmissions)}},Qq=class extends gi{constructor(e,t,s,r,n){super(),this.colors=e,this.textureCoordinates=t,this.hasNormals=s,this.shadeNormals=r,this.applySSAO=n}};function DL(i){const e=da().vec3f(Ae.POSITION);return i.hasNormals&&e.vec2i16(Ae.NORMALCOMPRESSED,{glNormalized:!0}),i.textureCoordinates===jh.Default?e.vec2f(Ae.UV0):i.textureCoordinates===jh.Atlas&&(e.vec2f(Ae.UV0),e.vec4u16(Ae.UVREGION,{glNormalized:!0})),i.colors&&e.vec4u8(Ae.COLOR,{glNormalized:!0}),e}let $L=class{constructor(){this.externalColor=Ci(),this.externalColorMixMode=mu.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}};var gs;function IL(i,e){const t=i.vertex;switch(t.code.add(b`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),e.vertexDiscardMode){case gs.None:t.code.add(b`#define vertexDiscardByOpacity(_opacity_) {}`);break;case gs.Opaque:t.code.add(b`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case gs.Transparent:t.code.add(b`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case gs.COUNT:break;default:Pl(e.vertexDiscardMode)}}(function(i){i[i.None=0]="None",i[i.Transparent=1]="Transparent",i[i.Opaque=2]="Opaque",i[i.COUNT=3]="COUNT"})(gs||(gs={}));var qr;function Zq(i){return i&&x_(i)?qr.Mars:i&&C_(i)?qr.Moon:qr.Earth}(function(i){i[i.Earth=1]="Earth",i[i.Mars=2]="Mars",i[i.Moon=3]="Moon",i[i.COUNT=4]="COUNT"})(qr||(qr={}));var Bs;(function(i){i[i.None=0]="None",i[i.NoOverlay=1]="NoOverlay",i[i.ColorOverlay=2]="ColorOverlay",i[i.ColorOverlayWithWater=3]="ColorOverlayWithWater",i[i.COUNT=4]="COUNT"})(Bs||(Bs={}));let at=class extends pa{constructor(e,t){super(),this.spherical=e,this.doublePrecisionRequiresObfuscation=t,this.output=D.Color,this.textureCoordinateType=jh.None,this.componentData=mc.Uniform,this.cullFace=H_.Back,this.vertexDiscardMode=gs.None,this.doubleSidedMode=kn.WindingOrder,this.alphaDiscardMode=ll.Opaque,this.integratedMeshMode=Bs.None,this.oitPass=Cs.NONE,this.ellipsoidMode=qr.Earth,this.pbrMode=jt.Disabled,this.normalType=gn.Attribute,this.emissionSource=Ch.None,this.hasVertexColors=!1,this.hasNormals=!1,this.shadeNormals=!0,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.screenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasNormalTextureTransform=!1,this.cloudReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1,this.discardInvisibleFragments=!1,this.occlusionPass=!1,this.bindType=c2.Draw,this.hasSliceHighlight=!0,this.hasSliceInVertexProgram=!1,this.useCustomDTRExponentForWater=!1,this.hasVertexTangents=!1,this.highStepCount=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.useFillLights=!0,this.objectAndLayerIdColorInstanced=!1,this.canHaveOverlay=!0}};c([pe({count:D.COUNT})],at.prototype,"output",void 0),c([pe({count:jh.COUNT})],at.prototype,"textureCoordinateType",void 0),c([pe({count:mc.COUNT})],at.prototype,"componentData",void 0),c([pe({count:H_.COUNT})],at.prototype,"cullFace",void 0),c([pe({count:gs.COUNT})],at.prototype,"vertexDiscardMode",void 0),c([pe({count:kn.COUNT})],at.prototype,"doubleSidedMode",void 0),c([pe({count:ll.COUNT})],at.prototype,"alphaDiscardMode",void 0),c([pe({count:Bs.COUNT})],at.prototype,"integratedMeshMode",void 0),c([pe({count:Cs.COUNT})],at.prototype,"oitPass",void 0),c([pe({count:qr.COUNT})],at.prototype,"ellipsoidMode",void 0),c([pe({count:jt.COUNT})],at.prototype,"pbrMode",void 0),c([pe({count:gn.COUNT})],at.prototype,"normalType",void 0),c([pe({count:Ch.COUNT})],at.prototype,"emissionSource",void 0),c([pe()],at.prototype,"hasVertexColors",void 0),c([pe()],at.prototype,"hasNormals",void 0),c([pe()],at.prototype,"shadeNormals",void 0),c([pe()],at.prototype,"hasSlicePlane",void 0),c([pe()],at.prototype,"hasColorTexture",void 0),c([pe()],at.prototype,"receiveAmbientOcclusion",void 0),c([pe()],at.prototype,"receiveShadows",void 0),c([pe()],at.prototype,"blendingEnabled",void 0),c([pe()],at.prototype,"screenSpaceReflections",void 0),c([pe()],at.prototype,"hasPolygonOffset",void 0),c([pe()],at.prototype,"hasMetallicRoughnessTexture",void 0),c([pe()],at.prototype,"hasOcclusionTexture",void 0),c([pe()],at.prototype,"hasNormalTexture",void 0),c([pe()],at.prototype,"hasOccludees",void 0),c([pe()],at.prototype,"terrainDepthTest",void 0),c([pe()],at.prototype,"cullAboveTerrain",void 0),c([pe()],at.prototype,"hasNormalTextureTransform",void 0),c([pe()],at.prototype,"cloudReflections",void 0),c([pe()],at.prototype,"snowCover",void 0),c([pe()],at.prototype,"objectAndLayerIdColor",void 0);function sv(i,e){const t=i.fragment;switch(e.doubleSidedMode){case kn.None:t.code.add(b`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case kn.View:i.include(yd,e),t.code.add(b`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case kn.WindingOrder:t.code.add(b`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:Pl(e.doubleSidedMode);case kn.COUNT:}switch(e.normalType){case gn.Attribute:case gn.Compressed:i.include(M1,e),t.main.add(b`vec3 fragmentFaceNormal = _adjustDoublesided(normalize(vNormalWorld));
vec3 fragmentFaceNormalView = gl_FrontFacing ? normalize(vNormalView) : -normalize(vNormalView);`);break;case gn.ScreenDerivative:i.include(yd,e),t.main.add(b`vec3 fragmentFaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
vec3 fragmentFaceNormalView = normalize(cross(dFdx(vPosition_view), dFdy(vPosition_view)));`);default:case gn.COUNT:}e.shadeNormals?t.main.add(b`vec3 fragmentShadingNormal = fragmentFaceNormal;`):e.spherical?(i.include(yd,e),t.main.add(b`vec3 fragmentShadingNormal = normalize(positionWorld());`)):t.main.add(b`vec3 fragmentShadingNormal = vec3(0.0, 0.0, 1.0);`)}function LL(i,e){i.include(rb,e),i.fragment.include(ZP);const t=i.fragment;t.uniforms.add(new fE("baseColor",s=>s.baseColor)),t.uniforms.add(new KP("objectOpacity",s=>s.objectOpacity)),e.hasVertexColors?t.code.add(b`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):t.code.add(b`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),t.code.add(b`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function NL(i,e){const t=e.hasColorTexture&&(wl(e.output)||e.alphaDiscardMode!==ll.Opaque);t&&(i.include(CS,e),i.fragment.uniforms.add(new jP("baseColorTexture",s=>s.texture))),i.fragment.code.add(b`
    vec4 readBaseColorTexture() {
      return ${t?"textureLookup(baseColorTexture, vuv0)":"vec4(1.0)"};
    }
  `)}function kw(i){const e=new qt;e.include(yd,i),e.include(M1,i),e.include(rb,i),e.include(w1,i),e.include(tb,i),e.include(aE,i),e.include(JP,i),e.include(TS,i),e.include(NL,i),e.include(IL,i);const{vertex:t,fragment:s}=e,{output:r,pbrMode:n,hasNormalTexture:a,snowCover:o,receiveShadows:l,spherical:h,ellipsoidMode:d}=i,u=n===jt.Normal||n===jt.Schematic;u&&(e.include(SS,i),a&&e.include(e2,i));const p=r===D.Shadow||r===D.ShadowHighlight||r===D.ShadowExcludeHighlight,_=p&&i.componentData===mc.Varying;t.code.add(`#define discardShadows(castShadows) { ${He(_,"if(!castShadows) { gl_Position = vec4(vec3(1e38), 1.0); return; }")} }`);const f=i.integratedMeshMode===Bs.ColorOverlay||i.integratedMeshMode===Bs.ColorOverlayWithWater;if(f){e.include(uu,i),e.include(HT,i);const C=d===qr.Earth,S=d===qr.Earth,P=C?rs.radius:S?Hx.radius:Bx.radius;t.code.add(`
      ${He(h,`const float invRadius = ${b.float(1/P)};`)}
      vec2 projectOverlay(vec3 pos) { return pos.xy ${He(h,"/ (1.0 + invRadius * pos.z);")}; }`)}const g=f&&wl(r)&&n===jt.WaterOnIntegratedMesh;if(g&&(e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),e.varyings.add("groundNormal","vec3")),t.main.add(b`
    bool castShadows;
    vec4 externalColor = forwardExternalColor(castShadows);
    discardShadows(castShadows);

    vertexDiscardByOpacity(externalColor.a);

    ${r===D.ObjectAndLayerIdColor?b`externalColor.a = 1.0;`:""}

    if (externalColor.a < ${b.float(Qo)}) {
      // Discard this vertex
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }

    forwardPosition(readElevationOffset());
    forwardNormal();
    forwardTextureCoordinates();
    forwardVertexColor();
    forwardLinearDepth();
    forwardObjectAndLayerIdColor();
    ${g?h?b`
              groundNormal = normalize(positionWorld());
              tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
              tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:b`
              groundNormal = vec3(0.0, 0.0, 1.0);
              tbnTangent = vec3(1.0, 0.0, 0.0);
              tbnBiTangent = vec3(0.0, 1.0, 0.0);`:""}
    ${f?b`setOverlayVTC(projectOverlay(position));`:""}
  `),wl(r))return e.include(PS,i),e.include(LL,i),e.include(sv,i),e.include(uu,i),e.include(ES,i),l&&e.include(Z_,i),s.code.add(b`
      float evaluateShadow() {
        return ${l?"readShadowMap(vPositionWorldCameraRelative, linearDepth)":"0.0"};
      }`),f&&s.uniforms.add(new et("ovColorTex",(C,S)=>BT(C,S))),s.main.add(b`
      discardBySlice(vPositionWorldCameraRelative);
      terrainDepthTest(vPosition_view.z);

      vec4 textureColor = readBaseColorTexture();
      discardOrAdjustAlpha(textureColor);

      vec4 externalColor;
      int externalColorMixMode;
      readExternalColor(externalColor, externalColorMixMode);

      vec4 materialColor = computeMaterialColor(textureColor, externalColor, externalColorMixMode);
      ${f?b`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`:""}
    `),u?(C1(s),h&&Om(s),s.main.add(b`
        applyPBRFactors();
        ${He(n===jt.Normal,b`if (externalColorMixMode == 3) {
              mrr = vec3(0.0, 0.6, 0.2);
            }`)}
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
        ${He(a,"mat3 tangentSpace = computeTangentSpace(fragmentShadingNormal, vPositionWorldCameraRelative, vuv0);")}
        vec3 shadingNormal = ${a?"computeTextureNormal(tangentSpace, vuv0)":"fragmentShadingNormal"};
        vec3 normalGround = ${h?b`normalize(positionWorld())`:b`vec3(0.0, 0.0, 1.0)`};

        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();
        ${He(o,b`float snow = smoothstep(0.5, 0.55, dot(fragmentFaceNormal, normalize(positionWorld())));
                 materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                 ssao = mix(ssao, 0.5 * ssao, snow);
                 shadingNormal = mix(shadingNormal, fragmentFaceNormal, snow);`)}
        ${He(f,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 emission = getEmissions();
        ${He(h,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        ${h?b`float shadow = max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow());`:"float shadow = evaluateShadow();"}
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, shadow, ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(h&&Om(s),g&&s.uniforms.add(new et("ovNormalTex",(C,S)=>{var P;return(P=S.overlay)==null?void 0:P.getTexture(Ns.WaterNormal)})),s.main.add(b`
        ${He(h,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        float shadow = ${l?h?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow())":"evaluateShadow()":h?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        ${He(o,b`float snow = smoothstep(0.5, 0.55, dot(fragmentFaceNormal, normalize(positionWorld())));
               materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)}

        // At global scale we create some additional ambient light based on the main light to simulate global illumination
        float ssao = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());

        ${f?b` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec4 shadedColor = vec4(evaluateSceneLighting(fragmentShadingNormal, materialColor.rgb, shadow, ssao, additionalLight), materialColor.a);
        ${He(g,b`vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
                 float waterNormalLength = length(overlayWaterMask);
                 if (waterNormalLength > 0.95) {
                   mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                   vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                   vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                   // un-gamma the ground color to mix in linear space
                   shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
                 }`)}
      `)),s.main.add(b`outputColorHighlightOID(shadedColor, vPositionWorldCameraRelative);`),e;const y=r===D.Normal,w=r===D.ObjectAndLayerIdColor,x=r===D.Highlight,T=p||r===D.ViewshedShadow;return T&&e.include(J1,i),y&&e.include(sv,i),e.include(x1,i),s.main.add(b`
    discardBySlice(vPositionWorldCameraRelative);

    vec4 textureColor = readBaseColorTexture();
    discardOrAdjustAlpha(textureColor);

    ${He(T,"outputDepth(linearDepth);")}
    ${He(y,b`fragColor = vec4(vec3(0.5) + 0.5 * fragmentFaceNormalView, 1.0);`)}
    ${He(w,f?"fragColor = getOverlayColorTexel(vtcOverlay);":"outputObjectAndLayerIdColor();")}
    ${He(x,b`${He(f,b`
           vec2 overlayHighlightTexel = getAllOverlayHighlightValuesEncoded();
           outputAllHighlights(overlayHighlightTexel);`,b`calculateOcclusionAndOutputHighlight();`)}`)}`),e}const VL=Object.freeze(Object.defineProperty({__proto__:null,build:kw},Symbol.toStringTag,{value:"Module"}));let FL=class extends Ht{constructor(e,t,s){super(e,t,new Bt(VL,()=>X(()=>Promise.resolve().then(()=>QN),void 0,import.meta.url)),s,jw)}initializePipeline(e){const{integratedMeshMode:t,output:s,blendingEnabled:r,cullFace:n,hasOccludees:a,hasPolygonOffset:o,oitPass:l}=e,h=t!==Bs.None,d=l===Cs.NONE,u=l===Cs.FrontFace;return Qt({blending:wl(s)&&r?MS(l):null,culling:FS(n),depthTest:{func:OS(l)},depthWrite:d||u?D1:null,drawBuffers:s===D.Depth?{buffers:[O1.NONE]}:RS(l,s),colorWrite:Jt,stencilWrite:h||a?AS:null,stencilTest:h?DS(q_.IntegratedMeshMaskExcluded):a?$S:null,polygonOffset:d||u?o?{factor:2,units:2}:null:IS})}};const jw=new Map([[Ae.POSITION,0],[Ae.NORMAL,1],[Ae.NORMALCOMPRESSED,1],[Ae.COLOR,2],[Ae.UV0,3],[Ae.UVREGION,4],[Ae.COMPONENTINDEX,5]]);let UL=class extends gi{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}},Ng=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}};function wt(i={}){return(e,t)=>{const s=e._parameterCount??0;if(e._parameterCount=s+1,i.vectorOps){const r=i.vectorOps;Object.defineProperty(e,t,{get(){return this[s]},set(n){const a=this[s];if(a==null)this[s]=[...n];else{if(r.equals(a,n))return;r.copy(a,n)}this._setDirty()}})}else Object.defineProperty(e,t,{get(){return this[s]},set(r){this[s]!==r&&(i.dispose&&this[s]&&this[s].dispose(),this[s]=r,this._setDirty())}})}}function rv(){return(i,e)=>{const t=i._parameterCount??0;i._parameterCount=t+1,i._parameterBlocks=i._parameterBlocks||[],i._parameterBlocks.push(t),Object.defineProperty(i,e,{get(){return this[t]},set(s){this[t]!==s&&(this[t]=s,this._setDirty())}})}}let Ww=class{constructor(e){this._low=v(),this._high=v(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){ue(this._low,ue(nv,e));const t=St(nv,e,this._low);ue(this._high,t)}get(e){return ye(e,this._low,this._high)}getLowScaled(e){return ie(e,this._low,1)}};const nv=dS();let li=class extends UL{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=fP(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=t2,this.emissiveFactor=T_(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new qd,this.componentParameters=new Dh,this.textureAlphaCutoff=Qo,this.alphaDiscardMode=ll.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=qr.Earth,this.hasOccludees=!1;const s=new Ww(e.position),r=rP(e.rotationScale);L_(r,r),Vu(r,r),this.transformNormalGlobalFromModel=r,this.transformWorldFromModelTL=s.low,this.transformWorldFromModelTH=s.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){var e;return(e=this.baseColorTexture)==null?void 0:e.glTexture}get textureMetallicRoughness(){var e;return(e=this.metallicRoughnessTexture)==null?void 0:e.glTexture}get textureEmissive(){var e;return(e=this.emissionTexture)==null?void 0:e.glTexture}get hasEmissions(){return this.emissionTexture!=null||!Lu(this.emissiveFactor,js)}get textureOcclusion(){var e;return(e=this.occlusionTexture)==null?void 0:e.glTexture}get textureNormal(){var e;return(e=this.normalTexture)==null?void 0:e.glTexture}acquireTechnique(e,t,s,r){const n=new at(e.context.spherical,e.context.doublePrecisionRequiresObfuscation);n.hasVertexColors=r.colors,n.hasNormals=r.hasNormals,n.textureCoordinateType=r.textureCoordinates,n.hasMetallicRoughnessTexture=this.metallicRoughnessTexture!=null,n.hasOcclusionTexture=this.occlusionTexture!=null,n.hasNormalTexture=this.normalTexture!=null,n.oitPass=t.identifier===Hn.Material&&s.oitPass!=null?s.oitPass:Cs.NONE,n.terrainDepthTest=t.identifier===Hn.Material&&s.terrainDepthTest,n.cullAboveTerrain=t.identifier===Hn.Material&&s.cullAboveTerrain,n.ellipsoidMode=this.ellipsoidMode,n.componentData=this.componentParameters.type,n.cullFace=this.commonMaterialParameters.cullFace,n.doubleSidedMode=this.commonMaterialParameters.doubleSided?kn.View:kn.None,n.hasColorTexture=this.baseColorTexture!=null;const a=this._computeWhichMaterialPass();if(n.blendingEnabled=a===Fi.Transparent||a===Fi.OpaqueAndTransparent,n.alphaDiscardMode=this.alphaDiscardMode,n.integratedMeshMode=this.isIntegratedMesh?HL(s)?qL(s)?Bs.ColorOverlayWithWater:Bs.ColorOverlay:Bs.NoOverlay:Bs.None,n.hasPolygonOffset=this.polygonOffsetEnabled,n.pbrMode=n.integratedMeshMode===Bs.ColorOverlayWithWater?jt.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?r.shadeNormals&&this.isIntegratedMesh?jt.Disabled:jt.Schematic:jt.Normal:jt.Disabled,n.emissionSource=this.emissionTexture!=null?Ch.Texture:n.pbrMode===jt.Normal?Ch.Value:Ch.None,n.shadeNormals=r.shadeNormals,n.normalType=n.hasNormals?gn.Compressed:gn.ScreenDerivative,n.hasSlicePlane=s.slicePlane!=null&&this.commonMaterialParameters.hasSlicePlane,t.identifier===Hn.ShadowMap)n.output=D.Shadow,n.vertexDiscardMode=gs.None;else if(t.identifier===Hn.ViewshedShadowMap)n.output=D.ViewshedShadow,n.vertexDiscardMode=gs.None;else if(t.identifier===Hn.Highlight)n.output=D.Highlight,n.vertexDiscardMode=gs.None;else{switch(a===Fi.OpaqueAndTransparent?n.vertexDiscardMode=t.transparent?gs.Opaque:gs.Transparent:n.vertexDiscardMode=gs.None,n.output=t.output,n.receiveAmbientOcclusion=!1,n.receiveShadows=!1,t.output){case D.Color:case D.ColorEmission:n.receiveAmbientOcclusion=r.applySSAO&&s.ssao!=null,n.hasOccludees=s.hasOccludees,n.receiveShadows=s.shadowMap.ready,n.screenSpaceReflections=s.ssr.lastFrameColor!=null,n.cloudReflections=s.clouds.data!=null;break;case D.ObjectAndLayerIdColor:n.objectAndLayerIdColor=!0}n.snowCover=this.hasSnowCover(s)}const o=e.acquire(FL,n);return this._setClean(),o}hasSnowCover(e){return e.weather!=null&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}submit(e,t,s){if(this.objectOpacity===0)return;const{components:r,renderable:n}=s,{geometry:a}=n,o=n.meta.cameraDepthSquared,{geometryRanges:l,highlightRanges:h,defaultShadowMapRanges:d}=r;switch(this._computeWhichMaterialPass()){case Fi.Opaque:e.materialOpaque.submitDraw(this,a,l,o);break;case Fi.Transparent:e.materialTransparent.submitDraw(this,a,l,o);break;case Fi.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,a,l,o),e.materialTransparent.submitDraw(this,a,l,o);break;case Fi.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,a,l,o),zL(t)&&e.highlightIntegratedMesh.submitDraw(this,a,l,o)}const u=this.componentParameters.castShadows!==si.None;if(u&&e.shadowMap.submitDraw(this,a,l,o),h!=null)for(const p of h)e.highlight.submitDraw(this,a,p[1],o,p[0]),u&&e.highlightShadowMap.submitDraw(this,a,p[1],o,p[0]);t.viewshedEnabled&&e.viewshedShadowMap.submitDraw(this,a,l,o),u&&d!=null&&e.defaultShadowMap.submitDraw(this,a,d,o)}_computeWhichMaterialPass(){return this.isIntegratedMesh?Fi.IntegratedMesh:this.objectOpacity<1?Fi.Transparent:this.componentParameters.opaqueOverride===si.All?Fi.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===ll.Blend||this.alphaDiscardMode===ll.MaskBlend?Fi.Transparent:this.componentParameters.transparent===si.None?Fi.Opaque:this.componentParameters.transparent===si.All?Fi.Transparent:Fi.OpaqueAndTransparent}};var Fi,si;c([wt({vectorOps:k1})],li.prototype,"baseColor",void 0),c([wt()],li.prototype,"usePBR",void 0),c([wt()],li.prototype,"hasParametersFromSource",void 0),c([wt({vectorOps:Cf})],li.prototype,"mrrFactors",void 0),c([wt({vectorOps:Cf})],li.prototype,"emissiveFactor",void 0),c([wt({dispose:!0})],li.prototype,"baseColorTexture",void 0),c([wt({dispose:!0})],li.prototype,"metallicRoughnessTexture",void 0),c([wt({dispose:!0})],li.prototype,"emissionTexture",void 0),c([wt({dispose:!0})],li.prototype,"occlusionTexture",void 0),c([wt({dispose:!0})],li.prototype,"normalTexture",void 0),c([wt()],li.prototype,"objectOpacity",void 0),c([rv()],li.prototype,"commonMaterialParameters",void 0),c([rv()],li.prototype,"componentParameters",void 0),c([wt()],li.prototype,"textureAlphaCutoff",void 0),c([wt()],li.prototype,"alphaDiscardMode",void 0),c([wt()],li.prototype,"isIntegratedMesh",void 0),c([wt()],li.prototype,"polygonOffsetEnabled",void 0),c([wt()],li.prototype,"ellipsoidMode",void 0),c([wt()],li.prototype,"hasOccludees",void 0),function(i){i[i.Opaque=0]="Opaque",i[i.Transparent=1]="Transparent",i[i.OpaqueAndTransparent=2]="OpaqueAndTransparent",i[i.IntegratedMesh=3]="IntegratedMesh"}(Fi||(Fi={}));let qd=class extends Ng{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=H_.Back,this.hasSlicePlane=!0}};c([wt()],qd.prototype,"doubleSided",void 0),c([wt()],qd.prototype,"cullFace",void 0),c([wt()],qd.prototype,"hasSlicePlane",void 0);let Dh=class extends Ng{constructor(){super(...arguments),this.externalColor=xr(1,1,1,1),this.externalColorMixMode=mu.Multiply,this.castShadows=si.All}get transparent(){return this.externalColor[3]<1?si.All:si.None}get opaqueOverride(){return this.externalColorMixMode===mu.Replace&&this.externalColor[3]===1?si.All:si.None}get visible(){return this.externalColor[3]>0?si.All:si.None}get type(){return mc.Uniform}};c([wt({vectorOps:k1})],Dh.prototype,"externalColor",void 0),c([wt()],Dh.prototype,"externalColorMixMode",void 0),c([wt()],Dh.prototype,"castShadows",void 0),function(i){i[i.All=0]="All",i[i.Some=1]="Some",i[i.None=2]="None"}(si||(si={}));let _h=class extends Ng{constructor(){super(...arguments),this.texture=null,this.transparent=si.None,this.opaqueOverride=si.None,this.castShadows=si.None}get type(){return mc.Varying}};function zL(i){var e;return((e=i.overlay)==null?void 0:e.getTexture(Ns.Highlight))!=null}function qL(i){var e;return((e=i.overlay)==null?void 0:e.getTexture(Ns.WaterNormal))!=null}function HL(i){var e;return((e=i.overlay)==null?void 0:e.getTexture(Ns.ColorNoRasterImage))!=null}c([wt()],_h.prototype,"texture",void 0),c([wt()],_h.prototype,"transparent",void 0),c([wt()],_h.prototype,"opaqueOverride",void 0),c([wt()],_h.prototype,"castShadows",void 0);let BL=class{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}},GL=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const s=new hi(this.textureWidth,1);s.samplingMode=Ws.NEAREST,s.wrapMode=Yi.CLAMP_TO_EDGE,this._texture=new Qi(this._rctx,s),this._data=new pu(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,s,r,n,a){const o=e*this._fieldCount+t;this._dirty=!0,this._data.set(o,0,s),this._data.set(o,1,r),this._data.set(o,2,n),this._data.set(o,3,a)}setDataElement(e,t,s,r){const n=e*this._fieldCount+t;this._dirty=!0,this._data.set(n,s,r)}getDataElement(e,t,s){const r=e*this._fieldCount+t;return this._dirty=!0,this._data.get(r,s)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const s=Math.ceil(t/this.textureWidth)*this.textureWidth,r=new pu(new ArrayBuffer(4*s));r.typedBuffer.set(this._data.typedBuffer),this._data=r}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}};const Qw=65536;let kL=class{constructor(e,t=1){this.textureBuffer=new GL(e,t),this._indexManager=new BL(Qw)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}},jL=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(e=>e.activeCount!==0||(e.dispose(),!1))}destroy(){this._buffers.forEach(e=>e.dispose()),this._buffers=[]}getBuffer(e){for(const s of this._buffers)if(s.availableCount>=e)return s;if(e>Qw)return null;const t=new kL(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}};const av=()=>Pe.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");let WL=class{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._visible=new Lt,this._hidden=new Lt,this._renderSubmit=new AL(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new jL(e.rctx,2+(Xh()?1:0))}destroy(){Gs(this._hidden.length===0&&this._visible.length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll(e=>e.destroy()),this._hidden.forAll(e=>e.destroy()),this._visible.clear(),this._hidden.clear()}createObject(e){const t=e.geometry,s=new GI(this._componentBufferManager,K1(t.componentOffsets)),r=this._createRenderable(e,s),n=new gL(this._viewingMode,t.positionData,s),a=new jI(e.transform,e.toMapSpace,e.obb.clone(),s,r,n);return(a.visible?this._visible:this._hidden).push(a),a}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const s=e;t!==s.visible&&(t?(this._hidden.removeUnordered(s),this._visible.push(s)):(this._visible.removeUnordered(s),this._hidden.push(s)),s.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll(s=>s.renderable.meta.cameraDepthSquared=Qn(t,s.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const s=e.renderable.material;t(s),s.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const s=e;s.components.visibility.reset(t),s.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,s=t.components.visibility.componentCount;return{visible:s,invisible:t.components.count-s}}setComponentData(e,t){const s=e,r=s.renderable.material,n=s.components,a=n.materialDataBuffer,o=n.materialDataIndices,l=new $L,h=a.textureBuffer,d=new Uint8Array(4),u=new Uint32Array(d.buffer);let p=0,_=0,f=0,g=n.verticalOffsets,y=1/0,w=-1/0,x=!1,T=!1,C=0;for(let S=0;S<n.count;S++){t(S,l),p+=+(l.externalColor[3]<1),_+=+(l.externalColorMixMode===mu.Replace&&l.externalColor[3]===1),f+=+l.castShadows,d2(l.externalColor,l.externalColorMixMode,d),d[2]=254&d[2]|+l.castShadows,h.setData(o[S],0,d[0],d[1],d[2],d[3]),x||(x=S>0&&C!==u[0]),C=u[0],T||(T=l.elevationOffset!==0),T&&g==null&&(g=new Array(S).fill(0)),g!=null&&(g[S]=l.elevationOffset),y=Math.min(y,l.elevationOffset),w=Math.max(w,l.elevationOffset),oE(l.elevationOffset,d),h.setData(o[S],1,d[0],d[1],d[2],d[3]);const P=l.objectAndLayerIdColor;P!=null&&h.setData(o[S],2,P[0],P[1],P[2],P[3]),l.pickable!==c_(n.pickability,S)&&(n.pickability=sL(n.pickability,n.count,S,l.pickable))}n.verticalOffsets=T?g:null,s.offsetObb=T?iE(s.obb,y,w,this._viewingMode,s.offsetObb??s.obb.clone()):null,x||T||Xh()?(r.componentParameters=new _h,r.componentParameters.castShadows=rm(f,n.count),r.componentParameters.transparent=rm(p,n.count),r.componentParameters.opaqueOverride=rm(_,n.count),r.componentParameters.texture=h,h.updateTexture()):(r.componentParameters=new Dh,r.componentParameters.castShadows=l.castShadows?si.All:si.None,r.componentParameters.externalColor=l.externalColor,r.componentParameters.externalColorMixMode=l.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,s,r=!1){e.intersectionGeometry.getComponentAabb(t,s);const n=e,a=n.components.verticalOffsets;if(r||a==null)return s;const o=a[t];if(this._viewingMode===Ne.Local||o===0)return s[2]+=o,s[5]+=o,s;const l=Nf(o);return l.localOrigin=n.transform.position,l.applyToAabb(s)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,s){return e.intersectionGeometry.getComponentPositions(t,s)}expandRangeWithComponentObjectElevationRange(e,t,s,r){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||r.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const n=e,a=n.components,o=a.count,l=a.verticalOffsets,h=n.intersectionGeometry,d=this._viewingMode===Ne.Local,u=h.getComponentAabbs(),p=XL;let _=1/0,f=-1/0;for(let g=0;g<o;g++){const y=6*g,w=(l==null?void 0:l[g])??0;let x=1/0,T=-1/0;if(d)x=u[y+2]+w+t,T=u[y+5]+w+t;else{if(p[0]=u[y],p[1]=u[y+1],p[2]=u[y+2],p[3]=u[y+3],p[4]=u[y+4],p[5]=u[y+5],w!==0){const M=Nf(w);M.localOrigin=n.transform.position,M.applyToAabb(p)}const C=Math.max(Math.abs(p[3]),Math.abs(p[0])),S=Math.max(Math.abs(p[4]),Math.abs(p[1])),P=t+p[5]+s;r.expandElevationRangeValues(t+p[2],Math.sqrt(C*C+S*S+P*P)-s)}r.expandElevationRangeValues(x,T),_=Math.min(_,x),f=Math.max(f,T)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=_,this._elevationRangeCacheMax=f}intersect(e,t,s,r,n,a,o){const l=e,{transform:h}=l,{position:d}=h;return n!=null&&(n.localOrigin=d),l.intersectionGeometry.intersect(t,s,r,n,l.components.verticalOffsets,h,a,o)}addEdges(e,t,s,r,n){const a=e,{indices:o,positions:l}=a.intersectionGeometry,h=a.components.offsets;return t.addComponentObject(a,l,o,h,s,r,n)}async extractEdgeInformation(e,t,s){const r=e,n=r.components.visibility;if(n.allInvisible()){const{extractComponentsEdgeLocationsLayout:_}=await X(()=>import("./edgeProcessing-CaTaoQ4d.js").then(f=>f.e),__vite__mapDeps([566,369,16,99,2,109,110,97,33,32,8,35,91,31,39,76,567,215,93,216,247,6]),import.meta.url);return{buffer:_.createBuffer(0),origin:[0,0,0]}}const{indices:a,positions:o}=r.intersectionGeometry,l=r.components.offsets,{EdgeInputBufferLayout:h}=await X(async()=>{const{EdgeInputBufferLayout:_}=await import("./bufferLayouts-viU4JW-U.js");return{EdgeInputBufferLayout:_}},__vite__mapDeps([567,215,93,216,109,110,97,33,32,8,35,91,31,39,76]),import.meta.url),d=h.createBuffer(o.length/3);U2(d.position.typedBuffer,o,d.position.typedBufferStride,3),nE(d.position,d.position,r.transform.rotationScale),this._setComponentIndices(d.componentIndex,a,l);const u=d.count,p=this._computeVisibilityIndices(a,n,l,u);return{origin:ta(r.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:p,indicesLength:p.length,skipDeduplicate:!0,data:d,writerSettings:{reducedPrecision:!1,variants:0}},s)}}_setComponentIndices(e,t,s){let r=0;for(let n=0;n<s.length-1;n++){const a=s[n],o=s[n+1];for(let l=a;l<o;l++){const h=t?t[l]:l;e.set(h,r)}r++}}_computeVisibilityIndices(e,t,s,r){if(e&&t.allVisible())return e;let n=0;t.forEachComponentRange((l,h)=>(n+=s[h]-s[l],!0));const a=Tx(e)?new Array(n):(e==null?void 0:e.BYTES_PER_ELEMENT)===2||r<=65536?new Uint16Array(n):new Uint32Array(n);let o=0;return t.forEachComponentRange((l,h)=>{const d=s[l],u=s[h];for(let p=d;p<u;p++)a[o++]=e?e[p]:p;return!0}),a}addComponentHighlight(e,t,s){const r=e.components;let n=r.highlightCounts,a=r.highlightGroups;n!=null&&a!=null||(n=new Uint32Array(r.count+1),r.highlightCounts=n,a=new Array(r.count+1),r.highlightGroups=a),a[t]=s,n[t]++===0&&(r.highlightsDirty(),this._notifyDirty()),n[r.count]++}removeComponentHighlight(e,t){const s=e.components,r=s.highlightCounts;if(r==null)return void av().warn("Removing non-existing highlight.");const n=r[t];if(n===0)return void av().warn("Removing non-existing highlight.");const a=r[s.count];if(n>1)return r[t]=n-1,void(r[s.count]=a-1);r[t]=0,s.highlightsDirty(),this._notifyDirty(),a===1?(s.highlightCounts=null,s.highlightGroups=null):r[s.count]=a-1}clearHighlights(e){const t=e.components;t.highlightCounts!=null&&(t.highlightCounts=null,t.highlightGroups=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const s=this._renderManager.rctx,r=e.geometry,n=r.vertices.layoutParameters,a=Ts.createVertex(s,gr.STATIC_DRAW,r.vertices.data),o=r.indices?Ts.createIndex(s,gr.STATIC_DRAW,r.indices):null,l=ca(DL(n)),h=new Uint16Array(r.vertices.count);for(let g=0;g<t.count;g++){const y=t.offsets[g],w=t.offsets[g+1],x=t.materialDataIndices[g];if(r.indices!=null)for(let T=y;T<w;T++)h[r.indices[T]]=x;else for(let T=y;T<w;T++)h[T]=x}const d=Ts.createVertex(s,gr.STATIC_DRAW,h.buffer),u=new li(e.transform,e.toMapSpace),p=new lE(s,jw,new Map([["data",l],["componentIndices",QL]]),new Map([["data",a],["componentIndices",d]]),o),_=new CL(p,_i.TRIANGLES,n,o!=null),f={cameraDepthSquared:.5,gpuMemoryEstimate:a.usedMemory+d.usedMemory+(o!=null?o.usedMemory:0)};return new xL(u,_,f)}_notifyDirty(){this._renderManager.notifyDirty()}};const QL=ca(da().u16(Ae.COMPONENTINDEX));function rm(i,e){return i===e?si.All:i===0?si.None:si.Some}const XL=qu();let YL=class{constructor(e,t,s,r,n){this.rctx=e,this.viewingMode=t,this.stippleTextures=s,this.waterTextures=r,this.markerTextures=n}get spherical(){return this.viewingMode===Ne.Global}get doublePrecisionRequiresObfuscation(){return this.rctx.driverTest.doublePrecisionRequiresObfuscation.result}},gh=class extends no{constructor(e){super(e),this.consumes={required:["olid"]},this.produces="olid"}destroy(){}render(e){const t=e.find(({name:r})=>r==="olid"),s=this.renderingContext;return s.bindFramebuffer(t.fbo),s.clearFramebuffer(ar,!0,!0),this.view._stage.renderer.renderAllGeometry(D.ObjectAndLayerIdColor),s.clear(Kt.DEPTH|Kt.STENCIL),this.view._stage.renderer.renderHUD(Js.NotOccluded),t}};c([m()],gh.prototype,"consumes",void 0),c([m()],gh.prototype,"produces",void 0),gh=c([I("esri.views.3d.webgl-engine.effects.geometry.ObjectAndLayerIDRenderNode")],gh);let ko=class extends no{constructor(e){super(e),this.consumes={required:[Ie.OCCLUDED]},this.produces=Ie.OCCLUDED;const t=e.view._stage.renderView.techniques;this._blit=new cb(t,Pa.PremultipliedAlpha)}precompile(){const e=this.view._stage.renderer;e.plugins.plugins.forAll(t=>{e.precompileSlots(t,J.OCCLUDED_TERRAIN,J.TRANSPARENT_OCCLUDER_MATERIAL),t.material&&e.precompileOccludedSlots(t,ov)})}render(e){const t=e.find(({name:n})=>n===Ie.OCCLUDED),s=this.view._stage.renderer;let r=0;if(Zr.clear(),s.plugins.plugins.forAll(n=>{n.material&&n.queryRenderOccludedState(Di.OccludeAndTransparentStencil)&&(r|=Di.OccludeAndTransparentStencil,Zr.push(n))}),Zr.length>0&&(s.renderSlots(Zr,J.OCCLUDER_MATERIAL),r&Di.OccludeAndTransparentStencil&&this._renderAndComposite(t,.5,()=>s.renderSlots(Zr,J.TRANSPARENT_OCCLUDER_MATERIAL),!1,!1)),Zr.clear(),s.plugins.plugins.forAll(n=>{if(!n.material)return;const a=n.queryRenderOccludedState(Di.OccludeAndTransparent),o=n.queryRenderOccludedState(Di.Transparent),l=n.queryRenderOccludedState(Di.Opaque);(a||o||l)&&(r|=a?Di.OccludeAndTransparent:o?Di.Transparent:Di.Opaque,Zr.push(n))}),r|=s.plugins.renderOccludedFlags,!r)return t;for(const n of ov)r&n&&this._renderAndComposite(t,n===Di.Opaque?1:.5,()=>s.renderOccludedSlots(Zr,n),!0,q_.OutlineVisualElementMask);return Zr.clear(),t}_renderAndComposite(e,t,s,r,n){const a=this.renderingContext,{width:o,height:l}=e.fbo,h=this.fboCache.acquire(o,l,"tmp color"),d=r?this.fboCache.acquireDepth(Ui.DEPTH_STENCIL_TEXTURE,o,l,"tmp depth"):e.getAttachment(ou);h.attachDepth(d),a.bindFramebuffer(h.fbo),a.clearFramebuffer(ar,r,n),s(),h.detachDepth(),this._blit.blend(a,h,e,this.bindParameters,t),r&&d.release(),h.release()}};c([m()],ko.prototype,"consumes",void 0),c([m()],ko.prototype,"produces",void 0),c([m({constructOnly:!0})],ko.prototype,"techniques",void 0),ko=c([I("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],ko);const Zr=new Lt,ov=[Di.OccludeAndTransparent,Di.Transparent,Di.Opaque];let Vg=class extends gi{};function Xw(){const i=new qt;return i.include(Xs),i.fragment.uniforms.add(new et("colorTexture",e=>e.color),new et("depthTexture",(e,t)=>t.mainDepth)),i.fragment.main.add(b`float depthSample = texture(depthTexture, uv).r;
if (depthSample == 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),i}const ZL=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:Vg,build:Xw},Symbol.toStringTag,{value:"Module"}));let lv=class extends Ht{constructor(e,t,s){super(e,t,new Bt(ZL,()=>X(()=>Promise.resolve().then(()=>XN),void 0,import.meta.url)),s)}initializePipeline(){return Qt({blending:dc(Rt.ONE,Rt.ZERO,Rt.ONE_MINUS_SRC_COLOR,Rt.ONE),depthTest:{func:ji.ALWAYS},colorWrite:Jt})}};function Yw(i){const e=new qt;e.include(Wu);const{reduced:t}=i,{fragment:s}=e;return s.uniforms.add(new et("depthTexture",(r,n)=>n.mainDepth),new Be("hazeStrength",r=>r.hazeStrength)),Fu(s),e.include(Nu),s.include(N_),s.include(Bu),s.include(I_),s.include(Iw,!0),t&&s.code.add(b`float getDepth(vec2 uv){
return linearDepthFromTexture(depthTexture, uv);
}
float textureBilinear(vec2 uv) {
vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
vec2 texelSize = 1.0 / depthTextureSize;
vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);
vec2 f = fract(depthUV);
vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;
float d0 = getDepth(snapUV);
float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
float d3 = getDepth(snapUV + texelSize);
return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
}`),s.main.add(b`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture(depthTexture, uv).r;
      if (depthSample != 1.0) {
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;

        cameraSpaceRay *= ${He(t,"-textureBilinear(uv)","-linearDepthFromTexture(depthTexture, uv)")};
        terrainDepth = max(0.0, length(cameraSpaceRay));
      } else {
        discard;
      }

      // Alpha is ignored for haze blending
      vec3 col = vec3(0);
      float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
      if(depthSample != 1.0){
        col = (1.0 - fadeOut) * hazeStrength * raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      }
      float alpha = 1.0;

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
  `),e}const KL=Object.freeze(Object.defineProperty({__proto__:null,build:Yw},Symbol.toStringTag,{value:"Module"}));let JL=class extends $w{constructor(){super(...arguments),this.hazeStrength=1}},nm=class extends Ht{constructor(e,t,s){super(e,t,new Bt(KL,()=>X(()=>Promise.resolve().then(()=>YN),void 0,import.meta.url)),s)}initializePipeline(e){return e.reduced?Qt({blending:U_,depthTest:{func:ji.ALWAYS},colorWrite:Jt}):Qt({blending:dc(Rt.ONE,Rt.ZERO,Rt.ONE_MINUS_SRC_COLOR,Rt.ONE),colorWrite:Jt})}},Zw=class extends pa{constructor(){super(...arguments),this.reduced=!1}};c([pe()],Zw.prototype,"reduced",void 0);let u_=class extends Ah{constructor(e){super(e),this._compositingPassParameters=new Vg,this._passParameters=new JL,this._hazeConfiguration=new Zw,this._vao=null,this.requireGeometryDepth=!0,this._oldAmount=1,this._newAmount=1,this._amount=this._newAmount;const{techniques:t}=e;t.precompile(nm,this._hazeConfiguration),t.precompile(lv),this._hazeConfiguration.reduced=!0,t.precompile(nm,this._hazeConfiguration),this._hazeConfiguration.reduced=!1}initialize(){this.addHandles([E(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ge),E(()=>{var e;return((e=this.view._stage)==null?void 0:e.renderer.renderContext.bind.clouds.fadeFactor)??1},e=>this._fade(e),Ge),E(()=>this.view.environment.weather.type,e=>this._newAmount=e==="rainy"?0:1,Ge),E(()=>{var e;return(e=this.view._stage.renderer)==null?void 0:e.fullResolutionAtmosphere},e=>this._hazeConfiguration.reduced=!e,Ge)])}_fade(e){e>=1?(this._amount=this._newAmount,this._oldAmount=this._newAmount):this._amount=e<=0?this._oldAmount:ke(this._oldAmount,this._newAmount,e)}destroy(){this._vao=We(this._vao)}render(e){const t=e.find(({name:g})=>g===Ie.TRANSPARENT_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;const s=this.renderingContext;this._vao??(this._vao=ma(s,Gr.Pos2Tex));const r=this.techniques.acquire(nm,this._hazeConfiguration);if(!r.compiled)return r.release(),t;const n=t.getAttachment(s.gl.DEPTH_STENCIL_ATTACHMENT);if(this._update(),!this._hazeConfiguration.reduced)return t.detachDepth(),s.bindFramebuffer(t.fbo),s.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(s),t.attachDepth(n),r.release(),t;const a=this.techniques.acquire(lv);if(!a.compiled)return r.release(),a.release(),t;const o=s.getViewport(),l=this.camera,h=Ce(l.eye)-rs.radius;let d;const u=rs.atmosphereHeight;if(h<u){const g=Math.min(1,Math.max(0,h/u));d=ke(.4,.5,g)}else{const g=Math.min(1,Math.max(0,(h-u)/(15*u)));d=ke(.5,1,g)}const p=Gh(Math.round(d*l.fullViewport[2])),_=Gh(Math.round(d*l.fullViewport[3]));s.setViewport(0,0,p,_);const f=this.fboCache.acquire(p,_,"haze",Ti.RGBA);return s.bindFramebuffer(f.fbo),s.clearFramebuffer([0,0,0,1],!0,!0),s.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(s),s.setViewport(o.x,o.y,o.width,o.height),this._compositingPassParameters.color=f.getTexture(),t.detachDepth(),s.bindFramebuffer(t.fbo),s.bindTechnique(a,this.bindParameters,this._compositingPassParameters),s.screen.draw(),t.attachDepth(n),a.release(),r.release(),f.release(),t}_renderCommon(e){this._vao!=null&&(e.bindVAO(this._vao),e.drawArrays(_i.TRIANGLE_STRIP,0,4))}_update(){const e=this.bindParameters.camera,t=Hs(e.eye),s=Math.sqrt(t),r=t-this._passParameters.radii[1]*this._passParameters.radii[1],n=W((s-this._passParameters.radii[0])/rs.atmosphereHeight,0,1);oa(this._passParameters.heightParameters,s,t,r,n);const a=this.view.basemapTerrain.getLowerBoundRadius();ro(this._passParameters.radii,a,a+rs.atmosphereHeight),this._passParameters.hazeStrength=ke(ke(.6,1,Fh(9500,10500,s-rs.radius)),1,this._amount)}};u_=c([I("esri.views.3d.webgl-engine.effects.haze.Haze")],u_);function e3(i){const e=i.fragment;i.include(V_),e.include(N_),e.code.add(b`vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
float leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);
float rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);
float bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);
float topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`)}let Fg=class extends pa{constructor(){super(...arguments),this.receiveShadows=!0}};c([pe()],Fg.prototype,"receiveShadows",void 0);const t3=.025;function Kw(){const i=new qt;i.include(Z_,i3),i.include(Xs),i.include(e3);const e=i.fragment;return e.include(ig),e.uniforms.add(new et("defaultDepthTex",(t,s)=>s.shadowMap.getSnapshot(su.ExcludeHighlight)),new et("highlightDepthTex",(t,s)=>s.shadowMap.getSnapshot(su.Highlight)),new et("depthMap",(t,s)=>{var r;return(r=s.depth)==null?void 0:r.attachment}),new et("highlightTexture",t=>t.highlight),new cc("uColor",t=>t.shadowColor),new Be("opacity",t=>t.shadowOpacity),new Be("occludedOpacity",t=>t.occludedShadowOpacity),new Be("terminationFactor",t=>t.opacityElevation*t.dayNightTerminator),new Wi("lightingMainDirectionView",(t,s)=>ae(cv,Wt(cv,s.lighting.mainLight.direction,s.camera.viewInverseTransposeMatrix))),new Tn("inverseViewMatrix",(t,s)=>au(hv,qh(hv,s.camera.viewMatrix,s.camera.center)))).main.add(b`
    ivec2 highlightTextureSize = textureSize(highlightTexture, 0);
    ivec2 highlightIUV = ivec2(uv * vec2(highlightTextureSize));
    vec4 highlightInfo = texelFetch(highlightTexture, highlightIUV, 0);

    fragColor = vec4(0.0);

    // Calculate bit mask to check if pixel is highlit unoccluded at any level
    int ored =
         (int(highlightInfo.r*255.0) << 0)
       | (int(highlightInfo.g*255.0) << 8)
       | (int(highlightInfo.b*255.0) << 16)
       | (int(highlightInfo.a*255.0) << 24);
    bool visiblyHighlighted = ((ored & ~(ored >> 1)) & (1+4+16+64)) != 0;
    if (visiblyHighlighted) {
      return;
    }

    // 1.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
    float depth = depthFromTexture(depthMap, uv);
    if (depth >= 1.0 || depth <= 0.0) {
      return;
    }

    float currentPixelDepth = linearizeDepth(depth);
    vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
    vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;

    mat4 shadowMatrix;
    float linearDepth = -currentPixelDepth;
    int i = chooseCascade(linearDepth, shadowMatrix);
    if (i >= numCascades) {
      return;
    }

    // vertex completely outside? -> no shadow
    vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
    if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
      return;
    }

    ivec2 texSize = textureSize(highlightDepthTex, 0);
    ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));

    float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
    bool shadowHighlight = depthHighlight < lvpos.z;
    if (!shadowHighlight) {
      return;
    }

    float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
    bool shadowDefault = depthDefault < lvpos.z;

    vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);
    bool shaded = dot(normal, lightingMainDirectionView) < ${b.float(t3)};

    float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
    fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
  `),i}const hv=Nt(),cv=v(),i3=new Fg,s3=Object.freeze(Object.defineProperty({__proto__:null,build:Kw},Symbol.toStringTag,{value:"Module"}));let r3=class extends Y_{constructor(){super(...arguments),this.shadowColor=xr(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}},dv=class extends Ht{constructor(e,t,s){super(e,t,new Bt(s3,()=>X(()=>Promise.resolve().then(()=>ZN),void 0,import.meta.url)),s),this.primitiveType=_i.TRIANGLE_STRIP}initializePipeline(){return Qt({blending:uc,colorWrite:Jt,depthTest:null,depthWrite:null})}};const n3=1/512,a3=4e4,o3=5e4;let $a=class extends no{constructor(e){super(e),this.produces=zi.COMPOSITE,this.consumes={required:[zi.COMPOSITE,"highlights"]},this._passParameters=new r3,this._maxOpacity=1,this._shadowDifference=.2,e.techniques.precompile(dv)}initialize(){this.addHandles([E(()=>this.view.highlightOptions.shadowOpacity,e=>{this._passParameters.shadowOpacity=e??ab,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},Ge),E(()=>this.view.highlightOptions.shadowDifference,e=>{this._shadowDifference=e??ob,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},Ge),E(()=>this.view.highlightOptions.shadowColor,e=>{this._passParameters.shadowColor=tg(e??nb),this._ensureMaxOpacity()},Ge)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(Me.UPDATE)}render(e){var n;const t=e.find(({name:a})=>a===zi.COMPOSITE),s=this.bindParameters;if(!s.shadowHighlightsVisible||!s.depth||!this._ensureIfVisible(s.camera,s.lighting.mainLight.direction))return t;const r=this.techniques.acquire(dv);if(r.compiled){this._passParameters.highlight=(n=e.find(({name:o})=>o==="highlights"))==null?void 0:n.getTexture(),this._passParameters.origin=s.camera.center;const a=this.renderingContext;a.bindFramebuffer(t.fbo),a.bindTechnique(r,s,this._passParameters),a.screen.draw()}else this.requestRender(Me.UPDATE);return r.release(),t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-Fh(a3,o3,e.relativeElevation);const s=this.viewingMode===Ne.Global?ae(uv,e.center):$e(uv,0,0,1),r=ce(s,t);return this._passParameters.dayNightTerminator=Fh(0,1,W(30*r,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=n3}};c([m()],$a.prototype,"produces",void 0),c([m()],$a.prototype,"consumes",void 0),c([m({constructOnly:!0})],$a.prototype,"viewingMode",void 0),c([m({constructOnly:!0})],$a.prototype,"techniques",void 0),$a=c([I("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],$a);const uv=v();let Ug=class extends gi{constructor(){super(...arguments),this.mask=null,this.overlay=null,this.input=null,this.size=0}};function Jw(){const i=new qt;return i.attributes.add(Ae.POSITION,"vec2"),i.vertex.uniforms.add(new cc("drawPosition",(e,t)=>l3(e,t))),i.varyings.add("vUV","vec2"),i.vertex.main.add(b`vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);`),i.fragment.uniforms.add(new et("textureInput",e=>e.input)),i.fragment.uniforms.add(new et("textureMask",e=>e.mask)),i.fragment.uniforms.add(new et("textureOverlay",e=>e.overlay)),i.fragment.uniforms.add(new kh("maskEnabled",e=>e.magnifier.maskEnabled)),i.fragment.uniforms.add(new kh("overlayEnabled",e=>e.magnifier.overlayEnabled)),i.fragment.code.add(b`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}`),i.fragment.main.add(b`float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;`),i}function l3(i,e){const t=e.camera.pixelRatio,s=i.magnifier.offset.x*t,r=i.magnifier.offset.y*t;dn(i.magnifier.position,pv);const n=e.camera.screenToRender(pv,h3),a=Math.ceil(t*i.magnifier.size),{fullWidth:o,fullHeight:l}=e.camera;return oa(c3,(n[0]+s)/o*2-1,(n[1]-r)/l*2-1,a/o*2,a/l*2)}const pv=ri(),h3=Wv(),c3=Ci(),d3=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:Ug,build:Jw},Symbol.toStringTag,{value:"Module"}));let mv=class extends Ht{constructor(e,t,s){super(e,t,new Bt(d3,()=>X(()=>Promise.resolve().then(()=>KN),void 0,import.meta.url)),s)}initializePipeline(){return Qt({blending:z_,depthTest:null,depthWrite:null,colorWrite:Jt})}},zn=class extends no{constructor(e){super(e),this.produces=Ie.MAGNIFIER,this.consumes={required:[Ie.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new Ug,this._vao=null,this._magnifier=null,this._tmpScreenPoint=ri(),this._tmpRenderPoint=Wv()}initialize(){this.addHandles([E(()=>this.view.magnifier,e=>this._update(e),Ge)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{const s=this._validMagnifier;s?(this._loadResources(s),this.produces=Ie.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles(E(()=>{var s;return(s=this._magnifier)==null?void 0:s.version},t)),t()}get _validMagnifier(){var e,t,s;return(e=this._magnifier)!=null&&e.visible&&((t=this._magnifier)!=null&&t.position)&&((s=this._magnifier)==null?void 0:s.size)>0?this._magnifier:null}get _factor(){var e;return((e=this._magnifier)==null?void 0:e.factor)||1}destroy(){this._magnifier=null,this._imageLoadTask!=null&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=We(this._vao)}_disposeTextures(){this._passParameters.mask=We(this._passParameters.mask),this._passParameters.overlay=We(this._passParameters.overlay),this._passParameters.input=We(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(mv)}render(e){const t=this._validMagnifier,s=e.find(({name:w})=>w===Ie.MAGNIFIER);if(t==null)return s;if(this._imageSources==null)return this.requestRender(Me.UPDATE),s;const r=this.renderingContext,n=this.camera.pixelRatio,a=Math.ceil(n*t.size);this._vao??(this._vao=ma(r,Gr.Pos2,Ol,0,1));const o=this.techniques.acquire(mv);if(this._ensureTextureResources(r,a),!o.compiled||!this._passParameters.input)return o.release(),this.requestRender(Me.UPDATE),s;const l=Math.ceil(1/this._factor*a),h=this._passParameters.input;h.resize(l,l),dn(t.position,this._tmpScreenPoint);const d=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),u=this.camera.fullWidth,p=this.camera.fullHeight,_=.5*l,f=.5*l;d[0]=W(d[0],_,u-_-1),d[1]=W(d[1],f,p-f-1);const g=Math.floor(d[0]-_),y=Math.floor(d[1]-f);return r.bindFramebuffer(s.fbo),o.program.bindTexture("textureInput",h),r.gl.copyTexImage2D(h.descriptor.target,0,h.descriptor.pixelFormat,g,y,l,l,0),this._passParameters.magnifier=t,r.bindTechnique(o,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(_i.TRIANGLE_STRIP,0,4),o.release(),s}_loadResources(e){var r,n,a;const{maskUrl:t,overlayUrl:s}=e;((r=this._imageLoadTask)==null?void 0:r.maskUrl)===t&&((n=this._imageLoadTask)==null?void 0:n.overlayUrl)===s||((a=this._imageLoadTask)==null||a.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:t,overlayUrl:s,task:lc(async o=>{const l=t==null||s==null?eE(o):null,h=t!=null?Kh(t,{signal:o}):l.then(u=>u.mask),d=s!=null?Kh(s,{signal:o}):l.then(u=>u.overlay);this._imageSources={mask:await h,overlay:await d}})})}_ensureTextureResources(e,t){if(this._imageSources==null||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay)return;this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t;const s=new hi;s.internalFormat=ai.RGBA,s.wrapMode=Yi.CLAMP_TO_EDGE,s.flipped=!0,s.preMultiplyAlpha=!lb(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result,this._passParameters.overlay=new Qi(e,s,this._imageSources.overlay),s.pixelFormat=s.internalFormat=ai.ALPHA,s.preMultiplyAlpha=!1,this._passParameters.mask=new Qi(e,s,this._imageSources.mask),s.pixelFormat=s.internalFormat=ai.RGBA,s.flipped=!1,this._passParameters.input=new Qi(e,s)}};c([m()],zn.prototype,"produces",void 0),c([m()],zn.prototype,"consumes",void 0),c([m()],zn.prototype,"_imageSources",void 0),c([m()],zn.prototype,"_imageLoadTask",void 0),c([m({constructOnly:!0})],zn.prototype,"techniques",void 0),zn=c([I("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],zn);const th=8,u3=16;function ex(){const i=new qt;return i.include(Xs),i.fragment.uniforms.add(new et("edgesTexture",e=>e.inputTexture),new et("areaTexture",e=>e.areaTexture),new et("searchTexture",e=>e.searchTexture)),i.fragment.code.add(b`
    #define SMAA_AREATEX_PIXEL_SIZE (1.0 / vec2(160.0, 560.0))
    #define SMAA_AREATEX_SUBTEX_SIZE (1.0 / 7.0)

    vec4 sampleLevelZeroOffset(vec2 coord, vec2 offset, vec2 resolution) {
      return texture(edgesTexture, coord + offset.x * resolution);
    }

    float searchLength(vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture(searchTexture, e).r;
    }

    float searchLeft(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${b.int(th)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x > end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${b.int(th)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x < end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength(e, 0.5, 0.5);
      return texcoord.x;
    }

    float searchUp(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${b.int(th)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y > end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength(e.gr, 0.0, 0.5);
      return texcoord.y;
    }

    float searchDown(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${b.int(th)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y < end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength(e.gr, 0.5, 0.5);
      return texcoord.y;
    }

    vec2 getArea(sampler2D areaTex, vec2 dist, float e1, float e2, float offset) {
      vec2 texcoord = float(${b.int(u3)}) * round(4.0 * vec2(e1, e2)) + dist;
      texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + (0.5 * SMAA_AREATEX_PIXEL_SIZE);
      texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
      return texture(areaTex, texcoord).rg;
    }`),i.fragment.main.add(b`
    vec2 size = vec2(textureSize(edgesTexture, 0));
    vec2 resolution = 1.0 / size;
    vec2 pixelCoord = uv * size;
    vec4 offsets[2];
    offsets[0] = uv.xyxy + resolution.xyxy * vec4(-0.25, 0.125, 1.25, 0.125);
    offsets[1] = uv.xyxy + resolution.xyxy * vec4(-0.125, 0.25, -0.125, -1.25);
    vec4 maxOffset = vec4(offsets[0].xz, offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * resolution.xxyy * float(${b.int(th)});
    ivec4 subsampleIndices = ivec4(0.0);
    vec4 weights = vec4(0.0);
    vec2 e = texture(edgesTexture, uv).rg;
    if (e.r > 0.0) {
      vec2 d;
      vec2 coords;
      coords.y = searchUp(offsets[1].xy, maxOffset.z, resolution);
      coords.x = offsets[0].x;
      d.x = coords.y;
      float e1 = texture(edgesTexture, coords).g;
      coords.y = searchDown(offsets[1].zw, maxOffset.w, resolution);
      d.y = coords.y;
      d = d * size.y - pixelCoord.y;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(0.0, 1.0), resolution).g;
      weights.ba = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.x));
      // for some reason the following lines are necessary to prevent
      // texture lookup precision issues on some Intel integrated graphics chips
      vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
      weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
    }
    if (e.g > 0.0) {
      vec2 d;
      vec2 coords;
      coords.x = searchLeft(offsets[0].xy, maxOffset.x, resolution);
      coords.y = offsets[1].y;
      d.x = coords.x;
      float e1 = texture(edgesTexture, coords).r;
      coords.x = searchRight(offsets[0].zw, maxOffset.y, resolution);
      d.y = coords.x;
      d = d * size.x - pixelCoord.x;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(1.0, 0.0), resolution).r;
      weights.rg = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.y));
    }
    fragColor = weights;
  `),i}const p3=Object.freeze(Object.defineProperty({__proto__:null,build:ex},Symbol.toStringTag,{value:"Module"}));let _v=class extends Ht{constructor(e,t,s){super(e,t,new Bt(p3,()=>X(()=>Promise.resolve().then(()=>JN),void 0,import.meta.url)),s)}initializePipeline(){return Qt({colorWrite:Jt})}};function tx(){const i=new qt;return i.include(Xs),i.fragment.uniforms.add(new et("blendWeightsTexture",e=>e.inputTexture),new et("colorTexture",e=>e.color)),i.fragment.main.add(b`vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}`),i}const m3=Object.freeze(Object.defineProperty({__proto__:null,build:tx},Symbol.toStringTag,{value:"Module"}));let gv=class extends Ht{constructor(e,t,s){super(e,t,new Bt(m3,()=>X(()=>Promise.resolve().then(()=>e5),void 0,import.meta.url)),s)}initializePipeline(){return Qt({colorWrite:Jt})}};const _3=.05,g3=2;function ix(){const i=new qt;return i.include(Xs),i.outputs.add("fragEdges","vec2"),i.fragment.code.add(b`float absMax3(vec3 v) {
vec3 t = abs(v);
return max(max(t.r, t.g), t.b);
}`),i.fragment.uniforms.add(new et("colorTexture",e=>e.color)).main.add(b`
    vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
    vec4 offsets[3];
    offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
    offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
    offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

    // Calculate color deltas:
    vec3 C = texture(colorTexture, uv).rgb;
    vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
    vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
    vec2 delta = vec2(absMax3(C - Cleft), absMax3(C - Ctop));
    vec2 edges = step(vec2(${b.float(_3)}), delta);

    // discard if there is no edge:
    if (dot(edges, vec2(1.0)) == 0.0) {
      fragEdges = vec2(0.0);
    }
    else {
      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      float horizontal = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      float vertical = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), horizontal), vertical);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      horizontal = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      vertical = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, horizontal), vertical);

      // Local contrast adaptation in action:
      fragEdges = edges * step(maxDelta, float(${b.float(g3)}) * delta);
    }
  `),i}const f3=Object.freeze(Object.defineProperty({__proto__:null,build:ix},Symbol.toStringTag,{value:"Module"}));let fv=class extends Ht{constructor(e,t,s){super(e,t,new Bt(f3,()=>X(()=>Promise.resolve().then(()=>t5),void 0,import.meta.url)),s)}initializePipeline(){return Qt({colorWrite:Jt})}},y3=class extends gi{},qn=class extends no{constructor(e){super(e),this.produces="disabled",this.consumes={required:[Ie.ANTIALIASING],optional:[zi.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new y3,e.techniques.precompile(fv),e.techniques.precompile(_v),e.techniques.precompile(gv)}initialize(){this.addHandles([E(()=>this.isEnabled(),e=>e?this.enable():this.disable(),Ge)])}async enable(){if(this.produces=Ie.ANTIALIASING,this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const e=this._abortController.signal;try{const t=await X(()=>import("./SMAAData-DCEZ61Cs.js"),[],import.meta.url);await this._loadTextures(t,e),this.requestRender(Me.UPDATE)}catch{}this._abortController=null}async _loadTextures(e,t){Gi(t);const[s,r]=await Promise.allSettled([Kh(e.areaTexture,{signal:t}),Kh(e.searchTexure,{signal:t})]);if(Gi(t),s.status!=="fulfilled"||r.status!=="fulfilled")return;const n=this.renderingContext;this._areaTexture=yv(n,Ws.LINEAR,ai.RGB,s.value),this._searchTexture=yv(n,Ws.NEAREST,ai.LUMINANCE,r.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=We(this._searchTexture),this._areaTexture=We(this._areaTexture)}render(e){const t=e.find(({name:_})=>_===Ie.ANTIALIASING);if(!this._areaTexture||!this._searchTexture)return this.requestRender(Me.UPDATE),t;const s=this.techniques.acquire(fv),r=this.techniques.acquire(_v),n=this.techniques.acquire(gv);if(!s.compiled||!r.compiled||!n.compiled)return s.release(),r.release(),n.release(),this.requestRender(Me.UPDATE),t;const a=e.find(({name:_})=>_===zi.COMPOSITE);if(!a)return t;const o=a.fbo.width,l=a.fbo.height,h=this.renderingContext;h.setViewport(0,0,o,l);const d=this.fboCache.acquire(o,l,"smaa edges",Ti.RG);h.bindFramebuffer(d.fbo),h.setClearColor(0,0,0,1),h.clear(Kt.COLOR),this._smaaParameters.color=a.getTexture();const u=this.bindParameters;h.bindTechnique(s,u,this._smaaParameters),h.screen.draw(),s.release();const p=this.fboCache.acquire(o,l,"smaa blend");return h.bindFramebuffer(p.fbo),h.setClearColor(0,0,1,1),h.clear(Kt.COLOR),this._smaaParameters.inputTexture=d.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,h.bindTechnique(r,u,this._smaaParameters),h.screen.draw(),r.release(),d.release(),h.bindFramebuffer(t.fbo),h.setClearColor(0,1,0,1),h.clear(Kt.COLOR),this._smaaParameters.inputTexture=p.getTexture(),h.bindTechnique(n,u,this._smaaParameters),h.screen.draw(),n.release(),p.release(),t}};function yv(i,e,t,s){const r=new hi;return r.pixelFormat=t,r.wrapMode=Yi.CLAMP_TO_EDGE,r.width=s.width,r.height=s.height,r.samplingMode=e,new Qi(i,r,s)}c([m()],qn.prototype,"produces",void 0),c([m()],qn.prototype,"consumes",void 0),c([m({constructOnly:!0})],qn.prototype,"isEnabled",void 0),c([m({constructOnly:!0})],qn.prototype,"techniques",void 0),c([m()],qn.prototype,"_abortController",void 0),qn=c([I("esri.views.3d.webgl-engine.effects.smaa.SMAA")],qn);function sx(){const i=new qt;return i.attributes.add(Ae.POSITION,"vec3"),i.attributes.add(Ae.COLOR,"vec4"),i.attributes.add(Ae.SIZE,"float"),i.varyings.add("vcolor","vec4"),i.varyings.add("vsize","float"),i.vertex.uniforms.add(new Tn("transform",(e,t)=>v3(e,t)),new cc("viewport",(e,t)=>t.camera.fullViewport),new Be("pixelRatio",(e,t)=>t.camera.pixelRatio)),i.vertex.main.add(b`gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;`),i.fragment.main.add(b`float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);`),i}function v3(i,e){return hc(In,e.camera.projectionMatrix),In[10]=24e-8-1,In[11]=-1,In[14]=(24e-8-2)*e.camera.near,_r(In,In,e.camera.viewMatrix),_r(In,In,i.modelMatrix)}const In=Nt(),b3=Object.freeze(Object.defineProperty({__proto__:null,build:sx},Symbol.toStringTag,{value:"Module"}));let w3=class extends gi{constructor(){super(...arguments),this.modelMatrix=Nt()}},vv=class extends Ht{constructor(e,t,s){super(e,t,new Bt(b3,()=>X(()=>Promise.resolve().then(()=>i5),void 0,import.meta.url)),s)}initializePipeline(){return Qt({blending:uc,depthTest:{func:ji.LEQUAL},colorWrite:Jt})}},p_=class extends lr{constructor(e){super(e),this._starData=null,this._loadDataTask=null,this._numPoints=0,this._passParameters=new w3,e.techniques.precompile(vv)}initialize(){this.addHandles([E(()=>this.view.environment.starsEnabled,e=>e?this._enable():this._disable(),dt),E(()=>this.view.environment.lighting.type==="virtual"?null:this.view.environment.lighting.date,e=>this._update(e),Ge)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=ha(this._loadDataTask),this._numPoints=0,this._vao=We(this._vao),this._starData=null}render(e){const t=e.find(({name:n})=>n===Ie.OPAQUE_ENVIRONMENT),s=this.renderingContext;if(this.loading)return this.requestRender(Me.UPDATE),t;if(!this._starData)return t;this._vao??(this._vao=this._ensureResources(this._starData,s));const r=this.techniques.acquire(vv);return r.compiled?(s.bindTechnique(r,this.bindParameters,this._passParameters),s.bindVAO(this._vao),s.drawArrays(_i.POINTS,0,this._numPoints),r.release(),t):(this.requestRender(Me.UPDATE),r.release(),t)}_ensureResources(e,t){return this._numPoints=e.byteLength/rx,x3(t,new Float32Array(e,0,2*this._numPoints),new Uint8Array(e,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,s=2*C3(e),r=hc(this._passParameters.modelMatrix,O3);Pf(r,r,-s*Math.PI),_r(r,M3,r),Pf(r,r,-t*Math.PI),this.requestRender(Me.UPDATE)}_createLoadDataTask(){if(this._starData)return null;const e=lc(async t=>{const{data:s}=await L2("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});T3(s),this._starData=s});return e.promise.catch(t=>{Jn(t)||Pe.getLogger(this).error(t)}).then(()=>{this.destroyed||this.requestRender(Me.UPDATE)}),e}};function x3(i,e,t,s){const r=bv.createBuffer(s),n=r.position,a=r.color,o=r.size;for(let l=0;l<s;l++){const h=e[2*l],d=e[2*l+1];n.set(l,0,-Math.cos(h)*Math.sin(d)),n.set(l,1,-Math.sin(h)*Math.sin(d)),n.set(l,2,-Math.cos(d));const u=P3(t[l]),p=S3(E3[u[1]]);a.set(l,0,255*p[0]),a.set(l,1,255*p[1]),a.set(l,2,255*p[2]),a.set(l,3,255),o.set(l,u[0])}return new ua(i,Ol,new Map([["geometry",ca(bv)]]),new Map([["geometry",Ts.createVertex(i,gr.STATIC_DRAW,r.buffer)]]))}function C3(i){const e=i,t=new Date(i.getFullYear(),0,1,11,58,56);return(+e-+t)/(+new Date(i.getFullYear()+1,0,1,11,58,55)-+t)}function T3(i){if(!i)throw new Bi("stars:no-data-received","Failed to create stars because star catalogue is missing");const e=i.byteLength/rx;if(e%1!=0||e>5e4||e<5e3)throw new Bi("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}function S3(i){return[parseInt(i.slice(0,2),16),parseInt(i.slice(2,4),16),parseInt(i.slice(4,6),16)]}function P3(i){return i>=192?[2.9,i-192]:i>=160?[2.5,i-160]:i>=128?[2,i-128]:i>=96?[1.5,i-96]:i>=64?[1,i-64]:i>=32?[.7,i-32]:[.4,i]}p_=c([I("esri.views.3d.webgl-engine.effects.stars.Stars")],p_);const E3=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],M3=y1(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),O3=y1(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),rx=9,bv=da().vec3f(Ae.POSITION).vec4u8(Ae.COLOR).f32(Ae.SIZE);let zg=class extends gi{};function nx(){const i=new qt;return i.include(Xs),i.fragment.uniforms.add(new et("tex",e=>e.texture)),i.fragment.main.add(b`fragColor = vec4(1.0 - texture(tex, uv).a);`),i}const R3=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:zg,build:nx},Symbol.toStringTag,{value:"Module"}));let wv=class extends Ht{constructor(e,t,s){super(e,t,new Bt(R3,()=>X(()=>Promise.resolve().then(()=>s5),void 0,import.meta.url)),s)}initializePipeline(){return Qt({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}},A3=class{constructor(e,t){this._rctx=e,this._techniques=t,this._configuration=new cE,this._passParameters=new dE,this._hudParameters=new zg,this._configuration.blitMode=Pa.PremultipliedAlpha,this._techniques.precompile(zl,this._configuration),this._configuration.hasOpacityFactor=!0,this._techniques.precompile(zl,this._configuration),this._configuration.hasOpacityFactor=!1,this._configuration.blitMode=Pa.Alpha,this._techniques.precompile(zl,this._configuration),this._configuration.blitMode=Pa.Depth,this._techniques.precompile(zl,this._configuration),this._techniques.precompile(wv)}compositeHUD(e,t){this._hudParameters.texture=t;const s=this._techniques.acquire(wv);this._rctx.bindTechnique(s,e,this._hudParameters),this._rctx.screen.draw(),s.release()}compositePreMultipliedAlpha(e,t,s=1){this._composite(e,t,Pa.PremultipliedAlpha,s)}composite(e,t){this._composite(e,t,Pa.Alpha,1)}blitDepthToLinearDepth(e,t){this._composite(e,t,Pa.Depth,1)}_composite(e,t,s,r){this._configuration.blitMode=s,this._configuration.hasOpacityFactor=r!==1,this._passParameters.texture=t,this._passParameters.opacity=r;const n=this._techniques.acquire(zl,this._configuration);this._rctx.bindTechnique(n,e,this._passParameters),this._rctx.screen.draw(),n.release()}},D3=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new pu(new ArrayBuffer(4)),this._layerToOidToColor=new cu,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new cu,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,s,r,n,a=null,o=null,l=null){e&&t&&s&&r&&(this._layerUidToId.set(r,s),this._layerUidToPopupEnabled.set(r,n),n&&this._layerUidToGraphicsUidToObjectId.set(r,t,{objectId:e,attributeNodeId:a,attributeIndex:o,subLayerId:l}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return xr(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){var a;if(!e.layerUid||!e.graphicUid)return this.colorZero;const t=this._layerUidToPopupEnabled.get(e.layerUid);if(t===void 0)return this.colorZero;if(t===!1)return this.colorZero;const s=(a=this._layerUidToGraphicsUidToObjectId.get(e.layerUid,e.graphicUid))==null?void 0:a.objectId;if(!s)return this.colorZero;let r=this._layerToOidToColor.get(e.layerUid,s);if(!r){if(Li("enable-feature:objectAndLayerId-screenshot-testing"))r=s;else for(;!r;){const o=Math.floor(16777214*Math.random())+1;this._colorToUID.has(o)||(r=o)}if(r>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerUid,s,r),this._colorToUID.set(r,e)}const n=new ArrayBuffer(4);return new DataView(n).setUint32(0,r,!1),new pu(n)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,s]of this._colorToUID.entries()){const r=this._layerUidToGraphicsUidToObjectId.get(s.layerUid,s.graphicUid),n=this._layerUidToId.get(s.layerUid);r&&n&&e.set(t,r.attributeNodeId?{type:"object-and-layer-and-i3s-id",olid:r.objectId,lid:n,attrId:r.attributeNodeId,attrIdx:r.attributeIndex,subLayerId:r.subLayerId}:{type:"object-and-layer-id",olid:r.objectId,lid:n})}return e}},ax=class{constructor(e,t){this.key=e,this.free=t,this.incarnation=0,this._refCount=1}retain(e=1){this._refCount+=e}release(){return this._refCount===0?(console.log(`Releasing already released FBO attachment "${this.name}" in ${new Error().stack}`),!0):(--this._refCount,this._refCount===0&&(this.free(),!0))}};var Sl;(function(i){i[i.FBO=0]="FBO",i[i.DEPTH=1]="DEPTH",i[i.COLOR=2]="COLOR"})(Sl||(Sl={}));let ox=class extends ax{constructor(e,t,s){super(e,s),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get usedMemory(){return this.attachment.usedMemory}},$3=class extends ox{constructor(e,t,s){super(e,t,s),this.attachment=t,this.type=Sl.COLOR}},xv=class extends ox{constructor(){super(...arguments),this.type=Sl.DEPTH}};function I3(i){return(i==null?void 0:i.attachment.type)===BS.Texture}let lx=class extends ax{constructor(e,t,s,r,n,a){super(e,a),this.type=Sl.FBO,this._colors=new Map,this._name=zi.COMPOSITE,this.acquireDepth=null,this.acquireColor=null,this._name=t,this.fbo=s,this.acquireDepth=r,this.acquireColor=n}dispose(){var e;(e=this.fbo)==null||e.dispose()}get usedMemory(){var e;return((e=this.fbo)==null?void 0:e.usedMemory)||0}get numberOfColorAttachments(){return this._colors.size}get name(){return this._name}setName(e){this._name=e}getTexture(e=yl.COLOR_ATTACHMENT0){var t,s;return e===ou?(t=this.fbo)==null?void 0:t.depthStencilTexture:(s=this.fbo)==null?void 0:s.getColorTexture(e)}getAttachment(e=yl.COLOR_ATTACHMENT0){return e===ou?this._depth:this._colors.get(e)}hasAttachment(e){return Sx(this._colors,t=>t.name===e)}attachDepth(e){var t;return e==null||e.retain(),this.detachDepth(),e&&((t=this.fbo)==null||t.attachDepthStencil(e.attachment)),this._depth=e,this}detachDepth(){var e,t;(e=this.fbo)==null||e.detachDepthStencilTexture(),(t=this.fbo)==null||t.detachDepthStencilBuffer(),this._depth=ii(this._depth)}obtainDepthTexture(){var t;const e=this._depth;return I3(e)?((t=this.fbo)==null||t.detachDepthStencilTexture(),this._depth=null,e):null}attachColor(e,t){var s;return e.retain(),this.detachColor(t),(s=this.fbo)==null||s.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){var s;(s=this.fbo)==null||s.detachColorTexture(e);const t=this._colors.get(e);this._colors.delete(e),t==null||t.release()}detachAll(){this._colors.forEach((e,t)=>this.detachColor(t)),this.detachDepth()}};class am{constructor(e,t){this._last=new Lt,this._incarnation=0,this._cache=new fc(e,t)}destroy(){var e;(e=this._last)==null||e.forAll(t=>t.dispose()),this._last=null,this._cache.destroy()}set interactive(e){var t;e&&!this._last?this._last=new Lt:e||((t=this._last)==null||t.forAll(s=>s.dispose()),this._last=null)}clean(){var e;(e=this._last)==null||e.filterInPlace(t=>!(t.incarnation<this._incarnation)||(this._cache.put(t.key,t),!1))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find(s=>s.key===e);if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){var e;return((e=this._last)==null?void 0:e.reduce((t,s)=>t+s.usedMemory,0))??0}}let L3=class{constructor(e){this.rctx=e,this._acquired=new Set,this._cache=new am(e.newCache,"FBOCache"),this._depthCache=new am(e.newCache,"DepthAttachmentCache"),this._colorCache=new am(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback&&this.debugCallback()}frameEnd(){const e=this.debugCallback;e&&this._acquired.forEach(t=>t.type===Sl.FBO&&e(t.name,t.fbo,t.numberOfColorAttachments))}get usedMemory(){return Array.from(this._acquired.values()).reduce((e,t)=>{var s;return e+("getTexture"in t?((s=t.getTexture())==null?void 0:s.usedMemory)??0:t.usedMemory)},this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e}acquire(e,t,s,r=Ti.RGBA){const n=om(r,e,t);let a=this._cache.pop(n);if(a){a.retain(),a.setName(s);const o=this.rctx.getBoundFramebufferObject();if(this.rctx.bindFramebuffer(a.fbo),this.rctx.setDrawBuffers([yl.COLOR_ATTACHMENT0]),!a.fbo)throw new Bi("attempt to use a not existing framebuffer");this.rctx.unbindTexture(a.fbo.colorTexture),this.rctx.bindFramebuffer(o)}else a=new lx(n,s,new pc(this.rctx,{...Cv[r],width:e,height:t}),o=>{o??(o=Ui.DEPTH_STENCIL_TEXTURE);const l=this._acquireDepth(o,a.fbo.width,a.fbo.height,`${a.name} depth`);return a.attachDepth(l),l.release(),a},(o,l,h)=>{l??(l=Ti.RGBA);const d=this._acquireColor(l,e,t,h??`${a.name} color ${o}`);return this.rctx.unbindTexture(d.attachment),a.attachColor(d,o),d.release(),a},()=>{this.debugCallback&&this.debugCallback(a.name,a.fbo,a.numberOfColorAttachments),this._acquired.delete(a),a.detachAll(),this._cache.put(a)});return this._trackHandle(a)}acquireDepth(e,t,s,r){return this._acquireDepth(e,t,s,r)}_acquireDepth(e,t,s,r){const n=om(e,t,s),a=this._depthCache.pop(n);if(a)return a.retain(),a.name=r,this._trackHandle(a);const o=e===Ui.DEPTH_STENCIL_TEXTURE?new xv(n,new Qi(this.rctx,{...Tv[e],width:t,height:s}),()=>{this._acquired.delete(o),this._depthCache.put(o)}):new xv(n,new zS(this.rctx,{...Tv[e],width:t,height:s}),()=>{this._acquired.delete(o),this._depthCache.put(o)});return o.name=r,this._trackHandle(o)}_acquireColor(e,t,s,r){const n=om(e,t,s),a=this._colorCache.pop(n);if(a)return a.retain(),a.name=r,this._trackHandle(a);const o=new $3(n,new Qi(this.rctx,{...Cv[e],width:t,height:s}),()=>{this._acquired.delete(o),this._colorCache.put(o)});return o.name=r,this._trackHandle(o)}_trackHandle(e){return this._acquired.add(e),e}};const jn=new lx("default","default",null,()=>jn,()=>jn,()=>{});function om(i,e,t){return`${i}x${e}x${t}`}jn.release=()=>!1;const Hd=new hi;Hd.pixelFormat=ai.RED,Hd.internalFormat=El.R8,Hd.wrapMode=Yi.CLAMP_TO_EDGE;const Bd=new hi;Bd.pixelFormat=ai.RG,Bd.internalFormat=El.RG8,Bd.wrapMode=Yi.CLAMP_TO_EDGE;const Gd=new hi;Gd.internalFormat=El.RGBA4,Gd.dataType=Ja.UNSIGNED_SHORT_4_4_4_4,Gd.wrapMode=Yi.CLAMP_TO_EDGE;const hx=new hi;hx.wrapMode=Yi.CLAMP_TO_EDGE;const fh=new hi;fh.wrapMode=Yi.CLAMP_TO_EDGE,fh.samplingMode=Ws.LINEAR_MIPMAP_LINEAR,fh.hasMipmap=!0,fh.maxAnisotropy=8;const yh=new hi;yh.pixelFormat=ai.RED,yh.dataType=Ja.HALF_FLOAT,yh.internalFormat=El.R16F,yh.samplingMode=Ws.NEAREST;const kd=new hi;kd.dataType=Ja.HALF_FLOAT,kd.internalFormat=El.RGBA16F,kd.samplingMode=Ws.NEAREST;const Cv={[Ti.RED]:Hd,[Ti.RG]:Bd,[Ti.RGBA4]:Gd,[Ti.RGBA]:hx,[Ti.RGBA_MIPMAP]:fh,[Ti.R16F]:yh,[Ti.RGBA16F]:kd},jo=new hi;jo.pixelFormat=ai.DEPTH_STENCIL,jo.dataType=Ja.UNSIGNED_INT_24_8,jo.samplingMode=Ws.NEAREST,jo.wrapMode=Yi.CLAMP_TO_EDGE,jo.internalFormat=ai.DEPTH24_STENCIL8;const Tv={[Ui.DEPTH_STENCIL_TEXTURE]:jo,[Ui.DEPTH16_BUFFER]:new $1(R1.DEPTH_COMPONENT16,4)};var oc;(function(i){i[i.FrontToBack=0]="FrontToBack",i[i.BackToFront=1]="BackToFront"})(oc||(oc={}));let Kr=class{constructor(e,t,s=oc.FrontToBack){this._rctx=e,this._techniques=t,this._sorting=s,this._draws=new Lt({initialSize:32,allocator:r=>r??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,s,r,n){const a=this._draws.pushNew();a.geometry=t,a.geometryRanges=s,a.material=e,a.depthSquaredHint=r,a.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0,a.highlightGroupName=n}acquire(e,t){return this._draws.map(s=>s.material.acquireTechnique(this._techniques,e,t,s.geometry.parameters))}dispatch(e,t,s){const r=this._rctx;this._previouslyBoundDraw.clear();let n=null;const a=this._draws.length;for(let o=0;o<a;o++){const l=this._draws.data[o];if(e.identifier===Hn.Highlight){const{highlightGroupName:y}=l;if(y&&(t.highlightGroupIndices.get(y)??0)!==t.highlightLevel)continue}const h=s[o];h===n&&t.oitPass===Cs.NONE||(r.bindTechnique(h,t,e),n=h);const{geometryRanges:d,indexType:u,geometry:p,material:_}=l;r.bindVAO(p.vao),this._previouslyBoundDraw.get(h)!==_&&(h.program.bindDraw(t,e,_),this._previouslyBoundDraw.set(h,_));const f=d.length,{primitiveType:g}=p;for(let y=0;y<f;y+=2){const w=d[y],x=d[y+1];if(u!==0){const T=jd.get(u);r.drawElements(g,x,u,w*T)}else r.drawArrays(g,w,x)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===oc.FrontToBack?1:-1;this._draws.sort((t,s)=>{const r=e*(t.depthSquaredHint-s.depthSquaredHint);return r!==0?r:t.geometry.vao.byteSize-s.geometry.vao.byteSize})}get count(){return this._draws.length}};const jd=new Map;jd.set(Th.UNSIGNED_BYTE,1),jd.set(Th.UNSIGNED_SHORT,2),jd.set(Th.UNSIGNED_INT,4);let m_=class extends G_{constructor(){super({}),this._passes=null,this.produces=new Map([[J.OPAQUE_MATERIAL,i=>this._produces(i)],[J.TRANSPARENT_MATERIAL,i=>!!(this._passes&&this._passes.materialTransparent.count>0)&&this._produces(i)],[J.INTEGRATED_MESH,i=>this._produces(i)]]),this._materialPassParameters=new GT,this._shadowPassParameters=new kT,this._highlightPassParameters=new jT,this._viewshedPassParameters=new WT,this._systems=new Set}initializeRenderContext(i){this._context=i;const e=i.renderContext.rctx,t=i.techniques;this._passes={materialOpaque:new Kr(e,t),materialTransparent:new Kr(e,t,oc.BackToFront),materialIntegratedMesh:new Kr(e,t),shadowMap:new Kr(e,t),highlight:new Kr(e,t),highlightIntegratedMesh:new Kr(e,t),highlightShadowMap:new Kr(e,t),viewshedShadowMap:new Kr(e,t),defaultShadowMap:new Kr(e,t)}}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(i){this._systems.add(i)}_produces(i){return this._systems.size!==0&&this._passes!==null&&(i===D.Highlight?this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0:i!==D.ShadowHighlight||this._passes.highlight.count>0)}prepareRender(i){if(this._systems.size!==0&&this._passes!==null){for(const e of Object.values(this._passes))e.prepareSubmit();this._systems.forEach(e=>e.submit(this._passes,i.bind));for(const e of Object.values(this._passes))e.finishSubmit();this._context.techniques.frameUpdate()}}acquireTechniques(i){if(this._systems.size===0)return null;const e=i.output===D.Shadow||i.output===D.ShadowHighlight||i.output===D.ShadowExcludeHighlight?this._shadowPassParameters:i.output===D.ViewshedShadow?this._viewshedPassParameters:i.output===D.Highlight?this._highlightPassParameters:this._materialPassParameters,t=i.bind;return this._updateParameters(t.camera,e,t.slot===J.TRANSPARENT_MATERIAL),this._materialPassParameters.output=i.output,this._invoke(i,(s,r)=>s.acquire(r,i.bind))}render(i,e){this._invoke(i,(t,s)=>t.dispatch(s,i.bind,e))}_invoke(i,e){if(this._passes===null)return null;switch(i.bind.slot){case J.OPAQUE_MATERIAL:switch(i.output){case D.Color:case D.ColorEmission:case D.Depth:case D.Normal:case D.ObjectAndLayerIdColor:return e(this._passes.materialOpaque,this._materialPassParameters);case D.Highlight:return e(this._passes.highlight,this._highlightPassParameters);case D.Shadow:return e(this._passes.shadowMap,this._shadowPassParameters);case D.ShadowHighlight:return e(this._passes.highlightShadowMap,this._shadowPassParameters);case D.ShadowExcludeHighlight:return e(this._passes.defaultShadowMap,this._shadowPassParameters);case D.ViewshedShadow:return e(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case J.TRANSPARENT_MATERIAL:switch(i.output){case D.Color:case D.ColorEmission:case D.Depth:case D.Normal:case D.ObjectAndLayerIdColor:return e(this._passes.materialTransparent,this._materialPassParameters)}break;case J.INTEGRATED_MESH:switch(i.output){case D.Color:case D.ColorEmission:case D.Depth:case D.Normal:case D.ObjectAndLayerIdColor:return e(this._passes.materialIntegratedMesh,this._materialPassParameters);case D.Highlight:return e(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(i){const e=new Lg;return this._systems.forEach(t=>Tl(e,t.queryShadowCasterDepthRange(i))),e}get hasEmissions(){let i=!1;return this._systems.forEach(e=>i=e.hasEmissions||i),i}_updateParameters(i,e,t){const s=i.viewInverseTransposeMatrix;$e(lm,s[3],s[7],s[11]),hm.set(lm),ue(e.transformWorldFromViewTH,hm.high),ue(e.transformWorldFromViewTL,hm.low),ue(e.slicePlaneLocalOrigin,lm),p1(e.transformViewFromCameraRelativeRS,i.viewMatrix),hc(e.transformProjFromView,i.projectionMatrix),e.identifier===Hn.Material&&(this._materialPassParameters.transparent=t,Vu(Sv,e.transformViewFromCameraRelativeRS),L_(e.transformNormalViewFromGlobal,Sv))}};m_=c([I("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],m_);const lm=v(),Sv=xn(),hm=new Ww;function N3(i){return i.name}let V3=class{constructor(e){this._context=e,this._nodes=new Lt}destroy(){this._nodes.forEach(e=>e.destroy()),this._nodes.clear()}add(e){this._nodes.push(e),Of&&console.log(`Registered render nodes: ${this._nodes.map(({declaredClass:t})=>t).join(", ")}`)}remove(e){this._nodes.remove(e),Of&&console.log(`Registered render nodes: ${this._nodes.map(({declaredClass:t})=>t).join(", ")}`)}produces(e){return this._nodes.some(({produces:t})=>t===e)}require(e,...t){const s=this._nodes,r=n=>s.reduce((a,{consumes:o,produces:l})=>a+(!o.required.includes(e)||n!=null&&l!==n?0:1),0);return t.length===0?r():t.reduce((n,a)=>n+r(a),0)}optional(e,...t){const s=this._nodes,r=n=>s.reduce((a,{consumes:o,produces:l})=>{var h;return a+(!((h=o.optional)!=null&&h.includes(e))||n!=null&&l!==n?0:1)},0);return t.length===0?r():t.reduce((n,a)=>n+r(a),0)}updateAnimation(e){return this._nodes.reduce((t,s)=>s.updateAnimation(e)||t,!1)}precompile(...e){++this._context.techniques.precompiling;for(const t of e)this._nodes.forEach(s=>{s.produces===t&&s.precompile()});--this._context.techniques.precompiling}render(e,t,s=()=>{}){const r=e.name,n=this._nodes.filter(({produces:a})=>a===r);return n.length===0?N3(e)?e:jn:(n.forEach(a=>{var l;const o=[e];for(const h of a.consumes.required){if(h===r)continue;const d=t.get(h);if(d)o.push(d);else if(h!=="emissive"||!((l=t.get(r))!=null&&l.hasAttachment(h)))return void(s&&s(o))}if(a.consumes.optional)for(const h of a.consumes.optional){if(h===r)continue;const d=t.get(h);d&&o.push(d)}try{const h=a.doRender(o);h&&h!==e&&(r!==h.name&&(Pe.getLogger(a).errorOnce(`RenderNode produced ${h.name}, expected ${r}`),h.setName(r)),e.release(),e=h,t.set(r,e))}catch(h){Pe.getLogger(a).errorOnce(h)}s&&s(o)}),this._context.rctx.enforceState(),e)}requireGeometryDepth(){return this._nodes.some(e=>e.produces!=="disabled"&&e.requireGeometryDepth)}get test(){return{nodes:this._nodes}}},F3=class{constructor(e){this.context=e,this._renderPlugins=new Lt,this._slots=new Array,this._version=ka(0);for(let t=0;t<J.MAX_SLOTS;++t)this._slots[t]=[]}destroy(){this._renderPlugins.forEach(e=>e.destroy()),this._renderPlugins.clear()}get plugins(){return this._renderPlugins}add(e,t){const s=()=>{if(t!=null&&t.aborted)throw e.uninitializeRenderContext(),hr();this._renderPlugins.push(e),e.produces.forEach((n,a)=>this._slots[a].push(e)),this.context.requestRender(),this._version.value++},r=e.initializeRenderContext(this.context,t);if(w_(r))return r.then(s);s()}remove(e){this._renderPlugins.removeUnordered(e),e.uninitializeRenderContext();for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter(s=>s!==e);this.context.requestRender(),this._version.value++}prepareRender(){this._renderPlugins.forAll(e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)})}updateAnimation(e){let t=!1;return this._renderPlugins.forAll(s=>{var r;return t=((r=s.updateAnimation)==null?void 0:r.call(s,e))||t}),t}renderFeatureChanged(){this._renderPlugins.forAll(e=>{e.renderFeatureChanged&&e.renderFeatureChanged()})}precompile(...e){++this.context.techniques.precompiling;const t=this.context.renderContext.bind.slot;for(const s of e)this.context.renderContext.bind.slot=s,this._slots[s].forEach(r=>{const n=r.produces.get(s);n!=null&&n(this.context.renderContext.output)&&r.precompile(this.context.renderContext)});this.context.renderContext.bind.slot=t,--this.context.techniques.precompiling}_acquireRenderables(){const e=this.context.renderContext.bind.slot,t=this.context.renderContext.output??D.Color,s=new Map;return this._slots[e].forEach(r=>{const n=r.produces.get(e);if(!(n!=null&&n(t))||r.isDecoration&&!this.context.renderContext.bind.decorations)return;const a=r.acquireTechniques(this.context.renderContext);a&&s.set(r,a)}),s}render(e,...t){for(const s of t)this.context.renderContext.bind.slot=s,this._acquireRenderables().forEach((r,n)=>{n.render(this.context.renderContext,r,e),I1(r)})}queryDepthRange(e){const t=new Lg;return this._renderPlugins.forAll(s=>{var n;const r=(n=s.queryDepthRange)==null?void 0:n.call(s,e);Tl(t,r)}),t}get updating(){return this._version.value>=0&&this._renderPlugins.some(e=>e.running)}produces(e,...t){for(const s of t)if(this._slots[s].some(r=>{const n=r.produces.get(s);return!!n&&n(e)}))return!0;return!1}consumes(e){return this._renderPlugins.some(t=>t.consumes().required.includes(e))}get hasDecorations(){return this._renderPlugins.some(e=>e.isDecoration)}get hasOccludees(){return this._renderPlugins.some(e=>e.hasOccludees)}get hasEmissions(){return this._renderPlugins.some(e=>e.hasEmissions)}get renderOccludedFlags(){return this._renderPlugins.reduce((e,t)=>e|t.renderOccludedFlags,Di.None)}get usedMemory(){return this._renderPlugins.reduce((e,t)=>t.material?e:e+(t.usedMemory??0),0)}get test(){}},qg=class extends gi{};function cx(){const i=new qt;return i.include(Xs),i.fragment.uniforms.add(new et("colorTexture",e=>e.colorTexture),new et("alphaTexture",e=>e.alphaTexture),new et("frontFaceTexture",e=>e.frontFaceTexture)).main.add(b`float srcAlpha = texture(alphaTexture, uv).r;
if(srcAlpha == 0.0){
fragColor = vec4(0.0);
return;
}
vec4 srcColor = texture(colorTexture, uv);
vec4 frontFace = texture(frontFaceTexture, uv);
fragColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);`),i}const U3=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:qg,build:cx},Symbol.toStringTag,{value:"Module"}));class Pv extends Ht{constructor(e,t,s){super(e,t,new Bt(U3,()=>X(()=>Promise.resolve().then(()=>r5),void 0,import.meta.url)),s)}initializePipeline(){return Qt({blending:uc,colorWrite:Jt})}}let z3=class{constructor(e){this._techniques=e,this._parameters=new qg,e.precompile(Pv)}blend(e,t,s,r){this._parameters.colorTexture=t.getTexture(),this._parameters.alphaTexture=t.getTexture(yl.COLOR_ATTACHMENT1),this._parameters.frontFaceTexture=s.getTexture();const n=this._techniques.acquire(Pv);e.bindTechnique(n,r,this._parameters),e.screen.draw(),n.release()}},q3=class{constructor(e,t){this._camera=e,this._dt=nt(0),this._time=nt(0),this._lastUpdate=nt(0),this._lastUpdate=t,this._time=t}advance(e,t,s){const r=nt(t-this._lastUpdate);this._dt=nt(r/s),this._time=nt(this._time+r),this._lastUpdate=t,this._camera=e}forceTime(e){this._lastUpdate=this._time=e,this._dt=nt(0)}get camera(){return this._camera}get dt(){return this._dt}get time(){return this._time}},H3=class{constructor(){this._step=Ov,this._dilation=1,this._firstIdleTime=nt(0)}frame(e,t){if(t?this._firstIdleTime===0&&(this._firstIdleTime=nt(performance.now())):this._firstIdleTime=nt(0),Li("disable-feature:high-quality-idle"))this._dilation=1;else{const r=t?performance.now()-this._firstIdleTime:0;if(r>=Ev+G3)return this._step=nt(1/0),void(this._dilation=1);this._dilation=r>=Ev?k3:1}const s=W(e/B3,Ov,W3);this._step===1/0?this._step=nt(s):this._step=nt(this._step*Mv+s*(1-Mv))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=nt(0)}};const B3=.5,Ev=nt(12e4),G3=nt(1e4),k3=10,Mv=.9,j3=30,Ov=nt(1e3/1),W3=nt(1e3/j3),Q3=1e4,__=100,X3=500,Y3=500,Z3=.1;function K3(i,e,t){let s=0;if(!e.some(n=>!!n.material&&(s+=n.numGeometries,s>=Q3)))return oN.compute(i,e);const r=yc();return t.forAll(n=>Tl(r,J3(i,n))),r}function J3(i,e){if(!e.visible)return;const t=yc(),s=e.getSpatialQueryAccelerator();return s?eN(t,i,s):tN(t,i,e.objects),t}function eN(i,e,t){const s=e.eye,r=e.viewForward,n=e.frustum,a=l=>l.visible,o=t.objectCount;if(o<X3)Ou(Ls,e.near,Math.min(i.near,e.far)),t.forEachInDepthRange(s,r,za.DepthOrder.FRONT_TO_BACK,Ls,(l,h)=>{g_(i,e,l),Ls.far=i.near,h.setRange(Ls)},n,a),Ou(Ls,Math.max(i.far,e.near),e.far),t.forEachInDepthRange(s,r,za.DepthOrder.BACK_TO_FRONT,Ls,(l,h)=>{g_(i,e,l),Ls.near=i.far,h.setRange(Ls)},n,a);else{const l=Math.max(Math.min(o,Y3),Math.ceil(o*Z3)),h=t.findClosest(r,za.DepthOrder.FRONT_TO_BACK,n,a,l),d=t.findClosest(r,za.DepthOrder.BACK_TO_FRONT,n,a,l);h&&d&&(Rv(i,e,h.boundingVolumeWorldSpace.bounds),Rv(i,e,d.boundingVolumeWorldSpace.bounds))}}function tN(i,e,t){$o.clear(),t.forAll(s=>{s.visible&&s.geometries.length!==0&&$o.add(s)}),$o.empty||($o.sort(e),Ou(Ls,e.near,Math.min(i.near,e.far)),$o.forEachInDepthRange(Ls,za.DepthOrder.FRONT_TO_BACK,(s,r)=>{r<i.near&&g_(i,e,s)}),Ou(Ls,Math.max(i.far,e.near),e.far),$o.forEachInDepthRange(Ls,za.DepthOrder.BACK_TO_FRONT,(s,r,n)=>{i.far=Math.max(i.far,n)}))}function g_(i,e,t){if(!t.visible||!J_(e.frustum,t.boundingVolumeWorldSpace.bounds))return;const s=t.transformation,r=aN;t.geometries.forEach(n=>{_r(r,s,n.transformation);const a=Sm(r);dx(i,e,n.boundingInfo,r,a)})}function dx(i,e,t,s,r){if(t==null)return;Wt(At(Hi),t.center,s);const{eye:n,viewForward:a}=e,o=a[0]*(Hi[0]-n[0])+a[1]*(Hi[1]-n[1])+a[2]*(Hi[2]-n[2]);if(Hi[3]=t.radius*r,!(o-Hi[3]>i.near&&o+Hi[3]<i.far)&&J_(e.frustum,Hi))if(t.radius>__&&t.getChildren())for(const l of t.getChildren())dx(i,e,l,s,r);else f_.unionDepthRangeWithAABB(i,e.viewProjectionMatrix,s,t.bbMin,t.bbMax)}function Rv(i,e,t){const s=e.eye,r=e.viewForward,n=(t[0]-s[0])*r[0]+(t[1]-s[1])*r[1]+(t[2]-s[2])*r[2];i.near=Math.min(i.near,n-t[3]),i.far=Math.max(i.far,n+t[3])}class iN{constructor(){this._items=new Lt({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,s=e.viewForward;this._items.forAll(r=>{const n=r.object.boundingVolumeWorldSpace.bounds,a=(n[0]-t[0])*s[0]+(n[1]-t[1])*s[1]+(n[2]-t[2])*s[2];r.distance=a,r.near=a-n[3],r.far=a+n[3]}),this._items.sort((r,n)=>r.distance-n.distance)}forEachInDepthRange(e,t,s){if(t===za.DepthOrder.FRONT_TO_BACK)for(let r=0;r<this._items.length;++r){const n=this._items.data[r];n.far<e.near||n.near>e.far||s(n.object,n.near,n.far)}else for(let r=this._items.length-1;r>=0;--r){const n=this._items.data[r];n.far<e.near||n.near>e.far||s(n.object,n.near,n.far)}}}class sN{constructor(){this._view=Nt(),this._viewProj=Nt(),this._frustum=Rm(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,t){this._reset(),hc(this._view,e.viewMatrix),_r(this._viewProj,e.projectionMatrix,this._view),Am(this._frustum,e.frustum);const s=this._view,r=s[2],n=s[6],a=s[10],o=s[14];t.forAll(p=>{p.forEachGeometry(_=>{if(!_.visible||!_.castShadow)return;const f=_.boundingSphere,g=r*f[0]+n*f[1]+a*f[2]+o,y=g-f[3],w=g+f[3];this._geometries.push(_),this._near.push(-w),this._far.push(-y)})});const l=new Lg;if(this._geometries.length===0)return l;for(let p=0;p<this._geometries.length;++p)this._near[p]>l.far&&(l.far=this._near[p]),this._near[p]>2&&this._far[p]<l.near&&(l.near=this._far[p]);const h=this._looseRange;h.near=Math.max(.5*l.near,2),h.far=2*l.far;let d=0,u=0;for(let p=0;p<this._geometries.length;++p)this._near[p]<l.near&&(this._near[p]>=h.near?l.near=this._near[p]:this._nearCandidates[d++]=p),this._far[p]>l.far&&(this._far[p]<=h.far?l.far=this._far[p]:this._farCandidates[u++]=p);if(this._nearCandidates.length===0&&this._farCandidates.length===0)return l;this._nearCandidates.sort((p,_)=>this._near[p]<this._near[_]?-1:this._near[p]>this._near[_]?1:0),this._farCandidates.sort((p,_)=>this._far[p]<this._far[_]?1:this._far[p]>this._far[_]?-1:0);for(let p=0;p<this._nearCandidates.length;++p){const _=this._nearCandidates[p];if(this._near[_]<l.near){const f=this._geometries[_],g=f.boundingInfo;this._includeNearBoundingInfoRec(g,f.shaderTransformation,l)}}for(let p=0;p<this._farCandidates.length;++p){const _=this._farCandidates[p];if(this._far[_]>l.far){const f=this._geometries[_],g=f.boundingInfo;this._includeFarBoundingInfoRec(g,f.shaderTransformation,l)}}return this._reset(),l}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,t,s){if(e==null)return;const r=e.center;Wt(At(Hi),r,t);const n=Sm(t),a=Hi[0],o=Hi[1],l=Hi[2],h=e.radius*n,d=this._frustum;if(d[0][0]*a+d[0][1]*o+d[0][2]*l+d[0][3]>h||d[1][0]*a+d[1][1]*o+d[1][2]*l+d[1][3]>h||d[2][0]*a+d[2][1]*o+d[2][2]*l+d[2][3]>h||d[3][0]*a+d[3][1]*o+d[3][2]*l+d[3][3]>h)return;const u=this._view[2]*a+this._view[6]*o+this._view[10]*l+this._view[14],p=u+h;if(!(-(u-h)<2||-p>=s.near))if(-p>this._looseRange.near)s.near=-p;else{if(h>__){const _=e.getChildren();if(_!==void 0){for(const f of _)this._includeNearBoundingInfoRec(f,t,s);return}}f_.unionDepthRangeWithAABB(s,this._viewProj,t,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,t,s){if(e==null)return;let r=e.radius;const n=e.center;Wt(At(Hi),n,t);const a=Sm(t),o=Hi[0],l=Hi[1],h=Hi[2];r*=a;const d=this._frustum;if(d[0][0]*o+d[0][1]*l+d[0][2]*h+d[0][3]>r||d[1][0]*o+d[1][1]*l+d[1][2]*h+d[1][3]>r||d[2][0]*o+d[2][1]*l+d[2][2]*h+d[2][3]>r||d[3][0]*o+d[3][1]*l+d[3][2]*h+d[3][3]>r)return;const u=this._view[2]*o+this._view[6]*l+this._view[10]*h+this._view[14]-r;if(!(-u<=s.far))if(-u<this._looseRange.far)s.far=-u;else{if(r>__){const p=e.getChildren();if(p!==void 0){for(const _ of p)this._includeFarBoundingInfoRec(_,t,s);return}}f_.unionDepthRangeWithAABB(s,this._viewProj,t,e.bbMin,e.bbMax)}}}class rN{constructor(){this._modelViewProj=Nt(),this._clipPosition=[Ci(),Ci(),Ci(),Ci(),Ci(),Ci(),Ci(),Ci()]}unionDepthRangeWithAABB(e,t,s,r,n){const a=this._modelViewProj;_r(a,t,s);let o=!1;for(let l=0;l<8;++l){const h=this._clipPosition[l],d=l===0||l===3||l===4||l===7?r[0]:n[0],u=l===0||l===1||l===4||l===5?r[1]:n[1],p=l<4?r[2]:n[2];h[0]=a[0]*d+a[4]*u+a[8]*p+a[12],h[1]=a[1]*d+a[5]*u+a[9]*p+a[13],h[2]=a[2]*d+a[6]*u+a[10]*p+a[14],h[3]=a[3]*d+a[7]*u+a[11]*p+a[15]}for(let l=0;l<12;++l){const h=nN(this._clipPosition[dm[l][0]],this._clipPosition[dm[l][1]],this._clipPosition[dm[l][2]]);let d=!0;for(let u=0;u<h.length;++u)if(h[u][3]>=2){d=!1;break}if(!d){o=!0;for(let u=0;u<h.length;++u){const p=h[u][3];Number.isFinite(p)&&(e.near=Math.min(p,e.near),e.far=Math.max(p,e.far))}}}return o}}function nN(i,e,t){let s=[i,e,t];for(let r=0;r<4;++r){const n=s;s=[];for(let a=0;a<n.length;++a){const o=n[a],l=n[(a+1)%n.length];cm(l,r)?(cm(o,r)||s.push(Av(o,l,r)),s.push(l)):cm(o,r)&&s.push(Av(o,l,r))}}return s}function cm(i,e){return e===0?i[0]>=-i[3]:e===1?i[1]>=-i[3]:e===2?i[0]<=i[3]:e===3?i[1]<=i[3]:void Gs(!1)}function Av(i,e,t){let s=0;return t===0?s=(-i[3]-i[0])/(e[0]-i[0]+e[3]-i[3]):t===1?s=(-i[3]-i[1])/(e[1]-i[1]+e[3]-i[3]):t===2?s=(i[3]-i[0])/(e[0]-i[0]-e[3]+i[3]):t===3&&(s=(i[3]-i[1])/(e[1]-i[1]-e[3]+i[3])),_P(Ci(),i,e,s)}const dm=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],Hi=wr(),aN=Nt(),Ls=yc(),$o=new iN,oN=new sN,f_=new rN;let lN=class{constructor(e){this._fbos=e,this._requiresEmission=!1,this._size=new QT(0,0),this._clearColor=Ci()}dispose(){this._color=ii(this._color),this.releaseDepth()}initialize(e,t,s,r){this._size.width=e,this._size.height=t,B_(this._size,this._fbos.rctx.parameters.maxTextureSize);const n=this._color;return this._color=null,this.releaseDepth(),this._requiresEmission=r,Q_(this._clearColor,s),n}releaseDepth(){var e;(e=this._color)==null||e.detachDepth(),this._depth=ii(this._depth)}update(e){const t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}bind(){const e=this._color==null;if(this.color.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(this.color.fbo),e){const t=this._fbos.rctx;t.setClearStencil(0),t.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),t.clear(Kt.COLOR|Kt.DEPTH|Kt.STENCIL),this._requiresEmission&&t.gl.clearBufferfv(t.gl.COLOR,1,uE)}}_acquireColor(){return this._requiresEmission?this._fbos.acquire(this._size.width,this._size.height,"acquired-color").acquireColor(yl.COLOR_ATTACHMENT1,Ti.RGBA,"emissive"):this._fbos.acquire(this._size.width,this._size.height,"acquired-color")}_acquireDepth(){return this._fbos.acquireDepth(Ui.DEPTH_STENCIL_TEXTURE,this._size.width,this._size.height,"depth")}get size(){return this._size}get color(){return this._ensureColor()}get depth(){return this._depth??(this._depth=this._acquireDepth()),this._depth}_ensureColor(){return this._color??(this._color=this._acquireColor()),this._color}},hN=class{constructor(){this._inputs=new Map}set(e,t){this._inputs.set(e,t)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){var t;(t=this._inputs.get(e))!=null&&t.release()&&this._inputs.delete(e)}};const vc=255,cN=1/vc;function ux(){const i=new qt,e=i.fragment;return e.include(ig),e.include(N_),i.include(V_),i.include(Xs),i.include(Z_,dN),e.uniforms.add(new et("shadowMap",(t,s)=>s.shadowMap.depthTexture),new et("depthMap",(t,s)=>{var r;return(r=s.depth)==null?void 0:r.attachment}),new Tn("inverseViewMatrix",(t,s)=>au(Dv,qh(Dv,s.camera.viewMatrix,s.camera.center)))),e.constants.add("sampleValue","float",cN),i.outputs.add("sampleCount","float"),e.main.add(b`sampleCount = 0.0;
float depth = depthFromTexture(depthMap, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float currentPixelDepth = linearizeDepth(depth);
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
return;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
return;
}
ivec2 texSize = textureSize(shadowMap, 0);
ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));
float depthShadow = readShadowMapDepth(uvShadow, shadowMap);
bool shadow = depthShadow < lvpos.z;
if (shadow) {
sampleCount = sampleValue;
}`),i}const Dv=Nt(),dN=new Fg,uN=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:vc,build:ux},Symbol.toStringTag,{value:"Module"}));class Hg extends gi{constructor(e){super(),this._data=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=j1(pN),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}}const pN=xr(.01,0,.25,1);function px(i){const e=new qt,t=e.fragment;e.include(V_),e.include(Xs);const{visualization:s,bandsEnabled:r}=i;t.constants.add("inverseSampleValue","float",vc),t.uniforms.add(new et("shadowCastMap",o=>o.shadowCastMap),new Be("sampleScale",o=>o.sampleScale),new Be("opacityFromElevation",o=>o.opacityFromElevation),new cc("uColor",o=>o.color));const n=s===$f.Gradient,a=s===$f.Threshold;return n&&r?t.uniforms.add(new Be("bandSize",o=>o.bandSize)):a&&t.uniforms.add(new Be("threshold",o=>o.threshold)),t.main.add(b`
    float record = texture(shadowCastMap, uv).r;
    float pixelSamples = record * inverseSampleValue;

    fragColor = vec4(0.0);
    if (pixelSamples < 1.0) {
      return;
    }

    float strength = pixelSamples * sampleScale;
    ${a?b`if (strength <= threshold) return;`:""}
    ${n&&r?b`strength = ceil(strength / bandSize) * bandSize;`:""}
    fragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${n?"* strength":""});
  `),e}const mN=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:Hg,build:px},Symbol.toStringTag,{value:"Module"}));let $v=class extends Ht{constructor(e,t,s){super(e,t,new Bt(mN,()=>X(()=>Promise.resolve().then(()=>n5),void 0,import.meta.url)),s),this.primitiveType=_i.TRIANGLE_STRIP}initializePipeline(){return Qt({blending:uc,colorWrite:Jt,depthTest:null,depthWrite:null})}};const _N=4e4,gN=5e4,mx=1/512;let Wd=class extends De{constructor(e,t,s,r){super({}),this._techniques=e,this._rctx=t,this._data=s,this._requestRender=r,this._passParameters=new Hg(this._data),this._configuration=new JS,this._enabled=!1,this._vao=ma(t)}dispose(){this._stop(),this._vao=We(this._vao)}precompile(){this._showVisualization&&this._techniques.precompile($v,this._configuration)}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const t=this._techniques.acquire($v,this._configuration);this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,e,this._passParameters),this._rctx.drawArrays(t.primitiveType,0,vl(this._vao,"geometry")),t.release()}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.color!==void 0&&this._setColor(e.color),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize),e.bandsEnabled!==void 0&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>mx}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfEnabled())}get _visualization(){return this._configuration.visualization}set _visualization(e){e!==this._visualization&&(this._configuration.visualization=e,this._requestRenderIfEnabled())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfEnabled())}get _bandsEnabled(){return this._configuration.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._configuration.bandsEnabled=e,this._requestRenderIfEnabled())}_setColor(e){const t=this._passParameters.color;gP(e,t)||(Q_(this._passParameters.color,e),this._requestRenderIfEnabled())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};c([m()],Wd.prototype,"opacityFromElevation",null),Wd=c([I("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],Wd);class Iv extends Ht{constructor(e,t,s){super(e,t,new Bt(uN,()=>X(()=>Promise.resolve().then(()=>a5),void 0,import.meta.url)),s),this.primitiveType=_i.TRIANGLE_STRIP}initializePipeline(){return Qt({blending:US,colorWrite:Jt,depthTest:null,depthWrite:null})}}let es=class extends De{constructor(i,e,t,s,r,n){super({}),this.fbos=i,this._techniques=e,this._stage=t,this._prepareForShadowMapPass=s,this._renderToShadowMap=r,this._requestRender=n,this._progress=0,this._sampleCount=0,this._passParameters=new Y_,this._cachedLightDirections=[],this._depthRange=d_,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey="shadowAccumulator",this._rctx=i.rctx,this._bindParameters=new d1(new u1(i,t.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=ma(this._rctx),this._accumulationRenderer=new Wd(e,this._rctx,this,n);const a=this._stage.view.resourceController.scheduler;this.addHandles([a.registerTask(ni.SHADOW_ACCUMULATOR,this),E(()=>t.renderView,o=>{this.removeHandles(Lv),o!=null&&this.addHandles(o.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),Lv)},Ge),E(()=>this._previewing,()=>this._requestRenderIfEnabled(),je)],this._shadowAccumulatorKey),e.precompile(Iv)}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=We(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=We(this._fbo),this._vao=We(this._vao),this._cachedLightDirections.length=0,this._sampleCount=0}get computedSamples(){return this._progress}get shadowCastTexture(){var i;return(i=this._fbo)==null?void 0:i.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._fbo!=null&&this._sampleCount>0}get canAccumulate(){return this._bindParameters.depth!=null&&this._depthRange!==d_&&this._opacityFromElevation>mx}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(i){const e=this._cachedLightDirections;if(Gv(e,i,Uh))return;const t=Math.min(vc,i.length);e.length=t,this._sampleCount=t;for(let s=0;s<t;++s)e[s]=ue(e[s]??v(),i[s]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(i){this._accumulationRenderer.opacityFromElevation=i}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(i){for(this._prepareForShadowMapPass(this._bindParameters);!i.done&&!this._isDoneAccumulating;)this._accumulateShadow(),i.madeProgress();this._requestRender()}renderAccumulation(i,e,t,s){if(this._depthRange=e,this._updateCamera(t),this._bindParameters.contentCamera=s,this._bindParameters.depth=i,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return!1;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();const r=this._cameraForcedForScreenshot?this._sampleCount:Math.min(fN,this._sampleCount-this._progress);for(let n=0;n<r;++n)this._accumulateShadow();return this._cameraForcedForScreenshot=!1,this._requestRender(),r>0}precompile(){this._accumulationRenderer.precompile()}render(i){this._accumulationRenderer.render(i)}setOptions(i){if(i.enabled!==void 0){const e=this._fbo!=null;i.enabled!==e&&(i.enabled?this._enable():this._disable())}i.previewing!==void 0&&(this._previewing=i.previewing),i.lightDirections!==void 0&&(this._lightDirections=i.lightDirections),this._accumulationRenderer.setOptions(i)}readAccumulatedShadow(i,e){return!this._isActive||!this._fbo||this._progress<1||i<0||i>=this._fbo.width||e<0||e>=this._fbo.height?0:(this._fbo.readPixels(i,e,1,1,ai.RGBA,Ja.UNSIGNED_BYTE,Nv),Nv[0]/this._progress)}_enable(){this._progress=0;const i=new hi;i.pixelFormat=ai.RED,i.internalFormat=El.R8,i.wrapMode=Yi.CLAMP_TO_EDGE,this._fbo=new pc(this._rctx,i),this._requestRender()}_disable(){this._fbo=We(this._fbo),this._requestRender()}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(Kt.COLOR),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._lightDirections[this._progress++],this._depthRange);const i=this._techniques.acquire(Iv);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(i,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,vl(this._vao,"geometry")),i.release()}_updateCamera(i){const e=this._fbo;if(e==null)return;const t=this._bindParameters.camera;i.equals(t)||t.copyFrom(i),e.resize(i.fullWidth,i.fullHeight),this._opacityFromElevation=1-Fh(_N,gN,i.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}};c([m()],es.prototype,"_progress",void 0),c([m()],es.prototype,"_sampleCount",void 0),c([m()],es.prototype,"_fbo",void 0),c([m()],es.prototype,"_depthRange",void 0),c([m()],es.prototype,"_previewing",void 0),c([m()],es.prototype,"_accumulationRenderer",void 0),c([m()],es.prototype,"_isRefining",null),c([m()],es.prototype,"_isActive",null),c([m()],es.prototype,"canAccumulate",null),c([m()],es.prototype,"_isDoneAccumulating",null),c([m()],es.prototype,"_opacityFromElevation",null),c([m()],es.prototype,"running",null),es=c([I("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],es);const fN=6,Lv="renderView",Nv=new Uint8Array(4),yN=S_();class vN{constructor(){this._plane=S_()}get plane(){return this._plane}set plane(e){P_(e||yN,this._plane)}}function bN(i,e){const t=i.capabilities.disjointTimerQuery;return t==null?null:new wN(t,e)}class wN{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach(s=>{const r=this._timer.createQuery(),n=this._timer.createQuery();this._queryPool.push(r,n),this._queryResults.set(s,null)})}start(){pE||(this._currentQuery=this._queryPool.pop(),this._currentQuery!=null&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||this._currentQuery==null||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(t==null)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const s=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,s}abort(){this._currentQuery!=null&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){this._currentQuery!=null&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{e!=null&&this._timer.deleteQuery(e)})}}var $t;(function(i){i.OVERLAY="overlay",i.PREPARE="prepare",i.SHADOW_MAP="shadow map",i.DEPTH="depth",i.ACCUMULATED_SHADOWS="accumulated shadows",i.APPLY_ACCUMULATED_SHADOWS="apply accumulated shadows",i.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",i.NORMALS="normals",i.SSAO="SSAO",i.HIGHLIGHTS="highlights",i.OPAQUE_EDGES="opaque edges",i.VOXEL="voxel",i.TRANSPARENT="transparent",i.TRANSPARENT_EDGES="transparent edges",i.HUD_VISIBILITY="HUD visibility",i.TRANSPARENT_TERRAIN="transparent terrain",i.TRANSPARENT_MATERIAL_WITHOUT_DEPTH="transparent material without depth",i.OPAQUE_ENVIRONMENT="opaque environment",i.TRANSPARENT_ENVIRONMENT="transparent environment",i.OCCLUDED="occluded",i.HUD="HUD",i.HUD_OCCLUDED="HUD occluded",i.FINISH="finish"})($t||($t={}));const um=Object.values(zi).concat(Object.values(Ie)).concat(Object.values($t)),Vv="Total";class xN{constructor(e){this._rctx=e,this._startTimeStampCPU=nt(0),this._lastTimeStampCPU=nt(0),this._totalCPUTime=new Tc(Vv),this._cpuTimeSamplers=new Map(um.map(t=>[t,new Tc(t)])),this._enableGPUTimer=0,this._totalGPUTime=new Tc("GPU"),this._gpuTimeSamplers=new Map(um.map(t=>[t,new Tc(t)])),this._totalTime=nt(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return this._gpuTimerPool!=null}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return nt(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(this._gpuTimerPool==null){const t=[...um,Vv];this._gpuTimerPool=bN(this._rctx,t)}if(this._gpuTimerPool==null)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,this._enableGPUTimer===0&&(this._gpuTimerPool=We(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=nt(performance.now()),this._gpuTimerPool&&(this._gpuTimeSamplers.forEach(e=>e.push(0)),this._gpuTimerPool.start())}advance(e){const t=nt(performance.now());if(this._cpuTimeSamplers.get(e).push(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const s=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).set(s),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const t=this._gpuTimerPool.stop($t.FINISH);this._gpuTimeSamplers.get($t.FINISH).set(t),this._rctx.gl.flush()}const e=nt(performance.now()-this._startTimeStampCPU);this._totalTime=nt(this._totalTime+e),this._totalCPUTime.push(e),this._gpuTimerPool&&this._totalGPUTime.push(this.gpuTimeSamplers.reduce((t,s)=>t+(s.last||0),0)),++this._totalFrameCount}}class Qd{constructor(e,t,s,r,n,a){this._stage=e,this._techniques=s,this._rctx=r,this._compositingHelper=n,this._requestRender=a,this._pluginsHas={hudElements:!1,water:!1},this._renderers=new Map,this.renderPassManager=new m_,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=xr(0,0,0,1),this._sliceHelper=new vN,this._blit=null,this._oitblend=null,this._state=ka(_t.IDLE),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new H3,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=ka(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new hN,this._releaseNormals=o=>{o.some(({name:l})=>l==="normals")&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this.fboCache=new L3(r),this._renderStateFeatures=ka(E0(!Li("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._framebuffer=new lN(this.fboCache),this.performanceInfo=new xN(this._rctx),this._shadowMap=new u1(this.fboCache,e.viewingMode),this._shadowAccumulator=new es(this.fboCache,s,e,o=>{const l=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(o.camera,o.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=l},(o,l,h)=>{const d=this._stage.view.qualitySettings.maximumPixelRatio;o.shadowMap.start(o.camera,l,h,!0,d),this._renderShadowCascades(D.Shadow,o.shadowMap),o.shadowMap.finish(),o.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(o.camera,o.contentCamera)},a),this._renderContext=new XT(this._rctx,this._shadowMap,s),this._nodes=new V3(this._renderContext),this._plugins=new F3({renderContext:this._renderContext,techniques:s,materials:t,requestRender:a,controller:e,fbos:this.fboCache,isFeatureEnabled:o=>this.isFeatureEnabled(o)}),this._plugins.add(this.renderPassManager),this._handles=[E(()=>this._stage.view.state.camera,()=>a(),Ge),E(()=>fs.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,o=>{this._renderHiddenTransparentEdges=o?()=>this._renderEdges(vo.TRANSPARENT):()=>{},a()},dt),E(()=>{var o;return(o=this._stage.view.environment.background)==null?void 0:o.color},o=>{const l=o?tg(o):ar;oa(this._backgroundColor,l[0]*l[3],l[1]*l[3],l[2]*l[3],l[3]),a()},Ge),E(()=>this._stage.view.state.camera.relativeElevation,o=>this._inGlobeView=(o??1/0)>=LS,Ge),E(()=>this._bindParameters.clouds.fadeFactor,()=>this._bindParameters.fadeLighting(),je),E(()=>{var o;return(o=this._bindParameters.clouds.data)==null?void 0:o.state},()=>this._requestRender(Me.UPDATE),je)]}destroy(){this._handles.forEach(e=>e.remove()),this._gpuTimerHandle=Hr(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=ha(this._loadEdgeViewTask),this._edgeView=de(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),this._renderers.clear(),this._blit=null,this._oitblend=null,NS.prune()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}updateRenderFeatures(e=null,t=!Li("disable-feature:high-quality-idle")){this._renderStateFeatures.value=E0(t,e),this._plugins.renderFeatureChanged(),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,s){this._renderStateFeatures.mutate(r=>r.set(t,e,s)),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(It.HighQualityTransparency)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(It.WaterReflection))}get hasHighlights(){return this._plugins.produces(D.Highlight,J.OPAQUE_MATERIAL,J.TRANSPARENT_MATERIAL,J.DRAPED_MATERIAL,J.HUD_MATERIAL,J.LABEL_MATERIAL)}get hasHighlightsOnHUD(){return this._plugins.produces(D.Highlight,J.HUD_MATERIAL,J.LABEL_MATERIAL)}get hasSSAO(){return(this._stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(It.SSAO))&&!this._inGlobeView}get hasSMAA(){return this._stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(It.Antialiasing)}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(It.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=ii(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=ii(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=ii(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=ii(this._bindParameters.depth),this._bindParameters.hudVisibility=ii(this._bindParameters.hudVisibility)}get updating(){return this._edgeView!=null&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=lc(async e=>{const{EdgeView:t}=await X(()=>import("./EdgeView-00iz-8BD.js"),__vite__mapDeps([568,1,6,2,16,66,33,36,37,32,8,141,20,21,22,23,24,7,65,61,35,39,15,11,14,9,10,12,4,5,13,34,38,31,40,245,214,246,55,99,102,72,73,74,62,17,18,67,94,93,89,88,76,90,91,87,69,70,92,95,96,97,78,98,100,101,128,109,110,113,71,105,126,125,50,51,52,106,111,63,64,68,75,77,79,48,80,81,60,43,44,45,46,47,42,82,83,41,49,53,54,28,56,57,58,59,84,85,86,3,103,104,107,108,212,213,215,216,567,566,369,247,174,167,168,175,170,130,176,177,178,179,180,133,181,182,183,184,185,186,187,188,189,153,154,171,26,190,150,151,119,120,152,191,192,193,194,195,25,27,196,197,198,199,200,201,202,203,204,205,206,569,268,169,570,219,165,166,30,112,114,115,116,117,118,121,122,123,124,127,129,131,172,173,155,207,208,209,210,132,134,135,211,217,218,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,136]),import.meta.url);Gi(e);const s=this._edgeView=new t({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:SN(this._stage.view.resourceController)});return this._handles.push(E(()=>s.updating,()=>this._requestRender(),je)),this._requestRender(),this._edgeViewCallbacks.forEach(r=>r(s)),this._edgeViewCallbacks.length=0,s})),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),this._edgeView==null?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&oS(this._bindParameters.ssr.reprojectionMatrix,xh)}set _reprojectionMatrix(e){Px(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){var e;return!!((e=this._shadowMap)!=null&&e.enabled)}setParameters(e){var r;const{_shadowMap:t,_bindParameters:s}=this;if(((r=e.qualitySettings)==null?void 0:r.reflections)!==void 0&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),e.shadowMap!==void 0&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),e.shadowMapMaxCascades!==void 0&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),e.environment!=null){e.environment.weather!=null&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const n=e.environment.lighting.type!=="virtual";s.enableFillLights!==n&&(s.enableFillLights=n,this._requestRender())}e.highQualityTransparency!==void 0&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),e.shadowCast!==void 0&&this._shadowAccumulator.setOptions(e.shadowCast)}set slicePlane(e){this._sliceHelper.plane!==e&&(this._sliceHelper.plane=e,this._requestRender())}get plugins(){return this._plugins}getMaterialRenderer(e){return this._renderers.get(e)}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,t){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:s,removes:r,updates:n}=e;s.length===0&&r.length===0&&n.length===0||(QS(e).forEach((a,o)=>{if(t.done)return;let l=this._renderers.get(o);l==null&&a.adds.length>0&&(l=new XS({material:o}),l.initializeRenderContext(this._plugins.context),this._plugins.add(l),this._renderers.set(o,l)),l&&(l.modify(a),l.numGeometries===0&&(this._renderers.delete(l.material),this._plugins.remove(l),l.destroy())),a.removes.forEach(h=>e.removes.removeUnordered(h)),a.adds.forEach(h=>e.adds.removeUnordered(h)),a.updates.forEach(h=>e.updates.removeUnordered(h)),t.madeProgress()}),this.updateHasFlags())}updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(D.Color,J.LINE_CALLOUTS_HUD_DEPTH,J.HUD_MATERIAL,J.LABEL_MATERIAL),e.water=this._plugins.produces(D.Normal,J.DRAPED_WATER),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(e,t){var r;this._animationTimer??(this._animationTimer=new q3(e.camera,t)),this._animationTimer.advance(e.camera,t,this._animationTimeDilation),e.forcedAnimationTime!=null&&this._animationTimer.forceTime(e.forcedAnimationTime);const s=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations=((r=this.overlay)==null?void 0:r.updateAnimation(this._animationTimer))||this._hasAnimations,this._hasAnimations!==s&&(this._gpuTimerHandle=s?Hr(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,s=$r.Default,r=!1){try{return this._isRendering=!0,this._render(e,t,s,r)}catch(n){console.error(`Exception during rendering: ${n}`)}finally{this._isRendering=!1}return new py(this._pluginInput.get("final-color"),null)}_render(e,t,s=$r.Default,r){var U,L,G,A,R,ee,z,V;this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=s===$r.Default,this._disposeBindBuffers();const n=this._framebuffer,{camera:a,contentCamera:o,mode:l,alignPixelEnabled:h}=e;this._state.value=l,this._bindParameters.overlay=(U=this.overlay)==null?void 0:U.render(t),this._bindParameters.overlay&&this.performanceInfo.advance($t.OVERLAY),this._renderContext.time=t,this._bindParameters.oitPass=Cs.NONE,this._bindParameters.alignPixelEnabled=h,this._bindParameters.decorations=!r,this._bindParameters.mainDepth=null,this._bindParameters.viewshedEnabled=this._nodes.produces(Ie.VIEWSHED);const d=this._nodes.produces("magnifier-color"),u=this._nodes.produces("final-color");this._bindParameters.slicePlane=this._sliceHelper.plane,a.setGLViewport(this._rctx);const p=this._nodes.require("emissive")>0&&this._plugins.hasEmissions,_=p?D.ColorEmission:D.Color,f=n.initialize(a.fullWidth,a.fullHeight,this._backgroundColor,p);this.hasReflections?(f==null||f.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=f):f==null||f.release(),this._ensureBindParametersCamera(a,o),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!r;const g=this._highQualityTransparency&&this._needsTransparentTerrain,y=this._plugins.produces(D.Color,...ih);this._precompilePrepasses(),this.performanceInfo.advance($t.PREPARE);const w=this._computeDepthRange(a);this._renderShadowMap(a,this._bindParameters.lighting.mainLight.direction,w),this._ensureBindParametersCamera(a,o),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(w,a,o),this._ensureBindParametersSSR(t),this._precompileShaders(g,y,_),this._renderContext.output=_,n.bind(),this._bindParameters.mainDepth=n.depth.attachment;const x=this.plugins.produces(D.Color,...pm);x&&this._renderOpaqueGeometry(),n.update(Y=>this._renderNodes(zi.OPAQUE,Y,x)),(G=(L=this.fboCache).debugCallback)==null||G.call(L,"opaque-color",n.color.fbo),n.update(Y=>this._renderNodes(Ie.OPAQUE_ENVIRONMENT,Y)),(R=(A=this.fboCache).debugCallback)==null||R.call(A,Ie.OPAQUE_ENVIRONMENT,n.color.fbo),this._renderTerrainDepth(g),this._setMultipassTerrain(g),this._renderEdges(vo.OPAQUE),n.bind(),this._renderPlugins(J.VOXEL,$t.VOXEL),this._renderHiddenTransparentEdges(),y&&(this._oitEnabled?this._renderOIT(nl.Geometry,_):this._renderTransparentGeometry()),n.update(Y=>this._renderNodes(zi.TRANSPARENT,Y,y)),(z=(ee=this.fboCache).debugCallback)==null||z.call(ee,"transparent-color",n.color.fbo),this._renderGeometryDepth(g),this._renderHUDVisibility(),g||this._plugins.render(this._pluginInput,J.LINE_CALLOUTS);const T=s===$r.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;this._renderEdges(vo.TRANSPARENT);const C=this._needsTransparentTerrain?this._renderTransparentTerrain():null;C&&(this.performanceInfo.advance($t.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(g?this._renderLineCallouts(Js.Occluded):(this._rctx.bindFramebuffer((V=this._bindParameters.hudVisibility)==null?void 0:V.fbo),this._compositingHelper.compositeHUD(this._bindParameters,C.getTexture())),this._renderHUD(Js.Occluded,n.color,_))),this._cullAboveTerrain(!1),C&&(n.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,C.getTexture()),C.release(),g&&(this._renderEdges(vo.OPAQUE),y&&(this._oitEnabled?this._renderOIT(nl.Geometry,_):this._renderTransparentGeometry(),this.performanceInfo.advance($t.TRANSPARENT)),this._renderEdges(vo.TRANSPARENT))),this._bindParameters.ssao=ii(this._bindParameters.ssao),g&&this._renderLineCallouts(Js.NotOccluded),this._setTerrainDepthTest(!1),this._renderTransparentEnvironment(),n.update(Y=>this._renderNodes(Ie.TRANSPARENT_ENVIRONMENT,Y)),n.update(Y=>this._renderNodes(Ie.VIEWSHED,Y)),n.update(Y=>this._renderNodes(Ie.LASERLINES,Y)),n.update(Y=>this._renderNodes(Ie.OCCLUDED,Y)),this._pluginInput.set("highlights",this._renderHighlightPrepass()),n.update(Y=>this._renderNodes(zi.COMPOSITE,Y));const S=!(s!==$r.Default||u||d&&!r&&s===$r.Default),P=this._pluginInput.get(zi.COMPOSITE),M=S?jn:this.fboCache.acquire(P.fbo.width,P.fbo.height,Ie.ANTIALIASING),$=this._nodes.produces(Ie.ANTIALIASING)?this._renderNodes(Ie.ANTIALIASING,M):this._blitFBO(P,M,!1);let O;this._pluginInput.set(Ie.ANTIALIASING,$),this.hasHighlightsOnHUD?(this._renderHUD(Js.NotOccluded,$,_),O=this._renderNodes(Ie.HIGHLIGHTS,$)):(O=this._renderNodes(Ie.HIGHLIGHTS,$),this._renderHUD(Js.NotOccluded,O,_));const N=this._renderNodes(Ie.MAGNIFIER,O);return d&&!r&&s===$r.Default&&!u&&this._blitFBO(N),u?(N.attachDepth(n.depth),this._blitFBO(this._renderNodes(zi.FINAL,N)),N.detachDepth()):this._pluginInput.set(zi.FINAL,N),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),n.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),s!==$r.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),new py(this._pluginInput.get("final-color"),T)}_precompileShaders(e,t,s){++this._plugins.context.techniques.precompiling,this._renderContext.output=s,this._precompileOpaqueGeometry(),this._setMultipassTerrain(e),this._renderContext.output=D.Depth,this._plugins.precompile(J.TRANSPARENT_TERRAIN),e&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=s,this._plugins.precompile(J.TRANSPARENT_TERRAIN),t&&(this._precompileTransparentGeometry(),this._needsTransparentTerrain&&(this._cullAboveTerrain(!1),this._precompileTransparentGeometry(),this._cullAboveTerrain(e))),this._needsHUDVisibility&&this._plugins.precompile(J.OCCLUSION_PIXELS),e&&!this._needsHUDVisibility||this._plugins.precompile(J.LINE_CALLOUTS),this._setMultipassTerrain(!1),this._nodes.precompile(Ie.VIEWSHED,Ie.LASERLINES,Ie.OCCLUDED,zi.COMPOSITE,Ie.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(J.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),--this._plugins.context.techniques.precompiling}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;++this._techniques.precompiling;const e=this._framebufferSize;let t=this.fboCache.acquire(e.width,e.height,"olid");return t.acquireDepth(Ui.DEPTH_STENCIL_TEXTURE),t=this._nodes.render(t,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance($t.OBJECT_AND_LAYER_ID_COLOR),t}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,s=e===Me.BACKGROUND;if(s||t){const r=s?this.performanceInfo.elapsedTime:0;let n=0;t?n=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();const a=Math.max(r,n);this._animationTimestep.frame(a,s)}}readMainDepth(e,t){var a;const{mainDepth:s,camera:r}=this._bindParameters;if(!s)return;const n=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(n.fbo),r.setGLViewport(this._rctx),this._rctx.setScissorRect(e[0],e[1],e[2],e[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(ar),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,s),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),(a=n.fbo)==null||a.readPixels(e[0],e[1],e[2],e[3],ai.RGBA,Ja.UNSIGNED_BYTE,t),n.release()}readHUDVisibility(e,t,s,r,n){var a,o;(o=(a=this._bindParameters.hudVisibility)==null?void 0:a.fbo)==null||o.readPixels(e,t,s,r,ai.RGBA,Ja.UNSIGNED_BYTE,n)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_setMultipassTerrain(e){this._setTerrainDepthTest(e),this._cullAboveTerrain(e)}_setTerrainDepthTest(e){this._bindParameters.terrainDepthTest=e}_cullAboveTerrain(e){this._bindParameters.cullAboveTerrain=e}_renderEdges(e){const t=this._edgeView;if(!(t!=null&&t.shouldRender()))return;const s=this._framebufferSize,r=this.fboCache.acquire(s.width,s.height,"edges"),n=()=>t.render(this._bindParameters,e),a=this._bindParameters.geometryDepth;this.renderToTargets(n,r,a??this._framebuffer.depth,ar),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,r.getTexture()),r.release(),this.performanceInfo.advance(e===vo.OPAQUE?$t.OPAQUE_EDGES:$t.TRANSPARENT_EDGES)}_renderShadowMap(e,t,s){if(!this.shadowsEnabled)return;const r=this._shadowMap;r.start(e,t,s,this.isFeatureEnabled(It.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(D.ShadowHighlight,this._shadowMap),r.moveSnapshot(su.Highlight),this._renderShadowCascades(D.ShadowExcludeHighlight,this._shadowMap),r.copySnapshot(su.ExcludeHighlight),this._renderShadowCascades(D.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(D.Shadow),r.finish(),e.setGLViewport(this._rctx),this.performanceInfo.advance($t.SHADOW_MAP)}_precompileShadowCascades(e){for(const t of this._shadowMap.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._precompileAllGeometry(e)}_renderShadowCascades(e,t=this._shadowMap){for(const s of t.cascades)s.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(s.camera,s.camera),this.renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(D.Depth)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._needsShadowAccumulation||this._debugNeedsDepth}_renderRemainingGeometryDepth(){const e=this._pluginInput.get("normals"),t=this._needsDepth;if(e){const s=t?e.getAttachment(ou):null;s==null||s.retain(),this._pluginInput.set(Ie.SSAO,this._renderSSAO()),this._renderGeometryWithoutNormalsDepth(t,s)}else this._renderAllGeometryDepth(t)}_renderGeometryWithoutNormalsDepth(e,t){if(!e||!t)return void(this._bindParameters.depth=ii(this._bindParameters.depth));const s=this._framebufferSize,r=this.fboCache.acquire(s.width,s.height,"depth");r.attachDepth(t),t.release(),this._rctx.bindFramebuffer(r.fbo),this._rctx.clear(Kt.STENCIL),this._renderGeometryWithoutNormals(D.Depth),ii(this._bindParameters.depth),this._bindParameters.depth=r.obtainDepthTexture(),r.release(),this.performanceInfo.advance($t.DEPTH)}_renderAllGeometryDepth(e){if(!e)return void(this._bindParameters.depth=ii(this._bindParameters.depth));const t=this._framebufferSize,s=this.fboCache.acquire(t.width,t.height,"depth").acquireDepth(Ui.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(s.fbo),this._rctx.clear(Kt.DEPTH|Kt.STENCIL),this.renderAllGeometry(D.Depth),ii(this._bindParameters.depth),this._bindParameters.depth=s.obtainDepthTexture(),s.release(),this.performanceInfo.advance($t.DEPTH)}_renderTerrainDepth(e){if(!e)return void(this._bindParameters.terrainDepth=ii(this._bindParameters.terrainDepth));const t=this._renderContext.output;this._renderContext.output=D.Depth;const s=this._framebufferSize,r=this.fboCache.acquire(s.width,s.height,"terrain depth").acquireDepth(Ui.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(r.fbo),this._rctx.clear(Kt.DEPTH|Kt.STENCIL),this._renderTransparentTerrain(),ii(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=r.obtainDepthTexture(),this._renderContext.output=t,r.release()}_renderGeometryDepth(e){if(!e)return void(this._bindParameters.geometryDepth=ii(this._bindParameters.geometryDepth));const t=this._renderContext.output,{width:s,height:r}=this._framebufferSize,n=this.fboCache.acquire(s,r,"geometry depth").acquireDepth(Ui.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(n.fbo),this._rctx.clear(Kt.DEPTH|Kt.STENCIL),this._renderOpaqueAndTransparentGeometry(D.Depth),this._renderContext.output=t,ii(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=n.obtainDepthTexture(),n.release()}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowAccumulation}_computeDepthRange(e){if(!this._needsDepthRange)return d_;const t=K3(e,this._plugins.plugins,this._stage.layers);return Tl(t,this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}get _normalsRequired(){const e=this._nodes.require("normals","final-color",zi.COMPOSITE,"opaque-color","transparent-color","laserline-color");return(this.hasSSAO?1:0)+e}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(D.Normal),this._needsDepth&&this._precompileAllGeometry(D.Depth),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(D.ShadowHighlight),this._precompileShadowCascades(D.ShadowExcludeHighlight),this._precompileShadowCascades(D.ShadowHighlight)):this._precompileShadowCascades(D.Shadow)),this._needsShadowAccumulation&&this._precompileAllGeometry(D.Shadow)}_renderNormals(){const e=this._normalsRequired;if(e===0)return;const t=this._framebufferSize,s=this.fboCache.acquire(t.width,t.height,"normals",Ti.RGBA);s.acquireDepth(Ui.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(s.fbo),this._rctx.clearFramebuffer(ar,!0,!0),this._renderGeometryWithNormals(D.Normal);const r=this._nodes.optional("normals","final-color",zi.COMPOSITE,"opaque-color","transparent-color","viewshed-color");return s.retain(e+r-1),this.performanceInfo.advance($t.NORMALS),s}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return void(e==null?void 0:e.detachDepth());jn.setName(Ie.SSAO);const t=this._nodes.render(jn,this._pluginInput);return this._bindParameters.ssao=t,e.detachDepth(),this._pluginInput.release("normals"),this.performanceInfo.advance($t.SSAO),t}_precompileAllGeometry(e){const t=this._renderContext.output;this._renderContext.output=e,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(J.TRANSPARENT_TERRAIN),this._renderContext.output=t}renderAllGeometry(e){this._renderContext.output=e,this._renderOpaqueAndTransparentGeometry(e),this._renderTransparentTerrain()}precompileSlots(e,...t){for(const s of t)this._bindParameters.slot=s,e.precompile(this._renderContext)}precompileOccludedSlots(e,t){for(const s of t)this._renderContext.renderOccludedMask=s,this.precompileSlots(e,...Fv);this._renderContext.renderOccludedMask=Sf}renderSlots(e,...t){for(const s of t)this._bindParameters.slot=s,e.forAll(r=>{const n=r.acquireTechniques(this._renderContext);n&&(r.render(this._renderContext,n,this._pluginInput),I1(n))})}renderOccludedSlots(e,t){this._renderContext.renderOccludedMask=t,this.plugins.renderOccludedFlags>Di.Occlude&&this._plugins.render(this._pluginInput,J.OCCLUDED_TERRAIN),this.renderSlots(e,...Fv),this._renderContext.renderOccludedMask=Sf}renderHUD(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(this._pluginInput,J.HUD_MATERIAL)}precompileViewshedShadowMap(){this._precompileAllGeometry(D.ViewshedShadow)}renderViewshedShadowMap(e){const{camera:t,contentCamera:s}=this._bindParameters,r=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this.renderAllGeometry(D.ViewshedShadow),this._ensureBindParametersCamera(t,s),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=r}_renderOpaqueAndTransparentGeometry(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,...CN),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,...TN)}_precompileOpaqueGeometry(){this._plugins.precompile(...pm)}_renderOpaqueGeometry(){this._plugins.render(this._pluginInput,...pm)}_renderTransparentGeometry(){this._plugins.render(this._pluginInput,...ih)}get _needsTransparentTerrain(){return this._plugins.produces(D.Color,J.TRANSPARENT_TERRAIN)}_renderTransparentTerrain(){const e=()=>this._plugins.render(this._pluginInput,J.TRANSPARENT_TERRAIN);if(!wl(this._renderContext.output))return void e();const t=this._framebufferSize,s=this.fboCache.acquire(t.width,t.height,"transparent terrain");return this.renderToTargets(e,s,this._framebuffer.depth,ar),s}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,J.OCCLUSION_PIXELS)}_renderHUDVisibility(){var n,a;if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=ii(this._bindParameters.hudVisibility));const{width:e,height:t}=this._framebufferSize;let s=this._bindParameters.hudVisibility;((n=s==null?void 0:s.fbo)==null?void 0:n.width)===e&&((a=s==null?void 0:s.fbo)==null?void 0:a.height)===t||(s==null||s.release(),s=this.fboCache.acquire(e,t,"hud visibility",Ti.RGBA4),this._bindParameters.hudVisibility=s);const r=this._bindParameters.geometryDepth;s.attachDepth(r||this._framebuffer.depth),this._rctx.bindFramebuffer(s.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(this._pluginInput,J.OCCLUSION_PIXELS),s.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance($t.HUD_VISIBILITY)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===Js.Occluded){const t=()=>this._plugins.render(this._pluginInput,J.LINE_CALLOUTS),s=this._framebufferSize,r=this.fboCache.acquireDepth(Ui.DEPTH16_BUFFER,s.width,s.height,"line callouts");this.renderToTargets(t,this._framebuffer.color,r,void 0,!0,!0),r.release()}else this._plugins.render(this._pluginInput,J.LINE_CALLOUTS)}_renderHUD(e,t,s){if(this._pluginsHas.hudElements){if(this._oitEnabled){const r=this._renderOIT(nl.HUD,s,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,r.getTexture()),r.release()}else if(e===Js.Occluded){this._renderContext.output=D.Color;const r=()=>this._renderHUDElements(e),n=this._framebufferSize,a=this.fboCache.acquireDepth(Ui.DEPTH16_BUFFER,n.width,n.height,"hud");this.renderToTargets(r,this._framebuffer.color,a,void 0,!0,!0),a.release()}else this._renderContext.output=D.Color,t.acquireDepth(Ui.DEPTH16_BUFFER),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(e===Js.Occluded?$t.HUD_OCCLUDED:$t.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.precompile(J.LINE_CALLOUTS_HUD_DEPTH,J.HUD_MATERIAL,J.LABEL_MATERIAL),this._plugins.render(this._pluginInput,J.LINE_CALLOUTS_HUD_DEPTH,J.HUD_MATERIAL,J.LABEL_MATERIAL)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(D.ShadowHighlight,J.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(!this.hasHighlights)return;const{fboCache:e,_rctx:t,_bindParameters:s}=this,r=this._framebufferSize,n=e.acquire(r.width,r.height,"highlights",Ti.RG);return n.acquireDepth(Ui.DEPTH_STENCIL_TEXTURE),t.bindFramebuffer(n.fbo),t.clearFramebuffer(ar,!0),this._renderContext.output=D.Highlight,YT(t,e,r,this._stage.view.highlights,s,()=>this._renderHighlightGeometries(),0,()=>t.bindFramebuffer(n.fbo)),this.performanceInfo.advance($t.HIGHLIGHTS),n}_renderHighlightGeometries(){const e=[J.TRANSPARENT_MATERIAL,J.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,J.OPAQUE_MATERIAL,J.OPAQUE_MATERIAL_WITHOUT_NORMALS];this._bindParameters.highlightLevel===0&&e.push(J.TRANSPARENT_TERRAIN,J.INTEGRATED_MESH,J.OPAQUE_TERRAIN),this._plugins.precompile(...e),this._plugins.render(this._pluginInput,...e),this._rctx.clear(Kt.DEPTH),this._renderHUDElements(Js.Both)}get _needsShadowAccumulation(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(e,t,s){this._needsShadowAccumulation&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,e,t,s)&&this.performanceInfo.advance($t.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){++this._plugins.context.techniques.precompiling,this._oitEnabled&&wl(this._renderContext.output)?(this._bindParameters.oitPass=Cs.ColorAlpha,this._plugins.precompile(...ih),this._bindParameters.oitPass=Cs.FrontFace,this._plugins.precompile(...ih),this._bindParameters.oitPass=Cs.NONE):this._plugins.precompile(...ih),--this._plugins.context.techniques.precompiling}_renderOIT(e,t,s=Js.Both){const r=e===nl.HUD,n=this._framebufferSize,a=r?this.fboCache.acquire(n.width,n.height,"oit hud composite"):null,o=r?()=>this._renderHUDElements(s):()=>this._renderTransparentGeometry(),l=this._bindParameters,h=this._renderContext.output;this._renderContext.output=t,l.oitPass=Cs.ColorAlpha;const d=a?"oit hud color alpha":"oit color alpha",u=this.fboCache.acquire(n.width,n.height,d,Ti.RGBA16F);u.acquireColor(yl.COLOR_ATTACHMENT1,Ti.R16F),a||u.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(u.fbo),this._rctx.clearFramebuffer([0,0,0,1]),o(),u.detachDepth(),l.oitPass=Cs.FrontFace;const p=this.fboCache.acquire(n.width,n.height,a?"oit hud front":"oit front");return a?p.acquireDepth(Ui.DEPTH16_BUFFER):p.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(p.fbo),this._rctx.clearFramebuffer(ar,!!a),o(),p.detachDepth(),l.oitPass=Cs.NONE,a?(this._rctx.bindFramebuffer(a.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(Kt.COLOR)):this._framebuffer.bind(),this._oitblend??(this._oitblend=new z3(this._techniques)),this._oitblend.blend(this._rctx,u,p,l),a==null||a.detachDepth(),p.release(),u.release(),this._renderContext.output=h,a}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance($t.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(this._pluginInput,J.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),this.performanceInfo.advance($t.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(this._pluginInput,e),this.performanceInfo.advance(t))}_renderNodes(e,t,s=!1){if(t.setName(e),this._pluginInput.set(e,t),!this._nodes.produces(e))return s&&this.performanceInfo.advance(e),t;const r=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),r}_blitFBO(e,t=jn,s=!0){return this._blit??(this._blit=new cb(this._techniques)),this._blit.blit(this._rctx,e,t,this._bindParameters),this._pluginInput.set(e.name,t),s&&e.release(),t}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){this._ssrEnableTime==null&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=xh:(au(zv,this._bindParameters.camera.viewMatrix),au(Uv,this._bindParameters.camera.projectionMatrix),_r(Io,zv,Uv),_r(Io,this._renderContext.lastFrameCamera.viewMatrix,Io),_r(Io,this._renderContext.lastFrameCamera.projectionMatrix,Io),this._reprojectionMatrix=Io);const t=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=xh,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}updateLighting(e,t,s,r){this._bindParameters.updateLighting(e,t,s,r),this._requestRender(Me.UPDATE)}get usedMemory(){var e;return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:((e=this.edgeView)==null?void 0:e.usedMemory)??0}}renderToTargets(e,t,s,r,n=!1,a=!1){t.attachDepth(s),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer(r,n,a),e(),t.detachDepth()}get test(){}}var nl;c([m({readOnly:!0})],Qd.prototype,"fullResolutionAtmosphere",null),c([m()],Qd.prototype,"_edgeView",void 0),c([m()],Qd.prototype,"updating",null),function(i){i[i.Geometry=0]="Geometry",i[i.HUD=1]="HUD"}(nl||(nl={}));const CN=[J.INTEGRATED_MESH,J.OPAQUE_TERRAIN,J.OPAQUE_MATERIAL,J.TRANSPARENT_MATERIAL],TN=[J.OPAQUE_MATERIAL_WITHOUT_NORMALS,J.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],pm=[J.INTEGRATED_MESH,J.OPAQUE_TERRAIN,J.OPAQUE_MATERIAL,J.OPAQUE_MATERIAL_WITHOUT_NORMALS],ih=[J.TRANSPARENT_MATERIAL,J.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],Fv=[J.OPAQUE_MATERIAL,J.TRANSPARENT_MATERIAL,J.TRANSPARENT_MATERIAL_WITHOUT_DEPTH],Uv=Nt(),zv=Nt(),Io=Nt();function SN(i){return e=>i.immediate.schedule(e)}class PN{constructor(e){this._rctx=e,this._vao=EN(e)}destroy(){this._vao=We(this._vao)}draw(){this._vao!=null&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(_i.TRIANGLES,0,3))}get test(){}}function EN(i,e=c1,t=Ol){const s=new Float32Array([-1,-1,3,-1,-1,3]);return new ua(i,t,new Map([["geometry",e]]),new Map([["geometry",Ts.createVertex(i,gr.STATIC_DRAW,s)]]))}class MN{constructor(e,t,s){this._rctx=e,this._locations=t,this._layout=s,this._cache=new fc(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){var r;const t=e.toString();let s=this._cache.pop(t);return s||(s=new ua(this._rctx,this._locations,new Map([["geometry",this._layout]]),new Map([["geometry",Ts.createVertex(this._rctx,gr.STATIC_DRAW)]])),(r=s.vertexBuffers.get("geometry"))==null||r.setSize(e),s)}deleteVao(e){if(e==null)return;const t=e.byteSize.toString();this._cache.put(t,e)}}let ON=class extends mE{constructor(e,t){super(e,t),this.gl=e,this._vaoCaches=new cu,this._appleAmdDriverHelper=null,this._refCount=1,this._newCache=t.newCache,this.screen=new PN(this)}configure(e){super.configure(e),this._newCache=e.newCache}destroy(){var e,t;(e=this._vaoCaches)==null||e.forAll(s=>s.dispose()),(t=this._vaoCaches)==null||t.clear(),--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){var e;super.dispose(),(e=this._appleAmdDriverHelper)==null||e.dispose(),this.screen.destroy(),this._vaoCaches.forAll(t=>t.dispose()),this._vaoCaches.clear()}get newCache(){return this._newCache}getVaoCache(e,t){const s=Array.from(e).join("."),r=JSON.stringify(t),n=this._vaoCaches.get(s,r);if(n)return n;const a=new MN(this,e,t);return this._vaoCaches.set(s,r,a),a}bindTechnique(e,t,s,r){return this.useProgram(e.program),this.setPipelineState(e.getPipeline()),s&&(e.program.bindPass(s,t),r&&e.program.bindDraw(t,s,r)),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??(this._appleAmdDriverHelper=new _E(this)),this._appleAmdDriverHelper.run())}get test(){}};function qv(i){return!!i.frameUpdate}let Wo=class extends De{constructor(e,t,s){super({}),this._stage=e,this._techniques=t,this._rctx=s,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new Cr,this._frameTask=e.view.resourceController.scheduler.registerTask(ni.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(Z1.Texture,e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return this._textureTechnique==null&&(this._textureTechnique=this._techniques.acquire(ZT,new KT)),this._textureTechnique}acquire(e){const t=this._textures.get(e);return t?(t.ref(),t.loadingPromise??t):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach(t=>{const s=t.texture.frameUpdate(t.previousToken);s>=0&&s!==t.previousToken&&(t.previousToken=s,e=!0)}),e&&this.events.emit("changed",Me.BACKGROUND)}_createNewRef(e){const t=this._stage.getObject(e);if(t==null)return Gs(t!==void 0),null;const s=t.events.on("unloaded",()=>{s.remove(),this._onTextureUnloaded(e)}),r=new RN(e,()=>{this._frameTask.schedule(()=>{r.isUnreferenced&&t.unload()})});return this._textures.set(e,r),r.ref(),t.glTexture?(this._updateGLTexture(r,t.glTexture),qv(t)&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule(()=>{const n=t.load(this._rctx),a=l=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,l),qv(t)&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r),o=l=>(this._loadingCount--,r.loadingPromise=null,Jn(l)||Pe.getLogger(this).error(l),null);return w_(n)?n.then(a,o):a(n)}),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",Me.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};c([m()],Wo.prototype,"_loadingCount",void 0),c([m()],Wo.prototype,"_frameTask",void 0),c([m()],Wo.prototype,"updating",null),Wo=c([I("esri.views.3d.webgl-engine.lib.TextureRepository")],Wo);let RN=class{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(Pe.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}};function AN(i,e){return new _2(t=>g2(t,i),t=>t,e)}let vh=class extends De{constructor(){super(...arguments),this._passParameters=new DN,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=ha(this._resourcesTask),this._passParameters.waveNormal=We(this._passParameters.waveNormal),this._passParameters.wavePerturbation=We(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(i){return this._resourcesTask||(this._resourcesTask=lc(async e=>{await Promise.allSettled([this._loadImageResource(i,jf("esri/images/materials/water/normals.jpg"),t=>this._passParameters.waveNormal=t,e),this._loadImageResource(i,jf("esri/images/materials/water/perturbation.jpg"),t=>this._passParameters.wavePerturbation=t,e)])})),this._resourcesTask.finished?Mf.LOADED:Mf.LOADING}async _loadImageResource(i,e,t,s){try{const r=await Kh(e,{signal:s});Gi(s);const n=new hi(r.width,r.height);n.pixelFormat=ai.RGB,n.samplingMode=Ws.LINEAR_MIPMAP_LINEAR,n.hasMipmap=!0,n.maxAnisotropy=8,t(new Qi(i,n,r))}catch(r){Pe.getLogger(this).error("Failed to load water material normal texture.",r)}}};c([m()],vh.prototype,"_resourcesTask",void 0),c([m({type:Boolean,readOnly:!0})],vh.prototype,"updating",null),vh=c([I("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],vh);class DN extends gi{}class $N{constructor(e,t){this.parameters=e,this.fbos=t}}class IN{constructor(e,t,s){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=s,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(Me.BACKGROUND);const t=y_();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const s of this._screenshotQueue){if(this._rctx==null){s.resolver.reject();continue}const r={...s.settings,pixelRatio:s.settings.pixelRatio*e.parameters.camera.pixelRatio},n=this._renderScreenshot(e,r,t);s.resolver(n)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,s){e.width=t.width,e.height=t.height;const r=e.getContext("2d"),n=s.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),s.region&&r.translate(-s.region.x,-s.region.y),r.scale(n,n),t=this._renderFunctions.renderOverlay(e,s.disableDecorations,t),r.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:s,framebufferHeight:r,region:n,resample:a}=e,o=this._ensureScreenshotEncodeCanvas();let l=lp(s,r,o);this._rctx.gl.readPixels(0,0,s,r,ai.RGBA,Th.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),t(),l=this._renderScreenshotOverlay(o,l,{...e,region:void 0});const h=lp(n.width,n.height,o);return qC(l,h,!0,a.region.x,r-(a.region.y+a.region.height),a.region.width,a.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:s,region:r}=e,n=this._ensureScreenshotEncodeCanvas(),a=lp(r.width,r.height,n);return this._rctx.gl.readPixels(r.x,s-(r.y+r.height),r.width,r.height,ai.RGBA,Th.UNSIGNED_BYTE,new Uint8Array(a.data.buffer)),t(),this._renderScreenshotOverlay(n,a,e)}_renderScreenshot(e,t,s){const r=e.parameters.camera,n={width:t.framebufferWidth,height:t.framebufferHeight};B_(n,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let a=!1;const o=n.width!==r.fullWidth||n.height!==r.fullHeight,l=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,h=o||t.disableDecorations||l||t.objectAndLayerIdColor;let d=null,u=null;if(h){const g=r.clone();if(t.ignorePadding){const C=j1(g.padding);for(let S=0;S<4;S++)C[S]=Math.round(C[S]/g.pixelRatio*t.pixelRatio);g.padding=C}g.fullWidth=n.width,g.fullHeight=n.height,g.pixelRatio=t.pixelRatio;const y=r.fovX-g.fovX,w=r.fovY-g.fovY;y<0&&y<w?g.fovX=r.fovX:w<0&&w<y&&(g.fovY=r.fovY);const x={camera:g,contentCamera:g,mode:_t.IDLE,alignPixelEnabled:!0,contentPixelRatio:g.pixelRatio,forcedAnimationTime:e.parameters.forcedAnimationTime};this._forceCameraHook(x),a=!0;const T=this._renderFunctions.renderScene(x,s,t.objectAndLayerIdColor?$r.ObjectAndLayerID:$r.Screenshot,t.disableDecorations);u=T.screen,d=T.olid}const p=()=>{this._rctx.bindFramebuffer(null),u==null||u.release()};this._rctx.bindFramebuffer(u==null?void 0:u.fbo);const _=this._readbackScreenshot(t,p);let f=null;if(t.objectAndLayerIdColor){const g=()=>{this._rctx.bindFramebuffer(null),d==null||d.release()};this._rctx.bindFramebuffer(d==null?void 0:d.fbo),f=this._readbackScreenshot(t,g),this._rctx.bindFramebuffer(null)}if(h&&!this._rctx.contextAttributes.alpha)for(let g=3;g<_.data.length;g+=4)_.data[g]=255;if(f&&!this._rctx.contextAttributes.alpha)for(let g=3;g<f.data.length;g+=4)f.data[g]=255;return a&&this._forceCameraHook(e.parameters),[_,f]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}let bi=class extends De{constructor(i){super({}),this.events=new Cr,this.waterTextures=new vh,this.olidRenderHelper=Xh()?new D3:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=i.container,this._viewingMode=i.viewingMode;try{this._initializeContext(i)}catch(s){return void console.error("Failed to initialize context",s)}const{memoryController:e}=i.view.resourceController;this.stippleTextures=f2(this._rctx,e),this.markerTextures=AN(this._rctx,e),this._techniques=new hE(new YL(this._rctx,i.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new Wo(i,this._techniques,this._rctx),this.addHandles(this._textures.events.on("changed",s=>this.requestRender(s))),this._materials=new JT(this._textures,this._techniques,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new A3(this._rctx,this._techniques),this.renderer=new Qd(i,this._materials,this._techniques,this._rctx,this._compositingHelper,s=>this.requestRender(s)),this.addHandles([E(()=>i.view.ready,s=>{s&&this._createRenderNodes(i.view,i.viewingMode)},dt),E(()=>{var s;return(s=this.waterTextures)==null?void 0:s.updating},()=>this.requestRender(),dt),E(()=>i.view.qualityProfile,s=>{var r;return(r=this.renderer)==null?void 0:r.updateRenderFeatures(s)},Ge)]);const t={renderScene:(s,r,n,a)=>this.renderer.render(s,r,n,a),requestRenderScene:s=>this.requestRender(s),prepareOverlay:()=>i.options.screenshot.prepareOverlay(),renderOverlay:(s,r,n)=>i.options.screenshot.renderOverlay(s,r,n)};this._screenshotManager=new IN(this._rctx,t,s=>this.events.emit("force-camera-for-screenshot",s)),this._registerFrameTask(i)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=Hr(this._frameTask),this._techniques=de(this._techniques),this._componentObjects=de(this._componentObjects),this._screenshotManager=de(this._screenshotManager),de(this.renderer),this._textures=de(this._textures),de(this.waterTextures),de(this.markerTextures),de(this.stippleTextures),this._canvas=null,this._container=null,this._rctx=de(this._rctx)}_createRenderNodes(i,e){new p_({view:i,techniques:this._techniques}),C_(i.spatialReference)||(e===Ne.Local?new l_({view:i,techniques:this._techniques}):x_(i.spatialReference)?new qI({view:i,techniques:this._techniques}):(new n_({view:i,techniques:this._techniques}),new a_({view:i,techniques:this._techniques}),new u_({view:i,techniques:this._techniques}),new o_({view:i,techniques:this._techniques}))),new i2({view:i,isEnabled:()=>this.renderer.hasSSAO,techniques:this._techniques}),new qn({view:i,isEnabled:()=>this.renderer.hasSMAA,techniques:this._techniques}),new zn({view:i,techniques:this._techniques}),new eS({view:i,techniques:this._techniques}),new $a({view:i,viewingMode:e,techniques:this._techniques}),new ko({view:i,techniques:this._techniques}),Xh()&&new gh({view:i})}requestRender(i=Me.UPDATE){this._needsRender=!0,i===Me.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(i){this._idleSuspend!==i&&(this._idleSuspend=i,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(i){return this._screenshotManager.takeScreenshot(i).then(e=>e[0])}takeScreenshotWithOID(i){return i.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(i)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(i,e,t,s,r,n=r){const a=s.constrainWindowSize(e,t,r*s.pixelRatio,n*s.pixelRatio),o=this._ensureLinearDepthArrayBuffer(a);this.renderer.readMainDepth(a,o);const l=(d,u,p)=>sE(u,d)*(p[1]-p[0])+p[0];let h=Number.MAX_VALUE;for(let d=0;d<a[2]*a[3];d++){const u=l(4*d,o,s.nearFar);h>u&&u!==s.nearFar[0]&&u!==s.nearFar[1]&&(h=u)}if(i){const d=i.pickDepth(e*s.pixelRatio,t*s.pixelRatio,s);d!=null&&h>d&&d!==s.nearFar[0]&&d!==s.nearFar[1]&&(h=d)}return h===Number.MAX_VALUE?void 0:h}_ensureLinearDepthArrayBuffer(i){const e=4*i[2]*i[3];return(this._tmpDepthBuffer==null||this._tmpDepthBuffer.byteLength<e)&&(this._tmpDepthBuffer=new Uint8Array(e)),this._tmpDepthBuffer}async reloadShaders(){var i;Qb(),await this._techniques.reloadAll(),(i=this.renderer.overlay)==null||i.reloadShaders(),this.requestRender()}_registerFrameTask(i){const e=i.view.state;let t=!1,s=Me.BACKGROUND,r=!1;const n={preRender:({time:a})=>{t=this.updating,s=this._needsUpdate?Me.UPDATE:Me.BACKGROUND,i.commitSyncLayers(),(nt(a-this._lastAnimationUpdate)>this.renderer.animationTimestep||e.forcedAnimationTime!=null||t||this._needsRender)&&(this.renderer.updateAnimation(e,a)&&this.requestRender(Me.BACKGROUND),this._lastAnimationUpdate=a)},render:({time:a})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&e.camera.fullWidth>0&&e.camera.fullHeight>0){const o=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this.renderer.render(e,a),r=!0,o&&this.renderer.hasReflections&&(this.requestRender(Me.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:a})=>{this._textures.update();const o=new $N(e,this.renderer.fboCache);this._screenshotManager.update(o,a)},finish:()=>{r&&(this.renderer.finish(e.mode===_t.IDLE?s:Me.UPDATE),r=!1)}};this._frameTask=Ru(n)}_initializeContext(i){const e=i.options;this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:e.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:e.preserveDrawingBuffer??!1},s=this._canvas.getContext("webgl2",t);s!=null?(this._rctx=LN(s,i),this._loadShaderOnlyExtensions(),!e.alpha&&this._rctx.contextAttributes.alpha&&Pe.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&Li("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)):Pe.getLogger(this).error("A WebGL2 context could not be created.")}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}getObjectAndLayerIdColor(i){var e;return(e=this.olidRenderHelper)==null?void 0:e.getObjectAndLayerIdColor(i)}get componentObjectCollection(){return this._componentObjects==null&&(this._componentObjects=new WL(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(i){this._componentObjects=i}};function LN(i,e){const t=(r,n)=>e.view.resourceController.memoryController.newCache(r,n),s={disabledExtensions:e.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.options.debugWebGLExtensions||{},maxAnisotropy:8,newCache:t};return new ON(i,s)}c([m({type:Boolean,readOnly:!0})],bi.prototype,"updating",null),c([m()],bi.prototype,"_rctx",void 0),c([m()],bi.prototype,"_container",void 0),c([m()],bi.prototype,"_canvas",void 0),c([m()],bi.prototype,"stippleTextures",void 0),c([m()],bi.prototype,"markerTextures",void 0),c([m()],bi.prototype,"waterTextures",void 0),c([m({readOnly:!0})],bi.prototype,"olidRenderHelper",void 0),c([m()],bi.prototype,"_textures",void 0),c([m({readOnly:!0})],bi.prototype,"renderer",void 0),c([m()],bi.prototype,"_screenshotManager",void 0),c([m()],bi.prototype,"componentObjectCollection",null),c([m()],bi.prototype,"_componentObjects",void 0),c([m()],bi.prototype,"_needsUpdate",void 0),c([m()],bi.prototype,"_needsWaterReflectionUpdate",void 0),bi=c([I("esri.views.3d.webgl-engine.parts.RenderView")],bi);let As=class extends De{constructor(i){super(i),this._model=new zd,this._layers=new Lt,this._asyncChangeSet=new Rf,this._syncChangeSet=new Rf,this._layerSyncSet=new Set}initialize(){this._set("renderView",new bi(this)),this._frameTask=this.view.resourceController.scheduler.registerTask(ni.STAGE,this),this.addHandles(this._frameTask)}destroy(){this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){var i;return(i=this.renderView)==null?void 0:i.renderer}add(i){this._model.add(i),_u(i)&&this._addLayer(i),this.renderView.requestRender()}remove(i){i!=null&&!this.destroyed&&this._model.remove(i)&&(_u(i)&&this._removeLayer(i),this.renderView.requestRender())}addMany(i){i!=null&&(this._model.addMany(i),this.renderView.requestRender())}removeMany(i){var e,t;i!=null&&((e=this._model)==null||e.removeMany(i),(t=this.renderView)==null||t.requestRender())}forEachOfType(i,e){this._model.forEachOfType(i,e)}handleEvent(i,e){this.destroyed||(this._model.dirtySet[i](e),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(i){if(this._frameTask.processQueue(i),this._commit(i),!i.hasProgressed)return Xi}_commit(i){const e=this._model.dirtySet;this._asyncChangeSet.empty||i.done||(this.renderer.modify(this._asyncChangeSet,i),this.renderView.requestRender(),i.madeProgress()),this._layers.forAll(t=>{if(i.done)return;const s=this._layerSyncSet.has(t.id)||t.updatePolicy===ap.SYNC,r=s?this._syncChangeSet:this._asyncChangeSet;e.commitLayer(t.id,r),this._layerSyncSet.delete(t.id),r.empty||(this.renderer.modify(r,s?pn:i),this.renderView.requestRender(),i.madeProgress())}),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,pn),this.renderView.requestRender(),i.madeProgress()),this._layers.forAll(t=>{i.done||this._layerSyncSet.has(t.id)||t.updatePolicy!==ap.ASYNC||(e.commitLayer(t.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,i),this.renderView.requestRender(),i.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const i=this._model.dirtySet;this._layers.forAll(e=>{this._layerSyncSet.has(e.id)||e.updatePolicy===ap.SYNC?(i.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id)):i.commitSyncUpdates(e.id,this._syncChangeSet)});for(const e of this._layerSyncSet)i.commitLayer(e,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,pn),this.renderView.requestRender())}_commitLayer(i){this._model.dirtySet.commitLayer(i.id,this._syncChangeSet),this._layerSyncSet.delete(i.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,pn),this.renderView.requestRender())}schedule(i,e){return this._frameTask.schedule(i,e)}reschedule(i,e){return this._frameTask.reschedule(i,e)}syncLayer(i){this._layerSyncSet.add(i),this.renderView.requestRender()}getObject(i){return this._model.getObject(i)}get layers(){return this._layers}_addLayer(i){this._layers.includes(i)||this._layers.push(i)}_removeLayer(i){this._commitLayer(i),this._layers.removeUnordered(i)!=null&&(this._model.dirtySet.getResidentRenderGeometries(i.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,pn))}addRenderPlugin(i,e){const t=this.renderer.plugins.add(i,e),s=()=>{ny(i)&&this.view.sceneIntersectionHelper.addIntersectionHandler(i)};if(w_(t))return t.then(s);s()}removeRenderPlugin(i){this.destroyed||(ny(i)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(i),this.renderer.plugins.remove(i))}get performanceInfo(){return this._model.getStats()}get test(){}};c([m({constructOnly:!0})],As.prototype,"view",void 0),c([m({constructOnly:!0})],As.prototype,"options",void 0),c([m({readOnly:!0})],As.prototype,"viewingMode",null),c([m({constructOnly:!0})],As.prototype,"container",void 0),c([m({readOnly:!0})],As.prototype,"updating",null),c([m({constructOnly:!0})],As.prototype,"_model",void 0),c([m()],As.prototype,"renderView",void 0),c([m({readOnly:!0})],As.prototype,"renderer",null),c([m({readOnly:!0})],As.prototype,"running",null),As=c([I("esri.views.3d.webgl-engine.Stage")],As);let Xd=class extends i1{constructor(i){super(i),this.components=["attribution","zoom","navigation-toggle","compass"]}};c([m()],Xd.prototype,"components",void 0),Xd=c([I("esri.views.ui.3d.DefaultUI3D")],Xd);const _x=Xd;let Q=class extends HC(BC(GC(jC))){constructor(i){super(i),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._overrideDefaultEnvironmentOnly=!0,this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new aa({slicePlane:wC},this),this._resourceController=LA(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new Xm({view:this}),this.labeler=new Da({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new s1,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new Va,this.environment=new Uo,this.environmentManager=new Os,this.floors=new wn,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new wE({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new hA({view:this}),this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new _x,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.highlights=_A(),Gx();const e=(t=null)=>{t!=null&&t.type===Kg.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(async s=>{try{await s.when()}catch{}this._updatingChanged()}))};this.addHandles([yn(()=>{var t;return(t=this.map)==null?void 0:t.allLayers},"after-changes",t=>e(t),{onListenerAdd:()=>e(),onListenerRemove:()=>e(),sync:!0}),this.allLayerViews.on("after-changes",t=>this._updateUpdatingMonitors(t)),E(()=>this.map,t=>{t&&"load"in t&&t.load&&t.load().catch(()=>{})})]),this.inputManager=new DO({view:this}),this.stateManager=new Dt({view:this})}initialize(){this.groundView=new vE({view:this}),this._updateUpdatingMonitors();const i=()=>this._updateDefaultToMapOptions();this.addHandles(yn(()=>{var e;return(e=this.map)==null?void 0:e.allLayers},"after-changes",i,{onListenerAdd:i,onListenerRemove:i})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},dt),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},dt),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,e=>Vx(e>0?1e3/Math.ceil(e):0),dt),this.updatingHandles.add(()=>{var e;return(e=this.map)==null?void 0:e.ground},i,Ge),this.updatingHandles.add(()=>{var e,t;return(t=(e=this.map)==null?void 0:e.ground)==null?void 0:t.opacity},()=>this._updateDefaultHitTestOptions(),Ge),this.addHandles(E(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),je))}destroy(){var i;this.destroyed||(this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=de(this.sharedSymbolResources),this._set("labeler",de(this.labeler)),this._set("deconflictor",de(this.deconflictor)),this._resourceController=de(this._resourceController),this._set("stateManager",de(this.stateManager)),this._set("inputManager",de(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",de(this.environmentManager)),this._set("environment",de(this.environment)),this.groundView=de(this.groundView),this._exitBasemapTerrain(),(i=this._stage)==null||i.destroy(),this.highlights.destroy())}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){var i;return(i=this.basemapTerrain)==null?void 0:i.spatialReference}get animation(){return this.state.animation}get camera(){var i;return(i=this.stateManager)==null?void 0:i.camera}set camera(i){this.stateManager&&(this.stateManager.camera=i)}get contentCamera(){var i;return(i=this.stateManager)==null?void 0:i.contentCamera}set contentCamera(i){this.stateManager&&(this.stateManager.contentCamera=i)}installContentCameraReset(i={sticky:!1}){return this.stateManager.installContentCameraReset(i)}get center(){var i;return(i=this.stateManager)==null?void 0:i.center}set center(i){this.stateManager&&(this.stateManager.center=i)}get clippingArea(){if(this.viewingMode==="global")return null;const i=this.map;let e=this._userClippingArea||rf(i,"clippingArea");return!this._userClippingArea&&!rf(i,"clippingEnabled")||e==null?(this._clippingArea=null,null):e instanceof Nr?this.spatialReference&&(e=md(e,this.spatialReference),e==null)?(Pe.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),e.intersection(this._groundAndLayersExtent)==null&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(Pe.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(i){this.ready&&this.viewingMode==="global"&&i!=null?Pe.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=i}get renderDataExtent(){if(this.state.viewingMode===Ne.Global)return null;const i=this.renderSpatialReference,e=this.dataExtent;return e==null||i==null||e.spatialReference.equals(i)?e:md(e,i)}get tileInfo(){var i,e;return(e=(i=this.basemapTerrain)==null?void 0:i.tilingScheme)==null?void 0:e.toTileInfo()}get dataExtent(){let i=this._groundAndLayersExtent;const e=this.spatialReference||pi.WGS84,t=md(this.clippingArea,e);t!=null&&(i=i!=null?i.intersection(t):t);const s=this._get("dataExtent");return i!=null&&i.equals(s)?s:i}get _groundAndLayersExtent(){const i=this.spatialReference||pi.WGS84;let e;const t=n=>{const a=md(n,i);a!=null&&(e!=null?e.union(a):e=a.clone())},s=this.basemapTerrain;if(s!=null&&s.spatialReference){const n=s.groundExtent;t(new Nr({xmin:n[0],ymin:n[1],zmin:0,xmax:n[2],ymax:n[3],zmax:0,spatialReference:s.spatialReference}))}if(this.map){const n=a=>{a.fullExtent==null||a.type==="graphics"&&a.internal||t(a.fullExtent)};this.map.allLayers.forEach(a=>n(a))}if(e==null)return null;e.hasZ?(e.zmin=Math.min(0,e.zmin??0),e.zmax=Math.max(0,e.zmax??0)):(e.zmin=0,e.zmax=0);const r=this._get("_groundAndLayersExtent");return e.equals(r)?r:e}castEnvironment(i){var e;return i?i instanceof Uo?i:i instanceof V1?((e=this.environment)==null?void 0:e.cloneWithWebsceneEnvironment(i))??Uo.fromWebsceneEnvironment(i):Ex(Uo,i):new Uo}get extent(){var i;return(i=this.stateManager)==null?void 0:i.extent}set extent(i){this.stateManager&&(this.stateManager.extent=i)}get screenCenter(){var i;return(i=this.stateManager)==null?void 0:i.screenCenter}get frustum(){var i;return(i=this.stateManager)==null?void 0:i.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){var i;return this.navigating||(((i=this.toolViewManager)==null?void 0:i.interacting)??!1)}get stationary(){var i;return!this.animation&&!this.resizing&&(((i=this.state)==null?void 0:i.stationary)??!0)}get navigating(){var i;return((i=this.state)==null?void 0:i.navigating)??!1}get padding(){var i;return(i=this.stateManager)==null?void 0:i.padding}set padding(i){this.stateManager&&(this.stateManager.padding=i)}set qualityProfile(i){Rd.isValidProfile(i)&&(Rd.apply(i,this.qualitySettings),this._set("qualityProfile",i))}get qualityProfile(){return this._get("qualityProfile")||Rd.getDefaultProfile()}set slicePlane(i){if(this._stage!=null&&(this._stage.renderer.slicePlane=i),i==null)return void this._set("slicePlane",null);const e=this._propertiesPool.get("slicePlane");P_(i,e),this._set("slicePlane",e)}get typeSpecificPreconditionsReady(){var i;return!!this.viewingMode&&!!((i=this.stateManager)!=null&&i.preinit(this.spatialReference))}get resolution(){return this.spatialReference!=null?TC(this.scale,this.spatialReference):0}get scale(){var i;return(i=this.stateManager)==null?void 0:i.scale}set scale(i){this.stateManager&&(this.stateManager.scale=i)}get heightModelInfo(){const i=this.getDefaultHeightModelInfo();return i!=null?Kx.deriveUnitFromSR(i,this.spatialReference):null}get updating(){var r,n,a,o;if(this.destroyed)return!1;let i=0,e=this.layerViewManager.updating,t=e?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(l=>{if(l.isFulfilled()){if(l.updating){if(e=!0,l.suspended||Cm(l))return;++t,i+=l.updatingProgress}}else++t});for(const l of this._updatingObjects)l!=null&&l.updating&&(t+=.1,i+=.5*.1);for(const l of this._updatingObjectsWithProgress)l!=null&&l.updating&&(++t,i+=l.updatingProgress);const s=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(e=!!(e||t>0||this.updatingHandles.updating||!this.ready||!this.stationary||s||this._createGraphicsViewController||(r=this.inputManager)!=null&&r.updating||(a=(n=this.map)==null?void 0:n.allLayers)!=null&&a.some(l=>!l.isFulfilled())||(o=this.textures)!=null&&o.updating),e?(this._numUpdating=Math.max(t,this._numUpdating),i+=this._numUpdating-t):this._numUpdating=0,this._numUpdating>0?i/=this._numUpdating:i=e?0:1,this._get("updatingProgress")!==i){const l=performance.now();if(i<1){const h=Math.min((l-this._lastUpdateTime)/2e3,1);i=this.updatingProgress*(1-h)+i*h}this._set("updatingProgress",i),this._lastUpdateTime=e&&i<1?l:0}return e}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){var t;const i=this._predeterminedViewingMode;if(i!=null)return ip(i);const e=this.spatialReference;return e?((t=this.defaultsFromMap)==null?void 0:t.viewingMode)!=null&&e.equals(this.defaultsFromMap.spatialReference)?ip(this.defaultsFromMap.viewingMode):Yf(e,Ne.Global)?"global":"local":"global"}set viewingMode(i){this.ready?Pe.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",i)}get viewpoint(){var i;return(i=this.stateManager)==null?void 0:i.viewpoint}set viewpoint(i){this.stateManager&&(this.stateManager.viewpoint=i)}get visibleArea(){var i;return(i=this.stateManager)==null?void 0:i.visibleArea}get zoom(){return this.stateManager.zoom}set zoom(i){this.stateManager&&(this.stateManager.zoom=i)}get highlightOptions(){for(const i of this.highlights)if(i.name===fu)return i.options;return new pl}set highlightOptions(i){for(const e of this.highlights)if(e.name===fu)return void(e.options=i)}get resourceController(){return this._resourceController}get quality(){var i,e;return((e=(i=this._resourceController)==null?void 0:i.memoryController)==null?void 0:e.memoryFactor)??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new VA(this)}on(i,e,t,s){return this.viewEvents.on(i,e,t,s)||super.on(i,e)}hasEventListener(i){return super.hasEventListener(i)||this.viewEvents.hasHandler(i)}toMap(i,e){if(!this.ready)return Pe.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const t=Qf(i)?Xf(this,i):i;return S2(this,t,e,this._defaultToMapOptions)}toScreen(i){if(!this.ready)return Pe.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const e=(i.z==null?M2(this.elevationProvider,i):null)??0;return Ih(i,_d,this.renderSpatialReference,e),this.state.camera.projectToScreen(_d,mm),jv(mm[0],mm[1])}pixelSizeAt(i,e){if(!this.ready)return Pe.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if(!i)return 0;const t=this.renderSpatialReference;Ih(i,_d,t);const s=this.state.camera.computeScreenPixelSizeAt(_d);return e&&t!==e?s*fm(t)/fm(e):s}overlayPixelSizeInMapUnits(i){const e=this.basemapTerrain.overlayManager;return e?e.overlayPixelSizeInMapUnits(i,()=>this.pixelSizeAt(i)):1}hitTest(i,e){if(!this.ready)return Pe.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const t=Qf(i)?Xf(this,i):i;return P2(this,t,e,this._defaultHitTestOptions)}async popupHitTest(i){return gA(this,i)}goTo(i,e){return this.updatingHandles.addPromise(this.stateManager.goTo(i,e))}async whenAnalysisView(i){if(i.parent==null)throw new Bi("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:i});switch(i.parent.type){case"line-of-sight":case"dimension":case"viewshed":return(await this.whenLayerView(i.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(i)}}whenLayerView(i){return super.whenLayerView(i)}async takeScreenshot(i){const e=await this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshot(e);return(await X(async()=>{const{encode:s}=await import("./DefaultUI-C0utm694.js").then(r=>r.R);return{encode:s}},__vite__mapDeps([174,1,6,2,20,21,22,23,24,7,167,44,45,13,46,47,12,4,5,59,168,10,141,175,170,130,176,177,56,58,178,11,9,57,14,179,28,180,133,181,50,51,16,96,42,54,182,183,184,185,186,52,187,61,8,33,188,189,48,15,83,153,154,171,80,81,60,43,82,41,49,53,55,84,26,190,150,151,119,120,152,191,192,193,194,195,25,27,67,3,17,18,32,196,197,198,199,200,201,202,203,204,205,206]),import.meta.url)).encode(t,e,this._pixelFormat())}async _takeScreenshot(i){const e=await this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshot(e);return(await X(async()=>{const{encodeData:s}=await import("./DefaultUI-C0utm694.js").then(r=>r.R);return{encodeData:s}},__vite__mapDeps([174,1,6,2,20,21,22,23,24,7,167,44,45,13,46,47,12,4,5,59,168,10,141,175,170,130,176,177,56,58,178,11,9,57,14,179,28,180,133,181,50,51,16,96,42,54,182,183,184,185,186,52,187,61,8,33,188,189,48,15,83,153,154,171,80,81,60,43,82,41,49,53,55,84,26,190,150,151,119,120,152,191,192,193,194,195,25,27,67,3,17,18,32,196,197,198,199,200,201,202,203,204,205,206]),import.meta.url)).encodeData(t,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(i){const e=await this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshotWithOID(e),{encodeData:s}=await X(async()=>{const{encodeData:r}=await import("./DefaultUI-C0utm694.js").then(n=>n.R);return{encodeData:r}},__vite__mapDeps([174,1,6,2,20,21,22,23,24,7,167,44,45,13,46,47,12,4,5,59,168,10,141,175,170,130,176,177,56,58,178,11,9,57,14,179,28,180,133,181,50,51,16,96,42,54,182,183,184,185,186,52,187,61,8,33,188,189,48,15,83,153,154,171,80,81,60,43,82,41,49,53,55,84,26,190,150,151,119,120,152,191,192,193,194,195,25,27,67,3,17,18,32,196,197,198,199,200,201,202,203,204,205,206]),import.meta.url);return[s(t[0],this._pixelFormat()),s(t[1],this._pixelFormat())]}async _completeSettings(i){const{toRenderSettings:e,screenshotSuperSampleSettings:t}=await X(()=>import("./DefaultUI-C0utm694.js").then(r=>r.R),__vite__mapDeps([174,1,6,2,20,21,22,23,24,7,167,44,45,13,46,47,12,4,5,59,168,10,141,175,170,130,176,177,56,58,178,11,9,57,14,179,28,180,133,181,50,51,16,96,42,54,182,183,184,185,186,52,187,61,8,33,188,189,48,15,83,153,154,171,80,81,60,43,82,41,49,53,55,84,26,190,150,151,119,120,152,191,192,193,194,195,25,27,67,3,17,18,32,196,197,198,199,200,201,202,203,204,205,206]),import.meta.url),s=e(i,this);return s.pixelRatio/=this.state.pixelRatio,t(s,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){}async takeScreenshotWithObjectAndLayerId(i){if(!Xh())throw new Bi("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true");const{encode:e}=await X(()=>import("./DefaultUI-C0utm694.js").then(a=>a.R),__vite__mapDeps([174,1,6,2,20,21,22,23,24,7,167,44,45,13,46,47,12,4,5,59,168,10,141,175,170,130,176,177,56,58,178,11,9,57,14,179,28,180,133,181,50,51,16,96,42,54,182,183,184,185,186,52,187,61,8,33,188,189,48,15,83,153,154,171,80,81,60,43,82,41,49,53,55,84,26,190,150,151,119,120,152,191,192,193,194,195,25,27,67,3,17,18,32,196,197,198,199,200,201,202,203,204,205,206]),import.meta.url),t=await this._completeSettings(i);await this.whenReady();const s=await this._stage.renderView.takeScreenshotWithOID(t),r=e(s[0],t,this._pixelFormat()),n=await this._completeSettings(i);return n.format="png",[r,e(s[1],n,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){const i=this._stage.renderView.olidRenderHelper;if(i)return i.getColorToObjectAndLayerIdMapping();throw new Bi("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true")}addUpdatingPromise(i){return this.updatingHandles.addPromise(i)}importLayerView(i){return Jf.importLayerView(i)}hasLayerViewModule(i){return Jf.hasLayerViewModule(i)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var i,e,t;return this.map&&"initialViewProperties"in this.map&&((i=this.map.initialViewProperties)==null?void 0:i.spatialReference)||((e=this.defaultsFromMap)==null?void 0:e.spatialReference)||((t=this.defaultsFromMap)==null?void 0:t.ready)&&this._initialDefaultSpatialReference||null}async validate(){let i=kC(this.type);const e=Li("safari");if(e&&e<9&&(i=new Bi("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:e})),i!=null)throw Pe.getLogger(this).warn("#validate()",i.message),i}get _predeterminedViewingMode(){var e;const i=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?(e=this.map.initialViewProperties)==null?void 0:e.viewingMode:null)??null;return i!=null?Tm(i):null}getSpatialReferenceSupport(i,e){const t=this._predeterminedViewingMode;if(t!=null)return this._validateSpatialReferenceForViewingMode(i,e,t)?{constraints:this._makeSpatialReferenceConstraints(i,e,t)}:null;const s=this._validateSpatialReferenceForViewingMode(i,e,Ne.Local),r=this._validateSpatialReferenceForViewingMode(i,e,Ne.Global);return s||r?s&&r?{constraints:this._makeSpatialReferenceConstraints(i,e,null)}:s?{constraints:this._makeSpatialReferenceConstraints(i,e,Ne.Local)}:{constraints:this._makeSpatialReferenceConstraints(i,e,Ne.Global)}:null}_validateSpatialReferenceForViewingMode(i,e,t){return!!Yf(i,t)&&(e==null||!!df(e)||(!wh(e)||$u(e,i,t)!=null)&&(!uf(e)||t!==Ne.Global))}_makeSpatialReferenceConstraints(i,e,t){if(e==null)return[{spatialReference:i,viewingMode:t}];const{isWebMercator:s,isWGS84:r}=i;return df(e)&&(s||r)?!r||t===Ne.Local||ET(e.tileInfo,e.fullExtent,i,Ne.Global)===null?[{spatialReference:i,viewingMode:t},{spatialReference:pi.WebMercator,viewingMode:t}]:[{spatialReference:s?pi.WGS84:pi.WebMercator,viewingMode:t}]:wh(e)||uf(e)||!s&&!r?wh(e)&&s&&t!==Ne.Global?[{spatialReference:i,viewingMode:t},{spatialReference:pi.WGS84,viewingMode:Ne.Local}]:[{spatialReference:i,viewingMode:t}]:[{spatialReference:i,viewingMode:t},{spatialReference:s?pi.WGS84:pi.WebMercator,viewingMode:t}]}_validateSpatialReference(i){const e=this.getSpatialReferenceSupport(i)!=null,t=this._predeterminedViewingMode;return e||(t!=null?Pe.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${ip(t)} viewing mode.`):i.isGeographic&&Pe.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),e}whenReady(){return new Promise(i=>{this.ready?i(this):this._resolveWhenReady.push(i)})}trackGraphicState(i){if(!i.graphic)return Pe.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const e=this.getViewForGraphic(i.graphic);let t=null,s=!1;const r=n=>{var a;!s&&n!=null&&"processor"in n&&((a=n.processor)==null?void 0:a.type)==="graphics-3d"&&n.processor.graphicsCore&&(t=n.processor.graphicsCore.trackGraphicState(i))};return e!=null?r(e):this.whenViewForGraphic(i.graphic,{waitForLayer:!0}).then(n=>r(n),()=>{}).catch(()=>{}),Wn(()=>{s=!0,t!=null&&(t.remove(),t=null)})}highlight(i){if(Array.isArray(i))return tf(i.map(t=>this.highlight(t)));if(wn.isCollection(i))return tf(i.toArray().map(t=>this.highlight(t)));const e=this.getViewForGraphic(i);return e&&"highlight"in e?e.highlight(i):Wn()}maskOccludee(i){if(!i)return Pe.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const e=this.getViewForGraphic(i);let t=null,s=!1;const r=n=>{!s&&n!=null&&gE(n)&&(t=n.maskOccludee(i))};return e!=null?r(e):this.whenViewForGraphic(i,{waitForLayer:!0}).then(n=>r(n),()=>{}).catch(()=>{}),Wn(()=>{s=!0,t!=null&&(t.remove(),t=null)})}getViewForGraphic(i){return i.layer===this.graphics?this.graphicsView:i.layer?this.allLayerViews.find(e=>e.layer===i.layer):null}graphicChanged(i){this.graphicsView!=null&&this.graphicsView.graphicChanged(i)}async whenViewForGraphic(i,e){if(i.layer===this)return await gm(()=>this.graphicsView),this.graphicsView;if(!i.layer||!this.map)throw new Bi("no-view-for-graphic");return e&&e.waitForLayer&&!this.map.allLayers.includes(i.layer)?new Promise((t,s)=>{const r=this.map.allLayers.on("change",n=>{n.added.includes(i.layer)&&(r.remove(),this.whenLayerView(i.layer).then(t,s))})}):this.whenLayerView(i.layer)}_initBasemapTerrain(){this._set("basemapTerrain",new gI({view:this})),this._set("elevationProvider",new dh({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new ts({view:this})),this._set("featureTiles",new di({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const i=()=>{var t;const e=(t=this.basemapTerrain)==null?void 0:t.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const s=this.basemapTerrain.extent!=null&&this.basemapTerrain.spatialReference!=null?Xv(Kv(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;this.clippingArea!=null?this.featureTiles.filterExtent=this.clippingArea.intersection(s):this.featureTiles.filterExtent=s}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add(()=>fs.FEATURE_TILE_TREE_SHOW_TILES,e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(X(()=>import("./FeatureTileTree3DDebugger-CxMwaQYn.js"),__vite__mapDeps([571,1,48,2,14,9,6,10,11,12,4,5,13,15,16,20,21,22,23,24,7,141,565,50,51,80,81,60,43,44,45,46,47,42,82,83,41,49,52,53,54,8,55,28,56,57,58,59,84]),import.meta.url)).then(({FeatureTileTree3DDebugger:t})=>{!this._featureTreeDebugger&&fs.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new t({view:this}))}):e||!this._featureTreeDebugger||fs.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)},Ge),this.updatingHandles.add(()=>this.clippingArea,i,Ge),this.updatingHandles.add(()=>this.basemapTerrain.extent,i,Ge)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.featureTiles&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this._set("featureTiles",de(this.featureTiles)),this._set("pointsOfInterest",de(this.pointsOfInterest)),this._exitBasemapTerrain(),this.state.reset(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const i=this.spatialReference,e=this.state.isGlobal,t=xC(e,i);t!==this.renderSpatialReference&&(this._set("renderCoordsHelper",CC.create(this.state.viewingMode,t)),e||this.addHandles(E(()=>{var s;return(s=this.basemapTerrain)==null?void 0:s.extent},s=>{const r=this.renderCoordsHelper.spatialReference;s==null||s[0]===0&&s[1]===0&&s[2]===0&&s[3]===0||!Zv(s,this.basemapTerrain.spatialReference,Hv,r)||(this.renderCoordsHelper.extent=Hv)},je),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(hu/this.renderCoordsHelper.unitInMeters))}else this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null)}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(i=null){i!=null&&i.type===Kg.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.addHandles(E(()=>[e.updating,e.updatingProgress],()=>this._updatingChanged(),je),"updatingMonitors"),e.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(i,e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const s=i.getContext("2d");return s.putImageData(t,0,0),this.overlay.renderCanvas(i,{disableDecorations:e}),s.getImageData(0,0,t.width,t.height)}_initStage(){const i={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(s,r,n)=>this._renderScreenshotOverlay(s,r,n)}},e=new dA(this.state.viewingMode,s=>this._stage.layers.forAll(s),this);this._set("sceneIntersectionHelper",e);const t=vx(this.surface);this._stage=new As({view:this,options:i,container:t}),this._stage.renderer.slicePlane=this.slicePlane,this.addHandles([this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,s=>this._stage.renderer.setParameters({highQualityTransparency:s}),dt),this.on("pointer-move",()=>{var s;return(s=this._stage)==null?void 0:s.renderer.resetAnimation()}),Fx(this._stage.renderView.canvas,"webglcontextlost",s=>{this.fatalError=new Bi("webgl-context-lost",s.statusMessage)})],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(hu/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=de(this._stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(i){this._exitSurface(),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new qA({view:this,viewingMode:i,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;const i=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(i,i),this._updatingChanged()}async _createGraphicsViewAsync(i){const e=(await X(async()=>{const{default:t}=await import("./GraphicsView3D-C6YJDCo6.js");return{default:t}},__vite__mapDeps([572,1,6,2,83,435,80,48,14,9,10,11,12,4,5,13,15,16,81,60,22,23,24,7,43,44,45,46,47,42,50,51,82,41,49,52,53,54,8,55,28,56,57,58,59,20,21,84,282,141,189,153,154,79,85,17,18,86,3,417,286,96,78,285,150,151,119,120,152,63,61,33,37,62,64,32,35,39,65,66,36,34,38,31,40,67,68,69,70,71,72,73,74,75,76,77,87,88,89,90,91,92,93,94,95,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,30,112,113,114,115,116,117,118,121,122,123,124,125,126,127,128,129,130,131,379,280,281,283,284,287,288,133,289,290,291,292,293,294,244,246,295,146,296,260,297,254,298,299,300,380,185,177,178,179,180,186,187,381,382,383,384,164,175,170,136,418,163,144,145,147,148,149,196]),import.meta.url)).default;Gi(i),await gm(()=>{var t;return(t=this.basemapTerrain)==null?void 0:t.ready},i),this._set("graphicsView",new e({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),this.graphicsView!=null&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const i=Tm(this.viewingMode);i===Ne.Global&&(this._clippingArea=null),this._initSurface(i),this._set("ready",!0),this.addHandles(yn(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded();const e=this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties:null,t=e==null?void 0:e.environment;t&&(this._overrideDefaultEnvironmentOnly?db(this.environment,t):this.environment=this.environment.cloneWithWebsceneEnvironment(t)),this.timeExtent=e==null?void 0:e.timeExtent,this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect(),this._set("textures",new tl(this._stage,this.resourceController.scheduler));const s=this._resolveWhenReady;this._resolveWhenReady=[],s.forEach(r=>r(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this._overrideDefaultEnvironmentOnly=!1,this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._set("textures",de(this.textures)),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Qh);for(const i of this.map.allLayers.items)wm(i.type)&&this._defaultToMapOptions.include.add(i.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Qh);for(const i of this.map.allLayers.items)wm(i.type)&&i.opacity<1&&this._defaultHitTestOptions.exclude.add(i.uid)}}};function md(i,e){return i!=null&&tC(i.spatialReference,e)?Xv(i,e):null}Q.type="3d",c([m()],Q.prototype,"_userClippingArea",void 0),c([m()],Q.prototype,"_resourceController",void 0),c([m()],Q.prototype,"_stage",void 0),c([m({readOnly:!0})],Q.prototype,"deconflictor",void 0),c([m({readOnly:!0})],Q.prototype,"labeler",void 0),c([m(Zx(s1,"analyses"))],Q.prototype,"analyses",void 0),c([m({type:fl,readOnly:!0})],Q.prototype,"animation",null),c([m({readOnly:!0})],Q.prototype,"basemapTerrain",void 0),c([m({readOnly:!0})],Q.prototype,"elevationProvider",void 0),c([m()],Q.prototype,"camera",null),c([m({type:Kn})],Q.prototype,"contentCamera",null),c([m({readOnly:!0})],Q.prototype,"canvas",void 0),c([m({type:ea})],Q.prototype,"center",null),c([m({type:Nr})],Q.prototype,"clippingArea",null),c([m({type:Va})],Q.prototype,"constraints",void 0),c([m({type:Nr,readOnly:!0})],Q.prototype,"renderDataExtent",null),c([m({readOnly:!0})],Q.prototype,"tileInfo",null),c([m({type:Nr,readOnly:!0})],Q.prototype,"dataExtent",null),c([m({type:Nr,readOnly:!0})],Q.prototype,"_groundAndLayersExtent",null),c([m({type:Uo})],Q.prototype,"environment",void 0),c([_l("environment")],Q.prototype,"castEnvironment",null),c([m({readOnly:!0})],Q.prototype,"environmentManager",void 0),c([m({type:Nr})],Q.prototype,"extent",null),c([m()],Q.prototype,"floors",void 0),c([m()],Q.prototype,"screenCenter",null),c([m()],Q.prototype,"frustum",null),c([m({type:Number,readOnly:!0})],Q.prototype,"fullOpacity",void 0),c([m({readOnly:!0})],Q.prototype,"graphicsView",void 0),c([m({readOnly:!0})],Q.prototype,"analysisViewManager",void 0),c([m()],Q.prototype,"groundView",void 0),c([m({type:Boolean})],Q.prototype,"initialExtentRequired",null),c([m()],Q.prototype,"defaultsFromMapSettings",null),c([m()],Q.prototype,"interacting",null),c([m()],Q.prototype,"stationary",null),c([m()],Q.prototype,"navigating",null),c([m()],Q.prototype,"map",void 0),c([m()],Q.prototype,"padding",null),c([m({type:ts,readOnly:!0})],Q.prototype,"pointsOfInterest",void 0),c([m({type:di,readOnly:!0})],Q.prototype,"featureTiles",void 0),c([m()],Q.prototype,"_featureTreeDebugger",void 0),c([m({type:Boolean})],Q.prototype,"screenSizePerspectiveEnabled",void 0),c([m({constructOnly:!0})],Q.prototype,"deactivatedWebGLExtensions",void 0),c([m({constructOnly:!0})],Q.prototype,"debugWebGLExtensions",void 0),c([m({constructOnly:!0})],Q.prototype,"renderCanvas",void 0),c([m({constructOnly:!0})],Q.prototype,"state",void 0),c([m({readOnly:!0})],Q.prototype,"inputManager",void 0),c([m({readOnly:!0})],Q.prototype,"stateManager",void 0),c([m({type:["low","medium","high"]})],Q.prototype,"qualityProfile",null),c([m({type:oy,get(){let i=this._get("qualitySettings");return i||(i=new oy,Rd.apply(this.qualityProfile,i)),i}})],Q.prototype,"qualitySettings",void 0),c([m()],Q.prototype,"slicePlane",null),c([m({readOnly:!0})],Q.prototype,"typeSpecificPreconditionsReady",null),c([m({readOnly:!0})],Q.prototype,"renderCoordsHelper",void 0),c([m({readOnly:!0})],Q.prototype,"sceneIntersectionHelper",void 0),c([m({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Q.prototype,"resolution",null),c([m({type:Number})],Q.prototype,"scale",null),c([m()],Q.prototype,"heightModelInfo",null),c([m()],Q.prototype,"spatialReference",void 0),c([m({type:Boolean,constructOnly:!0})],Q.prototype,"alphaCompositingEnabled",void 0),c([m({constructOnly:!0})],Q.prototype,"preserveDrawingBufferEnabled",void 0),c([m({type:Boolean})],Q.prototype,"supersampleScreenshotsEnabled",void 0),c([m({readOnly:!0})],Q.prototype,"type",void 0),c([m(),_l(i=>i instanceof i1?i:Mx(_x,i))],Q.prototype,"ui",void 0),c([m({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],Q.prototype,"updating",null),c([m()],Q.prototype,"_updatingObjects",null),c([m()],Q.prototype,"_updatingObjectsWithProgress",null),c([m({type:Number,readOnly:!0,dependsOn:["updating"]})],Q.prototype,"updatingProgress",void 0),c([m({type:["global","local"]})],Q.prototype,"viewingMode",null),c([m({type:$h})],Q.prototype,"viewpoint",null),c([m({readOnly:!0})],Q.prototype,"visibleArea",null),c([m({type:Number})],Q.prototype,"zoom",null),c([m({type:pl})],Q.prototype,"highlightOptions",null),c([m({type:wn.ofType(fn)})],Q.prototype,"highlights",void 0),c([m({readOnly:!0})],Q.prototype,"quality",null),c([m({readOnly:!0})],Q.prototype,"resolutionScale",null),c([m()],Q.prototype,"textures",void 0),Q=c([I("esri.views.SceneView")],Q);const _d=v(),mm=ri(),Hv=mi(),NN=Q,aB=Object.freeze(Object.defineProperty({__proto__:null,default:NN},Symbol.toStringTag,{value:"Module"})),VN=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:sg,build:ub,cubeMapSize:hl},Symbol.toStringTag,{value:"Module"})),FN=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:rg,build:mb},Symbol.toStringTag,{value:"Module"})),UN=Object.freeze(Object.defineProperty({__proto__:null,build:gb},Symbol.toStringTag,{value:"Module"})),zN=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:yg,build:Jb},Symbol.toStringTag,{value:"Module"})),qN=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return Pn},build:ww},Symbol.toStringTag,{value:"Module"})),HN=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:Sw,ColorizerStretchUniforms:Tw,ColorizerUniforms:ju,build:Pw},Symbol.toStringTag,{value:"Module"})),BN=Object.freeze(Object.defineProperty({__proto__:null,build:Lw},Symbol.toStringTag,{value:"Module"})),GN=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:Ag,build:Vw},Symbol.toStringTag,{value:"Module"})),kN=Object.freeze(Object.defineProperty({__proto__:null,build:Fw},Symbol.toStringTag,{value:"Module"})),jN=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:Dg,build:Uw},Symbol.toStringTag,{value:"Module"})),WN=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:Ig,SimpleAtmospherePassParameters:Qu,build:zw},Symbol.toStringTag,{value:"Module"})),QN=Object.freeze(Object.defineProperty({__proto__:null,build:kw},Symbol.toStringTag,{value:"Module"})),XN=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:Vg,build:Xw},Symbol.toStringTag,{value:"Module"})),YN=Object.freeze(Object.defineProperty({__proto__:null,build:Yw},Symbol.toStringTag,{value:"Module"})),ZN=Object.freeze(Object.defineProperty({__proto__:null,build:Kw},Symbol.toStringTag,{value:"Module"})),KN=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:Ug,build:Jw},Symbol.toStringTag,{value:"Module"})),JN=Object.freeze(Object.defineProperty({__proto__:null,build:ex},Symbol.toStringTag,{value:"Module"})),e5=Object.freeze(Object.defineProperty({__proto__:null,build:tx},Symbol.toStringTag,{value:"Module"})),t5=Object.freeze(Object.defineProperty({__proto__:null,build:ix},Symbol.toStringTag,{value:"Module"})),i5=Object.freeze(Object.defineProperty({__proto__:null,build:sx},Symbol.toStringTag,{value:"Module"})),s5=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:zg,build:nx},Symbol.toStringTag,{value:"Module"})),r5=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:qg,build:cx},Symbol.toStringTag,{value:"Module"})),n5=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:Hg,build:px},Symbol.toStringTag,{value:"Module"})),a5=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:vc,build:ux},Symbol.toStringTag,{value:"Module"}));export{Fr as A,wA as I,Zc as N,aB as S,si as W,It as a,DL as b,Zq as c,Ra as d,rz as e,ah as f,ly as g,e3 as h,yF as i,Ww as j,bz as k,fF as l,gR as m,NN as n,rc as o,jL as r,Qq as s,sD as t,ma as u,ju as v};
