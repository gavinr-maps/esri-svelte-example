import{B as w,s as p}from"./Accessor-BmwT4B0c.js";import{B as v,I as h,g,D as b,y as x,F as $,G as E,e as F}from"./opacityUtils-Dim20wpZ.js";import{E as A,j as B}from"./Promise-DfET-uns.js";import{l as I}from"./intl-Duiy0OzY.js";import{x as S,_ as T}from"./labelUtils-DCpQ7n-8.js";const m=()=>w.getLogger("esri.layers.support.labelFormatUtils"),d={type:"simple",evaluate:()=>null},V={getAttribute:(o,n)=>o.field(n)};async function U(o,n,f){if(!o||!o.symbol||!n)return d;const u=o.where,l=S(o);let a;if(l.type==="arcade"){const t=b(l.expression),s=n.get(t);if(s&&(x(s)||g(s)||$(s)))a={type:"simple",evaluate(e){var i;const r="attributes"in e?(i=e.attributes)==null?void 0:i[s.name]:e.field(s.name);return r==null?"":r.toString()}};else{const e=await E(l.expression,f,n);if(e==null)return d;a={type:"arcade",evaluate(r,i){try{const c="attributes"in r?e.repurposeFeature(r):r;c.contextTimeZone=i??null;const y=e.evaluate({$view:{timeZone:i},$feature:c},e.services);if(y!=null)return y.toString()}catch(c){m().error(new p("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:c,feature:r,expression:l}))}return null},needsHydrationToEvaluate:()=>T(l.expression)==null}}}else a={type:"simple",evaluate:t=>l.expression.replaceAll(/{[^}]*}/g,s=>{var c;const e=s.slice(1,-1),r=n.get(e);if(!r)return s;let i=null;return i="attributes"in t?(c=t==null?void 0:t.attributes)==null?void 0:c[r.name]:t.field(r.name),i==null?"":Z(i,r)})};if(u){let t;try{t=await F(u,n)}catch(e){return m().error(new p("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:u,error:e})),d}const s=a.evaluate;a.evaluate=(e,r)=>{const i="attributes"in e?void 0:V;try{if(t.testFeature(e,i))return s(e,r)}catch(c){m().error(new p("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:u,feature:e,error:c}))}return null}}return a}function Z(o,n){if(o==null)return"";const f=n.domain;if(f){if(f.type==="codedValue"||f.type==="coded-value"){const l=o;for(const a of f.codedValues)if(a.code===l)return a.name}else if(f.type==="range"){const{max:l,min:a}=v(n),t=+o;if(a!=null&&l!=null&&a<=t&&t<=l)return f.name}}let u=o;return h(n)?u=A(u,B("short-date")):g(n)&&(u=I(+u)),u||""}export{Z as b,U as y};
