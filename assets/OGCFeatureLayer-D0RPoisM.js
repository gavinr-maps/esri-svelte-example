import{r}from"./tslib.es6-B3Jf3DVX.js";import{i as N,o as R}from"./geometry-D964gYQX.js";import{q as L}from"./PopupTemplate-BHMhS05j.js";import"./ClassBreaksRenderer-BuHwSyVK.js";import{m as z,u as H}from"./jsonUtils-DxpLMo6d.js";import"./UniqueValueRenderer-BQtAHUSo.js";import"./SimpleRenderer-BV2L9G_n.js";import{S as J}from"./MultiOriginJSONSupport-B5nfqtQh.js";import{m as i,a as j,P as F,b as I}from"./subclass-BZA_h8Db.js";import U from"./Layer-CVt7Hb5J.js";import{m as V}from"./Loadable-BabW5Xcc.js";import{R as Z,x as O,C as $,P as k,O as W,N as K,q as X,v as Y,k as tt}from"./ogcFeatureUtils-YVfdd5m4.js";import{s as et}from"./capabilities-Y9lFlGVh.js";import{d as rt}from"./FeatureSet-BHEkYP03.js";import{g as C}from"./Point-Cg0-ChZE.js";import{i as ot}from"./APIKeyMixin-Di9kcRBS.js";import{l as it}from"./BlendLayer-CXM4n_Ge.js";import{e as pt}from"./CustomParametersMixin-B4u7wiBT.js";import{c as st}from"./FeatureEffectLayer-CpM66wLd.js";import{c as nt}from"./FeatureReductionLayer-Ddbk727V.js";import{b as at}from"./OperationalLayer-CVyVfSPu.js";import{p as lt}from"./OrderedLayer-C5VLMHgA.js";import{j as ut}from"./PortalLayer-CKja4bdW.js";import{f as mt}from"./RefreshableLayer-D7lXUJRS.js";import{t as dt}from"./ScaleRangeLayer-Bb8Ig1Hz.js";import{l as ct}from"./TemporalLayer-Dpq2hKKV.js";import{c as yt,p as ft,d as ht,l as gt,s as vt,y as St}from"./commonProperties-CPyIG_-u.js";import{n as Ct}from"./FeatureType-C0q_coeM.js";import{y as wt}from"./Field-ybkHhtnK.js";import{s as bt}from"./fieldProperties-Cgxj08ZE.js";import{N as D,g as xt}from"./fieldUtils-tmQlKvWo.js";import{C as Rt,n as Ft}from"./labelingInfo-DYPSPZCH.js";import{b as T}from"./Query-5Xpquc1r.js";import{p as It}from"./popupUtils-BBuPGAHd.js";import{w as Ot}from"./Extent-Bf3YTe7m.js";import"./Polyline-D9YkgmM_.js";import"./writer-DNAwXnhG.js";import"./mathUtils-C4_ghTv4.js";import"./jsonMap-0cxwUWs2.js";import"./Clonable-D3rtuBWg.js";import"./Accessor-BLX9ikPh.js";import"./Collection-CEdjem1-.js";import"./Evented-BHRw9x22.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./assets-C43MgM-v.js";import"./index-Bh2oEzTI.js";import"./cast-Bjksrh93.js";import"./enumeration-Ba5njXdz.js";import"./date-DlqISzcw.js";import"./locale-C9TlLpzi.js";import"./Color-BCS62Hs5.js";import"./colorUtils-0bJDPow9.js";import"./ActionToggle-iT4slXc7.js";import"./Identifiable-B1UbsKNt.js";import"./symbols-CNimns--.js";import"./TextSymbol-D8QO_KUV.js";import"./screenUtils-_ZIvrt5o.js";import"./materialUtils-DarhapKC.js";import"./opacityUtils-C68Tlu6_.js";import"./vec3f64-BLpZdpfb.js";import"./aaBoundingBox-BE7cC1jD.js";import"./persistableUrlUtils-fa1mAujs.js";import"./collectionUtils-D_lHIu88.js";import"./Portal-C10FKnaA.js";import"./reactiveUtils-C5zUhJQJ.js";import"./asyncUtils-CWX51uTe.js";import"./RendererLegendOptions-B-4se3aU.js";import"./LRUCache-B_PHMSGm.js";import"./MemCache-Dx1v3xLC.js";import"./Version-BSlAgupz.js";import"./jsonUtils-CEfjT-BK.js";import"./FieldsIndex-DpwHKAMX.js";import"./UnknownTimeZone-BkowvBs8.js";import"./OverrideHelper-ti072FkP.js";import"./colorUtils-aL8wj-8G.js";import"./vec42-YcqnINSP.js";import"./common-DQOJ18NT.js";import"./vec4f64-o2zAXfmz.js";import"./utils-D2PLyMFF.js";import"./enums-CmIX1y88.js";import"./quantizationUtils-uj_P09aO.js";import"./HeatmapColorStop-BJc5nbwr.js";import"./heatmapUtils-Dwiv9IEa.js";import"./SizeVariable-936USOrb.js";import"./sizeVariableUtils-Cmcuvw-4.js";import"./visualVariableUtils-DX1kS9Se.js";import"./Graphic-DsxsIjhH.js";import"./compilerUtils-Dw3R0f-Z.js";import"./lengthUtils-DL1-FDQQ.js";import"./intl-CChhNOV8.js";import"./messages-OmQvZhAg.js";import"./Promise-B2Hu02L7.js";import"./diffUtils-BP7jmOAy.js";import"./colorRamps-pKd7I5WZ.js";import"./ColorStop-Dk3U5tCk.js";import"./jsonUtils-Ds2Sqto-.js";import"./layerUtils-BrNoooE9.js";import"./defaults-DZ1kfMRx.js";import"./defaultsJSON-GKolV7NZ.js";import"./styleUtils-BYTm14n3.js";import"./TimeExtent-DocT5yPf.js";import"./timeUtils-8fb_2oAt.js";import"./featureConversionUtils-D14h8iad.js";import"./OptimizedFeature-6cJ-QFG5.js";import"./OptimizedGeometry-BF8iz5FO.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./geojson-DMG1YeVa.js";import"./date-DLgTylpo.js";import"./clientSideDefaults-BCN5Jkqv.js";import"./QueryEngineCapabilities-DjYb9CEb.js";import"./sourceUtils--DUSj3Of.js";import"./fieldType-BuzM0UHS.js";import"./jsonUtils-CSnQD004.js";import"./parser-CTsgEym6.js";import"./utils-93yNk4Xc.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-GpOFENPA.js";import"./FeatureEffect-BEzQmzeC.js";import"./FeatureFilter-BMHRQSxq.js";import"./layerContainerType-C5CzMsLd.js";import"./FeatureReductionSelection-7vaL4DYT.js";import"./featureLayerUtils-DBsQMhTm.js";import"./featureQueryAll-DnVoEjkM.js";import"./AttachmentQuery-BUlkjzkx.js";import"./RelationshipQuery-DPPNeuLK.js";import"./DataLayerSource-BKkswDvG.js";import"./MD5-C9MwAd2G.js";import"./OrderByInfo-IYmS1EXF.js";import"./PortalItem-DzgXrpyc.js";import"./portalItemUtils-BzVoFAku.js";import"./projection-B971H0Re.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";import"./TimeInfo-LUiaSFyX.js";import"./TimeInterval-CNlkea1s.js";import"./ElevationInfo-CA5m_tHv.js";import"./unitConversionUtils-BMfW9yAe.js";import"./AttributeTableTemplate-BZeVyq-j.js";import"./FeatureTemplate-CssMa1yk.js";import"./labelUtils-B8petyBk.js";import"./FullTextSearch-Csd1Hktu.js";let m=class extends V{constructor(){super(...arguments),this.featureDefinition=null,this.type="ogc-feature"}load(t){return this.addResolvingPromise(this._loadOGCServices(this.layer,t)),this.when()}getSource(){const{featureDefinition:{collection:t,layerDefinition:e,spatialReference:p,supportedCrs:s},layer:{apiKey:n,customParameters:l,effectiveMaxRecordCount:a}}=this;return{type:"ogc-source",collection:t,layerDefinition:e,maxRecordCount:a,queryParameters:{apiKey:n,customParameters:l},spatialReference:p,supportedCrs:s}}queryExtent(t,e={}){return null}queryFeatureCount(t,e={}){return null}queryFeatures(t,e={}){return this.queryFeaturesJSON(t,e).then(p=>rt.fromJSON(p))}queryFeaturesJSON(t,e={}){const p=this.getSource();return this.load(e).then(()=>Z(p,t,e))}queryObjectIds(t,e={}){return null}serviceSupportsSpatialReference(t){return!(!t.isWGS84&&!t.isWebMercator)||!!this.featureDefinition.supportedCrs[t.wkid]}_conformsToType(t,e){const p=new RegExp(`^${F(e)}$`,"i");return t.conformsTo.some(s=>p.test(s))??!1}_getCapabilities(t,e){return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,isBranchVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:t},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!1,supportsQueryBins:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},query:{maxRecordCount:e,maxRecordCountFactor:void 0,standardMaxRecordCount:void 0,supportsCacheHint:!1,supportsCentroid:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:!1,supportsPagination:!1,supportsPercentileStatistics:!1,supportsQuantization:!1,supportsQuantizationEditMode:!1,supportsQueryByAnonymous:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsStatistics:!1,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsCompactGeometry:!1,supportsSqlExpression:!1,tileMaxRecordCount:void 0},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},queryBins:et,editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUploadWithItemId:!1,supportsUpdateWithoutM:!1,supportsAsyncApplyEdits:!1,zDefault:void 0}}}_getMaxRecordCount(t){var p,s,n,l,a;const e=(p=t==null?void 0:t.components)==null?void 0:p.parameters;return((n=(s=e==null?void 0:e.limit)==null?void 0:s.schema)==null?void 0:n.maximum)??((a=(l=e==null?void 0:e.limitFeatures)==null?void 0:l.schema)==null?void 0:a.maximum)}_getStorageSpatialReference(t){const e=t.storageCrs??O,p=$(e);return p==null?C.WGS84:new C({wkid:p})}_getSupportedSpatialReferences(t,e){const p="#/crs",s=t.crs??[O],n=s.includes(p)?s.filter(a=>a!==p).concat(e.crs??[]):s,l=/^http:\/\/www\.opengis.net\/def\/crs\/epsg\/.*\/3785$/i;return n.filter(a=>!l.test(a))}async _loadOGCServices(t,e){const p=e!=null?e.signal:null,{apiKey:s,collectionId:n,customParameters:l,fields:a,geometryType:y,hasZ:f,objectIdField:P,timeInfo:h,url:q}=t,_={fields:a==null?void 0:a.map(u=>u.toJSON()),geometryType:N.toJSON(y),hasZ:f??!1,objectIdField:P,timeInfo:h==null?void 0:h.toJSON()},d={apiKey:s,customParameters:l,signal:p},g=await k(q,d),[w,b]=await Promise.all([W(g,d),K(g,d)]);if(!this._conformsToType(w,"http://www.opengis.net/spec/ogcapi-features-1/1.0/conf/geojson"))throw new I("ogc-feature-layer:no-geojson-support","Server does not support geojson");const c=b.collections.find(({id:u})=>u===n);if(!c)throw new I("ogc-feature-layer:collection-not-found","Server does not contain the named collection");const E=this._conformsToType(w,"http://www.opengis.net/spec/ogcapi-features-1/1.0/conf/oas30")?await X(g,d):null,x=await Y(c,_,d),B=this._getMaxRecordCount(E),A=this._getCapabilities(x.hasZ,B),Q=this._getStorageSpatialReference(c).toJSON(),G=this._getSupportedSpatialReferences(c,b),M=new RegExp(`^${F(tt)}`,"i"),v={};for(const u of G){const S=$(u);S!=null&&(v[S]||(v[S]=u.replace(M,"")))}this.featureDefinition={capabilities:A,collection:c,layerDefinition:x,spatialReference:Q,supportedCrs:v}}};r([i()],m.prototype,"featureDefinition",void 0),r([i({constructOnly:!0})],m.prototype,"layer",void 0),r([i()],m.prototype,"type",void 0),m=r([j("esri.layers.graphics.sources.OGCFeatureSource")],m);const $t=bt();let o=class extends ot(pt(nt(st(it(lt(ct(dt(at(ut(mt(J(U)))))))))))){constructor(t){super(t),this.capabilities=null,this.collectionId=null,this.copyright=null,this.description=null,this.displayField=null,this.elevationInfo=null,this.fields=null,this.fieldsIndex=null,this.fullExtent=null,this.geometryType=null,this.hasZ=void 0,this.labelingInfo=null,this.labelsVisible=!0,this.legendEnabled=!0,this.maxRecordCount=null,this.objectIdField=null,this.operationalLayerType="OGCFeatureLayer",this.popupEnabled=!0,this.popupTemplate=null,this.screenSizePerspectiveEnabled=!0,this.source=new m({layer:this}),this.spatialReference=null,this.title=null,this.type="ogc-feature",this.typeIdField=null,this.types=null,this.url=null}destroy(){var t;(t=this.source)==null||t.destroy()}load(t){return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["OGCFeatureServer"]},t).then(()=>this._fetchService(t))),this.when()}get defaultPopupTemplate(){return this.createPopupTemplate()}get effectiveMaxRecordCount(){var t;return this.maxRecordCount??((t=this.capabilities)==null?void 0:t.query.maxRecordCount)??5e3}get isTable(){return this.loaded&&this.geometryType==null}set renderer(t){D(t,this.fieldsIndex),this._set("renderer",t)}on(t,e){return super.on(t,e)}createPopupTemplate(t){return It(this,t)}createQuery(){return new T}getField(t){return this.fieldsIndex.get(t)}getFieldDomain(t,e){var a;let p,s=!1;const n=(a=e==null?void 0:e.feature)==null?void 0:a.attributes,l=this.typeIdField&&(n==null?void 0:n[this.typeIdField]);return l!=null&&this.types&&(s=this.types.some(y=>{var f;return y.id==l&&(p=(f=y.domains)==null?void 0:f[t],(p==null?void 0:p.type)==="inherited"&&(p=this._getLayerDomain(t)),!0)})),s||p||(p=this._getLayerDomain(t)),p}queryFeatures(t,e){return this.load().then(()=>this.source.queryFeatures(T.from(t)||this.createQuery(),e)).then(p=>{var s;return(s=p==null?void 0:p.features)==null||s.forEach(n=>{n.layer=n.sourceLayer=this}),p})}serviceSupportsSpatialReference(t){var e;return((e=this.source)==null?void 0:e.serviceSupportsSpatialReference(t))??!1}async _fetchService(t){await this.source.load(t),this.read(this.source.featureDefinition,{origin:"service"}),D(this.renderer,this.fieldsIndex),xt(this.timeInfo,this.fieldsIndex)}_getLayerDomain(t){if(!this.fields)return null;for(const e of this.fields)if(e.name===t&&e.domain)return e.domain;return null}};r([i({readOnly:!0,json:{origins:{service:{read:!0}}}})],o.prototype,"capabilities",void 0),r([i({type:String,json:{write:!0}})],o.prototype,"collectionId",void 0),r([i({type:String})],o.prototype,"copyright",void 0),r([i({readOnly:!0})],o.prototype,"defaultPopupTemplate",null),r([i({readOnly:!0,type:String,json:{origins:{service:{name:"collection.description"}}}})],o.prototype,"description",void 0),r([i({type:String})],o.prototype,"displayField",void 0),r([i({type:Number})],o.prototype,"effectiveMaxRecordCount",null),r([i(yt)],o.prototype,"elevationInfo",void 0),r([i({type:[wt],json:{origins:{service:{name:"layerDefinition.fields"}}}})],o.prototype,"fields",void 0),r([i($t.fieldsIndex)],o.prototype,"fieldsIndex",void 0),r([i({readOnly:!0,type:Ot,json:{origins:{service:{name:"layerDefinition.extent"}}}})],o.prototype,"fullExtent",void 0),r([i({type:R.apiValues,json:{origins:{service:{name:"layerDefinition.geometryType",read:{reader:R.read}}}}})],o.prototype,"geometryType",void 0),r([i({type:Boolean,json:{origins:{service:{name:"layerDefinition.hasZ"}}}})],o.prototype,"hasZ",void 0),r([i({type:Boolean,readOnly:!0})],o.prototype,"isTable",null),r([i({type:[Rt],json:{origins:{"web-document":{name:"layerDefinition.drawingInfo.labelingInfo",read:{reader:Ft},write:!0}}}})],o.prototype,"labelingInfo",void 0),r([i(ft)],o.prototype,"labelsVisible",void 0),r([i(ht)],o.prototype,"legendEnabled",void 0),r([i({type:Number})],o.prototype,"maxRecordCount",void 0),r([i({type:String,json:{origins:{service:{name:"layerDefinition.objectIdField"}}}})],o.prototype,"objectIdField",void 0),r([i({type:["OGCFeatureLayer"]})],o.prototype,"operationalLayerType",void 0),r([i(gt)],o.prototype,"popupEnabled",void 0),r([i({type:L,json:{name:"popupInfo",write:!0}})],o.prototype,"popupTemplate",void 0),r([i({types:z,json:{origins:{service:{name:"layerDefinition.drawingInfo.renderer",write:!1},"web-scene":{types:H,name:"layerDefinition.drawingInfo.renderer",write:!0}},name:"layerDefinition.drawingInfo.renderer",write:!0}})],o.prototype,"renderer",null),r([i(vt)],o.prototype,"screenSizePerspectiveEnabled",void 0),r([i({readOnly:!0})],o.prototype,"source",void 0),r([i({readOnly:!0,type:C,json:{origins:{service:{read:!0}}}})],o.prototype,"spatialReference",void 0),r([i({type:String,json:{write:{enabled:!0,ignoreOrigin:!0,isRequired:!0},origins:{service:{name:"collection.title"}}}})],o.prototype,"title",void 0),r([i({readOnly:!0,json:{read:!1}})],o.prototype,"type",void 0),r([i({type:String,readOnly:!0})],o.prototype,"typeIdField",void 0),r([i({type:[Ct]})],o.prototype,"types",void 0),r([i(St)],o.prototype,"url",void 0),o=r([j("esri.layers.OGCFeatureLayer")],o);const lo=o;export{lo as default};
