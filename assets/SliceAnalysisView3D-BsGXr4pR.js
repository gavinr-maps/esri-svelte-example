import{e as r}from"./Evented-CXIxDjmW.js";import{S as q,a4 as ft,u as V,U as Vt,f as Z}from"./Accessor-D6mNnsWy.js";import{y as l,b as H,n as z}from"./subclass-BR3PhgZG.js";import{s as bt}from"./AnalysisView3D-Bxdzk7YF.js";import{h as rt}from"./SlicePlane-DzUQ-3ue.js";import{d as y,C as Mt,A as F}from"./reactiveUtils-BFQ0BtrB.js";import{W as d,Z as u,d as K,H as W}from"./boundedPlane-CZE_hxQR.js";import{f as J}from"./Layer-C96_yo4i.js";import{A as Dt}from"./BuildingComponentSublayer-C9oehFgo.js";import{x as Et,L as Ct,V as Tt,R as lt,I as St,H as xt,g as Q,v as $t,j as ot,A as pt,l as X,_ as Y,r as kt,s as Lt,M as S,e as Ht,C as f,c as ht,u as zt,m as Ot,p as Rt,a as Gt,b as ut,t as ct,d as It,f as At}from"./SlicePlaneMaterial.glsl-CsvQGmT7.js";import{t as Bt}from"./projectionUtils-KFirXguG.js";import{n as Ft}from"./compilerUtils-BA04t1lN.js";import{c as Kt,d as Ut}from"./screenUtils-PfxkaaMN.js";import{p as jt,d as dt,c as mt}from"./mat4-ybYUU6jq.js";import{P as x,s as C,r as tt,g as O,c as it,O as et,t as Nt,z as at,d as yt,n as U}from"./mathUtils-ClvKsMak.js";import{t as qt,_ as vt}from"./vec4f64-CBQL1T0x.js";import{V as st,c,E as j,S as L,F as R,f as T,t as Zt}from"./plane-Bz78OrLf.js";import{m as Wt}from"./sphere-7666U3LO.js";import{l as Jt,n as Qt}from"./Factory-DT237UGo.js";import{m as Xt,M as wt,r as G,t as I,p as Yt,f as ti,h as ii,j as ei}from"./sliceToolConfig-DLdTgbpM.js";import{b as ai}from"./RenderObject-BOdCnfVB.js";import{O as $}from"./dragEventPipeline3D-CGTtUgxV.js";import{m as M}from"./ray-DM1mbnrb.js";import{o as si}from"./ShadedColorMaterial.glsl-DFzIg9fk.js";import{p as k}from"./InteractiveToolBase-SWVoyXWH.js";import{t as ni}from"./ToolIntersector-BOg0Q1CG.js";import{n as D}from"./screenUtils-BGG3AyYa.js";import{h as ri}from"./lineStippleUtils-BcQwIcXj.js";import{a as li,v as oi}from"./analysisViewUtils-CW7QQu79.js";import"./Promise-CZrWwByK.js";import"./jsonMap-DCC6W5ex.js";import"./geometry-DpwwkAX1.js";import"./Extent-DHjqVB-p.js";import"./Point-DB4Hp4hH.js";import"./writer-3zufXUNV.js";import"./assets-C2mb-ea2.js";import"./index-CeCSsEgo.js";import"./Polyline-D97hl-6E.js";import"./Clonable-cKbRam6-.js";import"./Cyclical-BY_I03kj.js";import"./persistable-ZhNvqYX-.js";import"./MD5-C9MwAd2G.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./uuid-fwrPAdZb.js";import"./resourceExtension-CNyCBDXT.js";import"./persistableUrlUtils-BcifXQ1Z.js";import"./shared-B3wH2qpO.js";import"./mat4f64-Dk4dwAN8.js";import"./lineSegment-BvgMMk26.js";import"./TimeExtent-41gxTbrv.js";import"./timeUtils-DQR2jUPL.js";import"./Identifiable-BLvpQbOc.js";import"./Portal-liet8xHC.js";import"./Graphic-Dc7F67nR.js";import"./PopupTemplate-ByHks6sq.js";import"./fieldUtils-CNduWQU9.js";import"./intl-Dpfm8vPB.js";import"./enumeration--HlxOQ_N.js";import"./Color-DDUWtbqR.js";import"./colorUtils-CS9vdHXB.js";import"./ActionToggle-C0Z1k2jc.js";import"./symbols-CsUQ5BxR.js";import"./TextSymbol-gKE-H_J6.js";import"./materialUtils-CQ3JLQ1x.js";import"./opacityUtils-BT7mQkwC.js";import"./aaBoundingBox-rJEWaOSN.js";import"./collectionUtils-Dm1icNvk.js";import"./jsonUtils-Cma_7A64.js";import"./ClassBreaksRenderer-DMO3d0Rn.js";import"./UniqueValueRenderer-dci9bLM8.js";import"./diffUtils--7ofoPN-.js";import"./colorRamps-CFlTi-ob.js";import"./SizeVariable-aYYWlweG.js";import"./ColorStop-CXfPDZon.js";import"./sizeVariableUtils-Cmcuvw-4.js";import"./visualVariableUtils-DzaXbn8H.js";import"./lengthUtils-D7_DvYH0.js";import"./jsonUtils-C6dvhNjw.js";import"./layerUtils-erzwAANv.js";import"./defaults-DCm7iNI6.js";import"./defaultsJSON-GKolV7NZ.js";import"./styleUtils-DQEZjdpw.js";import"./jsonUtils-CuoSmH2q.js";import"./LRUCache-ju6LnIBZ.js";import"./MemCache-C6WUx-5V.js";import"./Version-_Vxue7Ui.js";import"./FieldsIndex-IOXc-mnc.js";import"./UnknownTimeZone-D0GlcniK.js";import"./OverrideHelper-C4oumxVn.js";import"./colorUtils-D5nOabzP.js";import"./vec42-B1mBkh1w.js";import"./utils-CO7DMJWl.js";import"./quantizationUtils-CIQDbQFJ.js";import"./HeatmapColorStop-CgvKf0-E.js";import"./heatmapUtils-C-uT6ZIV.js";import"./SimpleRenderer-DvJZ7cyq.js";import"./FeatureLayer-BCmfw45U.js";import"./MultiOriginJSONSupport-DjAXzJun.js";import"./layerContainerType-C5CzMsLd.js";import"./FeatureLayerBase-CD91dIfN.js";import"./inputs-CnJRqwLx.js";import"./Field-C8SaaeoI.js";import"./fieldType-CIG5ey7e.js";import"./formUtils-Dni92j4V.js";import"./HeightModelInfo-CSXZysDz.js";import"./arcgisLayerUrl-Cgl5IQFD.js";import"./commonProperties-C-F8Nu9F.js";import"./ElevationInfo-BxYXLfrw.js";import"./unitConversionUtils-Dl04YuQU.js";import"./featureLayerUtils-CeNLEyq1.js";import"./featureQueryAll-CRo1-WqJ.js";import"./Query-Cx4awVKu.js";import"./DataLayerSource-6X35yXpo.js";import"./FullTextSearch-BNIhEccm.js";import"./AttachmentQuery-Dn4NbT1Z.js";import"./RelationshipQuery-kHvI2dm7.js";import"./LayerFloorInfo-BN2blBAm.js";import"./Relationship-WMN17mIX.js";import"./serviceCapabilitiesUtils-GL2GsHu0.js";import"./workers-8Q6jrI18.js";import"./Queue-DpHko4Yk.js";import"./editsZScale-BMHD7K6h.js";import"./queryZScale-B_YkkRy9.js";import"./projection-A9yUaaTs.js";import"./projectBuffer-vsa0P_cF.js";import"./geodesicConstants-XRAvAZCD.js";import"./FeatureSet-DyOnd9Rj.js";import"./APIKeyMixin-DpJrW91V.js";import"./ArcGISService-Dr1J04Ka.js";import"./BlendLayer-DmvCcS5c.js";import"./jsonUtils-C4Wp5KpV.js";import"./parser-BN6zmHl-.js";import"./utils-D20M4_S8.js";import"./mat4f32-DcsiF_Rp.js";import"./CustomParametersMixin-BStBpako.js";import"./EditBusLayer-C6pLlK14.js";import"./FeatureEffectLayer-B3ucpbgh.js";import"./FeatureEffect-BXMKpemG.js";import"./FeatureFilter-BzdN7b7E.js";import"./FeatureReductionLayer-7Q3CJbxJ.js";import"./FeatureReductionSelection-Do1LXJh7.js";import"./labelingInfo-C8CHVUWS.js";import"./labelUtils-Cczy0uDR.js";import"./OperationalLayer-B61mRSes.js";import"./OrderedLayer-CfmzojSk.js";import"./OrderByInfo-Bn0SWspE.js";import"./PortalLayer-iKUPhGZB.js";import"./PortalItem-BuTU9OuN.js";import"./portalItemUtils-DIZSrm3T.js";import"./RefreshableLayer-B26jSd3d.js";import"./ScaleRangeLayer-CKYXLXxK.js";import"./TemporalLayer-D6vkocFU.js";import"./TimeInterval-CjSB1odC.js";import"./TimeInfo-Cq5mDY2W.js";import"./FeatureTemplate-BOr53vUa.js";import"./FeatureType-ByEWGsln.js";import"./fieldProperties-DJEV41A1.js";import"./versionUtils-ByKR3-oH.js";import"./styleUtils-BATHgMyw.js";import"./TopFeaturesQuery-BBItvyOE.js";import"./popupUtils-fsHWupnf.js";import"./interfaces-CL2NbQte.js";import"./capabilities-CAweHQni.js";import"./I3SIndexInfo-ByH-ZBj-.js";import"./I3SLayerDefinitions-DS-Kg5zK.js";import"./I3SUtil-vacVP6Bd.js";import"./spatialReferenceEllipsoidUtils-BL8s_3ls.js";import"./projectVectorToVector-Chzd0Pq0.js";import"./projectPointToVector-D3506wm2.js";import"./I3SBinaryReader-CtwiVPE4.js";import"./VertexAttribute-BnAa5VW0.js";import"./computeTranslationToOriginAndRotation-CLzktXYu.js";import"./edgeUtils-BIb6yRHm.js";import"./floatRGBA-C8rGFKJ0.js";import"./DecodeSymbolColor.glsl-CeBC4xQe.js";import"./interfaces-B8ge7Jg9.js";import"./NormalAttribute.glsl-Dqf1UPF9.js";import"./BindType-BmZEZMMh.js";import"./Float4DrawUniform-CWdxHXQ-.js";import"./orientedBoundingBox-COq6pSqo.js";import"./mat3-DRqs2t5W.js";import"./mat3f64-BBpwCtoL.js";import"./quat-ChS85qAG.js";import"./quatf64-BrpT0VRp.js";import"./ViewingMode-Dodu7ZZk.js";import"./vec2f64-Diu2Kaa8.js";import"./popupUtils-sb3Ob2mW.js";import"./RenderGeometry-CXcYvifi.js";import"./vec3f32-Cw9Q6TO_.js";import"./DoubleArray-CF_CpVBS.js";import"./Texture-CcsX4Ue_.js";import"./Util-BMqL_pkg.js";import"./enums-BlUEVwJR.js";import"./Texture-BbJIOVx_.js";import"./basicInterfaces-wONHx_SN.js";import"./vec2-B_ymkwGp.js";import"./ShaderTechniqueConfiguration-D3UbJ2mX.js";import"./doublePrecisionUtils-B0owpBza.js";import"./Indices-B6BGScAS.js";import"./Material-BN_i9QRJ.js";import"./triangle-B7rKLsGW.js";import"./renderState-PYzNpa1K.js";import"./requestImageUtils-DgB0_9qP.js";import"./ElevationProvider-BHZsEIDd.js";import"./verticalOffsetUtils-DaB1QvwW.js";import"./hydratedFeatures-Cy9DBeYQ.js";import"./frustum-DqmLJYYu.js";import"./axisAngleDegrees-CHCWDIqP.js";import"./weather-TVtZwW4o.js";import"./Scheduler-CDoWuxMK.js";import"./signal-DzOfzcfh.js";import"./debugFlags-B3L9P_UW.js";import"./NestedMap-DgiGbX8E.js";import"./mathUtils-kvswLROa.js";import"./Octree-DQVAqpsn.js";import"./InterleavedLayout-UIhsB8jd.js";import"./BufferView-B7Z-dzh4.js";import"./Intersector-CYIO18dt.js";import"./glUtil-C6KhMg1m.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./VertexArrayObject-Cwnso4un.js";import"./BufferObject-CjYoWxgZ.js";import"./interfaces-D6pIddIh.js";import"./ImageMaterial.glsl-RtQG_3xX.js";import"./VertexColor.glsl-lPkEAKYQ.js";import"./DefaultLayouts-Bz7P2wdj.js";import"./ColorMaterial.glsl-CJh1RTEZ.js";import"./LineVisualElement-CI_1KXfW.js";import"./Object3DVisualElement-439h3v21.js";import"./VisualElement-CT5Yhr5G.js";import"./RenderCoordsHelper-DgY-kqpV.js";import"./projectVectorToPoint-Cwe6B2HP.js";import"./elevationInfoUtils-Bl7QRRwv.js";import"./meshVertexSpaceUtils-CtidK-ZY.js";import"./MeshLocalVertexSpace-Xt9zU6DE.js";import"./EditGeometryOperations-BgVEmauk.js";import"./geometry2dUtils-BraNT6Fs.js";import"./triangulationUtils-D8OjVISe.js";import"./earcut-BqgeR2O3.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./deduplicate-DxTSMkFY.js";function pi(t){switch(t.type){case"building-scene":case"catalog":case"catalog-dynamic-group":case"catalog-footprint":case"csv":case"dimension":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"integrated-mesh-3dtiles":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"video":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return Ft(t.type),!1}}let _=class extends q{constructor(t){super(t),this._internalChange=!1,this._currentSlicePlane=null}initialize(){this.addHandles(this.analysis.excludedLayers.on("before-add",t=>{const i=t.item;i!=null&&(i instanceof J||i instanceof Dt)?i instanceof J&&pi(i)?(z.getLogger(this).error("excludedLayers",`Layer '${i.title}, id:${i.id}' of type '${i.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),t.preventDefault()):this.analysis.excludedLayers.includes(i)&&t.preventDefault():(z.getLogger(this).error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),t.preventDefault())})),ui(this.view,this),this.addHandles([y(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),y(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),y(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),y(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this.addHandles([y(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null,this._updateActiveController(),this._updateViewSlicePlane()),ci(this.view,this),this.set("view",null)}get _allLayerAndSubLayerViews(){const t=this.view.allLayerViews.items;return t.concat(t.filter(Et).flatMap(({sublayerViews:i})=>i.items))}_updateBoundedPlaneFromSlicePlane(){const t=this.analysis.shape,i=this._currentSlicePlane;if(i==null&&t==null||i!=null&&t!=null&&t.equals(i))return;let e=null,a=null;if((t==null?void 0:t.position)!=null){const s=t.position.spatialReference,n=Ct(t,this.view);n==null&&Bt(this.analysis,s,z.getLogger(this)),e=Tt(n,this.view,{tiltEnabled:this.analysis.tiltEnabled},d()),e!=null&&(a={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=e,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const t=this.analysisViewData.plane,i=lt(t,this.view,this.view.spatialReference,new rt);let e=null;i!=null&&(e={heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height}),this._currentSlicePlane=e,this._internalChange=!0,this.analysis.shape=i,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(A)return;const t=_t(this.view);if(t)if(this.analysisViewData.active)t.activeController!=null&&t.activeController!==this?(A=!0,t.activeController.analysisViewData.active=!1,A=!1):t.activeController!=null&&t.activeController,this._updateLayerViews(),t.activeController=this;else{if(t.activeController!=null&&t.activeController!==this)return;t.activeController!=null&&t.activeController===this&&(t.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){hi(this.view)}_updateLayerViews(){const t=this.analysisViewData.plane!=null&&this.analysisViewData.visible&&this.analysisViewData.active,i=[],e=a=>{"layers"in a?a.layers.forEach(e):i.push(a)};this.analysis.excludedLayers.forEach(e),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=t&&!i.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=t&&!i.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=t&&!this.analysis.excludeGroundSurface)}};r([l()],_.prototype,"view",void 0),r([l()],_.prototype,"analysis",void 0),r([l()],_.prototype,"analysisViewData",void 0),r([l()],_.prototype,"_allLayerAndSubLayerViews",null),_=r([H("esri.views.3d.analysis.Slice.SliceController")],_);const g=new Map;let A=!1;function hi(t){const i=_t(t),e=i==null?void 0:i.activeController;(e==null?void 0:e.analysisViewData.plane)!=null&&e.analysisViewData.visible?t.slicePlane=e.analysisViewData.plane:t.slicePlane=null}function ui(t,i){var e;g.has(t)||g.set(t,{all:[],activeController:null}),(e=g.get(t))==null||e.all.push(i)}function _t(t){return g.get(t)}function ci(t,i){if(!g.has(t))throw new Error("view expected in global slice register");const e=g.get(t),a=(e==null?void 0:e.all.lastIndexOf(i))??-1;if(!e||a===-1)throw new Error("controller expected in global slice register");e.all.splice(a,1),e.all.length===0&&g.delete(t)}var N;let h=N=class extends si{constructor(t){super(t),this._clock=ft,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this._layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._frameTask=null,this._pointerMoveTimerMs=Xt,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=d(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=Kt(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=ni(t.view.state.viewingMode)}initialize(){var p;if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");const t=o=>{this._updateManipulatorsInteractive(o),o.grabbing||(this.analysisViewData.plane!=null&&u(this.analysisViewData.plane,this._startPlane),this.inputState=null)},i=new St(this.view,xt.CENTER_ON_ARROW);this.shiftManipulator=i,this.manipulators.add(i),this.addHandles([this._createShiftDragPipeline(i),i.events.on("grab-changed",o=>{this._onShiftGrab(o),t(i)})]);const e=!((p=this.view._stage)!=null&&p.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result),a=new Q(this.view,(o,v)=>Jt(this.view.textures,{accentColor:o,contrastColor:v,preMultiplyAlpha:e}));this.rotateHeadingManipulator=a,this.manipulators.add(a),this.addHandles([this._createRotateHeadingDragPipeline(a),a.events.on("grab-changed",o=>{this._onRotateHeadingGrab(o),t(a)})]);const s=new Q(this.view,(o,v)=>Qt(this.view.textures,{accentColor:o,contrastColor:v,preMultiplyAlpha:e}));this.rotateTiltManipulator=s,this.manipulators.add(s),this.addHandles([this._createRotateTiltDragPipeline(s),s.events.on("grab-changed",o=>{this._onRotateTiltGrab(o),t(s)})]),this.resizeManipulators=this._resizeHandles.map((o,v)=>{const P=new $t(this.view,o);return this.addHandles([this._createResizeDragPipeline(P),P.events.on("grab-changed",b=>{this._onResizeGrab(b,v),t(P)})]),P}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=ot(this.view),this._previewPlaneOutlineVisualElement=pt(this.view),this._previewPlaneOutlineVisualElement.width=wt,this.addHandles(y(()=>[this.analysisViewData.plane,this.analysis.tiltEnabled],()=>this._updateManipulators(),Mt));const n=y(()=>this.state,o=>{o==="sliced"&&this.finishToolCreation()},F);this.addHandles([n,y(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=V(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=V(this._previewPlaneGridVisualElement)}get state(){const t=!!this.analysisViewData.plane,i=!!this.inputState;return t?t&&i?"slicing":t&&!i?"sliced":"ready":"ready"}get cursor(){return this._isPlacingSlicePlane||this.layersMode==="exclude"?"crosshair":this._creatingPointerId!=null?"grabbing":null}set analysis(t){if(t==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.removeHandles("analysis"),this._set("analysis",t)}get layersMode(){return this._layersMode}get inputState(){return this._get("inputState")}set inputState(t){this._set("inputState",t),this.analysisViewData.showGrid=t!=null&&t.type==="resize",this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.analysisViewData.plane&&this.active}get _creatingPointerId(){return this.inputState!=null&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){this.analysisViewData.plane!=null&&(this._layersMode="exclude",this.active||(this.view.activeTool=this))}exitExcludeLayerMode(){this.analysisViewData.plane!=null&&(this._layersMode="none",this.active&&(this.view.activeTool=null))}onDeactivate(){this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(t){this._updateManipulators(),t||this._clearPointerMoveTimeout()}onInputEvent(t){switch(t.type){case"pointer-drag":if(!B(t))return;this._isPlacingSlicePlane?this._onClickPlacePlane(t)&&t.stopPropagation():this._onPointerDrag(t)&&t.stopPropagation();break;case"pointer-move":this._onPointerMove(t);break;case"pointer-up":this._onPointerUp(t)&&t.stopPropagation();break;case"immediate-click":if(!B(t))return;this._onClickPlacePlane(t)&&t.stopPropagation();break;case"click":if(!B(t))return;this._onClickExcludeLayer(t)&&t.stopPropagation();break;case"drag":this.inputState&&t.stopPropagation();break;case"key-down":this._onKeyDown(t)&&t.stopPropagation();break;case"key-up":this._onKeyUp(t)&&t.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(t){const i=this.inputState;if(t.pointerId===this._creatingPointerId&&i!=null&&i.type==="shift"){const e=D(t);return this.shiftManipulator.events.emit("drag",{action:i.hasBeenDragged?"update":"start",pointerType:t.pointerType,start:e,screenPoint:e}),i.hasBeenDragged=!0,!0}return!1}_onPointerMove(t){this._lastCursorPosition.x=t.x,this._lastCursorPosition.y=t.y,this._resetPointerMoveTimeout(),t.pointerType!=="touch"&&this._updatePreviewPlane(D(t),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(t){if(t.pointerId===this._creatingPointerId&&this.analysisViewData.plane!=null){const i=D(t);return this.shiftManipulator.events.emit("drag",{action:"end",start:i,screenPoint:i}),u(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(t){if(this.layersMode==="exclude")return!1;if(this._isPlacingSlicePlane){const i=D(t),e=d();if(this._pickPlane(i,!1,this._activeKeyModifiers,e)){if(t.type==="pointer-drag"){const a=M(this.view.state.camera,i,E);this.inputState=nt(a,t.pointerId,e.origin,e)}return u(e,this._startPlane),this.analysis.shape=lt(e,this.view,this.view.spatialReference,new rt),!0}}return!1}_onClickExcludeLayer(t){return!(this.layersMode!=="exclude"||!this.created)&&(this.view.hitTest(D(t)).then(i=>{if(i.results.length){const e=i.results[0],a=(e==null?void 0:e.type)==="graphic"&&e.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else i.ground.layer?this.analysis.excludedLayers.push(i.ground.layer):this.analysis.excludeGroundSurface=!0}),this.exitExcludeLayerMode(),!0)}_onKeyDown(t){return(t.key===G||t.key===I)&&(this._activeKeyModifiers[t.key]=!0,this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(t){return!(t.key!==G&&t.key!==I||!this._activeKeyModifiers[t.key])&&(delete this._activeKeyModifiers[t.key],this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const i=M(this.view.state.camera,t.screenPoint,E);u(this.analysisViewData.plane,this._startPlane),this.inputState=nt(i,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(t){return k(t,(i,e,a)=>{const s=this.inputState;if(s==null||s.type!=="shift")return;const n=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;e.next($(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{n!=null&&this._updateBoundedPlane(n)})})}_shiftDragAdjustSensitivity(t){return i=>{if(this.analysisViewData.plane==null)return null;const e=.001,a=Math.min((1-Math.abs(x(K(this.analysisViewData.plane),i.ray.direction)/C(i.ray.direction)))/e,1),s=-st(this._startPlane.plane,i.renderEnd),n=-st(this._startPlane.plane,t.startPoint);return t.depth=t.depth*(1-a)+s*a-n,i}}_shiftDragUpdatePlane(t){return()=>{if(this.analysisViewData.plane==null)return;const i=tt(c.get(),this._startPlane.origin),e=tt(c.get(),K(this._startPlane));O(e,e,-t.depth),it(e,e,i);const a=W(e,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,d());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const i=X(this.analysisViewData.plane,this.view.renderCoordsHelper,Y.HEADING,j()),e=M(this.view.state.camera,t.screenPoint,E),a=U();L(i,e,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:i,startPoint:a})}_createRotateHeadingDragPipeline(t){return k(t,(i,e,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const n=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;e.next($(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{n!=null&&this._updateBoundedPlane(n)})})}_onRotateTiltGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const i=X(this.analysisViewData.plane,this.view.renderCoordsHelper,Y.TILT,j()),e=M(this.view.state.camera,t.screenPoint,E),a=U();L(i,e,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:i,startPoint:a})}_createRotateTiltDragPipeline(t){return k(t,(i,e,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const n=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;e.next($(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{n!=null&&this._updateBoundedPlane(n)})})}_rotateDragRenderPlaneToRotate(t){return i=>{if(this.analysisViewData.plane==null)return null;const e=R(t.rotatePlane),a=ai(t.startPoint,i.renderEnd,this.analysisViewData.plane.origin,e);return{...i,rotateAxis:e,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return t=>{if(this.analysisViewData.plane==null)return;const i=jt(T.get(),t.rotateAngle,t.rotateAxis);if(i==null)return;const e=et(c.get(),this._startPlane.basis1,i),a=et(c.get(),this._startPlane.basis2,i),s=W(this.analysisViewData.plane.origin,e,a,d());this._updateBoundedPlane(s)}}_onResizeGrab(t,i){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const e=M(this.view.state.camera,t.screenPoint,E),a=c.get();L(this.analysisViewData.plane.plane,e,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:i,startPoint:Nt(a)})}_createResizeDragPipeline(t){return k(t,(i,e,a)=>{const s=this.inputState;if(s==null||s.type!=="resize"||this.analysisViewData.plane==null)return;const n=u(this.analysisViewData.plane,d());e.next($(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(n)})})}_resizeDragUpdatePlane(t){return i=>{if(this.analysisViewData.plane==null)return;const e=this._resizeHandles[t.activeHandleIdx],a=kt(e,t.startPoint,i.renderEnd,this.view.state.camera,this._startPlane,u(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(t){const i=this.analysisViewData;if(i==null)throw new Error("valid internal object expected");i.plane=t}_updatePreviewPlane(t,i={}){let e=this._previewPlane;if(this._previewPlane=null,t==null)return this._removeFrameTask(),void this._updateManipulators();if(!this.analysisViewData.plane&&this.active){const a=e??d();if(e=e!=null?u(e,mi):null,this._pickPlane(t,!0,i,a)){const s=ti;let n=!1;e!=null&&(n=x(R(e.plane),R(a.plane))<s||x(at(c.get(),e.basis1),at(c.get(),a.basis1))<s),n&&(this._previewPlaneOpacity=0),this._previewPlane=a}}this._previewPlane!=null&&this._frameTask==null&&this._previewPlaneOpacity===0?this._frameTask=Vt({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*Yt),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):this._previewPlane==null&&this._frameTask!=null?this._removeFrameTask():this._previewPlane!=null&&this._updateManipulators()}_removeFrameTask(){this._frameTask=Z(this._frameTask)}_pickMinResult(t){const i=Ut(t,Zt.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector),this._intersector.results.min}_pickPlane(t,i,e,a){const s=this._pickMinResult(t),n=c.get();if(!s.getIntersectionPoint(n))return!1;const p=s.getTransformedNormal(c.get()),o=this.view.state.camera;x(p,o.viewForward)>0&&O(p,p,-1);const v=Lt(n,o),P=(i?1:-1)*v*ii,b=O(c.get(),p,P);it(b,b,n);const gt=this.analysis.tiltEnabled?S.TILTED:S.HORIZONTAL_OR_VERTICAL,Pt=e[G]?S.VERTICAL:e[I]?S.HORIZONTAL:gt;return Ht(b,p,v,v,o,Pt,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Z(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=f,this.rotateHeadingManipulator.state|=f,this.rotateTiltManipulator.state|=f,this._prevPointerMoveTimeout=this._clock.setTimeout(()=>{this.shiftManipulator.state&=~f,this.rotateHeadingManipulator.state&=~f,this.rotateTiltManipulator.state&=~f},this._pointerMoveTimerMs)}_updateManipulators(){if(N.disableEngineLayers)return;let t,i=!1;if(this.analysisViewData.plane!=null)t=this.analysisViewData.plane,i=!1;else{if(this._previewPlane==null)return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(p=>p.available=!1),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);t=this._previewPlane,i=!0}const e=ht(t,T.get());i?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(p=>p.available=!1),this._previewPlaneOutlineVisualElement.attached=!0,this._previewPlaneGridVisualElement.attached=!0,this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.analysis.tiltEnabled,this.resizeManipulators.forEach(p=>p.available=!0),zt(this.shiftManipulator,e,t,this.view.state.camera),Ot(this.rotateHeadingManipulator,e,t,this.view.renderCoordsHelper),Rt(this.rotateTiltManipulator,e,t),this.resizeManipulators.forEach((p,o)=>Gt(p,this._resizeHandles[o],e,t)),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=yt(c.get(),C(t.basis1),C(t.basis2),1),s=dt(T.get(),a),n=mt(s,e,s);this._previewPlaneOutlineVisualElement.transform=n,this._previewPlaneGridVisualElement.transform=n,this._updateMaterials()}_updateMaterials(){const t=ut(this.view.effectiveTheme);t[3]*=this._previewPlaneOpacity;const i=qt(ct);i[3]*=this._previewPlaneOpacity,this._previewPlaneOutlineVisualElement.color=t,this._previewPlaneGridVisualElement.backgroundColor=i,this._previewPlaneGridVisualElement.gridColor=vt}_updateManipulatorsInteractive(t){if(!t.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(i=>{i.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===t,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===t,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===t,this.resizeManipulators.forEach(i=>{i.interactive=i===t})}testData(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:t=>{this._pointerMoveTimerMs=t}}}};h.disableEngineLayers=!1,r([l()],h.prototype,"_clock",void 0),r([l({constructOnly:!0})],h.prototype,"view",void 0),r([l()],h.prototype,"analysisViewData",void 0),r([l({readOnly:!0})],h.prototype,"state",null),r([l({readOnly:!0})],h.prototype,"cursor",null),r([l()],h.prototype,"analysis",null),r([l()],h.prototype,"removeIncompleteOnCancel",void 0),r([l()],h.prototype,"_layersMode",void 0),r([l()],h.prototype,"layersMode",null),r([l({value:null})],h.prototype,"inputState",null),r([l()],h.prototype,"_isPlacingSlicePlane",null),r([l()],h.prototype,"_creatingPointerId",null),h=N=r([H("esri.views.3d.analysis.Slice.SliceTool")],h);const di=h;function nt(t,i,e,a){const s=It(e,K(a),t.direction,j()),n=U();return L(s,t,n)?{type:"shift",creatingPointerId:i,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:n}:null}function B(t){return t.pointerType!=="mouse"||t.button===0}const mi=d(),E=Wt();let w=class extends q{constructor(t){super(t),this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const t=this.analysisViewData;if(t==null)throw new Error("expected internal object to be valid");this._gridVisualElement=ot(this.view),this._outlineVisualElement=pt(this.view),this.addHandles([y(()=>{const i=t.plane!=null&&this.analysisViewData.visible,{active:e}=this.analysisViewData,{preview:a,showGrid:s,view:n}=this,{effectiveTheme:p}=n;return{visible:i,active:e,preview:a,showGrid:s,gridColor:At(p),outlineColor:ut(p)}},i=>this._updateMaterials(i),F),y(()=>t.plane,i=>this._updatePlane(i),F)],"internal")}destroy(){this._gridVisualElement=V(this._gridVisualElement),this._outlineVisualElement=V(this._outlineVisualElement),this.set("view",null)}_updatePlane(t){if(t==null)return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const i=yt(c.get(),C(t.basis1),C(t.basis2),1),e=dt(T.get(),i),a=ht(t,T.get()),s=mt(e,a,e);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:t,active:i,preview:e,showGrid:a,gridColor:s,outlineColor:n}){this._outlineVisualElement.color=n,this._outlineVisualElement.width=e?wt:ei,this._outlineVisualElement.stipplePattern=i?null:ri(5),this._gridVisualElement.backgroundColor=ct,this._gridVisualElement.gridColor=a?s:vt,this._gridVisualElement.visible=t,this._outlineVisualElement.visible=t}};r([l()],w.prototype,"view",void 0),r([l()],w.prototype,"analysis",void 0),r([l()],w.prototype,"analysisViewData",void 0),r([l()],w.prototype,"showGrid",void 0),r([l()],w.prototype,"preview",void 0),w=r([H("esri.views.3d.analysis.Slice.SliceVisualization")],w);let m=class extends bt(q){constructor(t){super(t),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0}initialize(){this.analysisVisualization=new w({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new _({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(li(this,di))}destroy(){oi(this),this.analysisVisualization=V(this.analysisVisualization),this.analysisController=V(this.analysisController)}get showGrid(){var t;return((t=this.analysisVisualization)==null?void 0:t.showGrid)??!1}set showGrid(t){this.analysisVisualization&&(this.analysisVisualization.showGrid=t)}get editable(){return!this.analysisVisualization.preview}set editable(t){this.analysisVisualization.preview=!t}get testData(){}};r([l({readOnly:!0})],m.prototype,"type",void 0),r([l({constructOnly:!0,nonNullable:!0})],m.prototype,"analysis",void 0),r([l()],m.prototype,"tool",void 0),r([l()],m.prototype,"plane",void 0),r([l()],m.prototype,"active",void 0),r([l()],m.prototype,"showGrid",null),r([l()],m.prototype,"editable",null),m=r([H("esri.views.3d.analysis.SliceAnalysisView3D")],m);const Bn=m;export{Bn as default};
