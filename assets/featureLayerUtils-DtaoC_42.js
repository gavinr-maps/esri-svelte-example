import{J as j,Q as G,O as z,c as u}from"./subclass-BR3PhgZG.js";import{i as L}from"./originUtils-D69mHv66.js";import{$ as B,w as x,I as N,v as O,j as Q,y as V,P as k,l as g,d as q,c as I}from"./utils-1QwwZNj1.js";import{d as f}from"./arcgisLayerUrl-Cgl5IQFD.js";import{t as C,a as H,i as W}from"./lazyLayerLoader-syOvjMPz.js";import{L as X}from"./layerUtils-erzwAANv.js";import{l as J,a as T,f as p,u as $,i as b}from"./portalItemUtils-DIZSrm3T.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./Portal-liet8xHC.js";import"./index-CeCSsEgo.js";import"./Evented-CXIxDjmW.js";import"./Accessor-D6mNnsWy.js";import"./assets-C2mb-ea2.js";import"./Promise-CZrWwByK.js";import"./jsonMap-DCC6W5ex.js";import"./writer-3zufXUNV.js";import"./Extent-DHjqVB-p.js";import"./Point-DB4Hp4hH.js";import"./PortalItem-BuTU9OuN.js";import"./persistableUrlUtils-BcifXQ1Z.js";import"./jsonContext-9yrMdsS4.js";import"./saveAPIKeyUtils--6vvrYdZ.js";import"./saveUtils-BlgyRdsU.js";import"./requestPresets-FP_1qvJ2.js";import"./projection-A9yUaaTs.js";import"./reactiveUtils-BFQ0BtrB.js";import"./shared-B3wH2qpO.js";import"./mathUtils-ClvKsMak.js";import"./Polyline-D97hl-6E.js";import"./projectBuffer-vsa0P_cF.js";import"./geodesicConstants-XRAvAZCD.js";const h="Feature Service",w="feature-layer-utils",Z=`${w}-save`,aa=`${w}-save-as`,m=`${w}-saveall`,y=`${w}-saveall-as`;function v(a){return{isValid:X(a)&&(a.type!=="feature"||!a.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function M(a){const t=[],e=[];for(const{layer:r,layerJSON:s}of a)r.isTable?e.push(s):t.push(s);return{layers:t,tables:e}}function R(a){return M([a])}async function D(a,t){return/\/\d+\/?$/.test(a.url)?R(t[0]):F(t,a)}async function F(a,t){if(a.reverse(),!t)return M(a);const e=await ta(t,a);for(const r of a)U(r.layer,r.layerJSON,e);return oa(e,a),e}async function ta(a,t){let e=await a.fetchData("json");if(ea(e))return e;e||(e={}),ra(e);const{layer:{url:r,customParameters:s,apiKey:n}}=t[0];return await na(e,{url:r??"",customParameters:s,apiKey:n},t.map(o=>o.layer.layerId)),e}function ea(a){return!!(a&&Array.isArray(a.layers)&&Array.isArray(a.tables))}function ra(a){a.layers||(a.layers=[]),a.tables||(a.tables=[])}function oa(a,t){const e=[],r=[];for(const{layer:s}of t){const{isTable:n,layerId:o}=s;n?r.push(o):e.push(o)}A(a.layers,e),A(a.tables,r)}function A(a,t){if(a.length<2)return;const e=[];for(const{id:r}of a)e.push(r);j(e.sort(P),t.slice().sort(P))&&a.sort((r,s)=>{const n=t.indexOf(r.id),o=t.indexOf(s.id);return n<o?-1:n>o?1:0})}function P(a,t){return a<t?-1:a>t?1:0}async function na(a,t,e){const{url:r,customParameters:s,apiKey:n}=t,{serviceJSON:o,layersJSON:i}=await C(r,{customParameters:s,apiKey:n}),l=S(a.layers,o.layers,e),c=S(a.tables,o.tables,e);a.layers=l.itemResources,a.tables=c.itemResources;const d=[...l.added,...c.added],_=i?[...i.layers,...i.tables]:[];await sa(a,d,r,_)}function S(a,t,e){const r=G(a,t,(n,o)=>n.id===o.id);a=a.filter(n=>!r.removed.some(o=>o.id===n.id));const s=r.added;return s.forEach(({id:n})=>{a.push({id:n})}),{itemResources:a,added:s.filter(({id:n})=>!e.includes(n))}}async function sa(a,t,e,r){const s=await ia(t),n=t.map(({id:o,type:i})=>new(s.get(i))({url:e,layerId:o,sourceJSON:r.find(({id:l})=>l===o)}));await Promise.allSettled(n.map(o=>o.load())),n.forEach(o=>{const{layerId:i,loaded:l,defaultPopupTemplate:c}=o;if(!l||c==null)return;const d={id:i,popupInfo:c.toJSON()};o.operationalLayerType!=="ArcGISFeatureLayer"&&(d.layerType=o.operationalLayerType),U(o,d,a)})}async function ia(a){const t=[];a.forEach(({type:s})=>{const n=W(s),o=H[n];t.push(o())});const e=await Promise.all(t),r=new Map;return a.forEach(({type:s},n)=>{r.set(s,e[n])}),r}function U(a,t,e){a.isTable?E(e.tables,t):E(e.layers,t)}function E(a,t){const e=a.findIndex(({id:r})=>r===t.id);e===-1?a.push(t):a[e]=t}function K(a,t){if(!a.length)throw new u(`${t}:missing-parameters`,"'layers' array should contain at least one feature layer")}function la(a,t){const e=a.map(r=>r.portalItem.id);if(new Set(e).size>1)throw new u(`${t}:invalid-parameters`,"All layers in the 'layers' array should be loaded from the same portal item")}function Y(a,t){const e=a.map(r=>r.layerId);if(new Set(e).size!==e.length)throw new u(`${t}:invalid-parameters`,"'layers' array should contain only one instance each of layer or table in a feature service")}async function ca(a){K(a,m),await Promise.all(a.map(t=>t.load()));for(const t of a)g(t,m,v),q({layer:t,itemType:h,errorNamePrefix:m});la(a,m),Y(a,m)}async function pa(a,t){const{url:e,layerId:r,title:s,fullExtent:n,isTable:o}=a,i=f(e);t.url=((i==null?void 0:i.serverType)==="FeatureServer"?e:`${e}/${r}`)??null,t.title||(t.title=s),t.extent=null,o||n==null||(t.extent=await J(n)),T(t,p.METADATA),T(t,p.MULTI_LAYER),b(t,p.SINGLE_LAYER),o&&b(t,p.TABLE)}function ua(a,t){for(const n of a){const o=n.parsedUrl.path,i=f(o);if(!(i==null?void 0:i.url.path))throw new u(`${t}:invalid-parameters`,I(n,`has unsupported url pattern: ${o}`),{layer:n});const c=i==null?void 0:i.serverType;if(c!=="FeatureServer"&&c!=="MapServer")throw new u(`${t}:invalid-parameters`,I(n,`has unsupported server type: ${c}`),{layer:n});if(c==="MapServer"&&a.length>1)throw new u(`${t}:invalid-parameters`,"Only one layer or table in a map service can be saved")}const e=f(a[0].parsedUrl.path),r=e==null?void 0:e.url.path;if(!a.every(n=>{const o=f(n.parsedUrl.path);return(o==null?void 0:o.url.path)===r}))throw new u(`${t}:invalid-parameters`,"'layers' array should only contain layers or tables that belong to the same feature service")}async function ma(a){K(a,y),await Promise.all(a.map(t=>t.load()));for(const t of a)g(t,y,v);ua(a,y),Y(a,y)}async function ya(a,t){let e=0,r=0;for(const{isTable:o}of t)o?r++:e++;const s=t[0].parsedUrl.path,n=f(s);if(a.url=(n==null?void 0:n.serverType)==="FeatureServer"?n.url.path:s,a.title||(a.title=n.title),a.extent=null,e>0){const o=t.map(i=>i.fullExtent).filter(z).reduce((i,l)=>i.clone().union(l));o&&(a.extent=await J(o))}T(a,p.METADATA),$(a,p.MULTI_LAYER,t.length>1),$(a,p.SINGLE_LAYER,t.length===1),$(a,p.TABLE,r>0&&e===0),O(a)}async function Qa(a,t){return B({layer:a,itemType:h,validateLayer:v,createItemData:(e,r)=>D(r,[e]),errorNamePrefix:Z},t)}async function Va(a,t){await ca(a);const e=a[0].portalItem,r=x(e),s=await Promise.all(a.map(o=>N(o,r,t))),n=await D(e,a.map((o,i)=>({layer:o,layerJSON:s[i]})));return O(e),await e.update({data:n}),await Promise.all(a.slice(1).map(o=>o.portalItem.reload())),L(r),e.clone()}async function ka(a,t,e){return Q({layer:a,itemType:h,validateLayer:v,createItemData:(r,s)=>Promise.resolve(R(r)),errorNamePrefix:aa,newItem:t,setItemProperties:pa},e)}async function qa(a,t,e){await ma(a);const r=V({itemType:h,errorNamePrefix:y,newItem:t}),s=x(r),n=await Promise.all(a.map(i=>N(i,s,e))),o=await F(a.map((i,l)=>({layer:i,layerJSON:n[l]})));await ya(r,a),await k(r,o,e);for(const i of a)i.portalItem=r.clone();return L(s),r}export{Qa as save,Va as saveAll,qa as saveAllAs,ka as saveAs};
