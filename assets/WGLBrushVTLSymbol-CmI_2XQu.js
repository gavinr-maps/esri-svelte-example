import{i as q}from"./mathUtils-Cfq9PL9W.js";import{e as ee}from"./DefaultUI-BwWVKFUS.js";import{a as te}from"./DefaultVertexAttributeLayouts-wSIZdMhB.js";import{Z as w,_ as H,$ as B}from"./definitions-CP59Y04S.js";import{E as ae,o as ie}from"./BufferObject-BJilD_hc.js";import{L as k,O,E as N,F as ne,C as b}from"./enums-D9v74xTE.js";import{r as G,l as A,n as Y}from"./StyleDefinition-C2Flw6Qv.js";import{n as re,t as se}from"./vec2f32-BbH2jxlN.js";import{e as Q}from"./config-BOD8--da.js";let F=class{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(i,t){}draw(i,t,e){}drawMany(i,t,e){for(const n of t)n.visible&&this.draw(i,n,e)}},Ue=class extends F{constructor(){super(...arguments),this._color=te(1,0,0,1),this._patternMatrix=ee(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(i,t){const{context:e,painter:n,requestRender:l,allowDelayedRender:_}=i;this._loadWGLResources(i);const c=i.displayLevel,s=i.styleLayer,h=s.backgroundMaterial,d=n.vectorTilesMaterialManager,P=s.getPaintValue("background-color",c),p=s.getPaintValue("background-opacity",c),S=s.getPaintValue("background-pattern",c),y=S!==void 0,v=1|window.devicePixelRatio,M=i.spriteMosaic;let x,U;const f=v>H?2:1,g=this._programOptions;g.pattern=y;const r=d.getMaterialProgram(e,h,g);if(!_||l==null||r.compiled){if(e.bindVAO(this._vao),e.useProgram(r),y){const a=M.getMosaicItemPosition(S,!0);if(a!=null){const{tl:u,br:m,page:o}=a;x=m[0]-u[0],U=m[1]-u[1];const T=M.getPageSize(o);T!=null&&(M.bind(e,k.LINEAR,o,w),r.setUniform4f("u_tlbr",u[0],u[1],m[0],m[1]),r.setUniform2fv("u_mosaicSize",T),r.setUniform1i("u_texture",w))}r.setUniform1f("u_opacity",p)}else{const a=P[3]*p;this._color[0]=a*P[0],this._color[1]=a*P[1],this._color[2]=a*P[2],this._color[3]=a,r.setUniform4fv("u_color",this._color)}r.setUniform1f("u_depth",s.z||0);for(const a of t){if(r.setUniform1f("u_coord_range",a.rangeX),r.setUniformMatrix3fv("u_dvsMat3",a.transforms.displayViewScreenMat3),y){const u=Math.max(2**(Math.round(c)-a.key.level),1),m=f*a.width*u,o=m/q(x),T=m/q(U);this._patternMatrix[0]=o,this._patternMatrix[4]=T,r.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}e.setStencilFunction(O.EQUAL,0,255),e.drawArrays(N.TRIANGLE_STRIP,0,4)}}else l()}_loadWGLResources(i){if(this._vao)return;const{context:t,styleLayer:e}=i,n=e.backgroundMaterial,l=new Int8Array([0,0,1,0,0,1,1,1]),_=ae.createVertex(t,ne.STATIC_DRAW,l),c=new ie(t,n.getAttributeLocations(),n.getLayoutInfo(),new Map([["geometry",_]]));this._vao=c}};class ve extends F{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(i,t){const{context:e,displayLevel:n,requiredLevel:l,state:_,painter:c,spriteMosaic:s,styleLayerUID:h,requestRender:d,allowDelayedRender:P}=i;if(!t.some(r=>{var a;return((a=r.layerData.get(h))==null?void 0:a.circleIndexCount)??!1}))return;const p=i.styleLayer,S=p.circleMaterial,y=c.vectorTilesMaterialManager,v=1.2,M=p.getPaintValue("circle-translate",n),x=p.getPaintValue("circle-translate-anchor",n),U=this._programOptions,f=y.getMaterialProgram(e,S,U);if(P&&d!=null&&!f.compiled)return void d();e.useProgram(f),f.setUniformMatrix3fv("u_displayMat3",x===G.VIEWPORT?_.displayMat3:_.displayViewMat3),f.setUniform2fv("u_circleTranslation",M),f.setUniform1f("u_depth",p.z),f.setUniform1f("u_antialiasingWidth",v);let g=-1;for(const r of t){if(!r.layerData.has(h))continue;r.key.level!==g&&(g=r.key.level,S.setDataUniforms(f,n,p,g,s));const a=r.layerData.get(h);if(!a.circleIndexCount)continue;a.prepareForRendering(e);const u=a.vao;u!=null&&(e.bindVAO(u),f.setUniformMatrix3fv("u_dvsMat3",r.transforms.displayViewScreenMat3),l!==r.key.level?e.setStencilFunction(O.EQUAL,r.stencilRef,255):e.setStencilFunction(O.GREATER,255,255),e.drawElements(N.TRIANGLES,a.circleIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.circleIndexStart),r.triangleCount+=a.circleIndexCount/3)}}}const X=1/65536;class xe extends F{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(i,t){const{displayLevel:e,renderPass:n,spriteMosaic:l,styleLayerUID:_}=i;let c=!1;for(const f of t)if(f.layerData.has(_)){const g=f.layerData.get(_);if(g.fillIndexCount>0||g.outlineIndexCount>0){c=!0;break}}if(!c)return;const s=i.styleLayer,h=s.getPaintProperty("fill-pattern"),d=h!==void 0,P=d&&h.isDataDriven;let p;if(d&&!P){const f=h.getValue(e);p=l.getMosaicItemPosition(f,!0)}const S=!d&&s.getPaintValue("fill-antialias",e);let y=!0,v=1;if(!d){const f=s.getPaintProperty("fill-color"),g=s.getPaintProperty("fill-opacity");if(!(f!=null&&f.isDataDriven)&&!(g!=null&&g.isDataDriven)){const r=s.getPaintValue("fill-color",e);v=s.getPaintValue("fill-opacity",e)*r[3],v>=1&&(y=!1)}}if(y&&n==="opaque")return;const M=s.getPaintValue("fill-translate",e),x=s.getPaintValue("fill-translate-anchor",e);(y||n!=="translucent")&&this._drawFill(i,_,s,t,M,x,d,p,P);const U=!s.hasDataDrivenOutlineColor&&s.outlineUsesFillColor&&v<1;S&&n!=="opaque"&&!U&&this._drawOutline(i,_,s,t,M,x)}_drawFill(i,t,e,n,l,_,c,s,h){if(c&&!h&&s==null)return;const{context:d,displayLevel:P,state:p,painter:S,pixelRatio:y,spriteMosaic:v,requestRender:M,allowDelayedRender:x}=i,U=e.fillMaterial,f=S.vectorTilesMaterialManager,g=y>H?2:1,r=this._fillProgramOptions;r.pattern=c;const a=f.getMaterialProgram(d,U,r);if(x&&M!=null&&!a.compiled)return void M();if(d.useProgram(a),s!=null){const{page:m}=s,o=v.getPageSize(m);o!=null&&(v.bind(d,k.LINEAR,m,w),a.setUniform2fv("u_mosaicSize",o),a.setUniform1i("u_texture",w))}a.setUniformMatrix3fv("u_displayMat3",_===G.VIEWPORT?p.displayMat3:p.displayViewMat3),a.setUniform2fv("u_fillTranslation",l),a.setUniform1f("u_depth",e.z+X);let u=-1;for(const m of n){if(!m.layerData.has(t))continue;m.key.level!==u&&(u=m.key.level,U.setDataUniforms(a,P,e,u,v));const o=m.layerData.get(t);if(!o.fillIndexCount)continue;o.prepareForRendering(d);const T=o.fillVAO;if(T!=null){if(d.bindVAO(T),a.setUniformMatrix3fv("u_dvsMat3",m.transforms.displayViewScreenMat3),d.setStencilFunction(O.EQUAL,m.stencilRef,255),c){const E=Math.max(2**(Math.round(P)-m.key.level),1),R=m.rangeX/(g*m.width*E);a.setUniform1f("u_patternFactor",R)}if(h){const E=o.patternMap;if(!E)continue;for(const[R,D]of E){const z=v.getPageSize(R);z!=null&&(v.bind(d,k.LINEAR,R,w),a.setUniform2fv("u_mosaicSize",z),a.setUniform1i("u_texture",w),d.drawElements(N.TRIANGLES,D[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*D[0]))}}else d.drawElements(N.TRIANGLES,o.fillIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*o.fillIndexStart);m.triangleCount+=o.fillIndexCount/3}}}_drawOutline(i,t,e,n,l,_){const{context:c,displayLevel:s,state:h,painter:d,pixelRatio:P,spriteMosaic:p,requestRender:S,allowDelayedRender:y}=i,v=e.outlineMaterial,M=d.vectorTilesMaterialManager,x=.75/P,U=this._outlineProgramOptions,f=M.getMaterialProgram(c,v,U);if(y&&S!=null&&!f.compiled)return void S();c.useProgram(f),f.setUniformMatrix3fv("u_displayMat3",_===G.VIEWPORT?h.displayMat3:h.displayViewMat3),f.setUniform2fv("u_fillTranslation",l),f.setUniform1f("u_depth",e.z+X),f.setUniform1f("u_outline_width",x);let g=-1;for(const r of n){if(!r.layerData.has(t))continue;r.key.level!==g&&(g=r.key.level,v.setDataUniforms(f,s,e,g,p));const a=r.layerData.get(t);if(a.prepareForRendering(c),!a.outlineIndexCount)continue;const u=a.outlineVAO;u!=null&&(c.bindVAO(u),f.setUniformMatrix3fv("u_dvsMat3",r.transforms.displayViewScreenMat3),c.setStencilFunction(O.EQUAL,r.stencilRef,255),c.drawElements(N.TRIANGLES,a.outlineIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.outlineIndexStart),r.triangleCount+=a.outlineIndexCount/3)}}}class Ie extends F{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(i,t){const{context:e,displayLevel:n,state:l,painter:_,pixelRatio:c,spriteMosaic:s,styleLayerUID:h,requestRender:d,allowDelayedRender:P}=i;if(!t.some(E=>{var R;return((R=E.layerData.get(h))==null?void 0:R.lineIndexCount)??!1}))return;const p=i.styleLayer,S=p.lineMaterial,y=_.vectorTilesMaterialManager,v=p.getPaintValue("line-translate",n),M=p.getPaintValue("line-translate-anchor",n),x=p.getPaintProperty("line-pattern"),U=x!==void 0,f=U&&x.isDataDriven;let g,r;if(U&&!f){const E=x.getValue(n);g=s.getMosaicItemPosition(E)}let a=!1;if(!U){const E=p.getPaintProperty("line-dasharray");if(r=E!==void 0,a=r&&E.isDataDriven,r&&!a){const R=E.getValue(n),D=p.getDashKey(R,p.getLayoutValue("line-cap",n));g=s.getMosaicItemPosition(D)}}const u=1/c,m=this._programOptions;m.pattern=U,m.sdf=r;const o=y.getMaterialProgram(e,S,m);if(P&&d!=null&&!o.compiled)return void d();if(e.useProgram(o),o.setUniformMatrix3fv("u_displayViewMat3",l.displayViewMat3),o.setUniformMatrix3fv("u_displayMat3",M===G.VIEWPORT?l.displayMat3:l.displayViewMat3),o.setUniform2fv("u_lineTranslation",v),o.setUniform1f("u_depth",p.z),o.setUniform1f("u_antialiasing",u),g&&g!=null){const{page:E}=g,R=s.getPageSize(E);R!=null&&(s.bind(e,k.LINEAR,E,w),o.setUniform2fv("u_mosaicSize",R),o.setUniform1i("u_texture",w))}let T=-1;for(const E of t){if(!E.layerData.has(h))continue;E.key.level!==T&&(T=E.key.level,S.setDataUniforms(o,n,p,T,s));const R=2**(n-T)/c;o.setUniform1f("u_zoomFactor",R);const D=E.layerData.get(h);if(!D.lineIndexCount)continue;D.prepareForRendering(e);const z=D.vao;if(z!=null){if(e.bindVAO(z),o.setUniformMatrix3fv("u_dvsMat3",E.transforms.displayViewScreenMat3),e.setStencilFunction(O.EQUAL,E.stencilRef,255),f||a){const $=D.patternMap;if(!$)continue;for(const[I,C]of $){const L=s.getPageSize(I);L!=null&&(s.bind(e,k.LINEAR,I,w),o.setUniform2fv("u_mosaicSize",L),o.setUniform1i("u_texture",w),e.drawElements(N.TRIANGLES,C[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*C[0]))}}else e.drawElements(N.TRIANGLES,D.lineIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*D.lineIndexStart);E.triangleCount+=D.lineIndexCount/3}}}}const oe=256/360,le=1/Math.LN2;function fe(V,i){return(V%=i)>=0?V:V+i}function j(V){return fe(V*oe,256)}function Se(V){return Math.log(V)*le}const ue=1/65536;class Re extends F{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=re()}dispose(){}drawMany(i,t){const e=i.styleLayer;this._drawIcons(i,e,t),this._drawText(i,e,t)}_drawIcons(i,t,e){const{context:n,displayLevel:l,painter:_,spriteMosaic:c,state:s,styleLayerUID:h,requestRender:d,allowDelayedRender:P}=i,p=t.iconMaterial,S=_.vectorTilesMaterialManager;let y,v=!1;for(const o of e)if(o.layerData.has(h)&&(y=o.layerData.get(h),y.iconPerPageElementsMap.size>0)){v=!0;break}if(!v)return;const M=t.getPaintValue("icon-translate",l),x=t.getPaintValue("icon-translate-anchor",l);let U=t.getLayoutValue("icon-rotation-alignment",l);U===A.AUTO&&(U=t.getLayoutValue("symbol-placement",l)===Y.POINT?A.VIEWPORT:A.MAP);const f=U===A.MAP,g=t.getLayoutValue("icon-keep-upright",l)&&f,r=y.isIconSDF,a=this._iconProgramOptions;a.sdf=r;const u=S.getMaterialProgram(n,p,a);if(P&&d!=null&&!u.compiled)return void d();n.useProgram(u),u.setUniformMatrix3fv("u_displayViewMat3",U===A.MAP?s.displayViewMat3:s.displayMat3),u.setUniformMatrix3fv("u_displayMat3",x===G.VIEWPORT?s.displayMat3:s.displayViewMat3),u.setUniform2fv("u_iconTranslation",M),u.setUniform1f("u_depth",t.z),u.setUniform1f("u_mapRotation",j(s.rotation)),u.setUniform1f("u_keepUpright",g?1:0),u.setUniform1f("u_level",10*l),u.setUniform1i("u_texture",w),u.setUniform1f("u_fadeDuration",Q/1e3);let m=-1;for(const o of e){if(!o.layerData.has(h)||(o.key.level!==m&&(m=o.key.level,p.setDataUniforms(u,l,t,m,c)),y=o.layerData.get(h),y.iconPerPageElementsMap.size===0))continue;y.prepareForRendering(n),y.updateOpacityInfo();const T=y.iconVAO;if(T!=null){n.bindVAO(T),u.setUniformMatrix3fv("u_dvsMat3",o.transforms.displayViewScreenMat3),u.setUniform1f("u_time",(performance.now()-y.lastOpacityUpdate)/1e3);for(const[E,R]of y.iconPerPageElementsMap)this._renderIconRange(i,u,R,E,o)}}}_renderIconRange(i,t,e,n,l){const{context:_,spriteMosaic:c}=i;this._spritesTextureSize[0]=c.getWidth(n)/4,this._spritesTextureSize[1]=c.getHeight(n)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),c.bind(_,k.LINEAR,n,w),this._setStencilState(i,l),_.drawElements(N.TRIANGLES,e[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),l.triangleCount+=e[1]/3}_drawText(i,t,e){const{context:n,displayLevel:l,glyphMosaic:_,painter:c,pixelRatio:s,spriteMosaic:h,state:d,styleLayerUID:P,requestRender:p,allowDelayedRender:S}=i,y=t.textMaterial,v=c.vectorTilesMaterialManager;let M,x=!1;for(const L of e)if(L.layerData.has(P)&&(M=L.layerData.get(P),M.glyphPerPageElementsMap.size>0)){x=!0;break}if(!x)return;const U=t.getPaintProperty("text-opacity");if(U&&!U.isDataDriven&&U.getValue(l)===0)return;const f=t.getPaintProperty("text-color"),g=!f||f.isDataDriven||f.getValue(l)[3]>0,r=t.getPaintProperty("text-halo-width"),a=t.getPaintProperty("text-halo-color"),u=(!r||r.isDataDriven||r.getValue(l)>0)&&(!a||a.isDataDriven||a.getValue(l)[3]>0);if(!g&&!u)return;const m=24/8;let o=t.getLayoutValue("text-rotation-alignment",l);o===A.AUTO&&(o=t.getLayoutValue("symbol-placement",l)===Y.POINT?A.VIEWPORT:A.MAP);const T=o===A.MAP,E=t.getLayoutValue("text-keep-upright",l)&&T,R=.8*m/s;this._glyphTextureSize||(this._glyphTextureSize=se(_.width/4,_.height/4));const D=t.getPaintValue("text-translate",l),z=t.getPaintValue("text-translate-anchor",l),$=this._sdfProgramOptions,I=v.getMaterialProgram(n,y,$);if(S&&p!=null&&!I.compiled)return void p();n.useProgram(I),I.setUniformMatrix3fv("u_displayViewMat3",o===A.MAP?d.displayViewMat3:d.displayMat3),I.setUniformMatrix3fv("u_displayMat3",z===G.VIEWPORT?d.displayMat3:d.displayViewMat3),I.setUniform2fv("u_textTranslation",D),I.setUniform1f("u_depth",t.z+ue),I.setUniform2fv("u_mosaicSize",this._glyphTextureSize),I.setUniform1f("u_mapRotation",j(d.rotation)),I.setUniform1f("u_keepUpright",E?1:0),I.setUniform1f("u_level",10*l),I.setUniform1i("u_texture",B),I.setUniform1f("u_antialiasingWidth",R),I.setUniform1f("u_fadeDuration",Q/1e3);let C=-1;for(const L of e){if(!L.layerData.has(P)||(L.key.level!==C&&(C=L.key.level,y.setDataUniforms(I,l,t,C,h)),M=L.layerData.get(P),M.glyphPerPageElementsMap.size===0))continue;M.prepareForRendering(n),M.updateOpacityInfo();const W=M.textVAO;if(W==null)continue;n.bindVAO(W),I.setUniformMatrix3fv("u_dvsMat3",L.transforms.displayViewScreenMat3),this._setStencilState(i,L);const K=(performance.now()-M.lastOpacityUpdate)/1e3;I.setUniform1f("u_time",K),M.glyphPerPageElementsMap.forEach((Z,J)=>{this._renderGlyphRange(n,Z,J,_,I,u,g,L)})}}_renderGlyphRange(i,t,e,n,l,_,c,s){n.bind(i,k.LINEAR,e,B),_&&(l.setUniform1f("u_halo",1),i.drawElements(N.TRIANGLES,t[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),s.triangleCount+=t[1]/3),c&&(l.setUniform1f("u_halo",0),i.drawElements(N.TRIANGLES,t[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),s.triangleCount+=t[1]/3)}_setStencilState(i,t){const{context:e,is3D:n,stencilSymbols:l}=i;if(e.setStencilTestEnabled(!0),l)return e.setStencilWriteMask(255),void e.setStencilFunction(O.ALWAYS,t.stencilRef,255);e.setStencilWriteMask(0),n?e.setStencilFunction(O.EQUAL,t.stencilRef,255):e.setStencilFunction(O.GREATER,255,255)}}export{Re as d,Se as e,xe as f,ve as n,Ie as s,F as t,Ue as u};
