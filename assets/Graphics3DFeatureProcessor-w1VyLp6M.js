import{g as Q,r as n,m as a,a as w,b2 as A,l as H,N as x,D as v,V as P,B as M,bu as O,e as N,aO as J}from"./Accessor-BmwT4B0c.js";import{b as U}from"./Graphic-Dt0LgVGU.js";import{i as D}from"./hash-CcEbRgUF.js";import{p as j}from"./Promise-DfET-uns.js";import{P as y,d as g,p as L}from"./reactiveUtils-XM7cS2OP.js";import{y as F}from"./diffUtils-BanfihCO.js";import{h as $}from"./UpdatingHandles-CzJ4c3KT.js";import{ah as k,a3 as B}from"./Point-Cz2JYYmX.js";import{r as z,l as Z,a as W}from"./LineCallout.glsl-BQyjm-mE.js";import{b as T}from"./Query-B_2mhyL4.js";import{A as R,ah as Y}from"./opacityUtils-Dim20wpZ.js";import{e as K}from"./GridLocalOriginFactory-CngFIYNp.js";import{W as X,u as ee,e as te}from"./Graphics3DScaleVisibility-CyLlAoK9.js";import{a as ie,p as re,u as se}from"./Graphics3DObjectStates-XVMjaI7s.js";import{S as ne}from"./graphicUtils-BFGMMQ1R.js";import{n as V}from"./attributeUtils-Dc8--CBJ.js";import{d as _}from"./FeatureFilter-Ca1n-g_b.js";import{o as ae}from"./floorFilterUtils-DZ5C6FQv.js";import{w as oe}from"./Extent-g5W9hy0j.js";import{y as le}from"./typeUtils-B6WBEKDM.js";import{L as ue}from"./QueryEngine-BokU27l9.js";import{Z as pe}from"./FieldsIndex-FW1AMU67.js";import{d as I}from"./FeatureSet-B5-Veyin.js";import{a as he,s as ce}from"./memoryEstimations-Bcyf-mHz.js";import{g as de}from"./Scheduler-i_u8qdlN.js";import{s as b,e as ye,i as ge}from"./highlightUtils-CENYWDnQ.js";import{C as fe}from"./RibbonLine.glsl-DwJpAQ1c.js";import{c as me}from"./HighlightDefaults-CumzVg9-.js";class _e{constructor(t){this._cache=t.newCache("QueryEngine",null,-1)}clear(){this._cache.clear()}destroy(){this._cache.destroy()}get(t){var i;return(i=this._cache.get(t))==null?void 0:i.items}put(t,i){this._cache.put(t,new be(i))}get test(){}}class be{constructor(t){this.items=t}get cachedMemory(){return this.items.reduce((t,i)=>t+i.usedMemory,he+ce)}}const Ee=ue;let d=class extends Q{constructor(e){super(e),this._dataQueryEngineInstance=null}destroy(){this.clear()}get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new T({outSpatialReference:this.spatialReference}).toJSON()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t,i){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,t),i)}async executeQueryForCount(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:i,extent:r}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:i,extent:oe.fromJSON(r)}}async executeQueryForIds(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const i=await this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),r=I.fromJSON(i);return r.features.forEach(s=>{s.layer=this.layer,s.sourceLayer=this.layer}),r}async executeQuery(e,t){const i=await this._dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),r=I.fromJSON(i);return r.features.forEach(s=>{s.layer=this.layer,s.sourceLayer=this.layer}),r}_ensureQueryJSON(e,t){let i=this.defaultQueryJSON;if(e!=null&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),i=e.toJSON(),i.cacheHint=!0),t!=null){const r=t.geometries.map(s=>s.toJSON()).reduce((s,l)=>(s.rings=s.rings.concat(l.rings),s));i={...i,cacheHint:!0,sceneFilter:{...t,geometry:r}}}return i}get _dataQueryEngine(){var C,S;if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const{priority:e,layer:t}=this,i="timeInfo"in t&&((C=t.timeInfo)==null?void 0:C.toJSON())||null,r=t.objectIdField,s=le.toJSON(this._queryGeometryType),l=((S=t.fieldsIndex)==null?void 0:S.toJSON())||new pe([]),u=this.spatialReference.toJSON(),{hasZ:p,hasM:c,featureStore:f,scheduler:m,memoryController:G}=this.context,q=new _e(G);return this._dataQueryEngineInstance=new Ee({hasZ:p,hasM:c,geometryType:s,fieldsIndex:l,timeInfo:i,spatialReference:u,objectIdField:r,featureStore:f,scheduler:m,cache:q,priority:e}),this._dataQueryEngineInstance}};n([a({constructOnly:!0})],d.prototype,"context",void 0),n([a({constructOnly:!0})],d.prototype,"priority",void 0),n([a()],d.prototype,"layer",null),n([a()],d.prototype,"spatialReference",null),n([a()],d.prototype,"_queryGeometryType",null),n([a()],d.prototype,"defaultQueryJSON",null),d=n([w("esri.views.3d.layers.graphics.QueryEngine")],d);class xe{constructor(t,i,r,s,l,u){this.spatialReference=t,this.layer=i,this.resourceController=r,this._getFeatureStore=s,this.hasZ=l,this.hasM=u}get scheduler(){return this.resourceController.scheduler}get memoryController(){return this.resourceController.memoryController}get featureStore(){return this._getFeatureStore()}}let h=class extends Q{constructor(e){super(e),this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new $,this._abortController=new AbortController}initialize(){const e=de.FILTER_VISIBILITY,{layer:t,view:i}=this._configuration,{featureStore:r}=this.context,{spatialReference:s,resourceController:l}=i,u=this._configuration.hasZ??!1,p=this._configuration.hasM??!1,c=new xe(s,t,l,()=>r,u,p);this._queryEngine=new d({context:c,priority:e}),this._frameTask=i.resourceController.scheduler.registerTask(e),this._updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this._updateRequested=!0,y),this._updatingHandles.addWhen(()=>!this._frameTask.updating&&this._updateRequested,()=>{this._frameTask.schedule(()=>this._updateVisibility(),this._abortController.signal).catch(A),this._updateRequested=!1},y)}destroy(){this._abortController.abort(),this._updatingHandles.destroy(),this.clear(),this._frameTask=H(this._frameTask),this._queryEngine=x(this._queryEngine),this._set("context",null)}get updating(){return this._updateRequested||this._updatingHandles.updating||this._frameTask.updating}get defaultVisibility(){return this._compositedFeatureFilter==null&&this._sceneFilter==null}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _effectiveDisplayFilter(){return"effectiveDisplayFilter"in this._configuration?this._configuration.effectiveDisplayFilter:null}get _sceneFilter(){return"layerFilter"in this._configuration?this._configuration.layerFilter:null}get _floorFilter(){return ae(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){var l;const{_featureFilter:e,_effectiveDisplayFilter:t,_timeExtent:i,_floorFilter:r}=this;let s=e==null?void 0:e.clone();if(t!=null&&(s??(s=new _),s.where=R(s.where,t.where)),i!=null&&(s??(s=new _),s.timeExtent=((l=s.timeExtent)==null?void 0:l.intersection(i))??i),r!=null){s??(s=new _);const u=s.where==null||s.where==="";s.where=u?r:R(s.where,r)}return s}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}async _updateVisibility(){const{signal:e}=this._abortController,{context:t,_frameTask:i,_sceneFilter:r,_compositedFeatureFilter:s}=this;if(v(e),s==null&&r==null||t.getFeatureCount()===0)return await i.schedule(()=>this.clear(),e);try{const l=await this._queryEngine.executeQueryForIdSet(s,r,e);return v(e),await i.schedule(()=>{t.updateFeatureVisibilities(u=>l.has(u))},e)}catch(l){return P(l),M.getLogger(this).warn(`FeatureFilter query failed: ${l}`,{error:l}),await i.schedule(()=>{t.setAllFeaturesVisibility(!0)},e)}}};n([a({constructOnly:!0})],h.prototype,"context",void 0),n([a()],h.prototype,"updating",null),n([a()],h.prototype,"defaultVisibility",null),n([a()],h.prototype,"_featureFilter",null),n([a()],h.prototype,"_effectiveDisplayFilter",null),n([a()],h.prototype,"_sceneFilter",null),n([a()],h.prototype,"_floorFilter",null),n([a()],h.prototype,"_timeExtent",null),n([a()],h.prototype,"_compositedFeatureFilter",null),n([a()],h.prototype,"_configuration",null),n([a()],h.prototype,"_updateRequested",void 0),h=n([w("esri.views.3d.layers.support.FeatureVisibilityFilter")],h);let o=class extends j{constructor(e){super(e),this.type="graphics-3d",this._updatingHandles=new $,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=K.Features,this.preferredUpdatePolicy=fe.ASYNC,this._suspendResumeExtent=null}initialize(){const e=this.owner,t=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&e.layer.geometryType!=="multipatch",i=new X({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.hasZ,hasM:e.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:r=>e.view.deconflictor.addGraphicsOwner(r),labeler:(r,s)=>e.view.labeler.addGraphicsOwner(r,s),elevationAlignment:this.elevationAlignmentEnabled?(r,s)=>new re({graphicsCoreOwner:this,graphicsCore:r,queryGraphicUIDsInExtent:s,elevationProvider:e.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(r,s)=>new ee({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:s,graphicsCore:r,basemapTerrain:e.view.basemapTerrain}):null,filterVisibility:t?r=>new h({context:{...r,configuration:e}}):null,objectStates:r=>new ie(r)}});this._set("graphicsCore",i),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new se({graphicsCoreOwner:this})),this.elevationAlignment&&this._updatingHandles.add(()=>this.layer.elevationInfo,(r,s)=>{F(r,s)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())}),this._updatingHandles.add(()=>this.layer.labelsVisible,()=>this.graphicsCore.updateVisibilityInfo()),this._updatingHandles.add(()=>this.layer.labelingInfo,(r,s)=>{F(r,s)&&this.graphicsCore.updateLabelingInfo()}),this._updatingHandles.add(()=>this.preferredUpdatePolicy,r=>this.graphicsCore.preferredUpdatePolicy=r),this.addResolvingPromise(this._initializeAsync())}async _initializeAsync(){await O(this.graphicsCore.initializePromise);const e=this.owner;this._updatingHandles.add(()=>this.renderer,t=>this._updatingHandles.addPromise(this.graphicsCore.rendererChange(t))),this._updatingHandles.add(()=>e.fullOpacity,()=>this.graphicsCore.opacityChange()),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this._updatingHandles.add(()=>e.view.clippingArea,()=>this._updateClippingExtent()),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await O(this.graphicsCore.updateLabelingInfo())}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",x(this.frustumVisibility)),this._set("graphicsCore",x(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get dataUpdating(){var e;return((e=this.graphicsCore)==null?void 0:e.dataUpdating)??!1}get renderer(){const{renderer:e,objectIdField:t}=this.layer;if(!e||!t||e.type==="heatmap"||!e.visualVariables)return e;const i=e.visualVariables.findIndex(s=>s.type==="rotation"&&s.valueExpression!=null&&Y(s.valueExpression)===t&&(s.axis==null||s.axis==="heading")&&s.rotationType==="geographic");if(i<0)return e;const r=e.clone();return r.visualVariables?(r.visualVariables.splice(i,1),this._randomRotationRenderers??(this._randomRotationRenderers=new WeakMap),this._randomRotationRenderers.set(r,t),r):e}get scaleVisibility(){var e;return(e=this.graphicsCore)==null?void 0:e.scaleVisibility}get filterVisibility(){var e;return(e=this.graphicsCore)==null?void 0:e.filterVisibility}get elevationAlignment(){var e;return(e=this.graphicsCore)==null?void 0:e.elevationAlignment}get suspendResumeExtentMode(){return this.owner.suspendResumeExtentMode??"computed"}get scaleVisibilitySuspended(){return this.scaleVisibility!=null&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return this.frustumVisibility==null||!this.frustumVisibility.suspended}get suspendInfo(){const e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),this.frustumVisibility!=null&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){var e,t;return!!((e=this.graphicsCore)!=null&&e.updating||(t=this.frustumVisibility)!=null&&t.updating||this._updatingHandles.updating)}get updatingRemaining(){var e;return((e=this.graphicsCore)==null?void 0:e.updatingRemaining)??0}get featureStore(){var e;return(e=this.graphicsCore)==null?void 0:e.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){var e;return(e=this.owner)==null?void 0:e.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){var e;return(e=this.graphicsCore)==null?void 0:e.graphics3DGraphics}get graphics3DGraphicsByObjectID(){var e;return(e=this.graphicsCore)==null?void 0:e.graphics3DGraphicsByObjectID}get symbolUpdateType(){var e;return(e=this.graphicsCore)==null?void 0:e.symbolUpdateType}get displayFeatureLimit(){var r;const e=this.view.quality,t=(r=this.graphicsCore)==null?void 0:r.displayFeatureLimit;if(e===1)return t;const i=Math.ceil(t.maximumNumberOfFeatures*e);return new te(t.maximumTotalNumberOfVertices,i,t.averageSymbolComplexity)}get usedMemory(){var e;return((e=this.graphicsCore)==null?void 0:e.usedMemory)??0}get loadedFeatures(){var e;return((e=this.graphicsCore)==null?void 0:e.numberOfGraphics)??0}get usedMemoryPerFeature(){var e;return((e=this.graphicsCore)==null?void 0:e.usedMemoryPerGraphic)??0}get unprocessedMemoryEstimate(){var e;return((e=this.graphicsCore)==null?void 0:e.unprocessedMemoryEstimate)??0}get performanceInfo(){return this.graphicsCore.performanceInfo}maskOccludee(e){var s;const t=(s=this.graphicsCore)==null?void 0:s.objectStates;if(!t)return N();const{set:i,handle:r}=t.acquireOccludeeSet(null);return t.setUid(i,e.uid),r}highlight(e,t=null,i){var l;const r=(l=this.graphicsCore)==null?void 0:l.objectStates;if(!r)return b;if(i??(i=me),e instanceof T){const{set:u,handle:p}=r.acquireHighlightSet(i,t);return this.owner.queryObjectIds(e).then(c=>r.setObjectIds(u,c)),p}let s=ye(e);if(s.length===0)return b;if(s[0]instanceof U){const u=s;if(V(this.layer.fieldsIndex,u[0].attributes,t)==null){const p=u.map(m=>m.uid),{set:c,handle:f}=r.acquireHighlightSet(i,null);return r.setUids(c,p),f}s=u.map(p=>V(this.layer.fieldsIndex,p.attributes,t))}if(ge(s[0])){const u=s,{set:p,handle:c}=r.acquireHighlightSet(i,t);return r.setObjectIds(p,u),c}return b}resetObjectStates(){var e,t;(t=(e=this.graphicsCore)==null?void 0:e.objectStates)==null||t.reset()}whenGraphicBounds(e,t){var i;return(i=this.graphicsCore)==null?void 0:i.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){var i;return(i=this.graphicsCore)==null?void 0:i.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}getRenderingInfo(e,t,i){var s;const r=z(e,{renderer:t,arcade:i});if(r!=null&&r.color){const l=r.color;l[0]=l[0]/255,l[1]=l[1]/255,l[2]=l[2]/255}if(r!=null&&t!=null&&((s=this._randomRotationRenderers)!=null&&s.has(t))){const l=this._randomRotationRenderers.get(t),u=e.attributes[l],p=new D(0);p.updateFloatArray([u]),p.updateUint8Array([173]),r.heading=8381e-11*p.digest()}return r}getRenderingInfoAsync(e,t,i,r){return Z(e,{renderer:t,arcade:i,...r})}getSymbolLayerSize(e,t){var i;return(i=this.graphicsCore)==null?void 0:i.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){var i;(i=this.graphicsCore)==null||i.setObjectIdVisibility(e,t)}refreshFilter(){this.filterVisibility!=null&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(e){var t;return(t=this.graphicsCore)==null?void 0:t.getGraphics3DGraphicByObjectId(e)}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.addHandles(g(()=>this.suspendResumeExtentMode,()=>{switch(this.removeHandles(E),this.suspendResumeExtentMode){case"computed":this.addHandles([g(()=>this.graphicsCore.computedExtent,e=>this._updateSuspendResumeExtent(e),y),g(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent))],E);break;case"data":this.addHandles([L(()=>this.dataExtent,e=>this._updateSuspendResumeExtent(e),y),g(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.dataExtent))],E);break;default:J(this.suspendResumeExtentMode)}},y))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){const i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!k(e,i))return;e=B(e,i)}return ne(e,t,W,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){this.frustumVisibility!=null&&this.frustumVisibility.setExtent(e),this.scaleVisibility!=null&&this.scaleVisibility.setExtent(e)}};n([a()],o.prototype,"type",void 0),n([a({constructOnly:!0})],o.prototype,"owner",void 0),n([a()],o.prototype,"layer",null),n([a({readOnly:!0})],o.prototype,"dataUpdating",null),n([a()],o.prototype,"renderer",null),n([a({constructOnly:!0})],o.prototype,"updateClippingExtent",void 0),n([a({constructOnly:!0})],o.prototype,"elevationFeatureExpressionEnabled",void 0),n([a({constructOnly:!0})],o.prototype,"graphicsCore",void 0),n([a({constructOnly:!0})],o.prototype,"scaleVisibilityEnabled",void 0),n([a({constructOnly:!0})],o.prototype,"filterVisibilityEnabled",void 0),n([a({constructOnly:!0})],o.prototype,"frustumVisibilityEnabled",void 0),n([a({constructOnly:!0})],o.prototype,"elevationAlignmentEnabled",void 0),n([a({constructOnly:!0})],o.prototype,"timeExtentEnabled",void 0),n([a({constructOnly:!0})],o.prototype,"setUidToIdOnAdd",void 0),n([a()],o.prototype,"scaleVisibility",null),n([a()],o.prototype,"filterVisibility",null),n([a()],o.prototype,"elevationAlignment",null),n([a({constructOnly:!0})],o.prototype,"frustumVisibility",void 0),n([a()],o.prototype,"suspendResumeExtentMode",null),n([a()],o.prototype,"dataExtent",void 0),n([a()],o.prototype,"scaleVisibilitySuspended",null),n([a()],o.prototype,"suspended",null),n([a()],o.prototype,"legendEnabled",null),n([a()],o.prototype,"suspendInfo",null),n([a()],o.prototype,"updating",null),n([a()],o.prototype,"updatingRemaining",null),n([a()],o.prototype,"featureStore",null),n([a()],o.prototype,"view",null),n([a()],o.prototype,"loadedGraphics",null),n([a()],o.prototype,"fullOpacity",null),n([a()],o.prototype,"filter",null),n([a()],o.prototype,"slicePlaneEnabled",null),n([a()],o.prototype,"drapeSourceType",void 0),n([a()],o.prototype,"updatePolicy",null),n([a()],o.prototype,"preferredUpdatePolicy",void 0),n([a({readOnly:!0})],o.prototype,"displayFeatureLimit",null),o=n([w("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],o);const E="suspendResumeExtentMode";export{o as D,xe as e,d as p,h as y};
