const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CatalogLayer-Bjyf4PlP.js","./index-4eY77cms.js","./index-Cx51aysm.css","./Accessor-BmwT4B0c.js","./cast-CsZslgGN.js","./JSONSupport-DcrLLGjL.js","./reactiveUtils-XM7cS2OP.js","./Evented-Dw4_VOGn.js","./SimpleObservable-CvOkykwM.js","./MultiOriginJSONSupport-DbmrbwMa.js","./Layer-DH4_Pn8a.js","./Identifiable-BHVfzH03.js","./Portal-CmmHxpLg.js","./Promise-DfET-uns.js","./writer-DKgfqj4X.js","./Extent-g5W9hy0j.js","./Point-Cz2JYYmX.js","./TimeExtent-BO6BsF_x.js","./timeUtils-C1c_L2Fd.js","./LRUCache-CXiGQWMN.js","./MemCache-CmojB_Z1.js","./ReactiveMap-BHFEHYMj.js","./signal-CySMLEX9.js","./ScaleRangeLayer-Cnzwr9PT.js","./layerContainerType-C5CzMsLd.js","./jsonUtils-DZz5FrgB.js","./colorUtils-Rxh2V3ai.js","./utils-DYurMneM.js","./screenUtils-_ZIvrt5o.js","./mat4f32-DcsiF_Rp.js","./mat4-Fi6iAz29.js","./vec3f64-BLpZdpfb.js","./common-DQOJ18NT.js","./commonProperties-B0GHoNP5.js","./ElevationInfo-BPOqhCue.js","./opacityUtils-Dim20wpZ.js","./unitConversionUtils-rg07EgOm.js","./lengthUtils-_77UiyVF.js","./AttributeTableTemplate-cR37sM72.js","./OrderByInfo-KsusEmpW.js","./utils-Dyua10sr.js","./ClassBreaksDefinition-C7KVmBug.js","./enumeration-DpvDkLNI.js","./Graphic-Dt0LgVGU.js","./Clonable-Z-AWS-16.js","./Color-VJEMvW-n.js","./mathUtils-Cfq9PL9W.js","./ActionToggle-D7439N1A.js","./jsonUtils-CwFG8yN4.js","./Polyline-s-JzsQqo.js","./typeUtils-B6WBEKDM.js","./TextSymbol-BLIQ6RKX.js","./collectionUtils-CTT-51g7.js","./aaBoundingBox-Dw3yBk2f.js","./FeatureLayerBase-C4QQJYE9.js","./formUtils-l8pvwous.js","./Field-BDG0QV_T.js","./fieldType-CBeoJWlv.js","./HeightModelInfo-C05IFsWs.js","./timeZoneUtils-DxzjpEBb.js","./featureLayerUtils-Btb8HY8h.js","./uuid-Cl5lrJ4c.js","./featureQueryAll-JpNZKIBO.js","./Query-B_2mhyL4.js","./FullTextSearch-CBnxSwz4.js","./layerUtils-B__v9OBu.js","./SimpleRenderer-CEw_geZx.js","./commonProperties-ZfGquLPI.js","./colorRamps-CRjjPL3r.js","./SizeVariable-B-ghFm6e.js","./visualVariableUtils-Xcorldoo.js","./ColorStop-BYiAUa8d.js","./jsonUtils-B-voMz-i.js","./defaults-FkBa0ybj.js","./defaultsJSON-GKolV7NZ.js","./UniqueValueRenderer-yoWHKJ_P.js","./diffUtils-BanfihCO.js","./RendererLegendOptions-CYAPr8D6.js","./styleUtils-ColFrJ-Z.js","./AttachmentQuery-CpEmJqq-.js","./NormalizationBinParametersMixin-CZD0XfhN.js","./RelationshipQuery-B5a-mYy7.js","./LayerFloorInfo-iCgtHY6f.js","./Relationship-CTbzI1Kb.js","./serviceCapabilitiesUtils-B2yGaMdk.js","./infoFor3D-C7tb3HsI.js","./FeatureEffectLayer-BZmannck.js","./FeatureEffect-DZgZP6Sj.js","./FeatureFilter-Ca1n-g_b.js","./labelingInfo-BgG6IH9B.js","./labelUtils-DCpQ7n-8.js","./typeUtils-B3iPBwJ2.js","./ClassBreaksRenderer-C7fhua2J.js","./Version-Cd3TlGH0.js","./FieldsIndex-FW1AMU67.js","./utils-UPZJIDfz.js","./defaultCIMValues-Bb-CUowV.js","./enums-BTM-fOHQ.js","./HeatmapColorStop-CHbSyb1s.js","./heatmapUtils-Cyq-bAyG.js","./vec42-YcqnINSP.js","./vec4f64-o2zAXfmz.js","./popupUtils-CmsUVJA0.js","./FeatureLayerSource-Cz0vlv9O.js","./MeshLocalVertexSpace-CnHk-qPr.js","./meshVertexSpaceUtils-AgAbm20L.js","./vec32-Dvg_eL9J.js","./External-wgBWsUOW.js","./applyEditsUtils-DPVEGiDT.js","./projection-CyCZAIaD.js","./projectBuffer-CQnuEMuP.js","./geodesicConstants-RQL9oKdk.js","./MeshTransform-mu8wTSqx.js","./mat4f64-Dk4dwAN8.js","./quat-CP7JhygC.js","./mat3f64-BBpwCtoL.js","./quatf64-CCm9z-pX.js","./axisAngleDegrees-DdLZENJj.js","./editingSupport-DwgIc4Po.js","./normalizeUtils-BTGdXlpz.js","./normalizeUtilsCommon-lGDszWRI.js","./utils-YowqfOgk.js","./utils-B-dlKIhi.js","./EditBusLayer-KXo-LY9o.js","./clientSideDefaults-DyCV_B9d.js","./QueryEngineCapabilities-B_pTbIiR.js","./QueryTask-DhCC-aVs.js","./executeForIds-BgTHdLi8.js","./query-Bjn_Ozo1.js","./pbfQueryUtils-mqiWagfZ.js","./pbf-BsmI3A9L.js","./memoryEstimations-Bcyf-mHz.js","./OptimizedGeometry-BJqUA4Pi.js","./OptimizedFeature-P2towpqD.js","./OptimizedFeatureSet-Blu9Ckm7.js","./queryZScale-BdW_vUm_.js","./executeQueryJSON-BvVQs3iA.js","./FeatureSet-B5-Veyin.js","./featureConversionUtils-CvnFcmH_.js","./editsZScale-LI19I1vI.js","./APIKeyMixin-3z69J1h4.js","./ArcGISService-CDyDWGI0.js","./CustomParametersMixin-Be7WOSEG.js","./DisplayFilteredLayer-CzliK74b.js","./scaleUtils-DPfHG2g0.js","./displayFilterUtils-uKPOP7_-.js","./OperationalLayer-B__lrMRq.js","./OrderedLayer-ucEg87Tu.js","./PortalLayer-Cqwv_mmr.js","./PortalItem-CTx1kJsR.js","./portalItemUtils-ByOtbGao.js","./RefreshableLayer-C90FXoHt.js","./TemporalLayer-CMqBosxi.js","./TimeInfo-CctegBed.js","./TimeInterval-B7L-CEq7.js","./FeatureType-DhERcdEP.js","./FeatureTemplate-Dh5_oWTV.js","./fieldProperties-DDN0PSrH.js","./versionUtils-BfhafDf-.js","./FeatureLayer-U46cmps3.js","./workers-Cds_sd9m.js","./Queue-BQesTh_6.js","./intl-Duiy0OzY.js","./FeatureReductionLayer-B6VhUfZv.js","./FeatureReductionSelection-BJWsAyix.js","./jsonUtils-BZp85R7u.js","./MD5-C9MwAd2G.js","./TrackableLayer-DaYHUnrc.js","./TitleCreator-DIyQ9Yy3.js","./styleUtils-Bye9ft1s.js","./interfaces-CL2NbQte.js","./OrientedImageryLayer-Copf-Ns-.js"])))=>i.map(i=>d[i]);
import{_ as I}from"./index-4eY77cms.js";import{G as B,s as u,ad as K,ap as V}from"./Accessor-BmwT4B0c.js";import{i as w}from"./originUtils-D69mHv66.js";import{P as z,w as O,d as j,v as q,$ as H,p as x,f as Q,I as N,m as $}from"./utils-CL4g0y2W.js";import{d}from"./cast-CsZslgGN.js";import{t as W,i as X}from"./fetchService-DZsSekGm.js";import{L as Z}from"./layerUtils-B__v9OBu.js";import{o as ee}from"./jsonContext-Ctyl6VtL.js";import{l as g,u as y,E as p,a as ae}from"./portalItemUtils-ByOtbGao.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./Portal-CmmHxpLg.js";import"./JSONSupport-DcrLLGjL.js";import"./Promise-DfET-uns.js";import"./writer-DKgfqj4X.js";import"./Extent-g5W9hy0j.js";import"./Point-Cz2JYYmX.js";import"./PortalItem-CTx1kJsR.js";import"./saveUtils-D2cY3Oni.js";import"./requestPresets-D39VZbLJ.js";import"./projection-CyCZAIaD.js";import"./SimpleObservable-CvOkykwM.js";import"./vec3f64-BLpZdpfb.js";import"./Polyline-s-JzsQqo.js";import"./mathUtils-Cfq9PL9W.js";import"./projectBuffer-CQnuEMuP.js";import"./geodesicConstants-RQL9oKdk.js";const v="Feature Service",T="feature-layer-utils",te=`${T}-save`,re=`${T}-save-as`,f=`${T}-saveall`,m=`${T}-saveall-as`;function P(e){return{isValid:Z(e)&&(!("dynamicDataSource"in e)||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function b(e,a){const t=ee(e,"portal-item");return a!=null&&a.isTable&&(t.layerContainerType="tables"),t}function R(e){const a=b(e),t=b(e);return t.layerContainerType="tables",{forLayers:a,forTables:t}}function D(e){const a=[],t=[];for(const{layer:r,layerJSON:n}of e)r.isTable?t.push(n):a.push(n);return{layers:a,tables:t}}function J(e){return D([e])}async function G(e,a){return/\/\d+\/?$/.test(e.url)?J(a[0]):U(a,e)}async function U(e,a){if(e.reverse(),!a)return D(e);const t=await oe(a,e);for(const r of e)F(r.layer,r.layerJSON,t);return ie(t,e),t}async function oe(e,a){let t=await e.fetchData("json");if(se(t))return t;t||(t={}),ne(t);const{layer:{url:r,customParameters:n,apiKey:o}}=a[0];return await le(t,{url:r??"",customParameters:n,apiKey:o},a.map(s=>s.layer.layerId)),t}function se(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function ne(e){e.layers||(e.layers=[]),e.tables||(e.tables=[])}function ie(e,a){const t=[],r=[];for(const{layer:n}of a){const{isTable:o,layerId:s}=n;o?r.push(s):t.push(s)}E(e.layers,t),E(e.tables,r)}function E(e,a){if(e.length<2)return;const t=[];for(const{id:r}of e)t.push(r);K(t.sort(S),a.slice().sort(S))&&e.sort((r,n)=>{const o=a.indexOf(r.id),s=a.indexOf(n.id);return o<s?-1:o>s?1:0})}function S(e,a){return e<a?-1:e>a?1:0}async function le(e,a,t){const{url:r,customParameters:n,apiKey:o}=a,{serviceJSON:s,layersJSON:i}=await W(r,{customParameters:n,apiKey:o}),l=_(e.layers,s.layers,t),c=_(e.tables,s.tables,t);e.layers=l.itemResources,e.tables=c.itemResources;const h=[...l.added,...c.added],k=i?[...i.layers,...i.tables]:[];await ce(e,h,r,k)}function _(e,a,t){const r=V(e,a,(o,s)=>o.id===s.id);e=e.filter(o=>!r.removed.some(s=>s.id===o.id));const n=r.added;return n.forEach(({id:o})=>{e.push({id:o})}),{itemResources:e,added:n.filter(({id:o})=>!t.includes(o))}}async function ce(e,a,t,r){const n=await ue(a),o=a.map(({id:s,type:i})=>new(n.get(i))({url:t,layerId:s,sourceJSON:r.find(({id:l})=>l===s)}));await Promise.allSettled(o.map(s=>s.load())),o.forEach(s=>{const{layerId:i,loaded:l,defaultPopupTemplate:c}=s;if(!l||c==null)return;const h={id:i,popupInfo:c.toJSON()};s.operationalLayerType!=="ArcGISFeatureLayer"&&(h.layerType=s.operationalLayerType),F(s,h,e)})}async function ue(e){const a=[];e.forEach(({type:n})=>{switch(X(n)){case"CatalogLayer":a.push(I(()=>import("./CatalogLayer-Bjyf4PlP.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158]),import.meta.url).then(o=>o.default));break;case"FeatureLayer":a.push(I(()=>import("./FeatureLayer-U46cmps3.js"),__vite__mapDeps([159,1,2,3,43,44,6,7,8,5,4,14,35,13,16,42,45,26,46,47,11,48,15,49,50,51,28,52,12,31,53,9,24,54,55,56,57,58,33,34,36,37,38,59,60,61,62,63,64,17,18,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,10,160,161,162,139,135,109,110,111,137,140,141,23,25,27,29,30,32,142,143,144,145,123,86,87,88,163,164,89,90,165,91,92,19,20,93,94,95,96,97,98,99,100,101,166,146,147,39,148,149,150,151,152,153,154,167,156,155,157,168,158,169,102,170]),import.meta.url).then(o=>o.default));break;case"OrientedImageryLayer":a.push(I(()=>import("./OrientedImageryLayer-Copf-Ns-.js").then(o=>o.O),__vite__mapDeps([171,3,159,1,2,43,44,6,7,8,5,4,14,35,13,16,42,45,26,46,47,11,48,15,49,50,51,28,52,12,31,53,9,24,54,55,56,57,58,33,34,36,37,38,59,60,61,62,63,64,17,18,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,10,160,161,162,139,135,109,110,111,137,140,141,23,25,27,29,30,32,142,143,144,145,123,86,87,88,163,164,89,90,165,91,92,19,20,93,94,95,96,97,98,99,100,101,166,146,147,39,148,149,150,151,152,153,154,167,156,155,157,168,158,169,102,170]),import.meta.url).then(o=>o.default))}});const t=await Promise.all(a),r=new Map;return e.forEach(({type:n},o)=>{r.set(n,t[o])}),r}function F(e,a,t){e.isTable?A(t.tables,a):A(t.layers,a)}function A(e,a){const t=e.findIndex(({id:r})=>r===a.id);t===-1?e.push(a):e[t]=a}function M(e,a){if(!e.length)throw new u(`${a}:missing-parameters`,"'layers' array should contain at least one feature layer")}function pe(e,a){const t=e.map(r=>r.portalItem.id);if(new Set(t).size>1)throw new u(`${a}:invalid-parameters`,"All layers in the 'layers' array should be loaded from the same portal item")}function Y(e,a){const t=e.map(r=>r.layerId);if(new Set(t).size!==t.length)throw new u(`${a}:invalid-parameters`,"'layers' array should contain only one instance each of layer or table in a feature service")}async function ye(e){M(e,f),await Promise.all(e.map(a=>a.load()));for(const a of e)x(a,f,P),Q({layer:a,itemType:v,errorNamePrefix:f});pe(e,f),Y(e,f)}function L(e,a){let t=0,r=0,n=0;for(const{layerType:o}of[...a.layers,...a.tables])switch(o){case"OrientedImageryLayer":t++;break;case"SubtypeGroupLayer":r++;break;case"SubtypeGroupTable":n++}y(e,p.ORIENTED_IMAGERY_LAYER,t>0),y(e,p.SUBTYPE_GROUP_LAYER,r>0),y(e,p.SUBTYPE_GROUP_TABLE,n>0)}function C(e,a,t){ae(a,p.METADATA),y(a,p.MULTI_LAYER,e.length>1),y(a,p.SINGLE_LAYER,e.length===1),y(a,p.TABLE,t.tables.length>0&&t.layers.length===0),L(a,t)}async function fe(e,a,t){L(a,t)}async function me(e,a,t){const{url:r,layerId:n,title:o,fullExtent:s,isTable:i}=e,l=d(r);a.url=((l==null?void 0:l.serverType)==="FeatureServer"?r:`${r}/${n}`)??null,a.title||(a.title=o),a.extent=null,i||s==null||(a.extent=await g(s)),C([e],a,t)}function de(e,a){for(const o of e){const s=o.parsedUrl.path,i=d(s);if(!(i==null?void 0:i.url.path))throw new u(`${a}:invalid-parameters`,$(o,`has unsupported url pattern: ${s}`),{layer:o});const c=i==null?void 0:i.serverType;if(c!=="FeatureServer"&&c!=="MapServer")throw new u(`${a}:invalid-parameters`,$(o,`has unsupported server type: ${c}`),{layer:o});if(c==="MapServer"&&e.length>1)throw new u(`${a}:invalid-parameters`,"Only one layer or table in a map service can be saved")}const t=d(e[0].parsedUrl.path),r=t==null?void 0:t.url.path;if(!e.every(o=>{const s=d(o.parsedUrl.path);return(s==null?void 0:s.url.path)===r}))throw new u(`${a}:invalid-parameters`,"'layers' array should only contain layers or tables that belong to the same feature service")}async function he(e){M(e,m),await Promise.all(e.map(a=>a.load()));for(const a of e)x(a,m,P);de(e,m),Y(e,m)}function we(e,a){L(e,a),N(e)}async function be(e,a,t){let r=0;for(const{isTable:s}of e)s||r++;const n=e[0].parsedUrl.path,o=d(n);if(a.url=(o==null?void 0:o.serverType)==="FeatureServer"?o.url.path:n,a.title||(a.title=o.title),a.extent=null,r>0){const s=e.map(i=>i.fullExtent).filter(B).reduce((i,l)=>i.clone().union(l));s&&(a.extent=await g(s))}C(e,a,t),N(a)}async function Ve(e,a){return z({layer:e,itemType:v,validateLayer:P,createJSONContext:t=>b(t,e),createItemData:(t,r)=>G(r,[t]),errorNamePrefix:te,setItemProperties:fe},a)}async function ze(e,a){await ye(e);const t=e[0].portalItem,r=R(t),n=await Promise.all(e.map(s=>O(s,s.isTable?r.forTables:r.forLayers,a))),o=await G(t,e.map((s,i)=>({layer:s,layerJSON:n[i]})));return we(t,o),await t.update({data:o}),await Promise.all(e.slice(1).map(s=>s.portalItem.reload())),w(r.forLayers),w(r.forTables),t.clone()}async function je(e,a,t){return H({layer:e,itemType:v,validateLayer:P,createJSONContext:r=>b(r,e),createItemData:(r,n)=>Promise.resolve(J(r)),errorNamePrefix:re,newItem:a,setItemProperties:me},t)}async function qe(e,a,t){await he(e);const r=j({itemType:v,errorNamePrefix:m,newItem:a}),n=R(r),o=await Promise.all(e.map(i=>O(i,i.isTable?n.forTables:n.forLayers,t))),s=await U(e.map((i,l)=>({layer:i,layerJSON:o[l]})));await be(e,r,s),await q(r,s,t);for(const i of e)i.portalItem=r.clone();return w(n.forLayers),w(n.forTables),r}export{Ve as save,ze as saveAll,qe as saveAllAs,je as saveAs};
