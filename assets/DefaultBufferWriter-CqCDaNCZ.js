import{R as ee,o as ie,s as be,_ as xe,A as Ie}from"./vec32-Dvg_eL9J.js";import{n as J}from"./vec3f64-BLpZdpfb.js";import{c as Se,y as Ve,x as Ae,u as Pe,q as Ce,i as ye}from"./BufferView-0osDbyWD.js";import{S as $e,u as ke,Z as Ue}from"./aaBoundingBox-Dw3yBk2f.js";import{e as De}from"./Material-C_-mgXN8.js";import{s as j}from"./InterleavedLayout-_dYEAUNK.js";import{e as G}from"./VertexAttribute-Cq4MnHjR.js";import{H as Ee,G as ve}from"./mat4-Fi6iAz29.js";function Mt(i,n,f,t=1){const{data:r,indices:e}=i,s=n.typedBuffer,o=n.typedBufferStride,c=e.length;if(f*=o,t===1)for(let l=0;l<c;++l)s[f]=r[e[l]],f+=o;else for(let l=0;l<c;++l){const u=r[e[l]];for(let a=0;a<t;a++)s[f]=u,f+=o}}function Te(i,n,f){const{data:t,indices:r}=i,e=n.typedBuffer,s=n.typedBufferStride,o=r.length;f*=s;for(let c=0;c<o;++c){const l=2*r[c];e[f]=t[l],e[f+1]=t[l+1],f+=s}}function Fe(i,n,f,t){const{data:r,indices:e}=i,s=n.typedBuffer,o=n.typedBufferStride,c=e.length;if(f*=o,t==null||t===1)for(let l=0;l<c;++l){const u=3*e[l];s[f]=r[u],s[f+1]=r[u+1],s[f+2]=r[u+2],f+=o}else for(let l=0;l<c;++l){const u=3*e[l];for(let a=0;a<t;++a)s[f]=r[u],s[f+1]=r[u+1],s[f+2]=r[u+2],f+=o}}function ze(i,n,f,t=1){const{data:r,indices:e}=i,s=n.typedBuffer,o=n.typedBufferStride,c=e.length;if(f*=o,t===1)for(let l=0;l<c;++l){const u=4*e[l];s[f]=r[u],s[f+1]=r[u+1],s[f+2]=r[u+2],s[f+3]=r[u+3],f+=o}else for(let l=0;l<c;++l){const u=4*e[l];for(let a=0;a<t;++a)s[f]=r[u],s[f+1]=r[u+1],s[f+2]=r[u+2],s[f+3]=r[u+3],f+=o}}function Ot(i,n,f){const t=i.typedBuffer,r=i.typedBufferStride;n*=r;for(let e=0;e<f;++e)t[n]=0,t[n+1]=0,t[n+2]=0,t[n+3]=0,n+=r}function je(i,n,f,t,r=1){if(!n)return void Fe(i,f,t,r);const{data:e,indices:s}=i,o=f.typedBuffer,c=f.typedBufferStride,l=s.length,u=n[0],a=n[1],M=n[2],L=n[4],I=n[5],z=n[6],O=n[8],w=n[9],A=n[10],E=n[12],v=n[13],S=n[14];t*=c;let R=0,h=0,p=0;const g=Ee(n)?y=>{R=e[y]+E,h=e[y+1]+v,p=e[y+2]+S}:y=>{const d=e[y],m=e[y+1],b=e[y+2];R=u*d+L*m+O*b+E,h=a*d+I*m+w*b+v,p=M*d+z*m+A*b+S};if(r===1)for(let y=0;y<l;++y)g(3*s[y]),o[t]=R,o[t+1]=h,o[t+2]=p,t+=c;else for(let y=0;y<l;++y){g(3*s[y]);for(let d=0;d<r;++d)o[t]=R,o[t+1]=h,o[t+2]=p,t+=c}}function Ge(i,n,f,t,r=1){if(!n)return void Fe(i,f,t,r);const{data:e,indices:s}=i,o=n,c=f.typedBuffer,l=f.typedBufferStride,u=s.length,a=o[0],M=o[1],L=o[2],I=o[4],z=o[5],O=o[6],w=o[8],A=o[9],E=o[10],v=!ve(o),S=1e-6,R=1-S;t*=l;let h=0,p=0,g=0;const y=Ee(o)?d=>{h=e[d],p=e[d+1],g=e[d+2]}:d=>{const m=e[d],b=e[d+1],B=e[d+2];h=a*m+I*b+w*B,p=M*m+z*b+A*B,g=L*m+O*b+E*B};if(r===1)if(v)for(let d=0;d<u;++d){y(3*s[d]);const m=h*h+p*p+g*g;if(m<R&&m>S){const b=1/Math.sqrt(m);c[t]=h*b,c[t+1]=p*b,c[t+2]=g*b}else c[t]=h,c[t+1]=p,c[t+2]=g;t+=l}else for(let d=0;d<u;++d)y(3*s[d]),c[t]=h,c[t+1]=p,c[t+2]=g,t+=l;else for(let d=0;d<u;++d){if(y(3*s[d]),v){const m=h*h+p*p+g*g;if(m<R&&m>S){const b=1/Math.sqrt(m);h*=b,p*=b,g*=b}}for(let m=0;m<r;++m)c[t]=h,c[t+1]=p,c[t+2]=g,t+=l}}function He(i,n,f,t,r=1){if(!n)return void ze(i,f,t,r);const{data:e,indices:s}=i,o=n,c=f.typedBuffer,l=f.typedBufferStride,u=s.length,a=o[0],M=o[1],L=o[2],I=o[4],z=o[5],O=o[6],w=o[8],A=o[9],E=o[10],v=!ve(o),S=1e-6,R=1-S;if(t*=l,r===1)for(let h=0;h<u;++h){const p=4*s[h],g=e[p],y=e[p+1],d=e[p+2],m=e[p+3];let b=a*g+I*y+w*d,B=M*g+z*y+A*d,T=L*g+O*y+E*d;if(v){const x=b*b+B*B+T*T;if(x<R&&x>S){const N=1/Math.sqrt(x);b*=N,B*=N,T*=N}}c[t]=b,c[t+1]=B,c[t+2]=T,c[t+3]=m,t+=l}else for(let h=0;h<u;++h){const p=4*s[h],g=e[p],y=e[p+1],d=e[p+2],m=e[p+3];let b=a*g+I*y+w*d,B=M*g+z*y+A*d,T=L*g+O*y+E*d;if(v){const x=b*b+B*B+T*T;if(x<R&&x>S){const N=1/Math.sqrt(x);b*=N,B*=N,T*=N}}for(let x=0;x<r;++x)c[t]=b,c[t+1]=B,c[t+2]=T,c[t+3]=m,t+=l}}function Je(i,n,f,t,r=1){const{data:e,indices:s}=i,o=f.typedBuffer,c=f.typedBufferStride,l=s.length;if(t*=c,n!==e.length||n!==4)if(r!==1)if(n!==4)for(let u=0;u<l;++u){const a=3*s[u];for(let M=0;M<r;++M)o[t]=e[a],o[t+1]=e[a+1],o[t+2]=e[a+2],o[t+3]=255,t+=c}else for(let u=0;u<l;++u){const a=4*s[u];for(let M=0;M<r;++M)o[t]=e[a],o[t+1]=e[a+1],o[t+2]=e[a+2],o[t+3]=e[a+3],t+=c}else{if(n===4){for(let u=0;u<l;++u){const a=4*s[u];o[t]=e[a],o[t+1]=e[a+1],o[t+2]=e[a+2],o[t+3]=e[a+3],t+=c}return}for(let u=0;u<l;++u){const a=3*s[u];o[t]=e[a],o[t+1]=e[a+1],o[t+2]=e[a+2],o[t+3]=255,t+=c}}else{o[t]=e[0],o[t+1]=e[1],o[t+2]=e[2],o[t+3]=e[3];const u=new Uint32Array(f.typedBuffer.buffer,f.start),a=c/4,M=u[t/=4];t+=a;const L=l*r;for(let I=1;I<L;++I)u[t]=M,t+=a}}function Ke(i,n,f){const{data:t,indices:r}=i,e=n.typedBuffer,s=n.typedBufferStride,o=r.length,c=t[0];f*=s;for(let l=0;l<o;++l)e[f]=c,f+=s}function Xe(i,n,f,t,r=1){const e=n.typedBuffer,s=n.typedBufferStride;if(t*=s,r===1)for(let o=0;o<f;++o)e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],t+=s;else for(let o=0;o<f;++o)for(let c=0;c<r;++c)e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],t+=s}function Ye(i,n,f,t,r,e,s){var o;for(const c of f.fields.keys()){const l=i.get(c),u=l==null?void 0:l.indices;if(l&&u)Qe(c,l,t,r,e,s);else if(c===G.OBJECTANDLAYERIDCOLOR&&n!=null){const a=(o=i.get(G.POSITION))==null?void 0:o.indices;if(a){const M=a.length;Xe(n,e.getField(c,Ae),M,s)}}}}function Qe(i,n,f,t,r,e){switch(i){case G.POSITION:{j(n.size===3);const s=r.getField(i,ye);j(!!s,`No buffer view for ${i}`),s&&je(n,f,s,e);break}case G.NORMAL:{j(n.size===3);const s=r.getField(i,ye);j(!!s,`No buffer view for ${i}`),s&&Ge(n,t,s,e);break}case G.NORMALCOMPRESSED:{j(n.size===2);const s=r.getField(i,Ce);j(!!s,`No buffer view for ${i}`),s&&Te(n,s,e);break}case G.UV0:{j(n.size===2);const s=r.getField(i,Pe);j(!!s,`No buffer view for ${i}`),s&&Te(n,s,e);break}case G.COLOR:case G.SYMBOLCOLOR:{const s=r.getField(i,Ae);j(!!s,`No buffer view for ${i}`),j(n.size===3||n.size===4),!s||n.size!==3&&n.size!==4||Je(n,n.size,s,e);break}case G.COLORFEATUREATTRIBUTE:{const s=r.getField(i,Ve);j(!!s,`No buffer view for ${i}`),j(n.size===1),s&&n.size===1&&Ke(n,s,e);break}case G.TANGENT:{j(n.size===4);const s=r.getField(i,Se);j(!!s,`No buffer view for ${i}`),s&&He(n,f,s,e);break}case G.PROFILERIGHT:case G.PROFILEUP:case G.PROFILEVERTEXANDNORMAL:case G.FEATUREVALUE:{j(n.size===4);const s=r.getField(i,Se);j(!!s,`No buffer view for ${i}`),s&&ze(n,s,e)}}}class We{constructor(n=!1,f=!0){this.isVerticalRay=n,this.normalRequired=f}}const re=ke();function Bt(i,n,f,t,r,e){if(!i.visible)return;const s=ee(we,t,f),o=(l,u,a)=>{e(l,a,u,!1)},c=new We(!1,n.options.normalRequired);if(i.boundingInfo){j(i.type===De.Mesh);const l=n.tolerance;Le(i.boundingInfo,f,s,l,r,c,o)}else{const l=i.attributes.get(G.POSITION),u=l.indices;qe(f,s,0,u.length/3,u,l.data,l.stride,r,c,o)}}const Ze=J();function Le(i,n,f,t,r,e,s){if(i==null)return;const o=ot(f,Ze);if($e(re,i.bbMin),Ue(re,i.bbMax),r!=null&&r.applyToAabb(re),ft(re,n,o,t)){const{primitiveIndices:c,position:l}=i,u=c?c.length:l.indices.length/3;if(u>ct){const a=i.getChildren();if(a!==void 0){for(const M of a)Le(M,n,f,t,r,e,s);return}}et(n,f,0,u,l.indices,l.data,l.stride,c,r,e,s)}}const _=J();function Rt(i,n,f,t,r,e,s,o,c){const{data:l,stride:u}=e;qe(i,ee(we,n,i),f,t,r,l,u,s,o,c)}function Nt(i,n,f,t,r,e,s,o,c,l=null,u=0){const a=i[0],M=i[1],L=i[2],I=n[0],z=n[1],O=n[2];for(let w=f;w<t;++w){const A=u+(l?l[w]:w),E=3*A,v=s*r[E],S=e[v],R=e[v+1],h=e[v+2],p=s*r[E+1],g=e[p],y=e[p+1],d=e[p+2],m=s*r[E+2],b=g-S,B=y-R,T=d-h,x=e[m]-S,N=e[m+1]-R,P=e[m+2]-h,C=z*P-N*O,$=O*x-P*I,V=I*N-x*z,F=b*C+B*$+T*V;if(Math.abs(F)<=ae)continue;const k=a-S,U=M-R,D=L-h,q=k*C+U*$+D*V;if(F>0){if(q<0||q>F)continue}else if(q>0||q<F)continue;const K=U*T-B*D,X=D*b-T*k,Y=k*B-b*U,H=I*K+z*X+O*Y;if(F>0){if(H<0||q+H>F)continue}else if(H>0||q+H<F)continue;const Q=(x*K+N*X+P*Y)/F;Q>=0&&c(Q,A,o?ue(b,B,T,x,N,P,_):null)}}function _e(i,n,f,t,r,e,s,o){const c=i[0],l=i[1],u=i[2],a=n[0],M=n[1],L=n[2];for(let I=f;I<t;++I){const z=3*I,O=z+1,w=z+2,A=e*z,E=r[A],v=r[A+1],S=r[A+2],R=e*O,h=e*w,p=r[R]-E,g=r[R+1]-v,y=r[R+2]-S,d=r[h]-E,m=r[h+1]-v,b=r[h+2]-S,B=M*b-m*L,T=L*d-b*a,x=a*m-d*M,N=p*B+g*T+y*x;if(Math.abs(N)<=ae)continue;const P=c-E,C=l-v,$=u-S,V=P*B+C*T+$*x;if(N>0){if(V<0||V>N)continue}else if(V>0||V<N)continue;const F=C*y-g*$,k=$*p-y*P,U=P*g-p*C,D=a*F+M*k+L*U;if(N>0){if(D<0||V+D>N)continue}else if(D>0||V+D<N)continue;const q=(d*F+m*k+b*U)/N;q>=0&&o(q,I,s?ue(p,g,y,d,m,b,_):null)}}function St(i,n,f,t,r,e,s,o,c,l,u,a=null,M=0){const L=i[0],I=i[1],z=i[2],O=n[0],w=n[1],A=n[2];for(let E=f;E<t;++E){const v=M+(a?a[E]:E),S=3*v,R=s*r[S],h=e[R],p=e[R+1],g=e[R+2],y=s*r[S+1],d=e[y],m=e[y+1],b=e[y+2],B=s*r[S+2],T=e[B],x=e[B+1],N=e[B+2],P=g-c,C=o/Math.sqrt(h*h+p*p+P*P),$=h+h*C,V=p+p*C,F=g+P*C,k=b-c,U=o/Math.sqrt(d*d+m*m+k*k),D=d+d*U,q=m+m*U,K=b+k*U,X=N-c,Y=o/Math.sqrt(T*T+x*x+X*X),H=D-$,Q=q-V,te=K-F,ne=T+T*Y-$,W=x+x*Y-V,se=N+X*Y-F,me=w*se-W*A,ge=A*ne-se*O,Me=O*W-ne*w,Z=H*me+Q*ge+te*Me;if(Math.abs(Z)<=ae)continue;const de=L-$,pe=I-V,he=z-F,oe=de*me+pe*ge+he*Me;if(Z>0){if(oe<0||oe>Z)continue}else if(oe>0||oe<Z)continue;const Oe=pe*te-Q*he,Be=he*H-te*de,Re=de*Q-H*pe,fe=O*Oe+w*Be+A*Re;if(Z>0){if(fe<0||oe+fe>Z)continue}else if(fe>0||oe+fe<Z)continue;const Ne=(ne*Oe+W*Be+se*Re)/Z;Ne>=0&&u(Ne,v,l?ue(H,Q,te,ne,W,se,_):null)}}function et(i,n,f,t,r,e,s,o,c,l,u){const a=i[0],M=i[1],L=i[2],I=n[0],z=n[1],O=n[2],{normalRequired:w}=l;for(let A=f;A<t;++A){const E=o[A],v=3*E,S=s*r[v];let R=e[S],h=e[S+1],p=e[S+2];const g=s*r[v+1];let y=e[g],d=e[g+1],m=e[g+2];const b=s*r[v+2];let B=e[b],T=e[b+1],x=e[b+2];c!=null&&([R,h,p]=c.applyToVertex(R,h,p,A),[y,d,m]=c.applyToVertex(y,d,m,A),[B,T,x]=c.applyToVertex(B,T,x,A));const N=y-R,P=d-h,C=m-p,$=B-R,V=T-h,F=x-p,k=z*F-V*O,U=O*$-F*I,D=I*V-$*z,q=N*k+P*U+C*D;if(Math.abs(q)<=ae)continue;const K=a-R,X=M-h,Y=L-p,H=K*k+X*U+Y*D;if(q>0){if(H<0||H>q)continue}else if(H>0||H<q)continue;const Q=X*C-P*Y,te=Y*N-C*K,ne=K*P-N*X,W=I*Q+z*te+O*ne;if(q>0){if(W<0||H+W>q)continue}else if(W>0||H+W<q)continue;const se=($*Q+V*te+F*ne)/q;se>=0&&u(se,E,w?ue(N,P,C,$,V,F,_):null)}}function qe(i,n,f,t,r,e,s,o,c,l){const u=n,a=lt,M=Math.abs(u[0]),L=Math.abs(u[1]),I=Math.abs(u[2]),z=M>=L?M>=I?0:2:L>=I?1:2,O=z,w=u[O]<0?2:1,A=(z+w)%3,E=(z+(3-w))%3,v=u[A]/u[O],S=u[E]/u[O],R=1/u[O],h=tt,p=nt,g=st,{normalRequired:y}=c;for(let d=f;d<t;++d){const m=3*d,b=s*r[m];ie(a[0],e[b+0],e[b+1],e[b+2]);const B=s*r[m+1];ie(a[1],e[B+0],e[B+1],e[B+2]);const T=s*r[m+2];ie(a[2],e[T+0],e[T+1],e[T+2]),o&&(be(a[0],o.applyToVertex(a[0][0],a[0][1],a[0][2],d)),be(a[1],o.applyToVertex(a[1][0],a[1][1],a[1][2],d)),be(a[2],o.applyToVertex(a[2][0],a[2][1],a[2][2],d))),ee(h,a[0],i),ee(p,a[1],i),ee(g,a[2],i);const x=h[A]-v*h[O],N=h[E]-S*h[O],P=p[A]-v*p[O],C=p[E]-S*p[O],$=g[A]-v*g[O],V=g[E]-S*g[O],F=$*C-V*P,k=x*V-N*$,U=P*N-C*x;if((F<0||k<0||U<0)&&(F>0||k>0||U>0))continue;const D=F+k+U;if(D===0)continue;const q=F*(R*h[O])+k*(R*p[O])+U*(R*g[O]);if(q*Math.sign(D)<0)continue;const K=q/D;K>=0&&l(K,d,y?it(a):null)}}const tt=J(),nt=J(),st=J();function ue(i,n,f,t,r,e,s){return ie(ce,i,n,f),ie(le,t,r,e),xe(s,ce,le),Ie(s,s),s}function it(i){return ee(ce,i[1],i[0]),ee(le,i[2],i[0]),xe(_,ce,le),Ie(_,_),_}const ce=J(),le=J();function Tt(i,n,f){return ie(f,1/(n[0]-i[0]),1/(n[1]-i[1]),1/(n[2]-i[2]))}function ot(i,n){return ie(n,1/i[0],1/i[1],1/i[2])}function ft(i,n,f,t){return rt(i,n,f,t,1/0)}function rt(i,n,f,t,r){const e=(i[0]-t-n[0])*f[0],s=(i[3]+t-n[0])*f[0];let o=Math.min(e,s),c=Math.max(e,s);const l=(i[1]-t-n[1])*f[1],u=(i[4]+t-n[1])*f[1];if(c=Math.min(c,Math.max(l,u)),c<0||(o=Math.max(o,Math.min(l,u)),o>c))return!1;const a=(i[2]-t-n[2])*f[2],M=(i[5]+t-n[2])*f[2];return c=Math.min(c,Math.max(a,M)),!(c<0)&&(o=Math.max(o,Math.min(a,M)),!(o>c)&&o<r)}const ct=1e3,ae=1e-7,we=J(),lt=[J(),J(),J()];class xt{constructor(n){this.vertexBufferLayout=n}elementCount(n){return n.get(G.POSITION).indices.length}write(n,f,t,r,e,s){Ye(t,r,this.vertexBufferLayout,n,f,e,s)}intersect(n,f,t,r,e){const s=this.vertexBufferLayout.createView(n).getField(G.POSITION,ye);if(s==null)return;const o=ee(ut,r,t),c=0,l=s.elementCount/3,u=f.options.normalRequired,a=(M,L,I)=>{e(M,I,L,!1)};_e(t,o,c,l,s.typedBuffer,s.typedBufferStride,u,a)}}const ut=J();export{Ot as B,Tt as C,Ye as E,Qe as F,rt as N,Ge as O,Xe as R,Je as S,St as T,ze as a,je as b,Mt as d,xt as f,Nt as g,We as h,Bt as p,ft as w,Rt as x};
