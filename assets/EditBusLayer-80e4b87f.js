import{eF as H,_ as E,eG as L,a3 as $,f as x,j as T,a6 as p}from"./index-27db053b.js";const k=H(),P=new Map,j=new Map;async function B(e,r,a=!1){var s,d;if(!e||!r)return!0;const n=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),i=(s=j.get(n))==null?void 0:s.entries();if(i){for(const[l,c]of i)if(c.name===r){const u=!((d=c.stack)!=null&&d.hasForwardEdits());if(!u&&a){const[{deleteForwardEdits:m},{default:h}]=await Promise.all([E(()=>import("./deleteForwardEdits-d421b23e.js"),["./deleteForwardEdits-d421b23e.js","./index-27db053b.js","./index-5ad293c9.css"],import.meta.url),E(()=>import("./DeleteForwardEditsParameters-792d65f7.js"),["./DeleteForwardEditsParameters-792d65f7.js","./index-27db053b.js","./index-5ad293c9.css"],import.meta.url)]);return m(n,l,new h({sessionId:k,moment:c.moment}))}return u}}return!0}function U(e,r){var i;if(!e)return!1;const a=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=(i=j.get(a))==null?void 0:i.entries();if(n){for(const[s,d]of n)if(d.name===r)return d.lockType==="edit"}return!1}const g=new L.EventEmitter;function D(e){return g.on("apply-edits",new WeakRef(e))}function O(e){return g.on("update-moment",new WeakRef(e))}function C(e,r,a=null,n=!1){const i=$();return n=r==null||n,g.emit("apply-edits",{serviceUrl:e,layerId:r,gdbVersion:a,mayReceiveServiceEdits:n,result:i.promise}),i}const w="esri.layers.mixins.EditBusLayer",A=Symbol(w);function G(e){return e!=null&&typeof e=="object"&&A in e}function F(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function f(e,r,a){const n=new URL(e).host,i=P.get(n),s=d=>!d||d===i;return s(r)&&s(a)||r===a}const q=e=>{var r;let a=class extends e{constructor(...n){super(...n),this[r]=!0,this._applyEditsHandler=i=>{const{serviceUrl:s,layerId:d,gdbVersion:l,mayReceiveServiceEdits:c,result:u}=i,m=s===this.url,h=d!=null&&this.layerId!=null&&d===this.layerId,V=F(this),R=F(this)&&f(s,l,this.gdbVersion);if(!m||V&&!R||!h&&!c)return;const S=u.then(t=>{var y;if(h&&(t.addedFeatures.length||t.updatedFeatures.length||t.deletedFeatures.length||t.addedAttachments.length||t.updatedAttachments.length||t.deletedAttachments.length))return this.emit("edits",p(t)),t;const I=(y=t.editedFeatures)==null?void 0:y.find(({layerId:b})=>b===this.layerId);if(I){const{adds:b,updates:M,deletes:_}=I.editedFeatures,v={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:b?b.map(({attributes:o})=>({objectId:this.objectIdField&&o[this.objectIdField],globalId:this.globalIdField&&o[this.globalIdField]})):[],deletedFeatures:_?_.map(({attributes:o})=>({objectId:this.objectIdField&&o[this.objectIdField],globalId:this.globalIdField&&o[this.globalIdField]})):[],updatedFeatures:M?M.map(({current:{attributes:o}})=>({objectId:this.objectIdField&&o[this.objectIdField],globalId:this.globalIdField&&o[this.globalIdField]})):[],editedFeatures:p(t.editedFeatures),exceededTransferLimit:!1,historicMoment:p(t.historicMoment)};return this.emit("edits",v),v}return{edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:p(t.editedFeatures),exceededTransferLimit:!1,historicMoment:p(t.historicMoment)}}).then(t=>("historicMoment"in this&&this.historicMoment!==t.historicMoment&&U(s,l)&&(this.historicMoment=t.historicMoment),t));this.emit("apply-edits",{result:S})},this._updateMomentHandler=i=>{const{serviceUrl:s,gdbVersion:d,moment:l}=i,c=s===this.url,u=F(this),m=F(this)&&f(s,d,this.gdbVersion),h=F(this)&&!f(s,this.gdbVersion,null);c&&u&&m&&h&&"historicMoment"in this&&this.historicMoment!==l&&(this.historicMoment=l)},this.when().then(()=>{this.addHandles(D(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(O(this._updateMomentHandler))},()=>{})}};return r=A,a=x([T(w)],a),a};export{q as F,U as a,C as c,G as p,k as r,B as s};
