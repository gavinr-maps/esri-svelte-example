import{aO as ft,r as n,m as l,a as H,g as q,B as z,bo as Vt,N as V,aW as bt,l as W}from"./Accessor-BHnuXKD2.js";import{s as Mt}from"./AnalysisView3D-DKkik0jJ.js";import{h as nt}from"./SlicePlane-B3HtDybG.js";import{d as y,C as Dt,A as F}from"./reactiveUtils-BR0C1Kq4.js";import{W as d,Z as u,y as K,J as Z}from"./boundedPlane-Dyz2ub5d.js";import{f as J}from"./Layer-C9uQlTBT.js";import{C as Et}from"./BuildingComponentSublayer-ChbJSc37.js";import{x as Ct,L as Tt,V as St,R as lt,I as xt,H as $t,g as Q,v as kt,j as ot,A as pt,l as X,_ as Y,r as Lt,s as Ht,M as S,e as zt,C as f,c as ht,u as Ot,m as Rt,p as Gt,a as It,b as ut,t as ct,d as At,f as Bt}from"./SlicePlaneMaterial.glsl-Cdx-g5EK.js";import{t as Ft}from"./LineVisualElement-B4fIKpim.js";import{c as Kt,g as Ut}from"./screenUtils-_ZIvrt5o.js";import{p as jt,d as dt,c as mt}from"./mat4-Fi6iAz29.js";import{P as x,r as C,s as tt,g as O,u as it,E as et,A as at,o as yt}from"./vec32-Dvg_eL9J.js";import{t as Nt,n as U}from"./vec3f64-BLpZdpfb.js";import{t as qt,s as vt}from"./vec4f64-o2zAXfmz.js";import{V as st,c,M as j,x as L,O as R,a as T,t as Wt}from"./plane-4dpuo6-e.js";import{b as Zt}from"./sphere-DQxj5tsv.js";import{l as Jt,n as Qt}from"./Factory-Dp0C9G0y.js";import{m as Xt,M as wt,r as G,t as I,p as Yt,f as ti,h as ii,j as ei}from"./sliceToolConfig-hpjzEJNN.js";import{w as ai}from"./RenderObject-8TEkyAoe.js";import{C as $}from"./dragEventPipeline3D-m6RYCQo0.js";import{m as M}from"./ray-D3Okb4cY.js";import{o as si}from"./ShadedColorMaterial.glsl-BaXE-_67.js";import{p as k}from"./dragEventPipeline-D_Ldto1o.js";import{t as ri}from"./ToolIntersector-A0WvzCEW.js";import{n as D}from"./screenUtils-DyhV4TAA.js";import{h as ni}from"./lineStippleUtils-C89mzWlO.js";import{a as li,v as oi}from"./analysisViewUtils-VWx-Y-gy.js";import"./Promise-CmQqe-ke.js";import"./cast-BA_-jlhc.js";import"./index-tefRSezt.js";import"./JSONSupport-CGdeqxpk.js";import"./Clonable-DvJsj5LF.js";import"./Cyclical-CPiNl4ru.js";import"./mathUtils-DV9iOXpW.js";import"./persistable-t26j-4kt.js";import"./MD5-C9MwAd2G.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./uuid-Cl5lrJ4c.js";import"./resourceExtension-DBdDmYtS.js";import"./Point-XGrwlf63.js";import"./writer-B2bQV2uU.js";import"./Evented-DCWccWGU.js";import"./SimpleObservable-7oieNGD8.js";import"./mat4f64-Dk4dwAN8.js";import"./Polyline-BmuD2-ZN.js";import"./Extent-CBBGeHb-.js";import"./lineSegment-C-CDF7QX.js";import"./Identifiable-BrT7zvUW.js";import"./Portal-CTRRujjZ.js";import"./TimeExtent-J5qnUFx_.js";import"./timeUtils-D2X862bk.js";import"./Graphic-CFXUQZlS.js";import"./opacityUtils-CSd4XoR2.js";import"./enumeration-Cr5WIZs4.js";import"./Color-gncXBiLc.js";import"./colorUtils-Rxh2V3ai.js";import"./ActionToggle-__-l4AdQ.js";import"./jsonUtils-Cu7OBRmN.js";import"./typeUtils-BSg8Y507.js";import"./TextSymbol-BQ_NW9Xo.js";import"./collectionUtils-CbaToa73.js";import"./aaBoundingBox-CeBivBRq.js";import"./FeatureLayer-9fyQxXYm.js";import"./MultiOriginJSONSupport-nGLpCFeg.js";import"./layerContainerType-C5CzMsLd.js";import"./FeatureLayerBase-DsahGowz.js";import"./formUtils-DXUHP5lI.js";import"./Field-Cyk7Ur5d.js";import"./fieldType-L-VlbZqy.js";import"./HeightModelInfo-B3GZyQFz.js";import"./commonProperties-C0eC30J9.js";import"./ElevationInfo-Di4W6v5U.js";import"./unitConversionUtils-C4AR5obr.js";import"./lengthUtils-DjJgJFRg.js";import"./AttributeTableTemplate-B7rH2qLr.js";import"./timeZoneUtils-COos5xIr.js";import"./featureLayerUtils-BzWCGee1.js";import"./featureQueryAll-xezK3WCp.js";import"./Query-DCBIeen2.js";import"./FullTextSearch-BWm_kPUE.js";import"./layerUtils-dJgsXxkC.js";import"./SimpleRenderer-gSw1WaJS.js";import"./commonProperties-bGHL1a5M.js";import"./colorRamps-Dkx8zIVn.js";import"./SizeVariable-IzD1bP2e.js";import"./visualVariableUtils-Bp9QCb8E.js";import"./ColorStop-CDpeFWOz.js";import"./jsonUtils-Dzgxk9pw.js";import"./defaults-Dwxdhopq.js";import"./defaultsJSON-GKolV7NZ.js";import"./UniqueValueRenderer-Cri3tgP5.js";import"./diffUtils-CMkuJvD2.js";import"./RendererLegendOptions-mgfHoilI.js";import"./styleUtils-BB-zx7mT.js";import"./AttachmentQuery-BceVlzuF.js";import"./NormalizationBinParametersMixin-D6iHLB7I.js";import"./RelationshipQuery-W-4bfgaH.js";import"./LayerFloorInfo-BXAHB-yQ.js";import"./Relationship-BBBusoKs.js";import"./serviceCapabilitiesUtils-BuKg0yWx.js";import"./infoFor3D-CsJzgCF0.js";import"./workers-D8Q3pEzK.js";import"./Queue-BOnccek2.js";import"./intl-Do3GEEJ7.js";import"./editsZScale-BKYnJc2O.js";import"./queryZScale-DwN6mTru.js";import"./projection-B2I9Bzj_.js";import"./projectBuffer-DOU0xvVi.js";import"./geodesicConstants-yASAK_zX.js";import"./FeatureSet-DpCN730g.js";import"./APIKeyMixin-Btq102Nx.js";import"./ArcGISService-BHkTabnw.js";import"./ScaleRangeLayer-C59zG_yk.js";import"./jsonUtils-TjZmCq6l.js";import"./utils-DYurMneM.js";import"./mat4f32-DcsiF_Rp.js";import"./CustomParametersMixin-uo3x70vd.js";import"./DisplayFilteredLayer-BFGyM6i5.js";import"./scaleUtils-CfLu-sg1.js";import"./displayFilterUtils-DV_nOx_h.js";import"./EditBusLayer-Cx9SJosU.js";import"./FeatureEffectLayer-D3Dl2pXD.js";import"./FeatureEffect-xxsfLT-y.js";import"./FeatureFilter-DEE1jTWq.js";import"./FeatureReductionLayer-x8j38_gH.js";import"./FeatureReductionSelection-BpUGF9oj.js";import"./labelingInfo-BvMdv93l.js";import"./labelUtils-Dq8OkaT-.js";import"./jsonUtils-DD1NMzWj.js";import"./typeUtils-CfF4cYo5.js";import"./ClassBreaksRenderer-BBSNkSFx.js";import"./LRUCache-DS2O1kTf.js";import"./MemCache-CDoaVBHf.js";import"./Version-9k2AOv05.js";import"./FieldsIndex-DFdVonga.js";import"./utils-B91u8350.js";import"./defaultCIMValues-DII_GG3u.js";import"./enums-BJSSbDkD.js";import"./HeatmapColorStop-c4wClnpW.js";import"./heatmapUtils-DA7NmY3d.js";import"./vec42-YcqnINSP.js";import"./common-DQOJ18NT.js";import"./OperationalLayer-Bts9W3HA.js";import"./OrderedLayer-BP2hvfL_.js";import"./OrderByInfo-E-O9nvtm.js";import"./PortalLayer-jhi5QQgB.js";import"./PortalItem-CXk7DqVv.js";import"./portalItemUtils-rm7sAgcm.js";import"./RefreshableLayer-Cn2UpWQD.js";import"./TemporalLayer-CYEvmdjr.js";import"./TimeInfo-LjqhhubF.js";import"./TimeInterval-BDTTJ9Uw.js";import"./TrackableLayer-D6paP6wl.js";import"./FeatureTemplate-DqbLvkbZ.js";import"./FeatureType-DjGGrg1i.js";import"./fieldProperties-B9JP3-ue.js";import"./TitleCreator-Zm6TQ_ec.js";import"./versionUtils-DSsYFI36.js";import"./styleUtils-BQ_uVsZf.js";import"./popupUtils-pQ0CVidQ.js";import"./interfaces-CL2NbQte.js";import"./capabilities-De4i-OzG.js";import"./I3SIndexInfo-DP6w_-xh.js";import"./I3SLayerDefinitions-qdtC2E3S.js";import"./I3SUtil-nzJI4wHN.js";import"./projectVectorToVector-dS8io47t.js";import"./projectPointToVector-BS0u8fq6.js";import"./I3SBinaryReader-BTB-H69N.js";import"./VertexAttribute-Cq4MnHjR.js";import"./computeTranslationToOriginAndRotation-BT43Xu5d.js";import"./edgeUtils-52Urp6s4.js";import"./floatRGBA-CR2j2c7-.js";import"./NormalAttribute.glsl-BPQl43kJ.js";import"./glsl-BH37Aalp.js";import"./Matrix3PassUniform-Bhi2fM3C.js";import"./BindType-BBwFZqyN.js";import"./RgbaFloatEncoding.glsl-_io2eW3M.js";import"./Float4DrawUniform-C_Hqa-pI.js";import"./Matrix3DrawUniform-B_gSHO7v.js";import"./orientedBoundingBox-9z4w3ZAL.js";import"./mat3-CR8GKnhD.js";import"./mat3f64-BBpwCtoL.js";import"./quat-4pa1e6ds.js";import"./quatf64-CCm9z-pX.js";import"./spatialReferenceEllipsoidUtils-DM073JUd.js";import"./ViewingMode-Dodu7ZZk.js";import"./vec2f64-Dy6m9Nrb.js";import"./Attribute-B-NAci_J.js";import"./layerViewUtils-tkZ5z_iY.js";import"./popupUtils-Bp0XPfzq.js";import"./GeometryUtil-vHI0hYMT.js";import"./vec3f32-nZdmKIgz.js";import"./FloatArray-BCfeX8wo.js";import"./Material-Ba8x5bbY.js";import"./NoParameters-t-PuNrgq.js";import"./Texture-D-SqNa4i.js";import"./signal-DSa0yokC.js";import"./enums-D9v74xTE.js";import"./getDataTypeBytes-BTGR5GyG.js";import"./renderState-e7QeQoUO.js";import"./basicInterfaces-CZwQPxTp.js";import"./Indices-Db9lERgy.js";import"./InterleavedLayout-Dvj-Snan.js";import"./BufferView-_QDXRCew.js";import"./vec2-maR1OrZI.js";import"./types-D0PSWh4d.js";import"./triangle-D_E6eTS3.js";import"./ShaderTechniqueConfiguration-YrUOztAU.js";import"./requestImageUtils-Brn0e8z8.js";import"./TextureFormat-1mYWTFa-.js";import"./RibbonLine.glsl-D3IEIaDR.js";import"./mathUtils-B9R7G-2c.js";import"./sdfPrimitives-B8Jbwvqs.js";import"./doublePrecisionUtils-B0owpBza.js";import"./Octree-B-jwmuW2.js";import"./ShaderBuilder-DV1s2efh.js";import"./interfaces-D6pIddIh.js";import"./colorUtils-BAowQmkN.js";import"./ImageMaterial.glsl-DS2HLuOB.js";import"./GLTextureMaterial-BXvkeRxQ.js";import"./DefaultBufferWriter-D4XUxbP-.js";import"./DefaultLayouts-RacFqL-X.js";import"./TriangleMaterial-t01j2IAH.js";import"./VertexColor.glsl-C67vI27I.js";import"./Matrix4PassUniform-LFIUaE9i.js";import"./Object3DVisualElement-BtsT49h4.js";import"./VisualElement-D3eR6o-M.js";import"./ShaderTechniqueRepository-CuJwDr2t.js";import"./NestedMap-GuqgquCN.js";import"./RenderCoordsHelper-BbefYyBA.js";import"./projectVectorToPoint-d6Mr4zvQ.js";import"./dehydratedFeatureUtils-1rrRm6hF.js";import"./ColorMaterial.glsl-CArPvmMs.js";import"./ElevationProvider-aS5xrHHy.js";import"./line-CTiLAMHp.js";import"./hydratedFeatures-BVVSs98j.js";import"./elevationInfoUtils-RSZ4Logn.js";import"./RenderCamera-BovI3JTe.js";import"./graphicUtils-Daa6cjYT.js";import"./meshVertexSpaceUtils-SW0WEjNN.js";import"./MeshLocalVertexSpace-C0YDTRex.js";import"./Intersector-DqUGp7Vs.js";import"./intersectorUtils-l6zkk4nF.js";import"./verticalOffsetUtils-CUH6QZ7-.js";import"./InteractiveToolBase-DNJTN0p5.js";import"./EditGeometryOperations-C5kkQVhH.js";import"./geometry2dUtils-vtViF5g_.js";function pi(t){switch(t.type){case"building-scene":case"catalog":case"catalog-dynamic-group":case"catalog-footprint":case"csv":case"dimension":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"integrated-mesh-3dtiles":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"viewshed":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case"parquet":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"video":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return ft(t.type),!1}}let _=class extends q{constructor(t){super(t),this._internalChange=!1,this._currentSlicePlane=null}initialize(){this.addHandles(this.analysis.excludedLayers.on("before-add",t=>{const i=t.item;i!=null&&(i instanceof J||i instanceof Et)?i instanceof J&&pi(i)?(z.getLogger(this).error("excludedLayers",`Layer '${i.title}, id:${i.id}' of type '${i.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),t.preventDefault()):this.analysis.excludedLayers.includes(i)&&t.preventDefault():(z.getLogger(this).error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),t.preventDefault())})),ui(this.view,this),this.addHandles([y(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),y(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),y(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),y(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this.addHandles([y(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null,this._updateActiveController(),this._updateViewSlicePlane()),ci(this.view,this),this.set("view",null)}get _allLayerAndSubLayerViews(){const t=this.view.allLayerViews.items;return t.concat(t.filter(Ct).flatMap(({sublayerViews:i})=>i.items))}_updateBoundedPlaneFromSlicePlane(){const t=this.analysis.shape,i=this._currentSlicePlane;if(i==null&&t==null||i!=null&&t!=null&&t.equals(i))return;let e=null,a=null;if((t==null?void 0:t.position)!=null){const s=t.position.spatialReference,r=Tt(t,this.view);r==null&&Ft(this.analysis,s,z.getLogger(this)),e=St(r,this.view,{tiltEnabled:this.analysis.tiltEnabled},d()),e!=null&&(a={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=e,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const t=this.analysisViewData.plane,i=lt(t,this.view,this.view.spatialReference,new nt);let e=null;i!=null&&(e={heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height}),this._currentSlicePlane=e,this._internalChange=!0,this.analysis.shape=i,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(A)return;const t=_t(this.view);if(t)if(this.analysisViewData.active)t.activeController!=null&&t.activeController!==this?(A=!0,t.activeController.analysisViewData.active=!1,A=!1):t.activeController!=null&&t.activeController,this._updateLayerViews(),t.activeController=this;else{if(t.activeController!=null&&t.activeController!==this)return;t.activeController!=null&&t.activeController===this&&(t.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){hi(this.view)}_updateLayerViews(){const t=this.analysisViewData.plane!=null&&this.analysisViewData.visible&&this.analysisViewData.active,i=[],e=a=>{"layers"in a?a.layers.forEach(e):i.push(a)};this.analysis.excludedLayers.forEach(e),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=t&&!i.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=t&&!i.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=t&&!this.analysis.excludeGroundSurface)}};n([l()],_.prototype,"view",void 0),n([l()],_.prototype,"analysis",void 0),n([l()],_.prototype,"analysisViewData",void 0),n([l()],_.prototype,"_allLayerAndSubLayerViews",null),_=n([H("esri.views.3d.analysis.Slice.SliceController")],_);const g=new Map;let A=!1;function hi(t){const i=_t(t),e=i==null?void 0:i.activeController;(e==null?void 0:e.analysisViewData.plane)!=null&&e.analysisViewData.visible?t.slicePlane=e.analysisViewData.plane:t.slicePlane=null}function ui(t,i){var e;g.has(t)||g.set(t,{all:[],activeController:null}),(e=g.get(t))==null||e.all.push(i)}function _t(t){return g.get(t)}function ci(t,i){if(!g.has(t))throw new Error("view expected in global slice register");const e=g.get(t),a=(e==null?void 0:e.all.lastIndexOf(i))??-1;if(!e||a===-1)throw new Error("controller expected in global slice register");e.all.splice(a,1),e.all.length===0&&g.delete(t)}var N;let h=N=class extends si{constructor(t){super(t),this._clock=Vt,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this._layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._frameTask=null,this._pointerMoveTimerMs=Xt,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=d(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=Kt(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=ri(t.view.state.viewingMode)}initialize(){var p;if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");const t=o=>{this._updateManipulatorsInteractive(o),o.grabbing||(this.analysisViewData.plane!=null&&u(this.analysisViewData.plane,this._startPlane),this.inputState=null)},i=new xt(this.view,$t.CENTER_ON_ARROW);this.shiftManipulator=i,this.manipulators.add(i),this.addHandles([this._createShiftDragPipeline(i),i.events.on("grab-changed",o=>{this._onShiftGrab(o),t(i)})]);const e=!((p=this.view._stage)!=null&&p.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result),a=new Q(this.view,(o,v)=>Jt(this.view.textures,{accentColor:o,contrastColor:v,preMultiplyAlpha:e}));this.rotateHeadingManipulator=a,this.manipulators.add(a),this.addHandles([this._createRotateHeadingDragPipeline(a),a.events.on("grab-changed",o=>{this._onRotateHeadingGrab(o),t(a)})]);const s=new Q(this.view,(o,v)=>Qt(this.view.textures,{accentColor:o,contrastColor:v,preMultiplyAlpha:e}));this.rotateTiltManipulator=s,this.manipulators.add(s),this.addHandles([this._createRotateTiltDragPipeline(s),s.events.on("grab-changed",o=>{this._onRotateTiltGrab(o),t(s)})]),this.resizeManipulators=this._resizeHandles.map((o,v)=>{const P=new kt(this.view,o);return this.addHandles([this._createResizeDragPipeline(P),P.events.on("grab-changed",b=>{this._onResizeGrab(b,v),t(P)})]),P}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=ot(this.view),this._previewPlaneOutlineVisualElement=pt(this.view),this._previewPlaneOutlineVisualElement.width=wt,this.addHandles(y(()=>[this.analysisViewData.plane,this.analysis.tiltEnabled],()=>this._updateManipulators(),Dt));const r=y(()=>this.state,o=>{o==="sliced"&&this.finishToolCreation()},F);this.addHandles([r,y(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=V(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=V(this._previewPlaneGridVisualElement)}get state(){const t=!!this.analysisViewData.plane,i=!!this.inputState;return t?t&&i?"slicing":t&&!i?"sliced":"ready":"ready"}get cursor(){return this._isPlacingSlicePlane||this.layersMode==="exclude"?"crosshair":this._creatingPointerId!=null?"grabbing":null}set analysis(t){if(t==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.removeHandles("analysis"),this._set("analysis",t)}get layersMode(){return this._layersMode}get inputState(){return this._get("inputState")}set inputState(t){this._set("inputState",t),this.analysisViewData.showGrid=t!=null&&t.type==="resize",this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.analysisViewData.plane&&this.active}get _creatingPointerId(){return this.inputState!=null&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){this.analysisViewData.plane!=null&&(this._layersMode="exclude",this.active||(this.view.activeTool=this))}exitExcludeLayerMode(){this.analysisViewData.plane!=null&&(this._layersMode="none",this.active&&(this.view.activeTool=null))}onDeactivate(){this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(t){this._updateManipulators(),t||this._clearPointerMoveTimeout()}onInputEvent(t){switch(t.type){case"pointer-drag":if(!B(t))return;this._isPlacingSlicePlane?this._onClickPlacePlane(t)&&t.stopPropagation():this._onPointerDrag(t)&&t.stopPropagation();break;case"pointer-move":this._onPointerMove(t);break;case"pointer-up":this._onPointerUp(t)&&t.stopPropagation();break;case"immediate-click":if(!B(t))return;this._onClickPlacePlane(t)&&t.stopPropagation();break;case"click":if(!B(t))return;this._onClickExcludeLayer(t)&&t.stopPropagation();break;case"drag":this.inputState&&t.stopPropagation();break;case"key-down":this._onKeyDown(t)&&t.stopPropagation();break;case"key-up":this._onKeyUp(t)&&t.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(t){const i=this.inputState;if(t.pointerId===this._creatingPointerId&&i!=null&&i.type==="shift"){const e=D(t);return this.shiftManipulator.events.emit("drag",{action:i.hasBeenDragged?"update":"start",pointerType:t.pointerType,start:e,screenPoint:e}),i.hasBeenDragged=!0,!0}return!1}_onPointerMove(t){this._lastCursorPosition.x=t.x,this._lastCursorPosition.y=t.y,this._resetPointerMoveTimeout(),t.pointerType!=="touch"&&this._updatePreviewPlane(D(t),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(t){if(t.pointerId===this._creatingPointerId&&this.analysisViewData.plane!=null){const i=D(t);return this.shiftManipulator.events.emit("drag",{action:"end",start:i,screenPoint:i}),u(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(t){if(this.layersMode==="exclude")return!1;if(this._isPlacingSlicePlane){const i=D(t),e=d();if(this._pickPlane(i,!1,this._activeKeyModifiers,e)){if(t.type==="pointer-drag"){const a=M(this.view.state.camera,i,E);this.inputState=rt(a,t.pointerId,e.origin,e)}return u(e,this._startPlane),this.analysis.shape=lt(e,this.view,this.view.spatialReference,new nt),!0}}return!1}_onClickExcludeLayer(t){return!(this.layersMode!=="exclude"||!this.created)&&(this.view.hitTest(D(t)).then(i=>{if(i.results.length){const e=i.results[0],a=(e==null?void 0:e.type)==="graphic"&&e.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else i.ground.layer?this.analysis.excludedLayers.push(i.ground.layer):this.analysis.excludeGroundSurface=!0}),this.exitExcludeLayerMode(),!0)}_onKeyDown(t){return(t.key===G||t.key===I)&&(this._activeKeyModifiers[t.key]=!0,this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(t){return!(t.key!==G&&t.key!==I||!this._activeKeyModifiers[t.key])&&(delete this._activeKeyModifiers[t.key],this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const i=M(this.view.state.camera,t.screenPoint,E);u(this.analysisViewData.plane,this._startPlane),this.inputState=rt(i,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(t){return k(t,(i,e,a)=>{const s=this.inputState;if(s==null||s.type!=="shift")return;const r=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;e.next($(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{r!=null&&this._updateBoundedPlane(r)})})}_shiftDragAdjustSensitivity(t){return i=>{if(this.analysisViewData.plane==null)return null;const e=.001,a=Math.min((1-Math.abs(x(K(this.analysisViewData.plane),i.ray.direction)/C(i.ray.direction)))/e,1),s=-st(this._startPlane.plane,i.renderEnd),r=-st(this._startPlane.plane,t.startPoint);return t.depth=t.depth*(1-a)+s*a-r,i}}_shiftDragUpdatePlane(t){return()=>{if(this.analysisViewData.plane==null)return;const i=tt(c.get(),this._startPlane.origin),e=tt(c.get(),K(this._startPlane));O(e,e,-t.depth),it(e,e,i);const a=Z(e,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,d());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const i=X(this.analysisViewData.plane,this.view.renderCoordsHelper,Y.HEADING,j()),e=M(this.view.state.camera,t.screenPoint,E),a=U();L(i,e,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:i,startPoint:a})}_createRotateHeadingDragPipeline(t){return k(t,(i,e,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const r=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;e.next($(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{r!=null&&this._updateBoundedPlane(r)})})}_onRotateTiltGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const i=X(this.analysisViewData.plane,this.view.renderCoordsHelper,Y.TILT,j()),e=M(this.view.state.camera,t.screenPoint,E),a=U();L(i,e,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:i,startPoint:a})}_createRotateTiltDragPipeline(t){return k(t,(i,e,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const r=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;e.next($(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{r!=null&&this._updateBoundedPlane(r)})})}_rotateDragRenderPlaneToRotate(t){return i=>{if(this.analysisViewData.plane==null)return null;const e=R(t.rotatePlane),a=ai(t.startPoint,i.renderEnd,this.analysisViewData.plane.origin,e);return{...i,rotateAxis:e,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return t=>{if(this.analysisViewData.plane==null)return;const i=jt(T.get(),t.rotateAngle,t.rotateAxis);if(i==null)return;const e=et(c.get(),this._startPlane.basis1,i),a=et(c.get(),this._startPlane.basis2,i),s=Z(this.analysisViewData.plane.origin,e,a,d());this._updateBoundedPlane(s)}}_onResizeGrab(t,i){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const e=M(this.view.state.camera,t.screenPoint,E),a=c.get();L(this.analysisViewData.plane.plane,e,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:i,startPoint:Nt(a)})}_createResizeDragPipeline(t){return k(t,(i,e,a)=>{const s=this.inputState;if(s==null||s.type!=="resize"||this.analysisViewData.plane==null)return;const r=u(this.analysisViewData.plane,d());e.next($(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(r)})})}_resizeDragUpdatePlane(t){return i=>{if(this.analysisViewData.plane==null)return;const e=this._resizeHandles[t.activeHandleIdx],a=Lt(e,t.startPoint,i.renderEnd,this.view.state.camera,this._startPlane,u(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(t){const i=this.analysisViewData;if(i==null)throw new Error("valid internal object expected");i.plane=t}_updatePreviewPlane(t,i={}){let e=this._previewPlane;if(this._previewPlane=null,t==null)return this._removeFrameTask(),void this._updateManipulators();if(!this.analysisViewData.plane&&this.active){const a=e??d();if(e=e!=null?u(e,mi):null,this._pickPlane(t,!0,i,a)){const s=ti;let r=!1;e!=null&&(r=x(R(e.plane),R(a.plane))<s||x(at(c.get(),e.basis1),at(c.get(),a.basis1))<s),r&&(this._previewPlaneOpacity=0),this._previewPlane=a}}this._previewPlane!=null&&this._frameTask==null&&this._previewPlaneOpacity===0?this._frameTask=bt({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*Yt),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):this._previewPlane==null&&this._frameTask!=null?this._removeFrameTask():this._previewPlane!=null&&this._updateManipulators()}_removeFrameTask(){this._frameTask=W(this._frameTask)}_pickMinResult(t){const i=Ut(t,Wt.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector),this._intersector.results.min}_pickPlane(t,i,e,a){const s=this._pickMinResult(t),r=c.get();if(!s.getIntersectionPoint(r))return!1;const p=s.getTransformedNormal(c.get()),o=this.view.state.camera;x(p,o.viewForward)>0&&O(p,p,-1);const v=Ht(r,o),P=(i?1:-1)*v*ii,b=O(c.get(),p,P);it(b,b,r);const gt=this.analysis.tiltEnabled?S.TILTED:S.HORIZONTAL_OR_VERTICAL,Pt=e[G]?S.VERTICAL:e[I]?S.HORIZONTAL:gt;return zt(b,p,v,v,o,Pt,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=W(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=f,this.rotateHeadingManipulator.state|=f,this.rotateTiltManipulator.state|=f,this._prevPointerMoveTimeout=this._clock.setTimeout(()=>{this.shiftManipulator.state&=~f,this.rotateHeadingManipulator.state&=~f,this.rotateTiltManipulator.state&=~f},this._pointerMoveTimerMs)}_updateManipulators(){if(N.disableEngineLayers)return;let t,i=!1;if(this.analysisViewData.plane!=null)t=this.analysisViewData.plane,i=!1;else{if(this._previewPlane==null)return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(p=>p.available=!1),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);t=this._previewPlane,i=!0}const e=ht(t,T.get());i?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(p=>p.available=!1),this._previewPlaneOutlineVisualElement.attached=!0,this._previewPlaneGridVisualElement.attached=!0,this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.analysis.tiltEnabled,this.resizeManipulators.forEach(p=>p.available=!0),Ot(this.shiftManipulator,e,t,this.view.state.camera),Rt(this.rotateHeadingManipulator,e,t,this.view.renderCoordsHelper),Gt(this.rotateTiltManipulator,e,t),this.resizeManipulators.forEach((p,o)=>It(p,this._resizeHandles[o],e,t)),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=yt(c.get(),C(t.basis1),C(t.basis2),1),s=dt(T.get(),a),r=mt(s,e,s);this._previewPlaneOutlineVisualElement.transform=r,this._previewPlaneGridVisualElement.transform=r,this._updateMaterials()}_updateMaterials(){const t=ut(this.view.effectiveTheme);t[3]*=this._previewPlaneOpacity;const i=qt(ct);i[3]*=this._previewPlaneOpacity,this._previewPlaneOutlineVisualElement.color=t,this._previewPlaneGridVisualElement.backgroundColor=i,this._previewPlaneGridVisualElement.gridColor=vt}_updateManipulatorsInteractive(t){if(!t.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(i=>{i.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===t,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===t,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===t,this.resizeManipulators.forEach(i=>{i.interactive=i===t})}get test(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:t=>{this._pointerMoveTimerMs=t}}}};h.disableEngineLayers=!1,n([l()],h.prototype,"_clock",void 0),n([l({constructOnly:!0})],h.prototype,"view",void 0),n([l()],h.prototype,"analysisViewData",void 0),n([l({readOnly:!0})],h.prototype,"state",null),n([l({readOnly:!0})],h.prototype,"cursor",null),n([l()],h.prototype,"analysis",null),n([l()],h.prototype,"removeIncompleteOnCancel",void 0),n([l()],h.prototype,"_layersMode",void 0),n([l()],h.prototype,"layersMode",null),n([l({value:null})],h.prototype,"inputState",null),n([l()],h.prototype,"_isPlacingSlicePlane",null),n([l()],h.prototype,"_creatingPointerId",null),h=N=n([H("esri.views.3d.analysis.Slice.SliceTool")],h);const di=h;function rt(t,i,e,a){const s=At(e,K(a),t.direction,j()),r=U();return L(s,t,r)?{type:"shift",creatingPointerId:i,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:r}:null}function B(t){return t.pointerType!=="mouse"||t.button===0}const mi=d(),E=Zt();let w=class extends q{constructor(t){super(t),this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const t=this.analysisViewData;if(t==null)throw new Error("expected internal object to be valid");this._gridVisualElement=ot(this.view),this._outlineVisualElement=pt(this.view),this.addHandles([y(()=>{const i=t.plane!=null&&this.analysisViewData.visible,{active:e}=this.analysisViewData,{preview:a,showGrid:s,view:r}=this,{effectiveTheme:p}=r;return{visible:i,active:e,preview:a,showGrid:s,gridColor:Bt(p),outlineColor:ut(p)}},i=>this._updateMaterials(i),F),y(()=>t.plane,i=>this._updatePlane(i),F)],"internal")}destroy(){this._gridVisualElement=V(this._gridVisualElement),this._outlineVisualElement=V(this._outlineVisualElement),this.set("view",null)}_updatePlane(t){if(t==null)return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const i=yt(c.get(),C(t.basis1),C(t.basis2),1),e=dt(T.get(),i),a=ht(t,T.get()),s=mt(e,a,e);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:t,active:i,preview:e,showGrid:a,gridColor:s,outlineColor:r}){this._outlineVisualElement.color=r,this._outlineVisualElement.width=e?wt:ei,this._outlineVisualElement.stipplePattern=i?null:ni(5),this._gridVisualElement.backgroundColor=ct,this._gridVisualElement.gridColor=a?s:vt,this._gridVisualElement.visible=t,this._outlineVisualElement.visible=t}};n([l()],w.prototype,"view",void 0),n([l()],w.prototype,"analysis",void 0),n([l()],w.prototype,"analysisViewData",void 0),n([l()],w.prototype,"showGrid",void 0),n([l()],w.prototype,"preview",void 0),w=n([H("esri.views.3d.analysis.Slice.SliceVisualization")],w);let m=class extends Mt(q){constructor(t){super(t),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0}initialize(){this.analysisVisualization=new w({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new _({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(li(this,di))}destroy(){oi(this),this.analysisVisualization=V(this.analysisVisualization),this.analysisController=V(this.analysisController)}get showGrid(){var t;return((t=this.analysisVisualization)==null?void 0:t.showGrid)??!1}set showGrid(t){this.analysisVisualization&&(this.analysisVisualization.showGrid=t)}get editable(){return!this.analysisVisualization.preview}set editable(t){this.analysisVisualization.preview=!t}get testData(){}};n([l({readOnly:!0})],m.prototype,"type",void 0),n([l({constructOnly:!0,nonNullable:!0})],m.prototype,"analysis",void 0),n([l()],m.prototype,"tool",void 0),n([l()],m.prototype,"plane",void 0),n([l()],m.prototype,"active",void 0),n([l()],m.prototype,"showGrid",null),n([l()],m.prototype,"editable",null),m=n([H("esri.views.3d.analysis.SliceAnalysisView3D")],m);const Nr=m;export{Nr as default};
