import{n as N}from"./vec2f64-miziP1SN.js";import{n as Y}from"./vec3f64-BLpZdpfb.js";import{r as B,s as _,n as D}from"./vec4f64-o2zAXfmz.js";import{l as p}from"./Color-BCS62Hs5.js";import{i as W,c as j}from"./fontUtils-BKHqaMFz.js";import{n as I,m as z,a as G}from"./subclass-BZA_h8Db.js";import{u as S}from"./screenUtils-_ZIvrt5o.js";import{r as x}from"./tslib.es6-B3Jf3DVX.js";import{b as H,a as F,B as C,l as E}from"./Accessor-BLX9ikPh.js";import{o as X}from"./Evented-BHRw9x22.js";import{E as J,s as V}from"./vec42-YcqnINSP.js";import{e as q}from"./Material-_xx7OZxD.js";import{n as v}from"./Texture-Fac_8AOC.js";import{g as K,o as Q}from"./Scheduler-CJu5awNf.js";import{D as Z,L as tt}from"./enums-D9v74xTE.js";import{e as et,m as st}from"./Texture-Begq2x5n.js";import{o as m}from"./interfaces-DDtDqZYj.js";class Tt{constructor(t,e="center",i=!1,r=N(),n=B(0,0,0,-1),a="world",o=Y(),h=0){this.verticalOffset=t,this.anchor=e,this.hasLabelVerticalOffset=i,this.screenOffset=r,this.centerOffset=n,this.centerOffsetUnits=a,this.translation=o,this.elevationOffset=h}}let Rt=class{constructor(t,e="center",i="center",r=null,n=N()){this.placement=t,this.horizontalPlacement=e,this.verticalPlacement=i,this.text=r,this.displaySize=n}};class L{constructor(t){this.definition=t,this.key=JSON.stringify(t),this.haloSize=Math.round(t.halo.size),this.textStyle=M(t.color),this.haloStyle=it(t.halo.color),this.backgroundStyle=t.background.color[3]!==0?M(t.background.color):null}fontString(t){const e=this.definition.font;return`${e.style} ${e.weight} ${t}px ${e.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(t,e){t.font=this.fontString(e),t.textAlign="left",t.textBaseline="alphabetic"}static async fromSymbol(t,e){var y,b,k,T,R;const i=(y=t==null?void 0:t.material)==null?void 0:y.color,r=p.toUnitRGBA(i)??_,n=t.size!=null?S(t.size):12,a=t.lineHeight,o=t.background!=null?p.toUnitRGBA(t.background.color):_,h={family:((b=t.font)==null?void 0:b.family)??"sans-serif",decoration:((k=t.font)==null?void 0:k.decoration)??"none",weight:((T=t.font)==null?void 0:T.weight)??"normal",style:((R=t.font)==null?void 0:R.style)??"normal"},l=t.halo,U=(l==null?void 0:l.color)!=null&&l.size>0?{size:S(l.size),color:p.toUnitRGBA(l.color)}:{size:0,color:_},w=new L({color:r,size:n,background:{color:o,padding:t.background!=null?[.65*n,.5*n]:[0,0],borderRadius:t.background!=null?n*(6/16):0},lineSpacingFactor:a,font:h,halo:U,pixelRatio:e});if(t.font){let $=!1;const A=w.fontString(n);try{$=(await document.fonts.load(A)).some(g=>!W(g))}catch{I.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${A}'. Some text symbology may be rendered using the default browser font.`)}if(!$&&!rt.has(t.font.family))try{await j(t.font)}catch{}}return w}}function it(s){return`rgb(${s.slice(0,3).map(t=>Math.floor(255*t)).toString()})`}function M(s){return`rgba(${s.slice(0,3).map(t=>Math.floor(255*t)).toString()},${s[3]})`}const rt=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),c=4096;let f=class extends H{constructor(s){super(s),this.type=q.Texture,this.id=F(),this.events=new X,this._glTexture=null,this._atlas=new at(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view._stage,this._stage.add(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=C(this._glTexture),this._frameWorker=E(this._frameWorker),this.updating=!1,this.events.emit("unloaded")}get glTexture(){return this._glTexture}static get maxSize(){return u=0,[c-d-u,c-d-u-O]}load(s){if(this._glTexture)return this._glTexture;const t=new et;return t.wrapMode=Z.CLAMP_TO_EDGE,t.samplingMode=tt.LINEAR_MIPMAP_LINEAR,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=s.parameters.maxMaxAnisotropy,this._glTexture=new st(s,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(K.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=E(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=C(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(s){this._canvas.width=s.width,this._canvas.height=s.height}_resizeAtlas(s,t){var r,n;const{width:e,height:i}=this._atlas;e===s&&i===t||(this._atlas.width=s,this._atlas.height=t,(r=this._glTexture)==null||r.resize(s,t),(n=this._glTexture)==null||n.updateData(0,0,0,e,i,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach(a=>{var o;return(o=this._uvCallbacks.get(a.textRenderer.key))==null?void 0:o.forEach(h=>h(a.uv))}),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(s,t,e,i){const r=this._atlas;if(r.width<e||r.height<i)return!1;let n=r.cursors.get(i);if(!n){if(r.height<r.nextY+i)return!1;n=[new P(r.nextY)],r.cursors.set(i,n),r.nextY+=i}let a=n.find(o=>r.width>=o.x+e);if(a==null){if(r.height<r.nextY+i)return!1;a=new P(r.nextY),r.nextY+=i,n.push(a)}return s.setNewPosition(a),this._elements.set(t,s),this._elementsToRender.set(t,s),a.x+=e,!0}_ensureCallbacks(s){const t=this._uvCallbacks.get(s);if(t)return t;const e=new Set;return this._uvCallbacks.set(s,e),e}_addCallback(s,t){this._ensureCallbacks(s).add(t)}_removeCallback(s,t){const e=this._uvCallbacks.get(s);return!(!(e!=null&&e.delete(t))||e.size!==0)&&(this._uvCallbacks.delete(s),!0)}_processAddition(s){const t=s.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,s);const e=this._atlas,i=s.textRenderer.renderedWidth,r=s.textRenderer.renderedHeight,n=i+d,a=r+d+O;if(!this._addAtlasElement(s,t,n,a)){if(this._canRepack)this._reset();else if(e.width<n){const o=Math.min(v(Math.max(n,1.5*e.width)),c);this._resizeAtlas(o,e.height)}else{const o=e.nextY+a,h=Math.min(v(Math.max(o,1.5*e.height)),c);if(h>e.height)this._resizeAtlas(e.width,h);else if(e.width<c){const l=Math.min(v(1.5*e.width),c);this._resizeAtlas(l,e.height)}}this._elements.set(t,s)}}_renderElement(s){var i;const t=s.commitNewPosition(),e=s.textRenderer;this._ctx.clearRect(t[0]-d,t[1]-d,e.renderedWidth+2*d,e.renderedHeight+2*d),e.render(this._ctx,t[0],t[1]),(i=this._uvCallbacks.get(e.key))==null||i.forEach(r=>r(s.uv))}get running(){return this.updating}runTask(s){if(this._glTexture==null)return Q;for(;this._needsRepack&&(this._canRepack||this._atlas.height<c&&this._atlas.height<c);){this._canRepack=this._needsRepack=!1;const t=this._elements;this._elements=new Map,t.forEach(e=>this._processAddition(e)),s.madeProgress()}if(this._elementsToRender.size>0){for(const[t,e]of this._elementsToRender){if(s.done)break;this._renderElement(e),this._elementsToRender.delete(t),s.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(s,t){const e=s.key;this._addCallback(e,t);let i=this._elements.get(e);return i?J(i.uv,_)||t(i.uv):(i=new nt(this._atlas,s),this._processAddition(i),this.setDirty()),{remove:()=>this._removeText(s,t)}}_removeText(s,t){const e=s.key;this._elements.get(e)&&this._removeCallback(e,t)&&(this._elements.delete(e),this._elementsToRender.delete(e),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}};x([z({constructOnly:!0})],f.prototype,"view",void 0),x([z({type:Boolean})],f.prototype,"updating",void 0),f=x([G("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],f);const d=2,O=2;class nt{constructor(t,e){this._atlas=t,this.textRenderer=e,this._uv=D(),this._newPosition=[0,0]}get uv(){if(this._xOffset==null||this._yOffset==null)return _;const{renderedWidth:t,renderedHeight:e}=this.textRenderer;return V(this._uv,this._xOffset/this._atlas.width,(this._yOffset+e)/this._atlas.height,(this._xOffset+t)/this._atlas.width,this._yOffset/this._atlas.height)}setNewPosition(t){this._newPosition[0]=t.x,this._newPosition[1]=t.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class at{constructor(t,e){this.width=t,this.height=e,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=u}}class P{constructor(t){this.y=t,this.x=u}}let u=0;function At(s,t){t.spherical?s.vertex.code.add(m`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):s.vertex.code.add(m`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),t.spherical?s.vertex.code.add(m`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):s.vertex.code.add(m`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}export{Rt as a,Tt as i,f as k,At as r,L as s};
