const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./featureUtils-BovNToiy.js","./Accessor-BmwT4B0c.js","./Promise-DfET-uns.js","./cast-CsZslgGN.js","./index-4eY77cms.js","./index-Cx51aysm.css","./JSONSupport-DcrLLGjL.js","./intl-Duiy0OzY.js","./opacityUtils-Dim20wpZ.js","./Point-Cz2JYYmX.js","./writer-DKgfqj4X.js","./layerUtils-B__v9OBu.js","./utils-v4CMtYiY.js","./reactiveUtils-XM7cS2OP.js","./Evented-Dw4_VOGn.js","./SimpleObservable-CvOkykwM.js","./mat4f32-DcsiF_Rp.js","./mat4-Fi6iAz29.js","./vec3f64-BLpZdpfb.js","./common-DQOJ18NT.js","./timeZoneUtils-DxzjpEBb.js"])))=>i.map(i=>d[i]);
import{_ as f}from"./index-4eY77cms.js";import{g as h,r as n,m as o,a as m}from"./Accessor-BmwT4B0c.js";import{a as y,V as x}from"./reactiveUtils-XM7cS2OP.js";import{o as g,k as _,X as T}from"./opacityUtils-Dim20wpZ.js";const I="relationships/",v="expression/";let a=class extends h{constructor(e){super(e),this._featureUtils=null,this.effectivePopupTemplate=null}get _arcadeTask(){return this.expressionsUsedInTitle.length>0?this._get("_arcadeTask")||y(()=>g()):null}get featureUtilsPromise(){return this._get("featureUtilsPromise")??f(()=>import("./featureUtils-BovNToiy.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]),import.meta.url).then(e=>this._featureUtils=e)}get calculatedExpressions(){var t;const e=new x;if(!this.expressionsUsedInTitle.length)return e;if(!((t=this._arcadeTask)!=null&&t.value)){for(const s of this.expressionsUsedInTitle??[])e.push({name:s.name,invalid:!0});return e}for(const s of this.expressionsUsedInTitle)try{const i=this._arcadeTask.value.arcade.parseScript(s.expression,["$layer","$map","$datastore"]);if(i.isAsync){e.push({name:s.name,invalid:!0});break}e.push({name:s.name,syntax:i,invalid:!1,func:this._arcadeTask.value.arcade.compileScript(i,{vars:{$feature:"any"}})})}catch{e.push({name:s.name,invalid:!0});break}return e}get expressionsUsedInTitle(){var t,s,i;let e=((t=this.effectivePopupTemplate)==null?void 0:t.title)??"";return typeof e!="string"?[]:(e=e.toLowerCase(),((i=(s=this.effectivePopupTemplate)==null?void 0:s.expressionInfos)==null?void 0:i.filter(r=>e.includes(`{expression/${r.name.toLowerCase()}}`)))??[])}get fieldInfoMap(){return this._featureUtils?this._createFieldInfoMap(this._featureUtils.getAllFieldInfos(this.effectivePopupTemplate)):null}get hasBadExpressions(){return this.calculatedExpressions.some(e=>e.invalid===!0)}get requiredFields(){var s,i;const e=new Set;if((s=this._arcadeTask)!=null&&s.value&&!this.hasBadExpressions)for(const r of((i=this.calculatedExpressions)==null?void 0:i.toArray())??[])try{const l=this._arcadeTask.value.arcade.extractFieldLiterals(r.syntax);for(const d of l){const u=d.split("."),p=this.fieldsIndex.get(u.at(-1)??"");p&&e.add(p.name)}}catch{}const t=this._extractFieldNames(this.workingTitle);for(const r of t){const l=this.fieldsIndex.get(r);l&&e.add(l.name)}return e}get titleFromDisplayField(){var t,s;let e="";return this.displayField&&(e=((t=this.fieldsIndex.get(this.displayField))==null?void 0:t.name)??""),e||(e=((s=this.fieldsIndex.get(this.objectIdField))==null?void 0:s.name)??""),e?`{${e}}`:""}get workingTitle(){const e=this.effectivePopupTemplate?this.effectivePopupTemplate.title:"";return e===""||e==null||this.hasBadExpressions||typeof e!="string"?this.titleFromDisplayField:e}async getTitle(e,t,s){var i;try{const{attributes:r}=t,l=(s==null?void 0:s.timeZone)??"system",[{substituteFieldsInLinksAndAttributes:d}]=await Promise.all([this.featureUtilsPromise,(i=this._arcadeTask)==null?void 0:i.promise]);if(s.fetchMissingFields&&(t=await this._checkAndReQueryGraphic(e,t)),this.workingTitle&&this.fieldInfoMap){const u=this._createFormattedAttributes(e,t,l).global;return d({attributes:r,expressionAttributes:null,fieldInfoMap:this.fieldInfoMap,globalAttributes:u,layer:e,text:this.workingTitle})}return""}catch{}return""}async _checkAndReQueryGraphic(e,t){const s=t.getObjectId();if(s==null)return t;if(!_(this.requiredFields,t)){const i=e.createQuery();i.where="1=1",i.outFields=[...this.requiredFields],i.objectIds=[s];const r=await e.queryFeatures(i);if((r==null?void 0:r.features.length)===1)return r.features[0]}return t}_createFieldInfoMap(e){const t=new Map;if(!e)return t;for(const s of e){if(!s.fieldName)continue;const i=this.fieldsIndex.get(s.fieldName),r=(i==null?void 0:i.name)??s.fieldName;s.fieldName=r,t.set(r.toLowerCase(),s)}return t}_createFormattedAttributes(e,t,s="system"){var d,u;const i=((d=this.effectivePopupTemplate)==null?void 0:d.fieldInfos)??[],r={};if(!this._featureUtils)return{};if(!this.hasBadExpressions&&this.calculatedExpressions.length>0&&((u=this._arcadeTask)!=null&&u.value)){const p=this._arcadeTask.value.Feature.createFromGraphicLikeObject(t.geometry,t.attributes,e,null);for(const c of this.calculatedExpressions)try{r[`expression/${c.name}`]=c.func({vars:{$feature:p}})}catch{}}const l={...t.attributes,...r};return{global:this._featureUtils.formatAttributes({fieldInfos:i,attributes:l,graphic:t,timeZone:s,layer:e,fieldInfoMap:this.fieldInfoMap}),content:[]}}_extractFieldNames(e){return T(e).filter(t=>!(t.indexOf(I)===0||t.indexOf(v)===0))}};n([o({readOnly:!0})],a.prototype,"_arcadeTask",null),n([o()],a.prototype,"_featureUtils",void 0),n([o({readOnly:!0})],a.prototype,"featureUtilsPromise",null),n([o({readOnly:!0})],a.prototype,"calculatedExpressions",null),n([o()],a.prototype,"displayField",void 0),n([o()],a.prototype,"effectivePopupTemplate",void 0),n([o()],a.prototype,"expressionsUsedInTitle",null),n([o()],a.prototype,"fieldsIndex",void 0),n([o()],a.prototype,"fieldInfoMap",null),n([o()],a.prototype,"fields",void 0),n([o()],a.prototype,"objectIdField",void 0),n([o()],a.prototype,"requiredFields",null),a=n([m("esri.layers.support.TitleCreator")],a);const P=a;export{P as u};
