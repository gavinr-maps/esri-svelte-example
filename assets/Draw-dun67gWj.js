import{r as s}from"./tslib.es6-B3Jf3DVX.js";import{q as D,j as Z,b as M}from"./Accessor-BLX9ikPh.js";import{g as $,m as n,a as w}from"./subclass-BZA_h8Db.js";import"./geometry-D964gYQX.js";import{o as L}from"./Evented-BHRw9x22.js";import{f as S}from"./screenUtils-_ZIvrt5o.js";import R from"./GraphicsLayer-i3FeUJ_n.js";import{e as z}from"./projectVectorToVector-G2uWGoIb.js";import{l as T}from"./ViewingMode-Dodu7ZZk.js";import{d as F}from"./SnappingVisualizer2D-Br8KvMdL.js";import{P as N,E as I,p as U,a as E}from"./EditGeometryOperations-Cl8Sbfxr.js";import{e as K}from"./SnappingContext-lR2hMWGP.js";import{p as j}from"./SnappingOperation-CaI4DIP4.js";import{_ as r}from"./InputManager-Ba9xzDpe.js";import{p as a}from"./keybindings-DoOdil3D.js";import{n as p}from"./screenUtils-WcqhHU65.js";import{j as O}from"./Point-Cg0-ChZE.js";import{u as Y}from"./elevationInfoUtils-BC_66_Fg.js";import{F as q,l as B,c as J,a as k,e as G,b as Q}from"./surfaceCoordinateSystems-DhFxihAh.js";import{n as W}from"./InteractiveToolBase-vg6J8uyT.js";var f;let l=f=class extends L.EventedAccessor{constructor(t){super(t),this._hasZ=null,this._cursorScreenPoint=null,this._activePointerId=null,this._stagedVertexUnsnapped=null,this._lastVertexUnsnapped=null,this.interactiveUndoDisabled=!1,this.history=[],this.redoHistory=[],this.snapToScene=!1,this.view=null,this.elevationInfo=null,this.defaultZ=0,this._coordinateHelper=N(!!t.hasZ,!1,t.view.spatialReference),this._snappingManager=t.snappingManager,this._editGeometryOperations=new I(new U(t.editGeometryType??"polygon",this._coordinateHelper),T.Local),this._snappingGraphicsLayer=new R({id:f.SNAPPING_GRAPHICS_LAYER_ID,listMode:"hide",internal:!0}),this._snappingContext=new K({editGeometryOperations:this._editGeometryOperations,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new F(this._snappingGraphicsLayer)}),this._activeComponent=new E(t.view.spatialReference,T.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}normalizeCtorArgs(t){const e={...t};return delete e.editGeometryType,delete e.snappingManager,e}initialize(){this._snappingOperation=new j({view:this.view}),this.view.type==="2d"&&this.view.map.layers.add(this._snappingGraphicsLayer)}destroy(){this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this._snappingOperation=D(this._snappingOperation),this._editGeometryOperations.destroy()}get _committedVertices(){return this._editGeometryOperations.data.components[0].vertices.map(t=>t.pos)}get vertices(){return this._stagedVertex!=null?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}get hasZ(){return this._hasZ!=null?this._hasZ:this.view.type==="3d"}set hasZ(t){this._hasZ=t,this.notifyChange("hasZ")}get _stagedVertex(){return this._snappingOperation.stagedPoint}set _stagedVertex(t){this._snappingOperation.stagedPoint=$(t)}canUndo(){return this._editGeometryOperations.canUndo}canRedo(){return this._editGeometryOperations.canRedo}undo(){this.canUndo&&this._editGeometryOperations.undo()}redo(){this.canRedo&&this._editGeometryOperations.redo()}getCoordsFromScreenPoint(t){const e=t&&this.screenToMap(t);return e==null?null:e.hasZ?[e.x,e.y,e.z]:[e.x,e.y]}getCoordsAndPointFromScreenPoint(t){const e=this.screenToMap(t);return e==null?null:e.hasZ?{vertex:[e.x,e.y,e.z],mapPoint:e}:{vertex:[e.x,e.y],mapPoint:e}}screenToMap(t){let e=null;if(this.view.type==="3d")if(this.hasZ){const i=this.elevationInfo??X;e=this.view.sceneIntersectionHelper.intersectElevationFromScreen(S(t.x,t.y),i,this._getGeometryZValue())}else{const i=this.elevationInfo??ee;e=this.view.sceneIntersectionHelper.intersectElevationFromScreen(S(t.x,t.y),i,0),e!=null&&(e.z=void 0)}else e=this.view.toMap(t),e!=null&&(e.z=this.hasZ?this._getGeometryZValue():void 0);return e}_pushCursorVertex(t,e){const i=z(t[0],t[1],void 0,this.view.spatialReference);this._stagedVertexUnsnapped=i;const o=this._snappingManager;if(o==null)return this._stagedVertex=i,void e();Z(this._snappingOperation.snap({point:i},o,this._snappingContext)).then(()=>{e()})}_popCursorVertex(){this._stagedVertexUnsnapped=null,this._stagedVertex=null}_getGeometryZValue(){return this.defaultZ}_abortSnapping(){this._snappingOperation.abort()}_isDuplicateOfLastVertex(t){var h;const e=(h=this._editGeometryOperations.data.components[0].getLastVertex())==null?void 0:h.pos;if(e&&t[0]===e[0]&&t[1]===e[1])return!0;const{x:i,y:o}=this._coordinateHelper.vectorToDehydratedPoint(t);return this._lastVertexUnsnapped!=null&&i===this._lastVertexUnsnapped.x&&o===this._lastVertexUnsnapped.y}_shouldHandlePointerEvent(t){return te(t)&&(this._activePointerId==null||this._activePointerId===t.pointerId)}_vertexAddHandler(t){const e=this._stagedVertex!=null?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);e!=null&&this._addVertex(e,t.native)}_drawCompleteHandler(t){this._completeDrawing(t.native)}};l.SNAPPING_GRAPHICS_LAYER_ID="DrawAction-snapping-graphics-layer",s([n({readOnly:!0})],l.prototype,"vertices",null),s([n({type:Boolean,nonNullable:!0})],l.prototype,"interactiveUndoDisabled",void 0),s([n({readOnly:!0})],l.prototype,"history",void 0),s([n({readOnly:!0})],l.prototype,"redoHistory",void 0),s([n()],l.prototype,"snapToScene",void 0),s([n()],l.prototype,"view",void 0),s([n()],l.prototype,"elevationInfo",void 0),s([n({nonNullable:!0})],l.prototype,"defaultZ",void 0),s([n()],l.prototype,"hasZ",null),s([n()],l.prototype,"_snappingOperation",void 0),s([n()],l.prototype,"_stagedVertex",null),l=f=s([w("esri.views.draw.DrawAction")],l);const X={mode:"absolute-height",offset:0},ee={mode:"on-the-ground",offset:0};function te(t){return t.pointerType!=="mouse"||t.button===0}const V=l;class c{constructor(e,i,o){this.view=e,this.vertexIndex=i,this.vertices=o,this.defaultPrevented=!1,this.type="vertex-add"}preventDefault(){this.defaultPrevented=!0}}class m{constructor(e,i,o){this.view=e,this.vertexIndex=i,this.vertices=o,this.defaultPrevented=!1,this.type="vertex-remove"}preventDefault(){this.defaultPrevented=!0}}class v{constructor(e,i,o,h=null){this.view=e,this.vertexIndex=i,this.vertices=o,this.mapPoint=h,this.coordinates=null,this.defaultPrevented=!1,this.type="cursor-update",this.coordinates=o.length===1?o[0]:null}preventDefault(){this.defaultPrevented=!0}}class u{constructor(e){this.vertices=e,this.coordinates=null,this.defaultPrevented=!1,this.type="draw-complete",this.coordinates=e.length===1?e[0]:null}preventDefault(){this.defaultPrevented=!0}}const b=Symbol("view-handles"),A=Symbol("undo-redo-handles");let H=class extends V{constructor(t){super(t),this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1}initialize(){this._addViewHandles(),this._addUndoRedoHandles()}destroy(){this._removeViewHandles(),this._removeUndoRedoHandles(),this.emit("destroy")}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){this._completeDrawing()}_addViewHandles(){this._removeViewHandles(),this.addHandles([this.view.on("click",t=>{t.stopPropagation()},r.TOOL),this.view.on("pointer-down",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._activePointerId=t.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(t),t.pointerType==="touch"&&this._updateCursor())},r.TOOL),this.view.on("pointer-move",t=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=p(t),t.pointerType!=="touch"&&this._updateCursor()},r.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},r.TOOL),this.view.on("pointer-up",t=>{if(this._shouldHandlePointerEvent(t))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp)this._vertexAddHandler(t);else{const e=t.pointerType==="touch";this._updateCursor(e)}},r.TOOL),this.view.on("drag",["Shift"],t=>{t.stopPropagation()},r.TOOL),this.view.on("double-click",t=>{t.stopPropagation(),this._drawCompleteHandler(t)},r.TOOL),this.view.on("double-click",["Control"],t=>{t.stopPropagation(),this._drawCompleteHandler(t)},r.TOOL),this.view.on("key-down",t=>{const{key:e,repeat:i}=t;e===a.vertexAdd&&!i&&this._cursorScreenPoint?(t.stopPropagation(),this._abortSnapping(),this._vertexAddHandler(t)):e!==a.complete||i?e!==a.undo||this.interactiveUndoDisabled||i?e!==a.redo||this.interactiveUndoDisabled||i?e!==a.pan||i||t.stopPropagation():(t.stopPropagation(),this.redo()):(t.stopPropagation(),this.undo()):(t.stopPropagation(),this._drawCompleteHandler(t))},r.TOOL),this.view.on("key-up",t=>{t.key===a.pan&&t.stopPropagation()},r.TOOL)],b)}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this.addHandles([this._editGeometryOperations.on("vertex-remove",t=>{if(this.notifyChange("vertices"),t.operation==="undo"){const e=[...this._committedVertices];this._stagedVertex!=null&&e.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new m(this.view,t.vertices[0].index,e))}}),this._editGeometryOperations.on("vertex-add",t=>{if(this.notifyChange("vertices"),t.operation==="apply"){const e=this._committedVertices.length-1,i=new c(this.view,e,this.vertices);this.emit("vertex-add",i),i.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(t.operation==="redo"){const e=[...this._committedVertices];this._stagedVertex!=null&&e.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new c(this.view,t.vertices[0].index,e))}})],A)}_removeViewHandles(){this.removeHandles(b)}_removeUndoRedoHandles(){this.removeHandles(A)}_addVertex(t){const e=this._coordinateHelper.arrayToVector(t);this._isDuplicateOfLastVertex(e)||this._editGeometryOperations.appendVertex(e)}_updateCursor(t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const e=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);e==null||t||this._pushCursorVertex(e.vertex,()=>this.emit("cursor-update",new v(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new O(this._stagedVertex):null)))}_completeDrawing(){if(this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const t=new u(this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}};H=s([w("esri.views.draw.MultipointDrawAction")],H);const ie=H;let d=class extends L.EventedMixin(W){constructor(e){super(e),this.defaultZ=0,this.elevationInfo=null,this.hasZ=!0,this.mode=null,this.snapToScene=null,this.type="draw-3d"}initialize(){const e=this.view,i=Y(this.hasZ,this.elevationInfo);this.drawOperation=new q({view:e,manipulators:this.manipulators,geometryType:this.geometryType,drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:e.type==="3d"?new B(e,i):null,elevationDrawSurface:e.type==="3d"?new J(i,this.defaultZ,e):null,hasM:!1,elevationInfo:i}),this.addHandles([this.drawOperation.on("vertex-add",o=>this.onVertexAdd(o)),this.drawOperation.on("vertex-remove",o=>this.onVertexRemove(o)),this.drawOperation.on("vertex-update",o=>this.onVertexUpdate(o)),this.drawOperation.on("cursor-update",o=>this.onCursorUpdate(o)),this.drawOperation.on("complete",o=>this.onComplete(o))]),this.finishToolCreation()}destroy(){this.drawOperation=D(this.drawOperation),this._set("view",null)}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}get updating(){var e;return((e=this.drawOperation)==null?void 0:e.updating)??!1}completeCreateOperation(){this.drawOperation.complete()}onDeactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}getVertexCoords(){return this.drawOperation.geometryIncludingUncommittedVertices}onInputEvent(e){this.drawOperation.onInputEvent(e)}canRedo(){return this.drawOperation.canRedo}canUndo(){return this.drawOperation.canUndo}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo()}onComplete(e){this.emit("complete",e)}onCursorUpdate(e){this.emit("cursor-update",e)}onVertexAdd(e){this.emit("vertex-add",e)}onVertexRemove(e){this.emit("vertex-remove",e)}onVertexUpdate(e){this.emit("vertex-update",e)}};s([n({constructOnly:!0,nonNullable:!0})],d.prototype,"defaultZ",void 0),s([n()],d.prototype,"drawOperation",void 0),s([n({constructOnly:!0})],d.prototype,"elevationInfo",void 0),s([n({value:!0})],d.prototype,"enabled",null),s([n({constructOnly:!0})],d.prototype,"geometryType",void 0),s([n({constructOnly:!0})],d.prototype,"hasZ",void 0),s([n({constructOnly:!0})],d.prototype,"mode",void 0),s([n()],d.prototype,"snapToScene",void 0),s([n({readOnly:!0})],d.prototype,"type",void 0),s([n({readOnly:!0})],d.prototype,"updating",null),s([n({constructOnly:!0,nonNullable:!0})],d.prototype,"view",void 0),d=s([w("esri.views.draw.DrawTool")],d);let C=class extends V{constructor(t){super(t),this._addVertexOnPointerUp=!1,this._drawTool=null}initialize(){this._addViewHandles(),this.view.type==="3d"&&this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}complete(){this._completeDrawing()}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles([this.view.on("key-down",t=>{t.key===a.complete&&(this._drawTool?this.complete():(this._abortSnapping(),this._vertexAddHandler(t)))},r.TOOL)])}_addViewHandles2DOnly(){this.view.type==="2d"&&this.addHandles([this.view.on("pointer-down",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._activePointerId=t.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(t),t.pointerType==="touch"&&this._updateCursor())},r.TOOL),this.view.on("pointer-move",t=>{this._abortSnapping(),this._cursorScreenPoint=p(t),t.pointerType!=="touch"&&this._updateCursor()},r.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},r.TOOL),this.view.on("pointer-up",t=>{if(this._shouldHandlePointerEvent(t))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp)t.stopPropagation(),this._vertexAddHandler(t);else{const e=t.pointerType==="touch";this._updateCursor(e)}},r.TOOL),this.view.on("drag",["Shift"],t=>{t.stopPropagation()},r.TOOL)])}_addDrawTool(){const t=new d({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"point",mode:"click"});this._drawTool=t,this.view.addAndActivateTool(t),this.addHandles([t.on("cursor-update",e=>{e.vertices.length===1&&this.emit("cursor-update",new v(this.view,e.vertices[0].vertexIndex,t.getVertexCoords()))}),t.on("complete",e=>{this.emit("draw-complete",new u(t.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})])}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(t){const e=this._coordinateHelper.arrayToVector(t);this._isDuplicateOfLastVertex(e)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(e),this.notifyChange("vertices"),this._completeDrawing())}_updateCursor(t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const e=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);e==null||t||this._pushCursorVertex(e.vertex,()=>this.emit("cursor-update",new v(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new O(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const t=new u(this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this.removeAllHandles()}};C=s([w("esri.views.draw.PointDrawAction")],C);const oe=C;let g=class extends V{constructor(e){super(e),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.mode=G}initialize(){this._addViewHandles(),this.view.type==="3d"&&this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}undo(){this._drawTool?this._drawTool.undo():(super.undo(),this.notifyChange("vertices"))}redo(){this._drawTool?this._drawTool.redo():(super.redo(),this.notifyChange("vertices"))}canUndo(){var e;return((e=this._drawTool)==null?void 0:e.canUndo())??super.canUndo()}canRedo(){var e;return((e=this._drawTool)==null?void 0:e.canRedo())??super.canRedo()}complete(){this._completeDrawing()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles(this.view.on("key-down",e=>{const{key:i,repeat:o}=e;i!==a.vertexAdd||o?i!==a.complete||o?i!==a.undo||this.interactiveUndoDisabled||o?i!==a.redo||this.interactiveUndoDisabled||o||(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e)):(e.stopPropagation(),this._handleVertexAddKey(e))},r.TOOL))}_addViewHandles2DOnly(){this.view.type==="2d"&&(this.addHandles([this.view.on("click",e=>{e.stopPropagation()},r.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(e),e.pointerType==="touch"&&this._updateCursor())},r.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._cursorScreenPoint=p(e),e.pointerType!=="touch"&&this._updateCursor()},r.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._cursorScreenPoint=p(e),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(e):this._addVertexOnPointerUp=!1)},r.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(e);this._vertexAddHandler(e)}else{const i=e.pointerType==="touch";this._updateCursor(i)}},r.TOOL),this.view.on("drag",e=>{this._dragEnabled&&this._activePointerId!=null&&!this._panEnabled&&e.stopPropagation()},r.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},r.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},r.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},r.TOOL),this.view.on("key-down",e=>{const{key:i,repeat:o}=e;i!==a.pan||o||(e.stopPropagation(),this._panEnabled=!0)},r.TOOL),this.view.on("key-up",e=>{e.key===a.pan&&(e.stopPropagation(),this._panEnabled=!1)},r.TOOL)]),this._addUndoRedoHandles())}_handleVertexAddKey(e){this._drawTool?this._drawTool.drawOperation.commitStagedVertex():this._cursorScreenPoint&&(this._abortSnapping(),this._vertexAddHandler(e))}_addUndoRedoHandles(){this.addHandles([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){const i=[...this._committedVertices];this._stagedVertex!=null&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new m(this.view,e.vertices[0].index,i))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){const i=this._committedVertices.length-1,o=new c(this.view,i,this.vertices);this.emit("vertex-add",o),o.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){const i=[...this._committedVertices];this._stagedVertex!=null&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new c(this.view,e.vertices[0].index,i))}})])}_addDrawTool(){const e=new d({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polygon",mode:this.mode});this._drawTool=e,this.view.addAndActivateTool(e),e.on("vertex-add",i=>{if(i.vertices.length===1){const{view:o}=this,h=i.vertices[0].vertexIndex,_=e.getVertexCoords();this.emit("vertex-add",new c(o,h,_)),i.operation!=="undo"&&i.operation!=="redo"||this.emit(i.operation,new c(o,h,_))}}),e.on("vertex-remove",i=>{if(i.vertices.length===1){const{view:o}=this,h=i.vertices[0].vertexIndex,_=e.getVertexCoords();this.emit("vertex-remove",new m(o,h,_)),i.operation!=="undo"&&i.operation!=="redo"||this.emit(i.operation,new m(o,h,_))}}),e.on("cursor-update",i=>{i.vertices.length===1&&this.emit("cursor-update",new v(this.view,i.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("complete",i=>{this.emit("draw-complete",new u(e.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){const i=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(i)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(i))}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);i==null||e||this._pushCursorVertex(i.vertex,()=>this.emit("cursor-update",new v(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new O(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<3)return;this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const e=new u(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}};s([n()],g.prototype,"_dragEnabled",null),s([n()],g.prototype,"_clickEnabled",null),s([n({type:k})],g.prototype,"mode",void 0),g=s([w("esri.views.draw.PolygonDrawAction")],g);const re=g;let y=class extends V{constructor(e){super(e),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.mode=G}initialize(){this._addViewHandles(),this.view.type==="3d"&&this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}undo(){this._drawTool?this._drawTool.undo():(super.undo(),this.notifyChange("vertices"))}redo(){this._drawTool?this._drawTool.redo():(super.redo(),this.notifyChange("vertices"))}canUndo(){var e;return((e=this._drawTool)==null?void 0:e.canUndo())??super.canUndo()}canRedo(){var e;return((e=this._drawTool)==null?void 0:e.canRedo())??super.canRedo()}complete(){this._completeDrawing()}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles([this.view.on("key-down",e=>{const{key:i,repeat:o}=e;i!==a.vertexAdd||o?i!==a.complete||o?i!==a.undo||this.interactiveUndoDisabled||o?i!==a.redo||this.interactiveUndoDisabled||o||(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e)):(e.stopPropagation(),this._handleVertexAddKey(e))},r.TOOL)])}_addViewHandles2DOnly(){this.view.type==="2d"&&(this.addHandles([this.view.on("click",e=>{e.stopPropagation()},r.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&!this._panEnabled&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(e),e.pointerType==="touch"&&this._updateCursor())},r.TOOL),this.view.on("pointer-move",e=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=p(e),e.pointerType!=="touch"&&this._updateCursor()},r.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._cursorScreenPoint=p(e),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(e):this._addVertexOnPointerUp=!1)},r.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(e);this._vertexAddHandler(e)}else{const i=e.pointerType==="touch";this._updateCursor(i)}},r.TOOL),this.view.on("drag",e=>{this._dragEnabled&&this._activePointerId!=null&&!this._panEnabled&&e.stopPropagation()},r.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},r.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},r.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},r.TOOL),this.view.on("key-down",e=>{const{key:i,repeat:o}=e;i!==a.pan||o||(e.stopPropagation(),this._panEnabled=!0)},r.TOOL),this.view.on("key-up",e=>{e.key===a.pan&&(e.stopPropagation(),this._panEnabled=!1)},r.TOOL)]),this._addUndoRedoHandles())}_handleVertexAddKey(e){this._drawTool?this._drawTool.drawOperation.commitStagedVertex():this._cursorScreenPoint&&(this._abortSnapping(),this._vertexAddHandler(e))}_addUndoRedoHandles(){this.addHandles([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){const i=[...this._committedVertices];this._stagedVertex!=null&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new m(this.view,e.vertices[0].index,i))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){const i=this._committedVertices.length-1,o=new c(this.view,i,this.vertices);this.emit("vertex-add",o),o.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){const i=[...this._committedVertices];this._stagedVertex!=null&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new c(this.view,e.vertices[0].index,i))}})])}_addDrawTool(){const e=new d({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polyline",mode:this.mode});this._drawTool=e,this.view.addAndActivateTool(e),this.addHandles([e.on("vertex-add",i=>{if(i.vertices.length!==1)return;const{view:o}=this,h=i.vertices[0].vertexIndex,_=e.getVertexCoords();this.emit("vertex-add",new c(o,h,_)),i.operation!=="undo"&&i.operation!=="redo"||this.emit(i.operation,new c(o,h,_))}),e.on("vertex-remove",i=>{if(i.vertices.length!==1)return;const{view:o}=this,h=i.vertices[0].vertexIndex,_=e.getVertexCoords();this.emit("vertex-remove",new m(o,h,_)),i.operation!=="undo"&&i.operation!=="redo"||this.emit(i.operation,new m(o,h,_))}),e.on("cursor-update",i=>{i.vertices.length===1&&this.emit("cursor-update",new v(this.view,i.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("complete",i=>{this.emit("draw-complete",new u(e.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})])}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){const i=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(i)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(i))}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);i==null||e||this._pushCursorVertex(i.vertex,()=>this.emit("cursor-update",new v(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new O(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<2)return;this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const e=new u(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}};s([n()],y.prototype,"_clickEnabled",null),s([n()],y.prototype,"_dragEnabled",null),s([n({type:k})],y.prototype,"mode",void 0),y=s([w("esri.views.draw.PolylineDrawAction")],y);const se=y,ne=["freehand","click"];let P=class extends V{constructor(t){super(t),this._isDragging=!1,this._panEnabled=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.viewAlignedCoordinateSystem=null,this.mode="freehand"}initialize(){this.view.type==="2d"?this._addViewHandles():this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}complete(){this._completeDrawing()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this.mode==="click"?this.addHandles(this._getClickModeViewHandles()):this.addHandles(this._getDragModeViewHandles())}_getDragModeViewHandles(){return[this.view.on("immediate-click",t=>{t.stopPropagation(),t.mapPoint&&!this._panEnabled&&this.getCoordsFromScreenPoint(p(t))!=null&&(this._vertexAddHandler(t),this._drawCompleteHandler(t))},r.TOOL),this.view.on("pointer-down",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._panEnabled||(this._resetGeometry(),this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(t),this._activePointerId=t.pointerId,this._vertexAddHandler(t),this._isDragging=!1,t.pointerType==="touch"&&this._updateCursor()))},r.TOOL),this.view.on("pointer-move",t=>{this._abortSnapping(),this._activePointerId==null&&t.pointerType!=="touch"&&(this._cursorScreenPoint=p(t),this._updateCursor())},r.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._isDragging=!0,this._cursorScreenPoint=p(t),this._updateCursor())},r.TOOL),this.view.on("pointer-up",t=>{this._shouldHandlePointerEvent(t)&&this._addVertexOnPointerUp&&(this._abortSnapping(),this._activePointerId=null,this._isDragging&&this._vertexAddHandler(t),this._committedVertices.length===2&&this._drawCompleteHandler(t),this._isDragging=!1)},r.TOOL),this.view.on("key-down",t=>{t.key===a.complete&&this._cursorScreenPoint?(this._abortSnapping(),this._vertexAddHandler(t),this._drawCompleteHandler(t)):t.key===a.pan&&(this._panEnabled=!0)},r.TOOL),this.view.on("key-up",t=>{t.key===a.pan&&(this._panEnabled=!1)},r.TOOL),this.view.on("drag",t=>{this._activePointerId!=null&&t.stopPropagation()},r.TOOL),this.view.on("drag",["Shift"],t=>{t.stopPropagation()},r.TOOL)]}_getClickModeViewHandles(){return[this.view.on("pointer-down",t=>{this._abortSnapping(),this._cursorScreenPoint=p(t),this._activePointerId=t.pointerId,this._isDragging=!1,t.pointerType==="touch"&&this._updateCursor()},r.TOOL),this.view.on("pointer-move",t=>{this._abortSnapping(),this._cursorScreenPoint=p(t),this._activePointerId==null&&t.pointerType!=="touch"&&this._updateCursor()},r.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._isDragging=!0)},r.TOOL),this.view.on("pointer-up",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._activePointerId=null,t.stopPropagation(),this._isDragging||this._vertexAddHandler(t),this.vertices.length!==2||this._isDragging||this._drawCompleteHandler(t),this._isDragging=!1)},r.TOOL),this.view.on("key-down",t=>{t.key===a.vertexAdd&&this._cursorScreenPoint&&(this._vertexAddHandler(t),this.vertices.length===2&&this._drawCompleteHandler(t)),t.key===a.complete&&this._cursorScreenPoint&&this.vertices.length===2&&(this._vertexAddHandler(t),this._drawCompleteHandler(t))},r.TOOL)]}_addDrawTool(){const t=new d({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"segment",mode:this.mode});this._drawTool=t,this.view.addAndActivateTool(t),this.addHandles([t.on("vertex-add",e=>{e.vertices.length===1&&this.emit("vertex-add",new c(this.view,e.vertices[0].vertexIndex,t.getVertexCoords()))}),t.on("cursor-update",e=>{e.vertices.length===1&&this.emit("cursor-update",new v(this.view,e.vertices[0].vertexIndex,t.getVertexCoords()))}),t.on("complete",e=>{this.emit("draw-complete",new u(t.getVertexCoords())),this._removeDrawTool()}),this.view.on("key-down",e=>{e.key!==a.vertexAdd||e.repeat||this.mode!=="click"?e.key!==a.complete||e.repeat||t.completeCreateOperation():t.drawOperation.numCommittedVertices>0?t.completeCreateOperation():t.drawOperation.commitStagedVertex()},r.TOOL)])}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(t){const e=this._coordinateHelper.arrayToVector(t);if(this._isDuplicateOfLastVertex(e))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(e),this._committedVertices.length===1&&(this.viewAlignedCoordinateSystem=Q(this.view,this._committedVertices[0]));const i=this._committedVertices.length-1,o=new c(this.view,i,this.vertices);this.emit("vertex-add",o)}_updateCursor(){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t!=null&&this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new v(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new O(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return this._drawTool.completeCreateOperation(),void this.removeAllHandles();if(this._activePointerId=null,this._popCursorVertex(),this._cursorScreenPoint=null,this._isDragging=!1,this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const t=new u(this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this.removeAllHandles()}_resetGeometry(){this._editGeometryOperations.destroy(),this._editGeometryOperations=new I(new U("polygon",this._coordinateHelper),T.Local),this._activeComponent=new E(this._coordinateHelper.spatialReference,T.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}};s([n({type:ne})],P.prototype,"mode",void 0),P=s([w("esri.views.draw.SegmentDrawAction")],P);const ae=P;let x=class extends M{constructor(){super(...arguments),this.activeAction=null,this.type="draw",this.view=null}destroy(){this.activeAction&&(this.activeAction.destroy(),this.activeAction=null)}create(t,e){this.reset();const i={view:this.view,...e};switch(t){case"point":i.editGeometryType="point",this.activeAction=new oe(i);break;case"polyline":i.editGeometryType="polyline",this.activeAction=new se(i);break;case"multipoint":i.editGeometryType="polygon",this.activeAction=new ie(i);break;case"polygon":i.editGeometryType="polygon",this.activeAction=new re(i);break;case"rectangle":case"circle":case"ellipse":case"triangle":i.editGeometryType="polygon",this.activeAction=new ae(i)}return this.activeAction}complete(){this.activeAction&&this.activeAction.complete(),this.activeAction=null}reset(){this.activeAction&&this.activeAction.destroy(),this.activeAction=null}};s([n()],x.prototype,"activeAction",void 0),s([n({readOnly:!0})],x.prototype,"type",void 0),s([n()],x.prototype,"view",void 0),x=s([w("esri.views.draw.Draw")],x);const De=x;export{De as l};
