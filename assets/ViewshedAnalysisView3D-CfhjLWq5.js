import{e as n}from"./Evented-CXIxDjmW.js";import{S as q,u as M,C as ce,T as lt,q as zt}from"./Accessor-D6mNnsWy.js";import{d as w,P as C,g as St,A as Y,C as ue}from"./reactiveUtils-BFQ0BtrB.js";import{y as p,b as k,ao as me,$ as ve,K as _e,E as ie,O as we}from"./subclass-BR3PhgZG.js";import{s as fe}from"./AnalysisView3D-Bxdzk7YF.js";import{u as G}from"./Color-DDUWtbqR.js";import{_ as pt,n as c,r as J,M as ft,O as X,d as N,T as D,Y as Ht,z as K,g as A,w as Vt,t as Ve,D as re,c as H,h as b,b as P,E as ge,e as be,x as xt,p as Lt,P as gt}from"./mathUtils-ClvKsMak.js";import{p as Z,y as at,g as bt,d as se,R as yt,q as Et,c as Mt,J as B}from"./mat4-ybYUU6jq.js";import{e as O}from"./mat4f64-Dk4dwAN8.js";import"./vec2-B_ymkwGp.js";import"./vec2f64-Diu2Kaa8.js";import{distance as kt}from"./geometryEngine-DyRMGqqp.js";import{E as ye,j as Me,J as De}from"./plane-Bz78OrLf.js";import{O as Oe,b as $e,a as L,e as At,f as Ce}from"./RenderObject-Cc5ObyLE.js";import{O as Te,k as Se}from"./dragEventPipeline3D-BsmsUwER.js";import{f as F}from"./LineVisualElement-DDrOKAfo.js";import{h as ht}from"./Material-BN_i9QRJ.js";import{h as He}from"./lineStippleUtils-BJ8wDzcw.js";import"./geometry-CnaxvJsv.js";import{_ as nt}from"./Point-TlcsOcXV.js";import{i as Ee}from"./Clonable-cKbRam6-.js";import{a as Dt,n as Ae}from"./Cyclical-BY_I03kj.js";import{s as Re}from"./jsonMap-DCC6W5ex.js";import{K as Pe}from"./projection-tSh-0UvX.js";import{o as Fe}from"./ViewingMode-Dodu7ZZk.js";import{H as Ot}from"./boundedPlane-Xr4Vx-V9.js";import{b as ze,s as et}from"./sliceToolConfig-DLdTgbpM.js";import{t as oe,A as R,u as xe,o as Le}from"./MoveManipulation-3eFTSIuR.js";import{z as ke,g as Ue,A as Ut,w as Ie,s as je}from"./RenderGeometry-C4TY81Cr.js";import{s as Ne}from"./Util-BMqL_pkg.js";import{p as ot,M as Be,h as dt,f as Ge}from"./InteractiveToolBase-BwczmwYA.js";import{t as j}from"./interfaces-D6pIddIh.js";import{v as Ke}from"./sphere-DIv2hmik.js";import{e as qe}from"./basicInterfaces-wONHx_SN.js";import{d as We}from"./ColorMaterial.glsl-8RSfQ59m.js";import{j as Je}from"./settings-D4LvGPKp.js";import{G as Ye}from"./ExtendedLineVisualElement-CC63Pz3j.js";import{c as Qe}from"./Laserlines.glsl-Dgb6OMTT.js";import{E as Xe}from"./EditGeometryOperations-yqtNdguW.js";import{o as Ze}from"./ShadedColorMaterial.glsl-vn9dLgnT.js";import{p as It}from"./keybindings-DYR2fa8r.js";import{t as ti}from"./ToolIntersector-CtDkwpAn.js";import{c as ei}from"./screenUtils-BGG3AyYa.js";import{C as ii}from"./Viewshed.glsl-ClFwY1b3.js";import{a as ri,v as si,l as oi}from"./analysisViewUtils-CW7QQu79.js";import"./shared-B3wH2qpO.js";import"./Promise-CZrWwByK.js";import"./colorUtils-CS9vdHXB.js";import"./geometryEngineBase-RmbNeFm7.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./hydrated-CRSW297p.js";import"./Extent-B4rrMrqp.js";import"./Polyline-BQFeqYXi.js";import"./writer-3zufXUNV.js";import"./assets-BNizZMOZ.js";import"./index-BVncS3aY.js";import"./vec42-B1mBkh1w.js";import"./mat3f64-BBpwCtoL.js";import"./quatf64-BrpT0VRp.js";import"./vec4f64-CBQL1T0x.js";import"./mathUtils-kvswLROa.js";import"./compilerUtils-BA04t1lN.js";import"./screenUtils-PfxkaaMN.js";import"./mat3-DRqs2t5W.js";import"./computeTranslationToOriginAndRotation-CFxYfzBj.js";import"./projectBuffer-iyGwL2dv.js";import"./geodesicConstants-kj1AtlGg.js";import"./lineSegment-A3_mEhFF.js";import"./hydratedFeatures-DHwl8sGq.js";import"./Graphic-Bi5hWHps.js";import"./PopupTemplate-D8mXPxzU.js";import"./fieldUtils-C5R42-PY.js";import"./intl-CArXn1et.js";import"./enumeration--HlxOQ_N.js";import"./ActionToggle-C0Z1k2jc.js";import"./Identifiable-BLvpQbOc.js";import"./symbols-CfvYGR4J.js";import"./TextSymbol-zZq0BA1M.js";import"./materialUtils-CQ3JLQ1x.js";import"./opacityUtils-BT7mQkwC.js";import"./aaBoundingBox-BGxkJAW0.js";import"./persistableUrlUtils-Dx61-x4K.js";import"./collectionUtils-Dm1icNvk.js";import"./Portal-DCqdz-K4.js";import"./jsonUtils-DtWlwXHP.js";import"./projectVectorToVector-BLdiwuTJ.js";import"./projectPointToVector-C-hGM2ap.js";import"./elevationInfoUtils-C0SzfJu0.js";import"./unitConversionUtils-BUA_O87q.js";import"./lengthUtils-vgIBtB6M.js";import"./ElevationProvider-eMOI1-3B.js";import"./verticalOffsetUtils-CU5zOPGb.js";import"./orientedBoundingBox-WyW1LZfF.js";import"./quat-ChS85qAG.js";import"./spatialReferenceEllipsoidUtils-DuE2W35w.js";import"./ray-DzoXcN4v.js";import"./colorUtils-D5nOabzP.js";import"./BufferView-B7Z-dzh4.js";import"./InterleavedLayout-UIhsB8jd.js";import"./NormalAttribute.glsl-Dqf1UPF9.js";import"./interfaces-B8ge7Jg9.js";import"./BindType-BmZEZMMh.js";import"./VertexAttribute-BnAa5VW0.js";import"./Texture-DjTh7HwY.js";import"./enums-BlUEVwJR.js";import"./Texture-BbJIOVx_.js";import"./ShaderTechniqueConfiguration-D3UbJ2mX.js";import"./doublePrecisionUtils-B0owpBza.js";import"./Indices-B6BGScAS.js";import"./triangle-DtfDEZcP.js";import"./renderState-PYzNpa1K.js";import"./requestImageUtils-BkbekjsQ.js";import"./VertexColor.glsl-BROYASAm.js";import"./Object3DVisualElement-DudZRJcw.js";import"./VisualElement-CT5Yhr5G.js";import"./DoubleArray-CF_CpVBS.js";import"./triangulationUtils-KizYbMMI.js";import"./earcut-BqgeR2O3.js";import"./deduplicate-DxTSMkFY.js";import"./vec3f32-Cw9Q6TO_.js";import"./frustum-6KI4j9vx.js";import"./axisAngleDegrees-CHCWDIqP.js";import"./weather-B51D8kuv.js";import"./Scheduler-CDoWuxMK.js";import"./signal-DzOfzcfh.js";import"./debugFlags-B3L9P_UW.js";import"./Float4DrawUniform-CWdxHXQ-.js";import"./NestedMap-DgiGbX8E.js";import"./Octree-BnKLop8B.js";import"./floatRGBA-C8rGFKJ0.js";import"./Intersector-pThUjfQo.js";import"./glUtil-C6KhMg1m.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./MemCache-C6WUx-5V.js";import"./VertexArrayObject-Cwnso4un.js";import"./BufferObject-CjYoWxgZ.js";import"./meshVertexSpaceUtils-BfF6O78E.js";import"./MeshLocalVertexSpace-sBjAuOT3.js";import"./vec4f32-CjrfB-0a.js";import"./EngineVisualElement-DP_S_DwA.js";import"./geometry2dUtils-BraNT6Fs.js";import"./InputManager-C4xu1R9l.js";import"./Queue-DpHko4Yk.js";import"./Viewpoint-7_owAOZm.js";import"./jsxFactory-Be5PKa9i.js";import"./uuid-fwrPAdZb.js";import"./workers-D8NOwm_V.js";import"./GraphicsCollection-B0IuEpT5.js";import"./HeightModelInfo-CzO-kRMK.js";import"./WaterSurface.glsl-BpeZRtH_.js";import"./vec2f32-BbH2jxlN.js";import"./dehydratedFeatures-DzTz-nWK.js";import"./quantizationUtils-DFd0XKEL.js";import"./Field-poIiHWUc.js";import"./fieldType-CIG5ey7e.js";import"./featureConversionUtils-B-SknPj_.js";import"./OptimizedFeature-7juV2tZm.js";import"./OptimizedGeometry-vU5jWBvU.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./edgeUtils-BIb6yRHm.js";import"./DecodeSymbolColor.glsl-CeBC4xQe.js";import"./vec3-C3Q-RF_i.js";import"./SnappingCandidate-O5eRSE6e.js";import"./visualVariableUtils-CrTsYJ9f.js";import"./sizeVariableUtils-Cmcuvw-4.js";import"./Normals-D1LdtP06.js";import"./objectResourceUtils-CpGUIAJs.js";import"./devEnvironmentUtils-D6qIi8Ky.js";import"./vec4-L9zJLV3y.js";import"./Version-_Vxue7Ui.js";import"./CIMSymbolHelper-Ei9DhmLE.js";import"./BidiEngine-BwB1Df7c.js";import"./fontUtils-CILP_6vp.js";import"./GeometryUtils-CXWuBstD.js";import"./enums-BRXbslMp.js";import"./utils-D8D39sLt.js";import"./definitions-ByNBSgP9.js";import"./mat2d-DPkeMmgR.js";import"./mat2df32-orApM5a3.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BhuXqU4L.js";import"./defaults-CIM29kXM.js";import"./defaultsJSON-GKolV7NZ.js";import"./OverrideHelper-0-cH6aQ2.js";import"./cimSymbolUtils-Ctf0ZrmH.js";import"./utils-CvMr5svk.js";import"./jsonUtils-C4Wp5KpV.js";import"./parser-BN6zmHl-.js";import"./utils-D20M4_S8.js";import"./mat4f32-DcsiF_Rp.js";import"./LRUCache-ju6LnIBZ.js";import"./projectVectorToPoint-GP7lggIC.js";import"./MeshComponent-uUfLXsBv.js";import"./imageUtils-Bwri-Uf9.js";import"./MeshVertexAttributes-De1gN3Wb.js";import"./projection-CODyCdLE.js";import"./DefaultLayouts-Bz7P2wdj.js";import"./styleUtils-C7rrjuqd.js";import"./webStyleSymbolUtils--o9yKGMN.js";import"./jsonUtils-aUmUTP_F.js";import"./layerUtils-BzjQnEdj.js";import"./Intersector-C4Z_0aqD.js";import"./RenderCoordsHelper-DIYuiHA3.js";import"./scaleUtils-C_vWi-B7.js";import"./DefaultUI-Cy6B6U3V.js";import"./UpdatingHandles-CMtXpTiG.js";import"./Map-D9sO0Jqv.js";import"./Basemap-CKBB4cRW.js";import"./loadAll-z9YY33Kx.js";import"./PortalItem-CaeKabGc.js";import"./writeUtils-BUKZUL8X.js";import"./Ground-CSI-YC3C.js";import"./CollectionFlattener-CkyePFnC.js";import"./editableLayers-BdCikvlg.js";import"./catalogUtils--o1nDhfl.js";import"./basemapUtils-fcYt_ePc.js";import"./TablesMixin-BWPSKW45.js";import"./Layer-CfUiPX3n.js";import"./TimeExtent-Dl-qaORu.js";import"./timeUtils-DQR2jUPL.js";import"./ReactiveMap-Dl_3-Rm5.js";import"./Query-BpMwiNVl.js";import"./DataLayerSource-BX7Ap_tY.js";import"./FullTextSearch-BhJOgh_r.js";import"./selectionUtils-DYi6daQO.js";import"./IViewEvents-Bci6PjlS.js";import"./a11yUtils-DwloBVAu.js";import"./heightModelInfoUtils-C5nNknML.js";import"./arcgisLayerUrl-ETqee4Bd.js";import"./capabilities-C84AMSCg.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-CZa70j6i.js";import"./accessibleHandler-COYT31Am.js";import"./Compass-eoZ7sbNQ.js";import"./utils-DsJqvptN.js";import"./GoTo-CyjNnle5.js";import"./NavigationToggle-Dune4J79.js";import"./Zoom-BgowPovH.js";import"./viewpointUtils-DrSHV8Bj.js";import"./earthUtils-IMU84l4c.js";import"./spatialReferenceSupport-B36j_qpq.js";import"./ElevationSamplerData-Buk1kzZu.js";import"./terrainUtils-CFCwJ7li.js";import"./TileInfo-Dm24FfTU.js";import"./TileKey-DZd6gJy7.js";import"./Environment-Dqtndk8e.js";import"./quantityUtils-Cz8e0KG8.js";import"./Program-BE7XUO18.js";import"./ShadowCastVisualizeTechniqueConfiguration-CoPYcmeP.js";import"./euclideanLengthMeasurementUtils-j7PbRKQS.js";import"./ZoomMomentumEstimator-BjFm7M7Z.js";import"./labelFormatUtils-CJcADR3o.js";import"./labelUtils-Cczy0uDR.js";import"./FeatureTileDescriptor3D-BOE-lJxV.js";import"./ElevationQueryTileCache-CGdGXbwa.js";import"./LayerConstants-B33OP6sh.js";import"./ElevationRange-BrgM1moX.js";import"./geometryServiceUtils-C-iODloP.js";import"./project-DXhIgRZA.js";import"./utils-Blh5cXWv.js";import"./utils-Bh7lx_TM.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./RenderableTile-DOglSSxI.js";import"./enums-BRzLM11V.js";import"./TileStrategy-Dx1mrlzq.js";import"./TileKey-CIqLSCov.js";import"./QueueProcessor-Bu6RBZRX.js";import"./config-MDUrh2eL.js";import"./DefaultVertexAttributeLayouts-BIPVF1RK.js";import"./DisplayObject-DFOkWAgp.js";import"./StyleDefinition-BK3ROBTO.js";import"./resources-Aq4homSZ.js";import"./edgeProcessing-kh6EVSro.js";import"./testSVGPremultipliedAlpha-CKx7iZPZ.js";import"./RenderingContext-B0G6O7lI.js";import"./ProgramCache-DZJRjGv8.js";import"./layerViewUtils-D2JqIDZ8.js";function ae({tiltedUpVector:e,rightVector:t,observerRenderSpace:i},r){const s=Oe(e,t,i,r);return s[12]=0,s[13]=0,s[14]=0,s}function $t(e,t,i){const r=c(),s=pt(c(),i.basis1,i.basis2);return e.next(Te(t,i.plane)).next(o=>{o.action==="start"&&J(r,o.renderStart);const a=ft($e(r,o.renderEnd,i.origin,s));return{...o,deltaAngle:a}})}function ne(e,t){if(e==null)return 0;const{observer:i,target:r}=e,s=t.camera.position,o=kt(s,i)>kt(s,r)?i:r;return t.pixelSizeAt(o)}const ai=2,jt=new G([85,85,85,.5]);let E=class extends q{constructor(t){super(t),this.visible=!0,this._viewshedCorners={topLeft:c(),topRight:c(),bottomLeft:c(),bottomRight:c(),center:c()},this._arcCenterPoints={top:c(),bottom:c(),left:c(),right:c()},this._parallelCenters={top:c(),bottom:c()}}initialize(){const t={view:this.view,isDecoration:!0,color:this._color,renderOccluded:ht.OccludeAndTransparent},i={...t,width:ai,stipplePattern:He(2)};this._boundaryLinesVisualElement=new F(t),this._leftArcVisualElement=new F(t),this._rightArcVisualElement=new F(t),this._topArcVisualElement=new F(t),this._bottomArcVisualElement=new F(t),this._centralLongitude=new F(i),this._centralLatitude=new F(i),this.addHandles([w(()=>{const r=this.viewshedComputedData;if(!(r!=null&&r.isValid()))return null;const s=this._offsetScale,o=this._viewshedCorners,a=this._arcCenterPoints,l=this._parallelCenters;return r.cornerPoints(s,o),r.arcCentersPoints(s,a),r.parallelCenterPoints(l),{viewshedComputedData:r,corners:o,arcCenters:a,parallelCenters:l}},r=>{r!=null?(this._forEachVisualElement(s=>s.attached=!0),this._updateVisualElements(r)):this._forEachVisualElement(s=>s.attached=!1)},{initial:!0,equals:me}),w(()=>{var r;return{visible:this.visible,horFOV:(r=this.viewshedComputedData)==null?void 0:r.horizontalFieldOfView}},({visible:r,horFOV:s},o)=>{r!==(o==null?void 0:o.visible)&&this._forEachVisualElement(a=>a.visible=r),r&&s!==(o==null?void 0:o.horFOV)&&(this._boundaryLinesVisualElement.visible=s!==360)},C),w(()=>this._color,r=>this._forEachVisualElement(s=>s.color=r),C)])}get _color(){var l,d;const t=this.viewshedComputedData;if(t==null)return G.toUnitRGBA(jt);const i=this.analysisViewData,r=((l=i.tool)==null?void 0:l.active)||i.interactive,s=t===i.selectedViewshedComputedData,o=t.viewshed===((d=i.tool)==null?void 0:d.stagedViewshed),a=r&&(s||o)?this.view.effectiveTheme.accentColor:jt;return G.toUnitRGBA(a)}get _offsetScale(){return ne(this.viewshedComputedData,this.view)}destroy(){this._boundaryLinesVisualElement=M(this._boundaryLinesVisualElement),this._leftArcVisualElement=M(this._leftArcVisualElement),this._rightArcVisualElement=M(this._rightArcVisualElement),this._topArcVisualElement=M(this._topArcVisualElement),this._bottomArcVisualElement=M(this._bottomArcVisualElement),this._centralLongitude=M(this._centralLongitude),this._centralLatitude=M(this._centralLatitude)}_forEachVisualElement(t){[this._boundaryLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(t)}_updateVisualElements(t){const{viewshedComputedData:i,corners:r,arcCenters:s,parallelCenters:o}=t;this._updateBoundaryLines(r),this._updateBoundaryArcs(i,r,o),this._updateCentralHelperArcs(i,s)}_updateBoundaryLines(t){this._boundaryLinesVisualElement.geometry=[[t.center,t.topLeft],[t.center,t.topRight],[t.center,t.bottomLeft],[t.center,t.bottomRight]]}_updateBoundaryArcs(t,i,r){const{observerRenderSpace:s,rightVector:o,horizontalFieldOfView:a,tiltedUpVector:l}=t,d=b(a),h=c(),u=O();Z(u,d/2,l),X(h,o,u),U(this._leftArcVisualElement,s,i.bottomLeft,i.topLeft,"forward",h),Z(u,-d/2,l),N(h,0,0,0),X(h,o,u),U(this._rightArcVisualElement,s,i.bottomRight,i.topRight,"forward",h);const v=a>180?"backward":"forward";U(this._topArcVisualElement,r.top,i.topRight,i.topLeft,v,l),U(this._bottomArcVisualElement,r.bottom,i.bottomRight,i.bottomLeft,v,l)}_updateCentralHelperArcs(t,i){const r=t.observerRenderSpace,s=t.horizontalFieldOfView>=180?"backward":"forward";U(this._centralLatitude,r,i.right,i.left,s,t.tiltedUpVector),U(this._centralLongitude,r,i.top,i.bottom,"forward",t.leftVector)}};function U(e,t,i,r,s,o,a=5){const l=c();D(l,i,t);const d=Ht(l),h=c();D(h,r,t),K(h,h),A(h,h,d);let u=Vt(l,h);const v=Ve(o);s==="backward"&&(re(v,v),u=-(2*Math.PI-u));const m=[],f=Math.ceil(Math.abs(u)/b(a)),g=O();Z(g,u/f,v);const y=c();J(y,l);const it=c();J(it,i);for(let Rt=0;Rt<f;Rt++){const Pt=c();J(Pt,it),X(y,y,g),H(it,t,y);const Ft=c();J(Ft,it),m.push([Pt,Ft])}e.geometry=m}n([p()],E.prototype,"view",void 0),n([p()],E.prototype,"analysisViewData",void 0),n([p()],E.prototype,"viewshedComputedData",void 0),n([p()],E.prototype,"visible",void 0),n([p()],E.prototype,"_color",null),n([p()],E.prototype,"_offsetScale",null),E=n([k("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],E);const ni=E;let x=class extends q{get visible(){return this.analysisViewData.visible}constructor(t){super(t)}initialize(){const t=this.analysisViewData,i=St(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:r})=>{const s=new ni({view:this.view,viewshedComputedData:r,analysisViewData:t});return{visualization:s,remove:()=>s.destroy()}});this._viewshedVisualizations=i,this.addHandles([ve(i),w(()=>this.visible,r=>this._viewshedVisualizations.forEach(({visualization:s})=>s.visible=r))])}};n([p({constructOnly:!0})],x.prototype,"analysisViewData",void 0),n([p({constructOnly:!0,nonNullable:!0})],x.prototype,"view",void 0),n([p({constructOnly:!0})],x.prototype,"isDecoration",void 0),n([p()],x.prototype,"visible",null),x=n([k("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],x);var Ct;let _=Ct=class extends q{constructor(e){super(e)}get observer(){return this.viewshed.observer??new nt}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,c())}get target(){const e=this.targetRenderSpace;return this.renderSpaceToPoint(e,this.observer.spatialReference)}get targetRenderSpace(){const{leftVector:e,northVector:t,upVector:i}=this,r=this.observerRenderSpace,s=this.farDistanceRenderSpace,o=c();return A(o,t,s),I(o,-b(this.heading),i,o),I(o,-b(this.tiltParallelToSurface),e,o),H(o,r,o),o}get targetDirection(){const e=D(c(),this.targetRenderSpace,this.observerRenderSpace);return K(e,e)}get tiltedUpVector(){const e=I(this.upVector,-b(this.tiltParallelToSurface),this.leftVector,c());return K(e,e)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,O())}get upVector(){const e=this._basis;return P(e[8],e[9],e[10])}get northVector(){const e=this._basis;return P(e[4],e[5],e[6])}get leftVector(){const e=this.upVector,t=I(this.northVector,-b(this.heading),e,c());return pt(t,e,t)}get rightVector(){return re(c(),this.leftVector)}clone(){return new Ct({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}isValid(){return this.viewshed.isValid()}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(e,t,i){const{observerRenderSpace:r,targetRenderSpace:s}=this,o=D(Q,s,r);return I(o,-b(t),this.leftVector,o),I(o,-b(e),this.tiltedUpVector,o),H(i,o,r)}cornerPoints(e,t){const i=this.observerRenderSpace,r=this.horizontalFieldOfView/2,s=this.verticalFieldOfView/2,o=this.pointOnSphere(-r,s,_i),a=this.pointOnSphere(r,s,wi),l=this.pointOnSphere(-r,-s,fi),d=this.pointOnSphere(r,-s,Vi),h=D(ci,o,i),u=D(ui,a,i),v=D(mi,l,i),m=D(vi,d,i),{horizontalFieldOfView:f}=this,g=hi;Nt(h,u,o,l,i,e,f,t.topLeft,t.bottomLeft,g);const y=di;Nt(m,v,a,d,i,e,f,t.topRight,t.bottomRight,y),A(t.center,H(t.center,y,g),.5)}arcCentersPoints(e,t){const i=this.horizontalFieldOfView/2,r=this.verticalFieldOfView/2,s=this.pointOnSphere(0,r,t.top),o=this.pointOnSphere(0,-r,t.bottom),a=this.pointOnSphere(-i,0,t.left),l=this.pointOnSphere(i,0,t.right),{observerRenderSpace:d}=this;rt(s,d,e),rt(o,d,e),rt(a,d,e),rt(l,d,e)}parallelCenterPoints(e){const t=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin(b(this.verticalFieldOfView/2)),r=A(Q,this.tiltedUpVector,i);H(e.top,t,r),D(e.bottom,t,r)}renderSpaceToPoint(e,t){const i=Q;return this.renderCoordsHelper.fromRenderCoords(e,i,t),new nt(i[0],i[1],i[2],t)}_pointToRenderSpace(e,t){const i=ge(e.toArray());return this.renderCoordsHelper.toRenderCoords(i,e.spatialReference,t),t}};function Nt(e,t,i,r,s,o,a,l,d,h){const u=li(e,t,o,pi);H(h,s,u),Bt(i,e,u,o,a,l),Bt(r,e,u,o,a,d)}function I(e,t,i,r){return Z(Gt,t,i),X(r,e,Gt)}function li(e,t,i,r){const s=pt(r,e,t);return K(s,s),A(s,s,i),s}function Bt(e,t,i,r,s,o){const a=K(Q,t);return A(a,a,r),H(o,e,a),s!==0&&s!==360&&H(o,o,i),o}function rt(e,t,i){const r=D(Q,e,t);K(r,r),A(r,r,i),H(e,e,r)}n([p()],_.prototype,"renderCoordsHelper",void 0),n([p()],_.prototype,"viewshed",void 0),n([p()],_.prototype,"observer",null),n([p()],_.prototype,"farDistance",null),n([p()],_.prototype,"farDistanceRenderSpace",null),n([p()],_.prototype,"heading",null),n([p()],_.prototype,"tilt",null),n([p()],_.prototype,"tiltParallelToSurface",null),n([p()],_.prototype,"horizontalFieldOfView",null),n([p()],_.prototype,"verticalFieldOfView",null),n([p()],_.prototype,"observerRenderSpace",null),n([p()],_.prototype,"target",null),n([p()],_.prototype,"targetRenderSpace",null),n([p()],_.prototype,"targetDirection",null),n([p()],_.prototype,"tiltedUpVector",null),n([p()],_.prototype,"_basis",null),n([p()],_.prototype,"upVector",null),n([p()],_.prototype,"northVector",null),n([p()],_.prototype,"leftVector",null),n([p()],_.prototype,"rightVector",null),n([p()],_.prototype,"isValid",null),n([p()],_.prototype,"metersPerUnit",null),_=Ct=n([k("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],_);const Q=c(),pi=c(),hi=c(),di=c(),ci=c(),ui=c(),mi=c(),vi=c(),_i=c(),wi=c(),fi=c(),Vi=c(),Gt=O();let S=class extends Ee(q){constructor(t){super(t),this.observer=null,this.farDistance=1e3,this.heading=0,this.tilt=90,this.horizontalFieldOfView=45,this.verticalFieldOfView=45}isValid(){return this.observer!=null&&this.farDistance>0}equals(t){return ce(this.observer,t.observer)&&this.farDistance===t.farDistance&&this.heading===t.heading&&this.tilt===t.tilt&&this.horizontalFieldOfView===t.horizontalFieldOfView&&this.verticalFieldOfView===t.verticalFieldOfView}};n([p({type:nt})],S.prototype,"observer",void 0),n([p({type:Number,nonNullable:!0,range:{min:0}})],S.prototype,"farDistance",void 0),n([p({type:Number,nonNullable:!0}),Re(e=>Dt.normalize(_e(e)))],S.prototype,"heading",void 0),n([p({type:Number,nonNullable:!0,range:{min:0,max:180}})],S.prototype,"tilt",void 0),n([p({type:Number,nonNullable:!0,range:{min:0,max:360}})],S.prototype,"horizontalFieldOfView",void 0),n([p({type:Number,nonNullable:!0,range:{min:0,max:180}})],S.prototype,"verticalFieldOfView",void 0),n([p()],S.prototype,"isValid",null),S=n([k("esri.analysis.Viewshed")],S);const gi=S,le=ze,bi=et*le,ct=5,st=.0025,yi=1,Mi=Math.sin(b(2)),Di=et/1.5,Kt=5,ut=1;let Oi=class extends oe{constructor(t){super(),this._handles=new lt,this._interactive=!0,this._tool=t.tool,this._view=t.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles=M(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulators=null}get interactive(){return this._interactive}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}createDragPipeline(t,i){const r=Object.values(this._manipulators);return ie(r.map(({manipulator:s,side:o})=>ot(s,(a,l,d,h,u)=>{const v=Si(o,i);tt(o)?i.horizontalFieldOfView:i.verticalFieldOfView;const m=l.next(g=>({...g,manipulatorType:R.SCALE,side:o})),f=$t(m,this._view,v);t(a,f,d)})))}updateManipulatorsTransform(t){this._forEachManipulatorInfo(i=>this._updateArcManipulatorTransform(i,t))}updateManipulatorVisuals(t){this._forEachManipulatorInfo(i=>this._updateArcManipulatorVisuals(i,t))}_updateArcManipulatorVisuals({manipulator:t,side:i},r){const s=[];if(r!=null){if(i==="left"&&(r.horizontalFieldOfView<ut||r.horizontalFieldOfView>360-ut)||i==="bottom"&&r.verticalFieldOfView<ut)return t.renderObjects=[],void(t.collisionType={type:"line",paths:[]});const[o,a]=$i(i,r,this._unfocusedArcMaterial);s.push(new L(o,j.Unfocused),new L(o.instantiate({material:this._focusedArcMaterial}),j.Focused)),t.collisionType={type:"line",paths:[a]}}t.renderObjects=s,t.radius=10}_updateArcManipulatorTransform({manipulator:t,side:i},r){const s=r.horizontalFieldOfView,o=b(r.verticalFieldOfView/2),a=b(s/2),l=tt(i);t.location=r.observer;const d=O(),h=y=>{Mt(d,y,d)};h(at(z,b(-90))),l||h(bt(z,o));const u=r.farDistanceRenderSpace;h(se(z,N(qt,u,u,u))),h(yt(z,Ti(i))),h(ae(r,z));const v=D(qt,r.targetRenderSpace,r.observerRenderSpace);let m,f;if(h(Et(z,v)),l){if(m=a,f=r.tiltedUpVector,s!==0&&s!==360){const y=ne(r,this._view);m+=2*Math.tan(y/(2*r.farDistance))}}else f=r.rightVector,m=o;m*=i==="right"||i==="bottom"?-1:1;const g=Z(z,m,f);g!=null&&h(g),t.modelTransform=d}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator(i=>{i.interactive=!t&&this.interactive||i.grabbing})}_createManipulators(){const t=this._createArcManipulator("left"),i=this._createArcManipulator("right"),r=this._createArcManipulator("top"),s=this._createArcManipulator("bottom");this._manipulators={left:t,right:i,top:r,bottom:s};const o=[[s.manipulator,r.manipulator],[t.manipulator,i.manipulator]];o.push(...o.map(([a,l])=>[l,a])),this._handles.add(o.map(([a,l])=>a.events.on("focus-changed",d=>{const h=d.action==="focus";l.hovering=h})))}_createArcManipulator(t){const i={manipulator:new At({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),side:t};return this._updateArcManipulatorVisuals(i),i}_createArcMaterial(t){const i=t?bi:le,r=new ke({renderOccluded:ht.OccludeAndTransparent,isDecoration:!0,width:i});return this._handles.add(w(()=>G.toUnitRGBA(this._view.effectiveTheme.accentColor),s=>r.setParameters({color:s}),C)),r}forEachManipulator(t){Object.values(this._manipulators).forEach(({manipulator:i})=>t(i,R.SCALE))}_forEachManipulatorInfo(t){Object.values(this._manipulators).forEach(i=>t(i))}};function $i(e,t,i){const{horizontalFieldOfView:r,verticalFieldOfView:s}=t,o=tt(e),a=b(be((o?s:r)/2,0,15)),l=o?1:Math.max(Math.sin(b(90-s/2)),.1),d=pe(-a/2,a/2,l,[-l,0,0]);return[Ue(i,d),d]}function pe(e,t,i,r=[0,0,0],s=10){Ne(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const o=t-e,[a,l,d]=r;if(o<=0||i<=0)return[P(a,l,d+.001),P(a,l,l+-.001)];const h=[],u=o/s;for(let v=0;v<s;v++){let m=e+v*u;v===s-1&&(m=t);const f=Math.cos(m)*i,g=Math.sin(m)*i,y=P(f+a,l,g+d);h.push(y)}return h}function Ci(e){switch(e){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function Ti(e){return Ci(e)*Hi}function tt(e){return e==="left"||e==="right"}function Si(e,{observerRenderSpace:t,targetDirection:i,tiltedUpVector:r,rightVector:s}){const o=tt(e)?s:r;return Ot(t,i,o)}const Hi=Math.PI/2,z=O(),qt=c();class mt extends At{constructor(t,i,r,s){super({view:t,autoScaleRenderObjects:!1,worldSized:!0,radius:5}),this._handles=new lt,this._setupManipulatorVisual(i,r,s)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(t,i,r){const s=this._createMaterial(),o=b(i),a=t?1:Math.sin(o),l=t?pe(0,o,a,[-a,0,0]):[P(0,0,0),P(0,0,a)],d=Ut(s,l,r,16,!1),h=Ut(s,l,r*et,16,!1),u=Wt(!1,s,r),v=Wt(!0,s,r),m=O();Et(m,l[l.length-1]),B(m,m,bt(vt,Math.PI/2)),B(m,m,at(vt,Math.PI/2)),t&&B(m,m,bt(vt,-o)),u.transformation=m,v.transformation=m,this.renderObjects=[new L(d,j.Unfocused),new L(h,j.Focused),new L(u,j.Unfocused),new L(v,j.Focused)];const f=P(0,he(!0),0),g=X(f,f,m),y=[...l,g];this.collisionType={type:"line",paths:[y]}}_createMaterial(){const t=new We({cullFace:qe.Back,renderOccluded:ht.OccludeAndTransparent,isDecoration:!0,writeLinearDepth:!0});return this._handles.add(w(()=>G.toUnitRGBA(this.view.effectiveTheme.accentColor),i=>t.setParameters({color:i}),C)),t}}function Wt(e,t,i){const r=he(e);let s=2*i;e&&(s*=et);const o=r/2;return Ie(t,r,o,o,s,0)}function he(e){let t=Mi;return e&&(t*=Di),t}const vt=O();let Ei=class extends oe{constructor(t){super(),this._handles=new lt,this._interactive=!0,this._tool=t.tool,this._view=t.view,this._manipulatorHeading=new mt(this._view,!0,ct,st),this._manipulatorTilt=new mt(this._view,!0,ct,st),this._manipulatorDistance=new mt(this._view,!1,ct,st),this.forEachManipulator(i=>{this._tool.manipulators.add(i),this._handles.add(i.events.on("grab-changed",()=>this._updateManipulatorInteractivity()))})}destroy(){this._handles.destroy(),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}get interactive(){return this._interactive}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}createHeadingDragPipeline(t,i){return ot(this._manipulatorHeading,(r,s,o,a,l)=>{const{_view:d}=this,h=Math.sin(b(i.tiltParallelToSurface))*i.farDistanceRenderSpace,u=H(_t,i.observerRenderSpace,A(Qt,i.upVector,h)),v=pt(Qt,i.northVector,i.upVector),m=Ot(u,i.northVector,v),f=$t(s,d,m).next(g=>({...g,manipulatorType:R.ROTATE}));t(r,f,o)})}createTiltDragPipeline(t,i){return ot(this._manipulatorTilt,(r,s,o,a,l)=>{const d=Ot(i.observerRenderSpace,i.targetDirection,i.tiltedUpVector),h=$t(s,this._view,d).next(u=>({...u,manipulatorType:R.ROTATE}));t(r,h,o)})}createDistanceDragPipeline(t,i){return ot(this._manipulatorDistance,(r,s,o,a,l)=>{const d=Ke(i.observerRenderSpace,i.targetDirection),h=s.next(Be(this._view,r.location)).next(Se(this._view,d)).next(u=>({...u,manipulatorType:R.SCALE}));t(r,h,o)})}updateManipulators(t){const{target:i}=t;this._manipulatorHeading.location=i,this._manipulatorTilt.location=i,this._manipulatorDistance.location=i;const r=O(),s=u=>{Mt(r,u,r)},o=Ai(t);s(se(W,N(_t,o,o,o))),s(ae(t,W));const a=st*et*o,l=A(_t,t.targetDirection,a);s(Et(W,l));const d=yt(W,-wt);B(d,d,at(Yt,-wt)),this._manipulatorHeading.modelTransform=B(O(),r,d);const h=at(W,wt);B(h,h,yt(Yt,Math.PI)),this._manipulatorTilt.modelTransform=Mt(O(),r,h),this._manipulatorDistance.modelTransform=r}_updateManipulatorInteractivity(){const t=!this.grabbing;this.forEachManipulator(i=>{i.interactive=t&&this._interactive||i.grabbing})}forEachManipulator(t){t(this._manipulatorHeading,R.ROTATE),t(this._manipulatorTilt,R.ROTATE),t(this._manipulatorDistance,R.SCALE)}};const Jt={top:c(),bottom:c(),left:c(),right:c()},W=O(),Yt=O(),_t=c(),Qt=c(),wt=Math.PI/2;function Ai(e){const{verticalFieldOfView:i,horizontalFieldOfView:r}=e,s=i>180,o=r>180,a=e.farDistanceRenderSpace;if(s&&o)return Math.max(1,a);e.arcCentersPoints(a,Jt);const{left:l,right:d,top:h,bottom:u}=Jt,v=1.9*(s?xt(l,d):o?xt(u,l):Math.sqrt(Math.min(Lt(u,h),Lt(l,d))));return Math.max(1,Math.min(a,v))}class de extends At{constructor(t,i){super({view:t,autoScaleRenderObjects:!1,worldSized:!1,radius:Kt,interactive:!1}),this._handles=new lt;const r=Ce(this._color);this.renderObjects=[new L(je(r,Kt,32,32))],i.manipulators.add(this),this._handles.add([w(()=>this._color,s=>{r.setParameters({color:s})},C)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return G.toUnitRGBA(this.view.effectiveTheme.accentColor)}}n([p()],de.prototype,"_color",null);const Xt=Symbol("dragHandles"),Zt=Symbol("hideManipulators");let $=class extends q{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._moveHelperVisualElement=null,this._settings=new Je({getTheme:()=>this.view.effectiveTheme}),this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new Oi({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Ei({view:this.view,tool:this.parentTool}),this._observerManipulator=new de(this.view,this.parentTool),this._createMoveHelperVisuals(),this.addHandles([w(()=>{const{observer:t}=this;return{observer:t,array:t==null?void 0:t.toArray()}},({observer:t})=>{t!=null&&(this._moveManipulation.location=t,this._observerManipulator.location=t)},Y),w(()=>{const{viewshedComputedData:t}=this;return{viewshedComputedData:t,observer:t==null?void 0:t.observer}},({viewshedComputedData:t,observer:i},r)=>{this._grabbing&&i!==(r==null?void 0:r.observer)||(this.removeHandles(Xt),t!=null&&t.isValid()&&this.addHandles([this._buildObserverDragPipeline(t),this._buildFOVDragPipeline(t),this._buildScaleOrientDragPipeline(t)].filter(we),Xt))},C),w(()=>{const t=this.viewshedComputedData;return t!=null&&t.isValid()?{viewshedCompData:t,target:t.targetRenderSpace,hFOV:t.horizontalFieldOfView,vFOV:t.verticalFieldOfView}:null},t=>{t!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(t.viewshedCompData)},C),w(()=>{const t=this.viewshedComputedData;return t!=null&&t.isValid()?{viewshedCompData:t,hFOV:t.horizontalFieldOfView,vFOV:t.verticalFieldOfView,tilt:t.tilt}:null},t=>{t!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(t.viewshedCompData)},C),w(()=>{var t;return this.analysisViewData.visible&&(((t=this.viewshedComputedData)==null?void 0:t.isValid())??!1)&&!this.parentTool.placingTarget},t=>this._updateManipulationAvailability(t),C),w(()=>{const t=this.viewshedComputedData;if(!(t!=null&&t.isValid()))return null;const{observer:i,target:r,verticalFieldOfView:s,horizontalFieldOfView:o}=t;return{viewshedCompData:t,observer:i,target:r,verticalFieldOfView:s,horizontalFieldOfView:o}},t=>{t!=null&&this._scaleOrientManipulation.updateManipulators(t.viewshedCompData)},C),w(()=>{var t;return(t=this.viewshedComputedData)==null?void 0:t.observerRenderSpace},t=>{t!=null&&this._updateMoveHelperVisualsLocation(t)},C)]);const e=t=>{this.addHandles([t.events.on("focus-changed",()=>this._updateManipulatorVisibility()),t.events.on("grab-changed",i=>{this._grabbing=i.action==="start"})])};this._forEachManipulator(e)}destroy(){this._moveManipulation=M(this._moveManipulation),this._fieldOfViewManipulation=M(this._fieldOfViewManipulation),this._scaleOrientManipulation=M(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=M(this._observerManipulator),this._destroyMoveHelperVisuals()}get viewshed(){var e;return(e=this.viewshedComputedData)==null?void 0:e.viewshed}get grabbing(){return this._grabbing}get observer(){var e;return(e=this.viewshed)==null?void 0:e.observer}set observer(e){const t=this.viewshed;t!=null&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}onManipulatorSelectionChanged(){this._updateManipulatorVisibility()}hasManipulator(e){let t=!1;return this._forEachManipulator(i=>{t=t||i===e}),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new xe({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:Le})}_buildObserverDragPipeline(e){const t={mode:"absolute-height",offset:0},i=e.observer;return i==null?null:this._moveManipulation.createDragPipeline((r,s,o,a,l)=>{a=a.next(dt(this,["observer"]));const d=e.observer.clone();if(d==null)return{steps:o,cancel:a};const h=Xe.fromGeometry(d,Fe(this.view.viewingMode));return{steps:o.next(Ge({operations:h})).next(u=>(this.observer=Pe(h.data.geometry,d.spatialReference),u)),cancel:a}},t,i.spatialReference,void 0)}_buildFOVDragPipeline(e){let t=0,i=0;return this._fieldOfViewManipulation.createDragPipeline((r,s,o)=>{if(e==null)return{steps:s,cancel:o};const a=e.viewshed;return o=o.next(dt(e,["horizontalFieldOfView","verticalFieldOfView"])),{steps:s.next(l=>{l.action==="start"&&(t=e.horizontalFieldOfView,i=e.verticalFieldOfView);const d=l.deltaAngle;let h=0;switch(l.side){case"left":h=t/2-d;break;case"right":h=t/2+d;break;case"top":h=i+2*d;break;case"bottom":h=i-2*d}return tt(l.side)?(h=Dt.normalize(h),h=h>270?0:h>180?180:h,a.horizontalFieldOfView=2*h):a.verticalFieldOfView=h,l}),cancel:o}},e)}_buildScaleOrientDragPipeline(e){let t=0,i=0;const r=(s,o)=>(a,l,d)=>{if(e==null)return{steps:l,cancel:d};const h=e.viewshed;return d=d.next(dt(h,[s])),{steps:l=l.next(o(h,e)),cancel:d}};return ie([this._scaleOrientManipulation.createHeadingDragPipeline(r("heading",(s,o)=>a=>(a.action==="start"&&(i=e.heading),s.heading=Dt.normalize(i+a.deltaAngle),a)),e),this._scaleOrientManipulation.createTiltDragPipeline(r("tilt",(s,o)=>a=>{a.action==="start"&&(t=e.tilt);let l=t+a.deltaAngle;return l<-90?l=180:l>270&&(l=0),s.tilt=Pi.clamp(l),a}),e),this._scaleOrientManipulation.createDistanceDragPipeline(r("farDistance",(s,o)=>a=>{const l=D(Ri,a.renderEnd,o.observerRenderSpace),d=Ht(l)*o.metersPerUnit,h=gt(l,o.targetDirection)<0?yi:d;return s.farDistance=h,a}),e)])}_updateManipulationAvailability(e){this._moveManipulation.available=e,this._fieldOfViewManipulation.available=e,this._scaleOrientManipulation.available=e,this._observerManipulator.available=e}_updateManipulatorVisibility(){const e=this._someManipulatorSelected()||this._someManipulatorHovering()&&this.view.activeTool==null;if(e)this.removeHandles(Zt);else{const t=[],i=r=>{t.push(r.disableDisplay())};this._forEachManipulator(i),this.addHandles(t,Zt)}this._updateMoveHelperVisualsVisibility(e)}_forEachManipulator(e){this._moveManipulation.forEachManipulator(e),this._fieldOfViewManipulation.forEachManipulator(e),this._scaleOrientManipulation.forEachManipulator(e),e(this._observerManipulator)}_createMoveHelperVisuals(){this._destroyMoveHelperVisuals();const e=new Qe({view:this.view,attached:!0,style:{glowWidth:this._settings.visualElements.heightPlane.glowWidth,innerWidth:this._settings.visualElements.heightPlane.innerWidth},isDecoration:!0}),t=new Ye({view:this.view,extensionType:this._settings.visualElements.zVerticalLine.extensionType,attached:!0,innerWidth:1,writeDepthEnabled:!1,renderOccluded:ht.OccludeAndTransparent,isDecoration:!0});this._moveHelperVisualElement={laserline:e,verticalLine:t},this.addHandles([w(()=>this._settings.visualElements.zVerticalLine,i=>i.apply(t),Y),w(()=>this._settings.visualElements.heightPlane,i=>i.apply(e),Y)])}_updateMoveHelperVisualsVisibility(e){e=this.analysisViewData.visible&&e;const t=this._moveHelperVisualElement;t!=null&&(t.verticalLine.visible=e,t.laserline.visible=e)}_updateMoveHelperVisualsLocation(e){const t=this._moveHelperVisualElement;if(t==null)return;const{laserline:i,verticalLine:r}=t;i.heightManifoldTarget=e,i.intersectsWorldUpAtLocation=e,e!=null&&r.setStartEndFromWorldDownAtLocation(e)}_destroyMoveHelperVisuals(){const e=this._moveHelperVisualElement;e!=null&&(e.laserline.destroy(),e.verticalLine.destroy(),this._moveHelperVisualElement=null)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,moveHelperVisualElements:this._moveHelperVisualElement,viewshedComputedData:this.viewshedComputedData}}};n([p({constructOnly:!0})],$.prototype,"analysis",void 0),n([p({constructOnly:!0})],$.prototype,"analysisViewData",void 0),n([p({constructOnly:!0})],$.prototype,"parentTool",void 0),n([p({constructOnly:!0,nonNullable:!0})],$.prototype,"view",void 0),n([p()],$.prototype,"viewshed",null),n([p()],$.prototype,"_grabbing",void 0),n([p()],$.prototype,"grabbing",null),n([p()],$.prototype,"viewshedComputedData",void 0),n([p()],$.prototype,"observer",null),$=n([k("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],$);const Ri=c(),Pi=new Ae(0,180);var Tt;let V=Tt=class extends Ze{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creating=!1,this._selectedManipulator=null,this._selectedManipulatorSubTool=null}initialize(){this._intersector=ti(this.view.state.viewingMode);const e=this.analysisViewData.viewshedComputedDataHandles;this.addHandles([w(()=>e.some(t=>t.viewshedComputedData.isValid()),t=>{t&&this.finishToolCreation()},Y),w(()=>this._stagedViewshed,t=>{var i;this._stagedViewshedComputedData=t!=null?(i=this.analysisViewData.viewshedComputedDataHandles.find(r=>r.viewshedComputedData.viewshed===t))==null?void 0:i.viewshedComputedData:null},Y),w(()=>this.firstGrabbedManipulator,t=>{t!=null&&this._selectManipulator(t)},ue),w(()=>this.analysisViewData.visible,t=>{t||this._selectManipulator(null)}),w(()=>this.view.activeTool,t=>{t!==this&&t!=null&&this._selectManipulator(null)})]),this.subToolHandles=St(()=>e,({viewshedComputedData:t})=>{const i=new $({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:t});return{subTool:i,remove:()=>{this._selectedManipulatorSubTool===i&&this._selectManipulator(null),i.destroy()}}})}destroy(){this.subToolHandles=M(this.subToolHandles)}onDeactivate(){this.removeStaged()}get cursor(){return this.creating?"crosshair":null}_selectManipulator(e){var i,r,s;const t=this._selectedManipulator;t!=null&&(t.selected=!1,this._selectedManipulator=null,(i=this._selectedManipulatorSubTool)==null||i.onManipulatorSelectionChanged(),this._selectedManipulatorSubTool=null),e!=null&&(e.selected=!0,this._selectedManipulator=e,this._selectedManipulatorSubTool=(r=this.subToolHandles.find(o=>o.subTool.hasManipulator(e)))==null?void 0:r.subTool,(s=this._selectedManipulatorSubTool)==null||s.onManipulatorSelectionChanged())}get selectedViewshed(){var e;return(e=this._selectedManipulatorSubTool)==null?void 0:e.viewshed}set selectedViewshed(e){this.selectViewshed(e)}get selectedViewshedComputedData(){var e;return(e=this._selectedManipulatorSubTool)==null?void 0:e.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:e})=>e.grabbing)}get creating(){return this._creating&&this.active}get placingTarget(){return this._stagedViewshed!=null}createViewsheds(){this._creating=!0}onManipulatorSelectionChanged(){this.subToolHandles.forEach(e=>e.subTool.onManipulatorSelectionChanged())}onInputEvent(e){switch(e.type){case"immediate-click":this._clickDeselectHandler();break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":It.cancel===e.key?this._cancelKeyHandler(e):It.delete.includes(e.key)&&this._deleteKeyHandler()}}onInputEventAfter(e){e.type==="immediate-click"&&this._clickPlacementHandler(e)}_clickDeselectHandler(){this.hasFocusedManipulators||this._selectManipulator(null)}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const t=this._stagedViewshed,i=this._intersectScreen(e,ee);if(i!=null){if(t==null){i.mapPoint.z=(i.mapPoint.z??0)+2;const r=new gi({observer:i.mapPoint.clone()});this.analysis.viewsheds.add(r),this._stagedViewshed=r,this._updateStagedViewshed(i.scenePoint)}else{this._updateStagedViewshed(i.scenePoint);const r=this._stagedViewshed;this._stagedViewshed=null,this.selectViewshed(r)}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._selectManipulator(null),this._creating=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating||this._stagedViewshed==null)return;const t=this._intersectScreen(e,ee);t!=null&&this._updateStagedViewshed(t.scenePoint)}_cancelKeyHandler(e){if(this.creating){if(this.removeStaged())return this._selectManipulator(null),void e.stopPropagation();this._creating=!1}else if(!this.grabbing)return this.selectViewshed(null),void e.stopPropagation()}_deleteKeyHandler(){this.creating&&this.removeStaged(),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(e){const t=this._stagedViewshed,i=this._stagedViewshedComputedData;if(t==null||i==null)return;const{heading:r,tilt:s,farDistance:o}=Fi(this.view,i,e);t.farDistance=o,t.tilt=s,t.heading=r}removeStaged(){return this._stagedViewshed!=null&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}selectViewshed(e){var i;if(e!=null)for(const r of this.view.tools.items)r!==this&&r instanceof Tt&&r.selectViewshed(null);const t=(i=this.subToolHandles.find(r=>r.subTool.viewshed===e))==null?void 0:i.subTool;this._selectManipulator(t==null?void 0:t.discManipulator)}_intersectScreen(e,t){const i=ei(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const r=this._intersector.results.min,s=t.scenePoint;if(!r.getIntersectionPoint(s))return null;const o=t.mapPoint;return o.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(s,o),o==null?null:t}get test(){var e;return{subTools:this.subToolHandles.map(t=>t.subTool.test),selectedSubTool:(e=this._selectedManipulatorSubTool)==null?void 0:e.test,stagedViewshed:this._stagedViewshed}}};function Fi(e,t,i){const r=t.observerRenderSpace,s=D(zi,i,r),o=Ht(s)*t.metersPerUnit,a=e.renderCoordsHelper.basisMatrixAtPosition(r,ki),l=N(xi,a[8],a[9],a[10]),d=Me(r,l,Ui),h=De(d,i,Li),u=D(h,h,r),v=ft(Vt(s,u))*(gt(l,s)<0?-1:1)+90,m=N(te,a[4],a[5],a[6]),f=ft(Vt(m,u)),g=N(te,a[0],a[1],a[2]);return{heading:gt(u,g)<0?360-f:f,tilt:v,farDistance:o}}n([p({constructOnly:!0})],V.prototype,"view",void 0),n([p()],V.prototype,"analysisViewData",void 0),n([p()],V.prototype,"removeIncompleteOnCancel",void 0),n([p()],V.prototype,"automaticManipulatorSelection",void 0),n([p({constructOnly:!0})],V.prototype,"analysis",void 0),n([p()],V.prototype,"subToolHandles",void 0),n([p()],V.prototype,"_stagedViewshed",void 0),n([p()],V.prototype,"_stagedViewshedComputedData",void 0),n([p()],V.prototype,"_creating",void 0),n([p({readOnly:!0})],V.prototype,"cursor",null),n([p()],V.prototype,"_selectedManipulator",void 0),n([p()],V.prototype,"_selectedManipulatorSubTool",void 0),n([p()],V.prototype,"selectedViewshed",null),n([p()],V.prototype,"selectedViewshedComputedData",null),n([p()],V.prototype,"grabbing",null),n([p()],V.prototype,"creating",null),n([p()],V.prototype,"placingTarget",null),V=Tt=n([k("esri.views.3d.analysis.Viewshed.ViewshedTool")],V);const zi=c(),xi=c(),Li=c(),te=c(),ki=O(),Ui=ye(),ee={mapPoint:new nt,scenePoint:c()},Ii=V;let T=class extends fe(q){constructor(e){super(e),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this.viewshedComputedDataHandles=null,this._placementTask=null}get selectedViewshed(){var e;return(e=this.tool)==null?void 0:e.selectedViewshed}set selectedViewshed(e){const{tool:t}=this;t!=null&&(t.selectedViewshed=e)}get selectedViewshedComputedData(){var e;return(e=this.tool)==null?void 0:e.selectedViewshedComputedData}initialize(){this._initializeUpdateHandle(),this.viewshedComputedDataHandles=St(()=>this.analysis.viewsheds,e=>{const t=new _({renderCoordsHelper:this.view.renderCoordsHelper,viewshed:e}),i=Symbol();return this.addHandles(w(()=>t.isValid(),(r,s)=>{this.visible&&(r?this._addViewshedsToRenderer(t):s&&this._removeViewshedsFromRenderer(t))},C)),{viewshedComputedData:t,remove:()=>{this.removeHandles(i),this._removeViewshedsFromRenderer(t),t.destroy()}}}),this._analysisVisualization=new x({view:this.view,analysisViewData:this,isDecoration:!this.parent}),this.addHandles([w(()=>this.visible,e=>{const t=this.viewshedComputedDataHandles.map(i=>i.viewshedComputedData).filter(i=>i.isValid());e?this._addViewshedsToRenderer(t):this._removeViewshedsFromRenderer(t)}),w(()=>this.view.renderCoordsHelper,e=>{this.viewshedComputedDataHandles.forEach(({viewshedComputedData:t})=>t.renderCoordsHelper=e)}),ri(this,Ii)])}destroy(){this._placementTask=zt(this._placementTask),si(this),this._analysisVisualization=M(this._analysisVisualization),this._removeViewshedsFromRenderer(this.viewshedComputedDataHandles.map(e=>e.viewshedComputedData))}async createViewsheds(e){return this._placementTask=zt(this._placementTask),this._placementTask=oi(this,e),this.tool!=null&&this.tool.createViewsheds(),await this._placementTask.promise}_initializeUpdateHandle(){const e=this.view._stage.renderer.plugins.plugins.find(t=>t instanceof ii);e&&(this._updateHandleInRenderer=e.updateViewsheds.bind(e))}_addViewshedsToRenderer(e){this._updateHandleInRenderer({adds:e})}_removeViewshedsFromRenderer(e){this._updateHandleInRenderer({removes:e})}};n([p({readOnly:!0})],T.prototype,"type",void 0),n([p({constructOnly:!0,nonNullable:!0})],T.prototype,"analysis",void 0),n([p()],T.prototype,"tool",void 0),n([p()],T.prototype,"selectedViewshed",null),n([p()],T.prototype,"selectedViewshedComputedData",null),n([p()],T.prototype,"viewshedComputedDataHandles",void 0),n([p()],T.prototype,"_analysisVisualization",void 0),n([p()],T.prototype,"_placementTask",void 0),T=n([k("esri.views.3d.analysis.ViewshedAnalysisView3D")],T);const rl=T;export{rl as default};
