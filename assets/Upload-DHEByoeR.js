import{g as y,D as u,s as g,M as v,r as l,m as n,a as _,a3 as w,at as T}from"./Accessor-BHnuXKD2.js";import{a as R}from"./reactiveUtils-BR0C1Kq4.js";import{a7 as k,j as x}from"./Point-XGrwlf63.js";import{Q as F,O as S}from"./projection-B2I9Bzj_.js";import{i as b,e as j,h as E}from"./progressUtils-BmRXf5wX.js";import{o as P}from"./infoFor3D-CsJzgCF0.js";import"./Evented-DCWccWGU.js";import"./SimpleObservable-7oieNGD8.js";import"./cast-BA_-jlhc.js";import"./index-tefRSezt.js";import"./JSONSupport-CGdeqxpk.js";import"./writer-B2bQV2uU.js";import"./vec3f64-BLpZdpfb.js";import"./Extent-CBBGeHb-.js";import"./Polyline-BmuD2-ZN.js";import"./mathUtils-DV9iOXpW.js";import"./projectBuffer-DOU0xvVi.js";import"./geodesicConstants-yASAK_zX.js";let i=class extends y{constructor(){super({}),this.files=[],this.progress=0,this._uploadTask=null,this._layer=null}destroy(){this.cancel(),this.files=[],this._layer=null,this._uploadTask=null}get state(){const e=this._uploadTask;return e&&this.files.length!==0?e.finished?e.error?"error":"success":"pending":"default"}get result(){var e;return((e=this._uploadTask)==null?void 0:e.value)??null}get error(){var e;return((e=this._uploadTask)==null?void 0:e.error)??null}uploadTo(e){this.cancel(),this.files=[],this._layer=e,this._uploadTask=R(async r=>{var d;const a=await z(e);u(r),this.progress=0,this.files=a;const t=b(j.upload,f=>{this.progress=f},"Upload.uploadTo");if(a.length===0)return null;u(r);const s=await e.extractAndFilterFiles(a);u(r),s.length>0&&(this.files=s);const o=await e.convertMesh(s,{signal:r,onProgress:t.makeOnProgress("createFromFiles")});if(u(r),!o)throw new g("editor:upload","could not upload or convert model");const p=s.reduce((f,h)=>f+h.size,0),m=t.simulate("loadMesh",E(p));try{await o.load()}finally{m.remove()}if(v("enable-feature:georeferenced-uploads")&&o.metadata.georeferenced){if(await k(e.spatialReference,(d=o.origin)==null?void 0:d.spatialReference))return{type:"georeferenced",mesh:o};if((e.spatialReference.isWebMercator||e.spatialReference.isWGS84)&&await M(o,e.spatialReference))return{type:"georeferenced-reprojected",mesh:o}}return o.spatialReference=e.spatialReference,o.vertexSpace.origin=[0,0,0],{type:"non-georeferenced",mesh:o}})}retry(){this._layer&&this.uploadTo(this._layer)}cancel(){var e;(e=this._uploadTask)==null||e.abort()}};l([n()],i.prototype,"files",void 0),l([n()],i.prototype,"progress",void 0),l([n()],i.prototype,"state",null),l([n()],i.prototype,"result",null),l([n()],i.prototype,"error",null),l([n()],i.prototype,"_uploadTask",void 0),l([n()],i.prototype,"_layer",void 0),i=l([_("esri.widgets.Editor.Upload")],i);let c=null;async function z(e){const{resolve:r,promise:a}=w(),t=document.createElement("input");t.type="file",t.multiple=!1,t.accept=[...P(e.infoFor3D),".zip"].join(","),t.style.display="none",document.body.appendChild(t);const s=T(t,"change",()=>r(t.files?Array.from(t.files):[]));return c?c(t):t.click(),a.finally(()=>{s.remove(),t.remove()})}function Y(e,r){c=a=>{r==null||r(),Promise.resolve().then(()=>e).then(t=>{if(!c)return;const s=new DataTransfer;t.forEach(o=>s.items.add(o)),a.files=s.files,a.dispatchEvent(new Event("change"))})}}function Z(){c=null}async function M(e,r){if(await F(e.spatialReference,r),!e.vertexSpace.origin)return!1;const[a,t,s]=e.vertexSpace.origin,o=new x({x:a,y:t,z:s,spatialReference:e.spatialReference}),p=S(o,r);return!!p&&(e.vertexSpace.origin=[p.x,p.y,p.z??0],e.spatialReference=r,!0)}export{i as Upload,Z as clearPromptForFilesStub,Y as stubFilePickerToSelect};
