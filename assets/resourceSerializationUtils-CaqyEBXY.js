import{P as x}from"./cast-CsZslgGN.js";import{s as I,o as V}from"./Accessor-BmwT4B0c.js";import{s as se}from"./featureConversionUtils-CvnFcmH_.js";import{e as re}from"./OptimizedGeometry-BJqUA4Pi.js";import{g as ae}from"./Point-Cz2JYYmX.js";import{i as U,r as L,a as N}from"./knowledgeGraphService-DXS9bis6.js";class ie{constructor(){this.version="",this.queryResult=new ne}}let ne=class{constructor(){this.featureResult=new le}};class le{constructor(){this.objectIdFieldName="",this.uniqueIdField=new oe,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new ce,this.geometryType=null,this.spatialReference=new ae,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new $,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}}class oe{constructor(){this.name="",this.isSystemMaintained=!1}}class ce{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}}let $=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new de,this.translate=new ue}};class de{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}}class ue{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}}class ye{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}}let pe=class{constructor(){this.attributes=[],this.compressedGeometry=new k,this.centroid=new k,this.aggregateGeometries=[]}},k=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};var b;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(b||(b={}));const fe=[b.ELEMENTUID,b.TYPENAME];var v,_;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(v||(v={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(_||(_={}));var C,A,R,q;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(C||(C={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(A||(A={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(R||(R={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(q||(q={}));function me(e){const t=new ie;t.version=e.version;const a=e.get_query_result();if(a.results_type.value!==0)throw new Error("Got a non-feature collection type");const s=a.get_feature_result(),r=t.queryResult.featureResult;r.objectIdFieldName=s.objectid_field_name,r.exceededTransferLimit=s.exceeded_transfer_limit,r.hasM=s.has_m,r.hasZ=s.has_z,r.geometryType=U[s.geometry_type.value],r.globalIdFieldName=s.globalid_field_name,r.geohashFieldName=s.geohash_field_name;const l=r.uniqueIdField,p=s.unique_id_field;l.name=p.name,l.isSystemMaintained=p.isSystemMaintained;const o=r.geometryProperties,i=s.geometry_properties;o.shapeAreaFieldName=i.shapeAreaFieldName,o.shapeLengthFieldName=i.shapeLengthFieldName,o.units=i.units;const y=r.spatialReference,c=s.spatial_reference;y.wkid=c.wkid,y.latestWkid=c.latestWkid,y.vcsWkid=c.vcsWkid,y.latestVcsWkid=c.latestVcsWkid,y.wkt=c.wkt,r.transform=he(s.transform);const d=r.fields,u=r.fieldNameToAttributeIndexMap,n=s.fields,g=n.size();for(let f=0;f<g;f++){const T=n.get(f),h=j(T);d.push(h),u[h.name]=f,T.delete()}n.delete();const m=r.values,E=s.values_count();for(let f=0;f<E;f++)m.push(s.get_value_at(f));const X=r.features,F=s.features,G=F.size();if(G>0){for(const f of fe)if(u[f]===void 0)throw new Error(`Feature collection missing required attribute: ${f}`)}for(let f=0;f<G;f++){const T=new pe,h=F.get(f),H=T.attributes,J=h.attributes_count();for(let w=0;w<J;w++)H.push(h.get_attribute_at(w));const O=h.get_compressed_geometry();O&&(T.compressedGeometry=S(O),T.centroid=S(h.get_centroid()));const K=T.aggregateGeometries,M=h.aggregate_geometries,ee=M.size();for(let w=0;w<ee;w++){const P=M.get(w),te=S(P);K.push(te),P.delete()}M.delete(),X.push(T),h.delete()}F.delete();const Z=r.geometryFields,D=s.geometry_fields,Q=D.size();for(let f=0;f<Q;f++){const T=D.get(f),h=Te(T);Z.push(h),T.delete()}return D.delete(),t}function S(e){const t=new k;t.geometryType=U[e.geometry_type.value];const a=[],s=[];for(let r=0;r<e.lengths.length;r++)a.push(e.lengths[r]);for(let r=0;r<e.coords.length;r++)s.push(e.coords[r]);return t.lengths=a,t.coords=s,t}function j(e){const t=new ye;return t.name=e.name,t.alias=e.alias,t.fieldType=L[e.field_type.value],t.sqlType=R[e.sql_type.value],t.domain=e.domain,t.defaultValue=e.default_value,t}function Te(e){const t=j(e);return t.geometryType=U[e.geometry_type.value],t}function he(e){const t=new $;t.quantizeOriginPosition=A[e.quantizeOriginPosition.value];const a=t.scale,s=e.scale;a.xScale=s.xScale,a.yScale=s.yScale,a.mScale=s.mScale,a.zScale=s.zScale;const r=t.translate,l=e.translate;return r.xTranslate=l.xTranslate,r.yTranslate=l.yTranslate,r.mTranslate=l.mTranslate,r.zTranslate=l.zTranslate,t}async function _e(e){const t=[],a={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(Y(e.entitiesUrl).then(s=>{z(s,a)})),e.relationshipsUrl&&t.push(Y(e.relationshipsUrl).then(s=>{z(s,a)})),await Promise.all(t),a}async function ve(e,t){t??(t=!1);const a={generateAllSublayers:t,namedTypeDefinitions:new Map};return await Ee(e).then(s=>{be(s,a)}),a}async function Ue(e,t,a){const s=await N(),r=new s.FeatureCollection;try{B(r,s,e,"entities",t,a);const l=new s.FeatureCollectionEncoder,p=W(r,l),o=structuredClone(p);return l.delete(),o}finally{r.delete()}}async function Ge(e,t,a){const s=await N(),r=new s.FeatureCollection;try{B(r,s,e,"relationships",t,a);const l=new s.FeatureCollectionEncoder,p=W(r,l),o=structuredClone(p);return l.delete(),o}finally{r.delete()}}async function Oe(e){const t=await N(),a=new t.MapOfObjectIdentifierSets;ge(a,t,e);const s=new t.MapOfObjectIdentifierSetsEncoder;try{s.set_map_of_identifier_sets(a),s.encode();const r=s.get_encoding_result();if(r.error.error_code!==0)throw new I("knowledge-graph:layer-support-utils",r.error.error_message);const l=structuredClone(r.get_byte_buffer());return s.delete(),l}finally{a.delete()}}function B(e,t,a,s,r,l){e.version="";const p=new t.QueryResult,o=new t.FeatureResult,i=s==="entities"?v:_;o.unique_id_field={name:i[i.ELEMENTUID],isSystemMaintained:!1},o.globalid_field_name=i[i.ELEMENTUID],o.geohash_field_name="",o.geometry_properties={shapeAreaFieldName:"",shapeLengthFieldName:"",units:""},o.spatial_reference={wkid:4326,latestWkid:4326,vcsWkid:0,latestVcsWkid:0,wkt:""},o.exceeded_transfer_limit=!1,o.has_z=!1,o.has_m=!1,o.transform={quantizeOriginPosition:{value:A.upperLeft},scale:{xScale:1e-9,yScale:1e-9,mScale:1e-4,zScale:1e-4},translate:{xTranslate:-400,yTranslate:-400,mTranslate:-1e5,zTranslate:-1e5}};for(const c of Object.keys(i).filter(d=>isNaN(Number(d)))){const d=new t.Field;if(d.name=c,d.alias=c,d.sql_type={value:R.sqlTypeBigInt},s==="entities")switch(c){case i[i.ELEMENTUID]:case i[i.TYPENAME]:d.field_type={value:L.esriFieldTypeString}}else switch(c){case i[i.ELEMENTUID]:case i[i.TYPENAME]:case _[_.FROMUID]:case _[_.TOUID]:d.field_type={value:L.esriFieldTypeString}}d.domain="",o.add_field(d),d.delete()}const y=new Map;for(const c of r.dataModel.entityTypes)y.set(c.name,"entities");for(const c of r.dataModel.relationshipTypes)y.set(c.name,"relationships");for(const[c,d]of a.namedTypeDefinitions)if(s===y.get(c))for(const u of d.members.values()){const n=new t.Feature;for(const m of Object.keys(i).filter(E=>isNaN(Number(E))))if(s==="entities")switch(m){case i[i.ELEMENTUID]:n.add_attribute(u.id,t.esriFieldType.esriFieldTypeString);break;case i[i.TYPENAME]:n.add_attribute(c,t.esriFieldType.esriFieldTypeString)}else switch(m){case i[i.ELEMENTUID]:n.add_attribute(u.id,t.esriFieldType.esriFieldTypeString);break;case _[_.FROMUID]:n.add_attribute(l.has(u.id)?l.get(u.id)[0]:"",t.esriFieldType.esriFieldTypeString);break;case _[_.TOUID]:n.add_attribute(l.has(u.id)?l.get(u.id)[1]:"",t.esriFieldType.esriFieldTypeString);break;case i[i.TYPENAME]:n.add_attribute(c,t.esriFieldType.esriFieldTypeString)}let g;if(u.linkChartLocation&&"x"in u.linkChartLocation?g=se(u.linkChartLocation):u.linkChartLocation&&(g=u.linkChartLocation),u.linkChartLocation&&g){const m=new t.FeatureCollectionGeometry;let E=!1;switch(s){case"entities":m.geometry_type=t.esriGeometryType.esriGeometryPoint,E=!0;break;case"relationships":m.geometry_type=t.esriGeometryType.esriGeometryPolyline}m.coords=new Float64Array(g.coords),m.lengths=new Uint32Array(E?[1]:g.lengths),n.set_compressed_geometry(m),m.delete()}o.add_feature(n),n.delete()}switch(s){case"entities":o.geometry_type=t.esriGeometryType.esriGeometryPoint;break;case"relationships":o.geometry_type=t.esriGeometryType.esriGeometryPolyline}return p.set_feature_result(o),e.set_query_result(p),o.delete(),p.delete(),e}function ge(e,t,a){for(const[s,r]of a.namedTypeDefinitions){if(!r.members||r.useAllData)continue;const l=r.members.keys();let p=!1,o=!0;const i=new t.ObjectIdArray,y=new t.StringArray,c=new t.GlobalIdArray,d=new t.IdentifierArray,u=new t.ObjectIdentifierSet;for(const n of l)o&&(p=!isNaN(Number(n)),o=!1),p?i.add_objectid(Number(n)):(y.add_string(n),c.add_globalid(n)),d.add_identifier(n);u.set_oid_array(i),u.set_string_array(y),u.set_globalid_array(c),u.set_identifier_array(d),i.delete(),y.delete(),c.delete(),d.delete(),e.put_identifier_set(s,u),u.delete()}return e}async function Y(e){const t=await x(e,{responseType:"array-buffer"});return we(await t.data)}async function we(e){const t=new(await N()).FeatureCollectionDecoder,a=t.decode(new Uint8Array(e));if(a.error_code!==0)throw new I("knowledge-graph:layer-support-utils",a.error_message);const s=t.get_feature_collection(),r=me(s);return t.delete(),r}async function Ee(e){const t=await x(e,{responseType:"array-buffer"}),a=await t.data;return qe(new Uint8Array(a))}async function qe(e){const t=new(await N()).MapOfObjectIdentifierSetsDecoder,a=t.decode(new Uint8Array(e)),s=new Map;if(a.error_code!==0)throw new I("knowledge-graph:layer-support-utils",a.error_message);const r=t.get_map_of_identifier_sets(),l=r.keys,p=l.size();for(let o=0;o<p;o++){const i=l.get(o),y=r.query_identifier_set(i),c=[];if(y.id_array_type.value===q.GLOBALID_ARRAY){const d=y.get_globalid_array(),u=d.count();for(let n=0;n<u;n++)c.push(d.get_globalid_at(n))}else if(y.id_array_type.value===q.IDENTIFIER_ARRAY){const d=y.get_identifier_array(),u=d.count();for(let n=0;n<u;n++)c.push(d.get_identifier_at(n).toString())}else if(y.id_array_type.value===q.STRING_ARRAY){const d=y.get_string_array(),u=d.count();for(let n=0;n<u;n++)c.push(d.get_string_at(n))}else{if(y.id_array_type.value!==q.OID_ARRAY)throw new I("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const d=y.get_oid_array(),u=d.count();for(let n=0;n<u;n++)c.push(d.get_objectid_at(n).toString())}}s.set(i,c)}return t.delete(),s}function z(e,t){var s,r,l;if(!((s=e==null?void 0:e.queryResult)!=null&&s.featureResult))return t;const a=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const p of e.queryResult.featureResult.features){const o=p.attributes[a[b.TYPENAME]],i=V(t.namedTypeDefinitions,o,()=>({useAllData:!1,members:new Map})),y=p.attributes[a[b.ELEMENTUID]];if(((l=(r=p.compressedGeometry)==null?void 0:r.coords)==null?void 0:l.length)>0){let c=p.compressedGeometry.lengths;p.compressedGeometry.geometryType==="esriGeometryPoint"&&(c=[]),i.members.set(y,{id:y,linkChartLocation:new re(c,p.compressedGeometry.coords)})}else i.members.set(y,{id:y})}return t}function be(e,t){for(const[a,s]of e){const r=V(t.namedTypeDefinitions,a,()=>({useAllData:!1,members:new Map}));for(const l of s)r.members.has(l)||r.members.set(l,{id:l})}return t}const W=(e,t)=>{t.set_feature_collection(e),t.encode();const a=t.get_encoding_result();if(a.error.error_code!==0)throw new I("knowledge-graph:layer-support-utils",a.error.error_message);return a.get_byte_buffer()},Pe={fetchAndConvertSerializedLinkChart:e=>_e(e)};export{Pe as D,Ge as g,Oe as h,ve as m,Ue as w};
