import{r as l,m as d,a as Ee,g as Ae,B as Re,o as U,s as me,a6 as Qe,c as D,u as Pe}from"./Accessor-BHnuXKD2.js";import{e as Se,$ as Je,f as He}from"./opacityUtils-CSd4XoR2.js";import{w as ue}from"./Extent-CBBGeHb-.js";import{j as _e,P as We}from"./Polyline-BmuD2-ZN.js";import{Q as Te,O as ce}from"./projection-B2I9Bzj_.js";import{a4 as q,g as qe,j as Ue}from"./Point-XGrwlf63.js";import{I as fe,t as ge,_ as F,E as ae,S as Ne,o as Ie}from"./constants-B4mRqufT.js";import{f as ze}from"./jsonUtils-Cu7OBRmN.js";import{s as Be}from"./featureConversionUtils-DpmsPUmt.js";import{s as Me}from"./OptimizedFeature-DcMLlxvB.js";import{S as Ke}from"./supportUtils-CYitzarn.js";import{F as ne,W as Ve}from"./knowledgeGraphService-BDS0AlFK.js";import{p as B}from"./GraphQueryStreaming-DnnY4k6p.js";import{b as K}from"./Query-DCBIeen2.js";import{d as Ze,q as Ye}from"./Graphic-CFXUQZlS.js";import{S as Xe}from"./MultiOriginJSONSupport-nGLpCFeg.js";import{E as et}from"./workers-D8Q3pEzK.js";import{r as tt}from"./writer-B2bQV2uU.js";import{y as oe}from"./typeUtils-BSg8Y507.js";import{f as it}from"./Layer-C9uQlTBT.js";import{f as nt}from"./FeatureStore-CozDnyvc.js";import{L as ot}from"./QueryEngine-BJMZSAnZ.js";import{y as rt,u as Le}from"./clientSideDefaults-BOCfNRNG.js";import{s as at}from"./fieldProperties-B9JP3-ue.js";import{h as $e}from"./Color-gncXBiLc.js";import{C as V,b as se,n as st}from"./labelingInfo-BvMdv93l.js";import{m as pe}from"./TextSymbol-BQ_NW9Xo.js";import{p as pt,t as lt,n as dt,l as yt}from"./ScaleRangeLayer-C59zG_yk.js";import{a as mt,p as ht,l as ct}from"./DisplayFilteredLayer-BFGyM6i5.js";import{c as ut,p as ft}from"./FeatureEffectLayer-D3Dl2pXD.js";import{d as gt,p as bt}from"./FeatureReductionLayer-x8j38_gH.js";import{p as wt,c as Tt}from"./OrderedLayer-BP2hvfL_.js";import{f as It}from"./RefreshableLayer-Cn2UpWQD.js";import{l as Et,f as Nt}from"./TemporalLayer-CYEvmdjr.js";import{d as St,v as Mt,j as Lt,f as $t,l as Ct}from"./commonProperties-C0eC30J9.js";import{y as he}from"./Field-Cyk7Ur5d.js";import{d as kt}from"./TimeInfo-LjqhhubF.js";import{p as Dt}from"./SimpleRenderer-gSw1WaJS.js";import{t as Ce}from"./jsonUtils-DD1NMzWj.js";import{m as xt}from"./typeUtils-CfF4cYo5.js";import{d as vt}from"./FeatureSet-DpCN730g.js";import{p as jt}from"./popupUtils-pQ0CVidQ.js";import{a as ke}from"./utils-9nq77ifz.js";class Q{constructor(){this._featureLookup=new Map}static getInstance(){return Q.instance||(Q.instance=new Q),Q.instance}static resetInstance(){Q.instance&&(Q.instance=null)}deleteFromStore(e){e.forEach(n=>{this._featureLookup.delete(n)})}readFromStoreByList(e){const n=[];return e.forEach(i=>{const r=this.readFromStoreById(i);r&&n.push(r)}),n}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,n,i){const r=[];return e.forEach(o=>{if(!(o!=null&&o.id))return;o.properties||(o.properties=[]);let a,s=null;if(i&&o.properties[i]&&(s=Be(o.properties[i])),"originId"in o&&"destinationId"in o&&(o.properties[fe]=o.originId,o.properties[ge]=o.destinationId),o.properties[n]=o.id,o.id&&this._featureLookup.has(o.id)&&this._featureLookup.get(o.id).attributes){const p=this._featureLookup.get(o.id),f=JSON.parse(JSON.stringify(Object.assign(p.attributes,o.properties)));i&&o.properties[i]&&(f[i]=ze(o.properties[i])),a=new Me(s?JSON.parse(JSON.stringify(s)):p!=null&&p.geometry?JSON.parse(JSON.stringify(p.geometry)):null,f,null,o.properties[n])}else a=new Me(s?JSON.parse(JSON.stringify(s)):null,o.properties,null,o.properties[n]);this._featureLookup.set(`${o.typeName?`${o.typeName}__${o.id}`:o.id}`,a),r.push(a)}),r}}let O=class extends Ae{constructor(t){var n,i,r;super(t),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const e=new Map;(n=t.knowledgeGraph.dataModel.entityTypes)==null||n.forEach(o=>{var a,s;o.name&&(e.set(o.name,"entity"),this._processingCacheUpdatesLookup.set(o.name,[]),t.inclusionModeDefinition&&!((a=t.inclusionModeDefinition)!=null&&a.generateAllSublayers)||this.entityTypeNames.add(o.name),(s=o.properties)==null||s.forEach(p=>{p.geometryType&&p.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(o.name,{name:p.name??"",geometryType:p.geometryType})}))}),(i=t.knowledgeGraph.dataModel.relationshipTypes)==null||i.forEach(o=>{var a,s;o.name&&(e.set(o.name,"relationship"),this._processingCacheUpdatesLookup.set(o.name,[]),t.inclusionModeDefinition&&!((a=t.inclusionModeDefinition)!=null&&a.generateAllSublayers)||this.relationshipTypeNames.add(o.name),(s=o.properties)==null||s.forEach(p=>{p.geometryType&&p.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(o.name,{name:p.name??"",geometryType:p.geometryType})}))}),(r=t.inclusionModeDefinition)==null||r.namedTypeDefinitions.forEach((o,a)=>{var p,f;if(e.get(a)==="entity")this.entityTypeNames.add(a);else{if(e.get(a)!=="relationship")return Re.getLogger(this).warn(`A named type, ${a}, was in the inclusion list that wasn't in the data model and will be removed`),void((p=t.inclusionModeDefinition)==null?void 0:p.namedTypeDefinitions.delete(a));this.relationshipTypeNames.add(a)}const s=new Map;(f=o.members)==null||f.forEach(g=>{U(this.memberIdTypeLookup,g.id,()=>new Set).add(a);const c=this.getById(g.id);c&&s.set(g.id,c)}),this.sublayerCaches.set(a,s)})}addToLayer(t){t.forEach(({typeName:e,id:n})=>{if(!this.inclusionModeDefinition)throw new me("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const i=this.inclusionModeDefinition.namedTypeDefinitions.get(e);i.members||(i.members=new Map),i.members.set(n,{id:n}),U(this.memberIdTypeLookup,n,()=>new Set).add(e)}}else{const i=new Map;i.set(n,{id:n}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:i}),U(this.memberIdTypeLookup,n,()=>new Set).add(e)}})}getById(t){return Q.getInstance().readFromStoreById(t)}async getData(t,e,n){var r,o;if(e.objectType.name&&((r=this.inclusionModeDefinition)!=null&&r.namedTypeDefinitions)&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(e.objectType.name))return[];let i;if(i=t||new K({where:"1=1",outFields:["*"]}),e.parentCompositeLayer.type==="link-chart"){const a=e.parentCompositeLayer,s=this._processingCacheUpdatesLookup.get(e.objectType.name??""),p=i.outFields;p&&p.length===1&&p[0]===F&&i.where==="1=1"||await Promise.all(s??[]);const f=this.sublayerCaches.has(e.objectType.name??"")?Array.from((o=this.sublayerCaches.get(e.objectType.name))==null?void 0:o.values()):[],g=[];return f.forEach(c=>{if(this.relationshipTypeNames.has(e.objectType.name)){c.geometry=a.relationshipLinkChartDiagramLookup.get(c.attributes[e.objectIdField]);const u=this.memberIdTypeLookup.get(c.attributes[fe]),E=this.memberIdTypeLookup.get(c.attributes[ge]),R=this._isEndEntitySpatial(u,c,fe),v=this._isEndEntitySpatial(E,c,ge);c.attributes[ae]=Number(R&&v)}else{c.geometry=a.entityLinkChartDiagramLookup.get(c.attributes[e.objectIdField]);const u=this.geographicLookup.get(e.objectType.name);u&&c.attributes[u.name]?c.attributes[ae]=1:c.attributes[ae]=0}c.attributes[Ne]=c.geometry,g.push(c)}),g}return this.retrieveDataFromService(i,e,n)}async getConnectedRecordIds(t,e,n){const i=[];let r="";const o=this._getNamedTypeIdMapFromNodeIds(t);if(e&&(e==null?void 0:e.length)!==0){for(const g of e)r=r+g+"|";r=r.slice(0,-1)}const a={},s=[];for(const[g,c]of o){const u=`${g}_ids`;a[u]=c,e&&(e==null?void 0:e.length)!==0?s.push(`MATCH (n:${g}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r:${r}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):s.push(`MATCH (n:${g}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!s.length)return i;const p=s.join(" UNION "),f=(await ne(this.knowledgeGraph,new B({openCypherQuery:p,bindParameters:a}),{signal:n==null?void 0:n.signal})).resultRowsStream.getReader();for(;;){const{done:g,value:c}=await f.read();if(g)break;for(let u=0;u<c.length;u++){const E=c[u];i.push({id:E[0],typeName:E[1]}),i.push({id:E[2],typeName:E[3]})}}return i}async getRelationshipsBetweenNodes(t,e,n){const i=this._getNamedTypeIdMapFromNodeIds(t);if(i.size===0)return[];const r={relationshipExclusionIds:e,possibleConnectionEntityIds:t},o=[];for(const[f,g]of i.entries()){const c=`${f}_ids`;r[c]=g,o.push(`MATCH (n:${f}) WHERE id(n) IN $${c} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const a=o.join(" UNION "),s=[],p=(await ne(this.knowledgeGraph,new B({openCypherQuery:a,bindParameters:r}),{signal:n==null?void 0:n.signal})).resultRowsStream.getReader();for(;;){const{done:f,value:g}=await p.read();if(f)break;for(let c=0;c<g.length;c++){const u=g[c];s.push({id:u[0],typeName:u[1]})}}return s}async getRelationshipsFromNodes(t,e,n,i){const r=this._getNamedTypeIdMapFromNodeIds(t);if(r.size===0||e.length===0)return[];const o={relationshipExclusionIds:n,possibleConnectionEntityIds:e},a=[];for(const[c,u]of r.entries()){const E=`${c}_ids`;o[E]=u,a.push(`MATCH (n:${c}) WHERE id(n) IN $${E} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const s=a.join(" UNION "),p=new Map,f=(await ne(this.knowledgeGraph,new B({openCypherQuery:s,bindParameters:o}),{signal:i==null?void 0:i.signal})).resultRowsStream.getReader();for(;;){const{done:c,value:u}=await f.read();if(c)break;for(let E=0;E<u.length;E++){const R=u[E];let v=p.get(R[1]);v||(v=new Set,p.set(R[1],v)),v.add(R[0])}}const g=[];for(const[c,u]of p)for(const E of u)g.push({id:E,typeName:c});return g}async refreshCacheContent(t,e,n,i=!0,r){var f,g,c,u,E,R,v,Z;const o=Q.getInstance(),a=[],s=new Map,p=new Map;(f=this.knowledgeGraph.dataModel.entityTypes)==null||f.forEach(y=>{y.name&&p.set(y.name,y)}),(g=this.knowledgeGraph.dataModel.relationshipTypes)==null||g.forEach(y=>{y.name&&p.set(y.name,y)}),t||this.inclusionModeDefinition?t?t.forEach(y=>{var M;if(this.memberIdTypeLookup.has(y))for(const j of this.memberIdTypeLookup.get(y))s.has(j)?(M=s.get(j))==null||M.push(y):s.set(j,[y])}):(u=(c=this.inclusionModeDefinition)==null?void 0:c.namedTypeDefinitions)==null||u.forEach((y,M)=>{y.useAllData?s.set(M,null):y.members&&y.members.forEach(j=>{var J;s.has(M)&&s.get(M)!==null?(J=s.get(M))==null||J.push(j.id):s.set(M,[j.id])})}):((E=this.knowledgeGraph.dataModel.entityTypes)==null||E.forEach(y=>{y.name&&s.set(y.name,null)}),(R=this.knowledgeGraph.dataModel.entityTypes)==null||R.forEach(y=>{y.name&&s.set(y.name,null)}));for(const[y,M]of s){const j=new Set(M),J=new Promise((Y,le)=>{(async()=>{var ie,T,b,$,L,N,I,S,w;const G=new Set,z=[];let X,P="",ee=!1;if(e||((T=(ie=p.get(y))==null?void 0:ie.properties)==null||T.forEach(m=>{m.name&&G.add(m.name)})),n&&this.geographicLookup.has(y)){const m=(b=this.geographicLookup.get(y))==null?void 0:b.name;m&&G.add(m)}if(this.entityTypeNames.has(y))P=`MATCH (n:${y}) ${M?"WHERE id(n) IN $ids ":""}return ID(n)`,G.forEach(m=>{P+=`, n.${m}`,z.push(m)});else{if(!this.relationshipTypeNames.has(y))throw new me("knowledge-graph:layer-data-manager",`The graph type of ${y} could not be determined. Was this type set in the KG data model and inclusion definition?`);ee=!0,P=`MATCH ()-[n:${y}]->() ${M?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,G.forEach(m=>{P+=`, n.${m}`,z.push(m)})}X=new B(M?{openCypherQuery:P,bindParameters:{ids:M}}:{openCypherQuery:P});const de=(await ne(this.knowledgeGraph,X,{signal:r==null?void 0:r.signal})).resultRowsStream.getReader();for(;;){const{done:m,value:H}=await de.read();if(m)break;const _=[];for(let A=0;A<H.length;A++){const W=H[A];let C=0,ye=0;const k={properties:{}};for(k.id=W[C],C++,ye++,ee&&(k.originId=W[C],C++,ye++,k.destinationId=W[C],C++,ye++,U(this.nodeConnectionsLookup,k.originId,()=>new Set).add(k.id),U(this.nodeConnectionsLookup,k.destinationId,()=>new Set).add(k.id),U(this.relationshipConnectionsLookup,k.id,()=>[k.originId,k.destinationId]));C<W.length;C++)k.properties[z[C-ye]]=W[C];j.delete(k.id),_.push(k)}const Ge=o.writeToStore(_,F,($=this.geographicLookup.get(y))==null?void 0:$.name);this.sublayerCaches.has(y)||this.sublayerCaches.set(y,new Map),i&&!((L=this.inclusionModeDefinition)!=null&&L.namedTypeDefinitions.has(y))&&((N=this.inclusionModeDefinition)==null||N.namedTypeDefinitions.set(y,{useAllData:!1,members:new Map})),i&&!((I=this.inclusionModeDefinition)!=null&&I.namedTypeDefinitions.get(y).members)&&(this.inclusionModeDefinition.namedTypeDefinitions.get(y).members=new Map);const we=this.sublayerCaches.get(y);Ge.forEach(A=>{var W,C;we==null||we.set(A.attributes[F],A),i&&!((W=this.inclusionModeDefinition)!=null&&W.namedTypeDefinitions.get(y).members.has(A.attributes[F]))&&((C=this.inclusionModeDefinition)==null||C.namedTypeDefinitions.get(y).members.set(A.attributes[F],{id:A.attributes[F]}),U(this.memberIdTypeLookup,A.attributes[F],()=>new Set).add(y))})}const te=(S=this.inclusionModeDefinition)==null?void 0:S.namedTypeDefinitions.get(y);if(te)for(const m of j)(w=te.members)==null||w.delete(m)})().then(()=>{Y(null)}).catch(G=>{G.name==="AbortError"?Y(null):le(G)})});a.push(J),(v=this._processingCacheUpdatesLookup.get(y))==null||v.push(J)}if(await Promise.all(a),(Z=r==null?void 0:r.signal)==null?void 0:Z.aborted)throw Qe()}removeFromLayer(t){var i,r,o;const e=new Set,n=new Set(t.map(a=>a.id));for(const a of t)e.add(a.typeName),((i=this.memberIdTypeLookup.get(a.id))==null?void 0:i.size)===1?this.memberIdTypeLookup.delete(a.id):(r=this.memberIdTypeLookup.get(a.id))==null||r.delete(a.typeName),(o=this.inclusionModeDefinition)==null||o.namedTypeDefinitions.forEach((s,p)=>{var f;p===a.typeName&&((f=s.members)!=null&&f.has(a.id))&&s.members.delete(a.id)});e.forEach(a=>{var s;(s=this.sublayerCaches.get(a))==null||s.forEach((p,f)=>{var g;n.has(f)&&((g=this.sublayerCaches.get(a))==null||g.delete(f))})})}async retrieveDataFromService(t,e,n){var R,v,Z,y,M,j,J,Y,le,be,G,z,X,P,ee,de,te,ie;const i=Q.getInstance(),r=new Set,o=[];let a,s="",p=[];const f=e.graphType==="relationship",g=(Z=(v=(R=this.inclusionModeDefinition)==null?void 0:R.namedTypeDefinitions)==null?void 0:v.get(e.objectType.name))==null?void 0:Z.useAllData,c=e.parentCompositeLayer.sublayerIdsCache.get(e.objectType.name);let u=!g&&c?Array.from(c).sort():null;if((j=(M=(y=this.inclusionModeDefinition)==null?void 0:y.namedTypeDefinitions)==null?void 0:M.get(e.objectType.name))!=null&&j.useAllData)(le=(Y=(J=this.inclusionModeDefinition)==null?void 0:J.namedTypeDefinitions)==null?void 0:Y.get(e.objectType.name))!=null&&le.useAllData&&t.objectIds!=null&&(u=t.objectIds);else if(t.objectIds!=null&&u&&u.length>0){const T=t.objectIds;t.objectIds=u.filter(b=>T.includes(b))}else if(t.objectIds!=null)u=t.objectIds;else{if((be=this.inclusionModeDefinition)!=null&&be.namedTypeDefinitions.has(e.objectType.name)&&(!((G=this.inclusionModeDefinition.namedTypeDefinitions.get(e.objectType.name))!=null&&G.members)||((X=(z=this.inclusionModeDefinition.namedTypeDefinitions.get(e.objectType.name))==null?void 0:z.members)==null?void 0:X.size)<1))return t.objectIds=[],[];t.objectIds=u}if(t.outFields!=null){const T=t.outFields;T.includes("*")?e.fields.forEach(b=>{r.add(b.name)}):T.forEach(b=>{b!==F&&b!==e.geometryFieldName&&r.add(b)})}if(t.geometry!=null){const T=t.geometry;let b;const $=e.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,L=$==null?void 0:$.spatialReference,N=(P=$==null?void 0:$.serviceCapabilities)==null?void 0:P.geometryCapabilities;let I=N==null?void 0:N.geometryMaxBoundingRectangleSizeX,S=N==null?void 0:N.geometryMaxBoundingRectangleSizeY;if(T.type==="point"){let w=T;(ee=w.spatialReference)!=null&&ee.isWGS84||(await Te(w.spatialReference,q),w=ce(w,q)),b=new ue({spatialReference:q,xmin:w.x-1e-4,ymin:w.y-1e-4,xmax:w.x+1e-4,ymax:w.y+1e-4})}else(de=T==null?void 0:T.extent)!=null&&de.spatialReference&&!((te=T.spatialReference)!=null&&te.isWGS84)?(await Te(T.extent.spatialReference,q),b=ce(T.extent,q)):b=T.extent;if(I&&S&&L){if(L.wkid!==4326){const w=new ue({spatialReference:L,xmax:I,ymax:S}),m=ce(w,q);I=m.xmax,S=m.ymax}if(b.xmax-b.xmin>I)throw new me("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${I}° latitude, limit exceeded`);if(b.ymax-b.ymin>S)throw new me("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${S}° longitude, limit exceeded`)}if(t.where!=null&&t.where!=="1=1"){const w=await Se(t.where.toUpperCase(),e.fieldsIndex);e.fields.forEach(m=>{w.fieldNames.includes(m.name)&&r.add(m.name)})}s=f?`Match ()-[n:${e.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${e.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${e.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${e.geometryFieldName}) return ID(n)`,e.geometryFieldName&&r.add(e.geometryFieldName),r.forEach(w=>{s+=`, n.${w}`,o.push(w)}),a=new B({openCypherQuery:s,bindParameters:{param_filter_geom:new _e({rings:Ke(b)})}})}else{let T="";if(t.where!=null&&t.where!=="1=1"){const L=await Se(t.where,e.fieldsIndex);e.fields.forEach(m=>{L.fieldNames.includes(m.name)&&r.add(m.name)});const N=new Set(["column-reference","string","number","binary-expression"]),I=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let S=!1;const w=m=>{if(m.type==="column-reference")return`n.${m.column}`;if(m.type==="string")return`'${m.value}'`;if(m.type==="number")return`${m.value}`;if(m.type==="binary-expression"&&N.has(m.left.type)&&N.has(m.right.type)&&I.has(m.operator))return`${w(m.left)} ${m.operator} ${w(m.right)}`;if(m.type==="binary-expression"&&m.operator==="LIKE"){let H="";if(m.left.type==="function"&&m.left.args.value[0].type==="column-reference")H+=`lower(n.${m.left.args.value[0].column})`;else{if(m.left.type!=="column-reference")return S=!0,"";H+=`lower(n.${m.left.column})`}if(H+=" CONTAINS (",m.right.type!=="string")return S=!0,"";{let _=m.right.value;_.charAt(0)==="%"&&(_=_.slice(1)),_.charAt(_.length-1)==="%"&&(_=_.slice(0,-1)),H+=`'${_.toLowerCase()}')`}return H}return S=!0,""};T=w(L.parseTree),S&&(T="")}let b="";b=f?`Match ()-[n:${e.objectType.name}]->()`:`Match (n:${e.objectType.name})`;let $=!1;u&&($=!0,b+=" WHERE ID(n) IN $ids"),T&&(b+=$?" AND":" WHERE",b+=` ${T}`),b+=" return ID(n)",f&&(b+=", id(startNode(n)), id(endNode(n))"),t.returnGeometry&&e.geometryFieldName&&r.add(e.geometryFieldName),r.forEach(L=>{b+=`, n.${L}`,o.push(L)}),a=new B(u?{openCypherQuery:b,bindParameters:{ids:u}}:{openCypherQuery:b})}const E=(await ne(e.parentCompositeLayer.dataManager.knowledgeGraph,a,n)).resultRowsStream.getReader();for(;;){const{done:T,value:b}=await E.read();if(T)break;const $=[];for(let L=0;L<b.length;L++){const N=b[L];let I=0,S=0;const w={properties:{}};for(w.id=N[I],I++,S++,f&&(w.originId=N[I],I++,S++,w.destinationId=N[I],I++,S++);I<N.length;I++)w.properties[o[I-S]]=N[I];$.push(w)}p=p.concat(i.writeToStore($,F,(ie=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name))==null?void 0:ie.name))}return p}_isEndEntitySpatial(t,e,n){var i;for(const r of t??[])if(this.entityTypeNames.has(r)){const o=this.geographicLookup.get(r),a=o&&((i=this.sublayerCaches.get(r))==null?void 0:i.get(e.attributes[n]));if(o&&(a!=null&&a.attributes[o.name]))return!0}return!1}_getNamedTypeIdMapFromNodeIds(t){const e=new Map;return t.forEach(n=>{var i;if(this.memberIdTypeLookup.has(n))for(const r of this.memberIdTypeLookup.get(n)){if(!this.entityTypeNames.has(r))return;e.has(r)?(i=e.get(r))==null||i.push(n):e.set(r,[n])}}),e}};l([d()],O.prototype,"knowledgeGraph",void 0),l([d()],O.prototype,"inclusionModeDefinition",void 0),l([d()],O.prototype,"entityTypeNames",void 0),l([d()],O.prototype,"relationshipTypeNames",void 0),l([d()],O.prototype,"geographicLookup",void 0),l([d()],O.prototype,"sublayerCaches",void 0),l([d()],O.prototype,"nodeConnectionsLookup",void 0),l([d()],O.prototype,"relationshipConnectionsLookup",void 0),l([d()],O.prototype,"memberIdTypeLookup",void 0),O=l([Ee("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],O);const De=at(),Rt=t=>{let e=class extends t{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return l([d(De.fields)],e.prototype,"fields",void 0),l([d(De.fieldsIndex)],e.prototype,"fieldsIndex",void 0),e=l([Ee("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],e),e},_t={initializeLayersFromClientData:async(t,e,n)=>{if(e||(e=[...t.layers,...t.tables].map(o=>o.graphTypeName)),(e==null?void 0:e.length)===0)return;const i=new Map;for(const o of e)i.set(o,xe(t,o));const r=await Ve(t.dataManager.knowledgeGraph,Array.from(i.values()),{requestOptions:{signal:n==null?void 0:n.signal}});for(const o of[...t.layers,...t.tables]){const a=o.objectType.name;if(a==null)continue;const s=r.get(xe(t,a));if(s){const p=JSON.parse(s);p===null||typeof p!="object"||p.hasOwnProperty("showLabels")||(p.showLabels=!1),o.read(p,{origin:"service"})}}}},xe=(t,e)=>t.type==="knowledge-graph"?`${e}/Map`:`${e}/LinkChart/LinkChartSubLayer`;async function ji(t,e,n){return _t.initializeLayersFromClientData(t,e,n)}const ve=["#4a0932","#b31515","#18382e","#a64f1b","#102432","#8c213f","#ed9310","#2c6954","#144d59","#ffc730","#75351e","#454f4b","#78b1c2","#191921","#8f8f82","#9be0c0","#dbb658","#87b051","#11495c","#c43541","#9c5596","#44498b","#ad9d63","#86afb3","#5c98ca","#b0bfa2","#73241f","#b86b53","#d9d78c","#3e756d","#f260a1","#a0d17d","#c27c30","#eb82eb","#ffdf3c","#ffb259","#ab52b3","#3cccb4","#0095ba","#d92b30"],Ot="#8f8f82";function Ft(t){return t<0||t>=ve.length?new $e(Ot):new $e(ve[t])}function Gt(t){const e=t.toArray();return new Ze({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,style:"solid",width:.75,color:e},{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:e}]}}]}]}}})}function At(t){let e="ESRI__ID",n=4;for(const i of t)if(i.name){if(i.name.toLowerCase()==="name"){e=i.name;break}i.name.toLowerCase().includes("name")?(e=i.name,n=2):i.fieldType==="esriFieldTypeString"&&n>3&&(e=i.name,n=3)}return e}function Qt(t,e,n){const i={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:"normal"}},r=new V({labelExpressionInfo:new se({expression:n==="ESRI__ID"?`${e}`:`$feature.${n}`}),labelPlacement:"above-center",symbol:new pe(i)}),o=new V({labelExpressionInfo:new se({expression:`'${e}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:"center-along",labelPosition:"parallel",repeatLabel:!1,symbol:new pe({...i,yoffset:"12px"})});return t==="entity"?[r]:[o]}function Pt(t,e,n){const i={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:"bold"}},r=n==="ESRI__ID"?`${t}`:`$feature.${n}`;return e==="point"?[new V({labelExpressionInfo:new se({expression:r}),labelPlacement:"above-center",symbol:new pe(i)})]:e==="polyline"?[new V({labelExpressionInfo:new se({expression:r}),labelPlacement:"center-along",repeatLabel:!0,symbol:new pe(i)})]:e==="polygon"?[new V({labelExpressionInfo:new se({expression:r}),labelPlacement:"always-horizontal",symbol:new pe(i)})]:null}function x(t){if(!t.json)return t;t.json.write=je(t.json.write);const e=t.json.origins;if(!e)return t;let n;for(n in e){const i=e[n];i&&(i.write=je(i.write))}return t}function je(t){return typeof t=="object"&&t?(t.enabled!==!1&&(t.overridePolicy=Jt(t)),t):t===!0?re():t}function Jt(t){const{target:e,writer:n,overridePolicy:i,...r}=t;return function(o,a){const s=Oe.call(this,o,a);return s.enabled?{...r,...s}:s}}function re(){return{overridePolicy:Oe}}function Oe(t,e){const n=!!this.geometryType;let i={enabled:n};return n&&(i={...i,...Fe.call(this,t,e)}),i}function Fe(t,e){return{ignoreOrigin:this.originIdOf(e)>Pe.DEFAULTS}}let h=class extends Rt(mt(gt(ut(pt(wt(Et(lt(It(Xe(it)))))))))){constructor(t){super(t),this.blendMode="normal",this.capabilities=rt(!1,!1),this.charts=null,this.definitionExpression=null,this.displayField="",this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=F,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const e=new MessageChannel;return new et(e.port1,{channel:e,client:{queryFeatures:(n,i={})=>{const r=K.fromJSON(n);return this.queryFeaturesJSON(r,i)}}}),[e.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(t){const e=this._normalizeFeatureReduction(t);this._set("featureReduction",e)}get fields(){var e,n;const t=[];return(n=(e=this.objectType)==null?void 0:e.properties)==null||n.forEach(i=>{const r=i.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":i.fieldType;t.push(he.fromJSON({name:i.name,type:r,alias:i.alias,defaultValue:i.defaultValue,editable:i.editable,nullable:i.nullable}))}),t.push(he.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),he.fromJSON({name:Ie,type:"esriFieldTypeInteger",alias:Ie,editable:!1}),he.fromJSON({name:ae,type:"esriFieldTypeInteger",alias:ae,editable:!1})),t}get geometryType(){var n,i,r;if(((n=this.parentCompositeLayer)==null?void 0:n.type)==="link-chart")return this.graphType==="relationship"?"polyline":"point";const t=(r=this.parentCompositeLayer)==null?void 0:r.dataManager.geographicLookup.get((i=this.objectType)==null?void 0:i.name),e=t==null?void 0:t.geometryType;return e&&e!=="esriGeometryNull"?oe.fromJSON(e):null}get geometryFieldName(){var e,n,i;if(((e=this.parentCompositeLayer)==null?void 0:e.type)==="link-chart")return Ne;const t=(i=this.parentCompositeLayer)==null?void 0:i.dataManager.geographicLookup.get((n=this.objectType)==null?void 0:n.name);return(t==null?void 0:t.name)??null}get graphTypeName(){var t;return(t=this.objectType)==null?void 0:t.name}get hasM(){var i,r,o,a;const t=(r=this.parentCompositeLayer)==null?void 0:r.dataManager.geographicLookup.get((i=this.objectType)==null?void 0:i.name),e=t==null?void 0:t.name,n=e?(a=(o=this.objectType)==null?void 0:o.properties)==null?void 0:a[e]:null;return(n==null?void 0:n.hasM)??!1}get hasZ(){var i,r,o,a;const t=(r=this.parentCompositeLayer)==null?void 0:r.dataManager.geographicLookup.get((i=this.objectType)==null?void 0:i.name),e=t==null?void 0:t.name,n=e?(a=(o=this.objectType)==null?void 0:o.properties)==null?void 0:a[e]:null;return(n==null?void 0:n.hasZ)??!1}set labelingInfo(t){this._set("labelingInfo",t)}get labelingInfo(){if(this._isOverridden("labelingInfo"))return this._get("labelingInfo");const t=this.objectType.properties?At(this.objectType.properties):"ESRI__ID";return this.parentCompositeLayer.type==="link-chart"?Qt(this.graphType,this.graphTypeName,t):Pt(this.graphTypeName,this.geometryType,t)}set renderer(t){Je(t,this.fieldsIndex),this._set("renderer",t)}get renderer(){var r,o,a,s;if(this._isOverridden("renderer"))return this._get("renderer");const t=(a=(o=(r=this.parentCompositeLayer)==null?void 0:r.dataManager)==null?void 0:o.knowledgeGraph)==null?void 0:a.dataModel,e=[...(t==null?void 0:t.entityTypes)??[],...(t==null?void 0:t.relationshipTypes)??[]].map(p=>p.name).indexOf(this.graphTypeName),n=Ft(e);if(((s=this.parentCompositeLayer)==null?void 0:s.type)==="link-chart"){if(this.graphType==="relationship")return new Dt({type:"simple",symbol:Gt(n)});const p=Ce(Le(oe.toJSON("point")).renderer);return ke(p.symbol,n),p}const i=Ce(Le(oe.toJSON(this.geometryType)).renderer);return ke(i.symbol,n),i}get spatialReference(){var t,e,n,i;return((i=(n=(e=(t=this.parentCompositeLayer)==null?void 0:t.dataManager)==null?void 0:e.knowledgeGraph)==null?void 0:n.dataModel)==null?void 0:i.spatialReference)??qe.WGS84}set timeInfo(t){this._set("timeInfo",t)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(t){this._set("title",t)}writeTitle(t,e){e.title=t??"Layer"}createPopupTemplate(t){return jt(this,t)}createQuery(){return new K({where:"1=1",outFields:["*"]})}getField(t){return this.fieldsIndex.get(t)}getFieldDomain(t,e){return null}async queryFeatures(t,e){await this.load();const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(t),r=vt.fromJSON(await i.executeQuery(n.toJSON(),e==null?void 0:e.signal));return r.features.forEach(o=>{o.sourceLayer=this}),r}async queryFeaturesJSON(t,e){await this.load();const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(t);return await i.executeQuery(n.toJSON(),e==null?void 0:e.signal)}async queryFeatureCount(t,e){await this.load();const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(t);return i.executeQueryForCount(n.toJSON(),e==null?void 0:e.signal)}async queryExtent(t={},e){var s,p,f,g;await this.load();const n={...t,returnGeometry:!0},{resolvedQuery:i,queryEngine:r}=await this._setupQueryObjects(n),o=await r.executeQueryForExtent(i.toJSON(),e==null?void 0:e.signal);let a;return a=((s=o.extent)==null?void 0:s.xmin)!=null&&((p=o.extent)==null?void 0:p.xmax)!=null&&((f=o.extent)==null?void 0:f.ymin)!=null&&((g=o.extent)==null?void 0:g.ymax)!=null?new ue(o.extent):new ue,{count:o.count,extent:a}}async queryObjectIds(t,e){await this.load();const n=K.from(t);let i;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const r=await this.parentCompositeLayer.dataManager.getData(n,this,e);i=this.loadQueryEngine(r)}return await i.executeQueryForIds(n.toJSON(),e==null?void 0:e.signal)}loadQueryEngine(t){var i;const e=new nt({geometryType:oe.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),n=new ot({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:oe.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:(i=this.timeInfo)==null?void 0:i.toJSON(),featureStore:e});return n.featureStore.addMany(t),n}async refreshCachedQueryEngine(){const t=await this.parentCompositeLayer.dataManager.getData(new K({where:"1=1",outFields:[F]}),this);this._cachedQueryEngine=this.loadQueryEngine(t)}load(t){return this.addResolvingPromise(this.parent.load(t).then(()=>He(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(t,e){var o;const n=K.from(t),i=n.geometry;if(i&&!((o=i.spatialReference)!=null&&o.isWGS84)&&(await Te(i.spatialReference,q),n.geometry=ce(i instanceof _e||i instanceof We||i instanceof Ue?i:i.extent,q)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)return{resolvedQuery:n,queryEngine:this._cachedQueryEngine};const r=await this.parentCompositeLayer.dataManager.getData(n,this,e);return{resolvedQuery:n,queryEngine:this.loadQueryEngine(r)}}};l([d(x(D(dt)))],h.prototype,"blendMode",void 0),l([d()],h.prototype,"capabilities",void 0),l([d({json:{origins:{"web-scene":{write:!1}},write:re()}})],h.prototype,"charts",void 0),l([d({readOnly:!0})],h.prototype,"defaultPopupTemplate",null),l([d({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],h.prototype,"definitionExpression",void 0),l([d()],h.prototype,"displayField",void 0),l([d(x(D(ht)))],h.prototype,"displayFilterEnabled",void 0),l([d(x(D(ct)))],h.prototype,"displayFilterInfo",void 0),l([d(x(D(yt)))],h.prototype,"effect",void 0),l([d()],h.prototype,"elevationInfo",void 0),l([d(x(D(ft)))],h.prototype,"featureEffect",void 0),l([d(x(D(bt)))],h.prototype,"featureReduction",null),l([d()],h.prototype,"fields",null),l([d()],h.prototype,"geometryType",null),l([d()],h.prototype,"geometryFieldName",null),l([d({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],h.prototype,"graphType",void 0),l([d({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],h.prototype,"graphTypeName",null),l([d()],h.prototype,"hasM",null),l([d()],h.prototype,"hasZ",null),l([d({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],h.prototype,"id",void 0),l([d({type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],h.prototype,"labelsVisible",void 0),l([d({type:[V],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:Ht,write:re()}})],h.prototype,"labelingInfo",null),l([d({readOnly:!0,json:{read:!1,write:{writer(t,e){var n;switch((n=this.parentCompositeLayer)==null?void 0:n.type){case"link-chart":e.layerType="LinkChartSubLayer";break;case"knowledge-graph":e.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],h.prototype,"layerType",void 0),l([d(x(D(St)))],h.prototype,"legendEnabled",void 0),l([d(x(D(Mt)))],h.prototype,"maxScale",void 0),l([d(x(D(Lt)))],h.prototype,"minScale",void 0),l([d()],h.prototype,"objectIdField",void 0),l([d()],h.prototype,"objectType",void 0),l([d(x(D($t)))],h.prototype,"opacity",void 0),l([d(x(D(Tt)))],h.prototype,"orderBy",void 0),l([d({clonable:!1})],h.prototype,"parent",void 0),l([d()],h.prototype,"parentCompositeLayer",void 0),l([d(x(D(Ct)))],h.prototype,"popupEnabled",void 0),l([d({type:Ye,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],h.prototype,"popupTemplate",void 0),l([d({type:Number,json:{write:{overridePolicy:Fe}}})],h.prototype,"refreshInterval",void 0),l([d({types:xt,json:{name:"layerDefinition.drawingInfo.renderer",write:re()}})],h.prototype,"renderer",null),l([d()],h.prototype,"source",void 0),l([d()],h.prototype,"spatialReference",null),l([d({type:kt,json:{name:"layerDefinition.timeInfo",write:!0,origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:!0},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:!0}}}})],h.prototype,"timeInfo",null),l([d({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],h.prototype,"title",null),l([tt("title")],h.prototype,"writeTitle",null),l([d({json:{read:!1}})],h.prototype,"type",void 0),l([d(x(D(Nt)))],h.prototype,"useViewTime",void 0),l([d({type:Boolean,json:{name:"visibility",write:re()}})],h.prototype,"visible",void 0),h=l([Ee("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],h);const Ri=h;function Ht(t,e,n){var r,o;const i=[["ESRI__AGGREGATION_COUNT",Ie],["ESRI__ORIGIN_ID",fe],["ESRI__DESTINATION_ID",ge],["ESRI__LAYOUT_GEOMETRY",Ne]];try{for(const a of t)for(const[s,p]of i)a.labelExpression=(r=a.labelExpression)==null?void 0:r.replaceAll(s,p),(o=a.labelExpressionInfo)!=null&&o.expression&&(a.labelExpressionInfo.expression=a.labelExpressionInfo.expression.replaceAll(s,p))}catch(a){Re.getLogger(this).warn("Error updating labelingInfo",a)}return st(t,e,n)}export{O as E,Ri as S,ji as i,Q as o};
