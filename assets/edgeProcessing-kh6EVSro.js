import{e as me}from"./deduplicate-DxTSMkFY.js";import{H as F}from"./InterleavedLayout-UIhsB8jd.js";import{e as c}from"./VertexAttribute-BnAa5VW0.js";import{t as Z}from"./glUtil-C6KhMg1m.js";import{ac as Ie}from"./subclass-BR3PhgZG.js";import{c as Oe,z as ue,n as w,x as Se,d as k,r as oe,P as K,m as Ae,J as Ee,_ as pe,f as re,h as de}from"./mathUtils-ClvKsMak.js";import{s as J}from"./Normals-D1LdtP06.js";import{l as ee}from"./Accessor-D6mNnsWy.js";const we=F().vec3f(c.POSITION).u16(c.COMPONENTINDEX).freeze(),Te=F().vec2u8(c.SIDENESS).freeze(),je=Z(Te),j=F().vec3f(c.POSITION0).vec3f(c.POSITION1).vec2i16(c.NORMALCOMPRESSED).u16(c.COMPONENTINDEX).u8(c.VARIANTOFFSET,{glNormalized:!0}).u8(c.VARIANTSTROKE).u8(c.VARIANTEXTENSION,{glNormalized:!0}).freeze(),G=F().vec3f(c.POSITION0).vec3f(c.POSITION1).vec2i16(c.NORMALCOMPRESSED).vec2i16(c.NORMAL2COMPRESSED).u16(c.COMPONENTINDEX).u8(c.VARIANTOFFSET,{glNormalized:!0}).u8(c.VARIANTSTROKE).u8(c.VARIANTEXTENSION,{glNormalized:!0}).freeze(),Ge=new Map([[c.POSITION0,0],[c.POSITION1,1],[c.COMPONENTINDEX,2],[c.VARIANTOFFSET,3],[c.VARIANTSTROKE,4],[c.VARIANTEXTENSION,5],[c.NORMALCOMPRESSED,6],[c.NORMAL2COMPRESSED,7],[c.SIDENESS,8]]);function ae(e,n,s){const r=n/3,i=new Uint32Array(s+1),u=new Uint32Array(s+1),g=(t,o)=>{t<o?i[t+1]++:u[o+1]++};for(let t=0;t<r;t++){const o=e[3*t],f=e[3*t+1],l=e[3*t+2];g(o,f),g(f,l),g(l,o)}let h=0,S=0;for(let t=0;t<s;t++){const o=i[t+1],f=u[t+1];i[t+1]=h,u[t+1]=S,h+=o,S+=f}const a=new Uint32Array(6*r),p=i[s],I=(t,o,f)=>{if(t<o){const l=i[t+1]++;a[2*l]=o,a[2*l+1]=f}else{const l=u[o+1]++;a[2*p+2*l]=t,a[2*p+2*l+1]=f}};for(let t=0;t<r;t++){const o=e[3*t],f=e[3*t+1],l=e[3*t+2];I(o,f,t),I(f,l,t),I(l,o,t)}const A=(t,o)=>{const f=2*t,l=o-t;for(let O=1;O<l;O++){const $=a[f+2*O],y=a[f+2*O+1];let d=O-1;for(;d>=0&&a[f+2*d]>$;d--)a[f+2*d+2]=a[f+2*d],a[f+2*d+3]=a[f+2*d+1];a[f+2*d+2]=$,a[f+2*d+3]=y}};for(let t=0;t<s;t++)A(i[t],i[t+1]),A(p+u[t],p+u[t+1]);const R=new Int32Array(3*r),z=(t,o)=>t===e[3*o]?0:t===e[3*o+1]?1:t===e[3*o+2]?2:-1,T=(t,o)=>{const f=z(t,o);R[3*o+f]=-1},B=(t,o,f,l)=>{const O=z(t,o);R[3*o+O]=l;const $=z(f,l);R[3*l+$]=o};for(let t=0;t<s;t++){let o=i[t];const f=i[t+1];let l=u[t];const O=u[t+1];for(;o<f&&l<O;){const $=a[2*o],y=a[2*p+2*l];$===y?(B(t,a[2*o+1],y,a[2*p+2*l+1]),o++,l++):$<y?(T(t,a[2*o+1]),o++):(T(y,a[2*p+2*l+1]),l++)}for(;o<f;)T(t,a[2*o+1]),o++;for(;l<O;)T(a[2*p+2*l],a[2*p+2*l+1]),l++}return R}const q=.7;let ge=class{updateSettings(n){this.settings=n,this._edgeHashFunction=n.reducedPrecision?ve:$e}write(n,s,r){b.seed=this._edgeHashFunction(r);const i=b.getIntRange(0,255),u=b.getIntRange(0,this.settings.variants-1),g=b.getFloat(),h=255*(.5*ye(-(1-Math.min(g/q,1))+Math.max(0,g-q)/(1-q),1.2)+.5);n.position0.setVec(s,r.position0),n.position1.setVec(s,r.position1),n.componentIndex.set(s,r.componentIndex),n.variantOffset.set(s,i),n.variantStroke.set(s,u),n.variantExtension.set(s,h)}};const P=new Float32Array(6),M=new Uint32Array(P.buffer),C=new Uint32Array(1);function $e(e){return P[0]=e.position0[0],P[1]=e.position0[1],P[2]=e.position0[2],P[3]=e.position1[0],P[4]=e.position1[1],P[5]=e.position1[2],C[0]=31*(31*(31*(31*(31*(166811+M[0])+M[1])+M[2])+M[3])+M[4])+M[5],C[0]}function ve(e){const n=P;n[0]=D(e.position0[0]),n[1]=D(e.position0[1]),n[2]=D(e.position0[2]),n[3]=D(e.position1[0]),n[4]=D(e.position1[1]),n[5]=D(e.position1[2]),C[0]=5381;for(let s=0;s<M.length;s++)C[0]=31*C[0]+M[s];return C[0]}const ie=1e4;function D(e){return Math.round(e*ie)/ie}function ye(e,n){return Math.abs(e)**n*Math.sign(e)}let Q=class{constructor(){this._commonWriter=new ge}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return j.createBuffer(n)}write(n,s,r){this._commonWriter.write(n,s,r),Oe(L,r.faceNormal0,r.faceNormal1),ue(L,L);const{typedBuffer:i,typedBufferStride:u}=n.normalCompressed;J(i,s,L[0],L[1],L[2],u)}};Q.Layout=j,Q.glLayout=Z(j,1);let Y=class{constructor(){this._commonWriter=new ge}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return G.createBuffer(n)}write(n,s,r){this._commonWriter.write(n,s,r);{const{typedBuffer:i,typedBufferStride:u}=n.normalCompressed;J(i,s,r.faceNormal0[0],r.faceNormal0[1],r.faceNormal0[2],u)}{const{typedBuffer:i,typedBufferStride:u}=n.normal2Compressed;J(i,s,r.faceNormal1[0],r.faceNormal1[1],r.faceNormal1[2],u)}}};Y.Layout=G,Y.glLayout=Z(G,1);const L=w(),b=new Ie;class Pe{constructor(){this.position0=w(),this.position1=w(),this.faceNormal0=w(),this.faceNormal1=w(),this.componentIndex=0,this.cosAngle=0}}const W=-1;function Me(e,n,s){const r=e.vertices.position,i=e.vertices.componentIndex,u=m.position0,g=m.position1,h=m.faceNormal0,S=m.faceNormal1,{edges:a,normals:p}=De(e),I=a.length/4,A=n.allocate(I);let R=0;const z=I,T=s==null?void 0:s.allocate(z);let B=0,t=0,o=0;_.length=0;for(let d=0;d<I;++d){const v=4*d;r.getVec(a.data[v],u),r.getVec(a.data[v+1],g);const x=_.pushNew();x.index=4*d,x.length=Se(u,g)}_.sort((d,v)=>v.length-d.length);const f=new Array,l=new Array;_.forAll(({length:d,index:v})=>{const x=a.data[v],Ne=a.data[v+1],te=a.data[v+2],ne=a.data[v+3],se=ne===W;if(r.getVec(x,u),r.getVec(Ne,g),se){const E=3*te;k(h,p.data[E],p.data[E+1],p.data[E+2]),oe(S,h),m.componentIndex=i.get(x),m.cosAngle=K(h,S)}else{let E=3*te;if(k(h,p.data[E],p.data[E+1],p.data[E+2]),E=3*ne,k(S,p.data[E],p.data[E+1],p.data[E+2]),m.componentIndex=i.get(x),m.cosAngle=K(h,S),Ve(m,Fe))return;m.cosAngle<-.9999&&oe(S,h)}t+=d,o++,se||Re(m,Be)?(n.write(A,R++,m),f.push(d)):xe(m,he)&&(T&&s&&s.write(T,B++,m),l.push(d))});const O=new Float32Array(f.reverse()),$=new Float32Array(l.reverse()),y=T&&s?{instancesData:T.slice(0,B),lodInfo:{lengths:$}}:void 0;return{regular:{instancesData:A.slice(0,R),lodInfo:{lengths:O}},silhouette:y,averageEdgeLength:t/o}}function Re(e,n){return e.cosAngle<n}function Ve(e,n){return e.cosAngle>n}function xe(e,n){const s=Ae(e.cosAngle);return Ee(ce,e.position1,e.position0),s*(K(pe(Ce,e.faceNormal0,e.faceNormal1),ce)>0?-1:1)>n}function De(e){const n=e.faces.length/3,s=e.faces,r=e.neighbors,i=e.vertices.position;N.length=H.length=0;for(let u=0;u<n;u++){const g=3*u,h=r[g],S=r[g+1],a=r[g+2],p=s[g],I=s[g+1],A=s[g+2];i.getVec(p,V),i.getVec(I,X),i.getVec(A,U),re(X,X,V),re(U,U,V),pe(V,X,U),ue(V,V),H.pushArray(V),(h===W||p<I)&&(N.push(p),N.push(I),N.push(u),N.push(h)),(S===W||I<A)&&(N.push(I),N.push(A),N.push(u),N.push(S)),(a===W||A<p)&&(N.push(A),N.push(p),N.push(u),N.push(a))}return{edges:N,normals:H}}class Le{constructor(){this.index=0,this.length=0}}const _=new ee({allocator:e=>e||new Le,deallocator:null}),N=new ee({deallocator:null}),H=new ee({deallocator:null}),m=new Pe,Ce=w(),ce=w(),V=w(),X=w(),U=w(),he=de(4),Fe=Math.cos(he),ze=de(35),Be=Math.cos(ze);function et(e){const n=be(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return le.updateSettings(e.writerSettings),fe.updateSettings(e.writerSettings),Me(n,le,fe)}function be(e,n,s,r){if(n){const g=ae(s,r,e.count);return new _e(s,r,g,e)}const i=me(e.buffer,e.stride/4,{originalIndices:s,originalIndicesLength:r}),u=ae(i.indices,r,i.uniqueCount);return{faces:i.indices,facesLength:i.indices.length,neighbors:u,vertices:we.createView(i.buffer)}}class _e{constructor(n,s,r,i){this.faces=n,this.facesLength=s,this.neighbors=r,this.vertices=i}}const le=new Q,fe=new Y,tt=F().vec3f(c.POSITION0).vec3f(c.POSITION1),nt=F().vec3f(c.POSITION0).vec3f(c.POSITION1).u16(c.COMPONENTINDEX);export{we as E,Te as I,Y as N,je as S,tt as d,et as f,nt as m,Me as p,Ge as r,be as u,Q as w};
