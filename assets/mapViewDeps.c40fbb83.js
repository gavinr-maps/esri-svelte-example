var Yi=Object.defineProperty,Qi=Object.defineProperties;var Zi=Object.getOwnPropertyDescriptors;var Ct=Object.getOwnPropertySymbols;var Ki=Object.prototype.hasOwnProperty,Ji=Object.prototype.propertyIsEnumerable;var Bt=(r,e,t)=>e in r?Yi(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,$=(r,e)=>{for(var t in e||(e={}))Ki.call(e,t)&&Bt(r,t,e[t]);if(Ct)for(var t of Ct(e))Ji.call(e,t)&&Bt(r,t,e[t]);return r},ue=(r,e)=>Qi(r,Zi(e));import{y as es,r as B,z as ts,v as $e,C as xe,A as is,B as ss,D as Rt,w as O,E as J,F as rs,m as Te,G as ns,H as Ot,I as as,q as D,J as ee,K as ne,L as os,M as ls,N as hs,O as st,P as te,Q as us,l as cs,T as ds,U as _s,V as ms,W as Pt,X as At,Y as ps,Z as fs,_ as gs,$ as ke,a0 as bs,a1 as vs,a2 as ws,a3 as ys,a4 as N,a5 as xs,a6 as Ts,a7 as me,a8 as Fs,a9 as M,aa as R,ab as pe,ac as Dt,ad as Es,ae as It,af as Ss,ag as Ms,ah as zt,ai as Le,aj as Ve,ak as Ne,al as Cs,am as Bs,an as Rs,ao as Os,ap as Ps,aq as rt,ar as As,as as Ds,at as Ut,au as Is,av as zs,u as Fe,aw as Us}from"./vendor.f5642644.js";import{j as $t,W as $s,O as Ge,t as kt,o as ks,n as Ls,r as Vs,s as Ns}from"./CIMSymbolHelper.e6d71723.js";import{n as Ee,f as ae,o as ie,l as A,e as Gs}from"./VertexArrayObject.e0a1a120.js";import{o as I,n as H,r as nt,u as Se,e as at}from"./Texture.36d56722.js";import{e as Ws,n as oe,t as Me}from"./ShaderCompiler.42257610.js";import{s as Lt,a as Hs}from"./Container.46e88f89.js";import{I as k,l as js,O as We,y as qs,f as Xs,o as Vt,s as Ys,m as He,p as Nt,c as Qs,u as Zs,a as Gt,d as Ks,E as je}from"./Utils.cc4850d4.js";import{s as L,r as fe,j as ge}from"./WGLContainer.96b23cd9.js";import{t as Wt}from"./ProgramCache.704c31bf.js";import{r as Ht,m as Js}from"./cimSymbolUtils.a172be06.js";import{Y as Ce,y as jt,u as qt,J as er,A as tr,B as ir,F as Xt,E as Be,T as sr,P as rr,Q as nr}from"./definitions.21e97413.js";import{t as G}from"./BidiEngine.aae60613.js";import{P as Yt}from"./GeometryUtils.ea8c8742.js";import{e as ot}from"./Matcher.19eb3b6e.js";import{s as ar}from"./CircularArray.90e6366a.js";import{o as Qt,g as or,a as lr,K as hr,t as Zt}from"./requestImageUtils.85ad21f4.js";import{t as ur}from"./FeatureSetReader.8549f04d.js";import{i as So}from"./BaseGraphicContainer.d8501c0a.js";import{i as Co}from"./GraphicContainer.fc280989.js";import"./GeometryUtils.d4e26b77.js";import"./config.2a39d8a4.js";import"./MaterialKey.4d0549e4.js";import"./pixelUtils.62a09b6b.js";import"./earcut.f20dd8d8.js";import"./quantizationUtils.0f09cc76.js";import"./devEnvironmentUtils.444b8fd1.js";import"./visualVariablesUtils.fd6dc537.js";import"./visualVariablesUtils.7662df5b.js";import"./tileUtils.c954798b.js";import"./TileClipper.9ec40b87.js";import"./centroid.b7b6726a.js";import"./projectionSupport.0d3c0291.js";import"./json.2d0d6862.js";import"./FeatureContainer.ea98f157.js";import"./TileContainer.03ef91ca.js";import"./schemaUtils.24d1146f.js";import"./MD5.f9440c6b.js";import"./util.a76d11a6.js";import"./ComputedAttributeStorage.cf3eba07.js";import"./vec3f32.9cc42d31.js";const cr=512;class dr{constructor(e){this._resourceManager=e}dispose(){this._rasterizationCanvas=null}rasterizeJSONResource(e,t,i){if(this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),e.type==="simple-fill"||e.type==="esriSFS"){const[c,m,p]=$t.rasterizeSimpleFill(this._rasterizationCanvas,e.style,t);return{size:[m,p],image:new Uint32Array(c.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0}}if(e.type==="simple-line"||e.type==="esriSLS"||e.type==="line"&&e.dashTemplate){let c,m;if(e.type==="simple-line"||e.type==="esriSLS")switch(c=$s(e.style,e.cap),e.cap){case"butt":m="Butt";break;case"square":m="Square";break;default:m="Round"}else c=e.dashTemplate,m=e.cim.capStyle;const[p,u,f]=$t.rasterizeSimpleLine(c,m);return{size:[u,f],image:new Uint32Array(p.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let s,n,a;if(e.type==="simple-marker"||e.type==="esriSMS"||e.type==="line-marker"?(s=Ge.fromSimpleMarker(e),a=Ht(s)):e.cim&&e.cim.type==="CIMHatchFill"?(s=Ge.fromCIMHatchFill(e.cim),n=new kt(s.frame.xmin,-s.frame.ymax,s.frame.xmax-s.frame.xmin,s.frame.ymax-s.frame.ymin)):e.cim.markerPlacement&&e.cim.markerPlacement.type==="CIMMarkerPlacementInsidePolygon"?(s=Ge.fromCIMInsidePolygon(e.cim),n=new kt(s.frame.xmin,-s.frame.ymax,s.frame.xmax-s.frame.xmin,s.frame.ymax-s.frame.ymin)):(s=e.cim,a=Ht(s)),a&&!i){const[c,m,p]=Js(a);return c?{size:[m,p],image:new Uint32Array(c.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}const[o,l,h,_,d]=Ge.rasterize(this._rasterizationCanvas,s,n,this._resourceManager,!i);return o?{size:[l,h],image:new Uint32Array(o.buffer),sdf:!1,simplePattern:!1,anchorX:_,anchorY:d}:null}rasterizeImageResource(e,t,i,s){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=t;const n=this._rasterizationCanvas.getContext("2d");i instanceof ImageData?n.putImageData(i,0,0):(i.setAttribute("width",`${e}px`),i.setAttribute("height",`${t}px`),n.drawImage(i,0,0,e,t));const a=n.getImageData(0,0,e,t),o=new Uint8Array(a.data);if(s){for(const m of s)if(m&&m.oldColor&&m.oldColor.length===4&&m.newColor&&m.newColor.length===4){const[p,u,f,w]=m.oldColor,[b,v,g,x]=m.newColor;if(p===b&&u===v&&f===g&&w===x)continue;for(let y=0;y<o.length;y+=4)p===o[y]&&u===o[y+1]&&f===o[y+2]&&w===o[y+3]&&(o[y]=b,o[y+1]=v,o[y+2]=g,o[y+3]=x)}}let l;for(let m=0;m<o.length;m+=4)l=o[m+3]/255,o[m]=o[m]*l,o[m+1]=o[m+1]*l,o[m+2]=o[m+2]*l;let h=o,_=e,d=t;const c=cr;if(_>=c||d>=c){const m=_/d;m>1?(_=c,d=Math.round(c/m)):(d=c,_=Math.round(c*m)),h=new Uint8Array(4*_*d);const p=new Uint8ClampedArray(h.buffer);es(o,e,t,p,_,d,!1)}return{size:[_,d],image:new Uint32Array(h.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}const _r={background:{"background.frag":`#ifdef PATTERN
uniform lowp float u_opacity;
uniform lowp sampler2D u_texture;
varying mediump vec4 v_tlbr;
varying mediump vec2 v_tileTextureCoord;
#else
uniform lowp vec4 u_color;
#endif
#ifdef ID
varying mediump vec4 v_id;
#endif
void main() {
#ifdef PATTERN
mediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);
mediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);
lowp vec4 color = texture2D(u_texture, samplePos);
gl_FragColor = u_opacity * color;
#else
gl_FragColor = u_color;
#endif
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"background.vert":`precision mediump float;
attribute vec2 a_pos;
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
uniform highp mat3 u_dvsMat3;
uniform mediump float u_coord_range;
uniform mediump float u_depth;
#ifdef PATTERN
uniform mediump mat3 u_pattern_matrix;
varying mediump vec2 v_tileTextureCoord;
uniform mediump vec4 u_tlbr;
uniform mediump vec2 u_mosaicSize;
varying mediump vec4 v_tlbr;
#endif
void main() {
gl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);
#ifdef PATTERN
v_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;
v_tlbr             = u_tlbr / u_mosaicSize.xyxy;
#endif
#ifdef ID
v_id = u_id / 255.0;
#endif
}`},circle:{"circle.frag":`precision lowp float;
varying lowp vec4 v_color;
varying lowp vec4 v_stroke_color;
varying mediump float v_blur;
varying mediump float v_stroke_width;
varying mediump float v_radius;
varying mediump vec2 v_offset;
#ifdef ID
varying mediump vec4 v_id;
#endif
void main()
{
mediump float dist = length(v_offset);
mediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);
lowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));
gl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"circle.vert":`precision mediump float;
attribute vec2 a_pos;
#pragma header
varying lowp vec4 v_color;
varying lowp vec4 v_stroke_color;
varying mediump float v_blur;
varying mediump float v_stroke_width;
varying mediump float v_radius;
varying mediump vec2 v_offset;
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform mediump vec2 u_circleTranslation;
uniform mediump float u_depth;
uniform mediump float u_antialiasingWidth;
void main()
{
#pragma main
v_color = color * opacity;
v_stroke_color = stroke_color * stroke_opacity;
v_stroke_width = stroke_width;
v_radius = radius;
v_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));
mediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);
v_offset = offset;
#ifdef ID
v_id = u_id / 255.0;
#endif
mediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth, 1.0);
}`},fill:{"fill.frag":`precision lowp float;
#ifdef PATTERN
uniform lowp sampler2D u_texture;
varying mediump vec2 v_tileTextureCoord;
varying mediump vec4 v_tlbr;
#endif
#ifdef ID
varying mediump vec4 v_id;
#endif
varying lowp vec4 v_color;
vec4 mixColors(vec4 color1, vec4 color2) {
float compositeAlpha = color2.a + color1.a * (1.0 - color2.a);
vec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);
return vec4(compositeColor, compositeAlpha);
}
void main()
{
#ifdef PATTERN
mediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);
mediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);
lowp vec4 color = texture2D(u_texture, samplePos);
gl_FragColor = v_color[3] * color;
#else
gl_FragColor = v_color;
#endif
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"fill.vert":`precision mediump float;
attribute vec2 a_pos;
#pragma header
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform mediump float u_depth;
uniform mediump vec2 u_fillTranslation;
#ifdef PATTERN
#include <util/util.glsl>
uniform mediump vec2 u_mosaicSize;
uniform mediump float u_patternFactor;
varying mediump vec2 v_tileTextureCoord;
varying mediump vec4 v_tlbr;
#endif
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
varying lowp vec4 v_color;
void main()
{
#pragma main
v_color = color * opacity;
#ifdef ID
v_id = u_id / 255.0;
#endif
#ifdef PATTERN
float patternWidth = nextPOT(tlbr.z - tlbr.x);
float patternHeight = nextPOT(tlbr.w - tlbr.y);
float scaleX = 1.0 / (patternWidth * u_patternFactor);
float scaleY = 1.0 / (patternHeight * u_patternFactor);
mat3 patterMat = mat3(scaleX, 0.0,    0.0,
0.0,    -scaleY, 0.0,
0.0,    0.0,    1.0);
v_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;
v_tlbr             = tlbr / u_mosaicSize.xyxy;
#endif
vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth, 1.0);
}`},icon:{"icon.frag":`precision mediump float;
uniform lowp sampler2D u_texture;
#ifdef SDF
uniform lowp vec4 u_color;
uniform lowp vec4 u_outlineColor;
#endif
varying mediump vec2 v_tex;
varying lowp float v_opacity;
varying mediump vec2 v_size;
varying lowp vec4 v_color;
#ifdef SDF
varying mediump flaot v_halo_width;
#endif
#ifdef ID
varying mediump vec4 v_id;
#endif
#include <util/encoding.glsl>
vec4 mixColors(vec4 color1, vec4 color2) {
float compositeAlpha = color2.a + color1.a * (1.0 - color2.a);
vec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);
return vec4(compositeColor, compositeAlpha);
}
void main()
{
#ifdef SDF
lowp vec4 fillPixelColor = v_color;
float d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;
const float softEdgeRatio = 0.248062016;
float size = max(v_size.x, v_size.y);
float dist = d * softEdgeRatio * size;
fillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);
if (v_halo_width > 0.25) {
lowp vec4 outlinePixelColor = u_outlineColor;
const float outlineLimitRatio = (16.0 / 86.0);
float clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));
outlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);
gl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);
}
else {
gl_FragColor = v_opacity * fillPixelColor;
}
#else
lowp vec4 texColor = texture2D(u_texture, v_tex);
gl_FragColor = v_opacity * texColor;
#endif
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"icon.vert":`attribute vec2 a_pos;
attribute vec2 a_vertexOffset;
attribute vec4 a_texAngleRange;
attribute vec4 a_levelInfo;
attribute float a_opacityInfo;
#pragma header
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
varying lowp vec4 v_color;
#ifdef SDF
varying mediump float v_halo_width;
#endif
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform highp mat3 u_displayViewMat3;
uniform mediump vec2 u_iconTranslation;
uniform vec2 u_mosaicSize;
uniform mediump float u_depth;
uniform mediump float u_mapRotation;
uniform mediump float u_level;
uniform lowp float u_keepUpright;
uniform mediump float u_fadeDuration;
varying mediump vec2 v_tex;
varying lowp float v_opacity;
varying mediump vec2 v_size;
const float C_OFFSET_PRECISION = 1.0 / 8.0;
const float C_256_TO_RAD = 3.14159265359 / 128.0;
const float C_DEG_TO_RAD = 3.14159265359 / 180.0;
const float tileCoordRatio = 1.0 / 8.0;
uniform highp float u_time;
void main()
{
#pragma main
v_color = color;
v_opacity = opacity;
#ifdef SDF
v_halo_width = halo_width;
#endif
float modded = mod(a_opacityInfo, 128.0);
float targetOpacity = (a_opacityInfo - modded) / 128.0;
float startOpacity = modded / 127.0;
float interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);
v_opacity *= interpolatedOpacity;
mediump float a_angle         = a_levelInfo[1];
mediump float a_minLevel      = a_levelInfo[2];
mediump float a_maxLevel      = a_levelInfo[3];
mediump vec2 a_tex            = a_texAngleRange.xy;
mediump float delta_z = 0.0;
mediump float rotated = mod(a_angle + u_mapRotation, 256.0);
delta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));
delta_z += 1.0 - step(a_minLevel, u_level);
delta_z += step(a_maxLevel, u_level);
delta_z += step(v_opacity, 0.0);
vec2 offset = C_OFFSET_PRECISION * a_vertexOffset;
v_size = abs(offset);
#ifdef SDF
offset = (120.0 / 86.0) * offset;
#endif
mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);
#ifdef ID
v_id = u_id / 255.0;
#endif
v_tex = a_tex.xy / u_mosaicSize;
}`},line:{"line.frag":`precision lowp float;
varying mediump vec2 v_normal;
varying highp float v_accumulatedDistance;
varying mediump float v_lineHalfWidth;
varying lowp vec4 v_color;
varying mediump float v_blur;
#if defined (PATTERN) || defined(SDF)
varying mediump vec4 v_tlbr;
varying mediump vec2 v_patternSize;
varying mediump float v_widthRatio;
uniform sampler2D u_texture;
uniform mediump float u_antialiasing;
#endif
#ifdef SDF
#include <util/encoding.glsl>
#endif
#ifdef ID
varying mediump vec4 v_id;
#endif
void main()
{
mediump float fragDist = length(v_normal) * v_lineHalfWidth;
lowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);
#ifdef PATTERN
mediump float relativeTexX = mod(v_accumulatedDistance / (v_patternSize.x * v_widthRatio), 1.0);
mediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);
mediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));
lowp vec4 color = texture2D(u_texture, texCoord);
gl_FragColor = alpha * v_color[3] * color;
#elif defined(SDF)
mediump float relativeTexX = mod((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio), 1.0);
mediump float relativeTexY =  0.5 + 0.25 * v_normal.y;
mediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));
mediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;
float dist = d * v_lineHalfWidth;
gl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;
#else
gl_FragColor = alpha * v_color;
#endif
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"line.vert":`precision mediump float;
attribute vec2 a_pos;
attribute vec4 a_extrude_offset;
attribute vec4 a_dir_normal;
attribute vec2 a_accumulatedDistance;
#pragma header
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform highp mat3 u_displayViewMat3;
uniform mediump float u_zoomFactor;
uniform mediump vec2 u_lineTranslation;
uniform mediump float u_antialiasing;
uniform mediump float u_depth;
varying mediump vec2 v_normal;
varying highp float v_accumulatedDistance;
const float scale = 1.0 / 31.0;
const mediump float tileCoordRatio = 8.0;
#if defined (SDF)
const mediump float sdfPatternHalfWidth = 15.5;
#endif
#if defined (PATTERN) || defined(SDF)
uniform mediump vec2 u_mosaicSize;
varying mediump vec4 v_tlbr;
varying mediump vec2 v_patternSize;
varying mediump float v_widthRatio;
#endif
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
varying lowp vec4 v_color;
varying mediump float v_lineHalfWidth;
varying mediump float v_blur;
void main()
{
#pragma main
v_color = color * opacity;
v_blur = blur + u_antialiasing;
v_normal = a_dir_normal.zw * scale;
#if defined (PATTERN) || defined(SDF)
v_tlbr          = tlbr / u_mosaicSize.xyxy;
v_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);
#if defined (PATTERN)
v_widthRatio = width / v_patternSize.y;
#else
v_widthRatio = width / sdfPatternHalfWidth / 2.0;
#endif
#endif
v_lineHalfWidth = (width + u_antialiasing) * 0.5;
mediump vec2 dir = a_dir_normal.xy * scale;
mediump vec2 offset_ = a_extrude_offset.zw * scale * offset;
mediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;
mediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth, 1.0);
#if defined (PATTERN) || defined(SDF)
v_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);
#endif
#ifdef ID
v_id = u_id / 255.0;
#endif
}`},outline:{"outline.frag":`varying lowp vec4 v_color;
varying mediump vec2 v_normal;
#ifdef ID
varying mediump vec4 v_id;
#endif
void main()
{
lowp float dist = abs(v_normal.y);
lowp float alpha = smoothstep(1.0, 0.0, dist);
gl_FragColor = alpha * v_color;
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"outline.vert":`attribute vec2 a_pos;
attribute vec2 a_offset;
attribute vec2 a_xnormal;
#pragma header
varying lowp vec4 v_color;
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform mediump vec2 u_fillTranslation;
uniform mediump float u_depth;
uniform mediump float u_outline_width;
varying lowp vec2 v_normal;
const float scale = 1.0 / 15.0;
void main()
{
#pragma main
v_color = color * opacity;
#ifdef ID
v_id = u_id / 255.0;
#endif
v_normal = a_xnormal;
mediump vec2 dist = u_outline_width * scale * a_offset;
mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth, 1.0);
}`},text:{"text.frag":`uniform lowp sampler2D u_texture;
varying lowp vec2 v_tex;
varying lowp vec4 v_color;
varying mediump float v_edgeWidth;
varying mediump float v_edgeDistance;
#ifdef ID
varying mediump vec4 v_id;
#endif
void main()
{
lowp float dist = texture2D(u_texture, v_tex).a;
mediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);
gl_FragColor = alpha * v_color;
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"text.vert":`attribute vec2 a_pos;
attribute vec2 a_vertexOffset;
attribute vec4 a_texAngleRange;
attribute vec4 a_levelInfo;
attribute float a_opacityInfo;
#pragma header
varying lowp vec4 v_color;
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform highp mat3 u_displayViewMat3;
uniform mediump vec2 u_textTranslation;
uniform vec2 u_mosaicSize;
uniform mediump float u_depth;
uniform mediump float u_mapRotation;
uniform mediump float u_level;
uniform lowp float u_keepUpright;
uniform mediump float u_fadeDuration;
varying lowp vec2 v_tex;
const float offsetPrecision = 1.0 / 8.0;
const mediump float edgePos = 0.75;
uniform mediump float u_antialiasingWidth;
varying mediump float v_edgeDistance;
varying mediump float v_edgeWidth;
uniform lowp float u_halo;
const float sdfFontScale = 1.0 / 24.0;
const float sdfPixel = 3.0;
uniform highp float u_time;
void main()
{
#pragma main
if (u_halo > 0.5)
{
v_color = halo_color * opacity;
halo_width *= sdfPixel;
halo_blur *= sdfPixel;
}
else
{
v_color = color * opacity;
halo_width = 0.0;
halo_blur = 0.0;
}
float modded = mod(a_opacityInfo, 128.0);
float targetOpacity = (a_opacityInfo - modded) / 128.0;
float startOpacity = modded / 127.0;
float interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);
v_color *= interpolatedOpacity;
mediump float a_angle       = a_levelInfo[1];
mediump float a_minLevel    = a_levelInfo[2];
mediump float a_maxLevel    = a_levelInfo[3];
mediump vec2 a_tex          = a_texAngleRange.xy;
mediump float a_visMinAngle    = a_texAngleRange.z;
mediump float a_visMaxAngle    = a_texAngleRange.w;
mediump float delta_z = 0.0;
mediump float angle = mod(a_angle + u_mapRotation, 256.0);
if (a_visMinAngle < a_visMaxAngle)
{
delta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));
}
else
{
delta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));
}
delta_z += 1.0 - step(a_minLevel, u_level);
delta_z += step(a_maxLevel, u_level);
delta_z += step(v_color[3], 0.0);
v_tex = a_tex.xy / u_mosaicSize;
#ifdef ID
v_id = u_id / 255.0;
#endif
v_edgeDistance = edgePos - halo_width / size;
v_edgeWidth = (u_antialiasingWidth + halo_blur) / size;
mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);
}`},util:{"encoding.glsl":`const vec4 rgba2float_factors = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, rgba2float_factors);
}`,"util.glsl":`float nextPOT(in float x) {
return pow(2.0, ceil(log2(abs(x))));
}`}};function mr(r){let e=_r;return r.split("/").forEach(t=>{e&&(e=e[t])}),e}const pr=new Ws(mr);function V(r){return pr.resolveIncludes(r)}const Kt=r=>oe({ID:r.id,PATTERN:r.pattern}),fr={shaders:r=>({vertexShader:Kt(r)+V("background/background.vert"),fragmentShader:Kt(r)+V("background/background.frag")})},Jt=r=>oe({ID:r.id}),gr={shaders:r=>({vertexShader:Jt(r)+V("circle/circle.vert"),fragmentShader:Jt(r)+V("circle/circle.frag")})},ei=r=>oe({ID:r.id,PATTERN:r.pattern}),br={shaders:r=>({vertexShader:ei(r)+V("fill/fill.vert"),fragmentShader:ei(r)+V("fill/fill.frag")})},ti=r=>oe({ID:r.id}),vr={shaders:r=>({vertexShader:ti(r)+V("outline/outline.vert"),fragmentShader:ti(r)+V("outline/outline.frag")})},ii=r=>oe({ID:r.id,SDF:r.sdf}),wr={shaders:r=>({vertexShader:ii(r)+V("icon/icon.vert"),fragmentShader:ii(r)+V("icon/icon.frag")})},si=r=>oe({ID:r.id,PATTERN:r.pattern,SDF:r.sdf}),yr={shaders:r=>({vertexShader:si(r)+V("line/line.vert"),fragmentShader:si(r)+V("line/line.frag")})},ri=r=>oe({ID:r.id}),xr={shaders:r=>({vertexShader:ri(r)+V("text/text.vert"),fragmentShader:ri(r)+V("text/text.frag")})};class Tr{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach(e=>e.dispose()),this._programByKey.clear()}getMaterialProgram(e,t,i){const s=t.key<<3|this._getMaterialOptionsValue(t.type,i);if(this._programByKey.has(s))return this._programByKey.get(s);const n=this._getProgramTemplate(t.type),{shaders:a}=n,{vertexShader:o,fragmentShader:l}=a(i),h=t.getShaderHeader(),_=t.getShaderMain(),d=o.replace("#pragma header",h).replace("#pragma main",_),c=new Ee(e,d,l,t.getAttributeLocations());return this._programByKey.set(s,c),c}_getMaterialOptionsValue(e,t){switch(e){case 0:{const i=t;return(i.pattern?1:0)<<1|(i.id?1:0)}case 1:{const i=t;return(i.pattern?1:0)<<1|(i.id?1:0)}case 2:return t.id?1:0;case 3:{const i=t;return(i.sdf?1:0)<<2|(i.pattern?1:0)<<1|(i.id?1:0)}case 4:{const i=t;return(i.sdf?1:0)<<1|(i.id?1:0)}case 5:return t.id?1:0;case 6:return t.id?1:0;default:return 0}}_getProgramTemplate(e){switch(e){case 0:return fr;case 5:return gr;case 1:return br;case 4:return wr;case 3:return yr;case 2:return vr;case 6:return xr;default:return null}}}const ni={shaders:{vertexShader:L("bitBlit/bitBlit.vert"),fragmentShader:L("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};class ai{constructor(){this._initialized=!1}dispose(){this._program&&(this._program.dispose(),this._program=null),this._vertexArrayObject&&(this._vertexArrayObject.dispose(),this._vertexArrayObject=null)}render(e,t,i,s){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(1,771,1,771),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),t.setSamplingMode(i),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",s),e.drawArrays(5,0,4),e.bindTexture(null,0),e.bindVAO())}_initialize(e){if(this._initialized)return!0;const t=ni.attributes,i=Me(e,ni);if(!i)return!1;const s={geometry:[{name:"a_pos",count:2,type:5120,offset:0,stride:4,normalized:!1,divisor:0},{name:"a_tex",count:2,type:5120,offset:2,stride:4,normalized:!1,divisor:0}]},n=new Int8Array(16);n[0]=-1,n[1]=-1,n[2]=0,n[3]=0,n[4]=1,n[5]=-1,n[6]=1,n[7]=0,n[8]=-1,n[9]=1,n[10]=0,n[11]=1,n[12]=1,n[13]=1,n[14]=1,n[15]=1;const a=new ae(e,t,s,{geometry:ie.createVertex(e,35044,n)});return this._program=i,this._vertexArrayObject=a,this._initialized=!0,!0}}const Fr=r=>{let e="";e+=r[0].toUpperCase();for(let t=1;t<r.length;t++){const i=r[t];i===i.toUpperCase()?(e+="_",e+=i):e+=i.toUpperCase()}return e},oi=r=>{const e={};for(const t in r)e[Fr(t)]=r[t];return oe(e)},li=(r,e,t)=>{const i=r+r.substring(r.lastIndexOf("/")),s=e+e.substring(e.lastIndexOf("/"));return{attributes:t,shaders:n=>({vertexShader:oi(n)+L(`${i}.vert`),fragmentShader:oi(n)+L(`${s}.frag`)})}},hi=r=>r===k.HITTEST||r===k.LABEL_ALPHA,Er=r=>(hi(r)?1:0)|(r===k.HIGHLIGHT?2:0),Sr=({rendererInfo:r,drawPhase:e},t,i,s)=>`${t.getVariationHash()}-${s.join(".")}-${Er(e)}-${r.getVariationHash()}-${B(i)&&i.join(".")}`,Mr=(r,e,t,i)=>{const s=i.reduce((a,o)=>ue($({},a),{[o]:r.context.driverTest[o]}),{}),n=$(ue($($({},e.getVariation()),r.rendererInfo.getVariation()),{highlight:r.drawPhase===k.HIGHLIGHT,id:hi(r.drawPhase)}),s);if(B(t))for(const a of t)n[a]=!0;return n};class Cr{constructor(e){this._programByKey=new Map,this._programCache=new Wt(e)}dispose(){this._programCache&&this._programCache.dispose()}getProgram(e,t,i=[],s=[]){const n=t.vsPath+"."+t.fsPath+JSON.stringify(i)+s.join(".");if(this._programByKey.has(n))return this._programByKey.get(n);const a=s.reduce((c,m)=>ue($({},c),{[m]:e.context.driverTest[m]}),{}),o=$($({},i.map(c=>typeof c=="string"?{name:c,value:!0}:c).reduce((c,m)=>ue($({},c),{[m.name]:m.value}),{})),a),{vsPath:l,fsPath:h,attributes:_}=t,d=this._programCache.getProgram(li(l,h,_),o);if(!d)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(n,d),d}getMaterialProgram(e,t,i,s,n,a=["ignoresSamplerPrecision"]){const o=Sr(e,t,n,a);if(this._programByKey.has(o))return this._programByKey.get(o);const l=Mr(e,t,n,a),h=this._programCache.getProgram(li(i,i,s),l);if(!h)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(o,h),h}}function Br(r){const e=r.toLowerCase().split(" ").join("-");switch(e){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return e}}function Rr(r){const e=Or(r)+Pr(r);return Br(r.family)+(e.length>0?e:"-regular")}function Or(r){if(!r.weight)return"";switch(r.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}function Pr(r){if(!r.style)return"";switch(r.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}class qe{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new G(0,0,e,t))}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new G;let i=null,s=-1;for(let n=0;n<this._free.length;++n){const a=this._free[n];e<=a.width&&t<=a.height&&(i===null||a.y<=i.y&&a.x<=i.x)&&(i=a,s=n)}return i===null?new G:(this._free.splice(s,1),i.width<i.height?(i.width>e&&this._free.push(new G(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new G(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new G(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new G(i.x,i.y+t,e,i.height-t))),new G(i.x,i.y,e,t))}release(e){for(let t=0;t<this._free.length;++t){const i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}const Ar=256,Dr=r=>Math.floor(r/256);function Ir(r){const e=new Set;for(const t of r)e.add(Dr(t));return e}function zr(r,e,t){return r.has(e)||r.set(e,t().then(()=>{r.delete(e)}).catch(i=>{r.delete(e),ts(i)})),r.get(e)}const Ur=r=>({rect:new G(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:r,sdf:!0});class $r{constructor(e,t,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=t,this._glyphSource=i,this._binPack=new qe(e-4,t-4),this._glyphData.push(new Uint8Array(e*t)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}dispose(){this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyph(){const e=[117,149,181,207,207,181,149,117],t=[];for(let s=0;s<e.length;s++){const n=e[s];for(let a=0;a<11;a++)t.push(n)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(t)};this._recordGlyph(i)}async getGlyphItems(e,t,i){const s=this._getGlyphCache(e);return await this._fetchRanges(e,t,i),t.map(n=>this._getMosaicItem(s,e,n))}bind(e,t,i,s){const n=this._getTexture(e,i);n.setSamplingMode(t),this._dirties[i]&&(n.setData(this._glyphData[i]),this._dirties[i]=!1),e.bindTexture(n,s)}_getGlyphCache(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}_getTexture(e,t){return this._textures[t]||(this._textures[t]=new I(e,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[t]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(e,t,i){const s=Ir(t),n=[];s.forEach(a=>{n.push(this._fetchRange(e,a,i))}),await Promise.all(n)}async _fetchRange(e,t,i){if(t>Ar)return null;const s=e+t;return zr(this._rangePromises,s,()=>this._glyphSource.getRange(e,t,i))}_getMosaicItem(e,t,i){if(!e[i]){const s=this._glyphSource.getGlyph(t,i);if(!s||!s.metrics)return Ur(i);const n=this._recordGlyph(s),a=this._currentPage,o=s.metrics;e[i]={rect:n,page:a,metrics:o,code:i,sdf:!0},this._invalidate()}return e[i]}_recordGlyph(e){const t=e.metrics;let i;if(t.width===0)i=new G(0,0,0,0);else{const s=3,n=t.width+2*s,a=t.height+2*s;i=this._binPack.allocate(n,a),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new qe(this.width-4,this.height-4),i=this._binPack.allocate(n,a));const o=this._glyphData[this._currentPage],l=e.bitmap;let h,_;if(l)for(let d=0;d<a;d++){h=n*d,_=this.width*(i.y+d)+i.x;for(let c=0;c<n;c++)o[_+c]=l[h+c]}$e("esri-glyph-debug")&&this._showDebugPage(o)}return i}_showDebugPage(e){const t=document.createElement("canvas"),i=t.getContext("2d"),s=new ImageData(this.width,this.height),n=s.data;t.width=this.width,t.height=this.height,t.style.border="1px solid black";for(let a=0;a<e.length;++a)n[4*a+0]=e[a],n[4*a+1]=0,n[4*a+2]=0,n[4*a+3]=255;i.putImageData(s,0,0),document.body.appendChild(t)}}class kr{constructor(e){for(this._metrics=[],this._bitmaps=[];e.next();)switch(e.tag()){case 1:{const t=e.getMessage();for(;t.next();)switch(t.tag()){case 3:{const i=t.getMessage();let s,n,a,o,l,h,_;for(;i.next();)switch(i.tag()){case 1:s=i.getUInt32();break;case 2:n=i.getBytes();break;case 3:a=i.getUInt32();break;case 4:o=i.getUInt32();break;case 5:l=i.getSInt32();break;case 6:h=i.getSInt32();break;case 7:_=i.getUInt32();break;default:i.skip()}i.release(),s&&(this._metrics[s]={width:a,height:o,left:l,top:h,advance:_},this._bitmaps[s]=n);break}default:t.skip()}t.release();break}default:e.skip()}}getMetrics(e){return this._metrics[e]}getBitmap(e){return this._bitmaps[e]}}class Lr{constructor(){this._ranges=[]}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t}}class Vr{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,t,i){const s=this._getFontStack(e);if(s.getRange(t))return Promise.resolve();const n=256*t,a=n+255,o=this._baseURL.replace("{fontstack}",e).replace("{range}",n+"-"+a);return xe(o,$({responseType:"array-buffer"},i)).then(l=>{s.addRange(t,new kr(new is(new Uint8Array(l.data),new DataView(l.data))))})}getGlyph(e,t){const i=this._getFontStack(e);if(!i)return;const s=Math.floor(t/256);if(s>256)return;const n=i.getRange(s);return n?{metrics:n.getMetrics(t),bitmap:n.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new Lr),t}}const Re=1e20;class Nr{constructor(e){this.size=e;const t=document.createElement("canvas");t.width=t.height=e,this._context=t.getContext("2d"),this._gridOuter=new Float64Array(e*e),this._gridInner=new Float64Array(e*e),this._f=new Float64Array(e),this._d=new Float64Array(e),this._z=new Float64Array(e+1),this._v=new Int16Array(e)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(e,t,i=31){this._initSVG();const s=this.createSVGString(e);return new Promise((n,a)=>{const o=new Image;o.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(s),o.onload=()=>{o.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(o,0,0,this.size,this.size);const h=this._context.getImageData(0,0,this.size,this.size),_=new Uint8Array(this.size*this.size*4);for(let d=0;d<this.size*this.size;d++){const c=h.data[4*d+3]/255;this._gridOuter[d]=c===1?0:c===0?Re:Math.max(0,.5-c)**2,this._gridInner[d]=c===1?Re:c===0?0:Math.max(0,c-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let d=0;d<this.size*this.size;d++){const c=this._gridOuter[d]-this._gridInner[d];ks(.5-c/(2*i),_,4*d)}n(_)};const l=t&&t.signal;l&&ss(l,()=>a(Rt()))})}_initSVG(){if(!this._svg){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}}createSVGString(e){this._initSVG();const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d",e),this._svg.appendChild(t);const i=t.getBBox(),s=i.width/i.height,n=this.size/2;let a,o,l,h;if(s>1){o=a=n/i.width;const m=n*(1/s);l=this.size/4,h=n-m/2}else a=o=n/i.height,l=n-n*s/2,h=this.size/4;const _=-i.x*a+l,d=-i.y*o+h;t.setAttribute("style",`transform: matrix(${a}, 0, 0, ${o}, ${_}, ${d})`);const c=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${this._svg.innerHTML}</svg>`;return this._svg.removeChild(t),c}_edt(e,t,i){const s=this._f,n=this._d,a=this._v,o=this._z;for(let l=0;l<t;l++){for(let h=0;h<i;h++)s[h]=e[h*t+l];this._edt1d(s,n,a,o,i);for(let h=0;h<i;h++)e[h*t+l]=n[h]}for(let l=0;l<i;l++){for(let h=0;h<t;h++)s[h]=e[l*t+h];this._edt1d(s,n,a,o,t);for(let h=0;h<t;h++)e[l*t+h]=Math.sqrt(n[h])}}_edt1d(e,t,i,s,n){i[0]=0,s[0]=-Re,s[1]=+Re;for(let a=1,o=0;a<n;a++){let l=(e[a]+a*a-(e[i[o]]+i[o]*i[o]))/(2*a-2*i[o]);for(;l<=s[o];)o--,l=(e[a]+a*a-(e[i[o]]+i[o]*i[o]))/(2*a-2*i[o]);o++,i[o]=a,s[o]=l,s[o+1]=+Re}for(let a=0,o=0;a<n;a++){for(;s[o+1]<a;)o++;t[a]=(a-i[o])*(a-i[o])+e[i[o]]}}}function ce(r){return r&&r.type==="static"}class lt{constructor(e,t,i,s=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=i,this._requestRender=e,s>0&&(this._maxItemSize=s),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new qe(this._pageWidth,this._pageHeight);const n=Math.floor(this._pageWidth),a=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(n*a)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}getHeight(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}getPageTexture(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}has(e){return this._mosaicRects.has(e)}get itemCount(){return this._mosaicRects.size}getSpriteItem(e){return this._mosaicRects.get(e)}addSpriteItem(e,t,i,s,n,a){if(this._mosaicRects.has(e))return this._mosaicRects.get(e);let o,l,h;if(ce(i))[o,l,h]=this._allocateImage(t[0],t[1]);else{o=new G(0,0,t[0],t[1]),l=this._mosaicPages.length;const d=void 0;this._mosaicPages.push({mosaicsData:i,size:t,dirty:!0,texture:d})}if(o.width<=0||o.height<=0)return null;const _={rect:o,width:t[0],height:t[1],sdf:n,simplePattern:a,pixelRatio:1,page:l};return this._mosaicRects.set(e,_),ce(i)&&this._copy({rect:o,spriteSize:t,spriteData:i.data,page:l,pageSize:h,repeat:s,sdf:n}),_}hasItemsToProcess(){return this._spriteCopyQueue.length!==0}processNextItem(){const e=this._spriteCopyQueue.pop();e&&this._copy(e)}getSpriteItems(e){const t={};for(const i of e)t[i]=this.getSpriteItem(i);return t}getMosaicItemPosition(e){const t=this.getSpriteItem(e),i=t&&t.rect;if(!i)return null;i.width=t.width,i.height=t.height;const s=t.width,n=t.height,a=Ce,o=this._mosaicPages[t.page];return{size:[t.width,t.height],tl:[(i.x+a)/o[0],(i.y+a)/o[1]],br:[(i.x+a+s)/o[0],(i.y+a+n)/o[1]],page:t.page}}bind(e,t,i=0,s=0){const n=this._mosaicPages[i],a=n.mosaicsData;let o=n.texture;if(o||(o=Gr(e,a,n.size),n.texture=o),o.setSamplingMode(t),ce(a))e.bindTexture(o,s),n.dirty&&(o.setData(new Uint8Array(a.data.buffer)),o.generateMipmap());else{const l=a.data,h=l.bindFrame(e,o,s);B(this._requestRender)&&h&&l.frameCount>0&&this._requestRender.requestRender(),l.bindFrame(e,o,s)}n.dirty=!1}static _copyBits(e,t,i,s,n,a,o,l,h,_,d){let c=s*t+i,m=l*a+o;if(d){m-=a;for(let p=-1;p<=_;p++,c=((p+_)%_+s)*t+i,m+=a)for(let u=-1;u<=h;u++)n[m+u]=e[c+(u+h)%h]}else for(let p=0;p<_;p++){for(let u=0;u<h;u++)n[m+u]=e[c+u];c+=t,m+=a}}_copy(e){if(e.page>=this._mosaicPages.length)return;const t=this._mosaicPages[e.page],i=t.mosaicsData;if(!ce(t.mosaicsData))throw new O("mapview-invalid-resource","unsuitable data type!");const s=e.spriteData,n=i.data;n&&s||console.error("Source or target images are uninitialized!"),lt._copyBits(s,e.spriteSize[0],0,0,n,e.pageSize[0],e.rect.x+Ce,e.rect.y+Ce,e.spriteSize[0],e.spriteSize[1],e.repeat),t.dirty=!0}_allocateImage(e,t){e+=2*Ce,t+=2*Ce;const i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){const n=2**Math.ceil(Yt(e)),a=2**Math.ceil(Yt(t)),o=new G(0,0,e,t);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(n*a)},size:[n,a],dirty:!0,texture:void 0}),[o,this._mosaicPages.length-1,[n,a]]}const s=this._binPack.allocate(e,t);if(s.width<=0){const n=this._mosaicPages[this._currentPage];return!n.dirty&&ce(n.mosaicsData)&&(n.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new qe(this._pageWidth,this._pageHeight),this._allocateImage(e,t)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const e of this._mosaicPages){const t=e.texture;t&&t.dispose();const i=e.mosaicsData;ce(i)||i.data.pause()}this._mosaicPages=null,this._mosaicRects.clear()}}function Gr(r,e,t){return ce(e)?new I(r,{pixelFormat:6408,dataType:5121,width:t[0],height:t[1]},new Uint8Array(e.data.buffer)):new I(r,{pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:t[0],height:t[1]},null)}const ui=new Uint32Array(256);for(let r=0;r<256;r++){let e=r;for(let t=0;t<8;t++)e=(1&e)!=0?3988292384^e>>>1:e>>>1;ui[r]=e}function Wr(r,e=0,t=r.length-e){let i=-1;for(let s=e,n=e+t;s<n;s++)i=i>>>8^ui[255&(i^r[s])];return-1^i}const Hr=new O("Not a PNG"),ci=new O("Not an animated PNG"),ht=new Uint8Array([137,80,78,71,13,10,26,10]);function di(r){const e=r.constructor===Uint8Array?r:new Uint8Array(r);return!ht.some((t,i)=>t!==e[i])}function jr(r){const e=new Uint8Array(r);if(!di(e))return!1;let t=!1;return ct(e,i=>!(t=i==="acTL")),t}class ut{constructor(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.paused=!1,this.playing=!1,this.playSpeed=1,this.currentFrameNumber=0,this._lastUsedFrame=-1}static async create(e,t){const i=new ut;try{await i._load(e,t)}catch(s){if(!J(s))return new O("invalid-resource",`Could not load PNG: ${s.message}`)}return i}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(e,t,i){e.bindTexture(t,i);const s=this.frameChanged();if(!s)return!1;const n=this.currentFrame,a=n.frameData,o=t.descriptor;return(n.left||n.top||n.width!==o.width||n.height!==o.height)&&t.setData(null),t.updateData(0,n.left,n.top,n.width,n.height,a),this.updateUsedFrame(),s}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}async _load(e,t){try{const i=Yr(this,e);if(i!==this)return i;this._resizeCanvas=document.createElement("canvas"),this._resizeCanvas.width=this.width,this._resizeCanvas.height=this.height,await Promise.all(this.frames.map(s=>s.createImage(this._resizeCanvas)))}catch(i){if(!J(i))return new O("invalid-resource","Could not parse PNG")}this.play()}_play(){let e,t;if(this.playSpeed===0)return void this.pause();this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),t=this.currentFrameNumber,t-=1,t<0&&(t=this.frames.length-1),e=1*-this.frames[t].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,e=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);const i=this.frames[this.currentFrameNumber];this.currentFrame={frameData:i.imageData,top:i.top,left:i.left,width:i.width,height:i.height},this.timerID=window.setTimeout(()=>this._play(),e)}}class qr{constructor(){this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.data=null,this.imageData=null}async createImage(e){if(this.imageData===null)return new Promise((t,i)=>{const s=URL.createObjectURL(this.data),n=document.createElement("img");n.onload=()=>{URL.revokeObjectURL(s),this.imageData=Xr(n,e),t()},n.onerror=()=>{URL.revokeObjectURL(s),this.imageData=null,i(new Error("Image creation error"))},n.src=s})}}function Xr(r,e){e.width=r.width,e.height=r.height;const t=e.getContext("2d");t.drawImage(r,0,0,r.width,r.height);const i=t.getImageData(0,0,r.width,r.height),s=new Uint8Array(i.data);let n;for(let a=0;a<s.length;a+=4)n=s[a+3]/255,s[a]=s[a]*n,s[a+1]=s[a+1]*n,s[a+2]=s[a+2]*n;return new ImageData(new Uint8ClampedArray(s.buffer),r.width,r.height)}function Yr(r,e){const t=new Uint8Array(e);if(ht.some((d,c)=>d!==t[c]))return Hr;let i=!1;if(ct(t,d=>!(i=d==="acTL")),!i)return ci;const s=[],n=[];let a=null,o=null,l=0;if(ct(t,(d,c,m,p)=>{const u=new DataView(c.buffer);switch(d){case"IHDR":a=c.subarray(m+8,m+8+p),r.width=u.getUint32(m+8),r.height=u.getUint32(m+12);break;case"acTL":r.numPlays=u.getUint32(m+8+4);break;case"fcTL":{o&&(r.frames.push(o),l++),o=new qr,o.width=u.getUint32(m+8+4),o.height=u.getUint32(m+8+8),o.left=u.getUint32(m+8+12),o.top=u.getUint32(m+8+16);const f=u.getUint16(m+8+20);let w=u.getUint16(m+8+22);w===0&&(w=100),o.delay=1e3*f/w,o.delay<=10&&(o.delay=100),r.playTime+=o.delay,o.disposeOp=u.getUint8(m+8+24),o.blendOp=u.getUint8(m+8+25),o.dataParts=[],l===0&&o.disposeOp===2&&(o.disposeOp=1);break}case"fdAT":o&&o.dataParts.push(c.subarray(m+8+4,m+8+p));break;case"IDAT":o&&o.dataParts.push(c.subarray(m+8,m+8+p));break;case"IEND":n.push(_i(c,m,12+p));break;default:s.push(_i(c,m,12+p))}}),r.frames.length===0)return ci;r.frameCount=r.frames.length;const h=new Blob(s),_=new Blob(n);return r.frames.forEach(d=>{let c=[];c.push(ht),a.set(pi(d.width),0),a.set(pi(d.height),4),c.push(mi("IHDR",a)),c.push(h),d.dataParts.forEach(m=>c.push(mi("IDAT",m))),c.push(_),d.data=new Blob(c,{type:"image/png"}),delete d.dataParts,c=null}),r}function ct(r,e){const t=new DataView(r.buffer);let i,s,n,a=8;do s=t.getUint32(a),i=Qr(r,a+4,4),n=e(i,r,a,s),a+=12+s;while(n!==!1&&i!=="IEND"&&a<r.length)}function Qr(r,e,t){const i=Array.prototype.slice.call(r.subarray(e,e+t));return String.fromCharCode.apply(String,i)}function Zr(r){const e=new Uint8Array(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}function _i(r,e,t){const i=new Uint8Array(t);return i.set(r.subarray(e,e+t)),i}function mi(r,e){const t=r.length+e.length,i=new Uint8Array(t+8),s=new DataView(i.buffer);s.setUint32(0,e.length),i.set(Zr(r),4),i.set(e,8);const n=Wr(i,4,t);return s.setUint32(t+4,n),i}function pi(r){return new Uint8Array([r>>>24&255,r>>>16&255,r>>>8&255,255&r])}const be={GCExt:249,COMMENT:254,APPExt:255,UNKNOWN:1,IMAGE:44,EOF:59,EXT:33};function fi(r){if(!r||r.byteLength===0)return!1;const e=r.constructor===Uint8Array?r:new Uint8Array(r);return e[0]===71&&e[1]===73&&e[2]===70&&e[3]===56}function Kr(r){if(!r||r.byteLength===0)return!1;const e=new Uint8Array(r);if(!fi(e))return!1;let t=0;for(let i=0,s=e.length-9;i<s&&(e[i]!==0||e[i+1]!==33||e[i+2]!==249||e[i+3]!==4||e[i+8]!==0||e[i+9]!==44&&e[i+9]!==33||(t++,!(t>1)));++i);return t>1}class dt{constructor(){this.paused=!1,this.playing=!1,this.waitTillDone=!0,this.loading=!1,this.firstFrameOnly=!1,this.frames=[],this.comment="",this.length=0,this.currentFrameNumber=0,this.frameCount=0,this.playSpeed=1,this.lastFrame=null,this.playOnLoad=!0,this.complete=!1,this.interlaceOffsets=[0,4,2,1],this.interlaceSteps=[8,8,4,2],this._lastUsedFrame=-1}static async create(e,t){const i=new dt;try{await i._load(e,t)}catch(s){if(!J(s))return new O("invalid-resource",`Could not load PNG: ${s.message}`)}return i}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(e,t,i){e.bindTexture(t,i);const s=this.frameChanged();if(s){const n=this.currentFrame,a=n.frameData;t.updateData(0,0,0,n.width,n.height,a),this.updateUsedFrame()}return s}seekFrame(e){clearTimeout(this.timerID),this.currentFrameNumber=e%this.frames.length,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}seek(e){clearTimeout(this.timerID),e<0&&(e=0),e*=1e3,e%=this.length;let t=0;for(;e>this.frames[t].time+this.frames[t].delay&&t<this.frames.length;)t+=1;this.currentFrameNumber=t,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}async _load(e,t){try{this.loading=!0,await this._parse(e,t),this.loading=!1,this.play()}catch(i){if(!J(i))return new O("invalid-resource","Could not parse gif!")}}_parse(e,t){const i=new Jr(e);i.pos+=6,this.width=i.data[i.pos++]+(i.data[i.pos++]<<8),this.height=i.data[i.pos++]+(i.data[i.pos++]<<8);const s=i.data[i.pos++];return this.globalColourCount=1<<1+(7&s),i.pos++,i.pos++,128&s&&(this.globalColourTable=this._parseColourTable(this.globalColourCount,i)),new Promise((n,a)=>{setTimeout(()=>this._parseBlock(i,n,a,t),0)})}async _parseBlock(e,t,i,s){if(s&&s.signal&&rs(s.signal))return void i(Rt());const n=e.data[e.pos++];if(n===be.IMAGE){if(this._parseImg(e),this.firstFrameOnly)return this._finishedLoading(),void t()}else{if(n===be.EOF)return this._finishedLoading(),void t();this._parseExt(e)}typeof this.onprogress=="function"&&this.onprogress({bytesRead:e.pos,totalBytes:e.data.length,frame:this.frames.length}),setTimeout(()=>this._parseBlock(e,t,i,s),0)}_parseColourTable(e,t){const i=[];for(let s=0;s<e;s++)i.push([t.data[t.pos++],t.data[t.pos++],t.data[t.pos++]]);return i}_parseImg(e){const t=n=>{const a=this.pixelBufSize/n;this.interlacedBufSize!==this.pixelBufSize&&(this.deinterlaceBuf=new Uint8Array(this.pixelBufSize),this.interlacedBufSize=this.pixelBufSize);let o=0;for(let l=0;l<4;l++)for(let h=this.interlaceOffsets[l];h<a;h+=this.interlaceSteps[l])this.deinterlaceBuf.set(this.pixelBuf.subarray(o,o+n),h*n),o+=n},i={};this.frames.push(i),i.disposalMethod=this.disposalMethod,i.time=this.length,i.delay=10*this.delayTime,this.length+=i.delay,this.transparencyGiven?i.transparencyIndex=this.transparencyIndex:i.transparencyIndex=void 0,i.leftPos=e.data[e.pos++]+(e.data[e.pos++]<<8),i.topPos=e.data[e.pos++]+(e.data[e.pos++]<<8),i.width=e.data[e.pos++]+(e.data[e.pos++]<<8),i.height=e.data[e.pos++]+(e.data[e.pos++]<<8);const s=e.data[e.pos++];i.localColourTableFlag=!!(128&s),i.localColourTableFlag&&(i.localColourTable=this._parseColourTable(1<<1+(7&s),e)),this.pixelBufSize!==i.width*i.height&&(this.pixelBuf=new Uint8Array(i.width*i.height),this.pixelBufSize=i.width*i.height),this._lzwDecode(e.data[e.pos++],e.readSubBlocksB()),64&s?(i.interlaced=!0,t(i.width)):i.interlaced=!1,this._processFrame(i)}_lzwDecode(e,t){let i,s,n,a,o,l,h,_,d;n=s=0;let c=[];const m=1<<e,p=m+1;for(a=e+1,d=!1;!d;){for(l=o,o=0,i=0;i<a;i++)t[n>>3]&1<<(7&n)&&(o|=1<<i),n++;if(o===m){for(c=[],a=e+1,i=0;i<m;i++)c[i]=[i];c[m]=[],c[p]=null}else{if(o===p)return void(d=!0);for(o>=c.length?c.push(c[l].concat(c[l][0])):l!==m&&c.push(c[l].concat(c[o][0])),h=c[o],_=h.length,i=0;i<_;i++)this.pixelBuf[s++]=h[i];c.length===1<<a&&a<12&&a++}}}_processFrame(e){e.image=document.createElement("canvas"),e.image.width=this.width,e.image.height=this.height,e.ctx=e.image.getContext("2d");const t=e.localColourTableFlag?e.localColourTable:this.globalColourTable;this.lastFrame===null&&(this.lastFrame=e);const i=this.lastFrame.disposalMethod===2||this.lastFrame.disposalMethod===3;i||e.ctx.drawImage(this.lastFrame.image,0,0,this.width,this.height);const s=e.ctx.getImageData(e.leftPos,e.topPos,e.width,e.height),n=e.transparencyIndex,a=s.data,o=e.interlaced?this.deinterlaceBuf:this.pixelBuf,l=o.length;let h,_,d=0;for(let c=0;c<l;c++)h=o[c],_=t[h],n!==h?(a[d++]=_[0],a[d++]=_[1],a[d++]=_[2],a[d++]=255):(i&&(a[d+3]=0),d+=4);e.ctx.putImageData(s,e.leftPos,e.topPos),this.lastFrame=e}_parseExt(e){const t=e.data[e.pos++];t===be.GCExt?this._parseGCExt(e):t===be.COMMENT?this.comment+=e.readSubBlocks():t===be.APPExt?this._parseAppExt(e):(t===be.UNKNOWN&&(e.pos+=13),e.readSubBlocks())}_parseAppExt(e){e.pos+=1,e.getString(8)==="NETSCAPE"?e.pos+=8:(e.pos+=3,e.readSubBlocks())}_parseGCExt(e){e.pos++;const t=e.data[e.pos++];this.disposalMethod=(28&t)>>2,this.transparencyGiven=!!(1&t),this.delayTime=e.data[e.pos++]+(e.data[e.pos++]<<8),this.transparencyIndex=e.data[e.pos++],e.pos++}_finishedLoading(){this.loading=!1,this.frameCount=this.frames.length,this.lastFrame=null,this.complete=!0,this.disposalMethod=void 0,this.transparencyGiven=void 0,this.delayTime=void 0,this.transparencyIndex=void 0,this.waitTillDone=void 0,this.pixelBuf=void 0,this.deinterlaceBuf=void 0,this.pixelBufSize=void 0,this.deinterlaceBuf=void 0,this.currentFrameNumber=0,this.frames.length>0&&this._setCurrentFrame(0),this.playOnLoad&&this.play()}_play(){let e,t;this.playSpeed!==0?(this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),t=this.currentFrameNumber,t-=1,t<0&&(t=this.frames.length-1),e=1*-this.frames[t].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,e=1*this.frames[this.currentFrameNumber].delay/this.playSpeed),this._setCurrentFrame(this.currentFrameNumber),this.timerID=window.setTimeout(()=>this._play(),e)):this.pause()}_setCurrentFrame(e){const t=this.frames[e];this.currentFrame={frameData:t.image,top:0,left:0,width:this.width,height:this.height}}}class Jr{constructor(e){this.pos=0,this.data=new Uint8ClampedArray(e),this.len=this.data.length}getString(e){let t="";for(;e--;)t+=String.fromCharCode(this.data[this.pos++]);return t}readSubBlocks(){let e,t,i="";do for(t=e=this.data[this.pos++];t--;)i+=String.fromCharCode(this.data[this.pos++]);while(e!==0&&this.pos<this.len);return i}readSubBlocksB(){let e,t;const i=[];do for(t=e=this.data[this.pos++];t--;)i.push(this.data[this.pos++]);while(e!==0&&this.pos<this.len);return i}}function en(r){switch(r.type){case"esriSMS":return`${r.style}.${r.path}`;case"esriSLS":return`${r.style}.${r.cap}`;case"esriSFS":return`${r.style}`;case"esriPFS":case"esriPMS":return r.imageData?`${r.imageData}${r.width}${r.height}`:`${r.url}${r.width}${r.height}`;default:return"mosaicHash"in r?r.mosaicHash:JSON.stringify(r)}}const gi=os(),bi="arial-unicode-ms-regular",_t=126,vi=Te.getLogger("esri.views.2d.engine.webgl.TextureManager");async function tn(r,e){const t=Gt(r);let i;const s=";base64,";if(t.includes(s)){const n=t.indexOf(s)+s.length,a=t.substring(n),o=atob(a),l=new Uint8Array(o.length);for(let h=0;h<o.length;h++)l[h]=o.charCodeAt(h);i=l.buffer}else try{const{data:n}=await xe(t,$({responseType:"array-buffer"},e));i=n}catch(n){if(!J(n))return new O("mapview-invalid-resource",`Could not fetch requested resource at ${t}`)}return i}function wi(r,e){const t=Math.round(ne(e)*window.devicePixelRatio),i=t>=128?2:4;return Math.min(r,t*i)}const mt=(r,e,t)=>vi.error(new O(r,e,t));class pt{constructor(e,t,i){this.mosaicType=e,this.page=t,this.sdf=i}static fromMosaic(e,t){return new pt(e,t.page,t.sdf)}}class sn{constructor(e,t){this.resourceManager=t,this._invalidFontsMap=new Map,this._sdfConverter=new Nr(_t),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new ns({concurrency:10,process:async(i,s)=>{Ot(s);try{return await xe(i,{responseType:"image",signal:s})}catch(n){throw J(n)?n:new O("mapview-invalid-resource",`Could not fetch requested resource at ${i}`,n)}}}),this._spriteMosaic=new lt(e,2048,2048,500),this._glyphSource=new Vr(`${as.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new $r(1024,1024,this._glyphSource),this._rasterizer=new dr(t)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}async rasterizeItem(e,t,i,s){if(D(e))return mt("mapview-null-resource","Unable to rasterize null resource"),null;switch(e.type){case"text":case"esriTS":{const n=await this._rasterizeText(e,i,s);return n.forEach(a=>this._setTextureBinding(We.GLYPH,a)),{glyphMosaicItems:n}}default:{if(js(e))return mt("mapview-invalid-type",`MapView does not support symbol type: ${e.type}`,e),null;const n=await this._rasterizeSpriteSymbol(e,t,s);return ot(n)&&n&&this._setTextureBinding(We.SPRITE,n),{spriteMosaicItem:n}}}}bindTextures(e,t,i,s=!1){if(i.textureBinding===0)return;const n=this._bindingInfos[i.textureBinding-1],a=n.page,o=s?9987:9729;switch(n.mosaicType){case We.SPRITE:{const l=this.sprites.getWidth(a),h=this.sprites.getHeight(a),_=ee(gi,l,h);return this._spriteMosaic.bind(e,o,a,qt),t.setUniform1i("u_texture",qt),void t.setUniform2fv("u_mosaicSize",_)}case We.GLYPH:{const l=this.glyphs.width,h=this.glyphs.height,_=ee(gi,l,h);return this._glyphMosaic.bind(e,o,a,jt),t.setUniform1i("u_texture",jt),void t.setUniform2fv("u_mosaicSize",_)}default:vi.error("mapview-texture-manager",`Cannot handle unknown type ${n.mosaicType}`)}}_hashMosaic(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3}_setTextureBinding(e,t){const i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){const s=pt.fromMosaic(e,t),n=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,n),this._bindingInfos.push(s)}t.textureBinding=this._hashToBindingIndex.get(i)}async _rasterizeText(e,t,i){let s,n;if("cim"in e){const l=e;s=l.fontName,n=l.text}else{const l=e;s=Rr(l.font),n=l.text}const a=this._invalidFontsMap.has(s),o=t||qs(Ls(n)[0]);try{return await this._glyphMosaic.getGlyphItems(a?bi:s,o,i)}catch{return mt("mapview-invalid-resource",`Couldn't find font ${s}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(s,!0),this._glyphMosaic.getGlyphItems(bi,o,i)}}async _rasterizeSpriteSymbol(e,t,i){if(Xs(e))return null;const s=en(e);if(this._spriteMosaic.has(s))return this._spriteMosaic.getSpriteItem(s);if(Vt(e)||Ys(e))return this._handleAsyncResource(s,e,i);const n=1,a=this._rasterizer.rasterizeJSONResource(e,n);if(a){const{size:o,image:l,sdf:h,simplePattern:_}=a;return this._addItemToMosaic(s,o,{type:"static",data:l},He(e),h,_)}return new O("TextureManager","unrecognized or null rasterized image")}async _handleAsyncResource(e,t,i){if(this._ongoingRasterizations.has(e))return this._ongoingRasterizations.get(e);let s;s=Vt(t)?this._handleSVG(t,e,i):this._handleImage(t,e,i),this._ongoingRasterizations.set(e,s);try{await s,this._ongoingRasterizations.delete(e)}catch{this._ongoingRasterizations.delete(e)}return s}async _handleSVG(e,t,i){const s=[_t,_t],n=await this._sdfConverter.draw(e.path,i);return this._addItemToMosaic(t,s,{type:"static",data:new Uint32Array(n.buffer)},!1,!0,!0)}async _handleGIFOrPNG(e,t,i){const s=await tn(e,i);if(ot(s)){const n=fi(s),a=di(s);if(!n&&!a)return new O("mapview-invalid-resource","Image data is neither GIF nor PNG!");let o;try{n&&Kr(s)?o=await dt.create(s,i):a&&jr(s)&&(o=await ut.create(s,i))}catch(_){if(!J(_))return new O("mapview-invalid-resource","Could not fetch requested resource!")}if(o&&ot(o))return this._addItemToMosaic(t,[o.width,o.height],{type:"animated",data:o},He(e),!1,!1);const l=new Blob([s],{type:n?"image/gif":"image/png"}),h=await this._imageFromBlob(l);if(h&&h instanceof HTMLImageElement){let _=h.width,d=h.height;e.type==="esriPMS"&&(_=Math.round(wi(h.width,Nt(e))),d=Math.round(h.height*(_/h.width)));const c="cim"in e?e.cim.colorSubstitutions:void 0,{size:m,sdf:p,image:u}=this._rasterizer.rasterizeImageResource(_,d,h,c);return this._addItemToMosaic(t,m,{type:"static",data:u},He(e),p,!1)}}return new O("mapview-invalid-resource","Could not handle resource!")}async _handleImage(e,t,i){if(Qs(e)||Zs(e))return this._handleGIFOrPNG(e,t,i);const s=Gt(e);try{let a;const o=this.resourceManager.getResource(s);if(B(o))a=o;else{const{data:p}=await this._imageRequestQueue.push(s,$({},i));a=p}if(Ks(s)){if("width"in e&&"height"in e)a.width=ne(e.width),a.height=ne(e.height);else if("cim"in e){var n;const p=e.cim;a.width=ne((n=p.width)!=null?n:p.scaleX*p.size),a.height=ne(p.size)}}if(!a.width||!a.height)return null;let l=a.width,h=a.height;e.type==="esriPMS"&&(l=Math.round(wi(a.width,Nt(e))),h=Math.round(a.height*(l/a.width)));const _="cim"in e?e.cim.colorSubstitutions:void 0,{size:d,sdf:c,image:m}=this._rasterizer.rasterizeImageResource(l,h,a,_);return this._addItemToMosaic(t,d,{type:"static",data:m},He(e),c,!1)}catch(a){if(!J(a))return new O("mapview-invalid-resource",`Could not fetch requested resource at ${s}. ${a.message}`)}}async _imageFromBlob(e){const t=window.URL.createObjectURL(e);try{const{data:i}=await this._imageRequestQueue.push(t);return window.URL.revokeObjectURL(t),i}catch(i){if(window.URL.revokeObjectURL(t),!J(i))return new O("mapview-invalid-resource",`Could not fetch requested resource at ${t}`);throw i}}_addItemToMosaic(e,t,i,s,n,a){return this._spriteMosaic.addSpriteItem(e,t,i,s,n,a)}}class Xe{constructor(){this.name=this.constructor.name}}class rn extends Xe{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(e,t){if(!t.size)return;const{context:i,renderingOptions:s}=e;this._quad||(this._quad=new fe(i,[0,0,1,0,0,1,1,1]));const n=i.getBoundFramebufferObject(),{x:a,y:o,width:l,height:h}=i.getViewport();t.bindTextures(i);const _=t.getBlock(er);if(D(_))return;const d=_.getFBO(i),c=_.getFBO(i,1);i.setViewport(0,0,t.size,t.size),this._computeDelta(e,c,s.labelsAnimationTime),this._updateAnimationState(e,c,d),i.bindFramebuffer(n),i.setViewport(a,o,l,h)}_computeDelta(e,t,i){const{context:s,painter:n,displayLevel:a}=e,o=n.materialManager.getProgram(e,this._desc,["delta"]);s.bindFramebuffer(t),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),s.useProgram(o),o.setUniform1i("u_maskTexture",tr),o.setUniform1i("u_sourceTexture",ir),o.setUniform1f("u_timeDelta",e.deltaTime),o.setUniform1f("u_animationTime",i),o.setUniform1f("u_zoomLevel",Math.round(10*a)),this._quad.draw()}_updateAnimationState(e,t,i){const{context:s,painter:n}=e,a=n.materialManager.getProgram(e,this._desc,["update"]);s.bindTexture(t.colorTexture,1),s.useProgram(a),a.setUniform1i("u_sourceTexture",1),s.bindFramebuffer(i),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),this._quad.draw()}}const nn=r=>r.replace("-","_").toUpperCase(),yi=r=>`#define ${nn(r)}
`,xi={attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:r=>({vertexShader:yi(r)+L("blend/blend.vert"),fragmentShader:yi(r)+L("blend/blend.frag")})},Ti=Te.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class an{constructor(){this._size=[0,0]}dispose(e){this._backBufferTexture&&(this._backBufferTexture.dispose(),this._backBufferTexture=null),this._programCache&&(this._programCache.dispose(),this._programCache=null),this._quad&&(this._quad.dispose(),this._quad=null)}draw(e,t,i,s,n){const{context:a,drawPhase:o}=e;if(this._setupShader(a),s&&s!=="normal"&&o!==k.LABEL)return void this._drawBlended(e,t,i,s,n);const l=this._programCache.getProgram(xi,"normal");if(!l)return void Ti.error(new O("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));a.useProgram(l),t.setSamplingMode(i),a.bindTexture(t,0),l.setUniform1i("u_layerTexture",0),l.setUniform1f("u_opacity",n),a.setBlendingEnabled(!0),a.setBlendFunction(1,771);const h=this._quad;h.draw(),h.unbind()}_drawBlended(e,t,i,s,n){const{context:a,state:o,pixelRatio:l,inFadeTransition:h}=e,{size:_}=o,d=a.getBoundFramebufferObject();let c,m;if(B(d)){const w=d.descriptor;c=w.width,m=w.height}else c=Math.round(l*_[0]),m=Math.round(l*_[1]);this._createOrResizeTexture(e,c,m);const p=this._backBufferTexture;d.copyToTexture(0,0,c,m,0,0,p),a.setStencilTestEnabled(!1),a.setStencilWriteMask(0),a.setBlendingEnabled(!0),a.setDepthTestEnabled(!1),a.setDepthWriteEnabled(!1);const u=this._programCache.getProgram(xi,s);if(!u)return void Ti.error(new O("mapview-BlendEffect",`Error creating shader program for blend mode ${s}`));a.useProgram(u),p.setSamplingMode(i),a.bindTexture(p,0),u.setUniform1i("u_backbufferTexture",0),t.setSamplingMode(i),a.bindTexture(t,1),u.setUniform1i("u_layerTexture",1),u.setUniform1f("u_opacity",n),u.setUniform1f("u_inFadeOpacity",h?1:0),a.setBlendFunction(1,0);const f=this._quad;f.draw(),f.unbind(),a.setBlendFunction(1,771)}_setupShader(e){this._programCache||(this._programCache=new Wt(e),this._quad||(this._quad=new fe(e,[-1,-1,1,-1,-1,1,1,1])))}_createOrResizeTexture(e,t,i){const{context:s}=e;this._backBufferTexture!==null&&t===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(t,i):this._backBufferTexture=new I(s,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:t,height:i}),this._size[0]=t,this._size[1]=i)}}class Fi extends Xe{constructor(e){super(),this.name=this.constructor.name,this.defines=[e]}dispose(){}bind({context:e,painter:t}){this._prev=e.getBoundFramebufferObject();const{width:i,height:s}=e.getViewport(),n=t.getFbos(i,s).effect0;e.bindFramebuffer(n),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw(e,t){const{context:i,painter:s}=e,n=s.getPostProcessingEffects(t),a=i.getBoundFramebufferObject();for(const{postProcessingEffect:o,effect:l}of n)o.draw(e,a,l);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),s.blitTexture(i,a.colorTexture,9728),i.setStencilTestEnabled(!0)}}const ft=1,on=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],ln=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Oe=256,le={outlineWidth:.7,outerHaloWidth:.7,innerHaloWidth:.7,outlinePosition:0},gt=Te.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient");function hn(r,e){e.fillColor[0]=r.color.r/255,e.fillColor[1]=r.color.g/255,e.fillColor[2]=r.color.b/255,e.fillColor[3]=r.color.a,r.haloColor?(e.outlineColor[0]=r.haloColor.r/255,e.outlineColor[1]=r.haloColor.g/255,e.outlineColor[2]=r.haloColor.b/255,e.outlineColor[3]=r.haloColor.a):(e.outlineColor[0]=e.fillColor[0],e.outlineColor[1]=e.fillColor[1],e.outlineColor[2]=e.fillColor[2],e.outlineColor[3]=e.fillColor[3]),e.fillColor[3]*=r.fillOpacity,e.outlineColor[3]*=r.haloOpacity,e.fillColor[0]*=e.fillColor[3],e.fillColor[1]*=e.fillColor[3],e.fillColor[2]*=e.fillColor[3],e.outlineColor[0]*=e.outlineColor[3],e.outlineColor[1]*=e.outlineColor[3],e.outlineColor[2]*=e.outlineColor[3],e.outlineWidth=le.outlineWidth,e.outerHaloWidth=le.outerHaloWidth,e.innerHaloWidth=le.innerHaloWidth,e.outlinePosition=le.outlinePosition}const un=[0,0,0,0];class cn{constructor(){this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:le.outlinePosition,outlineWidth:le.outlineWidth,innerHaloWidth:le.innerHaloWidth,outerHaloWidth:le.outerHaloWidth},this.shadeTexChanged=!0,this.texelData=new Uint8Array(4*Oe),this.minMaxDistance=[0,0]}setHighlightOptions(e){const t=this._convertedHighlightOptions;hn(e,t);const i=t.outlinePosition-t.outlineWidth/2-t.outerHaloWidth,s=t.outlinePosition-t.outlineWidth/2,n=t.outlinePosition+t.outlineWidth/2,a=t.outlinePosition+t.outlineWidth/2+t.innerHaloWidth,o=Math.sqrt(Math.PI/2)*ft,l=Math.abs(i)>o?Math.round(10*(Math.abs(i)-o))/10:0,h=Math.abs(a)>o?Math.round(10*(Math.abs(a)-o))/10:0;let _;l&&!h?gt.error("The outer rim of the highlight is "+l+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!l&&h?gt.error("The inner rim of the highlight is "+h+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):l&&h&&gt.error("The highlight is "+Math.max(l,h)+"px away from the edge of the feature; consider reducing some width values.");const d=[void 0,void 0,void 0,void 0];function c(p,u,f){d[0]=(1-f)*p[0]+f*u[0],d[1]=(1-f)*p[1]+f*u[1],d[2]=(1-f)*p[2]+f*u[2],d[3]=(1-f)*p[3]+f*u[3]}const{texelData:m}=this;for(let p=0;p<Oe;++p)_=i+p/(Oe-1)*(a-i),_<i?(d[4*p+0]=0,d[4*p+1]=0,d[4*p+2]=0,d[4*p+3]=0):_<s?c(un,t.outlineColor,(_-i)/(s-i)):_<n?[d[0],d[1],d[2],d[3]]=t.outlineColor:_<a?c(t.outlineColor,t.fillColor,(_-n)/(a-n)):[d[4*p+0],d[4*p+1],d[4*p+2],d[4*p+3]]=t.fillColor,m[4*p+0]=255*d[0],m[4*p+1]=255*d[1],m[4*p+2]=255*d[2],m[4*p+3]=255*d[3];this.minMaxDistance[0]=i,this.minMaxDistance[1]=a,this.shadeTexChanged=!0}applyHighlightOptions(e,t){this.shadeTex||(this.shadeTex=new I(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:Oe,height:1,samplingMode:9729})),this.shadeTexChanged&&(this.shadeTex.updateData(0,0,0,Oe,1,this.texelData),this.shadeTexChanged=!1),e.bindTexture(this.shadeTex,Xt),t.setUniform2fv("u_minMaxDistance",this.minMaxDistance)}destroy(){this.shadeTex&&(this.shadeTex.dispose(),this.shadeTex=null)}}const dn={shaders:{vertexShader:L("highlight/textured.vert"),fragmentShader:L("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},_n={shaders:{vertexShader:L("highlight/textured.vert"),fragmentShader:L("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])};class mn{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(e,t){e.bindTexture(t,Be),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",on),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()}finalBlur(e,t){e.bindTexture(t,Be),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",ln),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()}renderHighlight(e,t,i){e.bindTexture(t,Be),e.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(1,771),e.drawArrays(5,0,4),e.bindVAO()}_initialize(e,t,i){this._width=t,this._height=i;const s=ie.createVertex(e,35044,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),n=new ae(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[{name:"a_position",count:2,type:5120,offset:0,stride:4,normalized:!1},{name:"a_texcoord",count:2,type:5121,offset:2,stride:4,normalized:!1}]},{geometry:s}),a=Me(e,dn),o=Me(e,_n);a.setUniform1i("u_texture",Be),a.setUniform1i("u_shade",Xt),a.setUniform1f("u_sigma",ft),o.setUniform1i("u_texture",Be),o.setUniform1f("u_sigma",ft),this._resources={quadGeometry:s,quadVAO:n,highlightProgram:a,blurProgram:o}}setup(e,t,i){this._resources?(this._width=t,this._height=i):this._initialize(e,t,i)}}function Ei(r,e,t){const i=new I(r,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:e,height:t,samplingMode:9729});return[i,new A(r,{colorTarget:0,depthStencilTarget:2},i)]}class pn{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(e,t,i){this._width=t,this._height=i;const[s,n]=Ei(e,t,i),[a,o]=Ei(e,t,i);this._resources={sharedBlur1Tex:s,sharedBlur1Fbo:n,sharedBlur2Tex:a,sharedBlur2Fbo:o}}setup(e,t,i){!this._resources||this._width===t&&this._height===i||this.dispose(),this._resources||this._initialize(e,t,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Tex}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Tex}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}const de=4,Ye=4/de;class fn extends Xe{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new mn,this._hlGradient=new cn,this._width=void 0,this._height=void 0,this._hlSurfaces=new pn,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new ai}dispose(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}bind(e){const{context:t,painter:i}=e,{width:s,height:n}=t.getViewport(),a=i.getFbos(s,n).effect0;this.setup(e,s,n),t.bindFramebuffer(a),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:e},t,i){this._width=t,this._height=i;const s=t%de,n=i%de;t+=s<de/2?-s:de-s,i+=n<de/2?-n:de-n,this._adjustedWidth=t,this._adjustedHeight=i,this._boundFBO=e.getBoundFramebufferObject();const a=Math.round(t*Ye),o=Math.round(i*Ye);this._hlRenderer.setup(e,a,o),this._hlSurfaces.setup(e,a,o)}draw({context:e}){const t=e.getBoundFramebufferObject();e.setViewport(0,0,this._adjustedWidth*Ye,this._adjustedHeight*Ye),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setStencilTestEnabled(!1),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(e,t.colorTexture,9728,1),e.setStencilTestEnabled(!1),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!0),e.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(e,this._hlSurfaces.sharedBlur1Tex),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(e,this._hlSurfaces.sharedBlur2Tex),e.bindFramebuffer(this._boundFBO),e.setBlendingEnabled(!0),e.setColorMask(!0,!0,!0,!0),e.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(e,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}setHighlightOptions(e){this._hlGradient.setHighlightOptions(e)}}class gn extends Xe{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0}dispose(){B(this._fbo)&&this._fbo.dispose()}bind({context:e,painter:t}){const{width:i,height:s}=e.getViewport();this._boundFBO=e.getBoundFramebufferObject();const n=t.getFbos(i,s).effect0;e.bindFramebuffer(n),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind({context:e}){e.bindFramebuffer(this._boundFBO),this._boundFBO=null}draw({context:e,state:t,pixelRatio:i},s,n=sr){const a=e.getBoundFramebufferObject(),o=t.size[1]*i,l=Math.round(n*i),h=l/2,_=l/2;this._ensureBuffer(l),s.forEach((d,c)=>{const m=new Map,p=Math.floor(c.x*i-l/2),u=Math.floor(o-c.y*i-l/2);a.readPixels(p,u,l,l,6408,5121,this._buf);for(let w=0;w<this._buf32.length;w++){const b=this._buf32[w];if(b!==4294967295&&b!==0){const v=w%l,g=l-Math.floor(w/l),x=(h-v)*(h-v)+(_-g)*(_-g),y=m.has(b)?m.get(b):4294967295;m.set(b,Math.min(x,y))}}const f=Array.from(m).sort((w,b)=>w[1]-b[1]).map(w=>w[0]);d.resolve(f),s.delete(c)})}_ensureBuffer(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}const bt=5,bn=[1,0],vn=[0,1],wn=[1,.8,.6,.4,.2],yn=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class xn{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(bt),this._nMips=bt,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad&&(this._quad.dispose(),this._quad=null),this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=null),this._compositeFBO&&(this._compositeFBO.dispose(),this._compositeFBO=null),this._mipsFBOs){for(let e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}draw(e,t,i){const{width:s,height:n}=t,{context:a,painter:o}=e,{materialManager:l}=o,h=a.gl,_=this._programDesc,{strength:d,radius:c,threshold:m}=i;this._quad||(this._quad=new fe(a,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,s,n),a.setStencilTestEnabled(!1),a.setBlendingEnabled(!0),a.setBlendFunction(1,771),a.setStencilWriteMask(0);const p=this._quad;p.bind(),a.bindFramebuffer(this._intensityFBO);const u=l.getProgram(e,_.luminosityHighPass);a.useProgram(u),a.bindTexture(t.colorTexture,0),u.setUniform1i("u_texture",0),u.setUniform3fv("u_defaultColor",[0,0,0]),u.setUniform1f("u_defaultOpacity",0),u.setUniform1f("u_luminosityThreshold",m),u.setUniform1f("u_smoothWidth",.01);const f=[Math.round(s/2),Math.round(n/2)];a.setViewport(0,0,f[0],f[1]),a.setClearColor(0,0,0,0),a.clear(h.COLOR_BUFFER_BIT),p.draw(),a.setBlendingEnabled(!1);let w=this._intensityFBO.colorTexture;for(let g=0;g<this._nMips;g++){const x=l.getProgram(e,_.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[g]}]);a.useProgram(x),a.bindTexture(w,g+1),x.setUniform1i("u_colorTexture",g+1),x.setUniform2fv("u_texSize",f),x.setUniform2fv("u_direction",bn),a.setViewport(0,0,f[0],f[1]);const y=this._mipsFBOs[g];a.bindFramebuffer(y.horizontal),p.draw(),w=y.horizontal.colorTexture,a.bindFramebuffer(y.vertical),a.bindTexture(w,g+1),x.setUniform2fv("u_direction",vn),p.draw(),w=y.vertical.colorTexture,f[0]=Math.round(f[0]/2),f[1]=Math.round(f[1]/2)}a.setViewport(0,0,s,n);const b=l.getProgram(e,_.composite,[{name:"nummips",value:bt}]);a.bindFramebuffer(this._compositeFBO),a.useProgram(b),b.setUniform1f("u_bloomStrength",d),b.setUniform1f("u_bloomRadius",c),b.setUniform1fv("u_bloomFactors",wn),b.setUniform3fv("u_bloomTintColors",yn),a.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),b.setUniform1i("u_blurTexture1",1),a.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),b.setUniform1i("u_blurTexture2",2),a.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),b.setUniform1i("u_blurTexture3",3),a.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),b.setUniform1i("u_blurTexture4",4),a.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),b.setUniform1i("u_blurTexture5",5),p.draw(),a.bindFramebuffer(t),a.setBlendingEnabled(!0);const v=l.getProgram(e,_.blit);a.useProgram(v),a.bindTexture(this._compositeFBO.colorTexture,6),v.setUniform1i("u_texture",6),a.setBlendFunction(1,1),p.draw(),p.unbind(),a.setBlendFunction(1,771),a.setStencilTestEnabled(!0)}_createOrResizeResources(e,t,i){const{context:s}=e;if(this._compositeFBO&&this._size[0]===t&&this._size[1]===i)return;this._size[0]=t,this._size[1]=i;const n=[Math.round(t/2),Math.round(i/2)];this._compositeFBO?this._compositeFBO.resize(t,i):this._compositeFBO=new A(s,{colorTarget:0,depthStencilTarget:0,width:t,height:i}),this._intensityFBO?this._intensityFBO.resize(n[0],n[1]):this._intensityFBO=new A(s,{colorTarget:0,depthStencilTarget:0,width:n[0],height:n[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:n[0],height:n[1]});for(let a=0;a<this._nMips;a++)this._mipsFBOs[a]?(this._mipsFBOs[a].horizontal.resize(n[0],n[1]),this._mipsFBOs[a].vertical.resize(n[0],n[1])):this._mipsFBOs[a]={horizontal:new A(s,{colorTarget:0,depthStencilTarget:0,width:n[0],height:n[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:n[0],height:n[1]}),vertical:new A(s,{colorTarget:0,depthStencilTarget:0,width:n[0],height:n[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:n[0],height:n[1]})},n[0]=Math.round(n[0]/2),n[1]=Math.round(n[1]/2)}}const Tn=[1,0],Fn=[0,1];class En{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(e,t,i){const{context:s}=e,{type:n,radius:a}=i;if(a===0)return;this._createOrResizeResources(e),this._quad||(this._quad=new fe(s,[-1,-1,1,-1,-1,1,1,1]));const o=this._quad;o.bind(),n==="blur"?this._gaussianBlur(e,t,a):this._radialBlur(e,t),o.unbind()}_gaussianBlur(e,t,i){const{context:s,state:n,painter:a,pixelRatio:o}=e,{size:l}=n,{materialManager:h}=a,_=this._programDesc,d=this._quad,c=[Math.round(o*l[0]),Math.round(o*l[1])],m=this._blurFBO,p=h.getProgram(e,_.gaussianBlur,[{name:"radius",value:Math.ceil(i)}]);s.useProgram(p),s.setBlendingEnabled(!1),s.bindFramebuffer(m),s.bindTexture(t.colorTexture,4),p.setUniform1i("u_colorTexture",4),p.setUniform2fv("u_texSize",c),p.setUniform2fv("u_direction",Tn),p.setUniform1f("u_sigma",i),d.draw(),s.bindFramebuffer(t),s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.bindTexture(m.colorTexture,5),p.setUniform1i("u_colorTexture",5),p.setUniform2fv("u_direction",Fn),d.draw(),s.setBlendingEnabled(!0),s.setBlendFunction(1,771),s.setStencilTestEnabled(!0)}_radialBlur(e,t){const{context:i,painter:s}=e,{materialManager:n}=s,a=this._programDesc,o=this._quad,l=this._blurFBO;i.bindFramebuffer(l);const h=n.getProgram(e,a.radialBlur);i.useProgram(h),i.setBlendingEnabled(!1),i.bindTexture(t.colorTexture,4),h.setUniform1i("u_colorTexture",4),o.draw(),i.bindFramebuffer(t),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setBlendingEnabled(!0);const _=n.getProgram(e,a.blit);i.useProgram(_),i.bindTexture(l.colorTexture,5),_.setUniform1i("u_texture",5),i.setBlendFunction(1,771),o.draw()}_createOrResizeResources(e){const{context:t,state:i,pixelRatio:s}=e,{size:n}=i,a=Math.round(s*n[0]),o=Math.round(s*n[1]);this._blurFBO&&this._size[0]===a&&this._size[1]===o||(this._size[0]=a,this._size[1]=o,this._blurFBO?this._blurFBO.resize(a,o):this._blurFBO=new A(t,{colorTarget:0,depthStencilTarget:0,width:a,height:o},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:a,height:o}))}}class Sn{constructor(){this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}draw(e,t,i){const{width:s,height:n}=t;this._createOrResizeResources(e,s,n);const{context:a,painter:o}=e,{materialManager:l}=o,h=this._programDesc,_=this._quad,d=i.colorMatrix;_.bind();const c=this._layerFBOTexture;a.bindFramebuffer(t),t.copyToTexture(0,0,s,n,0,0,c),a.setBlendingEnabled(!1),a.setStencilTestEnabled(!1);const m=l.getProgram(e,h);a.useProgram(m),a.bindTexture(c,2),m.setUniformMatrix4fv("u_coefficients",d),m.setUniform1i("u_colorTexture",2),_.draw(),a.setBlendingEnabled(!0),a.setBlendFunction(1,771),a.setStencilTestEnabled(!0),_.unbind()}_createOrResizeResources(e,t,i){const{context:s}=e;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new I(s,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:t,height:i}),this._quad||(this._quad=new fe(s,[-1,-1,1,-1,-1,1,1,1])))}}const Mn=[1,0],Cn=[0,1];class Bn{constructor(){this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._programDesc={blur:{vsPath:"post-processing/drop-shadow",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null),this._horizontalBlurFBO&&(this._horizontalBlurFBO.dispose(),this._horizontalBlurFBO=null),this._verticalBlurFBO&&(this._verticalBlurFBO.dispose(),this._verticalBlurFBO=null)}draw(e,t,i){const{context:s,state:n,painter:a}=e,{materialManager:o}=a,l=this._programDesc,h=t.width,_=t.height,d=[Math.round(h/2),Math.round(_/2)],{blurRadius:c,offsetX:m,offsetY:p,color:u}=i,f=[ne(m/2),ne(p/2)];this._createOrResizeResources(e,h,_,d);const w=this._horizontalBlurFBO,b=this._verticalBlurFBO;s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1);const v=this._layerFBOTexture;t.copyToTexture(0,0,h,_,0,0,v),this._quad||(this._quad=new fe(s,[-1,-1,1,-1,-1,1,1,1])),s.setViewport(0,0,d[0],d[1]);const g=this._quad;g.bind(),s.setBlendingEnabled(!1);const x=o.getProgram(e,l.blur,[{name:"radius",value:Math.ceil(c)}]);s.useProgram(x),s.bindFramebuffer(w),s.bindTexture(t.colorTexture,4),x.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),x.setUniform2fv("u_offset",f),x.setUniform1i("u_colorTexture",4),x.setUniform2fv("u_texSize",d),x.setUniform2fv("u_direction",Mn),x.setUniform1f("u_sigma",c),g.draw(),s.bindFramebuffer(b),s.bindTexture(w.colorTexture,5),x.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),x.setUniform2fv("u_offset",[0,0]),x.setUniform1i("u_colorTexture",5),x.setUniform2fv("u_direction",Cn),g.draw(),s.bindFramebuffer(t),s.setViewport(0,0,h,_);const y=o.getProgram(e,l.composite);s.useProgram(y),s.bindTexture(b.colorTexture,2),y.setUniform1i("u_blurTexture",2),s.bindTexture(v,3),y.setUniform1i("u_layerFBOTexture",3),y.setUniform4fv("u_shadowColor",[u[3]*(u[0]/255),u[3]*(u[1]/255),u[3]*(u[2]/255),u[3]]),g.draw(),s.setBlendingEnabled(!0),s.setStencilTestEnabled(!0),s.setBlendFunction(1,771),g.unbind()}_createOrResizeResources(e,t,i,s){const{context:n}=e;this._horizontalBlurFBO&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._horizontalBlurFBO?this._horizontalBlurFBO.resize(s[0],s[1]):this._horizontalBlurFBO=new A(n,{colorTarget:0,depthStencilTarget:0,width:s[0],height:s[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:s[0],height:s[1]}),this._verticalBlurFBO?this._verticalBlurFBO.resize(s[0],s[1]):this._verticalBlurFBO=new A(n,{colorTarget:0,depthStencilTarget:0,width:s[0],height:s[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:s[0],height:s[1]}),this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new I(n,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:t,height:i}))}}class Rn{constructor(){this._size=[0,0]}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}draw(e,t,i){const{width:s,height:n}=t;this._createOrResizeResources(e,s,n);const{context:a,painter:o}=e,{amount:l}=i,h=a.gl,_=this._layerFBOTexture;a.bindFramebuffer(t),t.copyToTexture(0,0,s,n,0,0,_),a.setBlendingEnabled(!0),a.setStencilTestEnabled(!1),a.setDepthTestEnabled(!1),a.setClearColor(0,0,0,0),a.clear(h.COLOR_BUFFER_BIT),o.blitTexture(a,_,9728,l)}_createOrResizeResources(e,t,i){const{context:s}=e;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new I(s,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!1,width:t,height:i}))}}function On(r){switch(r){case"bloom":case"blur":case"opacity":case"drop-shadow":return r;default:return"colorize"}}const Pn={colorize:()=>new Sn,blur:()=>new En,bloom:()=>new xn,opacity:()=>new Rn,"drop-shadow":()=>new Bn};class An{constructor(e){this._requestRender=e,this._effectMap=new Map}dispose(){this._requestRender&&(this._requestRender=null),this._effectMap.forEach(e=>e.dispose()),this._effectMap.clear()}getPostProcessingEffects(e){if(!e||e.length===0)return[];const t=[];for(const i of e){const s=On(i.type);let n=this._effectMap.get(s);n||(n=Pn[s](),this._effectMap.set(s,n)),t.push({postProcessingEffect:n,effect:i})}return t}}class Dn{constructor(e,t){var i;this.brushes=e,this.name=t.name,this.drawPhase=t.drawPhase||k.MAP,this._targetFn=t.target,this.effects=t.effects||[],this.enableDefaultDraw=(i=t.enableDefaultDraw)!=null?i:()=>!0}render(e){const{context:t,profiler:i}=e,s=this._targetFn(),n=this.drawPhase&e.drawPhase;if(i.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(e,s),i.recordPassEnd();for(const a of this.effects){if(!a.enable())continue;const o=a.apply;i.recordPassStart(this.name+"."+o.name),i.recordBrushStart(o.name);const l=a.args&&a.args(),{x:h,y:_,width:d,height:c}=t.getViewport(),m=t.getBoundFramebufferObject();o.bind(e,l),this._doRender(e,s,o.defines),o.draw(e,l),o.unbind(e,l),t.bindFramebuffer(m),t.setViewport(h,_,d,c),i.recordBrushEnd(),i.recordPassEnd()}}}_doRender(e,t,i){if(!D(t))if(ls(t)){for(const s of t)if(s.visible)for(const n of this.brushes)e.profiler.recordBrushStart(n.name),n.prepareState(e,s,i),n.draw(e,s,i),e.profiler.recordBrushEnd()}else for(const s of this.brushes)e.profiler.recordBrushStart(s.name),s.prepareState(e,t,i),s.draw(e,t,i),e.profiler.recordBrushEnd()}}const In={[je.FILL]:ge.fill,[je.LINE]:ge.line,[je.MARKER]:ge.marker,[je.TEXT]:ge.text};class zn{constructor(e,t,i){this.context=e,this._blitRenderer=new ai,this._brushCache=new Map,this._vtlMaterialManager=new Tr,this._blendEffect=new an,this.effects={highlight:new fn,hittest:new gn,integrate:new rn,insideEffect:new Fi("inside"),outsideEffect:new Fi("outside")},this.materialManager=new Cr(e),this.textureManager=new sn(t,i),this._effectsManager=new An(t)}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getRenderTarget(){return this._renderTarget}setRenderTarget(e){this._renderTarget=e}getFbos(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(const a in this._fbos)this._fbos[a].resize(e,t);return this._fbos}const i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,height:t},s={colorTarget:0,depthStencilTarget:3},n=new Gs(this.context,{width:e,height:t,internalFormat:34041});this._stencilBuf=n,this._fbos={output:new A(this.context,s,i,n),blend:new A(this.context,s,i,n),effect0:new A(this.context,s,i,n)}}return this._fbos}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderLayers(e,t=null){const{width:i,height:s}=e.getViewport();this._prevFBO=e.getBoundFramebufferObject();const n=this.getFbos(i,s);if(e.bindFramebuffer(n.output),e.setColorMask(!0,!0,!0,!0),e.setDepthWriteEnabled(!0),B(t)){const{r:a,g:o,b:l,a:h}=t.color;e.setClearColor(h*a/255,h*o/255,h*l/255,h)}else e.setClearColor(0,0,0,0);e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)}beforeRenderLayer(e,t,i){const{context:s,blendMode:n,effects:a,requireFBO:o,drawPhase:l}=e;if(o||Si(l,n,a,i))s.bindFramebuffer(this._fbos.blend),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.setDepthWriteEnabled(!0),s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1);else{const h=this._getOutputFBO();s.bindFramebuffer(h)}s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setClearStencil(t),s.setStencilWriteMask(255),s.clear(s.gl.STENCIL_BUFFER_BIT)}compositeLayer(e,t){const{context:i,blendMode:s,effects:n,requireFBO:a,drawPhase:o}=e;if(a||Si(o,s,n,t)){B(n)&&n.length>0&&o===k.MAP&&this._applyEffects(e,n);const l=this._getOutputFBO();i.bindFramebuffer(l),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(1,771,1,771),i.setColorMask(!0,!0,!0,!0);const h=D(s)||o===k.HIGHLIGHT?"normal":s;this._blendEffect.draw(e,this._fbos.blend.colorTexture,9728,h,t)}}renderLayers(e){if(e.bindFramebuffer(this._prevFBO),!this._fbos)return;const t=this._getOutputFBO();e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),this.blitTexture(e,t.colorTexture,9728)}dispose(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();if(this.effects)for(const e in this.effects)this.effects[e]&&this.effects[e].dispose();this._effectsManager.dispose(),this._vtlMaterialManager&&(this._vtlMaterialManager.dispose(),this._vtlMaterialManager=null),this._prevFBO=null}getGeometryBrush(e){const t=In[e];let i=this._brushCache.get(t);return i===void 0&&(i=new t,this._brushCache.set(t,i)),this._brushCache.get(t)}renderObject(e,t,i,s){const n=ge[i];if(!n)return null;let a=this._brushCache.get(n);a===void 0&&(a=new n,this._brushCache.set(n,a)),a.prepareState(e,t,s),a.draw(e,t,s)}renderObjects(e,t,i,s){const n=ge[i];if(!n)return null;let a=this._brushCache.get(n);a===void 0&&(a=new n,this._brushCache.set(n,a)),a.drawMany(e,t,s)}registerRenderPass(e){const t=e.brushes.map(i=>(this._brushCache.has(i)||this._brushCache.set(i,new i),this._brushCache.get(i)));return new Dn(t,e)}setHighlightOptions(e){this.effects.highlight.setHighlightOptions(e)}blitTexture(e,t,i,s=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,i,s)}getPostProcessingEffects(e){return this._effectsManager.getPostProcessingEffects(e)}_getOutputFBO(){return this._renderTarget!=null?this._renderTarget:this._fbos.output}_applyEffects(e,t){const{context:i}=e,s=this._effectsManager.getPostProcessingEffects(t);for(const{postProcessingEffect:n,effect:a}of s)i.bindFramebuffer(this._fbos.blend),n.draw(e,this._fbos.blend,a)}}function Si(r,e,t,i){return r!==k.HIGHLIGHT&&(i!==1||B(e)&&e!=="normal"||B(t)&&t.length>0)}class Mi{constructor(e,t,i,s,n,a,o,l){this.createQuery=e,this.resultAvailable=t,this.getResult=i,this.disjoint=s,this.beginTimeElapsed=n,this.endTimeElapsed=a,this.createTimestamp=o,this.timestampBits=l}}function Ci(r,e){if(e.disjointTimerQuery)return null;let t=r.getExtension("EXT_disjoint_timer_query_webgl2");return t&&H(r)?new Mi(()=>r.createQuery(),i=>r.getQueryParameter(i,r.QUERY_RESULT_AVAILABLE),i=>r.getQueryParameter(i,r.QUERY_RESULT),()=>r.getParameter(t.GPU_DISJOINT_EXT),i=>r.beginQuery(t.TIME_ELAPSED_EXT,i),()=>r.endQuery(t.TIME_ELAPSED_EXT),i=>t.queryCounterEXT(i,t.TIMESTAMP_EXT),()=>r.getQuery(t.TIMESTAMP_EXT,t.QUERY_COUNTER_BITS_EXT)):(t=r.getExtension("EXT_disjoint_timer_query"),t?new Mi(()=>t.createQueryEXT(),i=>t.getQueryObjectEXT(i,t.QUERY_RESULT_AVAILABLE_EXT),i=>t.getQueryObjectEXT(i,t.QUERY_RESULT_EXT),()=>r.getParameter(t.GPU_DISJOINT_EXT),i=>t.beginQueryEXT(t.TIME_ELAPSED_EXT,i),()=>t.endQueryEXT(t.TIME_ELAPSED_EXT),i=>t.queryCounterEXT(i,t.TIMESTAMP_EXT),()=>t.getQueryEXT(t.TIMESTAMP_EXT,t.QUERY_COUNTER_BITS_EXT)):null)}const j=$e("esri-2d-profiler");class Un{constructor(e,t){if(this._events=new hs,this._entries=new Map,this._timings=new ar(10),!j)return;this._ext=Ci(e.gl,{}),this._debugOutput=t;const i=e.gl;if(this.enableCommandLogging){for(const s in i)if(typeof i[s]=="function"){const n=i[s],a=s.indexOf("draw")!==-1;i[s]=(...o)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:s,args:o,isDrawCommand:a}),this._currentSummary&&(this._currentSummary.commands++,a&&this._currentSummary.drawCommands++),n.apply(i,o))}}}get enableCommandLogging(){return!(typeof j=="object"&&j.disableCommands)}recordContainerStart(e){j&&(this._currentContainer=e)}recordContainerEnd(){j&&(this._currentContainer=null)}recordPassStart(e){j&&(this._currentPass=e,this._initSummary())}recordPassEnd(){j&&(this._currentPass=null,this._emitSummary())}recordBrushStart(e){j&&(this._currentBrush=e)}recordBrushEnd(){j&&(this._currentBrush=null)}recordStart(e){if(j&&B(this._ext)){if(this._entries.has(e)){const i=this._entries.get(e),s=this._ext.resultAvailable(i.query),n=this._ext.disjoint();if(s&&!n){const a=this._ext.getResult(i.query)/1e6;let o=0;if(B(this._timings.enqueue(a))){const _=this._timings.entries,d=_.length;let c=0;for(const m of _)c+=m;o=c/d}const l=a.toFixed(2),h=o?o.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${e}, ${l} ms (${h} last 10 avg)
${i.commandsLen} Commands (${i.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(i.summaries),console.log("Commands: ",i.commands),console.groupEnd()):console.log(`Frame report for ${e}, ${l} ms (${h} last 10 avg)`),this._debugOutput.innerHTML=`${l} (${h})`}for(const a of i.handles)a.remove();this._entries.delete(e)}const t={name:e,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(t.handles.push(this._events.on("command",i=>{t.commandsLen++,t.commands.push(i),i.isDrawCommand&&t.drawCommands++})),t.handles.push(this._events.on("summary",i=>{t.summaries.push(i)}))),this._ext.beginTimeElapsed(t.query),this._entries.set(e,t)}}recordEnd(e){j&&B(this._ext)&&this._entries.has(e)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._events.emit("summary",this._currentSummary)}}const Bi={shaders:{vertexShader:L("stencil/stencil.vert"),fragmentShader:L("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])};class $n{constructor(e){this._allocations=new Map,e?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(e){this._allocations.set(e,new Error().stack)}remove(e){this._allocations.delete(e)}print(){if(this._allocations.size>0){console.log(`${this._allocations.size} live object allocations:`);const e=new Map;this._allocations.forEach(t=>{var i;e.set(t,((i=e.get(t))!=null?i:0)+1)}),e.forEach((t,i)=>{const s=i.split(`
`);s.shift(),s.shift(),console.log(`${t}: ${s.shift()}`),s.forEach(n=>console.log("   ",n))})}}}const kn=!1;class Ln{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new $n(kn);this._current.length<nt.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(e,t){const i=++this._current[e];this._max[e]=Math.max(i,this._max[e]),this._allocations.add(t)}decrement(e,t){--this._current[e],this._allocations.remove(t)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce((e,t)=>e+t,0)}printResourceCount(){if(this.total>0){console.log("Live objects:");for(let e=0;e<nt.COUNT;++e){const t=this._current[e];t>0&&console.log(`${nt[e]}: ${t}`)}}this._allocations.print()}}function Ri(r,e){const t=new A(r,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1});function i(w,b){const v=new Ee(r,`

  precision highp float;

  attribute vec2 position;

  uniform vec3 u_highA;
  uniform vec3 u_lowA;
  uniform vec3 u_highB;
  uniform vec3 u_lowB;

  varying vec4 v_color;

  ${e?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}

  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION

  vec3 dpPlusFrc(vec3 a, vec3 b) {
    return mix(a, a + b, vec3(notEqual(b, vec3(0))));
  }

  vec3 dpMinusFrc(vec3 a, vec3 b) {
    return mix(vec3(0), a - b, vec3(notEqual(a, b)));
  }

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = dpPlusFrc(hiA, hiB);
    vec3 e = dpMinusFrc(t1, hiA);
    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
    return t1 + t2;
  }

  #else

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = hiA + hiB;
    vec3 e = t1 - hiA;
    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
    return t1 + t2;
  }

  #endif

  const float MAX_RGBA_FLOAT =
    255.0 / 256.0 +
    255.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 / 256.0;

  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);

  vec4 float2rgba(const float value) {
    // Make sure value is in the domain we can represent
    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);

    // Decompose value in 32bit fixed point parts represented as
    // uint8 rgba components. Decomposition uses the fractional part after multiplying
    // by a power of 256 (this removes the bits that are represented in the previous
    // component) and then converts the fractional part to 8bits.
    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);

    // Convert uint8 values (from 0 to 255) to floating point representation for
    // the shader
    const float toU8AsFloat = 1.0 / 255.0;

    return fixedPointU8 * toU8AsFloat;
  }

  void main() {
    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);

    v_color = float2rgba(val.z / 25.0);

    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
  }
  `,`
  precision highp float;

  varying vec4 v_color;

  void main() {
    gl_FragColor = v_color;
  }
  `,new Map([["position",0]])),g=new Float32Array(6);Qt(w,g,3);const x=new Float32Array(6);return Qt(b,x,3),r.useProgram(v),v.setUniform3f("u_highA",g[0],g[2],g[4]),v.setUniform3f("u_lowA",g[1],g[3],g[5]),v.setUniform3f("u_highB",x[0],x[2],x[4]),v.setUniform3f("u_lowB",x[1],x[3],x[5]),v}const s=ie.createVertex(r,35044,new Uint16Array([0,0,1,0,0,1,1,1])),n=new ae(r,new Map([["position",0]]),{geometry:[{name:"position",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:s}),a=st(5633261287538229e-9,2626832878767164e-9,1.4349880495278358e6),o=st(563327146742708e-8,2.6268736381334523e6,1434963231608387e-9),l=i(a,o),h=r.getBoundFramebufferObject(),{x:_,y:d,width:c,height:m}=r.getViewport();r.bindFramebuffer(t),r.setViewport(0,0,1,1),r.bindVAO(n),r.drawArrays(5,0,4);const p=new Uint8Array(4);t.readPixels(0,0,1,1,6408,5121,p),l.dispose(),n.dispose(!1),s.dispose(),t.dispose(),r.setViewport(_,d,c,m),r.bindFramebuffer(h);const u=(a[2]-o[2])/25,f=Vs(p);return Math.abs(u-f)}var Oi,Pi,Ai,Di={exports:{}};function Vn(r){var e,t,i,s,n;if(!r.gl)return!1;if(r.webglVersion==="webgl")return((s=r.capabilities.textureFloat)==null?void 0:s.textureFloat)&&((n=r.capabilities.colorBufferFloat)==null?void 0:n.textureFloat);if(!(((e=r.capabilities.textureFloat)==null?void 0:e.textureFloat)&&((t=r.capabilities.colorBufferFloat)==null?void 0:t.textureFloat)&&((i=r.capabilities.colorBufferFloat)==null?void 0:i.floatBlend)))return!1;const a=new A(r,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5126,internalFormat:34836,samplingMode:9728,width:1,height:1}),o=ie.createVertex(r,35044,new Uint16Array([0,0,1,0,0,1,1,1])),l=new ae(r,new Map([["a_pos",0]]),{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:o}),h=new Ee(r,`
  precision highp float;
  attribute vec2 a_pos;

  void main() {
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,`
   precision highp float;

   void main() {
    gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
   }
  `,new Map([["a_pos",0]]));r.useProgram(h);const _=r.getBoundFramebufferObject(),{x:d,y:c,width:m,height:p}=r.getViewport();r.bindFramebuffer(a),r.setViewport(0,0,1,1),r.bindVAO(l),r.drawArrays(5,0,4);const u=or({blending:lr});r.setPipelineState(u),r.drawArrays(5,0,4),Di.exports.init(r);const f=r.gl.getError();return r.setViewport(d,c,m,p),r.bindFramebuffer(_),h.dispose(),l.dispose(!1),o.dispose(),a.dispose(),f!==1282||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}Oi=Di,Pi=function(){var r=function(u){window.console&&window.console.log&&window.console.log(u)},e=function(u){window.console&&window.console.error?window.console.error(u):r(u)},t={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},i=null,s=null;function n(u){if(i==null)for(var f in i={},s={},u)typeof u[f]=="number"&&(i[u[f]]=f,s[f]=u[f])}function a(){if(i==null)throw"WebGLDebugUtils.init(ctx) not called"}function o(u){return a(),i[u]!==void 0}function l(u){a();var f=i[u];return f!==void 0?"gl."+f:"/*UNKNOWN WebGL ENUM*/ 0x"+u.toString(16)}function h(u,f,w,b){var v;if((v=t[u])!==void 0&&(v=v[f])!==void 0&&v[w]){if(typeof v[w]=="object"&&v[w].enumBitwiseOr!==void 0){for(var g=v[w].enumBitwiseOr,x=0,y=[],C=0;C<g.length;++C){var F=s[g[C]];(b&F)!=0&&(x|=F,y.push(l(F)))}return x===b?y.join(" | "):l(b)}return l(b)}return b===null?"null":b===void 0?"undefined":b.toString()}function _(u,f){for(var w="",b=f.length,v=0;v<b;++v)w+=(v==0?"":", ")+h(u,b,v,f[v]);return w}function d(u,f,w){u.__defineGetter__(w,function(){return f[w]}),u.__defineSetter__(w,function(b){f[w]=b})}function c(u,f,w,b){b=b||u,n(u),f=f||function(F,S,W){for(var X="",Y=W.length,se=0;se<Y;++se)X+=(se==0?"":", ")+h(S,Y,se,W[se]);e("WebGL error "+l(F)+" in "+S+"("+X+")")};var v={};function g(F,S){return function(){w&&w(S,arguments);var W=F[S].apply(F,arguments),X=b.getError();return X!=0&&(v[X]=!0,f(X,S,arguments)),W}}var x={};for(var y in u)if(typeof u[y]=="function")if(y!="getExtension")x[y]=g(u,y);else{var C=g(u,y);x[y]=function(){return c(C.apply(u,arguments),f,w,b)}}else d(x,u,y);return x.getError=function(){for(var F in v)if(v.hasOwnProperty(F)&&v[F])return v[F]=!1,F;return u.NO_ERROR},x}function m(u){var f=u.getParameter(u.MAX_VERTEX_ATTRIBS),w=u.createBuffer();u.bindBuffer(u.ARRAY_BUFFER,w);for(var b=0;b<f;++b)u.disableVertexAttribArray(b),u.vertexAttribPointer(b,4,u.FLOAT,!1,0,0),u.vertexAttrib1f(b,0);u.deleteBuffer(w);var v=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS);for(b=0;b<v;++b)u.activeTexture(u.TEXTURE0+b),u.bindTexture(u.TEXTURE_CUBE_MAP,null),u.bindTexture(u.TEXTURE_2D,null);for(u.activeTexture(u.TEXTURE0),u.useProgram(null),u.bindBuffer(u.ARRAY_BUFFER,null),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,null),u.bindFramebuffer(u.FRAMEBUFFER,null),u.bindRenderbuffer(u.RENDERBUFFER,null),u.disable(u.BLEND),u.disable(u.CULL_FACE),u.disable(u.DEPTH_TEST),u.disable(u.DITHER),u.disable(u.SCISSOR_TEST),u.blendColor(0,0,0,0),u.blendEquation(u.FUNC_ADD),u.blendFunc(u.ONE,u.ZERO),u.clearColor(0,0,0,0),u.clearDepth(1),u.clearStencil(-1),u.colorMask(!0,!0,!0,!0),u.cullFace(u.BACK),u.depthFunc(u.LESS),u.depthMask(!0),u.depthRange(0,1),u.frontFace(u.CCW),u.hint(u.GENERATE_MIPMAP_HINT,u.DONT_CARE),u.lineWidth(1),u.pixelStorei(u.PACK_ALIGNMENT,4),u.pixelStorei(u.UNPACK_ALIGNMENT,4),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),u.UNPACK_COLORSPACE_CONVERSION_WEBGL&&u.pixelStorei(u.UNPACK_COLORSPACE_CONVERSION_WEBGL,u.BROWSER_DEFAULT_WEBGL),u.polygonOffset(0,0),u.sampleCoverage(1,!1),u.scissor(0,0,u.canvas.width,u.canvas.height),u.stencilFunc(u.ALWAYS,0,4294967295),u.stencilMask(4294967295),u.stencilOp(u.KEEP,u.KEEP,u.KEEP),u.viewport(0,0,u.canvas.width,u.canvas.height),u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT|u.STENCIL_BUFFER_BIT);u.getError(););}function p(u){var f,w,b=[],v=[],g={},x=1,y=!1,C=[],F=0,S=0,W=!1,X=0,Y={};function se(T){return typeof T=="function"?T:function(E){T.handleEvent(E)}}u.getContext=(w=u.getContext,function(){var T=w.apply(u,arguments);if(T instanceof WebGLRenderingContext){if(T!=f){if(f)throw"got different context";g=Xi(f=T)}return g}return T});var Ni=function(T){b.push(se(T))},Gi=function(T){v.push(se(T))};function Wi(T){var E=T.addEventListener;T.addEventListener=function(z,U,K){switch(z){case"webglcontextlost":Ni(U);break;case"webglcontextrestored":Gi(U);break;default:E.apply(T,arguments)}}}function Hi(){for(var T=Object.keys(Y),E=0;E<T.length;++E)delete Y[T]}function re(){++S,y||F==S&&u.loseContext()}function ji(T,E){var z=T[E];return function(){if(re(),!y)return z.apply(T,arguments)}}function qi(){for(var T=0;T<C.length;++T){var E=C[T];E instanceof WebGLBuffer?f.deleteBuffer(E):E instanceof WebGLFramebuffer?f.deleteFramebuffer(E):E instanceof WebGLProgram?f.deleteProgram(E):E instanceof WebGLRenderbuffer?f.deleteRenderbuffer(E):E instanceof WebGLShader?f.deleteShader(E):E instanceof WebGLTexture&&f.deleteTexture(E)}}function Et(T){return{statusMessage:T,preventDefault:function(){W=!0}}}return Wi(u),u.loseContext=function(){if(!y){for(y=!0,F=0,++x;f.getError(););Hi(),Y[f.CONTEXT_LOST_WEBGL]=!0;var T=Et("context lost"),E=b.slice();setTimeout(function(){for(var z=0;z<E.length;++z)E[z](T);X>=0&&setTimeout(function(){u.restoreContext()},X)},0)}},u.restoreContext=function(){y&&v.length&&setTimeout(function(){if(!W)throw"can not restore. webglcontestlost listener did not call event.preventDefault";qi(),m(f),y=!1,S=0,W=!1;for(var T=v.slice(),E=Et("context restored"),z=0;z<T.length;++z)T[z](E)},0)},u.loseContextInNCalls=function(T){if(y)throw"You can not ask a lost contet to be lost";F=S+T},u.getNumCalls=function(){return S},u.setRestoreTimeout=function(T){X=T},u;function Xi(T){for(var E in T)typeof T[E]=="function"?g[E]=ji(T,E):d(g,T,E);g.getError=function(){if(re(),!y)for(;P=f.getError();)Y[P]=!0;for(var P in Y)if(Y[P])return delete Y[P],P;return g.NO_ERROR};for(var z=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],U=0;U<z.length;++U){var K=z[U];g[K]=function(P){return function(){if(re(),y)return null;var it=P.apply(T,arguments);return it.__webglDebugContextLostId__=x,C.push(it),it}}(T[K])}var St=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(U=0;U<St.length;++U)K=St[U],g[K]=function(P){return function(){return re(),y?null:P.apply(T,arguments)}}(g[K]);var Mt=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(U=0;U<Mt.length;++U)K=Mt[U],g[K]=function(P){return function(){return re(),!y&&P.apply(T,arguments)}}(g[K]);return g.checkFramebufferStatus=function(P){return function(){return re(),y?g.FRAMEBUFFER_UNSUPPORTED:P.apply(T,arguments)}}(g.checkFramebufferStatus),g.getAttribLocation=function(P){return function(){return re(),y?-1:P.apply(T,arguments)}}(g.getAttribLocation),g.getVertexAttribOffset=function(P){return function(){return re(),y?0:P.apply(T,arguments)}}(g.getVertexAttribOffset),g.isContextLost=function(){return y},g}}return{init:n,mightBeEnum:o,glEnumToString:l,glFunctionArgToString:h,glFunctionArgsToString:_,makeDebugContext:c,makeLostContextSimulatingCanvas:p,resetToInitialState:m}},(Ai=Pi())!==void 0&&(Oi.exports=Ai);const Nn=Te.getLogger("esri.views.WebGLDriverTest"),Gn=r=>{const e=new A(r,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),t=`
precision highp float;
attribute vec2 a_pos;
uniform highp sampler2D u_texture;
varying vec4 v_color;

float getBit(in float bitset, in int bitIndex) {
  float offset = pow(2.0, float(bitIndex));
  return mod(floor(bitset / offset), 2.0);
}

void main() {
  vec4 value = texture2D(u_texture, vec2(0.0));
  float bit = getBit(value.x * 255.0, 1);

  v_color = bit * vec4(1.0);
  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,i=`
precision highp float;
varying vec4 v_color;

void main() {
  gl_FragColor = v_color;
}
`,s=new Uint8Array(4),n=ie.createVertex(r,35044,new Uint16Array([0,0,1,0,0,1,1,1])),a=new ae(r,new Map([["a_position",0]]),{geometry:[{name:"a_position",count:2,type:5122,offset:0,stride:4,normalized:!1}]},{geometry:n}),o=new Ee(r,t,i,new Map([["a_pos",0]])),l=new I(r,{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([2,255,0,0]));o.setUniform1i("u_texture",0),r.bindTexture(l,0);const h=r.getBoundFramebufferObject();r.bindFramebuffer(e),r.useProgram(o);const{x:_,y:d,width:c,height:m}=r.getViewport();r.setViewport(0,0,1,1),r.bindVAO(a),r.drawArrays(5,0,4),r.setViewport(_,d,c,m),e.readPixels(0,0,1,1,6408,5121,s),o.dispose(),a.dispose(!1),n.dispose(),e.dispose();const p=s[0]!==255||s[1]!==255||s[2]!==255||s[3]!==255;return p&&Nn.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${s[0]}.${s[1]}.${s[2]}.${s[3]}]`),r.bindFramebuffer(h),p};async function Wn(r){const e=new Image;if(e.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",e.width=5,e.height=5,await e.decode(),!r.gl)return!0;const t=new A(r,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),i=ie.createVertex(r,35044,new Uint16Array([0,0,1,0,0,1,1,1])),s=new ae(r,new Map([["a_pos",0]]),{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:i}),n=new Ee(r,`
  precision highp float;

  attribute vec2 a_pos;
  varying vec2 v_uv;

  void main() {
    v_uv = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,`
  precision highp float;

  varying vec2 v_uv;
  uniform sampler2D u_texture;

  void main() {
    gl_FragColor = texture2D(u_texture, v_uv);
  }
  `,new Map([["a_pos",0]]));r.useProgram(n);const a=new I(r,{dataType:5121,pixelFormat:6408,preMultiplyAlpha:!1,wrapMode:33071,samplingMode:9729},e);r.bindTexture(a,0),n.setUniform1i("u_texture",0);const o=r.getBoundFramebufferObject(),{x:l,y:h,width:_,height:d}=r.getViewport();r.bindFramebuffer(t),r.setViewport(0,0,1,1),r.setClearColor(0,0,0,0),r.setBlendingEnabled(!1),r.clearSafe(16384),r.bindVAO(s),r.drawArrays(5,0,4);const c=new Uint8Array(4);return t.readPixels(0,0,1,1,6408,5121,c),n.dispose(),s.dispose(!1),i.dispose(),t.dispose(),a.dispose(),r.setViewport(l,h,_,d),r.bindFramebuffer(o),e.src="",c[0]===255}class Hn{constructor(e){this.context=e,this._floatBufferBlendWorking=Vn(e),Wn(e).then(t=>this._svgAlwaysPremultipliesAlpha=!t)}get floatBufferBlendWorking(){if(D(this._floatBufferBlendWorking))throw new Error("floatBufferBlendWorking test not yet available");return this._floatBufferBlendWorking}get svgAlwaysPremultipliesAlpha(){if(D(this._svgAlwaysPremultipliesAlpha))throw new Error("svgAlwaysPremultipliesAlpha test not yet available");return this._svgAlwaysPremultipliesAlpha}get doublePrecisionRequiresObfuscation(){if(D(this._doublePrecisionRequiresObfuscation)){const e=Ri(this.context,!1),t=Ri(this.context,!0);this._doublePrecisionRequiresObfuscation=e!==0&&(t===0||e/t>5)}return this._doublePrecisionRequiresObfuscation}get ignoresSamplerPrecision(){return D(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=Gn(this.context)),this._ignoresSamplerPrecision}}function jn(r,e){if(e.disjointTimerQuery)return null;if(H(r))return{drawBuffers:r.drawBuffers.bind(r),MAX_DRAW_BUFFERS:r.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:r.MAX_COLOR_ATTACHMENTS};if(e.drawBuffers)return null;const t=r.getExtension("WEBGL_draw_buffers");return t?{drawBuffers:t.drawBuffersWEBGL.bind(t),MAX_DRAW_BUFFERS:t.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:t.MAX_COLOR_ATTACHMENTS_WEBGL}:null}function qn(r){if(H(r))return{drawArraysInstanced:r.drawArraysInstanced.bind(r),drawElementsInstanced:r.drawElementsInstanced.bind(r),vertexAttribDivisor:r.vertexAttribDivisor.bind(r)};const e=r.getExtension("ANGLE_instanced_arrays");return e?{drawArraysInstanced:e.drawArraysInstancedANGLE.bind(e),drawElementsInstanced:e.drawElementsInstancedANGLE.bind(e),vertexAttribDivisor:e.vertexAttribDivisorANGLE.bind(e)}:null}function Xn(r,e){const t=e.loseContext&&r.getExtension("WEBGL_lose_context");return t?{loseRenderingContext:()=>t.loseContext()}:null}function Yn(r,e){if(H(r))return{createVertexArray:r.createVertexArray.bind(r),deleteVertexArray:r.deleteVertexArray.bind(r),bindVertexArray:r.bindVertexArray.bind(r)};if(e.vao)return null;const t=r.getExtension("OES_vertex_array_object")||r.getExtension("MOZ_OES_vertex_array_object")||r.getExtension("WEBKIT_OES_vertex_array_object");return t?{createVertexArray:t.createVertexArrayOES.bind(t),deleteVertexArray:t.deleteVertexArrayOES.bind(t),bindVertexArray:t.bindVertexArrayOES.bind(t)}:null}function Qn(r,e){const t=e.disabledExtensions||{},i=e.debugWebGLExtensions||{};let s,n,a,o,l,h,_,d,c,m,p,u,f=null,w=null,b=null,v=null;return{get drawBuffers(){return p||(p=jn(r,t)),p},get instancing(){return s||(s=qn(r)),s},get vao(){return n||(n=Yn(r,t)),n},get compressedTextureETC(){return a||(a=Zn(r,t)),a},get compressedTextureS3TC(){return o||(o=Kn(r,t)),o},get textureFilterAnisotropic(){return l||(l=ea(r,t)),l},get disjointTimerQuery(){return h||(h=Ci(r,t)),h},get textureFloat(){return _||(_=ta(r,t)),_},get colorBufferFloat(){return d||(d=ia(r,t)),d},get blendMinMax(){return c||(c=Jn(r,t)),c},get depthTexture(){return f===null&&(f=Qe(r,t,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),f},get standardDerivatives(){return w===null&&(w=Qe(r,t,"standardDerivatives",!0,["OES_standard_derivatives"])),w},get shaderTextureLOD(){return b===null&&(b=Qe(r,t,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),b},get fragDepth(){return v===null&&(v=Qe(r,t,"fragDepth",!0,["EXT_frag_depth"])),v},get loseContext(){return m||(m=Xn(r,i)),m},get textureNorm16(){return u||(u=sa(r,t)),u},enable(g){return this[g]}}}function Zn(r,e){if(e.compressedTextureETC)return null;const t=r.getExtension("WEBGL_compressed_texture_etc");return t?{COMPRESSED_R11_EAC:t.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:t.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:t.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:t.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:t.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:t.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:t.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function Kn(r,e){if(e.compressedTextureS3TC)return null;const t=r.getExtension("WEBGL_compressed_texture_s3tc");return t?{COMPRESSED_RGB_S3TC_DXT1:t.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:t.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:t.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:t.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function Jn(r,e){if(H(r))return{MIN:r.MIN,MAX:r.MAX};if(e.blendMinMax)return null;{const t=r.getExtension("EXT_blend_minmax");return t?{MIN:t.MIN_EXT,MAX:t.MAX_EXT}:null}}function ea(r,e){if(e.textureFilterAnisotropic)return null;const t=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return t?{MAX_TEXTURE_MAX_ANISOTROPY:t.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:t.TEXTURE_MAX_ANISOTROPY_EXT}:null}function ta(r,e){if(H(r))return{textureFloat:!0,textureFloatLinear:!e.textureFloatLinear&&!!r.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!e.textureHalfFloatLinear&&!!r.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:r.HALF_FLOAT};if(r instanceof WebGLRenderingContext){const t=!e.textureHalfFloat&&r.getExtension("OES_texture_half_float");return{textureFloat:!e.textureFloat&&!!r.getExtension("OES_texture_float"),textureFloatLinear:!e.textureFloatLinear&&!!r.getExtension("OES_texture_float_linear"),textureHalfFloat:!!t,textureHalfFloatLinear:!e.textureHalfFloatLinear&&!!r.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:t?t.HALF_FLOAT_OES:void 0}}return null}function ia(r,e){if(H(r)){const t=!e.colorBufferFloat&&r.getExtension("EXT_color_buffer_half_float"),i=!e.colorBufferFloat&&r.getExtension("EXT_color_buffer_float"),s=!e.colorBufferFloat&&r.getExtension("EXT_float_blend");return t||i||s?{textureFloat:!!i,textureHalfFloat:!!t,floatBlend:!!s,R16F:r.R16F,RG16F:r.RG16F,RGBA16F:r.RGBA16F,R32F:r.R32F,RG32F:r.RG32F,RGBA32F:r.RGBA32F,R11F_G11F_B10F:r.R11F_G11F_B10F,RGB16F:r.RGB16F}:null}if(r instanceof WebGLRenderingContext){const t=!e.colorBufferFloat&&r.getExtension("EXT_color_buffer_half_float"),i=!e.colorBufferFloat&&r.getExtension("WEBGL_color_buffer_float"),s=!e.colorBufferFloat&&r.getExtension("EXT_float_blend");return t||i||s?{textureFloat:!!i,textureHalfFloat:!!t,floatBlend:!!s,RGBA16F:t?t.RGBA16F_EXT:void 0,RGB16F:t?t.RGB16F_EXT:void 0,RGBA32F:i?i.RGBA32F_EXT:void 0}:null}return null}function Qe(r,e,t,i,s){if(i&&H(r))return!0;if(e[t])return!1;for(const n of s)if(r.getExtension(n))return!0;return!1}function sa(r,e){if(!H(r)||e.textureNorm16)return null;const t=r.getExtension("EXT_texture_norm16");return t?{R16:t.R16,RG16:t.RG16,RGB16:t.RGB16,RGBA16:t.RGBA16,R16_SNORM:t.R16_SNORM,RG16_SNORM:t.RG16_SNORM,RGB16_SNORM:t.RGB16_SNORM,RGBA16_SNORM:t.RGBA16_SNORM}:null}class ra{constructor(e,t){this.gl=e,this.instanceCounter=new Ln,this._blendEnabled=!1,this._blendColorState={r:0,g:0,b:0,a:0},this._blendFunctionState={srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0},this._blendEquationState={mode:32774,modeAlpha:32774},this._colorMaskState={r:!0,g:!0,b:!0,a:!0},this._polygonCullingEnabled=!1,this._cullFace=1029,this._frontFace=2305,this._scissorTestEnabled=!1,this._scissorRect={x:0,y:0,width:0,height:0},this._depthTestEnabled=!1,this._depthFunction=513,this._clearDepth=1,this._depthWriteEnabled=!0,this._depthRange={zNear:0,zFar:1},this._viewport=null,this._stencilTestEnabled=!1,this._polygonOffsetFillEnabled=!1,this._polygonOffset=[0,0],this._stencilFunction={face:1032,func:519,ref:0,mask:1},this._clearStencil=0,this._stencilWriteMask=1,this._stencilOperation={face:1032,fail:7680,zFail:7680,zPass:7680},this._clearColor={r:0,g:0,b:0,a:0},this._activeShaderProgram=null,this._activeVertexBuffer=null,this._activeIndexBuffer=null,this._activeFramebuffer=null,this._activeRenderbuffer=null,this._activeTextureUnit=0,this._textureUnitMap=new Array,this._numOfDrawCalls=0,this._numOfTriangles=0,this.webglVersion=H(e)?"webgl2":"webgl",this.webglVersion==="webgl"&&this.gl.getExtension("OES_element_index_uint"),this._capabilities=Qn(e,t),this._parameters=this._loadParameters(t);const i=this.gl.getParameter(this.gl.VIEWPORT);this._viewport={x:i[0],y:i[1],width:i[2],height:i[3]},this._stateTracker=new hr({setBlending:s=>{if(s){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(s.opRgb,s.opAlpha),this.setBlendFunctionSeparate(s.srcRgb,s.dstRgb,s.srcAlpha,s.dstAlpha);const n=s.color;this.setBlendColor(n.r,n.g,n.b,n.a)}else this.setBlendingEnabled(!1)},setCulling:s=>{s?(this.setFaceCullingEnabled(!0),this.setCullFace(s.face),this.setFrontFace(s.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:s=>{s?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(s.factor,s.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:s=>{s?(this.setDepthTestEnabled(!0),this.setDepthFunction(s.func)):this.setDepthTestEnabled(!1)},setStencilTest:s=>{if(s){this.setStencilTestEnabled(!0);const n=s.function;this.setStencilFunction(n.func,n.ref,n.mask);const a=s.operation;this.setStencilOp(a.fail,a.zFail,a.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:s=>{s?(this.setDepthWriteEnabled(!0),this.setDepthRange(s.zNear,s.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:s=>{s?this.setColorMask(s.r,s.g,s.b,s.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:s=>{s?this.setStencilWriteMask(s.mask):this.setStencilWriteMask(0)}}),this.enforceState(),this.driverTest=new Hn(this)}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}dispose(){this.bindVAO(null),this.unbindBuffer(34962),this.unbindBuffer(34963),this._textureUnitMap.length=0,Se()&&this.instanceCounter.printResourceCount()}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._blendEnabled!==e&&(e===!0?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._blendEnabled=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){var e;(e=this._activeShaderProgram)==null||e.stop(),this._activeShaderProgram=null}externalTextureUnitUpdate(e,t){for(let i=0;i<e.length;++i)this._textureUnitMap[e[i]]=null;t>=0&&(this._activeTextureUnit=t)}externalVertexArrayObjectUpdate(){const e=this.capabilities.vao;e&&(e.bindVertexArray(null),this._activeVertexArrayObject=null),this._activeVertexBuffer=null,this._activeIndexBuffer=null}externalVertexBufferUpdate(){this._activeVertexBuffer=null}externalIndexBufferUpdate(){this._activeIndexBuffer=null}setBlendColor(e,t,i,s){e===this._blendColorState.r&&t===this._blendColorState.g&&i===this._blendColorState.b&&s===this._blendColorState.a||(this.gl.blendColor(e,t,i,s),this._blendColorState.r=e,this._blendColorState.g=t,this._blendColorState.b=i,this._blendColorState.a=s,this._stateTracker.invalidateBlending())}setBlendFunction(e,t){e===this._blendFunctionState.srcRGB&&t===this._blendFunctionState.dstRGB||(this.gl.blendFunc(e,t),this._blendFunctionState.srcRGB=e,this._blendFunctionState.srcAlpha=e,this._blendFunctionState.dstRGB=t,this._blendFunctionState.dstAlpha=t,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,t,i,s){this._blendFunctionState.srcRGB===e&&this._blendFunctionState.srcAlpha===i&&this._blendFunctionState.dstRGB===t&&this._blendFunctionState.dstAlpha===s||(this.gl.blendFuncSeparate(e,t,i,s),this._blendFunctionState.srcRGB=e,this._blendFunctionState.srcAlpha=i,this._blendFunctionState.dstRGB=t,this._blendFunctionState.dstAlpha=s,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._blendEquationState.mode!==e&&(this.gl.blendEquation(e),this._blendEquationState.mode=e,this._blendEquationState.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,t){this._blendEquationState.mode===e&&this._blendEquationState.modeAlpha===t||(this.gl.blendEquationSeparate(e,t),this._blendEquationState.mode=e,this._blendEquationState.modeAlpha=t,this._stateTracker.invalidateBlending())}setColorMask(e,t,i,s){this._colorMaskState.r===e&&this._colorMaskState.g===t&&this._colorMaskState.b===i&&this._colorMaskState.a===s||(this.gl.colorMask(e,t,i,s),this._colorMaskState.r=e,this._colorMaskState.g=t,this._colorMaskState.b=i,this._colorMaskState.a=s,this._stateTracker.invalidateColorWrite())}setClearColor(e,t,i,s){this._clearColor.r===e&&this._clearColor.g===t&&this._clearColor.b===i&&this._clearColor.a===s||(this.gl.clearColor(e,t,i,s),this._clearColor.r=e,this._clearColor.g=t,this._clearColor.b=i,this._clearColor.a=s)}setFaceCullingEnabled(e){this._polygonCullingEnabled!==e&&(e===!0?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._polygonCullingEnabled=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._polygonOffsetFillEnabled!==e&&(e===!0?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._polygonOffsetFillEnabled=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,t){this._polygonOffset[0]===e&&this._polygonOffset[1]===t||(this._polygonOffset[0]=e,this._polygonOffset[1]=t,this.gl.polygonOffset(e,t),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._cullFace!==e&&(this.gl.cullFace(e),this._cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._frontFace!==e&&(this.gl.frontFace(e),this._frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._scissorTestEnabled!==e&&(e===!0?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._scissorTestEnabled=e)}setScissorRect(e,t,i,s){this._scissorRect.x===e&&this._scissorRect.y===t&&this._scissorRect.width===i&&this._scissorRect.height===s||(this.gl.scissor(e,t,i,s),this._scissorRect.x=e,this._scissorRect.y=t,this._scissorRect.width=i,this._scissorRect.height=s)}setDepthTestEnabled(e){this._depthTestEnabled!==e&&(e===!0?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._depthTestEnabled=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._clearDepth!==e&&(this.gl.clearDepth(e),this._clearDepth=e)}setDepthFunction(e){this._depthFunction!==e&&(this.gl.depthFunc(e),this._depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._depthWriteEnabled!==e&&(this.gl.depthMask(e),this._depthWriteEnabled=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,t){this._depthRange.zNear===e&&this._depthRange.zFar===t||(this.gl.depthRange(e,t),this._depthRange.zNear=e,this._depthRange.zFar=t,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._stencilTestEnabled!==e&&(e===!0?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._stencilTestEnabled=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._clearStencil&&(this.gl.clearStencil(e),this._clearStencil=e)}setStencilFunction(e,t,i){this._stencilFunction.func===e&&this._stencilFunction.ref===t&&this._stencilFunction.mask===i||(this.gl.stencilFunc(e,t,i),this._stencilFunction.face=1032,this._stencilFunction.func=e,this._stencilFunction.ref=t,this._stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,t,i,s){this._stencilFunction.face===e&&this._stencilFunction.func===t&&this._stencilFunction.ref===i&&this._stencilFunction.mask===s||(this.gl.stencilFuncSeparate(e,t,i,s),this._stencilFunction.face=e,this._stencilFunction.func=t,this._stencilFunction.ref=i,this._stencilFunction.mask=s,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this.gl.stencilMask(e),this._stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,t,i){this._stencilOperation.fail===e&&this._stencilOperation.zFail===t&&this._stencilOperation.zPass===i||(this.gl.stencilOp(e,t,i),this._stencilOperation.face=1032,this._stencilOperation.fail=e,this._stencilOperation.zFail=t,this._stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,t,i,s){this._stencilOperation.face===e&&this._stencilOperation.fail===t&&this._stencilOperation.zFail===i&&this._stencilOperation.zPass===s||(this.gl.stencilOpSeparate(e,t,i,s),this._stencilOperation.face=e,this._stencilOperation.face=e,this._stencilOperation.fail=t,this._stencilOperation.zFail=i,this._stencilOperation.zPass=s,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,t=!1){const i=this._activeTextureUnit;return e>=0&&(t||e!==this._activeTextureUnit)&&(this.gl.activeTexture(at+e),this._activeTextureUnit=e),i}clear(e){e&&this.gl.clear(e)}clearSafe(e,t=255){e&&(16384&e&&this.setColorMask(!0,!0,!0,!0),256&e&&this.setDepthWriteEnabled(!0),1024&e&&this.setStencilWriteMask(t),this.gl.clear(e))}drawArrays(e,t,i){Se()&&(this._numOfDrawCalls++,this._numOfTriangles+=Ii(e,i)),this.gl.drawArrays(e,t,i)}drawElements(e,t,i,s){Se()&&(this._numOfDrawCalls++,this._numOfTriangles+=Ii(e,t)),this.gl.drawElements(e,t,i,s)}logIno(){Se()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}get capabilities(){return this._capabilities}setViewport(e,t,i,s){i=Math.max(Math.round(i),1),s=Math.max(Math.round(s),1);const n=this._viewport;n.x===e&&n.y===t&&n.width===i&&n.height===s||(n.x=e,n.y=t,n.width=i,n.height=s,this.gl.viewport(e,t,i,s))}getViewport(){return{x:this._viewport.x,y:this._viewport.y,width:this._viewport.width,height:this._viewport.height}}useProgram(e){var t,i;this._activeShaderProgram!==e&&((t=this._activeShaderProgram)==null||t.stop(),this._activeShaderProgram=e,this.gl.useProgram((i=e==null?void 0:e.glName)!=null?i:null))}bindTexture(e,t,i=!1){(t>=this.parameters.maxTextureImageUnits||t<0)&&console.error("Input texture unit is out of range of available units!");const s=this._textureUnitMap[t];return D(e)||e.glName==null?(B(s)&&(this.setActiveTexture(t,i),this.gl.bindTexture(s.descriptor.target,null)),this._textureUnitMap[t]=null,s):i||s!==e?(this.setActiveTexture(t,i),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._textureUnitMap[t]=e,s):(e.isDirty&&(this.setActiveTexture(t,i),e.applyChanges()),s)}unbindTextureAllUnits(e){for(let t=0;t<this.parameters.maxTextureImageUnits;t++)this._textureUnitMap[t]===e&&(this.bindTexture(null,t),this._textureUnitMap[t]=null)}bindFramebuffer(e,t=!1,i=3553){if(D(e))return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),void(this._activeFramebuffer=null);(t||this._activeFramebuffer!==e)&&(e.initializeAndBind(i),this._activeFramebuffer=e)}bindBuffer(e){e&&(e.bufferType===34962?this._activeVertexBuffer=Ze(this.gl,e,e.bufferType,this._activeVertexBuffer):this._activeIndexBuffer=Ze(this.gl,e,e.bufferType,this._activeIndexBuffer))}bindRenderbuffer(e){const t=this.gl;e||(t.bindRenderbuffer(t.RENDERBUFFER,null),this._activeRenderbuffer=null),this._activeRenderbuffer!==e&&(t.bindRenderbuffer(t.RENDERBUFFER,e.glName),this._activeRenderbuffer=e)}unbindBuffer(e){e===34962?this._activeVertexBuffer=Ze(this.gl,null,e,this._activeVertexBuffer):this._activeIndexBuffer=Ze(this.gl,null,e,this._activeIndexBuffer)}bindVAO(e=null){D(e)?this._activeVertexArrayObject&&(this._activeVertexArrayObject.unbind(),this._activeVertexArrayObject=null):this._activeVertexArrayObject!==e&&(e.bind(),this._activeVertexArrayObject=e)}getBoundFramebufferObject(){return this._activeFramebuffer}getBoundVAO(){return this._activeVertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null),this.unbindBuffer(34962),this.unbindBuffer(34963);for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(1,0),this.setBlendEquation(32774),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(1029),this.setFrontFace(2305),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(513),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(519,0,0),this.setStencilOp(7680,7680,7680),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){var e,t,i,s;const n=this.gl,a=this.capabilities.vao;a&&a.bindVertexArray(null);for(let o=0;o<this.parameters.maxVertexAttributes;o++)n.disableVertexAttribArray(o);if(this._activeVertexBuffer?n.bindBuffer(this._activeVertexBuffer.bufferType,this._activeVertexBuffer.glName):n.bindBuffer(34962,null),this._activeIndexBuffer?n.bindBuffer(this._activeIndexBuffer.bufferType,this._activeIndexBuffer.glName):n.bindBuffer(34963,null),a&&this._activeVertexArrayObject){const o=this._activeVertexArrayObject;this._activeVertexArrayObject&&(this._activeVertexArrayObject.unbind(),this._activeVertexArrayObject=null),this.bindVAO(o)}n.bindFramebuffer(n.FRAMEBUFFER,(e=(t=this._activeFramebuffer)==null?void 0:t.glName)!=null?e:null),n.useProgram((i=(s=this._activeShaderProgram)==null?void 0:s.glName)!=null?i:null),n.blendColor(this._blendColorState.r,this._blendColorState.g,this._blendColorState.b,this._blendColorState.a),n.bindRenderbuffer(n.RENDERBUFFER,this._activeRenderbuffer?this._activeRenderbuffer.glName:null),this._blendEnabled===!0?n.enable(this.gl.BLEND):n.disable(this.gl.BLEND),n.blendEquationSeparate(this._blendEquationState.mode,this._blendEquationState.modeAlpha),n.blendFuncSeparate(this._blendFunctionState.srcRGB,this._blendFunctionState.dstRGB,this._blendFunctionState.srcAlpha,this._blendFunctionState.dstAlpha),n.clearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a),n.clearDepth(this._clearDepth),n.clearStencil(this._clearStencil),n.colorMask(this._colorMaskState.r,this._colorMaskState.g,this._colorMaskState.b,this._colorMaskState.a),n.cullFace(this._cullFace),n.depthFunc(this._depthFunction),n.depthRange(this._depthRange.zNear,this._depthRange.zFar),this._depthTestEnabled===!0?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),n.depthMask(this._depthWriteEnabled),n.frontFace(this._frontFace),n.lineWidth(1),this._polygonCullingEnabled===!0?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),n.polygonOffset(this._polygonOffset[0],this._polygonOffset[1]),this._polygonOffsetFillEnabled===!0?n.enable(n.POLYGON_OFFSET_FILL):n.disable(n.POLYGON_OFFSET_FILL),n.scissor(this._scissorRect.x,this._scissorRect.y,this._scissorRect.width,this._scissorRect.height),this._scissorTestEnabled===!0?n.enable(n.SCISSOR_TEST):n.disable(n.SCISSOR_TEST),n.stencilFunc(this._stencilFunction.func,this._stencilFunction.ref,this._stencilFunction.mask),n.stencilOpSeparate(this._stencilOperation.face,this._stencilOperation.fail,this._stencilOperation.zFail,this._stencilOperation.zPass),this._stencilTestEnabled===!0?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),n.stencilMask(this._stencilWriteMask);for(let o=0;o<this.parameters.maxTextureImageUnits;o++){n.activeTexture(at+o),n.bindTexture(3553,null),n.bindTexture(34067,null),H(n)&&n.bindTexture(32879,null);const l=this._textureUnitMap[o];B(l)&&n.bindTexture(l.descriptor.target,l.glName)}n.activeTexture(at+this._activeTextureUnit),n.viewport(this._viewport.x,this._viewport.y,this._viewport.width,this._viewport.height),Se()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}_loadParameters(e){var t;const i=this.capabilities.textureFilterAnisotropic,s=(t=e.maxAnisotropy)!=null?t:1/0,n={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:i?Math.min(this.gl.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY),s):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE)};return I.TEXTURE_UNIT_FOR_UPDATES=n.maxTextureImageUnits-1,n}}function Ze(r,e,t,i){return e?i!==e&&r.bindBuffer(t,e.glName):r.bindBuffer(t,null),e}function Ii(r,e){switch(r){case 0:return 2*e;case 4:return e/3;case 5:case 6:return e-2;default:return 0}}const na=2e3;class wo extends Lt{constructor(e,t){super(),this._trash=new Set,this._clipData=new Float32Array(8),this._upperLeft=te(),this._upperRight=te(),this._lowerLeft=te(),this._lowerRight=te(),this._mat2=us(),this._clipRendererInitialized=!1,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this.renderRequested=!1,this.stage=this,this._stationary=!0;const{canvas:i=document.createElement("canvas"),alpha:s=!0,stencil:n=!0,contextOptions:a={}}=t;this._canvas=i;const o=cs(i,1,{alpha:s,antialias:!1,depth:!0,stencil:n});this.context=new ra(B(o)?o:null,a),this.resourceManager=new Ns,this.painter=new zn(this.context,this,this.resourceManager),$e("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(this._debugOutput)),this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:t.timeline||new ds,renderingOptions:t.renderingOptions,requireFBO:!1,profiler:new Un(this.context,this._debugOutput),dataUploadCounter:0},this._taskHandle=_s({render:l=>this.renderFrame(l)}),this._taskHandle.pause(),this._lostWebGLContextHandle=ms(i,"webglcontextlost",()=>{this.emit("webgl-error",{error:new O("webgl-context-lost")})}),i.setAttribute("style","width: 100%; height:100%; display:block;"),e.appendChild(i)}destroy(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get highlightOptions(){return this._highlightOptions}set highlightOptions(e){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=Pt(this._highlightOptions,"version",()=>{this.painter.setHighlightOptions(e),this.requestRender()}))}get renderingOptions(){return this._renderingOptions}set renderingOptions(e){this._renderingOptions=e,this.requestRender()}get state(){return this._state}set state(e){this._state=e,this.requestRender()}get stationary(){return this._stationary}set stationary(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}trashDisplayObject(e){this._trash.add(e),this.requestRender()}untrashDisplayObject(e){return this._trash.delete(e)}requestRender(){this._renderRemainingTime=na,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}renderFrame(e){const t=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=t,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}_createTransforms(){return{dvs:At()}}renderChildren(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)}_renderChildren(e,t){const i=this.context;t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,this._beforeRenderChildren(t),t.drawPhase=k.MAP,this.painter.beforeRenderLayers(i,this.background);for(const s of e)s.processRender(t);this.painter.renderLayers(i),t.drawPhase=k.HIGHLIGHT,this.painter.beforeRenderLayers(i);for(const s of e)s.processRender(t);if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(e)){t.drawPhase=k.LABEL,this.painter.beforeRenderLayers(i);for(const s of e)s.processRender(t);this.painter.renderLayers(i)}if($e("esri-tiles-debug")){t.drawPhase=k.DEBUG,this.painter.beforeRenderLayers(i);for(const s of e)s.processRender(t);this.painter.renderLayers(i)}t.profiler.recordEnd("drawLayers"),this._afterRenderChildren()}_beforeRenderChildren(e){const{context:t}=this,{state:i,pixelRatio:s}=e;t.enforceState(),t.setClearDepth(1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT);const{size:n,rotation:a}=i,o=Math.round(n[0]*s),l=Math.round(n[1]*s);if(this._boundFBO=t.getBoundFramebufferObject(),!(i.spatialReference&&(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable)))return void(this._clipFrame=!1);const h=ys(a),_=Math.abs(Math.cos(h)),d=Math.abs(Math.sin(h)),c=Math.round(o*_+l*d),m=Math.round(i.worldScreenWidth);if(c<=m)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===o&&this._clipFBO.height===l||(this._clipFBO=new A(t,{colorTarget:0,depthStencilTarget:3,width:o,height:l}));const p=(this.state.padding.left-this.state.padding.right)/2,u=(this.state.padding.bottom-this.state.padding.top)/2,f=.5*o,w=.5*l,b=1/o,v=1/l,g=m*s*.5,x=.5*(o*d+l*_),y=this._upperLeft,C=this._upperRight,F=this._lowerLeft,S=this._lowerRight;ee(y,-g,-x),ee(C,g,-x),ee(F,-g,x),ee(S,g,x),ps(this._mat2),fs(this._mat2,this._mat2,[f+p,w-u]),a!==0&&gs(this._mat2,this._mat2,h),ke(y,y,this._mat2),ke(C,C,this._mat2),ke(F,F,this._mat2),ke(S,S,this._mat2);const W=this._clipData;W.set([2*F[0]*b-1,2*(l-F[1])*v-1,2*S[0]*b-1,2*(l-S[1])*v-1,2*y[0]*b-1,2*(l-y[1])*v-1,2*C[0]*b-1,2*(l-C[1])*v-1]),this._clipRendererInitialized||this._initializeClipRenderer(t),this._clipVBO.setData(W),this._boundFBO=t.getBoundFramebufferObject(),t.bindFramebuffer(this._clipFBO),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),t.setClearColor(0,0,0,0),t.setClearDepth(1),t.setClearStencil(0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT|t.gl.STENCIL_BUFFER_BIT),t.setDepthWriteEnabled(!1),this._clipFrame=!0}_afterRenderChildren(){const e=this.context;if(e.logIno(),this._clipFrame&&this._clipRendererInitialized){if(e.bindFramebuffer(this._boundFBO),this._boundFBO=null,e.bindVAO(this._clipVAO),e.useProgram(this._clipStencilProgram),e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,1,255),e.drawElements(4,6,5123,0),e.bindVAO(),e.setColorMask(!0,!0,!0,!0),this.background!=null){const{r:t,g:i,b:s,a:n}=this.background.color;e.setClearColor(n*t/255,n*i/255,n*s/255,n)}else e.setClearColor(0,0,0,0);e.clear(e.gl.COLOR_BUFFER_BIT),e.setBlendingEnabled(!0),e.setStencilFunction(514,1,255),this.painter.blitTexture(e,this._clipFBO.colorTexture,9728,1),e.setStencilTestEnabled(!1)}}doRender(e){const t=this.context,{state:i,pixelRatio:s}=e;this._resizeCanvas(e),this.context.enforceState(),t.setViewport(0,0,s*i.size[0],s*i.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),super.doRender(e)}async takeScreenshot(e){const{framebufferWidth:t,framebufferHeight:i}={framebufferWidth:Math.round(this._renderParameters.state.size[0]*e.resolutionScale),framebufferHeight:Math.round(this._renderParameters.state.size[1]*e.resolutionScale)},s=1,n=this.context,a=this._state.clone();if(e.rotation!=null){const m=a.viewpoint;a.viewpoint.rotation=e.rotation,a.viewpoint=m}const o=ue($({},this._renderParameters),{drawPhase:null,globalOpacity:1,stationary:!0,state:a,pixelRatio:s,time:Date.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1}),l=new A(n,{colorTarget:0,depthStencilTarget:3,width:t,height:i}),h=n.getBoundFramebufferObject(),_=n.getViewport();n.bindFramebuffer(l),n.setViewport(0,0,t,i),this._renderChildren(e.children,o);const d=this._readbackScreenshot(ue($({},e.cropArea),{y:i-(e.cropArea.y+e.cropArea.height)}));let c;return n.bindFramebuffer(h),n.setViewport(_.x,_.y,_.width,_.height),this.requestRender(),e.outputScale===1?c=d:(c=new ImageData(Math.round(d.width*e.outputScale),Math.round(d.height*e.outputScale)),bs(d,c,!0)),vs(c,{format:e.format,quality:e.quality,rotation:0,disableDecorations:!1},document.createElement("canvas"),{flipY:!0,premultipliedAlpha:!0})}_readbackScreenshot(e){const t=this.context.gl,i=ws(e.width,e.height,document.createElement("canvas"));return t.readPixels(e.x,e.y,e.width,e.height,6408,5121,new Uint8Array(i.data.buffer)),i}_resizeCanvas(e){const t=this._canvas,i=t.style,{state:{size:s},pixelRatio:n}=e,a=s[0],o=s[1],l=Math.round(a*n),h=Math.round(o*n);t.width===l&&t.height===h||(t.width=l,t.height=h),i.width=a+"px",i.height=o+"px"}_initializeClipRenderer(e){if(this._clipRendererInitialized)return!0;const t=Bi.attributes,i=Me(e,Bi);if(!i)return!1;const s=ie.createVertex(e,35040,32),n=new Uint16Array([0,1,2,2,1,3]),a=ie.createIndex(e,35044,n),o=new ae(e,t,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:s},a);return this._clipStencilProgram=i,this._clipVBO=s,this._clipVAO=o,this._clipRendererInitialized=!0,!0}_emptyTrash(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}}_isLabelDrawPhaseRequired(e){let t=!1;for(const i of e){if(!(i instanceof Lt)){t=t||!1;break}if(i.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(i.children)}return t}}const Ke=2,Q=1,Pe=0,Ae=1,De=2;class aa{constructor(e,t){this.width=e,this.height=t;const i=Math.ceil(e/Q),s=Math.ceil(t/Q);this._cols=i,this._rows=s,this._cells=ur.create(i*s)}insertMetrics(e){const t=this._hasCollision(e);return t===Pe&&this._markMetrics(e),t}getCellId(e,t){return e+t*this._cols}has(e){return this._cells.has(e)}hasRange(e,t){return this._cells.hasRange(e,t)}set(e){this._cells.set(e)}setRange(e,t){this._cells.setRange(e,t)}_hasCollision(e){const t=e.id;let i=0,s=0;e.save();do{const n=e.boundsCount;i+=n;for(let a=0;a<n;a++){const o=e.boundsComputedAnchorX(a),l=e.boundsComputedAnchorY(a),h=e.boundsWidth(a)+Ke,_=e.boundsHeight(a)+Ke;switch(this._collide(o,l,h,_)){case De:return De;case Ae:s++}}}while(e.peekId()===t&&e.next());return e.restore(),i===s?Ae:Pe}_collide(e,t,i,s){const n=e-i/2,a=t-s/2,o=n+i,l=a+s;if(o<0||l<0||n>this.width||a>this.height)return Ae;const h=N(Math.floor(n/Q),0,this._cols),_=N(Math.floor(a/Q),0,this._rows),d=N(Math.ceil(o/Q),0,this._cols),c=N(Math.ceil(l/Q),0,this._rows);for(let m=_;m<=c;m++)for(let p=h;p<=d;p++){const u=this.getCellId(p,m);if(this.has(u))return De}return Pe}_mark(e,t,i,s){const n=e-i/2,a=t-s/2,o=n+i,l=a+s,h=N(Math.floor(n/Q),0,this._cols),_=N(Math.floor(a/Q),0,this._rows),d=N(Math.ceil(o/Q),0,this._cols),c=N(Math.ceil(l/Q),0,this._rows);for(let m=_;m<=c;m++)for(let p=h;p<=d;p++){const u=this.getCellId(p,m);this.set(u)}return!1}_markMetrics(e){const t=e.id;do{const i=e.boundsCount;for(let s=0;s<i;s++){const n=e.boundsComputedAnchorX(s),a=e.boundsComputedAnchorY(s),o=e.boundsWidth(s)+Ke,l=e.boundsHeight(s)+Ke;this._mark(n,a,o,l)}}while(e.peekId()===t&&e.next())}}const oa=Math.PI;function zi(r,e){switch(e.transformationType){case"additive":return la(r,e);case"constant":return ha(e,r);case"clamped-linear":return ua(r,e);case"proportional":return ca(r,e);case"stops":return da(r,e);case"real-world-size":return _a(r,e);case"identity":return r;case"unknown":return null}}function q(r,e){return typeof r=="number"?r:zi(e,r)}function la(r,e){return r+(q(e.minSize,r)||e.minDataValue)}function ha(r,e){const t=r.stops;let i=t&&t.length&&t[0].size;return i==null&&(i=r.minSize),q(i,e)}function ua(r,e){const t=(r-e.minDataValue)/(e.maxDataValue-e.minDataValue),i=q(e.minSize,r),s=q(e.maxSize,r);return r<=e.minDataValue?i:r>=e.maxDataValue?s:i+t*(s-i)}function ca(r,e){const t=r/e.minDataValue,i=q(e.minSize,r),s=q(e.maxSize,r);let n=null;return n=t*i,N(n,i,s)}function da(r,e){const[t,i,s]=ma(r,e.cache.ipData);if(t===i)return q(e.stops[t].size,r);{const n=q(e.stops[t].size,r);return n+(q(e.stops[i].size,r)-n)*s}}function _a(r,e){const t=xs[e.valueUnit],i=q(e.minSize,r),s=q(e.maxSize,r),{valueRepresentation:n}=e;let a=null;return a=n==="area"?2*Math.sqrt(r/oa)/t:n==="radius"||n==="distance"?2*r/t:r/t,N(a,i,s)}function ma(r,e){if(!e)return;let t=0,i=e.length-1;return e.some((s,n)=>r<s?(i=n,!0):(t=n,!1)),[t,i,(r-e[t])/(e[i]-e[t])]}const vt=254,Je=255,Ie=0;function ve(r,e){const t=[];r.forEachTile(i=>t.push(i)),t.sort((i,s)=>i.instanceId-s.instanceId),t.forEach(i=>{B(i.labelMetrics)&&i.isReady&&e(i,i.labelMetrics.getCursor())})}function pa(r){return r.layer.type==="feature"||r.layer.type==="csv"||r.layer.type==="geojson"||r.layer.type==="ogc-feature"||r.layer.type==="stream"||r.layer.type==="subtype-group"||r.layer.type==="wfs"}function fa(r){return e=>ne(zi(e,r))}function ga(r){const e="visualVariables"in r&&r.visualVariables;if(!e)return null;for(const t of e)if(t.type==="size")return fa(t);return null}function ba(r){for(const t of r){var e;const i="featureReduction"in t&&((e=t.featureReduction)==null?void 0:e.type)==="cluster"&&t.featureReduction,s=[...t.labelingInfo||[],...i.labelingInfo||[]];if(!(!t.labelsVisible||!s.length)&&s.some(n=>n.deconflictionStrategy==="none"))return!0}return!1}function va(r,e){if(!pa(e))return;const t=e.layer.type==="subtype-group"?e.layer.sublayers.items:[e.layer],i=e.layer.geometryType,s=!ba(t),n={};if(e.layer.type!=="subtype-group"){if(e.layer.renderer.type==="heatmap")return;const l=ga(e.layer.renderer);n[0]=l}const a=e.tileRenderer;if(D(a))return;const o=e.layer.visible&&!e.suspended;r.push({tileRenderer:a,vvEvaluators:n,deconflictionEnabled:s,geometryType:i,visible:o})}class wa{run(e,t,i){const s=[];for(let n=e.length-1;n>=0;n--)va(s,e[n]);this._transformMetrics(s,t),this._runCollision(s,t,i)}_runCollision(e,t,i){const[s,n]=t.state.size,a=new aa(s*t.pixelRatio,n*t.pixelRatio);for(const{tileRenderer:o,deconflictionEnabled:l,visible:h}of e){const _=o.featuresView.attributeView;l?h?(this._prepare(o),this._collideVisible(a,o,i),this._collideInvisible(a,o)):ve(o,(d,c)=>{for(;c.nextId();)_.setLabelMinZoom(c.id,Je)}):ve(o,(d,c)=>{for(;c.nextId();)_.setLabelMinZoom(c.id,Ie)})}}_isFiltered(e,t,i){const s=t.getFilterFlags(e),n=!i.hasFilter||!!(s&rr),a=!B(i.featureEffect)||i.featureEffect.excludedLabelsVisible||!!(s&nr);return!(n&&a)}_prepare(e){const t=e.featuresView.attributeView,i=new Set;ve(e,(s,n)=>{for(;n.nextId();)if(!i.has(n.id)){if(i.add(n.id),this._isFiltered(n.id,t,e.layerView)){t.setLabelMinZoom(n.id,vt);continue}t.getLabelMinZoom(n.id)!==Ie?t.setLabelMinZoom(n.id,Je):t.setLabelMinZoom(n.id,Ie)}})}_collideVisible(e,t,i){const s=t.featuresView.attributeView,n=new Set;ve(t,(a,o)=>{for(;o.nextId();)if(!n.has(o.id))if(a.key.level===i){if(s.getLabelMinZoom(o.id)===0)switch(e.insertMetrics(o)){case Ae:break;case De:s.setLabelMinZoom(o.id,vt),n.add(o.id);break;case Pe:s.setLabelMinZoom(o.id,Ie),n.add(o.id)}}else s.setLabelMinZoom(o.id,vt)})}_collideInvisible(e,t){const i=t.featuresView.attributeView,s=new Set;ve(t,(n,a)=>{for(;a.nextId();)if(!s.has(a.id)&&i.getLabelMinZoom(a.id)===Je)switch(e.insertMetrics(a)){case Ae:break;case De:i.setLabelMinZoom(a.id,Je),s.add(a.id);break;case Pe:i.setLabelMinZoom(a.id,Ie),s.add(a.id)}})}_transformMetrics(e,t){for(const{tileRenderer:i,geometryType:s,vvEvaluators:n}of e)ve(i,(a,o)=>{const l=i.featuresView.attributeView,h=a.transforms.labelMat2d;h[4]=Math.round(h[4]),h[5]=Math.round(h[5]);const _=h[4],d=h[5],c=s==="polyline";for(;o.next();){const m=o.boundsCount,p=o.anchorX,u=o.anchorY;let f=o.size;const w=n[0];if(B(w)){const g=w(l.getVVSize(o.id));f=isNaN(g)||g==null||g===1/0?f:g}const b=o.directionX*(f/2),v=o.directionY*(f/2);for(let g=0;g<m;g++){let x=p,y=o.anchorY;if(c){let C=x+o.boundsX(g)+b,F=y+o.boundsY(g)+v;t.state.rotation?(C=h[0]*C+h[2]*F+h[4],F=h[1]*C+h[3]*F+h[5]):(C+=_,F+=d),o.setBoundsComputedAnchorX(g,Math.floor(C)),o.setBoundsComputedAnchorY(g,Math.floor(F))}else{t.state.rotation?(x=h[0]*p+h[2]*u+h[4],y=h[1]*p+h[3]*u+h[5]):(x+=_,y+=d);const C=x+o.boundsX(g)+b,F=y+o.boundsY(g)+v;o.setBoundsComputedAnchorX(g,C),o.setBoundsComputedAnchorY(g,F)}}}})}}const ya=32,xa=Te.getLogger("esri.views.2d.layers.labels.LabelManager");let _e=class extends Ts(me){constructor(r){super(r),this._applyVisibilityPassThrottled=Fs(this._applyVisibilityPass,ya,this),this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}initialize(){this.collisionEngine=new wa}destroy(){this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}get updating(){return this.updateRequested}update(r){this._applyVisibilityPassThrottled(r)}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}processUpdate(r){this._set("updateParameters",r),this.updateRequested&&(this.updateRequested=!1,this.update(r))}_applyVisibilityPass(r){try{const e=this.view.featuresTilingScheme.getClosestInfoForScale(r.state.scale).level;this.collisionEngine.run(this.view.allLayerViews.items,r,e)}catch(e){xa.error(new O("mapview-labeling","Encountered an error during label decluttering",e))}}};M([R()],_e.prototype,"updateRequested",void 0),M([R({readOnly:!0})],_e.prototype,"updateParameters",void 0),M([R()],_e.prototype,"updating",null),M([R()],_e.prototype,"view",void 0),_e=M([pe("esri.views.2d.layers.labels.LabelManager")],_e);const yo=_e,et={container:"esri-zoom-box__container",overlay:"esri-zoom-box__overlay",background:"esri-zoom-box__overlay-background",box:"esri-zoom-box__outline"},wt={zoom:"Shift",counter:"Ctrl"};let ze=class extends me{constructor(r){super(r),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(r){this._handles&&this._handles.forEach(e=>{e.remove()}),this._handles=null,this._destroyOverlay(),this._set("view",r),r&&(r.on("drag",[wt.zoom],e=>this._handleDrag(e,1),Dt.INTERNAL),r.on("drag",[wt.zoom,wt.counter],e=>this._handleDrag(e,-1),Dt.INTERNAL))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(r,e,t,i){this._box.x=r,this._box.y=e,this._box.width=t,this._box.height=i,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(r,e,t,i,s){const n=this.view,a=n.toMap(Es(r+.5*t,e+.5*i));let o=Math.max(t/n.width,i/n.height);s===-1&&(o=1/o),this._destroyOverlay(),this.navigation.end(),n.goTo({center:a,scale:n.scale*o})}_updateBox(r,e,t,i){const s=this._boxShape;s.setAttributeNS(null,"x",""+r),s.setAttributeNS(null,"y",""+e),s.setAttributeNS(null,"width",""+t),s.setAttributeNS(null,"height",""+i),s.setAttributeNS(null,"class",et.box)}_updateBackground(r,e,t,i){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(r,e,t,i,this.view.width,this.view.height))}_createContainer(){const r=document.createElement("div");r.className=et.container,this.view.root.appendChild(r),this._container=r}_createOverlay(){const r=this.view.width,e=this.view.height,t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttributeNS(null,"d","M 0 0 L "+r+" 0 L "+r+" "+e+" L 0 "+e+" Z"),t.setAttributeNS(null,"class",et.background);const i=document.createElementNS("http://www.w3.org/2000/svg","rect"),s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),s.setAttributeNS(null,"class",et.overlay),s.appendChild(t),s.appendChild(i),this._container.appendChild(s),this._backgroundShape=t,this._boxShape=i,this._overlay=s}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(r,e,t,i,s,n){const a=r+t,o=e+i;return"M 0 0 L "+s+" 0 L "+s+" "+n+" L 0 "+n+" ZM "+r+" "+e+" L "+r+" "+o+" L "+a+" "+o+" L "+a+" "+e+" Z"}_handleDrag(r,e){const t=r.x,i=r.y,s=r.origin.x,n=r.origin.y;let a,o,l,h;switch(t>s?(a=s,l=t-s):(a=t,l=s-t),i>n?(o=n,h=i-n):(o=i,h=n-i),r.action){case"start":this._start();break;case"update":this._update(a,o,l,h);break;case"end":this._end(a,o,l,h,e)}r.stopPropagation()}_redraw(){if(!this._rafId||(this._rafId=null,!this._overlay))return;const{x:r,y:e,width:t,height:i}=this._box;this._updateBox(r,e,t,i),this._updateBackground(r,e,t,i),this._rafId=requestAnimationFrame(this._redraw)}};M([R()],ze.prototype,"navigation",void 0),M([R()],ze.prototype,"view",null),ze=M([pe("esri.views.2d.navigation.ZoomBox")],ze);const Ta=ze;class he{constructor(e){this.gain=e}update(e){if(this.hasLastValue){const t=this.computeDelta(e);this.updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return this.lastValue!==void 0}get hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(e){return e-this.lastValue}updateDelta(e){this.hasFilteredDelta?this.filteredDelta=(1-this.gain)*this.filteredDelta+this.gain*e:this.filteredDelta=e}}class yt{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}}class Fa extends yt{constructor(e,t,i,s,n){super(e,t,i),this.sceneVelocity=s,this.direction=n}value(e){return super.valueFromInitialVelocity(this.sceneVelocity,e)}}class Ea{constructor(e=300,t=12,i=.84){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.enabled=!0,this.time=new he(.6),this.screen=[new he(.4),new he(.4)],this.scene=[new he(.6),new he(.6),new he(.6)],this.tmpDirection=It()}add(e,t,i){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(i)<.015)return;this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.scene[0].update(t[0]),this.scene[1].update(t[1]),this.scene[2].update(t[2]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,t,i){Ss(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const s=Ms(this.tmpDirection);s>0&&zt(this.tmpDirection,this.tmpDirection,1/s);const n=s/this.time.filteredDelta;return new Fa(e,t,i,n,this.tmpDirection)}}let we=class extends me{constructor(r){super(r),this.animationTime=0,this.momentumEstimator=new Ea(500,6,.92),this.momentum=null,this.tmpMomentum=It(),this.momentumFinished=!1,this.viewpoint=new Le({targetGeometry:new Ve,scale:0,rotation:0}),this.watch("momentumFinished",e=>{e&&this.navigation.stop()})}begin(r,e){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(e),this.previousDrag=e}update(r,e){this.addToEstimator(e);let t=e.center.x,i=e.center.y;const s=this.previousDrag;t=s?s.center.x-t:-t,i=s?i-s.center.y:i,r.viewpoint=Ne(this.viewpoint,r.viewpoint,[t||0,i||0]),this.previousDrag=e}end(r,e){this.addToEstimator(e);const t=r.navigation.momentumEnabled;this.momentum=t?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(r),this.previousDrag=null,this.navigation.end()}addToEstimator(r){const e=r.center.x,t=r.center.y,i=Cs(-e,t),s=st(-e,t,0);this.momentumEstimator.add(i,s,.001*r.timestamp)}onAnimationUpdate(r){this.navigation.animationManager.animateContinous(r.viewpoint,(e,t)=>{this.momentumFinished=!this.momentum||this.momentum.isFinished(this.animationTime);const i=.001*t;if(!this.momentumFinished){const s=this.momentum.valueDelta(this.animationTime,i);zt(this.tmpMomentum,this.momentum.direction,s),Ne(e,e,this.tmpMomentum),r.constraints.constrainByGeometry(e)}this.animationTime+=i})}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};M([R()],we.prototype,"momentumFinished",void 0),M([R()],we.prototype,"viewpoint",void 0),M([R()],we.prototype,"navigation",void 0),we=M([pe("esri.views.2d.navigation.actions.Pan")],we);const Sa=we;class Ui{constructor(e=2.5,t=.01,i=.95,s=12){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.maxVelocity=s,this.enabled=!0,this.value=new he(.8),this.time=new he(.3)}add(e,t){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta){const i=this.value.computeDelta(e);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=N(e,-this.maxVelocity,this.maxVelocity),Math.abs(e)<this.minimumInitialVelocity?null:this.createMomentum(e,this.stopVelocity,this.friction)}createMomentum(e,t,i){return new yt(e,t,i)}}class Ma extends Ui{constructor(e=3,t=.01,i=.95,s=12){super(e,t,i,s)}add(e,t){if(this.value.hasLastValue){const i=this.value.lastValue;let s=e-i;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;e=i+s}super.add(e,t)}}class Ca extends yt{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),s=super.value(e+t)-i;return Math.exp(s)}}class Ba extends Ui{constructor(e=2.5,t=.01,i=.95,s=12){super(e,t,i,s)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new Ca(e,t,i)}}let ye=class extends me{constructor(r){super(r),this._animationTime=0,this._momentumFinished=!1,this._rotationMomentumEstimator=new Ma(.6,.15,.95),this._rotationDirection=1,this._zoomDirection=1,this._zoomMomentumEstimator=new Ba,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new Le({targetGeometry:new Ve,scale:0,rotation:0}),this.watch("_momentumFinished",e=>{e&&this.navigation.stop()})}begin(r,e){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=e.angle,this._previousRadius=this._startRadius=e.radius,this._previousCenter=e.center,this._updateTimestamp=null,r.constraints.rotationEnabled&&this.addToRotateEstimator(0,e.timestamp),this.addToZoomEstimator(e,1)}update(r,e){this._updateTimestamp===null&&(this._updateTimestamp=e.timestamp);const t=e.angle,i=e.radius,s=e.center,n=Math.abs(180*(t-this._startAngle)/Math.PI),a=Math.abs(i-this._startRadius),o=this._startRadius/i;if(this._previousRadius){const l=i/this._previousRadius;let h=180*(t-this._previousAngle)/Math.PI;this._rotationDirection=h>=0?1:-1,this._zoomDirection=l>=1?1:-1,r.constraints.rotationEnabled?(this._zoomOnly===null&&e.timestamp-this._updateTimestamp>200&&(this._zoomOnly=a-n>0),this._zoomOnly===null||this._zoomOnly?h=0:this.addToRotateEstimator(t-this._startAngle,e.timestamp)):h=0,this.addToZoomEstimator(e,o),this.navigation.setViewpoint([s.x,s.y],1/l,h,[this._previousCenter.x-s.x,s.y-this._previousCenter.y])}this._previousAngle=t,this._previousRadius=i,this._previousCenter=s}end(r){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(r),this.navigation.end()}addToRotateEstimator(r,e){this._rotationMomentumEstimator.add(r,.001*e)}addToZoomEstimator(r,e){this._zoomMomentumEstimator.add(e,.001*r.timestamp)}canZoomIn(r){const e=r.scale,t=r.constraints.effectiveMaxScale;return t===0||e>t}canZoomOut(r){const e=r.scale,t=r.constraints.effectiveMinScale;return t===0||e<t}onAnimationUpdate(r){this.navigation.animationManager.animateContinous(r.viewpoint,(e,t)=>{const i=!this.canZoomIn(r)&&this._zoomDirection>1||!this.canZoomOut(r)&&this._zoomDirection<1,s=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),n=i||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),a=.001*t;if(this._momentumFinished=s&&n,!this._momentumFinished){const o=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,a))*this._rotationDirection*180/Math.PI:0;let l=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,a)):1;const h=te(),_=te();if(this._previousCenter){ee(h,this._previousCenter.x,this._previousCenter.y),Bs(_,r.size,r.padding),Rs(h,h,_);const{constraints:d,scale:c}=r,m=c*l;l<1&&!d.canZoomInTo(m)?(l=c/d.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):l>1&&!d.canZoomOutTo(m)&&(l=c/d.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),Os(e,r.viewpoint,l,o,h,r.size),r.constraints.constrainByGeometry(e)}}this._animationTime+=a})}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};M([R()],ye.prototype,"_momentumFinished",void 0),M([R()],ye.prototype,"viewpoint",void 0),M([R()],ye.prototype,"navigation",void 0),ye=M([pe("esri.views.2d.navigation.actions.Pinch")],ye);const Ra=ye,xt=te(),$i=te();let Ue=class extends me{constructor(r){super(r),this._previousCenter=te(),this.viewpoint=new Le({targetGeometry:new Ve,scale:0,rotation:0})}begin(r,e){this.navigation.begin(),ee(this._previousCenter,e.center.x,e.center.y)}update(r,e){const{state:{size:t,padding:i}}=r;ee(xt,e.center.x,e.center.y),Ps($i,t,i),r.viewpoint=rt(this.viewpoint,r.state.paddedViewState.viewpoint,As($i,this._previousCenter,xt)),Ds(this._previousCenter,xt)}end(){this.navigation.end()}};M([R()],Ue.prototype,"viewpoint",void 0),M([R()],Ue.prototype,"navigation",void 0),Ue=M([pe("esri.views.2d.actions.Rotate")],Ue);const Oa=Ue,tt=10,ki=1,Tt=new Le({targetGeometry:new Ve}),Ft=[0,0],Li=250;let Z=class extends me{constructor(r){super(r),this._endTimer=null,this.animationManager=null}initialize(){this.pan=new Sa({navigation:this}),this.rotate=new Oa({navigation:this}),this.pinch=new Ra({navigation:this}),this.zoomBox=new Ta({view:this.view,navigation:this})}destroy(){this.zoomBox.destroy(),this.zoomBox=null,this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(Li)}async zoom(r,e=this._getDefaultAnchor()){if(this.stop(),this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return r<1?this.zoomIn(e):this.zoomOut(e);this.setViewpoint(e,r,0,[0,0])}async zoomIn(r){const e=this.view,t=e.constraints.snapToNextScale(e.scale);return this._zoomToScale(t,r)}async zoomOut(r){const e=this.view,t=e.constraints.snapToPreviousScale(e.scale);return this._zoomToScale(t,r)}setViewpoint(r,e,t,i){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,r,e,t,i),this.end()}setViewpointImmediate(r,e=0,t=[0,0],i=this._getDefaultAnchor()){this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,i,r,e,t)}continousRotateClockwise(){const r=this.get("view.viewpoint");this.animationManager.animateContinous(r,e=>{rt(e,e,-ki)})}continousRotateCounterclockwise(){const r=this.get("view.viewpoint");this.animationManager.animateContinous(r,e=>{rt(e,e,ki)})}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-tt,0])}continousPanRight(){this._continuousPan([tt,0])}continousPanUp(){this._continuousPan([0,tt])}continousPanDown(){this._continuousPan([0,-tt])}stop(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),this._endTimer!==null&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(r){const e=this.get("view.viewpoint");this.animationManager.animateContinous(e,t=>{Ne(t,t,r),this.view.constraints.constrainByGeometry(t)})}_startTimer(r){return this._endTimer!==null||(this._endTimer=setTimeout(()=>{this._endTimer=null;const e=performance.now()-this._lastEventTimestamp;e<Li?this._endTimer=this._startTimer(e):this._set("interacting",!1)},r)),this._endTimer}_getDefaultAnchor(){const{size:r,padding:{left:e,right:t,top:i,bottom:s}}=this.view;return Ft[0]=.5*(r[0]-t+e),Ft[1]=.5*(r[1]-s+i),Ft}async _zoomToScale(r,e=this._getDefaultAnchor()){const{view:t}=this,{constraints:i,scale:s,viewpoint:n,size:a,padding:o}=t,l=i.canZoomInTo(r),h=i.canZoomOutTo(r);if(!(r<s&&!l||r>s&&!h))return Ut(Tt,n,r/s,0,e,a,o),i.constrainByGeometry(Tt),t.goTo(Tt,{animate:!0})}_scaleRotateTranslateViewpoint(r,e,t,i,s){const{view:n}=this,{size:a,padding:o,constraints:l,scale:h,viewpoint:_}=n,d=h*t,c=l.canZoomInTo(d),m=l.canZoomOutTo(d);return(t<1&&!c||t>1&&!m)&&(t=1),Ne(_,_,s),Ut(r,_,t,i,e,a,o),l.constrainByGeometry(r)}};M([R()],Z.prototype,"animationManager",void 0),M([R({type:Boolean,readOnly:!0})],Z.prototype,"interacting",void 0),M([R()],Z.prototype,"pan",void 0),M([R()],Z.prototype,"pinch",void 0),M([R()],Z.prototype,"rotate",void 0),M([R()],Z.prototype,"view",void 0),M([R()],Z.prototype,"zoomBox",void 0),Z=M([pe("esri.views.2d.navigation.MapViewNavigation")],Z);const xo=Z,Vi={shaders:{vertexShader:L("magnifier/magnifier.vert"),fragmentShader:L("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};function Pa(r){return Me(r,Vi)}async function Aa(r){const e=import("./mask-svg.03f23d26.js"),t=import("./overlay-svg.4d0d565d.js"),i=Zt((await e).default,{signal:r}),s=Zt((await t).default,{signal:r}),n={mask:await i,overlay:await s};return Ot(r),n}class To extends Hs{constructor(){super(),this._handles=new Is,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(e){this._magnifier=e,this._handles.removeAll(),this._handles.add([Pt(e,"version",()=>{this.visible=e.visible&&B(e.position)&&e.size>0,this.requestRender()}),e.watch(["mask","overlay"],()=>this._reloadResources()),e.watch("size",()=>{this._disposeRenderResources(),this.requestRender()})])}_createTransforms(){return{dvs:At()}}doRender(e){var t;const i=e.context;if(!this._resourcesTask)return void this._reloadResources();if(e.drawPhase!==k.MAP||!this._canRender())return;this._updateResources(e);const s=this._magnifier;if(D(s.position))return;const n=e.pixelRatio,a=s.size*n,o=1/s.factor,l=Math.ceil(o*a);this._readbackTexture.resize(l,l);const{size:h}=e.state,_=n*h[0],d=n*h[1],c=.5*l,m=.5*l,p=N(n*s.position.x,c,_-c-1),u=N(d-n*s.position.y,m,d-m-1);i.setBlendingEnabled(!0);const f=p-c,w=u-m,b=this._readbackTexture;i.bindTexture(b,0),i.gl.copyTexImage2D(b.descriptor.target,0,b.descriptor.pixelFormat,f,w,l,l,0);const v=(t=this.background)==null?void 0:t.color,g=v?[v.a*v.r/255,v.a*v.g/255,v.a*v.b/255,v.a]:[1,1,1,1],x=(p+s.offset.x*n)/_*2-1,y=(u-s.offset.y*n)/d*2-1,C=a/_*2,F=a/d*2,S=this._program;i.bindVAO(this._vertexArrayObject),i.bindTexture(this._overlayTexture,6),i.bindTexture(this._maskTexture,7),i.useProgram(S),S.setUniform4fv("u_background",g),S.setUniform1i("u_readbackTexture",0),S.setUniform1i("u_overlayTexture",6),S.setUniform1i("u_maskTexture",7),S.setUniform4f("u_drawPos",x,y,C,F),S.setUniform1i("u_maskEnabled",s.maskEnabled?1:0),S.setUniform1i("u_overlayEnabled",s.overlayEnabled?1:0),i.setStencilTestEnabled(!1),i.setColorMask(!0,!0,!0,!0),i.drawArrays(5,0,4),i.bindVAO()}_canRender(){return this.mask&&this.overlay&&this._magnifier!=null}_reloadResources(){this._resourcesTask&&this._resourcesTask.abort();const e=B(this._magnifier)?this._magnifier.maskUrl:null,t=B(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=zs(async i=>{const s=D(e)||D(t)?Aa(i):null,n=B(e)?xe(e,{responseType:"image",signal:i}).then(h=>h.data):s.then(h=>h.mask),a=B(t)?xe(t,{responseType:"image",signal:i}).then(h=>h.data):s.then(h=>h.overlay),[o,l]=await Promise.all([n,a]);this.mask=o,this.overlay=l,this._disposeRenderResources(),this.requestRender()})}_disposeRenderResources(){this._readbackTexture=Fe(this._readbackTexture),this._overlayTexture=Fe(this._overlayTexture),this._maskTexture=Fe(this._maskTexture),this._vertexArrayObject=Fe(this._vertexArrayObject),this._program=Fe(this._program)}_updateResources(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const t=e.context;this._resourcePixelRatio=e.pixelRatio;const i=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=Pa(t);const s={geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},n=new Uint16Array([0,1,0,0,1,1,1,0]),a=Vi.attributes;this._vertexArrayObject=new ae(t,a,s,{geometry:ie.createVertex(t,35044,n)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new I(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,preMultiplyAlpha:!Us(this.overlay.src)||!e.context.driverTest.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new I(t,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask);const o=1/this._magnifier.factor;this._readbackTexture=new I(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.ceil(o*i),height:Math.ceil(o*i)})}}export{Co as GraphicContainer,So as GraphicsView2D,yo as LabelManager,To as MagnifierView2D,xo as MapViewNavigation,wo as Stage};
