import{e as yt}from"./deduplicate-8uOXlcvp.js";import{H as lt}from"./InterleavedLayout-Dvj-Snan.js";import{e as T}from"./VertexAttribute-Cq4MnHjR.js";import{RegularEdgeInstancesLayout as z,SilhouetteEdgeInstancesLayout as K,EdgeInputBufferLayout as $t}from"./bufferLayouts-C7weggCO.js";import{a0 as Y,bn as It}from"./Accessor-BHnuXKD2.js";import{p as Nt,o as q,s as nt,P as X,K as At,_ as ut,c as ot,A as ft,u as xt}from"./vec32-Dvg_eL9J.js";import{n as A}from"./vec3f64-BLpZdpfb.js";import{t as pt}from"./glUtil-D0YUa0ow.js";import{s as G}from"./Normals-OOhKYumi.js";import{b as St,s as gt}from"./mathUtils-DV9iOXpW.js";class vt{constructor(){this.position0=A(),this.position1=A(),this.faceNormal0=A(),this.faceNormal1=A(),this.componentIndex=0,this.cosAngle=0}}const k=-1;function Lt(t,n,o){const r=t.vertices.position,i=t.vertices.componentIndex,u=m.position0,g=m.position1,d=m.faceNormal0,$=m.faceNormal1,{edges:a,normals:f}=Vt(t),w=a.length/4,I=n.allocate(w);let O=0;const F=w,x=o==null?void 0:o.allocate(F);let U=0,e=0,s=0;C.length=0;for(let p=0;p<w;++p){const v=4*p;r.getVec(a.data[v],u),r.getVec(a.data[v+1],g);const _=C.pushNew();_.index=4*p,_.length=Nt(u,g)}C.sort((p,v)=>v.length-p.length);const l=new Array,c=new Array;C.forAll(({length:p,index:v})=>{const _=a.data[v],wt=a.data[v+1],Z=a.data[v+2],tt=a.data[v+3],et=tt===k;if(r.getVec(_,u),r.getVec(wt,g),et){const N=3*Z;q(d,f.data[N],f.data[N+1],f.data[N+2]),nt($,d),m.componentIndex=i.get(_),m.cosAngle=X(d,$)}else{let N=3*Z;if(q(d,f.data[N],f.data[N+1],f.data[N+2]),N=3*tt,q($,f.data[N],f.data[N+1],f.data[N+2]),m.componentIndex=i.get(_),m.cosAngle=X(d,$),Et(m,Pt))return;m.cosAngle<-.9999&&nt($,d)}e+=p,s++,et||bt(m,Ft)?(n.write(I,O++,m),l.push(p)):Ot(m,dt)&&(x&&o&&o.write(x,U++,m),c.push(p))});const y=new Float32Array(l.reverse()),S=new Float32Array(c.reverse()),L=x&&o?{instancesData:x.slice(0,U),lodInfo:{lengths:S}}:void 0;return{regular:{instancesData:I.slice(0,O),lodInfo:{lengths:y}},silhouette:L,averageEdgeLength:e/s}}function bt(t,n){return t.cosAngle<n}function Et(t,n){return t.cosAngle>n}function Ot(t,n){const o=St(t.cosAngle);return At(st,t.position1,t.position0),o*(X(ut(Bt,t.faceNormal0,t.faceNormal1),st)>0?-1:1)>n}function Vt(t){const n=t.faces.length/3,o=t.faces,r=t.neighbors,i=t.vertices.position;h.length=H.length=0;for(let u=0;u<n;u++){const g=3*u,d=r[g],$=r[g+1],a=r[g+2],f=o[g],w=o[g+1],I=o[g+2];i.getVec(f,V),i.getVec(w,D),i.getVec(I,W),ot(D,D,V),ot(W,W,V),ut(V,D,W),ft(V,V),H.pushArray(V),(d===k||f<w)&&(h.push(f),h.push(w),h.push(u),h.push(d)),($===k||w<I)&&(h.push(w),h.push(I),h.push(u),h.push($)),(a===k||I<f)&&(h.push(I),h.push(f),h.push(u),h.push(a))}return{edges:h,normals:H}}class _t{constructor(){this.index=0,this.length=0}}const C=new Y({allocator:t=>t||new _t,deallocator:null}),h=new Y({deallocator:null}),H=new Y({deallocator:null}),m=new vt,Bt=A(),st=A(),V=A(),D=A(),W=A(),dt=gt(4),Pt=Math.cos(dt),Mt=gt(35),Ft=Math.cos(Mt);function rt(t,n,o){const r=n/3,i=new Uint32Array(o+1),u=new Uint32Array(o+1),g=(e,s)=>{e<s?i[e+1]++:u[s+1]++};for(let e=0;e<r;e++){const s=t[3*e],l=t[3*e+1],c=t[3*e+2];g(s,l),g(l,c),g(c,s)}let d=0,$=0;for(let e=0;e<o;e++){const s=i[e+1],l=u[e+1];i[e+1]=d,u[e+1]=$,d+=s,$+=l}const a=new Uint32Array(6*r),f=i[o],w=(e,s,l)=>{if(e<s){const c=i[e+1]++;a[2*c]=s,a[2*c+1]=l}else{const c=u[s+1]++;a[2*f+2*c]=e,a[2*f+2*c+1]=l}};for(let e=0;e<r;e++){const s=t[3*e],l=t[3*e+1],c=t[3*e+2];w(s,l,e),w(l,c,e),w(c,s,e)}const I=(e,s)=>{const l=2*e,c=s-e;for(let y=1;y<c;y++){const S=a[l+2*y],L=a[l+2*y+1];let p=y-1;for(;p>=0&&a[l+2*p]>S;p--)a[l+2*p+2]=a[l+2*p],a[l+2*p+3]=a[l+2*p+1];a[l+2*p+2]=S,a[l+2*p+3]=L}};for(let e=0;e<o;e++)I(i[e],i[e+1]),I(f+u[e],f+u[e+1]);const O=new Int32Array(3*r),F=(e,s)=>e===t[3*s]?0:e===t[3*s+1]?1:e===t[3*s+2]?2:-1,x=(e,s)=>{const l=F(e,s);O[3*s+l]=-1},U=(e,s,l,c)=>{const y=F(e,s);O[3*s+y]=c;const S=F(l,c);O[3*c+S]=s};for(let e=0;e<o;e++){let s=i[e];const l=i[e+1];let c=u[e];const y=u[e+1];for(;s<l&&c<y;){const S=a[2*s],L=a[2*f+2*c];S===L?(U(e,a[2*s+1],L,a[2*f+2*c+1]),s++,c++):S<L?(x(e,a[2*s+1]),s++):(x(L,a[2*f+2*c+1]),c++)}for(;s<l;)x(e,a[2*s+1]),s++;for(;c<y;)x(a[2*f+2*c],a[2*f+2*c+1]),c++}return O}const R=.7;let ht=class{updateSettings(n){this.settings=n,this._edgeHashFunction=n.reducedPrecision?Ut:Tt}write(n,o,r){j.seed=this._edgeHashFunction(r);const i=j.getIntRange(0,255),u=j.getIntRange(0,this.settings.variants-1),g=j.getFloat(),d=255*(.5*Ct(-(1-Math.min(g/R,1))+Math.max(0,g-R)/(1-R),1.2)+.5);n.position0.setVec(o,r.position0),n.position1.setVec(o,r.position1),n.componentIndex.set(o,r.componentIndex),n.variantOffset.set(o,i),n.variantStroke.set(o,u),n.variantExtension.set(o,d)}};const b=new Float32Array(6),E=new Uint32Array(b.buffer),M=new Uint32Array(1);function Tt(t){return b[0]=t.position0[0],b[1]=t.position0[1],b[2]=t.position0[2],b[3]=t.position1[0],b[4]=t.position1[1],b[5]=t.position1[2],M[0]=31*(31*(31*(31*(31*(166811+E[0])+E[1])+E[2])+E[3])+E[4])+E[5],M[0]}function Ut(t){const n=b;n[0]=B(t.position0[0]),n[1]=B(t.position0[1]),n[2]=B(t.position0[2]),n[3]=B(t.position1[0]),n[4]=B(t.position1[1]),n[5]=B(t.position1[2]),M[0]=5381;for(let o=0;o<E.length;o++)M[0]=31*M[0]+E[o];return M[0]}const at=1e4;function B(t){return Math.round(t*at)/at}function Ct(t,n){return Math.abs(t)**n*Math.sign(t)}class J{constructor(){this._commonWriter=new ht}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return z.createBuffer(n)}write(n,o,r){this._commonWriter.write(n,o,r),xt(P,r.faceNormal0,r.faceNormal1),ft(P,P);const{typedBuffer:i,typedBufferStride:u}=n.normalCompressed;G(i,o,P[0],P[1],P[2],u)}}J.Layout=z,J.glLayout=pt(z,1);class Q{constructor(){this._commonWriter=new ht}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return K.createBuffer(n)}write(n,o,r){this._commonWriter.write(n,o,r);{const{typedBuffer:i,typedBufferStride:u}=n.normalCompressed;G(i,o,r.faceNormal0[0],r.faceNormal0[1],r.faceNormal0[2],u)}{const{typedBuffer:i,typedBufferStride:u}=n.normal2Compressed;G(i,o,r.faceNormal1[0],r.faceNormal1[1],r.faceNormal1[2],u)}}}Q.Layout=K,Q.glLayout=pt(K,1);const P=A(),j=new It;function Dt(t){const n=mt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return it.updateSettings(t.writerSettings),ct.updateSettings(t.writerSettings),Lt(n,it,ct)}function mt(t,n,o,r){if(n){const g=rt(o,r,t.count);return new Wt(o,r,g,t)}const i=yt(t.buffer,t.stride/4,{originalIndices:o,originalIndicesLength:r}),u=rt(i.indices,r,i.uniqueCount);return{faces:i.indices,facesLength:i.indices.length,neighbors:u,vertices:$t.createView(i.buffer)}}class Wt{constructor(n,o,r,i){this.faces=n,this.facesLength=o,this.neighbors=r,this.vertices=i}}const it=new J,ct=new Q,jt=lt().vec3f(T.POSITION0).vec3f(T.POSITION1),kt=lt().vec3f(T.POSITION0).vec3f(T.POSITION1).u16(T.COMPONENTINDEX),te=Object.freeze(Object.defineProperty({__proto__:null,extract:Dt,extractComponentsEdgeLocationsLayout:kt,extractEdgeInformation:mt,extractEdgeLocationsLayout:jt},Symbol.toStringTag,{value:"Module"}));export{Q as N,jt as d,te as e,Dt as f,kt as m,Lt as p,mt as u,J as w};
