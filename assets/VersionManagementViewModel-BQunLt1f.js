const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./createVersion-N9MsL3SY.js","./assets-C43MgM-v.js","./subclass-BZA_h8Db.js","./index-Bh2oEzTI.js","./index-2kwcjS9-.css","./tslib.es6-B3Jf3DVX.js","./Accessor-BLX9ikPh.js","./utils-6jMaHUrH.js","./CreateVersionParameters-yTm5JwCr.js","./deleteVersion-BDS1iy3s.js","./serverVersionUtils-XL3pUZsI.js","./DeleteVersionParameters-BF6h4Ux_.js","./getVersion-CQp_mjnZ.js","./getVersionInfos-BhWsjt9H.js","./GetVersionInfosParameters-BcYSmTje.js","./reconcile-DkSuMpJF.js","./ReconcileParameters-DqNKZSGT.js","./jsonMap-0cxwUWs2.js","./post-AfGTbDC3.js","./PostParameters-C-bZT1It.js","./alterVersion-Dz2AktTH.js","./AlterVersionParameters-CCPPNpuz.js","./startReading-DutCCnWL.js","./stopReading-CbTF-pOJ.js","./startEditing-CeRqbpB0.js","./deleteForwardEdits-DvZiU-zD.js","./DeleteForwardEditsParameters-CCrE6Z2I.js","./stopEditing-CEXMvDlq.js"])))=>i.map(i=>d[i]);
import{r as a}from"./tslib.es6-B3Jf3DVX.js";import{s as ye,p as D,b as we}from"./Accessor-BLX9ikPh.js";import{V as k}from"./Collection-CEdjem1-.js";import{g as Y,h as _e,O as ee,b as p,m as l,a as N,n as M,r as Ve,e as Ee}from"./subclass-BZA_h8Db.js";import{watch as x,on as te}from"./reactiveUtils-C5zUhJQJ.js";import{u as W,M as Se,i as Ie,U,j as de,x as ke}from"./assets-C43MgM-v.js";import{h as re}from"./UpdatingHandles-GfwcIh5z.js";import{x as ce}from"./layerUtils-BrNoooE9.js";import{b as Le}from"./Portal-C10FKnaA.js";import{s as be,t as Me}from"./utils-ChpoPxsr.js";import{s as xe}from"./Identifiable-B1UbsKNt.js";import{m as J}from"./Loadable-BabW5Xcc.js";import{o as A,r as Ue}from"./writer-DNAwXnhG.js";import{g as pe}from"./Point-Cg0-ChZE.js";import{m as ie,b as Re,f as Pe,j as Te,y as De,I as Oe}from"./applyEditsUtils-BWidamMq.js";import{checkEditingCapabilities as $e,normalizeEdits as Ae,normalizeGeometries as Ce}from"./editingSupport-CA_XWXsU.js";import{c as Ne,i as Fe,a as He,t as S,s as g,b as O,l as We,n as se,u as b}from"./EditBusLayer-DoTks2sU.js";import{T as Je}from"./featureLayerUtils-DBsQMhTm.js";import{i as oe,n as E,r as ne}from"./serviceCapabilitiesUtils-DAE5z8FP.js";import je from"./PortalItem-DzgXrpyc.js";import{E as qe}from"./portalItemUtils-BzVoFAku.js";import{f as C,i as Ge,s as Qe}from"./utils-6jMaHUrH.js";import{i as ze}from"./editsZScale-Bs7_pSzI.js";import{d as Be}from"./arcgisLayerUrl-BX1FE5Hm.js";import{_ as h}from"./index-Bh2oEzTI.js";import{a as ae}from"./catalogUtils-DyGHPM81.js";import"./Evented-BHRw9x22.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./asyncUtils-CWX51uTe.js";import"./Extent-Bf3YTe7m.js";import"./locale-C9TlLpzi.js";import"./jsonMap-0cxwUWs2.js";import"./Promise-B2Hu02L7.js";import"./cast-Bjksrh93.js";import"./Graphic-DsxsIjhH.js";import"./geometry-D964gYQX.js";import"./Polyline-D9YkgmM_.js";import"./mathUtils-C4_ghTv4.js";import"./PopupTemplate-BHMhS05j.js";import"./Clonable-D3rtuBWg.js";import"./fieldUtils-tmQlKvWo.js";import"./intl-CChhNOV8.js";import"./date-DlqISzcw.js";import"./messages-OmQvZhAg.js";import"./enumeration-Ba5njXdz.js";import"./Color-BCS62Hs5.js";import"./colorUtils-0bJDPow9.js";import"./ActionToggle-iT4slXc7.js";import"./symbols-CNimns--.js";import"./TextSymbol-D8QO_KUV.js";import"./screenUtils-_ZIvrt5o.js";import"./materialUtils-DarhapKC.js";import"./opacityUtils-C68Tlu6_.js";import"./vec3f64-BLpZdpfb.js";import"./aaBoundingBox-BE7cC1jD.js";import"./persistableUrlUtils-fa1mAujs.js";import"./collectionUtils-D_lHIu88.js";import"./jsonUtils-CEfjT-BK.js";import"./projection-B971H0Re.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";import"./MeshTransform-D2t3aEmK.js";import"./mat4-GpOFENPA.js";import"./common-DQOJ18NT.js";import"./mat4f64-Dk4dwAN8.js";import"./quat-4pa1e6ds.js";import"./mat3f64-BBpwCtoL.js";import"./quatf64-CCm9z-pX.js";import"./vec32-Dvg_eL9J.js";import"./vec42-YcqnINSP.js";import"./axisAngleDegrees-Ci2HA7Jo.js";import"./uuid-fwrPAdZb.js";import"./normalizeUtils-EVmAQ-ak.js";import"./normalizeUtilsCommon-dT81xWiM.js";import"./utils-Bema0iXE.js";import"./infoFor3D-C0hFfS1m.js";import"./Field-ybkHhtnK.js";import"./fieldType-BuzM0UHS.js";import"./featureQueryAll-DnVoEjkM.js";import"./Query-5Xpquc1r.js";import"./DataLayerSource-BKkswDvG.js";import"./FullTextSearch-Csd1Hktu.js";import"./TimeExtent-DocT5yPf.js";import"./timeUtils-8fb_2oAt.js";import"./SimpleRenderer-BV2L9G_n.js";import"./UniqueValueRenderer-BQtAHUSo.js";import"./diffUtils-BP7jmOAy.js";import"./colorRamps-pKd7I5WZ.js";import"./SizeVariable-936USOrb.js";import"./sizeVariableUtils-Cmcuvw-4.js";import"./visualVariableUtils-DX1kS9Se.js";import"./compilerUtils-Dw3R0f-Z.js";import"./lengthUtils-DL1-FDQQ.js";import"./ColorStop-Dk3U5tCk.js";import"./jsonUtils-Ds2Sqto-.js";import"./defaults-DZ1kfMRx.js";import"./defaultsJSON-GKolV7NZ.js";import"./RendererLegendOptions-B-4se3aU.js";import"./styleUtils-BYTm14n3.js";import"./AttachmentQuery-BUlkjzkx.js";import"./RelationshipQuery-DPPNeuLK.js";function $(t,e){const r=e.id;return{id:r,name:e.name,url:`${t}/${r}`,type:e.type||"Table"}}function Ze(t){return{data:Ke(t),sync:tt(t),operations:Xe(t.capabilities,t),query:Ye(t),editing:et(t)}}function Ke(t){return{isDataVersioned:E(t,"hasVersionedData",!1),isDataBranchVersioned:E(t,"hasBranchVersionedData",!1)}}function Xe(t,e){const r=t?t.toLowerCase().split(",").map(d=>d.trim()):[],i=r.includes("query"),o=r.includes("editing")&&!e.datesInUnknownTimezone;let s=o&&r.includes("create"),n=o&&r.includes("delete"),u=o&&r.includes("update");return o&&!(s||n||u)&&(s=n=u=!0),{supportsAdd:s,supportsDelete:n,supportsEditing:o,supportsChangeTracking:r.includes("changetracking"),supportsQuery:i,supportsQueryDataElements:E(e,"supportsQueryDataElements",!1),supportsQueryDomains:E(e,"supportsQueryDomains",!1),supportsQueryContingentValues:E(e,"supportsQueryContingentValues",!1),supportsSync:r.includes("sync"),supportsUpdate:u}}function Ye(t){return{maxRecordCountFactor:ne(t,"maxRecordCountFactor",void 0),maxRecordCount:ne(t,"maxRecordCount",void 0)}}function et(t){const e=t==null?void 0:t.advancedEditingCapabilities;return{supportsGlobalId:E(t,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:E(e,"supportsReturnServiceEditsInSourceSR",!1),supportsSplit:E(e,"supportsSplit",!1),supportsAsyncApplyEdits:E(e,"supportsAsyncApplyEdits",!1)}}function tt(t){const e=t==null?void 0:t.syncCapabilities,r=e==null?void 0:e.supportedSyncDataOptions;return{supportsAsync:E(e,"supportsAsync",!1),supportedSyncDataOptions:{annotations:!(1&~r),dimensions:!(2&~r),contingentValues:!(4&~r),attributeRules:!(8&~r),utilityNetworkSystem:!(16&~r),annotationFullModel:!(32&~r),include3DObjects:!(64&~r),utilityNetworkMissingLayers:!(128&~r),preserveTrueCurves:!(256&~r)}}}let f=class extends W(xe(J)){constructor(t){super(t),this.url=null,this.sourceJSON=null,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1,this.userTypeExtensions=[],this.layerInfos=null,this.tableInfos=null,this.capabilities=null}read(t,e){this.sourceJSON=t,super.read(t,e)}get utilityNetworkUrl(){if(this.sourceJSON){for(const t of this.sourceJSON.layers)if(t.type==="Utility Network Layer")return`${this.url}/${t.id}`}return null}get versionManagementServiceUrl(){var t;return(t=this.sourceJSON)!=null&&t.hasBranchVersionedData&&!Se(this.url)?this.url.replace(/\/FeatureServer/i,"/VersionManagementServer"):null}readLayerInfos(t,e){return(e.layers||[]).map(r=>{const{type:i,geometryType:o}=r;return{...$(this.url,r),type:i||"Feature Layer",geometryType:o}})}readTableInfos(t,e){return(e.tables||[]).map(r=>$(this.url,r))}readCapabilities(t,e){return Ze(e)}get effectiveCapabilities(){const t=this.capabilities;if(!t)return null;const e=Y(t),{operations:r}=e;return this.userHasUpdateItemPrivileges?(r.supportsAdd=r.supportsDelete=r.supportsEditing=r.supportsQuery=r.supportsUpdate=!0,e):(this.userHasFullEditingPrivileges&&r.supportsEditing&&(r.supportsAdd=r.supportsDelete=r.supportsUpdate=!0),e)}load(t){return this.addResolvingPromise(this._fetchService(this.url,t).then(()=>this._setUserPrivileges(t))),Promise.resolve(this)}async fetchAllLayersAndTables(t){return await this.load(t),this._fetchLayersAndTablesPromise||(this._fetchLayersAndTablesPromise=this._fetchLayersAndTables(this.url)),ye(t),this._fetchLayersAndTablesPromise}async applyEdits(t,e){let r=null;try{const{results:i,edits:o,editedFeatures:s}=await this._internalApplyEdits(t,e),n=d=>d.filter(c=>!c.error).map(Y);let u=0;return i.map(d=>{r=Ne(this.url,d.id,e==null?void 0:e.gdbVersion,!0);const c={edits:o[u],addedFeatures:n(d.addFeatureResults),updatedFeatures:n(d.updateFeatureResults),deletedFeatures:n(d.deleteFeatureResults),addedAttachments:n(d.addAttachmentResults),updatedAttachments:n(d.updateAttachmentResults),deletedAttachments:n(d.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:d.editMoment?new Date(d.editMoment):null};u+=1,s.length>0&&(c.editedFeatures=s),r.resolve(c),r=null}),i}catch(i){throw r&&r.reject(i),i}}async _setUserPrivileges(t){if(_e.userPrivilegesApplied)try{const{features:{fullEdit:e},content:{updateItem:r}}=await this._fetchUserPrivileges(this.sourceJSON.serviceItemId,t);this._set("userHasFullEditingPrivileges",e),this._set("userHasUpdateItemPrivileges",r)}catch(e){D(e)}}async _fetchUserPrivileges(t,e){var d;if(!t)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};let s,n,u;try{s=await ce(this.url,e)}catch(c){D(c)}try{const c=e!=null?e.signal:null;n=await((d=Ie)==null?void 0:d.getCredential(`${s}/sharing`,{prompt:!1,signal:c}))}catch(c){D(c)}if(!n)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};try{if(u=new je({id:t,portal:{url:s}}),await u.load(e),u.portal.user)return qe(u)}catch(c){D(c)}return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}}}async _internalApplyEdits(t,e){await Je(this.url);const r=(e==null?void 0:e.globalIdUsed)??!1,i=pe.fromJSON(this.sourceJSON.spatialReference),{edits:o,options:s}=await this._processApplyEditsParams(t,e),n=await Promise.all(o.map(async _=>{var K,X;const F=((K=_.addFeatures)==null?void 0:K.map(H=>ie({spatialReference:i},H,null)))??[],q=(await Promise.all(F)).filter(ee),G=q.length>0?q:null,ge=((X=_.updateFeatures)==null?void 0:X.map(H=>ie({spatialReference:i},H,null)))??[],Q=(await Promise.all(ge)).filter(ee),z=Q.length>0?Q:null,B=Re(_.identifierFields,_.deleteFeatures,r),fe=B.length>0?B:null;ze(G,z,i);const I=await Pe(_.identifierFields,_);let Z=null;return I&&(Z={adds:I.adds.length>0?I.adds:void 0,updates:I.updates.length>0?I.updates:void 0,deletes:I.deletes.length>0?I.deletes:void 0}),{id:_.id,adds:G,updates:z,deletes:fe,attachments:Z}})),u={gdbVersion:s==null?void 0:s.gdbVersion,rollbackOnFailure:!0,useGlobalIds:r,returnEditMoment:!0,honorSequenceOfEdits:s==null?void 0:s.honorSequenceOfEdits,usePreviousEditMoment:s==null?void 0:s.usePreviousEditMoment,returnServiceEditsInSourceSR:!1,returnServiceEditsOption:"originalAndCurrentFeatures",async:!1};await Fe(this.url,e==null?void 0:e.gdbVersion,!0);const d=He(this.url,(e==null?void 0:e.gdbVersion)||null);u.edits=JSON.stringify(n);const c=C(this.url),y=Ge(c.query,{query:Qe({...u,f:"json"}),method:"post"});let v;d&&(y.authMode="immediate",y.query.sessionId=S);try{v=await U(this.url+"/applyEdits",y)}catch(_){if(!Te(_))throw _;y.authMode="immediate",v=await U(this.url+"/applyEdits",y)}return{...rt(v),edits:o}}async _processApplyEditsParams(t,e){const r={...e};return{edits:await Promise.all(t.map(async i=>{const o=this.effectiveCapabilities,s=i&&(i.addFeatures||i.updateFeatures||i.deleteFeatures),n=i&&(i.addAttachments||i.updateAttachments||i.deleteAttachments);if($e(i,o,e,!!s,!!n,"feature-service"),!o.data.isDataVersioned&&(e==null?void 0:e.gdbVersion))throw new p("feature-service:invalid-parameter","'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isDataVersioned'");const u=Ae(i,o,"feature-service");return{...await Ce(u),id:i.id,identifierFields:i.identifierFields}})),options:r}}async _fetchService(t,e){if(this.sourceJSON)return void this.read(this.sourceJSON,{url:C(t)});const r=await U(t,{responseType:"json",query:{f:"json"},...e});this.read(r.data,{url:C(t)})}async _fetchLayersAndTables(t){const e=`${t}/layers`,r=await U(e,{responseType:"json",query:{f:"json"}});return{layers:r.data.layers.map(i=>{const{type:o,geometryType:s}=i,n=$(this.url,i),u=oe(i,n.url);return{...n,type:o||"Feature Layer",geometryType:s,capabilities:u}}),tables:r.data.tables.map(i=>{const o=$(this.url,i),s=oe(i,o.url);return{...o,capabilities:s}})}}};function rt(t){const e=t.data,r=[];return{results:e.map(i=>{const o={addResults:i.addResults??[],updateResults:i.updateResults??[],deleteResults:i.deleteResults??[],attachments:i.attachments,editMoment:i.editMoment},s=De(o),n=i.editedFeatures,u=n!=null&&n.spatialReference?new pe({wkid:n==null?void 0:n.spatialReference.wkid,wkt:n==null?void 0:n.spatialReference.wkt,latestWkid:n==null?void 0:n.spatialReference.latestWkid,latestVcsWkid:n==null?void 0:n.spatialReference.latestVcsWkid,vcsWkid:n==null?void 0:n.spatialReference.vcsWkid}):null,d=n?Oe(n,u):null;return d&&r.push({layerId:i.id,editedFeatures:d}),{id:i.id,editedFeatures:d,...s}}),editedFeatures:r}}a([l()],f.prototype,"url",void 0),a([l()],f.prototype,"sourceJSON",void 0),a([l()],f.prototype,"userHasFullEditingPrivileges",void 0),a([l()],f.prototype,"userHasUpdateItemPrivileges",void 0),a([l({readOnly:!0})],f.prototype,"utilityNetworkUrl",null),a([l({readOnly:!0})],f.prototype,"versionManagementServiceUrl",null),a([l()],f.prototype,"userTypeExtensions",void 0),a([l({json:{read:{source:["layers"]}}})],f.prototype,"layerInfos",void 0),a([A("layerInfos",["layers"])],f.prototype,"readLayerInfos",null),a([l({json:{read:{source:["tables"]}}})],f.prototype,"tableInfos",void 0),a([A("tableInfos",["tables"])],f.prototype,"readTableInfos",null),a([l({readOnly:!0,json:{read:{source:["hasVersionedData","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"]}}})],f.prototype,"capabilities",void 0),a([A("capabilities",["hasVersionedData","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"])],f.prototype,"readCapabilities",null),a([l({readOnly:!0})],f.prototype,"effectiveCapabilities",null),f=a([N("esri.rest.featureService.FeatureService")],f);const j=f,he=(t,e)=>{for(const r of t)if(r.type==="feature"||r.type==="subtype-group"){if(!r.url)continue;const i=Be(r.url).url.path,o=e.get(i);if(o)o.layers.push(r);else{const s=new j({url:i}),n=[r];e.set(i,{featureService:s,layers:n})}}else r.type==="group"&&he(r.layers,e)};function it(t){const e=new Map;return he(t,e),e}let w=class extends W(J){constructor(e){super(e),this.versionManagementService=null,this.featureServiceUrl=null,this.url=null,this.currentVersion=null,this.currentVersionInfo=null,this.versionInfos=[],this.versionableItems=new k,this.usePersistentReadSessions=!1,this.state="lock-none"}initialize(){this.url=this.versionManagementService.url,this.featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),this.addHandles([this.versionableItems.on("before-add",e=>{if(e.item.featureServiceUrl.toLowerCase()!==this.featureServiceUrl.toLowerCase())return e.preventDefault(),void M.getLogger(this).error("#add()","Cannot add versionAdapter, feature service urls do not match.")}),this.versionableItems.on("before-remove",e=>{if(this.versionableItems.items.length===0&&this.currentVersion&&"name"in this.currentVersion&&this.versionManagementService.getLockType(this.currentVersion)!=="none")return e.preventDefault(),void M.getLogger(this).error("#remove()","Cannot remove last versionAdapter.")})])}load(e){return this.addResolvingPromise(this._setUpState(e)),Promise.resolve(this)}get defaultVersionIdentifier(){return this.versionManagementService.defaultVersionIdentifier}get isDefault(){return!this.currentVersion||!!this.currentVersion&&"name"in this.currentVersion&&this.currentVersion.name===this.defaultVersionIdentifier.name}async getVersionInfos(e=!1){return e&&(this.versionInfos=await this.versionManagementService.getVersionInfos()),this.versionInfos}async alterVersion(e,r){if(this.currentVersion&&"guid"in this.currentVersion&&e.guid===this.currentVersion.guid)return!1;const i=await this.versionManagementService.alterVersion(e,r);return i&&await this.getVersionInfos(!0),i}async deleteVersion(e){if(this.currentVersion&&"guid"in this.currentVersion&&e.guid===this.currentVersion.guid)return!1;const r=await this.versionManagementService.deleteVersion(e);return r&&await this.getVersionInfos(!0),r}async getVersionInfoExtended(){return this.currentVersion&&"name"in this.currentVersion?this.versionManagementService.getVersionInfoExtended(this.currentVersion):this.versionManagementService.getVersionInfoExtended(this.defaultVersionIdentifier)}async startEditing(){if(this._isDefaultOrHistoricVersion())return{success:!1};if(!this.usePersistentReadSessions){const r=await this.versionManagementService.startReadingWithResult(this.currentVersion);if(!r.success)return r;this.state="lock-read"}const e=await this.versionManagementService.startEditingWithResult(this.currentVersion);return e.success&&(this.state="lock-write"),e}async stopEditing(e){if(this._isDefaultOrHistoricVersion())return{success:!1};const r=await this.versionManagementService.stopEditingWithResult(this.currentVersion,e);if(!r.success)return r;if(this.state="lock-read",!this.usePersistentReadSessions){const i=await this.versionManagementService.stopReadingWithResult(this.currentVersion);return i.success&&(this.state="lock-none"),i}return r}async changeVersion(e){var s;let r=null;if(this.usePersistentReadSessions){if(this._isDefaultOrHistoricVersion(e))e&&"name"in e?(r=await this.versionManagementService.getVersionInfoExtended(e),this.state=(r==null?void 0:r.access)==="public"?"lock-none":"lock-read"):this.state="lock-read";else if(!await this.versionManagementService.startReading(e))throw new p("Failed to acquire read lock for version: "+e);this._isDefaultOrHistoricVersion(this.currentVersion)||await this.versionManagementService.stopReading(this.currentVersion)}const i=await this.versionManagementService.changeVersionWithResult(this.versionableItems,this.currentVersion,e);let o=!1;return i.forEach((n,u)=>{o=o||n.success}),o&&(this.currentVersion=e,this.currentVersionInfo=r||await this.getVersionInfoExtended(),this._isDefaultOrHistoricVersion()?this.currentVersion&&"name"in this.currentVersion?this.state=((s=this.currentVersionInfo)==null?void 0:s.access)==="public"?"lock-none":"lock-read":this.state="lock-read":this.state=this.versionManagementService.getLockType(this.currentVersion)!=="read"?"lock-none":"lock-read"),i}async undo(){return this._isDefaultOrHistoricVersion()?{success:!1}:(this.versionManagementService.undo(this.currentVersion),{success:!0})}async redo(){return this._isDefaultOrHistoricVersion()?{success:!1}:(this.versionManagementService.redo(this.currentVersion),{success:!0})}async _setUpState(e){var r;await this.versionManagementService.load(e),this.state="lock-none",this.currentVersionInfo=await this.getVersionInfoExtended(),this.versionableItems.forEach(i=>{this.currentVersion?"name"in this.currentVersion?(i.gdbVersion=this.currentVersion.name,i.historicMoment=null):(i.historicMoment=this.currentVersion,i.gdbVersion=null):(i.gdbVersion=null,i.historicMoment=null)}),this.usePersistentReadSessions&&(this._isDefaultOrHistoricVersion()?this.currentVersion&&"name"in this.currentVersion?this.state=((r=this.currentVersionInfo)==null?void 0:r.access)==="public"?"lock-none":"lock-read":this.state="lock-read":await this.versionManagementService.startReading(this.currentVersion)&&(this.state="lock-read"))}_isDefaultOrHistoricVersion(e=this.currentVersion){return!(e&&"name"in e)||e.name===this.versionManagementService.defaultVersionIdentifier.name}};a([l()],w.prototype,"versionManagementService",void 0),a([l()],w.prototype,"featureServiceUrl",void 0),a([l()],w.prototype,"url",void 0),a([l()],w.prototype,"currentVersion",void 0),a([l()],w.prototype,"currentVersionInfo",void 0),a([l()],w.prototype,"versionInfos",void 0),a([l()],w.prototype,"versionableItems",void 0),a([l()],w.prototype,"usePersistentReadSessions",void 0),a([l()],w.prototype,"state",void 0),a([l({readOnly:!0})],w.prototype,"defaultVersionIdentifier",null),a([l({readOnly:!0})],w.prototype,"isDefault",null),w=a([N("esri.versionManagement.VersioningState")],w);const me=w;let st=class{constructor(e){this.moments=[],this.forwardMoments=[],this.moments.push(e)}push(e){return this.forwardMoments.length,this.moments.push(e)}pop(){if(!(this.forwardMoments.length>0))return this.moments.pop()}undo(){if(!this.canUndo())return;const e=this.moments.pop();return this.forwardMoments.push(e),e}peek(){return this.moments.at(-1)}canUndo(){return this.moments.length>1}canRedo(){return this.hasForwardEdits()}redo(){if(!this.canRedo())return;const e=this.forwardMoments.pop();return this.moments.push(e),e}size(){return this.moments.length+this.forwardMoments.length}hasForwardEdits(){return this.forwardMoments.length>0}clearForwardEdits(){this.forwardMoments=[]}},R=class{constructor(e){this.versionableItem=e,this.type="feature-layer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){const e=/^(.*\/FeatureServer)\/\d+$/;return this.versionableItem.url.replace(e,"$1")}};a([l({readOnly:!0})],R.prototype,"type",void 0),a([l()],R.prototype,"gdbVersion",null),a([l({type:Date})],R.prototype,"historicMoment",null),a([l({readOnly:!0})],R.prototype,"featureServiceUrl",null);let P=class{constructor(e){this.versionableItem=e,this.type="network"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){return this.versionableItem.featureServiceUrl}};a([l({readOnly:!0})],P.prototype,"type",void 0),a([l()],P.prototype,"gdbVersion",null),a([l({type:Date})],P.prototype,"historicMoment",null),a([l({readOnly:!0})],P.prototype,"featureServiceUrl",null);class T{constructor(e){this.versionableItem=e,this.type="subtype-group-layer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){const e=/^(.*\/FeatureServer)\/\d+$/;return this.versionableItem.url.replace(e,"$1")}}a([l({readOnly:!0})],T.prototype,"type",void 0),a([l()],T.prototype,"gdbVersion",null),a([l({type:Date})],T.prototype,"historicMoment",null),a([l({readOnly:!0})],T.prototype,"featureServiceUrl",null);function ue(t){return"networkServiceUrl"in t?new P(t):t.type!=="feature"||ae(t)?t.type!=="subtype-group"||ae(t)?null:new T(t):new R(t)}function L(t){const e=[];for(const r of t)if(r.type==="group"){const i=r,o=i.allTables.concat(i.allLayers);for(const s of o)if(s.type==="feature"||s.type==="subtype-group"){const n=ue(s);n&&e.push(n)}}else{const i=ue(r);i&&e.push(i)}return e}let V=class extends W(J){constructor(t){super(t),this.url=null,this.sourceJSON=null,this.name=null,this.defaultVersionIdentifier=null,this.capabilities=null,this._isDefault=e=>!e||e===this.defaultVersionIdentifier.name,this._dateEquals=(e,r)=>!e&&!r||!(!e||!r)&&e.toISOString()===r.toISOString(),this._applyEditsHandler=e=>{const{serviceUrl:r,gdbVersion:i,result:o}=e;r===this._featureServiceUrl&&o.then(s=>{const n=s.historicMoment;n&&this._addMomentToVersionItem(i,n)})}}initialize(){this.url=de(this.url),this._featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),g.has(this.url)||g.set(this.url,new Map);const t=(O.get(this.url)??0)+1;O.set(this.url,t),this.when().then(()=>this.addHandles(We(this._applyEditsHandler)),()=>{})}destroy(){const t=(O.get(this.url)??1)-1;O.set(this.url,t),t===0&&g.delete(this.url),se.delete(this._featureServiceUrl)}read(t,e){this.sourceJSON=t,super.read(t,e)}readDefaultVersionIdentifier(t,e){return{name:e.defaultVersionName,guid:e.defaultVersionGuid}}writeDefaultVersionIdentifier(t,e){e.defaultVersionName=t.name,e.defaultVersionGuid=t.guid}load(t){return this.addResolvingPromise(this._fetchService(this.url,t)),Promise.resolve(this)}async createVersion(t){const[{createVersion:e},{default:r}]=await Promise.all([h(()=>import("./createVersion-N9MsL3SY.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url),h(()=>import("./CreateVersionParameters-yTm5JwCr.js"),__vite__mapDeps([8,5,1,2,3,4,6]),import.meta.url)]),i=r.from(t);return e(this.url,i)}async deleteVersion(t){var s;const[{deleteVersion:e},{default:r}]=await Promise.all([h(()=>import("./deleteVersion-BDS1iy3s.js"),__vite__mapDeps([9,1,2,3,4,5,6,7,10]),import.meta.url),h(()=>import("./DeleteVersionParameters-BF6h4Ux_.js"),__vite__mapDeps([11,5,1,2,3,4,6]),import.meta.url)]);let i;t.guid&&((s=g.get(this.url))!=null&&s.has(t.guid))&&(i=S??void 0);const o=new r({versionName:t.name,sessionId:i});return e(this.url,o)}async getVersionInfoExtended(t){const{getVersion:e}=await h(()=>import("./getVersion-CQp_mjnZ.js"),__vite__mapDeps([12,1,2,3,4,5,6,7]),import.meta.url);return e(this.url,t.guid)}async getVersionInfos(t={}){const[{getVersionInfos:e},{default:r}]=await Promise.all([h(()=>import("./getVersionInfos-BhWsjt9H.js"),__vite__mapDeps([13,1,2,3,4,5,6,7]),import.meta.url),h(()=>import("./GetVersionInfosParameters-BcYSmTje.js"),__vite__mapDeps([14,5,1,2,3,4,6]),import.meta.url)]),i=r.from(t);return e(this.url,i)}async reconcile(t,e={}){const[{reconcile:r},{default:i}]=await Promise.all([h(()=>import("./reconcile-DkSuMpJF.js"),__vite__mapDeps([15,1,2,3,4,5,6,7,10]),import.meta.url),h(()=>import("./ReconcileParameters-DqNKZSGT.js"),__vite__mapDeps([16,5,17,2,1,3,4,6]),import.meta.url)]),o=i.from(e);return o.sessionId=S,r(this.url,t.guid,o)}async post(t){const[{post:e},{default:r}]=await Promise.all([h(()=>import("./post-AfGTbDC3.js"),__vite__mapDeps([18,1,2,3,4,5,6,7,10]),import.meta.url),h(()=>import("./PostParameters-C-bZT1It.js"),__vite__mapDeps([19,5,1,2,3,4,6]),import.meta.url)]),i=r.from({sessionId:S});return e(this.url,t.guid,i)}async alterVersion(t,e){const[{alterVersion:r},{default:i}]=await Promise.all([h(()=>import("./alterVersion-Dz2AktTH.js"),__vite__mapDeps([20,1,2,3,4,5,6,7,10]),import.meta.url),h(()=>import("./AlterVersionParameters-CCPPNpuz.js"),__vite__mapDeps([21,5,1,2,3,4,6]),import.meta.url)]),o=i.from(e);return r(this.url,t.guid,o)}async startReading(t){return(await this.startReadingWithResult(t)).success}async startReadingWithResult(t){const{startReading:e}=await h(()=>import("./startReading-DutCCnWL.js"),__vite__mapDeps([22,1,2,3,4,5,6,7]),import.meta.url),r=await e(this.url,t.guid,S);if(r.success){const i=await this.getVersionInfoExtended(t),o=new Date(i.modifiedDate),s={name:i.versionIdentifier.name,moment:o,lockType:"read"};this._addOrUpdateItem(t.guid,s),b(this._featureServiceUrl,null,t.name,o)}return r}async stopReading(t){return(await this.stopReadingWithResult(t)).success}async stopReadingWithResult(t){var i;const{stopReading:e}=await h(()=>import("./stopReading-CbTF-pOJ.js"),__vite__mapDeps([23,1,2,3,4,5,6,7]),import.meta.url),r=await e(this.url,t.guid,S);return r.success&&((i=g.get(this.url))==null||i.delete(t.guid),b(this._featureServiceUrl,null,t.name,null)),r}async startEditing(t){return(await this.startEditingWithResult(t)).success}async startEditingWithResult(t){const{startEditing:e}=await h(()=>import("./startEditing-CeRqbpB0.js"),__vite__mapDeps([24,1,2,3,4,5,6,7]),import.meta.url),r=await e(this.url,t.guid,S);if(r.success){const i=await this.getVersionInfoExtended(t),o=new Date(i.modifiedDate),s=new st(o),n={name:t.name,moment:o,lockType:"edit",stack:s};this._addOrUpdateItem(t.guid,n),b(this._featureServiceUrl,null,t.name,o)}return r}async stopEditing(t,e){return(await this.stopEditingWithResult(t,e)).success}async stopEditingWithResult(t,e){var o,s;if(e){const n=(o=g.get(this.url))==null?void 0:o.get(t.guid);if((s=n==null?void 0:n.stack)!=null&&s.canRedo()){const[{deleteForwardEdits:u},{default:d}]=await Promise.all([h(()=>import("./deleteForwardEdits-DvZiU-zD.js"),__vite__mapDeps([25,1,2,3,4,5,6,7]),import.meta.url),h(()=>import("./DeleteForwardEditsParameters-CCrE6Z2I.js"),__vite__mapDeps([26,5,1,2,3,4,6]),import.meta.url)]),c=await u(this.url,t.guid,new d({sessionId:S,moment:n.moment}));if(!c.success)return c}}const{stopEditing:r}=await h(()=>import("./stopEditing-CEXMvDlq.js"),__vite__mapDeps([27,1,2,3,4,5,6,7]),import.meta.url),i=await r(this.url,t.guid,S,e);if(i.success){const n=await this.getVersionInfoExtended(t),u=new Date(n.modifiedDate);this._addOrUpdateItem(t.guid,{name:t.name,moment:u,lockType:"read",editMomentStack:void 0}),b(this._featureServiceUrl,null,t.name,u)}return i}getLockType(t){var r,i;return((i=(r=g.get(this.url))==null?void 0:r.get(t.guid))==null?void 0:i.lockType)??"none"}async changeVersion(t,e,r){if(r&&"name"in r&&!await this.getVersionInfoExtended(r))throw new p("version-management-service:invalid-version","version does not exist");if("networkServiceUrl"in t){if(this._featureServiceUrl.toLowerCase()===t.featureServiceUrl.toLowerCase())return this._changeVersionInternal(t,e,r)}else{let i;"layers"in t?(i=t.allTables.concat(t.allLayers),t.utilityNetworks&&t.utilityNetworks.forEach(o=>{this._featureServiceUrl.toLowerCase()===o.featureServiceUrl.toLowerCase()&&this._changeVersionInternal(o,e,r)})):i=t;for(const o of i)if(o.type==="feature"||o.type==="subtype-group"){const s=/^(.*\/FeatureServer)\/\d+$/,n=o.url.replace(s,"$1");if(this._featureServiceUrl.toLowerCase()===n.toLowerCase()&&!this._changeVersionInternal(o,e,r))return!1}else if(o.type==="group"){const s=o.allTables.concat(o.allLayers);for(const n of s)if(n.type==="feature"||n.type==="subtype-group"){const u=/^(.*\/FeatureServer)\/\d+$/,d=n.url.replace(u,"$1");if(this._featureServiceUrl.toLowerCase()===d.toLowerCase()&&!this._changeVersionInternal(n,e,r))return!1}}}return!0}async changeVersionWithResult(t,e,r){let i;if("layers"in t){const s=L(t.allTables.concat(t.allLayers).filter(n=>n.type!=="group").toArray());t.utilityNetworks&&t.utilityNetworks.forEach(n=>{const u=L([n]);s.push(...u)}),i=s}else i=t;if(r&&"name"in r&&!await this.getVersionInfoExtended(r)){const s=new Map;for(const n of i)s.set(n,{success:!1});return s}if(e&&"name"in e&&this.getLockType(e)!=="none"){const s=new Map;for(const n of i)s.set(n,{success:!1});return s}const o=new Map;for(const s of i)if(s)if(s.featureServiceUrl.toLowerCase()===this._featureServiceUrl.toLowerCase()){const n=this._changeVersionInternalWithResult(s,e,r);o.set(s,n)}else o.set(s,{success:!1});return o}async getVersionIdentifierFromName(t){var e;try{return((e=(await this.getVersionInfos({includeHidden:!0})).find(i=>i.versionIdentifier.name===t))==null?void 0:e.versionIdentifier)||null}catch{return null}}async getVersionIdentifierFromGuid(t){const{getVersion:e}=await h(()=>import("./getVersion-CQp_mjnZ.js"),__vite__mapDeps([12,1,2,3,4,5,6,7]),import.meta.url);try{return(await e(this.url,t)).versionIdentifier}catch{return null}}canUndo(t){var r,i;const e=(r=g.get(this.url))==null?void 0:r.get(t.guid);return!!((i=e==null?void 0:e.stack)!=null&&i.canUndo())}canRedo(t){var r,i;const e=(r=g.get(this.url))==null?void 0:r.get(t.guid);return!!((i=e==null?void 0:e.stack)!=null&&i.canRedo())}undo(t){var i,o,s;const e=(i=g.get(this.url))==null?void 0:i.get(t.guid),r=((o=e==null?void 0:e.stack)==null?void 0:o.undo())||void 0;if(e&&r){const n=e.stack.peek();b(this._featureServiceUrl,null,t.name,n),(s=g.get(this.url))==null||s.set(t.guid,{...e,moment:n})}}redo(t){var i,o,s;const e=(i=g.get(this.url))==null?void 0:i.get(t.guid),r=((o=e==null?void 0:e.stack)==null?void 0:o.redo())||void 0;e&&r&&(b(this._featureServiceUrl,null,t.name,r),(s=g.get(this.url))==null||s.set(t.guid,{...e,moment:r}))}_setUpData(t,e){let r=null,i=null,o=null,s=null;const n=u=>{var c,y;const d=(y=(c=g)==null?void 0:c.get(this.url))==null?void 0:y.get(u.guid);o=u.name,s=(d==null?void 0:d.moment)??null};if(t&&"name"in t){if(this.getLockType(t)!=="none")throw new p("version-management-service:version-locked","version is locked");r=t.name,i=null,e&&"name"in e?n(e):(o=this.defaultVersionIdentifier.name,s=e)}else r=this.defaultVersionIdentifier.name,i=t,e&&"name"in e?n(e):(o=this.defaultVersionIdentifier.name,s=e);return{fromVersionName:r,fromMoment:i,toVersionName:o,toMoment:s}}_changeVersionInternal(t,e,r){try{const{fromVersionName:i,fromMoment:o,toVersionName:s,toMoment:n}=this._setUpData(e,r);(this._isDefault(i)&&this._isDefault(t.gdbVersion)&&this._dateEquals(t.historicMoment,o)||i===t.gdbVersion&&this._dateEquals(t.historicMoment,o))&&(t.gdbVersion=s,t.historicMoment=n)}catch{return!1}return!0}_changeVersionInternalWithResult(t,e,r){try{const{fromVersionName:i,fromMoment:o,toVersionName:s,toMoment:n}=this._setUpData(e,r);return this._isDefault(i)&&this._isDefault(t.gdbVersion)&&this._dateEquals(t.historicMoment,o)||i===t.gdbVersion&&this._dateEquals(t.historicMoment,o)?(t.gdbVersion=s,t.historicMoment=n,{success:!0}):{success:!1}}catch{return{success:!1}}}_addMomentToVersionItem(t,e){const r=g.get(this.url);if(r)for(const[i,o]of r)o.name===t&&this._addToStack(i,e)}_addToStack(t,e){const r=g.get(this.url),i=r==null?void 0:r.get(t);return!!(i!=null&&i.stack)&&(ot(i.stack.peek(),e)&&i.stack.push(e),r.set(t,{...i,moment:e}),!0)}_addOrUpdateItem(t,e){const r=g.get(this.url),i=r==null?void 0:r.get(t);return i?(r.set(t,{...i,...e}),!0):!(!e.name||!e.lockType)&&(r==null||r.set(t,{...e,lockType:e.lockType}),!0)}async _fetchService(t,e){if(this.sourceJSON){this.read(this.sourceJSON,{origin:"service",url:C(t)});const i=new ke(this.url).host;return void se.set(i,this.defaultVersionIdentifier.name)}const r=await U(t,{responseType:"json",query:{f:"json"},...e});this.read(r.data)}};function ot(t,e){return t?t.getTime()<e.getTime():!0}a([l()],V.prototype,"url",void 0),a([l()],V.prototype,"sourceJSON",void 0),a([l({type:String,json:{write:!0}})],V.prototype,"name",void 0),a([l({json:{write:{target:{defaultVersionName:{type:String},defaultVersionGuid:{type:String}}},read:{source:["defaultVersionName","defaultVersionGuid"]}}})],V.prototype,"defaultVersionIdentifier",void 0),a([A("defaultVersionIdentifier",["defaultVersionName","defaultVersionGuid"])],V.prototype,"readDefaultVersionIdentifier",null),a([Ue("defaultVersionIdentifier",{defaultVersionName:{type:String},defaultVersionGuid:{type:String}})],V.prototype,"writeDefaultVersionIdentifier",null),a([l({json:{write:!0}})],V.prototype,"capabilities",void 0),V=a([N("esri.versionManagement.VersionManagementService")],V);const ve=V;async function nt(t,e){let r;if("layers"in t){const s=L(t.allTables.concat(t.allLayers).filter(n=>n.type!=="group").toArray());t.utilityNetworks&&t.utilityNetworks.forEach(n=>{const u=L([n]);s.push(...u)}),r=s}else r=new k(t);const i=new Map;for(const s of r){const n=i.get(s.featureServiceUrl);n?n.push(s):i.set(s.featureServiceUrl,new k([s]))}const o=new k;for(const[s,n]of i){const u=new j({url:s});if(await u.load(),!u.versionManagementServiceUrl)continue;const d=new ve({url:u.versionManagementServiceUrl});o.push(new me({versionManagementService:d,versionableItems:n,usePersistentReadSessions:e}))}return o}const le=new Map;async function at(t,e=!1){const r=await nt(t.map,e);return Ve(le,t,()=>(t.addHandles(Ee(()=>{le.delete(t),r.forEach(i=>i.destroy())})),r.forEach(i=>i.load().catch(o=>{M.getLogger("esri.versionManagement.VersioningState").error("Failed to load Versioning State",o)})),r))}let m=class extends we{constructor(t){super(t),this._portalLookup=new Map,this._updatingHandlesLoad=new re,this._updatingHandlesExecute=new re,this.advancedEditingUserTypeExtensionLookup=new Map,this.executionError=void 0,this.featureServiceLookup=new Map,this.loadError=void 0,this.serverVersionLookup=new Map,this.serviceNameLookup=new Map,this.userLookup=new Map,this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionAdministratorLookup=new Map,this.versionManagementServiceLookup=new Map,this.versioningStateLookup=new Map,this.view=null,this.versioningStates=null}initialize(){this._viewChangeHandle(),this.addHandles([x(()=>this.view,()=>{this._resetAllLookupProperties(),this._viewChangeHandle()}),x(()=>this.versioningStates,()=>{this._resetVersioningLookupProperties(),this._setVersioningStatesLookups()})])}destroy(){this._updatingHandlesLoad.destroy(),this._updatingHandlesExecute.destroy()}get state(){return this._updatingHandlesLoad.updating?"loading":this.loadError?"disabled":this._updatingHandlesExecute.updating?"executing":this.executionError?"failed":"ready"}async alterVersion(t){return this._updatingHandlesExecute.addPromise(this._alterVersionInternal(t))}async changeVersion(t,e,r){return this._updatingHandlesExecute.addPromise(this._changeVersionInternal(t,e,r))}async createVersion(t){return this._updatingHandlesExecute.addPromise(this._createVersionInternal(t))}async deleteVersion(t,e,r){return this._updatingHandlesExecute.addPromise(this._deleteVersionInternal(t,e,r))}async getVersionInfos(t){return this._updatingHandlesExecute.addPromise(this._getVersionInfosInternal(t))}async _alterVersionInternal(t){if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new p("version-management-view-model:load-error",this.loadError);this._setExecutionError();const e=this.versioningStateLookup.get(t.featureServerUrl);if(!e)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new p("version-management-view-model:execution-error",this.executionError);if(!this.serverVersionLookup.has(t.featureServerUrl)||this.serverVersionLookup.get(t.featureServerUrl)<=11.1)throw this._logError("version-management-view-model:execution-error","no-valid-enterprise-version"),new p("version-management-view-model:execution-error",this.executionError);if(!this.advancedEditingUserTypeExtensionLookup.get(t.featureServerUrl))throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new p("version-management-view-model:execution-error",this.executionError);const{featureServerUrl:r,versionIdentifier:i,...o}=t,s=await e.alterVersion(i,o).catch(n=>{throw this._logExecutionError(n),n});return await this.getVersionInfos(r),s}async _changeVersionInternal(t,e,r){if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new p("version-management-view-model:load-error",this.loadError);this._setExecutionError();const i=this.versioningStateLookup.get(t);if(!i)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new p("version-management-view-model:execution-error",this.executionError);const o={name:e,guid:r};return await i.changeVersion(o).catch(s=>{throw this._logExecutionError(s),s})}_updateVersionableItems(t){this._updatingHandlesLoad.addPromise((async()=>{L(t.added).forEach(e=>{const r=e.featureServiceUrl,i=this.versioningStateLookup.get(r);i&&(i.versionableItems.find(o=>o.versionableItem===e.versionableItem)||i.versionableItems.add(e))}),L(t.removed).forEach(e=>{const{allLayers:r,allTables:i}=this.view.map,o=e.featureServiceUrl,s=this.versioningStateLookup.get(o);if(!s)return void this._logError("version-management-view-model:execution-error","no-version-management-service-found");const n=d=>{var c;return(d.type==="feature"||d.type==="subtype-group")&&(((c=d.url)==null?void 0:c.includes(o))??!1)};[...r.filter(n),...i.filter(n)].length||(this.featureServiceLookup.delete(o),this.serviceNameLookup.delete(o),this.versioningStateLookup.delete(o),this.versioningStates.remove(s));const u=s.versionableItems.find(d=>d.versionableItem===e.versionableItem);u&&s.versionableItems.remove(u)})})())}async _createVersionInternal(t){var d,c,y;if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new p("version-management-view-model:load-error",this.loadError);this._setExecutionError();const e=t.featureServerUrl,r=this.versioningStateLookup.get(e);if(!r)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new p("version-management-view-model:execution-error",this.executionError);const i=this.advancedEditingUserTypeExtensionLookup.get(t.featureServerUrl),o=this.userLookup.get(e).toUpperCase(),s=this._isEmptyString(t.ownerName)?o:(d=t.ownerName)==null?void 0:d.trim().toUpperCase();if(s!==o){if(this.serverVersionLookup.get(e)<=11.1)throw this._logError("version-management-view-model:execution-error","versioning-api-error"),new p("version-management-view-model:execution-error",this.executionError);if(!i)throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new p("version-management-view-model:execution-error",this.executionError)}let n=await((c=this.versioningStateLookup.get(e))==null?void 0:c.getVersionInfos());if((s==null?void 0:s.toUpperCase())==="SDE"&&t.versionName.toUpperCase()==="DEFAULT"||n!=null&&n.find(v=>v.versionIdentifier.name.toUpperCase()===(s+"."+t.versionName).toUpperCase()||v.versionIdentifier.name.toUpperCase()===(o+"."+t.versionName).toUpperCase()))throw this._logError("version-management-view-model:execution-error","no-valid-version-name"),new p("version-management-view-model:execution-error",this.executionError);const u=await r.versionManagementService.createVersion({versionName:t.versionName,access:s!==o?"public":t.access,description:t.description}).catch(v=>{throw this._logExecutionError(v),v});if(s!==o){const{guid:v,name:_}=u.versionIdentifier,F={featureServerUrl:e,versionIdentifier:{guid:v,name:_},access:t.access,ownerName:s};await this.alterVersion(F)||this.deleteVersion(e,o+"."+t.versionName,u.versionIdentifier.guid)}return await this.getVersionInfos(e),n=await((y=this.versioningStateLookup.get(e))==null?void 0:y.getVersionInfos()),n==null?void 0:n.find(v=>v.versionIdentifier.guid===u.versionIdentifier.guid)}async _deleteVersionInternal(t,e,r){if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new p("version-management-view-model:load-error",this.loadError);this._setExecutionError();const i=this.versioningStateLookup.get(t);if(!i)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new p("version-management-view-model:execution-error",this.executionError);if(this.serverVersionLookup.get(t)<=11.1)throw this._logError("version-management-view-model:execution-error","versioning-api-error"),new p("version-management-view-model:execution-error",this.executionError);if(!this.advancedEditingUserTypeExtensionLookup.get(t))throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new p("version-management-view-model:execution-error",this.executionError);const o={name:e,guid:r};return await i.deleteVersion(o).catch(s=>{throw this._logExecutionError(s),new p("version-management-view-model:execution-error",this.executionError)})}async _getVersionInfosInternal(t){var s,n;if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new p("version-management-view-model:load-error",this.loadError);this._setExecutionError();const e=(s=this.featureServiceLookup.get(t))==null?void 0:s.featureService;if(!e)throw this._logError("version-management-view-model:execution-error","no-feature-service-found"),new p("version-management-view-model:execution-error",this.executionError);e.loaded||await e.load().catch(u=>{throw this._logExecutionError(u),u});const r=e.url;this.serverVersionLookup.set(r,((n=e.sourceJSON)==null?void 0:n.currentVersion)??0),this.serverVersionLookup.get(r)<=11.1&&this.advancedEditingUserTypeExtensionLookup.set(r,!1);const i=this.userLookup.get(t);this._portalLookup.get(t)&&i?(this.advancedEditingUserTypeExtensionLookup.set(r,await be(this._portalLookup.get(t),i,"advediting")),this.versionAdministratorLookup.set(r,await Me(this._portalLookup.get(t),i,"features:user:manageVersions"))):(this.advancedEditingUserTypeExtensionLookup.set(r,!1),this.versionAdministratorLookup.set(r,!1));const o=this.versioningStateLookup.get(t);if(!o)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new p("version-management-view-model:execution-error",this.executionError);return o.loaded||await o.load().catch(u=>{throw this._logExecutionError(u),u}),await o.getVersionInfos(!0).catch(u=>{throw this._logExecutionError(u),u})}_isEmptyString(t){return!t||t.trim().length===0}_logError(t,e){switch(M.getLogger(this).error(new p(t,e)),t){case"version-management-view-model:load-error":this._setLoadError(e);break;case"version-management-view-model:execution-error":this._setExecutionError(e)}}_logExecutionError(t){this._logError("version-management-view-model:execution-error",t.message)}async _viewChangeHandle(){this._updatingHandlesLoad.addPromise((async()=>{if(this._setLoadError(),!this.view)return void this._setLoadError("no-view-property");if(this.view&&this.view.type!=="2d")return void this._logError("version-management-view-model:load-error","sceneView-not-supported");this.removeHandles("map-change-handle"),this.addHandles([x(()=>{var e;return(e=this.view)==null?void 0:e.map},()=>{this._resetAllLookupProperties(),this._mapChangeHandle(this.versioningStates)})],"map-change-handle");const t=await this._getVersioningStates();await this._mapChangeHandle(t)})())}async _mapChangeHandle(t){this._updatingHandlesLoad.addPromise((async()=>{this._setLoadError(),this.removeHandles("map-layers-tables-change-handle"),this.addHandles([te(()=>{var e;return(e=this.view)==null?void 0:e.map.allLayers},"change",e=>{(e.added.some(({type:r})=>r==="feature")||e.removed.some(({type:r})=>r==="feature")||e.added.some(({type:r})=>r==="subtype-group")||e.removed.some(({type:r})=>r==="subtype-group"))&&(this._resetServiceRelatedLookupProperties(),this._propertiesChangeInternal(this.versioningStates),this._updateVersionableItems(e))}),te(()=>{var e;return(e=this.view)==null?void 0:e.map.allTables},"change",e=>{(e.added.some(({type:r})=>r==="feature")||e.removed.some(({type:r})=>r==="feature")||e.added.some(({type:r})=>r==="subtype-group")||e.removed.some(({type:r})=>r==="subtype-group"))&&(this._resetServiceRelatedLookupProperties(),this._propertiesChangeInternal(this.versioningStates),this._updateVersionableItems(e))})],"map-layers-tables-change-handle"),await this._propertiesChangeInternal(t)})())}async _propertiesChangeInternal(t){this._updatingHandlesLoad.addPromise((async()=>{var o;const e=s=>s.type==="feature"||s.type==="subtype-group",{allLayers:r,allTables:i}=this.view.map;if(this._setLoadError(),this.featureServiceLookup=it([...r.filter(e),...i.filter(e)]),this.featureServiceLookup.size){this._updateFeatureServiceLookup(t),this.serviceNameLookup=new Map;for(const s of this.featureServiceLookup.values()){const{featureService:n,featureService:{url:u}}=s;if(!this.serviceNameLookup.has(u)){if(n.loaded||await n.load().catch(v=>{M.getLogger(this).error(v)}),!n.versionManagementServiceUrl){this.featureServiceLookup.delete(u);continue}const d=await ce(u),c=new Le({authMode:"immediate",url:d});await c.load().catch(v=>{M.getLogger(this).error(v)});const y=(o=c.user)==null?void 0:o.username;if(!n.loaded||!c.loaded||!y)continue;this.serviceNameLookup.set(de(u),u.split("/").at(-2)),this.userLookup.set(u,y),this._portalLookup.set(u,c)}}this.removeHandles("versioning-states-change-handle"),t.forEach(s=>this._handleVersioningStateLookupUpdate(s)),await this._updateVersioningStates(t),this.versioningStates=t}else this._logError("version-management-view-model:load-error","no-feature-services")})())}_updateFeatureServiceLookup(t){for(const e of t){const r=e.featureServiceUrl;if(!this.featureServiceLookup.has(r)){const i=new j({url:r}),o=e.versionableItems.toArray().flatMap(s=>s.type==="network"?null:s.versionableItem);this.featureServiceLookup.set(r,{featureService:i,layers:o})}}}async _updateVersioningStates(t){for(const e of this.featureServiceLookup.values()){const r=e.featureService;if(r.versionManagementServiceUrl){if(!t.find(i=>i.featureServiceUrl===r.url)&&r.versionManagementServiceUrl){const i=new k(L(e.layers)),o=new me({versionManagementService:new ve({url:r.versionManagementServiceUrl}),versionableItems:i});t.add(o),this._handleVersioningStateLookupUpdate(o)}await this.getVersionInfos(r.url)}}}async _getVersioningStates(){return this.versioningStates&&this.versioningStates.length?this.versioningStates:this.view?await at(this.view,!1):(this._logError("version-management-view-model:load-error","no-view-property"),new k)}_handleVersioningStateLookupUpdate(t){var e;this.versioningStateLookup.set(t.featureServiceUrl,t),this._addHandlesToVersioningState(t),this.versionIdentifierLookup.set(t.featureServiceUrl,(e=t.currentVersionInfo)==null?void 0:e.versionIdentifier),this.versionManagementServiceLookup.set(t.featureServiceUrl,t.versionManagementService)}async _setVersioningStatesLookups(){this._updatingHandlesLoad.addPromise((async()=>{this.versioningStates&&(this.removeHandles("versioning-states-change-handle"),this._updateFeatureServiceLookup(this.versioningStates),this.versioningStates.forEach(t=>this._handleVersioningStateLookupUpdate(t)),await this._updateVersioningStates(this.versioningStates))})())}_addHandlesToVersioningState(t){this.addHandles([x(()=>t.versionInfos,()=>{this.versionInfoLookup.set(t.featureServiceUrl,t.versionInfos)}),x(()=>{var e;return(e=t.currentVersionInfo)==null?void 0:e.versionIdentifier},()=>{var e;this.versionIdentifierLookup.set(t.featureServiceUrl,(e=t.currentVersionInfo)==null?void 0:e.versionIdentifier)})],"versioning-states-change-handle")}_resetVersioningLookupProperties(){this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionManagementServiceLookup=new Map,this.versioningStateLookup=new Map}_resetAllLookupProperties(){this._portalLookup=new Map,this.advancedEditingUserTypeExtensionLookup=new Map,this.serverVersionLookup=new Map,this.userLookup=new Map,this.versioningStates=new k,this._resetVersioningLookupProperties(),this._resetServiceRelatedLookupProperties()}_resetServiceRelatedLookupProperties(){this.featureServiceLookup=new Map,this.serviceNameLookup=new Map}_setExecutionError(t){this._set("executionError",t)}_setLoadError(t){this._set("loadError",t)}};a([l()],m.prototype,"_portalLookup",void 0),a([l()],m.prototype,"advancedEditingUserTypeExtensionLookup",void 0),a([l({readOnly:!0})],m.prototype,"executionError",void 0),a([l()],m.prototype,"featureServiceLookup",void 0),a([l({readOnly:!0})],m.prototype,"loadError",void 0),a([l()],m.prototype,"serverVersionLookup",void 0),a([l()],m.prototype,"serviceNameLookup",void 0),a([l({readOnly:!0})],m.prototype,"state",null),a([l()],m.prototype,"userLookup",void 0),a([l()],m.prototype,"versionIdentifierLookup",void 0),a([l()],m.prototype,"versionInfoLookup",void 0),a([l()],m.prototype,"versionAdministratorLookup",void 0),a([l()],m.prototype,"versionManagementServiceLookup",void 0),a([l()],m.prototype,"versioningStateLookup",void 0),a([l()],m.prototype,"view",void 0),a([l()],m.prototype,"versioningStates",void 0),m=a([N("esri.widgets.VersionManagement.VersionManagementViewModel")],m);const ni=m;export{ni as default};
