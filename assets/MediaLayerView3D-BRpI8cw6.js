const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ManipulatedObject3DMediaElement-C1o7iY9V.js","./tslib.es6-B3Jf3DVX.js","./Evented-BHRw9x22.js","./Accessor-BLX9ikPh.js","./subclass-BZA_h8Db.js","./reactiveUtils-C5zUhJQJ.js","./asyncUtils-CWX51uTe.js","./Collection-CEdjem1-.js","./shared-B3wH2qpO.js","./SimpleObservable-KocWTzVy.js","./geometry-D964gYQX.js","./Extent-Bf3YTe7m.js","./Point-Cg0-ChZE.js","./cast-Bjksrh93.js","./writer-DNAwXnhG.js","./assets-C43MgM-v.js","./index-Bh2oEzTI.js","./index-2kwcjS9-.css","./jsonMap-0cxwUWs2.js","./Polyline-D9YkgmM_.js","./mathUtils-C4_ghTv4.js","./UpdatingHandles-GfwcIh5z.js","./projection-B971H0Re.js","./vec3f64-BLpZdpfb.js","./projectBuffer-Bs7GwaPY.js","./geodesicConstants-DWQLYX7F.js","./EditGeometryOperations-Cl8Sbfxr.js","./compilerUtils-Dw3R0f-Z.js","./vec2-maR1OrZI.js","./common-DQOJ18NT.js","./vec2f64-miziP1SN.js","./vec32-Dvg_eL9J.js","./vec42-YcqnINSP.js","./vec4f64-o2zAXfmz.js","./ViewingMode-Dodu7ZZk.js","./plane-IENfwZlB.js","./mat3f64-BBpwCtoL.js","./mat4f64-Dk4dwAN8.js","./quatf64-CCm9z-pX.js","./mathUtils-BG-eq9fO.js","./geometry2dUtils-DdyQE7AQ.js","./projectPointToVector-GINIbYMz.js","./VideoElement-DlpZ7VDv.js","./imageUtils-CtmzXUTE.js","./uuid-fwrPAdZb.js","./resourceExtension-D8MnQ6oV.js","./persistableUrlUtils-fa1mAujs.js","./Identifiable-B1UbsKNt.js","./Loadable-BabW5Xcc.js","./Promise-B2Hu02L7.js","./MultiOriginJSONSupport-B5nfqtQh.js","./Clonable-D3rtuBWg.js","./perspectiveUtils-DUm6VYra.js","./normalizeUtilsSync-BUrHV6iS.js","./jsonUtils-CEfjT-BK.js","./normalizeUtilsCommon-dT81xWiM.js","./mat3-BRl2i9Bz.js","./screenUtils-_ZIvrt5o.js","./editingTools-COUq-DTn.js","./colorUtils-aL8wj-8G.js","./Color-BCS62Hs5.js","./colorUtils-0bJDPow9.js","./elevationInfoUtils-BC_66_Fg.js","./unitConversionUtils-BMfW9yAe.js","./lengthUtils-DL1-FDQQ.js","./ElevationInfo-CA5m_tHv.js","./fieldUtils-tmQlKvWo.js","./intl-CChhNOV8.js","./date-DlqISzcw.js","./locale-C9TlLpzi.js","./messages-OmQvZhAg.js","./viewUtils-DrPohWV3.js","./quantityFormatUtils-CX8UdSzC.js","./quantityUtils-D0GB2dMc.js","./projectVectorToVector-G2uWGoIb.js","./spatialReferenceEllipsoidUtils-DBE_OFra.js","./Cyclical-oTUX3aX7.js","./unitFormatUtils-CZ2bRlFg.js","./ByteSizeUnit-BsxeN7wM.js","./getDefaultUnitForView-Ce2vZZap.js","./Portal-C10FKnaA.js","./TextOverlayItem-zxgmE06K.js","./jsxFactory-CJa39Fro.js","./automaticLengthMeasurementUtils-BXgXm1JY.js","./geodesicLengthMeasurementUtils-he3vjGJN.js","./geometryEngine-DGiYLHJy.js","./geometryEngineBase-yFIvKOkM.js","./_commonjsHelpers-DCkdB7M8.js","./hydrated-C9rxSL4a.js","./geodesicUtils-FCYOaNwu.js","./geodesicMeasurementUtils-Bt9h4589.js","./SnappingVisualizer3D-BL4wyEeI.js","./ExtendedLineVisualElement-BaVIzd5h.js","./frustum-CQrOepbv.js","./sphere-C77djCO6.js","./mat4-GpOFENPA.js","./lineSegment-D7sKPPYf.js","./EngineVisualElement-DAbK0X3b.js","./RibbonLine.glsl-BZu1FDpE.js","./computeTranslationToOriginAndRotation-Q27G6TBL.js","./dehydratedFeatureUtils-B--Sgpdi.js","./intersectorUtils-BK9EUwUf.js","./boundedPlane-EV1sS2Ke.js","./verticalOffsetUtils-BDQLpfho.js","./orientedBoundingBox-DOAJUK5g.js","./quat-4pa1e6ds.js","./ElevationProvider-C95wyCKc.js","./VertexAttribute-Cq4MnHjR.js","./hydratedFeatures-DBKLr8hT.js","./Graphic-DsxsIjhH.js","./PopupTemplate-BHMhS05j.js","./enumeration-Ba5njXdz.js","./ActionToggle-iT4slXc7.js","./symbols-CNimns--.js","./TextSymbol-D8QO_KUV.js","./materialUtils-DarhapKC.js","./opacityUtils-C68Tlu6_.js","./aaBoundingBox-BE7cC1jD.js","./collectionUtils-D_lHIu88.js","./Material-_xx7OZxD.js","./interfaces-DDtDqZYj.js","./Texture-Fac_8AOC.js","./BindType-BmZEZMMh.js","./Util-BIfApRF5.js","./Texture-Begq2x5n.js","./enums-D9v74xTE.js","./renderState-DQLu6AJX.js","./Matrix3DrawUniform-CiBFaSz6.js","./ShaderTechniqueConfiguration-CBbn2DCi.js","./Indices-DflDlU4Z.js","./triangle-PTGDC_xJ.js","./AlphaCutoff-UcccL64p.js","./requestImageUtils-DgMiQwsm.js","./sdfPrimitives-CUWZbMRe.js","./vec3f32-nZdmKIgz.js","./doublePrecisionUtils-B0owpBza.js","./floatRGBA-CfH_2xsy.js","./Octree-C8d4sqjv.js","./InterleavedLayout-e-di2fxs.js","./BufferView-_QDXRCew.js","./Float4DrawUniform-N58YDhuZ.js","./MergedRenderer-Dli9s1X5.js","./VertexArrayObject-lPxPk5E-.js","./NestedMap-GuqgquCN.js","./glUtil-D0YUa0ow.js","./VertexElementDescriptor-BOD-G50G.js","./VisualElement-Bz1W-x8t.js","./LaserlineVisualElement-CUgS0u0n.js","./Blit-B-VutIER.js","./BufferObject-BVi1lwBq.js","./OverlayCompositing.glsl-CiE3Tt8y.js","./signal-D4lghLjV.js","./axisAngleDegrees-Ci2HA7Jo.js","./weather-eV4wTXCK.js","./HighlightDefaults-D4ckYWWJ.js","./Intersector-wXoCuQ8W.js","./Scheduler-CJu5awNf.js","./debugFlags-BF6Z0j0F.js","./LaserlinePath.glsl-CV6hrJ4l.js","./Object3DVisualElement-BVfa8i_P.js","./HUDMaterial.glsl-D6WRipwF.js","./graphicUtils-CWEFaVJb.js","./VertexColor.glsl-_ARMpsAT.js","./meshVertexSpaceUtils-CXzOFlTI.js","./MeshLocalVertexSpace-LEHwMUnu.js","./RightAngleQuadVisualElement-9e1qCkJI.js","./ColorMaterial.glsl-BF1fDRqL.js","./TriangleMaterial-BiHR3MKx.js","./SnappingManager-BJPyuu7J.js","./timeUtils-8fb_2oAt.js","./Query-5Xpquc1r.js","./DataLayerSource-BKkswDvG.js","./Field-ybkHhtnK.js","./fieldType-BuzM0UHS.js","./FullTextSearch-Csd1Hktu.js","./TimeExtent-DocT5yPf.js","./InputManager-Ba9xzDpe.js","./Queue-yu3bZ02p.js","./keybindings-DoOdil3D.js","./utils-BpB3MnW1.js","./Version-BSlAgupz.js","./SnappingVisualizer-BtjTdiTG.js","./PointSnappingHint-D7X20mlb.js","./interfaces-DkjgzG8v.js","./settings-BHWvAK7h.js","./lineStippleUtils-C89mzWlO.js","./OutlineVisualElement-JiMQm3sc.js","./line-CML3g7Ng.js","./line-DxZlo8wx.js","./triangulationUtils-DWWEtF_0.js","./earcut-Lltz9D9k.js","./deduplicate-DIJK2kGw.js","./VerticesVisualElement-B1xfXpYJ.js","./RenderObject-CuwfmXYe.js","./Compositing.glsl-DMM7CJmu.js","./interfaces-D6pIddIh.js","./GraphicState-Ch3zkYKf.js","./editPlaneUtils-DJAUpVXQ.js","./coordinateFormatter-Bqv90CKy.js","./GraphicsLayer-i3FeUJ_n.js","./GraphicsCollection-FfahqxsR.js","./Layer-CVt7Hb5J.js","./BlendLayer-CXM4n_Ge.js","./jsonUtils-CSnQD004.js","./parser-CTsgEym6.js","./utils-93yNk4Xc.js","./mat4f32-DcsiF_Rp.js","./ScaleRangeLayer-Bb8Ig1Hz.js","./dehydratedFeatureComparison-06VFTqH5.js","./createUtils-ibzYx0GK.js","./Circle-BInHZHdw.js","./surfaceCoordinateSystems-DhFxihAh.js","./memoize-DsJmrG76.js","./ReactiveSet-BU2iaegS.js","./diffUtils-BP7jmOAy.js","./InteractiveToolBase-vg6J8uyT.js","./angularMeasurementUtils-7e2vxqzG.js","./SketchLabelOptions-DDQnGNSN.js","./SnappingContext-lR2hMWGP.js","./SnappingDragPipelineStep-rzVcndp8.js","./SnappingOperation-CaI4DIP4.js","./mat2d-D9DBP-jx.js","./mat2df64-CBKYtunK.js","./helpMessageUtils-M95XMmyR.js","./helpMessageUtils3d-TaLw0ElD.js","./SketchTooltipInfo-BA57LzDt.js","./MeshTransform-D2t3aEmK.js","./themeUtils-C3zvZbsE.js","./a11yUtils-cyWndM8Q.js","./directionModeIcons-Br5woIHu.js","./automaticAreaMeasurementUtils-12dUsEmf.js","./euclideanAreaMeasurementUtils-CfO9bFtV.js","./geodesicAreaMeasurementUtils-BILXFcc4.js","./isSupportedObject-6I_Nw0mS.js","./manipulatorUtils--FgdKArx.js","./MoveManipulation-DDXwpmjU.js","./dragEventPipeline3D-BzC_kbE1.js","./SelectedVertexTooltipInfo-Jy1UVcy1.js","./TranslateTooltipInfo-BDJmumyy.js","./utils-Ce7L3imC.js","./cimSymbolUtils-DXvZxabN.js","./utils-D2PLyMFF.js","./enums-CmIX1y88.js","./LRUCache-B_PHMSGm.js","./MemCache-Dx1v3xLC.js","./IViewEvents-Bci6PjlS.js","./SlicePlaneMaterial.glsl-CvGYpiku.js","./sliceToolConfig-D0gkc1PF.js","./ImageMaterial.glsl-toQN6zid.js","./DefaultLayouts-BuE1efcQ.js","./SlicePlane-CdDvBULA.js","./persistable-DjaiFmiM.js","./MD5-C9MwAd2G.js","./multiOriginJSONSupportUtils-C0wm8_Yw.js","./LineVisualElement-mUtX7dGi.js","./ShaderTechniqueRepository-hTzew41Z.js","./RenderCoordsHelper-C50UGjbb.js","./projectVectorToPoint-DcLtSZYw.js","./Factory-Bm3bRF5y.js","./ExtentScaleTooltipInfo-Da4eAeVm.js","./GraphicManipulator-Dc-QfW2U.js","./defaults-DZ1kfMRx.js","./defaultsJSON-GKolV7NZ.js","./drapedUtils-HWKOCxgF.js"])))=>i.map(i=>d[i]);
import{r as s}from"./tslib.es6-B3Jf3DVX.js";import{m as a,a as S,e as g,i as x,t as G,b as V}from"./subclass-BZA_h8Db.js";import{m as k,j as U}from"./perspectiveUtils-DUm6VYra.js";import{b as W,C,e as b,q as N,S as q}from"./Accessor-BLX9ikPh.js";import{initial as D,watch as F,syncAndInitial as K,on as A}from"./reactiveUtils-C5zUhJQJ.js";import{e as Y}from"./mat3f64-BBpwCtoL.js";import{i as B}from"./Polyline-D9YkgmM_.js";import{e as Z,C as J}from"./RibbonLine.glsl-BZu1FDpE.js";import{l as Q}from"./LayerView3D-Dkb0AiwM.js";import{_ as R}from"./index-Bh2oEzTI.js";import{s as X}from"./mathUtils-C4_ghTv4.js";import{z as M}from"./Point-Cg0-ChZE.js";import{M as tt}from"./mat2d-D9DBP-jx.js";import{e as et}from"./mat2df64-CBKYtunK.js";import{o as it,S as rt}from"./vec2-maR1OrZI.js";import{n as ot}from"./vec2f64-miziP1SN.js";import{h as nt}from"./UpdatingHandles-GfwcIh5z.js";import{_ as E}from"./InputManager-Ba9xzDpe.js";import{d,h as st}from"./keybindings-DoOdil3D.js";import{a as at}from"./SnappingManagerPool-CewNAGGP.js";import{g as lt,r as f}from"./OverlayCompositing.glsl-CiE3Tt8y.js";import{t as T}from"./orientedBoundingBox-DOAJUK5g.js";import{p as dt,C as mt}from"./Texture-Fac_8AOC.js";import{E as I,I as pt}from"./MergedRenderer-Dli9s1X5.js";import{e as u}from"./VertexAttribute-Cq4MnHjR.js";import{I as ht}from"./ImageMaterial.glsl-toQN6zid.js";import{y as ct}from"./LayerView-CGYm21KA.js";import{s as _t}from"./MediaLayerView-Bo-1OY3C.js";import{r as ut}from"./layerViewUtils-DhFEu8Rd.js";import{D as O}from"./enums-D9v74xTE.js";import"./projection-B971H0Re.js";import"./SimpleObservable-KocWTzVy.js";import"./vec3f64-BLpZdpfb.js";import"./Extent-Bf3YTe7m.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";import"./normalizeUtilsSync-BUrHV6iS.js";import"./assets-C43MgM-v.js";import"./jsonUtils-CEfjT-BK.js";import"./normalizeUtilsCommon-dT81xWiM.js";import"./mat3-BRl2i9Bz.js";import"./common-DQOJ18NT.js";import"./vec32-Dvg_eL9J.js";import"./asyncUtils-CWX51uTe.js";import"./Collection-CEdjem1-.js";import"./Evented-BHRw9x22.js";import"./shared-B3wH2qpO.js";import"./writer-DNAwXnhG.js";import"./mat4-GpOFENPA.js";import"./mat4f64-Dk4dwAN8.js";import"./computeTranslationToOriginAndRotation-Q27G6TBL.js";import"./dehydratedFeatureUtils-B--Sgpdi.js";import"./vec42-YcqnINSP.js";import"./vec4f64-o2zAXfmz.js";import"./sphere-C77djCO6.js";import"./plane-IENfwZlB.js";import"./quatf64-CCm9z-pX.js";import"./mathUtils-BG-eq9fO.js";import"./ViewingMode-Dodu7ZZk.js";import"./intersectorUtils-BK9EUwUf.js";import"./boundedPlane-EV1sS2Ke.js";import"./lineSegment-D7sKPPYf.js";import"./verticalOffsetUtils-BDQLpfho.js";import"./ElevationProvider-C95wyCKc.js";import"./unitConversionUtils-BMfW9yAe.js";import"./lengthUtils-DL1-FDQQ.js";import"./hydratedFeatures-DBKLr8hT.js";import"./geometry-D964gYQX.js";import"./jsonMap-0cxwUWs2.js";import"./Graphic-DsxsIjhH.js";import"./PopupTemplate-BHMhS05j.js";import"./Clonable-D3rtuBWg.js";import"./cast-Bjksrh93.js";import"./fieldUtils-tmQlKvWo.js";import"./intl-CChhNOV8.js";import"./date-DlqISzcw.js";import"./locale-C9TlLpzi.js";import"./messages-OmQvZhAg.js";import"./enumeration-Ba5njXdz.js";import"./Color-BCS62Hs5.js";import"./colorUtils-0bJDPow9.js";import"./ActionToggle-iT4slXc7.js";import"./Identifiable-B1UbsKNt.js";import"./symbols-CNimns--.js";import"./TextSymbol-D8QO_KUV.js";import"./screenUtils-_ZIvrt5o.js";import"./materialUtils-DarhapKC.js";import"./opacityUtils-C68Tlu6_.js";import"./aaBoundingBox-BE7cC1jD.js";import"./persistableUrlUtils-fa1mAujs.js";import"./collectionUtils-D_lHIu88.js";import"./Portal-C10FKnaA.js";import"./Loadable-BabW5Xcc.js";import"./Promise-B2Hu02L7.js";import"./projectVectorToVector-G2uWGoIb.js";import"./projectPointToVector-GINIbYMz.js";import"./Material-_xx7OZxD.js";import"./interfaces-DDtDqZYj.js";import"./renderState-DQLu6AJX.js";import"./Util-BIfApRF5.js";import"./sdfPrimitives-CUWZbMRe.js";import"./vec3f32-nZdmKIgz.js";import"./Indices-DflDlU4Z.js";import"./doublePrecisionUtils-B0owpBza.js";import"./floatRGBA-CfH_2xsy.js";import"./Octree-C8d4sqjv.js";import"./frustum-CQrOepbv.js";import"./InterleavedLayout-e-di2fxs.js";import"./BufferView-_QDXRCew.js";import"./Matrix3DrawUniform-CiBFaSz6.js";import"./BindType-BmZEZMMh.js";import"./compilerUtils-Dw3R0f-Z.js";import"./AlphaCutoff-UcccL64p.js";import"./Float4DrawUniform-N58YDhuZ.js";import"./Texture-Begq2x5n.js";import"./ShaderTechniqueConfiguration-CBbn2DCi.js";import"./heightModelInfoUtils-C6gW75mB.js";import"./HeightModelInfo-9nOoV6LU.js";import"./arcgisLayerUrl-BX1FE5Hm.js";import"./Queue-yu3bZ02p.js";import"./signal-D4lghLjV.js";import"./SnappingManager-BJPyuu7J.js";import"./elevationInfoUtils-BC_66_Fg.js";import"./timeUtils-8fb_2oAt.js";import"./Query-5Xpquc1r.js";import"./DataLayerSource-BKkswDvG.js";import"./Field-ybkHhtnK.js";import"./fieldType-BuzM0UHS.js";import"./FullTextSearch-Csd1Hktu.js";import"./TimeExtent-DocT5yPf.js";import"./utils-BpB3MnW1.js";import"./Version-BSlAgupz.js";import"./geodesicUtils-FCYOaNwu.js";import"./geometry2dUtils-DdyQE7AQ.js";import"./viewUtils-DrPohWV3.js";import"./axisAngleDegrees-Ci2HA7Jo.js";import"./quat-4pa1e6ds.js";import"./weather-eV4wTXCK.js";import"./HighlightDefaults-D4ckYWWJ.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./BufferObject-BVi1lwBq.js";import"./NestedMap-GuqgquCN.js";import"./Intersector-wXoCuQ8W.js";import"./Scheduler-CJu5awNf.js";import"./debugFlags-BF6Z0j0F.js";import"./spatialReferenceEllipsoidUtils-DBE_OFra.js";import"./triangle-PTGDC_xJ.js";import"./requestImageUtils-DgMiQwsm.js";import"./VertexArrayObject-lPxPk5E-.js";import"./glUtil-D0YUa0ow.js";import"./VertexColor.glsl-_ARMpsAT.js";import"./DefaultLayouts-BuE1efcQ.js";import"./TriangleMaterial-BiHR3MKx.js";const P=Symbol(),H=Symbol(),$=1,yt=10;let m=class extends W{get updating(){return this._updatingHandles.updating}get _preferredInteractionTool(){var t;return((t=this.options)==null?void 0:t.tool)??"transform"}get _toolType(){switch(this._preferredInteractionTool){case"transform":return"transform-3d";case"reshape":return"reshape-3d"}}get _validatedSelectedElement(){const t=this.selectedElement;if(!t)return null;const{layer:{source:e}}=this;return e?"hasElement"in e?e.hasElement(t)?t:null:e===t?t:null:null}constructor(t){super(t),this.enabled=!1,this._updatingHandles=new nt,this._isOpacityToggled=!1,this._factor=$,this._tool=null,this._object=null,this._createToolAbortController=null,this._onPointerMove=C(async e=>{const i=await this._updatingHandles.addPromise(this._findElementAtScreenPoint(e));this.destroyed||(this.removeHandles(H),i&&i!==this.selectedElement&&(this.view.cursor="pointer",this.addHandles(g(()=>this.view.cursor=null),H)))}),this._tmpMat2=et(),this._tmpVec2=ot()}destroy(){this._createToolAbortController=b(this._createToolAbortController)}initialize(){this.addHandles([x(this._updatingHandles),this._updatingHandles.add(()=>this.enabled,t=>this._enableDisable(t),D),this._updatingHandles.add(()=>this._preferredInteractionTool,t=>this._preferredInteractionToolChanged(t))])}_enableDisable(t){if(!t)return void this.removeHandles(P);this._dynamicImports();const{view:e}=this,i=new st;i.add(d.undo,()=>{var r,o,n;(o=(r=this._object)==null?void 0:r.operations)==null||o.undo(),(n=this._object)==null||n.emit("modified-externally")}),i.add(d.redo,()=>{var r,o,n;(o=(r=this._object)==null?void 0:r.operations)==null||o.redo(),(n=this._object)==null||n.emit("modified-externally")}),i.addToggle(d.preserveAspectRatio,r=>{var o;((o=this._tool)==null?void 0:o.type)==="transform-3d"&&(this._tool.preserveAspectRatio=r.type==="key-down")}),i.addToggle(d.rotateIncrements,r=>{var o;((o=this._tool)==null?void 0:o.type)==="transform-3d"&&(this._tool.snapRotation=r.type==="key-down")}),i.add(d.toggleOpacity,()=>{var o;const r=(o=this._object)==null?void 0:o.element;r&&(r.opacity*=this._isOpacityToggled?2:.5,this._isOpacityToggled=!this._isOpacityToggled)}),i.add(d.moveUp,()=>this._move(0,this._factor)),i.add(d.moveDown,()=>this._move(0,-this._factor)),i.add(d.moveRight,()=>this._move(this._factor,0)),i.add(d.moveLeft,()=>this._move(-this._factor,0)),i.addToggle(d.factorModifier,r=>this._factor=r.type==="key-down"?yt:$),this._isOpacityToggled=!1,this.addHandles([i.register(e,E.TOOL),g(()=>{this._isOpacityToggled&&this.selectedElement&&(this.selectedElement.opacity*=2,this._isOpacityToggled=!1)}),e.on("immediate-click",r=>this._onClick(r),E.TOOL),e.on("pointer-move",r=>this._onPointerMove(r).catch(()=>{}),E.TOOL),this._updatingHandles.add(()=>this._validatedSelectedElement,(r,o)=>{o&&r!==o&&this._isOpacityToggled&&(o.opacity*=2,this._isOpacityToggled=!1),this._selectedElementChanged(r)},D),g(()=>{e.cursor=null,this._removeTool()})],P)}async _onClick(t){await this._updatingHandles.addPromise(t.async(async()=>{const e=await this._findElementAtScreenPoint(t);this.destroyed||(e&&t.stopPropagation(),this.selectedElement=e,this.selectedElement&&(this.view.cursor=null))}))}async _selectedElementChanged(t){var e;t!=null&&t.georeference?((e=this._object)==null?void 0:e.element)!==t&&await this._updatingHandles.addPromise(this._recreateTool()):this._removeTool()}async _recreateTool(){this._createToolAbortController=b(this._createToolAbortController),this._removeTool();const t=this._validatedSelectedElement;if(!t)return;const e=new AbortController;this._createToolAbortController=e;const{ManipulatedObject3DMediaElement:i,ExtentTransformTool:r,ReshapeTool3D:o}=await this._dynamicImports();if(e.signal.aborted)return;const{view:n,layer:l,_toolType:_}=this;switch(this._object=new i({view:n,layer:l,element:t,tool:this._preferredInteractionTool}),_){case"transform-3d":{this._tool=new r({view:n,object:this._object});const p=n.inputManager;p.isModifierKeyDown(d.rotateIncrements.key)&&(this._tool.snapRotation=!0),p.isModifierKeyDown(d.preserveAspectRatio.key)&&(this._tool.preserveAspectRatio=!0)}break;case"reshape-3d":{const p=at(n);this.addHandles(p,this._tool);const{snappingManager:h}=p;this._tool=new o({view:n,object:this._object,enableMidpoints:!1,enableZShape:!1,snappingManager:h,enableMoveObject:!1,autoHideManipulators:!0,enableDeleteVertices:!1})}}this.addHandles([g(()=>{this._object=N(this._object),this._tool&&(n.tools.remove(this._tool),this._tool=null)})],this._tool),n.addAndActivateTool(this._tool)}_preferredInteractionToolChanged(t){const{_tool:e}=this;if(!e)return;if(this._toolType!==e.type)return void this._updatingHandles.addPromise(this._recreateTool());const{_object:i}=this;i&&(i.tool=t)}async _dynamicImports(){const[{ManipulatedObject3DMediaElement:t},{ExtentTransformTool:e,ReshapeTool3D:i}]=await Promise.all([R(()=>import("./ManipulatedObject3DMediaElement-C1o7iY9V.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57]),import.meta.url),R(()=>import("./editingTools-COUq-DTn.js"),__vite__mapDeps([58,1,59,60,61,20,4,32,29,33,3,5,6,7,2,8,9,31,23,62,12,13,14,15,16,17,18,63,64,65,66,67,68,69,70,10,11,19,57,71,28,72,73,74,24,25,41,22,75,76,77,78,30,35,36,37,38,39,79,80,48,49,81,82,44,83,84,85,86,87,88,89,90,91,92,93,94,95,56,96,97,47,98,99,100,34,101,102,103,104,105,106,107,108,109,110,51,111,112,113,114,115,116,117,46,118,54,119,120,121,122,123,124,125,126,127,27,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,40,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,21,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,26,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,45,254,255,256,257,258,259,260,261,262,263]),import.meta.url)]);return{ManipulatedObject3DMediaElement:t,ExtentTransformTool:e,ReshapeTool3D:i}}async _findElementAtScreenPoint(t){const e=(await this.view.hitTest(t,{include:[this.layer]})).results[0];return(e==null?void 0:e.type)==="media"?e.element:null}_removeTool(){this._tool&&this.removeHandles(this._tool)}_move(t,e){const{view:i,_object:r}=this,o=r==null?void 0:r.operations;if(!o)return;const n=i.overlayPixelSizeInMapUnits(i.pointsOfInterest.focus.location)*M(i.spatialReference)/M(o.data.spatialReference),{_tmpMat2:l,_tmpVec2:_}=this,p=tt(l,X(360-this.view.camera.heading)),h=it(_,n*t,n*e);rt(h,h,p),o.move(h[0],h[1],0),r.emit("modified-externally")}};s([a({constructOnly:!0})],m.prototype,"view",void 0),s([a({constructOnly:!0})],m.prototype,"layer",void 0),s([a()],m.prototype,"selectedElement",void 0),s([a()],m.prototype,"enabled",void 0),s([a()],m.prototype,"options",void 0),s([a()],m.prototype,"updating",null),s([a()],m.prototype,"_preferredInteractionTool",null),s([a()],m.prototype,"_validatedSelectedElement",null),m=s([S("esri.views.3d.layers.support.MediaLayerInteraction")],m);let c=class extends Q(_t(ct)){get interactive(){return this._interaction.enabled}set interactive(t){this._interaction&&(this._interaction.enabled=t)}get selectedElement(){return this._interaction.selectedElement}set selectedElement(t){this._interaction&&(this._interaction.selectedElement=t)}get visibleAtCurrentScale(){return ut(this.layer.effectiveScaleRange,this.view.scale)}constructor(t){super(t),this.type="media-3d",this.drapeSourceType=Z.Features,this.updatePolicy=J.ASYNC,this._uidToElement=new Map,this._renderedElements=new Map,this._lastDrapingExtent=null,this._update=C(async(r,o,n)=>{const l=await this._collectMediaElements(r,o,n);this._synchronizeRenderElements(l)},0);const{view:e,layer:i}=t;this._interaction=new m({view:e,layer:i}),this.addHandles(F(()=>this.interactionOptions,r=>this._interaction.options=r,K))}initialize(){const{view:t,layer:e}=this;this._renderer=t.basemapTerrain.overlayManager.registerGeometryDrapeSource(this);const i=()=>this._updateWithLastDrapingExtent();this.addHandles([g(()=>t.basemapTerrain.overlayManager.unregisterDrapeSource(this)),A(()=>e.effectiveSource,"change",i),A(()=>e.effectiveSource,"refresh",i)]),this._updatingHandles.add(()=>this.suspended,i)}setDrapingExtent(t,e){this._lastDrapingExtent={overlays:t,spatialReference:e},this._updateWithLastDrapingExtent()}getHit(t){const e=this._uidToElement.get(t);return e?{type:"media",element:e,layer:this.layer}:null}isUpdating(){return super.isUpdating()||this._interaction.updating}_updateWithLastDrapingExtent(){if(this._lastDrapingExtent==null||this.suspended)return void(this._renderer&&this._synchronizeRenderElements(new Set));const{overlays:t,spatialReference:e}=this._lastDrapingExtent;this._updatingHandles.addPromise(this._update(t,e).catch(()=>{}))}async _collectMediaElements(t,e,i){const r=this.layer.effectiveSource;return r==null?new Set:new Set((await Promise.all(t.map(o=>r.queryElements(B(o.extent,e),{signal:i})))).flat())}_synchronizeRenderElements(t){this._synchronizeRenderElementsRemove(t),this._synchronizeRenderElementsAdd(t)}_synchronizeRenderElementsRemove(t){this._renderedElements.forEach((e,i)=>{t.has(i)||(this._removeElement(i,e),this.emit("element-render-changed",{element:i}))})}_synchronizeRenderElementsAdd(t){for(const e of t)this._renderedElements.has(e)||this._createRenderElement(e)}_removeElement(t,{renderData:e,handle:i}){this._destroyRenderData(t,e),this._renderedElements.delete(t),this._uidToElement.delete(t.uid),i.remove()}async _createRenderElement(t){const e=new k({spatialReference:this.view.spatialReference,element:t}),i={renderData:null,handle:G([this._updatingHandles.add(()=>t.opacity,r=>{i.renderData!=null&&i.renderData.material.setParameters({opacity:r})}),this._updatingHandles.add(()=>e.coords,()=>{i.renderData!=null?this._updateGeometry(e,i,i.renderData):this._initializeRenderData(e,i)}),this._updatingHandles.add(()=>t.content,()=>this._initializeRenderData(e,i)),x(e)])};this._renderedElements.set(t,i),this._uidToElement.set(t.uid,t),this._updatingHandles.addPromise(t.load().catch(()=>{})),this._initializeRenderData(e,i)}_initializeRenderData(t,e){const{coords:i,element:r}=t,{contentWidth:o,contentHeight:n}=r;if(i==null||r.content==null)return void(e.renderData=this._destroyRenderData(r,e.renderData));if(e.renderData!=null)return;const l=this._createTexture(r.content),_=l.load(this.view._stage.renderView.renderingContext);this.view._stage.add(l),q(_)&&this._updatingHandles.addPromise(_);const p=new ht({initTextureTransparent:!0,textureId:l.id,opacity:r.opacity,perspectiveInterpolation:!0}),h=this._getPositionAttributeArray(i),j=[0,0,1,0,1,1,0,1],L=this._getPerspectiveDivideAttributeArray(h,o,n),v=[0,1,2,0,2,3],z=new dt(p,[[u.POSITION,new T(h,v,3,!0)],[u.UV0,new T(j,v,2,!0)],[u.PERSPECTIVEDIVIDE,new T(L,v,1,!0)]]),w=new lt(z,{layerUid:this.layer.uid,graphicUid:r.uid});this._renderer.addGeometries([w],I.ADD),e.renderData={renderGeometry:w,texture:l,material:p},this.emit("element-render-changed",{element:r})}_updateGeometry(t,e,i){const{coords:r,element:o}=t;if(r==null||o.content==null)return void(e.renderData=this._destroyRenderData(o,e.renderData));const n=this._getPositionAttributeArray(r);i.renderGeometry.geometry.setAttributeData(u.POSITION,n);const l=this._getPerspectiveDivideAttributeArray(n,o.contentWidth,o.contentHeight);i.renderGeometry.geometry.setAttributeData(u.PERSPECTIVEDIVIDE,l),i.renderGeometry.geometry.invalidateBoundingInfo(),this._renderer.modifyGeometries([i.renderGeometry],pt.GEOMETRY),this.emit("element-render-changed",{element:o})}_getPositionAttributeArray(t){const[e,i,r,o]=t.rings[0];return[e[0],e[1],f,o[0],o[1],f,r[0],r[1],f,i[0],i[1],f]}_getPerspectiveDivideAttributeArray(t,e,i){U(y,[0,0,e,0,e,i,0,i],[t[0],t[1],t[3],t[4],t[6],t[7],t[9],t[10]]);const r=y[6]/y[8]*e,o=y[7]/y[8]*i;return[1,1+r,1+r+o,1+o]}_destroyRenderData(t,e){if(e==null)return null;const i=e.texture;return i.unload(),this.view._stage.remove(i),this._renderer.removeGeometries([e.renderGeometry],I.REMOVE),this.emit("element-render-changed",{element:t}),null}_createTexture(t){const e=t instanceof HTMLImageElement?t.naturalWidth:t.width,i=t instanceof HTMLImageElement?t.naturalHeight:t.height;if("getFrame"in t)throw new V("media-layer-view-3d","animation is not supported");return new mt(t,{wrap:{s:O.CLAMP_TO_EDGE,t:O.CLAMP_TO_EDGE},preMultiplyAlpha:!0,width:e,height:i,mipmap:!0,updateCallback:()=>this.view.basemapTerrain.overlayManager.setDrawTexturesDirty()})}get test(){}};s([a({readOnly:!0})],c.prototype,"type",void 0),s([a()],c.prototype,"layer",void 0),s([a()],c.prototype,"interactive",null),s([a()],c.prototype,"selectedElement",null),s([a({readOnly:!0})],c.prototype,"visibleAtCurrentScale",null),c=s([S("esri.views.3d.layers.MediaLayerView3D")],c);const y=Y(),lr=c;export{lr as default};
