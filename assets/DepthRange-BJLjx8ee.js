import{r as v,o as b}from"./vec2-ChnYg_BJ.js";import{l as B,t as _}from"./vec2f64-Dy6m9Nrb.js";import{r as D}from"./mathUtils-Cfq9PL9W.js";import{t as y}from"./Material-C_-mgXN8.js";import{O}from"./basicInterfaces-CZwQPxTp.js";function x(r,t,e){return r.canvas||(r.canvas=document.createElement("canvas")),r.canvas.width=t,r.canvas.height=e,r.canvas}function $(r){const{size:t}=r.definition,e=r.fontString(t);let i=z.get(e);if(!i){const s=x(E,0,0).getContext("2d");r.setFontProperties(s,t);const n=s.measureText(F);i=new C(n.actualBoundingBoxAscent,n.actualBoundingBoxDescent),z.set(e,i)}return i}const z=new Map;let C=class{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(t,e){this.maxAscent=t,this.maxDescent=e}};const E={canvas:null},F=(()=>{let r="";for(let t=32;t<127;t++)r+=String.fromCharCode(t);return r})(),U=1;let K=class{constructor(t,e,i,s){this.text=t,this._alignment=e,this._parameters=i,this._maxSize=s,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${t}--${this._parameters.key}-${this._alignment}`,this._lines=t.replaceAll(" ","Â ").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let t=this._metrics.firstLineAscent;for(let e=0;e<this._lines.length-1;e++)t+=this._lineSpacing;return t+=this._metrics.lastLineDescent,Math.ceil(t+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(this._metricsCached==null){const t=x(T,p,p).getContext("2d"),e=this._parameters.definition.pixelRatio,i=this._fontSize*e;this._parameters.setFontProperties(t,i);let s=2*this._haloSize;const n=this._parameters.definition.font;n.style!=="italic"&&n.style!=="oblique"&&n.weight!=="bold"&&n.weight!=="bolder"||(s+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let o=0,l=0,a=0,h=0,d=0;this._lines.forEach((k,R)=>{const f=t.measureText(k),S=f.width/e,L=S+s;this._textWidths.push(S),this._lineWidths.push(L),o=Math.max(o,L),h=Math.max(h,f.actualBoundingBoxAscent/e),d=Math.max(d,f.actualBoundingBoxDescent/e),R===0&&(l=f.actualBoundingBoxAscent/e),R===this._lines.length-1&&(a=f.actualBoundingBoxDescent/e)});const c=$(this._parameters),g=Math.max(h,c.maxAscent),m=Math.max(d,c.maxDescent),H=l,w=this._parameters.definition.font.decoration==="underline"?m:a,A=o;this._metricsCached=new I(H,w,g,m,A)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*X}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,U)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(this._renderPixelRatio==null){const t=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(t,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case u.Left:return this._horizontalPadding;case u.Center:return(this.displayWidth-this._lineWidths[t])/2;case u.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[t]}}render(t,e,i){t.save();const s=e/=this.renderPixelRatio,n=i/=this.renderPixelRatio,o=this._haloSize,l=this._firstLineYOffset+this._metrics.firstLineAscent;e+=o,i+=l;const a=this._haloSize>0;a&&this._renderHalo(t,s,n,o,l),this._parameters.setFontProperties(t,this._renderedFontSize);for(let h=0;h<this._lines.length;++h){const d=this._lines[h],c=this._getLineXOffset(h);a&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,d,e+c,i),this._renderLineDecoration(t,e+c,i,this._textWidths[h])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,d,e+this._getLineXOffset(h),i),this._renderLineDecoration(t,e+c,i,this._textWidths[h]),i+=this._lineSpacing}if(y.TEXT_SHOW_BASELINE){t.strokeStyle=P,t.setLineDash([2,2]),t.lineWidth=1;let h=n+l;for(let d=0;d<this._lines.length;++d)this._drawLine(t,[s,h],[s+this.displayWidth,h]),h+=this._lineSpacing}if(y.TEXT_SHOW_BORDER&&(t.strokeStyle=P,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[s,n],[this.displayWidth,this.displayHeight])),this._hasBackground){const h=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,s,n,h),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()}_renderLineDecoration(t,e,i,s,n=!1){if(this._parameters.definition.font.decoration==="none"||s===0)return;const o=1,l=Math.max(this._parameters.definition.size/16,o);switch(this._parameters.definition.font.decoration){case"underline":i+=2*l;break;case"line-through":i-=.33*this._midLineAscent}const a=n?this._haloSize:0;t.strokeStyle=n?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(l+2*a),t.beginPath(),t.moveTo(this._toRenderUnit(e-a),this._toRenderUnit(i)),t.lineTo(this._toRenderUnit(e+s+a),this._toRenderUnit(i)),t.stroke()}_roundedRect(t,e,i,s){e=this._toRenderUnit(e),i=this._toRenderUnit(i);const n=this.renderedWidth,o=this.renderedHeight;s!==0?(s=D(s,0,Math.floor(o/2)),t.beginPath(),t.moveTo(e,i+s),t.arcTo(e,i,e+s,i,s),t.lineTo(e+n-s,i),t.arcTo(e+n,i,e+n,i+s,s),t.lineTo(e+n,i+o-s),t.arcTo(e+n,i+o,e+n-s,i+o,s),t.lineTo(e+s,i+o),t.arcTo(e,i+o,e,i+o-s,s),t.closePath()):t.rect(e,i,n,o)}_renderHalo(t,e,i,s,n){const o=this.renderedWidth,l=this.renderedHeight,a=x(T,Math.max(o,p),Math.max(l,p)),h=a.getContext("2d");h.clearRect(0,0,o,l),this._parameters.setFontProperties(h,this._renderedFontSize),h.fillStyle=this._parameters.haloStyle,h.strokeStyle=this._parameters.haloStyle;const d=this._renderedHaloSize<3;h.lineJoin=d?"miter":"round",d?this._renderHaloEmulated(h,s,n):this._renderHaloNative(h,s,n);let c=n;for(let g=0;g<this._lines.length;++g){const m=this._getLineXOffset(g);this._renderLineDecoration(h,s+m,c,this._textWidths[g],!0),c+=this._lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(a,0,0,o,l,this._toRenderUnit(e),this._toRenderUnit(i),o,l),t.globalAlpha=1}_renderHaloEmulated(t,e,i){for(let s=0;s<this._lines.length;++s){const n=this._lines[s],o=this._getLineXOffset(s);for(const[l,a]of M)this._fillText(t,n,e+o+this._haloSize*l,i+this._haloSize*a);i+=this._lineSpacing}}_renderHaloNative(t,e,i){const s=2*this._haloSize;for(let n=0;n<this._lines.length;++n){const o=this._lines[n],l=this._getLineXOffset(n),a=5,h=.1;for(let d=0;d<a;d++){const c=1-(a-1)*h+d*h;t.lineWidth=this._toRenderUnit(c*s),this._strokeText(t,o,e+l,i)}i+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(t){return t*this.renderPixelRatio}_toRoundedRenderUnit(t){return Math.round(t*this.renderPixelRatio)}_fillText(t,e,i,s){t.fillText(e,this._toRenderUnit(i),this._toRenderUnit(s))}_strokeText(t,e,i,s){t.strokeText(e,this._toRenderUnit(i),this._toRenderUnit(s))}_drawLine(t,e,i){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(e[0])+.5,this._toRoundedRenderUnit(e[1])+.5),t.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.stroke()}_drawBox(t,e,i){const s=this._toRenderUnit(e[0]),n=this._toRenderUnit(e[1]),o=this._toRenderUnit(i[0]),l=this._toRenderUnit(i[1]),a=Math.floor(s)+.5,h=Math.ceil(s+o)-.5,d=Math.floor(n)+.5,c=Math.ceil(n+l)-.5;t.beginPath(),t.moveTo(a,d),t.lineTo(h,d),t.lineTo(h,c),t.lineTo(a,c),t.lineTo(a,d),t.stroke()}};const M=[];for(let t=0;t<360;t+=360/16)M.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)]);var u;(function(r){r[r.Left=0]="Left",r[r.Center=1]="Center",r[r.Right=2]="Right"})(u||(u={}));const T={canvas:null},X=.2,p=512,P="rgb(255, 0, 255, 0.5)";class I{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(t,e,i,s,n){this.firstLineAscent=t,this.lastLineDescent=e,this.maxLineAscent=i,this.maxLineDescent=s,this.displayWidth=n}}const V=Object.freeze({left:0,center:.5,right:1}),Z=Object.freeze({"bottom-left":_(0,0),bottom:_(.5,0),"bottom-right":_(1,0),left:_(0,.5),center:_(.5,.5),right:_(1,.5),"top-left":_(0,1),top:_(.5,1),"top-right":_(1,1)});function tt(r){switch(r){case"left":return u.Left;case"right":return u.Right;default:return u.Center}}function et(r){switch(r){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function it(r){switch(r){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function st(r,t){switch(t){case"bottom":return r==="left"?"bottom-left":r==="right"?"bottom-right":"bottom";case"center":return r;case"top":return r==="left"?"top-left":r==="right"?"top-right":"top"}}function nt(r){return r==="middle"?"center":r}function rt(r,t){switch(r){case"top":return b(t,0,U);case"bottom":return b(t,0,-1);default:return v(t,B)}}class ht{constructor(t,e){this._material=t,this._repository=e,this._map=new Map}dispose(){this._map.forEach((t,e)=>{t!=null&&this._repository.release(this._material,e)})}load(t,e,i){const s=this._material.produces.get(e);if(!(s!=null&&s(i)))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,e,i));const n=this._map.get(i);if(n!=null){if(n.ensureResources(t)===O.LOADED)return n;this._repository.requestRender()}return null}}class W{constructor(t=1/0,e=-1/0){this.near=t,this.far=e}set(t,e){this.near=t,this.far=e}union(t){t!=null&&(this.near=Math.min(this.near,t.near),this.far=Math.max(this.far,t.far))}within(t){return this.near<=t&&t<=this.far}}W.zero=new W(0,0);export{K as a,x as b,U as c,et as d,$ as e,tt as f,rt as h,V as i,it as l,st as m,W as r,Z as s,ht as t,nt as u};
