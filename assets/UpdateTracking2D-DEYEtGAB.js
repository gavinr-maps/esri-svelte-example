import{r as a,e as $}from"./tslib.es6-B3Jf3DVX.js";import{b as br,n as Be,z as Yr,_ as tn,j as wr,m as or,a as en}from"./subclass-BZA_h8Db.js";import{a as Bt}from"./BindType-BmZEZMMh.js";import{s as rn}from"./Util-BIfApRF5.js";import"./Texture-Begq2x5n.js";import"./enums-D9v74xTE.js";import{r as nn}from"./Program-mfcb06fW.js";import{T as on}from"./LabelMetric-CbxH21Le.js";import{K as xr}from"./definitions-DfvbPdMm.js";import{b as sn}from"./Accessor-BLX9ikPh.js";import{s as an}from"./ReactiveMap-6CfRGOlR.js";import{watch as ln}from"./reactiveUtils-C5zUhJQJ.js";import{h as un}from"./UpdatingHandles-GfwcIh5z.js";var sr;(function(e){e[e.AnimatedMarker=0]="AnimatedMarker",e[e.Blend=1]="Blend",e[e.ComplexFill=2]="ComplexFill",e[e.ComplexOutlineFill=3]="ComplexOutlineFill",e[e.DotDensity=4]="DotDensity",e[e.Fill=5]="Fill",e[e.Grid=6]="Grid",e[e.Heatmap=7]="Heatmap",e[e.Label=8]="Label",e[e.Line=9]="Line",e[e.Magnifier=10]="Magnifier",e[e.Marker=11]="Marker",e[e.OutlineFill=12]="OutlineFill",e[e.Overlay=13]="Overlay",e[e.PatternFill=14]="PatternFill",e[e.PatternOutlineFill=15]="PatternOutlineFill",e[e.PieChart=16]="PieChart",e[e.Test=17]="Test",e[e.Text=18]="Text",e[e.TexturedLine=19]="TexturedLine"})(sr||(sr={}));const Hi={bitset:{isSDF:0,isMapAligned:1,scaleSymbolsProportionally:2,overrideOutlineColor:3,colorLocked:4,isStroke:5}};var ar;(function(e){e[e.Geographic=0]="Geographic",e[e.Arithmatic=1]="Arithmatic"})(ar||(ar={}));const Gi=3.14159265359/180,cn=3.14159265359/128,qi=1,pn=1.1,dn=1,Wi=24,Zi=8,hn=1e-5,lr=.05,yn=1e-30,fn=4,mn=0,gn=2,Xi=2,Ji=3,Qi=0,Yi=3,vn=16777216,to=1.1,bn=()=>Be.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");let $r=class{constructor(){this._includedModules=new Map}include(t,r){this._includedModules.has(t)?this._includedModules.get(t):(this._includedModules.set(t,r),t(this.builder,r))}},wn=class extends $r{constructor(){super(...arguments),this.vertex=new ur,this.fragment=new ur,this.attributes=new Tn,this.varyings=new Sn,this.extensions=new me,this.constants=new Tr}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(t,r=!0){const n=this.extensions.generateSource(t),i=this.attributes.generateSource(t),o=this.varyings.generateSource(t),s=t==="vertex"?this.vertex:this.fragment,u=s.uniforms.generateSource(),p=s.code.generateSource(),c=t==="vertex"?In:_n(),y=this.constants.generateSource().concat(s.constants.generateSource());return`${r?"#version 300 es":""}
${n.join(`
`)}
${c}
${y.join(`
`)}
${u.join(`
`)}
${i.join(`
`)}
${o.join(`
`)}
${p.join(`
`)}`}generateBindPass(t){const r=new Map;this.vertex.uniforms.entries.forEach(o=>{const s=o.bind[Bt.Pass];s&&r.set(o.name,s)}),this.fragment.uniforms.entries.forEach(o=>{const s=o.bind[Bt.Pass];s&&r.set(o.name,s)});const n=Array.from(r.values()),i=n.length;return(o,s)=>{for(let u=0;u<i;++u)n[u](t,o,s)}}generateBindDraw(t){const r=new Map;this.vertex.uniforms.entries.forEach(o=>{const s=o.bind[Bt.Draw];s&&r.set(o.name,s)}),this.fragment.uniforms.entries.forEach(o=>{const s=o.bind[Bt.Draw];s&&r.set(o.name,s)});const n=Array.from(r.values()),i=n.length;return(o,s,u)=>{for(let p=0;p<i;++p)n[p](t,u,o,s)}}},xn=class{constructor(){this._entries=new Map}add(...t){for(const r of t)this._add(r)}get(t){return this._entries.get(t)}_add(t){if(t!=null){if(this._entries.has(t.name)&&!this._entries.get(t.name).equals(t))throw new br(`Duplicate uniform name ${t.name} for different uniform type`);this._entries.set(t.name,t)}else bn().error(`Trying to add null Uniform from ${new Error().stack}.`)}generateSource(){return Array.from(this._entries.values()).map(t=>t.arraySize!=null?`uniform ${t.type} ${t.name}[${t.arraySize}];`:`uniform ${t.type} ${t.name};`)}get entries(){return Array.from(this._entries.values())}},$n=class{constructor(){this._entries=new Array}add(t){this._entries.push(t)}generateSource(){return this._entries}},ur=class extends $r{constructor(){super(...arguments),this.uniforms=new xn,this.code=new $n,this.constants=new Tr}get builder(){return this}},Tn=class{constructor(){this._entries=new Array}add(t,r){this._entries.push([t,r])}generateSource(t){return t==="fragment"?[]:this._entries.map(r=>`in ${r[1]} ${r[0]};`)}},Sn=class{constructor(){this._entries=new Map}add(t,r){this._entries.has(t)&&rn(this._entries.get(t)===r),this._entries.set(t,r)}generateSource(t){const r=new Array;return this._entries.forEach((n,i)=>r.push(t==="vertex"?`out ${n} ${i};`:`in ${n} ${i};`)),r}},me=class ge{constructor(){this._entries=new Set}add(t){this._entries.add(t)}generateSource(t){const r=t==="vertex"?ge.ALLOWLIST_VERTEX:ge.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(n=>r.includes(n)).map(n=>`#extension ${n} : enable`)}};me.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],me.ALLOWLIST_VERTEX=[];let Tr=class w{constructor(){this._entries=new Set}add(t,r,n){let i="ERROR_CONSTRUCTOR_STRING";switch(r){case"float":i=w._numberToFloatStr(n);break;case"int":i=w._numberToIntStr(n);break;case"bool":i=n.toString();break;case"vec2":i=`vec2(${w._numberToFloatStr(n[0])},                            ${w._numberToFloatStr(n[1])})`;break;case"vec3":i=`vec3(${w._numberToFloatStr(n[0])},                            ${w._numberToFloatStr(n[1])},                            ${w._numberToFloatStr(n[2])})`;break;case"vec4":i=`vec4(${w._numberToFloatStr(n[0])},                            ${w._numberToFloatStr(n[1])},                            ${w._numberToFloatStr(n[2])},                            ${w._numberToFloatStr(n[3])})`;break;case"ivec2":i=`ivec2(${w._numberToIntStr(n[0])},                             ${w._numberToIntStr(n[1])})`;break;case"ivec3":i=`ivec3(${w._numberToIntStr(n[0])},                             ${w._numberToIntStr(n[1])},                             ${w._numberToIntStr(n[2])})`;break;case"ivec4":i=`ivec4(${w._numberToIntStr(n[0])},                             ${w._numberToIntStr(n[1])},                             ${w._numberToIntStr(n[2])},                             ${w._numberToIntStr(n[3])})`;break;case"mat2":case"mat3":case"mat4":i=`${r}(${Array.prototype.map.call(n,o=>w._numberToFloatStr(o)).join(", ")})`}return this._entries.add(`const ${r} ${t} = ${i};`),this}static _numberToIntStr(t){return t.toFixed(0)}static _numberToFloatStr(t){return Number.isInteger(t)?t.toFixed(1):t.toString()}generateSource(){return Array.from(this._entries)}};function _n(){return`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp sampler2D;
#else
  precision mediump float;
  precision mediump sampler2D;
#endif
`}const In=`precision highp float;
precision highp sampler2D;`;function On(e){return e.split(" ").map((t,r)=>r>0?t.charAt(0).toUpperCase()+t.slice(1):t).join("")}function Vn(e,t){const r=[];for(r.push(t);r.length;){const n=r.pop();if(typeof n=="object"&&!e.has(n.uid)){e.add(n.uid);for(const i of n.children)r.push(i)}}}let ut=class ve{constructor(){this.uid=ve.NodeCount++,this._debugName=null,this._isMutable=!1,this.isImplicit=!1}get isMutable(){return this._isMutable}setMutable(){return this._isMutable=!0,this}setDebugName(t){return t=On(t),this._debugName=t,this.isImplicit&&this.children[0]instanceof ve&&this.children[0].setDebugName(t),this}get debugInfo(){return{name:this._debugName??""}}cloneInto(t){t._debugName=this._debugName,t._isMutable=this._isMutable,t.isImplicit=this.isImplicit,t.uid=this.uid}};function d(e){return typeof e=="object"?e.clone():e}ut.NodeCount=0;let S=class extends ut{constructor(){super(...arguments),this.shaderType="primitive-node"}},Cn=class Sr extends ut{constructor(t){super(),this.child=t,this.shaderType="scope-node"}get children(){return[this.child]}clone(){const t=new Sr(d(this.child));return this.cloneInto(t),t}},Fn=class _r extends ut{constructor(t,r,n){super(),this.property=t,this.target=r,this.returnType=n,this.shaderType="property-access-node"}get children(){const t=[this.target];return typeof this.property!="string"&&t.push(this.property),t}clone(){const t=new _r(this.property,d(this.target),this.returnType);return this.cloneInto(t),t}},Nn=class Ir extends ut{constructor(t,r,n){super(),this.condition=t,this.ifTrue=r,this.ifFalse=n,this.shaderType="condition-node"}get children(){return[this.condition,this.ifTrue,this.ifFalse]}clone(){const t=d(this.ifTrue),r=this.ifFalse?d(this.ifFalse):null,n=new Ir(this.condition,t,r);return this.cloneInto(n),n}},zn=class Or extends ut{constructor(t,r,n,i){super(),this.captureList=t,this.returnType=r,this.generator=i,this.shaderType="block-node",n&&(this.subgraph=new Cn(n))}get children(){return Object.keys(this.captureList).map(t=>this.captureList[t]).concat(this.subgraph??[])}clone(){const t={};for(const n in this.captureList)t[n]=d(this.captureList[n]);const r=new Or(t,this.returnType,this.subgraph?d(this.subgraph.child):this.subgraph,this.generator);return this.cloneInto(r),r}},st=class Vr extends ut{constructor(t,r,n,i,o,s=!1){super(),this.token=t,this._children=r,this.isInfix=n,this.isPropertyAccess=i,this.returnType=o,this.isTernary=s,this.shaderType="function-node"}get children(){return this._children}clone(){const t=new Vr(this.token,this._children.map(d),this.isInfix,this.isPropertyAccess,this.returnType,this.isTernary);return this.cloneInto(t),t}};var Vt,be,we,xe,$e,Te,Se,_e,Ie,Oe,Ve,Ce,Fe,Ne;function Dn(e){const t=[["float","vec2","vec3","vec4"],["int","ivec2","ivec3","ivec4"],["uint","uvec2","uvec3","uvec4"],["bool","bvec2","bvec3","bvec4"]];for(const r of t)if(r.includes(e))return r.map(n=>kn[n]);throw new Error("Unable to find type family")}function Cr(e){return new Proxy(e,{get(t,r){if(r==="constructor")return new Proxy(t.constructor,{construct:(n,i,o)=>Cr(new n(...i))});if(r in t)return t[r];if(typeof r=="string"){const n=Dn(e.type);return M(e,r,n[r.length-1])}}})}function R(e){return new Proxy(e,{construct:(t,r,n)=>Cr(new t(...r))})}function Pn(e){return new Proxy(e,{get(t,r){if(r in t)return t[r];if(typeof r=="string"){const n=parseInt(r,10);if(!isNaN(n))return M(e,`[${n}]`,e.elementType.constructor)}}})}function An(e){return new Proxy(e,{construct:(t,r,n)=>Pn(new t(...r))})}let ze=class extends Error{},U=Vt=class extends S{constructor(e,t){super(),this.elementType=e,this.size=t,this.children=[],this.type="array"}clone(){const e=new Vt(this.elementType,this.size);return super.cloneInto(e),e}get(e){if(typeof e=="number"){const t=new rt(e);return t.isImplicit=!0,M(this,t,this.elementType.constructor)}return M(this,e,this.elementType.constructor)}last(){return this.get(this.size-1)}first(){return this.get(0)}findIndex(e,t,r){return Un(this,e,t,r)}glslFindIndex(e,t,r){return Ln(this,e,t,r)}static ofType(e,t){const r={construct:(n,i)=>new Vt(new e,t)};return new Proxy(Vt,r)}};U.type="array",U=Vt=a([An],U);let K=class Fr extends S{constructor(){super(...arguments),this.type="sampler2D",this.children=[]}clone(){const t=new Fr;return t.children=this.children.map(d),super.cloneInto(t),t}};K.type="sampler2D";let l=class ht extends S{constructor(t){super(),this.type="float",this.children=[t]}clone(){const t=new ht(d(this.children[0]));return super.cloneInto(t),t}multiply(t){return Q(this,typeof t=="number"?_(t,ht):t)}divide(t){return Et(this,typeof t=="number"?_(t,ht):t)}add(t){return bt(this,typeof t=="number"?_(t,ht):t)}subtract(t){return Ut(this,typeof t=="number"?_(t,ht):t)}};l.type="float";let g=be=class extends S{constructor(e,t){super(),this.type="vec2",this.children=[e,t].filter(r=>r!=null)}clone(){const e=new be(d(this.children[0]),d(this.children[1]));return super.cloneInto(e),e}get 0(){return M(this,"[0]",l)}get 1(){return M(this,"[1]",l)}get 2(){throw new ze}get 3(){throw new ze}multiply(e){return Q(this,typeof e=="number"?_(e,l):e)}divide(e){return Et(this,typeof e=="number"?_(e,l):e)}add(e){return bt(this,typeof e=="number"?_(e,l):e)}subtract(e){return Ut(this,typeof e=="number"?_(e,l):e)}};g.type="vec2",g=be=a([R],g);let I=we=class extends S{constructor(e,t,r){super(),this.type="vec3",this.children=[e,t,r].filter(n=>n!=null)}get 0(){return M(this,"[0]",l)}get 1(){return M(this,"[1]",l)}get 2(){return M(this,"[2]",l)}get 3(){throw new ze}clone(){const e=new we(d(this.children[0]),d(this.children[1]),d(this.children[2]));return super.cloneInto(e),e}multiply(e){return Q(this,typeof e=="number"?_(e,l):e)}divide(e){return Et(this,typeof e=="number"?_(e,l):e)}add(e){return bt(this,typeof e=="number"?_(e,l):e)}subtract(e){return Ut(this,typeof e=="number"?_(e,l):e)}};I.type="vec3",I=we=a([R],I);let b=xe=class extends S{constructor(e,t,r,n){super(),this.type="vec4",this.children=[e,t,r,n].filter(i=>i!=null)}clone(){const e=new xe(d(this.children[0]),d(this.children[1]),d(this.children[2]),d(this.children[3]));return super.cloneInto(e),e}get 0(){return M(this,"[0]",l)}get 1(){return M(this,"[1]",l)}get 2(){return M(this,"[2]",l)}get 3(){return M(this,"[3]",l)}multiply(e){return Q(this,typeof e=="number"?_(e,l):e)}divide(e){return Et(this,typeof e=="number"?_(e,l):e)}add(e){return bt(this,typeof e=="number"?_(e,l):e)}subtract(e){return Ut(this,typeof e=="number"?_(e,l):e)}};b.type="vec4",b=xe=a([R],b);let Zt=$e=class extends S{constructor(e){super(),this.type="uint",this.children=[e]}clone(){const e=new $e(d(this.children[0]));return super.cloneInto(e),e}};Zt.type="uint",Zt=$e=a([R],Zt);let Xt=Te=class extends S{constructor(e,t){super(),this.type="uvec2",this.children=[e,t].filter(r=>r!=null)}clone(){const e=new Te(d(this.children[0]),d(this.children[1]));return super.cloneInto(e),e}};Xt.type="uvec2",Xt=Te=a([R],Xt);let Jt=Se=class extends S{constructor(e,t,r){super(),this.type="uvec3",this.children=[e,t,r].filter(n=>n!=null)}clone(){const e=new Se(d(this.children[0]),d(this.children[1]),d(this.children[2]));return super.cloneInto(e),e}};Jt.type="uvec3",Jt=Se=a([R],Jt);let Qt=_e=class extends S{constructor(e,t,r,n){super(),this.type="uvec4",this.children=[e,t,r,n].filter(i=>i!=null)}clone(){const e=new _e(d(this.children[0]),d(this.children[1]),d(this.children[2]),d(this.children[3]));return super.cloneInto(e),e}};Qt.type="uvec4",Qt=_e=a([R],Qt);class P extends S{constructor(t){super(),this.type="bool",this.children=[t]}and(t){return Pe(this,t)}or(t){return Dr(this,t)}clone(){const t=new P(d(this.children[0]));return super.cloneInto(t),t}}P.type="bool";let Yt=Ie=class extends S{constructor(e,t){super(),this.type="bvec2",this.children=[e,t].filter(r=>r!=null)}all(){return Ge(this)}any(){return qe(this)}clone(){const e=new Ie(d(this.children[0]),d(this.children[1]));return super.cloneInto(e),e}};Yt.type="bvec2",Yt=Ie=a([R],Yt);let te=Oe=class extends S{constructor(e,t,r){super(),this.type="bvec3",this.children=[e,t,r].filter(n=>n!=null)}all(){return Ge(this)}any(){return qe(this)}clone(){const e=new Oe(d(this.children[0]),d(this.children[1]),d(this.children[2]));return super.cloneInto(e),e}};function _(e,t){return typeof e=="number"?new t(e):e}te.type="bvec3",te=Oe=a([R],te);let ee=Ve=class extends S{constructor(e,t,r,n){super(),this.type="bvec4",this.children=[e,t,r,n].filter(i=>i!=null)}all(){return Ge(this)}any(){return qe(this)}clone(){const e=new Ve(d(this.children[0]),d(this.children[1]),d(this.children[2]),d(this.children[3]));return super.cloneInto(e),e}};ee.type="bvec4",ee=Ve=a([R],ee);let rt=class yt extends S{constructor(t){super(),this.type="int",this.children=[t]}multiply(t){return Q(this,_(t,yt))}add(t){return bt(this,_(t,yt))}subtract(t){return Ut(this,_(t,yt))}divide(t){return Et(this,_(t,yt))}clone(){const t=new yt(d(this.children[0]));return super.cloneInto(t),t}};rt.type="int";let re=Ce=class extends S{constructor(e,t){super(),this.type="ivec2",this.children=[e,t].filter(r=>r!=null)}clone(){const e=new Ce(d(this.children[0]),d(this.children[1]));return super.cloneInto(e),e}};re.type="ivec2",re=Ce=a([R],re);let ne=Fe=class extends S{constructor(e,t,r){super(),this.type="ivec3",this.children=[e,t,r].filter(n=>n!=null)}clone(){const e=new Fe(d(this.children[0]),d(this.children[1]),d(this.children[2]));return super.cloneInto(e),e}};ne.type="ivec3",ne=Fe=a([R],ne);let ie=Ne=class extends S{constructor(e,t,r,n){super(),this.type="ivec4",this.children=[e,t,r,n].filter(i=>i!=null)}clone(){const e=new Ne(d(this.children[0]),d(this.children[1]),d(this.children[2]),d(this.children[3]));return super.cloneInto(e),e}};ie.type="ivec4",ie=Ne=a([R],ie);let Mn=class Nr extends S{constructor(t,r,n,i){super(),this.type="mat2",this.children=[t,r,n,i]}clone(){const t=new Nr(d(this.children[0]),d(this.children[1]),d(this.children[2]),d(this.children[3]));return super.cloneInto(t),t}multiply(t){return Q(this,t)}};Mn.type="mat2";let j=class oe extends S{static identity(){return new oe(1,0,0,0,1,0,0,0,1)}static fromRotation(t){const r=Xe(t),n=Pr(t);return new oe(n,r,0,ae(r),n,0,0,0,1)}constructor(t,r,n,i,o,s,u,p,c){super(),this.type="mat3",this.children=[t,r,n,i,o,s,u,p,c]}add(t){return bt(this,t)}multiply(t){return Q(this,t)}clone(){const t=new oe(d(this.children[0]),d(this.children[1]),d(this.children[2]),d(this.children[3]),d(this.children[4]),d(this.children[5]),d(this.children[6]),d(this.children[7]),d(this.children[8]));return super.cloneInto(t),t}};j.type="mat3";class Ft extends S{static identity(){return new Ft(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}constructor(t,r,n,i,o,s,u,p,c,y,f,v,V,C,H,Y){super(),this.type="mat4",this.children=[t,r,n,i,o,s,u,p,c,y,f,v,V,C,H,Y]}static fromColumns(t,r,n,i){return new Ft(t.x,t.y,t.z,t.w,r.x,r.y,r.z,r.w,n.x,n.y,n.z,n.w,i.x,i.y,i.z,i.w)}multiply(t){return Q(this,t)}clone(){const t=new Ft(d(this.children[0]),d(this.children[1]),d(this.children[2]),d(this.children[3]),d(this.children[4]),d(this.children[5]),d(this.children[6]),d(this.children[7]),d(this.children[8]),d(this.children[9]),d(this.children[10]),d(this.children[11]),d(this.children[12]),d(this.children[13]),d(this.children[14]),d(this.children[15]));return super.cloneInto(t),t}}Ft.type="mat4";const kn={float:l,vec2:g,vec3:I,vec4:b,int:rt,ivec2:re,ivec3:ne,ivec4:ie,uint:Zt,uvec2:Xt,uvec3:Jt,uvec4:Qt,bool:P,bvec2:Yt,bvec3:te,bvec4:ee},ct=(...e)=>new rt(...e),x=(...e)=>new l(...e),De=(...e)=>new g(...e),Rn=(...e)=>new I(...e),En=(...e)=>new b(...e),cr=(...e)=>new j(...e);function M(e,t,r){const n=new r(new Fn(t,e,r));return n.isImplicit=!0,n}function A(e,t,r,n=null){if(n){const o=new n,s=new n(new st(e,[t,r],!0,!1,o));return s.isImplicit=!0,s}if(t.type==="float"||t.type==="int"){const o=new r.constructor(new st(e,[t,r],!0,!1,r.constructor));return o.isImplicit=!0,o}if((t.type==="mat2"||t.type==="mat3"||t.type==="mat4")&&r.type!=="float"){const o=new r.constructor(new st(e,[t,r],!0,!1,r.constructor));return o.isImplicit=!0,o}const i=new t.constructor(new st(e,[t,r],!0,!1,t.constructor));return i.isImplicit=!0,i}function z(e,t,r=t.constructor){const n=new r(new st(e,[t],!1,!1,r));return n.isImplicit=!0,n}function J(e,t,r,n=t.constructor){const i=new n(new st(e,[t,r],!1,!1,n));return i.isImplicit=!0,i}function je(e,t,r,n,i=t.constructor){const o=new i(new st(e,[t,r,n],!1,!1,i));return o.isImplicit=!0,o}function ae(e){return Q(e,x(-1))}function zr(e,t,r,n){return new t(new zn(e,t,r,n))}function Un(e,t,r=0,n=e.size){const i=new rt(r).setMutable().setDebugName("FindIndexIterator"),o=t(e.get(i)).setDebugName("FindIndexPredicate");return zr({iter:i},rt,o,({out:u,iter:p,subgraph:c})=>`
${u} = -1;

for (; ${p} < ${n}; ${p}++) {

${c.body}

  if (${c.varName}) {
    ${u} = ${p};
    break;
  }

}
`).setDebugName("FindIndexBlock")}function Ln(e,t,r=0,n=e.size){return zr({array:e},rt,null,({out:o,array:s})=>`
${o} = -1;
for (int i = ${r}; i < ${n}; i++) {
  bool condition;
  ${t({array:s,i:"i",out:"condition"})}
  if (condition) {
    ${o} = i;
    break;
  }
}
`).setDebugName("GlslFindIndexBlock")}function O(e,t,r){const n=typeof t=="function"?t():t,i=typeof r=="function"?r():r,o=new n.constructor(new Nn(e,n,i));return o.isImplicit=!0,o}function Rt(...e){const t=e.map(([u,p])=>typeof p=="function"?[u,p()]:[u,p]),r=t[0][1].constructor,n=t.findIndex(u=>u[0]===!0);if(n===-1)throw new Error("A cond must have a fallthrough case with `true`/; ");const i=t.slice(0,n),o=t[n][1],s=new r(i.reduceRight((u,p)=>O(p[0],p[1],u),o));return s.isImplicit=!0,s}function Q(e,t){return A("*",e,t)}function Et(e,t){return A("/",e,t)}function bt(e,t){return A("+",e,t)}function Ut(e,t){return A("-",e,t)}function co(e,t){return A("%",e,t)}function po(e,t){return A(">>",e,t)}function ho(e,t){return A("&",e,t)}function He(e,t){return A("==",e,t,P)}function Kn(e,t){return A("<",e,t,P)}function pe(e,t){return A("<=",e,t,P)}function k(e,t){return A(">",e,t,P)}function de(e,t){return A(">=",e,t,P)}function Dr(...e){return e.length<=1?e[0]:e.slice(1).reduce((t,r)=>Bn(t,r),e[0])}function Bn(e,t){return A("||",e,t,P)}function Pe(...e){return e.length<=1?e[0]:e.slice(1).reduce((t,r)=>jn(t,r),e[0])}function jn(e,t){return A("&&",e,t,P)}function Hn(e){return z("abs",e)}function Ge(e){return z("all",e,P)}function qe(e){return z("any",e,P)}function yo(e,t){return t==null?z("atan",e):J("atan",e,t,e.constructor)}function Gn(e){return z("ceil",e)}function We(e,t,r){return je("clamp",e,t,r,e.constructor)}function Pr(e){return z("cos",e)}function Ar(e,t){return J("distance",e,t,l)}function Ze(e,t){return J("dot",e,t,l)}function qn(e){return z("floor",e)}function Mr(e){return z("fract",e)}function kr(e){return z("length",e,l)}function mt(e,t){return J("max",e,t)}function Ae(e,t){return J("min",e,t)}function wt(e,t,r){return je("mix",e,t,r)}function xt(e,t){return J("mod",e,t)}function Wn(e){return z("normalize",e)}function Zn(e){return e.type==="bool"?z("!",e):z("not",e)}function fo(e,t){return J("pow",e,t)}function mo(e){return z("round",e)}function Xe(e){return z("sin",e)}function go(e,t,r){return je("smoothstep",e,t,r)}function vo(e){return z("sqrt",e)}function et(e,t){return J("step",e,t,t.constructor)}function B(e,t){return J("texture",e,t,b)}const _t=5;function F(e,t,r){const n=t.split(`
`);for(const i of n)if(i.trim().length){{let o="";r!=null&&(o+=`/*id:${r??"000"}*/   `),e.body+=o.padEnd(14)}e.body+=" ".repeat(e.indent)+i+`
`}}let pr=class{write(t){for(const r of t.rootOutputNodes())t.shouldPruneOutputNode(r)||(r.variableName=this._write(t,r.node));return t}_createVarName(t,r){let n="";return typeof r!="boolean"&&typeof r!="number"&&r.debugInfo.name&&(n=`${r.debugInfo.name}_`),`${n}v${t.varCount++}`}_write(t,r,n=!1){if(typeof r=="number"||typeof r=="boolean")return r.toString();let i=t.getEmit(r);if(i)return i;switch(r.shaderType){case"scope-node":i=this._writeScopeNode(t,r);break;case"primitive-node":i=this._writePrimitiveNode(t,r,n);break;case"function-node":i=this._writeFunctionNode(t,r);break;case"property-access-node":i=this._writePropertyAccessNode(t,r);break;case"text-node":i=r.text;break;case"block-node":i=this._writeBlockNode(t,r);break;case"condition-node":i=this._writeConditionNode(t,r)}return t.setEmit(r,i),i}_writeScopeNode(t,r){const n=new r.child.constructor;n.setDebugName(r.debugInfo.name);const i=this._write(t,n,!0);return F(t,`{ /*ScopeStart: ${r.uid} ${r.debugInfo.name}*/`),t.indent+=2,F(t,`${i} = ${this._write(t,r.child)};`),t.indent-=2,F(t,`} /*ScopeEnd: ${r.uid} ${r.debugInfo.name}*/`),i}_writeConditionNode(t,r){const n=new r.ifTrue.constructor,i=this._write(t,n,!0);F(t,`if (${this._write(t,r.condition)}) {`),t.indent+=2;const o=t.createSubgraphContext(),s=this._write(o,r.ifTrue);if(t.body+=o.body,s&&F(t,`${i} = ${s};`),t.indent-=2,F(t,"}"),r.ifFalse){F(t,"else {"),t.indent+=2;const u=t.createSubgraphContext(),p=this._write(u,r.ifFalse);t.body+=u.body,p&&F(t,`${i} = ${p};`),t.indent-=2,F(t,"}")}return i}_writeBlockNode(t,r){const{captureList:n,generator:i,returnType:o}=r,s={};for(const y in n){if(!n[y])continue;const f=this._write(t,n[y]);s[y]=f}const u=new o,p=this._write(t,u,!0);if(s.out=p,r.subgraph){const y=t.createSubgraphContext(),f=this._write(y,r.subgraph.child),v=y.body;s.subgraph={varName:f,body:v}}const c=i(s);return F(t,`{
`),t.indent+=2,F(t,c),t.indent-=2,F(t,`}
`),p}_writePropertyAccessNode(t,r){const n=this._write(t,r.target);return typeof r.property=="string"&&r.property.includes("[")?`${n}${r.property}`:typeof r.property!="string"?`${n}[${this._write(t,r.property)}]`:`${n}.${r.property}`}_writeFunctionNode(t,r){const n=r.returnType.type;if(r.isInfix){const[s,u]=r.children.map(c=>this._write(t,c)),p=this._createVarName(t,r);return F(t,`${n.padEnd(_t)} ${p} = ${s} ${r.token} ${u};`,r.uid),p}const i=r.children.map(s=>this._write(t,s)).join(", "),o=this._createVarName(t,r);return F(t,`${n.padEnd(_t)} ${o} = ${r.token}(${i});`,r.uid),o}_writePrimitiveNode(t,r,n=!1){var c;const i=t.getInput(r);if(i)return i.isUsed=!0,i.variableName;const o=r.children.length===1&&((c=r.children[0])==null?void 0:c.type)===r.type;if(r.isImplicit||o)return this._write(t,r.children[0]);const s=this._createVarName(t,r);if(n)return F(t,`${r.type.padEnd(_t)} ${s};`,r.uid),s;const u=!r.debugInfo.name&&!r.isMutable;if(u&&r.type==="float"&&typeof r.children[0]=="number")return Number.isInteger(r.children[0])?r.children[0].toFixed(1):r.children[0].toString();if(u&&r.type==="int"&&typeof r.children[0]=="number"&&Number.isInteger(r.children[0]))return r.children[0].toString();const p=r.children.map(y=>this._write(t,y)).join(", ");return r.type==="array"?(F(t,`${r.type.padEnd(_t)} ${s} = [${p}];`,r.uid),s):u?`${r.type}(${p})`:(F(t,`${r.type.padEnd(_t)} ${s} = ${r.type}(${p});`,r.uid),s)}},pt=class Rr{constructor(t,r,n){this.variableName=t,this.variableInputType=r,this.node=n,this.type="shader-input",this.isUsed=!1}clone(){return new Rr(this.variableName,this.variableInputType,d(this.node))}},dt=class Er{constructor(t,r,n){this.outVariableName=t,this.outVariableType=r,this.node=n,this.type="shader-output"}clone(){const t=new Er(this.outVariableName,this.outVariableType,d(this.node));return t.variableName=this.variableName,t}},dr=class se{static createVertex(t,r,n,i,o,s){const u=[];for(const c in t){const y=t[c],f=n.get(c);f?u.push(new pt(f,"builtin",y)):u.push(new pt("a_"+c,"in",y))}for(const c of i){const y=c.uniformHydrated;u.push(new pt(c.uniformName,"uniform",y))}const p=[];for(const c in r){const y=r[c];c==="glPosition"?p.push(new dt("gl_Position","builtin",y)):c==="glPointSize"?p.push(new dt("gl_PointSize","builtin",y)):p.push(new dt("v_"+c,"out",y))}return new se(u,p,o,s)}static createFragment(t,r,n,i,o,s){const u=[],p=Array.from(o.rootOutputNodes());for(const y in t){const f=t[y],v=n.get(y);if(v){u.push(new pt(v,"builtin",f));continue}const V=p.find(C=>C.node===f);V&&u.push(new pt(V.outVariableName,"in",f))}for(const y of i){const f=y.uniformHydrated;u.push(new pt(y.uniformName,"uniform",f))}const c=[];for(const y in r){const f=r[y],v=n.get(y);y==="discard"?c.push(new dt(null,"discard",f)):v?c.push(new dt(v,"builtin",f)):c.push(new dt(y,"out",f))}return new se(u,c,s)}constructor(t,r,n,i){this.type="shader-graph-context",this.indent=0,this.body="",this.varCount=0,this._inputShaderTypesByNodeUid=new Map,this._nodeEmitMap=new Map;for(const o of t)this._inputShaderTypesByNodeUid.set(o.node.uid,o);this._outputShaderTypes=r,this._transformFeedbackBindings=n,this._transformFeedbackNames=new Set(n.map(o=>"v_"+o.propertyKey)),this._usedInFragmentShader=i}shouldPruneOutputNode(t){return!!this._usedInFragmentShader&&t.outVariableType!=="builtin"&&!this._transformFeedbackNames.has(t.outVariableName)&&!this._usedInFragmentShader.has(t.node.uid)}setEmit(t,r){this._nodeEmitMap.set(t.uid,r)}getEmit(t){return this._nodeEmitMap.get(t.uid)}inputs(){return this._inputShaderTypesByNodeUid.values()}getInput(t){return this._inputShaderTypesByNodeUid.get(t.uid)}*rootOutputNodes(){for(const t of this._outputShaderTypes)yield t}*nodes(){const t=[];for(const r of this._outputShaderTypes.values())t.push(r.node);for(;t.length;){const r=t.pop();typeof r!="number"&&typeof r!="boolean"&&t.push(...r.children.filter(Boolean)),yield r}}*nodesOfTypeOrFunction(){for(const t of this.nodes())typeof t!="number"&&typeof t!="boolean"&&(yield t)}createSubgraphContext(){const t=this.clone();return t.body="",t.indent=this.indent+2,t._nodeEmitMap=new Map(this._nodeEmitMap),t}clone(){const t=new se([],this._outputShaderTypes,this._transformFeedbackBindings,this._usedInFragmentShader);return t._inputShaderTypesByNodeUid=this._inputShaderTypesByNodeUid,t.indent=this.indent,t.body=this.body,t.varCount=this.varCount,t._nodeEmitMap=this._nodeEmitMap,t}insertVertexShader(t){t.vertex.code.add(""),this._insertInputs(t,"vertex"),t.vertex.code.add(""),t.vertex.code.add("// OUTPUTS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const r of this.rootOutputNodes()){const n=r.outVariableType==="builtin";this.shouldPruneOutputNode(r)||(n?t.vertex.code.add(`// ${r.outVariableType.padEnd(7)} ${r.node.type.padEnd(9)} ${r.outVariableName};`):t.vertex.code.add(`${r.outVariableType.padEnd(10)} ${r.node.type.padEnd(9)} ${r.outVariableName};`))}t.vertex.code.add(""),t.vertex.code.add("void main() {"),t.vertex.code.add("  "+this.body.split(`
`).join(`
  `));for(const r of this.rootOutputNodes())this.shouldPruneOutputNode(r)||t.vertex.code.add(`  ${r.outVariableName} = ${r.variableName};`);t.vertex.code.add("}")}insertFragmentShader(t){this._insertInputs(t,"fragment"),t.fragment.code.add(""),t.fragment.code.add("// OUTPUTS: "),t.fragment.code.add("// --------------------------------------------------------- ");for(const r of this.rootOutputNodes())r.outVariableType==="builtin"?t.fragment.code.add(`// ${r.outVariableType.padEnd(7)} ${r.node.type.padEnd(9)} ${r.outVariableName};`):t.fragment.code.add(`${r.outVariableType.padEnd(10)} ${r.node.type.padEnd(9)} ${r.outVariableName};`);t.fragment.code.add(""),t.fragment.code.add("void main() {"),t.fragment.code.add("  "+this.body.split(`
`).join(`
  `));for(const r of this.rootOutputNodes())r.outVariableType==="discard"?(t.fragment.code.add("  // TODO: Should ensure codegen for discard appears first in fragment shader"),t.fragment.code.add(`  if (${r.variableName}) {`),t.fragment.code.add("    discard;"),t.fragment.code.add("  }"),t.fragment.code.add("  ")):t.fragment.code.add(`  ${r.outVariableName} = ${r.variableName};`);t.fragment.code.add("}")}_insertInputs(t,r){t[r].code.add("// INPUTS: "),t[r].code.add("// --------------------------------------------------------- ");for(const n of this.inputs())n.isUsed&&n.variableInputType!=="builtin"&&(n.node.type==="array"?t[r].code.add(`${n.variableInputType.padEnd(10)} ${n.node.elementType.type.padEnd(9)} ${n.variableName}[${n.node.size}];`):t[r].code.add(`${n.variableInputType.padEnd(10)} ${n.node.type.padEnd(9)} ${n.variableName};`))}};const Xn=()=>Be.getLogger("esri.views.2d.engine.webgl.shaderGraph.typed.TypedShaderProgram");function It(e,t,r){const n=t.length;if(n!==r){const i=new br("Invalid Uniform",`Invalid length, expected ${r} but got ${n}`,{uniformName:e,values:t});Xn().errorOnce(i)}}let hr=class{constructor(t,r,n,i,o,s){this._program=null,this._vao=null,this._temporaryTextures=[],this.vertexShader=t,this.fragmentShader=r,this._locations=n,this._locationInfo=i,this._uniformBindings=o,this._transformFeedbackBindings=s}destroy(){this._program&&this._program.dispose(),this.cleanupTemporaryTextures()}get locations(){return this._locations}get locationInfo(){return this._locationInfo}setUniforms(t){this._uniforms=t}cleanupTemporaryTextures(){for(const t of this._temporaryTextures)t.dispose();this._temporaryTextures=[]}bind(t){const r=this._uniforms;if(!this._program){const i=new Map;for(const[s,u]of this._locations)i.set(s,u);const o=[];for(const s of this._transformFeedbackBindings??[]){const{index:u,propertyKey:p}=s;o[u]=`v_${p}`}this._program=new nn(t,this.vertexShader,this.fragmentShader,i,new Map,o)}const n=this._program;t.useProgram(n);for(const i of this._uniformBindings){const{shaderModulePath:o,uniformName:s,uniformType:u,uniformArrayLength:p}=i,c=Yr(o,r);if(c==null){if(u==="sampler2D")continue;throw new Error(`Failed to find uniform value for ${o}`)}switch(u==="array"?i.uniformArrayElementType:u){case"sampler2D":{const{unit:y,texture:f}=c;if(n.setUniform1i(s,y),"type"in f)t.bindTexture(f,y);else{const v=on(t,f.descriptor,f.data);t.bindTexture(v,y)}break}case"int":if(!p){n.setUniform1i(s,c);break}It(i.uniformName,c,p),n.setUniform1iv(s,c);break;case"float":if(!p){n.setUniform1f(s,c);break}It(i.uniformName,c,p),n.setUniform1fv(s,c);break;case"vec2":if(!p){n.setUniform2f(s,c[0],c[1]);break}It(i.uniformName,c,p),n.setUniform2fv(s,c.flat());break;case"vec3":if(!p){n.setUniform3f(s,c[0],c[1],c[2]);break}It(i.uniformName,c,p),n.setUniform3fv(s,c.flat());break;case"vec4":if(!p){n.setUniform4f(s,c[0],c[1],c[2],c[3]);break}It(i.uniformName,c,p),n.setUniform4fv(s,c.flat());break;case"mat3":n.setUniformMatrix3fv(s,c);break;case"mat4":n.setUniformMatrix4fv(s,c);break;default:throw new Error(`Unable to set uniform for type ${u}`)}}}};function Ot(e){return new e}function Lt(e,t,r){const n=e.constructor[t]??[];e.constructor.hasOwnProperty(t)||Object.defineProperty(e.constructor,t,{value:n.slice()}),e.constructor[t].push(r)}function m(e,t){return(r,n)=>{Lt(r,"locations",{typeCtor:t,propertyKey:n,parameterIndex:null,index:e})}}const T=e=>(t,r,n)=>{Lt(t,"inputs",{inputCtor:e,propertyKey:r,parameterIndex:n})},h=e=>(t,r)=>{Lt(t,"uniforms",{typeCtor:e,propertyKey:r})},N=e=>(t,r)=>{Lt(t,"options",{typeCtor:e,propertyKey:r})},yr=(e,t)=>{Lt(e,"defines",{propertyKey:t})},Me=(e,t)=>(r,n)=>{r.constructor.builtins.push({builtin:e,propertyKey:n,typeCtor:t})};class ke{}ke.builtins=[],a([Me("gl_VertexID",rt)],ke.prototype,"glVertexID",void 0);let Jn=class{},Nt=class{};Nt.builtins=[],a([Me("gl_FragCoord",b)],Nt.prototype,"glFragCoord",void 0),a([Me("gl_PointCoord",g)],Nt.prototype,"glPointCoord",void 0);let Qn=class{},E=class{constructor(){this.type="uniform-group"}get _uniforms(){return this.constructor.uniforms??[]}},Yn=class{constructor(){this.logShader=!1,this.computeAttributes={}}get vertexInput(){const t=this._shaderModuleClass.inputs.findLast(r=>r.propertyKey==="vertex"&&r.parameterIndex===0);if(!t)throw new Error("Unable to find vertex input parameter");return t}get computeInput(){return this._shaderModuleClass.inputs.findLast(t=>t.propertyKey==="vertex"&&t.parameterIndex===1)}get fragmentInput(){const t=this._shaderModuleClass.inputs.findLast(r=>r.propertyKey==="fragment");if(!t)throw new Error("Unable to find fragment input parameter");return t}get transformFeedbackBindings(){return this.fragmentInput.inputCtor.transformFeedbackBindings??[]}get locations(){var t;return[...this.vertexInput.inputCtor.locations,...((t=this.computeInput)==null?void 0:t.inputCtor.locations)??[]]}get locationsMap(){const t=new Map,r=new Set;for(const n of this.locations)r.has(n.index)?Be.getLogger("esri.views.2d.engine.webgl.shaderGraph.GraphShaderModule").warnOnce("mapview-rendering",`Unable to assigned attribute ${n.propertyKey} to ${n.index}. Index already in use`,{locationsMap:t}):(t.set(n.propertyKey,n.index),r.add(n.index));return t}get locationInfo(){if(!this._locationInfo){const t=this.locationsMap,r=Array.from(t.entries()).map(([o,s])=>`${o}.${s}`).join("."),n=tn(r),i=this.computeAttributes;this._locationInfo={hash:n,locations:t,computeAttributeMap:i}}return this._locationInfo}get renamedLocationsMap(){const t=new Map;for(const r of this.locations)t.set("a_"+r.propertyKey,r.index);return t}get optionPropertyKeys(){if(!this._optionPropertyKeys){const t=new Set;for(const r of this._options)t.add(r.propertyKey);this._optionPropertyKeys=t}return this._optionPropertyKeys}get _shaderModuleClass(){return this.constructor}get _defines(){return this._shaderModuleClass.defines??[]}get _options(){return this._shaderModuleClass.options??[]}get _uniforms(){return this._shaderModuleClass.uniforms??[]}getProgram(t,r,n,i){try{const{vertex:o,fragment:s,uniformBindings:u}=this._generateShaders(t,r,n,i);return new hr(o,s,this.renamedLocationsMap,this.locationInfo,u,this.transformFeedbackBindings)}catch{return new hr("","",this.renamedLocationsMap,this.locationInfo,[],this.transformFeedbackBindings)}}getDebugUniformClassInfo(t){const r=this._options.find(i=>i.propertyKey===t);if(r)return{type:"option",className:r.typeCtor};const n=this._uniforms.find(i=>i.propertyKey===t);if(!n)throw new Error(`Unable to find uniform class type for property: ${t}`);return{type:"required",className:n.typeCtor}}getShaderKey(t,r,n,i){const o=Object.keys(t).map(c=>`${c}.${t[c]}`).join("."),s=Object.keys(n).map(c=>`${c}.${n[c]}`).join("."),u=Object.keys(i).map(c=>`${c}.${i[c]}`).join("."),p=Object.keys(r).filter(c=>this.optionPropertyKeys.has(c)&&r[c]).join(".");return`${this.constructor.name}.${o}.${s}.${u}.${p}`}_generateShaders(t,r,n,i){const o=[];this._setDefines(n),this._setOptionalUniforms(o,r),this._setRequiredUniforms(o);const s=this._hydrateVertexInput(i),u=this._injectPackPrecisionFactor(s,t),p=this._hydrateComputeInput(),c=p&&this._injectComputePackPrecisionFactor(p,t),y=this.vertex(u,c),f=this._hydrateFragmentInput(y),v=this.fragment(f),V=new Set;for(const Jr in v){const Qr=v[Jr];Vn(V,Qr)}const C=this._getVertexInputBuiltins(),H=dr.createVertex({...s,...p},y,C,o,this.transformFeedbackBindings,V);new pr().write(H);const Y=this._getFragmentInputBuiltins(v);Y.set("glPointCoord","gl_PointCoord");const St=dr.createFragment(f,v,Y,o,H,this.transformFeedbackBindings);new pr().write(St);const Kt=this._createShaderBuilder(H,St),nr=Kt.generate("vertex",!0),ir=Kt.generate("fragment",!0);return this.logShader&&(console.log(nr),console.log(ir)),{vertex:nr,fragment:ir,uniformBindings:o}}_setDefines(t){for(const r in t)this[r]=t[r]}_setOptionalUniforms(t,r){for(const n of this._options)r[n.propertyKey]?this[n.propertyKey]=this._hydrateUniformGroup(t,n):this[n.propertyKey]=null}_setRequiredUniforms(t){for(const r of this._uniforms)this[r.propertyKey]=this._hydrateUniformGroup(t,r)}_hydrateUniformGroup(t,r){const n=new r.typeCtor;for(const i of n._uniforms??[]){const o=Ot(i.typeCtor),s=`u_${r.propertyKey}_${i.propertyKey}`,u=o.type,p=[r.propertyKey,i.propertyKey].join(".");if("type"in i.typeCtor&&i.typeCtor.type==="array"){const c=o;t.push({shaderModulePath:p,uniformName:s,uniformType:u,uniformArrayLength:c.size,uniformArrayElementType:c.elementType.type,uniformHydrated:o})}else t.push({shaderModulePath:p,uniformName:s,uniformType:u,uniformHydrated:o});n[i.propertyKey]=o}return n}_hydrateVertexInput(t){const r=this.vertexInput.inputCtor,n=r.locations.reduce((i,o)=>t[o.propertyKey]===!1?i:{...i,[o.propertyKey]:Ot(o.typeCtor)},{});for(const{propertyKey:i,typeCtor:o}of r.builtins){const s=Ot(o);n[i]=s}return n}_hydrateComputeInput(){return this.computeInput==null?null:this.computeInput.inputCtor.locations.reduce((t,r)=>({...t,[r.propertyKey]:Ot(r.typeCtor)}),{})}_injectPackPrecisionFactor(t,r){const n={};for(const i in t){const o=t[i],s=r[i];if(s){if(o.type!=="float"&&o.type!=="vec2"&&o.type!=="vec3"&&o.type!=="vec4")throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${o.type}`);n[i]=o.divide(new l(s))}else n[i]=o}return n}_injectComputePackPrecisionFactor(t,r){const n={},i=new Map;for(const o in this.computeAttributes)for(const s of this.computeAttributes[o]??[])i.set(s,o);for(const o in t){const s=t[o],u=i.get(o);if(!u)continue;const p=r[u];if(p){if(s.type!=="float"&&s.type!=="vec2"&&s.type!=="vec3"&&s.type!=="vec4")throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${s.type}`);n[o]=s.divide(new l(p))}else n[o]=s}return n}_hydrateFragmentInput(t){const r={};for(const n in t)r[n]=t[n];for(const{propertyKey:n,typeCtor:i}of Nt.builtins){const o=Ot(i);r[n]=o}return r}_getVertexInputBuiltins(){const t=this.vertexInput.inputCtor,r=new Map;for(const{builtin:n,propertyKey:i}of t.builtins)r.set(i,n);return r}_getFragmentInputBuiltins(t){const r=t.constructor,n=new Map;for(const i of r.builtins??[])n.set(i.propertyKey,i.builtin);return n}_createShaderBuilder(t,r){const n=new wn;return this._insertDebugInfo(n),t.insertVertexShader(n),r.insertFragmentShader(n),n}_insertDebugInfo(t){t.vertex.code.add("// DEFINES: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const r of this._defines)this[r.propertyKey]?t.vertex.code.add(`//   ${r.propertyKey}: true`):t.vertex.code.add(`//   ${r.propertyKey}: false`);t.vertex.code.add(""),t.vertex.code.add("// OPTIONS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const r of this._options)this[r.propertyKey]?t.vertex.code.add(`//   ${r.propertyKey}: true`):t.vertex.code.add(`//   ${r.propertyKey}: false`)}};function fr(e){const t=x(12.9898),r=x(78.233),n=x(43758.5453),i=Ze(e,De(t,r)),o=xt(i,x(3.14));return Mr(Xe(o).multiply(n))}function lt(e){return He(e,x(yn))}function ti(e,t){return e.x.multiply(t.y).subtract(t.x.multiply(e.y))}function ei(e){return e.multiply(2).subtract(1)}function nt(e,t){const r=x(2**t);return xt(qn(e.divide(r)),x(2))}function Io(e,t){return k(nt(e,t),x(.5))}function fe(e,t){return nt(e,t+xr)}function ri(e,t){return nt(e,t)}function ni(e){const t=nt(e.z,7),r=x(1).subtract(t),n=e.xyz.subtract(Rn(0,0,x(128)));return r.multiply(e).add(t.multiply(n))}function ii(e){const t=En(.99609375,.0038909912109375,1519918441772461e-20,59371814131736755e-24);return Ze(e,t)}function Oo(e){return mt(mt(mt(e.x,e.y),e.z),e.w)}function Vo(e){return new l(1).subtract(e)}function Co(e){return e.subtract(new l(1))}function Fo(e,t){return e.subtract(new l(t))}let L=class extends E{getVisualVariableData(t){if(!this._vvData){const r=this.getAttributeDataCoords(t);this._vvData=B(this.visualVariableData,r).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(t){if(!this._uv){const r=ni(t),n=this.size,i=ct(r.x),o=ct(r.y).multiply(ct(256)),s=ct(r.z).multiply(ct(256)).multiply(ct(256)),u=x(i.add(o).add(s)),p=xt(u,n),c=u.subtract(p).divide(n);this._uv=new g(p,c).add(.5).divide(n)}return this._uv}getFilterData(t){const r=this.getAttributeDataCoords(t);return B(this.filterFlags,r).setDebugName("storage0")}getAnimationData(t){const r=this.getAttributeDataCoords(t);return B(this.animation,r).setDebugName("storage1")}getVVData(t){return this.getVisualVariableData(t)}getDataDrivenData0(t){const r=this.getAttributeDataCoords(t);return B(this.dataDriven0,r).setDebugName("storage30")}getDataDrivenData1(t){const r=this.getAttributeDataCoords(t);return B(this.dataDriven1,r).setDebugName("storage31")}getDataDrivenData2(t){const r=this.getAttributeDataCoords(t);return B(this.dataDriven2,r).setDebugName("storage32")}getGPGPUData(t){const r=this.getAttributeDataCoords(t);return B(this.gpgpu,r).setDebugName("storage4")}getLocalTimeOrigin(t){const r=this.getAttributeDataCoords(t);return B(this.localTimeOrigin,r).x.setDebugName("storage5")}getFilterFlags(t){return wr("webgl-ignores-sampler-precision")?Gn(this.getFilterData(t).x.multiply(x(255))):this.getFilterData(t).x.multiply(x(255))}getLabelVisibility(t){const r=this.getFilterData(t).y.multiply(255);return new l(1).subtract(r)}getAnimationValue(t){return this.getAnimationData(t).x}getSizeValue(t){return this.getVisualVariableData(t).x}getColorValue(t){return this.getVisualVariableData(t).y}getOpacityValue(t){return this.getVisualVariableData(t).z}getRotationValue(t){return this.getVisualVariableData(t).w}};a([h(K)],L.prototype,"filterFlags",void 0),a([h(K)],L.prototype,"animation",void 0),a([h(K)],L.prototype,"gpgpu",void 0),a([h(K)],L.prototype,"localTimeOrigin",void 0),a([h(K)],L.prototype,"visualVariableData",void 0),a([h(K)],L.prototype,"dataDriven0",void 0),a([h(K)],L.prototype,"dataDriven1",void 0),a([h(K)],L.prototype,"dataDriven2",void 0),a([h(l)],L.prototype,"size",void 0);let Re=class extends E{};a([h(l)],Re.prototype,"activeReasons",void 0),a([h(l)],Re.prototype,"highlightAll",void 0);let Ct=class extends E{};a([h(g)],Ct.prototype,"position",void 0),a([h(l)],Ct.prototype,"distance",void 0),a([h(l)],Ct.prototype,"smallSymbolDistance",void 0),a([h(l)],Ct.prototype,"smallSymbolSizeThreshold",void 0);let D=class extends E{};a([h(j)],D.prototype,"displayViewScreenMat3",void 0),a([h(j)],D.prototype,"displayViewMat3",void 0),a([h(j)],D.prototype,"displayMat3",void 0),a([h(j)],D.prototype,"viewMat3",void 0),a([h(j)],D.prototype,"tileMat3",void 0),a([h(l)],D.prototype,"displayZoomFactor",void 0),a([h(l)],D.prototype,"requiredZoomFactor",void 0),a([h(g)],D.prototype,"tileOffset",void 0),a([h(l)],D.prototype,"currentScale",void 0),a([h(l)],D.prototype,"currentZoom",void 0),a([h(l)],D.prototype,"metersPerSRUnit",void 0),a([h(l)],D.prototype,"rotation",void 0),a([h(l)],D.prototype,"pixelRatio",void 0);let at=class extends ke{};a([m(0,I)],at.prototype,"id",void 0),a([m(1,l)],at.prototype,"bitset",void 0),a([m(2,g)],at.prototype,"pos",void 0);let X=class extends Jn{};a([m(14,g)],X.prototype,"nextPos1",void 0),a([m(15,g)],X.prototype,"nextPos2",void 0);let he=class extends Nt{},Z=class extends Yn{clip(t,r){let n=new l(0);const i=this.storage.getFilterFlags(t);if(n=n.add(x(2).multiply(x(1).subtract(fe(i,0)))),this.inside?n=n.add(x(2).multiply(x(1).subtract(fe(i,1)))):this.outside?n=n.add(x(2).multiply(fe(i,1))):this.highlight&&(n=n.add(x(2).multiply(x(1).subtract(this._checkHighlight(i))))),r!=null){const o=new l(1).subtract(et(r.x,this.view.currentZoom)),s=et(r.y,this.view.currentZoom);n=n.add(new l(2).multiply(o.add(s)))}return n}getFragmentOutput(t,r,n=new l(1/255)){const i=new Qn;return i.glFragColor=this._maybeWriteHittest(r)??this._maybeHighlight(t,n)??t,i}_maybeHighlight(t,r){return this.highlight?new b(t.rgb,et(r,t.a)):null}_checkHighlight(t){let r=this._checkHighlightBit(t,0);for(let n=1;n<xr;n++)r=r.add(this._checkHighlightBit(t,n));return et(new l(.1),r.add(this.highlight.highlightAll))}_checkHighlightBit(t,r){return ri(t,r).multiply(nt(this.highlight.activeReasons,r))}maybeRunHittest(t,r,n){if(this.hittestRequest==null)return null;const i=this.hittest(t,r,n);let o=O(k(i,this.hittestRequest.distance),new l(2),new l(0));const s=this.storage.getAttributeDataCoords(t.id),u=ei(s);o=o.add(this.clip(t.id,t.zoomRange));const p=new b(new l(1/255),0,0,0);return{glPointSize:new l(1),glPosition:new b(u,o,1),color:p}}_maybeWriteHittest(t){return this.hittestRequest!=null?t.color:null}};a([yr],Z.prototype,"inside",void 0),a([yr],Z.prototype,"outside",void 0),a([N(Re)],Z.prototype,"highlight",void 0),a([h(L)],Z.prototype,"storage",void 0),a([h(D)],Z.prototype,"view",void 0),a([N(Ct)],Z.prototype,"hittestRequest",void 0);function oi(e,t){return Ze(e,Wn(t))}function zt(e,t,r){const n=r.subtract(t),i=oi(e.subtract(t),n),o=We(i.divide(kr(n)),new l(0),new l(1));return Ar(e,t.add(o.multiply(r.subtract(t))))}function si(e){const t=Hn(e);return et(t.x.add(t.y).add(t.z),new l(1.05))}function ai(e,t,r,n){const i=new j(r.x.multiply(n.y).subtract(n.x.multiply(r.y)),n.x.multiply(t.y).subtract(t.x.multiply(n.y)),t.x.multiply(r.y).subtract(r.x.multiply(t.y)),r.y.subtract(n.y),n.y.subtract(t.y),t.y.subtract(r.y),n.x.subtract(r.x),t.x.subtract(n.x),r.x.subtract(t.x)),o=t.x.multiply(r.y.subtract(n.y)),s=r.x.multiply(n.y.subtract(t.y)),u=n.x.multiply(t.y.subtract(r.y)),p=o.add(s).add(u);return new l(1).divide(p).multiply(i.multiply(new I(1,e)))}function li(e,t,r,n){return He(si(ai(e,t,r,n)),new l(1))}function ui(e,t,r,n){const i=r.subtract(t),o=n.subtract(t),s=ti(i,o),u=Pe(Kn(s,new l(lr)),k(s,new l(-lr)));return Rt([Pe(Zn(u),li(e.xy,t,r,n)),new l(-1)],[!0,()=>{const p=zt(e,t,r),c=zt(e,r,n),y=zt(e,n,t);return Ae(Ae(p,c),y)}])}function Ur(e){return e.distance.add(1)}function Je(e,t,r){const{viewMat3:n,tileMat3:i}=e.view,o=n.multiply(i),s=o.multiply(new I(t.pos,1)),u=o.multiply(new I(r.nextPos1,1)),p=o.multiply(new I(r.nextPos2,1));return ui(e.hittestRequest.position,s.xy,u.xy,p.xy)}function Eo(e,t,r){return Ar(e,r).subtract(t)}let At=class extends E{getColor(t,r,n){return Rt([Dr(lt(t),n),r],[pe(t,this.values.first()),this.colors.first()],[de(t,this.values.last()),this.colors.last()],[!0,()=>{const i=this.values.findIndex(c=>k(c,t)),o=this.values.get(i),s=i.subtract(1),u=this.values.get(s),p=t.subtract(u).divide(o.subtract(u));return wt(this.colors.get(s),this.colors.get(i),p)}])}};a([h(U.ofType(b,8))],At.prototype,"colors",void 0),a([h(U.ofType(l,8))],At.prototype,"values",void 0);let Mt=class extends E{getOpacity(t){return Rt([lt(t),new l(1)],[pe(t,this.opacityValues.first()),this.opacities.first()],[de(t,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const r=this.opacityValues.findIndex(u=>k(u,t)),n=this.opacityValues.get(r),i=r.subtract(1),o=this.opacityValues.get(i),s=t.subtract(o).divide(n.subtract(o));return wt(this.opacities.get(i),this.opacities.get(r),s)}])}};a([h(U.ofType(l,8))],Mt.prototype,"opacities",void 0),a([h(U.ofType(l,8))],Mt.prototype,"opacityValues",void 0);function Lr(e){return e.visualVariableSizeMinMaxValue!=null||e.visualVariableSizeScaleStops!=null||e.visualVariableSizeStops!=null||e.visualVariableSizeUnitValue!=null}function ci(e,t,r){var n,i,o,s;if(Lr(e)){const u=e.storage.getSizeValue(t);return((n=e.visualVariableSizeMinMaxValue)==null?void 0:n.getSize(u,r))??((i=e.visualVariableSizeScaleStops)==null?void 0:i.getSizeForViewScale(e.view.currentScale))??((o=e.visualVariableSizeStops)==null?void 0:o.getSize(u,r))??((s=e.visualVariableSizeUnitValue)==null?void 0:s.getSize(u,r))}return r}function Qe(e,t,r,n=new P(!1)){if(e.visualVariableColor==null)return r;const i=e.storage.getColorValue(t);return e.visualVariableColor.getColor(i,r,n)}function Ye(e,t){if(e.visualVariableOpacity==null)return new l(1);const r=e.storage.getOpacityValue(t);return e.visualVariableOpacity.getOpacity(r)}function Ko(e,t){if(e.visualVariableRotation==null)return j.identity();const r=e.storage.getRotationValue(t);return e.visualVariableRotation.getVVRotationMat3(r)}function Bo(e,t){if(e.visualVariableRotation==null)return new l(0);const r=e.storage.getRotationValue(t);return e.visualVariableRotation.getNormalizedAngle(r)}let kt=class extends at{};a([m(3,b)],kt.prototype,"color",void 0),a([m(4,g)],kt.prototype,"zoomRange",void 0);let ft=class extends Z{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,r){const n=Ye(this,t.id),i=Qe(this,t.id,t.color).multiply(n),o=this.view.displayViewScreenMat3.multiply(new I(t.pos.xy,1)),s=this.clip(t.id,t.zoomRange);return{glPosition:new b(o.xy,s,1),color:i,...this.maybeRunHittest(t,r,null)}}fragment(t){return this.getFragmentOutput(t.color,t,new l(0))}hittest(t,r){return Je(this,t,r)}};a([N(At)],ft.prototype,"visualVariableColor",void 0),a([N(Mt)],ft.prototype,"visualVariableOpacity",void 0),a([$(0,T(kt)),$(1,T(X))],ft.prototype,"vertex",null),a([$(0,T(he))],ft.prototype,"fragment",null);let gt=class extends E{getPatternOffsetAtTileOrigin(t,r=new l(0),n=new l(1)){const i=new g(vn).divide(t);let o=t.multiply(Mr(this.maxIntsToLocalOrigin.multiply(i))).add(this.tileOffsetFromLocalOrigin).subtract(new l(.5).multiply(t));return o=new g(o.x.multiply(n).subtract(o.y.multiply(r)),o.x.multiply(r).add(o.y.multiply(n))),xt(o,t)}};a([h(g)],gt.prototype,"tileOffsetFromLocalOrigin",void 0),a([h(g)],gt.prototype,"maxIntsToLocalOrigin",void 0);let vt=class extends E{};a([h(g)],vt.prototype,"size",void 0),a([h(K)],vt.prototype,"texture",void 0);let it=class extends kt{};a([m(5,b)],it.prototype,"tlbr",void 0),a([m(6,l)],it.prototype,"width",void 0),a([m(7,l)],it.prototype,"height",void 0),a([m(8,g)],it.prototype,"offset",void 0),a([m(9,g)],it.prototype,"scale",void 0),a([m(10,l)],it.prototype,"angle",void 0);let pi=class extends he{};function di(e,t,r,n,i){const o=He(nt(i,gn),x(1)),s=ii(new b(e,0));return O(o,cr(n.divide(t.x),r.divide(t.y),0,ae(r.divide(t.x)),n.divide(t.y),0,fr(De(s,0)),fr(De(0,s)),1),cr(n.divide(t.x),r.divide(t.y),0,ae(r.divide(t.x)),n.divide(t.y),0,0,0,1))}function Kr(e,t){const r=e.view.requiredZoomFactor,n=new g(t.width,t.height),i=n.multiply(t.scale).multiply(r),o=t.angle.multiply(cn),s=Xe(o),u=Pr(o),p=di(t.id,i,s,u,t.bitset),c=e.localTileOffset.getPatternOffsetAtTileOrigin(n,s,u),y=r.multiply(t.scale).multiply(t.offset.subtract(c)).divide(i),f=new I(t.pos,1),v=p.multiply(f).xy.subtract(y),V=t.tlbr.divide(e.mosaicInfo.size.xyxy);let C=nt(t.bitset,fn);return e.visualVariableColor!=null&&(C=O(lt(e.storage.getColorValue(t.id)),new l(0),C)),{tileTextureCoord:v,tlbr:V,sampleAlphaOnly:C}}function Br(e,t){const r=xt(t.tileTextureCoord,new l(1)),n=wt(t.tlbr.xy,t.tlbr.zw,r);let i=B(e.mosaicInfo.texture,n);return i=O(k(t.sampleAlphaOnly,new l(.5)),i.aaaa,i),t.color.multiply(i)}let jt=class extends ft{vertex(t,r){return{...super.vertex(t,r),...Kr(this,t)}}fragment(t){const r=Br(this,t);return this.getFragmentOutput(r,t,new l(0))}};a([h(vt)],jt.prototype,"mosaicInfo",void 0),a([h(gt)],jt.prototype,"localTileOffset",void 0),a([$(0,T(it)),$(1,T(X))],jt.prototype,"vertex",null),a([$(0,T(pi))],jt.prototype,"fragment",null);let tr=class extends E{getSize(t,r){const n=this.minMaxValueAndSize.xy,i=this.minMaxValueAndSize.zw;return O(lt(t),r,()=>{const o=t.subtract(n.x).divide(n.y.subtract(n.x)),s=We(o,new l(0),new l(1));return i.x.add(s.multiply(i.y.subtract(i.x)))})}};a([h(b)],tr.prototype,"minMaxValueAndSize",void 0);let le=class extends E{getSizeForViewScale(t){return Rt([pe(t,this.values.first()),this.sizes.first()],[de(t,this.values.last()),this.sizes.last()],[!0,()=>{const r=this.values.findIndex(u=>k(u,t)),n=this.values.get(r),i=r.subtract(1),o=this.values.get(i),s=t.subtract(o).divide(n.subtract(o));return wt(this.sizes.get(i),this.sizes.get(r),s)}])}};a([h(U.ofType(l,8))],le.prototype,"sizes",void 0),a([h(U.ofType(l,8))],le.prototype,"values",void 0);let ue=class extends E{getSize(t,r){const n=Rt([lt(t),r],[pe(t,this.values.first()),this.sizes.first()],[de(t,this.values.last()),this.sizes.last()],[!0,()=>{const i=this.values.findIndex(c=>k(c,t)),o=this.values.get(i),s=i.subtract(1),u=this.values.get(s),p=t.subtract(u).divide(o.subtract(u));return wt(this.sizes.get(s),this.sizes.get(i),p)}]);return O(lt(n),r,n)}};a([h(U.ofType(l,8))],ue.prototype,"sizes",void 0),a([h(U.ofType(l,8))],ue.prototype,"values",void 0);let er=class extends E{getSize(t,r){return O(lt(t),r,t.multiply(this.unitValueToPixelsRatio))}};a([h(l)],er.prototype,"unitValueToPixelsRatio",void 0);class ot extends at{}a([m(3,b)],ot.prototype,"color",void 0),a([m(4,g)],ot.prototype,"offset",void 0),a([m(5,g)],ot.prototype,"normal",void 0),a([m(6,l)],ot.prototype,"halfWidth",void 0),a([m(7,l)],ot.prototype,"referenceHalfWidth",void 0),a([m(8,g)],ot.prototype,"zoomRange",void 0);let jr=class extends he{},ce=class extends E{};function Hr(e){return mt(new l(pn).multiply(et(e,new l(dn))),new l(1))}function hi(e,t){const{halfWidth:r,normal:n}=e,i=Hr(r),o=kr(n).multiply(r);return We(i.multiply(r.subtract(o)).divide(t.add(i).subtract(new l(1))),new l(0),new l(1))}function yi(e,t){const{id:r,halfWidth:n,referenceHalfWidth:i}=t;if(Lr(e)){const o=new l(2).multiply(i),s=ci(e,r,o);return new l(.5).multiply(n.divide(mt(i,new l(hn)))).multiply(s)}return n}function Gr(e,t){const{id:r,offset:n,pos:i,normal:o,zoomRange:s}=t,{displayViewScreenMat3:u,displayViewMat3:p}=e.view,c=Qe(e,r,t.color),y=Ye(e,r),f=yi(e,t),v=new l(.5).multiply(e.antialiasingControls.antialiasing),V=mt(f.add(v),new l(.45)).add(new l(.1).multiply(v)),C=Hr(V).multiply(V).multiply(n),H=p.multiply(new I(C,new l(0))),Y=u.multiply(new I(i,new l(1))).add(H),St=new l(2).multiply(et(f,new l(0))).add(e.clip(r,s)),Kt=new b(Y.xy,St,1);return{color:c,opacity:y,halfWidth:V,normal:o,scaledOffset:C,scaledHalfWidth:f,glPosition:new b(Kt.xy,St,1)}}function ye(e,t){const{opacity:r,color:n}=e,i=hi(e,t);return r.multiply(n).multiply(i)}a([h(l)],ce.prototype,"antialiasing",void 0),a([h(l)],ce.prototype,"blur",void 0);class G extends Z{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,r){const n=Gr(this,t);return{...n,...this.maybeRunHittest(t,r,n.halfWidth)}}fragment(t){const r=ye(t,this.antialiasingControls.blur);return this.getFragmentOutput(r,t)}hittest(t,r,n){const{viewMat3:i,tileMat3:o}=this.view,s=i.multiply(o),u=s.multiply(new I(t.pos,1)),p=s.multiply(new I(r.nextPos1,1)),c=s.multiply(new I(r.nextPos2,1)),{distance:y,smallSymbolDistance:f,smallSymbolSizeThreshold:v}=this.hittestRequest,V=et(n,v.multiply(.5)).multiply(y.subtract(f)),C=this.hittestRequest.position;return Ae(zt(C,u.xy,p.xy),zt(C,u.xy,c.xy)).subtract(n).add(V)}}a([h(ce)],G.prototype,"antialiasingControls",void 0),a([N(At)],G.prototype,"visualVariableColor",void 0),a([N(Mt)],G.prototype,"visualVariableOpacity",void 0),a([N(tr)],G.prototype,"visualVariableSizeMinMaxValue",void 0),a([N(le)],G.prototype,"visualVariableSizeScaleStops",void 0),a([N(ue)],G.prototype,"visualVariableSizeStops",void 0),a([N(er)],G.prototype,"visualVariableSizeUnitValue",void 0),a([$(0,T(ot)),$(1,T(X))],G.prototype,"vertex",null),a([$(0,T(jr))],G.prototype,"fragment",null);class tt extends at{}a([m(3,g)],tt.prototype,"offset",void 0),a([m(4,b)],tt.prototype,"color",void 0),a([m(5,g)],tt.prototype,"normal",void 0),a([m(6,l)],tt.prototype,"halfWidth",void 0),a([m(7,l)],tt.prototype,"referenceHalfWidth",void 0),a([m(8,g)],tt.prototype,"zoomRange",void 0);let qr=class extends jr{};function rr(e,t,r){const{id:n,bitset:i}=t,o=nt(i,mn),s=k(o,new l(.5)),u=Gr(e,t),p=O(s,u.halfWidth,new l(0)),c=Ye(e,n),y=Qe(e,n,t.color),f=O(s,t.color,y.multiply(c)),v=e.view.displayViewScreenMat3.multiply(new I(t.pos.xy,1)),V=e.clip(t.id),C=new b(v.xy,V,1),H=O(s,u.glPosition,C),Y=r&&e.maybeRunHittest(t,r,s);return{isOutline:o,color:f,opacity:new l(1),halfWidth:p,normal:u.normal,glPosition:H,...Y}}let W=class extends Z{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}};a([h(ce)],W.prototype,"antialiasingControls",void 0),a([N(At)],W.prototype,"visualVariableColor",void 0),a([N(Mt)],W.prototype,"visualVariableOpacity",void 0),a([N(tr)],W.prototype,"visualVariableSizeMinMaxValue",void 0),a([N(le)],W.prototype,"visualVariableSizeScaleStops",void 0),a([N(ue)],W.prototype,"visualVariableSizeStops",void 0),a([N(er)],W.prototype,"visualVariableSizeUnitValue",void 0);class Ee extends W{vertex(t,r){return rr(this,t,r)}fragment(t){const{color:r,isOutline:n}=t,i=k(n,new l(.5)),o=ye(t,this.antialiasingControls.blur),s=O(i,o,r),u=O(i,new l(1/255),new l(0));return this.getFragmentOutput(s,t,u)}hittest(t,r,n){return O(n,Ur(this.hittestRequest),Je(this,t,r))}}a([$(0,T(tt)),$(1,T(X))],Ee.prototype,"vertex",null),a([$(0,T(qr))],Ee.prototype,"fragment",null);let Ue=class extends kt{};a([m(5,b)],Ue.prototype,"tlbr",void 0),a([m(6,l)],Ue.prototype,"inverseRasterizationScale",void 0);class fi extends he{}function mi(e){const t=new l(1),r=new l(0);return new j(t.divide(e.x),r.divide(e.y),0,ae(r.divide(e.x)),t.divide(e.y),0,0,0,1)}function Wr(e,t){const r=t.tlbr.xy,n=t.tlbr.zw,i=n.x.subtract(r.x),o=r.y.subtract(n.y),s=new g(i,o).multiply(t.inverseRasterizationScale),u=s.multiply(e.view.requiredZoomFactor),p=mi(u),c=e.localTileOffset.getPatternOffsetAtTileOrigin(s).divide(u),y=new I(t.pos,1);return{tileTextureCoord:p.multiply(y).xy.subtract(c),tlbr:t.tlbr.divide(e.mosaicInfo.size.xyxy)}}function Zr(e,t){const r=xt(e.tileTextureCoord,new l(1)),n=wt(e.tlbr.xy,e.tlbr.zw,r),i=B(t.texture,n);return e.color.multiply(i)}class Ht extends ft{vertex(t,r){return{...super.vertex(t,r),...Wr(this,t)}}fragment(t){const r=Zr(t,this.mosaicInfo);return this.getFragmentOutput(r,t,new l(0))}}a([h(vt)],Ht.prototype,"mosaicInfo",void 0),a([h(gt)],Ht.prototype,"localTileOffset",void 0),a([$(0,T(Ue)),$(1,T(X))],Ht.prototype,"vertex",null),a([$(0,T(fi))],Ht.prototype,"fragment",null);let Le=class extends tt{};a([m(9,b)],Le.prototype,"tlbr",void 0),a([m(10,l)],Le.prototype,"inverseRasterizationScale",void 0);let Xr=class extends qr{},Gt=class extends Ee{vertex(t,r){return{...rr(this,t,r),...Wr(this,t)}}fragment(t){const{isOutline:r}=t,n=k(r,new l(.5)),i=ye(t,this.antialiasingControls.blur),o=Zr(t,this.mosaicInfo),s=O(n,i,o),u=O(n,new l(1/255),new l(0));return this.getFragmentOutput(s,t,u)}};a([h(vt)],Gt.prototype,"mosaicInfo",void 0),a([h(gt)],Gt.prototype,"localTileOffset",void 0),a([$(0,T(Le)),$(1,T(X))],Gt.prototype,"vertex",null),a([$(0,T(Xr))],Gt.prototype,"fragment",null);const gi=16,mr=1/gi,vi=128;class q extends at{}a([m(3,b)],q.prototype,"color",void 0),a([m(4,b)],q.prototype,"tlbr",void 0),a([m(5,l)],q.prototype,"angle",void 0),a([m(6,l)],q.prototype,"aux1",void 0),a([m(7,l)],q.prototype,"aux2",void 0),a([m(8,g)],q.prototype,"aux3",void 0),a([m(9,g)],q.prototype,"aux4",void 0),a([m(10,g)],q.prototype,"zoomRange",void 0);class bi extends Xr{}class qt extends W{vertex(t,r){const{aux1:n,aux2:i,aux3:o,aux4:s}=t,u={...t,width:n,height:i,offset:o,scale:s.multiply(mr)},p={...t,halfWidth:n,referenceHalfWidth:i,offset:o,normal:s.subtract(vi).multiply(mr)},c=rr(this,p),y=Kr(this,u),f=k(c.isOutline,new l(.5));return{...c,...y,...this.maybeRunHittest(t,r,f)}}fragment(t){const{isOutline:r}=t,n=k(r,new l(.5)),i=ye(t,this.antialiasingControls.blur),o=Br(this,t),s=O(n,i,o),u=O(n,new l(1/255),new l(0));return this.getFragmentOutput(s,t,u)}hittest(t,r,n){return O(n,Ur(this.hittestRequest),Je(this,t,r))}}a([h(vt)],qt.prototype,"mosaicInfo",void 0),a([h(gt)],qt.prototype,"localTileOffset",void 0),a([$(0,T(q)),$(1,T(X))],qt.prototype,"vertex",null),a([$(0,T(bi))],qt.prototype,"fragment",null);const wi=8388607,xi=8388608,us=e=>e&wi;function cs(e,t){return((t?xi:0)|e)>>>0}var gr;(function(e){e.Local="Local",e.Global="Global"})(gr||(gr={}));class $t{generateSource(t){const r=[];for(let i=1;i<this.length;i++)r.push(`vec4 atom${i} = texture(${t.animationTexture}, (pointer + 0.5) / size);`),r.push("pointer.x += 1.0;");for(let i=0;i<this.ins;i++)r.push("top--;"),r.push(`vec4 in${this.ins-i-1} = stack[top];`);for(let i=0;i<this.outs;i++)r.push(`vec4 out${i};`);const{microcode:n}=this;for(const i of n)r.push(i);for(let i=0;i<this.outs;i++)r.push(`stack[top] = out${i};`),r.push("top++;"),r.push(`if (top >= ${Ke}) { top = ${Ke-1}; }`);return r}}let Tt=128;class $i extends $t{constructor(){super(...arguments),this.opcode=++Tt,this.length=1,this.ins=0,this.outs=0,this.microcode=["break;"]}encode(){return[[this.opcode,0,0,0]]}}class Ti extends $t{constructor(){super(...arguments),this.opcode=++Tt,this.length=1,this.ins=0,this.outs=1,this.microcode=["out0 = vec4(atom0.y, atom0.y, atom0.y, atom0.y);"]}encode(t){return[[this.opcode,t,0,0]]}}class Si extends $t{constructor(){super(...arguments),this.opcode=++Tt,this.length=1,this.ins=0,this.outs=1,this.microcode=["out0 = vec4(atom0.yzw, 0.0);"]}encode(t){return[[this.opcode,t[0]||0,t[1]||0,t[2]||0]]}}class _i extends $t{constructor(){super(...arguments),this.opcode=++Tt,this.length=2,this.ins=0,this.outs=1,this.microcode=["out0 = atom1;"]}encode(t){return[[this.opcode,0,0,0],t]}}function Dt(e){return[`float duration = clamp(${e.duration}, 0.05, 3600.0);`,`float startTimeOffset = ${e.startTimeOffset};`,`float repeatDelay = ${e.repeatDelay};`,`float timeOriginSelector = ${e.timeOriginSelector};`,`float repeatType = ${e.repeatType};`,`float easing = ${e.easing};`,`float playAnimation = ${e.playAnimation} * (1.0 - step(0.0, -${e.duration}));`,`float reverseAnimation = ${e.reverseAnimation};`,"float time = globalTime - (timeOriginSelector == 1.0 ? localTimeOrigin : 0.0);","time *= playAnimation;","time *= 1.0 - reverseAnimation * 2.0;","float period = duration + repeatDelay;","time += reverseAnimation == 1.0 ? (period - startTimeOffset - 0.001) : startTimeOffset + 0.001;","float omega = time / period;","float oi = floor(omega);","omega = repeatType == 1.0 || repeatType == 3.0 ? omega - oi : omega;","float of = omega * period;","of = (clamp(of, reverseAnimation * repeatDelay, period - (1.0 - reverseAnimation) * repeatDelay) - reverseAnimation * repeatDelay) / duration;","of = easing == 2.0 ? pow(of, 3.0) : of;","of = easing == 3.0 ? 1.0 - pow(1.0 - of, 3.0) : of;","of = easing == 4.0 ? of < 0.5 ? 4.0 * pow(of, 3.0) : 1.0 - pow(-2.0 * of + 2.0, 3.0) / 2.0 : of;","bool oscillate = repeatType == 3.0 && mod(oi, 2.0) == 1.0;",`${e.out} = oscillate ? 1.0 - of : of;`]}const Ii={Linear:1,EaseIn:2,EaseOut:3,EaseInOut:4},Oi={Loop:1,None:2,Oscillate:3},Vi={Local:1,Global:2};function Pt(e){const t=Ii[e.easing],r=Oi[e.repeatType],n=Vi[e.timeOriginSelector];return[[e.duration,e.startTimeOffset,e.repeatDelay,n],[r,t,e.playAnimation,e.reverseAnimation]]}class Ci extends $t{constructor(){super(...arguments),this.opcode=++Tt,this.length=10,this.ins=1,this.outs=1,this.microcode=["vec2 fromTranslation = atom1.xy;","vec2 toTranslation = atom1.zw;","float fromRotation = atom2.x;","float toRotation = atom2.y;","float fromScale = atom2.z;","float toScale = atom2.w;","bool relativeTranslation = atom9.x == 1.0;","bool absoluteScale = atom9.y == 1.0;","vec2 translationMultiplier = relativeTranslation ? pixelDimensions : vec2(1.0, 1.0);","float scaleDivisor = absoluteScale ? pixelDimensions.y : 1.0;","float fTranslation;","{",...Dt({duration:"atom3.x",startTimeOffset:"atom3.y",repeatDelay:"atom3.z",timeOriginSelector:"atom3.w",repeatType:"atom4.x",easing:"atom4.y",playAnimation:"atom4.z",reverseAnimation:"atom4.w",out:"fTranslation"}),"}","float fRotation;","{",...Dt({duration:"atom5.x",startTimeOffset:"atom5.y",repeatDelay:"atom5.z",timeOriginSelector:"atom5.w",repeatType:"atom6.x",easing:"atom6.y",playAnimation:"atom6.z",reverseAnimation:"atom6.w",out:"fRotation"}),"}","float fScale;","{",...Dt({duration:"atom7.x",startTimeOffset:"atom7.y",repeatDelay:"atom7.z",timeOriginSelector:"atom7.w",repeatType:"atom8.x",easing:"atom8.y",playAnimation:"atom8.z",reverseAnimation:"atom8.w",out:"fScale"}),"}","vec2 aTranslation = mix(fromTranslation, toTranslation, fTranslation);","float aRotation = mix(fromRotation, toRotation, fRotation);","float aScale = mix(fromScale, toScale, fScale);","vec2 pTranslation = in0.xy;","float pRotation = in0.z;","float pScale = in0.w;","aTranslation *= translationMultiplier;","aScale /= scaleDivisor;","float rotation = pRotation + aRotation;","float scale = pScale * aScale;","float sin1 = sin(pRotation);","float cos1 = cos(pRotation);","float s1 = pScale;","float x1 = pTranslation.x;","float y1 = pTranslation.y;","float x2 = aTranslation.x;","float y2 = aTranslation.y;",`
    vec2 translation = vec2(
      cos1 * s1 * x2 - sin1 * s1 * y2 + x1,
      sin1 * s1 * x2 + cos1 * s1 * y2 + y1
    );
    `,"out0 = vec4(translation, rotation, scale);"]}encode(t){return[[this.opcode,0,0,0],[t.translation.from[0],t.translation.from[1],t.translation.to[0],t.translation.to[1]],[t.rotation.from,t.rotation.to,t.scale.from,t.scale.to],...Pt(t.translation.timing),...Pt(t.rotation.timing),...Pt(t.scale.timing),[t.relativeTranslation?1:0,t.absoluteScale?1:0,0,0]]}}class Fi extends $t{constructor(){super(...arguments),this.opcode=++Tt,this.length=7,this.ins=1,this.outs=1,this.microcode=["float fromOpacity = atom0.y;","float toOpacity = atom0.z;","vec4 fromColor = atom1;","vec4 toColor = atom2;","float fColor;","{",...Dt({duration:"atom3.x",startTimeOffset:"atom3.y",repeatDelay:"atom3.z",timeOriginSelector:"atom3.w",repeatType:"atom4.x",easing:"atom4.y",playAnimation:"atom4.z",reverseAnimation:"atom4.w",out:"fColor"}),"}","float fOpacity;","{",...Dt({duration:"atom5.x",startTimeOffset:"atom5.y",repeatDelay:"atom5.z",timeOriginSelector:"atom5.w",repeatType:"atom6.x",easing:"atom6.y",playAnimation:"atom6.z",reverseAnimation:"atom6.w",out:"fOpacity"}),"}","vec4 aColor = mix(fromColor, toColor, fColor);","aColor.a *= mix(fromOpacity, toOpacity, fOpacity);","vec4 pColor = in0;","out0 = aColor * pColor;"]}encode(t){return[[this.opcode,t.opacity.from,t.opacity.to,0],[t.color.from[0],t.color.from[1],t.color.from[2],t.color.from[3]],[t.color.to[0],t.color.to[1],t.color.to[2],t.color.to[3]],...Pt(t.color.timing),...Pt(t.opacity.timing)]}}const vr={scalar:new Ti,vector3:new Si,vector4:new _i,animatedTransform:new Ci,animatedColor:new Fi,ret:new $i},Ni=40,Ke=4;function ps(e){const t=[];t.push(`float globalTime = ${e.globalTime};`),t.push(`float localTimeOrigin = ${e.localTimeOrigin};`),t.push(`vec2 pointer = ${e.animationPointer};`),t.push(`vec2 size = ${e.animationTextureSize};`),t.push("int top = 0;"),t.push(`vec4 stack[${Ke}];`),t.push(`for (int counter = 0; counter < ${Ni}; counter++) {`),t.push(`vec4 atom0 = texture(${e.animationTexture}, (pointer + 0.5) / size);`),t.push("pointer.x += 1.0;"),t.push(`vec2 pixelDimensions = ${e.pixelDimensions};`),t.push("if (false) {");for(const r in vr){const n=vr[r];t.push(`} else if (int(atom0.x) == ${n.opcode}) {`);for(const i of n.generateSource(e))t.push(i)}return t.push("} // End if-else."),t.push("} // End for."),t.push(`${e.out} = top > 0 ? stack[top - 1] : vec4(0.0);`),t.join(`
`)}let Wt=class extends sn{constructor(e){super(e),this.debugName="",this._updatingHandles=new un,this._idToUpdatingState=new an}get updating(){const e=this._updatingHandles.updating||Array.from(this._idToUpdatingState.values()).some(t=>t);if(wr("esri-2d-log-updating")){const t=Array.from(this._idToUpdatingState.entries()).map(([r,n])=>`-> ${r}: ${n}`).join(`
`);console.log(`${this.debugName}: Updating: ${e}
-> Handles: ${this._updatingHandles.updating}
${t}`)}return e}addUpdateTracking(e,t){const r=ln(()=>t.updating,n=>this._idToUpdatingState.set(e,n),{sync:!0});this.addHandles(r)}addPromise(e){return this._updatingHandles.addPromise(e)}};a([or({constructOnly:!0})],Wt.prototype,"debugName",void 0),a([or({readOnly:!0})],Wt.prototype,"updating",null),Wt=a([en("esri.views.2d.layers.support.UpdateTracking2D")],Wt);export{cs as $,vo as A,Kn as B,g as C,Vo as D,Co as E,to as F,I as G,b as H,ke as I,fo as J,yr as K,kr as L,Pr as M,Mr as N,go as O,E as P,rt as Q,mo as R,K as S,co as T,He as U,yo as V,Q as W,wt as X,Hn as Y,Xe as Z,wi as _,Yn as a,ot as a$,yn as a0,gn as a1,fn as a2,mn as a3,gi as a4,vi as a5,Qi as a6,Yi as a7,Xi as a8,Ji as a9,Dr as aA,P as aB,Io as aC,Ye as aD,Ar as aE,ui as aF,ai as aG,ae as aH,si as aI,Ur as aJ,D as aK,U as aL,Oo as aM,ft as aN,jt as aO,qt as aP,Ee as aQ,Ht as aR,Gt as aS,Eo as aT,qn as aU,Wi as aV,Ko as aW,Zi as aX,po as aY,ho as aZ,G as a_,gr as aa,Ft as ab,lt as ac,ar as ad,Gi as ae,N as af,at as ag,Z as ah,Bo as ai,ii as aj,qi as ak,zr as al,ps as am,vt as an,At as ao,Mt as ap,tr as aq,le as ar,ue as as,er as at,he as au,Jn as av,nt as aw,Mn as ax,ci as ay,Qe as az,Ze as b,Gr as b0,hi as b1,X as b2,hr as b3,cn as c,Wt as d,sr as e,us as f,h as g,m as h,vr as i,l as j,We as k,B as l,T as m,mt as n,Hi as o,Ae as p,Rt as q,et as r,pe as s,j as t,Fo as u,Nt as v,Qn as w,O as x,k as y,ei as z};
