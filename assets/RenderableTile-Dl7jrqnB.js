import{a as R,e as v}from"./DefaultUI-C0utm694.js";import{t as L,e as O}from"./config-MDUrh2eL.js";import{n as J,l as x,r as I}from"./StyleDefinition-BTt_i6C1.js";import{E as P}from"./enums-BRzLM11V.js";import{w as k}from"./GeometryUtils-Dyjqugo6.js";import{r as A}from"./DefaultVertexAttributeLayouts-PrbBmwty.js";let V=class{constructor(e,o){this.sourceTile=o,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}};class Z{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function C(y,e,o,t,s,l){const c=o-s;if(c>=0)return(e>>c)+(t-(l<<c))*(y>>c);const i=-c;return e-(l-(t<<i))*(y>>i)<<i}let q=class{constructor(e,o,t){this._rows=Math.ceil(o/t),this._columns=Math.ceil(e/t),this._cellSize=t,this.cells=new Array(this._rows);for(let s=0;s<this._rows;s++){this.cells[s]=new Array(this._columns);for(let l=0;l<this._columns;l++)this.cells[s][l]=[]}}getCell(e,o){const t=Math.min(Math.max(Math.floor(o/this._cellSize),0),this._rows-1),s=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[t]&&this.cells[t][s]||null}getCellSpan(e,o,t,s){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(o/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}};function te(y,e,o,t,s,l,c){const i=e[t++];for(let r=0;r<i;r++){const a=new V(l,c);a.xTile=e[t++],a.yTile=e[t++],a.hash=e[t++],a.priority=e[t++],a.featureIndex=e[t++];const f=e[t++];for(let n=0;n<f;n++){const m=e[t++],b=e[t++],_=e[t++],d=e[t++],p=!!e[t++],g=e[t++],S=o[t++],w=o[t++],T=e[t++],M=e[t++];a.colliders.push({xTile:m,yTile:b,dxPixels:_,dyPixels:d,hard:p,partIndex:g,width:T,height:M,minLod:S,maxLod:w})}const h=y[t++];for(let n=0;n<h;n++)a.textVertexRanges.push([y[t++],y[t++]]);const u=y[t++];for(let n=0;n<u;n++)a.iconVertexRanges.push([y[t++],y[t++]]);s.push(a)}return t}function oe(y,e,o){for(const[t,s]of y.symbols)z(y,e,o,s,t)}function z(y,e,o,t,s){const l=y.layerData.get(s);if(l.type===P.SYMBOL){for(const c of t){const i=c.unique;let r;if(c.selectedForRendering){const a=i.parts[0],f=a.startOpacity,h=a.targetOpacity;y.allSymbolsFadingOut=y.allSymbolsFadingOut&&h===0;const u=o?Math.floor(127*f)|h<<7:h?255:0;r=u<<24|u<<16|u<<8|u}else r=0;for(const[a,f]of c.iconVertexRanges)for(let h=a;h<a+f;h+=4)l.iconOpacity[h/4]=r;if(c.selectedForRendering){const a=i.parts[1],f=a.startOpacity,h=a.targetOpacity;y.allSymbolsFadingOut=y.allSymbolsFadingOut&&h===0;const u=o?Math.floor(127*f)|h<<7:h?255:0;r=u<<24|u<<16|u<<8|u}else r=0;for(const[a,f]of c.textVertexRanges)for(let h=a;h<a+f;h+=4)l.textOpacity[h/4]=r}l.lastOpacityUpdate=e,l.opacityChanged=!0}}function $(y,e,o,t){const s=y.colliders;let l,c,i,r;for(const a of s)if(y.unique.show&&y.unique.parts[a.partIndex].show&&(l=a.xScreen-t[0]+a.dxScreen,c=a.yScreen-t[1]+a.dyScreen,i=l+a.width,r=c+a.height,k(o,e.x,e.y,l,c,i,r)))return!0;return!1}function U(y,e,o,t,s,l){const{iconRotationAlignment:c,textRotationAlignment:i,iconTranslate:r,iconTranslateAnchor:a,textTranslate:f,textTranslateAnchor:h}=t;let u=0;for(const n of y.colliders){const[m,b]=n.partIndex===0?r:f,_=n.partIndex===0?a:h,d=n.minLod<=l&&l<=n.maxLod;u+=d?0:1,n.enabled=d,n.xScreen=n.xTile*s[0]+n.yTile*s[3]+s[6],n.yScreen=n.xTile*s[1]+n.yTile*s[4]+s[7],_===I.MAP?(n.xScreen+=o*m-e*b,n.yScreen+=e*m+o*b):(n.xScreen+=m,n.yScreen+=b),x.VIEWPORT===(n.partIndex===0?c:i)?(n.dxScreen=n.dxPixels,n.dyScreen=n.dyPixels):(n.dxScreen=o*(n.dxPixels+n.width/2)-e*(n.dyPixels+n.height/2)-n.width/2,n.dyScreen=e*(n.dxPixels+n.width/2)+o*(n.dyPixels+n.height/2)-n.height/2)}y.colliders.length>0&&u===y.colliders.length&&(y.unique.show=!1)}class se{constructor(e,o,t,s,l,c){this._symbols=e,this._styleRepository=s,this._zoom=l,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new q(o,t,L),this._si=Math.sin(Math.PI*c/180),this._co=Math.cos(Math.PI*c/180);for(const i of e)for(const r of i.symbols)this._allNeededMatrices.has(r.tile)||this._allNeededMatrices.set(r.tile,R(r.tile.transforms.tileUnitsToPixels))}work(e){const o=this._gridIndex;function t(l){const c=l.xScreen+l.dxScreen,i=l.yScreen+l.dyScreen,r=c+l.width,a=i+l.height,[f,h,u,n]=o.getCellSpan(c,i,r,a);for(let m=h;m<=n;m++)for(let b=f;b<=u;b++){const _=o.cells[m][b];for(const d of _){const p=d.xScreen+d.dxScreen,g=d.yScreen+d.dyScreen,S=p+d.width,w=g+d.height;if(!(r<p||c>S||a<g||i>w))return!0}}return!1}const s=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const l=this._symbols[this._currentLayerCursor],c=this._getProperties(l.styleLayerUID);for(;this._currentSymbolCursor<l.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-s>e)return!1;const i=l.symbols[this._currentSymbolCursor];if(!i.unique.show)continue;U(i,this._si,this._co,c,this._allNeededMatrices.get(i.tile),this._zoom);const r=i.unique;if(!r.show)continue;const{iconAllowOverlap:a,iconIgnorePlacement:f,textAllowOverlap:h,textIgnorePlacement:u}=c;for(const n of i.colliders){if(!n.enabled)continue;const m=r.parts[n.partIndex];m.show&&!(n.partIndex?h:a)&&t(n)&&(n.hard?r.show=!1:m.show=!1)}if(r.show)for(const n of i.colliders){if(!n.enabled||(n.partIndex?u:f)||!r.parts[n.partIndex].show)continue;const m=n.xScreen+n.dxScreen,b=n.yScreen+n.dyScreen,_=m+n.width,d=b+n.height,[p,g,S,w]=this._gridIndex.getCellSpan(m,b,_,d);for(let T=g;T<=w;T++)for(let M=p;M<=S;M++)this._gridIndex.cells[T][M].push(n)}}}return!0}_getProperties(e){const o=this._styleProps.get(e);if(o)return o;const t=this._zoom,s=this._styleRepository.getStyleLayerByUID(e),l=s.getLayoutValue("symbol-placement",t)!==J.POINT;let c=s.getLayoutValue("icon-rotation-alignment",t);c===x.AUTO&&(c=l?x.MAP:x.VIEWPORT);let i=s.getLayoutValue("text-rotation-alignment",t);i===x.AUTO&&(i=l?x.MAP:x.VIEWPORT);const r=s.getPaintValue("icon-translate",t),a=s.getPaintValue("icon-translate-anchor",t),f=s.getPaintValue("text-translate",t),h=s.getPaintValue("text-translate-anchor",t),u={iconAllowOverlap:s.getLayoutValue("icon-allow-overlap",t),iconIgnorePlacement:s.getLayoutValue("icon-ignore-placement",t),textAllowOverlap:s.getLayoutValue("text-allow-overlap",t),textIgnorePlacement:s.getLayoutValue("text-ignore-placement",t),iconRotationAlignment:c,textRotationAlignment:i,iconTranslateAnchor:a,iconTranslate:r,textTranslateAnchor:h,textTranslate:f};return this._styleProps.set(e,u),u}}function F(y,e){if(y.priority-e.priority)return y.priority-e.priority;const o=y.tile.key,t=e.tile.key;return o.world-t.world?o.world-t.world:o.level-t.level?o.level-t.level:o.row-t.row?o.row-t.row:o.col-t.col?o.col-t.col:y.xTile-e.xTile?y.xTile-e.xTile:y.yTile-e.yTile}let le=class{get running(){return this._running}constructor(e,o,t,s,l,c){this._visibleTiles=e,this._symbolRepository=o,this._createCollisionJob=t,this._assignTileSymbolsOpacity=s,this._symbolLayerSorter=l,this._isLayerVisible=c,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,o){this._screenWidth===e&&this._screenHeight===o||this.restart(),this._screenWidth=e,this._screenHeight=o}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const o=performance.now();if(!this._selectionJob.work(e)||(this._selectionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-o)))===0))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const o=performance.now();if(!this._collisionJob.work(e)||(this._collisionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-o)))===0))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const o=performance.now();if(!this._opacityJob.work(e)||(this._opacityJobCompleted=!0,(e=Math.max(0,e-(performance.now()-o)))===0))return!1}return this._running=!1,!0}_createSelectionJob(){const e=this._symbolRepository.uniqueSymbols;for(let r=0;r<e.length;r++){const a=e[r];for(let f=0;f<a.uniqueSymbols.length;f++){const h=a.uniqueSymbols[f];for(const u of h.tileSymbols)u.selectedForRendering=!1}}const o=[];let t=0,s=0;const l=this._isLayerVisible;function c(r){let a;const f=performance.now();for(;s<e.length;s++,t=0){const h=e[s],u=h.styleLayerUID;if(!l(u)){o[s]||(o[s]={styleLayerUID:u,symbols:[]});continue}o[s]=o[s]||{styleLayerUID:u,symbols:[]};const n=o[s];for(;t<h.uniqueSymbols.length;t++){if(a=h.uniqueSymbols[t],t%100==99&&performance.now()-f>r)return!1;let m=null,b=!1,_=!1;for(const d of a.tileSymbols)if(!_||!b){const p=d.tile;(!m||p.isCoverage||p.neededForCoverage&&!b)&&(m=d,(p.neededForCoverage||p.isCoverage)&&(_=!0),p.isCoverage&&(b=!0))}if(m.selectedForRendering=!0,_){n.symbols.push(m),a.show=!0;for(const d of a.parts)d.show=!0}else a.show=!1}}for(const h of o)h.symbols.sort(F);return!0}const i=this._symbolLayerSorter;return{work:c,get sortedSymbols(){return o.sort(i)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,o=this._visibleTiles;let t=0;function s(l,c){for(const i of l.symbols.values())D(i,c);e(l,c);for(const i of l.childrenTiles)s(i,c)}return{work(l){const c=performance.now();for(;t<o.length;t++){if(performance.now()-c>l)return!1;const i=o[t];i.parentTile==null&&s(i,performance.now())}return!0}}}};function D(y,e){for(const o of y){const t=o.unique;for(const s of t.parts){const l=s.targetOpacity>.5?1:-1;s.startOpacity+=l*((e-s.startTime)/O),s.startOpacity=Math.min(Math.max(s.startOpacity,0),1),s.startTime=e,s.targetOpacity=t.show&&s.show?1:0}}}const W=32,N=8,E=64,H=20;class ne{constructor(e,o,t){this.tileCoordRange=e,this._visibleTiles=o,this._createUnique=t,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return this._uniqueSymbolLayerArray==null&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}get uniqueSymbolsReferences(){return this._uniqueSymbolsReferences}add(e,o){this._uniqueSymbolLayerArray=null;let t=this._tiles.get(e.id);t||(t={symbols:new Map},this._tiles.set(e.id,t));const s=new Map;if(o)for(const i of o)t.symbols.has(i)&&(s.set(i,t.symbols.get(i)),t.symbols.delete(i));else for(const[i,r]of e.layerData)t.symbols.has(i)&&(s.set(i,t.symbols.get(i)),t.symbols.delete(i));this._removeSymbols(s);const l=e.symbols,c=new Map;for(const[i,r]of l){let a=r.length;if(a>=W){let f=this.tileCoordRange;do f/=2,a/=4;while(a>N&&f>E);const h=new q(this.tileCoordRange,this.tileCoordRange,f);c.set(i,{flat:r,index:h}),t.symbols.set(i,{flat:r,index:h});for(const u of r)h.getCell(u.xTile,u.yTile).push(u)}else c.set(i,{flat:r}),t.symbols.set(i,{flat:r})}this._addSymbols(e.key,l)}deleteStyleLayers(e){this._uniqueSymbolLayerArray=null;for(const[o,t]of this._tiles){const s=new Map;for(const l of e)t.symbols.has(l)&&(s.set(l,t.symbols.get(l)),t.symbols.delete(l));this._removeSymbols(s),t.symbols.size===0&&this._tiles.delete(o)}}removeTile(e){this._uniqueSymbolLayerArray=null;const o=this._tiles.get(e.id);if(!o)return;const t=new Map;for(const[s,l]of e.symbols)o.symbols.has(s)&&(t.set(s,o.symbols.get(s)),o.symbols.delete(s));this._removeSymbols(t),o.symbols.size===0&&this._tiles.delete(e.id)}querySymbols(e,o,t,s){const l=[],c=this.uniqueSymbols;for(const i of c){const r=i.styleLayerUID,a=i.uniqueSymbols;for(const f of a){const h=f.tileSymbols.find(u=>u.selectedForRendering);h&&$(h,e,o*(window.devicePixelRatio||1),t)&&l.push({vtlSymbol:h,styleLayerUID:r,tileKey:h.tile.key})}}return l}_removeSymbols(e){for(const[o,{flat:t}]of e)for(const s of t){const l=s.unique,c=l.tileSymbols,i=c.length-1;for(let r=0;r<i;r++)if(c[r]===s){c[r]=c[i];break}if(c.length=i,i===0){const r=this._uniqueSymbolsReferences.get(o);r.delete(l),r.size===0&&this._uniqueSymbolsReferences.delete(o)}s.unique=null}}_addSymbols(e,o){if(o.size===0)return;const t=this._visibleTiles;for(const s of t)s.parentTile||s.key.world!==e.world||s.key.level===e.level&&!s.key.equals(e)||this._matchSymbols(s,e,o);for(const[s,l]of o)for(const c of l)if(c.unique==null){const i=this._createUnique();c.unique=i,i.tileSymbols.push(c);let r=this._uniqueSymbolsReferences.get(s);r||(r=new Set,this._uniqueSymbolsReferences.set(s,r)),r.add(i)}}_matchSymbols(e,o,t){if(e.key.level>o.level){const l=e.key.level-o.level;if(e.key.row>>l!==o.row||e.key.col>>l!==o.col)return}if(o.level>e.key.level){const l=o.level-e.key.level;if(o.row>>l!==e.key.row||o.col>>l!==e.key.col)return}if(o.equals(e.key)){for(const l of e.childrenTiles)this._matchSymbols(l,o,t);return}const s=new Map;for(const[l,c]of t){const i=[];for(const h of c){const u=C(this.tileCoordRange,h.xTile,o.level,o.col,e.key.level,e.key.col),n=C(this.tileCoordRange,h.yTile,o.level,o.row,e.key.level,e.key.row);u>=0&&u<this.tileCoordRange&&n>=0&&n<this.tileCoordRange&&i.push({symbol:h,xTransformed:u,yTransformed:n})}const r=[],a=(e.key.level<o.level?1:1<<e.key.level-o.level)+H,f=this._tiles.get(e.id).symbols.get(l);if(f){const h=f.flat;for(const u of i){let n,m=!1;const b=u.xTransformed,_=u.yTransformed;n=f.index!=null?f.index.getCell(b,_):h;const d=u.symbol,p=d.hash;for(const g of n)if(p===g.hash&&Math.abs(b-g.xTile)<=a&&Math.abs(_-g.yTile)<=a){const S=g.unique;d.unique=S,S.tileSymbols.push(d),m=!0;break}m||r.push(d)}}r.length>0&&s.set(l,r)}for(const l of e.childrenTiles)this._matchSymbols(l,o,s)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsReferences,o=new Array(e.size);let t,s=0;for(const[l,c]of e){const i=new Array(c.size);t=0;for(const r of c)i[t++]=r;o[s]={styleLayerUID:l,uniqueSymbols:i},s++}return o}}class re extends A{_createTransforms(){return{displayViewScreenMat3:v(),tileMat3:v()}}}export{oe as a,re as b,te as c,se as l,ne as r,Z as s,le as t};
