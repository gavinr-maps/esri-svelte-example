const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./symbolLayerUtils-9ZRBOe8t.js","./index-CeCSsEgo.js","./index-CjOb8WjV.css","./assets-C2mb-ea2.js","./subclass-BR3PhgZG.js","./Evented-CXIxDjmW.js","./Accessor-D6mNnsWy.js","./LRUCache-ju6LnIBZ.js","./MemCache-C6WUx-5V.js","./mathUtils-ClvKsMak.js","./aaBoundingBox-rJEWaOSN.js","./Extent-DHjqVB-p.js","./Point-DB4Hp4hH.js","./jsonMap-DCC6W5ex.js","./writer-3zufXUNV.js","./Polyline-D97hl-6E.js","./symbols-CsUQ5BxR.js","./enumeration--HlxOQ_N.js","./fieldUtils-CNduWQU9.js","./intl-Dpfm8vPB.js","./Promise-CZrWwByK.js","./geometry-DpwwkAX1.js","./TextSymbol-gKE-H_J6.js","./Color-DDUWtbqR.js","./colorUtils-CS9vdHXB.js","./screenUtils-PfxkaaMN.js","./materialUtils-CQ3JLQ1x.js","./opacityUtils-BT7mQkwC.js","./persistableUrlUtils-BcifXQ1Z.js","./reactiveUtils-BFQ0BtrB.js","./shared-B3wH2qpO.js","./collectionUtils-Dm1icNvk.js","./Portal-liet8xHC.js","./Clonable-cKbRam6-.js","./Upload-C5L-qIWV.js","./progressUtils-l3fizrvn.js","./infoFor3D-CxOdoily.js","./helpMessageUtils3d-C5Z3FjL3.js","./elevationInfoUtils-Bl7QRRwv.js","./unitConversionUtils-Dl04YuQU.js","./lengthUtils-D7_DvYH0.js","./calcite-scrim-ByhE7nPY.js","./scrim-tJUFlVOZ.js","./jsxFactory-CbAu6VfF.js","./uuid-fwrPAdZb.js","./locale-BUTTOPma.js","./dom-Cv0oa6So.js","./key-D5DPfjW0.js","./observers-EizV_Lvc.js","./t9n-DfK3dFGw.js","./loader-wfvKSvDR.js","./calcite-button-D_QRw8fR.js","./button-CT5wDIjk.js","./form-DcBTx4ZC.js","./interactive-Dtpmn6Ls.js","./label-rdYpV4K5.js","./component-ByvC-PUv.js","./loadable-CTFTnu2T.js","./icon-DIKjN-ev.js","./calcite-notice-DAIcfVw0.js","./conditionalSlot-MT4PnZbw.js","./openCloseComponent-v_dlVp47.js","./calcite-accordion-CIMDxbLr.js","./calcite-accordion-item-7SNIzdd3.js","./calcite-icon-CocWVhPd.js","./calcite-loader-DxqUpD6Z.js","./calcite-flow-item-M0Vz-xgS.js","./panel-B3delCVt.js","./action-menu-CBohuqGX.js","./array-DofFqflK.js","./action-DJPgY7YC.js","./popover-Cj0_nbSv.js","./floating-ui-BiOoil4s.js","./debounce-C5YDvsuO.js","./focusTrapComponent-C9GPb5g8.js","./Heading-Dn_ijr3J.js","./FloatingArrow-HmzV7w9c.js","./calcite-flow-CrhM5qTo.js","./calcite-list-C9DJsIWv.js","./resources4-CT6dxwoZ.js","./utils3-Dl40LrI3.js","./filter-BHzLPuAd.js","./input2-ChLBQj0V.js","./Validation-BBJwLSGg.js","./input-Dt5r39B0.js","./input-message-CKyGNFPw.js","./progress-B-8bmD6j.js"])))=>i.map(i=>d[i]);
import{_ as V}from"./index-CeCSsEgo.js";import{e as o,o as Et}from"./Evented-CXIxDjmW.js";import"./intl-Dpfm8vPB.js";import{S as ae,s as _e,x as Oe,z as We,Q as Yt,L as at,f as Fe,u as rt,y as Xt,am as wt,q as He,m as ei,g as ti,O as Re,j as ii}from"./Accessor-D6mNnsWy.js";import{y as l,b as O,k as I,E as X,a as ai,aH as ri,c as $,L as gt,aI as si,n as z,O as Ge}from"./subclass-BR3PhgZG.js";import{V as Ie,d as F,w as H,c as At,P as ie,A as we,C as ze,v as J,p as ge}from"./reactiveUtils-BFQ0BtrB.js";import{l as Te,a as oi}from"./isSupportedObject-B5Os5oYN.js";import{y as ni,I as li}from"./Attachments-CFH_3zPg.js";import{Y as $t,a as Wt,Z as di,n as ci,s as pi}from"./FeatureForm-BKpjqiF_.js";import{t as St,h as ui,o as hi,F as mi,m as fi}from"./FeatureTemplates-BP4Fbw9P.js";import{p as wi,h as gi}from"./Spinner-C5ZtDqJ2.js";import{r as re,n as h,f as Ne,u as st,T as yi,e as Le,B as vi}from"./jsxFactory-CbAu6VfF.js";import{h as Vt}from"./UpdatingHandles-CMtXpTiG.js";import ot from"./GraphicsLayer-D2NeCfd2.js";import{e as Be}from"./editableLayers-BHlaPs85.js";import{k as pe,c as _i,B as ki,O as bi,r as Mi,x as Fi}from"./layerUtils-erzwAANv.js";import{a0 as Ii}from"./assets-C2mb-ea2.js";import{l as Ci,k as Ot,I as Ei}from"./SnappingManager-GEHlVC1V.js";import{d as nt}from"./Graphic-Dc7F67nR.js";import{r as yt}from"./uuid-fwrPAdZb.js";import{e as Ai}from"./helpMessageUtils-M95XMmyR.js";import{_ as Tt}from"./InputManager-C4xu1R9l.js";import{e as Ue}from"./screenUtils-PfxkaaMN.js";import{d as $i}from"./diffUtils--7ofoPN-.js";import{j as Wi,I as Pt,_ as Lt}from"./fieldUtils-CNduWQU9.js";import{o as Si,r as Vi}from"./drapedUtils-CA19mSiA.js";import{m as Oi}from"./lengthUtils-D7_DvYH0.js";import{a as Ti,i as Pi}from"./sizeVariableUtils-Cmcuvw-4.js";import{getRotationAngle as Li,getSize as Ui}from"./visualVariableUtils-DzaXbn8H.js";import{g as xi}from"./jsonUtils-C6dvhNjw.js";import{L as qe}from"./symbolUtils-yAx-Kz88.js";import{e as Ut}from"./GraphicState-TgtLVp_Q.js";import{t as Di,s as xt}from"./hitTestSelectUtils-UXJPjatw.js";import{p as lt}from"./SketchViewModel-CtuH7-ky.js";import{s as vt}from"./Queue-DpHko4Yk.js";import{h as Dt}from"./HighlightHelper-BmkMLZFD.js";import{v as Hi}from"./elevationInfoUtils-Bl7QRRwv.js";import{n as Ri}from"./layerViewUtils-D2JqIDZ8.js";import{n as Gi,r as zi}from"./styleUtils-DQEZjdpw.js";import{K as Ni,J as Bi}from"./featureUtils-2Q65ejfE.js";import{G as xe,y as qi,x as ji,a3 as Zi}from"./Point-DB4Hp4hH.js";import{u as Ki,i as Qi}from"./infoFor3D-CxOdoily.js";import{l as Ji}from"./ViewingMode-Dodu7ZZk.js";import{z as Yi}from"./featureFormUtils-CZvTbSTn.js";import{s as dt,k as Xi,L as ea}from"./SnappingControls-B9h-34Wm.js";import{s as Se}from"./substitute-JuF-yP_g.js";import{e as je,n as Ce}from"./Heading-ynVMbJ8d.js";import{l as ta,m as ia,i as aa}from"./uploadAssetErrors-DCYJ56ch.js";import{e as _t}from"./globalCss-CZa70j6i.js";import{e as ra}from"./vmEvent-D4Ubqkbq.js";import"./Promise-CZrWwByK.js";import"./jsonMap-DCC6W5ex.js";import"./shared-B3wH2qpO.js";import"./SketchLabelOptions-10TdxHmI.js";import"./unitFormatUtils-DYi2eq8E.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./Cyclical-BY_I03kj.js";import"./mathUtils-ClvKsMak.js";import"./quantityUtils-d_-fFwhF.js";import"./AttachmentInfo-BoDg34HQ.js";import"./AttachmentQuery-Dn4NbT1Z.js";import"./writer-3zufXUNV.js";import"./legacyIcon-CtsJ0OTG.js";import"./compilerUtils-BA04t1lN.js";import"./FeatureLayerBase-CD91dIfN.js";import"./inputs-CnJRqwLx.js";import"./Field-C8SaaeoI.js";import"./enumeration--HlxOQ_N.js";import"./fieldType-CIG5ey7e.js";import"./PopupTemplate-ByHks6sq.js";import"./Clonable-cKbRam6-.js";import"./Color-DDUWtbqR.js";import"./colorUtils-CS9vdHXB.js";import"./ActionToggle-C0Z1k2jc.js";import"./Identifiable-BLvpQbOc.js";import"./formUtils-Dni92j4V.js";import"./layerContainerType-C5CzMsLd.js";import"./Extent-DHjqVB-p.js";import"./HeightModelInfo-CSXZysDz.js";import"./arcgisLayerUrl-Cgl5IQFD.js";import"./persistableUrlUtils-BcifXQ1Z.js";import"./commonProperties-C-F8Nu9F.js";import"./ElevationInfo-BxYXLfrw.js";import"./unitConversionUtils-Dl04YuQU.js";import"./opacityUtils-BT7mQkwC.js";import"./featureLayerUtils-CeNLEyq1.js";import"./symbols-CsUQ5BxR.js";import"./TextSymbol-gKE-H_J6.js";import"./materialUtils-CQ3JLQ1x.js";import"./aaBoundingBox-rJEWaOSN.js";import"./Polyline-D97hl-6E.js";import"./collectionUtils-Dm1icNvk.js";import"./Portal-liet8xHC.js";import"./featureQueryAll-CRo1-WqJ.js";import"./Query-Cx4awVKu.js";import"./geometry-DpwwkAX1.js";import"./TimeExtent-41gxTbrv.js";import"./timeUtils-DQR2jUPL.js";import"./jsonUtils-Cma_7A64.js";import"./DataLayerSource-6X35yXpo.js";import"./FullTextSearch-BNIhEccm.js";import"./SimpleRenderer-DvJZ7cyq.js";import"./UniqueValueRenderer-dci9bLM8.js";import"./colorRamps-CFlTi-ob.js";import"./SizeVariable-aYYWlweG.js";import"./ColorStop-CXfPDZon.js";import"./RelationshipQuery-kHvI2dm7.js";import"./LayerFloorInfo-BN2blBAm.js";import"./Relationship-WMN17mIX.js";import"./serviceCapabilitiesUtils-GL2GsHu0.js";import"./FieldInput-CcbqZWiP.js";import"./utils-BaQRRNPl.js";import"./Basemap-DhGpUWGY.js";import"./loadAll-DDw-urzS.js";import"./PortalItem-BuTU9OuN.js";import"./writeUtils-3wz9AuW7.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-ybYUU6jq.js";import"./arcade-BYKMypXa.js";import"./TimeOnly-cvONhzoK.js";import"./UnknownTimeZone-D0GlcniK.js";import"./ImmutableArray-BPVd6ESQ.js";import"./FeatureLayer-BCmfw45U.js";import"./ClassBreaksRenderer-DMO3d0Rn.js";import"./jsonUtils-CuoSmH2q.js";import"./LRUCache-ju6LnIBZ.js";import"./MemCache-C6WUx-5V.js";import"./Version-_Vxue7Ui.js";import"./FieldsIndex-IOXc-mnc.js";import"./OverrideHelper-C4oumxVn.js";import"./colorUtils-D5nOabzP.js";import"./vec42-B1mBkh1w.js";import"./vec4f64-CBQL1T0x.js";import"./utils-CO7DMJWl.js";import"./quantizationUtils-CIQDbQFJ.js";import"./HeatmapColorStop-CgvKf0-E.js";import"./heatmapUtils-C-uT6ZIV.js";import"./MultiOriginJSONSupport-DjAXzJun.js";import"./Layer-C96_yo4i.js";import"./workers-8Q6jrI18.js";import"./editsZScale-BMHD7K6h.js";import"./queryZScale-B_YkkRy9.js";import"./projection-A9yUaaTs.js";import"./projectBuffer-vsa0P_cF.js";import"./geodesicConstants-XRAvAZCD.js";import"./FeatureSet-DyOnd9Rj.js";import"./APIKeyMixin-DpJrW91V.js";import"./ArcGISService-Dr1J04Ka.js";import"./BlendLayer-DmvCcS5c.js";import"./jsonUtils-C4Wp5KpV.js";import"./parser-BN6zmHl-.js";import"./utils-D20M4_S8.js";import"./CustomParametersMixin-BStBpako.js";import"./EditBusLayer-C6pLlK14.js";import"./FeatureEffectLayer-B3ucpbgh.js";import"./FeatureEffect-BXMKpemG.js";import"./FeatureFilter-BzdN7b7E.js";import"./FeatureReductionLayer-7Q3CJbxJ.js";import"./FeatureReductionSelection-Do1LXJh7.js";import"./labelingInfo-C8CHVUWS.js";import"./labelUtils-Cczy0uDR.js";import"./defaults-DCm7iNI6.js";import"./defaultsJSON-GKolV7NZ.js";import"./MD5-C9MwAd2G.js";import"./OperationalLayer-B61mRSes.js";import"./OrderedLayer-CfmzojSk.js";import"./OrderByInfo-Bn0SWspE.js";import"./PortalLayer-iKUPhGZB.js";import"./portalItemUtils-DIZSrm3T.js";import"./RefreshableLayer-B26jSd3d.js";import"./ScaleRangeLayer-CKYXLXxK.js";import"./TemporalLayer-D6vkocFU.js";import"./TimeInterval-CjSB1odC.js";import"./TimeInfo-Cq5mDY2W.js";import"./FeatureTemplate-BOr53vUa.js";import"./FeatureType-ByEWGsln.js";import"./fieldProperties-DJEV41A1.js";import"./versionUtils-ByKR3-oH.js";import"./styleUtils-BATHgMyw.js";import"./TopFeaturesQuery-BBItvyOE.js";import"./popupUtils-fsHWupnf.js";import"./interfaces-CL2NbQte.js";import"./FeatureRelationshipViewModel-uplKJq_H.js";import"./ReactiveMap-Dl_3-Rm5.js";import"./ReactiveSet-HYC-4KEs.js";import"./AnchorElementViewModel-D6r9UeGZ.js";import"./GraphicsCollection-nEq2FD1R.js";import"./catalogUtils--o1nDhfl.js";import"./projectVectorToVector-Chzd0Pq0.js";import"./projectPointToVector-D3506wm2.js";import"./vec2-B_ymkwGp.js";import"./vec2f64-Diu2Kaa8.js";import"./geodesicUtils-iciHABcX.js";import"./plane-Bz78OrLf.js";import"./mat3f64-BBpwCtoL.js";import"./mat4f64-Dk4dwAN8.js";import"./quatf64-BrpT0VRp.js";import"./mathUtils-kvswLROa.js";import"./sphere-7666U3LO.js";import"./geometry2dUtils-BraNT6Fs.js";import"./floorFilterUtils-DZ5C6FQv.js";import"./keybindings-DYR2fa8r.js";import"./utils-CXgSw6Sd.js";import"./geodesicLengthMeasurementUtils-B9-VlVgL.js";import"./geometryEngine-BT1Ysmbs.js";import"./geometryEngineBase-RmbNeFm7.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./hydrated-DO_xxk1P.js";import"./signal-DzOfzcfh.js";import"./utils-C1cS-0Yj.js";import"./cimSymbolUtils-D00GIWna.js";import"./mat2df32-orApM5a3.js";import"./mat2d-DPkeMmgR.js";import"./webStyleSymbolUtils-BtUE3Q7L.js";import"./devEnvironmentUtils-D6qIi8Ky.js";import"./layerUtils-BS1Di3Pm.js";import"./screenUtils-BGG3AyYa.js";import"./directionModeIcons-Br5woIHu.js";import"./layerListUtils-CMiJTmu0.js";import"./LayerListViewModel-nCbo239i.js";import"./ListItem-B3QFVwaH.js";import"./widget-AQdZwE2X.js";const se="esri-editor",oe={base:se,helpMessage:`${se}__help-message`,updateActions:`${se}__update-actions`,updateActionsList:`${se}__update-actions-list`,featureTemplatesContainer:`${se}__feature-templates-container`,templateItemContentEnd:`${se}__template-item-content-end`};let N=class extends ae{constructor(t){super(t),this.creationInfo=null,this.editorItem=null,this.parent=null,this.pendingFeatures=new Ie,this.sketchOptions=null,this.snappingManager=null,this.viewModel=null,this.upload=null}};o([l()],N.prototype,"creationInfo",void 0),o([l()],N.prototype,"editorItem",void 0),o([l()],N.prototype,"parent",void 0),o([l({constructOnly:!0})],N.prototype,"sketchOptions",void 0),o([l()],N.prototype,"snappingManager",void 0),o([l()],N.prototype,"viewModel",void 0),o([l()],N.prototype,"upload",void 0),N=o([O("esri.widgets.Editor.CreateFeaturesWorkflowData")],N);function ct(e){const t=e.sourceLayer;if(!t||t.type!=="feature"||!da(t.renderer))return{rotation:null,size:null};let i=null,a=null;const r=t.renderer.getVisualVariablesForType("rotation").filter(n=>(!n.axis||n.axis==="heading")&&n.field&&!n.valueExpression&&Li(n,e)!=null);r.length===1&&(i=sa(r[0],t));const s=t.renderer.getVisualVariablesForType("size").filter(n=>n.field&&!n.useSymbolValue&&!n.valueExpression&&Ti(n)===Pi.RealWorldSize&&Ui(n,e)!=null);return s.length===1&&(a=la(s[0],t)),{rotation:i,size:a}}function sa(e,t){const i=(e.axis||"heading")==="heading"&&e.rotationType==="arithmetic"?-1:1,a=e.field,r=t.fields&&t.fields.filter(d=>d.name===a),s=r&&r.length===1?r[0].type:"double",n={initial:0,current:0};return{field:a,fieldType:s,getDefault:()=>Promise.resolve(0),getValue:d=>(n.current=n.initial-i*d,Ze((n.current+360)%360,s)),setInitialValue:d=>{n.initial=d,n.current=0},isUpdatingInteractively:!1,rotationType:e.rotationType??"geographic"}}function oa(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}async function na(e,t,i){if(t==null)return 0;const{symbol:a}=xi(t);if(a==null||a.type==="web-style"||a.type==="cim")return 0;const r=a.symbolLayers.at(0);if(!r)return 0;switch(r.type){case"icon":{const{computeIconLayerResourceSize:s}=await V(()=>import("./symbolLayerUtils-9ZRBOe8t.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33]),import.meta.url);return r.size||Math.min(Q.icon,(await s(r,Q.icon))[0])||Q.icon}case"text":return r.size||Q.text;case"line":return r.size||Q.line;case"object":{const{computeObjectLayerResourceSize:s}=await V(()=>import("./symbolLayerUtils-9ZRBOe8t.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33]),import.meta.url);return oa(await s(r,e.scale/Q.viewScaleSizeFactor),i)}case"path":return(r.width!=null?r.width:r.height)||e.scale/Q.viewScaleSizeFactor;case"extrude":return r.size||e.scale/Q.viewScaleSizeFactor;default:return 0}}function la(e,t){const i=e.field,a=e.axis,r=t.fields&&t.fields.filter(p=>p.name===i),s=r&&r.length===1?r[0].type:"double",n={initial:0,current:0},d=Oi[e.valueUnit]??1;let c;return c=e.valueRepresentation==="area"?p=>(p*d/2)**2*Math.PI:e.valueRepresentation==="radius"||e.valueRepresentation==="distance"?p=>p*d/2:p=>p*d,{field:i,fieldType:s,getDefault:async(p,u)=>Ze(c(await na(u,p,a)),s),getValue:(p,u)=>(n.initial||(n.initial=u.pixelSizeAt(u.center)),n.current=n.initial*p,Ze(n.current,s)),setInitialValue:p=>{n.initial=p,n.current=0},isUpdatingInteractively:!1,displayUnit:Fa(e.valueUnit),axis:e.axis}}function Ze(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function da(e){switch(e==null?void 0:e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}async function Z(e,t,i){const a=await qe(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:t,scale:i});$i(e.symbol,a)!=null&&(e.symbol=a)}function ca(e){if(!e)throw new Error("no geometry type");return e==="multipatch"?"mesh":e}async function pa(e,t,i){var u;const a=t.layer,r={...(u=t.template)==null?void 0:u.prototype.attributes,...t.attributeOverrides};let s=null;const{view:n}=e,d=(n==null?void 0:n.type)==="2d";if(await kt(e,a,r,i,d?n.scale:null),d){const m=Oe(f=>kt(e,a,r,i,f));s=F(()=>n.scale,f=>m(f))}const{data:c,editing:p}=a.capabilities;return e.layer.elevationInfo=a.elevationInfo,t.geometryToPlace==null?await e.create(ca(a.geometryType),{graphicProperties:{attributes:r,sourceLayer:a},hasZ:c.supportsZ,defaultZ:(d?p.zDefault:null)??e.defaultCreateOptions.defaultZ}):await e.place(t.geometryToPlace,{graphicProperties:{attributes:r,sourceLayer:a}}),s??I()}async function kt(e,t,i,a,r){const s=new nt({sourceLayer:t,attributes:i}),{rotation:n,size:d}=ct(s);let c=await qe(s,{useSourceLayer:!0,webStyleCache:a,scale:r}),p=!1;for(const u of[d,n])u!=null&&i[u.field]==null&&(i[u.field]=await u.getDefault(c,e.view),p=!0);switch(p&&(c=await qe(s,{useSourceLayer:!0,webStyleCache:a,scale:r})),c==null?void 0:c.type){case"simple-fill":case"polygon-3d":e.polygonSymbol=c;break;case"simple-line":case"line-3d":e.polylineSymbol=c;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":e.pointSymbol=c;break;case"mesh-3d":e.meshSymbol=c}Ht(e.tooltipOptions,d,n)}function Ht(e,t,i){e.visualVariables=t!=null||i!=null?{size:t!=null?{unit:t.displayUnit,axis:t.axis,valueType:t.fieldType}:null,rotation:i!=null?{valueType:i.fieldType,rotationType:i.rotationType??"geographic"}:null}:null}function ua(e,t){return e==null?void 0:e.find(i=>i.layer===t)}async function ha(e,t,i,a){switch(t.type){case"3d":return ma(e,t,i,a);case"2d":return fa(e,t,i,a)}}async function ma(e,t,i,a){if(e.length===0)return[];const{updatable:r,graphicsByLayer:s}=await i.async(async()=>{const{results:n}=await We(Di(t,i),a),d=new Map,c=u=>{const m=u.layer,f=d.get(m);if(!f){const y=new Array;return d.set(m,y),y}return f};xt(n).forEach(({graphic:u})=>c(u).push(u));const p=e.filter(({capabilities:u,layer:m})=>u.update.enabled&&d.has(m));return p.length!==0&&i.stopPropagation(),{updatable:p,graphicsByLayer:d}});return We(Promise.allSettled(r.map(async({layer:n})=>{const d=s.get(n),c=Rt(n);if(d.every(m=>Wi(c,m)))return d;const p=[];for(const m of d){p.push(m.getObjectId());const f=Object.keys(m.attributes);ri(c,f)}const u=n.createQuery();return u.returnGeometry=!1,u.objectIds=p,u.outFields=Pt(n.fieldsIndex,c),n.queryFeatures(u,{signal:a}).then(({features:m})=>m)})),a)}async function fa(e,t,i,a){if(e.length===0)return[];const{mapPoint:r}=i;if(r==null)return[];let s=null;const n=await i.async(async()=>{const{results:d}=await We(t.hitTest(i),a);if(d.length===0)return[];const c=new Set;s=xt(d),s.forEach(({graphic:u})=>u&&c.add(u.layer));const p=e.filter(u=>c.has(u.layer)&&u.supportsUpdateWorkflow);return p.length>0&&i.stopPropagation(),p});return We(Promise.allSettled(n.map(async({layer:d})=>{const c=d.createQuery();c.returnGeometry=!1,c.outFields=Rt(d);const p="renderer"in d?Si({renderer:d.renderer,pointerType:i.pointerType}):0;c.geometry=Vi(r,p,t),c.outSpatialReference=t.spatialReference;const{features:u}=await d.queryFeatures(c,{signal:a});return s==null||s.forEach(({graphic:m})=>{m.layer!==d||u.some(f=>f.getObjectId()===m.getObjectId())||u.push(m)}),u})),a)}function Rt(e){return Pt(e.fieldsIndex,[e.objectIdField,Lt({displayField:"displayField"in e?e.displayField:null,fields:e.fields})])}async function wa(e,t,i){const{sourceLayer:a}=e,r=a.createQuery();r.objectIds=[e.getAttribute(a.objectIdField)],r.outFields=["*"],r.returnM=a.capabilities.data.supportsM,r.returnZ=a.capabilities.data.supportsZ,a.type==="scene"&&a.infoFor3D!=null||(r.outSpatialReference=t);const s=await a.queryFeatures(r,{signal:i});return _e(i),s.features[0]}async function Ke(e){var u;const{graphic:t,sketchViewModel:i,sourceLayer:a,visualVariables:r,webStyleCache:s}=e;let n=!1;const{rotation:d,size:c}=r;if([d,c].forEach(async m=>{if(m==null)return;const f=t.getAttribute(m.field);if(f!=null)m.setInitialValue(f);else{const y=await m.getDefault(t.symbol,i.view);m.setInitialValue(y),t.setAttribute(m.field,y),n=!0}}),n){const m=((u=i.view)==null?void 0:u.type)==="2d"?i.view.scale:null;await Z(t,s,m)}const p={multipleSelectionEnabled:!1};return a.geometryType==="point"&&(p.enableRotation=d!=null,p.enableScaling=c!=null),Ht(i.tooltipOptions,c,d),i.layer.elevationInfo=a.elevationInfo,i.update(t,p)}function ga(e){return e==null||e.type!=="rotate-start"&&e.type!=="rotate"&&e.type!=="rotate-stop"?null:e}function ya(e){return e==null||e.type!=="scale-start"&&e.type!=="scale"&&e.type!=="scale-stop"?null:e}async function Gt(e,t,i,a,r){var p;if(t.geometry==null||((p=t.geometry)==null?void 0:p.type)!=="point")return;const s=a.rotation,n=ga(i.toolEventInfo);if(s!=null&&n!=null){const{field:u,getValue:m}=s;n.type==="rotate-stop"?(s.isUpdatingInteractively=!1,s.setInitialValue(t.getAttribute(u))):(s.isUpdatingInteractively=!0,t.setAttribute(u,m(n.angle,e)))}const d=a.size,c=ya(i.toolEventInfo);if(d!=null&&c!=null){const{field:u,getValue:m}=d;c.type==="scale-stop"?(d.isUpdatingInteractively=!1,d.setInitialValue(t.getAttribute(u))):(d.isUpdatingInteractively=!0,t.setAttribute(u,m(c.xScale,e)))}await Z(t,r,e.type==="2d"?e.scale:null)}async function va({feature:e,featureClone:t,visualVariableAttributes:i,sketchViewModel:a,view:r,onUpdate:s,webStyleCache:n}){var b;await Z(t,n,r.type==="2d"?r.scale:null);let d=null;if(((b=a==null?void 0:a.view)==null?void 0:b.type)==="2d"){const _=Oe(M=>Z(t,n,M));d=F(()=>{var M;return(M=a==null?void 0:a.view)==null?void 0:M.scale},M=>_(M))}const c=t.sourceLayer,p=he(r,c);await Ke({graphic:t,sketchViewModel:a,sourceLayer:c,visualVariables:i,webStyleCache:n});let u=null;p.then(_=>u=_).catch(()=>{});const m=i.size,f=i.rotation,y=F(()=>e.attributes,async _=>{let M=!1;for(const E in _){const U=_[E];U!==t.getAttribute(E)&&(t.setAttribute(E,U),m==null||m.isUpdatingInteractively||m.field!==E||m.setInitialValue(U),f==null||f.isUpdatingInteractively||f.field!==E||f.setInitialValue(U),(u==null||u.requiredFields.includes(E))&&(M=!0))}M&&await Z(t,n,r.type==="2d"?r.scale:null)}),w=a.on("update",async _=>{const M=_.graphics[0];if(_.state==="complete")return Ke({graphic:M,sketchViewModel:a,sourceLayer:c,visualVariables:i,webStyleCache:n});await Gt(r,M,_,i,n),s(Qe(M),_)}),g=a.on(["undo","redo"],async _=>{s(Qe(_.graphics[0]),_)});return X([g,w,I(()=>a.cancel()),y,d])}async function _a(e,t,i){const a=e.view;e.layer.add(i);const r=t.sourceLayer,s=t.layer,n=t.getAttribute(s.objectIdField);let d=null;function c(p){d==null||d.abort(),d=At(async u=>{var f;const m=await he(a,r);_e(u),(f=m.setVisibility)==null||f.call(m,n,p)})}return await ba(a,i),c(!1),X([ka(a,i,p=>c(!p)),I(async()=>{c(!0);try{const p=await he(a,r);await H(()=>!p.updating)}finally{e.layer.remove(i)}})])}function ka(e,t,i){if(e.type==="3d"){const a=new Ut({graphic:t});return X([e.trackGraphicState(a),F(()=>a.displaying,i)])}return F(()=>t.visible,i)}async function ba(e,t){if(e.type==="3d"){const i=new Ut({graphic:t}),a=e.trackGraphicState(i);await H(()=>i.displaying),a.remove()}else await H(()=>t.visible)}const Q={icon:Ue(24),text:Ue(12),line:Ue(1),viewScaleSizeFactor:100};function zt(e,t,i){let a=!1;return e.filter(r=>!!a||(a=r===t,a)).map(r=>i[r]())}function Ma(e,t){e.viewModel.syncFeatureTemplates();const i=e.creationInfo;if(t[0].id==="awaiting-feature-creation-info"&&i){const a=i.layer,r=St(a);r.length===1&&a.type!=="scene"&&(i.template=r[0],t.shift())}return t}function Fa(e){switch(e){case"unknown":case"decimal-degrees":return null;default:return e}}function Ia(e){e.filesEnabled=!0,e.mode="view",e.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}}const Nt=e=>/-stop/.test(e)||/vertex-/.test(e),he=(e,t)=>{const i=t.type==="subtype-sublayer"?t.parent:t;return e.whenLayerView(i)};function Ca(e){return"createInteractiveEditSession"in e}function Qe(e){var i;const t=e.geometry;if((t==null?void 0:t.type)==="mesh"){const a=e.cloneShallow();return a.attributes=ai(e.attributes),a.geometry=t.cloneShallow(),a.geometry.transform=((i=t.transform)==null?void 0:i.clone())??null,a}return e.clone()}function Je(e){const t=e.cursor;return e.cursor="progress",I(()=>e.cursor=t)}async function Ea({view:e,data:t,signal:i,next:a,cancel:r}){const{creationInfo:s}=t;if(!s)return I();if(!ye(s))return I();const{layer:n}=s,d=s.geometryToPlace!=null;if(s.geometryToPlace=null,d)return r(),I();const{Upload:c}=await V(()=>import("./Upload-C5L-qIWV.js"),__vite__mapDeps([34,5,6,4,29,30,12,13,14,3,1,2,35,36]),import.meta.url);_e(i);const p=new c;t.upload=p;let u=null;const m=()=>u==null?void 0:u.remove(),f=X([F(()=>p.state,y=>{switch(y){case"default":case"error":m();break;case"pending":m(),u=Je(e);break;case"success":s.maxFeatures=1,s.geometryToPlace=p.result,m(),a()}}),I(()=>{p.cancel(),m()})]);return p.uploadTo(n),f}function ye(e){const t=e==null?void 0:e.layer;return(t==null?void 0:t.type)==="scene"}let C=class extends Et.EventedAccessor{constructor(t){super(t),this._indexHistory=[],this._lastStepIndex=-1,this._stepIndex=-1,this._updatingHandles=new Vt,this._handleKeys={afterCommit:"after-commit",beforeCommit:"before-commit"},this.data=void 0,this.started=!1,this.steps=[],this.type=null,this._pendingOperation=null}destroy(){this._updatingHandles.destroy()}get hasNextStep(){const{steps:t}=this;return!!(t&&this._stepIndex<t.filter(i=>!i.parent).length-1)}get hasPreviousStep(){return this._stepIndex>0}get reliesOnOwnerAdminPrivileges(){return!1}get hasInvalidFormTemplate(){return!1}get shouldShowAttachments(){return!1}get shouldAllowAttachmentEditing(){return!1}get stepId(){const{steps:t}=this,i=t&&t[this._stepIndex];return i&&i.id}get helpMessage(){}get hasPendingEdits(){return!1}get keyboardCancellationEnabled(){return!0}get updating(){return this._updatingHandles.updating}async back(t=()=>Promise.resolve(!0)){this.hasPendingEdits&&!await t()||(this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0}))}async cancel(t={force:!0}){return t.force!==!1?this._cancel(t):new Promise((i,a)=>{this.emit("cancel-request",{controller:{allow:()=>{this._cancel({...t,force:!0}).then(i)},deny:()=>a(new $("workflow:cancel-denied","Request to cancel workflow was denied."))}})})}async commit(){this.removeHandles(this._handleKeys.beforeCommit),this.onCommit&&await this.onCommit(this.data),this.removeHandles(this._handleKeys.afterCommit),this.emit("commit")}async go(t){const{steps:i}=this,a=i.findIndex(r=>r.id===t);this._indexHistory.push(this._stepIndex),await this._go(a)}async next(){this._indexHistory.push(this._stepIndex),await this._go(this._stepIndex+1)}async previous(t={cancelCurrentStep:!1}){await this._go(this._indexHistory.pop(),t.cancelCurrentStep)}async reset(){await this._cancel({emitCancelEvent:!1}),await this.start()}async save(){await this.commit(),await this.reset()}async start(){this._set("started",!0);const t=this._stepIndex===-1?0:this._stepIndex;await this._go(t)}async _cancel({emitCancelEvent:t=!0,error:i}={}){this.started&&(this._set("started",!1),await this._transaction(()=>{var a;return(a=this.steps[this._stepIndex])==null?void 0:a.tearDown({canceled:!0})})),this.removeHandles([this._handleKeys.afterCommit,this._handleKeys.beforeCommit]),this._resetIndexing(t),t&&this.emit("cancel",{error:i})}_go(t=-1,i=!1){return this._transaction(async()=>{const{steps:a}=this;if(!(t<=-1||t>=a.length)){if(!this.started)return this._stepIndex=t,void this._notifyStepProps();this._lastStepIndex>-1&&await a[this._lastStepIndex].tearDown({canceled:i});try{await a[t].setUp()}catch(r){Yt(r)}this._lastStepIndex=t,this._stepIndex=t,this._notifyStepProps()}})}async _transaction(t){const i=this._pendingOperation,a=at(),r=(i??Promise.resolve()).then(()=>a.promise);this._pendingOperation=r,this._updatingHandles.addPromise(r);try{i&&await i,await t()}finally{a.resolve(),r===this._pendingOperation&&(this._pendingOperation=null)}}_resetIndexing(t=!0){this._stepIndex=-1,this._lastStepIndex=-1,this._indexHistory.length=0,t&&this._notifyStepProps()}_notifyStepProps(){this.notifyChange("stepId"),this.notifyChange("hasPreviousStep"),this.notifyChange("hasNextStep")}};o([l()],C.prototype,"data",void 0),o([l()],C.prototype,"hasNextStep",null),o([l()],C.prototype,"hasPreviousStep",null),o([l()],C.prototype,"onCommit",void 0),o([l()],C.prototype,"reliesOnOwnerAdminPrivileges",null),o([l()],C.prototype,"hasInvalidFormTemplate",null),o([l()],C.prototype,"shouldShowAttachments",null),o([l()],C.prototype,"shouldAllowAttachmentEditing",null),o([l()],C.prototype,"started",void 0),o([l({readOnly:!0})],C.prototype,"stepId",null),o([l()],C.prototype,"steps",void 0),o([l({readOnly:!0})],C.prototype,"type",void 0),o([l()],C.prototype,"helpMessage",null),o([l()],C.prototype,"hasPendingEdits",null),o([l()],C.prototype,"keyboardCancellationEnabled",null),o([l()],C.prototype,"updating",null),C=o([O("esri.widgets.Editor.Workflow")],C);const pt=C;var Ee;const De=Symbol(),ne=Symbol(),be=Symbol();let A=Ee=class extends pt{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this.data=void 0,this.isNested=!1,this._getDrawMeshHelpMessage=void 0,this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._featureFormViewModel=new $t,this._sketchViewModel=null,this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1,this._lastActiveGraphics=[],this._isActive=!0,this._updateGraphicDebounced=Oe((t,i,a)=>Z(t,i,a))}initialize(){this.isNested&&(this._isActive=!1),this._initializeSketchViewModel()}destroy(){this._sketchViewModel.destroy()}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){var s,n;if(this.numPendingFeatures>0)return!0;const{creationInfo:e,upload:t}=this.data,i=this._sketchViewModel,{activeComponent:a}=i,r=(n=(s=i.createGraphic)==null?void 0:s.geometry)==null?void 0:n.type;return!(r!=="polyline"&&r!=="polygon"&&r!=="multipoint"||(a==null?void 0:a.type)!=="draw-2d"&&(a==null?void 0:a.type)!=="draw-3d")&&a.drawOperation.committedVertices.length>0||!(!t||t.state!=="pending"&&t.state!=="success")||!!(e!=null&&e.geometryToPlace)}get helpMessage(){var r;const{creationInfo:e,viewModel:t}=this.data;if(this.stepId!=="creating-features"||!e)return;const i=e.layer.geometryType,a=this._sketchViewModel.createGraphic;if(i==="mesh"){this._getDrawMeshHelpMessage||V(()=>import("./helpMessageUtils3d-C5Z3FjL3.js"),__vite__mapDeps([37,12,5,6,4,13,14,3,1,2,9,38,39,40]),import.meta.url).then(n=>{this._getDrawMeshHelpMessage=n.getDrawMeshHelpMessage});const{view:s}=t;return(s==null?void 0:s.type)==="3d"?(r=this._getDrawMeshHelpMessage)==null?void 0:r.call(this,a,s):void 0}return Ai(i,a==null?void 0:a.geometry)}get layer(){var e;return(e=this.data.creationInfo)==null?void 0:e.layer}get numPendingFeatures(){return this.pendingFeatures.length}get parent(){return this.data.parent}get parentLayer(){var e;return(e=this.parent)==null?void 0:e.data.editorItem.layer}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return this.numPendingFeatures===0}get reliesOnOwnerAdminPrivileges(){var e;return((e=this.data.editorItem)==null?void 0:e.capabilities.create.reliesOnOwnerAdminPrivileges)??!1}get shouldShowAttachments(){var e;return((e=this.data.editorItem)==null?void 0:e.capabilities.create.attachments.enabled)??!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get sketchViewModel(){return this._sketchViewModel}get test(){}async enter(){this._isActive=!0,this.stepId!=="awaiting-feature-creation-info"&&this._setUpCreatingFeaturesStep()}exit(){this._isActive=!1,this.removeHandles([be])}async updatePendingFeature(e,t){return this._preventDefaultActionOnCancel=!0,this._sketchViewModel.cancel(),gt(this._lastActiveGraphics,e),this._startUpdating(e,t)}async start(){var e;return await super.start(),pe((e=this.data.creationInfo)==null?void 0:e.layer)?null:{enter:async()=>{},exit:async()=>{},viewModel:this._sketchViewModel}}static create(e){const{addAttachmentsCallback:t,applyEditsCallback:i,isNested:a,creationInfo:r,parent:s,snappingManager:n,startAt:d,viewModel:c}=e,p=e.sketchOptions??new Te,u=r==null?void 0:r.layer,m=u?c.findEditorItemForLayer(u):void 0,f=new Ee({data:new N({creationInfo:r,editorItem:m,parent:s,sketchOptions:p,snappingManager:n,viewModel:c}),isNested:a,onCommit:async y=>{var U;const{creationInfo:w}=y;if(!w)return;const g=y.pendingFeatures.toArray(),{layer:b}=w,_=((U=b.capabilities)==null?void 0:U.editing.supportsGlobalId)&&"globalIdField"in b,M=f._attachmentFileInfos;if(_){const K=Wa(g,b,M);return void await i(b,K,{globalIdUsed:!0})}const E=await i(b,{addFeatures:g});if(M.size>0){const K=(E==null?void 0:E.addFeatureResults)??[];await t(b,$a(g,K,b,M))}}});return f._set("steps",this._createWorkflowSteps(f,d)),f}_fadeExistingFeatures(e){if("effect"in e){const i=e.effect;return e.effect="saturate(0.6) opacity(0.8)",I(()=>e.effect=i)}const t=e.opacity;return e.opacity=.7,I(()=>e.opacity=t)}_highlight(e){const t=this.data.viewModel.view;(t==null?void 0:t.type)==="3d"&&this._highlightHandles.set(e,t.highlight(e))}_removeHighlight(e){Fe(this._highlightHandles.get(e)),this._highlightHandles.delete(e)}async _startCreating(e){this.removeHandles(ne);const{creationInfo:t}=this.data;if(!t)return;this.createFeatureState="create-new";const i=await pa(this._sketchViewModel,t,e);this.addHandles(i,ne)}async _startUpdating(e,t){var w;const{pendingFeatures:i}=this;i.includes(e)||i.add(e);const{_featureFormViewModel:a,_sketchViewModel:r}=this,{creationInfo:s,viewModel:n}=this.data,{attachmentsViewModel:d,layerInfos:c,view:p}=n;if(!p||!s)return;const u=s.layer,m=ua(c,u),f=m==null?void 0:m.formTemplate,y=p.spatialReference;if(a.set({arcadeEditType:"INSERT",feature:e,formTemplate:f,spatialReference:y,map:p.map}),d.mode!=="add"&&d.mode!=="edit"||((w=n.activeWorkflow)==null||w.previous()),d.graphic=e,d.fileInfos.removeAll(),d.mode="view",(this._attachmentFileInfos.get(e)||[]).forEach(({file:g,form:b})=>d.addFile(g,b)),this._removeHighlight(e),await Z(e,t,p.type==="2d"?p.scale:null),this.removeHandles(ne),Fe(this._featureFormHandle),p.type==="2d"){const g=F(()=>p.scale,b=>this._updateGraphicDebounced(e,t,b));this.addHandles(g,ne)}return this._featureFormHandle=X([a.on("value-change",async()=>{e.attributes=a.getValues(),await Z(e,t,p.type==="2d"?p.scale:null)}),r.on(["update","undo","redo"],g=>{(g.type==="undo"||g.type==="redo"||g.type==="update"&&g.toolEventInfo!=null&&Nt(g.toolEventInfo.type))&&a.notifyFeatureGeometryChanged()})]),this.createFeatureState="update-pending",this._visualVariableAttributes=ct(e),pe(u)?void 0:Ke({graphic:e,sketchViewModel:r,sourceLayer:u,visualVariables:this._visualVariableAttributes,webStyleCache:t})}static _createWorkflowSteps(e,t="awaiting-feature-creation-info"){const{data:i}=e,a=zt(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],t,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){const{creationInfo:r,viewModel:s}=i,{view:n}=s;n&&(ye(r)?e.addHandles(await Ea({view:n,data:i,next:()=>e.next(),cancel:()=>s.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(i.parent&&r&&(e.addHandles(s.lockFeatureTemplatesViewModel(),this.id),s.featureTemplatesViewModel.layers=[r.layer]),e.addHandles(s.featureTemplatesViewModel.on("select",({item:d})=>{d&&(i.creationInfo={...i.creationInfo,layer:d.layer,template:d.template},e.next())}),this.id)))},async tearDown(){e.removeHandles([this.id,ne])}}),"creating-features":()=>({id:"creating-features",async setUp(){e._isActive&&await e._setUpCreatingFeaturesStep()},async tearDown(r){const{viewModel:s}=i;r.canceled&&(e.removeHandles([be,De,ne]),s.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:r}=i.viewModel,{graphic:s,fileInfos:n}=r;e._attachmentFileInfos.set(s,n.toArray()),r.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:r}=i.viewModel,{graphic:s,fileInfos:n}=r;e._attachmentFileInfos.set(s,n.toArray()),r.mode="view"}})});return Ma(i,a)}static _configureSketchViewModel(e,t){const{data:i}=e,{creationInfo:a,viewModel:r}=i,{view:s}=r,n=e._sketchViewModel;let d=null;const c=[];if(!s)return I();s.type==="2d"&&a&&c.push(e._fadeExistingFeatures(a.layer));const p=async w=>{if(w.state==="cancel"){if(e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(e._lastActiveGraphics.length<1)return e._startCreating(t);const g=e._lastActiveGraphics.pop();return e._startUpdating(g,t)}if(w.state==="complete"&&w.graphic)return e._startUpdating(w.graphic,t)},u=async w=>{var mt;const{attachmentsViewModel:g}=r,{_featureFormViewModel:b}=e,_=w.graphics[0];if(w.state==="complete"){_!==d&&(e._lastActiveGraphics.push(_),e._highlight(_)),d=null;const{hasPendingSubtypeChoice:ee,submittable:ft}=b;if(e.numPendingFeatures===(a==null?void 0:a.maxFeatures)||ee||!ft){!ft&&b.submit();const Pe=e._lastActiveGraphics.pop();return e._startUpdating(Pe,t)}if(g.mode!=="add"&&g.mode!=="edit"||((mt=r.activeWorkflow)==null||mt.previous()),w.aborted&&e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);e.addHandles([Je(s),s.on("click",Pe=>Pe.preventDefault())],De),await H(()=>!b.updating),e.removeHandles(De),e._startCreating(t)}w.state==="start"&&e._removeHighlight(_);const M=e._visualVariableAttributes;await Gt(s,_,w,M,t);const E=_.attributes,{rotation:U,size:K}=M;if(U!=null){const{field:ee}=U;b.setValue(ee,E[ee])}if(K!=null){const{field:ee}=K;b.setValue(ee,E[ee])}},m=w=>{const g=w.graphics[0];e.pendingFeatures.remove(g),gt(e._lastActiveGraphics,g),d=g},f=async w=>{if(ye(a))return;const{results:g}=await s.hitTest(w,{include:n.layer}),b=g.find(M=>M.type==="graphic"&&M.graphic.sourceLayer===(a==null?void 0:a.layer));if(!b)return;const _=b.graphic;if(n.activeTool==="transform"||n.activeTool==="reshape"){if(n.updateGraphics.at(0)===_)return;const{submittable:M,hasPendingSubtypeChoice:E}=e._featureFormViewModel;if(!M||E)return;await e.updatePendingFeature(_,t)}};c.push(n.on("create",w=>e._updatingHandles.addPromise(p(w))),n.on("update",w=>e._updatingHandles.addPromise(u(w))),n.on("delete",w=>m(w)),s.on("immediate-click",w=>e._updatingHandles.addPromise(f(w)),Tt.TOOL),I(()=>{e._preventDefaultActionOnCancel=!0,n.cancel()}),Aa(n,i));const y=X(c);return n.addHandles(y),y}_initializeSketchViewModel(){var r;const{data:e}=this,{view:t}=e.viewModel,i=new ot({elevationInfo:(r=e.creationInfo)==null?void 0:r.layer.elevationInfo,internal:!0,listMode:"hide"}),a=new lt({layer:i,sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,view:t});this._sketchViewModel=a,t==null||t.map.add(i),this.addHandles(I(()=>{t!=null&&t.destroyed||(t==null||t.map.remove(i)),i.destroy()}))}async _setUpCreatingFeaturesStep(){var w;if(this.hasHandles(be))return;const{creationInfo:e,viewModel:t}=this.data,{attachmentsViewModel:i,view:a}=t;if(!a||!(e!=null&&e.layer))throw new $("missing-parameters","CreateFeaturesWorkflow requires a view and creationInfo.");const{initialFeature:r,layer:s}=e,n=this._sketchViewModel,d=new Map,c=[];this._lastActiveGraphics=[],this._featureFormHandle=Fe(this._featureFormHandle),this._visualVariableAttributes={rotation:null,size:null},this.data.editorItem=t.findEditorItemForLayer(e.layer),Ia(i),c.push(F(()=>i.mode,g=>{switch(g){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}));const p=Je(a);c.push(p);const u=pe(e.layer);try{if(u){const g=r??new nt({attributes:{...(w=e.template)==null?void 0:w.prototype.attributes,...e.attributeOverrides},sourceLayer:s});await this._startUpdating(g,d)}else c.push(Ee._configureSketchViewModel(this,d)),r?(n.layer.add(r),await this._startUpdating(r,d)):await this._startCreating(d)}finally{p.remove()}const m=I(()=>this.pendingFeatures.drain(g=>n.layer.remove(g))),f=F(()=>a==null?void 0:a.timeZone,g=>this._featureFormViewModel.timeZone=g,ie),y=I(()=>{ye(e)&&t.cancelWorkflow({warnIfNoWorkflow:!1})});this._featureFormHandle&&c.push(this._featureFormHandle),this.addHandles(c,this._handleKeys.beforeCommit),this.addHandles([I(()=>i.fileInfos.removeAll()),X(c),y,m,f],be)}};function Aa(e,t){let i=null;const a=()=>e.snappingOptions.featureSources,r=()=>(i=new Ci({layer:e.layer}),a().add(i),i),s=()=>{i!=null&&(a().remove(i),i=rt(i))};return X([F(()=>{var c;const n=(c=t.creationInfo)==null?void 0:c.layer,d=a().find(p=>p.layer===n);return{hasFeatureLayerSource:!!d,enabled:(d==null?void 0:d.enabled)??!1}},({hasFeatureLayerSource:n,enabled:d})=>{if(!n)return s();i??(i=r()),i.enabled=d},we),I(s)])}function $a(e,t,i,a){const r=[];return t.forEach((s,n)=>{if(!s.error){const d=e[n],c=a.get(d)||[];d.attributes[i.objectIdField]=s.objectId,c.forEach(({form:p})=>r.push({feature:d,attachment:p}))}}),r}function Wa(e,t,i){const a=[],r=t.globalIdField;return e.forEach((s,n)=>{var d;(d=e[n].attributes)[r]??(d[r]=yt()),((i==null?void 0:i.get(s))||[]).forEach(({file:c})=>a.push({feature:s,attachment:{globalId:yt(),data:c}}))}),a.length?{addFeatures:e,addAttachments:a}:{addFeatures:e}}o([l()],A.prototype,"createFeatureState",void 0),o([l()],A.prototype,"data",void 0),o([l({constructOnly:!0})],A.prototype,"isNested",void 0),o([l()],A.prototype,"featureFormViewModel",null),o([l()],A.prototype,"hasPendingEdits",null),o([l()],A.prototype,"_getDrawMeshHelpMessage",void 0),o([l()],A.prototype,"helpMessage",null),o([l()],A.prototype,"layer",null),o([l()],A.prototype,"parent",null),o([l()],A.prototype,"parentLayer",null),o([l()],A.prototype,"keyboardCancellationEnabled",null),o([l()],A.prototype,"reliesOnOwnerAdminPrivileges",null),o([l()],A.prototype,"shouldShowAttachments",null),o([l()],A.prototype,"shouldAllowAttachmentEditing",null),o([l()],A.prototype,"sketchViewModel",null),A=Ee=o([O("esri.widgets.Editor.CreateFeaturesWorkflow")],A);const Bt=A;function bt(e){return e==null?null:JSON.stringify(e)}let j=class extends ae{constructor(t){super(t),this._stagedForDelete=!1,this.feature=null,this.initialFeature=null}get attributesModified(){return this._stringifyAttributes(this.feature)!==this._stringifyAttributes(this.initialFeature)}get geometryModified(){return this._stringifyGeometry(this.feature)!==this._stringifyGeometry(this.initialFeature)}get stagedForDelete(){return this._stagedForDelete}get modified(){return this.attributesModified||this.geometryModified||this._stagedForDelete}stageDelete(){this._stagedForDelete=!0}unstageDelete(){this._stagedForDelete=!1}trackChanges(){var t;this.initialFeature=(t=this.feature)==null?void 0:t.clone()}updateAttributes(t){const{feature:i}=this;i&&(i.attributes=t,this.notifyChange("attributesModified"))}updateGeometry(t){const{feature:i}=this;i&&(i.geometry=t,this.notifyChange("geometryModified"))}_stringifyAttributes(t){return bt(t==null?void 0:t.attributes)}_stringifyGeometry(t){const i=t==null?void 0:t.geometry;return bt((i==null?void 0:i.type)==="mesh"?{transform:i.transform,vertexSpace:i.vertexSpace}:i)}};o([l()],j.prototype,"_stagedForDelete",void 0),o([l()],j.prototype,"attributesModified",null),o([l()],j.prototype,"feature",void 0),o([l()],j.prototype,"geometryModified",null),o([l()],j.prototype,"initialFeature",void 0),o([l()],j.prototype,"modified",null),j=o([O("esri.widgets.Editor.Edits")],j);var Ae;let B=Ae=class extends ae{constructor(e){super(e),this.editorItem=null,this.edits=null,this.parent=null,this.relatedRecordCallbacks=null,this.viewModel=null}get attachmentsCapabilities(){const e=this.editorItem.capabilities.update.attachments.enabled;return{editing:!0,operations:{add:e,update:e,delete:e}}}get formTemplate(){return this.editorItem.formTemplate}static async create(e){const t=Ae._makeConstructorProps(e);return new Ae(t)}static _makeConstructorProps(e){const{feature:t,parent:i,relatedRecordCallbacks:a,viewModel:r}=e,s=r.editorItems.find(n=>n.layer===t.layer);if(!s)throw new $("no-editorItem-found","The EditorViewModel provided did not have an EditorItem associated with the specified Graphic's layer");return{editorItem:s,edits:new j({feature:t}),parent:i,relatedRecordCallbacks:a,viewModel:r}}};o([l()],B.prototype,"attachmentsCapabilities",null),o([l({constructOnly:!0})],B.prototype,"editorItem",void 0),o([l()],B.prototype,"edits",void 0),o([l()],B.prototype,"formTemplate",null),o([l()],B.prototype,"parent",void 0),o([l()],B.prototype,"relatedRecordCallbacks",void 0),o([l()],B.prototype,"viewModel",void 0),B=Ae=o([O("esri.widgets.Editor.UpdateRecordWorkflowData")],B);const qt=B;var $e;let de=$e=class extends qt{constructor(e){super(e),this.sketchOptions=null,this.snappingManager=null}static async create(e){const{feature:t,snappingManager:i,viewModel:a}=e,r=e.sketchOptions??new Te,{view:s}=a;if(!s)throw new $("editor:cannot-create-workflow-data","The provided EditorViewModel does not have an associated view");const n=await he(s,t.layer);return new $e({...$e._makeConstructorProps(e),layerView:n,sketchOptions:r,snappingManager:i})}};o([l()],de.prototype,"layerView",void 0),o([l({constructOnly:!0})],de.prototype,"sketchOptions",void 0),o([l()],de.prototype,"snappingManager",void 0),de=$e=o([O("esri.widgets.Editor.UpdateFeatureWorkflowData")],de);const Sa=de;var Ye;const Xe={exit:Symbol()};let T=Ye=class extends pt{constructor(e){super(e),this._highlightHelper=null,this.fullFeature=null,this.type="update-table-record"}initialize(){const{data:e}=this,{edits:t}=e,{view:i}=e.viewModel,a=t.feature,r=new AbortController;this.addHandles(si(r)),this._updatingHandles.addPromise(wa(a,e.viewModel.view.spatialReference,r.signal).then(s=>{Xt(r)||(this._onFullFeatureLoaded(s),this._initializeFeatureFormViewModel())},s=>this.cancel({force:!0,error:new $("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:s}})}))),i&&(this._highlightHelper=new Dt({view:i}),this.addHandles(I(()=>{var s;return(s=this._highlightHelper)==null?void 0:s.removeAll()})))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){return this.data.edits.modified}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){var e;return(e=this.parent)==null?void 0:e.data.editorItem.layer}get shouldShowAttachments(){return this.editorItem.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return this.editorItem.capabilities.update.attachments.enabled}get reliesOnOwnerAdminPrivileges(){const e=this.editorItem.capabilities;return e.update.reliesOnOwnerAdminPrivileges||e.delete.reliesOnOwnerAdminPrivileges}async deleteAndCommit(){return this.data.edits.stageDelete(),this.commit()}async enter(){this._configureAttachmentsViewModel()}exit(e){this.removeHandles(Xe.exit)}async start(){return await super.start(),null}_configureAttachmentsViewModel(){const{data:e,fullFeature:t}=this,{attachmentsCapabilities:i,viewModel:a}=e,{attachmentsViewModel:r}=a;r.set({capabilities:i,graphic:t,filesEnabled:!1,mode:"view"}),this.addHandles([I(()=>r.fileInfos.removeAll()),F(()=>r.mode,s=>{switch(s){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}})],Xe.exit)}_initializeFeatureFormViewModel(){const{edits:e,formTemplate:t,viewModel:{view:i}}=this.data,a=this._featureFormViewModel=new $t({arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:t,highlightHelper:this._highlightHelper,map:i==null?void 0:i.map,spatialReference:i.spatialReference,timeZone:i==null?void 0:i.timeZone});a.relatedRecordCallbacks={...this.data.relatedRecordCallbacks,showAllRelatedRecords:s=>a.relationshipId=s.relationshipId};const{initialFeature:r}=e;r&&a.overrideInitialFeature(r),this.addHandles([a.on("value-change",()=>{e.updateAttributes(a.getValues()),this.fullFeature.attributes=e.feature.attributes}),F(()=>i==null?void 0:i.timeZone,s=>a.timeZone=s)])}_onFullFeatureLoaded(e){this.fullFeature=e;const{edits:t}=this.data;t.updateAttributes(e.attributes),t.trackChanges()}static async create(e){const t=new Ye({data:await qt.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t}static _createWorkflowSteps(e){const{attachmentsViewModel:t}=e.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){t.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){t.mode="view"}}]}};T._onCommitFactory=e=>async t=>{var d;const{edits:i}=t,{feature:a}=i;if(!a)return;const r=a.sourceLayer,s=a.clone();if(!i.attributesModified||i.stagedForDelete){const c=r.objectIdField;if(s.attributes={[c]:a.getAttribute(c)},Gi()&&zi()&&r.type==="scene"&&r.infoFor3D!=null){const p=(d=r.associatedLayer)==null?void 0:d.globalIdField;p!=null&&s.setAttribute(p,a.getAttribute(p))}}i.geometryModified&&!i.stagedForDelete||(s.geometry=null);const n=i.stagedForDelete?"deleteFeatures":"updateFeatures";await e(r,{[n]:[s]})},o([l()],T.prototype,"editorItem",null),o([l()],T.prototype,"featureFormViewModel",null),o([l()],T.prototype,"fullFeature",void 0),o([l()],T.prototype,"hasPendingEdits",null),o([l()],T.prototype,"layer",null),o([l()],T.prototype,"parent",null),o([l()],T.prototype,"parentLayer",null),o([l()],T.prototype,"shouldShowAttachments",null),o([l()],T.prototype,"shouldAllowAttachmentEditing",null),o([l()],T.prototype,"reliesOnOwnerAdminPrivileges",null),T=Ye=o([O("esri.widgets.Editor.UpdateRecordWorkflow")],T);var et;const G={...Xe,highlights:Symbol(),sketchGraphics:Symbol(),sketchViewModel:Symbol()};let ce=et=class extends T{constructor(e){super(e),this.type="update-feature",this._layerViewEditSession=null,this._sketchGraphicClone=null,this._sketchViewModel=null,this._webStyleCache=new Map}destroy(){var e;(e=this._layerViewEditSession)==null||e.rollback()}async commit(){this.removeHandles(G.sketchGraphics);try{const e=this.data.edits.stagedForDelete;await super.commit();const t=this._layerViewEditSession;e?t==null||t.rollback():t==null||t.commit()}catch(e){throw await this._configureSketchViewModel(),new $("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:e})}}async start(){return await super.start(),await this._initializeSketchViewModel()}_initializeFeatureFormViewModel(){super._initializeFeatureFormViewModel(),this.addHandles(this._featureFormViewModel.on("value-change",e=>{var t;(t=this._layerViewEditSession)==null||t.setAttribute(e.fieldName,e.value)}))}_configureHighlight(){const{edits:e,layerView:t}=this.data;Ri(t)&&this.addHandles(t.highlight(e.feature),G.highlights)}async _configureSketchViewModel(){const e=this._sketchViewModel;if(!e)return;const{data:t,_featureFormViewModel:i,_sketchGraphicClone:a}=this,{edits:r,viewModel:s}=t,n=r.feature,{view:d}=s,c=ct(n),p=await va({feature:n,featureClone:a,visualVariableAttributes:c,sketchViewModel:e,view:d,onUpdate:({geometry:u,attributes:m},f)=>{if(r.updateAttributes(m),r.updateGeometry(u),i.feature.geometry=u,c.rotation!=null){const{field:y}=c.rotation;i.setValue(y,m[y])}if(c.size!=null){const{field:y}=c.size;i.setValue(y,m[y])}(f.type==="undo"||f.type==="redo"||f.type==="update"&&f.toolEventInfo!=null&&Nt(f.toolEventInfo.type))&&i.notifyFeatureGeometryChanged()},webStyleCache:this._webStyleCache});this.addHandles(p,G.sketchGraphics),e.addHandles(p)}async _initializeSketchViewModel(){const{data:e,_sketchGraphicClone:t}=this,i=e.edits.feature,{capabilities:a,layer:r}=e.editorItem,{view:s}=e.viewModel;if(this.removeHandles([G.highlights,G.sketchGraphics,G.sketchViewModel]),!a.update.geometry||(s==null?void 0:s.type)==="3d"&&Hi(r.elevationInfo))return{enter:async()=>{this.hasHandles(G.highlights)||this._configureHighlight()},exit:()=>this.removeHandles([G.highlights])};const n=new ot({elevationInfo:r.elevationInfo,internal:!0,listMode:"hide"}),d=new lt({allowDeleteKey:!1,layer:n,sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,view:s});return this._sketchViewModel=d,s==null||s.map.add(n),this.addHandles(I(()=>{s!=null&&s.destroyed||(s==null||s.map.remove(n)),n.destroy(),this._sketchViewModel=rt(d)}),G.sketchViewModel),await Z(t,this._webStyleCache,(s==null?void 0:s.type)==="2d"?s.scale:null),this.addHandles([await _a(d,i,t)]),{enter:async()=>{this.hasHandles(G.sketchGraphics)||await this._configureSketchViewModel()},exit:()=>this.removeHandles([G.sketchGraphics]),viewModel:d}}_onFullFeatureLoaded(e){super._onFullFeatureLoaded(e);const t=this._sketchGraphicClone=Qe(e),{edits:i,layerView:a}=this.data;i.updateGeometry(e.geometry),i.trackChanges(),Ca(a)&&(this._layerViewEditSession=a.createInteractiveEditSession(t))}static async create(e){const t=new et({data:await Sa.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t}get test(){}};o([l()],ce.prototype,"_layerViewEditSession",void 0),o([l()],ce.prototype,"_sketchGraphicClone",void 0),o([l()],ce.prototype,"_sketchViewModel",void 0),ce=et=o([O("esri.widgets.Editor.UpdateFeatureWorkflow")],ce);let q=class extends ae{constructor(t){super(t),this.addAttachmentsCallback=null,this.applyEditsCallback=null,this.candidates=null,this.rootFeature=null,this.sketchOptions=null,this.snappingManager=null,this.viewModel=null}};o([l()],q.prototype,"addAttachmentsCallback",void 0),o([l()],q.prototype,"applyEditsCallback",void 0),o([l()],q.prototype,"candidates",void 0),o([l()],q.prototype,"rootFeature",void 0),o([l({constructOnly:!0})],q.prototype,"sketchOptions",void 0),o([l()],q.prototype,"snappingManager",void 0),o([l()],q.prototype,"viewModel",void 0),q=o([O("esri.widgets.Editor.UpdateWorkflowData")],q);const Va=q;var tt;const jt="esri.widgets.Editor.UpdateWorkflow",Oa=()=>z.getLogger(jt);let W=tt=class extends pt{constructor(e){super(e),this._workflowStack=new vt(wt),this._sketchStack=new vt(wt),this.data=void 0,this.type="update"}get activeEditorItem(){var e;return((e=this.activeWorkflow)==null?void 0:e.data.editorItem)??void 0}get activeFeatureFormViewModel(){var e;return(e=this.activeWorkflow)==null?void 0:e.featureFormViewModel}get activeSketchViewModel(){var e;return(e=this._sketchStack.peek())==null?void 0:e.viewModel}get activeWorkflow(){return this._workflowStack.last()}get hasUpdatableCandidates(){const{candidates:e,viewModel:t}=this.data;return e.some(({layer:i})=>{var a;return(a=t.findEditorItemForLayer(i))==null?void 0:a.supportsUpdateWorkflow})}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){var e;return!!((e=this.activeEditorItem)!=null&&e.capabilities.attachments.enabled)}get shouldAllowAttachmentEditing(){var e;return!!((e=this.activeEditorItem)!=null&&e.capabilities.update.attachments.enabled)}get hasPendingEdits(){return Array.from(this._workflowStack).some(e=>e.hasPendingEdits)}get helpMessage(){var e;return(e=this.activeWorkflow)!=null&&e.helpMessage?this.activeWorkflow.helpMessage:this.stepId==="awaiting-feature-to-update"?"select":void 0}get reliesOnOwnerAdminPrivileges(){var e;return((e=this.activeWorkflow)==null?void 0:e.reliesOnOwnerAdminPrivileges)??!1}get hasInvalidFormTemplate(){var e;return!!((e=this.activeEditorItem)!=null&&e.hasInvalidFormTemplate)}async back(e=()=>Promise.resolve(!0)){const{activeWorkflow:t}=this;if((t==null?void 0:t.featureFormViewModel.relationshipId)==null)if(t){if(t.hasPendingEdits&&!await e())return;t.hasPreviousStep?await t.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0});else t.featureFormViewModel.relationshipId=null}async cancelActiveWorkflow(e){var t;await((t=this.activeWorkflow)==null?void 0:t.cancel(e)),await this._popWorkflow()}async commit(){await this._drainWorkflowStack(e=>e.commit()),await super.commit()}static create(e){const{viewModel:t,snappingManager:i,startAt:a,addAttachmentsCallback:r,applyEditsCallback:s}=e,n=e.sketchOptions??new Te,d=new tt({data:new Va({addAttachmentsCallback:r,applyEditsCallback:s,sketchOptions:n,snappingManager:i,viewModel:t}),onCommit:async()=>{}});return d._set("steps",this._createWorkflowSteps(d,a)),d}async save(){var e;this.nestedWorkflowCount>1?(await((e=this.activeWorkflow)==null?void 0:e.commit()),await this._popWorkflow()):await this.commit()}async startCreatingRelatedRecord(e){try{const t=await this._createNestedCreateFeaturesWorkflow(e);await this._pushWorkflow(t)}catch(t){throw new $("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:t})}}async startUpdating(e){try{const t=await this._createNestedUpdateWorkflow(e);await this._pushWorkflow(t)}catch(t){throw new $("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:t})}}async deleteActiveFeature(){const{activeWorkflow:e}=this;if(!e)throw new $("editor:nothing-to-delete","There is no feature to delete");Ta(e)?await e.deleteAndCommit():await e.cancel(),this.nestedWorkflowCount===1?await this.reset():await this._popWorkflow()}async cancelAll(){await this._drainWorkflowStack(e=>e.cancel({force:!0}))}async _createNestedCreateFeaturesWorkflow(e){var u;const{relatedLayer:t}=e,{addAttachmentsCallback:i,applyEditsCallback:a,sketchOptions:r,snappingManager:s,viewModel:n}=this.data;if(!Be(t))throw new $("editor:unsupported-layer","Editing is not supported on the provided layer");const d=this._getCreationInfoForNestedCreateFeaturesWorkflow(e),c=d.template||d.initialFeature?"creating-features":"awaiting-feature-creation-info",p=((u=this.activeWorkflow)==null?void 0:u.type)!=="create-features"?this.activeWorkflow:void 0;return Bt.create({addAttachmentsCallback:i,applyEditsCallback:a,creationInfo:d,isNested:!0,parent:p,sketchOptions:r,snappingManager:s,startAt:c,viewModel:n})}_getCreationInfoForNestedCreateFeaturesWorkflow(e){const{relatedLayer:t}=e;if(!Be(t)||_i(t))throw new $("editor:unsupported-layer","Editing is not supported on the provided layer");const i={layer:t,maxFeatures:1},a=this._makeRelatedRecordAttributes(e),r=St(t);return(r==null?void 0:r.length)>0?(i.attributeOverrides=a,r.length===1&&(i.template=r[0])):i.initialFeature=new nt({sourceLayer:t,attributes:a}),i}async _createNestedUpdateWorkflow(e){var c;const t=pe(e.sourceLayer)?T:ce,{applyEditsCallback:i,sketchOptions:a,snappingManager:r,viewModel:s}=this.data,n=((c=this.activeWorkflow)==null?void 0:c.type)!=="create-features"?this.activeWorkflow:void 0,d=await t.create({feature:e,parent:n,sketchOptions:a,snappingManager:r,viewModel:s,applyEdits:i,relatedRecordCallbacks:{addRelatedRecord:async p=>await this.startCreatingRelatedRecord(p),editRelatedRecord:async({relatedFeature:p})=>await this.startUpdating(p)}});return await H(()=>!d.updating),d}async _drainWorkflowStack(e){const t=this._workflowStack,i=[];for(;t.length>0;){const a=t.pop();this._sketchStack.pop();const r=e(a).then(()=>a.destroy());this._updatingHandles.addPromise(r),i.push(r)}await Promise.all(i)}_makeRelatedRecordAttributes(e){var c,p;const{parentFeature:t,relatedLayer:i,relationshipId:a}=e;if(!Ni(t))return;const r=(c=i.relationships)==null?void 0:c.find(u=>u.id===a);if(!r)return void me("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if(r.role==="origin")return void me("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");const s=t.sourceLayer;r.relatedTableId!==s.layerId&&me("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");const n=(p=s.relationships)==null?void 0:p.find(u=>u.id===a);if(!n)return void me("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");const d=t.getAttribute(n.keyField);return d||me("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field."),{[r.keyField]:d}}async _popWorkflow(){var t;(t=this._workflowStack.pop())==null||t.destroy(),this._sketchStack.pop();const e=await this._reconcileWorkflowStack();if(e.failureCount>0)throw new $("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",e)}async _pushWorkflow(e){var n;const t=this._workflowRequiresSketchViewModel(e);(n=this.activeWorkflow)==null||n.exit({removeSketchHandles:t});const i=this._sketchStack,a=await(e==null?void 0:e.start()),r=i.peek();a?(r==null||r.exit(),i.push(a)):i.push(this._cloneSketchController(r)),this._workflowStack.push(e);const s=await this._reconcileWorkflowStack();if(s.failureCount>0)throw new $("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",s)}async _reconcileWorkflowStack(){var i;const e=this._workflowStack,t=this._sketchStack;try{const a=e.peek();return await(a==null?void 0:a.enter()),await((i=t.peek())==null?void 0:i.enter()),{activeWorkflow:a,failureCount:0}}catch{e.pop().destroy(),t.pop();const{activeWorkflow:r,failureCount:s}=await this._reconcileWorkflowStack();return{activeWorkflow:r,failureCount:s+1}}}_cloneSketchController(e){return{enter:(e==null?void 0:e.enter)??(async()=>{}),exit:(e==null?void 0:e.exit)??(async()=>{}),viewModel:e==null?void 0:e.viewModel}}_workflowRequiresSketchViewModel(e){var i;const{type:t}=e;return t==="update-feature"||t==="create-features"&&!pe((i=e.data.creationInfo)==null?void 0:i.layer)}static _createWorkflowSteps(e,t="awaiting-feature-to-update"){const{data:i}=e;return zt(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],t,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:a}=i.viewModel,r=i.viewModel.view;let s=null;e.addHandles(I(()=>{s=He(s)}),this.id),i.rootFeature=null,i.candidates=[];const n=r.on("immediate-click",async d=>{a.location=d.mapPoint,a.visible=!0,s==null||s.abort();const{editorItems:c}=i.viewModel;s=new AbortController;const p=await d.async(()=>new Promise((u,m)=>{ei(s==null?void 0:s.signal,()=>m(ti())),u(ha(c,r,d,s==null?void 0:s.signal))}));_e(s),i.candidates=p.filter(u=>u.status==="fulfilled").flatMap(u=>u.value).filter(u=>!u.isAggregate),a.visible=i.candidates.length===1,i.candidates.length!==0&&(d.stopPropagation(),i.candidates.length===1?(i.rootFeature=i.candidates[0],e.go("editing-existing-feature").catch(()=>{}).then(()=>a.visible=!1)):e.next())},Tt.TOOL);r.focus(),e.addHandles(n,this.id)},async tearDown(){i.candidates.length===0&&(i.viewModel.spinnerViewModel.visible=!1),e.removeHandles(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){i.rootFeature=null;const{view:a}=i.viewModel;if(!a)return;const r=new Dt({view:a});e.addHandles([F(()=>i.rootFeature,(s,n)=>{r.remove(n),r.add(s)},ze),I(()=>r.removeAll())],this.id)},async tearDown(){e.removeHandles(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const{rootFeature:a,viewModel:r}=e.data;if(!a)throw new $("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await e.startUpdating(a),r.spinnerViewModel.visible=!1;const s=Oe(async()=>{await H(()=>!e.updating),e.previous()});e.addHandles([F(()=>e.nestedWorkflowCount,(n,d)=>{n===0&&d!==0&&s()},ze)],this.id)},async tearDown(){await e.cancelAll(),e.removeHandles(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}})})}};o([l()],W.prototype,"activeEditorItem",null),o([l()],W.prototype,"activeFeatureFormViewModel",null),o([l()],W.prototype,"activeSketchViewModel",null),o([l()],W.prototype,"activeWorkflow",null),o([l()],W.prototype,"data",void 0),o([l()],W.prototype,"hasUpdatableCandidates",null),o([l()],W.prototype,"nestedWorkflowCount",null),o([l()],W.prototype,"shouldShowAttachments",null),o([l()],W.prototype,"shouldAllowAttachmentEditing",null),o([l()],W.prototype,"hasPendingEdits",null),o([l()],W.prototype,"helpMessage",null),o([l()],W.prototype,"reliesOnOwnerAdminPrivileges",null),o([l()],W.prototype,"hasInvalidFormTemplate",null),W=tt=o([O(jt)],W);const me=(e,t)=>Oa().warn(`editor:${e}`,t,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature."),Ta=e=>!!e&&/update-/.test(e.type),Pa=W;let L=class extends ae{constructor(t){super(t),this.layer=null}get attachments(){var t;return{enabled:this._effectiveEnabled&&!!((t=this._effectiveCapabilities)!=null&&t.data.supportsAttachment)}}get create(){var d;const{_effectiveCapabilities:t,layer:i}=this,a=this._createEnabled,r=a,s=(d=i.capabilities)==null?void 0:d.operations.supportsAdd,n=!!(t!=null&&t.operations.supportsAdd);return{attachments:{enabled:a&&this.attachments.enabled},attributes:a,enabled:a,geometry:r,reliesOnOwnerAdminPrivileges:!s&&n}}get delete(){var s;const{_effectiveCapabilities:t,layer:i}=this,a=(s=i.capabilities)==null?void 0:s.operations.supportsDelete,r=!!(t!=null&&t.operations.supportsDelete);return{enabled:this._effectiveEnabled&&!!(t!=null&&t.operations.supportsDelete),reliesOnOwnerAdminPrivileges:!a&&r}}get reliesOnOwnerAdminPrivileges(){return this._effectiveEnabled&&!this.layer.editingEnabled||this.create.reliesOnOwnerAdminPrivileges||this.update.reliesOnOwnerAdminPrivileges||this.delete.reliesOnOwnerAdminPrivileges}get update(){var p;const{_effectiveCapabilities:t,layer:i}=this,a=this._updateEnabled,r=!(!a||!(t!=null&&t.editing.supportsGeometryUpdate)),s=(p=i.capabilities)==null?void 0:p.operations.supportsUpdate,n=!!(t!=null&&t.operations.supportsUpdate),d=this.attachments.enabled,c=d&&this._canCreateOrUpdate;return{attachments:{enabled:d,create:c,update:c},attributes:a,enabled:a,geometry:r,reliesOnOwnerAdminPrivileges:!s&&n}}get _createEnabled(){var t;return this._effectiveEnabled&&!!((t=this._effectiveCapabilities)!=null&&t.operations.supportsAdd)}get _updateEnabled(){var t;return this._effectiveEnabled&&!!((t=this._effectiveCapabilities)!=null&&t.operations.supportsUpdate)}get _canCreateOrUpdate(){return!(!this._createEnabled&&!this._updateEnabled)}get _effectiveEnabled(){return ki(this.layer)}get _effectiveCapabilities(){return bi(this.layer)}};o([l()],L.prototype,"attachments",null),o([l()],L.prototype,"create",null),o([l()],L.prototype,"delete",null),o([l()],L.prototype,"layer",void 0),o([l()],L.prototype,"reliesOnOwnerAdminPrivileges",null),o([l()],L.prototype,"update",null),o([l()],L.prototype,"_createEnabled",null),o([l()],L.prototype,"_updateEnabled",null),o([l()],L.prototype,"_canCreateOrUpdate",null),o([l()],L.prototype,"_effectiveEnabled",null),o([l()],L.prototype,"_effectiveCapabilities",null),L=o([O("esri.layers.support.EditingCapabilities")],L);const Mt=L,le="esri.views.layers.support.editableLayerViews";function La(e,t){const{associatedLayer:i}=e,a=i==null?void 0:i.infoFor3D;if(!a)return!1;const{supportedFormats:r,queryFormats:s}=a,n=Ki("model/gltf-binary",r)??Qi("glb",r);if(!(n!=null&&s.includes(n)))return z.getLogger(le).warnOnce(`SceneLayer (${e.title??"Untitled layer"}, ${e.id}) does not support geometry edits because it does not support GLB queries.`),!1;const d=e.spatialReference,c=i.spatialReference;if(!xe(d,c))return z.getLogger(le).warnOnce(`SceneLayer (${e.title??"Untitled layer"}, ${e.id}) does not support geometry edits because its spatial reference (wkid:${d.wkid}) is different from its associated FeatureLayer's spatial reference (wkid:${c.wkid}).`),!1;const p=i.sourceJSON.sourceSpatialReference;if(!(p==null||xe(p,c)))return z.getLogger(le).warnOnce(`SceneLayer (${e.title??"Untitled layer"}, ${e.id}) does not support geometry edits because the spatial reference of its associated FeatureLayer's service (wkid:${c.wkid}) is different from its source spatial reference (wkid:${p.wkid}).`),!1;const{view:u}=t;if(t.destroyed||u==null)return!1;const m=u.spatialReference,{viewingMode:f}=u.state,y=qi(d),w=f===Ji.Global;return y&&!w?(z.getLogger(le).warnOnce(`SceneLayer (${e.title??"Untitled layer"}, ${e.id}) does not support geometry edits in local viewing mode because its spatial reference (wkid:${d.wkid}) is geographic. Please consider changing the viewing mode to global.`),!1):!y&&w?(z.getLogger(le).warnOnce(`SceneLayer (${e.title??"Untitled layer"}, ${e.id}) does not support geometry edits in global viewing mode because its spatial reference (wkid:${d.wkid}) is projected. Please consider changing the viewing mode to local.`),!1):!!(xe(d,m)||w&&ji(m)&&Zi(d))||(z.getLogger(le).warnOnce(`SceneLayer (${e.title??"Untitled layer"}, ${e.id}) does not support geometry edits because its spatial reference (wkid:${d.wkid}) does not match the view spatial reference (wkid:${m.wkid}).`),!1)}let x=class extends Mt{constructor(t){super(t),this.layerInfo=null,this.layerView=null}get attachments(){const t=this.defaults.attachments.enabled,i=this.layerInfo;return{enabled:t&&(i==null?void 0:i.enabled)!==!1}}get create(){const{attachments:t,defaults:i,layerInfo:a,layer:r,layerView:s}=this,n=i.create,d=(a==null?void 0:a.enabled)!==!1&&(a==null?void 0:a.addEnabled)!==!1,c=n.enabled&&d;return{attributes:c&&n.attributes,enabled:c,geometry:c&&n.geometry&&Ft(r,s),attachments:{enabled:t.enabled&&c&&(a==null?void 0:a.attachmentsOnCreateEnabled)!==!1},reliesOnOwnerAdminPrivileges:n.reliesOnOwnerAdminPrivileges}}get defaults(){return new Mt({layer:this.layer})}get delete(){const{defaults:t,layerInfo:i}=this,a=t.delete,r=(i==null?void 0:i.enabled)!==!1&&(i==null?void 0:i.deleteEnabled)!==!1;return{enabled:a.enabled&&r,reliesOnOwnerAdminPrivileges:a.reliesOnOwnerAdminPrivileges}}get formTemplate(){const{layer:t,layerInfo:i}=this;return i!=null&&i.formTemplate?i.formTemplate:t&&"formTemplate"in t?t.formTemplate:null}get relationship(){var r,s,n;const{layer:t}=this,i=!(!Bi(t)||!((r=t.relationships)!=null&&r.length)),a=!!((n=(s=this.formTemplate)==null?void 0:s.elements)!=null&&n.some(d=>d.type==="relationship"));return{enabled:i&&a}}get update(){const{attachments:t,defaults:i,layerInfo:a,layer:r,layerView:s}=this,n=i.update,d=(a==null?void 0:a.enabled)!==!1&&(a==null?void 0:a.updateEnabled)!==!1,c=n.enabled&&d,p=c&&n.attributes&&(a==null?void 0:a.attributeUpdatesEnabled)!==!1,u=c&&n.geometry&&(a==null?void 0:a.geometryUpdatesEnabled)!==!1&&Ft(r,s),m=t.enabled&&(a==null?void 0:a.attachmentsOnUpdateEnabled)!==!1;return{attributes:p,enabled:c,geometry:u,attachments:{enabled:m,create:m&&n.attachments.create,update:m&&n.attachments.update},reliesOnOwnerAdminPrivileges:n.reliesOnOwnerAdminPrivileges}}};function Ft(e,t){return e.type!=="scene"||t!=null&&"type"in t&&t.type==="scene-layer-3d"&&La(e,t)}o([l()],x.prototype,"attachments",null),o([l()],x.prototype,"create",null),o([l()],x.prototype,"defaults",null),o([l()],x.prototype,"delete",null),o([l()],x.prototype,"formTemplate",null),o([l()],x.prototype,"layerInfo",void 0),o([l()],x.prototype,"layerView",void 0),o([l()],x.prototype,"relationship",null),o([l()],x.prototype,"update",null),x=o([O("esri.widgets.Editor.support.EditorEditingCapabilities")],x);const Ua=x;let S=class extends ae{constructor(t){super(t),this.disabled=!1,this.layer=null,this.layerInfo=null,this.layerView=null}get _suspended(){var t;return!!((t=this.layerView)!=null&&t.suspended)}get capabilities(){return new Ua({layer:this.layer,layerInfo:this.layerInfo,layerView:this.layerView})}get editable(){const{create:t,relationship:i,update:a,delete:{enabled:r}}=this.capabilities,s=t.attachments.enabled||a.attachments.enabled;return!this.disabled&&(t.enabled||a.enabled||s||r||i.enabled)}get formTemplate(){return this.capabilities.formTemplate}get hasInvalidFormTemplate(){return Yi(this.layer,this.formTemplate)}get isTable(){return pe(this.layer)}get supportsCreateFeaturesWorkflow(){if(this.disabled)return!1;const{enabled:t,geometry:i}=this.capabilities.create;return this.isTable?t:t&&i}get supportsUpdateWorkflow(){const{capabilities:t}=this;return!this.disabled&&(t.update.enabled||t.update.attachments.enabled||t.delete.enabled)}get visible(){const{layer:t}=this,i=t.parent;return!this._suspended&&t.visible&&(!i||!("visible"in i)||i.visible)}};o([l()],S.prototype,"_suspended",null),o([l()],S.prototype,"capabilities",null),o([l()],S.prototype,"disabled",void 0),o([l()],S.prototype,"editable",null),o([l()],S.prototype,"formTemplate",null),o([l()],S.prototype,"hasInvalidFormTemplate",null),o([l()],S.prototype,"isTable",null),o([l()],S.prototype,"layer",void 0),o([l()],S.prototype,"layerInfo",void 0),o([l()],S.prototype,"layerView",void 0),o([l()],S.prototype,"supportsCreateFeaturesWorkflow",null),o([l()],S.prototype,"supportsUpdateWorkflow",null),o([l()],S.prototype,"visible",null),S=o([O("esri.widgets.Editor.support.EditorItem")],S);const xa=S,Zt="esri.widgets.Editor.EditorViewModel",Da=()=>z.getLogger(Zt),Kt=["create-features","update"];function te(e,t,i){Da().error(new $(e,t,i))}function Ha(e,t){return e==null?void 0:e.find(i=>i.layer===t)}let v=class extends Et.EventedAccessor{constructor(e){super(e),this._sketchEventListenerHandle=null,this._sketchGraphicsLayer=new ot({listMode:"hide",internal:!0}),this._snappingManager=null,this._updateItemsTask=null,this._updatingHandles=new Vt,this._featureTemplatesViewModelLocked=!1,this.activeWorkflow=null,this._activityQueue=new Ie,this.editorItems=new Ie,this.failures=[],this.hideTemplatesForInactiveLayers=!1,this.attachmentsViewModel=new ni({capabilities:{editing:!0}}),this.featureTemplatesViewModel=new ui({disabledItemFunction:({layer:t})=>this._itemIsSuspended(t)}),this.layerInfos=null,this.ownSketchViewModel=new lt({layer:this._sketchGraphicsLayer}),this.sketchOptions=new Te,this.snappingOptions=new Ot({attributeRulesEnabled:!0}),this.spinnerViewModel=new wi,this.pageStack=[],this.showDiscardEditsPrompt=()=>Promise.resolve(!0),this._candidateCommitted=!1,this.back=async()=>{var t;this.canGoBack&&((t=this.activeWorkflow)!=null&&t.hasPreviousStep?await this.activeWorkflow.back(this.showDiscardEditsPrompt):await this._cancelWorkflow({force:!this.hasPendingEdits}))},this.saveWorkflow=async()=>{var i;const{featureFormViewModel:t}=this;if(t){if(t.submit(),!t.submittable||t.hasPendingSubtypeChoice)return;const a=t.getValues();if(t.validateContingencyConstraints(a,{includeIncompleteViolations:!0}).length>0)return}await((i=this.activeWorkflow)==null?void 0:i.save())},this.selectFeature=(t,i=!1)=>{const a=this.activeWorkflow;this._candidateCommitted||(a==null?void 0:a.type)!=="update"||(a.data.rootFeature=t,i&&(a.next(),this._candidateCommitted=!0))}}initialize(){this.addHandles([F(()=>{var r;const e=this.view,t=(r=e==null?void 0:e.map)==null?void 0:r.editableLayers,i=e==null?void 0:e.allLayerViews,a=i==null?void 0:i.filter(s=>!!(t!=null&&t.includes(s.layer)));return[t,a,this.layerInfos,this.allowedWorkflows]},()=>this._updateEditorItems(),we),F(()=>this.hideTemplatesForInactiveLayers,()=>this.syncFeatureTemplates()),J(()=>this.activeWorkflow,"cancel",()=>this.emit("workflow-cancel")),J(()=>this.activeWorkflow,"commit",()=>this.emit("workflow-commit")),J(()=>this.activeWorkflow,"complete",()=>{this.emit("workflow-commit"),this._set("activeWorkflow",null)}),ge(()=>{var e;return(e=this.view)==null?void 0:e.map},e=>e.add(this._sketchGraphicsLayer),ie),J(()=>this.editorItems,"change",()=>this._afterEditorItemsChange()),F(()=>[this.canCreate,this.canUpdateVisible],()=>this._afterEditorItemsChange()),F(()=>this.page,(e,t)=>{const i=[...this.pageStack];if(i.indexOf(e)===-1)i.push(e);else for(;i.length&&i.at(-1)!==e;)i.pop();this.pageStack=i},we),ge(()=>this.state==="awaiting-update-feature-candidate",()=>this._candidateCommitted=!1),J(()=>this.featureTemplatesViewModel,"select",async({item:e,oldItem:t})=>{var r;const{activeWorkflow:i}=this;if(i){if(i.type==="update"&&((r=i.activeWorkflow)==null?void 0:r.stepId)==="awaiting-feature-creation-info")return;try{await this.cancelWorkflow({force:!this.hasPendingEdits})}catch{return void this.featureTemplatesViewModel.select(t,{emit:!1})}}if(!e)return;const a={layer:e.layer,template:e.template};if(e.supportsUpload)return this.featureTemplatesViewModel.select(t,{emit:!1}),this.startCreateFeaturesWorkflow(a);this.startCreateFeaturesWorkflowAtFeatureCreation(a)}),J(()=>this.view,"key-down",e=>{var t;e.key==="Escape"&&((t=this.activeWorkflow)!=null&&t.keyboardCancellationEnabled)&&(e.stopPropagation(),this.back())}),J(()=>this.sketchViewModel,["create","delete","update"],e=>{var n,d;const{activeWorkflow:t}=this,i=(t==null?void 0:t.type)==="update",a=i?(n=t.activeWorkflow)==null?void 0:n.layer:t==null?void 0:t.layer,r=i?(d=t==null?void 0:t.activeWorkflow)==null?void 0:d.parentLayer:void 0,s=`sketch-${e.type}`;this.emit(s,{type:s,detail:e,layer:a,parentLayer:r})},ze),F(()=>this.view,e=>{if(this._snappingManager=rt(this._snappingManager),!e)return;const t=this.snappingOptions;this._snappingManager=new Ei({view:e,options:t})},we),F(()=>this.snappingOptions,e=>{this._snappingManager&&(this._snappingManager.options=e)},we)])}destroy(){this._cancelWorkflow({warnIfNoWorkflow:!1}).then(()=>{var e,t;(t=(e=this.view)==null?void 0:e.map)==null||t.remove(this._sketchGraphicsLayer),this.view=null}),this._updateItemsTask=He(this._updateItemsTask),this._updatingHandles.destroy(),this._sketchEventListenerHandle=Fe(this._sketchEventListenerHandle)}get allowedWorkflows(){return this._get("allowedWorkflows")}set allowedWorkflows(e){Re(z.getLogger(this),"allowedWorkflows",{replacement:"Editor.visibleElements",version:"4.29",warnOnce:!0}),e&&e.length!==0||(e=[...Kt]),this._set("allowedWorkflows",e)}get canCreate(){return this.editorItems.some(e=>e.supportsCreateFeaturesWorkflow)}get canCreateVisible(){return!!this.featureTemplatesLayers.length}get canUpdate(){return this.editorItems.some(e=>e.supportsUpdateWorkflow)}get canUpdateVisible(){return this.editorItems.some(e=>e.supportsUpdateWorkflow&&e.visible)}get featureTemplatesLayers(){const e=new Ie;for(const t of this.editorItems){const i=t.supportsCreateFeaturesWorkflow&&!t.isTable,a=this.hideTemplatesForInactiveLayers&&!t.visible;i&&!a&&e.push(t.layer)}return e}get editableItems(){return Re(z.getLogger(this),"editableItems",{replacement:"editorItems",version:"4.29",warnOnce:!0}),this.editorItems.map(e=>{const{capabilities:t,disabled:i,hasInvalidFormTemplate:a,layer:r}=e,s=[],n=t.create,d=t.update,c=t.delete;return n.enabled&&s.push("create"),d.enabled&&s.push("update"),c.enabled&&s.push("delete"),{layer:r,supports:s,suspended:i,attributeUpdatesEnabled:d.attributes,geometryUpdatesEnabled:d.geometry,attachmentsOnCreateEnabled:n.attachments.enabled,attachmentsOnUpdateEnabled:d.attachments.enabled,hasInvalidFormTemplate:a,hasAttachments:t.attachments.enabled}})}get featureFormViewModel(){const{activeWorkflow:e}=this;return(e==null?void 0:e.type)==="update"?e.activeFeatureFormViewModel:(e==null?void 0:e.type)==="create-features"?e.featureFormViewModel:null}get labelOptions(){return this.sketchOptions.labels}set labelOptions(e){this.sketchOptions.labels=e}get sketchViewModel(){const{activeWorkflow:e}=this;return(e==null?void 0:e.type)==="update"?e.activeSketchViewModel:(e==null?void 0:e.type)==="create-features"?e.sketchViewModel:this.ownSketchViewModel}get state(){var i,a;if(!((i=this.view)!=null&&i.ready))return"disabled";const e=this.attachmentsViewModel.mode;if(e==="add")return"adding-attachment";if(e==="edit")return"editing-attachment";const{activeWorkflow:t}=this;return t!=null&&t.stepId?t.type==="update"&&((a=t.activeWorkflow)!=null&&a.stepId)?t.activeWorkflow.stepId:t.stepId:"ready"}get syncing(){return this._activityQueue.length>0}get updating(){var e;return this._updatingHandles.updating||((e=this.activeWorkflow)==null?void 0:e.updating)===!0}get tooltipOptions(){return this.sketchOptions.tooltips}set tooltipOptions(e){this.sketchOptions.tooltips=e}get valueOptions(){return this.sketchOptions.values}set valueOptions(e){this.sketchOptions.values=e}set view(e){this.ownSketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)}get page(){const{activeWorkflow:e,state:t}=this;if((e==null?void 0:e.type)==="update"&&e.stepId==="awaiting-feature-to-update")return"ready";if((e==null?void 0:e.type)==="create-features"&&e.numPendingFeatures===0){const i=e.data.upload;if(i)return i.state==="default"?"ready":"creating-features-upload-details"}return t??"disabled"}get featureFormDisabled(){var t;const{activeWorkflow:e}=this;return(e==null?void 0:e.type)==="update"&&((t=e.activeEditorItem)==null?void 0:t.capabilities.update.attributes)===!1}get canGoBack(){return this.activeWorkflow!=null&&!this.syncing}get shouldShowDeleteButton(){var t;const{activeWorkflow:e}=this;return!!e&&e.type==="update"&&!!((t=e.activeEditorItem)!=null&&t.capabilities.delete.enabled)}get hasPendingEdits(){var e;return((e=this.activeWorkflow)==null?void 0:e.hasPendingEdits)??!1}async startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.startCreateFeaturesWorkflow()}async startCreateFeaturesWorkflowAtFeatureCreation(e){return this.startCreateFeaturesWorkflow(e,"creating-features")}async startCreateFeaturesWorkflow(e,t="awaiting-feature-creation-info"){if(await H(()=>!this.updating),!this.canCreate)throw new $("editing:unsupported-workflow","Creating features is unsupported or disabled.");const i=this._createUpdatingResolver();try{await this._cancelWorkflow();const a=this._createCreateFeaturesWorkflow(e,t);this._set("activeWorkflow",a),await a.start()}catch(a){this._logErrorAndCancelWorkflow(a)}finally{i.resolve()}}async startCreateFeaturesWorkflowAtFeatureEdit(e){await H(()=>!this.updating);const t=this._createUpdatingResolver();try{const{initialFeature:i}=e,a=i.sourceLayer=i.layer,r=a?this.findEditorItemForLayer(a):void 0;if(!(r!=null&&r.supportsCreateFeaturesWorkflow))throw new $("editing:unsupported-workflow","Creating features is unsupported or disabled for this layer.");await this._cancelWorkflow();const s=this._createCreateFeaturesWorkflow({initialFeature:i,layer:r.layer,maxFeatures:1},"creating-features");this._set("activeWorkflow",s),await s.start()}catch(i){this._logErrorAndCancelWorkflow(i)}finally{t.resolve()}}async startUpdateWorkflowAtFeatureSelection(){if(await H(()=>!this.updating),!this.canUpdate)return void te("editing:unsupported-workflow","Update workflow is unsupported or disabled.");const e=this._createUpdatingResolver();try{await this._cancelWorkflow();const t=this._createUpdateWorkflow();this._set("activeWorkflow",t),await t.start()}catch(t){this._logErrorAndCancelWorkflow(t)}finally{e.resolve()}}async startUpdateWorkflowAtMultipleFeatureSelection(e){if(await H(()=>!this.updating),!this.canUpdate)return void te("editing:unsupported-workflow","Update workflow is unsupported or disabled.");const t=this._createUpdatingResolver();try{await this._cancelWorkflow();const i=this._createUpdateWorkflow("awaiting-update-feature-candidate");i.data.candidates=e,this._set("activeWorkflow",i),await i.start()}catch(i){this._logErrorAndCancelWorkflow(i)}finally{t.resolve()}}async startUpdateWorkflowAtFeatureEdit(e){if(await H(()=>!this.updating),!this.canUpdate)return void te("editing:unsupported-workflow","Update workflow is unsupported or disabled.");const t=this._createUpdatingResolver();try{await this._cancelWorkflow();const i=this._createUpdateWorkflow("editing-existing-feature");i.data.rootFeature=e,this._set("activeWorkflow",i),await i.start()}catch(i){this._logErrorAndCancelWorkflow(i)}finally{t.resolve()}}async deleteFeatureFromWorkflow(){const{activeWorkflow:e}=this;e&&e.type==="update"?await e.deleteActiveFeature():te("editing:unsupported-workflow","Deleting requires an active update workflow.")}async cancelWorkflow(e){return this._cancelWorkflow({warnIfNoWorkflow:!0,...e})}findEditorItemForLayer(e){return this.editorItems.find(t=>t.layer===e)}itemHasInvalidFormTemplate(e){var t;return e!=null&&((t=this.findEditorItemForLayer(e.layer))==null?void 0:t.hasInvalidFormTemplate)===!0}syncFeatureTemplates(){this._featureTemplatesViewModelLocked||(this.featureTemplatesViewModel.layers=this.featureTemplatesLayers.toArray())}async toggleUpdateWorkflow(){this.canUpdate&&(this.hasPendingEdits&&!await this.showDiscardEditsPrompt()||(this.activeWorkflow&&this.state==="awaiting-feature-to-update"?await this.cancelWorkflow({force:!0}):await this.startUpdateWorkflowAtFeatureSelection()))}lockFeatureTemplatesViewModel(){return this._featureTemplatesViewModelLocked=!0,I(()=>{this._featureTemplatesViewModelLocked=!1,this.syncFeatureTemplates()})}async _getEditorItemCandidates(e){const{view:t}=this;if(!(t!=null&&t.map))return[];const{map:i}=t,a=i.editableLayers.toArray()??[],r=i.allTables.toArray().filter(Mi)??[];return await Promise.allSettled([...a.map(s=>s.type==="subtype-group"?s.loadAll():Promise.resolve()),...r.map(s=>s.load())]),_e(e),[...a.reverse(),...r.reverse()].filter(s=>Be(s)&&(s.geometryType!=="mesh"||t.type==="3d")).flatMap(s=>s.type==="subtype-group"?s.sublayers.toArray():s)}_drainEditorItems(){this.editorItems.drain(e=>e.destroy())}async _updateEditorItems(){He(this._updateItemsTask);const{view:e}=this,t=At(async i=>{if(!(e!=null&&e.map)||!(e!=null&&e.allLayerViews))return;const a=await this._getEditorItemCandidates(i);if(!a.length)return void this._drainEditorItems();const r=[],s=[],n=[],{layerInfos:d}=this;for(const p of a){const u=Ha(d,p),m=await he(e,p).catch(()=>null);(u?r:m?s:n).push(new xa({layer:p,layerInfo:u,layerView:m}))}d!=null&&d.length&&r.sort((p,u)=>d.findIndex(({layer:m})=>m===p.layer)-d.findIndex(({layer:m})=>m===u.layer));const c=[...r,...s,...n];i.aborted||(this._drainEditorItems(),this.editorItems.addMany(c))});this._updatingHandles.addPromise(t.promise),this._updateItemsTask=t}_afterEditorItemsChange(){const{activeWorkflow:e}=this;if(this.syncFeatureTemplates(),!e)return;const{stepId:t}=e;e.type!=="create-features"?e.type==="update"&&(t==="awaiting-feature-to-update"&&!this.canUpdateVisible||t==="awaiting-update-feature-candidate"&&!e.hasUpdatableCandidates)&&this._cancelWorkflow():t!=="awaiting-feature-creation-info"||this.canCreate||this._cancelWorkflow()}async _cancelWorkflow(e){const t=this.activeWorkflow;if(!t)return void((e==null?void 0:e.warnIfNoWorkflow)&&te("editing:no-active-workflow","There is no active workflow to cancel."));if(!e||e.force!==!1)return this.emit("workflow-cancel"),this._set("activeWorkflow",null),void await t.cancel(e);await t.cancel(e),this._set("activeWorkflow",null)}_createCreateFeaturesWorkflow(e,t){return Bt.create({viewModel:this,creationInfo:e,sketchOptions:this.sketchOptions,snappingManager:this._snappingManager,startAt:t,applyEditsCallback:(i,a,r)=>this._applyEdits(i,a,r),addAttachmentsCallback:(i,a)=>this._addAttachments(i,a)})}_createUpdateWorkflow(e){return Pa.create({viewModel:this,sketchOptions:this.sketchOptions,snappingManager:this._snappingManager,startAt:e,applyEditsCallback:(t,i,a)=>this._applyEdits(t,i,a),addAttachmentsCallback:(t,i)=>this._addAttachments(t,i)})}_addAttachments(e,t){const i=t.map(a=>this._addAttachment(e,a.feature,a.attachment))??[];return Promise.all(i)}async _addAttachment(e,t,i){var r;let a=null;if(!("addAttachment"in e)||((r=e.capabilities)==null?void 0:r.attachment)==null)throw new $("editor:attachments-not-supported","Adding attachments is not supported for this layer type");return await this._queueOperation(async()=>{var s;return a=await((s=e.addAttachment)==null?void 0:s.call(e,t,i).catch(n=>{throw(n==null?void 0:n.error)||n}))??null,a}),a}async _applyEdits(e,t,i){let a=null;const r=e.url?await Fi(e.url):null,s={returnServiceEditsOption:(!r||!Ii(r))&&!RegExp("/hosted/","i").test(e.url)?"original-and-current-features":void 0,...i};return await this._queueOperation(async()=>{const{view:n}=this;if(!n)return null;const d=await he(n,e).catch(()=>null);return a=await e.applyEdits(t,s),d&&await H(()=>!d.updating),a}),a}_queueOperation(e){this._activityQueue.push(e);const t=(i,a)=>{const r=a.indexOf(i);r>-1&&a.splice(r,1)};return e().then(i=>{if(i!=null&&"error"in i&&i.error!=null)throw i.error;if(i!=null&&"addFeatureResults"in i){const{addFeatureResults:a,deleteFeatureResults:r,updateFeatureResults:s}=i,n=a.find(d=>!!d.error)||s.find(d=>!!d.error)||r.find(d=>!!d.error);if(n)throw n.error}return i}).catch(i=>{te("editing:operation-error","An error occurred.",{error:i});const a={error:i,retry:()=>(t(a,this.failures),this._queueOperation(e)),cancel:()=>{t(a,this.failures)}};this._set("failures",[...this.failures,a])}).then(()=>{t(e,this._activityQueue)})}_createUpdatingResolver(){const e=at();return this._updatingHandles.addPromise(e.promise),e}_logErrorAndCancelWorkflow(e){const{name:t,message:i,details:a}=e;te(t??"editing:workflow-start-failed",i??void 0,a??e),this._cancelWorkflow({force:!0})}_itemIsSuspended(e){const t=this.findEditorItemForLayer(e);return t!=null&&(!t.visible||t.disabled)}};o([l({readOnly:!0})],v.prototype,"activeWorkflow",void 0),o([l({readOnly:!0})],v.prototype,"_activityQueue",void 0),o([l({value:[...Kt]})],v.prototype,"allowedWorkflows",null),o([l({readOnly:!0})],v.prototype,"canCreate",null),o([l()],v.prototype,"canCreateVisible",null),o([l({readOnly:!0})],v.prototype,"canUpdate",null),o([l()],v.prototype,"canUpdateVisible",null),o([l()],v.prototype,"featureTemplatesLayers",null),o([l()],v.prototype,"editableItems",null),o([l()],v.prototype,"editorItems",void 0),o([l({readOnly:!0})],v.prototype,"failures",void 0),o([l()],v.prototype,"hideTemplatesForInactiveLayers",void 0),o([l()],v.prototype,"attachmentsViewModel",void 0),o([l()],v.prototype,"featureFormViewModel",null),o([l()],v.prototype,"featureTemplatesViewModel",void 0),o([l()],v.prototype,"labelOptions",null),o([l()],v.prototype,"layerInfos",void 0),o([l()],v.prototype,"ownSketchViewModel",void 0),o([l()],v.prototype,"sketchOptions",void 0),o([l()],v.prototype,"sketchViewModel",null),o([l({type:Ot,nonNullable:!0})],v.prototype,"snappingOptions",void 0),o([l()],v.prototype,"spinnerViewModel",void 0),o([l()],v.prototype,"state",null),o([l({readOnly:!0})],v.prototype,"syncing",null),o([l()],v.prototype,"updating",null),o([l()],v.prototype,"tooltipOptions",null),o([l()],v.prototype,"valueOptions",null),o([l()],v.prototype,"view",null),o([l()],v.prototype,"pageStack",void 0),o([l()],v.prototype,"showDiscardEditsPrompt",void 0),o([l()],v.prototype,"_candidateCommitted",void 0),o([l()],v.prototype,"page",null),o([l()],v.prototype,"featureFormDisabled",null),o([l()],v.prototype,"canGoBack",null),o([l()],v.prototype,"shouldShowDeleteButton",null),o([l()],v.prototype,"hasPendingEdits",null),v=o([O(Zt)],v);const Ra=v;let D=class extends ae{constructor(t){super(t),this.createFeaturesSection=!0,this.directionModePicker=!1,this.editFeaturesSection=!0,this.labelsToggle=!0,this.settingsMenu=!0,this.snappingControls=!0,this.snappingControlsElements=new dt,this.tooltipsToggle=!0,this.undoRedoButtons=!1}};o([l({type:Boolean,nonNullable:!0})],D.prototype,"createFeaturesSection",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"directionModePicker",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"editFeaturesSection",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"labelsToggle",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"settingsMenu",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"snappingControls",void 0),o([l({type:dt,nonNullable:!0})],D.prototype,"snappingControlsElements",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"tooltipsToggle",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"undoRedoButtons",void 0),D=o([O("esri.widgets.Editor.VisibleElements")],D);const Qt=D,fe="esri-editor__panel-content",ve={base:fe,message:`${fe}__message`,section:`${fe}__section`,sectionGroup:`${fe}__section__group`,scrimContainer:`${fe}__scrim-container`},ke=()=>re({scrim:()=>V(()=>import("./calcite-scrim-ByhE7nPY.js"),__vite__mapDeps([41,42,43,5,6,4,19,20,13,3,1,2,29,30,44,45,46,47,48,49,50]),import.meta.url)});function Y(e,...t){return h("div",{class:Ne(ve.base,e!=null&&e.showScrimOverlay?ve.scrimContainer:void 0),key:(e==null?void 0:e.key)??"panel-content"},...t,e!=null&&e.showScrimOverlay?h("calcite-scrim",null):void 0)}function ut(e,...t){return h("div",{class:ve.message,"data-testid":"panel-content-message",key:(e==null?void 0:e.key)??"panel-content-message"},...t)}function ue(e,...t){return h("div",{class:ve.section,key:(e==null?void 0:e.key)??"panel-content-section"},...t)}function Ga(e,...t){return h("div",{class:ve.sectionGroup,key:(e==null?void 0:e.key)??"panel-content-section-group"},...t)}const za=()=>ke();function Na({helpMessage:e}){return h(Y,{key:"creating-features-panel-content"},h(ut,{key:"content-message"},e))}const Ba=()=>ke();function qa({editorItems:e,filterText:t,id:i,messagesTemplates:a,onFilterTextChange:r,onSelectFeature:s,workflow:n}){const d=new Map,c=n.data.candidates;let p=0;c.map(f=>({label:ja(f),id:f.attributes[f.layer.objectIdField],data:f})).filter(({label:f,data:y})=>{const w=t.toLowerCase(),{title:g}=y.layer,b=e.find(_=>_.layer===y.sourceLayer);return b?b.supportsUpdateWorkflow&&(!w||(f==null?void 0:f.toLowerCase().includes(w))||(g==null?void 0:g.toLowerCase().includes(w))):null}).filter(Ge).forEach(f=>{var w;p++;const y=f.data.layer;d.has(y)?(w=d.get(y))==null||w.items.push(f):d.set(y,{id:`${y.id}`,label:y.title??"",items:[f]})});const u=e.toArray().map(({layer:f})=>d.get(f)).filter(Ge),m=p>10||t.length>0;return h(Y,{key:"feature-list"},h(ue,null,hi({enableListScroll:!1,filterEnabled:m,filterText:t,id:i,items:u,messages:{filterPlaceholder:a.filterPlaceholder,noItems:a.noItems,noMatches:a.noMatches},onFilterChange:f=>r(f),onItemMouseEnter:f=>s(f.data),onItemMouseLeave:()=>s(null),onItemSelect:f=>s(f.data,!0)})))}function ja(e){const t=e.layer;if(!t)return null;const i=t.fieldsIndex.get(t.objectIdField),a=i.alias||i.name,{attributes:r}=e,s=Lt(t);return s&&r[s]&&`${r[s]}`||`${a}: ${r[i.name]}`}const Za={base:"esri-editor__actions"},ht=()=>re({button:()=>V(()=>import("./calcite-button-D_QRw8fR.js"),__vite__mapDeps([51,52,43,5,6,4,19,20,13,3,1,2,29,30,44,53,46,54,55,56,57,45,47,48,49,58,50]),import.meta.url)});function Ve({buttons:e,key:t}){return h("div",{class:Za.base,key:t??"footer-actions",slot:"footer"},e.filter(Ge).map(({disabled:i,onClick:a,label:r,...s},n)=>h("calcite-button",{disabled:i??!1,key:`action-${n}`,onclick:()=>{i||a()},slot:"footer-actions",width:"full",...s},r)))}const Ka={notice:"esri-editor__notice"},Jt=()=>re({notice:()=>V(()=>import("./calcite-notice-DAIcfVw0.js"),__vite__mapDeps([59,43,5,6,4,19,20,13,3,1,2,29,30,44,60,48,46,57,45,47,49,61,56,58]),import.meta.url)});function Qa({workflow:e,messages:t}){return h(st,null,e!=null&&e.reliesOnOwnerAdminPrivileges?h(it,{message:t.ownerAdminNotice}):void 0,e!=null&&e.hasInvalidFormTemplate?h(it,{icon:Wt,message:t.formFieldUpdateError}):void 0)}function it({message:e,...t}){return h("calcite-notice",{class:Ka.notice,open:!0,scale:"s",...t},h("div",{slot:"message"},e))}const Ja={settingsContainer:"esri-editor__settings"},Ya=()=>re({accordion:()=>V(()=>import("./calcite-accordion-CIMDxbLr.js"),__vite__mapDeps([62,43,5,6,4,19,20,13,3,1,2,29,30,44,48]),import.meta.url),"accordion-item":()=>V(()=>import("./calcite-accordion-item-7SNIzdd3.js"),__vite__mapDeps([63,43,5,6,4,19,20,13,3,1,2,29,30,44,60,48,46,56,57,58]),import.meta.url)});function Xa({editorViewModel:e,messagesCommon:t,visibleElements:i}){const{snappingOptions:a,sketchOptions:r,view:s}=e,n=[],d={directionModePicker:i.directionModePicker,labelsToggle:i.labelsToggle,tooltipsToggle:i.tooltipsToggle};return yi(d)&&n.push(h(Xi,{sketchOptions:r,viewType:s==null?void 0:s.type,visibleElements:d})),i.snappingControls&&n.push(h(ea,{afterCreate:c=>c.layerListOpen=!1,snappingOptions:a,view:s,visibleElements:i.snappingControlsElements??new dt})),n.length===0?null:h("calcite-accordion",{appearance:"transparent",class:Ja.settingsContainer,key:"settings"},h("calcite-accordion-item",{"data-testid":"settings",heading:t.settings,iconStart:"gear"},n))}const er={base:"esri-editor__panel-toolbar"},tr=()=>Promise.all([re({button:()=>V(()=>import("./calcite-button-D_QRw8fR.js"),__vite__mapDeps([51,52,43,5,6,4,19,20,13,3,1,2,29,30,44,53,46,54,55,56,57,45,47,48,49,58,50]),import.meta.url)}),Ya()]);function ir({editorViewModel:e,messagesCommon:t,visibleElements:i}){const{sketchViewModel:a}=e;return h("div",{class:er.base,key:"panel-toolbar"},h(Xa,{editorViewModel:e,messagesCommon:t,visibleElements:i}),i.undoRedoButtons?[h("calcite-button",{alignment:"center",appearance:"transparent",disabled:!(a!=null&&a.canUndo()),iconStart:"undo",key:"undo-button",kind:"neutral",label:t.undo,onclick:()=>a==null?void 0:a.undo(),scale:"l"},t.undo),h("calcite-button",{alignment:"center",appearance:"transparent",disabled:!(a!=null&&a.canRedo()),iconStart:"redo",key:"redo-button",kind:"neutral",label:t.redo,onclick:()=>a==null?void 0:a.redo(),scale:"l"},t.redo)]:null)}const ar=()=>Promise.all([ht(),Jt(),ke()]);function It({editorViewModel:e,headingLevel:t,messages:i,messagesCommon:a,onDelete:r,onSave:s,renderAttachments:n,renderFeatureForm:d}){const{activeWorkflow:c,featureFormViewModel:p,syncing:u}=e;if(!c||!p)return null;const m=c.type,f="activeWorkflow"in c?c.activeWorkflow:void 0,y=f==null?void 0:f.type,w=f&&!f.hasPendingEdits||m==="update"&&!c.hasPendingEdits||u||p.updating,g=m==="update"&&y!=="create-features"?a.update:a.create,b=m==="create-features"&&c.createFeatureState==="create-new",_=m==="create-features"?c.numPendingFeatures:0,M=_>1?Se(i.createFeaturesTemplate,{numFeatures:_}):g,E=c.shouldShowAttachments&&!p.activeRelationshipInput,U=p.inputs.every(K=>!K.visible)&&!E?h(ut,{key:"panel-content-message"},Se(i.clickToFinishTemplate,{button:g})):h(ue,{key:"panel-content-section"},h(Qa,{messages:i,workflow:c}),h(Ga,null,d(),E?h("div",{key:"attachments"},h(je,{level:Ce(t)},i.attachments),n()):null));return h(st,null,h(Y,{key:"attribute-panel-content",showScrimOverlay:b},U),h(Ve,{buttons:[{onClick:s,disabled:w,label:M},e.shouldShowDeleteButton?{appearance:"outline",onClick:r,disabled:u,kind:"danger",label:a.delete}:void 0]}))}const P="esri-editor__upload-details",R={base:P,status:`${P}__status`,titleWrapper:`${P}__title-wrapper`,title:`${P}__title`,description:`${P}__description`,loader:`${P}__loader`,iconSuccess:`${P}__icon ${P}__icon--success`,iconError:`${P}__icon ${P}__icon--error`,fileList:`${P}__file-list`,file:`${P}__file`,fileIcon:`${P}__file-icon`,fileName:`${P}__file-name`},rr=()=>Promise.all([re({icon:()=>V(()=>import("./calcite-icon-CocWVhPd.js"),__vite__mapDeps([64,58,43,5,6,4,19,20,13,3,1,2,29,30,44,46,48]),import.meta.url),loader:()=>V(()=>import("./calcite-loader-DxqUpD6Z.js"),__vite__mapDeps([65,50,43,5,6,4,19,20,13,3,1,2,29,30,44,46,45,47,48]),import.meta.url)}),ht(),ke()]);function sr(e){const{messages:t,key:i,upload:a}=e;return h(st,null,h(Y,{key:i??"upload-details"},h(ue,null,or(e))),a.state==="error"?h(Ve,{buttons:[{onClick:()=>a.retry(),label:t.modelUploads.error.uploadNew,iconStart:"upload-to"}],key:"upload-details-footer-actions"}):null)}function or(e){const t=nr(e);return t?h("div",{class:R.base,"data-testid":"upload-details",key:"upload-details-content"},h("div",{class:R.status,key:"status"},t.iconContent,h("div",{class:R.titleWrapper,key:"text"},h("div",{class:R.title,key:"title"},t.title),h("div",{class:R.description,key:"description"},t.description))),dr(e.upload)):null}function nr({helpMessage:e,messages:t,upload:i}){switch(i.state){case"pending":{const{title:a,description:r}=t.modelUploads.pending;return{title:a,description:r,iconContent:h("calcite-loader",{"aria-hidden":"true",class:R.loader,label:"",scale:"s",type:"determinate",value:Math.min(Math.round(100*i.progress),i.progress===1?100:99)})}}case"success":{const{title:a}=t.modelUploads.success;return{title:a,description:e||t.helpMessages3d.mesh,iconContent:h("calcite-icon",{class:Ne(R.iconSuccess),icon:"check",scale:"l"})}}case"error":{const{title:a}=t.modelUploads.error;return{title:a,description:lr(i.error,t),iconContent:h("calcite-icon",{class:Ne(R.iconError),icon:"exclamation-mark-circle",scale:"l"})}}default:return null}}function lr(e,t){if(!e)return null;const i=t.modelUploads.error.messages;switch(e.constructor){case aa:return i.noModel;case ia:return i.multipleModels;case ta:return i.conversionFailed;default:return i.default}}function dr(e){return h("div",{class:R.fileList,key:"file-list"},e.files.map(t=>h("div",{class:R.file,key:`file-${t.name}`},h("calcite-icon",{class:R.fileIcon,icon:pr(t),scale:"s"}),h("span",{class:R.fileName},cr(t.name)))))}function cr(e){var t;return((t=e.split("/").pop())==null?void 0:t.split("\\").pop())??""}function pr(e){var i;const t=(i=e.name.split(".").pop())==null?void 0:i.toLowerCase();return(t?hr[t]:null)??ur}const ur="file",Ct="file-shape",Me="file-image",hr={glb:Ct,gltf:Ct,jpeg:Me,jpg:Me,png:Me,svg:Me,zip:"file-zip"};let k=class extends vi{constructor(e,t){super(e,t),this._featureForm=new di,this._attachments=new li({visibleElements:{addSubmitButton:!1,cancelAddButton:!1,cancelUpdateButton:!1,deleteButton:!1,errorMessage:!1,progressBar:!1,updateButton:!1}}),this._featureTemplates=new mi({enableListScroll:!1,renderItemContentEnd:i=>i.supportsUpload?h("calcite-icon",{class:oe.templateItemContentEnd,icon:"upload-to",key:"upload-icon"}):null,renderItemLabel:i=>i.label,renderCustomGroupContent:i=>this._renderCustomTemplateGroupContent(i)}),this._filterText="",this._prompt=null,this._spinner=new gi,this.headingLevel=4,this.messages=null,this.messagesCommon=null,this.messagesTemplates=null,this.supportingWidgetDefaults=null,this.viewModel=new Ra,this.visibleElements=new Qt,this._renderSelectIcon=()=>h("calcite-icon",{icon:"cursor",slot:"content-start"}),this.EditorPanel=({heading:i,key:a},...r)=>{const{visibleElements:s}=this;return h("calcite-flow-item",{closable:!1,heading:i,headingLevel:this.headingLevel,key:a,loading:this._loading,onCalciteFlowItemBack:this._onBack},s.settingsMenu?h(ir,{editorViewModel:this.viewModel,messagesCommon:this.messagesCommon,visibleElements:s}):null,...r)},this._showDiscardEditsPrompt=()=>{var r;const{messages:i,activeWorkflow:a}=this;return(a==null?void 0:a.type)==="create-features"&&ye(a.data.creationInfo)?this._showPromptAndWait(((r=a.data.upload)==null?void 0:r.state)==="success"?i.modelUploads.cancelPlacementPrompt:i.modelUploads.cancelUploadPrompt):this._showPromptAndWait({title:i.cancelEditTitle,message:i.cancelEditWarningMessage,yesLabel:i.discardEdits,noLabel:i.continueEditing})},this._showGenericCancelPrompt=()=>{const{messages:i,messagesCommon:a}=this;return this._showPromptAndWait({title:i.cancelRequestTitle,message:i.cancelRequestWarningMessage,yesLabel:a.form.yes,noLabel:a.form.no})},this._showPrompt=i=>{var a,r;(r=(a=this._prompt)==null?void 0:a.cancel)==null||r.call(a),this._prompt=i},this._clearPrompt=()=>{this._prompt=null},this._onSave=()=>{this.viewModel.saveWorkflow()},this._onDelete=()=>{const{messages:i,messagesCommon:a}=this;this._showPrompt({title:i.deleteWarningTitle,message:i.deleteWarningMessage,context:"danger",actions:{primary:{label:a.delete,action:()=>{this.deleteFeatureFromWorkflow(),this._clearPrompt()}},secondary:{label:i.keepFeature,action:this._clearPrompt}}})},this._onToggleUpdateWorkflow=()=>this.viewModel.toggleUpdateWorkflow(),this._onBack=i=>(i==null||i.stopPropagation(),this.viewModel.back()),this._onAttachmentAdd=()=>{var a;const{activeWorkflow:i}=this.viewModel;i&&(i.type==="create-features"||i.type==="update"&&((a=i.activeWorkflow)==null?void 0:a.type)==="create-features"?(this._attachments.addFile(),i.back()):this._attachments.addAttachment().then(()=>i.back()))},this._onAttachmentUpdate=()=>{const{activeWorkflow:i}=this.viewModel;i&&(i.type==="create-features"?(this._attachments.updateFile(),i.back()):this._attachments.updateAttachment().then(()=>i.back()))},this._onAttachmentDelete=()=>{const{messages:i,messagesCommon:a}=this;this._showPrompt({title:i.deleteAttachmentWarningTitle,message:i.deleteAttachmentWarningMessage,context:"danger",actions:{primary:{label:a.delete,action:this._onAttachmentDeleteConfirm},secondary:{label:i.keepAttachment,action:this._clearPrompt}}})},this._onAttachmentDeleteConfirm=async()=>{const i=this._attachments,{activeWorkflow:a}=this.viewModel;a&&(a.type==="create-features"?i.deleteFile():(await i.deleteAttachment(i.viewModel.activeAttachmentInfo),this._clearPrompt()),await a.back(),this._clearPrompt())},this._onAttachmentsError=i=>{this._showPrompt({title:this.messages.errorWarningTitle,message:i.message,context:"warning",actions:{primary:{label:this.messagesCommon.form.ok,action:this._clearPrompt}}})}}initialize(){this._featureForm.showPrompt=this._showPrompt,this._featureForm.clearPrompt=this._clearPrompt,this.addHandles([F(()=>Ce(this.headingLevel),e=>{this._featureForm.headingLevel=e,this._featureTemplates.headingLevel=e},ie),J(()=>this.viewModel.activeWorkflow,"cancel-request",({controller:e})=>{(this.viewModel.hasPendingEdits?this._showDiscardEditsPrompt():this._showGenericCancelPrompt()).then(t=>t?e.allow():e.deny())}),ge(()=>this.viewModel.featureFormViewModel,e=>{this._featureForm.viewModel=e},ie),F(()=>this.viewModel,e=>{this._attachments.viewModel=(e==null?void 0:e.attachmentsViewModel)??null,this._featureTemplates.viewModel=(e==null?void 0:e.featureTemplatesViewModel)??null,this._spinner.viewModel=(e==null?void 0:e.spinnerViewModel)??null,e.showDiscardEditsPrompt=this._showDiscardEditsPrompt},ie),F(()=>this.view,(e,t)=>{const i=`editor-${this.id}-spinner`;t==null||t.ui.remove(this._spinner,i),e==null||e.ui.add(this._spinner,{key:i,position:"manual"})},ie),F(()=>[this.supportingWidgetDefaults,this.viewModel.sketchViewModel],([e])=>{var t;e&&(this._featureForm.set(e.featureForm),this._attachments.set(e.attachments),this._featureTemplates.set(e.featureTemplates),(t=this.viewModel.sketchViewModel)==null||t.set(e.sketch))},ie),ge(()=>{var e;return(e=this._attachments)==null?void 0:e.error},e=>this._onAttachmentsError(e)),ge(()=>{var e;return(e=this.viewModel)==null?void 0:e.failures},e=>{const{messages:t}=this,[{error:i,retry:a,cancel:r}]=e;this._showPrompt({title:t.errorWarningTitle,message:Se(t.errorWarningMessageTemplate,{errorMessage:i.message}),context:"warning",actions:{primary:{label:t.retry,action:()=>{a(),this._clearPrompt()}},secondary:{label:t.ignore,action:()=>{r(),this._clearPrompt()}}}})}),F(()=>{var e;return(e=this.viewModel)==null?void 0:e.state},e=>{switch(e){case"awaiting-feature-to-update":case"ready":case"disabled":this._filterText="",this._featureTemplates.filterText=""}}),F(()=>this.viewModel.featureFormDisabled,e=>this._featureForm.disabled=e)])}destroy(){this._attachments.destroy(),this._featureForm.destroy(),this._featureTemplates.destroy()}loadDependencies(){return Promise.all([re({"flow-item":()=>V(()=>import("./calcite-flow-item-M0Vz-xgS.js"),__vite__mapDeps([66,43,5,6,4,19,20,13,3,1,2,29,30,44,46,54,57,45,47,48,49,67,68,69,70,56,58,50,71,72,73,74,61,75,76,42]),import.meta.url),flow:()=>V(()=>import("./calcite-flow-CrhM5qTo.js"),__vite__mapDeps([77,43,5,6,4,19,20,13,3,1,2,29,30,44,48,57]),import.meta.url),icon:()=>V(()=>import("./calcite-icon-CocWVhPd.js"),__vite__mapDeps([64,58,43,5,6,4,19,20,13,3,1,2,29,30,44,46,48]),import.meta.url),list:()=>V(()=>import("./calcite-list-C9DJsIWv.js"),__vite__mapDeps([78,43,5,6,4,19,20,13,3,1,2,29,30,44,46,54,48,79,80,57,49,45,47,81,73,58,82,53,55,56,83,84,85,86,50,42]),import.meta.url)}),za(),Ba(),ht(),Jt(),ke(),tr(),ci(),ar(),rr()])}get _deleteButtonCommonInfo(){return{appearance:"outline",kind:"danger"}}get _loading(){const{viewModel:e}=this;return e.syncing||e.updating||this._attachments.submitting}get activeWorkflow(){return this.viewModel.activeWorkflow}get allowedWorkflows(){return this.viewModel.allowedWorkflows}set allowedWorkflows(e){Re(z.getLogger(this),"allowedWorkflows",{replacement:"visibleElements",version:"4.29",warnOnce:!0}),this.viewModel.allowedWorkflows=e}get hideTemplatesForInactiveLayers(){return this.viewModel.hideTemplatesForInactiveLayers}set hideTemplatesForInactiveLayers(e){this.viewModel.hideTemplatesForInactiveLayers=e}get icon(){return"pencil"}set icon(e){this._overrideIfSome("icon",e)}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}get labelOptions(){return this.viewModel.labelOptions}set labelOptions(e){this.viewModel.labelOptions=e}get layerInfos(){return this.viewModel.layerInfos}set layerInfos(e){this.viewModel.layerInfos=e}get snappingOptions(){return this.viewModel.snappingOptions}set snappingOptions(e){this.viewModel.snappingOptions=e}get tooltipOptions(){return this.viewModel.tooltipOptions}set tooltipOptions(e){this.viewModel.tooltipOptions=e}get valueOptions(){return this.viewModel.valueOptions}set valueOptions(e){this.viewModel.valueOptions=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.viewModel.startCreateFeaturesWorkflowAtFeatureTypeSelection()}startCreateFeaturesWorkflowAtFeatureCreation(e){return this.viewModel.startCreateFeaturesWorkflowAtFeatureCreation(e)}startCreateFeaturesWorkflowAtFeatureEdit(e){return this.viewModel.startCreateFeaturesWorkflowAtFeatureEdit(e)}startUpdateWorkflowAtFeatureSelection(){return this.viewModel.startUpdateWorkflowAtFeatureSelection()}startUpdateWorkflowAtMultipleFeatureSelection(e){return this.viewModel.startUpdateWorkflowAtMultipleFeatureSelection(e)}startUpdateWorkflowAtFeatureEdit(e){return this.viewModel.startUpdateWorkflowAtFeatureEdit(e)}deleteFeatureFromWorkflow(){return this.viewModel.deleteFeatureFromWorkflow()}cancelWorkflow(e){return this.viewModel.cancelWorkflow(e)}render(){const{viewModel:e}=this,t=this.classes(oe.base,_t.widget,_t.panel);return e?h("div",{class:t,key:"base"},h("calcite-flow",{key:"flow"},e.pageStack.map(i=>this._renderPage(i))),this._prompt?h(pi,{...this._prompt,headingLevel:this.headingLevel}):void 0):h("div",{class:t,key:"empty"})}_renderPage(e){switch(e){case"disabled":break;case"ready":return this._renderReady();case"awaiting-feature-creation-info":return this._renderAwaitingFeatureCreationInfo();case"creating-features-upload-details":return this._renderUploadDetails();case"creating-features":return this._renderCreatingFeatures();case"editing-existing-feature":case"editing-attributes":return this._renderUpdateFeature();case"awaiting-update-feature-candidate":return this._renderFeatureList();case"adding-attachment":return this._renderAttachmentAdding();case"editing-attachment":return this._renderAttachmentEditing()}return h("div",{key:"empty-page"})}_renderAwaitingFeatureCreationInfo(){const{EditorPanel:e,messages:t}=this;return h(e,{heading:t.selectTemplate,key:"templates-panel"},h(Y,{key:"feature-templates"},h(ue,null,this._featureTemplates.render())))}_renderUploadDetails(){const{EditorPanel:e,activeWorkflow:t,messages:i}=this;if((t==null?void 0:t.type)!=="create-features")return null;const a=t.data.upload;return a?h(e,{heading:i.createFeatures,key:"upload-details-panel"},h(sr,{helpMessage:this._helpMessage,messages:i,upload:a})):null}_renderCreatingFeatures(){var d,c;const{EditorPanel:e,activeWorkflow:t,messages:i,messagesCommon:a,headingLevel:r,viewModel:s}=this;if(!t)return null;const n=t.type==="create-features"&&t.numPendingFeatures>0||t.type==="update"&&((d=t==null?void 0:t.activeWorkflow)==null?void 0:d.type)==="create-features"&&((c=t.activeWorkflow)==null?void 0:c.numPendingFeatures)>0;return h(e,{heading:i.createFeatures,key:"create-features-panel"},n?h(It,{editorViewModel:s,headingLevel:r,messages:i,messagesCommon:a,renderAttachments:()=>this._attachments.render(),renderFeatureForm:()=>this._featureForm.render(),onDelete:this._onDelete,onSave:this._onSave}):h(Na,{helpMessage:this._helpMessage}))}_renderUpdateFeature(){const{EditorPanel:e,messages:t,messagesCommon:i,headingLevel:a,viewModel:r}=this;return h(e,{heading:t.editFeature,key:"update-feature-panel"},h(It,{editorViewModel:r,headingLevel:a,messages:t,messagesCommon:i,renderAttachments:()=>this._attachments.render(),renderFeatureForm:()=>this._featureForm.render(),onDelete:this._onDelete,onSave:this._onSave}))}_renderCustomTemplateGroupContent(e){const{messages:t,viewModel:i}=this,a=ii(e.group.items,r=>i.itemHasInvalidFormTemplate(r)?t.formFieldCreateError:void 0);return a?h(it,{icon:Wt,message:a}):null}_renderAttachmentAdding(){const{EditorPanel:e,_attachments:t,messages:i,messagesCommon:a}=this;return h(e,{heading:i.addAttachment,key:"attachment-adding-panel"},h(Y,{key:"attachments"},t.render()),h(Ve,{buttons:[{label:t.submitting?a.cancel:a.add,disabled:t.submitting||!t.selectedFile,onClick:this._onAttachmentAdd}]}))}_renderAttachmentEditing(){const{EditorPanel:e,_attachments:t,activeWorkflow:i,messages:a,messagesCommon:r}=this;return i?h(e,{heading:a.editAttachment,key:"attachment-editing-panel"},h(Y,{key:"attachments"},t.render()),i.shouldAllowAttachmentEditing?h(Ve,{buttons:[{label:r.update,disabled:t.submitting||!t.selectedFile,onClick:this._onAttachmentUpdate},{...this._deleteButtonCommonInfo,onClick:this._onAttachmentDelete,disabled:t.submitting,label:r.delete}]}):void 0):null}_renderReady(){const{EditorPanel:e,messages:t,viewModel:i,visibleElements:a}=this,r=this._helpMessage;return h(e,{heading:t.widgetLabel,key:"landing-panel"},h(Y,{key:"landing-content"},i.editorItems.length?[a.editFeaturesSection?h(ue,{key:"edit-actions"},this._renderUpdateActions()):null,a.createFeaturesSection&&i.canCreateVisible?h(ue,{key:"create-actions"},this._renderCreateActions()):null]:h(ut,{key:"no-content"},t.noEditableLayers)),r?h("div",{class:oe.helpMessage,key:"footer-actions",slot:"footer"},r):void 0)}get _helpMessage(){var r;const{activeWorkflow:e,messages:t,view:i}=this,a=e==null?void 0:e.helpMessage;return a?(r=t[(i==null?void 0:i.type)==="3d"?"helpMessages3d":"helpMessages2d"])==null?void 0:r[a]:void 0}_renderUpdateActions(){var r;const{messages:e,messagesCommon:t,viewModel:i}=this,a={id:"select",label:t.select};return h("div",{class:oe.updateActions,key:"update-actions"},h(je,{level:Ce(this.headingLevel)},e.editFeatures),h("calcite-list",{class:oe.updateActionsList,selectionAppearance:"border",selectionMode:"single"},fi({disabled:!i.canUpdateVisible,grouped:!1,item:a,selectedItem:((r=i.activeWorkflow)==null?void 0:r.stepId)==="awaiting-feature-to-update"?a:void 0,renderIcon:this._renderSelectIcon,onItemSelect:this._onToggleUpdateWorkflow})))}_renderCreateActions(){return h("div",{key:"create-actions"},h(je,{level:Ce(this.headingLevel)},this.messages.createFeatures),h("div",{class:oe.featureTemplatesContainer,key:"templates"},this._featureTemplates.render()))}_renderFeatureList(){const{EditorPanel:e,viewModel:t}=this,{activeWorkflow:i}=t;if((i==null?void 0:i.type)!=="update")return null;const a=i.data.candidates,r=Se(this.messages.multipleFeaturesTemplate,{total:a.length});return h(e,{heading:r,key:"feature-list"},h(qa,{editorItems:t.editorItems,filterText:this._filterText,id:this.id,messagesTemplates:this.messagesTemplates,workflow:i,onFilterTextChange:s=>this._filterText=s,onSelectFeature:(s,n)=>t.selectFeature(s,n)}))}_showPromptAndWait({title:e,message:t,yesLabel:i,noLabel:a}){const r=at(),{view:s}=this,n=s==null?void 0:s.focused;return this._showPrompt({title:e,message:t,context:"danger",actions:{primary:{label:i,action:()=>r.resolve(!0)},secondary:{label:a,action:()=>r.resolve(!1)}}}),r.promise.finally(()=>{this._clearPrompt(),n&&(s==null||s.focus())})}};o([l()],k.prototype,"_featureForm",void 0),o([l()],k.prototype,"_attachments",void 0),o([l()],k.prototype,"_featureTemplates",void 0),o([l()],k.prototype,"_filterText",void 0),o([l()],k.prototype,"_prompt",void 0),o([l()],k.prototype,"_spinner",void 0),o([l()],k.prototype,"_deleteButtonCommonInfo",null),o([l()],k.prototype,"_loading",null),o([l({readOnly:!0})],k.prototype,"activeWorkflow",null),o([l()],k.prototype,"allowedWorkflows",null),o([l()],k.prototype,"headingLevel",void 0),o([l()],k.prototype,"hideTemplatesForInactiveLayers",null),o([l()],k.prototype,"icon",null),o([l()],k.prototype,"label",null),o([l()],k.prototype,"labelOptions",null),o([l()],k.prototype,"layerInfos",null),o([l(),Le("esri/widgets/Editor/t9n/Editor")],k.prototype,"messages",void 0),o([l(),Le("esri/t9n/common")],k.prototype,"messagesCommon",void 0),o([l(),Le("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],k.prototype,"messagesTemplates",void 0),o([l()],k.prototype,"snappingOptions",null),o([l()],k.prototype,"tooltipOptions",null),o([l()],k.prototype,"supportingWidgetDefaults",void 0),o([l({type:oi,nonNullable:!0})],k.prototype,"valueOptions",null),o([l()],k.prototype,"view",null),o([l(),ra(["sketch-create","sketch-delete","sketch-update","workflow-cancel","workflow-commit"])],k.prototype,"viewModel",void 0),o([l({type:Qt,nonNullable:!0})],k.prototype,"visibleElements",void 0),o([l()],k.prototype,"_helpMessage",null),k=o([O("esri.widgets.Editor")],k);const Wl=k;export{Wl as default};
