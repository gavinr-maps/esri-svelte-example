import{e as v}from"./Evented-CXIxDjmW.js";import{U as z,k as B,s as $,v as O}from"./assets-BNizZMOZ.js";import{V as F,d as N}from"./reactiveUtils-BFQ0BtrB.js";import{q as W,u as C}from"./Accessor-D6mNnsWy.js";import{y as S,b as H}from"./subclass-BR3PhgZG.js";import{w as T}from"./Extent-B4rrMrqp.js";import{K as k,W as K}from"./projection-tSh-0UvX.js";import{_ as U,f as A}from"./Point-TlcsOcXV.js";import{b as D,g as J,d as Y}from"./kmlUtils-D17SHcg7.js";import{f as Q}from"./utils-Blh5cXWv.js";import{c as P}from"./GraphicsCollection-B0IuEpT5.js";import{g as X,f as Z,b as tt}from"./Bitmap-UVG-lDis.js";import{a as it}from"./BitmapContainer-BbCPQbvy.js";import{f as et}from"./LayerView2D-Dn0gqiP2.js";import{t as M}from"./GraphicContainer-dBb5mX3Q.js";import{V as R}from"./GraphicsView2D-u2hXgWGU.js";import{y as rt}from"./LayerView-CbIY_4n2.js";import{C as ot,e as at}from"./rasterProjectionHelper-CuUa3waC.js";import{b as st}from"./WGLContainer-BPPb4wqa.js";import{o as pt}from"./MaterialPrograms-CQOe4hHU.js";import{t as mt}from"./capabilities-C84AMSCg.js";import{D as E,G as nt,U as lt,X as q}from"./enums-BlUEVwJR.js";import{E as ht}from"./Program-BE7XUO18.js";import{c as ct}from"./rasterUtils-Brs-M08Y.js";import{y as dt}from"./RenderingContext-B0G6O7lI.js";import{e as L,c as ut}from"./Texture-BbJIOVx_.js";import"./index-BVncS3aY.js";import"./shared-B3wH2qpO.js";import"./mathUtils-ClvKsMak.js";import"./Polyline-BQFeqYXi.js";import"./writer-3zufXUNV.js";import"./projectBuffer-iyGwL2dv.js";import"./geodesicConstants-kj1AtlGg.js";import"./jsonMap-DCC6W5ex.js";import"./PopupTemplate-D8mXPxzU.js";import"./Clonable-cKbRam6-.js";import"./fieldUtils-C5R42-PY.js";import"./intl-CArXn1et.js";import"./Promise-CZrWwByK.js";import"./geometry-CnaxvJsv.js";import"./enumeration--HlxOQ_N.js";import"./Color-DDUWtbqR.js";import"./colorUtils-CS9vdHXB.js";import"./ActionToggle-C0Z1k2jc.js";import"./Identifiable-BLvpQbOc.js";import"./aaBoundingBox-BGxkJAW0.js";import"./jsonUtils-DsFdmTaK.js";import"./ClassBreaksRenderer-B2uJHW90.js";import"./symbols-CfvYGR4J.js";import"./TextSymbol-zZq0BA1M.js";import"./screenUtils-PfxkaaMN.js";import"./materialUtils-CQ3JLQ1x.js";import"./opacityUtils-BT7mQkwC.js";import"./persistableUrlUtils-Dx61-x4K.js";import"./collectionUtils-Dm1icNvk.js";import"./Portal-DCqdz-K4.js";import"./UniqueValueRenderer-Q9ooDuxf.js";import"./diffUtils--7ofoPN-.js";import"./colorRamps-BBM5Timv.js";import"./SizeVariable-Bq7jlw1r.js";import"./ColorStop-DEfc5Idt.js";import"./sizeVariableUtils-Cmcuvw-4.js";import"./visualVariableUtils-CrTsYJ9f.js";import"./Graphic-Bi5hWHps.js";import"./jsonUtils-DtWlwXHP.js";import"./compilerUtils-BA04t1lN.js";import"./lengthUtils-vgIBtB6M.js";import"./jsonUtils-aUmUTP_F.js";import"./layerUtils-BzjQnEdj.js";import"./defaults-CIM29kXM.js";import"./defaultsJSON-GKolV7NZ.js";import"./styleUtils-C7rrjuqd.js";import"./LRUCache-ju6LnIBZ.js";import"./MemCache-C6WUx-5V.js";import"./Version-_Vxue7Ui.js";import"./FieldsIndex-DHql50vu.js";import"./UnknownTimeZone-D0GlcniK.js";import"./OverrideHelper-0-cH6aQ2.js";import"./colorUtils-D5nOabzP.js";import"./vec42-B1mBkh1w.js";import"./vec4f64-CBQL1T0x.js";import"./utils-D8D39sLt.js";import"./quantizationUtils-DFd0XKEL.js";import"./HeatmapColorStop-7F2_sZ2U.js";import"./heatmapUtils-C-uT6ZIV.js";import"./SimpleRenderer-FL1Ywtqd.js";import"./FeatureSet-4rZsDUx9.js";import"./Field-poIiHWUc.js";import"./fieldType-CIG5ey7e.js";import"./mat3-DRqs2t5W.js";import"./DefaultUI-Cy6B6U3V.js";import"./jsxFactory-Be5PKa9i.js";import"./uuid-fwrPAdZb.js";import"./UpdatingHandles-CMtXpTiG.js";import"./InputManager-C4xu1R9l.js";import"./Queue-DpHko4Yk.js";import"./signal-DzOfzcfh.js";import"./Map-D9sO0Jqv.js";import"./Basemap-CKBB4cRW.js";import"./loadAll-z9YY33Kx.js";import"./PortalItem-CaeKabGc.js";import"./writeUtils-BUKZUL8X.js";import"./Ground-CSI-YC3C.js";import"./CollectionFlattener-CkyePFnC.js";import"./editableLayers-BdCikvlg.js";import"./catalogUtils--o1nDhfl.js";import"./basemapUtils-fcYt_ePc.js";import"./utils-D20M4_S8.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-ybYUU6jq.js";import"./TablesMixin-BWPSKW45.js";import"./Layer-CfUiPX3n.js";import"./TimeExtent-Dl-qaORu.js";import"./timeUtils-DQR2jUPL.js";import"./HeightModelInfo-CzO-kRMK.js";import"./ReactiveMap-Dl_3-Rm5.js";import"./Query-BpMwiNVl.js";import"./DataLayerSource-BX7Ap_tY.js";import"./FullTextSearch-BhJOgh_r.js";import"./selectionUtils-DYi6daQO.js";import"./IViewEvents-Bci6PjlS.js";import"./interfaces-D6pIddIh.js";import"./screenUtils-BGG3AyYa.js";import"./a11yUtils-DwloBVAu.js";import"./heightModelInfoUtils-C5nNknML.js";import"./arcgisLayerUrl-ETqee4Bd.js";import"./ViewingMode-Dodu7ZZk.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-CZa70j6i.js";import"./accessibleHandler-COYT31Am.js";import"./Compass-eoZ7sbNQ.js";import"./utils-DsJqvptN.js";import"./GoTo-CyjNnle5.js";import"./NavigationToggle-Dune4J79.js";import"./Zoom-BgowPovH.js";import"./vec2f32-BbH2jxlN.js";import"./DisplayObject-DFOkWAgp.js";import"./Container-BQo1Tfto.js";import"./EffectView-D2q0Wr_W.js";import"./parser-BN6zmHl-.js";import"./highlightReasons-CQmHiFo_.js";import"./HighlightOptions-BG8_qaKQ.js";import"./quickselect-D0_cvEX6.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./TileKey-CIqLSCov.js";import"./definitions-ByNBSgP9.js";import"./ClipRect-CkQqwQzT.js";import"./layerViewUtils-D2JqIDZ8.js";import"./AGraphicContainer-DV1awRM6.js";import"./TechniqueInstance-CdE5J-S7.js";import"./UpdateTracking2D-CBckaO4D.js";import"./BindType-BmZEZMMh.js";import"./Util-BMqL_pkg.js";import"./vec2f64-Diu2Kaa8.js";import"./LabelMetric-Agz2doNK.js";import"./enums-BRXbslMp.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./BoundingBox-BhuXqU4L.js";import"./TileContainer-nXcbD7rd.js";import"./FeatureCommandQueue-CXv6tVJy.js";import"./CIMSymbolHelper-Ei9DhmLE.js";import"./BidiEngine-BwB1Df7c.js";import"./fontUtils-CILP_6vp.js";import"./OptimizedGeometry-vU5jWBvU.js";import"./GeometryUtils-CXWuBstD.js";import"./mat2d-DPkeMmgR.js";import"./mat2df32-orApM5a3.js";import"./vec2-B_ymkwGp.js";import"./Rect-CUzevAry.js";import"./BufferObject-CjYoWxgZ.js";import"./VertexArrayObject-Cwnso4un.js";import"./heatmapTextureUtils-DhR7tWLr.js";import"./constants-D5zmR9t2.js";import"./QueueProcessor-Bu6RBZRX.js";import"./vec3f32-Cw9Q6TO_.js";import"./normalizeUtils-CuTX3yb4.js";import"./normalizeUtilsCommon-DNPu20r0.js";import"./utils-Bh7lx_TM.js";import"./AttributeStore-BezdLLOX.js";import"./labelFormatUtils-CJcADR3o.js";import"./labelUtils-Cczy0uDR.js";import"./TimeOnly-BtK5SiqG.js";import"./centroid-DdLmOD72.js";import"./featureConversionUtils-B-SknPj_.js";import"./OptimizedFeature-7juV2tZm.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./timeSupport-86-Lo3YD.js";import"./json-Wa8cmqdu.js";import"./normalizeUtilsSync-DD8htqGn.js";import"./WGLBrushVTLSymbol-BVZwlPlb.js";import"./vec4f32-CjrfB-0a.js";import"./StyleDefinition-BK3ROBTO.js";import"./config-MDUrh2eL.js";import"./ShaderCompiler-G2XYGDs6.js";import"./ProgramTemplate-wM3hmZl7.js";import"./DefaultVertexAttributeLayouts-BIPVF1RK.js";import"./earcut-BqgeR2O3.js";import"./MapView-qZukyD5W.js";import"./Viewpoint-7_owAOZm.js";import"./Cyclical-BY_I03kj.js";import"./workers-D8NOwm_V.js";import"./TileInfo-Dm24FfTU.js";import"./TileKey-DZd6gJy7.js";import"./viewpointUtils-m5ps6MiV.js";import"./mat2df64-CBKYtunK.js";import"./unitBezier-BX6NeAEr.js";import"./TileStrategy-Dx1mrlzq.js";import"./utils-CXgSw6Sd.js";import"./ColorBackground-Ds8mXmIZ.js";import"./programUtils-CwiKxPbA.js";import"./ProgramCache-DZJRjGv8.js";import"./NestedMap-DgiGbX8E.js";import"./renderState-PYzNpa1K.js";import"./basicInterfaces-wONHx_SN.js";import"./interfaces-B8ge7Jg9.js";import"./testSVGPremultipliedAlpha-CKx7iZPZ.js";import"./floatRGBA-C8rGFKJ0.js";import"./doublePrecisionUtils-B0owpBza.js";class l{constructor(t){if(this._ownsRctx=!1,t)this._ownsRctx=!1,this._rctx=t;else{if(l._instance)return l._instanceRefCount++,l._instance;l._instanceRefCount=1,l._instance=this,this._ownsRctx=!0;const e=document.createElement("canvas"),r=mt(e);r.getExtension("OES_texture_float"),this._rctx=new dt(r,{})}const o={applyProjection:!0,bilinear:!1,bicubic:!1},a=pt("raster/reproject","raster/reproject",new Map([["a_position",0]]),o);this._program=this._rctx.programCache.acquire(a.shaders.vertexShader,a.shaders.fragmentShader,a.attributes),this._rctx.useProgram(this._program),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new st(this._rctx,[0,0,1,0,0,1,1,1])}reprojectTexture(t,o,a=!1){const e=k(t.extent,o),r=new U({x:(t.extent.xmax-t.extent.xmin)/t.texture.descriptor.width,y:(t.extent.ymax-t.extent.ymin)/t.texture.descriptor.height,spatialReference:t.extent.spatialReference}),{x:s,y:n}=ot(r,o,t.extent);let p=(s+n)/2;const m=Math.round((e.xmax-e.xmin)/p),u=Math.round((e.ymax-e.ymin)/p);p=(e.width/m+e.height/u)/2;const I=new U({x:p,y:p,spatialReference:e.spatialReference}),g=at({projectedExtent:e,srcBufferExtent:t.extent,pixelSize:I,hasWrapAround:!0,spacing:[16,16]}),f=ct(this._rctx,g),w=new L(m,u);w.wrapMode=E.CLAMP_TO_EDGE;const h=new ht(this._rctx,w);this._rctx.bindFramebuffer(h),this._rctx.setViewport(0,0,m,u),this._rctx.useProgram(this._program),this._rctx.bindTexture(t.texture,0),this._rctx.bindTexture(f,1),this._quad.bind();const{width:y=0,height:x=0}=t.texture.descriptor;if(this._program.setUniform2f("u_srcImageSize",y,x),this._program.setUniform2fv("u_transformSpacing",g.spacing),this._program.setUniform2fv("u_transformGridSize",g.size),this._program.setUniform2f("u_targetImageSize",m,u),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),f.dispose(),a){const{width:c,height:V}=h,_=new ImageData(c??0,V??0);h.readPixels(0,0,c??0,V??0,nt.RGBA,lt.UNSIGNED_BYTE,_.data);const G=h.detachColorTexture(q.COLOR_ATTACHMENT0);return h.dispose(),{texture:G,extent:e,imageData:_}}const b=h.detachColorTexture(q.COLOR_ATTACHMENT0);return h.dispose(),{texture:b,extent:e}}reprojectBitmapData(t,o){const a=X(t.bitmapData)?Z(t.bitmapData):t.bitmapData,e=new L;e.wrapMode=E.CLAMP_TO_EDGE,e.width=t.bitmapData.width,e.height=t.bitmapData.height;const r=new ut(this._rctx,e,a),s=this.reprojectTexture({texture:r,extent:t.extent},o,!0);s.texture.dispose();const n=document.createElement("canvas"),p=s.imageData;return n.width=p.width,n.height=p.height,n.getContext("2d").putImageData(p,0,0),{bitmapData:n,extent:s.extent}}async loadAndReprojectBitmapData(t,o,a){const e=(await z(t,{responseType:"image"})).data,r=document.createElement("canvas");r.width=e.width,r.height=e.height;const s=r.getContext("2d");s.drawImage(e,0,0);const n=s.getImageData(0,0,r.width,r.height);if(o.spatialReference.equals(a))return{bitmapData:n,extent:o};const p=this.reprojectBitmapData({bitmapData:n,extent:o},a);return{bitmapData:p.bitmapData,extent:p.extent}}destroy(){this._ownsRctx?(l._instanceRefCount--,l._instanceRefCount===0&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),l._instance=null)):(this._quad.dispose(),this._program.dispose())}}l._instanceRefCount=0;class j{constructor(){this.allSublayers=new Map,this.allPoints=[],this.allPolylines=[],this.allPolygons=[],this.allMapImages=[]}}let d=class extends et(rt){constructor(){super(...arguments),this._bitmapIndex=new Map,this._mapImageContainer=new it,this._kmlVisualData=new j,this._fetchController=null,this.allVisiblePoints=new P,this.allVisiblePolylines=new P,this.allVisiblePolygons=new P,this.allVisibleMapImages=new F}async hitTest(i,t){var a,e,r;const o=this.layer;return[(a=this._pointsView)==null?void 0:a.hitTest(i),(e=this._polylinesView)==null?void 0:e.hitTest(i),(r=this._polygonsView)==null?void 0:r.hitTest(i)].flat().filter(Boolean).map(s=>(s.layer=o,s.sourceLayer=o,{type:"graphic",graphic:s,layer:o,mapPoint:i}))}update(i){this._polygonsView&&this._polygonsView.processUpdate(i),this._polylinesView&&this._polylinesView.processUpdate(i),this._pointsView&&this._pointsView.processUpdate(i)}attach(){this._fetchController=new AbortController,this.container.addChild(this._mapImageContainer),this._polygonsView=new R({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new M(this.view.featuresTilingScheme)}),this.container.addChild(this._polygonsView.container),this._polylinesView=new R({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new M(this.view.featuresTilingScheme)}),this.container.addChild(this._polylinesView.container),this._pointsView=new R({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new M(this.view.featuresTilingScheme)}),this.container.addChild(this._pointsView.container),this.addAttachHandles([this.allVisibleMapImages.on("change",i=>{i.added.forEach(t=>this._addMapImage(t)),i.removed.forEach(t=>this._removeMapImage(t))}),N(()=>this.layer.visibleSublayers,i=>{for(const[t,o]of this._kmlVisualData.allSublayers)o.visibility=0;for(const t of i){const o=this._kmlVisualData.allSublayers.get(t.id);o&&(o.visibility=1)}this._refreshCollections()})]),this._updatingHandles.addPromise(this._fetchService(this._fetchController.signal)),this._imageReprojector=new l}detach(){this._fetchController=W(this._fetchController),this._mapImageContainer.removeAllChildren(),this.container.removeAllChildren(),this._bitmapIndex.clear(),this._polygonsView=C(this._polygonsView),this._polylinesView=C(this._polylinesView),this._pointsView=C(this._pointsView),this._imageReprojector=C(this._imageReprojector)}viewChange(){this._polygonsView.viewChange(),this._polylinesView.viewChange(),this._pointsView.viewChange()}moveEnd(){}isUpdating(){return this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating}_addMapImage(i){var t,o;((t=this.view.spatialReference)!=null&&t.isWGS84||(o=this.view.spatialReference)!=null&&o.isWebMercator)&&this._imageReprojector.loadAndReprojectBitmapData(i.href,T.fromJSON(i.extent),this.view.spatialReference).then(a=>{const e=new tt(a.bitmapData);e.x=a.extent.xmin,e.y=a.extent.ymax,e.resolution=a.extent.width/a.bitmapData.width,e.rotation=i.rotation,this._mapImageContainer.addChild(e),this._bitmapIndex.set(i,e)})}async _getViewDependentUrl(i,t){const{viewFormat:o,viewBoundScale:a,httpQuery:e}=i;if(o!=null){if(t==null)throw new Error("Loading this network link requires a view state.");let r;if(await K(),a!=null&&a!==1){const c=new T(t.extent);c.expand(a),r=c}else r=t.extent;r=k(r,A.WGS84);const s=k(r,A.WebMercator),n=r.xmin,p=r.xmax,m=r.ymin,u=r.ymax,I=t.size[0]*t.pixelRatio,g=t.size[1]*t.pixelRatio,f=Math.max(s.width,s.height),w={"[bboxWest]":n.toString(),"[bboxEast]":p.toString(),"[bboxSouth]":m.toString(),"[bboxNorth]":u.toString(),"[lookatLon]":r.center.x.toString(),"[lookatLat]":r.center.y.toString(),"[lookatRange]":f.toString(),"[lookatTilt]":"0","[lookatHeading]":t.rotation.toString(),"[lookatTerrainLon]":r.center.x.toString(),"[lookatTerrainLat]":r.center.y.toString(),"[lookatTerrainAlt]":"0","[cameraLon]":r.center.x.toString(),"[cameraLat]":r.center.y.toString(),"[cameraAlt]":f.toString(),"[horizFov]":"60","[vertFov]":"60","[horizPixels]":I.toString(),"[vertPixels]":g.toString(),"[terrainEnabled]":"0","[clientVersion]":B,"[kmlVersion]":"2.2","[clientName]":"ArcGIS API for JavaScript","[language]":"en-US"},h=c=>{for(const V in c){let _;for(_ in w)c[V]=c[V].replace(_,w[_])}},y=$(o);h(y);let x={};e!=null&&(x=$(e),h(x));const b=Q(i.href);return b.query={...b.query,...y,...x},`${b.path}?${O(y)}`}return i.href}async _fetchService(i){const t=new j;await this._loadVisualData(this.layer.url,t,i),this._kmlVisualData=t,this._refreshCollections()}_refreshCollections(){this.allVisiblePoints.removeAll(),this.allVisiblePolylines.removeAll(),this.allVisiblePolygons.removeAll(),this.allVisibleMapImages.removeAll(),this.allVisiblePoints.addMany(this._kmlVisualData.allPoints.filter(i=>this._isSublayerVisible(i.sublayerId)).map(({item:i})=>i)),this.allVisiblePolylines.addMany(this._kmlVisualData.allPolylines.filter(i=>this._isSublayerVisible(i.sublayerId)).map(({item:i})=>i)),this.allVisiblePolygons.addMany(this._kmlVisualData.allPolygons.filter(i=>this._isSublayerVisible(i.sublayerId)).map(({item:i})=>i)),this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter(i=>this._isSublayerVisible(i.sublayerId)).map(({item:i})=>i))}_isSublayerVisible(i){const t=this._kmlVisualData.allSublayers.get(i);return!!(t!=null&&t.visibility)&&(t.parentFolderId===-1||this._isSublayerVisible(t.parentFolderId))}_loadVisualData(i,t,o){return this._fetchParsedKML(i,o).then(async a=>{for(const e of a.sublayers){t.allSublayers.set(e.id,e);const r=e.points?await D(e.points):[],s=e.polylines?await D(e.polylines):[],n=e.polygons?await D(e.polygons):[],p=e.mapImages||[];if(t.allPoints.push(...r.map(m=>({item:m,sublayerId:e.id}))),t.allPolylines.push(...s.map(m=>({item:m,sublayerId:e.id}))),t.allPolygons.push(...n.map(m=>({item:m,sublayerId:e.id}))),t.allMapImages.push(...p.map(m=>({item:m,sublayerId:e.id}))),e.networkLink){const m=await this._getViewDependentUrl(e.networkLink,this.view.state);await this._loadVisualData(m,t,o)}}})}_fetchParsedKML(i,t){return J(i,this.layer.spatialReference,this.layer.refreshInterval,t).then(o=>Y(o.data))}_removeMapImage(i){const t=this._bitmapIndex.get(i);t&&(this._mapImageContainer.removeChild(t),this._bitmapIndex.delete(i))}};v([S()],d.prototype,"_pointsView",void 0),v([S()],d.prototype,"_polylinesView",void 0),v([S()],d.prototype,"_polygonsView",void 0),v([S()],d.prototype,"updating",void 0),d=v([H("esri.views.2d.layers.KMLLayerView2D")],d);const wo=d;export{wo as default};
