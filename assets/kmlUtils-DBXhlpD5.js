import{O as I,c as d}from"./Accessor-BmwT4B0c.js";import{E as w,s as k,P as E}from"./cast-CsZslgGN.js";import{q as x}from"./Graphic-Dt0LgVGU.js";import{g as v}from"./Point-Cz2JYYmX.js";import{u as P,K as h,M as g,C as O}from"./aaBoundingBox-Dw3yBk2f.js";import{m as S}from"./Polyline-s-JzsQqo.js";import{t as M}from"./jsonUtils-BZp85R7u.js";import{d as $}from"./FeatureSet-B5-Veyin.js";const F={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function A(s){var u;const o=s.folders||[],e=o.slice(),r=new Map,a=new Map,f=new Map,i=new Map,m=new Map,l={esriGeometryPoint:a,esriGeometryPolyline:f,esriGeometryPolygon:i};(((u=s.featureCollection)==null?void 0:u.layers)||[]).forEach(t=>{const p=d(t);p.featureSet.features=[];const y=t.featureSet.geometryType;r.set(y,p);const c=t.layerDefinition.objectIdField;y==="esriGeometryPoint"?G(a,c,t.featureSet.features):y==="esriGeometryPolyline"?G(f,c,t.featureSet.features):y==="esriGeometryPolygon"&&G(i,c,t.featureSet.features)}),s.groundOverlays&&s.groundOverlays.forEach(t=>{m.set(t.id,t)}),o.forEach(t=>{t.networkLinkIds.forEach(p=>{const y=C(p,t.id,s.networkLinks);y&&e.push(y)})}),e.forEach(t=>{var p;if(t.featureInfos){t.points=d(r.get("esriGeometryPoint")),t.polylines=d(r.get("esriGeometryPolyline")),t.polygons=d(r.get("esriGeometryPolygon")),t.mapImages=[];for(const y of t.featureInfos)switch(y.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const c=l[y.type].get(y.id);c&&((p=t[F[y.type]])==null||p.featureSet.features.push(c));break}case"GroundOverlay":{const c=m.get(y.id);c&&t.mapImages.push(c);break}}t.fullExtent=b([t])}});const n=b(e);return{folders:o,sublayers:e,extent:n}}function K(s,o,e,r){var i;const a=(i=k)==null?void 0:i.findCredential(s);s=w(s,{token:a==null?void 0:a.token});const f=I.kmlServiceUrl;return E(f,{query:{url:s,model:"simple",folders:"",refresh:e!==0||void 0,outSR:JSON.stringify(o)},responseType:"json",signal:r})}function U(s,o,e=null,r=[]){const a=[],f={},i=o.sublayers,m=new Set(o.folders.map(l=>l.id));return i.forEach(l=>{var u;const n=new s;if(e?n.read(l,e):n.read(l),r.length&&m.has(n.id)&&(n.visible=r.includes(n.id)),f[l.id]=n,l.parentFolderId!=null&&l.parentFolderId!==-1){const t=f[l.parentFolderId];t.sublayers||(t.sublayers=[]),(u=t.sublayers)==null||u.unshift(n)}else a.unshift(n)}),a}function G(s,o,e){e.forEach(r=>{s.set(r.attributes[o],r)})}function j(s,o){let e;return o.some(r=>r.id===s&&(e=r,!0)),e}function C(s,o,e){const r=j(s,e);return r&&(r.parentFolderId=o,r.networkLink=r),r}async function W(s){const o=$.fromJSON(s.featureSet).features,e=s.layerDefinition,r=M(e.drawingInfo.renderer),a=x.fromJSON(s.popupInfo),f=[];for(const i of o){const m=await r.getSymbolAsync(i);i.symbol=m,i.popupTemplate=a,i.visible=!0,f.push(i)}return f}function b(s){var r,a,f,i,m,l;const o=P(h),e=P(h);for(const n of s){if((a=(r=n.polygons)==null?void 0:r.featureSet)!=null&&a.features)for(const u of n.polygons.featureSet.features)S(o,u.geometry),g(e,o);if((i=(f=n.polylines)==null?void 0:f.featureSet)!=null&&i.features)for(const u of n.polylines.featureSet.features)S(o,u.geometry),g(e,o);if((l=(m=n.points)==null?void 0:m.featureSet)!=null&&l.features)for(const u of n.points.featureSet.features)S(o,u.geometry),g(e,o);if(n.mapImages)for(const u of n.mapImages)S(o,u.extent),g(e,o)}return O(e,h)?void 0:{xmin:e[0],ymin:e[1],zmin:e[2],xmax:e[3],ymax:e[4],zmax:e[5],spatialReference:v.WGS84}}export{U as S,W as b,A as d,K as g,b as j};
