import{o as Gt}from"./VertexArrayObject-lPxPk5E-.js";import{r as a}from"./tslib.es6-B3Jf3DVX.js";import{b as At,t as P,B as Vt,al as Lt}from"./Accessor-BLX9ikPh.js";import{m as h,a as $t,n as Ft,k as lt,aB as jt}from"./subclass-BZA_h8Db.js";import{o as V,n as Bt}from"./mathUtils-C4_ghTv4.js";import{f as zt,y as Nt}from"./screenUtils-_ZIvrt5o.js";import{n as U,c as ct,h as Y,s as Ht,A as Wt,C as qt,X as Ut}from"./mat4-GpOFENPA.js";import{e as I}from"./mat4f64-Dk4dwAN8.js";import{r as Yt,E as kt}from"./vec2-maR1OrZI.js";import{r as Xt}from"./vec2f64-miziP1SN.js";import{c as K,o as S,p as Kt,s as Z,H as L,R as dt,P as pt,Z as mt,X as Zt,g as J,r as ft,_ as gt,A as _t,K as Jt}from"./vec32-Dvg_eL9J.js";import{n as A}from"./vec3f64-BLpZdpfb.js";import{m as wt,L as vt,E as Q,a as F,x as yt,z as j}from"./vec42-YcqnINSP.js";import{r as Mt,n as k}from"./vec4f64-o2zAXfmz.js";import{H as Qt,N as te,L as ee}from"./frustum-CQrOepbv.js";import{b as ie}from"./sphere-C77djCO6.js";import{f as re}from"./plane-IENfwZlB.js";import{l as se}from"./ViewingMode-Dodu7ZZk.js";import{t as ne}from"./NestedMap-GuqgquCN.js";import{t as oe}from"./glUtil-D0YUa0ow.js";import{n as E}from"./Matrix3DrawUniform-CiBFaSz6.js";import{O as ae}from"./renderState-DQLu6AJX.js";import{K as he,A as xt}from"./Texture-Fac_8AOC.js";import{s as tt}from"./Util-BIfApRF5.js";let Ke=class extends Gt{};const ue={required:[]},Je={required:[E.Depth]};let Pt=class extends At{precompile(e){const i=this.acquireTechniques(e);return ce(i),i!=null}consumes(){return ue}get usedMemory(){return 0}get isDecoration(){return!1}get running(){return!1}modify(e){}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(e){}queryRenderOccludedState(e){return!1}};class le extends Pt{}let ti=class extends Pt{};function ce(t){Array.isArray(t)?t.forEach(e=>e==null?void 0:e.release()):t==null||t.release()}function de(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/e)}function pe(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/i)}function me(t,e,i){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}function fe(t,e,i){return 2*Math.atan(i*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}let ii=class{constructor(){this.adds=new P,this.removes=new P,this.updates=new P({allocator:e=>e||new ge,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},ge=class{},_e=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}};var Dt,p;function oi(t){const e=new Map,i=r=>{let s=e.get(r);return s||(s=new _e,e.set(r,s)),s};return t.removes.forAll(r=>{et(r)&&i(r.material).removes.push(r)}),t.adds.forAll(r=>{et(r)&&i(r.material).adds.push(r)}),t.updates.forAll(r=>{et(r.renderGeometry)&&i(r.renderGeometry.material).updates.push(r)}),e}function et(t){return t.geometry.indexCount>=1}(function(t){t[t.Default=0]="Default",t[t.Screenshot=1]="Screenshot",t[t.ObjectAndLayerID=2]="ObjectAndLayerID"})(Dt||(Dt={})),function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"}(p||(p={}));var ht;let o=ht=class extends At{constructor(t){super(t),this._ray=ie(),this._viewport=Mt(0,0,1,1),this._padding=Mt(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Xt(1,1e3),this._viewDirty=!0,this._viewMatrix=I(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=I(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=I(),this._frustumDirty=!0,this._frustum=Qt(),this._fullViewport=k(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=A(),this._up=A(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get rows(){return this._rows}set rows(t){this._rows=Math.max(1,t)}get columns(){return this._columns}set columns(t){this._columns=Math.max(1,t)}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return K(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){U(this._viewMatrix,t),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),S(A(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),S(A(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),S(A(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const t=wt(k(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&vt(t,e)?e:t}get screenPadding(){if(this.pixelRatio===1)return this._padding;const t=wt(k(),this._padding,1/this.pixelRatio),e=this._get("screenPadding");return e&&vt(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[p.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[p.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[p.RIGHT]+this._padding[p.LEFT]}set fullWidth(t){this.width=t-(this._padding[p.RIGHT]+this._padding[p.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[p.TOP]+this._padding[p.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[p.TOP]+this._padding[p.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[p.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[p.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){Q(this._padding,t)||(this._viewport[0]+=t[p.LEFT]-this._padding[p.LEFT],this._viewport[1]+=t[p.BOTTOM]-this._padding[p.BOTTOM],this._viewport[2]-=t[p.RIGHT]+t[p.LEFT]-(this._padding[p.RIGHT]+this._padding[p.LEFT]),this._viewport[3]-=t[p.TOP]+t[p.BOTTOM]-(this._padding[p.TOP]+this._padding[p.BOTTOM]),F(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(ct(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return Y(I(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||I()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return me(this._fov,this.width,this.height)}set fovX(t){this._fov=de(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return fe(this._fov,this.width,this.height)}set fovY(t){this._fov=pe(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return Kt(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Y(this._viewInverseTransposeMatrix,this.viewMatrix),Ht(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){const t=this.width,e=this.height,i=this.near*Math.tan(this.fovY/2)*2,r=i*this._aspect,s=i/this.rows,n=r/this.columns,u=-r/2+this.column*n,c=u+n,d=-i/2+this.row*s,m=d+s,_=Wt(I(),u*(1+2*this._padding[p.LEFT]/t),c*(1+2*this._padding[p.RIGHT]/t),d*(1+2*this._padding[p.BOTTOM]/e),m*(1+2*this._padding[p.TOP]/e),this.near,this.far),g=this._get("projectionMatrix");return g&&qt(g,_)?g:_}copyFrom(t){Z(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,F(this._viewport,t.viewport),this.notifyChange("_viewport"),F(this._padding,t.padding),this.notifyChange("_padding"),Yt(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.row=t.row,this.column=t.column,this.rows=t.rows,this.columns=t.columns,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(U(this._viewMatrix,t.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(te(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(U(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),F(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up,this.fov=t.fov}clone(){return new ht().copyFrom(this)}equals(t){return L(this.eye,t.eye)&&L(this.center,t.center)&&L(this.up,t.up)&&Q(this._viewport,t.viewport)&&Q(this._padding,t.padding)&&kt(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation&&this.row===t.row&&this.column===t.column&&this.rows===t.rows&&this.columns===t.columns}almostEquals(t){const e=Math.max(1,1/this.pixelRatio,1/t.pixelRatio);if(Math.abs(t.fov-this._fov)>=.001||yt(t.screenPadding,this.screenPadding)>=e||yt(this.screenViewport,t.screenViewport)>=e||this.row!==t.row||this.column!==t.column||this.rows!==t.rows||this.columns!==t.columns)return!1;dt(D,t.eye,t.center),dt(it,this.eye,this.center);const i=pt(D,it),r=mt(D),s=mt(it),n=5e-4;return i*i>=(1-1e-10)*r*s&&Zt(t.eye,this.eye)<Math.max(r,s)*n*n}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(re(this.viewForward,K(D,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=zt()){return t[0]=(this.padding[p.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[p.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,i=.5){return t[0]=this.padding[p.LEFT]+this.width*e,t[1]=this.padding[p.BOTTOM]+this.height*i,t[2]=.5,t}setGLViewport(t){const e=this.viewport,i=this.padding;t.setViewport(e[0]-i[3],e[1]-i[2],e[2]+i[1]+i[3],e[3]+i[0]+i[2])}applyProjection(t,e){t!==l&&Z(l,t),l[3]=1,j(l,l,this.projectionMatrix);const i=Math.abs(l[3]);J(l,l,1/i);const r=this.fullViewport;e[0]=V(0,r[0]+r[2],.5+.5*l[0]),e[1]=V(0,r[1]+r[3],.5+.5*l[1]),e[2]=.5*(l[2]+1),e[3]=i}unapplyProjection(t,e){const i=this.fullViewport;l[0]=(t[0]/(i[0]+i[2])*2-1)*t[3],l[1]=(t[1]/(i[1]+i[3])*2-1)*t[3],l[2]=(2*t[2]-1)*t[3],l[3]=t[3],this.inverseProjectionMatrix!=null&&(j(l,l,this.inverseProjectionMatrix),e[0]=l[0],e[1]=l[1],e[2]=l[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,rt),this.renderToScreen(rt,e),e}projectToRenderScreen(t,e){if(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=1,j(l,l,this.viewProjectionMatrix),l[3]===0)return null;const i=l;J(i,i,1/Math.abs(l[3]));const r=this.fullViewport,s=V(0,r[0]+r[2],.5+.5*i[0]),n=V(0,r[1]+r[3],.5+.5*i[1]);return"x"in e?(e.x=s,e.y=n):(e[0]=s,e[1]=n,e.length>2&&(e[2]=.5*(i[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,rt),e)}unprojectFromRenderScreen(t,e){if(ct(B,this.projectionMatrix,this.viewMatrix),!Y(B,B))return null;const i=this.fullViewport;return l[0]=2*(t[0]-i[0])/i[2]-1,l[1]=2*(t[1]-i[1])/i[3]-1,l[2]=2*t[2]-1,l[3]=1,j(l,l,B),l[3]===0?null:(e[0]=l[0]/l[3],e[1]=l[1]/l[3],e[2]=l[2]/l[3],e)}constrainWindowSize(t,e,i,r){const s=t*this.pixelRatio,n=e*this.pixelRatio,u=Math.max(s-i/2,0),c=Math.max(this.fullHeight-n-r/2,0),d=-Math.min(s-i/2,0),m=-Math.min(this.fullHeight-n-r/2,0),_=i-d- -Math.min(this.fullWidth-s-i/2,0),g=r-m- -Math.min(n-r/2,0);return[Math.round(u),Math.round(c),Math.round(_),Math.round(g)]}computeUp(t){t===se.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){const i=t[0]*this.pixelRatio,r=this.fullHeight-t[1]*this.pixelRatio;return e[0]=i,e[1]=r,e}renderToScreen(t,e){const i=t[0]/this.pixelRatio,r=(this.fullHeight-t[1])/this.pixelRatio;e[0]=i,e[1]=r}_computeUpGlobal(){K(D,this.center,this.eye);const t=ft(this.center);t<1?(S(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(pt(D,this.center))>.9999*ft(D)*t||(gt(this._up,D,this.center),gt(this._up,this._up,D),_t(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){Jt(D,this.eye,this.center),Math.abs(D[2])<=.9999&&(J(D,D,D[2]),S(this._up,-D[0],-D[1],1-D[2]),_t(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(t,e,i=""){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?L(t,e)||(Z(e,t),this._markViewDirty(),i.length&&this.notifyChange(i)):Ft.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(ee(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(Ut(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};a([h()],o.prototype,"_viewport",void 0),a([h()],o.prototype,"_padding",void 0),a([h()],o.prototype,"_fov",void 0),a([h()],o.prototype,"_nearFar",void 0),a([h()],o.prototype,"_viewDirty",void 0),a([h()],o.prototype,"_viewMatrix",void 0),a([h()],o.prototype,"_pixelRatio",void 0),a([h()],o.prototype,"pixelRatio",null),a([h()],o.prototype,"row",void 0),a([h()],o.prototype,"column",void 0),a([h()],o.prototype,"_rows",void 0),a([h()],o.prototype,"rows",null),a([h()],o.prototype,"_columns",void 0),a([h()],o.prototype,"columns",null),a([h()],o.prototype,"eye",null),a([h()],o.prototype,"center",null),a([h()],o.prototype,"_center",void 0),a([h()],o.prototype,"up",null),a([h()],o.prototype,"_up",void 0),a([h()],o.prototype,"viewMatrix",null),a([h({readOnly:!0})],o.prototype,"viewForward",null),a([h({readOnly:!0})],o.prototype,"viewUp",null),a([h({readOnly:!0})],o.prototype,"viewRight",null),a([h({readOnly:!0})],o.prototype,"nearFar",null),a([h()],o.prototype,"near",null),a([h()],o.prototype,"far",null),a([h()],o.prototype,"viewport",null),a([h({readOnly:!0})],o.prototype,"screenViewport",null),a([h({readOnly:!0})],o.prototype,"screenPadding",null),a([h()],o.prototype,"x",null),a([h()],o.prototype,"y",null),a([h()],o.prototype,"width",null),a([h()],o.prototype,"height",null),a([h()],o.prototype,"fullWidth",null),a([h()],o.prototype,"fullHeight",null),a([h({readOnly:!0})],o.prototype,"_aspect",null),a([h()],o.prototype,"padding",null),a([h({readOnly:!0})],o.prototype,"projectionMatrix",null),a([h({readOnly:!0})],o.prototype,"inverseProjectionMatrix",null),a([h()],o.prototype,"fov",null),a([h()],o.prototype,"fovX",null),a([h()],o.prototype,"fovY",null),a([h()],o.prototype,"viewInverseTransposeMatrix",null),a([h({readOnly:!0})],o.prototype,"_projectionMatrixInternal",null),a([h()],o.prototype,"relativeElevation",void 0),o=ht=a([$t("esri.views.3d.webgl.RenderCamera")],o);const ai=o,l=k(),B=I(),D=A(),it=A(),rt=Nt();let we=class{constructor(e,i){this._material=e,this._repository=i,this._map=new Map}dispose(){this._map.forEach((e,i)=>{e!=null&&this._repository.release(this._material,i)})}load(e,i,r){const s=this._material.produces.get(i);if(!(s!=null&&s(r)))return null;this._map.has(r)||this._map.set(r,this._repository.acquire(this._material,i,r));const n=this._map.get(r);if(n!=null){if(n.ensureResources(e)===ae.LOADED)return n;this._repository.requestRender()}return null}},ve=class extends he{constructor(e=A()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}};var Ot,$;(function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"})(Ot||(Ot={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}($||($={}));let ut=class{constructor(e=0,i=0){this.from=e,this.to=i}get numElements(){return this.to-this.from}};function Tt(t){const e=new Map;t.forAll(r=>e.set(r.from,r));let i=!0;for(;i;){i=!1;for(let r=0;r<t.length;++r){const s=t.data[r],n=e.get(s.to);if(!n)return;s.to=n.to,e.delete(n.from),t.removeUnordered(n),i=!0}}}class Ct extends ut{constructor(e,i,r){super(i,r),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}foreachHighlightGroup(e){this.isVisible&&this.geometry.foreachHighlightGroup(e)}get hasOccludees(){return this.geometry.occludees!=null}}class ye{constructor(){this.first=0,this.count=0}}class Me{constructor(){this._numElements=0,this._instances=new Map,this.holes=new P({allocator:e=>e||new ut,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightGroups=new Set,this.drawCommandsDefault=z(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=z(),this.drawCommandsShadowHighlightRest=z()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightGroups.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightGroups.clear()}updateIfDrawCommandsDirty(e){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const i of this.instances.values())this.updateDrawState(i);this.updateDrawCommands(e)}}addInstance(e,i){this.deleteInstance(e),this._instances.set(e,i),this._numElements+=i.numElements}deleteInstance(e){const i=this._instances.get(e);i&&(this._numElements-=i.numElements,this._instances.delete(e))}updateInstance(e,i,r){const s=this._instances.get(e);s&&(this._numElements-=s.numElements,s.from=i,s.to=r,this._numElements+=s.numElements)}updateDrawState(e){e.isVisible?(e.foreachHighlightGroup(i=>this.highlightGroups.add(i)),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlights.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;if(!this.needsMultipleCommands()){const s=this.drawCommandsDefault.pushNew(),n=this.holes.front();return this.vao!=null&&this.holes.length===1&&n.to===Math.floor(this.vao.byteSize/e)?(s.first=0,void(s.count=n.from)):(s.first=1/0,s.count=0,this._instances.forEach(u=>{s.first=Math.min(s.first,u.from),s.count=Math.max(s.count,u.to)}),void(s.count-=s.first))}const i=Array.from(this._instances.values()).sort((s,n)=>s.from===n.from?s.to-n.to:s.from-n.from),{drawCommandsHighlights:r}=this;for(const s of i)s.isVisible&&(st(s.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,s),s.hasHighlights?s.foreachHighlightGroup(n=>{let u=r.get(n);u||(u=z(),r.set(n,u)),st(u,s)}):st(this.drawCommandsShadowHighlightRest,s))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function xe(t){return t.vao!=null}function z(){return new P({allocator:t=>t||new ye,deallocator:t=>t})}function st(t,e){const i=t.back();if(i==null){const r=t.pushNew();return r.first=e.from,void(r.count=e.numElements)}if(De(i,e)){const r=e.from-i.first+e.numElements;i.count=r}else{const r=t.pushNew();r.first=e.from,r.count=e.numElements}}function De(t,e){return t.first+t.count>=e.from}class Oe{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(i=>i.instances.has(e))}}let nt=class extends le{get _hasAnyHighlight(){return this._highlightGroups.size>0}constructor(t){super(t),this._dataByOrigin=new Map,this._drawParameters=new ve,this._highlightGroups=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=Vt(this._glMaterials),this._dataByOrigin.forEach(t=>t.dispose()),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this.material.produces.forEach((t,e)=>{this._produces.set(e,i=>!(this._dataByOrigin.size===0||!(i!==E.Highlight&&i!==E.ShadowHighlight||this._hasAnyHighlight))&&t(i))})}initializeRenderContext(t,e){this._glMaterials=new we(this.material,e??t.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=t.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,oe(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(t){return this.material.queryRenderOccludedState(t)}get numGeometries(){let t=0;return this._dataByOrigin.forEach(e=>t+=e.buffers.reduce((i,r)=>i+r.instances.size,0)),t}get usedMemory(){let t=0;return this._dataByOrigin.forEach(e=>t+=e.buffers.reduce((i,r)=>i+r.vao.usedMemory,0)),t}forEachGeometry(t){this._dataByOrigin.forEach(e=>e.buffers.forEach(i=>i.instances.forEach(({geometry:r})=>t(r))))}modify(t){this._updateGeometries(t.updates),this._addAndRemoveGeometries(t.adds,t.removes),this._updateDrawCommands()}_updateGeometries(t){const e=this._bufferWriter;if(e==null)return;const i=e.vertexBufferLayout.stride/4;for(const r of t){const s=r.renderGeometry,n=this._dataByOrigin.get(s.localOrigin.id),u=n==null?void 0:n.findBuffer(s.id);if(u==null)return;const c=u.instances.get(s.id);if(r.updateType&($.GEOMETRY|$.TRANSFORMATION)){const d=q(e.elementCount(c.geometry.geometry.attributes)*i),m=e.vertexBufferLayout.createView(d.buffer);this._writeGeometry(s,m,0),u.vao.vertexBuffers.get("geometry").setSubData(d,c.from*i,0,c.numElements*i)}r.updateType&($.HIGHLIGHT|$.OCCLUDEE|$.VISIBILITY)&&(u.drawCommandsDirty=!0)}}_computeDeltas(t,e){const i=new ne;for(const r of t){const s=r.localOrigin;if(s==null)continue;let n=i.get(s.id,null);n==null&&(n=new bt(s.vec3),i.set(s.id,null,n)),n.changes.push(r)}for(const r of e){const s=r.localOrigin;if(s==null)continue;const n=this._dataByOrigin.get(s.id),u=n==null?void 0:n.findBuffer(r.id);if(u==null)continue;let c=i.get(s.id,u);c==null&&(c=new bt(s.vec3),i.set(s.id,u,c)),c.changes.push(r)}return i}_addAndRemoveGeometries(t,e){if(this._bufferWriter==null||this._vaoCache==null)return;const{_bufferWriter:i,_dataByOrigin:r}=this,s=i.vertexBufferLayout.stride/4,n=this._computeDeltas(t,e);n.forEach((u,c)=>{const d=u.get(null),m=(d==null?void 0:d.changes)??[];n.delete(c,null);let _=r.get(c);if(u.forEach((g,f)=>{if(n.delete(c,f),f==null)return void tt(!1,"No VAO for removed geometries");if(f.instances.size===g.changes.length)return this._vaoCache.deleteVao(f.vao),lt(_.buffers,f),void(_.buffers.length===0&&m.length===0&&r.delete(c));const w=f.numElements,y=f.vao.byteSize/4,v=m.reduce((T,C)=>T+i.elementCount(C.geometry.attributes),0),M=g.changes.reduce((T,C)=>T+i.elementCount(C.geometry.attributes),0),x=Math.min((w+v-M)*s,W),O=x>y;x>X&&x<y/2?(g.changes.forEach(({id:T})=>f.deleteInstance(T)),f.instances.forEach(({geometry:T})=>m.push(T)),this._vaoCache.deleteVao(f.vao),lt(_.buffers,f)):O?this._applyAndRebuild(f,m,g):this._applyRemoves(f,g)}),m.length>0)for(_==null&&(_=new Oe(d.origin),r.set(c,_)),_.buffers.forEach(g=>this._applyAdds(g,m));m.length>0;)_.buffers.push(this._applyAndRebuild(new Me,m,null))})}_updateDrawCommands(){this._highlightGroups.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach(t=>{t.buffers.forEach(e=>{e.updateIfDrawCommandsDirty(this._bufferWriter.vertexBufferLayout.stride),e.hasHighlights&&Lt(this._highlightGroups,e.highlightGroups),this._hasOccludees=this._hasOccludees||e.hasOccludees})})}_applyAndRebuild(t,e,i){if(i)for(const w of i.changes)t.deleteInstance(w.id);const r=this._bufferWriter,s=r.vertexBufferLayout.stride,n=s/4,u=Math.floor(W/n);let c=t.numElements;for(;e.length>0;){const w=e.pop(),y=r.elementCount(w.geometry.attributes);if(c+y>u&&c>0){e.push(w);break}c+=y;const v=new Ct(w,0,0);tt(t.instances.get(w.id)==null),t.addInstance(w.id,v)}const d=c*n,m=q(d),_=r.vertexBufferLayout.createView(m.buffer);let g=0;t.resetInstanceSummary(),t.instances.forEach((w,y)=>{this._writeGeometry(w.geometry,_,g);const v=g;g+=r.elementCount(w.geometry.geometry.attributes),t.updateInstance(y,v,g),t.updateDrawState(w)}),this._vaoCache.deleteVao(t.vao),t.vao=this._vaoCache.newVao(Et(d)),t.vao.vertexBuffers.get("geometry").setSubData(m,0,0,g*n),t.holes.clear();const f=t.holes.pushNew();return f.from=g,f.to=Math.floor(t.vao.byteSize/s),t.updateDrawCommands(s),t}_applyRemoves(t,e){if(e.changes.length===0||this._bufferWriter==null)return;for(const u of e.changes){const c=u.id,d=t.instances.get(c);if(!d)continue;t.deleteInstance(c);const m=R.back();if(m){if(m.to===d.from){m.to=d.to;continue}if(m.from===d.to){m.from=d.from;continue}}const _=R.pushNew();_.from=d.from,_.to=d.to}Tt(R);const i=this._bufferWriter.vertexBufferLayout.stride/4,r=R.reduce((u,c)=>Math.max(u,c.numElements),0)*i,s=q(r);s.fill(0,0,r);const n=t.vao.vertexBuffers.get("geometry");R.forAll(u=>n.setSubData(s,u.from*i,0,u.numElements*i)),t.holes.pushArray(R.data,R.length),R.forAll((u,c)=>R.data[c]=null),R.clear(),t.drawCommandsDirty=!0}_applyAdds(t,e){if(e.length===0||this._bufferWriter==null)return;if(!xe(t))return void this._applyAndRebuild(t,e,null);const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,s=t.numElements,n=e.reduce((M,x)=>M+i.elementCount(x.geometry.attributes),0),u=Math.min((s+n)*r,W),c=4*u;if(t.vao.byteSize<Et(W-X)&&c>t.vao.byteSize)return void this._applyAndRebuild(t,e,null);Tt(t.holes);const d=new Array;for(const M of e){const x=i.elementCount(M.geometry.attributes),O=Te(t.holes,x);d.push(O)}const m=t.vao.vertexBuffers.get("geometry");let _=0,g=0,f=0;const w=q(u),y=i.vertexBufferLayout.createView(w.buffer);e.forEach((M,x)=>{const O=d[x];if(O==null)return;if(f!==O){const b=f-g;b>0&&m.setSubData(w,g*r,0,b*r),g=O,_=0}const T=i.elementCount(M.geometry.attributes);this._writeGeometry(M,y,_),_+=T,f=O+T;const C=new Ct(M,O,O+T);tt(t.instances.get(M.id)==null),t.addInstance(M.id,C),t.drawCommandsDirty=!0});const v=f-g;v>0&&m.setSubData(w,g*r,0,v*r),jt(e,(M,x)=>d[x]==null)}_writeGeometry(t,e,i){this._bufferWriter!=null&&(U(H,t.transformation),H[12]-=t.localOrigin.vec3[0],H[13]-=t.localOrigin.vec3[1],H[14]-=t.localOrigin.vec3[2],Y(N,H),Ht(N,N),this._bufferWriter.write(H,N,t.geometry.attributes,t.geometry.objectAndLayerIdColor,e,i))}updateAnimation(t){return this.material.update(t)}acquireTechniques(t){var f;if(!this.material.shouldRender(t))return null;const{output:e,bind:i}=t,r=this.material.produces.get(i.slot);if(!(r!=null&&r(e)))return null;const{highlightGroupName:s,slot:n}=i,u=e===E.ShadowHighlight,c=e===E.Highlight,d=c||u,m=w=>d&&(this._highlightGroups.size===0||c&&!!s&&!w.has(s));if(m(this._highlightGroups))return null;const _=e===E.ShadowExcludeHighlight,g=!(d||_);for(const{buffers:w}of this._dataByOrigin.values())for(const y of w){if(m(y.highlightGroups))continue;const v=u?y.drawCommandsHighlights.size>0:d?s?y.drawCommandsHighlights.get(s):y.drawCommandsHighlights.size>0:((f=(_&&y.needsMultipleCommands()?y.drawCommandsShadowHighlightRest:y.drawCommandsDefault)||null)==null?void 0:f.length)??!1,M=g&&y.drawCommandsOccludees||null;if(v||M!=null&&M.length){const x=this._glMaterials.load(t.rctx,n,e),O=x==null?void 0:x.beginSlot(i);if(O)return O}}return null}render(t,e){const{output:i,bind:r}=t,{slot:s,highlightGroupName:n}=r,u=i===E.Highlight;if(u&&!n)return;const c=i===E.ShadowHighlight,d=u||c,m=i===E.ShadowExcludeHighlight,_=!(d||m),g=s===xt.OCCLUDER_MATERIAL||s===xt.TRANSPARENT_OCCLUDER_MATERIAL?s:null,{rctx:f}=t;f.runAppleAmdDriverHelper();const w=f.bindTechnique(e,r,this.material.parameters);for(const y of this._dataByOrigin.values())for(const v of y.buffers){if(u&&(!v.hasHighlights||!v.drawCommandsHighlights.has(n))||c&&!v.hasHighlights)continue;const M=()=>{const b=[];for(const G of v.drawCommandsHighlights.values())b.push(G);return b},x=d&&!c?v.drawCommandsHighlights.get(n)??null:null,O=c?M():d?x?[x]:It:(m&&v.needsMultipleCommands()?[v.drawCommandsShadowHighlightRest]:[v.drawCommandsDefault])||It,T=O.some(b=>b.length>0),C=_&&v.drawCommandsOccludees||null;if(T||C!=null&&C.length){if(this._drawParameters.origin=y.origin,w.bindDraw(r,this.material.parameters,this._drawParameters),e.ensureAttributeLocations(v.vao),f.bindVAO(v.vao),T)for(const b of O)f.setPipelineState(e.getPipeline(!1,g)),b.forAll(G=>f.drawArrays(e.primitiveType,G.first,G.count));C!=null&&C.length&&(f.setPipelineState(e.getPipeline(!0,g)),C.forAll(b=>f.drawArrays(e.primitiveType,b.first,b.count)))}}}get test(){}};a([h({constructOnly:!0})],nt.prototype,"material",void 0),nt=a([$t("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],nt);class bt{constructor(e){this.origin=e,this.changes=new Array}}function Te(t,e){const i=t.find(s=>s.numElements>=e);if(i==null)return null;const r=i.from;return i.from+=e,i.from>=i.to&&t.removeUnordered(i),r}const H=I(),N=I(),R=new P({allocator:t=>t||new ut,deallocator:null}),X=65536,ot=4*X,Rt=1024,St=16777216,W=St/4;let at=new Float32Array(X);function q(t){return at.length<t&&(at=new Float32Array(t)),at}function Et(t){const e=4*t;return e<=Rt?Rt:e<ot?Bt(e):Math.max(Math.min(Math.ceil(1.5*e/ot)*ot,St),e)}const It=[];export{Ot as E,$ as I,Et as V,ai as a,p as b,ce as c,Je as d,ue as e,Dt as f,ve as i,oi as n,ti as o,Ke as r,ii as s,we as t,le as u,nt as x};
