const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./MediaLayerInteraction-CTlQJGIT.js","./index-4eY77cms.js","./index-Cx51aysm.css","./Accessor-BmwT4B0c.js","./reactiveUtils-XM7cS2OP.js","./Evented-Dw4_VOGn.js","./SimpleObservable-CvOkykwM.js","./UpdatingHandles-CzJ4c3KT.js","./InputManager-DZ3jJnlx.js","./Queue-BQesTh_6.js","./signal-CySMLEX9.js"])))=>i.map(i=>d[i]);
import{_ as D}from"./index-4eY77cms.js";import{aV as z,aD as $,at as v,B as E,s as U,E as F,o as I,r as x,m as A,a as W}from"./Accessor-BmwT4B0c.js";import"./Graphic-Dt0LgVGU.js";import{d as l,p as Q,P as g,V as B,A as V,v as M}from"./reactiveUtils-XM7cS2OP.js";import{a as j,w as N,x as J}from"./Extent-g5W9hy0j.js";import{a as K}from"./Polyline-s-JzsQqo.js";import{j as X,m as P}from"./MediaElementView-BlY9eVB-.js";import"./SimpleRenderer-CEw_geZx.js";import"./TextSymbol-BLIQ6RKX.js";import"./colorUtils-DaPfwnk3.js";import"./defaultCIMValues-Bb-CUowV.js";import{d as R}from"./enums-BTM-fOHQ.js";import"./floatRGBA-Cb__GiDF.js";import"./Point-Cz2JYYmX.js";import"./definitions-CP59Y04S.js";import"./UpdateTracking2D-DnXhWMyK.js";import"./mathUtils-Cfq9PL9W.js";import"./GeometryUtils-F7QfOKlc.js";import"./CIMSymbolHelper-BDfNg_6w.js";import"./vec2f32-BbH2jxlN.js";import"./defaults-FkBa0ybj.js";import"./OverrideHelper-BItCoKFp.js";import"./EffectView-vElW3ESK.js";import"./Evented-Dw4_VOGn.js";import{e as Y}from"./DisplayObject-Dejv4A66.js";import"./View2D-CUfvXSSH.js";import"./DefaultVertexAttributeLayouts-wSIZdMhB.js";import{D as Z}from"./enums-D9v74xTE.js";import"./WGLContainer-CAGx_8nH.js";import{p as ee,w as G}from"./Texture-BVJ22uHh.js";import"./dataViewUtils-htlyuhrl.js";import"./StyleDefinition-C2Flw6Qv.js";import"./enums-BRzLM11V.js";import"./GridShader-CnyEHbwo.js";import"./cast-CsZslgGN.js";import"./pbf-BsmI3A9L.js";import"./TechniqueType-uMFRS8dR.js";import"./FramebufferObject-B01p0UGV.js";import"./FeatureCommandQueue-D2VPggrt.js";import"./Color-VJEMvW-n.js";import"./PieChartMeshWriter-CydCmunJ.js";import"./aaBoundingBox-Dw3yBk2f.js";import"./opacityUtils-Dim20wpZ.js";import"./renderState-Ci93M1-P.js";import"./glsl-BH37Aalp.js";import"./testSVGPremultipliedAlpha-BGpZOwI7.js";import"./GraphicsView2D-YaB3LUCn.js";import"./earcut-D9gy186-.js";import"./vec3f32-nZdmKIgz.js";import"./normalizeUtilsCommon-lGDszWRI.js";import"./UpdatingHandles-CzJ4c3KT.js";import"./projectBuffer-CQnuEMuP.js";import"./geodesicConstants-RQL9oKdk.js";import{p as te,r as ie}from"./TileStrategy-CtmYSAoK.js";import"./TileKey-DBTeo_j0.js";import{e as re}from"./mat3f64-BBpwCtoL.js";import{o as oe}from"./vec2-ChnYg_BJ.js";import{n as se}from"./vec2f64-Dy6m9Nrb.js";import{o as ne}from"./mediaLayerUtils-BJ-DU5EY.js";import{c as me}from"./utils-Bsjx6BTm.js";import{u as pe}from"./OverlayContainer-Covc2YOX.js";import{S as ae}from"./LayerView2D-mneyXHGR.js";import{y as le}from"./LayerView-DUZfYZew.js";import{s as he}from"./MediaLayerView-C_j0wKSM.js";import{g as de}from"./Scheduler-i_u8qdlN.js";import"./Clonable-Z-AWS-16.js";import"./JSONSupport-DcrLLGjL.js";import"./writer-DKgfqj4X.js";import"./enumeration-DpvDkLNI.js";import"./Promise-DfET-uns.js";import"./ActionToggle-D7439N1A.js";import"./Identifiable-BHVfzH03.js";import"./jsonUtils-CwFG8yN4.js";import"./typeUtils-B6WBEKDM.js";import"./collectionUtils-CTT-51g7.js";import"./Portal-CmmHxpLg.js";import"./screenUtils-_ZIvrt5o.js";import"./vec3f64-BLpZdpfb.js";import"./SimpleObservable-CvOkykwM.js";import"./mat3-CR8GKnhD.js";import"./common-DQOJ18NT.js";import"./vec32-Dvg_eL9J.js";import"./projection-CyCZAIaD.js";import"./normalizeUtilsSync-12EQcOVf.js";import"./commonProperties-ZfGquLPI.js";import"./colorRamps-CRjjPL3r.js";import"./SizeVariable-B-ghFm6e.js";import"./visualVariableUtils-Xcorldoo.js";import"./lengthUtils-_77UiyVF.js";import"./ColorStop-BYiAUa8d.js";import"./jsonUtils-B-voMz-i.js";import"./layerUtils-B__v9OBu.js";import"./defaultsJSON-GKolV7NZ.js";import"./vec42-YcqnINSP.js";import"./vec4f64-o2zAXfmz.js";import"./ReactiveMap-BHFEHYMj.js";import"./BidiEngine-QXap_35O.js";import"./fontUtils-CGi-tOxo.js";import"./OptimizedGeometry-BJqUA4Pi.js";import"./memoryEstimations-Bcyf-mHz.js";import"./utils-UPZJIDfz.js";import"./rasterizingUtils-C1EbvluX.js";import"./mat2d-D9DBP-jx.js";import"./mat2df32-orApM5a3.js";import"./Rect-CUzevAry.js";import"./BoundingBox-CnpCxTZE.js";import"./callExpressionWithFeature-Dty09cLj.js";import"./quantizationUtils-DgFbqZi7.js";import"./colorUtils-Rxh2V3ai.js";import"./jsonUtils-DZz5FrgB.js";import"./utils-DYurMneM.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-Fi6iAz29.js";import"./Viewpoint-DvyUmqUt.js";import"./Camera-CdyTfTAk.js";import"./Cyclical-Dlbl-cQK.js";import"./CollectionFlattener-U8hHQmGf.js";import"./workers-Cds_sd9m.js";import"./Queue-BQesTh_6.js";import"./intl-Duiy0OzY.js";import"./TileInfo-DxwC9WcY.js";import"./TileKey-DZd6gJy7.js";import"./DefaultUI-BwWVKFUS.js";import"./jsxFactory-Cnml7uXM.js";import"./uuid-Cl5lrJ4c.js";import"./InputManager-DZ3jJnlx.js";import"./signal-CySMLEX9.js";import"./Basemap-BZmrlnvW.js";import"./loadAll-D1eTJ7uv.js";import"./PortalItem-CTx1kJsR.js";import"./basemapDefinitions-D-Q7PKmu.js";import"./writeUtils-CcunaxF8.js";import"./groundInstanceUtils-Ben03ZCf.js";import"./editableLayers-CWgCazH-.js";import"./catalogUtils-CGCu8hgu.js";import"./basemapEnsureType-CmRtohu0.js";import"./basemapUtils-oMnqy94d.js";import"./TablesMixin-Bqfi1Ha_.js";import"./Layer-DH4_Pn8a.js";import"./TimeExtent-BO6BsF_x.js";import"./timeUtils-C1c_L2Fd.js";import"./GraphicsCollection-BJ5Nr2H8.js";import"./HeightModelInfo-C05IFsWs.js";import"./timeZoneUtils-DxzjpEBb.js";import"./Query-B_2mhyL4.js";import"./Field-BDG0QV_T.js";import"./fieldType-CBeoJWlv.js";import"./FullTextSearch-CBnxSwz4.js";import"./selectionUtils-DYi6daQO.js";import"./ViewEvents-c9mvQ_r3.js";import"./IViewEvents-Bci6PjlS.js";import"./interfaces-D6pIddIh.js";import"./screenUtils-BWEEmpSb.js";import"./HighlightDefaults-CumzVg9-.js";import"./a11yUtils-ClKbIIe-.js";import"./heightModelInfoUtils-D_x68P3s.js";import"./ViewingMode-Dodu7ZZk.js";import"./unitBezier-B1N-tmtC.js";import"./imageUtils-DsXKmbqJ.js";import"./capabilities-DwlKKScG.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-vQlnDsEX.js";import"./accessibleHandler-BaA3O97p.js";import"./CompassViewModel-DBhnIkQP.js";import"./GoTo-zPv0y7kC.js";import"./ZoomViewModel-Bua4WqEj.js";import"./viewpointUtils-CtXMVquh.js";import"./mat2df64-CBKYtunK.js";import"./normalizeUtils-BTGdXlpz.js";import"./utils-YowqfOgk.js";import"./utils-B-dlKIhi.js";import"./Tile-DxjvolLp.js";import"./quickselect-QQC62dOK.js";import"./utils-BjSXFjBJ.js";import"./Version-Cd3TlGH0.js";import"./VertexElementDescriptor-BLyltQyJ.js";import"./WGLBrushVTLSymbol-CmI_2XQu.js";import"./BufferObject-BJilD_hc.js";import"./config-BOD8--da.js";import"./ShaderCompiler-G2XYGDs6.js";import"./ProgramTemplate-BpBqJqy1.js";import"./Program-C5Xq9SwE.js";import"./Container-CQ-TKdBu.js";import"./featureConversionUtils-CvnFcmH_.js";import"./OptimizedFeature-P2towpqD.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./getDataTypeBytes-BTGR5GyG.js";import"./GraphShaderModule--vK3Hbk2.js";import"./ShaderBuilder-BKul5qh8.js";import"./BindType-BBwFZqyN.js";import"./CircularArray-CujHzHWW.js";import"./FeatureMetadata-Bu8jYZ4s.js";import"./diffUtils-BanfihCO.js";import"./queryUtils-DBEPdow2.js";import"./json-Wa8cmqdu.js";import"./timeSupport-C7DiFkF_.js";import"./FieldsIndex-FW1AMU67.js";import"./TimeOnly-CveCl9ie.js";import"./labelFormatUtils-F9rkrs4Y.js";import"./labelUtils-DCpQ7n-8.js";import"./ZoomMomentumEstimator-BDiG9U4W.js";import"./heatmapTextureUtils-C_5TPY_E.js";import"./streamLayerUtils-CKwt2uXH.js";import"./QueueProcessor-BzFcKfHF.js";import"./libtess-Dhf_mjs_.js";import"./utils-BGwKYX33.js";import"./basicInterfaces-CZwQPxTp.js";import"./dehydratedFeatures-kwLHUA1D.js";import"./ScheduledQueueProcessor-U8WIIyj8.js";import"./grouping-CyFLmhwA.js";import"./utils-ehcGqGxa.js";import"./utils-BQBvadb7.js";import"./ClipRect-0Tl6AMAT.js";import"./layerViewUtils-Bevty3Jm.js";import"./debugFlags-B1LM_Apo.js";const H=[1,1],d=re(),ce={none:R.None,loop:R.Loop,oscillate:R.Oscillate};function ue(e){return e?{type:"CIMAnimatedSymbolProperties",...e,playAnimation:e.playing,repeatType:e.repeatType?ce[e.repeatType]:void 0}:{type:"CIMAnimatedSymbolProperties"}}class fe extends Y{constructor(t){super(),this.elementView=t,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=se(),this._handles=new z,this._vertices=new Float32Array(8),this._indices=new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]),this._handles.add([l(()=>this.elementView.element.opacity,i=>this.opacity=i,g),l(()=>[this.elementView.coords],()=>{this.requestRender()},g),l(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this._handles.remove("play"),this.texture=$(this.texture),this.requestRender()},g),Q(()=>this.elementView.element.loaded,()=>{const i=this.elementView.element;this.ready(),ne(i)&&i.content!=null&&(this._handles.add([v(i.content,"play",()=>this.requestRender()),v(i.content,"loadeddata",()=>this.requestRender()),v(i.content,"loaded",()=>this.requestRender())]),"requestVideoFrameCallback"in i.content?i.content.requestVideoFrameCallback(()=>this.requestRender()):this._handles.add([v(i.content,"seeked",()=>this.requestRender())]),this.requestRender())},g)]),t.element.load().catch(i=>{E.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new U("element-load-error","Element cannot be displayed",{element:t,error:i}))})}getMesh(t){throw new Error("Method not implemented.")}destroy(){this._handles.destroy(),this.texture=$(this.texture)}get textureSize(){return H}get dvsMat3(){return this.parent.dvsMat3}beforeRender(t){const{context:i}=t,r=this.elementView.element.content;if(r!=null){const o=r instanceof HTMLImageElement,n=r instanceof HTMLVideoElement,p=o?r.naturalWidth:n?r.videoWidth:r.width,s=o?r.naturalHeight:n?r.videoHeight:r.height;if(this._updatePerspectiveTransform(p,s),this.texture)n&&(this.texture.setData(r),this.texture.generateMipmap(),"requestVideoFrameCallback"in r?r.requestVideoFrameCallback(()=>this.requestRender()):r.paused||this.requestRender());else{const m=new ee;if(m.wrapMode=Z.CLAMP_TO_EDGE,m.preMultiplyAlpha=!0,m.width=p,m.height=s,"getFrame"in r){const f=h=>{this.texture?this.texture.setData(h):this.texture=new G(i,m,h),this.requestRender()};"animationOptions"in this.elementView.element&&this._handles.add(me(r,ue(this.elementView.element.animationOptions),null,f),"play")}else this.texture=new G(i,m,r);this.texture.generateMipmap(),n&&("requestVideoFrameCallback"in r?r.requestVideoFrameCallback(()=>this.requestRender()):r.paused||this.requestRender())}}super.beforeRender(t)}_createTransforms(){return null}draw(t,i){this.isReady&&this.texture!=null?i.render(t,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:H,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._indices}):this.requestRender()}updateDrawCoords(t,i,r,o){const{coords:n,bounds:p}=this.elementView;if(n==null||p==null)return;const[s,m,f,h]=n.rings[0],k=this._vertices,{x:y,y:_}=t;k.set([m[0]-y,m[1]-_,s[0]-y,s[1]-_,f[0]-y,f[1]-_,h[0]-y,h[1]-_]);let w=i;if(o){const[q,,T]=p,{worldWidth:S,xBounds:O}=o,[b,C]=O;q<b&&T>b?w=S:T>C&&q<C&&(w=-S)}this.wrapAroundShift=w,this.isWrapAround=w!==0}_updatePerspectiveTransform(t,i){const r=this._vertices;X(d,[0,0,t,0,0,i,t,i],[r[0],r[1],r[4],r[5],r[2],r[3],r[6],r[7]]),oe(this.perspectiveTransform,d[6]/d[8]*t,d[7]/d[8]*i)}}let u=class extends ae(he(le)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this._interaction=null,this.layer=null,this.elements=new B}initialize(){this.addHandles([l(()=>[this.interactive,this.suspended],async()=>{if(this.interactive&&!this._interaction){const{MediaLayerInteraction:e}=await D(()=>import("./MediaLayerInteraction-CTlQJGIT.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10]),import.meta.url);this._interaction=new e({view:this.view,layer:this.layer}),this.selectedElement!==this._interaction.selectedElement&&(this._interaction.selectedElement=this.selectedElement),this.interactionOptions!==this._interaction.options&&(this._interaction.options=this.interactionOptions)}this._interaction&&(this._interaction.enabled=!this.suspended&&this.interactive)},V),l(()=>this.interactionOptions,e=>{this._interaction&&(this._interaction.options=e)},V),l(()=>this.selectedElement,e=>{this._interaction&&(this._interaction.selectedElement=e)},V)])}attach(){this.addAttachHandles([M(()=>this.layer.effectiveSource,"refresh",()=>{this._tileStrategy.refresh(e=>this._updateTile(e)),this.requestUpdate()}),M(()=>this.layer.effectiveSource,"change",({element:e})=>this._elementUpdateHandler(e))]),this._overlayContainer=new pe,this.container.addChild(this._overlayContainer),this._fetchQueue=new te({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t),scheduler:this.scheduler,priority:de.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new ie({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){var e;this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),(e=this._debugGraphicsView)==null||e.destroy()}supportsSpatialReference(e){return!0}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(e){var t;this._tileStrategy.update(e),(t=this._debugGraphicsView)==null||t.update(e)}async hitTest(e,t){const i=[],r=e.normalize(),o=[r.x,r.y];for(const{elementView:{normalizedCoords:n,element:p}}of this._elementReferences.values())n!=null&&j(n.rings,o)&&i.push({type:"media",element:p,layer:this.layer,mapPoint:e,sourcePoint:p.toSource(e)});return i.reverse()}canResume(){return this.layer.source!=null&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh(e=>this._updateTile(e))}_acquireTile(e){const t=new ye(e.clone());return this._updateTile(t),t}_updateTile(e){this._updatingHandles.addPromise(this._fetchQueue.push(e.key).then(t=>{const[i,r]=e.setElements(t);this._referenceElements(e,i),this._dereferenceElements(e,r),this.requestUpdate()},t=>{F(t)||E.getLogger(this).error(t)}))}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._dereferenceElements(e,e.elements),this.requestUpdate()}async _queryElements(e,t){const i=this.layer.effectiveSource;if(i==null)return[];this.view.featuresTilingScheme.getTileBounds(a,e,!0);const r=new N({xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:this.view.spatialReference});return i.queryElements(r,t)}_referenceElements(e,t){if(this.layer.source!=null)for(const i of t)this._referenceElement(e,i)}_referenceElement(e,t){I(this._elementReferences,t.uid,()=>{const i=new P({element:t,spatialReference:this.view.spatialReference}),r=new fe(i);return this._overlayContainer.addChild(r),this.elements.add(t),this._updatingHandles.addPromise(t.load().catch(o=>{E.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new U("element-load-error","Element cannot be displayed",{element:t,error:o}))})),{debugGraphic:null,elementView:i,overlay:r,tiles:new Set}}).tiles.add(e)}_dereferenceElements(e,t){for(const i of t)this._dereferenceElement(e,i)}_dereferenceElement(e,t){var r;const i=this._elementReferences.get(t.uid);i.tiles.delete(e),i.tiles.size||(this._overlayContainer.removeChild(i.overlay),i.overlay.destroy(),i.elementView.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),(r=this._debugGraphicsView)==null||r.graphics.remove(i.debugGraphic))}_elementUpdateHandler(e){var r;let t=this._elementReferences.get(e.uid);if(t){const o=t.elementView.normalizedCoords;if(o==null)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.elementView.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),void((r=this._debugGraphicsView)==null?void 0:r.graphics.remove(t.debugGraphic));const n=[],p=[];for(const s of this._tileStrategy.tiles){const m=L(this.view.featuresTilingScheme,s,o);t.tiles.has(s)?m||p.push(s):m&&n.push(s)}for(const s of n)this._referenceElement(s,e);for(const s of p)this._dereferenceElement(s,e);return t=this._elementReferences.get(e.uid),void((t==null?void 0:t.debugGraphic)&&(t.debugGraphic.geometry=t.elementView.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:"geometry"})))}const i=new P({element:e,spatialReference:this.view.spatialReference}).normalizedCoords;if(i!=null)for(const o of this._tileStrategy.tiles)L(this.view.featuresTilingScheme,o,i)&&this._referenceElement(o,e)}};x([A()],u.prototype,"layer",void 0),x([A({readOnly:!0})],u.prototype,"elements",void 0),u=x([W("esri.views.2d.layers.MediaLayerView2D")],u);const a=K(),c={xmin:0,ymin:0,xmax:0,ymax:0};function L(e,t,i){return e.getTileBounds(a,t.key,!0),c.xmin=a[0],c.ymin=a[1],c.xmax=a[2],c.ymax=a[3],J(c,i)}class ye{constructor(t){this.key=t,this.elements=null,this.isReady=!1,this.visible=!0}setElements(t){const i=[],r=new Set(this.elements);this.elements=t;for(const o of t)r.has(o)?r.delete(o):i.push(o);return this.isReady=!0,[i,Array.from(r)]}destroy(){}}const _o=u;export{_o as default};
