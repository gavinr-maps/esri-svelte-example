import{r as l}from"./tslib.es6-B3Jf3DVX.js";import{b as y,s as u,L as g,h as v}from"./Accessor-BLX9ikPh.js";import{d as _}from"./asyncUtils-CWX51uTe.js";import{b as w,j as T,m as n,a as R}from"./subclass-BZA_h8Db.js";import{a4 as k,j as b}from"./Point-Cg0-ChZE.js";import{N as x,K as F}from"./projection-B971H0Re.js";import{i as S,e as j,h as E}from"./progressUtils-DPI25tXa.js";import{o as P}from"./infoFor3D-C0hFfS1m.js";import"./cast-Bjksrh93.js";import"./writer-DNAwXnhG.js";import"./assets-C43MgM-v.js";import"./index-Bh2oEzTI.js";import"./jsonMap-0cxwUWs2.js";import"./SimpleObservable-KocWTzVy.js";import"./vec3f64-BLpZdpfb.js";import"./Extent-Bf3YTe7m.js";import"./Polyline-D9YkgmM_.js";import"./mathUtils-C4_ghTv4.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";let a=class extends y{constructor(){super({}),this.files=[],this.progress=0,this._uploadTask=null,this._layer=null}destroy(){this.cancel(),this.files=[],this._layer=null,this._uploadTask=null}get state(){const e=this._uploadTask;return e&&this.files.length!==0?e.finished?e.error?"error":"success":"pending":"default"}get result(){var e;return((e=this._uploadTask)==null?void 0:e.value)??null}get error(){var e;return((e=this._uploadTask)==null?void 0:e.error)??null}uploadTo(e){this.cancel(),this.files=[],this._layer=e,this._uploadTask=_(async r=>{var d;const i=await z(e);u(r),this.progress=0,this.files=i;const t=S(j.upload,f=>{this.progress=f},"Upload.uploadTo");if(i.length===0)return null;u(r);const s=await e.extractAndFilterFiles(i);u(r),s.length>0&&(this.files=s);const o=await e.convertMesh(s,{signal:r,onProgress:t.makeOnProgress("createFromFiles")});if(u(r),!o)throw new w("editor:upload","could not upload or convert model");const p=s.reduce((f,h)=>f+h.size,0),m=t.simulate("loadMesh",E(p));try{await o.load()}finally{m.remove()}if(T("enable-feature:georeferenced-uploads")&&o.metadata.georeferenced){if(await k(e.spatialReference,(d=o.origin)==null?void 0:d.spatialReference))return{type:"georeferenced",mesh:o};if((e.spatialReference.isWebMercator||e.spatialReference.isWGS84)&&await M(o,e.spatialReference))return{type:"georeferenced-reprojected",mesh:o}}return o.spatialReference=e.spatialReference,o.vertexSpace.origin=[0,0,0],{type:"non-georeferenced",mesh:o}})}retry(){this._layer&&this.uploadTo(this._layer)}cancel(){var e;(e=this._uploadTask)==null||e.abort()}};l([n()],a.prototype,"files",void 0),l([n()],a.prototype,"progress",void 0),l([n()],a.prototype,"state",null),l([n()],a.prototype,"result",null),l([n()],a.prototype,"error",null),l([n()],a.prototype,"_uploadTask",void 0),l([n()],a.prototype,"_layer",void 0),a=l([R("esri.widgets.Editor.Upload")],a);let c=null;async function z(e){const{resolve:r,promise:i}=g(),t=document.createElement("input");t.type="file",t.multiple=!1,t.accept=[...P(e.infoFor3D),".zip"].join(","),t.style.display="none",document.body.appendChild(t);const s=v(t,"change",()=>r(t.files?Array.from(t.files):[]));return c?c(t):t.click(),i.finally(()=>{s.remove(),t.remove()})}function $(e,r){c=i=>{r==null||r(),Promise.resolve().then(()=>e).then(t=>{if(!c)return;const s=new DataTransfer;t.forEach(o=>s.items.add(o)),i.files=s.files,i.dispatchEvent(new Event("change"))})}}function ee(){c=null}async function M(e,r){if(await x(e.spatialReference,r),!e.vertexSpace.origin)return!1;const[i,t,s]=e.vertexSpace.origin,o=new b({x:i,y:t,z:s,spatialReference:e.spatialReference}),p=F(o,r);return!!p&&(e.vertexSpace.origin=[p.x,p.y,p.z??0],e.spatialReference=r,!0)}export{a as Upload,ee as clearPromptForFilesStub,$ as stubFilePickerToSelect};
