import{r as g,m as S,a as ce,e as et,a0 as tt,aD as be,o as it,N as Se,i as rt,G as ye,E as st,B as Z,az as ot,D as xe,as as nt}from"./Accessor-BmwT4B0c.js";import{b as Qe}from"./Graphic-Dt0LgVGU.js";import{P as x,d as at,C as lt,_ as dt,e as ht}from"./reactiveUtils-XM7cS2OP.js";import{i as Pe}from"./memoryEstimations-Bcyf-mHz.js";import{u as ut}from"./screenUtils-_ZIvrt5o.js";import{P as R,o as ve,c as we,r as pt,g as ct,y as mt,j as gt,s as _t}from"./vec32-Dvg_eL9J.js";import{t as ft}from"./vec3f32-nZdmKIgz.js";import{u as H,_ as Te,j as bt,J as ue,R as Ne,V as St,f as yt,C as xt}from"./aaBoundingBox-Dw3yBk2f.js";import{M as Ue,C as Pt}from"./plane-CpXmOyqq.js";import{a as vt,p as wt}from"./Field-BDG0QV_T.js";import{N as $e}from"./opacityUtils-Dim20wpZ.js";import{i as Nt,g as $t}from"./Scheduler-i_u8qdlN.js";import{b as zt}from"./Query-B_2mhyL4.js";import{h as Rt}from"./elevationInfoUtils-D26wVF2d.js";import{l as At}from"./LayerView3D-BJ3u1Cu5.js";import{t as It,x as Ct}from"./LineCallout.glsl-BQyjm-mE.js";import{h as Ot}from"./WorkerHandle-CKOgUZ7i.js";import{s as Mt,a as Et}from"./I3SUtil-BD55sujO.js";import{a as Ft}from"./spatialReferenceEllipsoidUtils-DBqQpPRa.js";import{n as F}from"./vec3f64-BLpZdpfb.js";import{s as Lt}from"./vec42-YcqnINSP.js";import{S as kt}from"./sphere-Cin5efBj.js";import{s as Dt}from"./intersectorUtilsConversions-CiJ6bOx7.js";import{j as Vt,af as qt,v as Ht,P as Wt,B as Bt,m as Qt,t as Tt,a0 as Ut,a1 as Gt,E as jt,A as ee}from"./FloatArray-BQXWSSJh.js";import{u as Ge,t as Jt,a as ze,n as T,S as te}from"./Matrix3PassUniform-uCCQMnlP.js";import{u as Kt}from"./RenderPlugin-CTXypYLE.js";import{O as Yt}from"./Material-C_-mgXN8.js";import{R as Xt}from"./Intersector-tBiZcjSu.js";import{i as Zt,e as B}from"./intersectorUtils-BNnvTT1E.js";import{r as ei}from"./VertexArrayObject-vYejmVPr.js";import{e as G}from"./VertexAttribute-Cq4MnHjR.js";import{_ as ti}from"./index-4eY77cms.js";import{f as ii,O as ri,E as Re,F as Ae,C as Ie}from"./enums-D9v74xTE.js";import{B as si,g as oi,p as ni}from"./renderState-Ci93M1-P.js";import{i as Q}from"./ShaderTechniqueConfiguration-D4dZMCXS.js";import{E as Ce}from"./BufferObject-BJilD_hc.js";import{t as Oe}from"./VertexElementDescriptor-BLyltQyJ.js";import{c as ai,u as li,a as di}from"./PointCloudWorkerUtil-d-sDeJid.js";import{s as ie,e as hi}from"./highlightUtils-CENYWDnQ.js";import{i as ui}from"./PopupSceneLayerView-DOs4Ybu9.js";import{x as pi}from"./hitTest-Dmi1EcVX.js";import{A as Me,t as ci}from"./ShadowCastAccumulate.glsl-DMni1gLj.js";import{I as re}from"./orientedBoundingBox-B17G_yFO.js";import{y as mi}from"./LayerView-DUZfYZew.js";import{c as gi}from"./HighlightDefaults-CumzVg9-.js";import{r as _i}from"./layerViewUtils-Bevty3Jm.js";import{q as M}from"./mathUtils-Cfq9PL9W.js";import{c as fi,q as bi}from"./mat4-Fi6iAz29.js";import{e as Si}from"./mat4f64-Dk4dwAN8.js";import{o as se}from"./vec2-ChnYg_BJ.js";import{n as yi}from"./vec2f64-Dy6m9Nrb.js";import{n as E}from"./glsl-BH37Aalp.js";import"./BindType-BBwFZqyN.js";import{i as xi}from"./ShaderBuilder-BKul5qh8.js";import{t as Pi}from"./RgbaFloatEncoding.glsl-_io2eW3M.js";import{a as Ee}from"./SceneLighting-BuSMIzqo.js";import{e as vi}from"./Float2PassUniform-x4sHx2JD.js";import{c as wi}from"./NoParameters-t-PuNrgq.js";import"./Clonable-Z-AWS-16.js";import"./JSONSupport-DcrLLGjL.js";import"./cast-CsZslgGN.js";import"./writer-DKgfqj4X.js";import"./enumeration-DpvDkLNI.js";import"./Promise-DfET-uns.js";import"./Color-VJEMvW-n.js";import"./colorUtils-Rxh2V3ai.js";import"./ActionToggle-D7439N1A.js";import"./Identifiable-BHVfzH03.js";import"./jsonUtils-CwFG8yN4.js";import"./Extent-g5W9hy0j.js";import"./Point-Cz2JYYmX.js";import"./Polyline-s-JzsQqo.js";import"./typeUtils-B6WBEKDM.js";import"./TextSymbol-BLIQ6RKX.js";import"./collectionUtils-CTT-51g7.js";import"./Portal-CmmHxpLg.js";import"./Evented-Dw4_VOGn.js";import"./SimpleObservable-CvOkykwM.js";import"./common-DQOJ18NT.js";import"./mat3f64-BBpwCtoL.js";import"./quatf64-CCm9z-pX.js";import"./vec4f64-o2zAXfmz.js";import"./mathUtils-BgCEaV43.js";import"./fieldType-CBeoJWlv.js";import"./signal-CySMLEX9.js";import"./debugFlags-B1LM_Apo.js";import"./FullTextSearch-CBnxSwz4.js";import"./TimeExtent-BO6BsF_x.js";import"./timeUtils-C1c_L2Fd.js";import"./unitConversionUtils-rg07EgOm.js";import"./lengthUtils-_77UiyVF.js";import"./heightModelInfoUtils-D_x68P3s.js";import"./HeightModelInfo-C05IFsWs.js";import"./visualVariableUtils-Xcorldoo.js";import"./computeTranslationToOriginAndRotation-DYUrDrjE.js";import"./projectBuffer-CQnuEMuP.js";import"./geodesicConstants-RQL9oKdk.js";import"./ElevationContext-BJejROd5.js";import"./dehydratedFeatureUtils-1rrRm6hF.js";import"./ElevationProvider-aS5xrHHy.js";import"./hydratedFeatures-CNHxsqRS.js";import"./projectVectorToVector-CCOy_B5J.js";import"./projectPointToVector-BoxjK-qy.js";import"./projection-CyCZAIaD.js";import"./Indices-D8XWalpO.js";import"./triangle-B1tKFm7z.js";import"./lineSegment-v806maA5.js";import"./basicInterfaces-CZwQPxTp.js";import"./graphicUtils-BFGMMQ1R.js";import"./meshVertexSpaceUtils-AgAbm20L.js";import"./MeshLocalVertexSpace-CnHk-qPr.js";import"./RibbonLine.glsl-DwJpAQ1c.js";import"./InterleavedLayout-_dYEAUNK.js";import"./BufferView-0osDbyWD.js";import"./types-D0PSWh4d.js";import"./sdfPrimitives-DBgFWIDT.js";import"./doublePrecisionUtils-B0owpBza.js";import"./floatRGBA-Cb__GiDF.js";import"./Octree-CmoRJhci.js";import"./Texture-BVJ22uHh.js";import"./getDataTypeBytes-BTGR5GyG.js";import"./Attribute-DGhdp5lO.js";import"./vec2f32-BbH2jxlN.js";import"./DefaultBufferWriter-CqCDaNCZ.js";import"./projectBoundingRect-C2OcwCLZ.js";import"./dehydratedFeatures-kwLHUA1D.js";import"./quantizationUtils-DgFbqZi7.js";import"./featureConversionUtils-CvnFcmH_.js";import"./OptimizedFeature-P2towpqD.js";import"./OptimizedGeometry-BJqUA4Pi.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./edgeUtils-D0U-z06n.js";import"./NormalAttribute.glsl-0GHNIsQf.js";import"./Float4DrawUniform-Db0CLl_z.js";import"./Matrix3DrawUniform-DD7AqlIc.js";import"./ViewingMode-Dodu7ZZk.js";import"./webStyleAcceptedFormats-CG7ZQ6BV.js";import"./GeometryUtil-D-PMXorz.js";import"./RealisticTree.glsl-PW_KtBDJ.js";import"./Intersector-zrebwyaY.js";import"./DefaultMaterial-GRoe8HM5.js";import"./GLTextureMaterial-96UpbkjC.js";import"./verticalOffsetUtils-BFnFdbst.js";import"./mat3-CR8GKnhD.js";import"./VertexColor.glsl-D3WyDYIi.js";import"./Matrix4PassUniform-COGIPIq4.js";import"./VerticalOffset.glsl-CsMbbWIx.js";import"./Matrix4sPassUniform-SKhQ1xSr.js";import"./BooleanBindUniform-BgD_OP8i.js";import"./CameraSpace.glsl-g9iLbhnR.js";import"./boundedPlane-DuGhiiFM.js";import"./HUDRenderStyle-BhGvVxgm.js";import"./HUDVisibility.glsl-DuFScu5i.js";import"./workers-Cds_sd9m.js";import"./Queue-BQesTh_6.js";import"./intl-Duiy0OzY.js";import"./I3SBinaryReader-DxrJbUZw.js";import"./requestImageUtils-DWgRKL5q.js";import"./TextureFormat-1mYWTFa-.js";import"./PointCloudUniqueValueRenderer-DcQF_3qx.js";import"./RendererLegendOptions-CYAPr8D6.js";import"./ColorStop-BYiAUa8d.js";import"./popupUtils-CY6-CisY.js";import"./LayerConstants-B33OP6sh.js";import"./layerUtils-B__v9OBu.js";import"./Camera-CdyTfTAk.js";import"./Cyclical-Dlbl-cQK.js";import"./Viewpoint-DvyUmqUt.js";import"./jsxFactory-Cnml7uXM.js";import"./uuid-Cl5lrJ4c.js";import"./GraphicsCollection-BJ5Nr2H8.js";import"./RenderCoordsHelper-DA-pMWeR.js";import"./projectVectorToPoint-DEm8-dt4.js";import"./scaleUtils-DPfHG2g0.js";import"./DefaultUI-BwWVKFUS.js";import"./UpdatingHandles-CzJ4c3KT.js";import"./InputManager-DZ3jJnlx.js";import"./Basemap-BZmrlnvW.js";import"./loadAll-D1eTJ7uv.js";import"./PortalItem-CTx1kJsR.js";import"./basemapDefinitions-D-Q7PKmu.js";import"./writeUtils-CcunaxF8.js";import"./groundInstanceUtils-Ben03ZCf.js";import"./CollectionFlattener-U8hHQmGf.js";import"./editableLayers-CWgCazH-.js";import"./catalogUtils-CGCu8hgu.js";import"./basemapEnsureType-CmRtohu0.js";import"./basemapUtils-oMnqy94d.js";import"./utils-DYurMneM.js";import"./mat4f32-DcsiF_Rp.js";import"./TablesMixin-Bqfi1Ha_.js";import"./Layer-DH4_Pn8a.js";import"./timeZoneUtils-DxzjpEBb.js";import"./ReactiveMap-BHFEHYMj.js";import"./selectionUtils-DYi6daQO.js";import"./ViewEvents-c9mvQ_r3.js";import"./IViewEvents-Bci6PjlS.js";import"./interfaces-D6pIddIh.js";import"./screenUtils-BWEEmpSb.js";import"./a11yUtils-ClKbIIe-.js";import"./unitBezier-B1N-tmtC.js";import"./imageUtils-DsXKmbqJ.js";import"./capabilities-DwlKKScG.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-vQlnDsEX.js";import"./accessibleHandler-BaA3O97p.js";import"./CompassViewModel-DBhnIkQP.js";import"./GoTo-zPv0y7kC.js";import"./ZoomViewModel-Bua4WqEj.js";import"./NormalUtils.glsl-W-nmUbAv.js";import"./earcut-D9gy186-.js";import"./vec3-BXNNVgyU.js";import"./SnappingCandidate-DGkpYqI6.js";import"./triangulationUtils-Cu97ljqy.js";import"./deduplicate-Cp1WDW0w.js";import"./OverlayCompositing.glsl-CUa8aMAb.js";import"./GridLocalOriginFactory-CngFIYNp.js";import"./RenderCamera-CDB-KFBK.js";import"./axisAngleDegrees-DdLZENJj.js";import"./quat-CP7JhygC.js";import"./weather-zOic7P_q.js";import"./NestedMap-GuqgquCN.js";import"./Normals-D6WqMXVD.js";import"./fontUtils-CGi-tOxo.js";import"./cameraUtils-Cg-qbPDO.js";import"./earthUtils-8WLQbUUl.js";import"./spatialReferenceSupport-DfixDcu7.js";import"./ElevationSamplerData-UywXoG8C.js";import"./terrainUtils-CgFk6NLH.js";import"./TileInfo-DxwC9WcY.js";import"./TileKey-DZd6gJy7.js";import"./FramebufferObject-B01p0UGV.js";import"./glUtil-CAJRmga-.js";import"./ShadowCastVisualizeTechniqueConfiguration-vN_a9xco.js";import"./SunCalc-uwgdo0BB.js";import"./VirtualLighting-CdhwLgbn.js";import"./ray-C_tSu6xd.js";import"./RenderFeature-2QP3kBrd.js";import"./unitFormatUtils-Q7ZG7HcF.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./quantityUtils-BsDK158M.js";import"./ZoomMomentumEstimator-BDiG9U4W.js";import"./HUDMaterial-DDt4C7E7.js";import"./labelFormatUtils-F9rkrs4Y.js";import"./labelUtils-DCpQ7n-8.js";import"./DepthRange-BJLjx8ee.js";import"./ElevationRange-BrgM1moX.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./MemCache-CmojB_Z1.js";import"./DefaultLoadingContext-pYVsNNqG.js";import"./wosrLoader-CvsaTck0.js";import"./Version-Cd3TlGH0.js";import"./DrawParameters-C9t9_e99.js";import"./TileStrategy-CtmYSAoK.js";import"./TileKey-DBTeo_j0.js";import"./ScheduledQueueProcessor-U8WIIyj8.js";import"./RenderableTile-FJVLrFon.js";import"./config-BOD8--da.js";import"./StyleDefinition-C2Flw6Qv.js";import"./enums-BTM-fOHQ.js";import"./enums-BRzLM11V.js";import"./GeometryUtils-F7QfOKlc.js";import"./DefaultVertexAttributeLayouts-wSIZdMhB.js";import"./DisplayObject-Dejv4A66.js";import"./resources-D31XxULB.js";import"./colorUtils-DaPfwnk3.js";import"./vec33-KumQEj7U.js";import"./ShaderTechniqueRepository-Ch1TPHrL.js";import"./Blit-_zFq7-RL.js";import"./testSVGPremultipliedAlpha-BGpZOwI7.js";import"./RenderingContext-7iVYEQBa.js";import"./ProgramCache-CuBZBhwD.js";import"./Program-C5Xq9SwE.js";import"./makeScheduleFunction-CggzEh3c.js";let Ni=class extends It{constructor(e,i,r,s,o){super(e,i,-1,r,s),this.queue=o}},$i=class{constructor(e,i,r,s){this.loading=e,this.indexLoading=i,this.processing=r,this.idleProcessing=s}},zi=class extends Ot{constructor(e){super("PointCloudWorker","transform",{transform:i=>Ri(i)},e)}};function Ri(t){const e=[t.geometryBuffer];if(t.primaryAttributeData!=null&&t.primaryAttributeData.buffer&&e.push(t.primaryAttributeData.buffer),t.modulationAttributeData!=null&&t.modulationAttributeData.buffer&&e.push(t.modulationAttributeData.buffer),t.filterAttributesData!=null)for(const i of t.filterAttributesData)i!=null&&i.buffer&&e.push(i.buffer);for(const i of t.userAttributesData)i.buffer&&e.push(i.buffer);return e}function Ai(t,e,i){for(let s=0;s<e.length;s++)ne[s]=!1,z[s]=null;for(let s=0;s<t.length;s++)oe[s]=!1,$[s]=null;for(let s=0;s<e.length;s++){const o=Fe(e[s],t,i);o>=0&&(ne[s]=!0,$[o]!=null?$[o].push(e[s]):$[o]=[e[s]])}for(let s=0;s<t.length;s++){const o=Fe(t[s],e,i);o>=0&&(oe[s]=!0,z[o]!=null?z[o].push(t[s]):z[o]=[t[s]])}const r=[];for(let s=0;s<t.length;s++)$[s]!=null||oe[s]||r.push({load:[],remove:[t[s]]});for(let s=0;s<e.length;s++)z[s]!=null||ne[s]||r.push({load:[e[s]],remove:[]});for(let s=0;s<e.length;s++)z[s]!=null&&(z[s].length>1||z[s][0]!==e[s])&&r.push({load:[e[s]],remove:z[s]});for(let s=0;s<t.length;s++)$[s]!=null&&($[s].length>1||$[s][0]!==t[s])&&r.push({load:$[s],remove:[t[s]]});return r}const oe=[!1],$=[null],ne=[!1],z=[null];function Fe(t,e,i){let r=t;for(;r>0;){const s=e.indexOf(r);if(s>=0)return s;r=i.getParentId(r)}return e.indexOf(r)}function Ii(t,e,i){return t.sort((r,s)=>{if(r.load.length===0&&s.load.length===0)return 0;if(r.load.length===0)return-1;if(s.load.length===0)return 1;if(r.remove.length===0&&s.remove.length===0){const o=i.getRenderObb(r.load[0]).center,a=i.getRenderObb(s.load[0]).center;return R(o,e)-R(a,e)}if(r.remove.length===0)return-1;if(s.remove.length===0)return 1;if(r.load.length===1&&s.load.length===1){const o=i.getRenderObb(r.load[0]).center,a=i.getRenderObb(s.load[0]).center;return R(o,e)-R(a,e)}if(r.load.length===1)return-1;if(s.load.length===1)return 1;{const o=i.getRenderObb(r.remove[0]).center,a=i.getRenderObb(s.remove[0]).center;return R(o,e)-R(a,e)}})}function Ci(t,e,i){for(let r=0;r<t.length;++r){const s=t[r];s.load.length>e&&s.remove.length===1&&Oi(t,s,i)}}function Oi(t,e,i){const r=[e.remove[0]],s=[];for(;r.length===1;){const o=r.pop();s.length=0;for(let a=0;a<e.load.length;a++){let n=e.load[a],d=i.getParentId(n);for(;d!==o;)n=d,d=i.getParentId(n);let l=r.indexOf(n);l<0&&(l=r.length,r.push(n),s.push([])),s[l].push(e.load[a])}}e.load=r;for(let o=0;o<r.length;o++)s[o].length>1?t.push({remove:[r[o]],load:s[o]}):r[o]=s[o][0]}let Mi=class{constructor(e,i,r){this._pages=[],this.pageSize=0,this._nodeSR=e,this._renderSR=i,this._renderSRSphericalPCPF=Ft(i),this.pageSize=r}addPage(e,i,r=0){for(;this._pages.length<e;)this._pages.push(null);Fi(i,this._nodeSR,this._renderSR,r,this._renderSRSphericalPCPF),this._pages[e]={nodes:i,parents:new Uint32Array(this.pageSize)},Li(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const i=this.pageSize;return this._pages[w(e,i)].nodes[L(e,i)]}getRenderObb(e){const i=this.pageSize;return this._pages[w(e,i)].nodes[L(e,i)].obbInRenderSR}setRenderObb(e,i){const r=this.pageSize;this._pages[w(e,r)].nodes[L(e,r)].obbInRenderSR.copy(i)}getParentId(e){const i=this.pageSize;return this._pages[w(e,i)].parents[L(e,i)]}hasNodes(e,i){const r=w(e,this.pageSize),s=w(e+i-1,this.pageSize);for(let o=r;o<=s;o++)if(this._pages[o]==null)return!1;return!0}forEachNodeId(e){for(let i=0;i<this._pages.length;i++){const r=this._pages[i];if(r)for(let s=0;s<r.nodes.length;s++)e(i*this.pageSize+s)}}createVisibilityTraverse(){const e={index:this,queue:[],masks:[],tempAabb:H()};return(i,r)=>Ei(e,i,r)}};function Ei(t,e,i){const r=t.index;if(!r.hasNodes(0,1))return;const s=t.queue;s.length=0,s.push(0);const o=t.masks;for(o.length=0,o.push(0);s.length>0;){const a=s.pop();let n=o.pop();const d=r.getNode(a),l=r.getRenderObb(a);let u=!0;if(e.clippingBox!=null){const h=1<<e.frustum.length;n&h||(l.toAaBoundingBox(t.tempAabb),Te(e.clippingBox,t.tempAabb)?n|=h:bt(e.clippingBox,t.tempAabb)||(u=!1))}for(let h=0;h<e.frustum.length&&u;h++){const p=1<<h;if(!(n&p)){const _=l.intersectPlane(e.frustum[h]);_>0?u=!1:_<0&&(n|=p)}}if(i.predicate(a,d,u)){const h=d.firstChild,p=d.childCount;let _=!1;const v=w(h,r.pageSize),b=w(h+p-1,r.pageSize);for(let m=v;m<=b;m++)if(!r.hasPage(m)){i.pageMiss(a,m),_=!0;break}if(!_)for(let m=0;m<p;m++)s.push(h+m),o.push(n)}}}function Fi(t,e,i,r,s){for(let o=0;o<t.length;o++){const a=t[o];a.obb.transform(a.obbInRenderSR,e,i,r,s)}}function Li(t,e){const i=[0];for(;i.length;){const r=i.pop(),s=t[w(r,e)].nodes[L(r,e)];for(let o=0;o<s.childCount;o++){const a=s.firstChild+o;t[w(a,e)]!=null&&(t[w(a,e)].parents[L(a,e)]=r,i.push(a))}}}function w(t,e){return t/e|0}function L(t,e){return t%e}let q=class extends Qe{constructor(e){super(e),this.pointCloudMetadata=null}};g([S({constructOnly:!0,clonable:"reference"})],q.prototype,"pointCloudMetadata",void 0),q=g([ce("esri.views.3d.layers.i3s.PointCloudGraphic")],q);let ki=class{constructor(e){this._context=e,this._highlights=new Map}get empty(){return this._highlights.size===0}destroy(){this._highlights=null}add(e,i){const r=new Di(e,i),s=this._highlights.get(i);return s?s.add(r):this._highlights.set(i,new Set([r])),this._enableSet(r),et(()=>this._removeSet(r))}_removeSet(e){this._disableSet(e);const{highlightName:i}=e.id,r=this._highlights.get(i);r&&(r.delete(e),r.size===0&&this._highlights.delete(i))}_enableSet(e){e.enabled||(e.enabled=!0,this._context.forEachNode(i=>this._enableSetForNode(e,i)))}_enableSetForNode(e,i){if(!e.enabled)return;const r=e.ids.get(i.id);r&&r.forEach(s=>this._context.addHighlight(i,s,e.id))}_disableSet(e){e.enabled&&(e.enabled=!1,this._context.forEachNode(i=>this._disableSetForNode(e,i)))}_disableSetForNode(e,i){e.enabled||this._context.removeHighlight(i,e.id)}nodeAdded(e){this._forEachSet(i=>this._enableSetForNode(i,e))}nodeRemoved(e){this._forEachSet(i=>this._disableSetForNode(i,e))}removeAll(){this._forEachSet(e=>this._disableSet(e))}_forEachSet(e){this._highlights.forEach(i=>i.forEach(e))}hasHighlightOptions(e){return this._highlights.has(e)}},Di=class{constructor(e,i){this.ids=new Map,this.enabled=!1;for(const r of e)r!=null&&this._add(r.nodeId,r.pointId);this.id=new Vt(i)}_add(e,i){const r=this.ids.get(e);r?r.add(i):this.ids.set(e,new Set([i]))}};class me extends wi{constructor(){super(...arguments),this.clipBox=H(ue),this.useFixedSizes=!1,this.useRealWorldSymbolSizes=!1,this.scaleFactor=1,this.minSizePx=0,this.size=0,this.sizePx=0}get fixedSize(){return this.drawScreenSpace?this.sizePx:this.size}get screenMinSize(){return this.useFixedSizes?0:this.minSizePx}get drawScreenSpace(){return this.useFixedSizes&&!this.useRealWorldSymbolSizes}}class ge extends qt{constructor(e,i,r){super(e),this.origin=e,this.isLeaf=i,this.splatSize=r}}function je(t){const e=new xi,i=Ge(t.output),{vertex:r,fragment:s}=e;return e.vertex.include(Ht,t),e.attributes.add(G.POSITION,"vec3"),e.attributes.add(G.COLOR,"vec3"),r.uniforms.add(new Wt("modelView",(o,a)=>fi(Le,a.camera.viewMatrix,bi(Le,o.origin))),new Jt("proj",o=>o.camera.projectionMatrix),new Ee("screenMinMaxSize",(o,a,n)=>se(ae,n.useFixedSizes?0:n.minSizePx*a.camera.pixelRatio,j(o.isLeaf)*a.camera.pixelRatio)),t.useFixedSizes?new vi("pointScale",(o,a)=>se(ae,o.fixedSize*a.camera.pixelRatio,a.camera.fullHeight)):new Ee("pointScale",(o,a,n)=>se(ae,o.splatSize*n.scaleFactor*a.camera.pixelRatio,a.camera.fullHeight/a.camera.pixelRatio))),t.clippingEnabled?r.uniforms.add(new ze("clipMin",(o,a,n)=>ve(ke,n.clipBox[0]-o.origin[0],n.clipBox[1]-o.origin[1],n.clipBox[2]-o.origin[2])),new ze("clipMax",(o,a,n)=>ve(ke,n.clipBox[3]-o.origin[0],n.clipBox[4]-o.origin[1],n.clipBox[5]-o.origin[2]))):(r.constants.add("clipMin","vec3",[-M,-M,-M]),r.constants.add("clipMax","vec3",[M,M,M])),i&&e.varyings.add("vColor","vec3"),r.main.add(E`
    // Move clipped points outside of clipspace
    if (position.x < clipMin.x || position.y < clipMin.y || position.z < clipMin.z ||
      position.x > clipMax.x || position.y > clipMax.y || position.z > clipMax.z) {
      gl_Position = vec4(0.0,0.0,0.0,2.0);
      gl_PointSize = 0.0;
      return;
    }

    if (rejectBySlice(position)) {
      gl_Position = vec4(0.0, 0.0, 0.0, 2.0);
      gl_PointSize = 0.0;
      return;
    }

    // Position in camera space
    vec4 camera = modelView * vec4(position, 1.0);

    float pointSize = pointScale.x;
    vec4 position = proj * camera;
    ${t.drawScreenSize?E`float clampedScreenSize = pointSize;`:E`float pointRadius = 0.5 * pointSize;
           vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);
           vec4 positionOffset = proj * cameraOffset;
           float radius = abs(positionOffset.y - position.y);
           float viewHeight = pointScale.y;
           // screen diameter = (2 * r / w) * (h / 2)
           float screenPointSize = (radius / position.w) * viewHeight;
           float clampedScreenSize = clamp(screenPointSize, screenMinMaxSize.x, screenMinMaxSize.y);
           // Shift towards camera, to move rendered point out of terrain i.e. to
           // the camera-facing end of the virtual point when considering it as a
           // 3D sphere.
           camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;
           position = proj * camera;`}

    gl_PointSize = clampedScreenSize;
    gl_Position = position;
    ${i?E`vColor = color;`:""}`),s.include(Pi,t),e.include(Bt,t),s.main.add(E`
    vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);
    float r2 = dot(vOffset, vOffset);

    if (r2 > 0.25) {
      discard;
    }
    calculateOcclusionAndOutputHighlight();
    ${i?E`fragColor = vec4(vColor, 1.0);`:""}`),e}function j(t){return t?256:64}const Le=Si(),ke=F(),ae=yi(),Vi=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:ge,PointRendererPassParameters:me,build:je,getMaxPointSizeScreenspace:j},Symbol.toStringTag,{value:"Module"}));class qi extends Qt{constructor(e,i){super(e,i,new Tt(Vi,()=>ti(()=>Promise.resolve().then(()=>Yi),void 0,import.meta.url)))}initializePipeline(e){return si({depthTest:{func:ri.LESS},depthWrite:ni,colorWrite:oi,stencilWrite:e.hasOccludees?Gt:null,stencilTest:e.hasOccludees?Ut:null,drawBuffers:e.output===T.Depth?{buffers:[ii.NONE]}:null})}}let V=class extends jt{constructor(){super(...arguments),this.drawScreenSize=!1,this.useFixedSizes=!1,this.hasOccludees=!1,this.clippingEnabled=!1}};g([Q()],V.prototype,"drawScreenSize",void 0),g([Q()],V.prototype,"useFixedSizes",void 0),g([Q()],V.prototype,"hasOccludees",void 0),g([Q()],V.prototype,"clippingEnabled",void 0);const Hi=new Map([["positions",[new Oe(G.POSITION,3,Ie.FLOAT,0,12)]],["colors",[new Oe(G.COLOR,3,Ie.UNSIGNED_BYTE,0,3,!0)]]]);let U=class extends Kt{constructor(t){super(t),this.type=Zt.PCL,this.isGround=!1,this._passParameters=new me,this._highlights=new ki({forEachNode:e=>this.forEachNode(e),addHighlight:(e,i,r)=>this._addHighlight(e,i,r),removeHighlight:(e,i)=>this._removeHighlight(e,i)}),this.produces=new Map([[ee.OPAQUE_MATERIAL,e=>!(te(e)||e===T.Highlight&&this._highlights.empty)],[ee.OPAQUE_MATERIAL_WITHOUT_NORMALS,e=>te(e)]]),this.layerUid="",this._slicePlaneEnabled=!1,this._configuration=new V,this._nodes=new tt}hasHighlightOptions(t){return this._highlights.hasHighlightOptions(t)}initializeRenderContext(t){this._context=t,t.requestRender()}uninitializeRenderContext(){}intersect(t,e,i,r){const s=F(),o=F(),a=F(),n=F(),d=Ue(),l=t.camera.perScreenPixelRatio/2,u=t.camera.near;we(o,r,i);const h=1/pt(o);ct(o,o,h),mt(a,o),Lt(d,o[0],o[1],o[2],-R(o,i));const p=new de,_=new de,v=new Array,b=H(),m=H(this._passParameters.clipBox);Ne(m,-i[0],-i[1],-i[2],m),this._nodes.forAll(c=>{const y=c.splatSize*this._passParameters.scaleFactor;let P=c.obb.minimumDistancePlane(d),A=c.obb.maximumDistancePlane(d);P-=le(y,P+u,this._passParameters,l,c.isLeaf),A-=le(y,A+u,this._passParameters,l,c.isLeaf);const Je=A<0,Ke=p.dist!=null&&_.dist!=null&&p.dist<P*h&&_.dist>A*h;if(Je||Ke)return;const J=pe(y,A+u,this._passParameters,l,c.isLeaf);if(!c.obb.intersectRay(i,o,J))return;const Ye=J*J;c.obb.toAaBoundingBox(b),Ne(b,-i[0],-i[1],-i[2],b);const Xe=!Te(m,b);we(n,c.origin,i);const Ze=c.coordinates.length/3;for(let I=0;I<Ze;I++){if(s[0]=n[0]+c.coordinates[3*I],s[1]=n[1]+c.coordinates[3*I+1],s[2]=n[2]+c.coordinates[3*I+2],Xe&&!St(m,s))continue;const D=R(s,o),_e=gt(s)-D*D;if(_e>Ye)continue;let K=D+u;const Y=le(y,K,this._passParameters,l,c.isLeaf);if(D-Y<0)continue;K-=Y;const fe=pe(y,K,this._passParameters,l,c.isLeaf);if(_e>fe*fe)continue;const O=(D-Y)*h,X=N=>(N.point=Wi(c,I,N.point),N.dist=O,N.normal=a,N.node=c,N.pointId=I,N.layerUid=this.layerUid,N);if((p.dist==null||O<p.dist)&&(e==null||e(i,r,O))&&X(p),t.options.store!==B.MIN&&(_.dist==null||O>_.dist)&&(e==null||e(i,r,O))&&X(_),t.options.store===B.ALL&&(e==null||e(i,r,O))){const N=new de;v.push(X(N))}}});const C=c=>{const{layerUid:y,node:P,pointId:A}=c;return new Dt(c.point,y,A,()=>this.createGraphic(P,A,c.point))},k=(c,y)=>{const P=C(y);c.set(this.type,P,y.dist,y.normal)};if(De(p)){const c=t.results.min;(c.dist==null||p.dist<c.dist)&&k(c,p)}if(De(_)&&t.options.store!==B.MIN){const c=t.results.max;(c.dist==null||_.dist>c.dist)&&k(c,_)}if(t.options.store===B.ALL){const c=kt(i,r);for(const y of v){const P=Xt(c);k(P,y),t.results.all.push(P)}}}acquireTechniques(t){return this._nodes.length!==0&&(Ge(t.output)||te(t.output)&&t.bind.slot===ee.OPAQUE_MATERIAL_WITHOUT_NORMALS||t.output===T.Highlight)?(this._nodes.forAll(e=>this._initNode(t,e)),this._configuration.drawScreenSize=this._passParameters.drawScreenSpace,this._configuration.useFixedSizes=this._passParameters.useFixedSizes,this._configuration.hasSlicePlane=this._slicePlaneEnabled,this._configuration.hasOccludees=t.bind.hasOccludees,this._configuration.clippingEnabled=this._clippingEnabled,this._configuration.output=t.output,this._context.techniques.get(qi,this._configuration)):null}render(t,e){var d;const{rctx:i,bind:r,output:s}=t,o=i.bindTechnique(e,r,this._passParameters),a=s===T.Highlight,n=((d=r.highlight)==null?void 0:d.name)??null;a&&!n||this._nodes.forAll(l=>{l.coordinates.length===0||a&&!l.highlightMap.has(n)||(o.bindDraw(r,this._passParameters,l),i.bindVAO(l.vao),a?this._renderHighlightFragments(t,l):i.drawArrays(Re.POINTS,0,l.coordinates.length/3))})}_renderHighlightFragments(t,e){const{highlightMap:i}=e,{rctx:r,bind:s}=t,{highlight:o}=s;if(!o)return;const a=o.name,n=i.get(a);if(!n||n.length===0)return;const{highlightOrderMap:d,highlightLevel:l}=s;if(l==null)return;for(const b of i.keys())if(b!==a){const m=d.get(b);if(m!==void 0&&m>l)return}let u=0,h=n[0].componentIndex,p=h+1;const _=()=>{for(;u<n.length&&n[u].id.highlightName!==a;)h=n[u].componentIndex,++u;p=h+1};_();const v=(b,m)=>{const C=m-b;C>0&&r.drawArrays(Re.POINTS,b,C)};for(;u<n.length;){const b=n[u];if(b.id.highlightName!==a){v(h,p),++u,_();continue}const m=b.componentIndex;m!==p&&(v(h,p),h=m),p=m+1,++u}v(h,p)}set useFixedSizes(t){this._passParameters.useFixedSizes!==t&&(this._passParameters.useFixedSizes=t,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(t){this._passParameters.scaleFactor!==t&&(this._passParameters.scaleFactor=t,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(t){this._passParameters.minSizePx!==t&&(this._passParameters.minSizePx=t,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(t){this._passParameters.useRealWorldSymbolSizes!==t&&(this._passParameters.useRealWorldSymbolSizes=t,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(t){this._passParameters.size!==t&&(this._passParameters.size=t,this._requestRender())}get size(){return this._passParameters.size}set sizePx(t){this._passParameters.sizePx!==t&&(this._passParameters.sizePx=t,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(t){yt(this._passParameters.clipBox,t||ue)}get _clippingEnabled(){return!xt(this._passParameters.clipBox,ue,(t,e)=>t===e)}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(t){this._slicePlaneEnabled!==t&&(this._slicePlaneEnabled=t,this._requestRender())}addNode(t){this._nodes.push(t),this._highlights.nodeAdded(t),this._requestRender()}removeNode(t){let e=null;return this._nodes.filterInPlace(i=>i.id!==t||(e=i,i.vao=be(i.vao),this._highlights.nodeRemoved(i),!1)),this._requestRender(),e}forEachNode(t){this._nodes.forAll(t)}removeAll(){this._nodes.forAll(t=>t.vao=be(t.vao)),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(t,e){return this._highlights.add(t,e)}_addHighlight(t,e,i){t.addHighlight(e,i),this._requestRender()}_removeHighlight(t,e){t.removeHighlight(e),this._requestRender()}_initNode(t,e){e.vao??(e.vao=new ei(t.rctx,Yt,Hi,new Map([["positions",Ce.createVertex(t.rctx,Ae.STATIC_DRAW,e.coordinates)],["colors",Ce.createVertex(t.rctx,Ae.STATIC_DRAW,e.rgb)]])))}_requestRender(){this._context&&this._context.requestRender()}};function pe(t,e,i,r,s){if(i.drawScreenSpace)return i.fixedSize*e*r;const o=j(s)*e*r;return i.useFixedSizes?Math.min(i.fixedSize/2,o):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*e*r,t/2),o):Math.min(t/2,o)}function le(t,e,i,r,s){return i.drawScreenSpace?0:pe(t,e,i,r,s)}function Wi(t,e,i){return i==null&&(i=F()),i[0]=t.origin[0]+t.coordinates[3*e],i[1]=t.origin[1]+t.coordinates[3*e+1],i[2]=t.origin[2]+t.coordinates[3*e+2],i}g([S({constructOnly:!0})],U.prototype,"createGraphic",void 0),U=g([ce("esri.views.3d.layers.i3s.PointCloudRenderer")],U);class de{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}function De(t){return t.dist!=null&&t.point!=null&&t.pointId!=null&&t.node!=null}class Bi extends ge{constructor(e,i,r,s,o,a,n,d,l=null){super(r,o,i),this.id=e,this.obb=s,this.coordinates=a,this.rgb=n,this.attributes=d,this.pointIdFilterMap=l,this.highlightMap=new Map}addHighlight(e,i){const{highlightMap:r}=this,s=it(r,i.highlightName,()=>new Array),o=new Ti(e,i);s.push(o);const a=Ve(o);for(let n=s.length-1;n>0&&a<Ve(s[n-1]);--n)[s[n-1],s[n]]=[s[n],s[n-1]]}removeHighlight(e){const{highlightMap:i}=this,{highlightName:r}=e,s=i.get(r);if(!s)return;const o=s.filter(a=>a.id!==e);o.length===0?i.delete(r):i.set(r,o)}get cachedMemory(){return 5*this.coordinates.length+128}}function Qi(t){return t.hasOwnProperty("splatSize")}function Ve(t){return t.componentIndex!=null?t.componentIndex:-1}class Ti{constructor(e,i){this.componentIndex=e,this.id=i}}function qe(t){const e=t.renderer,i=e==null?void 0:e.type,r=(e==null?void 0:e.toJSON())??null;let s=null,o=!1;const a=t.attributeStorageInfo;i==="point-cloud-unique-value"||i==="point-cloud-stretch"||i==="point-cloud-class-breaks"?s=W(a,e.field):i==="point-cloud-rgb"?(s=Be(a,e.field),o=s!=null):(s=Be(a,"RGB"),o=s!=null);let n=null;return e!=null&&e.colorModulation&&(n=W(a,e.colorModulation.field)),{rendererJSON:r,isRGBRenderer:o,primaryAttribute:s,modulationAttribute:n}}function He(t){const e=t.filters;return e?e.map(i=>({filterJSON:i.toJSON(),attributeInfo:W(t.attributeStorageInfo,i.field)})):[]}function Ui(t){const e=t==null?void 0:t.pointSizeAlgorithm;return e&&e.type==="splat"?e:null}function We(t){const e=t==null?void 0:t.pointSizeAlgorithm;return e&&e.type==="fixed-size"?e:null}function Gi(t){const e=t==null?void 0:t.pointSizeAlgorithm;return!!(e!=null&&e.type)&&e.type==="fixed-size"}function Be(t,e){for(const i of t??[])if(i.name===e&&i.attributeValues!=null&&i.attributeValues.valueType==="UInt8"&&i.attributeValues.valuesPerElement===3)return{name:e,storageInfo:i,useElevation:!1};return null}function W(t,e){for(const i of t??[])if(i.name===e){const r=i.encoding==="embedded-elevation";return r?{name:e,storageInfo:null,useElevation:r}:{name:e,storageInfo:i,useElevation:r}}return(e==null?void 0:e.toLowerCase())==="elevation"?{name:e,storageInfo:null,useElevation:!0}:null}const ji=8,Ji=Ue();let f=class extends ui(At(mi)){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new Nt,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[],this.ignoresMemoryFactor=!1}get baseUrl(){var t;return((t=this.layer.parsedUrl)==null?void 0:t.path)??""}get pointScale(){var i;const t=Ui((i=this.layer)==null?void 0:i.renderer);return(t==null?void 0:t.scaleFactor)!=null?t.scaleFactor:1}get useRealWorldSymbolSizes(){var i;const t=We((i=this.layer)==null?void 0:i.renderer);return(t==null?void 0:t.useRealWorldSymbolSizes)!=null?t.useRealWorldSymbolSizes:!1}get pointSize(){var i;const t=We((i=this.layer)==null?void 0:i.renderer);return(t==null?void 0:t.size)!=null?t.size:0}get inverseDensity(){var e;return(e=this.layer)!=null&&e.renderer?1*96/this.layer.renderer.pointsPerInch:5}get availableFields(){const t=qe(this.layer),e=new Set;t.primaryAttribute&&e.add(t.primaryAttribute.name),t.modulationAttribute&&e.add(t.modulationAttribute.name);const i=He(this.layer);if(i)for(const r of i)r.attributeInfo&&e.add(r.attributeInfo.name);if(this.layer.outFields)for(const r of $e(this.layer.fieldsIndex,this.layer.outFields))e.add(r);return Array.from(e)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const t=H(),e=this.view.renderSpatialReference;return Ct(this.view.clippingArea,t,e)?t:null}get _elevationOffset(){const t=this.layer&&this.layer.elevationInfo;return t&&t.mode==="absolute-height"?Rt(t,this.layer.spatialReference):0}initialize(){const t=this.view.resourceController,e=Ki(t);this._worker=new zi(e),this.addResolvingPromise(this._worker.promise),Mt(this.layer),Et(this.layer,this.view),this._indexRequester=t.createStreamDataRequester(Me.I3S_INDEX),this._dataRequester=t.createStreamDataRequester(Me.I3S_DATA),this._initRenderer();const i=this._initNodePages(),r=this.view.resourceController.memoryController;this._memCache=r.newCache(`pcl-${this.layer.uid}`),this._updatingHandles.add(()=>this._clippingBox,()=>this._setUpdateViewNeeded(),x),this._updatingHandles.add(()=>this._elevationOffset,()=>this._elevationOffsetChanged(),x),this._updatingHandles.add(()=>this.layer.renderer,()=>this._rendererChanged(),x),this._updatingHandles.add(()=>this.layer.filters,()=>this._reload(),x),this._updatingHandles.add(()=>this.layer.outFields,()=>this._reload(),x),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this._setUpdateViewNeeded()),this._updatingHandles.add(()=>this.view.state.contentCamera,()=>this._setUpdateViewNeeded()),this.addHandles([at(()=>this.view.quality,()=>this._setUpdateViewNeeded(),lt)]),this.addResolvingPromise(i),this.when(()=>{this.addHandles([t.scheduler.registerTask($t.POINT_CLOUD_LAYER,this),t.scheduler.registerIdleStateCallbacks(()=>this._idleBegin(),()=>this._idleEnd()),this._updatingHandles.add(()=>this.suspended,s=>{s?this._clearNodeState():this._setUpdateViewNeeded()},x)])},()=>{this._updatingHandles.removeAll(),this.removeAllHandles()})}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker=Se(this._worker),this._destroyRenderer(),this._memCache=Se(this._memCache),this._codedDomainPopulationAbortController=rt(this._codedDomainPopulationAbortController),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new U({createGraphic:(t,e,i)=>this._createGraphic(t,e,i)}),this._renderer.layerUid=this.layer.uid,this._updatingHandles.add(()=>this._clippingBox,t=>this._renderer.clippingBox=t,x),this._updatingHandles.add(()=>this.suspended,t=>this._setPointsVisible(!t),x),this._updatingHandles.add(()=>this.pointScale,t=>this._renderer.scaleFactor=t,x),this._renderer.minSizePx=Math.sqrt(2),this._updatingHandles.add(()=>this.useRealWorldSymbolSizes,t=>this._renderer.useRealWorldSymbolSizes=t,x),this._updatingHandles.add(()=>this.pointSize,t=>{const e=ut(t);this._renderer.size=t,this._renderer.sizePx=e},x),this._updatingHandles.add(()=>this.slicePlaneEnabled,t=>this._renderer.slicePlaneEnabled=t,x),this._updatingHandles.add(()=>this.inverseDensity,()=>this._setUpdateViewNeeded(),x),this._updatingHandles.add(()=>this.maximumPointCount,()=>this._setUpdateViewNeeded(),x),this._updatingHandles.add(()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor,t=>{this._lodFactor=t,this._setUpdateViewNeeded()},x)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(t,e,i){const r=t.pointIdFilterMap!=null?t.pointIdFilterMap[e]:e,s=pi(this.view,i),o=this._createGraphicAttributes(t,r);return new q({pointCloudMetadata:{nodeId:t.id,pointIndexInNode:e,attributePointIndexInNode:r,epoch:this._nodeLoadEpoch},geometry:s,attributes:o,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(t,e){const i={};for(const r of t.attributes)this._encodeGraphicAttribute(r.attributeInfo,r.values,e,i);return i}_encodeGraphicAttribute(t,e,i,r){var a;const s=(a=t.storageInfo)==null?void 0:a.attributeValues,o=(s==null?void 0:s.valuesPerElement)??1;if(o===1)r[t.name]=e[i];else if((s==null?void 0:s.valueType)==="UInt8"&&o<=4){let n=0;const d=i*o;for(let l=d;l<d+o;l++)n=(n<<8)+e[l];r[t.name]=n}else r[t.name]=void 0}_setPointsVisible(t){t&&!this._rendererAdded?(this.view._stage.addRenderPlugin(this._renderer),this._rendererAdded=!0):!t&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=Gi(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_displayNodes(t){this._workQueue=Ai([...this._renderedNodes],t,this._index),Ii(this._workQueue,this.view.state.contentCamera.viewForward,this._index),Ci(this._workQueue,ji,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=t.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const t=new Array;this._loadingNodes.forEach(({abortController:e})=>t.push(e)),this._loadingNodes.clear();for(const e of t)e.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const t=new Set;this._workQueue.forEach(r=>r.load.forEach(s=>t.add(s)));const e=new Array,i=new Map;this._loadingNodes.forEach((r,s)=>{t.has(s)?i.set(s,r):e.push(r)}),this._loadingNodes=i;for(const{abortController:r}of e)r.abort();this._workQueue=this._workQueue.filter(r=>{for(const s of r.load)if(this._loadingNodes.has(s))return this._recalcWork=!0,!1;return!0}),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach(({abortController:t})=>t.abort()),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach(t=>this._removeFromRenderer(t)),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}get running(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.running}runTask(t){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange("suspended")),this._updateLoading()}}else{for(t.run(()=>this._updateWorkQueues());this._indexQueue.length>0&&t.run(()=>this._processIndexQueue()););this._processWorkQueue(t),this._idleQueue.runTask(t)}}_processIndexQueue(){const t=this._indexQueue.shift(),e=this._loadNodePage(t);return this._indexPagesLoading.set(t,e),e.promise.then(i=>{this._index.addPage(t,i,this._elevationOffset),this._setUpdateViewNeeded()}).then(()=>{this._indexPagesLoading.delete(t)},()=>{this._indexPagesLoading.delete(t)}),!0}_processWorkQueue(t){for(;!t.done;){const e=this._scheduleWorkEntry();if(e==null)return void t.madeProgress();this._processWorkEntry(e),t.madeProgress()}}_scheduleWorkEntry(){let t=this._workQueue.length;for(;t--;){const e=this._workQueue.shift();if(!e.remove.find(i=>!this._renderedNodes.has(i)))return e;this._workQueue.push(e)}return null}_processWorkEntry(t){if(t.load.length!==0)Promise.all(t.load.map(e=>{const i=new AbortController,r=this._memCache.pop(e.toString());return r!=null?this._loadingNodes.set(e,{abortController:i,promise:Promise.resolve(r)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:i,promise:this._loadNode(e,i.signal)}),this._loadingNodes.get(e).promise})).then(e=>{for(let i=0;i<t.load.length;i++)if(e[i]){const r=this._setupRendererData(t.load[i],e[i]);this._addToRenderer(r)}for(const i of t.remove)this._removeFromRenderer(i)}).catch(()=>{}).then(()=>{for(const e of t.load)this._loadingNodes.delete(e);this._updateLoading(),this._recalcWork&&!this._idleQueue.running&&this._indexQueue.length===0&&this._loadingNodes.size===0&&(this._recalcWork=!1,this._setUpdateViewNeeded())}),this._updateLoading();else for(const e of t.remove)this._removeFromRenderer(e)}async _populateClassCodeCodedDomain(t,e){var a,n,d;const i="CLASS_CODE",r=this.layer.fieldsIndex.get(i);if(!r||r.domain||!t.includes(r.name))return;const s=await dt(this.layer.queryCachedStatistics(i,{signal:e}));if(s.ok===!1)return;const o=(d=(n=(a=s.value)==null?void 0:a.stats)==null?void 0:n.labels)==null?void 0:d.labels;o&&Array.isArray(o)&&(r.domain=new vt({name:"CLASS_CODE",codedValues:o.map(l=>new wt({code:l.value,name:l.label}))}))}async prepareFetchPopupFeatures(t){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=new AbortController,this._codedDomainPopulationPromise=this._populateClassCodeCodedDomain(t,this._codedDomainPopulationAbortController.signal).then(()=>{this._codedDomainPopulationAbortController=null})),this._codedDomainPopulationPromise}async whenGraphicAttributes(t,e){const i=this._splitGraphicsPerNode(t),r=this.layer.attributeStorageInfo,s=e.map(n=>W(r,n)).filter(ye),o=async(n,d)=>{const l=this._index.getNode(d);await ht(s,async u=>{const h=u.useElevation?await this._loadElevationAttributeFromGeometry(l.resourceId):await this._loadAndParseAttribute(l,u);if(h){for(const p of n)if(this._isValidPointGraphic(p)){const _=p.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(u,h,_,p.attributes)}}})},a=[];return i.forEach((n,d)=>{a.push(o(n,d))}),await Promise.allSettled(a),t}_isValidPointGraphic(t){var e;return t instanceof q&&((e=t.pointCloudMetadata)==null?void 0:e.epoch)===this._nodeLoadEpoch}_splitGraphicsPerNode(t){const e=new Map;for(const i of t){if(!this._isValidPointGraphic(i))continue;const r=i.pointCloudMetadata,s=e.get(r.nodeId);s?s.push(i):e.set(r.nodeId,[i])}return e}async _loadAndParseAttribute(t,e){const i=await this._loadAttribute(t.resourceId,e,null);return i!=null?ai({attributeInfo:e,buffer:i},null,t.vertexCount):null}async _loadElevationAttributeFromGeometry(t){const e=this.layer.store.defaultGeometrySchema,i=li(e,await this._loadGeometry(t,null));return di(i,i.length/3)}highlight(t,e){if(!t||t instanceof zt)return ie;const i=hi(t);if(i.length===0)return ie;if(!(i[0]instanceof Qe))return ie;const r=i;return this._renderer.highlight(r.map(s=>this._graphicToPointDefinition(s)),(e==null?void 0:e.name)??gi)}_graphicToPointDefinition(t){if(!this._isValidPointGraphic(t))return null;const{nodeId:e,pointIndexInNode:i}=t.pointCloudMetadata;return e!=null&&i!=null?{nodeId:e,pointId:i}:null}_computeWork(){let t=0;for(const e of this._workQueue)t+=e.load.length+e.remove.length;return t+=this._loadingNodes.size,t+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,t+=this._loadingInitNodePage?100:0,t+=this._updateViewNeeded?100:0,t}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const t=this._computeWork();return 1-Math.min(this._totalWork,t)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}get visibleAtCurrentScale(){return _i(this.layer.effectiveScaleRange,this.view.scale)}_initNodePages(){const t=this.layer.store.index,e=t.nodesPerPage||t.nodePerIndexBlock;return this._index=new Mi(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,e),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=t.nodesPerPage!=null?1:t.nodePerIndexBlock,this._loadNodePage(0).promise.then(i=>{this._index.addPage(0,i,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()})}_loadNodePage(t){const e=new AbortController,i=`${this.baseUrl}/nodepages/${t*this._pageMultiplier}`;return{promise:this._requestNodePage(i,e.signal).then(r=>r.nodes.map((s,o)=>({resourceId:s.resourceId!=null?s.resourceId:t*this._index.pageSize+o,obb:re.fromJSON(s.obb),obbInRenderSR:new re,firstChild:s.firstChild,childCount:s.childCount,vertexCount:s.vertexCount??s.pointCount,lodThreshold:s.lodThreshold??s.effectiveArea}))),abortController:e}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;const t=this.view.quality;let e=this.inverseDensity/this._lodFactor*t;const i=this.maximumPointCount*this._lodFactor*t;let r=this._computeNodesForMinimumDensity(e),s=this._computePointCount(r),o=Math.sqrt(s/(.75*i));for(;s>i;)e*=o,r=this._computeNodesForMinimumDensity(e),s=this._computePointCount(r),o=Math.sqrt(2);return this._displayNodes(r),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(t){let e=0;for(let i=0;i<t.length;i++){const r=this._index.getNode(t[i]);r&&(e+=r.vertexCount)}return e}_isRootNodeVisible(){let t=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(e,i,r)=>(t=r,!1),pageMiss:()=>{}}),t}_computeNodesForMinimumDensity(t){const e=this.view.state.contentCamera,i=e.frustum,r=this._clippingBox,s=e.viewForward,o=R(s,e.eye),a=Pt(s,-o,Ji),n=e.perScreenPixelRatio/2,d=t*t,l=this._nodeIdArray;l.length=0;const u=h=>l.push(h);return this._traverseVisible({frustum:i,clippingBox:r},{predicate:(h,p,_)=>{if(!_)return!1;if(p.childCount===0)return u(h),!1;const v=this._index.getRenderObb(h);return!(this._computeAveragePixelArea(v,p.lodThreshold,p.vertexCount,a,n)<=d)||(u(h),!1)},pageMiss:(h,p)=>{u(h),this._indexQueue.includes(p)||this._indexQueue.push(p)}}),l}_computeAveragePixelArea(t,e,i,r,s){const a=Math.max(1e-7,t.minimumDistancePlane(r));return e/(a*a)/(4*s*s)/i}_loadNode(t,e){try{return this._loadNodeAsync(t,e)}catch(i){throw st(i)||Z.getLogger(this).error(i),i}}async _loadAdditionalUserAttributes(t,e,i){const r=this.layer.outFields;if(!r)return[];const s=$e(this.layer.fieldsIndex,r),o=new Set(t.map(l=>l!=null?l.name:null)),a=this.layer.attributeStorageInfo,n=[];for(const l of s){if(o.has(l))continue;const u=W(a,l);u&&n.push(e(u))}const d=await ot(n);return xe(i),d.filter(ye)}async _loadNodeAsync(t,e){const i=this._index.getNode(t),r=qe(this.layer),s=He(this.layer),o=i.resourceId,a=async n=>{if(!n)return null;if(n.useElevation)return{attributeInfo:n,buffer:null};const d=await this._loadAttribute(o,n,e);return d!=null?{attributeInfo:n,buffer:d}:null};return this._idleQueue.push(async()=>{const n=this._loadGeometry(o,e),{primaryAttribute:d,modulationAttribute:l}=r,u=a(d),h=a(l),p=s.map(P=>P.attributeInfo),_=p.map(P=>a(P)),v=this._loadAdditionalUserAttributes([d,l,...p],a,e),[b,m,C,k,c]=await Promise.all([n,u,h,Promise.all(_),v]);xe(e);const y={geometryBuffer:b,primaryAttributeData:m,modulationAttributeData:C,filterAttributesData:k,userAttributesData:c,schema:this.layer.store.defaultGeometrySchema,rendererInfo:r,filterInfo:s,obbData:this._index.getRenderObb(t).data,elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(y,e)},e)}async _loadGeometry(t,e){return this._requestData(`${this.baseUrl}/nodes/${t}/geometries/0`,e)}async _loadAttribute(t,e,i){if(!(e!=null&&e.storageInfo))return null;const r=e.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${t}/attributes/${r}`,i)}_requestNodePage(t,e){const i={f:"json",...this.layer.customParameters,token:this.layer.apiKey};return this._indexRequester.request(t,"json",{query:i,signal:e})}_requestData(t,e){return this._dataRequester.request(t,"binary",{query:{...this.layer.customParameters,token:this.layer.apiKey},signal:e})}_removeFromRenderer(t){if(this._renderedNodes.has(t)){const e=this._renderer.removeNode(t);this._renderedNodes.delete(t),this._memCache.put(e.id.toString(),e)}}_addToRenderer(t){this._renderedNodes.has(t.id)||(this._renderedNodes.add(t.id),this._renderer.addNode(t))}_setupRendererData(t,e){const i=this._index.getNode(t),r=Math.sqrt(i.lodThreshold/i.vertexCount),s=this._index.getRenderObb(t);if(Qi(e))return e.splatSize=r,e.obb=s,_t(e.origin,e.obb.center),e;const o=re.fromData(e.obbData),a=o.halfSize,n=s.halfSize,d=.01*Math.max(n[0],n[1],n[2]);if(a[0]>n[0]+d||a[1]>n[1]+d||a[2]>n[2]+d){if(this._maxLoggedBoxWarnings>0){const l=u=>`[${u.halfSize[0]}, ${u.halfSize[1]}, ${u.halfSize[2]}]`;Z.getLogger(this).warn(`Node ${t} reported bounding box too small. got ${l(s)} but points cover ${l(o)}`),--this._maxLoggedBoxWarnings==0&&Z.getLogger(this).warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(t,o)}return new Bi(t,r,ft(s.center),s,i.childCount===0,e.points,e.rgb,e.attributes,e.pointIdFilterMap)}get usedMemory(){let t=0;return this._renderer.forEachNode(e=>{t+=he,t+=Pe(e.coordinates);for(const i of e.attributes){const r=i.values;nt(r.buffer)&&(t+=Pe(r))}}),t}get unloadedMemory(){const t=this._renderedNodes.size;if(t<4)return 0;const e=[...this._renderedNodes].reduce((r,s)=>r+this._index.getNode(s).vertexCount);let i=this._loadingNodes.size;for(let r=0;r<this._workQueue.length;r++)i+=this._workQueue[r].load.length,i-=this._workQueue[r].remove.length;return i<0?0:i*e/t*((this.usedMemory-t*he)/e)+i*he}get performanceInfo(){return new Ni(this.usedMemory,this._renderedNodes.size,[...this._renderedNodes].reduce((t,e)=>t+this._index.getNode(e).vertexCount,0),this.maximumPointCount,new $i(this._loadingNodes.size,this._indexQueue.length,this._workQueue.length,this._idleQueue.length))}get test(){}};g([S()],f.prototype,"layer",void 0),g([S()],f.prototype,"baseUrl",null),g([S()],f.prototype,"pointScale",null),g([S()],f.prototype,"useRealWorldSymbolSizes",null),g([S()],f.prototype,"pointSize",null),g([S()],f.prototype,"inverseDensity",null),g([S()],f.prototype,"maximumPointCount",void 0),g([S({readOnly:!0})],f.prototype,"availableFields",null),g([S({readOnly:!0})],f.prototype,"_clippingBox",null),g([S({readOnly:!0})],f.prototype,"_elevationOffset",null),g([S({type:Boolean})],f.prototype,"slicePlaneEnabled",void 0),g([S()],f.prototype,"updating",void 0),g([S(ci)],f.prototype,"updatingProgress",void 0),g([S({readOnly:!0})],f.prototype,"updatingProgressValue",null),g([S({readOnly:!0})],f.prototype,"visibleAtCurrentScale",null),f=g([ce("esri.views.3d.layers.PointCloudLayerView3D")],f);const pl=f,he=160;function Ki(t){return e=>t.immediate.schedule(e)}const Yi=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:ge,PointRendererPassParameters:me,build:je,getMaxPointSizeScreenspace:j},Symbol.toStringTag,{value:"Module"}));export{pl as default};
