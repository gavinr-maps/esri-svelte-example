const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ShadowCastAccumulate.glsl-7ziGQBCy.js","./index-tefRSezt.js","./index-Cx51aysm.css","./Accessor-BHnuXKD2.js","./Camera-DJtV7zYb.js","./Clonable-DvJsj5LF.js","./Cyclical-CPiNl4ru.js","./mathUtils-DV9iOXpW.js","./JSONSupport-CGdeqxpk.js","./cast-BA_-jlhc.js","./writer-B2bQV2uU.js","./Point-XGrwlf63.js","./Viewpoint-Cv8Otrne.js","./jsonUtils-Cu7OBRmN.js","./Extent-CBBGeHb-.js","./Polyline-BmuD2-ZN.js","./typeUtils-BSg8Y507.js","./reactiveUtils-BR0C1Kq4.js","./Evented-DCWccWGU.js","./SimpleObservable-7oieNGD8.js","./jsxFactory-CLjKarlq.js","./intl-Do3GEEJ7.js","./Promise-CmQqe-ke.js","./uuid-Cl5lrJ4c.js","./screenUtils-_ZIvrt5o.js","./workers-D8Q3pEzK.js","./Queue-BOnccek2.js","./vec3f64-BLpZdpfb.js","./GraphicsCollection-CkliHSk1.js","./Graphic-CFXUQZlS.js","./opacityUtils-CSd4XoR2.js","./enumeration-Cr5WIZs4.js","./Color-gncXBiLc.js","./colorUtils-Rxh2V3ai.js","./ActionToggle-__-l4AdQ.js","./Identifiable-BrT7zvUW.js","./TextSymbol-BQ_NW9Xo.js","./collectionUtils-CbaToa73.js","./Portal-CTRRujjZ.js","./aaBoundingBox-CeBivBRq.js","./HeightModelInfo-B3GZyQFz.js","./projection-B2I9Bzj_.js","./projectBuffer-DOU0xvVi.js","./geodesicConstants-yASAK_zX.js","./projectBoundingRect-BA_jRNoI.js","./projectPointToVector-BS0u8fq6.js","./boundedPlane-Dyz2ub5d.js","./sphere-DQxj5tsv.js","./mat4-Fi6iAz29.js","./common-DQOJ18NT.js","./vec32-Dvg_eL9J.js","./vec42-YcqnINSP.js","./vec4f64-o2zAXfmz.js","./mat3-CR8GKnhD.js","./mat3f64-BBpwCtoL.js","./plane-4dpuo6-e.js","./mat4f64-Dk4dwAN8.js","./quatf64-CCm9z-pX.js","./vec2f64-Dy6m9Nrb.js","./mathUtils-B9R7G-2c.js","./lineSegment-C-CDF7QX.js","./RenderCoordsHelper-BbefYyBA.js","./spatialReferenceEllipsoidUtils-DM073JUd.js","./projectVectorToPoint-d6Mr4zvQ.js","./projectVectorToVector-dS8io47t.js","./dehydratedFeatureUtils-1rrRm6hF.js","./ViewingMode-Dodu7ZZk.js","./scaleUtils-CfLu-sg1.js","./layerUtils-dJgsXxkC.js","./DefaultUI-DqLHkAzt.js","./UpdatingHandles-ptqz1ck8.js","./InputManager-Bs9UE-jw.js","./signal-DSa0yokC.js","./Basemap-BHdJ6wQH.js","./loadAll-Do8S8AWH.js","./PortalItem-CXk7DqVv.js","./basemapDefinitions-BmB40s1J.js","./writeUtils-C3ZSK02Z.js","./groundInstanceUtils-Ben03ZCf.js","./CollectionFlattener-B9CFCLSp.js","./editableLayers-BZGjz8nI.js","./catalogUtils-CK4eMvD1.js","./basemapEnsureType-BVU7UGJp.js","./basemapUtils-DQr5T1wn.js","./utils-DYurMneM.js","./mat4f32-DcsiF_Rp.js","./TablesMixin-BzMj7HDl.js","./Layer-C9uQlTBT.js","./TimeExtent-J5qnUFx_.js","./timeUtils-D2X862bk.js","./timeZoneUtils-COos5xIr.js","./ReactiveMap-Dwhwbx9R.js","./Query-DCBIeen2.js","./Field-Cyk7Ur5d.js","./fieldType-L-VlbZqy.js","./FullTextSearch-BWm_kPUE.js","./selectionUtils-DYi6daQO.js","./ViewEvents-Hl5AOQnu.js","./IViewEvents-Bci6PjlS.js","./interfaces-D6pIddIh.js","./screenUtils-DyhV4TAA.js","./HighlightDefaults-ESbuT2uR.js","./a11yUtils-CSYUX1kC.js","./heightModelInfoUtils-CMg1cdju.js","./unitBezier-B1N-tmtC.js","./imageUtils-brik-GLm.js","./capabilities-DwlKKScG.js","./themeUtils-C3zvZbsE.js","./globalCss-CZa70j6i.js","./accessibleHandler-rIBXQ52V.js","./CompassViewModel-BAJa4WdS.js","./GoTo-BsXOAO95.js","./ZoomViewModel-BZXEbLSs.js","./cameraUtils-D51h-KGF.js","./Intersector-DqUGp7Vs.js","./intersectorUtils-l6zkk4nF.js","./verticalOffsetUtils-CUH6QZ7-.js","./orientedBoundingBox-9z4w3ZAL.js","./quat-4pa1e6ds.js","./computeTranslationToOriginAndRotation-BT43Xu5d.js","./Attribute-B-NAci_J.js","./Octree-B-jwmuW2.js","./InterleavedLayout-Dvj-Snan.js","./BufferView-_QDXRCew.js","./vec2-maR1OrZI.js","./types-D0PSWh4d.js","./earthUtils-5Ip67eD0.js","./ElevationProvider-aS5xrHHy.js","./spatialReferenceSupport-CJqi4Nvp.js","./ElevationSamplerData-ejt2NMnl.js","./terrainUtils-NB9gChf5.js","./TileInfo-CRfZy5zq.js","./TileKey-DZd6gJy7.js","./OverlayCompositing.glsl-BbJKjUZQ.js","./GridLocalOriginFactory-BvhZ_UoU.js","./Material-Ba8x5bbY.js","./VertexAttribute-Cq4MnHjR.js","./NoParameters-t-PuNrgq.js","./FloatArray-BCfeX8wo.js","./BindType-BBwFZqyN.js","./Matrix3PassUniform-Bhi2fM3C.js","./Texture-D-SqNa4i.js","./enums-D9v74xTE.js","./getDataTypeBytes-BTGR5GyG.js","./renderState-e7QeQoUO.js","./basicInterfaces-CZwQPxTp.js","./Indices-Db9lERgy.js","./triangle-D_E6eTS3.js","./ShaderTechniqueConfiguration-YrUOztAU.js","./glsl-BH37Aalp.js","./lengthUtils-DjJgJFRg.js","./requestImageUtils-Brn0e8z8.js","./TextureFormat-1mYWTFa-.js","./RibbonLine.glsl-D3IEIaDR.js","./sdfPrimitives-B8Jbwvqs.js","./doublePrecisionUtils-B0owpBza.js","./floatRGBA-CR2j2c7-.js","./ShaderBuilder-DV1s2efh.js","./RgbaFloatEncoding.glsl-_io2eW3M.js","./SceneLighting-fZH2UQ_L.js","./RenderCamera-BovI3JTe.js","./axisAngleDegrees-8Sw4vC28.js","./weather-DtiKeY2t.js","./BooleanBindUniform-xvVHJCDz.js","./Float4DrawUniform-C_Hqa-pI.js","./RenderPlugin-B2sz29jJ.js","./VertexElementDescriptor-BOD-G50G.js","./VertexArrayObject-DcVjXzZo.js","./BufferObject-CIl3vJtA.js","./memoryEstimations-5gFNwkKK.js","./NestedMap-GuqgquCN.js","./HUDRenderStyle-BhGvVxgm.js","./Scheduler-B_GuBefw.js","./debugFlags-ZrDyTcDc.js","./vec3f32-nZdmKIgz.js","./FramebufferObject-DHwDHMWe.js","./glUtil-D0YUa0ow.js","./ShadowCastVisualizeTechniqueConfiguration-WdqoNZsk.js","./SunCalc-uwgdo0BB.js","./VirtualLighting-CTSkZQzH.js","./LineCallout.glsl-BFpkOc4i.js","./visualVariableUtils-Bp9QCb8E.js","./ElevationContext-jcnAn7VT.js","./unitConversionUtils-C4AR5obr.js","./hydratedFeatures-BVVSs98j.js","./graphicUtils-Daa6cjYT.js","./meshVertexSpaceUtils-SW0WEjNN.js","./MeshLocalVertexSpace-C0YDTRex.js","./vec2f32-BbH2jxlN.js","./DefaultBufferWriter-D4XUxbP-.js","./dehydratedFeatures-Nwhn-hep.js","./quantizationUtils-2Az-xHPA.js","./featureConversionUtils-DpmsPUmt.js","./OptimizedFeature-DcMLlxvB.js","./OptimizedGeometry-7IxBWtHr.js","./OptimizedFeatureSet-Blu9Ckm7.js","./edgeUtils-52Urp6s4.js","./NormalAttribute.glsl-BPQl43kJ.js","./Matrix3DrawUniform-B_gSHO7v.js","./webStyleAcceptedFormats-CG7ZQ6BV.js","./GeometryUtil-vHI0hYMT.js","./RealisticTree.glsl-BIYA2y1x.js","./Intersector-DPK4WnQE.js","./DefaultMaterial-B5sYRDQR.js","./GLTextureMaterial-BXvkeRxQ.js","./VertexColor.glsl-C67vI27I.js","./Matrix4PassUniform-LFIUaE9i.js","./VerticalOffset.glsl-0YVQE7vQ.js","./Matrix4sPassUniform--uPzDbTP.js","./Float2PassUniform-Blij1ug3.js","./CameraSpace.glsl-BZ4Eapt3.js","./HUDVisibility.glsl-DSeZY4v-.js","./ray-D3Okb4cY.js","./RenderFeature-3I21ZjJq.js","./unitFormatUtils-Dbksq3U5.js","./ByteSizeUnit-BsxeN7wM.js","./quantityUtils-1LswOhxZ.js","./ZoomMomentumEstimator-Igei2Npb.js","./HUDMaterial-DRUv4rua.js","./labelFormatUtils-B--9rEVY.js","./labelUtils-Dq8OkaT-.js","./DepthRange-C25RnOB3.js","./elevationInfoUtils-RSZ4Logn.js","./hitTest-CblPROa1.js","./LayerConstants-B33OP6sh.js","./intersectorUtilsConversions-CZnn6t-z.js","./ElevationRange-BrgM1moX.js","./hitTestSelectUtils-UXJPjatw.js","./MemCache-CDoaVBHf.js","./DefaultLoadingContext-b8vwa5ZD.js","./wosrLoader-F8PxTYxV.js","./Version-9k2AOv05.js","./DrawParameters-C0gywgJQ.js","./Normals-OOhKYumi.js","./TileStrategy-DlGVvP4C.js","./TileKey-BtGhNUzq.js","./ScheduledQueueProcessor-DfrR8pp0.js","./RenderableTile-Ewnw5ULl.js","./config-MDUrh2eL.js","./StyleDefinition-DxJzQnGW.js","./enums-BJSSbDkD.js","./enums-BRzLM11V.js","./GeometryUtils-B5FJlfZD.js","./DefaultVertexAttributeLayouts-DMsCtEEh.js","./DisplayObject-S19ALweP.js","./resources-CcZcI9oR.js","./WorkerHandle-B2QLNs3X.js","./colorUtils-BAowQmkN.js","./vec3-Bn81gjoR.js","./vec33-KumQEj7U.js","./ShaderTechniqueRepository-CuJwDr2t.js","./Blit-D5AxBSxC.js","./testSVGPremultipliedAlpha-CpxLiQJP.js","./RenderingContext-BkhmhK8E.js","./ProgramCache-D9MJNX7j.js","./Program-DD6La1z3.js","./layerViewUtils-tkZ5z_iY.js","./makeScheduleFunction-CggzEh3c.js"])))=>i.map(i=>d[i]);
import{s as Ge,c as vt,r as S,m as k,a as dt,g as he,N as kt,B as Ue,aR as He,aD as It,l as Nt}from"./Accessor-BHnuXKD2.js";import{V as Dt,d as zt,A as Lt}from"./reactiveUtils-BR0C1Kq4.js";import{e as Et}from"./earcut-Lltz9D9k.js";import{e as X}from"./mat4f64-Dk4dwAN8.js";import{s as je,A as pt,o as Q,c as Ft,_ as ue,b as Ve,E as ht,R as Bt}from"./vec32-Dvg_eL9J.js";import{n as R,u as We,t as qe,_ as de}from"./vec3f64-BLpZdpfb.js";import{$ as Ke,j as Ye}from"./Point-XGrwlf63.js";import{m as pe}from"./computeTranslationToOriginAndRotation-BT43Xu5d.js";import{t as N,d as Z,u as Qe,m as Ze,A as Xe}from"./aaBoundingBox-CeBivBRq.js";import{w as me,i as ut}from"./Indices-Db9lERgy.js";import{r as fe}from"./vec3-Bn81gjoR.js";import{l as ge}from"./ViewingMode-Dodu7ZZk.js";import{u as Je,g as Gt,R as ts,o as es}from"./ElevationContext-jcnAn7VT.js";import{j as ss}from"./mat3-CR8GKnhD.js";import{e as is}from"./mat3f64-BBpwCtoL.js";import{h as rs,e as os,i as ns}from"./mat4-Fi6iAz29.js";import{t as as,e as Ut}from"./SnappingCandidate-O5eRSE6e.js";import{y as cs,o as ls,k as Ht,q as hs,v as us,w as ds}from"./LineCallout.glsl-BFpkOc4i.js";import{U as ps,b as _e}from"./graphicUtils-Daa6cjYT.js";import{w as ms}from"./Extent-CBBGeHb-.js";import{n as fs,j as gs}from"./Polyline-BmuD2-ZN.js";import{c as _s,a as ye,p as ve}from"./triangulationUtils-ChyeOnqC.js";import{t as I}from"./Attribute-B-NAci_J.js";import{e as mt,t as ys,O as vs}from"./Material-Ba8x5bbY.js";import{f as Rt,k as jt,m as we,t as xe,P as ws,Q as wt}from"./FloatArray-BCfeX8wo.js";import{e as E}from"./VertexAttribute-Cq4MnHjR.js";import{a as xs}from"./edgeUtils-52Urp6s4.js";import{r as bs}from"./ElevationProvider-aS5xrHHy.js";import{o as As}from"./projectBuffer-DOU0xvVi.js";import{t as $s,o as Es}from"./OverlayCompositing.glsl-BbJKjUZQ.js";import{a as Rs}from"./NormalAttribute.glsl-BPQl43kJ.js";import{e as xt}from"./basicInterfaces-CZwQPxTp.js";import{e as Ss,s as Ps}from"./Normals-OOhKYumi.js";import{A as Ts}from"./RibbonLine.glsl-D3IEIaDR.js";import{z as Vt}from"./DefaultMaterial-B5sYRDQR.js";import{a as Cs,h as be,n as tt,t as et}from"./BooleanBindUniform-xvVHJCDz.js";import{_ as Ae}from"./index-tefRSezt.js";import{n as V}from"./glsl-BH37Aalp.js";import{o as Os,R as Ms}from"./SceneLighting-fZH2UQ_L.js";import{c as $e,e as ks}from"./NoParameters-t-PuNrgq.js";import{i as Ee}from"./ShaderBuilder-DV1s2efh.js";import{B as Re,g as Se}from"./renderState-e7QeQoUO.js";import{t as Is}from"./Matrix3PassUniform-Bhi2fM3C.js";import{O as $t,_ as Wt,N as qt,I as W,E as Kt,F as Ns,D as Ds,L as zs}from"./enums-D9v74xTE.js";import{r as Ls}from"./VertexArrayObject-DcVjXzZo.js";import{E as Fs}from"./BufferObject-CIl3vJtA.js";import{n as Pe}from"./vec2f64-Dy6m9Nrb.js";import{r as Bs,s as st,n as Gs}from"./vec4f64-o2zAXfmz.js";import{h as bt}from"./Color-gncXBiLc.js";import{i as Us,c as Hs}from"./fontUtils-D0SfAiSy.js";import{u as Yt}from"./screenUtils-_ZIvrt5o.js";import{i as js}from"./Evented-DCWccWGU.js";import{E as Vs,s as Ws}from"./vec42-YcqnINSP.js";import{g as qs,o as Ks}from"./Scheduler-B_GuBefw.js";import{p as Ys,w as Qs}from"./Texture-D-SqNa4i.js";function Rr(e,t,s){const i=(t.length>0?t[0]:e.length/3)-1,r=_s(e,i,s);if(r!==fs.Z){e=e.slice();for(let o=0;o<e.length;o+=3)e[o+r]=e[o+2]}return Et(e,t,3)}function Sr(e){const t=[[E.POSITION,new I(e.attributeData.position,e.indices,3,!0)]],s=me(e.indices.length);return e.attributeData.colorFeature!=null?t.push([E.COLORFEATUREATTRIBUTE,new I([e.attributeData.colorFeature],s,1,!0)]):e.attributeData.color&&t.push([E.COLOR,new I(e.attributeData.color,s,4,!0)]),e.attributeData.uvMapSpace&&t.push([E.UVMAPSPACE,new I(e.attributeData.uvMapSpace,e.indices,4,!0)]),e.attributeData.boundingRect&&t.push([E.BOUNDINGRECT,new I(e.attributeData.boundingRect,e.indices,9,!0)]),new Rt(e.material,t,e.mapPositions,mt.Mesh,e.attributeData.objectAndLayerIdColor)}function Pr(e,t=null){const s=[[E.POSITION,new I(e.attributeData.position,e.indices,3,!0)],[E.UV0,new I(e.attributeData.uv0,e.indices,2,!0)]];return new Rt(e.material,s,e.mapPositions,mt.Mesh,t)}function Zs(e){switch(e.type){case"extent":if(e instanceof ms)return gs.fromExtent(e);break;case"polygon":return e}return null}let Tr=class{constructor(t,s,i){this.renderData=t,this.layerUid=s,this.graphicUid=i,this.outGeometries=new Array}};function Te(e,t,s,i){const r=ye(e.rings,!!e.hasZ&&i.mode!=="on-the-ground",ve.CCW_IS_HOLE,e.spatialReference),o=N(r.position.length),n=Je(r.position,e.spatialReference,0,o,0,r.position,0,r.position.length/3,t,s,i),l=n!=null;return new ti(r.position,o,Oe(r.polygons,r.position,o),Ce(r.outlines,r.position,o),l,n)}function Or(e,t){const s=ye(e.rings,!1,ve.CCW_IS_HOLE),i=As(s.position,e.spatialReference,0,s.position,t,0);for(let r=2;r<s.position.length;r+=3)s.position[r]=$s;return{position:s.position,polygons:Oe(s.polygons,s.position),outlines:Ce(s.outlines,s.position),projectionSuccess:i}}function Ce(e,t,s=null){return e.filter(({count:i})=>i>1).map(({index:i,count:r})=>{const o=3*i,n=3*r;return s!=null?new Me(i,r,Z(t,o,n),Z(s,o,n)):new St(i,r,Z(t,o,n))})}function Oe(e,t,s=null){const i=new Array;for(const{index:r,count:o,holeIndices:n,pathLengths:l}of e){if(o<=1)continue;const a=3*r,c=3*o,p=n.map(m=>m-r),d=s!=null?new Xs(r,o,Z(t,3*r,3*o),Z(s,a,c),p,l):new Js(r,o,Z(t,3*r,3*o),p,l);i.push(d)}return i}let St=class{constructor(t,s,i){this.index=t,this.count=s,this.position=i}};class Me extends St{constructor(t,s,i,r){super(t,s,i),this.mapPositions=r}}class Xs extends Me{constructor(t,s,i,r,o,n){super(t,s,i,r),this.holeIndices=o,this.pathLengths=n}}let Js=class extends St{constructor(t,s,i,r,o){super(t,s,i),this.holeIndices=r,this.pathLengths=o}};class ti{constructor(t,s,i,r,o,n){this.position=t,this.mapPositions=s,this.polygons=i,this.outlines=r,this.projectionSuccess=o,this.sampledElevation=n}}const ei=["polygon","extent"];class Ir extends cs{constructor(t,s,i,r){super(t,s,i,r),this.ensureDrapedStatus(!1)}async doLoad(){var c,p,d,m;if(!this._drivenProperties.size){const x=ps(this._getSymbolSize());if(x)throw new Ge("graphics3dextrudesymbollayer:invalid-size",x)}const t=(p=(c=this.symbolLayer)==null?void 0:c.material)==null?void 0:p.color,s=this._getCombinedOpacityAndColor(t),i=We(s),r=s[3],o=r<1||this.needsDrivenTransparentPass,n=(m=(d=this.symbolLayer)==null?void 0:d.material)==null?void 0:m.emissiveFactor,l=n?Ve(qe(n)):de,a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:r,transparent:o,cullFace:o?xt.None:xt.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,emissiveFactor:l,offsetTransparentBackfaces:!0,normalType:Rs.Compressed};this._materials[M.Main]=new Vt(a,this._context),this._materials[M.Bottom]=new Vt({...a,cullFace:xt.Back},this._context),this._context.stage.addMany(this._materials)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(t){const s=t.graphic;if(!this._validateGeometry(s.geometry,ei,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(t.renderingInfo,255),r=this.setGraphicElevationContext(s);return this._createAs3DShape(s,t.renderingInfo,i,r,s.uid)}layerOpacityChanged(t,s){var l,a,c,p;const i=(a=(l=this.symbolLayer)==null?void 0:l.material)==null?void 0:a.color,r=this._getCombinedOpacity(i),o=r<1||this.needsDrivenTransparentPass;(c=this._materials[M.Main])==null||c.setParameters({opacity:r,transparent:o}),(p=this._materials[M.Bottom])==null||p.setParameters({opacity:r,transparent:o});const n=this._getLayerOpacity();t.forEach(d=>{var m;return(m=s(d))==null?void 0:m.layerOpacityChanged(n,this._context.isAsync)})}layerElevationInfoChanged(t,s){return this.updateGraphics3DGraphicElevationInfo(t,s,Gt)}slicePlaneEnabledChanged(t,s){var i,r;return(i=this._materials[M.Main])==null||i.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),(r=this._materials[M.Bottom])==null||r.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t.forEach(o=>{const n=s(o);n!=null&&n.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){var s,i;const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return(s=this._materials[M.Main])==null||s.setParameters(t),(i=this._materials[M.Bottom])==null||i.setParameters(t),!0}_getExtrusionSize(t){let s;return s=t.size&&this._drivenProperties.size?ls(t.size,2)??0:this._getSymbolSize(),s/=this._context.renderCoordsHelper.unitInMeters,s}applyRendererDiff(t,s){return this._drivenPropertiesChanged(s)?Ht.RecreateSymbol:Ht.RecreateGraphics}async queryForSnapping(t,s,i,r){const o=this._getExtrusionSize(i)*this._context.renderCoordsHelper.unitInMeters/Ke(s),{objectId:n,target:l}=t,a=vt(l);switch(a.z=(a.z??0)+o,t.type){case"edge":{const{start:c,end:p}=t,d=vt(c),m=vt(p);return d.z=(d.z??0)+o,m.z=(m.z??0)+o,[Ut(n,a,1/0,d,m)]}case"vertex":return[as(n,a,1/0),Ut(n,l,1/0,l,a)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,s,i,r,o){const n=Zs(t.geometry);if(n==null)return null;if(n.rings.length===0||!n.rings.some(P=>P.length>0))return this._logGeometryValidationWarnings(n.rings,"rings","ExtrudeSymbol3DLayer"),null;const l=Te(n,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(l,n.rings,"rings","ExtrudeSymbol3DLayer");const a=_e(n);if(a==null)return null;const c=new Array,p=new Array,d=Qe(),m=X(),x=R(),u=this._context.renderCoordsHelper.viewingMode===ge.Global;u||this._context.renderCoordsHelper.worldUpAtPosition(null,x),pe(n.spatialReference,[a.x,a.y,0],m,this._context.renderCoordsHelper.spatialReference);const y=X();rs(y,m);const v=is();ss(v,y);const{polygons:w,mapPositions:f,position:_}=l,g=new Map,b=this._materials[M.Main];for(const P of w){const D=P.count;if(this._context.clippingExtent&&(Ze(P.mapPositions,d),!Xe(d,this._context.clippingExtent)))continue;const z=Et(P.mapPositions,P.holeIndices,3);if(z.length===0)continue;const L=z.length,G=6*D,ft=ut(G+L),gt=ut(L),ot=N(3*G),Pt=N(3*G),Tt=N(3*G),Ct=N(G);ke(_,f,z,P,ot,Tt,Pt,Ct,ft,gt,this._getExtrusionSize(s),x,u),fe(ot,ot,y);const Ot=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:o,layerUid:this._context.layer.uid}),_t=new hi(ot,Tt,Ss(Pt),Ct),yt=Qt(b,ft,ft.length-gt.length,_t,i,Ot),Le=D,Fe=D,Be=2*P.count,Mt=new ui(Le,Fe,Be,L/3);Ie(yt,Mt,m),g.set(yt,Mt),c.push(yt,Qt(this._materials[M.Bottom],gt,0,_t,i,Ot)),p.push(_t.heights)}if(c.length===0)return null;const h=new Ts({geometries:c,layerUid:this._context.layer.uid,graphicUid:o,isElevationSource:!0});h.transformation=m;const A=xs(this.symbolLayer,{opacity:this._getLayerOpacity()}),$=A?new hs(this._materials[M.Main],A,this._context.slicePlaneEnabled):null,C=new us(this,h,c,null,null,(P,D,z,L,G)=>ri(P,D,z,L,G,p,g),r,$);return C.alignedSampledElevation=l.sampledElevation,C.needsElevationUpdates=Gt(r.mode),C}}function Qt(e,t,s,i,r,o){const n=me(t.length),l=[[E.POSITION,new I(i.positions,t,3,!0)],[E.NORMALCOMPRESSED,new I(i.normals,t,2,!0)],[E.COLOR,new I(r,n,4,!0)]];return new Rt(e,l,i.elevation,mt.Mesh,o,s)}function ke(e,t,s,i,r,o,n,l,a,c,p,d,m){{const x=s.length/3,u=2*i.count;si(e,t,i.index,i.count,s,0,x,r,o,n,l,a,c,u,p,d,m)}{let x=0,u=2*i.count,y=0;const v=i.pathLengths[0];Zt(r,o,l,n,x,v,i.count,u,a,y,p),u+=4*v,y+=2*v,x+=v;for(let w=1;w<i.pathLengths.length;++w){const f=i.pathLengths[w];Zt(r,o,l,n,x,f,i.count,u,a,y,p),u+=4*f,y+=2*f,x+=f}}}function si(e,t,s,i,r,o,n,l,a,c,p,d,m,x,u,y,v){je(O,y);{const w=u>0?1:-1;let f=3*s,_=0,g=3*_,b=i,h=3*b;for(let A=0;A<i;++A){const $=e[f],C=e[f+1],P=e[f+2];v&&(O[0]=$,O[1]=C,O[2]=P,pt(O,O)),l[g+0]=$,l[g+1]=C,l[g+2]=P;const D=t[f+0],z=t[f+1],L=t[f+2];a[g+0]=D,a[g+1]=z,a[g+2]=L,c[g+0]=-w*O[0],c[g+1]=-w*O[1],c[g+2]=-w*O[2],p[_]=0,l[h+0]=$+u*O[0],l[h+1]=C+u*O[1],l[h+2]=P+u*O[2],a[h+0]=D,a[h+1]=z,a[h+2]=L,p[b]=u,g+=3,h+=3,f+=3,_+=1,b+=1}}{let w=3*o,f=0,_=3*x;const g=u<0?ie:se,b=u<0?se:ie;for(let h=0;h<n;++h)m[f]=r[w+g[0]],m[f+1]=r[w+g[1]],m[f+2]=r[w+g[2]],d[_]=r[w+b[0]]+i,d[_+1]=r[w+b[1]]+i,d[_+2]=r[w+b[2]]+i,f+=3,_+=3,w+=3}}function nt(e,t,s,i,r,o,n){i[o]=i[n],n*=3,e[o*=3]=e[n],e[o+1]=e[n+1],e[o+2]=e[n+2],t[o]=t[n],t[o+1]=t[n+1],t[o+2]=t[n+2],s[o]=r[0],s[o+1]=r[1],s[o+2]=r[2]}const J=R();function Zt(e,t,s,i,r,o,n,l,a,c,p){let d=r,m=r+1,x=r+n,u=r+n+1,y=l,v=l+1,w=l+2*o,f=l+2*o+1;p<0&&(d=r+n+1,u=r);let _=3*c;for(let g=0;g<o;++g)g===o-1&&(m=r,p>0?u=r+n:d=r+n),ii(e,d,m,x,J),nt(e,t,i,s,J,y,d),nt(e,t,i,s,J,v,m),nt(e,t,i,s,J,w,x),nt(e,t,i,s,J,f,u),a[_]=y,a[_+1]=w,a[_+2]=f,a[_+3]=y,a[_+4]=f,a[_+5]=v,_+=6,d++,m++,x++,u++,y+=2,v+=2,w+=2,f+=2}const At=R(),Xt=R(),Jt=R(),te=R(),ee=R();function ii(e,t,s,i,r){t*=3,s*=3,i*=3,Q(At,e[t++],e[t++],e[t++]),Q(Xt,e[s++],e[s++],e[s++]),Q(Jt,e[i++],e[i++],e[i++]),Ft(te,Xt,At),Ft(ee,Jt,At),ue(r,ee,te),pt(r,r)}const q=R();function ri(e,t,s,i,r,o,n){const l=e.stageObject,a=l.geometries,c=a.length,p=t.mode!=="absolute-height";let d=0;const m=l.transformation,x=os(X(),m);for(let u=0;u<c;u+=2){const y=a[u];if(!ds(y))continue;const v=y.getMutableAttribute(E.POSITION).data,w=o[u/2],f=new bs(y.mapPositions),_=v.length/3;let g=!1,b=0;{let h=0;for(let A=0;A<_;A++){q[0]=v[h],q[1]=v[h+1],q[2]=v[h+2],i(f,at),p&&(b+=at.sampledElevation),ys.TESTS_DISABLE_OPTIMIZATIONS?(Q(T,f.array[f.offset],f.array[f.offset+1],at.z+w[h/3]),s!=null&&r.toRenderCoords(T,s,T),ht(T,T,x)):(Q(T,v[h],v[h+1],v[h+2]),ht(T,T,m),r.setAltitude(T,at.z+w[h/3]),ht(T,T,x)),v[h]=T[0],v[h+1]=T[1],v[h+2]=T[2];const $=oi/r.unitInMeters;(Math.abs(q[0]-v[h])>=$||Math.abs(q[1]-v[h+1])>=$||Math.abs(q[2]-v[h+2])>=$)&&(g=!0),f.offset+=3,h+=3}}if(g){const h=n.get(y);h&&Ie(y,h,m),l.geometryVertexAttributeUpdated(a[u],E.NORMALCOMPRESSED),y.invalidateBoundingInfo(),l.geometryVertexAttributeUpdated(a[u],E.POSITION),a[u+1].invalidateBoundingInfo(),l.geometryVertexAttributeUpdated(a[u+1],E.POSITION)}d+=b/_}return d/c}function Ie(e,t,s){const i=e.getMutableAttribute(E.POSITION),r=e.getMutableAttribute(E.NORMALCOMPRESSED).data,{topVertexStart:o,topVertexCount:n,topFaceStart:l,topFaceCount:a}=t,c=i.data,p=n,d=e.attributes.get(E.POSITION).indices,m=l+a,x=o+n,u=N(3*p);for(let g=0;g<p;++g){const b=3*g;u[b+0]=0,u[b+1]=0,u[b+2]=0}const y=ni,v=ai,w=ci,f=li,_=O;for(let g=l;g<m;++g){const b=3*g;for(let h=0;h<3;++h){const A=d[b+h];f[h]=A;const $=3*A;Q(T,c[$+0],c[$+1],c[$+2]),ht(y[h],T,s)}Bt(v,y[1],y[0]),Bt(w,y[2],y[0]),ue(_,v,w),pt(_,_);for(let h=0;h<3;++h){const A=3*(f[h]-o);u[A+0]+=_[0],u[A+1]+=_[1],u[A+2]+=_[2]}}for(let g=o;g<x;++g){const b=3*(g-o),h=u[b+0],A=u[b+1],$=u[b+2],C=Math.sqrt(h*h+A*A+$*$);Ps(r,g,h/C,A/C,$/C)}}const T=R(),O=R(),at=new ts,se=[0,2,1],ie=[0,1,2],oi=.01,ni=[R(),R(),R()],ai=R(),ci=R(),li=[0,0,0];var M;(function(e){e[e.Main=0]="Main",e[e.Bottom=1]="Bottom"})(M||(M={}));class hi{constructor(t,s,i,r){this.positions=t,this.elevation=s,this.normals=i,this.heights=r}}class ui{constructor(t,s,i,r){this.topVertexStart=t,this.topVertexCount=s,this.topFaceStart=i,this.topFaceCount=r}}class Ne extends $e{}function di(){const e=new Ee;return e.include(Cs),e.outputs.add("fragColor","vec4",0),e.fragment.uniforms.add(new jt("colorTexture",t=>t.color),new jt("focusArea",t=>t.focusArea),new Os("focusAreaEffectMode",t=>t.effect??1)).main.add(V`float mask = texture( focusArea, uv, 0.0 ).r;
vec4 color = texture( colorTexture, uv, 0.0 );
vec4 colorDeSaturate = vec4(color.r * 0.25 + color.g * 0.5 + color.b * 0.25);
if (focusAreaEffectMode == 1) {
fragColor = mask > 0.0 ? color : 0.55 * colorDeSaturate + 0.45;
} else {
fragColor = mask > 0.0 ? color : 0.33 * mix(color, colorDeSaturate, 0.);
}`),e}const pi=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaColorPassParameters:Ne,build:di},Symbol.toStringTag,{value:"Module"}));let re=class extends we{constructor(t,s){super(t,s,new xe(pi,()=>Ae(()=>import("./ShadowCastAccumulate.glsl-7ziGQBCy.js").then(i=>i.F),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257]),import.meta.url)))}initializePipeline(){return Re({colorWrite:Se})}},K=class extends be{constructor(e){super({...e,view:e.focusAreas.view}),this.consumes={required:[tt.COMPOSITE,et.FOCUSAREA]},this.produces=tt.COMPOSITE,this._passParameters=new Ne}precompile(){this.techniques.precompile(re)}render(e){const t=this.techniques.get(re),s=e.find(({name:p})=>p===tt.COMPOSITE);if(!t.compiled)return this.requestRender(),s;const i=this.bindParameters,r=i.camera,o=r.fullViewport[2],n=r.fullViewport[3],l=e.find(({name:p})=>p===et.FOCUSAREA),a=this.fboCache.acquire(o,n,this.produces),c=this.renderingContext;return c.gl.clear(c.gl.STENCIL_BUFFER_BIT),c.bindFramebuffer(a.fbo),this._passParameters.color=s.getTexture(),this._passParameters.focusArea=l.getTexture(),this._passParameters.effect=mi[this.focusAreas.style],c.bindTechnique(t,i,this._passParameters),c.screen.draw(),a.attachDepth(s.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),a}};var it;S([k()],K.prototype,"consumes",void 0),S([k()],K.prototype,"produces",void 0),S([k({constructOnly:!0})],K.prototype,"focusAreas",void 0),K=S([dt("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaColorNode")],K),function(e){e[e.NONE=0]="NONE",e[e.BRIGHT=1]="BRIGHT",e[e.DARK=2]="DARK"}(it||(it={}));const mi={none:it.NONE,bright:it.BRIGHT,dark:it.DARK};let De=class extends $e{constructor(){super(...arguments),this.origin=de}};function fi(){const e=new Ee;return e.attributes.add(E.POSITION,"vec3"),e.outputs.add("fragColor","vec4",0),e.vertex.uniforms.add(new Is("proj",t=>t.camera.projectionMatrix),new ws("view",(t,s)=>ns(gi,s.camera.viewMatrix,t.origin))).main.add(V`gl_Position = proj * view * vec4(position, 1.0);`),e.fragment.main.add(V`fragColor = vec4(1., 0., 0., 1.);`),e}const gi=X(),_i=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaMaskDrawParameters:De,build:fi},Symbol.toStringTag,{value:"Module"}));let oe=class extends we{constructor(t,s){super(t,s,new xe(_i,()=>Ae(()=>import("./ShadowCastAccumulate.glsl-7ziGQBCy.js").then(i=>i.p),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257]),import.meta.url)))}initializePipeline(){return Re({colorWrite:Se,depthTest:{func:$t.LEQUAL}})}},Y=class extends be{constructor(t){super({...t,view:t.focusAreas.view}),this.consumes={required:[et.FOCUSAREA,tt.TRANSPARENT]},this.produces=et.FOCUSAREA,this._vaos=new Array,this._counts=new Array,this._origins=new Array,this._maskParameters=new De}initialize(){this.updateGeometries()}destroy(){this._vaos.forEach(t=>t.dispose()),this._vaos.length=this._counts.length=this._origins.length=0}precompile(){this.techniques.precompile(oe)}render(t){const s=this.techniques.get(oe),i=this.bindParameters,r=i.camera,o=r.fullViewport[2],n=r.fullViewport[3],l=this.fboCache.acquire(o,n,et.FOCUSAREA,Ms.RGBA);if(!s.compiled||!this._vaos)return this.requestRender(),l;const a=t.find(({name:d})=>d===tt.TRANSPARENT),c=this.renderingContext;l.attachDepth(a.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),c.bindFramebuffer(l.fbo),c.clear(Wt.COLOR|Wt.STENCIL),c.setViewport(0,0,o,n),c.gl.clearStencil(0),c.gl.clear(c.gl.STENCIL_BUFFER_BIT),c.setClearStencil(0);const p=c.bindTechnique(s,i);c.setFaceCullingEnabled(!1),c.setStencilTestEnabled(!0),c.setStencilOpSeparate(qt.FRONT,W.KEEP,W.INCR_WRAP,W.KEEP),c.setStencilOpSeparate(qt.BACK,W.KEEP,W.DECR_WRAP,W.KEEP),c.setDepthWriteEnabled(!1);for(let d=0;d<this._vaos.length;d++){const m=this._vaos[d],x=this._counts[d];this._maskParameters.origin=this._origins[d],p.bindDraw(i,ks,this._maskParameters),c.bindVAO(m),c.setStencilWriteMask(255),c.setStencilFunction($t.ALWAYS,0,255),c.setColorMask(!1,!1,!1,!1),c.drawArrays(Kt.TRIANGLES,0,x),c.setStencilWriteMask(0),c.setStencilFunction($t.NOTEQUAL,0,255),c.setColorMask(!0,!0,!0,!0),c.drawArrays(Kt.TRIANGLES,0,x)}return l}updateGeometries(){if(!this.view._stage)return;this._vaos.forEach(s=>s.dispose()),this._vaos.length=this._counts.length=this._origins.length=0;const t=this.focusAreas.geometries;for(const s of t){const i=new Array,r=s.indicesBottom;for(let a=0;a<r.length;a++)i.push(s.positions[3*(r[a]-1)]),i.push(s.positions[3*(r[a]-1)+1]),i.push(s.positions[3*(r[a]-1)+2]);const o=s.indicesExtruded;for(let a=0;a<o.length;a++)i.push(s.positions[3*o[a]]),i.push(s.positions[3*o[a]+1]),i.push(s.positions[3*o[a]+2]);const n=new Float32Array(i),l=new Ls(this.renderingContext,vs,new Map([["geometry",Es]]),new Map([["geometry",Fs.createVertex(this.renderingContext,Ns.STATIC_DRAW,n)]]));this._vaos.push(l),this._counts.push(r.length+o.length),this._origins.push(s.origin)}this.requestRender()}};S([k()],Y.prototype,"consumes",void 0),S([k()],Y.prototype,"produces",void 0),S([k({constructOnly:!0})],Y.prototype,"focusAreas",void 0),Y=S([dt("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaMaskNode")],Y);class yi{constructor(t,s,i,r,o,n){this.positions=t,this.indicesBottom=s,this.indicesExtruded=i,this.height=r,this.origin=o,this.color=n}}var ne;(function(e){e[e.NONE=0]="NONE",e[e.BRIGHT=1]="BRIGHT",e[e.DARK=2]="DARK"})(ne||(ne={}));const U=0,vi=5e6,ct=.42,H=.32;function Fr(e,t){if(e){if(t==="bright"){const s=(e[0]+e[1]+e[2])/3;return[s*H+(1-H),s*H+(1-H),s*H+(1-H),e[3]*H]}return t==="dark"?[e[0]*ct,e[1]*ct,e[2]*ct,e[3]*ct]:e}}let j=class extends he{constructor(e){super(e),this.style="dark",this.geometries=new Array,this._areas=new Dt,this._elevationContext=new es}initialize(){this.addHandles([zt(()=>this.style,()=>this._updateRenderNodes(),Lt)]),this.addHandles([zt(()=>this.activePolygons,()=>this._updateFocusAreaGeometries(),Lt)])}get activePolygons(){const e=new Dt;for(const t of this.areas)if(t.enabled)for(const s of t.geometries)e.push(s);return e}add(e){this.areas.add(e),this._updateFocusAreaGeometries()}addMany(e){this.areas.addMany(e),this._updateFocusAreaGeometries()}remove(e){this.areas.remove(e),this._updateFocusAreaGeometries()}removeMany(e){this.areas.removeMany(e),this._updateFocusAreaGeometries()}removeAll(){this.areas.removeAll(),this._updateFocusAreaGeometries()}containsGeometry(e){let t=!0;const s=new Ye(e);return t=this.areas.some(i=>!!i.enabled&&!!(i!=null&&i.geometries.length)&&i.geometries.some(r=>r.contains(s))),t}get areas(){return this._areas}_updateFocusAreaGeometries(){this._extrudePolygons(),this._updateRenderNodes()}_extrudePolygons(){var o,n;if(!this.view.renderCoordsHelper)return;this.geometries.length=0;const e=vi-U,t=R(),s=this.view.renderCoordsHelper.viewingMode===ge.Global,i=X(),r=X();s||this.view.renderCoordsHelper.worldUpAtPosition([0,0,0],t);for(const l of this.areas)if(l.enabled)for(const a of l.geometries){const c=_e(a);if(c==null)continue;pe(a.spatialReference,[c.x,c.y,0],i,this.view.renderCoordsHelper.spatialReference);const p=pt(wi,[i[12]-U*t[0],i[13]-U*t[1],i[14]-U*t[2]]);r[12]=-i[12],r[13]=-i[13],r[14]=-i[14];const d=Te(a,this.view.elevationProvider,this.view.renderCoordsHelper,this._elevationContext),{polygons:m,mapPositions:x,position:u}=d;for(const y of m){const v=y.count,w=Et(y.mapPositions,y.holeIndices,3);if(w.length===0)continue;const f=w.length,_=6*v,g=ut(_+f),b=ut(f),h=N(3*_),A=N(3*_),$=N(3*_),C=N(_);ke(u,x,w,y,h,$,A,C,g,b,e,t,s),fe(h,h,r);const P=new yi(h,b,g,e,[i[12]+U*p[0],i[13]+U*p[1],i[14]+U*p[2]],(o=l.outline)==null?void 0:o.color);this.geometries.push(P)}}(n=this._maskRenderNode)==null||n.updateGeometries()}_updateRenderNodes(){this.view._stage&&(this.style==="none"||this.geometries.length===0?(this._maskRenderNode=kt(this._maskRenderNode),this._colorRenderNode=kt(this._colorRenderNode)):(this._maskRenderNode??(this._maskRenderNode=new Y({focusAreas:this})),this._colorRenderNode??(this._colorRenderNode=new K({focusAreas:this}))))}};S([k()],j.prototype,"activePolygons",null),S([k()],j.prototype,"style",void 0),S([k()],j.prototype,"geometries",void 0),S([k({constructOnly:!0})],j.prototype,"view",void 0),S([k()],j.prototype,"_areas",void 0),j=S([dt("esri.views.FocusAreas")],j);const wi=R();class Br{constructor(t,s="center",i=!1,r=Pe(),o=Bs(0,0,0,-1),n="world",l=R(),a=0){this.verticalOffset=t,this.anchor=s,this.hasLabelVerticalOffset=i,this.screenOffset=r,this.centerOffset=o,this.centerOffsetUnits=n,this.translation=l,this.elevationOffset=a}}let Gr=class{constructor(t,s="center",i="center",r=null,o=Pe(),n=!0){this.placement=t,this.horizontalPlacement=s,this.verticalPlacement=i,this.text=r,this.displaySize=o,this.isFocused=n}};class ze{constructor(t){this.definition=t,this.key=JSON.stringify(t),this.haloSize=Math.round(t.halo.size),this.textStyle=ae(t.color),this.haloStyle=xi(t.halo.color),this.backgroundStyle=t.background.color[3]!==0?ae(t.background.color):null}fontString(t){const s=this.definition.font;return`${s.style} ${s.weight} ${t}px ${s.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(t,s){t.font=this.fontString(s),t.textAlign="left",t.textBaseline="alphabetic"}static async fromSymbol(t,s){var m,x,u,y,v;const i=(m=t==null?void 0:t.material)==null?void 0:m.color,r=bt.toUnitRGBA(i)??st,o=t.size!=null?Yt(t.size):12,n=t.lineHeight,l=t.background!=null?bt.toUnitRGBA(t.background.color):st,a={family:((x=t.font)==null?void 0:x.family)??"sans-serif",decoration:((u=t.font)==null?void 0:u.decoration)??"none",weight:((y=t.font)==null?void 0:y.weight)??"normal",style:((v=t.font)==null?void 0:v.style)??"normal"},c=t.halo,p=(c==null?void 0:c.color)!=null&&c.size>0?{size:Yt(c.size),color:bt.toUnitRGBA(c.color)}:{size:0,color:st},d=new ze({color:r,size:o,background:{color:l,padding:t.background!=null?[.65*o,.5*o]:[0,0],borderRadius:t.background!=null?o*(6/16):0},lineSpacingFactor:n,font:a,halo:p,pixelRatio:s});if(t.font){let w=!1;const f=d.fontString(o);try{w=(await document.fonts.load(f)).some(_=>!Us(_))}catch{Ue.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${f}'. Some text symbology may be rendered using the default browser font.`)}if(!w&&!bi.has(t.font.family))try{await Hs(t.font)}catch{}}return d}}function xi(e){return`rgb(${e.slice(0,3).map(t=>Math.floor(255*t)).toString()})`}function ae(e){return`rgba(${e.slice(0,3).map(t=>Math.floor(255*t)).toString()},${e[3]})`}const bi=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),F=4096;let lt=class extends he{constructor(e){super(e),this.type=mt.Texture,this.id=He(),this.events=new js,this._glTexture=null,this._atlas=new $i(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view._stage,this._stage.add(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=It(this._glTexture),this._frameWorker=Nt(this._frameWorker),this.updating=!1,this.events.emit("unloaded")}get glTexture(){return this._glTexture}static get maxSize(){return rt=0,[F-B-rt,F-B-rt-ce]}load(e){if(this._glTexture)return this._glTexture;const t=new Ys;return t.wrapMode=Ds.CLAMP_TO_EDGE,t.samplingMode=zs.LINEAR_MIPMAP_LINEAR,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,this._glTexture=new Qs(e,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(qs.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=Nt(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=It(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.width=e.width,this._canvas.height=e.height}_resizeAtlas(e,t){var r,o;const{width:s,height:i}=this._atlas;s===e&&i===t||(this._atlas.width=e,this._atlas.height=t,(r=this._glTexture)==null||r.resize(e,t),(o=this._glTexture)==null||o.updateData(0,0,0,s,i,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach(n=>{var l;return(l=this._uvCallbacks.get(n.textRenderer.key))==null?void 0:l.forEach(a=>a(n.uv))}),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(e,t,s,i){const r=this._atlas;if(r.width<s||r.height<i)return!1;let o=r.cursors.get(i);if(!o){if(r.height<r.nextY+i)return!1;o=[new le(r.nextY)],r.cursors.set(i,o),r.nextY+=i}let n=o.find(l=>r.width>=l.x+s);if(n==null){if(r.height<r.nextY+i)return!1;n=new le(r.nextY),r.nextY+=i,o.push(n)}return e.setNewPosition(n),this._elements.set(t,e),this._elementsToRender.set(t,e),n.x+=s,!0}_ensureCallbacks(e){const t=this._uvCallbacks.get(e);if(t)return t;const s=new Set;return this._uvCallbacks.set(e,s),s}_addCallback(e,t){this._ensureCallbacks(e).add(t)}_removeCallback(e,t){const s=this._uvCallbacks.get(e);return!(!(s!=null&&s.delete(t))||s.size!==0)&&(this._uvCallbacks.delete(e),!0)}_processAddition(e){const t=e.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,e);const s=this._atlas,i=e.textRenderer.renderedWidth,r=e.textRenderer.renderedHeight,o=i+B,n=r+B+ce;if(!this._addAtlasElement(e,t,o,n)){if(this._canRepack)this._reset();else if(s.width<o){const l=Math.min(wt(Math.max(o,1.5*s.width)),F);this._resizeAtlas(l,s.height)}else{const l=s.nextY+n,a=Math.min(wt(Math.max(l,1.5*s.height)),F);if(a>s.height)this._resizeAtlas(s.width,a);else if(s.width<F){const c=Math.min(wt(1.5*s.width),F);this._resizeAtlas(c,s.height)}}this._elements.set(t,e)}}_renderElement(e){var i;const t=e.commitNewPosition(),s=e.textRenderer;this._ctx.clearRect(t[0]-B,t[1]-B,s.renderedWidth+2*B,s.renderedHeight+2*B),s.render(this._ctx,t[0],t[1]),(i=this._uvCallbacks.get(s.key))==null||i.forEach(r=>r(e.uv))}get running(){return this.updating}runTask(e){if(this._glTexture==null)return Ks;for(;this._needsRepack&&(this._canRepack||this._atlas.height<F&&this._atlas.height<F);){this._canRepack=this._needsRepack=!1;const t=this._elements;this._elements=new Map,t.forEach(s=>this._processAddition(s)),e.madeProgress()}if(this._elementsToRender.size>0){for(const[t,s]of this._elementsToRender){if(e.done)break;this._renderElement(s),this._elementsToRender.delete(t),e.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(e,t){const s=e.key;this._addCallback(s,t);let i=this._elements.get(s);return i?Vs(i.uv,st)||t(i.uv):(i=new Ai(this._atlas,e),this._processAddition(i),this.setDirty()),{remove:()=>this._removeText(e,t)}}_removeText(e,t){const s=e.key;this._elements.get(s)&&this._removeCallback(s,t)&&(this._elements.delete(s),this._elementsToRender.delete(s),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}};S([k({constructOnly:!0})],lt.prototype,"view",void 0),S([k({type:Boolean})],lt.prototype,"updating",void 0),lt=S([dt("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],lt);const B=2,ce=2;class Ai{constructor(t,s){this._atlas=t,this.textRenderer=s,this._uv=Gs(),this._newPosition=[0,0]}get uv(){if(this._xOffset==null||this._yOffset==null)return st;const{renderedWidth:t,renderedHeight:s}=this.textRenderer;return Ws(this._uv,this._xOffset/this._atlas.width,(this._yOffset+s)/this._atlas.height,(this._xOffset+t)/this._atlas.width,this._yOffset/this._atlas.height)}setNewPosition(t){this._newPosition[0]=t.x,this._newPosition[1]=t.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class $i{constructor(t,s){this.width=t,this.height=s,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=rt}}class le{constructor(t){this.y=t,this.x=rt}}let rt=0;function Hr(e,t){t.spherical?e.vertex.code.add(V`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(V`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),t.spherical?e.vertex.code.add(V`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(V`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}export{Fr as C,j as F,Rr as a,Zs as b,Or as c,Gr as d,di as e,De as f,Tr as g,fi as h,Br as i,lt as k,Sr as l,Pr as m,Ir as o,Te as p,Hr as r,ze as s,Ne as t};
