import{a8 as pe,a0 as G}from"./Accessor-BHnuXKD2.js";import{u as C,g as q,r as Ae,o as be,s as ee,I as Fe,v as te}from"./vec32-Dvg_eL9J.js";import{n as F,r as m}from"./vec3f64-BLpZdpfb.js";import{s as ue,b as ne,v as Ee,q as ge,a as k,k as oe,N as J,H as re,U as f,E as $}from"./sphere-DQxj5tsv.js";import{c as Ne,h as Me}from"./mat4-Fi6iAz29.js";import{z as Be}from"./vec42-YcqnINSP.js";import{r as M}from"./vec4f64-o2zAXfmz.js";import{M as A,h as Se,a as xe,r as je,p as I,G as Pe,V as Ie,B as $e}from"./plane-4dpuo6-e.js";import{i as le}from"./InterleavedLayout-Dvj-Snan.js";function K(n){return n?{ray:ne(n.ray),c0:n.c0,c1:n.c1}:{ray:ne(),c0:0,c1:Number.MAX_VALUE}}function He(n,e=K()){return Ee(n,e.ray),e.c0=0,e.c1=Number.MAX_VALUE,e}function Le(n,e,t=K()){const o=Ae(n.vector);return ge(n.origin,e,t.ray),t.c0=0,t.c1=o,t}function it(n,e){return de(n,n.c0,e)}function st(n,e){return de(n,n.c1,e)}function de(n,e,t){return C(t,n.ray.origin,q(t,n.ray.direction,e))}new ue(()=>K());function at(n){return n?[A(n[0]),A(n[1]),A(n[2]),A(n[3]),A(n[4]),A(n[5])]:[A(),A(),A(),A(),A(),A()]}function ze(){return[F(),F(),F(),F(),F(),F(),F(),F()]}function ht(n,e){for(let t=0;t<v;t++)Se(n[t],e[t]);return n}function ut(n,e,t,o=ye){const r=Ne(xe.get(),e,n);Me(r,r);for(let i=0;i<De;++i){const a=Be(je.get(),ve[i],r);be(o[i],a[0]/a[3],a[1]/a[3],a[2]/a[3])}Ge(t,o)}function Ge(n,e){I(e[s.FAR_BOTTOM_LEFT],e[s.NEAR_BOTTOM_LEFT],e[s.NEAR_TOP_LEFT],n[B.LEFT]),I(e[s.NEAR_BOTTOM_RIGHT],e[s.FAR_BOTTOM_RIGHT],e[s.FAR_TOP_RIGHT],n[B.RIGHT]),I(e[s.FAR_BOTTOM_LEFT],e[s.FAR_BOTTOM_RIGHT],e[s.NEAR_BOTTOM_RIGHT],n[B.BOTTOM]),I(e[s.NEAR_TOP_LEFT],e[s.NEAR_TOP_RIGHT],e[s.FAR_TOP_RIGHT],n[B.TOP]),I(e[s.NEAR_BOTTOM_LEFT],e[s.NEAR_BOTTOM_RIGHT],e[s.NEAR_TOP_RIGHT],n[B.NEAR]),I(e[s.FAR_BOTTOM_RIGHT],e[s.FAR_BOTTOM_LEFT],e[s.FAR_TOP_LEFT],n[B.FAR])}function y(n,e){for(let t=0;t<v;t++){const o=n[t];if(o[0]*e[0]+o[1]*e[1]+o[2]*e[2]+o[3]>=e[3])return!1}return!0}function lt(n,e){return ce(n,He(e,_e.get()))}function dt(n,e){for(let t=0;t<v;t++){const o=n[t];if(!Pe(o,e))return!1}return!0}function ct(n,e,t){return ce(n,Le(e,t,_e.get()))}function _t(n,e){for(let t=0;t<v;t++)if(Ie(n[t],e)>0)return!1;return!0}function ce(n,e){for(let t=0;t<v;t++)if(!$e(n[t],e))return!1;return!0}var B,s;(function(n){n[n.LEFT=0]="LEFT",n[n.RIGHT=1]="RIGHT",n[n.BOTTOM=2]="BOTTOM",n[n.TOP=3]="TOP",n[n.NEAR=4]="NEAR",n[n.FAR=5]="FAR"})(B||(B={})),function(n){n[n.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",n[n.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",n[n.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",n[n.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",n[n.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",n[n.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",n[n.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",n[n.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(s||(s={}));const ft={bottom:[s.FAR_BOTTOM_RIGHT,s.NEAR_BOTTOM_RIGHT,s.NEAR_BOTTOM_LEFT,s.FAR_BOTTOM_LEFT],near:[s.NEAR_BOTTOM_LEFT,s.NEAR_BOTTOM_RIGHT,s.NEAR_TOP_RIGHT,s.NEAR_TOP_LEFT],far:[s.FAR_BOTTOM_RIGHT,s.FAR_BOTTOM_LEFT,s.FAR_TOP_LEFT,s.FAR_TOP_RIGHT],right:[s.NEAR_BOTTOM_RIGHT,s.FAR_BOTTOM_RIGHT,s.FAR_TOP_RIGHT,s.NEAR_TOP_RIGHT],left:[s.FAR_BOTTOM_LEFT,s.NEAR_BOTTOM_LEFT,s.NEAR_TOP_LEFT,s.FAR_TOP_LEFT],top:[s.FAR_TOP_LEFT,s.NEAR_TOP_LEFT,s.NEAR_TOP_RIGHT,s.FAR_TOP_RIGHT]},v=6,De=8,ve=[M(-1,-1,-1,1),M(1,-1,-1,1),M(1,1,-1,1),M(-1,1,-1,1),M(-1,-1,1,1),M(1,-1,1,1),M(1,1,1,1),M(-1,1,1,1)],_e=new ue(K),ye=ze();class D{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,t){this.objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new l,this._objectCount=0,t&&(t.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),t.maximumDepth!==void 0&&(this._maximumDepth=t.maximumDepth))}destroy(){this._degenerateObjects.clear(),l.clearPool(),Y[0]=null,j.prune(),P.prune()}add(e,t=e.length){this._objectCount+=t,this._grow(e,t);const o=l.acquire();for(let r=0;r<t;r++){const i=e[r];this._isDegenerate(i)?this._degenerateObjects.add(i):(o.init(this._root),this._add(i,o))}l.release(o)}remove(e,t=null){this._objectCount-=e.length;const o=l.acquire();for(const r of e){const i=t??k(this.objectToBoundingSphere(r),We);z(i[3])?(o.init(this._root),we(r,i,o)):this._degenerateObjects.delete(r)}l.release(o),this._shrink()}update(e,t){if(!z(t[3])&&this._isDegenerate(e))return;const o=Ue(e);this.remove(o,t),this.add(o)}forEachAlongRay(e,t,o){const r=oe(e,t);x(this._root,i=>{if(!qe(r,i))return!1;const a=i.node;return a.terminals.forAll(u=>{this._intersectsObject(r,u)&&o(u)}),a.residents!==null&&a.residents.forAll(u=>{this._intersectsObject(r,u)&&o(u)}),!0})}forEachAlongRayWithVerticalOffset(e,t,o,r){const i=oe(e,t);x(this._root,a=>{if(!ke(i,a,r))return!1;const u=a.node;return u.terminals.forAll(h=>{this._intersectsObjectWithOffset(i,h,r)&&o(h)}),u.residents!==null&&u.residents.forAll(h=>{this._intersectsObjectWithOffset(i,h,r)&&o(h)}),!0})}forEach(e){x(this._root,t=>{const o=t.node;return o.terminals.forAll(e),o.residents!==null&&o.residents.forAll(e),!0}),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,o,r=()=>!0,i=1/0){let a=1/0,u=1/0,h=null;const c=U(e,t),T=d=>{if(--i,!r(d))return;const O=this.objectToBoundingSphere(d);if(!y(o,O))return;const E=S(e,t,f(O)),H=E-O[3],_=E+O[3];H<a&&(a=H,u=_,h=d)};return ie(this._root,d=>{if(i<=0||!y(o,d.bounds)||(q(b,c,d.halfSize),C(b,b,f(d.bounds)),S(e,t,b)>u))return!1;const O=d.node;return O.terminals.forAll(E=>T(E)),O.residents!==null&&O.residents.forAll(E=>T(E)),!0},e,t),h}forEachInDepthRange(e,t,o,r,i,a,u){let h=-1/0,c=1/0;const T={setRange:_=>{o===D.DepthOrder.FRONT_TO_BACK?(h=Math.max(h,_.near),c=Math.min(c,_.far)):(h=Math.max(h,-_.far),c=Math.min(c,-_.near))}};T.setRange(r);const d=S(t,o,e),O=U(t,o),E=U(t,-o),H=_=>{if(!u(_))return;const N=this.objectToBoundingSphere(_),L=f(N),Z=S(t,o,L)-d,Oe=Z-N[3],Re=Z+N[3];Oe>c||Re<h||!y(a,N)||i(_,T)};ie(this._root,_=>{if(!y(a,_.bounds)||(q(b,O,_.halfSize),C(b,b,f(_.bounds)),S(t,o,b)-d>c)||(q(b,E,_.halfSize),C(b,b,f(_.bounds)),S(t,o,b)-d<h))return!1;const N=_.node;return N.terminals.forAll(L=>H(L)),N.residents!==null&&N.residents.forAll(L=>H(L)),!0},t,o)}forEachNode(e){x(this._root,t=>e(t.node,t.bounds,t.halfSize,t.depth))}forEachNeighbor(e,t){const o=J(t),r=f(t),i=h=>{const c=this.objectToBoundingSphere(h),T=J(c),d=o+T;return!(te(f(c),r)-d*d<=0)||e(h)};let a=!0;const u=h=>{a&&(a=i(h))};x(this._root,h=>{const c=J(h.bounds),T=o+c;if(te(f(h.bounds),r)-T*T>0)return!1;const d=h.node;return d.terminals.forAll(u),a&&d.residents!==null&&d.residents.forAll(u),a}),a&&this.forEachDegenerateObject(u)}_intersectsObject(e,t){const o=this.objectToBoundingSphere(t);return!(o[3]>0)||re(o,e)}_intersectsObjectWithOffset(e,t,o){const r=this.objectToBoundingSphere(t);return!(r[3]>0)||re(o.applyToBoundingSphere(r),e)}_add(e,t){t.advanceTo(this.objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let o=0;o<t.length;o++){const r=l.acquire().init(e);this._add(t.at(o),r),l.release(r)}}_grow(e,t){if(t!==0&&(se(e,t,o=>this.objectToBoundingSphere(o),g),z(g[3])&&!this._fitsInsideTree(g)))if(fe(this._root.node))k(g,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const o=this._rootBoundsForRootAsSubNode(g);this._placingRootViolatesMaxDepth(o)?this._rebuildTree(g,o):this._growRootAsSubNode(o),l.release(o)}}_rebuildTree(e,t){ee(f(X),f(t.bounds)),X[3]=t.halfSize,se([e,X],2,r=>r,Q);const o=l.acquire().init(this._root);this._root.initFrom(null,Q,Q[3]),this._root.increaseHalfSize(1.25),x(o,r=>(this.add(r.node.terminals.data,r.node.terminals.length),r.node.residents!==null&&this.add(r.node.residents.data,r.node.residents.length),!0)),l.release(o)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let o=0;return x(this._root,r=>(o=Math.max(o,r.depth),o+t<=this._maximumDepth)),o+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],o=e;let r=-1/0;const i=this._root.bounds,a=this._root.halfSize;for(let h=0;h<3;h++){const c=i[h]-a-(o[h]-t),T=o[h]+t-(i[h]+a),d=Math.max(0,Math.ceil(c/(2*a))),O=Math.max(0,Math.ceil(T/(2*a)))+1,E=2**Math.ceil(Math.log(d+O)*Math.LOG2E);r=Math.max(r,E),w[h].min=d,w[h].max=O}for(let h=0;h<3;h++){let c=w[h].min,T=w[h].max;const d=(r-(c+T))/2;c+=Math.ceil(d),T+=Math.floor(d);const O=i[h]-a-c*a*2;W[h]=O+(T+c)*a}const u=r*a;return W[3]=u*me,l.acquire().initFrom(null,W,u,0)}_growRootAsSubNode(e){const t=this._root.node;ee(f(g),f(this._root.bounds)),g[3]=this._root.halfSize,this._root.init(e),e.advanceTo(g,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(e===-1)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let o=0,r=0;for(;r<t.length&&e==null;)o=r++,e=t[o];for(;r<t.length;)if(t[r++])return-1;return o}_isDegenerate(e){return!z(this.objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,o=this._root.halfSize;return e[3]<=o&&e[0]>=t[0]-o&&e[0]<=t[0]+o&&e[1]>=t[1]-o&&e[1]<=t[1]+o&&e[2]>=t[2]-o&&e[2]<=t[2]+o}toJSON(){const{maximumDepth:e,maximumObjectsPerNode:t,_objectCount:o}=this,r=this._nodeToJSON(this._root.node);return{maximumDepth:e,maximumObjectsPerNode:t,objectCount:o,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:r}}}_nodeToJSON(e){var i,a;const t=e.children.map(u=>u?this._nodeToJSON(u):null),o=(i=e.residents)==null?void 0:i.map(u=>this.objectToBoundingSphere(u)),r=(a=e.terminals)==null?void 0:a.map(u=>this.objectToBoundingSphere(u));return{children:t,residents:o,terminals:r}}static fromJSON(e){const t=new D(o=>o,{maximumDepth:e.maximumDepth,maximumObjectsPerNode:e.maximumObjectsPerNode});return t._objectCount=e.objectCount,t._root.initFrom(e.root.node,e.root.bounds,e.root.halfSize,e.root.depth),t}}class l{constructor(){this.bounds=$(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,o,r=this.depth){return this.node=e??l.createEmptyNode(),t&&k(t,this.bounds),this.halfSize=o,this.depth=r,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*me}advance(e){let t=this.node.children[e];t||(t=l.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const o=Te[e];return this.bounds[0]+=o[0]*this.halfSize,this.bounds[1]+=o[1]*this.halfSize,this.bounds[2]+=o[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,t,o=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!o)return t&&t(this,-1),!1;this.node.residents=null}const r=this._childIndex(e);t&&t(this,r),this.advance(r)}}isLeaf(){return this.node.residents!=null}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new G({shrink:!0}),residents:new G({shrink:!0})}}static acquire(){return l._pool.acquire()}static release(e){l._pool.release(e)}static clearPool(){l._pool.prune()}}function x(n,e){let t=l.acquire().init(n);const o=[t];for(;o.length!==0;){if(t=o.pop(),e(t)&&!t.isLeaf())for(let r=0;r<t.node.children.length;r++)t.node.children[r]&&o.push(l.acquire().init(t).advance(r));l.release(t)}}function ie(n,e,t,o=D.DepthOrder.FRONT_TO_BACK){let r=l.acquire().init(n);const i=[r];for(Je(t,o,he);i.length!==0;){if(r=i.pop(),e(r)&&!r.isLeaf())for(let a=7;a>=0;--a){const u=he[a];r.node.children[u]&&i.push(l.acquire().init(r).advance(u))}l.release(r)}}function we(n,e,t){j.clear();const o=t.advanceTo(e,(r,i)=>{j.push(r.node),j.push(i)})?t.node.terminals:t.node.residents;if(o.removeUnordered(n),o.length===0)for(let r=j.length-2;r>=0&&Ce(j.data[r],j.data[r+1]);r-=2);}function Ce(n,e){return e>=0&&(n.children[e]=null),!!fe(n)&&(n.residents===null&&(n.residents=new G({shrink:!0})),!0)}function qe(n,e){return V(f(e.bounds),2*-e.halfSize,R),V(f(e.bounds),2*e.halfSize,p),le(n.origin,n.direction,R,p)}function ke(n,e,t){return V(f(e.bounds),2*-e.halfSize,R),V(f(e.bounds),2*e.halfSize,p),t.applyToMinMax(R,p),le(n.origin,n.direction,R,p)}function fe(n){if(n.terminals.length!==0)return!1;if(n.residents!==null)return n.residents.length===0;for(let e=0;e<n.children.length;e++)if(n.children[e])return!1;return!0}function Ve(n,e){n[0]=Math.min(n[0],e[0]-e[3]),n[1]=Math.min(n[1],e[1]-e[3]),n[2]=Math.min(n[2],e[2]-e[3])}function Ke(n,e){n[0]=Math.max(n[0],e[0]+e[3]),n[1]=Math.max(n[1],e[1]+e[3]),n[2]=Math.max(n[2],e[2]+e[3])}function V(n,e,t){t[0]=n[0]+e,t[1]=n[1]+e,t[2]=n[2]+e}function se(n,e,t,o){if(e===1){const r=t(n[0]);k(r,o)}else{R[0]=1/0,R[1]=1/0,R[2]=1/0,p[0]=-1/0,p[1]=-1/0,p[2]=-1/0;for(let r=0;r<e;r++){const i=t(n[r]);z(i[3])&&(Ve(R,i),Ke(p,i))}Fe(f(o),R,p,.5),o[3]=Math.max(p[0]-R[0],p[1]-R[1],p[2]-R[2])/2}}function Je(n,e,t){if(!P.length)for(let o=0;o<8;++o)P.push({index:0,distance:0});for(let o=0;o<8;++o){const r=Te[o];P.data[o].index=o,P.data[o].distance=S(n,e,r)}P.sort((o,r)=>o.distance-r.distance);for(let o=0;o<8;++o)t[o]=P.data[o].index}function U(n,e){let t,o=1/0;for(let r=0;r<8;++r){const i=S(n,e,ae[r]);i<o&&(o=i,t=ae[r])}return t}function S(n,e,t){return e*(n[0]*t[0]+n[1]*t[1]+n[2]*t[2])}function z(n){return!isNaN(n)&&n!==-1/0&&n!==1/0&&n>0}l._pool=new pe(l),function(n){var e;(e=n.DepthOrder||(n.DepthOrder={}))[e.FRONT_TO_BACK=1]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(D);const Te=[m(-1,-1,-1),m(1,-1,-1),m(-1,1,-1),m(1,1,-1),m(-1,-1,1),m(1,-1,1),m(-1,1,1),m(1,1,1)],ae=[m(-1,-1,-1),m(-1,-1,1),m(-1,1,-1),m(-1,1,1),m(1,-1,-1),m(1,-1,1),m(1,1,-1),m(1,1,1)],me=Math.sqrt(3),Y=[null];function Ue(n){return Y[0]=n,Y}const W=$(),b=F(),R=F(),p=F(),j=new G,We=$(),g=$(),X=$(),Q=$(),w=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],P=new G,he=[0,0,0,0,0,0,0,0];export{at as H,ze as I,ut as L,ht as N,Ge as P,K as a,D as b,s as c,ct as d,v as e,st as g,B as j,_t as l,dt as m,it as p,y as s,lt as u,ft as v,He as y};
