import{n as T}from"./mat4-Fi6iAz29.js";import{o as N,e as U}from"./mat4f64-Dk4dwAN8.js";import{u as D,E as x,r as C,g as B,A as J,s as E}from"./vec32-Dvg_eL9J.js";import{n as p,N as V}from"./vec3f64-BLpZdpfb.js";import{z as W}from"./vec42-YcqnINSP.js";import{n as z}from"./vec4f64-o2zAXfmz.js";import{b as c,S as H,v as w}from"./sphere-Cin5efBj.js";import{l as R}from"./ViewingMode-Dodu7ZZk.js";import{s as X,e as G,r as Q,i as _,o as $}from"./intersectorUtils-BNnvTT1E.js";import{b as k,d as j}from"./verticalOffsetUtils-BFnFdbst.js";const I=1e-5;class q{constructor(t){this.options=new X,this._results=new F,this.transform=new k,this.tolerance=I,this.verticalOffset=null,this._ray=c(),this._rayEnd=p(),this._rayBeginTransformed=p(),this._rayEndTransformed=p(),this.viewingMode=t??R.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,r,s){this.resetWithRay(H(t,r,this._ray),s)}resetWithRay(t,r){this.camera=r,t!==this._ray&&w(t,this._ray),this.options.verticalOffset!==0?this.viewingMode===R.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,D(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(t=null,r,s,f,a){var d;this.point=r,this.filterPredicate=f,this.tolerance=s??I;const h=j(this.verticalOffset);if(t&&t.length>0){const m=a?i=>{a(i)&&this.intersectObject(i)}:i=>{this.intersectObject(i)};for(const i of t){const l=(d=i.getSpatialQueryAccelerator)==null?void 0:d.call(i);l!=null?(h!=null?l.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,m,h):l.forEachAlongRay(this._ray.origin,this._ray.direction,m),this.options.selectionMode&&this.options.hud&&l.forEachDegenerateObject(m)):i.objects.forAll(g=>m(g))}}this.sortResults()}intersectObject(t){const r=t.geometries;if(!r)return;const s=t.effectiveTransformation,f=j(this.verticalOffset);for(const a of r){if(!a.visible)continue;const{material:h,id:d}=a;if(!h.visible)continue;this.transform.setAndInvalidateLazyTransforms(s,a.transformation),x(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),x(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const m=this.transform.transform;f!=null&&(f.objectTransform=this.transform),h.intersect(a,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(i,l,g,v,O,P)=>{if(i>=0){if(this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,i))return;const e=v?this._results.hud:this._results,L=v?o=>{const S=new Q(t,d,g,P);o.set(_.HUD,S,i,l,N,O)}:o=>o.set(_.OBJECT,{object:t,geometryId:d,triangleNr:g},i,l,m,O);if((e.min.drapedLayerOrder==null||O>=e.min.drapedLayerOrder)&&(e.min.dist==null||i<e.min.dist)&&L(e.min),this.options.store!==G.MIN&&(e.max.drapedLayerOrder==null||O<e.max.drapedLayerOrder)&&(e.max.dist==null||i>e.max.dist)&&L(e.max),this.options.store===G.ALL)if(v){const o=new A(this._ray);L(o),this._results.hud.all.push(o)}else{const o=new u(this._ray);L(o),this._results.all.push(o)}}})}}sortResults(t=this._results.all){t.sort((r,s)=>r.dist!==s.dist?(r.dist??0)-(s.dist??0):r.drapedLayerOrder!==s.drapedLayerOrder?M(r.drapedLayerOrder,s.drapedLayerOrder):M(r.drapedLayerGraphicOrder,s.drapedLayerGraphicOrder))}}function M(n,t){return(t??-Number.MAX_VALUE)-(n??-Number.MAX_VALUE)}function ot(n){return new q(n)}class F{constructor(){this.min=new u(c()),this.max=new u(c()),this.hud={min:new A(c()),max:new A(c()),all:new Array},this.ground=new u(c()),this.all=[]}init(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0}}class u{get ray(){return this._ray}get distanceInRenderSpace(){return this.dist!=null?(B(b,this.ray.direction,this.dist),C(b)):null}withinDistance(t){return!!$(this)&&this.distanceInRenderSpace<=t}getIntersectionPoint(t){return!!$(this)&&(B(b,this.ray.direction,this.dist),D(t,this.ray.origin,b),!0)}getTransformedNormal(t){return E(y,this.normal),y[3]=0,W(y,y,this.transformation),E(t,y),J(t,t)}constructor(t){this.intersector=_.OBJECT,this.normal=p(),this.transformation=U(),this._ray=c(),this.init(t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=_.OBJECT,w(t,this._ray)}set(t,r,s,f,a,h,d){this.intersector=t,this.dist=s,E(this.normal,f??V),T(this.transformation,a??N),this.target=r,this.drapedLayerOrder=h,this.drapedLayerGraphicOrder=d}copy(t){w(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,E(this.normal,t.normal),T(this.transformation,t.transformation)}}class A extends u{constructor(){super(...arguments),this.intersector=_.HUD}}function ht(n){return new u(n)}const b=p(),y=z();export{I as E,ht as R,ot as T};
