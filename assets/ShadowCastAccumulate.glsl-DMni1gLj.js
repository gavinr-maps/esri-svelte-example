const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./TileLayerView3D-B72EtQ_i.js","./Accessor-BmwT4B0c.js","./projection-CyCZAIaD.js","./index-4eY77cms.js","./index-Cx51aysm.css","./SimpleObservable-CvOkykwM.js","./vec3f64-BLpZdpfb.js","./Point-Cz2JYYmX.js","./cast-CsZslgGN.js","./JSONSupport-DcrLLGjL.js","./writer-DKgfqj4X.js","./Extent-g5W9hy0j.js","./Polyline-s-JzsQqo.js","./mathUtils-Cfq9PL9W.js","./projectBuffer-CQnuEMuP.js","./geodesicConstants-RQL9oKdk.js","./LayerView3D-BJ3u1Cu5.js","./reactiveUtils-XM7cS2OP.js","./Evented-Dw4_VOGn.js","./heightModelInfoUtils-D_x68P3s.js","./HeightModelInfo-C05IFsWs.js","./TiledLayerView3D-MBIRqUas.js","./LineCallout.glsl-BQyjm-mE.js","./Color-VJEMvW-n.js","./colorUtils-Rxh2V3ai.js","./visualVariableUtils-Xcorldoo.js","./Graphic-Dt0LgVGU.js","./Clonable-Z-AWS-16.js","./opacityUtils-Dim20wpZ.js","./Promise-DfET-uns.js","./enumeration-DpvDkLNI.js","./ActionToggle-D7439N1A.js","./Identifiable-BHVfzH03.js","./jsonUtils-CwFG8yN4.js","./typeUtils-B6WBEKDM.js","./TextSymbol-BLIQ6RKX.js","./screenUtils-_ZIvrt5o.js","./collectionUtils-CTT-51g7.js","./Portal-CmmHxpLg.js","./aaBoundingBox-Dw3yBk2f.js","./lengthUtils-_77UiyVF.js","./vec2f64-Dy6m9Nrb.js","./vec32-Dvg_eL9J.js","./common-DQOJ18NT.js","./plane-CpXmOyqq.js","./vec42-YcqnINSP.js","./mat3f64-BBpwCtoL.js","./mat4f64-Dk4dwAN8.js","./quatf64-CCm9z-pX.js","./vec4f64-o2zAXfmz.js","./mathUtils-BgCEaV43.js","./mat4-Fi6iAz29.js","./computeTranslationToOriginAndRotation-DYUrDrjE.js","./ElevationContext-BJejROd5.js","./dehydratedFeatureUtils-1rrRm6hF.js","./ElevationProvider-aS5xrHHy.js","./VertexAttribute-Cq4MnHjR.js","./unitConversionUtils-rg07EgOm.js","./hydratedFeatures-CNHxsqRS.js","./projectVectorToVector-CCOy_B5J.js","./projectPointToVector-BoxjK-qy.js","./Material-C_-mgXN8.js","./boundedPlane-DuGhiiFM.js","./sphere-Cin5efBj.js","./mat3-CR8GKnhD.js","./lineSegment-v806maA5.js","./ViewingMode-Dodu7ZZk.js","./NoParameters-t-PuNrgq.js","./Indices-D8XWalpO.js","./FloatArray-BQXWSSJh.js","./BindType-BBwFZqyN.js","./Matrix3PassUniform-uCCQMnlP.js","./Texture-BVJ22uHh.js","./signal-CySMLEX9.js","./enums-D9v74xTE.js","./getDataTypeBytes-BTGR5GyG.js","./renderState-Ci93M1-P.js","./basicInterfaces-CZwQPxTp.js","./InterleavedLayout-_dYEAUNK.js","./BufferView-0osDbyWD.js","./vec2-ChnYg_BJ.js","./types-D0PSWh4d.js","./triangle-B1tKFm7z.js","./ShaderTechniqueConfiguration-D4dZMCXS.js","./glsl-BH37Aalp.js","./requestImageUtils-DWgRKL5q.js","./TextureFormat-1mYWTFa-.js","./graphicUtils-BFGMMQ1R.js","./meshVertexSpaceUtils-AgAbm20L.js","./MeshLocalVertexSpace-CnHk-qPr.js","./RibbonLine.glsl-DwJpAQ1c.js","./sdfPrimitives-DBgFWIDT.js","./doublePrecisionUtils-B0owpBza.js","./floatRGBA-Cb__GiDF.js","./Octree-CmoRJhci.js","./ShaderBuilder-BKul5qh8.js","./RgbaFloatEncoding.glsl-_io2eW3M.js","./Attribute-DGhdp5lO.js","./vec2f32-BbH2jxlN.js","./DefaultBufferWriter-CqCDaNCZ.js","./memoryEstimations-Bcyf-mHz.js","./projectBoundingRect-C2OcwCLZ.js","./dehydratedFeatures-kwLHUA1D.js","./quantizationUtils-DgFbqZi7.js","./Field-BDG0QV_T.js","./fieldType-CBeoJWlv.js","./featureConversionUtils-CvnFcmH_.js","./OptimizedFeature-P2towpqD.js","./OptimizedGeometry-BJqUA4Pi.js","./OptimizedFeatureSet-Blu9Ckm7.js","./edgeUtils-D0U-z06n.js","./NormalAttribute.glsl-0GHNIsQf.js","./Float4DrawUniform-Db0CLl_z.js","./Matrix3DrawUniform-DD7AqlIc.js","./webStyleAcceptedFormats-CG7ZQ6BV.js","./GeometryUtil-D-PMXorz.js","./vec3f32-nZdmKIgz.js","./RealisticTree.glsl-PW_KtBDJ.js","./Intersector-tBiZcjSu.js","./intersectorUtils-BNnvTT1E.js","./verticalOffsetUtils-BFnFdbst.js","./orientedBoundingBox-B17G_yFO.js","./quat-CP7JhygC.js","./spatialReferenceEllipsoidUtils-DBqQpPRa.js","./Intersector-zrebwyaY.js","./DefaultMaterial-GRoe8HM5.js","./SceneLighting-BuSMIzqo.js","./GLTextureMaterial-96UpbkjC.js","./VertexColor.glsl-D3WyDYIi.js","./Matrix4PassUniform-COGIPIq4.js","./VerticalOffset.glsl-CsMbbWIx.js","./Matrix4sPassUniform-SKhQ1xSr.js","./Float2PassUniform-x4sHx2JD.js","./BooleanBindUniform-BgD_OP8i.js","./CameraSpace.glsl-g9iLbhnR.js","./Scheduler-i_u8qdlN.js","./debugFlags-B1LM_Apo.js","./HUDRenderStyle-BhGvVxgm.js","./HUDVisibility.glsl-DuFScu5i.js","./terrainUtils-CgFk6NLH.js","./layerUtils-B__v9OBu.js","./TileInfo-DxwC9WcY.js","./TileKey-DZd6gJy7.js","./layerViewUtils-Bevty3Jm.js","./fetchTile-B4Q5HPnF.js","./RefreshableLayer-C90FXoHt.js","./layerContainerType-C5CzMsLd.js","./LayerView-DUZfYZew.js","./UpdatingHandles-CzJ4c3KT.js","./RefreshableLayerView-CmQe69iO.js","./MapServiceLayerViewHelper-CxIA-JZr.js","./scaleUtils-DPfHG2g0.js","./floorFilterUtils-DZ5C6FQv.js","./drapedUtils--IsYcWNz.js","./normalizeUtils-BTGdXlpz.js","./normalizeUtilsCommon-lGDszWRI.js","./utils-YowqfOgk.js","./utils-B-dlKIhi.js","./sublayerUtils-Cj6GQMKz.js","./TimeExtent-BO6BsF_x.js","./timeUtils-C1c_L2Fd.js","./popupUtils-CY6-CisY.js","./Camera-CdyTfTAk.js","./Cyclical-Dlbl-cQK.js","./Viewpoint-DvyUmqUt.js","./jsxFactory-Cnml7uXM.js","./intl-Duiy0OzY.js","./uuid-Cl5lrJ4c.js","./workers-Cds_sd9m.js","./Queue-BQesTh_6.js","./GraphicsCollection-BJ5Nr2H8.js","./RenderCoordsHelper-DA-pMWeR.js","./projectVectorToPoint-DEm8-dt4.js","./DefaultUI-BwWVKFUS.js","./InputManager-DZ3jJnlx.js","./Basemap-BZmrlnvW.js","./loadAll-D1eTJ7uv.js","./PortalItem-CTx1kJsR.js","./basemapDefinitions-D-Q7PKmu.js","./writeUtils-CcunaxF8.js","./groundInstanceUtils-Ben03ZCf.js","./CollectionFlattener-U8hHQmGf.js","./editableLayers-CWgCazH-.js","./catalogUtils-CGCu8hgu.js","./basemapEnsureType-CmRtohu0.js","./basemapUtils-oMnqy94d.js","./utils-DYurMneM.js","./mat4f32-DcsiF_Rp.js","./TablesMixin-Bqfi1Ha_.js","./Layer-DH4_Pn8a.js","./timeZoneUtils-DxzjpEBb.js","./ReactiveMap-BHFEHYMj.js","./Query-B_2mhyL4.js","./FullTextSearch-CBnxSwz4.js","./selectionUtils-DYi6daQO.js","./ViewEvents-c9mvQ_r3.js","./IViewEvents-Bci6PjlS.js","./interfaces-D6pIddIh.js","./screenUtils-BWEEmpSb.js","./HighlightDefaults-CumzVg9-.js","./a11yUtils-ClKbIIe-.js","./unitBezier-B1N-tmtC.js","./imageUtils-DsXKmbqJ.js","./capabilities-DwlKKScG.js","./themeUtils-C3zvZbsE.js","./globalCss-vQlnDsEX.js","./accessibleHandler-BaA3O97p.js","./CompassViewModel-DBhnIkQP.js","./GoTo-zPv0y7kC.js","./ZoomViewModel-Bua4WqEj.js","./NormalUtils.glsl-W-nmUbAv.js","./earcut-D9gy186-.js","./vec3-BXNNVgyU.js","./SnappingCandidate-DGkpYqI6.js","./triangulationUtils-Cu97ljqy.js","./deduplicate-Cp1WDW0w.js","./OverlayCompositing.glsl-CUa8aMAb.js","./GridLocalOriginFactory-CngFIYNp.js","./RenderCamera-CDB-KFBK.js","./axisAngleDegrees-DdLZENJj.js","./weather-zOic7P_q.js","./RenderPlugin-CTXypYLE.js","./VertexElementDescriptor-BLyltQyJ.js","./VertexArrayObject-vYejmVPr.js","./BufferObject-BJilD_hc.js","./NestedMap-GuqgquCN.js","./Normals-D6WqMXVD.js","./fontUtils-CGi-tOxo.js","./cameraUtils-Cg-qbPDO.js","./earthUtils-8WLQbUUl.js","./spatialReferenceSupport-DfixDcu7.js","./ElevationSamplerData-UywXoG8C.js","./FramebufferObject-B01p0UGV.js","./glUtil-CAJRmga-.js","./ShadowCastVisualizeTechniqueConfiguration-vN_a9xco.js","./SunCalc-uwgdo0BB.js","./VirtualLighting-CdhwLgbn.js","./ray-C_tSu6xd.js","./RenderFeature-2QP3kBrd.js","./unitFormatUtils-Q7ZG7HcF.js","./ByteSizeUnit-BsxeN7wM.js","./quantityUtils-BsDK158M.js","./ZoomMomentumEstimator-BDiG9U4W.js","./HUDMaterial-DDt4C7E7.js","./labelFormatUtils-F9rkrs4Y.js","./labelUtils-DCpQ7n-8.js","./DepthRange-BJLjx8ee.js","./elevationInfoUtils-D26wVF2d.js","./hitTest-Dmi1EcVX.js","./LayerConstants-B33OP6sh.js","./intersectorUtilsConversions-CiJ6bOx7.js","./ElevationRange-BrgM1moX.js","./hitTestSelectUtils-UXJPjatw.js","./MemCache-CmojB_Z1.js","./DefaultLoadingContext-pYVsNNqG.js","./wosrLoader-CvsaTck0.js","./Version-Cd3TlGH0.js","./DrawParameters-C9t9_e99.js","./TileStrategy-CtmYSAoK.js","./TileKey-DBTeo_j0.js","./ScheduledQueueProcessor-U8WIIyj8.js","./RenderableTile-FJVLrFon.js","./config-BOD8--da.js","./StyleDefinition-C2Flw6Qv.js","./enums-BTM-fOHQ.js","./enums-BRzLM11V.js","./GeometryUtils-F7QfOKlc.js","./DefaultVertexAttributeLayouts-wSIZdMhB.js","./DisplayObject-Dejv4A66.js","./resources-D31XxULB.js","./WorkerHandle-CKOgUZ7i.js","./colorUtils-DaPfwnk3.js","./vec33-KumQEj7U.js","./ShaderTechniqueRepository-Ch1TPHrL.js","./Blit-_zFq7-RL.js","./testSVGPremultipliedAlpha-BGpZOwI7.js","./RenderingContext-7iVYEQBa.js","./ProgramCache-CuBZBhwD.js","./Program-C5Xq9SwE.js","./makeScheduleFunction-CggzEh3c.js","./ElevationLayerView3D-Cbu-WnI2.js","./LercDecoder-y0ZHeHqS.js","./BaseDynamicLayerView3D-BVQPGahd.js","./DynamicLayerView3D-DZ_d3bCz.js","./projectExtentUtils-B6xjnIBe.js","./geometryServiceUtils-CW7bdn7_.js","./project-CvBujuEW.js","./ImageMaterial.glsl-WwbGgv6U.js","./DefaultLayouts-CBF6SkyQ.js","./TriangleMaterial-D-IjcYAX.js","./BuildingSceneLayerView3D-YdNSL369.js","./BuildingGroupSublayer-e_mbCmSO.js","./BuildingComponentSublayer-C_pZIhA8.js","./FeatureLayer-U46cmps3.js","./MultiOriginJSONSupport-DbmrbwMa.js","./FeatureLayerBase-C4QQJYE9.js","./formUtils-l8pvwous.js","./commonProperties-B0GHoNP5.js","./ElevationInfo-BPOqhCue.js","./AttributeTableTemplate-cR37sM72.js","./featureLayerUtils-Btb8HY8h.js","./featureQueryAll-JpNZKIBO.js","./SimpleRenderer-CEw_geZx.js","./commonProperties-ZfGquLPI.js","./colorRamps-CRjjPL3r.js","./SizeVariable-B-ghFm6e.js","./ColorStop-BYiAUa8d.js","./jsonUtils-B-voMz-i.js","./defaults-FkBa0ybj.js","./defaultsJSON-GKolV7NZ.js","./UniqueValueRenderer-yoWHKJ_P.js","./diffUtils-BanfihCO.js","./RendererLegendOptions-CYAPr8D6.js","./styleUtils-ColFrJ-Z.js","./AttachmentQuery-CpEmJqq-.js","./NormalizationBinParametersMixin-CZD0XfhN.js","./RelationshipQuery-B5a-mYy7.js","./LayerFloorInfo-iCgtHY6f.js","./Relationship-CTbzI1Kb.js","./serviceCapabilitiesUtils-B2yGaMdk.js","./infoFor3D-C7tb3HsI.js","./editsZScale-LI19I1vI.js","./queryZScale-BdW_vUm_.js","./FeatureSet-B5-Veyin.js","./APIKeyMixin-3z69J1h4.js","./ArcGISService-CDyDWGI0.js","./ScaleRangeLayer-Cnzwr9PT.js","./jsonUtils-DZz5FrgB.js","./CustomParametersMixin-Be7WOSEG.js","./DisplayFilteredLayer-CzliK74b.js","./displayFilterUtils-uKPOP7_-.js","./EditBusLayer-KXo-LY9o.js","./FeatureEffectLayer-BZmannck.js","./FeatureEffect-DZgZP6Sj.js","./FeatureFilter-Ca1n-g_b.js","./FeatureReductionLayer-B6VhUfZv.js","./FeatureReductionSelection-BJWsAyix.js","./labelingInfo-BgG6IH9B.js","./jsonUtils-BZp85R7u.js","./typeUtils-B3iPBwJ2.js","./ClassBreaksRenderer-C7fhua2J.js","./LRUCache-CXiGQWMN.js","./FieldsIndex-FW1AMU67.js","./utils-UPZJIDfz.js","./defaultCIMValues-Bb-CUowV.js","./HeatmapColorStop-CHbSyb1s.js","./heatmapUtils-Cyq-bAyG.js","./MD5-C9MwAd2G.js","./OperationalLayer-B__lrMRq.js","./OrderedLayer-ucEg87Tu.js","./OrderByInfo-KsusEmpW.js","./PortalLayer-Cqwv_mmr.js","./portalItemUtils-ByOtbGao.js","./TemporalLayer-CMqBosxi.js","./TimeInfo-CctegBed.js","./TimeInterval-B7L-CEq7.js","./TrackableLayer-DaYHUnrc.js","./FeatureTemplate-Dh5_oWTV.js","./FeatureType-DhERcdEP.js","./fieldProperties-DDN0PSrH.js","./TitleCreator-DIyQ9Yy3.js","./versionUtils-BfhafDf-.js","./styleUtils-Bye9ft1s.js","./popupUtils-CmsUVJA0.js","./interfaces-CL2NbQte.js","./capabilities-B4c8vV3b.js","./I3SIndexInfo-CtHVwWKN.js","./I3SLayerDefinitions-F93A6ZIl.js","./I3SUtil-BD55sujO.js","./I3SBinaryReader-DxrJbUZw.js","./WhereClause-xGR0ztic.js","./TimeOnly-CveCl9ie.js","./I3SMeshView3D-Db4KR9B8.js","./Transform-DK3em4J4.js","./RenderTexture-DlHrT8bu.js","./I3SOverrides-CVBzyDHR.js","./resourceUtils-CBM_aocN.js","./I3SNode-uwg_6Be3.js","./ReactiveSet-DgPcISC1.js","./SceneModification-7WMFEBC-.js","./persistable-C1YjaxW7.js","./multiOriginJSONSupportUtils-C0wm8_Yw.js","./resourceExtension-DiQ4lOGT.js","./Graphics3DScaleVisibility-CyLlAoK9.js","./rendererConversion-B_DS3bPe.js","./optimizedFeatureQueryEngineAdapter-D7doR0mc.js","./PooledRBush--ue4CxG1.js","./quickselect-QQC62dOK.js","./SceneLayerWorker-BbWbzR8n.js","./attributeUtils-Dc8--CBJ.js","./highlightUtils-CENYWDnQ.js","./I3SQueryFeatureStore-BMCUm8yG.js","./TemporalSceneLayerView-C2HiX5rK.js","./timeSupport-C7DiFkF_.js","./queryUtils-DBEPdow2.js","./json-Wa8cmqdu.js","./timeSupport-B8qjIabC.js","./utils-BjSXFjBJ.js","./QueryEngine-BokU27l9.js","./WhereClauseCache-CJbuf62r.js","./QueryEngineCapabilities-B_pTbIiR.js","./utils-Co_tyUES.js","./utils-v4CMtYiY.js","./utils-Dyua10sr.js","./ClassBreaksDefinition-C7KVmBug.js","./FixedIntervalBinParameters-ZfcJap1f.js","./CatalogLayerView3D-DsaVKxrj.js","./CatalogLayerView-Ck38emHa.js","./CatalogDynamicGroupLayerView3D-Db15gpRD.js","./CatalogDynamicGroupLayerView-_MXMkHpo.js","./CatalogFootprintLayerView3D-CcP9MEHG.js","./FeatureLayerViewBase3D-DlwvBN2v.js","./HeatmapDensity.glsl-C4Ur6ReY.js","./dehydratedFeatureComparison-j4L0peJx.js","./utils-aIx1khaq.js","./cimSymbolUtils-DzhKvmq_.js","./queryForSymbologySnapping-f8bz6CGc.js","./Graphics3DFeatureProcessor-w1VyLp6M.js","./hash-CcEbRgUF.js","./Graphics3DObjectStates-XVMjaI7s.js","./FeatureStore-BuDu5Iw5.js","./BoundsStore-CI-maf3v.js","./heatmapTextureUtils-C_5TPY_E.js","./query-Bjn_Ozo1.js","./pbfQueryUtils-mqiWagfZ.js","./pbf-BsmI3A9L.js","./EventedSet-DZ2rCNIA.js","./FeatureLayerView-CazbeBsE.js","./constants-B4mRqufT.js","./networkFieldUtils-iOtCEyIS.js","./CatalogFootprintLayerView-BuolGpuz.js","./CSVLayerView3D-C_2Zm9rC.js","./DimensionLayerView3D-H_m_qrU1.js","./FeatureLayerView3D-C_RV6Dyl.js","./GeoJSONLayerView3D-CYq_vFML.js","./GraphicsLayerView3D-DbYDPeRg.js","./GraphicsProcessor-CFoeo0Fv.js","./GroupLayerView3D-Cky0Lmzf.js","./GroupLayerView-MikeaAnU.js","./ImageryLayerView3D-Dc46E0Y2.js","./ImageryLayerView-CpLZppSV.js","./rasterProjectionHelper-Wej15Bp6.js","./IntegratedMeshLayerView3D-Kc0HdtU4.js","./IntegratedMesh3DTilesLayerView3D-BkS-08TX.js","./ILyr3DWasmPerSceneView-QwgNPJGT.js","./LineOfSightLayerView3D-D2cUUg5R.js","./MapImageLayerView3D-BADgY6VG.js","./MapImageLayerView-Bakv4x6d.js","./ExportImageParameters-AbYMPLed.js","./MediaLayerView3D-CA8q46Z9.js","./MediaElementView-BlY9eVB-.js","./normalizeUtilsSync-12EQcOVf.js","./mat2d-D9DBP-jx.js","./mat2df64-CBKYtunK.js","./EditGeometryOperations-CAMJU2Wn.js","./geometry2dUtils-D9Oax6Qb.js","./keybindings-CTmT1RTo.js","./SnappingManagerPool-C7HBJ4KI.js","./SnappingManager-DoaI-UDx.js","./RightAngleSnappingHint-BepRvd6S.js","./geodesicUtils-Cvz9v8ds.js","./viewUtils-CV6QVz7y.js","./MediaLayerView-C_j0wKSM.js","./OGCFeatureLayerView3D-B8t2SaYh.js","./OGCFeatureLayerView-12UrFD7L.js","./PointCloudLayerView3D-Dj7xiTN4.js","./PointCloudWorkerUtil-d-sDeJid.js","./PointCloudUniqueValueRenderer-DcQF_3qx.js","./PopupSceneLayerView-DOs4Ybu9.js","./ViewshedLayerView3D-CX_tkSQj.js","./VoxelLayerView3D-Buf2ojED.js","./VoxelGraphic-BTYDoYqo.js","./RouteLayerView3D-Bok-hxPn.js","./Stop-Cb4ynHVF.js","./networkEnums-BgkT2jou.js","./SceneLayerView3D-WxrgQpXE.js","./SceneLayerViewRequiredFields-C2ulre25.js","./SceneLayerGraphicsView3D-Brao_V44.js","./StreamLayerView3D-C2h-UiZ6.js","./StreamFeatureManager-C2RiB7eK.js","./CircularArray-CujHzHWW.js","./streamLayerUtils-CKwt2uXH.js","./createConnection-CFXZ1Iqe.js","./StreamLayerView-Tl3HLu7K.js","./ImageryTileLayerView3D-BGbxBMnm.js","./rasterUtils-BmCX8yQb.js","./ImageryTileLayerView-C-BRmlc_.js","./rasterFieldUtils-Bs-oNwHn.js","./VectorTileLayerView3D-BODV0wOR.js","./TileInfoViewPOT-CAjkDqgu.js","./Rect-CUzevAry.js","./rasterizingUtils-C1EbvluX.js","./definitions-CP59Y04S.js","./WGLBrushVTLSymbol-CmI_2XQu.js","./VTLMaterialManager-B10yUbF1.js","./ShaderCompiler-G2XYGDs6.js","./programUtils-CwiKxPbA.js","./StyleRepository-COGvMSY8.js","./WFSLayerView3D-LlSms5Mu.js","./WMSLayerView3D-CCLXF6P3.js","./WMSLayerView-BIBoThEr.js","./ExportWMSImageParameters-Buw0se_f.js","./WMTSLayerView3D-mXeXfXzi.js","./AreaMeasurementAnalysisView3D-VwD1qnp3.js","./defaultUnit-CHqZKPQE.js","./getDefaultUnitForView-BBSnYQvp.js","./AnalysisView3D-DoDk2o7n.js","./interfaces-js1RL7O8.js","./measurementUtils-CZMdV_le.js","./geodesicAreaMeasurementUtils-CfJYiWyy.js","./geometryEngine-CLtm9OQA.js","./geometryEngineBase-B0ZyeKAX.js","./_commonjsHelpers-DCkdB7M8.js","./hydrated-DcIAHEVL.js","./geodesicMeasurementUtils-B-7dBAnY.js","./euclideanAreaMeasurementUtils-ButVfzxp.js","./euclideanLengthMeasurementUtils-Bcu5HQVu.js","./geodesicLengthMeasurementUtils-B4BXDmbs.js","./LineVisualElement-BCLvCZUF.js","./Object3DVisualElement-D0-_EXFp.js","./VisualElement-CaupdJPJ.js","./line-BiDIlUeT.js","./quantityFormatUtils-Bo0-7oki.js","./Segment-DI6rnOzR.js","./TextOverlayItem-Bocd_PuB.js","./lineStippleUtils-C89mzWlO.js","./DimensionAnalysisView3D-B7hpYuW0.js","./LengthDimension-BswUxyjY.js","./automaticLengthMeasurementUtils-4SpTQo4O.js","./RenderObject-DqJETQox.js","./ColorMaterial.glsl-B6FVFiO0.js","./dragEventPipeline3D-BPjuyc9D.js","./dragEventPipeline-Dj33NxJd.js","./memoize-DmxaQ-k8.js","./Factory-BJU6qm9N.js","./SnappingVisualizer3D-CNnXtbrW.js","./ExtendedLineVisualElement-D_FcbyIy.js","./EngineVisualElement-BU-x7ubB.js","./LaserlineVisualElement-C8OQFtp1.js","./LaserlinePath.glsl-DNndnwiF.js","./RightAngleQuadVisualElement-IhLHtjxy.js","./SnappingVisualizer-bfo0JaXd.js","./PointSnappingHint-DWAfJfrj.js","./VerticesVisualElement--d2vklez.js","./SnappingContext-lR2hMWGP.js","./SnappingDragPipelineStep-dx2sltqU.js","./SnappingOperation-D1hMlFdT.js","./ShadedColorMaterial.glsl-BFmY_SxS.js","./InteractiveToolBase-rZBtMOMv.js","./ToolIntersector-Ce8oIgvQ.js","./LineMarker.glsl-DPIHxabV.js","./analysisViewUtils-CVt56akI.js","./DirectLineMeasurementAnalysisView3D-Bhergdke.js","./interfaces-CjSZqm0S.js","./LineOfSightAnalysisView3D-C7kKJrl8.js","./featureReferenceUtils-D6mA_na5.js","./LineOfSightAnalysisTarget-BdC6usKT.js","./manipulatorUtils-CFLpXm7g.js","./SliceAnalysisView3D-Dcgc8-5Z.js","./SlicePlane-oF-O5hhm.js","./SlicePlaneMaterial.glsl-DRbvxdCD.js","./sliceToolConfig-DdKbqpbd.js","./ViewshedAnalysisView3D-VpQ4ZOc9.js","./Viewshed-DKHDZnpP.js","./MoveManipulation-BT9Lh8Ph.js","./settings-PZrBMq9n.js","./VoxelWasmPerSceneView-DgxWmrwj.js","./loader-B7wNe1V9.js","./TerrainTileTree3DDebugger-bKp97IUI.js","./TileTreeDebugger-DWDRAwrm.js","./edgeProcessing-Dmwf8z6c.js","./bufferLayouts-DmKtt9ER.js","./EdgeView-CRrUHzhn.js","./EdgeWorkerHandle-Fky_Xpe_.js","./workerHelper-Bbyb81sR.js","./FeatureTileTree3DDebugger-BMAKj6Xj.js","./GraphicsView3D-D0i8J2uZ.js"])))=>i.map(i=>d[i]);
import{_ as X}from"./index-4eY77cms.js";import{p as Wf,u as Qf,g as Re,B as pe,r as c,m,a as F,s as Ri,a6 as _r,e as po,f as GC,l as ea,N as se,i as xn,H as Hh,a4 as pp,a3 as ug,M as Gi,aD as We,aO as Ec,c3 as kb,c as Ad,aA as BC,bb as qC,aw as Xe,aT as kC,q as jC,D as Ai,aW as mp,aV as dg,a0 as mt,E as cn,aR as WC,bw as QC,V as YC,X as Dd,a7 as ZC,o as pg,bB as XC,bK as KC,b5 as qu,K as ui,ad as jb,a8 as mo,ap as JC,c4 as eT,bE as tT,J as iT,S as mg,ba as qc,c5 as sT,c6 as rT,b8 as Yf,L as aT,at as nT,h as oT}from"./Accessor-BmwT4B0c.js";import{d as ta}from"./Camera-CdyTfTAk.js";import{m as un}from"./Viewpoint-DvyUmqUt.js";import{V as wo,p as Pl,d as O,C as Ge,a as Oc,P as at,A as Be,_ as o_,w as l_,v as Aa,e as lT,E as Zf}from"./reactiveUtils-XM7cS2OP.js";import{O as hT,n as kc,e as Xf,d as cT}from"./jsxFactory-Cnml7uXM.js";import{f as ri,c as Wb,g as Ea,y as _p,p as Kf,s as Qb}from"./screenUtils-_ZIvrt5o.js";import{g as si,t as os,i as Jf,c as $d,ac as _g,ad as gg,C as Dt,ag as uT,Q as h_,j as Cs,b as dT,$ as pT,ae as mT,ab as Yb,a as _T,s as gT}from"./Point-Cz2JYYmX.js";import{m as fT}from"./workers-Cds_sd9m.js";import{a as El,P as Hp,aj as Zb,am as yT,n as ey}from"./cast-CsZslgGN.js";import{c as vT,n as v,r as Vt,t as dn,y as bT,m as wT,N as xT,u as CT,_ as vr,e as gp,l as TT}from"./vec3f64-BLpZdpfb.js";import{l as ST}from"./GraphicsCollection-BJ5Nr2H8.js";import{b as PT,w as dr}from"./Extent-g5W9hy0j.js";import{v as ET}from"./HeightModelInfo-C05IFsWs.js";import{U as Jo,I as Xb,J as Ol,W as OT,$ as MT,O as Kb,L as RT}from"./projection-CyCZAIaD.js";import{i as Jb}from"./projectBoundingRect-C2OcwCLZ.js";import{c as ec,i as c_}from"./projectPointToVector-BoxjK-qy.js";import{k as e1,a8 as AT,u as DT,a as pi,j as $T,H as _o,a6 as t1,y as Qn,A as Id,i as vl,R as tc,a9 as IT,f as u_,N as LT,r as NT,J as i1,a3 as ty,K as no,c as VT,B as d_,d as iy,w as FT,b as UT,aa as sy}from"./Polyline-s-JzsQqo.js";import{f as HT,W as fg,Z as yg,h as zT,G as GT}from"./boundedPlane-DuGhiiFM.js";import{z as p_,w as ry,a as BT,B as qT}from"./RenderCoordsHelper-DA-pMWeR.js";import{o as kT,u as jT}from"./scaleUtils-DPfHG2g0.js";import{m as m_,y as zh,d as WT,p as Ml,j as ku,v as ay,h as ny}from"./layerUtils-B__v9OBu.js";import{Q as QT,A as YT,b as Rl,H as ZT,R as s1,c as XT,S as vg,T as KT,i as oy,h as zp,U as ly,j as JT,d as eS,y as Gp,o as tS,p as iS,q as sS,v as rS,w as aS,x as nS,e as oS,V as lS,G as r1,I as hS,J as cS,K as uS,W as a1,u as n1,P as dS,M as pS}from"./DefaultUI-BwWVKFUS.js";import{i as mS,k as hy,s as _S,d as gS,r as fS,F as yS,t as vS,e as bS,f as wS,h as xS}from"./NormalUtils.glsl-W-nmUbAv.js";import{j as o1,f as bg,c as pn,u as l1,V as h1,M as ju,W as wa,B as Al,N as Dl,k as Js,Z as c1,a as CS,S as u1,g as Hl,b as wg,o as TS,l as d1,J as p1,O as m1,z as SS,Q as PS,H as ES,p as OS,i as MS,K as RS,h as AS}from"./cameraUtils-Cg-qbPDO.js";import{i as Va}from"./Evented-Dw4_VOGn.js";import{p as DS,t as $S}from"./ElevationSamplerData-UywXoG8C.js";import{l as xg,r as Cg,m as IS,c as LS,V as fp,_ as _1,a as z,d as wh,I as g1,E as zi,$ as gr,z as Tg,e as Kt,n as Ld,T as dt,B as ua,G as cy,g as f1,C as bl,S as ci,t as Xl,h as NS,i as VS,A as ic,q as Nd,Z as uy,Y as dy,Q as py,X as my,P as js,p as __,J as FS,K as US,R as Vd,j as HS,o as zS,s as GS,w as BS,v as qS,f as Io,u as kS,x as jS,y as jc,H as WS,L as QS,N as YS,O as g_,W as Kl,U as _y,a0 as gy,a1 as ZS,a2 as XS,M as KS}from"./terrainUtils-CgFk6NLH.js";import{l as Ne,o as f_,a as Bp}from"./ViewingMode-Dodu7ZZk.js";import{a as yp}from"./Clonable-Z-AWS-16.js";import{r as Q,s as Rt,M as sc,o as ze,b as mn,l as Fd,n as JS,u as rc,L as ac}from"./mathUtils-Cfq9PL9W.js";import{d as Wu,v as Sg,j as eP,b as Wc,m as y_}from"./mathUtils-BgCEaV43.js";import{M as tP,o as ce,R as Mt,g as ee,A as ie,P as oe,I as Tr,r as we,s as le,c as ye,u as ue,p as vi,K as Pg,E as Gt,j as Zs,N as jr,_ as pt,v as rn,y as an,q as Jl,W as ys,Y as ns,H as vp,J as nc,Q as iP,$ as fy}from"./vec32-Dvg_eL9J.js";import{l as sP,f as rP,a as aP}from"./spatialReferenceEllipsoidUtils-DBqQpPRa.js";import{r as Da}from"./signal-CySMLEX9.js";import{e as oc,n as xh,c as qp,I as Ui,E as Nt,$ as nP,a as Or,O as zt,C as Ud,d as eh,f as Bs,A as zr,h as y1,i as oP,j as v1,s as yy,g as lP,k as bp,l as Eg,p as hP,q as cP,T as uP,r as Ws,P as Hd,u as dP,X as b1,v as pP,w as vy,V as mP,x as _P,y as gP}from"./OverlayCompositing.glsl-CUa8aMAb.js";import{n as Og,u as Mc,o as w1,M as zd,h as x1,f as C1,r as fP,i as yP,s as Mg,p as vP}from"./mat3-CR8GKnhD.js";import{Y as bP,p as go,B as wP,c as Zr,b as Ma,i as lc,o as Gd,s as T1,n as Rc,h as hc,e as xP,X as CP,x as by,C as TP}from"./mat4-Fi6iAz29.js";import{e as It,o as Gh,t as S1}from"./mat4f64-Dk4dwAN8.js";import{o as xo,T as P1,r as _n,m as cc,e as SP}from"./vec2-ChnYg_BJ.js";import{n as Ts,t as E1,r as PP,l as uc,c as EP}from"./vec2f64-Dy6m9Nrb.js";import{r as Br,n as OP}from"./vec3f32-nZdmKIgz.js";import{s as Ze,k as ft,m as Bt,t as qt,L as gn,N as MP,A as j,Q as dc,Y as O1,g as RP,B as M1,p as wy,r as ll,G as AP,d as DP,P as $P,ao as IP,a5 as Oa,z as R1,E as A1,q as pc,c as wp,i as br,O as LP,h as D1,l as xp,n as $1,C as Qi,F as Bh,M as NP,ap as VP,u as FP,H as UP,I as HP,aq as zP,a0 as GP,a1 as BP,D as qP,a2 as kP,K as jP,o as WP,V as QP}from"./FloatArray-BQXWSSJh.js";import{O as Zi,T as YP,R as $t,M as v_,D as Ki,E as bi,F as wr,f as I1,G as ni,I as kp,B as L1,L as Ds,_ as Jt,t as Bd,X as hs,P as zl,U as fo,C as qh}from"./enums-D9v74xTE.js";import{B as Qt,l as Rg,g as ti,_ as Ag,r as Ac,o as Dg,p as N1,d as V1,c as Dc,f as ZP,h as XP}from"./renderState-Ci93M1-P.js";import{x as $c,A as $g,i as F1,s as KP}from"./FramebufferObject-B01p0UGV.js";import{p as mi,E as JP,_ as eE,w as oi,i as $l,s as tE,e as iE,n as xy}from"./Texture-BVJ22uHh.js";import{g as ai,o as Xi,I as Oi,C as qr,F as qd,a as sE}from"./Scheduler-i_u8qdlN.js";import{a as sr,h as Co,t as ge,n as gt}from"./BooleanBindUniform-BgD_OP8i.js";import{e as De}from"./VertexAttribute-Cq4MnHjR.js";import{c as Ii}from"./NoParameters-t-PuNrgq.js";import{t as Fa}from"./glUtil-CAJRmga-.js";import{H as Cn,s as ws,a as Cy}from"./InterleavedLayout-_dYEAUNK.js";import{a as Ce,s as Ig,e as Lg,i as wl,O as Ty}from"./basicInterfaces-CZwQPxTp.js";import{r as Tn}from"./VertexArrayObject-vYejmVPr.js";import{E as $s,o as rE}from"./BufferObject-BJilD_hc.js";import{e as b_,s as aE,p as nE,d as oE}from"./weather-zOic7P_q.js";import{u as Cp,s as lE,t as hE}from"./RenderPlugin-CTXypYLE.js";import{c as Sy}from"./earthUtils-8WLQbUUl.js";import{I as Py,j as cE,O as uE,z as dE,t as Ey,r as pE}from"./ShadowCastVisualizeTechniqueConfiguration-vN_a9xco.js";import{g as mE,i as _E,h as gE,n as Wt,t as Tp,d as U1,o as H1,R as di,m as fE,E as Yi,b as yE}from"./SceneLighting-BuSMIzqo.js";import{a as Ch,d as Un,c as Ng,p as kd}from"./VirtualLighting-CdhwLgbn.js";import{S as z1}from"./JSONSupport-DcrLLGjL.js";import{h as Vg}from"./Color-VJEMvW-n.js";import{r as vE}from"./enumeration-DpvDkLNI.js";import{a3 as bE,b as G1,a1 as wE,w as xE,Z as CE,z as TE}from"./Graphic-Dt0LgVGU.js";import{k as Il,F as Sp,O as SE,K as Pp,L as Fg,u as Ug,b as To,E as Sr,U as wt,t as PE,q as EE,a as OE,N as ME}from"./sphere-Cin5efBj.js";import{W as RE,A as Xs,L as pr,j as AE,p as DE,X as $E,Y as IE,D as LE,b as NE,u as B1,Z as VE,_ as FE,e as UE}from"./LineCallout.glsl-BQyjm-mE.js";import{e as ia,r as HE}from"./mat3f64-BBpwCtoL.js";import{i as Pt,t as vs,s as w_,n as q1,r as xa}from"./RenderCamera-CDB-KFBK.js";import{T as sa,E as jd,R as k1}from"./Intersector-tBiZcjSu.js";import{s as fn,a as j1,n as Oy}from"./Cyclical-Dlbl-cQK.js";import{O as zE}from"./quat-CP7JhygC.js";import{e as GE}from"./quatf64-CCm9z-pX.js";import{r as BE,b as W1,C as Q1,x as Hg,c as Tt,a as qE,M as mc,l as Y1,O as Qa,y as My,L as kE,U as Lo,V as yo,u as jE}from"./plane-CpXmOyqq.js";import{p as Gl,g as Z1,f as X1}from"./ray-C_tSu6xd.js";import{w as _c,I as WE,L as Ry}from"./verticalOffsetUtils-BFnFdbst.js";import{a as oa,o as yn,d as QE,_ as Ay}from"./InputManager-DZ3jJnlx.js";import{s as vn,z as x_,m as K1,o as YE,a as zg,H as J1,_ as ZE,E as XE}from"./vec42-YcqnINSP.js";import{n as Mi,r as Pr,s as ur,e as KE,t as ew}from"./vec4f64-o2zAXfmz.js";import{m as JE}from"./computeTranslationToOriginAndRotation-DYUrDrjE.js";import{t as tw}from"./projectVectorToPoint-DEm8-dt4.js";import{n as Ll}from"./projectVectorToVector-CCOy_B5J.js";import{p as iw,v as eO,w as tO,q as Nl,l as C_,M as iO,u as Ic,g as sO,E as sw,y as rO,H as aO,t as nO,a as Dy,f as oO}from"./aaBoundingBox-Dw3yBk2f.js";import{l as Th,j as el,s as Gg,e as lO,H as $y,N as Iy,b as to}from"./Octree-CmoRJhci.js";import{a as Bg}from"./ElevationProvider-aS5xrHHy.js";import{o as Gr,s as Ly}from"./RenderFeature-2QP3kBrd.js";import{w as hO,g as cO}from"./unitFormatUtils-Q7ZG7HcF.js";import{t as jp,b as uO,s as rw,a as aw,c as nw}from"./ZoomMomentumEstimator-BDiG9U4W.js";import{h as ow}from"./UpdatingHandles-CzJ4c3KT.js";import{t as xs,a as dO,s as lw,f as pO,p as Pi,O as Bl,e as hw}from"./Material-C_-mgXN8.js";import{e as Xr,o as mO,i as Ur,f as Ny}from"./intersectorUtils-BNnvTT1E.js";import{a as qg,t as _O}from"./HUDMaterial-DDt4C7E7.js";import{c as gO}from"./hydratedFeatures-CNHxsqRS.js";import{y as fO}from"./labelFormatUtils-F9rkrs4Y.js";import{c as yO,d as Vy,l as vO,f as bO,a as wO,t as xO,r as ir}from"./DepthRange-BJLjx8ee.js";import{a as CO,l as Wd,t as TO,g as SO,u as PO,C as Wp}from"./RibbonLine.glsl-DwJpAQ1c.js";import{G as T_,I as EO,o as OO}from"./projectBuffer-CQnuEMuP.js";import{y as MO,c as nn,t as RO,a as AO,n as DO}from"./HighlightDefaults-CumzVg9-.js";import{R as $O}from"./elevationInfoUtils-D26wVF2d.js";import{x as Fy,t as IO,b as LO,U as NO}from"./hitTest-Dmi1EcVX.js";import{e as Qd}from"./ElevationRange-BrgM1moX.js";import{t as VO}from"./hitTestSelectUtils-UXJPjatw.js";import{h as FO,r as UO,s as Uy,i as HO}from"./MemCache-CmojB_Z1.js";import{E as zO}from"./ByteSizeUnit-BsxeN7wM.js";import{n as GO}from"./DefaultLoadingContext-pYVsNNqG.js";import{j as BO}from"./wosrLoader-CvsaTck0.js";import{n as qO}from"./CollectionFlattener-U8hHQmGf.js";import{b as kO,_ as jO}from"./GridLocalOriginFactory-CngFIYNp.js";import{i as WO}from"./intersectorUtilsConversions-CiJ6bOx7.js";import{o as QO,e as on,t as bn,n as D,i as Lc,u as oo,b as YO,c as gc}from"./Matrix3PassUniform-uCCQMnlP.js";import{t as Yd}from"./NestedMap-GuqgquCN.js";import{i as cw}from"./DrawParameters-C9t9_e99.js";import{f as ZO,s as fc}from"./Normals-D6WqMXVD.js";import{N as uw,h as kg,g as dw,x as XO,T as KO,C as JO,w as e2}from"./DefaultBufferWriter-CqCDaNCZ.js";import{i as t2,x as Zd}from"./BufferView-0osDbyWD.js";import{u as pw}from"./common-DQOJ18NT.js";import"./TileStrategy-CtmYSAoK.js";import{e as i2}from"./TileKey-DBTeo_j0.js";import{r as s2,t as r2,s as a2,l as n2,a as o2,b as l2}from"./RenderableTile-FJVLrFon.js";import{i as h2,a as c2}from"./StyleDefinition-C2Flw6Qv.js";import{s as u2,a as d2}from"./resources-D31XxULB.js";import{a as Ua,i as ne}from"./ShaderTechniqueConfiguration-D4dZMCXS.js";import{h as p2}from"./WorkerHandle-CKOgUZ7i.js";import{s as m2}from"./Attribute-DGhdp5lO.js";import{t as _2,a as Ra,n as Xd,r as g2}from"./NormalAttribute.glsl-0GHNIsQf.js";import{r as f2}from"./floatRGBA-Cb__GiDF.js";import{F as jg}from"./colorUtils-DaPfwnk3.js";import{r as y2}from"./GeometryUtil-D-PMXorz.js";import{t as mw,o as v2,U as b2}from"./Indices-D8XWalpO.js";import{f as w2}from"./vec3-BXNNVgyU.js";import{t as x2}from"./vec33-KumQEj7U.js";import{L as C2}from"./orientedBoundingBox-B17G_yFO.js";import{C as Nc,e as T2,d as S2,A as No}from"./edgeUtils-D0U-z06n.js";import{j as Wg,b as _w,c as Kd,d as P2,x as E2,u as O2,p as S_,h as M2,g as tn,k as gw,l as R2,e as A2,q as D2,T as $2,w as Qg,t as I2,y as L2,E as N2}from"./DefaultMaterial-GRoe8HM5.js";import{o as V2}from"./ShaderTechniqueRepository-Ch1TPHrL.js";import{c as Ps}from"./HUDRenderStyle-BhGvVxgm.js";import{o as fw,i as Hn,r as F2,m as U2,a as th}from"./Blit-_zFq7-RL.js";import{t as yc}from"./requestImageUtils-DWgRKL5q.js";import{l as yw}from"./DefaultVertexAttributeLayouts-wSIZdMhB.js";import{E as H2}from"./testSVGPremultipliedAlpha-BGpZOwI7.js";import{y as z2,n as G2}from"./RenderingContext-7iVYEQBa.js";import{s as Qp}from"./imageUtils-DsXKmbqJ.js";import{t as B2}from"./layerViewUtils-Bevty3Jm.js";import{o as Hy,r as zy}from"./screenUtils-BWEEmpSb.js";import{r as Gy}from"./spatialReferenceSupport-DfixDcu7.js";import{e as q2}from"./makeScheduleFunction-CggzEh3c.js";import{n as w,t as Pe}from"./glsl-BH37Aalp.js";import{a as vw}from"./BindType-BBwFZqyN.js";import{i as kt}from"./ShaderBuilder-BKul5qh8.js";import{e as ra}from"./Float2PassUniform-x4sHx2JD.js";import{a as k2,o as bw,i as j2,t as W2,n as ww,v as Qu,e as xw}from"./VertexColor.glsl-D3WyDYIi.js";import{t as Yg}from"./RgbaFloatEncoding.glsl-_io2eW3M.js";import{o as Q2}from"./Float4DrawUniform-Db0CLl_z.js";import{f as Zg}from"./CameraSpace.glsl-g9iLbhnR.js";import{o as Y2}from"./Matrix4PassUniform-COGIPIq4.js";function Cw(s,e){const t=Wf(s),i=Wf(e),r=t.store,a=i.store,n=i.metadata;for(const o in n){const l=n[o],h=r.originOf(o),u=a.originOf(o);if(!l.readOnly&&u!==Qf.DEFAULTS)if(h===Qf.DEFAULTS)s.set(o,a.get(o));else{const d=r.get(o),p=a.get(o);d&&p&&p instanceof Re&&d instanceof Re&&d instanceof p.constructor&&Cw(d,p)}}}let Ya=class extends Va.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=xg}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const e=this.view.basemapTerrain;if((e==null?void 0:e.extent)==null||e.spatialReference==null)return null;const t=e1(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){var e;return((e=this.view.basemapTerrain)==null?void 0:e.spatialReference)??si.WGS84}elevationAt(e,t){var i;if(this.extent==null||!PT(this.extent,e,t)){const r=this.extent!=null?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return pe.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${r})`),this.noDataValue}return((i=this.view.elevationProvider)==null?void 0:i.getElevation(e,t,0,this.spatialReference,"ground"))??this.noDataValue}queryElevation(e){return DS(e.clone(),this)}};c([m({readOnly:!0})],Ya.prototype,"demResolution",void 0),c([m({readOnly:!0})],Ya.prototype,"extent",null),c([m({readOnly:!0})],Ya.prototype,"noDataValue",void 0),c([m()],Ya.prototype,"spatialReference",null),c([m({constructOnly:!0})],Ya.prototype,"view",void 0),Ya=c([F("esri.views.support.GroundViewElevationSampler")],Ya);const Z2=Ya;let _a=class extends Re{constructor(e){super(e),this.view=null,this.layerViews=new wo}initialize(){this.addHandles(Pl(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground},e=>e.load())),this.addHandles(this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()))}destroy(){this._set("view",null);for(const e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new Z2({view:this.view}):null:null}get extent(){const e=this.view;return e&&e.type!=="2d"&&e.ready?o1(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){var e;return((e=this.view)==null?void 0:e.suspended)??!0}_layerViewsAfterChangesHandler(){this.removeHandles("updating"),this.addHandles(this.layerViews.map(e=>O(()=>e.updating,()=>this._updateUpdating(),Ge)).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};c([m({readOnly:!0})],_a.prototype,"elevationSampler",null),c([m({readOnly:!0})],_a.prototype,"extent",null),c([m({type:Boolean,readOnly:!0})],_a.prototype,"updating",null),c([m({constructOnly:!0})],_a.prototype,"view",void 0),c([m({type:wo,readOnly:!0})],_a.prototype,"layerViews",void 0),c([m({readOnly:!0})],_a.prototype,"suspended",null),_a=c([F("esri.views.GroundView")],_a);const X2=_a,ih=()=>X(()=>import("./TileLayerView3D-B72EtQ_i.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279]),import.meta.url),By=()=>X(()=>import("./ElevationLayerView3D-Cbu-WnI2.js"),__vite__mapDeps([280,1,281,270,168,169,5,8,3,4,9,166,29,16,17,18,19,20,7,10,21,22,23,24,13,25,26,27,28,30,31,32,33,11,12,34,35,36,37,38,6,39,40,41,42,43,44,45,46,47,48,49,50,51,52,14,15,53,54,55,56,57,58,59,60,2,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,147,148,162,163,164,165,167,170,171,172,151,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,159,160,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,271,272,273,274,275,276,277,278,279]),import.meta.url),qy={"base-dynamic":()=>X(()=>import("./BaseDynamicLayerView3D-BVQPGahd.js"),__vite__mapDeps([282,1,283,17,18,5,11,7,8,3,4,9,10,12,13,217,42,6,43,49,14,15,97,61,56,62,63,51,45,64,46,44,47,48,41,50,65,66,67,69,70,71,72,73,74,75,76,77,68,78,79,80,81,82,83,84,40,28,29,85,86,90,91,92,93,94,36,95,96,16,19,20,39,115,116,284,285,38,286,33,156,157,216,126,218,24,219,122,220,30,133,112,221,199,23,222,223,224,100,225,137,135,136,287,127,99,288,289,128,113,129,147,32,148,143,149]),import.meta.url),"base-elevation":By,"base-tile":ih,"bing-maps":ih,"building-scene":()=>X(()=>import("./BuildingSceneLayerView3D-YdNSL369.js"),__vite__mapDeps([290,1,17,18,5,291,176,38,3,4,8,9,29,10,11,7,292,26,27,28,30,23,24,13,31,32,33,12,34,35,36,37,6,39,293,294,146,295,296,104,105,20,297,298,57,40,299,190,300,167,301,192,193,159,160,140,302,303,304,305,25,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,189,168,169,166,321,322,2,14,15,323,324,325,326,327,186,187,51,43,328,329,151,330,331,332,333,334,335,336,337,245,338,339,340,341,253,256,342,343,344,264,345,346,45,49,347,348,349,350,351,177,352,145,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,47,42,59,60,63,64,46,44,48,41,50,369,56,52,110,93,111,84,71,70,96,112,113,121,122,123,66,97,143,161,370,371,372,240,148,373,374,251,22,53,54,55,58,61,62,65,67,68,69,72,73,74,75,76,77,78,79,80,81,82,83,85,86,87,88,89,90,91,92,94,95,98,99,100,101,102,103,106,107,108,109,114,115,116,117,118,119,120,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,249,375,376,377,271,378,379,380,381,382,185,178,247,383,384,385,386,387,217,174,388,212,270,250,389,390,279,233,222,199,391,392,393,394,154,155,156,157,395,396,397,398,399,400,401,402,403,404,213,405,16,19,147,162,163,164,165,170,171,172,173,175,179,180,181,182,183,184,188,191,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,214,215,216,218,219,220,221,223,224,225,226,227,228,229,230,231,139,141,142,232,234,235,236,237,238,239,241,242,243,244,246,248,252,254,255,257,258,259,260,261,262,263,265,266,267,268,269,272,273,274,275,276,277,278]),import.meta.url),catalog:()=>X(()=>import("./CatalogLayerView3D-DsaVKxrj.js"),__vite__mapDeps([406,1,17,18,5,16,19,20,8,3,4,9,7,10,407,147,32,29,148,143]),import.meta.url),"catalog-dynamic-group":()=>X(()=>import("./CatalogDynamicGroupLayerView3D-Db15gpRD.js"),__vite__mapDeps([408,1,17,18,5,16,19,20,8,3,4,9,7,10,409,28,29,147,32,148,143]),import.meta.url),"catalog-footprint":()=>X(()=>import("./CatalogFootprintLayerView3D-CcP9MEHG.js"),__vite__mapDeps([410,1,411,3,4,17,18,5,102,100,7,8,9,10,39,11,12,13,103,34,104,30,105,412,58,26,27,28,29,23,24,31,32,33,35,36,37,38,6,59,14,15,60,2,396,160,159,397,256,192,193,284,285,286,156,157,90,51,43,47,42,63,45,49,64,46,44,48,41,50,77,61,56,62,65,66,67,69,70,71,72,73,74,75,76,68,78,79,80,81,82,83,84,40,85,86,91,92,93,94,95,96,199,148,300,167,301,140,302,303,304,305,25,306,307,308,309,310,311,312,313,314,315,316,191,413,87,88,89,135,136,139,141,142,414,327,186,187,415,343,344,264,341,253,416,247,57,53,52,54,55,417,418,22,97,98,99,101,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,137,138,217,383,189,384,185,178,166,385,386,387,161,174,169,143,419,389,334,152,398,399,370,371,393,394,154,155,395,400,401,346,402,190,403,404,213,405,342,323,390,151,420,421,216,218,219,220,221,222,223,224,225,232,422,16,19,20,423,424,425,322,270,168,426,427,428,330,333,429,147,149,430,162,163,164,165,170,171,172,173,175,176,177,179,180,181,182,183,184,188,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,212,214,215,226,227,228,229,230,231,233,234,235,236,237,238,239,240,241,242,243,244,245,246,248,249,250,251,252,254,255,257,258,259,260,261,262,263,265,266,267,268,269,271,272,273,274,275,276,277,278,279]),import.meta.url),csv:()=>X(()=>import("./CSVLayerView3D-C_2Zm9rC.js"),__vite__mapDeps([431,1,411,3,4,17,18,5,102,100,7,8,9,10,39,11,12,13,103,34,104,30,105,412,58,26,27,28,29,23,24,31,32,33,35,36,37,38,6,59,14,15,60,2,396,160,159,397,256,192,193,284,285,286,156,157,90,51,43,47,42,63,45,49,64,46,44,48,41,50,77,61,56,62,65,66,67,69,70,71,72,73,74,75,76,68,78,79,80,81,82,83,84,40,85,86,91,92,93,94,95,96,199,148,300,167,301,140,302,303,304,305,25,306,307,308,309,310,311,312,313,314,315,316,191,413,87,88,89,135,136,139,141,142,414,327,186,187,415,343,344,264,341,253,416,247,57,53,52,54,55,417,418,22,97,98,99,101,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,137,138,217,383,189,384,185,178,166,385,386,387,161,174,169,143,419,389,334,152,398,399,370,371,393,394,154,155,395,400,401,346,402,190,403,404,213,405,342,323,390,151,420,421,216,218,219,220,221,222,223,224,225,232,422,16,19,20,423,424,425,322,270,168,426,427,428,330,333,429,147,149,162,163,164,165,170,171,172,173,175,176,177,179,180,181,182,183,184,188,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,212,214,215,226,227,228,229,230,231,233,234,235,236,237,238,239,240,241,242,243,244,245,246,248,249,250,251,252,254,255,257,258,259,260,261,262,263,265,266,267,268,269,271,272,273,274,275,276,277,278,279]),import.meta.url),dimension:()=>X(()=>import("./DimensionLayerView3D-H_m_qrU1.js"),__vite__mapDeps([432,3,4,1,17,18,5,16,19,20,8,9,7,10,147,32,29,148,143]),import.meta.url),elevation:By,feature:()=>X(()=>import("./FeatureLayerView3D-C_RV6Dyl.js"),__vite__mapDeps([433,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,140,411,17,18,102,100,39,103,34,104,30,105,412,58,26,27,28,29,23,24,31,32,33,35,36,37,38,59,60,396,160,159,397,256,192,193,284,285,286,156,157,90,51,43,47,42,63,45,49,64,46,44,48,41,50,77,61,56,62,65,66,67,69,70,71,72,73,74,75,76,68,78,79,80,81,82,83,84,40,85,86,91,92,93,94,95,96,199,148,300,167,301,302,303,304,305,25,306,307,308,309,310,311,312,313,314,315,316,191,413,87,88,89,135,136,139,141,142,414,327,186,187,415,343,344,264,341,253,416,247,57,53,52,54,55,417,418,22,97,98,99,101,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,137,138,217,383,189,384,185,178,166,385,386,387,161,174,169,143,419,389,334,152,398,399,370,371,393,394,154,155,395,400,401,346,402,190,403,404,213,405,342,323,390,151,420,421,216,218,219,220,221,222,223,224,225,232,422,16,19,20,423,424,425,322,270,168,426,427,428,330,333,429,147,149,162,163,164,165,170,171,172,173,175,176,177,179,180,181,182,183,184,188,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,212,214,215,226,227,228,229,230,231,233,234,235,236,237,238,239,240,241,242,243,244,245,246,248,249,250,251,252,254,255,257,258,259,260,261,262,263,265,266,267,268,269,271,272,273,274,275,276,277,278,279]),import.meta.url),geojson:()=>X(()=>import("./GeoJSONLayerView3D-CYq_vFML.js"),__vite__mapDeps([434,1,411,3,4,17,18,5,102,100,7,8,9,10,39,11,12,13,103,34,104,30,105,412,58,26,27,28,29,23,24,31,32,33,35,36,37,38,6,59,14,15,60,2,396,160,159,397,256,192,193,284,285,286,156,157,90,51,43,47,42,63,45,49,64,46,44,48,41,50,77,61,56,62,65,66,67,69,70,71,72,73,74,75,76,68,78,79,80,81,82,83,84,40,85,86,91,92,93,94,95,96,199,148,300,167,301,140,302,303,304,305,25,306,307,308,309,310,311,312,313,314,315,316,191,413,87,88,89,135,136,139,141,142,414,327,186,187,415,343,344,264,341,253,416,247,57,53,52,54,55,417,418,22,97,98,99,101,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,137,138,217,383,189,384,185,178,166,385,386,387,161,174,169,143,419,389,334,152,398,399,370,371,393,394,154,155,395,400,401,346,402,190,403,404,213,405,342,323,390,151,420,421,216,218,219,220,221,222,223,224,225,232,422,16,19,20,423,424,425,322,270,168,426,427,428,330,333,429,147,149,162,163,164,165,170,171,172,173,175,176,177,179,180,181,182,183,184,188,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,212,214,215,226,227,228,229,230,231,233,234,235,236,237,238,239,240,241,242,243,244,245,246,248,249,250,251,252,254,255,257,258,259,260,261,262,263,265,266,267,268,269,271,272,273,274,275,276,277,278,279]),import.meta.url),graphics:()=>X(()=>import("./GraphicsLayerView3D-DbYDPeRg.js"),__vite__mapDeps([435,1,17,18,5,16,19,20,8,3,4,9,7,10,416,6,60,2,11,12,13,14,15,59,247,57,40,53,51,43,47,52,54,55,56,58,26,27,28,29,30,23,24,31,32,33,34,35,36,37,38,39,436,311,148,189,159,160,22,25,41,42,44,45,46,48,49,50,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,192,193,217,383,253,310,303,304,305,306,307,140,308,309,312,313,384,185,186,187,178,166,385,386,387,161,174,169,143,419,390,284,285,286,156,157,147,199]),import.meta.url),group:()=>X(()=>import("./GroupLayerView3D-Cky0Lmzf.js"),__vite__mapDeps([437,1,438,17,18,5,37,147,32,29,8,3,4,9,148,143]),import.meta.url),imagery:()=>X(()=>import("./ImageryLayerView3D-Dc46E0Y2.js"),__vite__mapDeps([439,1,17,18,5,283,11,7,8,3,4,9,10,12,13,217,42,6,43,49,14,15,97,61,56,62,63,51,45,64,46,44,47,48,41,50,65,66,67,69,70,71,72,73,74,75,76,77,68,78,79,80,81,82,83,84,40,28,29,85,86,90,91,92,93,94,36,95,96,16,19,20,39,115,116,284,285,38,286,33,156,157,216,126,218,24,219,122,220,30,133,112,221,199,23,222,223,224,100,225,137,135,136,287,127,99,288,289,128,113,129,147,32,148,143,149,440,396,160,159,397,256,441,2,192,34,104,105,193,27,161]),import.meta.url),"integrated-mesh":()=>X(()=>import("./IntegratedMeshLayerView3D-Kc0HdtU4.js"),__vite__mapDeps([442,1,26,27,17,18,5,9,8,3,4,10,28,29,7,30,23,24,13,31,32,33,11,12,34,35,36,37,38,6,39,372,240,64,43,46,51,47,48,42,45,49,148,123,373,14,15,374,63,44,41,50,251,22,25,40,52,53,54,55,56,57,58,59,60,2,61,62,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,249,375,253,167,376,377,368,192,193,159,160,369,143,271,378,166,301,379,380,347,381,382,185,186,187,178,247,311,383,189,310,303,304,305,306,307,140,308,309,312,313,384,385,386,387,217,161,174,169,388,212,270,168,250,389,390,279,233,222,199,16,19,20,147,162,163,164,165,170,171,172,151,173,175,176,177,179,180,181,182,183,184,188,190,191,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,213,214,215,216,218,219,220,221,223,224,225,226,227,228,229,230,231,139,141,142,232,234,235,236,237,238,239,241,242,243,244,245,246,248,252,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,272,273,274,275,276,277,278]),import.meta.url),"integrated-mesh-3dtiles":()=>X(()=>import("./IntegratedMesh3DTilesLayerView3D-BkS-08TX.js"),__vite__mapDeps([443,1,17,18,5,64,43,46,51,6,47,48,42,49,7,8,3,4,9,10,52,13,14,15,373,374,12,11,63,45,44,41,50,251,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,53,54,55,56,57,58,59,60,2,61,62,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,444,247,217,16,19,20,173,165,166,167,148,174,169,175,176,177,178,179,140,180,181,182,183,184,185,186,187,188,189,159,160,170,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,250,226,147,143,162,163,164,168,171,172,151,210,211,212,213,214,215,216,218,219,220,221,222,223,224,225,227,228,229,230,231,139,141,142,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,248,249,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279]),import.meta.url),"line-of-sight":()=>X(()=>import("./LineOfSightLayerView3D-D2cUUg5R.js"),__vite__mapDeps([445,3,4,1,17,18,5,16,19,20,8,9,7,10,147,32,29,148,143]),import.meta.url),"map-image":()=>X(()=>import("./MapImageLayerView3D-BADgY6VG.js"),__vite__mapDeps([446,1,283,17,18,5,11,7,8,3,4,9,10,12,13,217,42,6,43,49,14,15,97,61,56,62,63,51,45,64,46,44,47,48,41,50,65,66,67,69,70,71,72,73,74,75,76,77,68,78,79,80,81,82,83,84,40,28,29,85,86,90,91,92,93,94,36,95,96,16,19,20,39,115,116,284,285,38,286,33,156,157,216,126,218,24,219,122,220,30,133,112,221,199,23,222,223,224,100,225,137,135,136,287,127,99,288,289,128,113,129,147,32,148,143,149,447,448,151,152,158,396,160,159,397,256,150,153,154,155,34,26,27,31,35,37,161]),import.meta.url),media:()=>X(()=>import("./MediaLayerView3D-CA8q46Z9.js").then(s=>s.M),__vite__mapDeps([449,1,450,64,43,46,80,42,6,12,10,11,7,8,3,4,9,13,2,5,14,15,451,33,155,17,18,217,49,97,61,56,62,63,51,45,44,47,48,41,50,65,66,67,69,70,71,72,73,74,75,76,77,68,78,79,81,82,83,84,40,28,29,85,86,90,91,92,93,94,36,95,96,16,19,20,452,453,148,454,455,174,169,456,457,458,247,57,459,23,24,160,59,60,192,30,34,104,105,193,27,159,397,256,460,461,216,126,218,219,122,220,133,112,221,199,222,223,224,100,225,137,135,136,287,127,99,39,288,289,128,113,129,147,32,143,462]),import.meta.url),"ogc-feature":()=>X(()=>import("./OGCFeatureLayerView3D-B8t2SaYh.js"),__vite__mapDeps([463,1,411,3,4,17,18,5,102,100,7,8,9,10,39,11,12,13,103,34,104,30,105,412,58,26,27,28,29,23,24,31,32,33,35,36,37,38,6,59,14,15,60,2,396,160,159,397,256,192,193,284,285,286,156,157,90,51,43,47,42,63,45,49,64,46,44,48,41,50,77,61,56,62,65,66,67,69,70,71,72,73,74,75,76,68,78,79,80,81,82,83,84,40,85,86,91,92,93,94,95,96,199,148,300,167,301,140,302,303,304,305,25,306,307,308,309,310,311,312,313,314,315,316,191,413,87,88,89,135,136,139,141,142,414,327,186,187,415,343,344,264,341,253,416,247,57,53,52,54,55,417,418,22,97,98,99,101,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,137,138,217,383,189,384,185,178,166,385,386,387,161,174,169,143,419,389,334,152,398,399,370,371,393,394,154,155,395,400,401,346,402,190,403,404,213,405,342,323,390,151,420,421,216,218,219,220,221,222,223,224,225,232,422,16,19,20,423,424,425,322,270,168,426,427,428,330,333,429,147,149,464,162,163,164,165,170,171,172,173,175,176,177,179,180,181,182,183,184,188,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,212,214,215,226,227,228,229,230,231,233,234,235,236,237,238,239,240,241,242,243,244,245,246,248,249,250,251,252,254,255,257,258,259,260,261,262,263,265,266,267,268,269,271,272,273,274,275,276,277,278,279]),import.meta.url),"open-street-map":ih,"oriented-imagery":()=>X(()=>import("./FeatureLayerView3D-C_RV6Dyl.js"),__vite__mapDeps([433,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,140,411,17,18,102,100,39,103,34,104,30,105,412,58,26,27,28,29,23,24,31,32,33,35,36,37,38,59,60,396,160,159,397,256,192,193,284,285,286,156,157,90,51,43,47,42,63,45,49,64,46,44,48,41,50,77,61,56,62,65,66,67,69,70,71,72,73,74,75,76,68,78,79,80,81,82,83,84,40,85,86,91,92,93,94,95,96,199,148,300,167,301,302,303,304,305,25,306,307,308,309,310,311,312,313,314,315,316,191,413,87,88,89,135,136,139,141,142,414,327,186,187,415,343,344,264,341,253,416,247,57,53,52,54,55,417,418,22,97,98,99,101,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,137,138,217,383,189,384,185,178,166,385,386,387,161,174,169,143,419,389,334,152,398,399,370,371,393,394,154,155,395,400,401,346,402,190,403,404,213,405,342,323,390,151,420,421,216,218,219,220,221,222,223,224,225,232,422,16,19,20,423,424,425,322,270,168,426,427,428,330,333,429,147,149,162,163,164,165,170,171,172,173,175,176,177,179,180,181,182,183,184,188,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,212,214,215,226,227,228,229,230,231,233,234,235,236,237,238,239,240,241,242,243,244,245,246,248,249,250,251,252,254,255,257,258,259,260,261,262,263,265,266,267,268,269,271,272,273,274,275,276,277,278,279]),import.meta.url),"point-cloud":()=>X(()=>import("./PointCloudLayerView3D-Dj7xiTN4.js"),__vite__mapDeps([465,1,26,27,17,18,5,9,8,3,4,10,28,29,7,30,23,24,13,31,32,33,11,12,34,35,36,37,38,6,39,100,42,43,116,44,45,46,47,48,41,49,50,104,105,135,73,136,192,193,159,160,247,57,40,16,19,20,22,25,51,52,14,15,53,54,55,56,58,59,60,2,61,62,63,64,65,66,67,68,69,70,71,72,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,101,102,103,106,107,108,109,110,111,112,113,114,115,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,137,138,270,168,169,166,368,369,143,250,221,223,224,222,466,467,312,306,390,468,161,248,249,140,147,148,199,162,163,164,165,167,170,171,172,151,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,225,226,227,228,229,230,231,139,141,142,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,271,272,273,274,275,276,277,278,279]),import.meta.url),viewshed:()=>X(()=>import("./ViewshedLayerView3D-CX_tkSQj.js"),__vite__mapDeps([469,3,4,1,17,18,5,16,19,20,8,9,7,10,147,32,29,148,143]),import.meta.url),voxel:()=>X(()=>import("./VoxelLayerView3D-Buf2ojED.js"),__vite__mapDeps([470,1,17,18,5,42,6,43,7,8,3,4,9,10,59,11,12,13,14,15,60,2,39,16,19,20,471,26,27,28,29,30,23,24,31,32,33,34,35,36,37,38,22,25,40,41,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,468,161,147,148,143,162,163,164,165,166,167,168,169,170,171,172,151,140,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,159,160,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,139,141,142,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279]),import.meta.url),route:()=>X(()=>import("./RouteLayerView3D-Bok-hxPn.js"),__vite__mapDeps([472,1,17,18,5,181,473,26,27,9,8,3,4,10,28,29,7,30,23,24,13,31,32,33,11,12,34,35,36,37,38,6,39,474,16,19,20,436,311,148,189,159,160,58,59,14,15,60,2,22,25,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,192,193,217,383,253,310,303,304,305,306,307,140,308,309,312,313,384,185,186,187,178,166,385,386,387,161,174,169,143,419,390,284,285,286,156,157,426,147,199]),import.meta.url),scene:s=>s.profile==null||s.profile==="mesh-pyramids"?X(()=>import("./SceneLayerView3D-WxrgQpXE.js"),__vite__mapDeps([475,1,26,27,17,18,5,9,8,3,4,10,28,29,7,30,23,24,13,31,32,33,11,12,34,35,36,37,38,6,39,378,370,371,334,192,104,105,193,159,160,152,372,240,64,43,46,51,47,48,42,45,49,148,123,373,14,15,374,63,44,41,50,251,22,25,40,52,53,54,55,56,57,58,59,60,2,61,62,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,249,375,253,167,376,377,368,369,143,271,166,301,379,380,347,381,382,185,186,187,178,247,311,383,189,310,303,304,305,306,307,140,308,309,312,313,384,385,386,387,217,161,174,169,388,212,270,168,250,389,390,279,233,222,199,16,19,20,476,392,393,394,154,155,156,157,395,396,397,256,147,391,398,399,341,400,401,346,402,190,403,404,213,405,315,342,323,468,162,163,164,165,170,171,172,151,173,175,176,177,179,180,181,182,183,184,188,191,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,214,215,216,218,219,220,221,223,224,225,226,227,228,229,230,231,139,141,142,232,234,235,236,237,238,239,241,242,243,244,245,246,248,252,254,255,257,258,259,260,261,262,263,264,265,266,267,268,269,272,273,274,275,276,277,278]),import.meta.url):X(()=>import("./SceneLayerGraphicsView3D-Brao_V44.js"),__vite__mapDeps([477,3,4,1,100,17,18,5,42,6,43,14,13,7,8,9,10,15,59,11,12,60,2,39,249,102,103,34,104,30,105,58,26,27,28,29,23,24,31,32,33,35,36,37,38,375,101,135,73,136,66,253,167,64,46,374,88,89,63,51,45,49,44,47,48,41,50,376,77,69,70,71,61,56,62,65,67,72,74,75,76,68,78,79,80,81,82,83,84,40,85,86,125,111,126,127,99,120,121,122,123,52,97,128,113,129,92,130,131,132,133,95,134,377,368,192,193,159,160,369,110,93,96,112,143,251,271,94,53,54,55,57,22,25,87,90,91,98,106,107,108,109,114,115,116,117,118,119,124,137,138,378,166,301,334,185,186,187,178,270,168,169,16,19,20,417,418,311,148,217,383,189,310,303,304,305,306,307,140,308,309,312,313,384,385,386,387,161,174,419,389,152,398,399,341,370,371,393,394,154,155,156,157,395,400,401,346,402,190,403,404,213,405,315,342,323,390,199,476,392,396,397,256,147,468,162,163,164,165,170,171,172,151,173,175,176,177,179,180,181,182,183,184,188,191,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,212,214,215,216,218,219,220,221,222,223,224,225,226,227,228,229,230,231,139,141,142,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,250,252,254,255,257,258,259,260,261,262,263,264,265,266,267,268,269,272,273,274,275,276,277,278,279]),import.meta.url),stream:()=>X(()=>import("./StreamLayerView3D-C2h-UiZ6.js"),__vite__mapDeps([478,1,17,18,5,26,27,9,8,3,4,10,28,29,7,30,23,24,13,31,32,33,11,12,34,35,36,37,38,6,39,479,480,481,482,2,14,15,423,154,155,156,157,424,425,100,108,107,109,322,192,104,105,193,159,160,426,73,412,58,59,60,396,397,256,284,285,286,90,51,43,47,42,63,45,49,64,46,44,48,41,50,77,61,56,62,65,66,67,69,70,71,72,74,75,76,68,78,79,80,81,82,83,84,40,85,86,91,92,93,94,95,96,199,148,300,167,301,140,302,303,304,305,25,306,307,308,309,310,311,312,313,314,315,316,191,102,103,413,87,88,89,135,136,139,141,142,414,327,186,187,415,343,344,264,341,253,416,247,57,53,52,54,55,417,418,22,97,98,99,101,106,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,137,138,217,383,189,384,185,178,166,385,386,387,161,174,169,143,419,389,334,152,398,399,370,371,393,394,395,400,401,346,402,190,403,404,213,405,342,323,390,151,420,421,216,218,219,220,221,222,223,224,225,232,422,16,19,20,147,483,162,163,164,165,168,170,171,172,173,175,176,177,179,180,181,182,183,184,188,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,212,214,215,226,227,228,229,230,231,233,234,235,236,237,238,239,240,241,242,243,244,245,246,248,249,250,251,252,254,255,257,258,259,260,261,262,263,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279]),import.meta.url),tile:ih,"imagery-tile":()=>X(()=>import("./ImageryTileLayerView3D-BGbxBMnm.js"),__vite__mapDeps([484,1,17,18,5,441,3,4,7,8,9,10,11,12,13,2,6,14,15,16,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,485,486,487,396,160,159,397,256,161,147,148,149,153,203,162,163,164,165,166,167,168,169,170,171,172,151,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279]),import.meta.url),"vector-tile":()=>X(()=>import("./VectorTileLayerView3D-BODV0wOR.js"),__vite__mapDeps([488,1,17,18,5,253,173,165,166,29,8,3,4,9,167,148,174,169,73,175,37,38,10,11,7,176,177,178,179,140,23,24,13,30,180,28,181,182,183,184,185,186,36,187,51,6,43,188,189,32,159,160,170,26,27,31,33,12,34,35,39,20,190,191,192,104,105,193,194,195,196,197,198,199,200,19,66,2,14,15,42,201,202,203,204,205,206,207,208,209,489,168,265,490,74,72,75,425,100,491,93,344,264,492,259,64,258,80,260,261,262,263,266,267,268,222,224,141,142,493,98,494,495,496,497,271,45,49,16,21,22,25,40,41,44,46,47,48,50,52,53,54,55,56,57,58,59,60,61,62,63,65,67,68,69,70,71,76,77,78,79,81,82,83,84,85,86,87,88,89,90,91,92,94,95,96,97,99,101,102,103,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,143,147,162,163,164,171,172,151,210,211,212,213,214,215,216,217,218,219,220,221,223,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,254,255,256,257,269,270,272,273,274,275,276,277,278,279]),import.meta.url),wcs:()=>X(()=>import("./ImageryTileLayerView3D-BGbxBMnm.js"),__vite__mapDeps([484,1,17,18,5,441,3,4,7,8,9,10,11,12,13,2,6,14,15,16,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,485,486,487,396,160,159,397,256,161,147,148,149,153,203,162,163,164,165,166,167,168,169,170,171,172,151,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279]),import.meta.url),"web-tile":ih,wfs:()=>X(()=>import("./WFSLayerView3D-LlSms5Mu.js"),__vite__mapDeps([498,1,411,3,4,17,18,5,102,100,7,8,9,10,39,11,12,13,103,34,104,30,105,412,58,26,27,28,29,23,24,31,32,33,35,36,37,38,6,59,14,15,60,2,396,160,159,397,256,192,193,284,285,286,156,157,90,51,43,47,42,63,45,49,64,46,44,48,41,50,77,61,56,62,65,66,67,69,70,71,72,73,74,75,76,68,78,79,80,81,82,83,84,40,85,86,91,92,93,94,95,96,199,148,300,167,301,140,302,303,304,305,25,306,307,308,309,310,311,312,313,314,315,316,191,413,87,88,89,135,136,139,141,142,414,327,186,187,415,343,344,264,341,253,416,247,57,53,52,54,55,417,418,22,97,98,99,101,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,137,138,217,383,189,384,185,178,166,385,386,387,161,174,169,143,419,389,334,152,398,399,370,371,393,394,154,155,395,400,401,346,402,190,403,404,213,405,342,323,390,151,420,421,216,218,219,220,221,222,223,224,225,232,422,16,19,20,423,424,425,322,270,168,426,427,428,330,333,429,147,149,162,163,164,165,170,171,172,173,175,176,177,179,180,181,182,183,184,188,194,195,196,197,198,200,201,202,203,204,205,206,207,208,209,210,211,212,214,215,226,227,228,229,230,231,233,234,235,236,237,238,239,240,241,242,243,244,245,246,248,249,250,251,252,254,255,257,258,259,260,261,262,263,265,266,267,268,269,271,272,273,274,275,276,277,278,279]),import.meta.url),wms:()=>X(()=>import("./WMSLayerView3D-CCLXF6P3.js"),__vite__mapDeps([499,1,11,7,8,3,4,9,10,283,17,18,5,12,13,217,42,6,43,49,14,15,97,61,56,62,63,51,45,64,46,44,47,48,41,50,65,66,67,69,70,71,72,73,74,75,76,77,68,78,79,80,81,82,83,84,40,28,29,85,86,90,91,92,93,94,36,95,96,16,19,20,39,115,116,284,285,38,286,33,156,157,216,126,218,24,219,122,220,30,133,112,221,199,23,222,223,224,100,225,137,135,136,287,127,99,288,289,128,113,129,147,32,148,143,149,500,501,396,160,159,397,256]),import.meta.url),wmts:()=>X(()=>import("./WMTSLayerView3D-mXeXfXzi.js"),__vite__mapDeps([502,1,17,18,5,140,8,3,4,9,16,19,20,7,10,21,22,23,24,13,25,26,27,28,29,30,31,32,33,11,12,34,35,36,37,38,6,39,40,41,42,43,44,45,46,47,48,49,50,51,52,14,15,53,54,55,56,57,58,59,60,2,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,141,142,143,144,145,146,147,148,149,162,163,164,165,166,167,168,169,170,171,172,151,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,159,160,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279]),import.meta.url),parquet:null,"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};function K2(s){const e=s.declaredClass?s.declaredClass.slice(s.declaredClass.lastIndexOf(".")+1):"Unknown",t=e.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new Ri(`${t}:view-not-supported`,`${e} is not supported in 3D`)}const ky={hasLayerViewModule:s=>qy[s.type]!=null,importLayerView:s=>{const e=qy[s.type];if(e==null)throw K2(s);return e(s)}},jy="analyses-owner-handles";var hl,Yn;(function(s){s[s.PENDING=0]="PENDING",s[s.CREATED=1]="CREATED"})(hl||(hl={})),function(s){s[s.ADDED=0]="ADDED",s[s.REMOVED=1]="REMOVED"}(Yn||(Yn={}));let zn=class extends Re{constructor(e){super(e),this._allAnalysisViews=new wo,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=Wy(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(_r("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(_r()),this._attachedToViewResolver=Wy()}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(t==null||t.state.list===Yn.REMOVED)throw new Ri("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),jy)}_disconnectOwners(){this.removeHandles(jy),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const r of e)this._addAnalysis(r);const t=e.on("after-add",r=>this._addAnalysis(r.item)),i=e.on("after-remove",r=>this._removeAnalysis(r.item));return po(()=>{t.remove(),i.remove();for(const r of e)this._removeAnalysis(r)})}_addAnalysis(e){const t=this._items.get(e);if(t==null){const i={state:{view:hl.PENDING,list:Yn.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,i),i.createAnalysisViewTask=Oc(r=>this._createAnalysisViewPromise(i,r))}else t.state.list=Yn.ADDED}_removeAnalysis(e){const t=this._items.get(e);t!=null?(t.state.list=Yn.REMOVED,this._scheduleUpdate()):pe.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){this._scheduledUpdateHandle==null&&(this._scheduledUpdateHandle=GC(()=>this._update()))}_update(){this._scheduledUpdateHandle=ea(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list===Yn.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case hl.PENDING:e.createAnalysisViewTask=xn(e.createAnalysisViewTask);break;case hl.CREATED:e.view!=null&&(this._allAnalysisViews.remove(e.view),e.view=se(e.view),e.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(e,t){const i=e.analysis,r=i.type,a=this._analysisModules[r];if(this._creatingViewCount+=1,a.module==null)try{a.module=await this._loadAnalysisModule(r)}catch(l){throw this._creatingViewCount-=1,l}if(Hh(t))throw this._creatingViewCount-=1,_r("AnalysisView creation aborted");const n=new a.module.default({analysis:i,view:this.view});let o=!0;pp(t,()=>{o&&(this._creatingViewCount-=1,n.destroy())});try{await n.when()}catch(l){throw o=!1,n.destroyed||(this._creatingViewCount-=1,n.destroy()),l}if(Hh(t))throw _r();return o=!1,e.view=n,e.state.view=hl.CREATED,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_loadAnalysisModule(e){switch(e){case"area-measurement":return X(()=>import("./AreaMeasurementAnalysisView3D-VwD1qnp3.js"),__vite__mapDeps([503,1,504,505,7,8,3,4,9,10,38,29,11,506,507,17,18,5,13,241,80,43,41,42,6,49,2,12,14,15,123,59,60,68,63,51,45,64,46,44,47,48,50,82,65,508,509,510,511,512,513,460,514,55,54,515,211,516,517,518,519,520,90,77,61,56,62,66,67,69,70,71,72,73,74,75,76,78,79,81,83,84,40,28,85,86,91,92,93,94,36,95,96,521,39,97,454,455,166,271,23,24,522,163,239,240,523,461,247,57,165,167,524,99,288,289,525,132]),import.meta.url);case"dimension":return X(()=>import("./DimensionAnalysisView3D-B7hpYuW0.js"),__vite__mapDeps([526,1,17,18,5,506,29,8,3,4,9,527,27,163,13,7,10,505,38,11,241,51,6,43,47,42,12,44,45,46,48,41,49,50,59,14,15,60,2,58,26,28,30,23,24,31,32,33,34,35,36,37,39,523,80,461,247,57,40,520,165,166,167,524,123,528,516,517,510,511,512,513,460,514,271,529,64,52,65,63,55,54,237,218,94,78,79,81,66,90,77,61,56,62,67,69,70,71,72,73,74,75,76,68,82,83,84,85,86,91,92,93,95,96,197,87,88,89,530,99,289,128,113,129,531,118,119,120,121,122,97,532,454,455,115,116,287,127,288,533,148,534,535,536,537,217,216,126,219,220,133,112,221,199,222,223,224,100,225,137,135,136,538,274,233,134,132,539,519,53,243,138,130,540,459,160,192,104,105,193,159,174,169,456,397,256,541,542,518,521,543,525,544,545,413,457,458,546,547,548,549,198,522,239,240,267,268,259,550,551]),import.meta.url);case"direct-line-measurement":return X(()=>import("./DirectLineMeasurementAnalysisView3D-Bhergdke.js"),__vite__mapDeps([552,1,504,505,7,8,3,4,9,10,38,29,11,506,507,241,17,18,5,518,2,6,12,13,14,15,55,54,51,43,47,42,49,519,520,90,63,45,64,46,44,48,41,50,77,61,56,62,65,66,67,69,70,71,72,73,74,75,76,68,78,79,80,81,82,83,84,40,28,85,86,91,92,93,94,36,95,96,521,39,97,516,59,60,123,517,510,511,512,513,460,514,166,271,23,24,522,163,239,240,553,461,247,57,523,165,167,524,228,162,27,172,118,119,120,121,122,52,229,230,115,116,540,537,32,217,216,126,218,219,220,30,133,112,221,199,222,223,224,100,225,137,135,136,530,99,289,128,113,129,525]),import.meta.url);case"line-of-sight":return X(()=>import("./LineOfSightAnalysisView3D-C7kKJrl8.js"),__vite__mapDeps([554,1,17,18,5,6,506,29,8,3,4,9,555,42,43,63,13,51,45,49,12,10,11,7,64,46,44,47,48,41,50,119,62,65,250,39,124,148,2,14,15,101,247,57,40,36,102,100,103,34,104,30,105,237,80,118,66,120,121,122,123,52,97,518,55,54,519,520,90,77,61,56,67,69,70,71,72,73,74,75,76,68,78,79,81,82,83,84,28,85,86,91,92,93,94,95,96,521,135,136,23,24,556,27,380,347,381,167,382,298,271,529,58,26,31,32,33,35,37,38,59,60,218,197,87,88,89,530,99,289,128,113,129,557,115,116,538,133,274,233,222,134,132,223,224,195,174,169,196,547,548,532,454,455,198,539,53,243,138,130,137,127,112,551]),import.meta.url);case"slice":return X(()=>import("./SliceAnalysisView3D-Dcgc8-5Z.js"),__vite__mapDeps([558,1,506,29,8,3,4,9,559,27,163,13,380,347,381,167,382,7,10,17,18,5,62,63,51,6,43,42,45,49,12,11,64,46,44,47,48,41,50,65,189,32,38,159,160,292,26,28,30,23,24,31,33,34,35,36,37,39,293,294,146,295,296,104,105,20,297,298,57,40,299,190,300,301,192,193,140,302,303,304,305,25,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,168,169,166,321,322,2,14,15,323,324,325,326,327,186,187,328,329,151,330,331,332,333,334,335,336,337,245,338,339,340,341,253,256,342,343,344,264,345,346,348,349,350,351,177,352,145,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,59,60,369,56,52,110,93,111,84,71,70,96,112,113,121,122,123,66,97,143,161,560,561,529,80,58,247,55,54,237,218,94,78,79,81,90,77,61,67,69,72,73,74,75,76,68,82,83,85,86,91,92,95,197,271,87,88,89,530,99,289,128,129,115,116,287,127,288,518,519,520,521,273,225,171,172,534,531,118,119,120,532,454,455,547,548,549,198,525,551]),import.meta.url);case"viewshed":return X(()=>import("./ViewshedAnalysisView3D-VpQ4ZOc9.js"),__vite__mapDeps([562,1,555,42,6,43,63,13,51,45,49,12,10,11,7,8,3,4,9,64,46,44,47,48,41,50,119,62,65,250,39,124,17,18,5,2,14,15,506,29,518,55,54,519,520,90,77,61,56,66,67,69,70,71,72,73,74,75,76,68,78,79,80,81,82,83,84,40,28,85,86,91,92,93,94,36,95,96,521,97,23,24,563,27,163,529,52,58,26,30,31,32,33,34,35,37,38,59,60,247,57,237,218,197,271,87,88,89,530,99,289,128,113,129,531,118,120,121,122,123,532,454,455,228,162,172,229,230,564,115,116,565,536,537,217,216,126,219,220,133,112,221,199,222,223,224,100,225,137,135,136,538,274,233,134,132,525,561,547,548,456,174,169,549,198,539,53,243,138,130,127,238,551,131]),import.meta.url)}}};function Wy(){const s=ug();return s.promise.catch(()=>{}),s}c([m()],zn.prototype,"updating",null),c([m({constructOnly:!0})],zn.prototype,"view",void 0),c([m()],zn.prototype,"_allAnalysisViews",void 0),c([m()],zn.prototype,"_creatingViewCount",void 0),zn=c([F("esri.views.3d.analysis.AnalysisViewManager3D")],zn);const J2=zn;let ga=class extends Re{constructor(e){super(e),this.collision=new Sh,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===Ne.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Ne.Local?this._set("altitude",e):pe.getLogger(this).warn("Altitude constraint is ignored in local scenes")}get mode(){return this.state.viewingMode}clampAltitude(e){return this.altitude?Q(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return Q(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Ne.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=Yp)=>(i.min=Ei.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?Wu([[4e3,Ei.max],[1e4,Rt(88)],[6e6,Rt(88)]]):()=>Ei.max;return(t,i=Yp)=>(i.min=Ei.min,i.max=e(t),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?Wu([[4e3,Ei.max],[5e4,Rt(88)],[6e6,Rt(88)],[2e7,Ei.min]]):Wu([[3e5,Ei.max],[3e6,Rt(88)],[6e6,Rt(88)],[2e7,Ei.min]]);return(t,i=Yp)=>(i.min=Ei.min,i.max=e(t),i)}};function eM(s){return{min:-2e5,max:4*s.radius}}c([m()],ga.prototype,"altitude",null),c([m({readOnly:!0})],ga.prototype,"collision",void 0),c([m()],ga.prototype,"distance",void 0),c([m({readOnly:!0})],ga.prototype,"minimumPoiDistance",void 0),c([m()],ga.prototype,"tilt",void 0),c([m({constructOnly:!0})],ga.prototype,"state",void 0),ga=c([F("esri.views.3d.state.Constraints")],ga);const Qy=eM(os),Ei={min:Rt(.5),max:Rt(179.5)},Yp={min:0,max:0};let Sh=class extends Re{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};c([m({type:Boolean})],Sh.prototype,"enabled",void 0),c([m({type:Number})],Sh.prototype,"elevationMargin",void 0),Sh=c([F("esri.views.3d.state.Constraints.CollisionConstraint")],Sh);let cl=class extends yp{constructor(){super(...arguments),this.min=Qy.min,this.max=Qy.max}};c([m({type:Number})],cl.prototype,"min",void 0),c([m({type:Number})],cl.prototype,"max",void 0),cl=c([F("esri.views.3d.constraints.AltitudeConstraint")],cl);let Ca=class extends yp{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};c([m({type:Number,value:1e-8})],Ca.prototype,"near",null),c([El("near")],Ca.prototype,"castNear",null),c([m({type:Number,value:1e-8})],Ca.prototype,"far",null),c([El("far")],Ca.prototype,"castFar",null),c([m({type:["auto","manual"]})],Ca.prototype,"mode",void 0),Ca=c([F("esri.views.3d.constraints.ClipDistanceConstraint")],Ca);const P_={min:sc(Ei.min),max:sc(Ei.max)};let Zn=class extends yp{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return Q(e,P_.min,P_.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};c([m({type:["auto","manual"]})],Zn.prototype,"mode",void 0),c([m({type:Number,value:P_.max})],Zn.prototype,"max",null),c([El("max")],Zn.prototype,"castMax",null),Zn=c([F("esri.views.3d.constraints.TiltConstraint")],Zn);let Xn=class extends yp{constructor(e){super(e),this.tilt=new Zn,this.altitude=new cl,this.clipDistance=new Ca}};c([m({type:Zn})],Xn.prototype,"tilt",void 0),c([m({type:cl})],Xn.prototype,"altitude",void 0),c([m({type:Ca})],Xn.prototype,"clipDistance",void 0),Xn=c([F("esri.views.3d.constraints.Constraints")],Xn);function Yy(s){return $d(s,sP)||_g(s)?{wkid:Jf.GCSMARS2000}:$d(s,rP)||gg(s)?{wkid:Jf.GCSMOON2000}:si.WGS84}var ls;(function(s){s[s.SIXTEEN=0]="SIXTEEN",s[s.HUNDRED=1]="HUNDRED",s[s.TWOHUNDRED=2]="TWOHUNDRED",s[s.COUNT=3]="COUNT"})(ls||(ls={}));let E_=class extends Ua{constructor(){super(...arguments),this.steps=ls.SIXTEEN,this.writeTextureChannels=oc.RG}};c([ne({count:ls.COUNT})],E_.prototype,"steps",void 0),c([ne({count:oc.COUNT})],E_.prototype,"writeTextureChannels",void 0);let sh=class{constructor(e,t,i,r,a,n,o,l,h=.5){this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=r,this.detailSize=a,this.smoothness=n,this.cloudHeight=o,this.raymarchingSteps=l,this.median=h}};const Si={sunny:new sh([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],ls.SIXTEEN),cloudy:new sh([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],ls.TWOHUNDRED,.6),rainy:new sh([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],ls.TWOHUNDRED,.4),snowy:new sh([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],ls.HUNDRED,.65),foggy:new sh([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],ls.SIXTEEN)};Si.default=Si.sunny;const qs=Gi("esri-mobile")?64:128,tM=qs/128,cr=Math.ceil(Math.sqrt(qs)),$a=(qs+2)*cr,iM=1e5,Qc=128,sM=$a/1560;function Ep(s){s.code.add(w`vec2 sphereIntersect(vec3 start, vec3 dir, float distance) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * distance;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`)}let Xg=class extends Ii{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.viewMatrix=ia()}};const xl=Gi("esri-mobile")?1024:2048;function Tw(s){const e=new kt;e.include(sr,!1);const t=e.fragment;return t.include(Ep),t.uniforms.add(new Ze("cloudRadius",i=>i.cloudRadius),new Ze("power",i=>ze(35,120,i.absorption)),new Ze("sigmaE",i=>1+i.absorption),new Ze("density",i=>ze(0,.3,i.density)),new Ze("cloudSize",i=>ze(0,.02,Math.max(.01,1-i.cloudSize))),new Ze("detailSize",i=>ze(0,.2,Math.max(.01,1-i.detailSize))),new Ze("smoothness",i=>ze(0,.5,1-i.smoothness)),new Ze("cloudHeight",i=>ze(0,1500,i.cloudHeight)),new Ze("coverage",i=>i.coverage),new QO("view",i=>i.viewMatrix),new ft("cloudShapeTexture",i=>i.noiseTexture!=null?i.noiseTexture.textureAtlas:null),new ra("cloudVariables",i=>xo(rM,i.coverage,i.absorption))),t.constants.add("halfCubeMapSize","float",.5*xl),t.code.add(w`
    const int STEPS = ${s.steps===ls.SIXTEEN?w`16`:s.steps===ls.HUNDRED?w`100`:w`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),t.code.add(w`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${w.float($a)};
      const float dataWidth = ${w.float($a)};
      const float tileRows = ${w.float(cr)};
      const vec3 atlasDimensions = vec3(${w.float(qs)}, ${w.float(qs)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${w.float(tM)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${w.float(sM)} * p) / ${w.float($a)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),t.code.add(w`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),t.code.add(w`float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}
float multipleOctaves(float extinction, float mu, float stepL) {
float attenuation = 1.0;
float contribution = 1.0;
float phaseAttenuation = 1.0;
float luminance = 0.0;
for (int i = 0; i < 4; i++) {
float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
attenuation *= 0.2;
contribution *= 0.6;
phaseAttenuation *= 0.5;
}
return luminance;
}`),t.code.add(w`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),t.code.add(w`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),t.main.add(w`if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
if (hitsPlanet) {
shading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);
totalTransmittance = hazeFactor;
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
return;
}
float cloudDistance = cloudRadius + cloudStart;
float rayStartDistance = dot(viewPos, viewPos) - (cloudDistance * cloudDistance);
vec2 rayStartIntersect = sphereIntersect(viewPos, rayDir, rayStartDistance);
float rayEndDistance = dot(viewPos, viewPos) - ((cloudDistance + cloudHeight) * (cloudDistance + cloudHeight));
vec2 rayEndIntersect = sphereIntersect(viewPos, rayDir, rayEndDistance);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);`),e}const rM=Ts(),aM=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:Xg,build:Tw,cubeMapSize:xl},Symbol.toStringTag,{value:"Module"}));let Zp=class extends Bt{constructor(e,t){super(e,t,new qt(aM,()=>X(()=>Promise.resolve().then(()=>U4),void 0,import.meta.url)))}initializePipeline(e){return Qt({blending:Rg($t.CONSTANT_COLOR,$t.ONE_MINUS_CONSTANT_COLOR,YP.ADD,e.writeTextureChannels===oc.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:Zi.LEQUAL},colorWrite:ti})}};var Kr;(function(s){s[s.Full=0]="Full",s[s.WeatherMap=1]="WeatherMap",s[s.COUNT=2]="COUNT"})(Kr||(Kr={}));let Yu=class extends Ua{constructor(){super(...arguments),this.mode=Kr.Full}};c([ne({count:Kr.COUNT})],Yu.prototype,"mode",void 0);let Kg=class extends Ii{constructor(){super(...arguments),this.weatherTile=E1(0,0)}};function Sw(s){const e=new kt;return e.include(sr,!1),e.fragment.code.add(w`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),s.mode===Kr.Full&&(e.fragment.code.add(w`float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),e.fragment.code.add(w`vec3 modulo(vec3 m, float n) {
return mod(mod(m, n) + n, n);
}
vec3 hash(vec3 p3, float frequency) {
p3 = modulo(p3, frequency);
p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yxz + 33.33);
return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
}`),e.fragment.code.add(w`vec3 fade(vec3 t) {
return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
}`),e.fragment.code.add(w`
    float gradientNoise(vec3 p, float frequency) {
      vec3 i = floor(p);
      vec3 f = fract(p);
      vec3 u = fade(f);
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequency = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequency;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${w.float(cr)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${w.float(8)});

      float worley0 = worley(p, ${w.float(2)} * 2.0);
      float worley1 = worley(p, ${w.float(2)} * 8.0);
      float worley2 = worley(p, ${w.float(2)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${w.float(2)});
      float worley1 = worley(p, ${w.float(2)} * 2.0);
      float worley2 = worley(p, ${w.float(2)} * 4.0);
      float worley3 = worley(p, ${w.float(2)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)),e.fragment.uniforms.add(new ra("weatherTile",t=>t.weatherTile)).code.add(w`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${w.float(Qc)});

      // Get global coordinates of p
      p += weatherTile * ${w.float(Qc)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${w.float(iM)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),s.mode===Kr.Full?e.fragment.main.add(w`
      float padWidth = 1.0;
      float paddedSize = ${w.float(qs)} + 2.0 * padWidth;
      float tileCount = ${w.float(cr)} * ${w.float(cr)};
      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

      bool padCell = false;
      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      bool startPadX = false;
      bool startPadY = false;
      bool endPadX = false;
      bool endPadY = false;

      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
        startPadX = true;
      }

      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
        startPadY = true;
      }

      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
        endPadX = true;
      }

      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
        endPadY = true;
      }

      vec2 padding = vec2(2.0 * padWidth) * tile;
      vec2 uv;

      if (padCell) {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;

        if (startPadX) {
          pixel.x += ${w.float(qs)};
        }

        if (startPadY) {
          pixel.y += ${w.float(qs)};
        }

        if (endPadX) {
          pixel.x -= ${w.float(qs)};
        }

        if (endPadY) {
          pixel.y -= ${w.float(qs)};
        }

        uv = vec2(pixel.xy / ${w.float(qs)});
      } else {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;
        uv = vec2(pixel.xy / ${w.float(qs)});
      }

      vec3 p_ = get3Dfrom2D(uv);
      vec3 p = p_;
      p.z /= (${w.float(cr)} * ${w.float(cr)});

      float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      float worleyNoise = getTextureForPointWorley(p);

      fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      p_ = mod(p_ + 1.0, ${w.float(cr)} * ${w.float(cr)});
      p = p_;
      p.z /= (${w.float(cr)} * ${w.float(cr)});

      worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      worleyNoise = getTextureForPointWorley(p);

      fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      vec2 mapUV = ${w.float(Qc)} * (gl_FragCoord.xy / ${w.float($a)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor.ba = vec2(0.0, map);
      `):e.fragment.main.add(w`
      vec2 mapUV = ${w.float(Qc)} * (gl_FragCoord.xy / ${w.float($a)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor = vec4(map);
    `),e}const nM=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:Kg,build:Sw},Symbol.toStringTag,{value:"Module"}));let Xp=class extends Bt{constructor(e,t){super(e,t,new qt(nM,()=>X(()=>Promise.resolve().then(()=>H4),void 0,import.meta.url)))}initializePipeline(e){return Qt({blending:e.mode===Kr.Full?Ag:Ac($t.ZERO,$t.ONE,$t.ONE,$t.ZERO),depthTest:{func:Zi.ALWAYS},colorWrite:ti})}},Zu=class extends Re{constructor(e){super(e),this._needsRender=!0,this._passParameters=new Kg,this._configuration=new Yu,this._fbo=new $c(e.context.renderContext.rctx,new mi($a)),e.context.techniques.precompile(Xp,new Yu);const t=new Yu;t.mode=Kr.WeatherMap,e.context.techniques.precompile(Xp,t)}get textureAtlas(){if(this._texture&&!this._needsRender)return this._texture;this._configuration.mode=this._texture?Kr.WeatherMap:Kr.Full;const e=this.context.techniques.get(Xp,this._configuration);return e.compiled&&(this._texture=this._render(e)),this._texture}updateWeatherMap(e){P1(this._passParameters.weatherTile,e)||(_n(this._passParameters.weatherTile,e),this._needsRender=!0)}destroy(){this._fbo=We(this._fbo)}_render(e){if(!this._fbo)return null;const t=this.context.renderContext.rctx,i=t.getViewport();return t.setViewport(0,0,$a,$a),t.bindFramebuffer(this._fbo),t.bindTechnique(e,this.context.renderContext.bind,this._passParameters),t.screen.draw(),t.setViewport(i.x,i.y,i.width,i.height),this._needsRender=!1,this._fbo.colorTexture}};c([m({constructOnly:!0})],Zu.prototype,"context",void 0),Zu=c([F("esri.views.3d.environment.NoiseTextureAtlas")],Zu);let es=class extends Re{constructor(e){super(e),this._state=Da(xh.Idle),this._passParameters=new Xg,this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this._tilesPerFace=1,this.coverage=ze(Si.default.coverage[0],Si.default.coverage[1],.5),this.density=ze(Si.default.density[0],Si.default.density[1],.5),this.absorption=ze(Si.default.absorption[0],Si.default.absorption[1],.5),this.cloudSize=ze(Si.default.cloudSize[0],Si.default.cloudSize[1],.5),this.detailSize=ze(Si.default.detailSize[0],Si.default.detailSize[1],.5),this.smoothness=ze(Si.default.smoothness[0],Si.default.smoothness[1],.5),this.cloudHeight=ze(Si.default.cloudHeight[0],Si.default.cloudHeight[1],.5),this.raymarchingSteps=Si.default.raymarchingSteps,this._viewMatrix=It(),this._dirty=!0,this.running=!0,this._configuration=new E_}initialize(){const e=Dt(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius;const t=()=>this.setDirty();this.addHandles([this.view.resourceController.scheduler.registerTask(ai.CLOUDS_GENERATOR,this),O(()=>this.coverage,t,at),O(()=>this.density,t,at),O(()=>this.absorption,t,at),O(()=>this.cloudSize,t,at),O(()=>this.detailSize,t,at),O(()=>this.smoothness,t,at),O(()=>this.cloudHeight,t,at),O(()=>this.raymarchingSteps,t,at)]);const i=PP(this._computeWeatherTile());let r=0;this.addHandles(O(()=>{const a=this._computeWeatherTile();return P1(i,a)||(++r,_n(i,a)),r},t))}destroy(){this.destroyCubeMap(),this._passParameters.noiseTexture=se(this._passParameters.noiseTexture)}_precompileTechniques(){this._configuration.steps=this.raymarchingSteps,this._configuration.writeTextureChannels=oc.RG,this.context.techniques.precompile(Zp,this._configuration),this._configuration.writeTextureChannels=oc.BA,this.context.techniques.precompile(Zp,this._configuration)}_acquireTechnique(){switch(this.raymarchingSteps){case ls.SIXTEEN:this._tilesPerFace=1;break;case ls.HUNDRED:this._tilesPerFace=4;break;case ls.COUNT:case ls.TWOHUNDRED:this._tilesPerFace=8;break;default:Ec(this.raymarchingSteps)}return this._configuration.writeTextureChannels=1-this.parameters.readChannels,this._configuration.steps=this.raymarchingSteps,this.context.techniques.get(Zp,this._configuration)}_computeWeatherTile(){var l,h;const{camera:e,environment:t}=this.view,{latitude:i,longitude:r}=e.position;if(i==null||r==null)return uc;xo(rr,(i+90)/180,(r+180)/360);const a=Math.floor(this._weatherTileCount*Math.abs(2*rr[0]-1));rr[0]=Math.floor(2*this._weatherTileCount*rr[0]),rr[1]=Math.floor(4*(this._weatherTileCount-a)*rr[1]);let n=0,o=0;if(((l=t==null?void 0:t.lighting)==null?void 0:l.type)!=="virtual"&&((h=t==null?void 0:t.lighting)==null?void 0:h.date)!=null){const u=new Date(t.lighting.date);u.setUTCHours(t.lighting.date.getUTCHours()+(t.lighting.displayUTCOffset??0)),n=31*u.getUTCMonth()+u.getUTCDate(),o=u.getUTCFullYear()}return rr[0]=(rr[0]+n)%(2*this._weatherTileCount),rr[1]=(rr[1]+o%100)%(4*this._weatherTileCount),rr}get state(){return this._state.value}set state(e){this._state.value=e}get usedMemory(){var e,t,i;return(((e=this._fbo)==null?void 0:e.usedMemory)??0)+(((i=(t=this._passParameters.noiseTexture)==null?void 0:t.textureAtlas)==null?void 0:i.usedMemory)??0)}_ensureNoiseTexture(){var e;return(e=this._passParameters).noiseTexture??(e.noiseTexture=new Zu({context:this.context})),this._passParameters.noiseTexture}_ensureFrameBufferCube(e){const t=this.context.renderContext.rctx;if(this._fbo==null){const i=new mi(e);i.target=v_.TEXTURE_CUBE_MAP,i.wrapMode=Ki.CLAMP_TO_EDGE,this._fbo=new $c(t,i),this.parameters.data=this}return t.unbindTexture(this._fbo.colorTexture),this._fbo}get cubeMap(){return this._fbo}get parameters(){return this.context.renderContext.bind.clouds}destroyCubeMap(){this._fbo=We(this._fbo),this.parameters.data=null}applyPreset(e,t){const i=e.median,r=a=>{const n=ze(a[0],a[1],i);return t<.5?ze(a[0],n,2*t):ze(n,a[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps,this._precompileTechniques()}setDirty(){this._dirty=this.running=!0}runTask(e){if(this.state===xh.Fading)return Xi;this._dirty&&(this._faceIndex=this._tileIndex=0,this.state=xh.Rendering,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._ensureNoiseTexture().updateWeatherMap(this._computeWeatherTile()),this._dirty=!1);const t=this._acquireTechnique();if(!this._ensureNoiseTexture().textureAtlas||!t.compiled)return Xi;const i=oM[this._faceIndex],r=lM[this._faceIndex];bP(this._viewMatrix,hM,i,r),Og(this._passParameters.viewMatrix,this._viewMatrix);const a=this.context.renderContext.rctx,n=a.getViewport(),o=xl/this._tilesPerFace,l=this._tileIndex*o;a.setViewport(0,l,xl,o);const h=this._ensureFrameBufferCube(xl);a.bindFramebuffer(h),a.bindTechnique(t,this.context.renderContext.bind,this._passParameters);const u=v_.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return h.setColorTextureTarget(u),a.screen.draw(),a.gl.flush(),a.setViewport(n.x,n.y,n.width,n.height),this.requestRender(),++this._tileIndex,this._faceIndex===4&&this._tileIndex===this._tilesPerFace?(this._faceIndex=this._tileIndex=0,this.state=xh.Ready,this.running=!1):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),Xi}};c([m({constructOnly:!0})],es.prototype,"context",void 0),c([m({constructOnly:!0})],es.prototype,"view",void 0),c([m({constructOnly:!0})],es.prototype,"requestRender",void 0),c([m()],es.prototype,"coverage",void 0),c([m()],es.prototype,"density",void 0),c([m()],es.prototype,"absorption",void 0),c([m()],es.prototype,"cloudSize",void 0),c([m()],es.prototype,"detailSize",void 0),c([m()],es.prototype,"smoothness",void 0),c([m()],es.prototype,"cloudHeight",void 0),c([m()],es.prototype,"raymarchingSteps",void 0),c([m()],es.prototype,"running",void 0),es=c([F("esri.views.3d.environment.CloudsRenderer")],es);const oM=[Br(1,0,0),Br(-1,0,0),Br(0,1,0),Br(0,-1,0),Br(0,0,1)],lM=[Br(0,1,0),Br(0,1,0),Br(0,0,-1),Br(0,0,1),Br(0,1,0)],hM=vT(),rr=EP();var La;(function(s){s[s.Rain=0]="Rain",s[s.Snow=1]="Snow",s[s.COUNT=2]="COUNT"})(La||(La={}));let Pw=class extends Ua{constructor(){super(...arguments),this.type=La.Rain}};c([ne({count:La.COUNT})],Pw.prototype,"type",void 0);function Ew(s){const e=new kt;return e.attributes.add(De.POSITION,"vec3"),e.attributes.add(De.INSTANCEFEATUREATTRIBUTE,"float"),e.vertex.uniforms.add(new gn("cameraPosition",t=>t.camera.eye),new on("offset",(t,i)=>cM(t,i)),new Ze("width",t=>t.width),new Ze("time",t=>t.time),new bn("proj",t=>t.camera.projectionMatrix),new bn("view",t=>t.camera.viewMatrix)),e.varyings.add("vUv","vec2"),e.vertex.code.add(w`vec3 hash31(float p){
vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yzx + 33.33);
return fract((p3.xxy + p3.yzz) * p3.zyx);
}
float hash11(float p){
p = fract(p * 0.1031);
p *= p + 33.33;
p *= p + p;
return fract(p);
}
vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
}`),e.vertex.main.add(w`
      vUv = position.xz;
      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundredths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${s.type===La.Rain?w`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:w`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
  `),e.fragment.uniforms.add(new Ze("opacity",t=>t.opacity),new gn("particleColor",t=>uM(t,s))),e.fragment.main.add(w`
    float d = length(vUv - vec2(0.5));

    ${s.type===La.Rain?w`d = 0.35 * smoothstep(0.5, 0.0, d);`:w`d = smoothstep(0.5, 0.1, d);`}
    fragColor = opacity * vec4(particleColor * d, d);
  `),e}function cM(s,e){const t=e.camera.eye,i=.5*s.width,r=1/s.width,a=tP(O_,ce(O_,(t[0]+i)*r,(t[1]+i)*r,(t[2]+i)*r));return Mt(a,t,ee(a,a,s.width))}function uM(s,e){const t=e.type===La.Rain?pM:dM,i=ee(O_,t,mM),r=s.camera.eye;ie(Zy,r);const a=Math.max(0,oe(Zy,s.lighting.mainLight.direction));return Tr(i,i,t,a)}const O_=v(),Zy=v(),dM=Vt(1,1,1),pM=Vt(.85,.85,.85),mM=.7,_M=Object.freeze(Object.defineProperty({__proto__:null,build:Ew},Symbol.toStringTag,{value:"Module"}));let gM=class extends Ii{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=0}},Xy=class extends Bt{constructor(e,t){super(e,t,new qt(_M,()=>X(()=>Promise.resolve().then(()=>z4),void 0,import.meta.url)),new Map([[De.POSITION,0],[De.INSTANCEFEATUREATTRIBUTE,1]]))}initializePipeline(){return Qt({blending:Dg,depthTest:{func:Zi.LEQUAL},colorWrite:ti})}},tl=class extends Co{constructor(e){super(e),this.consumes={required:[ge.TRANSPARENT_ENVIRONMENT]},this.produces=ge.TRANSPARENT_ENVIRONMENT,this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new gM,this._configuration=new Pw;const{view:t,type:i}=e;this._configuration.type=i==="rainy"?La.Rain:La.Snow,t._stage.renderView.techniques.precompile(Xy,this._configuration),this._passParameters.time=0,this._passParameters.radius=Dt(t.spatialReference).radius,this.addHandles(O(()=>t.environment.weather,r=>{r.type===i&&this.addHandles(O(()=>r.precipitation,a=>this._adjustParticles(a),Be))},Be)),this.addHandles(O(()=>{var r;return((r=t._stage)==null?void 0:r.renderer.renderContext.bind.clouds.fadeFactor)??1},r=>{this._passParameters.opacity=r,r===1&&(this.removeHandles("opacity"),this.addHandles(O(()=>{var a;return((a=t._stage)==null?void 0:a.renderer.renderContext.bind.clouds.opacity)??1},a=>this._passParameters.opacity=a,Be),"opacity"))},Ge),"opacity")}_adjustParticles(e){const i=e<.5?ze(0,.35,2*e):ze(.35,1,2*(e-.5));this._numParticles=Ky*i}destroy(){this._numParticles=0,this._vao=We(this._vao),this._instanceIdBuffer=We(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles(O(()=>{var t;return((t=this.renderContext)==null?void 0:t.bind.clouds.fadeFactor)??1},t=>{this._passParameters.opacity=1-t,t===1&&(this.removeAllHandles(),e())}),"opacity")}updateAnimation(e){const t=(this.type==="rainy"?this._rainSpeed:this._snowSpeed)*kb(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){const t=this.renderingContext;this._instanceIdBuffer??(this._instanceIdBuffer=this._createInstanceIndices(t));const i=Math.round(this._numParticles*this._passParameters.opacity),r=e.find(({name:o})=>o===ge.TRANSPARENT_ENVIRONMENT);if(i<1)return r;const a=this.techniques.get(Xy,this._configuration);if(!a.compiled)return this.requestRender(Ce.UPDATE),r;const n=t.bindTechnique(a,this.bindParameters,this._passParameters);return this._vao??(this._vao=fM(t,a.locations)),t.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),JP(t,a.locations,this._instanceIdBuffer,Jy,0),t.drawArraysInstanced(bi.TRIANGLES,0,3,i),eE(t,a.locations,this._instanceIdBuffer,Jy),r}_createInstanceIndices(e){const t=[];for(let i=0;i<Ky;i++)t.push(i);return $s.createVertex(e,wr.STATIC_DRAW,new Float32Array(t))}};function fM(s,e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new Tn(s,e,new Map([["geometry",Fa(yM)]]),new Map([["geometry",$s.createVertex(s,wr.STATIC_DRAW,t)]]))}c([m()],tl.prototype,"consumes",void 0),c([m()],tl.prototype,"produces",void 0),c([m({constructOnly:!0})],tl.prototype,"type",void 0),tl=c([F("esri.views.3d.environment.Precipitation")],tl);const Ky=25e4,yM=Cn().vec3f(De.POSITION),Jy=Fa(Cn().f32(De.INSTANCEFEATUREATTRIBUTE),1);let Gn=class extends Cp{constructor(e){super(e),this.produces=new Map([]),this._clouds=Da(null),this._incarnation=0,this._precipitation=null}initialize(){this.view._stage.addRenderPlugin(this)}destroy(){var e,t;this.removeHandles(),this.uninitializeRenderContext(),(t=(e=this.view)==null?void 0:e._stage)==null||t.removeRenderPlugin(this),this._set("view",null)}get updating(){var e;return!!((e=this._clouds.value)!=null&&e.running)}get weatherAvailable(){return we(this.view.state.camera.eye)-Dt(this.view.spatialReference).radius<=b_}get usedMemory(){var e;return((e=this._clouds.value)==null?void 0:e.usedMemory)??0}_fadeOutPrecipitation(){var e;this._precipitation&&((e=this._precipitationOutgoing)==null||e.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut(()=>{this._precipitationOutgoing=se(this._precipitationOutgoing)}),this._precipitation=null,++this._incarnation)}get weather(){var e,t;return(t=(e=this.view)==null?void 0:e.environmentManager)!=null&&t.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(e){this._context=e;const t=this.view,i=()=>this._requestRender();this.addHandles([O(()=>this._precipitation,i,Ge),O(()=>{var r;return(r=this._clouds.value)==null?void 0:r.state},i,Ge),O(()=>t.state.mode,i,Ge),O(()=>this._updateClouds(),i,Ge),O(()=>this._updatePrecipitation(),i,Ge),O(()=>this.weather,r=>this._initWeather(r))])}uninitializeRenderContext(){this._context=null,this._clouds.value=se(this._clouds.value),this._precipitation=se(this._precipitation),this._precipitationOutgoing=se(this._precipitationOutgoing)}prepareRender(e){const{bind:t,time:i}=e;if(this.view.viewingMode!=="local"&&t.clouds.data){t.clouds.fade(t.camera,i,this.view.qualitySettings.fadeDuration);const r=this._clouds.value;r&&r.state===xh.Idle&&r.coverage===0&&!r.running&&r.destroyCubeMap()}}acquireTechniques(){return[]}render(){}_requestRender(){var e;(e=this._context)==null||e.requestRender()}_initWeather(e){const t=this._context;if(!e||!t)return void(this._clouds.value=se(this._clouds.value));if(this._clouds.value)return;const i=this.view;this._clouds.value=new es({context:t,view:i,requestRender:()=>this._requestRender()})}_updateClouds(){const e=this.view.environment.weather;return e==null||this._clouds.value==null||this._clouds.value.applyPreset(Si[e.type],vM(e)),++this._incarnation}_updatePrecipitation(){var r;const e=this.view.environment.weather;if(e.type===((r=this._precipitation)==null?void 0:r.type))return this._incarnation;this._fadeOutPrecipitation();const t=e.type==="rainy"||e.type==="snowy",i=this._context;return t&&i&&(this._precipitation=new tl({view:this.view,type:e.type}),++this._incarnation),this._incarnation}get test(){}hasHighlightOptions(e){return!1}};function vM(s){switch(s.type){case"rainy":case"snowy":case"cloudy":case"sunny":return s.cloudCover;case"foggy":return s.fogStrength}}c([m({constructOnly:!0})],Gn.prototype,"view",void 0),c([m({type:Boolean,readOnly:!0})],Gn.prototype,"updating",null),c([m()],Gn.prototype,"weatherAvailable",null),c([m()],Gn.prototype,"_context",void 0),Gn=c([F("esri.views.3d.environment.EnvironmentRenderer")],Gn);let Ns=class extends Va.EventedAccessor{constructor(){super(),this._tmpLightParameters=new Py,this._defaultLightParameters=new Py,this._tmpDate=new Date,this._tmpTz={hours:0,minutes:0,seconds:0},this._viewHandlesKey="viewHandles",this._trackingEnabled=!1,this._mainLight=new mE,this._ambientLight=new _E,this._moonLight=new gE,this._disableProjectionEngineAutoLoad=!1,this._disableWeather=!1,this._renderer=null,this._referencePositionGeographic=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){var e;return(e=this._renderer)==null?void 0:e.view}get updating(){var e;return!!((e=this._renderer)!=null&&e.updating)||!this._canProjectCameraPosition}get weatherEnabled(){var e,t,i;return((e=this._view)==null?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&((i=(t=this._view)==null?void 0:t.state)==null?void 0:i.viewingMode)===Ne.Global&&uT(this._view.spatialReference)}get _weatherAvailable(){var e;return this.weatherEnabled&&((e=this._renderer)==null?void 0:e.weatherAvailable)}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){var i,r,a,n;const e=((n=(a=(r=(i=this._view)==null?void 0:i.stateManager)==null?void 0:r.camera)==null?void 0:a.position)==null?void 0:n.spatialReference)??si.WGS84,t=Yy(e);return this._disableProjectionEngineAutoLoad||Jo(e,t)}connectView(e){if(this._renderer)return;this._renderer=new Gn({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this.addHandles([O(()=>e.environment.lighting,r=>this._updateLightingHandler(r),Ge),O(()=>e.environment.lighting.type!=="virtual"?e.environment.lighting.date:null,r=>this._lightingDateHandler(r),Ge),O(()=>e.environment.lighting.directShadowsEnabled,t,Ge),O(()=>e.qualitySettings.ambientOcclusion,t,Ge),O(()=>e.qualitySettings.reflections,t,Ge),O(()=>e.spatialReference,()=>this._resetReferencePosition(!0),Ge),O(()=>[e.environment.weather.type,this.weatherEnabled],()=>this._updateLighting(null,qp.FadeWithWeather),Ge),O(()=>e.environment,r=>r.setComputeWeatherAvailable(()=>this._weatherAvailable),Be),O(()=>e.viewingMode,()=>this._resetReferencePosition(!0),Be),O(()=>e.environment.lighting.type!=="virtual"&&e.environment.lighting.cameraTrackingEnabled,r=>this._updateCameraTracking(r),Be),O(()=>e.state.camera,i,Be),Pl(()=>this._canProjectCameraPosition,i,Ge)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=se(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type!=="virtual"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.type!=="virtual"?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const t=this._view.environment.lighting;(t==null?void 0:t.type)!=="virtual"&&(t.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if((t==null?void 0:t.type)!=="virtual"){if(e){if(!t.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(e),this._referencePositionGeographic!=null)){const i=Sy(this._referencePositionGeographic,this._tmpTz);i!=null&&(t.autoUpdate(null,i),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type!=="virtual"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;if(!i)return;const{position:r}=i,a=r.spatialReference??si.WGS84,n=Yy(a),o=this._referencePositionGeographic??v();if(!ec(r,o,n))return this._referencePositionGeographic=null,void this._updateLighting();this._referencePositionGeographic=o,this.notifyChange("referencePositionGeographic"),this._autoUpdateTimezone(o,e)||this._updateLighting(e)}_updateLighting(e,t=qp.Immediate){const i=this._view,{lighting:r}=i.environment,a=r.type==="virtual",n=this._referencePositionGeographic,o=n!=null?this._tmpLightParameters:this._defaultLightParameters;if(n){e??(e=a?null:r.date);const _=this._weatherAvailable?i.environment.weather.type:"disabled";cE(e,n,i.state.viewingMode,_,i.state.camera,o)}else a&&uE(i.state.camera,i.state.viewingMode,o.direct.directionToLightSource);const l=this._mainLight,h=o.direct;ee(l.intensity,h.color,h.intensity*Math.PI),le(l.direction,h.directionToLightSource),l.specularStrength=o.specularStrength,l.environmentStrength=o.environmentStrength;const u=this._ambientLight;ee(u.intensity,o.ambient.color,o.ambient.intensity);const d=this._moonLight;Tr(d.intensity,bM,wM,o.globalFactor);const p=(1-.5*o.globalFactor)*(1-.4*o.noonFactor*(1-o.globalFactor));ee(d.intensity,d.intensity,p),le(d.direction,h.directionToLightSource),this._view._stage.renderer.updateLighting([l,u,d],o.noonFactor,o.globalFactor,this._weatherAvailable?t:qp.Immediate),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||e==null)return!1;const i=this._tmpDate;i.setTime((t||this._view.environment.lighting.date).getTime());const r=Sy(e,this._tmpTz);if(r==null)return!1;let a=this._view.environment.lighting.positionTimezoneInfo;if(a.autoUpdated){if(a.hours===r.hours&&a.minutes===r.minutes&&a.seconds===r.seconds)return!1}else a=r;const n=i.getUTCHours()-(r.hours-a.hours),o=i.getUTCMinutes()-(r.minutes-a.minutes),l=i.getUTCSeconds()-(r.seconds-a.seconds);return i.setUTCHours(n),i.setUTCMinutes(o),i.setUTCSeconds(l),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=this._referencePositionGeographic==null||dE(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._weatherAvailable,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._referencePositionGeographic=null,e&&this._cameraHandler()}get test(){}};c([m({type:Boolean,readOnly:!0})],Ns.prototype,"updating",null),c([m()],Ns.prototype,"_disableProjectionEngineAutoLoad",void 0),c([m()],Ns.prototype,"_disableWeather",void 0),c([m()],Ns.prototype,"weatherEnabled",null),c([m()],Ns.prototype,"_weatherAvailable",null),c([m()],Ns.prototype,"referencePositionGeographic",null),c([m()],Ns.prototype,"_renderer",void 0),c([m()],Ns.prototype,"_referencePositionGeographic",void 0),c([m()],Ns.prototype,"_canProjectCameraPosition",null),Ns=c([F("esri.views.3d.environment.EnvironmentManager")],Ns);const bM=Vt(.22,.22,.33),wM=Vt(.22,.22,.22),xM={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Un,virtual:Ch}},CM={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:kd,virtual:Ng}};let Xu=class extends z1{constructor(e){super(e)}clone(){throw new Error("Subclasses of Background should implement their own clone method.")}};c([m({readOnly:!0,json:{read:!1}})],Xu.prototype,"type",void 0),Xu=c([F("esri.webscene.background.Background")],Xu);const Ow=Xu;var M_;let Ph=M_=class extends Ow{constructor(s){super(s),this.type="color",this.color=new Vg([0,0,0,1])}clone(){return new M_(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};c([vE({color:"color"},{readOnly:!0})],Ph.prototype,"type",void 0),c([m(bE({nonNullable:!0}))],Ph.prototype,"color",void 0),Ph=M_=c([F("esri.webscene.background.ColorBackground")],Ph);const Mw=Ph,ev={base:Ow,key:"type",typeMap:{color:Mw}};function TM(s){return(e,t,i)=>{if(!e)return e;for(const r in s.typeMap)if(e.type===r){const a=new s.typeMap[r];return a.read(e,i),a}}}const SM={types:ev,json:{read:TM(ev),write:{overridePolicy:(s,e,t)=>({enabled:!(t!=null&&t.isPresentation)})}}};var R_;const tv=(s,e,t)=>({enabled:!(t!=null&&t.isPresentation)});let Za=R_=class extends z1{constructor(s){super(s),this.lighting=new kd,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(s){aE(s==null?void 0:s.type,pe.getLogger(this))&&this._set("weather",s)}clone(){return new R_(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&this.lighting.type==="virtual"?Ng.prototype.clone.call(this.lighting):kd.prototype.clone.call(this.lighting),background:Ad(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};c([m({types:CM,nonNullable:!0,json:{write:!0}})],Za.prototype,"lighting",void 0),c([m(SM)],Za.prototype,"background",void 0),c([m({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:tv}}})],Za.prototype,"atmosphereEnabled",void 0),c([m({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:tv}}})],Za.prototype,"starsEnabled",void 0),c([m({types:oE,nonNullable:!0,json:{write:!0},value:new nE})],Za.prototype,"weather",null),Za=R_=c([F("esri.webscene.Environment")],Za);const Rw=Za;var Eh;let Bn=Eh=class extends Rw{constructor(s){super(s),this.lighting=this.castLighting(),this._computeWeatherAvailable=void 0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(s){const e=s.cloneConstructProperties();return new Eh({...e,lighting:e.lighting?e.lighting.type==="virtual"?Ch.fromWebsceneLighting(e.lighting):Un.fromWebsceneLighting(e.lighting):void 0})}get weatherAvailable(){var s;return((s=this._computeWeatherAvailable)==null?void 0:s.call(this))??!1}setComputeWeatherAvailable(s){this._computeWeatherAvailable=s}castLighting(s){return this._convertLightingWithDestroy(s)}applyLighting(s){this.lighting=this._convertLightingWithDestroy(s)}_convertLightingWithDestroy(s){const e=this._convertLighting(s);return e!==s&&this.addHandles(BC(e)),e}_convertLighting(s){var e,t;return s?s instanceof Un||s instanceof Ch?s:s instanceof kd?this.lighting&&this.lighting.type!=="virtual"?this.lighting.cloneWithWebsceneLighting(s):new Un({...s.cloneConstructProperties(),...(e=this.lighting)==null?void 0:e.cloneNonPersistentConstructProperties()}):s instanceof Ng?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(s):new Ch({...s.cloneConstructProperties(),...(t=this.lighting)==null?void 0:t.cloneNonPersistentConstructProperties()}):qC(xM,s):new Un}clone(){return new Eh({lighting:this.lighting.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:Ad(this.background)})}cloneWithWebsceneEnvironment(s){return new Eh({weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:Ad(this.background),...s.cloneConstructProperties(),lighting:this._getLighting(s)})}_getLighting(s){switch(s.lighting.type){case"sun":return this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(s.lighting):Un.fromWebsceneLighting(s.lighting);case"virtual":return this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(s.lighting):Ch.fromWebsceneLighting(s.lighting);default:return Ec(s.lighting),Un.fromWebsceneLighting(s.lighting)}}};c([m({nonNullable:!0})],Bn.prototype,"lighting",void 0),c([m()],Bn.prototype,"_computeWeatherAvailable",void 0),c([m({readOnly:!0})],Bn.prototype,"weatherAvailable",null),c([El("lighting")],Bn.prototype,"castLighting",null),Bn=Eh=c([F("esri.views.3d.environment.SceneViewEnvironment")],Bn);const il=Bn;var nt;(function(s){s[s.NONE=0]="NONE",s[s.TILT=1]="TILT",s[s.ALTITUDE=2]="ALTITUDE",s[s.DISTANCE=4]="DISTANCE",s[s.COLLISION=8]="COLLISION",s[s.ALL=15]="ALL",s[s.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"})(nt||(nt={}));var Oe;(function(s){s[s.NONE=0]="NONE",s[s.ZOOM=1]="ZOOM",s[s.TUMBLE=2]="TUMBLE",s[s.LOOK_AROUND=3]="LOOK_AROUND",s[s.PAN=4]="PAN",s[s.ASCEND=5]="ASCEND"})(Oe||(Oe={}));var aa;(function(s){s[s.TUMBLE=0]="TUMBLE",s[s.LOOK_AROUND=1]="LOOK_AROUND"})(aa||(aa={}));let Is=class{constructor(e=nt.ALL,t=Oe.NONE,i=0,r=null,a=null,n=aa.TUMBLE){this.selection=e,this.interactionType=t,this.interactionFactor=i,this.interactionStartCamera=r,this.interactionDirection=a,this.tiltMode=n}};function vc(s,e){return!!(s&e)}function Jd(s,e,t,i,r,a){s!==0&&(t?(a.min=Math.min(a.min,e),a.max=Math.max(a.max,e)):i!=null?(a.min-=Math.max(0,(e-a.min)*(1-i)),a.max+=Math.max(0,(e-a.max)*(1-i))):r&&(a.min-=Math.max(0,e-a.min-r),a.max+=Math.max(0,e-a.max-r)))}const So=new Is(nt.NONE);function Aw(s,e,t,i){return e=e||s.viewForward,le(i,e),ee(i,i,Math.sign(oe(e,t))),i}function PM(s,e,t=So){const i=Jg(s,e,t);if(i===0)return!1;const r=s.renderCoordsHelper,a=r.getAltitude(e.eye)+i,n=Aw(e,t.interactionDirection,MM(s,e,Math.sign(i),$M),DM),o=le(IM,e.viewForward),l=r.intersectInfiniteManifold(Il(e.eye,n),a,Kp);return e.eye=l??r.setAltitude(Kp,a,e.eye),e.center=RE(Kp,e.eye,o,e.center),!0}function Jg(s,e,t=So){if(!EM(s,t)||!s.state.constraints.altitude)return 0;const i=RM(s.state.constraints.altitude,AM);OM(s,t,i);const r=s.renderCoordsHelper.getAltitude(e.eye),a=Q(r,i.min,i.max)-r;return Math.abs(a)<=1e-6?0:a}function EM(s,e){const t=s.state.constraints.altitude;return!(!s.state.isGlobal||!t)&&(e.interactionType!==Oe.TUMBLE||!vc(e.selection,nt.TILT))}function OM(s,e,t){const i=e.interactionType;if(i===Oe.NONE)return;const{min:r,max:a}=t,{interactionStartCamera:n,interactionFactor:o}=e;if(!n)return;const l=i===Oe.TUMBLE||i===Oe.ZOOM,h=Jg(s,n),u=h===0?0:s.renderCoordsHelper.getAltitude(n.eye);t.min=r,t.max=a,Jd(h,u,l,o,.05*u,t)}function MM(s,e,t,i){return s.renderCoordsHelper.worldUpAtPosition(e.eye,i),ee(i,i,t),i}function RM(s,e){return e.min=s.min,e.max=s.max,e}const AM={min:0,max:0},DM=v(),$M=v(),IM=v(),Kp=v();function ef(s,e,t=So){if(!s.state.isLocal)return 0;const i=s.state.constraints.distance;if(!s.pointsOfInterest.surfaceOrigin.renderLocation||i===1/0)return 0;Yc.min=0,Yc.max=i,NM(s,t,Yc);const r=tf(s,e),a=Yc.max-r;return a>=-1e-6?0:a}function LM(s,e,t=So){const i=ef(s,e,t);if(i===0)return!1;const r=s.pointsOfInterest.surfaceOrigin;if(!r.renderLocation)return!1;const a=tf(s,e)+i,n=le(FM,e.eye),o=Aw(e,t.interactionDirection,VM(e,r.renderLocation,zM),HM);if(!Sp(SE(r.renderLocation,a),Il(e.eye,o),Zc))return!1;e.eye=Zc;const l=ye(UM,e.eye,n);e.center=ue(Zc,e.center,l);const h=s.renderCoordsHelper.getAltitude(e.center),u=s.renderCoordsHelper.intersectInfiniteManifold(e.ray,h,Zc);return u!=null&&(e.center=u),!0}function NM(s,e,t){const i=e.interactionType;if(i===Oe.NONE)return;const{min:r,max:a}=t,{interactionStartCamera:n,interactionFactor:o}=e;if(!n)return;const l=i===Oe.ZOOM||i===Oe.PAN,h=ef(s,n),u=h===0?0:tf(s,n);t.min=r,t.max=a,Jd(h,u,l,o,.05*u,t)}function tf(s,e){const t=s.pointsOfInterest.surfaceOrigin;return t.renderLocation?vi(e.eye,t.renderLocation):0}function VM(s,e,t){return Pg(t,s.eye,e)}const Yc={min:0,max:0},FM=v(),UM=v(),HM=v(),zM=v(),Zc=v();function ql(s,e,t=er.EYE){const i=s.state.constraints;if(!i.collision.enabled)return!1;const r=bg(s,e.eye),a=s.renderCoordsHelper.getAltitude(e.eye),n=r+i.collision.elevationMargin;if(a>=n)return!1;const o=we(e.eye);if(ye(Xc,e.center,e.eye),e.eye=s.renderCoordsHelper.setAltitude(GM,n,e.eye),t===er.EYE_AND_CENTER)e.center=ue(Xc,e.eye,Xc);else if(t===er.EYE_AND_CENTER_SCALE){const l=(o-a+n)/o;e.center=ee(Xc,e.center,l)}return!0}var er;(function(s){s[s.EYE=0]="EYE",s[s.EYE_AND_CENTER=1]="EYE_AND_CENTER",s[s.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})(er||(er={}));const Xc=v(),GM=v();function Dw(s,e,t,i=!0){rh.eyeCenterDistance=0,rh.requiresTwoSteps=!1;const r=sf(s,e,t,So,rh);if(r===0)return!1;switch(go(Kc,-r,e.viewRight),t.tiltMode){case aa.LOOK_AROUND:Gt(Ga,e.viewForward,Kc),ee(Ga,Ga,rh.eyeCenterDistance),e.center=ue(Ja,e.eye,Ga);break;case aa.TUMBLE:ye(Ga,e.center,e.eye),Gt(Ga,Ga,Kc),e.eye=ye(Ja,e.center,Ga);break;default:Ec(t.tiltMode)}return e.up=Gt(Ja,e.up,Kc),!rh.requiresTwoSteps||!i||Dw(s,e,t,!1)}function sf(s,e,t,i=So,r){if(!s.state.constraints.tilt)return 0;const a=Math.min(e.relativeElevation*Ku,e.distance),n=s.state.constraints.tilt(a,KM);return XM(s,t,n),i.interactionType===Oe.TUMBLE&&vc(i.selection,nt.ALTITUDE)&&$w(s,i.interactionStartCamera,n),t.tiltMode===aa.LOOK_AROUND||i.tiltMode===aa.LOOK_AROUND?qM(s,e,n,r):BM(s,e,n)}function BM(s,e,t){const i=pn(s.renderCoordsHelper,e.center,e.eye),r=i-Q(i,t.min,t.max);return bc(r)?r:0}function qM(s,e,t,i){switch(i&&(i.requiresTwoSteps=!1),s.viewingMode){case"global":return jM(s,e,t,i);case"local":return kM(s,e,t,i)}}function kM(s,e,t,i){const r=pn(s.renderCoordsHelper,e.center,e.eye),a=Q(r,t.min,t.max),n=r-a;if(!bc(n))return 0;if(i){const o=Math.abs(s.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude),l=s.renderCoordsHelper.getAltitude(e.eye)-o,h=Math.max(Math.cos(a),1e-4);Math.abs(h)>1e-4?i.eyeCenterDistance=l/h:i.eyeCenterDistance=e.distance}return n}function jM(s,e,t,i){const r=WM(s,e,JM),a=Q(r.tiltAtCenter,t.min,t.max);if(!bc(r.tiltAtCenter-a))return 0;let n,o;return r.centerIsOnSurface?(n=QM(r),o=YM(r,n)):(n=r.constraints.clampTilt(r.distance,r.tiltAtCenter),i&&n<Math.PI/2&&(i.requiresTwoSteps=!0,n=Math.PI/2-1e-5),o=ZM(r,n)),i&&(i.eyeCenterDistance=A_(r,n)),o}function WM(s,e,t){const i=s.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=i+Dt(s.spatialReference).radius,a=s.renderCoordsHelper.intersectManifold(e.ray,i,Ja);return t.distance=Math.min(e.relativeElevation*Ku,e.distance),t.centerIsOnSurface=!1,a!=null?(t.distance=Math.min(e.relativeElevation*Ku,vi(e.eye,a)),t.tiltAtCenter=pn(s.renderCoordsHelper,a,e.eye),t.centerIsOnSurface=!0):s.state.isLocal?t.tiltAtCenter=pn(s.renderCoordsHelper,e.center,e.eye):(Pp(Fg(Ug,r),e.ray,Ja),t.distance=Math.min(e.relativeElevation*Ku,vi(e.eye,Ja)),t.tiltAtCenter=mn(-oe(e.viewForward,ie(Ja,Ja)))),t.radius=r,t.eyeRadius=we(e.eye),t.constraints=s.state.constraints,t}function bc(s){return Math.abs(s)>1e-9}function QM(s){const{constraints:e,distance:t,tiltAtCenter:i}=s;let r=i,a=e.clampTilt(t,i);const n=A_(s,a);if(e.clampTilt(n,i)===a)return a;let o=0;for(;o<10&&bc(a-r);){const l=(r+a)/2,h=A_(s,l);bc(e.clampTilt(h,l)-l)?r=l:a=l,o++}return a}function A_(s,e){if(!s.centerIsOnSurface)return s.distance;const t=Math.PI-Q(e,0,Math.PI),i=Fd(s.radius/s.eyeRadius*Math.sin(t)),r=Math.PI-t-i,a=Math.sin(r)/Math.sin(t);if(s.eyeRadius<s.radius&&a>1){const n=Math.PI-i,o=Math.PI-t-n;return Math.sin(o)/Math.sin(t)*s.eyeRadius}return a*s.eyeRadius}function YM(s,e){const t=Fd(s.radius/s.eyeRadius*Math.sin(s.tiltAtCenter)),i=Fd(s.radius/s.eyeRadius*Math.sin(e));return s.eyeRadius>s.radius?t-i:i-t}function ZM(s,e){return s.tiltAtCenter-Math.PI/2-(e-Math.PI/2)}function XM(s,e,t){if(e.interactionType===Oe.NONE)return;const{interactionStartCamera:i,interactionFactor:r}=e;if(!i)return;const{min:a,max:n}=t,o=sf(s,i,So,e),l=o===0?0:pn(s.renderCoordsHelper,i.center,i.eye);t.min=a,t.max=n,e.interactionType===Oe.TUMBLE?(vc(e.selection,nt.ALTITUDE)&&$w(s,i,t),Jd(o,l,!0,r,iv,t)):Jd(o,l,!1,r,iv,t)}function $w(s,e,t){const i=s.state.constraints;if(s.state.isLocal||!i.altitude||!e)return;const r=Zs(e.center),a=Math.sqrt(r),n=e.distance,o=Dt(s.spatialReference).radius,l=i.altitude.min+o,h=i.altitude.max+o,u=(l*l-n*n-r)/(-2*a*n),d=(h*h-n*n-r)/(-2*a*n);t.min=Math.max(t.min,Math.min(Math.PI-mn(d),t.max)),t.max=Math.min(t.max,Math.PI-mn(u))}const Ga=v(),Kc=It(),Ja=v(),iv=Rt(5),Ku=30,KM={min:0,max:0},JM={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,distance:0,tiltAtCenter:0},rh={eyeCenterDistance:0,requiresTwoSteps:!1};function At(s,e,t=sR,i=e){i!==e&&i.copyFrom(e),i.computeUp(s.state.viewingMode);let r=!1;for(let o=0;o<rR;o++){let l=0;for(const h of iR)if(vc(t.selection,h.type)){const u=Math.abs(h.error(s,i,t));h.apply(s,i,t)&&(r=!0,l+=u)}if(l===0)break}const a=vc(t.selection,nt.COLLISION),n=eR(t.interactionType,s);return a&&ql(s,i,n)&&(r=!0),r&&i.computeUp(s.state.viewingMode),r}function eR(s,e){switch(s){case Oe.PAN:return er.EYE_AND_CENTER;case Oe.ASCEND:return e.state.isGlobal?er.EYE_AND_CENTER_SCALE:er.EYE_AND_CENTER;default:return er.EYE}}function Qs(s){const e=Math.min(1,s/150);return QT(e)}function tR(s,e,t){return sf(s,e,t)*e.distance}const iR=[{type:nt.TILT,error:tR,apply:Dw},{type:nt.ALTITUDE,error:Jg,apply:PM},{type:nt.DISTANCE,error:ef,apply:LM}],sR=new Is,rR=5;let sv=class{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=v(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=dn(rv),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotate(){const e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,t){if(this.viewingMode===Ne.Global){const a=(we(this.center)+we(e.center))/2;t.pan=Sg(this.center,e.center)*a}else t.pan=vi(this.center,e.center);let i=Math.abs(e._yaw-this._yaw);i>=Math.PI&&(i=2*Math.PI-i);const r=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(i,r),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}interpolate(e,t,i){this.viewingMode===Ne.Global?eP(e.center,t.center,i.pan,this.center):Tr(this.center,e.center,t.center,i.pan),this._distance=isFinite(t.distance)?ze(e.distance,t.distance+i.zoomOffset,i.zoom):e.distance,this._pitch=ze(e.pitch,t.pitch,i.rotate);let r=e._yaw;const a=t._yaw;Math.abs(a-r)>=Math.PI&&(r+=2*(r<a?1:-1)*Math.PI),this._yaw=ze(r,a,i.rotate),this._fov=ze(e.fov,t.fov,i.fov)}copyFrom(e){le(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,le(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,av);le(this.center,e.center),ye(xi,e.center,e.eye),jr(xi,xi,t),jr(qa,e.up,t),this._distance=we(xi),this._distance!==0&&(xi[0]/=this._distance,xi[1]/=this._distance,xi[2]/=this._distance),this._pitch=aR(xi),this._yaw=nR(xi,qa),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,av);Mc(t,t),this._axisAngleVec3(Ju,this._pitch-Math.PI/2,rv,xi),this._axisAngleVec3(io,this._yaw,xi,xi),this._axisAngleVec3(Ju,this._pitch-Math.PI/2,io,qa),this._axisAngleVec3(io,this._yaw,qa,qa),ee(xi,xi,this._distance),jr(xi,xi,t),jr(qa,qa,t),e.center=this.center,e.eye=ye(xi,this.center,xi),e.up=qa,e.fov=this._fov}_axisAngleVec3(e,t,i,r){const a=Math.cos(t),n=Math.sin(t);return ee(Ss,i,a),pt(fs,e,i),ee(fs,fs,n),ee(Ba,e,(1-a)*oe(e,i)),ue(r,ue(r,Ss,fs),Ba)}_lookAtOrientation(e,t=ia()){return this._upAtLookAt(e,Ba),pt(Ss,this.direction,Ba),ie(Ss,Ss),Ss[0]===0&&Ss[1]===0&&Ss[2]===0&&le(Ss,Ju),pt(fs,Ba,Ss),ie(fs,fs),t[0]=Ss[0],t[1]=fs[0],t[2]=Ba[0],t[3]=Ss[1],t[4]=fs[1],t[5]=Ba[1],t[6]=Ss[2],t[7]=fs[2],t[8]=Ba[2],t}_upAtLookAt(e,t){return this.viewingMode===Ne.Local?le(t,io):ie(t,e)}};function aR(s){return Math.PI-Sg(io,s)}function nR(s,e){const t=oR;return Math.abs(e[2])<.5?(le(t,e),s[2]>0&&ee(t,t,-1)):le(t,s),pt(fs,t,io),ie(fs,fs),Sg(Ju,fs,io)}const Ss=v(),fs=v(),Ba=v(),xi=v(),qa=v(),oR=v(),io=xT,rv=bT,Ju=wT,av=ia();let lR=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=Xe(0),this._animation=new YT(()=>new sv(e)),this._current=new sv(e)}update(e,t,i){const{source:r,target:a}=this._animation.definition,n=ye(hR,t.center,e.center),o=we(n);o>=1e-5?(n[0]/=o,n[1]/=o,n[2]/=o):(n[0]=0,n[1]=1,n[0]=0),le(r.direction,n),le(a.direction,n),r.copyFromRenderCamera(e),a.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,a,i),this.currentTime=Xe(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){this._animation.cameraAt(e,this._current),this._current.copyToRenderCamera(t)}step(e,t){this.finished||(this.currentTime=Xe(this.currentTime+kC(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}};const hR=v();var ct;(function(s){s[s.Ready=0]="Ready",s[s.Rejected=1]="Rejected",s[s.Running=2]="Running",s[s.Stopped=3]="Stopped",s[s.Finished=4]="Finished"})(ct||(ct={}));let Pa=class extends Re{constructor(e){super(e),this.state=ct.Ready}get running(){return this.state===ct.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=ct.Stopped,!0)}finishController(){this.state=ct.Finished}get steppingFinished(){return!1}};c([m({constructOnly:!0})],Pa.prototype,"view",void 0),c([m({readOnly:!0})],Pa.prototype,"running",null),c([m()],Pa.prototype,"state",void 0),c([m({readOnly:!0})],Pa.prototype,"isInteractive",null),Pa=c([F("esri.views.3d.state.controllers.CameraController")],Pa);let wc=class extends Pa{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(_r()),this._asyncResult=null),this.state===ct.Finished||this.state===ct.Stopped?(jC(e),this.state===ct.Finished?e.resolve():e.reject(_r())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=ct.Running,this.viewAnimation!=null&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!this.viewAnimation||this.state!==ct.Ready&&this.state!==ct.Running||(this.viewAnimation.state===Rl.State.FINISHED?this.finish():this.viewAnimation.state===Rl.State.STOPPED&&(this.state=ct.Stopped))}onControllerEnd(e){this.viewAnimation==null||this.viewAnimation.done||(this.state===ct.Finished?this.viewAnimation.finish():this.state===ct.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===ct.Finished?this._asyncResult.resolve():this._asyncResult.reject(_r()))}finish(){this.finishController()}};wc=c([F("esri.views.3d.state.controllers.AnimationController")],wc);let so=class extends wc{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.type="point-to-point",this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new lR(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new Rl}get isInteractive(){return this.mode==="interaction"}begin(e,t){this._hasTarget=!0;const i=this.animationSettings(t);Jc.copyFrom(this.view.state.camera);const r=sa(this.view.state.viewingMode);this._intersectionHelper.intersectRay(Jc.ray,r,nv)&&(Jc.center=nv),this.animation.update(Jc,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:typeof e.easing=="string"?ZT[e.easing]:e.easing}}};c([m({constructOnly:!0})],so.prototype,"mode",void 0),c([m({readOnly:!0})],so.prototype,"isInteractive",null),so=c([F("esri.views.3d.state.controllers.PointToPointAnimationController")],so);const Jc=new Pt,nv=v();function ov(s){return s!=null&&"type"in s&&s.type==="point-to-point"}function Op(s=uR){return[s[0],s[1],s[2],s[3]]}function xc(s,e){return cR(s[0],s[1],s[2],e,BE.get())}function cR(s,e,t,i,r=Op()){return r[0]=s,r[1]=e,r[2]=t,r[3]=i,r}function rf(s,e,t){return pt(t,s,e),ie(t,t),t[3]=W1(s,e),t}const uR=[0,0,1,0];function af(s,e,t,i){const r=Gl(e,t,dR);return Sp(s,r,i)}const dR=To();var Vl;(function(s){s[s.Ellipsoid=0]="Ellipsoid",s[s.Silhouette=1]="Silhouette"})(Vl||(Vl={}));const Iw=30,ep=[1,3e8],Vc=80,Lw=8,Nw=200,Vw=1508e5,Fw=5,Uw=50,pR=5,mR=10,Jp=90,Po={exclude:new Set([_c])};function lo(s,e,t){return t[0]=e[0]/(s.fullWidth/s.pixelRatio),t[1]=e[1]/(s.fullHeight/s.pixelRatio),t}function D_(s){for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;return s}function wn(s,e,t){const i=go(qE.get(),t[3],t);i==null||wP(i,Gh)||(ye(tt,s.eye,e),Gt(tt,tt,i),s.eye=ue(tt,tt,e),ye(tt,s.center,e),Gt(tt,tt,i),s.center=ue(tt,tt,e),s.up=Gt(tt,s.up,i))}function _R(s,e,t,i){return Hg(s,Z1(e,t,lf),i)}function $_(s,e,t,i){return Hg(s,Gl(e,t,lf),i)}function nf(s,e,t,i){const r=Tt.get();let a=1-t;ye(r,e,s.eye);const n=we(r);let o=n*(1-a);a>=0&&o<i&&(o=i,a=-(o-n)/n),Math.abs(n-o)<1e-6||(ee(r,r,a),s.eye=ue(tt,s.eye,r),s.center=Tr(tt,s.center,e,a))}function Hw(s,e,t){e.getScreenCenter(lv),af(s,e,lv,tt)&&(e.center=tt);const i=e.distance,r=i*t;if(Math.abs(i-r)<1e-6)return;const a=ee(Tt.get(),e.viewForward,r);e.eye=ye(tt,e.center,a)}const lv=ri();function em(s,e){ce(e,0,0,0);for(const t of s)ue(e,e,t);ee(e,e,1/s.length)}function ed(s,e,t,i){return Math.sin(s/we(e))*(t+i.radius)}function hv(s,e,t,i){return ed(Math.PI/2,e,t,i)+(s-Math.PI/2)}var $i;(function(s){s[s.Vertical=0]="Vertical",s[s.Horizontal=1]="Horizontal"})($i||($i={}));const cv={Elevation:3e4,Angle:Rt(16)},zw=Rt(80);function Gw(s,e,t,i,r,a){const n=v(),o=Sr();let l=!0,h=!0;return s.intersectScreen(t,n,a)?o[3]=we(n):(h=!1,e.aboveGround&&r!==Vl.Ellipsoid?o[3]=Math.max(we(e.center),.9*i.radius):o[3]=we(e.eye)-e.relativeElevation,r===Vl.Silhouette?Cc(o,e,t,n):l=af(o,e,t,n)),{sphere:o,scenePickPoint:l?n:null,hasGeometryIntersection:h}}function Fc(s,e,t,i){const r=s.relativeElevation;if(r>cv.Elevation&&i==="global")return $i.Horizontal;Gl(s,e,im);const a=Math.sign(r),n=t.worldUpAtPosition(s.eye,tt);return-a*oe(n,im.direction)<Math.sin(cv.Angle)*we(im.direction)?$i.Vertical:$i.Horizontal}function Bw(s,e,t){ye(tm,t,e),s.eye=ye(tt,s.eye,tm),s.center=ye(tt,s.center,tm)}const tm=v();function Cc(s,e,t,i){const r=Gl(e,t,lf);return r!=null&&(Pp(s,r,eu),Sp(s,r,i)?!(rn(eu,r.origin)<rn(i,r.origin))||(le(i,eu),!1):(ye(Vo,e.eye,e.center),ie(Vo,Vo),Q1(Vo,-oe(ie(Vo,Vo),eu),uv),Hg(uv,r,i),!1))}const eu=v(),Vo=v(),uv=mc();function qw(s,e,t,i,r,a){let n=0;if(pt(sp,s,e),ye(ru,s,e),we(s)<=r||!i.aboveGround){pt(t,ru,i.eye);const o=oe(s,e)/(we(s)*we(e));if(o<.9999)n=mn(o);else{const h=we(pt(v(),s,e))/(we(s)*we(e));n=Fd(h)}const l=Math.cos(Q(fn.normalize(Rt(a)),0,zw));n=-n-Math.max(0,we(e)-r)/(l*r)}else ye(dv,i.eye,i.center),pt(t,ru,dv),n=-we(ru)/r;return ie(t,t),ee(t,t,we(sp)),n}const dv=v();function pv(s,e,t,i){let r,a;const n=Math.cos(Q(fn.normalize(Rt(i)),0,zw));return r=e>t?-(e-t)/(n*t):e<-t?Math.PI-(e+t)/(n*t):mn(e/t),a=s>t?-(s-t)/(n*t):s<-t?Math.PI-(s+t)/(n*t):mn(s/t),(a-r)*t}function gR(s,e,t,i,r,a,n,o,l,h){const u=pv(s[2],e[2],a[3],o),d=l?pv(s[0],e[0],a[3],180):e[0]-s[0],p=Math.sin(n)*d-Math.cos(n)*u,_=Math.cos(n)*d+Math.sin(n)*u;ie(tt,r);const f=l?p/Math.sqrt(Math.abs(a[3]**2-oe(t,tt)**2)):p/a[3],g=_/Math.sqrt(Math.abs(a[3]**2-oe(t,i)**2));xo(h,f,g)}function kw(s,e,t,i,r,a,n,o,l,h){pt(sp,s,e),p_(a.up,a.eye,tu,iu,su),p_([0,0,1],a.eye,Ia,ln,Yw),le(t,ln),le(i,Ia),ie(t,t),ee(t,t,we(sp)),ry(s,ie(iu,iu),ie(su,su),ie(tu,tu),mv),ry(e,iu,su,tu,_v),gR(mv,_v,s,Ia,ln,n,o,l,h,r)}function fR(s,e,t,i,r,a,n){go(tp,r,i),go(ip,n,a),Zr(ul,tp,ip),ye(e,s,t),Gt(e,e,ul),ue(e,e,t)}function jw(s,e,t,i,r,a){go(tp,i,t),go(ip,a,r),Zr(ul,tp,ip),ye(tt,s.eye,e),Gt(tt,tt,ul),s.eye=ue(tt,tt,e),ye(tt,s.center,e),Gt(tt,tt,ul),s.center=ue(tt,tt,e),ye(tt,s.up,e),Gt(tt,tt,ul),s.up=ue(tt,tt,e)}const On={Pole:.95,Angle:Rt(18),Tilt:45,TiltHysteresisMargin:1e-7};let Fo=!1;function of(s,e,t,i,r,a){const n=Math.abs(i)>Math.PI-On.Angle||Math.abs(i)<On.Angle,o=(Math.abs(s[2])<t*On.Pole||Math.abs(e)>t)&&a;return n&&o?!Fo&&r<On.Tilt-On.TiltHysteresisMargin?Fo=!0:Fo&&r>On.Tilt+On.TiltHysteresisMargin&&(Fo=!1):Fo=!1,Fo}function Ww(s,e,t,i,r,a){if(a)rf(t,i,gv),wn(e,wt(s),gv);else{const n=qw(t,i,fv,e,s[3],r);wn(e,wt(s),xc(fv,n))}}function Qw(s,e,t,i,r,a,n){const o=n?20:1,l=1e-12;let h,u;le(Mn,i),au.copyFrom(e);for(let d=0;d<o&&rn(t,Mn)>l&&(h=rn(t,Mn),kw(t,Mn,ln,Ia,ah,au,s,r,a,n),jw(au,wt(s),Ia,ah[1],ln,ah[0]),fR(Mn,Mn,wt(s),Ia,ah[1],ln,ah[0]),u=rn(t,Mn),u<h||d===0);d++)e.copyFrom(au)}function yR(s,e,t,i,r,a,n){of(t,oe(e.up,t),s[3],-fn.normalize(Rt(r)),a,e.aboveGround)?Qw(s,e,t,i,-fn.normalize(Rt(r)),a,n):Ww(s,e,t,i,a,n)}function vR(s,e,t,i,r,a){const{eye:n}=s;p_([0,0,1],n,Ia,ln,Yw);const o=e.translation[0]*t.pan,l=r.mode==="zoom"?0:e.translation[1]*t.pan,h=Math.max(Math.sqrt(Math.abs(1-oe(s.center,Ia)**2/we(s.center)**2)),.5),u=(Math.sin(a)*l+Math.cos(a)*o)/h,d=-Math.cos(a)*l+Math.sin(a)*o;switch(Ma(i.pan.matrix,i.pan.matrix,u,Ia),i.pan.enabled=!0,r.mode){case"pan":Ma(i.pan.matrix,i.pan.matrix,d,ln),i.pan.enabled=!0;break;case"zoom":i.zoom=-e.translation[1]*t.zoom}}function bR(s,e,t,i,r){const{eye:a,viewRight:n}=s,o=pt(Tt.get(),n,a),l=e.translation[0]*t.pan;switch(l!==0&&(Ma(i.pan.matrix,i.pan.matrix,-l,o),i.pan.enabled=!0),r.mode){case"pan":{const h=e.translation[1]*t.pan;h!==0&&(Ma(i.pan.matrix,i.pan.matrix,h,n),i.pan.enabled=!0);break}case"zoom":i.zoom=-e.translation[1]*t.zoom}}function wR(s,e,t,i,r,a,n,o,l){of(s.center,oe(s.up,s.center),we(s.center),-fn.normalize(Rt(a)),n,e.aboveGround)?vR(e,t,i,o,l,-fn.normalize(Rt(r))):bR(e,t,i,o,l)}const Ia=v(),ln=v(),Yw=v(),tu=v(),iu=v(),su=v(),mv=v(),_v=v(),ah=Ts(),gv=Op(),tp=It(),ip=It(),ul=It(),Mn=v(),tt=v(),ru=v(),au=new Pt,sp=v(),fv=v(),lf={origin:v(),direction:v()},im={origin:v(),direction:v()},yv=.6,sm=4,xR=60;let rp=class extends so{constructor(){super(...arguments),this._zoomLocation=v(),this._tmpCamera=new Pt,this._tmpViewDir=v(),this._tmpRayDir=To(),this._targetOnSphere=v(),this._tmpCenter=v(),this._beginCamera=new Pt,this._constraintOptions=new Is(nt.ALL_EXCEPT_COLLISION,Oe.ZOOM,null,this._beginCamera),this._sphere=Sr()}initialize(){this._intersector=sa(this.view.state.viewingMode)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let r=!1,a=!1;this._intersectionHelper.intersectScreen(t,this._zoomLocation,this.view.map.ground.opacity===0?Po:{})&&(r=e>0,a=!0),this._tmpCamera.copyFrom(i.camera),r?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:le(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,t,a),this.begin(this._tmpCamera)}animationSettings(){return{duration:Xe(600),easing:s1}}_updateCamera(e,t,i,r){const a=Fc(e,i,this.view.renderCoordsHelper,this.view.viewingMode),n=Math.abs(this.view.camera.position.z),o=this._zoomLocation;ie(ou,e.eye),ee(ou,ou,-1),Gl(e,i,this._tmpRayDir),ie(this._tmpRayDir.direction,this._tmpRayDir.direction);const l=Q(Math.min(Lw,1/Math.abs(oe(ou,this._tmpRayDir.direction)))*n,Nw,Vw);if(a===$i.Horizontal){let h=yv**t;this._sphere[3]=we(o),ye(this._tmpViewDir,e.center,e.eye);const u=Math.min(we(this._tmpViewDir),l);let d=u*h;if(h<=1&&d<sm&&(d=sm,h=d/u),Math.abs(u-d)<1e-6)return;const p=we(e.center);if(this._sphere[3]!==p){const _=this._sphere[3]+h*(p-this._sphere[3]);e.center=ee(nu,e.center,_/p)}ee(this._tmpViewDir,this._tmpViewDir,-h),e.eye=ue(nu,e.center,this._tmpViewDir),At(this.view,e,this._constraintOptions),rn(o,e.center)>1e-12&&af(this._sphere,e,i,this._targetOnSphere)&&yR(this._sphere,e,o,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let h=yv**Math.abs(t);const u=t>0?1:-1;ye(this._tmpViewDir,o,e.eye);const d=we(this._tmpViewDir),p=this.view._stage.renderView.getMinimalDepthForArea(null,i[0],i[1],this.view.state.camera,xR);let _=p??l;_=r&&t>0?Math.min(_,d):_,ee(this._tmpRayDir.direction,this._tmpRayDir.direction,_),ue(o,this._tmpRayDir.origin,this._tmpRayDir.direction);let f=_*h;const g=Math.max(sm,1.01*e.nearFar[0]);if(t>0&&f<g&&(f=g,h=f/_),Math.abs(_-f)<1e-6)return;ee(this._tmpRayDir.direction,this._tmpRayDir.direction,u*(1-h)),e.eye=ue(nu,e.eye,this._tmpRayDir.direction),e.center=ue(nu,e.center,this._tmpRayDir.direction)}ql(this.view,e)}};rp=c([F("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],rp);const nu=v(),ou=v();let td,id=null;const Cl=new Map;async function LH(s){id==null&&(td==null&&(td=X(()=>import("./VoxelWasmPerSceneView-DgxWmrwj.js"),__vite__mapDeps([566,1,8,3,4,9,17,18,5,160,29,42,6,43,171,13,7,10,51,123,60,2,11,12,14,15,172,59,62,63,45,49,64,46,44,47,48,41,50,65,54,66,94,78,79,80,81,471,26,27,28,30,23,24,31,32,33,34,35,36,37,38,39,250,119,124,228,162,163,118,120,121,122,52,97,229,55,230,221,71,70,238,225,135,73,136,69,61,56,67,72,74,75,76,77,68,82,83,84,40,85,86]),import.meta.url)),id=await td);const e=s.view;let t=Cl.get(e);return t||(t=new id.default({view:e}),Cl.set(e,t)),t.addVoxelLayer(s)}function Tc(s){return Cl.get(s)}function NH(s){const e=s.view,t=Cl.get(e);t&&t.removeVoxelLayer(s)<1&&(Cl.delete(e),Cl.size===0&&(td=null,id=null))}const CR=.6,TR=4,SR=60;let ap=class extends so{constructor(){super(...arguments),this._zoomLocation=v(),this._tmpCamera=new Pt,this._tmpRayDir=v(),this._tmpCenter=v(),this._beginCamera=new Pt,this._constraintOptions=new Is(nt.ALL,Oe.ZOOM,null,this._beginCamera)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);const r=sa(this.view.state.viewingMode);let a=!1;e>0?(a=this._intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.map.ground.opacity===0?Po:{}),this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:le(this._zoomLocation,this._tmpCamera.center);const n=CR**e;let o=this.view._stage.renderView.getMinimalDepthForArea(Tc(this.view),t[0],t[1],this.view.state.camera,SR);ye(lu,this._tmpCamera.eye,this._zoomLocation),ie(lu,lu);const l=Q(Math.min(Lw,1/Math.abs(oe(PR,lu)))*Math.abs(this.view.camera.position.z),Nw,Vw);if(o=o??l,o){const h=v();ye(h,this._zoomLocation,this._tmpCamera.eye),(o<we(h)||!a)&&(ie(h,h),ue(this._zoomLocation,this._tmpCamera.eye,ee(h,h,o)))}this._updateCamera(this._tmpCamera,n,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:Xe(600),easing:s1}}_updateCamera(e,t,i){ye(this._tmpRayDir,i,e.eye);const r=we(this._tmpRayDir);let a=r*t;const n=t<=1,o=Math.max(TR,1.01*e.nearFar[0]);a!==0&&(n&&a<o&&(a=o,t=a/r),Math.abs(r-a)<1e-6||(ee(this._tmpRayDir,this._tmpRayDir,t),e.eye=ye(vv,i,this._tmpRayDir),e.center=Tr(vv,e.center,i,1-t),At(this.view,e,this._constraintOptions)))}};ap=c([F("esri.views.3d.state.controllers.ZoomStepControllerLocal")],ap);const vv=v(),PR=Vt(0,0,1),lu=v();let ER=class extends oa{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,i=>this._handleDoubleClick(i))}_handleDoubleClick(e){const t=e.data;if(XT(t,"primary")){const i=this._view.state.isGlobal?new rp({view:this._view,mode:"animation"}):new ap({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.step(Math.log(.5)/Math.log(.6),ri(t.x,t.y)),e.stopPropagation()}}};function hf(s){return Q((s-1e5)/9e5,0,1)}const bv=1e4,sd=Vt(parseFloat(5802e-9.toFixed(6)),parseFloat(13558e-9.toFixed(6)),parseFloat(331e-7.toFixed(6))),rm=3,am=Vt(rm*parseFloat(65e-8.toFixed(6)),rm*parseFloat(1881e-9.toFixed(6)),rm*parseFloat(85e-9.toFixed(6))),OR=3996e-9,MR=Vt(parseFloat(Number(sd[0]+am[0]).toFixed(6)),parseFloat(Number(sd[1]+am[1]).toFixed(6)),parseFloat(Number(sd[2]+am[2]).toFixed(6)));function RR(s,e,t){return s===Ne.Global?new DR(t):new AR(e,t)}let AR=class{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=Dt(t),this._unitInMeters=h_(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,r,a){var C;a||(a={near:0,far:0});let n=e[2]*this._unitInMeters;const o=n,l=n-r,h=(C=this._elevationProvider)==null?void 0:C.visibleElevationBounds;h&&(n=l>=0?o-this._unitInMeters*h.min:this._unitInMeters*h.max-o);const u={x:(i=i??new dr({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},d=Math.max(u.x,u.y,u.z);ye(Rn,t,e),Uo[0]=Rn[0]>0?i.xmax:i.xmin,Uo[1]=Rn[1]>0?i.ymax:i.ymin,Uo[2]=Rn[2]>0?d/2:-d/2,ye(Uo,Uo,e),ie(Rn,Rn);const p=1.1*oe(Uo,Rn)*this._unitInMeters,_=Math.sqrt(n*(n+2*this._referenceEllipsoid.radius)),f=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),g=f*LR*this._unitInMeters,y=f*NR*this._unitInMeters,b=Q((n-y)/(g-y),0,1)**3,x=Math.min(ze(_,p,b),_)*Math.max(Math.log(Math.abs(l)),1);return Zw(Math.min(x,Math.max(34064e4,d))/this._unitInMeters,rd,this._unitInMeters,a)}},DR=class{constructor(e){this._referenceEllipsoid=Dt(e)}compute(e,t,i,r,a){a||(a={near:0,far:0});const n=we(e),o=n-this._referenceEllipsoid.radius,l=this._referenceEllipsoid.radius+Math.min(0,r),h=Math.abs(o-r),u=Math.max(h,Math.abs(o)),d=Math.sqrt(u*(u+2*l)),p=n+this._referenceEllipsoid.radius,_=1.2*ze(d,p,hf(u)),f=(Math.log(u)-wv)/($R-wv);return Zw(_,Q(rd-f*(rd-xv),xv,rd),1,a)}};function Zw(s,e,t,i){const r=IR/t,a=s/e;return a>r?(i.far=s,i.near=a):(i.near=r,i.far=i.near*e),i}const wv=7.983,$R=16.994,rd=2e4,xv=100,IR=2,LR=.001,NR=1e-4,Uo=v(),Rn=v();let ad=class extends Re{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;e.spatialReference!=null&&l1(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>ql(this.view,e,er.EYE_AND_CENTER))}};c([m({constructOnly:!0})],ad.prototype,"view",void 0),ad=c([F("esri.views.3d.state.SurfaceCollisionConstraint")],ad);let Oh=class extends Re{constructor(e){super(e),this.nearFarHeuristic=RR(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([O(()=>{var e,t,i,r;return[(t=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:t.near,(r=(i=this.view.constraints)==null?void 0:i.clipDistance)==null?void 0:r.far]},()=>this._clipDistanceNearFarChanged()),O(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:t.mode},()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e)),O(()=>this.view.renderDataExtent,()=>this._updateNearFar(),Ge),O(()=>{var e,t,i,r;return[(t=(e=this.view.constraints)==null?void 0:e.altitude)==null?void 0:t.min,(r=(i=this.view.constraints)==null?void 0:i.altitude)==null?void 0:r.max]},()=>this._updateAltitude(),Ge),O(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:t.max},()=>this._updateTiltMax(),Ge),O(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:t.mode},()=>this._updateTilt(),Ge),O(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this._updateTiltAutoMax(),Ge),O(()=>{var e,t,i,r,a,n;return[(i=(t=(e=this.view.map)==null?void 0:e.ground)==null?void 0:t.navigationConstraint)==null?void 0:i.type,(n=(a=(r=this.view.state)==null?void 0:r.constraints)==null?void 0:a.collision)==null?void 0:n.enabled]},()=>this._updateCollision(),Ge)]),this.view.state.isLocal&&this.addHandles(O(()=>this.view.renderDataExtent,e=>this._updateLocalSurfaceDistance(e),at)),this._updateNearFar(),this.view.state.viewingMode!==Ne.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new ad({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var t;const e=(t=this.view.constraints)==null?void 0:t.clipDistance;e&&e.mode!=="auto"&&this.view.state.updateCamera(i=>Cv(i,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;(t?t.mode:"auto")==="manual"?Cv(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,bg(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCollision(){var r,a,n;const e=(n=(a=(r=this.view.map)==null?void 0:r.ground)==null?void 0:a.navigationConstraint)==null?void 0:n.type,t=!e||e==="stay-above",i=this.view.state.constraints.collision;if(t!==i.enabled){i.enabled=t,t&&this._reapplyConstraints(nt.COLLISION);const o=this.view.constraints&&this.view.constraints.tilt;o&&o.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Ne.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;(e?e.mode:"auto")==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(Rt(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||e.mode!=="auto")return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(sc(i))}}_updateLocalSurfaceDistance(e){if(e==null)return;let t=Math.max(e.width,e.height);if(t<=0)return;e.zmax!=null&&e.zmin!=null&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=nt.ALL){this.view.state.updateCamera(t=>At(this.view,t,new Is(e,Oe.NONE,null)))}};function Cv(s,e){e&&(s.near=e.near,s.far=e.far)}c([m({constructOnly:!0})],Oh.prototype,"view",void 0),c([m({readOnly:!0})],Oh.prototype,"surfaceCollisionConstraint",void 0),Oh=c([F("esri.views.3d.state.ConstraintsManager")],Oh);let kh=class extends Pa{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=ct.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(e.spatialReference==null||l1(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),ql(this.view,e,er.EYE_AND_CENTER)||this.constraintEnabled||(this.state=ct.Stopped)})}};c([m({constructOnly:!0})],kh.prototype,"desiredCamera",null),kh=c([F("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],kh);const VR=.66;function Xw(s){return 360-j1.normalize(s)}function Mp(s){return j1.normalize(360-s)}function Kw(s,e,t){const i=e.camera;if(i!=null)return FR(i,h1(s));const{targetGeometry:r}=e;if(r==null)return null;const{camera:a,mode:n}=ex(s,e.rotation,t);if(r.type==="point")return HR(s,e,r,a,n);const o=r.extent;return o==null?null:ju(s,o,a.heading,a.tilt,n)}async function Jw(s,e,t,i){const r=e.camera;if(r!=null)return UR(r,h1(s),i);const{targetGeometry:a}=e;if(a==null)throw new Error("Viewpoint has no targetGeometry!");const{camera:n,mode:o}=ex(s,e.rotation,t);if(a.type==="point")return zR(s,e,a,n,o,i);const l=a.extent;if(l==null)throw new Error("Target geometry has no extent!");return u1(s,l,n.heading,n.tilt,o,i)}function FR(s,e){const t=s.position;let i;try{i=Xb(t,e)}catch{return null}if(!i)return null;const r=s.clone();return r.position=i.clone(),r}async function UR(s,e,t){const i=s.position,r=await Ol(i,e,{signal:t});Ai(t);const a=s.clone();return a.position=r.clone(),a}function ex(s,e,t){const i=Dl(s,s.state.camera);let r=Js.ADJUST;return e!=null&&(i.heading=Xw(e),r=Js.LOCKED),t!=null&&(i.tilt=t),{camera:i,mode:r}}function HR(s,e,t,i,r){const a=s.spatialReference;let n;try{n=Xb(t.clone(),a)}catch{return null}if(!n)return null;const o=e.scale!=null?c1(s,e.scale):s.state.camera.distance;return CS(s,n,o,i,r)}async function zR(s,e,t,i,r,a){const n=s.spatialReference,o=await Ol(t.clone(),n,{signal:a});Ai(a);const l=e.scale!=null?c1(s,e.scale):s.state.camera.distance;return wg(s,o,l,i,r,a)}function tx(s,e,t=null){return t==null&&(t=new un),uf(s,null,e.clone(),t)}async function ix(s,e,t){const i=XR(s,e);if(!i)throw new Ri("viewpointutils-create:no-target","Missing target for creating viewpoint");const r=new ta({fov:s.camera.fov}),a=new un({camera:r});if(i.target instanceof un)return An(await qR(s,i.target,i,t,a));if(i.target instanceof ta)return An(await rx(s,i.target,t,a));const n=i.scale!=null||i.zoom!=null;if(i.target instanceof dr){const h=i.target.xmin===i.target.xmax||i.target.ymin===i.target.ymax;return An(n||h?await I_(s,i,i.target.center,r,t,a):await QR(s,i,i.target,r,t,a))}const o=new JR,l=n?GR(s,i):void 0;if(await sx(s,i.target,l,o,t),isFinite(o.boundingBox[0])){let h;if(iw(o.boundingBox,Ot),Rs.x=Ot[0],Rs.y=Ot[1],Rs.z=Ot[2],Rs.spatialReference=s.spatialReference,isFinite(Rs.z)&&o.hasZ?h=eO(o.boundingBox):(Rs.z=void 0,h=AT(tO(o.boundingBox,eA))),n||h)return An(await I_(s,i,Rs,r,t,a));const u=KR(s,o.screenSpaceObjects);return An(await ZR(s,i,Rs,o.boundingBox,u,r,t,a))}return i.position?An(await jR(s,i,r,a,t)):An(await WR(s,i,r,t,a))}function cf(s,e){return e.scale==null&&e.zoom!=null?p1(s,e.zoom):e.scale}function GR(s,e){const t=cf(s,e);return t?kT(t):void 0}function Rp(s,e){let t=!1;return e.heading!=null?(s.heading=e.heading,t=!0):e.rotation!=null&&(s.heading=Xw(e.rotation),t=!0),e.tilt!=null&&(s.tilt=e.tilt,t=!0),e.fov!=null&&(s.fov=e.fov),t}function uf(s,e,t,i){const r=s.spatialReference||si.WGS84;if(e??(e=wa(s,t)),e==null)return i;const a=new Cs({spatialReference:r});return tw(e.center,s.renderSpatialReference,a)&&(i.targetGeometry=a,i.scale=Al(s,e.distance),i.rotation=Mp(t.heading),i.camera=t),i}async function np(s,e,t,i){var d;const r=()=>new Ri("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!e)throw r();e.type==="mesh"&&(e=e.extent);const a=s.basemapTerrain.spatialReference;if(!e.hasZ&&s.basemapTerrain){let p;switch(e.type){case"point":p=e;break;case"multipoint":case"polyline":p=(d=e.extent)==null?void 0:d.center;break;case"extent":p=e.center;break;case"polygon":p=e.centroid}p!=null&&a&&s.elevationProvider?(p=await Ol(p,a,{signal:i}),Ot[2]=Bg(s.elevationProvider,p)??0):Ot[2]=0}const n=tA[e.type],o=new Array;if(n(e,e.hasZ?p=>{o.push([p[0],p[1],p[2]])}:p=>{o.push([p[0],p[1]])},Ot),o.length===0)throw r();const l=e.spatialReference,h=s.spatialReference,u=await Ol(new DT({spatialReference:l,hasZ:e.hasZ,hasM:!1,points:o}),h,{signal:i});if(e.hasZ&&(t.hasZ=!0),e.hasZ)for(const[p,_,f]of u.points)Ot[0]=p,Ot[1]=_,Ot[2]=f,C_(t.boundingBox,Ot);else for(const[p,_]of u.points)Ot[0]=p,Ot[1]=_,C_(t.boundingBox,Ot)}async function BR(s,e,t,i,r){const a=await o_(s.whenViewForGraphic(e));if(a.ok===!1||a.value==null||!("whenGraphicBounds"in a.value))return void await np(s,e.geometry,i,r);const n=a.value,o=await o_(n.whenGraphicBounds(e,{minDemResolution:t}));if(o.ok===!1||!o.value)return void await np(s,e.geometry,i,r);const{screenSpaceObjects:l,boundingBox:h}=o.value;iO(i.boundingBox,h),l&&l.forEach(u=>{i.screenSpaceObjects.push(u)}),isFinite(h[2])&&(i.hasZ=!0)}async function sx(s,e,t,i,r){var a;if(Array.isArray(e)&&e.length===2){const n=e[0],o=e[1];if(typeof n=="number"&&typeof o=="number")return Rs.x=n,Rs.y=o,Rs.z=void 0,Rs.spatialReference=(a=s.spatialReference)!=null&&a.isGeographic?s.spatialReference:si.WGS84,void await np(s,Rs,i,r)}e&&"map"in e&&typeof e.map=="function"?await Promise.allSettled(e.map(n=>sx(s,n,t,i,r))):e instanceof dT?await np(s,e,i,r):e instanceof G1&&await BR(s,e,t,i,r)}async function qR(s,e,t,i,r){if(e.camera)return rx(s,e.camera,i,r);r.scale=e.scale,r.rotation=e.rotation,r.targetGeometry=e.targetGeometry!=null?e.targetGeometry.clone():null,r.camera=null,t.heading!=null?r.rotation=Mp(t.heading):t.rotation!=null&&(r.rotation=t.rotation);const a=cf(s,t);return a!=null&&(r.scale=a),r.camera=await Jw(s,r,t.tilt,i),r}async function rx(s,e,t,i){const r=s.spatialReference,a=await Ol(e.position,r,{signal:t}),n=e.clone();return n.position=a,uf(s,null,n,i)}async function kR(s,e,t,i,r,a,n){const o=s.renderSpatialReference;return await c_(e,nm,o,0,{signal:n}),await c_(t,cu,o,0,{signal:n}),a.targetGeometry=new Cs(e),r.position=new Cs(t),ye(op,nm,cu),d1(s,cu,op,i.up,r),a.scale=Al(s,vi(cu,nm)),a.rotation=Mp(r.heading),a.camera=r,a}async function I_(s,e,t,i,r,a){a.targetGeometry=t.clone();const n=Hl(s);if(e.position)return kR(s,a.targetGeometry,e.position,n,i,a,r);if(e.zoomFactor){const l=n.distance/e.zoomFactor,h=ee(Ot,n.viewForward,-l);n.eye=ue(Ot,n.center,h),a.scale=Al(s,l)}Dl(s,n,i);const o=Rp(i,e)?Js.LOCKED:Js.ADJUST;if(!e.zoomFactor){const l=cf(s,e);if(l==null){await c_(a.targetGeometry,Ot,s.renderSpatialReference,0,{signal:r});const h=Th(n.frustum,Ot)?vi(n.eye,Ot):n.distance;a.camera=await wg(s,a.targetGeometry,h,i,o),a.scale=Al(s,h)}else a.scale=l,a.camera=await TS(s,a.targetGeometry,a.scale,i,o,r)}return a}async function jR(s,e,t,i,r){const a=Hl(s);le(op,a.viewForward),d1(s,a.eye,op,a.up,om);const n=s.spatialReference,{position:o}=e;if(o){const l=await Ol(o,n,{signal:r});t.position=l}else t.position=new Cs;return t.heading=e.heading!=null?e.heading:om.heading,t.tilt=e.tilt!=null?e.tilt:om.tilt,uf(s,null,t,i)}async function WR(s,e,t,i,r){if(e.heading!=null||e.rotation!=null||e.scale!=null||e.tilt!=null||e.zoom!=null||e.zoomFactor!=null){const a=Hl(s),{spatialReference:n,renderSpatialReference:o}=s,l=new Cs({spatialReference:n});return tw(a.center,o,l)?I_(s,e,l,t,i,r):r}return r.scale=s.scale,r.camera=s.camera.clone(),Rp(r.camera,e),r}async function QR(s,e,t,i,r,a){a.targetGeometry=t.clone();const n=Hl(s);Dl(s,n,i);const o=Rp(i,e)?Js.LOCKED:Js.ADJUST;return a.camera=await u1(s,t,i.heading,i.tilt,o,r),a}function YR(s,e,t,i,r){let a=0;t.z!=null?a=t.z:s.basemapTerrain&&s.elevationProvider&&(a=Bg(s.elevationProvider,t)),ce(Ot,t.x,t.y,a),JE(s.spatialReference,Ot,Tv,s.renderSpatialReference),Og(hu,Tv),Mc(hu,hu),Nl(nh);const n=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let f=0;f<n.length;f++){const g=n[f];let y=i[g[2]];isFinite(y)||(y=a),ce(Ot,i[g[0]],i[g[1]],y),Ll(Ot,s.spatialReference,Ot,s.renderSpatialReference),C_(nh,jr(Ot,Ot,hu))}const o=sO(nh),l=sw(nh),h=rO(nh),u=1/Math.tan(e.fovX/2),d=1/Math.tan(e.fovY/2),p=.5*Math.sqrt(o*o+h*h)*Math.max(d,u)+.5*l,_=.5*l*d+.5*Math.max(o,h);return Math.max(p,_)/r}async function ZR(s,e,t,i,r,a,n,o){o.targetGeometry=t.clone();const l=Hl(s),h=YR(s,l,t,i,r);Dl(s,l,a);const u=Rp(a,e)?Js.LOCKED:Js.ADJUST;return o.camera=await wg(s,o.targetGeometry,h,a,u,n),o.scale=Al(s,h),o}function XR(s,e){if(!e||!s.spatialReference)return null;const t={target:void 0};return"declaredClass"in e||Array.isArray(e)?t.target=e:(Object.assign(t,e),!t.target&&"center"in e&&e.center&&(t.target=e.center)),t}function An(s){return(s==null?void 0:s.camera)!=null&&(s.rotation=Mp(s.camera.heading)),s}function KR(s,e){const t=VR;if(!e.length)return t;let i=Number.NEGATIVE_INFINITY;for(let r=0;r<e.length;r++){const a=e[r].screenSpaceBoundingRect;i=Math.max(i,Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2]),Math.abs(a[3]))}return t-i/Math.min(s.width,s.height)*2}class JR{constructor(){this.hasZ=!1,this.boundingBox=Nl(),this.screenSpaceObjects=new Array}}const Ot=v(),Tv=It(),hu=ia(),nh=Ic(),eA=pi(),op=v(),cu=v(),nm=v(),om={heading:0,tilt:0},Rs=new Cs,tA={point(s,e,t){t[0]=s.x,t[1]=s.y,s.z!=null&&(t[2]=s.z),e(t)},polygon(s,e,t){const i=s.hasZ;for(let r=0;r<s.rings.length;r++){const a=s.rings[r];for(let n=0;n<a.length;n++)t[0]=a[n][0],t[1]=a[n][1],i&&(t[2]=a[n][2]),e(t)}},polyline(s,e,t){const i=s.hasZ;for(let r=0;r<s.paths.length;r++){const a=s.paths[r];for(let n=0;n<a.length;n++)t[0]=a[n][0],t[1]=a[n][1],i&&(t[2]=a[n][2]),e(t)}},multipoint(s,e,t){const i=s.points,r=s.hasZ;for(let a=0;a<i.length;a++)t[0]=i[a][0],t[1]=i[a][1],r&&(t[2]=i[a][2]),e(t)},extent(s,e,t){s.zmin!=null&&s.zmax!=null?(e(ce(t,s.xmin,s.ymin,s.zmin)),e(ce(t,s.xmax,s.ymin,s.zmin)),e(ce(t,s.xmin,s.ymax,s.zmin)),e(ce(t,s.xmax,s.ymax,s.zmin)),e(ce(t,s.xmin,s.ymin,s.zmax)),e(ce(t,s.xmax,s.ymin,s.zmax)),e(ce(t,s.xmin,s.ymax,s.zmax)),e(ce(t,s.xmax,s.ymax,s.zmax))):(e(ce(t,s.xmin,s.ymin,t[2])),e(ce(t,s.xmax,s.ymin,t[2])),e(ce(t,s.xmin,s.ymax,t[2])),e(ce(t,s.xmax,s.ymax,t[2])))}},qH=Object.freeze(Object.defineProperty({__proto__:null,create:ix,fromCamera:tx,toCameraAsync:Jw,toCameraSync:Kw},Symbol.toStringTag,{value:"Module"}));let iA=class{constructor(e,t,i){this._target=e,this._options=t,this.view=i,this.state="pending",this._animationController=null,this.promise=new Promise((r,a)=>{this._resolveCallback=r,this._rejectCallback=a;const n=new AbortController;this._options.signal!=null&&pp(this._options.signal,()=>this.abort()),this._abortController=n,this._waitForReady()})}_resolve(e){if(this.state!=="finished")return this.state="finished",this._resolveCallback(e)}_reject(e){if(this.state!=="finished")return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),this.state==="wait-for-animation-finish"&&!e&&this._animationController!=null&&this.view.state.cameraController===this._animationController&&this._animationController.running&&this._animationController.stopController(),this._reject(_r())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await l_(()=>this.view.ready,this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()}async _createViewPoint(){if(this.state!=="finished"){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{const e=await ix(this.view,this._target,this._abortController.signal);if(this.state==="finished")return;const t=e?this._getCameraFromViewpoint(e):null;if(t==null)return;if(this._options.animate){if(this._animationController==null)return;this._startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}}_getCameraFromViewpoint(e){var a;const t=!!(this._target instanceof un&&this._target.camera||this._target instanceof ta),i=e.camera;if(i==null)return null;if(!this.view.stateManager.isCompatible(i)){const n=i.position,o=n&&n.spatialReference,l=o?o.wkid:"none",h=(a=this.view.spatialReference)==null?void 0:a.wkid;return this._reject(new Ri("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${l}, view: ${h})`,{camera:i})),null}const r=wa(this.view,i);return r==null?(this._reject(new Ri("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:r,isFullySpecified:t}}_startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(i==null)return void this._reject(new Ri("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.running||t.viewAnimation==null||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new kh({view:this.view,desiredCamera:e.camera}),ql(this.view,e.camera,er.EYE_AND_CENTER)):At(this.view,e.camera),t.begin(e.camera,this._options);const a=()=>{const o=this.view.state.cameraController;r&&(o&&o.running?ov(o)&&o.viewAnimation!=null&&o.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=r):t.viewAnimation!=null&&t.viewAnimation.target===e.viewpoint&&t.state===ct.Finished&&(this.view.state.cameraController=r))},n=o=>{if(this.view.state!=null)switch(t.state){case ct.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case ct.Ready:case ct.Rejected:case ct.Running:case ct.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(o)}}};i.when(a,o=>n(o)),t.asyncResult={resolve:()=>n(),reject:o=>n(o)}}_getAnimationController(){let e=null,t=null;const i=this.view.state.cameraController;return ov(i)&&(i.updateStateFromViewAnimation(),i.running&&(e=i,t=e.viewAnimation)),e==null&&(e=new so({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e),e.state===ct.Rejected)?(t==null||t.stop(),this._reject(new Ri("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null):e}},Lt=class extends Re{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=Sv,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:t=>this._devicePixelRatioOverride=t,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return this.renderState!=null},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(t){this.viewStateManager._idleTimeout=t?Sv:0}},this._propertiesPool=new yn({frustum:m1},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new sA}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([Aa(()=>this.view.state.events,"before-camera-change",e=>e&&this._updateElevation(e)),O(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},(e,t)=>this._cameraChangedHandler(e,t),Ge)]),Pl(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([mp({prepare:()=>this._prepareFrame()}),O(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(du)}),Aa(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=se(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=Dl(this.view,this.view.state.camera,lm);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){var t,i;this._updatePropertyBeforeReady("camera",e)||((t=this.view.elevationProvider)==null||t.enableCache(!0),this.setStateCamera(wa(this.view,e),{applyConstraints:!1})||pe.getLogger(this).error("#camera=","Invalid camera",e),(i=this.view.elevationProvider)==null||i.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=Dl(this.view,this.view.state.contentCamera,lm);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=wa(this.view,e);t!=null?(this._updateElevation(t),this.view.state.contentCamera=t):this.view.state.contentCamera=null}installContentCameraReset(e){if(this.removeHandles(hm),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=CT(this.view.state.camera.center),a=e.sticky?this.contentCamera.clone():null;return this.addHandles([O(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles(hm),this.test.contentCameraResetState.clear())}),O(()=>this.zoom,n=>{n!==void 0&&t!==void 0&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(n-t)/2),Math.abs(n-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=a))}),O(()=>this.view.state.camera,n=>{const o=rn(r,n.center);this.test.contentCameraResetState.set("camera.center",o/i),o>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=a)})],hm),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){var t;this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():pe.getLogger(this).error("#center=","Invalid center",e):pe.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e):pe.getLogger(this).error("#center=","Center may not be null or undefined"))}get visibleArea(){if(!this.ready){const e=this._get("extent");return e?$T.fromExtent(e):null}return SS(this.view,this.view.pointsOfInterest.focus.renderLocation)}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=o1(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return t??this._get("extent")}set extent(e){var t;this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||pe.getLogger(this).error("#extent=","Invalid extent",e):pe.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e):pe.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){var t;const e=this.view.map;return e&&"initialViewProperties"in e?(t=e.initialViewProperties)==null?void 0:t.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(!this.ready)return this._get("scale");const e=this.view.basemapTerrain.tilingScheme,t=this.view.pointsOfInterest.cameraOnSurface.scale;return e&&t?PS(this.view,t,this.view.state.contentCamera,e):this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||pe.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),a=Math.round(t[vs.TOP]/i),n=Math.round(t[vs.RIGHT]/i),o=Math.round(t[vs.BOTTOM]/i),l=Math.round(t[vs.LEFT]/i);return r!=null&&r.top===a&&r.right===n&&r.bottom===o&&r.left===l?r:{top:a,right:n,bottom:o,left:l}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,uu),this.view.state.updateCamera(t=>t.padding=uu))}_paddingToArray(e,t,i){e?vn(i,e.top||0,e.right||0,e.bottom||0,e.left||0):vn(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t)}get screenCenter(){const e=this.padding;return Wb((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?tx(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){var t;if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||pe.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{const i=e.camera!=null?e.camera.position:e.targetGeometry,r=i!=null&&i.spatialReference;pe.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(r?r.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e)}else pe.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?ES(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||e===void 0||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||pe.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){var r;if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const i=(r=this.view._stage.renderView.renderingContext)==null?void 0:r.parameters.maxTextureSize;return i&&$g(this._tmpCanvasSize,i),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return this._devicePixelRatioOverride!=null?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){var e,t;return((t=(e=this.view)==null?void 0:e._stage)==null?void 0:t.renderer.isFeatureEnabled(Gr.PhysicalPixelRendering))??!1}get _usePhysicalPixelRenderingAny(){var t,i;const e=(i=(t=this.view)==null?void 0:t._stage)==null?void 0:i.renderer;return e&&(e.isFeatureEnabled(Gr.PhysicalPixelRendering,Oi.IDLE)||e.isFeatureEnabled(Gr.PhysicalPixelRendering,Oi.INTERACTING)||e.isFeatureEnabled(Gr.PhysicalPixelRendering,Oi.ANIMATING))}preinit(e){var t,i,r;return!(this._isOverridden("center")&&!Jo(this.center.spatialReference,e))&&!(this._isOverridden("camera")&&!Jo(this.camera.position.spatialReference,e))&&!(this._isOverridden("extent")&&!Jo(this.extent.spatialReference,e))&&!!(!this._isOverridden("viewpoint")||Jo((t=this.viewpoint.targetGeometry)==null?void 0:t.spatialReference,e)&&Jo((r=(i=this.viewpoint.camera)==null?void 0:i.position)==null?void 0:r.spatialReference,e))}init(){this._constraintsManager=new Oh({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const t=this._initialViewpoint||this.view.initialExtent;t&&this.isCompatible(t)?this._setInitialView(t):this.view.state.viewingMode===Ne.Local&&this.addHandles(Pl(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(du),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),du)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(du),this._constraintsManager=se(this._constraintsManager))}async goTo(e,t){return t={animate:!0,...t},this._gotoOperation!=null&&this._gotoOperation.abort(t.animate),this._gotoOperation=new iA(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera(Hl(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t==null?void 0:t.cameraController;i&&(t.updateCamera(r=>i.stepController(e,r)),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){this._gotoOperation!=null&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of aA){const a=e.has(i),n=this._isOverridden(i);!a&&n&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(a||n)&&r.forEach(o=>e.add(o))}return t}_setInitialView(e){if(e==null||this._cameraSetByUser)return;if(e instanceof ta)return void this.setStateCamera(wa(this.view,e),{applyConstraints:!1});if(e instanceof un){if(e.targetGeometry instanceof dr){const a=ju(this.view,e.targetGeometry,0,.5,Js.LOCKED);return void(a!=null&&this.setStateCamera(wa(this.view,a),{applyConstraints:!0}))}const i={applyConstraints:!e.camera},r=this._viewpointToCamera(e);return void this.setStateCamera(r,i)}const t=ju(this.view,e,0,.5,Js.LOCKED);t!=null&&this.setStateCamera(wa(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&rA.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return e!=null&&(e instanceof un?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof ta?this.isCompatible(e.position):e.spatialReference&&!OT(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=nA){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=ka){const{heading:r,tilt:a}=this._getPreservingHeadingTilt(),n=OS(this.view,r,a,e,t,Js.ADJUST);return n==null?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)}_centerToCamera(e){let t;if(e.hasZ)t=this.view.state.camera.distance;else{const{centerOnContent:i}=this.view.pointsOfInterest;i.runTask(),t=i.distance}return this._centerPointAtDistanceToCamera(e,t)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=ju(this.view,e,t,i,Js.ADJUST,lm);return r?wa(this.view,r):null}_scaleToCamera(e){if(e==null)return null;const t=this.view,i=t.pointsOfInterest.centerOnContent;i.runTask();const r=i.renderLocation,a=t.pointsOfInterest.cameraOnSurface.renderLocation,n=MS(t,e,t.state.contentCamera,r,a);return this._centerPointAtDistanceToCamera(r,n)}_zoomToCamera(e){return this._scaleToCamera(p1(this.view,e))}_viewpointToCamera(e){return wa(this.view,Kw(this.view,e))}setStateCamera(e,t){return!(e==null||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up,i.fov=e.fov):i.copyFrom(e),t.applyConstraints&&At(this.view,i)}),t.applyConstraints||(this.view.state.cameraController=new kh({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._computeCanvasSize();if(i.width!==0&&i.height!==0&&(t.width===i.width&&t.height===i.height||(t.width=i.width,t.height=i.height),this.view.state)){const r=this.view.state.camera;r.fullWidth===i.width&&r.fullHeight===i.height&&r.pixelRatio===i.pixelRatio||(ka.copyFrom(r),ka.pixelRatio!==i.pixelRatio&&(this._paddingToArray(this.padding,i.pixelRatio,uu),ka.padding=uu),ka.fullWidth=i.width,ka.fullHeight=i.height,ka.pixelRatio=i.pixelRatio,this.view.state.camera=ka),this._updateViewState()}}_updateElevation(e){var a,n;const t=(a=this.view.basemapTerrain)==null?void 0:a.spatialReference,i=((n=this.view.renderCoordsHelper)==null?void 0:n.getAltitude(e.eye))??0,r=t?bg(this.view,e.eye):0;e.relativeElevation=i-r}_updateViewState(){this.test.renderState!=null?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=Oi.ANIMATING:this.view.interacting?this.view.state.mode=Oi.INTERACTING:(this.view.state.mode===Oi.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=Oi.INTERACTING:this.view.state.mode=Oi.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};c([m({type:ta,dependsOn:["view.state.camera","ready"]})],Lt.prototype,"camera",null),c([m({type:ta,dependsOn:["view.state.contentCamera","ready"]})],Lt.prototype,"contentCamera",null),c([m({type:Cs})],Lt.prototype,"center",null),c([m()],Lt.prototype,"visibleArea",null),c([m({type:dr})],Lt.prototype,"extent",null),c([m({readOnly:!0})],Lt.prototype,"frustum",null),c([m()],Lt.prototype,"_constraintsManager",void 0),c([m({readOnly:!0})],Lt.prototype,"constraintsManager",null),c([m()],Lt.prototype,"_initialViewpoint",null),c([m({readOnly:!0})],Lt.prototype,"hasInitialView",null),c([m({readOnly:!0,type:Boolean})],Lt.prototype,"ready",void 0),c([m({type:Number})],Lt.prototype,"scale",null),c([m()],Lt.prototype,"padding",null),c([m({readOnly:!0})],Lt.prototype,"screenCenter",null),c([m({constructOnly:!0})],Lt.prototype,"view",void 0),c([m({type:un})],Lt.prototype,"viewpoint",null),c([m({type:Number})],Lt.prototype,"zoom",null),c([m({readOnly:!0})],Lt.prototype,"_rasterPixelRatio",null),c([m({readOnly:!0})],Lt.prototype,"_usePhysicalPixelRendering",null),c([m({readOnly:!0})],Lt.prototype,"_usePhysicalPixelRenderingAny",null),c([m()],Lt.prototype,"_windowDevicePixelRatio",void 0),c([m()],Lt.prototype,"_devicePixelRatioOverride",void 0),Lt=c([F("esri.views.3d.state.ViewStateManager")],Lt);let sA=class{constructor(){this.width=0,this.height=0,this.pixelRatio=1}};const rA=new Set(["camera","viewpoint","extent","scale","center","zoom"]),aA=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],nA={heading:0,tilt:0},lm=new ta,ka=new Pt,uu=Mi(),du="pending-initial-view",hm="content-camera-reset",Sv=300,Pv=100;let fr=class extends Pa{constructor(){super(...arguments),this.startCamera=new Pt,this.currentCamera=new Pt,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<Pv}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=ct.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout(()=>this.notifyChange("isInteractive"),Pv),this.view.state.updateCamera(e=>this.stepController(0,e)),this.steppingFinished&&this.finishController()}};c([m({readOnly:!0})],fr.prototype,"isInteractive",null),c([m()],fr.prototype,"_lastInteraction",void 0),fr=c([F("esri.views.3d.state.controllers.InteractiveController")],fr);var bs;(function(s){s[s.CENTER=0]="CENTER",s[s.EYE=1]="EYE"})(bs||(bs={}));let jh=class extends fr{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=bs.CENTER,this._rotScale=0,this._lastPoint=Ts(),this._tmpWorldUp=v(),this._tmpViewDir=v(),this._tmpRotCurPoint=Ts(),this._tmpTransf=It(),this._tmpAxis=v(),this._tmpPivotPoint=v(),this._pivotPos=v(),this._constraintOptions=new Is(nt.ALL,Oe.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===bs.CENTER?3:1.5}begin(e){if(this.running){switch(this.pivot){case bs.EYE:le(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=Oe.LOOK_AROUND,this._constraintOptions.tiltMode=aa.LOOK_AROUND,this._constraintOptions.selection=nt.NONE;break;case bs.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.map.ground.opacity===0?Po:{});t||le(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=Oe.TUMBLE,this._constraintOptions.tiltMode=aa.TUMBLE,this._constraintOptions.selection=nt.ALL&~nt.DISTANCE;break}}lo(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const i=this.startCamera,r=v();ye(r,this._pivotPos,i.eye);const a=we(r),n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,Ev);let o=Math.max(Math.min(pR,1/Math.abs(oe(Ev,i.viewForward)))*n,mR);t&&(o=Math.min(a,o));const l=ri(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),h=Fc(this.startCamera,l,this.view.renderCoordsHelper,this.view.viewingMode);let u=this.view._stage.renderView.getMinimalDepthForArea(Tc(this.view),i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*Jp,Jp),d=this.view._stage.renderView.getMinimalDepthForArea(Tc(this.view),e[0],e[1],i,Jp);u==null&&d==null||(u=u??d??0,d=d==null||h===$i.Horizontal?u:d,o=u>d?d:u,o=t?Math.min(o,a):o),ie(r,r),le(this._pivotPos,ue(this._tmpPivotPoint,i.eye,ee(this._tmpPivotPoint,r,o)))}update(e){if(this.running){switch(this.pivot){case bs.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case bs.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}At(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),lo(e,t,this._tmpRotCurPoint);let a=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,n=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;ye(this._tmpViewDir,i,r);const o=we(this._tmpViewDir),l=mn(oe(this._tmpViewDir,this._tmpWorldUp)/o);if(this.pivot===bs.EYE){a*=-.5;const h=.5*Math.PI-l,u=.5*Math.PI*.99;a=h-Math.max(-u,Math.min(u,h+a))}return a=Q(a+l,Ei.min,Ei.max)-l,pt(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===bs.CENTER&&(n=-n),go(this._tmpTransf,n,this._tmpWorldUp),Ma(this._tmpTransf,this._tmpTransf,a,this._tmpAxis),Gt(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=Gt(cm,e.up,this._tmpTransf),ue(cm,r,this._tmpViewDir),_n(this._lastPoint,this._tmpRotCurPoint),cm}};c([m()],jh.prototype,"pivot",void 0),jh=c([F("esri.views.3d.state.controllers.RotateController")],jh);const cm=v(),Ev=v();let um=class extends oa{constructor(e,t,i,r){super(!0),this._view=e,this.pointerActions=t,this._pivot=i,this.registerIncoming("drag",r,a=>this._handleDrag(a))}_handleDrag(e){const t=e.data;if(t.pointers.size>1||!vg(e.data,this.pointerActions))return;const i=ri(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new jh({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}};const pu="esri-fov-overlay",mu={base:pu,outer:`${pu}-outer`,reset:`${pu}-reset`,text:`${pu}-text`};let fa=class extends hT{constructor(e){super(e),this.onReset=()=>{},this._messagesCommon=null,this._messagesUnits=null,this.fov=null}render(){return kc("div",{class:mu.outer},kc("div",{class:mu.base},kc("p",{class:mu.text},this._overlay),kc("p",{class:mu.reset,onclick:this.onReset,title:this._messagesCommon.reset},this._reset)))}get _overlay(){const{fov:e,_messagesUnits:t}=this;if(!t||e==null)return"";const i=hO(sc(e),"degrees","arithmetic","arithmetic",0),r=oA/(2*Math.tan(e/2));return`${i} | ${cO(t,r,"millimeters",0,"abbr")} |`}get _reset(){return this._messagesUnits&&this.fov!=null?"↺":""}};c([m()],fa.prototype,"onReset",void 0),c([m(),Xf("esri/t9n/common")],fa.prototype,"_messagesCommon",void 0),c([m(),Xf("esri/core/t9n/Units")],fa.prototype,"_messagesUnits",void 0),c([m()],fa.prototype,"fov",void 0),c([m()],fa.prototype,"_overlay",null),c([m()],fa.prototype,"_reset",null),fa=c([F("esri.widgets.FovOverlay")],fa);const oA=Math.sqrt(1872);let Tl=class extends fr{constructor(e){super(e),this.onStop=null,this._timeOutId=void 0,this._onReset=()=>{this._startSize=this._lastDrag=null,this._setFov(lA),this.updateTimeout()},this._center=v(),this._viewForward=v(),this._constraints=new Is(nt.ALL,Oe.ZOOM)}begin(e){uA(e)?this._showOverlay().fov=e.fov:(this._lastDrag=e[1],this._startSize=null,this._ensureStartSize(this.view.state.camera))}updateTimeout(){clearTimeout(this._timeOutId),this._timeOutId=setTimeout(this.onStop,1500)}update(e){if(this._lastDrag==null)return this._lastDrag=e[1],this._startSize=null,void this._ensureStartSize(this.view.state.camera);const t=-(this._lastDrag-e[1])/2;this._lastDrag=e[1],this.step(t)}step(e){if(!this.running)return void(this._startSize=this._lastDrag=null);const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=sc(i.fov)+e,a=Rt(Q(r,hA,cA));a!==i.fov?this._setFov(a):this._showOverlay().fov=i.fov}finish(){this.running&&(this._startSize=this._lastDrag=null,this.finishController())}destroy(){this.hideOverlay()}onControllerEnd(e){super.onControllerEnd(e),this._startSize=this._lastDrag=null,this.hideOverlay()}_showOverlay(){return this._overlay||(this._overlay=new KT({id:"esri.FovOverlay",node:new fa({onReset:this._onReset})}),this.view.ui.add(this._overlay)),this._overlay.widget}hideOverlay(){this._overlay&&(this.view.ui.remove(this._overlay),this._overlay=se(this._overlay))}_setFov(e){const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=this._ensureStartSize(i)/Math.tan(e/2),a=ue(dm,this._center,ee(dm,this._viewForward,-r));i.eye=a,i.fov=e,this._constraints.interactionStartCamera=t.camera,this._constraints.interactionFactor=Qs(this.currentCamera.height-t.camera.height),At(this.view,this.currentCamera,this._constraints),this.begin(i),this.commitCamera()}_ensureStartSize(e){if(this._startSize==null){le(this._viewForward,e.viewForward);const t=this.view._stage.renderView.getMinimalDepthForArea(null,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,Vc),i=vi(e.eye,this.view.pointsOfInterest.centerOnContent.renderLocation),r=t??i;ue(this._center,e.eye,ee(dm,this._viewForward,r)),this._startSize=r*Math.tan(e.fov/2)}return this._startSize}};c([m()],Tl.prototype,"onStop",void 0),Tl=c([F("esri.views.3d.state.controllers.FovController")],Tl);const lA=Rt(new ta().fov),hA=10,cA=150,dm=v();function uA(s){return!Array.isArray(s)}let L_=class extends fr{constructor(){super(...arguments),this._pickPoint=v(),this._tmpP0=Ts(),this._panAxisAngle=Op(),this._tmpRayDir=v(),this._tmpRayDirPick=v(),this._targetOnSphere=v(),this._navMode=$i.Horizontal,this._tmpRay={origin:v(),direction:v()},this.dragBeginPoint=ri(),this._normalizedAnchorPoint=Ts(),this._constraintOptions=new Is(nt.ALL_EXCEPT_COLLISION,Oe.ZOOM,0,this.startCamera),this._sphere=Sr(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;_n(this.dragBeginPoint,e),lo(this.startCamera,e,this._normalizedAnchorPoint);const t=Dt(this.view.spatialReference),i=Gw(this._intersectionHelper,this.startCamera,e,t,Vl.Ellipsoid,this.view.map.ground.opacity===0?Po:{});if(this._navMode=Fc(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===$i.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let r;Gl(this.startCamera,e,this._tmpRay),ie(this._tmpRay.direction,this._tmpRay.direction),i.scenePickPoint!=null&&(ye(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),r=we(this._tmpRayDirPick));const a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,Ov);let n=Q(Math.min(Iw,1/Math.abs(oe(Ov,this._tmpRay.direction)))*a,ep[0],ep[1]);const o=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,Vc);n=o??n,n=r!=null?Math.min(n,r):n,this._hasPickPoint=!0,ee(this._tmpRay.direction,this._tmpRay.direction,n),ue(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.running){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===$i.Horizontal){ye(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=we(this._tmpRayDir);lo(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**i;const a=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<a&&(r=a),Math.abs(t-r)<1e-6)return;if(this._hasPickPoint&&r<t){const n=1-(1-r/t)*(1-this._sphere[3]/we(this.currentCamera.center));this.currentCamera.center=ee(_u,this.currentCamera.center,n)}ee(this._tmpRayDir,this._tmpRayDir,-r/t),this.currentCamera.eye=ue(_u,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=Qs(cc(this.dragBeginPoint,e)),At(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(Cc(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),rf(this._pickPoint,this._targetOnSphere,this._panAxisAngle),wn(this.currentCamera,wt(this._sphere),this._panAxisAngle))}else{const t=we(this._tmpRay.direction);lo(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**i;const a=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<a&&(r=a),Math.abs(t-r)<1e-6)return;ee(this._tmpRayDir,this._tmpRay.direction,1-r/t),this.currentCamera.eye=ue(_u,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=ue(_u,this.currentCamera.center,this._tmpRayDir)}ql(this.view,this.currentCamera),this.commitCamera()}}finish(){this.running&&this.finishController()}};L_=c([F("esri.views.3d.state.controllers.ZoomControllerGlobal")],L_);const _u=v(),Ov=v();let N_=class extends fr{constructor(){super(...arguments),this._tmpP=v(),this._tmpDir=v(),this._tmpN=v(),this._tmpP0=Ts(),this._tmpPoi=v(),this._tmpRayDir=v(),this.dragBeginPoint=ri(),this._normalizedAnchorPoint=Ts(),this._constraintOptions=new Is(nt.ALL,Oe.ZOOM,0,this.startCamera,v()),this._plane=mc()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;_n(this.dragBeginPoint,e),lo(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.map.ground.opacity===0?Po:{});ye(this._tmpDir,this._tmpP,this.startCamera.eye);const i=we(this._tmpDir);ie(this._tmpDir,this._tmpDir);const r=Math.abs(this.view.camera.position.z);let a=Q(Math.min(Iw,1/Math.abs(oe(dA,this._tmpDir)))*r,ep[0],ep[1]);const n=this.view._stage.renderView.getMinimalDepthForArea(Tc(this.view),e[0],e[1],this.view.state.camera,Vc);a=n??a,a=t?Math.min(a,i):a,ee(this._tmpDir,this._tmpDir,a),ue(this._tmpP,this.startCamera.eye,this._tmpDir),ye(this._tmpN,this.startCamera.eye,this.startCamera.center),ie(this._tmpN,this._tmpN),this._tmpN[1]<0&&an(this._tmpN,this._tmpN),Y1(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.running)return;_R(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||le(this._tmpPoi,this.currentCamera.center),lo(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);_n(this._normalizedAnchorPoint,this._tmpP0),ye(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const i=we(this._tmpRayDir);let r=i*(1-t);this._constraintOptions.interactionDirection&&(le(this._constraintOptions.interactionDirection,this._tmpRayDir),ee(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/i));const a=this.view.state.constraints.minimumPoiDistance;t>=0&&r<a&&(r=a,t=-(r-i)/i),Math.abs(i-r)<1e-6||(ee(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=ue(Dn,this.currentCamera.eye,this._tmpRayDir),Tr(Dn,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?Dn[2]=Math.max(this.startCamera.center[2],Dn[2]):Dn[2]=Math.min(this.startCamera.center[2],Dn[2]),this.currentCamera.center=Dn,this._constraintOptions.interactionFactor=Qs(cc(this.dragBeginPoint,e)),At(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}finish(){this.running&&this.finishController()}};N_=c([F("esri.views.3d.state.controllers.ZoomControllerLocal")],N_);const Dn=v(),dA=Vt(0,0,1);let pA=class extends oa{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._fovModifier=i,this.registerIncoming("drag",[i],r=>this._handleZoom(r)),this.registerIncoming("drag",r=>this._handleZoom(r))}_handleZoom(e){var r,a;const t=e.data;if(t.pointers.size>1||!vg(e.data,this.pointerActions))return;const i=ri(t.center.x,t.center.y);switch(t.action){case"start":{(r=this._cameraController)==null||r.finish();const n=this._view,o=e.modifiers.has(this._fovModifier);this._cameraController=o?new Tl({view:n,onStop:()=>this._stopController()}):n.state.isGlobal?new L_({view:n}):new N_({view:n}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break}case"update":(a=this._cameraController)==null||a.update(i);break;case"end":this._cameraController instanceof Tl?this._cameraController.updateTimeout():this._stopController()}e.stopPropagation()}_stopController(){var e;(e=this._cameraController)==null||e.finish(),this._cameraController=null}},ro=class extends fr{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new Pt,this._headingStart=0,this._constraintOptions=new Is(nt.ALL,Oe.NONE,0,new Pt,null,aa.LOOK_AROUND)}handleEventGamepad(e){const t=oy(e,this.view.navigation.gamepad,this._transformation);(e.action==="end"||zp(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,ly(this._keysButtonState,this._transformation)}directionActive(e){return this._keysButtonState[e]===1}countActiveDirections(){return this._keysButtonState.reduce((e,t)=>t>0?e+1:e,0)}deactivateDirection(e){this._keysButtonState[e]=0;const t=ly(this._keysButtonState,this._transformation);zp(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this._filteredSurfaceElevation+=i*(t-this._filteredSurfaceElevation)*e}stepController(e,t){var i;this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),(i=this._constraintOptions.interactionStartCamera)==null||i.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,$n),this._applyDisabledMovementTypes($n),this._applyPan($n.pan),this._applyRotate($n.rotate),this._applyZoom($n.zoom),this._applyAscend($n.ascend),this._constraintOptions.interactionType=Oe.NONE,this._constraintOptions.selection=nt.COLLISION,At(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){this._transformation.heading!==0&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;ye(Ji,t.center,t.eye),Gt(Ji,Ji,e.matrix),t.center=ue(Ji,Ji,t.eye),t.up=Gt(Ji,t.up,e.matrix),this._constraintOptions.interactionType=Oe.LOOK_AROUND,this._constraintOptions.selection=nt.ALL_EXCEPT_COLLISION,At(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=Gt(Ji,t.eye,e.matrix),t.center=Gt(Ji,t.center,e.matrix),this.view.state.isGlobal&&(t.up=Gt(Ji,t.up,e.matrix)),this._constraintOptions.interactionType=Oe.PAN,this._constraintOptions.selection=nt.ALL,At(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=ue(Ji,this.currentCamera.eye,ee(Tt.get(),t,e)),le(oh,t),an(oh,oh),this._constraintOptions.interactionDirection=oh,this._constraintOptions.interactionType=Oe.ZOOM,this._constraintOptions.selection=nt.ALL_EXCEPT_COLLISION,At(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Tt.get());if(this._constraintOptions.interactionDirection=le(oh,t),this.view.state.isGlobal){const i=we(this.currentCamera.eye),r=(i+e)/i;this.currentCamera.eye=ee(Ji,this.currentCamera.eye,r),this.currentCamera.center=ee(Ji,this.currentCamera.center,r)}else{const i=ee(Tt.get(),t,e);this.currentCamera.eye=ue(Ji,this.currentCamera.eye,i),this.currentCamera.center=ue(Ji,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=Oe.ASCEND,this._constraintOptions.selection=nt.COLLISION,At(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=nt.ALL_EXCEPT_COLLISION,At(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){bA(i);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,Ji)}_calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:a}=t,n=this._transformation,o=this.view.navigation.gamepad,l=ce(Tt.get(),a[0],a[1],0);ie(l,l);const h=n.translation[0]*e.pan;if(h!==0){const g=ee(Tt.get(),r,h);lc(i.pan.matrix,i.pan.matrix,g),i.pan.enabled=!0}switch(o.mode){case"pan":{const g=-n.translation[1]*e.pan;if(g!==0){const y=ee(Tt.get(),l,g);lc(i.pan.matrix,i.pan.matrix,y),i.pan.enabled=!0}i.zoom=n.zoom*e.zoom;break}case"zoom":i.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:Ec(o.mode)}const u=n.translation[2]*e.ascend;i.ascend=u;const d=-n.heading*e.rotate;d!==0&&(Ma(i.rotate.matrix,i.rotate.matrix,d,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,Tt.get())),i.rotate.enabled=!0);const p=n.tilt*e.rotate,_=pn(this.view.renderCoordsHelper,t.center,t.eye),f=Q(_+p,Ei.min,Ei.max)-_;f&&(Ma(i.rotate.matrix,i.rotate.matrix,f,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:a}=t,n=this._transformation,o=this.view.navigation.gamepad,l=pt(Tt.get(),a,r);ie(l,l),an(l,l),wR(this.startCamera,t,n,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan($n.pan,this._tmpCamera);const h=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,u=n.translation[2]*e.ascend;i.ascend=u;const d=-n.heading*e.rotate;d!==0&&(Ma(i.rotate.matrix,i.rotate.matrix,d,this._tmpCamera.eye),i.rotate.enabled=!0);const p=n.tilt*e.rotate,_=this._clampTiltDeltaGlobalToValidRange(p,t.ray,h);_!==0&&(Ma(i.rotate.matrix,i.rotate.matrix,_,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const r=Dt(this.view.spatialReference),a=ed(Ei.min,t.origin,i,r);let n=0,o=0;const l=Tt.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,l)){const h=pn(this.view.renderCoordsHelper,l,t.origin);n=ed(h,t.origin,i,r),o=ed(Ei.max,t.origin,i,r)}else{Pp(Fg(Ug,i+r.radius),t,l);const h=Math.PI+W1(t.direction,l);n=hv(h,t.origin,i,r),o=hv(Ei.max,t.origin,i,r)}return Q(n+e,a,o)-n}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,a=r.getAltitude(e),n=t+Math.abs(a-t);return r.setAltitude(i,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:a}=RS(this.view,t,0,ax,vA),n=i.intersectManifoldClosestSilhouette(Il(t,a),e,Tt.get()),o=vi(t,n),l=i.intersectManifoldClosestSilhouette(Il(t,Pg(Tt.get(),t,r.center)),e,Tt.get()),h=vi(t,l);return Math.min(o,h)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:a}=i,n=t.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,Tt.get());if(a){const o=ye(Tt.get(),e,n),l=we(o);ee(o,o,1/l);const h=ie(Tt.get(),e),u=mn(oe(h,o));return l*Math.sin(Math.min(_A,u))}{const o=le(Tt.get(),e);return t.setAltitude(o,this._filteredSurfaceElevation),vi(n,o)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:gA}_computeVelocities(e){const t=this._filteredSurfaceElevation,i=t+Dt(this.view.spatialReference).radius,{camera:r,isGlobal:a}=this.view.state,n=Tt.get(),o=this._getPointAbsoluteSurfaceElevation(r.eye,t,n),l=this._clampedDistanceToSurface(t,n),h=r.width/2,u=Mv*r.width,d=Mv*r.width,p=l*Math.tan(.5*r.fovX)/h,_=p/i,f=p/this._computeHeadingRotateRadius(n),g=o-t;return{pan:(a?_:p)*u*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(u*e/h)*g-g),zoom:2**(u*e/h)*l-l,rotate:Q(f*d,fA,yA)*e}}_applyDisabledMovementTypes(e){this.disableMovements==null||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Gd(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Gd(e.rotate.matrix))}static activatesFor(e,t){const i=oy(t,e.navigation.gamepad,mA);return!(t.action==="end"||zp(i))}};c([m({constructOnly:!0})],ro.prototype,"gamepadDevice",void 0),c([m({constructOnly:!0})],ro.prototype,"disableMovements",void 0),ro=c([F("esri.views.3d.state.controllers.GamepadKeyboardController")],ro);const mA={translation:[0,0,0],heading:0,tilt:0,zoom:0},ax=80,_A=Rt(ax),Mv=.75,gA=5,fA=Rt(30),yA=Rt(80),$n={zoom:0,ascend:0,pan:{enabled:!1,matrix:It()},rotate:{enabled:!1,matrix:It()}},Ji=v(),oh=v(),vA=AS();function bA(s){s.zoom=0,s.ascend=0,s.pan.enabled=!1,Gd(s.pan.matrix),s.rotate.enabled=!1,Gd(s.rotate.matrix)}let wA=class extends oa{constructor(e){super(!0),this._view=e,this._watchHandles=new dg,this._handle=this.registerIncoming("gamepad",t=>this._handleEventGamepad(t)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([O(()=>this._view.navigation.gamepad.enabled,t=>{t?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},at),O(()=>this._view.navigation.gamepad.device,t=>{this._cameraControllerGamepad&&t&&this._cameraControllerGamepad.gamepadDevice!==t&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){var r;const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=(r=this._cameraControllerGamepad)==null?void 0:r.running;if(i||ro.activatesFor(this._view,e.data)){if(!i){const a=new ro({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(a),a.state!==ct.Rejected&&(this._cameraControllerGamepad=a)}this._cameraControllerGamepad&&this._cameraControllerGamepad.running&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}};var _s;(function(s){s[s.LEFT=0]="LEFT",s[s.RIGHT=1]="RIGHT",s[s.FORWARD=2]="FORWARD",s[s.BACKWARD=3]="BACKWARD",s[s.UP=4]="UP",s[s.DOWN=5]="DOWN",s[s.HEADINGLEFT=6]="HEADINGLEFT",s[s.HEADINGRIGHT=7]="HEADINGRIGHT",s[s.TILTUP=8]="TILTUP",s[s.TILTDOWN=9]="TILTDOWN",s[s.ZOOMIN=10]="ZOOMIN",s[s.ZOOMOUT=11]="ZOOMOUT"})(_s||(_s={}));let xA=class extends oa{constructor(e,t){super(!0),this._view=e,this._keyToDirection=new Map,this._keyToAction=new Map,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Ne.Local},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._addKeysMapping(t),this.registerIncoming("key-down",null,i=>this._handleKeyDown(i)),this.registerIncoming("key-up",null,i=>this._handleKeyUp(i)),this.registerIncoming("blur",null,()=>this._handleStop()),this._visibilityHandle=JT(i=>i?null:this._handleStop())}onUninstall(){var e;(e=this._visibilityHandle)==null||e.remove(),this._handleStop()}setStickyKeyDuration(e){this._stickyKeyDuration=e}_addKeysMapping(e){this._addKeyMapping(e.pan.left,_s.LEFT),this._addKeyMapping(e.pan.right,_s.RIGHT),this._addKeyMapping(e.pan.forward,_s.FORWARD),this._addKeyMapping(e.pan.backward,_s.BACKWARD),this._addKeyMapping(e.pan.up,_s.UP),this._addKeyMapping(e.pan.down,_s.DOWN),this._addKeyMapping(e.lookAround.headingLeft,_s.HEADINGLEFT),this._addKeyMapping(e.lookAround.headingRight,_s.HEADINGRIGHT),this._addKeyMapping(e.lookAround.tiltUp,_s.TILTUP),this._addKeyMapping(e.lookAround.tiltDown,_s.TILTDOWN),this._addKeyMapping(e.zoom.zoomIn,_s.ZOOMIN),this._addKeyMapping(e.zoom.zoomOut,_s.ZOOMOUT),this._addKeyAction(e.reset.heading,()=>this._resetHeading()),this._addKeyAction(e.reset.tilt,()=>this._resetTilt())}_addKeyMapping(e,t){for(const i of this._eachKey(e))this._keyToDirection.set(i,t)}*_eachKey(e){typeof e=="string"?yield e:yield*e}_addKeyAction(e,t){for(const i of this._eachKey(e))this._keyToAction.set(i,t)}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToAction.get(e.data.key);if(t!=null)return e.stopPropagation(),void t();const i=this._keyToDirection.get(e.data.key);if(i!=null&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new ro({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(e.stopPropagation(),this._cameraControllerKeyboard.directionActive(i)||(this._cameraControllerKeyboard.activateDirection(i),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(i)))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout(()=>{var r;this._stickyKeyTimeoutHandle=void 0,this._stickyDirection!=null&&this._stickyDirection!==void 0&&((r=this._cameraControllerKeyboard)==null||r.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)},this._stickyKeyDuration))}}_handleStop(){var e;(e=this._cameraControllerKeyboard)!=null&&e.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){var r,a,n;if(e.data.native.ctrlKey||e.data.native.metaKey||!((r=this._cameraControllerKeyboard)!=null&&r.running))return;const t=this._keyToDirection.get(e.data.key);if(t==null)return;e.stopPropagation();const i=this._stickyKeyTimeoutHandle===void 0;this._stickyKeyTimeoutHandle===void 0||((a=this._cameraControllerKeyboard)==null?void 0:a.countActiveDirections())!==1?((n=this._cameraControllerKeyboard)==null||n.deactivateDirection(t),i&&(this._stickyDirection=void 0)):this._stickyDirection=t}_isPanning(e){return e<=3}_resetHeading(){this._view.goTo({heading:0}).catch(()=>{})}_resetTilt(){this._view.goTo({tilt:0}).catch(()=>{})}},CA=class extends oa{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",[t],i=>this._handleFov(i)),this.registerIncoming("mouse-wheel",i=>this._handleZoom(i))}_handleZoom(e){var i;if(!this._mouseWheelZoomEnabled)return;const t=e.data;(i=this._zoomController)!=null&&i.running||(this._stopFovController(),this._zoomController=this._view.state.isGlobal?new rp({view:this._view,mode:"interaction"}):new ap({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._zoomController)),this._zoomController.step(-t.deltaY/60,ri(t.x,t.y)),e.preventDefault(),e.stopPropagation()}_handleFov(e){var t,i,r;this._mouseWheelZoomEnabled&&((t=this._fovController)!=null&&t.running||((i=this._zoomController)==null||i.finish(),(r=this._fovController)==null||r.hideOverlay(),this._fovController=new Tl({view:this._view,onStop:()=>this._stopFovController()}),this._view.state.switchCameraController(this._fovController),this._fovController.state!==ct.Rejected)?(this._fovController.updateTimeout(),this._fovController.step(e.data.deltaY/20),e.preventDefault(),e.stopPropagation()):this._stopFovController())}get _mouseWheelZoomEnabled(){return this._view.navigation.actionMap.mouseWheel==="zoom"}_stopFovController(){var e;(e=this._fovController)==null||e.finish(),this._fovController=null}},lp=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return this._value===void 0?0:this._value}update(e){this._value===void 0?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}},vo=class extends wc{constructor(){super(...arguments),this._beginCamera=new Pt,this._elapsedTimeSec=0,this.constraintOptions=new Is(nt.ALL,Oe.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new Rl}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),At(this.view,t,this.constraintOptions)}};vo=c([F("esri.views.3d.state.controllers.momentum.MomentumController")],vo);let Wh=class extends vo{constructor(e){super(e),this.interactionType=Oe.PAN,this._tmpPan=v()}momentumStep(e,t){const i=this.momentum.value(e);ee(this._tmpPan,this.momentum.direction,i),t.eye=ye(Rv,t.eye,this._tmpPan),t.center=ye(Rv,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};c([m({constructOnly:!0})],Wh.prototype,"momentum",void 0),Wh=c([F("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Wh);const Rv=v(),TA=v(),gu=v();let nd=class extends vo{constructor(e){super(e),this.interactionType=Oe.PAN}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);le(gu,t.eye),ie(gu,gu),pt(this.momentum.axis2,gu,this.momentum.axis1),jw(t,TA,this.momentum.axis1,i,this.momentum.axis2,r)}};c([m({constructOnly:!0})],nd.prototype,"momentum",void 0),nd=c([F("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],nd);let Kn=class extends vo{set center(e){this._set("center",dn(e))}set axis(e){this._set("axis",dn(e))}constructor(e){super(e),this.interactionType=Oe.TUMBLE}momentumStep(e,t){const i=this.momentum.value(e);wn(t,this.center,xc(this.axis,i))}};c([m({constructOnly:!0})],Kn.prototype,"momentum",void 0),c([m({constructOnly:!0})],Kn.prototype,"center",null),c([m({constructOnly:!0})],Kn.prototype,"axis",null),Kn=c([F("esri.views.3d.state.controllers.momentum.RotationMomentumController")],Kn);let dl=class extends vo{set zoomCenter(e){this._set("zoomCenter",dn(e))}constructor(e){super(e),this.interactionType=Oe.ZOOM,this.constraintOptions.interactionDirection=v()}momentumStep(e,t){const{interactionDirection:i}=this.constraintOptions;if(!i)return;le(i,t.eye);const r=this.momentum.valueDelta(0,e);nf(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),Pg(i,t.eye,i)}};c([m({constructOnly:!0})],dl.prototype,"momentum",void 0),c([m({constructOnly:!0})],dl.prototype,"zoomCenter",null),dl=c([F("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],dl);let qn=class extends vo{set screenCenter(e){this._set("screenCenter",ri(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",dn(e))}constructor(e){super(e),this.interactionType=Oe.ZOOM,this.radius=0,this._tmpSceneCenter=v(),this._tmpZoomAxisAngle=Op(),this._sphere=Sr()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);Hw(this._sphere,t,i),this.constraintOptions.interactionType=Oe.ZOOM,At(this.view,t,this.constraintOptions),Cc(this._sphere,t,this.screenCenter,this._tmpSceneCenter),rf(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),wn(t,wt(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=Oe.PAN}};c([m({constructOnly:!0})],qn.prototype,"momentum",void 0),c([m({constructOnly:!0})],qn.prototype,"screenCenter",null),c([m({constructOnly:!0})],qn.prototype,"sceneCenter",null),c([m({constructOnly:!0})],qn.prototype,"radius",void 0),qn=c([F("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],qn);let Av=class{constructor(e){this._gain=e}update(e){this.filteredValue!==void 0?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}};const Dv=1e-5;let SA=class extends uO{constructor(e,t,i,r,a,n=0,o){super(e,t,i),this._angularVelocity1=r,this.axis1=a,this.angularVelocity2=n,this.axis2=o}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}},PA=class{constructor(e=300,t=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._tmpAxis1=v(),this._tmpAxis2=v(),this._tmpAngles=Ts(),this._time=new jp(.3),this._screen=[new jp(.4),new jp(.4)],this._angle1=new Av(.6),this._angle2=new Av(.6),this._axis1=v(),this._axis2=v(),this._lastScene=v()}addMomentumDirectRotation(e,t,i,r,a,n){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let o=qw(this._lastScene,t,this._tmpAxis2,r,a,n);this._angle2.update(0),Zs(this._tmpAxis2)<Dv?o=0:ie(this._axis1,this._tmpAxis2),this._angle1.update(o),le(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,r,a,n,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;kw(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,r,a,n,o,!1),Zs(this._tmpAxis2)<Dv?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),ie(this._axis1,this._tmpAxis1),ie(this._axis2,this._tmpAxis2)),le(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=e==null||t==null?null:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,a=i==null||r==null?0:i/r;return Math.abs(a)<this._minimumInitialVelocity?null:this.createMomentum(a,this._stopVelocity,this._friction)}createMomentum(e,t,i){const r=this._time.filteredDelta,a=this._angle1.filteredValue,n=this._angle2.filteredValue,o=r==null||n==null?0:n/r;return new SA(e,t,i,r==null||a==null?0:a/r,this._axis1,o,this._axis2)}},V_=class extends fr{constructor(){super(...arguments),this._smoothRotation=new lp(.05),this._rotationAxis=v(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=mc(),this._beginRadius=0,this._smoothScaling=new lp(.05),this._zoomCenterScreen=ri(),this._zoomMomentumEstimator=new rw,this._rotationMomentumEstimator=new aw,this._panSphericalMomentumEstimator=new PA,this._panPlanarMomentumEstimator=new nw,this._adjustedSphere=Sr(),this._tmp3d=v(),this._tmpScreenPointArray=ri(),this._beginScreenPoint=ri(),this._beginScenePoint=v(),this._screenPickPoint=ri(),this._scenePickPoint=v(),this._navMode=$i.Horizontal,this._sphere=Sr(),this._pointerCount=0,this._tmpInteractionDirection=v(),this._beginCamera=new Pt,this._constraintOptions=new Is(nt.ALL,Oe.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-fn.normalize(Rt(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),Ea(e.center,this._screenPickPoint),_n(this._beginScreenPoint,this._screenPickPoint);const t=Dt(this.view.spatialReference),i=Gw(this._intersectionHelper,this.startCamera,this._screenPickPoint,t,Vl.Silhouette,this.view.map.ground.opacity===0?Po:{});i.scenePickPoint!=null&&(this._scenePickPoint=i.scenePickPoint,this._sphere=i.sphere,le(this._beginScenePoint,this._scenePickPoint),this._navMode=Fc(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===$i.Vertical&&this._preparePlanarPanMode(e,i.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._navMode===$i.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._navMode===$i.Horizontal?new qn({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new dl({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Kn({view:this.view,momentum:i,center:wt(this._sphere),axis:this._rotationAxis});if(this._navMode===$i.Horizontal){const r=this._panSphericalMomentumEstimator.evaluateMomentum();if(r)return new nd({view:this.view,momentum:r})}else{const r=this._panPlanarMomentumEstimator.evaluateMomentum();if(r)return new Wh({view:this.view,momentum:r})}return null}_preparePlanarPanMode(e,t){const i=an(this._tmp3d,this.startCamera.viewForward);Y1(this._scenePickPoint,i,this._panningPlane);const r=ri(this._screenPickPoint[0],0),a=v(),n=we(this.startCamera.eye);this._adjustedSphere[3]=n<this._sphere[3]?n-100:this._sphere[3],Cc(this._adjustedSphere,this.startCamera,r,a);const o=_p();this.startCamera.projectToRenderScreen(a,o);const l=v(),h=v(),u=v();ye(l,this._scenePickPoint,this.currentCamera.eye);const d=we(l);ie(l,l);const p=Fw*Math.max(Math.abs(this.view.camera.position.z),Uw),_=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,Vc);let f=_??p;f=t?Math.min(f,d):f,le(u,ue(h,this.currentCamera.eye,ee(h,l,f))),this._panningPlane[3]=-oe(Qa(this._panningPlane),u),this.startCamera.center=ue(h,this.startCamera.eye,ee(h,this.startCamera.viewForward,f));const g=Ea(e.center,this._tmpScreenPointArray);$_(this._panningPlane,this.startCamera,g,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),Hw(this._sphere,this.currentCamera,this._smoothScaling.value),Ea(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=Oe.ZOOM,this._constraintOptions.interactionFactor=Qs(e.radius-this._beginRadius),At(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=Ea(e.center,this._tmpScreenPointArray);Cc(this._sphere,this.currentCamera,t,this._tmp3d),of(this._beginScenePoint,oe(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera.aboveGround)?(Qw(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(Ww(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=Oe.PAN,this._constraintOptions.interactionFactor=Qs(cc(this._screenPickPoint,t)),At(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){ie(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||an(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,i=t+D_(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(i);const a=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp),wn(this.currentCamera,wt(this._sphere),xc(this._rotationAxis,a)),this._constraintOptions.interactionType=Oe.TUMBLE,this._constraintOptions.interactionFactor=Qs(e.radius*i),At(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=Ea(e.center,this._tmpScreenPointArray);$_(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(Bw(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=Oe.PAN,this._constraintOptions.interactionFactor=Qs(cc(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),At(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),nf(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=Oe.ZOOM,this._constraintOptions.interactionFactor=Qs(e.radius-this._beginRadius),At(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){le(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||an(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let i=e.angle-t;i=D_(i);const r=t+i,a=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=a,this._smoothRotation.update(r);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),wn(this.currentCamera,wt(this._sphere),xc(this._rotationAxis,n)),this._constraintOptions.interactionType=Oe.TUMBLE,this._constraintOptions.interactionFactor=Qs(e.radius*n),At(this.view,this.currentCamera,this._constraintOptions)}};V_=c([F("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],V_);const $v=Vt(0,0,1);let F_=class extends fr{constructor(){super(...arguments),this._rotationValueSmooth=new lp(.05),this._scalingValueSmooth=new lp(.05),this._planeHorizontal=mc(),this._planeVertical=mc(),this._rotationMomentumEstimator=new aw,this._panMomentumEstimator=new nw(300,12,.9),this._zoomMomentumEstimator=new rw,this._beginRadius=0,this._beginCenter=v(),this._beginAngle=0,this._tmpPoints=[],this._navMode=$i.Horizontal,this._beginCenterScreen=ri(),this._tmpCentroid3d=v(),this._tmpCentroid2d=ri(),this._tmp2d=ri(),this._pointerCount=0,this._beginCamera=new Pt,this._constraintOptions=new Is(nt.ALL,Oe.NONE,0,this._beginCamera)}begin(e){if(!this.running)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),Ea(e.center,this._beginCenterScreen),Q1($v,0,this._planeHorizontal);const i=v(),r=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.map.ground.opacity===0?Po:{}),a=v();an(a,this.startCamera.viewForward);const n=v();le(n,$v);const o=oe(a,n);this._navMode=Fc(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);const l=Math.min(Fw,1/Math.abs(oe(n,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),Uw);My(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||kE(this._planeHorizontal,this._planeHorizontal);const h=v(),u=v(),d=v();ye(h,i,this.currentCamera.eye);const p=we(h);if(ie(h,h),this._navMode===$i.Vertical){ee(n,n,o),ye(Qa(this._planeVertical),a,n),ie(Qa(this._planeVertical),Qa(this._planeVertical)),My(this._planeVertical,this._planeVertical,i);const _=this.view._stage.renderView.getMinimalDepthForArea(Tc(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,Vc);let f=_??l;f=r?Math.min(f,p):f,le(d,ue(u,this.currentCamera.eye,ee(u,h,f))),this._planeVertical[3]=-oe(Qa(this._planeVertical),d),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),em(this._tmpPoints,this._beginCenter)}else{const _=r?p:l;le(d,ue(u,this.currentCamera.eye,ee(u,h,_))),this._planeHorizontal[3]=-oe(Qa(this._planeHorizontal),d),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),em(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this._navMode===$i.Horizontal?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(t){const a=this._beginRadius/e.radius,n=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=n,this._scalingValueSmooth.update(a),nf(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=Oe.ZOOM,this._constraintOptions.interactionFactor=Qs(Math.abs(e.radius-this._beginRadius)),At(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),em(this._tmpPoints,this._tmpCentroid3d),Ea(e.center,this._tmpCentroid2d),Bw(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=Oe.PAN,this._constraintOptions.interactionFactor=Qs(cc(this._beginCenterScreen,this._tmpCentroid2d)),At(this.view,this.currentCamera,this._constraintOptions),t){const a=r,n=this._rotationValueSmooth.value,o=n+D_(e.angle-n),l=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=l,this._rotationValueSmooth.update(o);const h=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(h,.001*e.timestamp);const u=Qa(this._planeHorizontal);wn(this.currentCamera,a,xc(u,h)),this._constraintOptions.interactionType=Oe.TUMBLE,this._constraintOptions.interactionFactor=Qs(Math.abs(e.radius*h)),At(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new dl({view:this.view,momentum:t,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Kn({view:this.view,momentum:i,center:this._beginCenter,axis:Qa(this._planeHorizontal)});const r=this._panMomentumEstimator.evaluateMomentum();return r?new Wh({view:this.view,momentum:r}):null}_computePlanePoints(e,t,i,r){r.length=e.size;const a=this._tmp2d;let n=0;return e.forEach(o=>{a[0]=o.x,a[1]=o.y,r[n]===void 0&&(r[n]=v()),$_(t,i,a,r[n]),n+=1}),r}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};F_=c([F("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],F_);let Iv=class extends oa{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,r=>this._handleDrag(r))}_handleDrag(e){if(e.data.pointerType==="mouse"&&!vg(e.data,this.pointerActions))return;const t=e.timestamp-this._lastEndTimestamp,i=40,r=this._momentum&&this._momentum.running&&t<i;switch(e.data.action){case"start":case"update":if(r)break;this._controller&&this._controller.running?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){var i;if((i=this._controller)!=null&&i.running){this._lastEndTimestamp=e.timestamp;const r=this._controller.end(e.data);t&&r&&(this._momentum=r,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new V_({view:this._view}):new F_({view:this._view})}},EA=class extends oa{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,()=>this.view.state.stopActiveCameraController())}},OA=class extends oa{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",i=>this._handleTwoFinger(i))}_handleTwoFinger(e){var r,a,n;const t=this._invert?-1:1,i=ri(0,e.data.delta*t);switch(e.data.action){case"begin":(r=this._cameraController)==null||r.end(),this._cameraController=new jh({view:this._view,pivot:bs.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":(a=this._cameraController)==null||a.update(i);break;case"end":(n=this._cameraController)==null||n.end(),this._cameraController=null}}},MA=class extends oa{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new eS({start:(i,r)=>this._observeStart(i,r),update:(i,r,a)=>this._observeUpdate(i,r,a),end:(i,r)=>this._observeEnd(r)}),this.registerIncoming("drag",i=>this._dragEventSeparator.handle(i))}get failed(){return this._state==="failed"}_observeStart(e,t){e===1&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=e===2?"ready":"failed"}_observeUpdate(e,t,i){if(this._state!=="failed"&&e===2)return this._state==="active"?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,i.data)?this._checkVerticalThresholdReached(t.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){this._state==="active"&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,a=-1/0,n=1/0;for(const{x:g,y}of t.pointers.values())i=Math.max(i,g),r=Math.min(r,g),a=Math.max(a,y),n=Math.min(n,y);let o=-1/0,l=1/0,h=-1/0,u=1/0;for(const{x:g,y}of e.pointers.values())o=Math.max(o,g),l=Math.min(l,g),h=Math.max(h,y),u=Math.min(u,y);const d=i-r,p=a-n,_=o-l,f=h-u;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(_-d)<=this._maxDelta&&Math.abs(f-p)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((r,a)=>{const n=t.pointers.get(a);i=Math.min(i,Math.abs(r.y-n.y))}),i>=this._threshold}},Nr=class extends Re{constructor(){super(...arguments),this.mode="default",this._updateMode=({mode:e,dragPrimary:t,dragSecondary:i,dragTertiary:r})=>{e==="pro"&&(i="zoom",r=t==="pan"?"rotate":"pan");const a={dragPrimary:t,dragSecondary:i,dragTertiary:r};this._modeDragPan&&(this._modeDragPan.pointerActions=Gp("pan",a)),this._modeDragRotate&&(this._modeDragRotate.pointerActions=Gp("rotate",a)),this._modeDragZoom&&(this._modeDragZoom.pointerActions=Gp("zoom",a))}}destroy(){this.disconnect()}get primaryDragAction(){return this.view.navigation.actionMap.dragPrimary}set primaryDragAction(e){const{actionMap:t}=this.view.navigation;t.dragPrimary=e,t.dragSecondary=e==="pan"?"rotate":"pan"}get updating(){var e;return!!((e=this._inputManager)!=null&&e.updating)}get latestPointerType(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerType}get latestPointerLocation(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerLocation}get multiTouchActive(){var e;return((e=this._inputManager)==null?void 0:e.multiTouchActive)??!1}disconnect(){this.removeAllHandles(),this.view.viewEvents.disconnect(),this._modeDragPan=null,this._modeDragRotate=null,this._modeDragZoom=null,this._modeKeyboardNavigation=null,this._inputManager=se(this._inputManager),this._source=se(this._source)}connect(){const e=this.view;this._source=new tS(this.view.surface,e.input);const t=[new iS,new sS,new rS,new aS(this.view.navigation),new MA],i=new QE({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new nS],Ay.INTERNAL);const r={fov:"Shift",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:["u","U"],down:["j","J"]},lookAround:{headingLeft:["a","A"],headingRight:["d","D"],tiltUp:["w","W"],tiltDown:["s","S"],modifier:"b"},zoom:{zoomIn:["+","="],zoomOut:["-","_"]},reset:{heading:["n","N"],tilt:["p","P"]}};this._modeDragPan=new Iv(e,["primary"]),this._modeDragRotate=new um(e,["secondary"],bs.CENTER),this._modeDragZoom=new pA(e,["tertiary"],r.fov),this._modeKeyboardNavigation=new xA(e,r),i.installHandlers("navigation",[new EA(e),new ER(e),new wA(e),new CA(e,r.fov),new um(e,["primary"],bs.EYE,[r.lookAround.modifier]),new um(e,["secondary"],bs.CENTER,[r.lookAround.modifier]),new Iv(e,["tertiary"],[r.lookAround.modifier]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,this._modeKeyboardNavigation,new OA(e)],Ay.INTERNAL),this.view.viewEvents.connect(i),this.addHandles([O(()=>{var a;return(a=this.view.navigation)==null?void 0:a.browserTouchPanEnabled},a=>{this._source.browserTouchPanningEnabled=!a},at),O(()=>{const{actionMap:a}=this.view.navigation,{dragPrimary:n,dragSecondary:o,dragTertiary:l}=a;return{mode:this.mode,dragPrimary:n,dragSecondary:o,dragTertiary:l}},this._updateMode,Be)])}isModifierKeyDown(e){var t;return((t=this._inputManager)==null?void 0:t.isModifierKeyDown(e))??!1}get test(){}};c([m()],Nr.prototype,"view",void 0),c([m({type:["default","pro"]})],Nr.prototype,"mode",void 0),c([m({readOnly:!0})],Nr.prototype,"updating",null),c([m()],Nr.prototype,"latestPointerType",null),c([m()],Nr.prototype,"latestPointerLocation",null),c([m()],Nr.prototype,"multiTouchActive",null),c([m()],Nr.prototype,"_inputManager",void 0),Nr=c([F("esri.views.3d.input.SceneInputManager")],Nr);const RA=Nr;let As,Sl,U_=!1,H_=!1,z_=!1,G_=!1,Qh=null;function AA(s,e){if(!H_||!Sl)return;nx();const t=Sl;let i=0;for(let r=0;r<s.accBinsNumX;r++)for(let a=0;a<s.accBinsNumY;a++){const n=s.accBins[r][s.accBinsNumY-1-a];i+=n.length;const o=r*s.accBinsSizeX,l=(r+1)*s.accBinsSizeX,h=a*s.accBinsSizeY,u=(a+1)*s.accBinsSizeY;t.fillText(n.length.toFixed(),o+5,h+15),ox(o,l,h,u,"blue")}t.fillText("total totalShownLabels: "+i,70,40),t.fillText("total visible labels: "+e.size,70,50),t.fillText("total numTests: "+s.accNumTests,70,30)}function DA(s){z_=xs.DECONFLICTOR_SHOW_VISIBLE,G_=xs.DECONFLICTOR_SHOW_INVISIBLE,U_=z_||G_,H_=xs.DECONFLICTOR_SHOW_GRID,Qh=null,U_||H_?Qh=()=>$A(s):As&&(As.parentElement.removeChild(As),As=null)}function nx(){Qh&&(Qh(),Qh=null)}function $A(s){As==null&&(As=document.createElement("canvas"),As.setAttribute("id","debugCanvas2d"),s.surface.parentElement.style.position="relative",s.surface.parentElement.appendChild(As));const{state:e}=s,{camera:t,pixelRatio:i}=e,{width:r,height:a}=t,n=r*i,o=a*i;As.setAttribute("width",`${n}px`),As.setAttribute("height",`${o}px`),As.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${r}px;height:${a}px`),Sl=As.getContext("2d"),Sl.clearRect(0,0,r,a),Sl.font="12px Arial"}function ox(s,e,t,i,r){nx();const a=As.height,n=Sl;n.beginPath(),n.lineWidth=1,n.strokeStyle=r,n.moveTo(s,a-t),n.lineTo(e,a-t),n.stroke(),n.lineTo(e,a-i),n.stroke(),n.lineTo(e,a-t),n.stroke(),n.lineTo(s,a-t),n.stroke(),n.lineTo(s,a-t),n.stroke(),n.closePath()}function IA(s,e){U_&&(e&&z_||!e&&G_)&&ox(s.aabr[0],s.aabr[2],s.aabr[1],s.aabr[3],e?"green":"red")}const Mr=v(),fu=v(),Ho=Mi(),lh=Mi(),pm=v(),Lv=It(),LA=Sr(),mm=To(),NA=v(),VA=pi();class FA{constructor(){this.aabr=pi(),this.distance=0,this.distanceToTerrain=0,this.culled=!1,this.visible=!1}}class UA{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info={}}}var gs;(function(s){s[s.Idle=0]="Idle",s[s.Process=1]="Process",s[s.Sort=2]="Sort",s[s.Deconflict=3]="Deconflict",s[s.NumStates=4]="NumStates"})(gs||(gs={}));class HA{constructor(){this.camera=new Pt,this.slicePlane=fg(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),yg(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let Jn=class extends Re{get dirty(){return this._dirty}get state(){return this._state}constructor(s){super(s),this._dirty=!1,this._viewState=new HA,this._state=gs.Idle,this._active=new Map,this._visible=new Map,this._iterators=new qA,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0,this._updatingHandles=new ow}destroy(){this._updatingHandles.destroy(),this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==gs.Idle||this._dirty||this._updatingHandles.updating}get updatingProgress(){if(!this.updating)return 1;const s=this._state/gs.NumStates;return this._dirty?.5*s:s}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(s){switch(this._state){case gs.Idle:this._startUpdate(),s.madeProgress();case gs.Process:if(this._state=gs.Process,!this._processActiveGraphics(s))return;case gs.Sort:if(this._state=gs.Sort,!this._sortVisibleGraphics(s))return;case gs.Deconflict:if(this._state=gs.Deconflict,!this._deconflictVisibleGraphics(s))return;default:AA(this,this._visible),this._state=gs.Idle,this.notifyChange("updating")}}modifyGraphics(s,e){e?s.forEach(t=>this.addToActiveGraphics(t)):s.forEach(t=>this.removeFromActiveGraphics(t)),this.setDirty()}layerSupportsDeconfliction(s){if(s==null||s.type!=="object3d")return!1;const e=s.stageObject;if(((e==null?void 0:e.geometries.length)??0)!==1)return!1;const t=e==null?void 0:e.geometries[0];return(t==null?void 0:t.material)instanceof qg}_startUpdate(){DA(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:s,fullHeight:e}=this._viewState.camera;this._initBins(s,e),this._resetIterators()}addToActiveGraphics(s){s.info[this.visibilityGroup]=new FA,this._active.set(s.graphics3DGraphic.graphic.uid,s),this.setDirty()}removeFromActiveGraphics(s){this._visible.delete(s.graphics3DGraphic.graphic.uid),zA(s,this.visibilityGroup),delete s.info[this.visibilityGroup],this._active.delete(s.graphics3DGraphic.graphic.uid),this.setDirty()}_createTerrainIntersector(){const s=sa(this.view.state.viewingMode);s.options.store=Xr.MIN;const e=this.view.basemapTerrain,t=this.view.state.camera;return T1(Lv,this._viewState.camera.viewInverseTransposeMatrix),i=>{Gt(fu,i,Lv),s.reset(t.eye,fu,t),e.intersect(s,null,t.eye,fu);const r=s.results.ground.dist;return r!=null?r*vi(fu,t.eye):0}}_processActiveGraphics(s){const e=this._ensureActiveGraphicsIterator(),t=this._viewState.camera.inverseProjectionMatrix,i=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._viewState.camera.relativeElevation>0,r=Gi("enable-feature:non-occluded-hud")&&this.view.map.ground.opacity>0?this._createTerrainIntersector():null,a=i?LA:null;let n=0;for(a!=null&&(Gt(wt(a),vr,this._viewState.camera.viewMatrix),a[3]=Dt(this.view.spatialReference).radius,n=PE(a,vr));!s.done;){s.madeProgress();const o=e.next();if(o.done===!0)return this._resetActiveGraphicsIterator(),!0;const l=o.value,h=l==null?void 0:l.info[this.visibilityGroup];h&&(this._collectGraphics3DGraphics(l,t,a,n,r),h.culled?(this._setGraphicVisibility(l,!1),this._visible.delete(l.graphics3DGraphic.graphic.uid)):this._visible.set(l.graphics3DGraphic.graphic.uid,l))}return!1}_sortVisibleGraphics(s){const e=this._ensureSortGraphicsIterator();for(;!s.done;){const t=e.next();if(s.madeProgress(),t.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(s){const e=this._ensureVisibleGraphicsIterator(),t=this.visibilityGroup===Xs.LABEL;for(;!s.done;){s.madeProgress();const i=e.next();if(i.done===!0)return this._resetVisibleGraphicsIterator(),!0;const r=i.value,a=r.info[this.visibilityGroup];if(!a||a.culled){this._setGraphicVisibility(r,!1);continue}const n=r.graphics3DGraphic,o=!t||n.isVisible();a.visible=o&&!this._isConflicted(r),a.visible&&this._addToBins(r),this._setGraphicVisibility(r,a.visible),IA(a,a.visible)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=Nv(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=Nv(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=GA(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(s,e,t,i,r){const a=s.graphics3DGraphic;if(a.destroyed)return;const n=s.info[this.visibilityGroup];if(!a.isVisible(Xs.GRAPHIC,pr.DECONFLICTION))return void(n.culled=!0);const o=this.getGraphicsLayers(a);_o(n.aabr);let l=null;for(const h of o){if(!this.layerSupportsDeconfliction(h))continue;const u=h.stageObject.geometries[0].material;if(l==null){if(l=QA,this._getProjectionInfo(h,e,l),l.isOutsideScreen||this._isCulledBySlice(s,Mr)||t!=null&&WA(l,t,i))return void(n.culled=!0);l.distanceToTerrain=(r==null?void 0:r(l.positionView))??0}this._expandBoundingRect(n,h,u,l)}l==null?n.culled=!0:(n.distance=l.distance,n.distanceToTerrain=l.distanceToTerrain,n.culled=!1)}_getProjectionInfo(s,e,t){const i=this._viewState.camera,r=s.stageObject,a=r.geometries[0],n=a.material,o=wt(r.boundingVolumeWorldSpace.bounds);Gt(Mr,o,i.viewMatrix);const l=a.attributes,h=l.get(De.NORMAL).data,u=l.get(De.CENTEROFFSETANDDISTANCE).data;n.applyShaderOffsetsView(Mr,h,r.transformation,u,i,t.scaleInfo,Mr),vn(Ho,Mr[0],Mr[1],Mr[2],1),x_(lh,Ho,i.projectionMatrix),ee(t.positionNDC,lh,1/lh[3]),n.applyShaderOffsetsNDC(t.positionNDC,u,i,t.positionNDC,pm),t.distanceWithoutPolygonOffset=i.depthNDCToWorld(pm[2]),t.distance=pm[2]===t.positionNDC[2]?t.distanceWithoutPolygonOffset:i.depthNDCToWorld(t.positionNDC[2]),vn(lh,t.positionNDC[0],t.positionNDC[1],t.positionNDC[2],1),x_(Ho,lh,e),K1(Ho,Ho,1/Ho[3]),ce(t.positionView,Mr[0],Mr[1],Mr[2])}_isCulledBySlice(s,e){return s.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&HT(this._viewState.slicePlane,e)}_expandBoundingRect(s,e,t,{positionNDC:i,scaleInfo:r}){const{fullWidth:a,fullHeight:n,pixelRatio:o}=this._viewState.camera,l=e.getScreenSize(kA);dO(l,r.factor,l),l[0]*=o,l[1]*=o;const h=t1(t.calculateRelativeScreenBounds(l,r.factorAlignment.scale*o,VA),ze(0,a,.5+.5*i[0]),ze(0,n,.5+.5*i[1])),u=this.marginFactor;if(u!==0){const d=u*Math.min(Qn(h),Id(h));h[0]-=d,h[1]-=d,h[2]+=d,h[3]+=d}vl(s.aabr,h,s.aabr)}_isConflicted(s){const e=s.graphics3DGraphic.graphic.uid,t=s.info[this.visibilityGroup];let i=!0;for(let r=Math.floor(t.aabr[0]/this._accBinsSizeX);r<=Math.floor(t.aabr[2]/this._accBinsSizeX);r++)if(!(r<0||r>=this._accBinsNumX))for(let a=Math.floor(t.aabr[1]/this._accBinsSizeY);a<=Math.floor(t.aabr[3]/this._accBinsSizeY);a++){if(a<0||a>=this._accBinsNumY)continue;i=!1;const n=this._accBins[r][a];for(let o=0;o<n.length;o++){const l=n.data[o],h=l.info[this.visibilityGroup];if(h&&h.visible&&l.graphics3DGraphic.graphic.uid!==e&&(this.accNumTests++,tc(h.aabr,t.aabr)))return!0}}return i}_initBins(s,e){if(this._accBins==null){this._accBins=[];for(let t=0;t<this._accBinsNumX;t++){this._accBins.push([]);const i=this._accBins[this._accBins.length-1];for(let r=0;r<this._accBinsNumY;r++)i.push(new mt)}}else for(let t=0;t<this._accBinsNumX;t++)for(let i=0;i<this._accBinsNumY;i++)this._accBins[t][i].clear();this._accBinsSizeX=s/this._accBinsNumX,this._accBinsSizeY=e/this._accBinsNumY,this.accNumTests=0}_addToBins(s){const e=s.info[this.visibilityGroup],t=Math.floor(e.aabr[0]/this._accBinsSizeX),i=Math.floor(e.aabr[2]/this._accBinsSizeX),r=Math.floor(e.aabr[1]/this._accBinsSizeY),a=Math.floor(e.aabr[3]/this._accBinsSizeY);for(let n=t;n<=i;n++)if(!(n<0||n>=this._accBinsNumX))for(let o=r;o<=a;o++)o<0||o>=this._accBinsNumY||this._accBins[n][o].push(s)}_setGraphicVisibility(s,e){const t=s.graphics3DGraphic;t.destroyed||(t.setVisibilityFlag(this.visibilityGroup,pr.DECONFLICTION,e),this.visibilityGroup===Xs.LABEL&&this.view.labeler.setLabelGraphicVisibility(t,e))}};function zA(s,e){const t=s.graphics3DGraphic;t.destroyed||t.setVisibilityFlag(e,pr.DECONFLICTION,!0)}function*Nv(s){if(Map.prototype.entries){const e=s.entries();for(let t=e.next();!t.done;t=e.next())yield t.value[1]}else yield*s.values()}function*GA(s,e,t){e.clear(),s.forEach((r,a)=>{var l;const n=e.pushNew();n.id=a,n.visible=r.graphics3DGraphic.getVisibilityFlag(t,pr.DECONFLICTION);const o=(l=r.info)==null?void 0:l[t];n.prio=r.graphics3DGraphic.deconflictionPriority,n.distance=o?o.distance:Number.MAX_VALUE,n.behindTerrain=!!o&&o.distanceToTerrain!==0&&o.distance>o.distanceToTerrain}),yield;const i=e.iterableSort((r,a)=>r.behindTerrain!==a.behindTerrain?+r.behindTerrain-+a.behindTerrain:r.prio!==a.prio?a.prio-r.prio:r.distance!==a.distance?r.distance-a.distance:r.visible!==a.visible?+a.visible-+r.visible:r.id-a.id);for(let r=i.next();!r.done;r=i.next())yield;e.forAll(r=>{const a=s.get(r.id);a&&(s.delete(r.id),s.set(r.id,a))}),e.clear()}c([m({constructOnly:!0})],Jn.prototype,"view",void 0),c([m({type:Boolean,readOnly:!0})],Jn.prototype,"updating",null),c([m({readOnly:!0})],Jn.prototype,"_updatingHandles",void 0),Jn=c([F("esri.views.3d.layers.graphics.Deconflictor")],Jn);class BA{constructor(){this.id=0,this.visible=!1,this.behindTerrain=!1,this.prio=0,this.distance=0}}class qA{constructor(e=null,t=null,i=null){this.active=e,this.visible=t,this.sort=i,this.sortArray=new mt({allocator:r=>r||new BA})}}const kA=Ts();class jA{constructor(){this.positionView=v(),this.positionNDC=v(),this.distance=0,this.distanceToTerrain=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new _O}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1||e[2]>=1}}function WA(s,e,t){return le(mm.direction,s.positionView),ce(mm.origin,0,0,0),!!Sp(e,mm,NA)&&s.distanceWithoutPolygonOffset>t}const QA=new jA,YA=2e3;let od=class extends Jn{constructor(e){super(e),this.visibilityGroup=Xs.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}initialize(){this._updatingHandles.add(()=>{var e,t,i;return(((i=(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground)==null?void 0:i.opacity)??0)===0},()=>this.setDirty())}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return Xi;const t=performance.now();if(e.state!==Oi.IDLE&&t-this._lastDeconfliction<YA)return Xi;super.runTask(e),this.state===gs.Idle&&(this._lastDeconfliction=t)}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};c([m({constructOnly:!0})],od.prototype,"parent",void 0),od=c([F("esri.views.3d.layers.graphics.LabelDeconflictor")],od);let B_=class extends Jn{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=Xs.GRAPHIC,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._updatingHandles.add(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.state)==null?void 0:t.camera},()=>{this._updateViewState(),this.setDirty()}),this._updatingHandles.add(()=>{var e,t,i;return((i=(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground)==null?void 0:i.opacity)===1},()=>this.setDirty()),this._updatingHandles.add(()=>{var e;return(e=this.view)==null?void 0:e.slicePlane},()=>{this._updateSlicePlane(),this._slicePlaneChanged()},at),this._frameTask=this.view.resourceController.scheduler.registerTask(ai.GRAPHICS_DECONFLICTOR,this),this._labels=new od({view:this.view,parent:this})}destroy(){this._labels=se(this._labels),this._frameTask=ea(this._frameTask)}get marginFactor(){return this._marginFactor}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}_updateViewState(){var e;(e=this.view)!=null&&e.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;e!=null&&zT(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=e!=null}_slicePlaneChanged(){for(const e of this._contexts.keys())if(e.symbolCreationContext.slicePlaneEnabled)return void this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:i=>this._removeGraphic(t,i),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic)),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const r=i.graphic.uid,a=new UA(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,a),_m(e)&&this.addToActiveGraphics(a),e.labelsEnabled&&this._labels.addToActiveGraphics(a);const n=!this._graphicSupportsDeconfliction(i)||!_m(e);i.setVisibilityFlag(Xs.GRAPHIC,pr.DECONFLICTION,n)}_removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=_m(e);i||ZA(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach(r=>r.slicePlaneEnabled=i),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!(t!=null&&t.length))return!1;for(const i of t)if(this.layerSupportsDeconfliction(i))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function _m(s){const e=s.layer;return!(!(e!=null&&e.featureReduction)||e.featureReduction.type!=="selection")}function ZA(s){const e=s.graphics3DGraphics;e&&e.forEach(t=>t.setVisibilityFlag(Xs.GRAPHIC,pr.DECONFLICTION,!0))}B_=c([F("esri.views.3d.layers.graphics.GraphicsDeconflictor")],B_);function q_(s){return s instanceof AE?s.graphics3DSymbol:s instanceof DE?s:null}const hh=()=>pe.getLogger("esri.views.3d.layers.graphics.labelPlacement");let Vv=class{constructor(e,t,i,r=null){this._graphic=e,this._symbol=t,this._class=i,this._disablePlacement=r}get placement(){const e=this._verticalOffsetPlacement;if(e==null)return null;const t=this._getPlacementInfo(e);if(t==null)return null;const i=t.anchor,r=!!e.hasLabelVerticalOffset,a=e.verticalOffset,n=new mS(a,i,r);return this._calculatePlacementOffsets(n,t)}get _verticalOffsetPlacement(){const e=this._class.labelPlacement,{_symbol:t,_graphic:i}=this,r=q_(i.graphics3DSymbol),a=(r==null?void 0:r.symbol.type)==="point-3d"?r.symbol:null,n=mr[e]||this._defaultPlacementInfo;return a!=null&&a.supportsCallout()&&a.hasVisibleVerticalOffset()&&!i.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:a.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!(t!=null&&t.hasVisibleVerticalOffset())||a!=null&&a.supportsCallout()&&a.verticalOffset&&!i.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:n&&XA(n.placement)?{placement:"above-center",verticalOffset:t.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(hh().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}_getPlacementInfo(e){if(e.anchor)return e;const t=this._class.labelPlacement,i=mr[t],r=i||this._defaultPlacementInfo;return t&&!i&&hh().warnOncePerTick(`the requested label placement '${t}' is currently unsupported in SceneView.`),this._validatePlacementInfo(r)}_calculatePlacementOffsets(e,t){const i=this._graphic.graphic.geometry;if(i==null)return null;switch(i.type){case"point":this._setPointSpecificPlacement(e,t);break;case"mesh":this._setMeshSpecificPlacement(e,t);break;case"polygon":this._setPolygonSpecificPlacement(e,t)}const r=$E-yO;return e.screenOffset[0]+=r*t.normalizedOffset[0],e.screenOffset[1]+=r*t.normalizedOffset[1],e}get _defaultPlacementInfo(){const e=this._graphic.graphic.geometry;if(e==null)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:vr,anchor:"center"};case"polygon":{const t=this._firstSymbolLayer;return(t==null?void 0:t.type)==="extrude"?mr["above-center"]:{placement:"center-center",normalizedOffset:vr,anchor:"center"}}case"point":case"mesh":return mr["above-center"];default:return}}_validatePlacementInfo(e){const t=this._graphic.graphic.geometry;if(t==null)return null;if(this._disablePlacement!=null)return this._class.labelPlacement?(hh().warnOncePerTick(Fv(e==null?void 0:e.placement,this._disablePlacement.logEntityDescription)),this._defaultPlacementInfo):e;const i=t.type;switch(i){case"polyline":case"polygon":case"extent":case"multipoint":if(this._class.labelPlacement)return hh().warnOncePerTick(Fv(e==null?void 0:e.placement,`'${i}' geometries`)),this._defaultPlacementInfo;break;case"point":case"mesh":return e}return e}_setPointSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(i==null)return;const r=this._graphic.layers[0];switch(r!=null?r.getCenterObjectSpace(e.translation):ce(e.translation,0,0,0),i.type){case"icon":case"text":this._setHUDSpecificPlacement(e,t,r);break;case"object":gm(e,t,r)}}_setMeshSpecificPlacement(e,t){const i=this._firstSymbolLayer;i!=null&&i.type==="fill"&&gm(e,t,this._graphic.layers[0])}_setPolygonSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(i!=null)switch(i.type){case"extrude":{const r=this._graphic.layers[0];r!=null?(r.getBoundingBoxObjectSpace(Yh),iw(Yh,e.translation),e.translation[2]=sw(Yh)/2):ce(e.translation,0,0,0),gm(e,t,r);break}}}_setHUDSpecificPlacement(e,t,i){const{_graphic:r}=this,a=i!=null?i.getScreenSize():null;if(r.isDraped||a==null)e.hasLabelVerticalOffset||e.anchor==="center"||(mr[this._class.labelPlacement]&&hh().warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");else{const n=this._normalizedSymbolAnchorPos;e.screenOffset[0]=a[0]/2*(t.normalizedOffset[0]-n[0]);const o=a[1]/2*(t.normalizedOffset[1]-n[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=o,e.centerOffsetUnits="screen"):e.screenOffset[1]=o}}get _firstSymbolLayer(){const e=this._graphic.graphics3DSymbol,t=q_(e);return t!=null?t.symbol.symbolLayers.at(0):null}get _normalizedSymbolAnchorPos(){const e=this._graphic.layers[0],t=(e==null?void 0:e.stageObject.geometries[0].material)??null;if(t&&t instanceof qg){const i=t.parameters.anchorPosition;ch[0]=2*(i[0]-.5),ch[1]=2*(i[1]-.5)}else ch[0]=0,ch[1]=0;return ch}};function Fv(s,e){return`the requested label placement '${s}' is currently unsupported for ${e} in SceneView.`}function gm(s,e,t){const i=t!=null?t.getBoundingBoxObjectSpace(Yh):Yh,r=Vt(i[3]-i[0],i[4]-i[1],i[5]-i[2]),a=Math.sqrt(r[0]*r[0]+r[1]*r[1]);s.centerOffset[0]=a/2*e.normalizedOffset[0];const n=s.translation[2],o=r[2]/2*e.normalizedOffset[1];s.translation[2]=0,s.elevationOffset=n+o;const l=we(r);s.centerOffset[2]=l/2*e.normalizedOffset[2]}function XA(s){return s==="above-center"}const mr={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Uv={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const s in Uv){const e=Uv[s],t=mr[s];e.forEach(i=>{mr[i]=t})}Object.freeze&&(Object.freeze(mr),Object.keys(mr).forEach(s=>{var e;Object.freeze(mr[s]),Object.freeze((e=mr[s])==null?void 0:e.normalizedOffset)}));const ch=[0,0],Yh=Ic();let Hv=class{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}},zv=class{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.textureAtlasHandles=[],this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}},KA=class{constructor(e,t,i,r,a){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=r,this.labelFunction=a,this.calloutSymbolLayerIndex=0}},JA=class{constructor(e,t,i,r,a,n,o,l){this.layer=t,this.graphics3DCore=i,this.scaleVisibility=r,this.emptySymbolLabelSupported=a,this.elevationInfoOverride=n,this.disablePlacement=o,this.active=l,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new CO(e,{pickable:!0,disableOctree:!0},t.uid)}destroy(){this.stageLayer.destroy()}},kn=class extends Re{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([O(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this.setDirty()),O(()=>{var e;return(e=this.view.state)==null?void 0:e.rasterPixelRatio},()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(ai.LABELER,this)]),this._textTextureAtlas=new hy({view:this.view}),this._hudMaterialCollection=new Hv(this.view._stage),this._calloutMaterialCollection=new Hv(this.view._stage)}dispose(){this.removeAllHandles(),this._textTextureAtlas=We(this._textTextureAtlas),this._hudMaterialCollection=We(this._hudMaterialCollection),this._calloutMaterialCollection=We(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),ar.graphic=null,ar.renderingInfo=null,ar.layer=null}_activateLabelingContext(e){e.graphics.forEach((t,i)=>{const r=new zv(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r),t.setVisibilityFlag(Xs.LABEL,pr.USER,!0)}),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach((t,i)=>{t.setVisibilityFlag(Xs.LABEL,pr.USER,!1),this.setLabelGraphicVisibility(t,!1),t.clearLabelGraphics(),this._labels.delete(i)}),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&(e.textureAtlasHandles.push(this._textTextureAtlas.addText(i,r=>tD(t.stageObject,r))),eD(t.stageObject,i))}}_removeLabelTextureFromAtlas(e){e.textureAtlasHandles.forEach(t=>t.remove()),e.textureAtlasHandles.length=0}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),Xi}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active){if(fm(t))this._dirty=!0;else if(ym(t.labelClassContexts)){if(t.labelClassContexts===null){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else for(const[i,r]of t.labelsToInitialize)if(this._ensureGraphics3DResources(r)&&(this._labels.set(i,r),this.deconflictor.setDirty(),e.madeProgress()),(r.visible&&r.textInitialized||!r.visible&&r.hasGraphics3DResources)&&(t.labelsToInitialize.delete(i),e.madeProgress()),e.done){this._dirty=!0;break}}this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){var n,o,l;const t=(n=e.labelClassAbortController)==null?void 0:n.signal;e.layer.when&&await e.layer.when(),Ai(t),(o=e.scaleVisibility)==null||o.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,a=(l=r.labelingInfo)==null?void 0:l.filter(h=>!!h.symbol);!a||a.length===0||(await lT(a,async(h,u)=>{const d=h.symbol,p=q_(i.getOrCreateGraphics3DSymbol(d));if(p==null)return void pe.getLogger(this).error("Failed to create Graphics3DSymbol for label");await p.load(),Ai(t);let _=null;wE(d)&&d.hasVisibleCallout()&&(_=NE(d,i.symbolCreationContext),await _.load(),Ai(t));const f=await o_(fO(h,e.layer.fieldsIndex,this.view.spatialReference));if(Ai(t),f.ok===!0){const g=await this._createTextRenderParameters(p.symbol);Ai(t),e.labelClassContexts[u]=new KA(h,p,_,g,f.value)}else pe.getLogger(this).error(`Label expression failed to evaluate: ${f.error}`)}),Ai(t))}async _createLabelClassContext(e){return e.labelClassPromise==null&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(t=>{if(cn(t))throw t;e.labelClassContexts.length=0}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return(t==null?void 0:t.type)!=="text"?null:_S.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,xn(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,a,n){const o=new gS(i,Vy(i.anchor),vO(i.anchor),e.text,E1(e.displayWidth,e.displayHeight));return ar.graphic=t,ar.layer=r,ar.renderingInfo=null,a.createLabel(ar,o,this._hudMaterialCollection,this._textTextureAtlas,()=>{var l;return((l=n.placement)==null?void 0:l.elevationOffset)??null})}_createLineCalloutGraphic(e,t,i,r,a){ar.graphic=e,ar.layer=a;const n=r.screenOffset[0];return ar.renderingInfo=new LE(null,t,r.translation,r.centerOffset,n,r.centerOffsetUnits,r.elevationOffset,this._calloutMaterialCollection),i.createGraphics3DGraphic(ar)}_ensureGraphics3DResources(e){var h,u;if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(ym(r)||!i.emptySymbolLabelSupported&&t.layers.length===0)return!1;let a=!1;const n=t.graphic,o=i.layer,l=yu(i.layer);for(let d=0;d<r.length;d++){const p=e.textRenderers[d],_=e.textLabelPlacements[d];if(p==null||_==null)continue;const f=r[d],g=f.graphics3DSymbol,y=iD(g),b=g.symbolLayers[0];if(!b)continue;b.setElevationInfoOverride(i.elevationInfoOverride);const x=new Vv(t,y,f.labelClass),C=this._createTextSymbolGraphic(p,n,_,o,b,x);if(C==null)return!1;C._labelClass=f.labelClass,C._labelIndex=d,t.addLabelGraphic(C,i.stageLayer),t.deconflictionPriority=((h=f.textRenderParameters)==null?void 0:h.definition.size)??0,t.setVisibilityFlag(Xs.LABEL,pr.USER,l),t.setVisibilityFlag(Xs.LABEL,pr.SCALE_RANGE,!0),t.setVisibilityFlag(Xs.LABEL,pr.DECONFLICTION,!1),a=!0;const T=f.graphics3DCalloutSymbolLayer;if(T&&_.hasLabelVerticalOffset){T.setElevationInfoOverride(i.elevationInfoOverride);const P=this._createLineCalloutGraphic(n,y,T,_,o);P!=null&&(f.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(P,i.stageLayer))}break}return a&&((u=i.scaleVisibility)==null||u.updateGraphicLabelScaleVisibility(t)),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(i._labelClass==null)continue;const r=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];r==null||r.onRemoveGraphic(i)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){var a;if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(ym(i))return;const r=e.graphics3DGraphic.graphic;for(let n=0;n<i.length;n++){const o=i[n];if(e.textRenderers[n]=null,e.textLabelPlacements[n]=null,(o==null?void 0:o.textRenderParameters)==null)continue;const l=o.labelFunction;let h;if(l.type==="arcade")try{const x=l.needsHydrationToEvaluate()?gO(r,t.layer):r;h=l.evaluate(x)}catch{h=null}else h=l.evaluate(r);if(h==null||h===""||/^\s+$/.test(h))continue;const u=o.graphics3DSymbol;if(!u.symbolLayers[0])continue;const d=e.graphics3DGraphic,p=((a=u.symbol)==null?void 0:a.type)==="label-3d"?u.symbol:null,_=o.labelClass,f=t.disablePlacement,g=new Vv(d,p,_,f).placement;if(g==null)continue;const y=Vy(g.anchor),b=bO(y);e.textRenderers[n]=new wO(h,b,o.textRenderParameters,hy.maxSize),e.textLabelPlacements[n]=g}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const r=new zv(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r)}this.setDirty(),this.deconflictor.setDirty()}_updateGraphicGeometry(e,t){const i=t.graphic.uid,r=this._labels.get(i);if(!r)return!0;for(const a of r.graphics3DGraphic.labelLayers)if(a._labelClass!=null&&!e.labelClassContexts[a._labelIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(a,t.graphic.geometry))return!1;return this.setDirty(),this.deconflictor.setDirty(),!0}_removeGraphic(e,t){const i=t.graphic.uid,r=this._labels.get(i);e.graphics.delete(i),r&&(this._destroyGraphic(r,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const r=e.graphics.get(i);r&&(this._removeGraphic(e,r),this._addGraphic(e,r))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.graphics.forEach(n=>r.set(n.graphic.uid,n));const a=n=>n.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,a),i.graphics3DCalloutSymbolLayer){const n=o=>o.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,n)}}}_visibilityInfoChange(e){const t=yu(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach((t,i)=>{const r=this._labels.get(i);r&&(this._destroyGraphic(r,i),r.visible=!1,e.labelsToInitialize.set(i,r))}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=(i==null?void 0:i.emptySymbolLabelSupported)||!1,a=(i==null?void 0:i.elevationInfoOverride)||null,n=(i==null?void 0:i.disablePlacement)||null;if(this._findLabelingContext(e))return;const o=e.layer,l=new JA(this.view._stage,o,e,t,r,a,n,yu(o));return this._labelingContexts.push(l),this.setDirty(),{addGraphic:h=>this._addGraphic(l,h),removeGraphic:h=>this._removeGraphic(l,h),updateGraphicGeometry:h=>this._updateGraphicGeometry(l,h),layerLabelsEnabled:()=>yu(l.layer),labelingInfoChange:h=>this._labelingInfoChange(l,h),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",l),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",l),visibilityInfoChange:()=>this._visibilityInfoChange(l),reset:()=>this._resetLabels(l),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach(r=>this._removeGraphic(t,r)),t.destroy(),this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.textureAtlasHandles.length?(this._addLabelTextureToAtlas(r),r.textInitialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(r),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some(t=>fm(t))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((t,i)=>t+(fm(i)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){}};function eD(s,e){s.geometries[0].setAttributeData(De.SIZE,[e.displayWidth,e.displayHeight]),s.geometryVertexAttributeUpdated(s.geometries[0],De.SIZE)}function tD(s,e){s.geometries[0].setAttributeData(De.UV0,e),s.geometryVertexAttributeUpdated(s.geometries[0],De.UV0,!0)}function fm(s){return!!s.labelClassPromise&&!!s.labelClassAbortController}function ym(s){return!s||s.length===0}function iD(s){var e;return((e=s.symbol)==null?void 0:e.type)==="label-3d"?s.symbol:null}function yu(s){var e;return s.labelsVisible===!0&&!!((e=s.labelingInfo)!=null&&e.some(t=>!!t.symbol))}c([m({constructOnly:!0})],kn.prototype,"view",void 0),c([m({constructOnly:!0})],kn.prototype,"deconflictor",void 0),c([m()],kn.prototype,"_textTextureAtlas",void 0),c([m({type:Boolean,readOnly:!0})],kn.prototype,"updating",null),kn=c([F("esri.views.3d.layers.graphics.Labeler")],kn);const ar=new IE(null,null,null);let Gv=class Mh{constructor(e,t,i,r,a=ld(e,t,i)){this._tilingScheme=r,this.id=a,this.lij=[0,0,0],this.extent=pi(),this.measures=new sD,this.loadPriority=0,this.used=!1,this.lij[0]=this.measures.lodLevel=e,this.lij[1]=t,this.lij[2]=i,r.getExtent(e,t,i,this.extent)}get planetRadius(){return Dt(this.spatialReference).radius}get spatialReference(){return this._tilingScheme.spatialReference}get resolution(){return this._tilingScheme.resolutionAtLevel(this.measures.lodLevel)}get level(){return this.lij[0]}get lodLevelDelta(){return this.measures.lodLevel-this.level}createChildren(){const e=this.lij[0]+1,t=2*this.lij[1],i=2*this.lij[2];return[new Mh(e,t,i,this._tilingScheme),new Mh(e,t+1,i,this._tilingScheme),new Mh(e,t,i+1,this._tilingScheme),new Mh(e,t+1,i+1,this._tilingScheme)]}},sD=class{constructor(){this.visible=!0,this.distance=0,this.lodLevel=0,this.splitPriority=0,this.mergeable=!0}};function ld(s,e,t){return`${s}/${e}/${t}`}function rD(s,e,t,i,r,a,n=1){const o=T_(e,r);if(o==null)return!1;if(o===EO){if(s===i&&t===a)return!0;const h=t+n;for(let u=t,d=a;u<h;++u,++d)le(i[d],s[u]);return!0}const l=t+n;for(let h=t,u=a;h<l;++h,++u)o(s[h],0,i[u],0);return!0}let aD=class{constructor(e,t){this._renderCoordsHelper=e,this.opaqueGround=t,this._cache=new Map,this._cameraForward=v(),this._cameraEye=v(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=v(),this._frustumBoundingSphereRadius=0,this._frustum=new m1(e),this._renderSR=e.spatialReference;const i=aP(this._renderSR);this._renderSREllipsoidRadius=Dt(i).radius}setup(e){this._aboveGround=e.aboveGround,this._frustum.update(e),ie(this._cameraForward,e.viewForward),le(this._cameraEye,e.eye),this._cameraFovY=e.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(e){if(this._cache.has(e.id))return this._cache.get(e.id);const t=this._isVisibleInFrustum(e);return this._cache.set(e.id,t),t}_isVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===Ne.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,t=e.origin,i=mD;ie(i,e.direction);const r=e.points,a=_D;Mt(a,r[4],t);const n=.5*oe(a,a)/oe(i,a),o=this._frustumBoundingSphereCenter;Jl(o,t,i,n);const l=1+n;this._frustumBoundingSphereRadius=l}_isTileVisibleInFrustumLocal(e){const t=e.spatialReference,i=e.extent,r=this._renderSR;if(Xt[0]=i[0],Xt[1]=i[1],Xt[2]=0,Xt[3]=i[2],Xt[4]=i[3],Xt[5]=0,!OO(Xt,t,0,Xt,r,0))return!1;ce(qi[0],Xt[0],Xt[1],0),ce(qi[1],Xt[3],Xt[1],0),ce(qi[2],Xt[3],Xt[4],0),ce(qi[3],Xt[0],Xt[4],0),ce(vu,.5*(Xt[0]+Xt[3]),.5*(Xt[1]+Xt[4]),.5*(Xt[2]+Xt[5]));const a=Qv,n=.5*ys(qi[0],qi[2]),o=this._frustum,l=this._frustumBoundingSphereRadius,h=this._frustumBoundingSphereCenter,u=fD;Mt(u,h,vu);const d=oe(a,u),p=gD;if(Jl(p,vu,a,d),ys(p,h)>n+l)return!1;const _=this._cameraForward,f=oe(_,Qv),g=this._cameraFovY,y=this._cameraEye;if(Math.abs(f)<Math.abs(Math.cos(.5*g))){let S=!0;const E=ce(BD,_[0],_[1],0),M=oe(y,E);for(let $=0;$<4;++$){const B=qi[$];if(oe(B,E)-M>0){S=!1;break}}if(S)return!1}{const S=qi[0],E=qi[2];if(S[0]<=y[0]&&y[0]<=E[0]&&S[1]<=y[1]&&y[1]<=E[1])return!0}const b=hD,x=this.opaqueGround&&this._aboveGround,C=this.opaqueGround&&!this._aboveGround,T=Math.min(C?bu:1/0,d+l),P=Math.max(x?-430:-1/0,d-l);for(let S=0;S<4;++S)Jl(b[S],qi[S],a,T),Jl(b[S+4],qi[S],a,P);if(qv(o.planes,b,8))return!1;if(vm(o.planes,b,8))return!0;for(let S=0;S<4;++S){const E=b[S],M=b[S+4];if(xm(o.planes,E,M))return!0;const $=b[(S+1)%4];if(xm(o.planes,E,$))return!0;const B=b[4+(S+1)%4];if(xm(o.planes,M,B))return!0}if(Rr[0][3]=+qi[0][0],Rr[1][3]=-qi[2][0],Rr[2][3]=+qi[0][1],Rr[3][3]=-qi[2][1],Rr[4][3]=+P,Rr[5][3]=-T,vm(Rr,o.points)||vm(Rr,o.points))return!0;for(let S=0;S<4;++S){const E=y,M=o.points[S+4];if(Yv(Rr,E,M))return!0;const $=o.points[4+(S+1)%4];if(Yv(Rr,M,$))return!0}return!1}_isTileVisibleInFrustumGlobal(e){if(e.level<hd)return!0;const t=e.spatialReference,i=e.extent,r=this.opaqueGround&&this._aboveGround,a=this.opaqueGround&&!this._aboveGround,n=qi,o=.5*(i[0]+i[2]);if(ce(n[0],i[0],i[1],0),ce(n[1],i[2],i[1],0),ce(n[2],i[2],i[3],0),ce(n[3],i[0],i[3],0),ce(n[4],o,i[1],0),ce(n[5],o,i[3],0),!rD(n,t,0,n,this._renderSR,0,6))return!1;const l=n[0][2]>0,h=n[3][2]<0,u=l||h,d=this._renderSREllipsoidRadius;if(u){const me=cD;Xa(me,wu,n[0]);const Me=uD;if(Xa(Me,wu,n[1]),l){const V=kv,L=n[4],N=jv;Xa(N,L,wu),Xa(V,N,L);const K=n[0];pt(K,me,V),uh(K,d);const he=n[1];pt(he,Me,V),uh(he,d)}else if(h){const V=kv,L=n[5],N=jv;Xa(N,L,wu),Xa(V,L,N);const K=n[3];pt(K,V,me),uh(K,d);const he=n[2];pt(he,V,Me),uh(he,d)}}const p=vu,_=Mt(wD,n[3],n[0]);ie(_,_);const f=ue(xD,n[0],n[3]);ee(f,f,.5);const g=-oe(f,_),y=ue(CD,n[0],n[1]);ee(y,y,.5);const b=ue(TD,n[2],n[3]);ee(b,b,.5);const x=Mt(SD,b,y);ie(x,x);const C=-(g+oe(_,y))/oe(_,x);Jl(p,y,x,C),uh(p,d);const T=this._frustumBoundingSphereRadius,P=this._frustumBoundingSphereCenter,S=this._frustum,E=S.planes,M=dD;ie(M,p);const $=oe(n[0],M)/ns(n[0]),B=S.origin,k=S.points;let H=!1;if(r){{H=!0;const Me=ie(Wv,B);for(let V=0;V<4;++V){const L=k[4+V],N=Mt(v(),L,B);ie(N,N);const K=pt(v(),Me,N);ie(K,K);const he=pt(v(),N,K);if(ie(he,he),oe(B,he)>d){H=!1;break}}}if(H&&oe(B,M)<d*$-bu)return!1;const me=ie(Wv,S.origin);if(oe(me,M)<0)return!1;{const Me=ie(zD,S.direction);if(oe(Me,M)>GD)return!1}}const Y=Math.sqrt(1-$*$);if(Y>.9)return!0;let A=!1;const R=oe(M,P),W=ns(P);if(W<=T&&!E.some(me=>yo(me,bm)>0)){if(!r)return!0;A=!0}const U=R/W;if(!A&&R<=0&&-R>T)return!1;const I=T/W;if(Math.sqrt(1-U*U)*Math.sqrt(1-I*I)-I*U>Y)return!1;if(!H&&(n.some(me=>S.intersectsPoint(me))||S.intersectsPoint(p)))return!0;const de=yD;Mt(de,P,bm);const ae=oe(de,M),ve=pD;ee(ve,M,ae);const Le=ys(ve,P),Qe=t.isWGS84,$e=e.lij,Ke=Qe&&$e[2]===2**$e[0]-1,xt=Qe&&$e[2]===0,Ct=xt?LD:Ke?$D:AD,Ue=xt?ND:Ke?ID:DD;if(!A){const me=n,Me=VD,V=PD,L=ED,N=bm;for(const K of Ct){const he=me[K];if(Bv(V,me[(K+1)%4],he),Bv(L,N,he),Xa(Me,L,V),lD(Me,k,1))return!1}}let Ae=null;if(!r&&ae<1.01*T){const me=2.5*T;if(Le>$*me+T)return!1;const Me=bD,V=me/$;for(let L=0;L<4;++L)ee(Me[L],n[L],V/d);ce(Me[4],0,0,0),Ae=Me}else{const me=(a?d+bu:ae+T)/$,Me=r?d-bu:(ae-T)/$,V=vD;for(let L=0;L<4;++L){const N=n[L];ee(V[L],N,Me/d),ee(V[L+4],N,me/d)}Ae=V}if(qv(E,Ae,Ae.length))return!1;const st=S.lines,Ie=OD,qe=MD;for(const me of st){ie(qe,me.direction);for(const Me of Ue){const V=Ae[Me];if(ie(Ie,V),wm(qe,Ie,Ae,k))return!1;const L=(Me+1)%4;if(r){const N=Ae[L];if(Mt(Ie,N,V),ie(Ie,Ie),wm(qe,Ie,Ae,k))return!1}if(a){const N=Ae[4+Me],K=Ae[4+L];if(Mt(Ie,K,N),ie(Ie,Ie),wm(qe,Ie,Ae,k))return!1}}}return!0}};function Xa(s,e,t){return pt(s,e,t),ie(s,s),s}function Bv(s,e,t){return Mt(s,e,t),ie(s,s),s}function uh(s,e){return ee(s,s,e/ns(s)),s}const lx=[el.LEFT,el.RIGHT,el.BOTTOM,el.TOP,el.FAR];function nD(s,e,t){for(let i=0;i<t;++i)if(yo(s,e[i])<=0)return!1;return!0}function qv(s,e,t){for(const i of lx)if(nD(s[i],e,t))return!0;return!1}function vm(s,e,t=e.length){for(let i=0;i<t;++i){const r=e[i];let a=!0;for(const n of s)if(yo(n,r)>0){a=!1;break}if(a)return!0}return!1}const hd=2,oD=4;function lD(s,e,t){for(const i of e)if(oe(i,s)<t)return!1;return!0}const hD=[v(),v(),v(),v(),v(),v(),v(),v()],Xt=[0,0,0,0,0,0],qi=[v(),v(),v(),v(),v(),v()],vu=v(),kv=v(),cD=v(),uD=v(),jv=v(),dD=v(),pD=v(),mD=v(),_D=v(),gD=v(),fD=v(),bm=gp(0,0,0),yD=v(),vD=[v(),v(),v(),v(),v(),v(),v(),v()],bD=[v(),v(),v(),v(),v()],wD=v(),xD=v(),CD=v(),TD=v(),SD=v(),PD=v(),ED=v(),OD=v(),MD=v(),RD=v(),AD=[0,1,2,3],DD=[0,1,2,3],$D=[0,1,3],ID=[0,1,3],LD=[1,2,3],ND=[1,2,3],VD=v();function FD(s,e,t){let i=1/0,r=-1/0;for(const a of t){const n=oe(e,a);i=Math.min(i,n),r=Math.max(r,n)}s[0]=i,s[1]=r}function UD(s,e,t,i){let r=1/0,a=-1/0;for(const n of i){const o=oe(t,n);if(r=Math.min(r,o),a=Math.max(a,o),r<=e&&a>=s)return!1}return!0}const HD=[0,0];function wm(s,e,t,i){if(t.length===0||i.length===0)return!0;const r=RD;Xa(r,s,e);const a=i[0]<t[0],n=a?t:i,o=HD;return FD(o,r,a?i:t),UD(o[0],o[1],r,n)}const bu=430,Wv=v(),zD=v(),GD=Math.cos(.25*Math.PI),Qv=Vt(0,0,1),BD=v();function xm(s,e,t){const i={t0:0,t1:1};for(const r of lx)if(!hx(s[r],e,t,i))return!1;return i.t0<i.t1}function Yv(s,e,t){const i={t0:0,t1:1};for(const r of s)if(!hx(r,e,t,i))return!1;return i.t0<i.t1}function hx(s,e,t,i){let{t0:r,t1:a}=i;const n=yo(s,e),o=yo(s,t);if(n>=0&&o>=0)return!1;if(n<0&&o>=0){const l=-n/(o-n);if(l<r)return!1;l<a&&(a=l)}else if(n>=0&&o<0){const l=n/(n-o);if(l>a)return!1;l>r&&(r=l)}return i.t0=r,i.t1=a,!0}const Rr=[Lo(-1,0,0,1),Lo(1,0,0,-1),Lo(0,-1,0,1),Lo(0,1,0,-1),Lo(0,0,-1,1),Lo(0,0,1,-1)],wu=gp(0,0,1);let Zv=class{constructor(e,t,i){this._renderCoordsHelper=e,this._tilingScheme=t,this._camera=new Pt,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new aD(e,i)}set opaqueGround(e){this._visibility.opaqueGround=e}setup(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(e){const{measures:t,extent:i,level:r}=e;t.visible=this._visibility.compute(e),t.distance=IT(i,this._focusOnMap),t.mergeable=!0,t.lodLevel=hd,t.splitPriority=Math.max(0,hd-r),t.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(e):this._updateSplitAndLodLocal(e))}_updateSplitAndLodGlobal(e){const t=e.level,i=this._renderCoordsHelper,{eye:r,fov:a}=this._camera,n=i.referenceEllipsoid.radius,o=ns(r)-n;if(2*Math.atan(n/o)<a&&o>0)return void(e.measures.lodLevel=Math.max(t,hd));const l=Xv,{extent:h}=e,{_surfaceElevation:u}=this;ce(l[0],h[0],h[1],u),ce(l[1],h[2],h[1],u),ce(l[2],h[2],h[3],u),ce(l[3],h[0],h[3],u);const d=ce(Kv,.5*(h[0]+h[2]),.5*(h[1]+h[3]),u),p=this._tilingScheme.spatialReference;for(let y=0;y<4;++y)i.toRenderCoords(l[y],p,l[y]);i.toRenderCoords(d,p,d);const _=ie(Cm.direction,d),f=oe(r,_),g=ee(Jv,_,f);this._updateSplitAndLod(e,l,d,g)}_updateSplitAndLodLocal(e){const t=Xv,{extent:i}=e,{_surfaceElevation:r}=this;ce(t[0],i[0],i[1],r),ce(t[1],i[2],i[1],r),ce(t[2],i[2],i[3],r),ce(t[3],i[0],i[3],r);const a=this._tilingScheme.spatialReference;for(let d=0;d<4;++d)this._renderCoordsHelper.toRenderCoords(t[d],a,t[d]);const n=ce(Kv,.5*(t[0][0]+t[2][0]),.5*(t[0][1]+t[2][1]),.25*(t[0][2]+t[1][2]+t[2][2]+t[3][2])),o=ce(qD,n[0],n[1],0),{eye:l,far:h}=this._camera,u=ce(Jv,o[0],o[1],l[2]);ce(Cm.origin,o[0],o[1],l[2]-2*h),le(Cm.direction,cx),this._updateSplitAndLod(e,t,n,u)}_updateSplitAndLod(e,t,i,r){const a=Math.max(ys(t[0],t[2]),ys(t[1],t[3]),ys(t[0],i)+ys(i,t[2]),ys(t[1],i)+ys(i,t[3])),{eye:n,near:o,fov:l,viewForward:h,width:u,height:d,pixelRatio:p,frustum:_}=this._camera,f=oe(n,h),g=oe(i,h)-f,y=ys(i,n);let b=g,x=g,C=y,T=y;const P=(U,I)=>I<o?1:Math.sqrt(U*U-I*I)/I;let S=P(y,g);for(const U of t){const I=oe(U,h)-f;b=Math.min(b,I),x=Math.max(x,I);const de=ys(U,n);T=Math.max(T,de),C=Math.min(C,de);const ae=P(de,I);S=Math.min(S,ae)}if(x<o)return void(e.measures.lodLevel=0);const E=Math.cos(.5*l),M=ys(n,r);S>E&&M>jD*a&&(x=e0*T,b=e0*C);const $=.5*Math.sqrt(u*u+d*d)/p,B=2*Math.tan(.5*l),k=U=>Math.max(o,U)*kD/$*B,H=e.level,Y=a*2**H*Math.max(1,B),A=k(b),R=Math.ceil(Math.log2(Math.max(1,Y/A)));if(e.measures.lodLevel=Math.max(R,e.measures.lodLevel),e.measures.splitPriority+=e.measures.lodLevel-H,H<R){const U=+Th(_,t[0])+ +Th(_,t[1])+ +Th(_,t[2])+ +Th(_,t[3]);e.measures.splitPriority+=U}const W=k(x)/A;W>2.5&&(e.measures.splitPriority+=W)}get _isGlobal(){return this._renderCoordsHelper.viewingMode===Ne.Global}};const Xv=[v(),v(),v(),v()],Kv=v(),qD=v(),Jv=v(),cx=gp(0,0,1),Cm=EE(vr,cx),kD=312,jD=.5,e0=2,WD=60;let gi=class extends Re{constructor(e){super(e),this.tiles=new wo,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=Da(!1),this._pendingTiles=Da(null),this._newTiles=new mt,this._tests=!1,this._measurements=new Zv(e.renderCoordsHelper,e.tilingSchemeOwner.tilingScheme,this._opaqueGround)}initialize(){var i;const e=()=>this._setDirty(),t=()=>this._reset();this.addHandles([O(()=>this.tileSize,t,Be),O(()=>{var r;return(r=this.cameraOnSurface)==null?void 0:r.location},e,Be),O(()=>{var r;return(r=this.viewState)==null?void 0:r.contentCamera},e,Be),O(()=>{var r;return(r=this.focus)==null?void 0:r.location},e,Be),O(()=>{var r;return((r=this.terrain)==null?void 0:r.baseOpacity)??1},e),O(()=>this.tilingScheme,r=>{this._reset(),this._measurements=new Zv(this.renderCoordsHelper,r,this._opaqueGround)},Ge),O(()=>this._opaqueGround,r=>this._measurements.opaqueGround=r,Ge)]),this._frameWorker=(i=this.scheduler)==null?void 0:i.registerTask(ai.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=ea(this._frameWorker)}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(e!=null&&!e.spatialReference.equals(this.viewState.spatialReference))return void pe.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||t!=null&&e&&t.equals(e))return;const i=e!=null?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(this.filterExtent==null)return null;const e=pi();return B1(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}addClient(){const e=WC();return this._clients.add(e),this._clients.size===1&&this._setDirty(),po(()=>this._removeClient(e))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}get _opaqueGround(){var e;return(((e=this.terrain)==null?void 0:e.baseOpacity)??1)===1}_setDirty(){this._hasClients&&!this.suspended&&(this._frameWorker?this._dirty.value=!0:this.runTask(qr))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty.value=!1}get running(){return this.updating}_reset(){this._newTiles.clear(),this._pendingTiles.value=null,this._setDirty()}_getRootTiles(){const e=this.tilingScheme;return this._rootTileIds.map(t=>new Gv(t[0],t[1],t[2],e))}runTask(e){e=this._tests?qr:e,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(e),this._frameWorker!=null&&(this._frameWorker.priority=ai.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(e),this._pendingTiles.value||this._frameWorker==null||(this._frameWorker.priority=ai.FEATURE_TILE_TREE)}_startUpdate(e){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:t,_filterExtentRect:i,_newTiles:r}=this;t.setup(this.viewState.contentCamera,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter(a=>{if(t.update(a),a.measures.visible&&(!i||tc(a.extent,i))){if(a.measures.splitPriority>0)return!0;r.push(a)}return!1}).sort(t0),this._newTiles.clear(),e.madeProgress()}_splitPendingTiles(e){const t=this._pendingTiles.value;if(!t)return;const{tilingScheme:i,_filterExtentRect:r,_newTiles:a,_measurements:n}=this;for(;t.length>0&&this._tileBudgetExceeded<1;){const o=t.pop();if(e.madeProgress(),o.measures.splitPriority>0){i.ensureMaxLod(o.level+1);const l=o.createChildren();for(const h of l)n.update(h),!h.measures.visible||r&&!tc(h.extent,r)||(h.measures.splitPriority>0?t.push(h):a.push(h));t.sort(t0),this._tileBudgetExceeded>=1&&(this._mergeNewTiles(),this._tileBudgetExceeded>=1&&this._mergeNewTiles(!0))}else a.push(o);if(e.done)return}a.pushArray(t),this._pendingTiles.value=null,this._updateTiles(),a.clear(),n.done()}get _tileBudgetExceeded(){var e;return Math.max(0,(this._newTiles.length+(((e=this._pendingTiles.value)==null?void 0:e.length)??0))/WD-1)}_mergeNewTiles(e=!1){const{_newTiles:t,_measurements:i}=this,r=new Map(t.map(n=>[n.id,n]));let a=!1;return r.forEach(n=>{const{lij:o,measures:l}=n;if(!l.mergeable||o[1]%2!=0||o[2]%2!=0||o[0]<=1||n.lodLevelDelta>=oD)return;const h=l.lodLevel;let u=h,d=!0;const p=r.get(ld(o[0],o[1]+1,o[2]));let _=Math.abs(((p==null?void 0:p.measures.lodLevel)??0)-h),f=_===0||e&&(p==null?void 0:p.measures.mergeable)&&_<=1;if(!p||!f)return;u+=p.measures.lodLevel,d&&(d=_===0);const g=r.get(ld(o[0],o[1],o[2]+1));if(_=Math.abs(((g==null?void 0:g.measures.lodLevel)??0)-h),f=_===0||e&&(g==null?void 0:g.measures.mergeable)&&_<=1,!g||!f)return;u+=g.measures.lodLevel,d&&(d=_===0);const y=r.get(ld(o[0],o[1]+1,o[2]+1));if(_=Math.abs(((y==null?void 0:y.measures.lodLevel)??0)-h),f=_===0||e&&(y==null?void 0:y.measures.mergeable)&&_<=1,!y||!f)return;u+=y.measures.lodLevel,d&&(d=_===0),t.removeUnordered(n),t.removeUnordered(p),t.removeUnordered(g),t.removeUnordered(y);const b=new Gv(o[0]-1,o[1]/2,o[2]/2,this.tilingScheme);i.update(b),b.measures.visible=!0,b.measures.lodLevel=u/4,b.measures.mergeable=d,t.push(b),a=!0}),a}_updateTiles(){for(;this._mergeNewTiles(););for(;this._tileBudgetExceeded&&this._mergeNewTiles(!0););for(const r of this.tiles.items)r.used=!1;let e=!1;const t=this._newTiles.filter(r=>{const a=this._idToTile.get(r.id);return a?(e||(e=a.measures.lodLevel!==r.measures.lodLevel),a.measures={...r.measures},a.used=!0):this._idToTile.set(r.id,r),!a}),i=this.tiles.items.filter(r=>!r.used&&(this._idToTile.delete(r.id),!0));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles(),!e||i.length||t.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,t)=>e.measures.distance-t.measures.distance),this.tiles.forEach((e,t)=>e.loadPriority=t)}};function t0(s,e){return s.lodLevelDelta-e.lodLevelDelta||s.measures.splitPriority-e.measures.splitPriority||e.measures.distance-s.measures.distance}c([m({constructOnly:!0})],gi.prototype,"scheduler",void 0),c([m({constructOnly:!0})],gi.prototype,"renderCoordsHelper",void 0),c([m({constructOnly:!0})],gi.prototype,"tilingSchemeOwner",void 0),c([m({constructOnly:!0})],gi.prototype,"cameraOnSurface",void 0),c([m({constructOnly:!0})],gi.prototype,"focus",void 0),c([m({constructOnly:!0})],gi.prototype,"viewState",void 0),c([m({constructOnly:!0})],gi.prototype,"terrain",void 0),c([m()],gi.prototype,"tiles",void 0),c([m()],gi.prototype,"tileSize",void 0),c([m({readOnly:!0})],gi.prototype,"tilingScheme",null),c([m()],gi.prototype,"filterExtent",null),c([m({readOnly:!0})],gi.prototype,"_filterExtentRect",null),c([m({readOnly:!0})],gi.prototype,"_rootTileIds",null),c([m({value:!1})],gi.prototype,"suspended",null),c([m({readOnly:!0})],gi.prototype,"updating",null),gi=c([F("esri.views.3d.layers.support.FeatureTileTree3D")],gi);let vt=class extends Re{constructor(e){super(e),this._propertiesPool=new yn({camera:Pt},this),this._lastSeenCameraProjectionValues=new Pt,this.mode=Oi.ANIMATING,this._cssCamera=new Pt,this._camera=new Pt,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new ga({state:this}),this.events=new Va,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new yn({camera:Pt},this)}destroy(){var e;this.cameraController=null,(e=this._propertiesPool)==null||e.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===Ne.Global){const e=Dt(this.spatialReference).radius;this.camera=new Pt({eye:Vt(4*e,0,0),center:Vt(e,0,0),up:Vt(0,0,1)})}else this.camera=new Pt({eye:Vt(0,0,100),center:Vt(0,0,0),up:Vt(0,1,0)})}get animation(){return this.cameraController instanceof wc&&this.cameraController.viewAnimation!=null?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:i,pixelRatio:r}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/r),e.width=Math.round(i/r),e}get camera(){return this._camera}set camera(e){e!==Ls&&Ls.copyFrom(e),Ls.computeUp(this.viewingMode),this.events.emit("before-camera-change",Ls);const t=this._camera;if(YD(this._lastSeenCameraProjectionValues,Ls)&&(this._lastSeenCameraProjectionValues.copyFrom(Ls),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(Ls)&&(this._camera=this._propertiesPool.get("camera").copyFrom(Ls),this._cameraChanged=!t.almostEquals(Ls),this._cameraChanged)){const i=QC(()=>{this._cameraChanged=!1,i.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===Oi.IDLE}get updating(){return this.mode!==Oi.IDLE}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){this._contentCamera=e!=null?e.clone():null}get fixedContentCamera(){return this._contentCamera!=null}get isGlobal(){return this.viewingMode===Ne.Global}get isLocal(){return this.viewingMode===Ne.Local}get viewingMode(){return f_(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){const e=this.view.highlights.items.slice(0,MO);for(let t=0;t<e.length;){const i=e[t],r=e.findIndex(a=>a.name===i.name);r>=0&&t>r?e.splice(t,1):++t}return e}get highlightOrderMap(){const e=new Map;return this.highlights.forEach((t,i)=>e.set(t.name,i)),e}get navigating(){var e;return!!((e=this.cameraController)!=null&&e.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){var t;this.stopActiveCameraController()?((t=this.cameraController)==null||t.destroy(),e&&(this.removeHandles(i0),this.addHandles(Pl(()=>e.state===ct.Finished||e.state===ct.Stopped,()=>{this._set("cameraController",null),this.updateCamera(i=>e.onControllerEnd(i))},{sync:!0,once:!0}),i0),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=ct.Rejected)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this._updateQueue.length===0||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Ls.copyFrom(this._get("camera")),e(Ls),this.camera=Ls,this._processingUpdates=!1,this._processUpdateQueue()}};c([m({constructOnly:!0})],vt.prototype,"view",void 0),c([m()],vt.prototype,"mode",void 0),c([m({readOnly:!0,type:Rl})],vt.prototype,"animation",null),c([m({type:Pt})],vt.prototype,"cssCamera",null),c([m()],vt.prototype,"_cssCamera",void 0),c([m({type:Pt})],vt.prototype,"camera",null),c([m()],vt.prototype,"_camera",void 0),c([m({readOnly:!0})],vt.prototype,"pixelRatio",null),c([m()],vt.prototype,"rasterPixelRatio",void 0),c([m()],vt.prototype,"contentPixelRatio",void 0),c([m({readOnly:!0})],vt.prototype,"alignPixelEnabled",null),c([m({readOnly:!0})],vt.prototype,"updating",null),c([m({})],vt.prototype,"_contentCamera",void 0),c([m({type:Pt})],vt.prototype,"contentCamera",null),c([m({readOnly:!0})],vt.prototype,"fixedContentCamera",null),c([m({readOnly:!0})],vt.prototype,"events",void 0),c([m({readOnly:!0})],vt.prototype,"isGlobal",null),c([m({readOnly:!0})],vt.prototype,"isLocal",null),c([m({readOnly:!0})],vt.prototype,"viewingMode",null),c([m({readOnly:!0})],vt.prototype,"highlights",null),c([m({readOnly:!0})],vt.prototype,"highlightOrderMap",null),c([m({readOnly:!0})],vt.prototype,"navigating",null),c([m({readOnly:!0})],vt.prototype,"stationary",null),c([m()],vt.prototype,"_cameraChanged",void 0),c([m()],vt.prototype,"cameraController",null),vt=c([F("esri.views.3d.state.ViewState")],vt);const QD=vt;function YD(s,e){return s.fov!==e.fov||s.fullViewport[0]!==e.fullViewport[0]||s.fullViewport[1]!==e.fullViewport[1]||s.fullViewport[2]!==e.fullViewport[2]||s.fullViewport[3]!==e.fullViewport[3]||s.padding[vs.TOP]!==e.padding[vs.TOP]||s.padding[vs.RIGHT]!==e.padding[vs.RIGHT]||s.padding[vs.BOTTOM]!==e.padding[vs.BOTTOM]||s.padding[vs.LEFT]!==e.padding[vs.LEFT]}const Ls=new Pt,i0="ViewStateHandles";let ZD=class{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new mt,this._tolerance=jd,this._tmpRay=To(),this._tmpRegion=pi(),this._validateHUDIntersector=sa(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),s0(this.viewingMode),t,i)}intersectScreenFreePointFallback(e,t,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,i)}intersectRayFreePointFallback(e,t,i){return this.intersectRay(e,s0(this.viewingMode),t,i)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=Xr.MIN,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,r=.5){return e.getRenderCenter(Cu,i,r),Cu[0]+=.0466,Cu[1]-=.0123,X1(e,Cu,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,i)}intersectToolIntersectorScreen(e,t,i){const r=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,i);const r=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||mO(r)&&r.intersector!==Ur.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,i))}setTolerance(e=jd){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((t,i)=>t.type===Ur.TERRAIN?1:i.type===Ur.TERRAIN?-1:0)}removeIntersectionHandler(e){this._externalIntersectionHandlers.removeUnordered(e)!=null&&this._externalIntersectionHandlers.sort((t,i)=>t.type===Ur.TERRAIN?1:i.type===Ur.TERRAIN?-1:0)}_getPickRay(e,t){const i=this._view.state.camera;return Z1(i,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==Ne.Local||e==null||ue(t,e.origin,ie(Tt.get(),e.direction)),!1}intersectElevationFromScreen(e,t,i=0,r=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,i,r)}_intersectElevation(e,t,i=0,r=null){if(e==null)return null;const a=this._view,{renderCoordsHelper:n}=a,o=pT(a.spatialReference),l=t!=null?t.mode:"absolute-height",h=$O(t)/o,u=(l!=="on-the-ground"?h+i:0)*o/n.unitInMeters,{camera:d}=a.state;if(l==="absolute-height"){const T=n==null?void 0:n.getAltitude(d.eye),P=oe(ie(dh,e.direction),n.worldUpAtPosition(d.eye,JD));if(T<u&&P<0||T>=u&&P>0)return null;if(n.intersectInfiniteManifold(e,u,dh)){const S=Fy(a,dh);return S.z??(S.z=0),S.z-=h,S}return null}const p=Kf(Tt.get());d.projectToRenderScreen(e.origin,p);const _=new r0(null,this._forEachLayer),{slicePlane:f}=a,g=f!=null?Ny(f):null,y=sa(this.viewingMode);y.options.store=Xr.MIN,y.options.verticalOffset=u,y.options.normalRequired=!1;const b=e.origin,x=ue(Tt.get(),b,e.direction);y.reset(b,x,d),y.point=p;const C=r?"type"in r&&r.type==="graphics"?T=>T.layerUid!==r.uid:T=>T.graphicUid!==r.uid:null;switch(l){case"relative-to-scene":{const T=P=>(!C||C(P))&&!!P.lastValidElevationBB;y.intersect(_.layers,p,this._tolerance,null,T),this._externalIntersectionHandlers.forAll(P=>{if(P.type===Ur.I3S||P.type===Ur.TERRAIN||P.type===Ur.TILES3D){const S=P.slicePlaneEnabled?g:null;P.intersect(y,S,y.rayBegin,y.rayEnd,p)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(T=>{if(T.isGround){const P=T.slicePlaneEnabled?g:null;T.intersect(y,P,y.rayBegin,y.rayEnd,p)}})}if(y.results.min.getIntersectionPoint(dh)){const T=Fy(a,dh);return T.z=i,T}return null}computeIntersection(e,t,i,r){var g;if(e==null)return;const a=this._view.state.camera,n=Kf(Tt.get());a.projectToRenderScreen(e.origin,n);const o=new r0(i,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const l=e.origin,h=ue(Tt.get(),e.origin,e.direction);t.reset(l,h,a),t.intersect(o.layers,n,this._tolerance);const u=this._view.slicePlane,d=u!=null?Ny(u):null;t.intersect(o.sliceableLayers,n,this._tolerance,d);const p=i&&(i.requiresGroundFeedback||i.enableDraped);this._externalIntersectionHandlers.forAll(y=>{const b=y.layerUid,x=Array.isArray(b),C=x?b:[b];x&&(t.options.filteredLayerUids=[]);let T=!1;for(const P of C)o.filterLayerUid(P)?T=!0:x&&t.options.filteredLayerUids.push(P);if(t.options.isFiltered=!T,y.isGround&&p||!t.options.isFiltered){const P=y.slicePlaneEnabled?d:null;y.intersect(t,P,l,h,n,r)}});const _=Tt.get(),f=this._view.basemapTerrain;if(i&&i.enableDraped&&f.spatialReference!=null&&t.results.ground.getIntersectionPoint(_)){const y=f.overlayManager.renderer,b=this._view.renderCoordsHelper.spatialReference,x=Tt.get();this._view.renderCoordsHelper.fromRenderCoords(_,x,f.spatialReference),x[2]=((g=this._view.elevationProvider)==null?void 0:g.getElevation(_[0],_[1],_[2],b,"ground"))??0,y.intersect(t,x,t.results.ground,C=>o.filterRenderGeometry(C))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;u_(this._tmpRegion,LT);const i=this._view.state.camera,r=[],a=this._tmpRegion,n=b=>{const x=new KD(b),C=x.result.target.object.geometries.every(T=>T.material instanceof qg&&T.material.parameters.occlusionTest);r.push({item:x,occlusionTest:C}),C&&(i.projectToRenderScreen(b.target.center,x.screenPoint),x.screenPoint[0]=Math.floor(x.screenPoint[0]),x.screenPoint[1]=Math.floor(x.screenPoint[1]),NT(a,x.screenPoint))};e.sortResults(t.all),t.min.dist!=null&&n(t.min);for(const b of t.all)t.min.target.object!==b.target.object&&t.max.target.object!==b.target.object&&n(b);if(t.max.dist!=null&&t.max.target.object!==t.min.target.object&&n(t.max),!r.length)return;a[0]===a[2]&&(a[2]+=1),a[1]===a[3]&&(a[3]+=1);const o=i.fullWidth,l=i.fullHeight,h=Math.max(0,a[0]-Rh),u=Math.max(0,a[1]-Rh),d=Math.min(Qn(a)+2*Rh,o-h),p=Math.min(Id(a)+2*Rh,l-u),_=d>0&&p>0?new Uint8Array(d*p*4):null;_&&this._view._stage.renderer.readHUDVisibility(h,u,d,p,_);let f=!0;const g=e.results.max.dist==null;let y=0;for(const{item:b,occlusionTest:x}of r){let C=!x;if(x&&_)for(const T of XD){const P=4*(Math.min(b.screenPoint[0]+T[0],o)-a[0]+(Math.min(b.screenPoint[1]+T[1],l)-a[1])*d);if(P>=0&&P<_.length&&_[P]){C=!0;break}}C&&(f&&(e.results.min.copy(b.result),f=!1),g&&e.results.max.copy(b.result),e.options.store===Xr.ALL&&e.results.all.splice(y++,0,b.result))}}};const Rh=1,XD=(()=>{const s=[],e=Rh;for(let t=-1;t<=e;t++)for(let i=-1;i<=e;i++)s.push([i+e,t+e]);return s})();let KD=class{constructor(e){this.result=e,this.screenPoint=_p()}},xu;function s0(s){return xu&&xu.viewingMode===s||(xu=sa(s)),xu}let r0=class{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e==null?void 0:e.include,this.exclude=e==null?void 0:e.exclude,t(i=>{i.pickable&&this.filterLayerUid(i.apiLayerUid)&&(i.sliceable?this.sliceableLayers:this.layers).push(i)})}filterLayerUid(e){const{include:t,exclude:i}=this;return e==null?t==null&&i==null:(t==null||t.has(e))&&(i==null||!i.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}};function a0(s){return typeof s=="object"&&"intersect"in s}const dh=v(),JD=v(),Cu=_p();let Ah=class extends Va.EventedMixin(Re){get spatialReference(){var e,t;return(t=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:t.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=se(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,i,r,a){if(this._cacheEnabled&&this.lastElevationQuery!=null){const o=this.lastElevationQuery;if(e===o.x&&t===o.y&&i===o.z&&$d(r,o.spatialReference)&&a===o.queryContext)return o.result}let n=null;return n=Tu(n,this._im,e,t,i,r,a),n==null&&(n=Tu(n,this._ground,e,t,i,r,a)),a==="scene"&&(n=Tu(n,this._scene,e,t,i,r,a)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:r,queryContext:a,result:n}),n}getSphereElevationBounds(e,t,i){const r=new Qd;function a(n){for(const o of n)if(o.getSphereElevationBounds){const l=o.getSphereElevationBounds(e,t,i);l!=null&&r.expandElevationRangeValues(l.elevationRangeMin,l.elevationRangeMax)}}return a(this._ground),a(this._im),i==="scene"&&a(this._scene),r}getRootElevationBounds(){const e=new Qd;for(const t of[this._im,this._ground,this._scene])t.forEach(i=>{if(i.getRootElevationBounds){const r=i.getRootElevationBounds();r!=null&&e.expandElevationRangeValues(r.elevationRangeMin,r.elevationRangeMax)}});return e}async queryElevation(e,t,i,r,a,n=null,o=0){const l=this._getElevationQuery(r);try{const h=await l.queryElevation(e,t,n,o);return a==="scene"?Tu(h,this._scene,e,t,i,r,a):h}catch(h){return YC(h),this.getElevation(e,t,i,r,a)}}register(e,t){this.addHandles(t.on("elevation-change",i=>this.emit("elevation-change",i)),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(t!=null&&$d(e,t.spatialReference))return t;t==null||t.destroy({completeTasks:!0});const{wkid:i,wkt:r,wkt2:a,latestWkid:n}=e,o=new VE(this.view.resourceController.scheduler,new si({wkid:i,wkt:r,wkt2:a,latestWkid:n}),()=>{var l;return(l=this.view.map)==null?void 0:l.ground},{maximumAutoTileRequests:4});return this._cachedQuery=o,o}};function Tu(s,e,t,i,r,a,n){for(const o of e){const l=o.getElevation(t,i,r,a,n);l!=null&&(s=s!=null?Math.max(l,s):l)}return s}c([m({constructOnly:!0})],Ah.prototype,"view",void 0),c([m()],Ah.prototype,"spatialReference",null),Ah=c([F("esri.views.3d.support.CombinedElevationProvider")],Ah);let ho=class k_{static isValidProfile(e){return e in k_.profiles}static getDefaultProfile(){return Gi("esri-iPhone")?"low":"medium"}static apply(e,t){const i=k_.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=i.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=i.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods,t.graphics3D.uncompressedTextureDownsamplingEnabled=i.graphics3D.uncompressedTextureDownsamplingEnabled;const r=t.sceneService.object,a=i.sceneService.object;r.lodFactor=a.lodFactor,t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=i.tiledSurface.vtlContentZoom,t.tiledSurface.elevationLevelDelta=i.tiledSurface.elevationLevelDelta,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=i.fadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.highResolutionAtmosphere=i.highResolutionAtmosphere,t.reflections=i.reflections,t.ambientOcclusion=i.ambientOcclusion,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumPixelRatio=i.maximumPixelRatio}};ho.test={reset(){const s=ux();for(const e of Object.keys(s))ho.profiles[e]=s[e]}};const ph={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430};function ux(){const s=!!Gi("esri-mobile"),e=!!Gi("ios"),t=Xe(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0,uncompressedTextureDownsamplingEnabled:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:Xe(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:200+ph.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:s?.8:1,polylineLodFactor:s?1.2:1.5,snapshotAvailable:!e,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:s},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:s},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!Gi("disable-feature:reduce-map-tile-levels")},fadeDuration:t,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:s?600+ph.GalaxyS20:750+ph.FullHD,additionalCacheMemory:s?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:s?1.2:2,polylineLodFactor:s?1.2:2,snapshotAvailable:!e,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!Gi("disable-feature:reduce-map-tile-levels")},fadeDuration:t,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,memoryLimit:s?900+ph.SurfacePro7:1500+ph.FullHDRetina,additionalCacheMemory:s?-150:0,frameRate:0,maximumPixelRatio:s?1:1/0}}}(function(s){s.profiles=ux()})(ho);var fe;(function(s){s[s.ELEVATION=0]="ELEVATION",s[s.MAP=1]="MAP"})(fe||(fe={}));const sl=[fe.ELEVATION,fe.MAP];async function e$(s,e){var p,_,f,g,y;const{results:t,ground:i}=await VO(s,e),r=(!i.layer||!m_(i.layer.type))&&i.mapPoint,a=[],n=s$(s),o=r?t$(s,n):i$;let l=0,h=0;const u=()=>{const b=o.layerViews[h];r&&b&&"fetchPopupFeaturesAtLocation"in b&&a.push({mapPoint:i.mapPoint,layerView:b}),++h};let d=null;for(;l<t.length||h<o.layerViews.length;){const b=t[l];if(b&&b.type!=="graphic")++l;else if(((p=b==null?void 0:b.layer)==null?void 0:p.type)!=="scene"||((_=b==null?void 0:b.layer)==null?void 0:_.parent)!==((f=s==null?void 0:s.map)==null?void 0:f.basemap))if(b){const x=(g=b.layer)==null?void 0:g.uid,C=o.layerUids.has(x)&&b.distance===i.distance,T=n.get((y=b.layer)==null?void 0:y.uid);if(d??(d=b.mapPoint),h<o.layerViews.length&&(C||(b.distance??0)>i.distance)&&o.layerViews[h]!==T){u();continue}a.push({graphic:b.graphic,layerView:T}),++l}else u();else++l}return d??(d=i.mapPoint),{hits:a,location:d}}function t$(s,e){const t=new Set,i=[];for(let a=s.basemapTerrain.numLayers(fe.MAP)-1;a>=0;a--){const n=s.basemapTerrain.layerViewByIndex(a,fe.MAP);t.add(n.layer.uid),i.push(n)}const r=s.basemapTerrain.overlayManager.renderer.layers;for(const{uid:a}of r){const n=e.get(a);n&&(t.add(a),i.push(n))}return i.reverse(),{layerUids:t,layerViews:i}}const i$={layerUids:new Set,layerViews:[]};function s$(s){const e=new Map;for(const t of s.allLayerViews){const i=t.layer.uid;e.set(i,t)}return e}let Ms=class extends Re{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1,this.uncompressedTextureDownsamplingEnabled=!1}};c([m()],Ms.prototype,"minTotalNumberOfFeatures",void 0),c([m()],Ms.prototype,"maxTotalNumberOfFeatures",void 0),c([m()],Ms.prototype,"maxNumberOfDrawCalls",void 0),c([m()],Ms.prototype,"maxTotalNumberOfVertices",void 0),c([m()],Ms.prototype,"snapshotAvailable",void 0),c([m()],Ms.prototype,"polygonLodFactor",void 0),c([m()],Ms.prototype,"polylineLodFactor",void 0),c([m()],Ms.prototype,"skipHighSymbolLods",void 0),c([m()],Ms.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Ms=c([F("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Ms);let yr=class extends Re{constructor(){super(...arguments),this.lodFactor=1}};c([m()],yr.prototype,"lodFactor",void 0),yr=c([F("esri.views.3d.support.QualitySettings.LoDFactorSettings")],yr);let Ta=class extends Re{constructor(){super(...arguments),this.object=new yr,this.point=new yr,this.integratedMesh=new yr,this.pointCloud=new yr,this.uncompressedTextureDownsamplingEnabled=!1}};c([m({type:yr})],Ta.prototype,"object",void 0),c([m({type:yr})],Ta.prototype,"point",void 0),c([m({type:yr})],Ta.prototype,"integratedMesh",void 0),c([m({type:yr})],Ta.prototype,"pointCloud",void 0),c([m()],Ta.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Ta=c([F("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Ta);let Sa=class extends Re{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};c([m()],Sa.prototype,"lodBias",void 0),c([m()],Sa.prototype,"angledSplitBias",void 0),c([m()],Sa.prototype,"vtlContentZoom",void 0),c([m()],Sa.prototype,"elevationLevelDelta",void 0),c([m()],Sa.prototype,"reduceTileLevelDifferences",void 0),Sa=c([F("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],Sa);let pl=class extends Re{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};c([m()],pl.prototype,"pixelRatio",void 0),c([m()],pl.prototype,"maxTotalNumberOfFeatures",void 0),pl=c([F("esri.views.3d.support.QualitySettings.HeatmapSettings")],pl);let Ci=class extends Re{constructor(){super(...arguments),this.graphics3D=new Ms,this.sceneService=new Ta,this.tiledSurface=new Sa,this.heatmap=new pl,this.fadeDuration=Xe(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};c([m({type:Ms})],Ci.prototype,"graphics3D",void 0),c([m({type:Ta})],Ci.prototype,"sceneService",void 0),c([m({type:Sa})],Ci.prototype,"tiledSurface",void 0),c([m({type:pl})],Ci.prototype,"heatmap",void 0),c([m()],Ci.prototype,"fadeDuration",void 0),c([m()],Ci.prototype,"antialiasingEnabled",void 0),c([m()],Ci.prototype,"physicallyBasedRenderingEnabled",void 0),c([m()],Ci.prototype,"highQualityTransparency",void 0),c([m()],Ci.prototype,"highResolutionAtmosphere",void 0),c([m()],Ci.prototype,"reflections",void 0),c([m()],Ci.prototype,"ambientOcclusion",void 0),c([m()],Ci.prototype,"memoryLimit",void 0),c([m()],Ci.prototype,"additionalCacheMemory",void 0),c([m()],Ci.prototype,"frameRate",void 0),c([m()],Ci.prototype,"maximumPixelRatio",void 0),Ci=c([F("esri.views.3d.support.QualitySettings")],Ci);const n0=Ci;var kr;(function(s){s[s.ELEVATION=0]="ELEVATION",s[s.BASEMAP=1]="BASEMAP",s[s.I3S_INDEX=2]="I3S_INDEX",s[s.I3S_DATA=3]="I3S_DATA",s[s.SYMBOLOGY=4]="SYMBOLOGY"})(kr||(kr={}));const r$=(()=>{const s=new Array;return s[kr.ELEVATION]=10,s[kr.BASEMAP]=10,s[kr.I3S_INDEX]=10,s[kr.I3S_DATA]=10,s[kr.SYMBOLOGY]=5,s})(),a$=30;function n$(s){return"usedMemory"in s&&"unloadedMemory"in s&&"ignoresMemoryFactor"in s}function o$(s){return new ki({view:s})}const o0=.1,Su=1,Tm=1,l$=.75,h$=.6,l0=1.3;let ki=class extends Re{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new FO,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles(mp({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){e==null||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(Su),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){e!=null&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t,i){return new UO(e,this._cacheStorage,t,i)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();this._memoryPredicted<h$&&this._canFastRecover?(this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(Su)):e?(this._memoryPredicted>1.1*Tm||this._usedMemory>Tm)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>o0&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/l0),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1)):(this._downscaleMemoryUsed=0,this._usedMemory>Tm?(this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/l0),this._downscaleMemoryUsed=this._memoryPredicted):this._stableQuality!==this._quality&&(this._usedMemory<l$&&this._quality<Su?(this._stableQuality=this._quality,e=this._updateQuality(this._quality+.05)):this._quality<1&&(this._canFastRecover=!0))),this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,o0),Su))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){var o,l,h,u,d;if(!this.view)return;(l=(o=this.view._stage)==null?void 0:o.renderer)==null||l.tick();const e=(u=(h=this.view._stage)==null?void 0:h.renderer)==null?void 0:u.usedMemory;let t=(((d=this.view.basemapTerrain)==null?void 0:d.usedMemory)??0)+(e?e.fbos+e.edges+e.plugins:0),i=0;this.view.allLayerViews&&this.view.allLayerViews.forEach(p=>{if(n$(p)){const _=p.ignoresMemoryFactor?this._quality:1;t+=p.usedMemory*_,i+=p.unloadedMemory*_}});const r=this._warnMemoryUsage==null||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),a=1048576*this.maxMemory;if(t>a&&r){this._warnMemoryUsage=t;const p=f=>(f/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",_=Math.round(100*this._quality);pe.getLogger(this).warn(`Memory Limit exceeded! Limit: ${p(a)} Current: ${p(t)} Projected: ${p(t+i)} Quality: ${_}%`)}this._usedMemory=t/a,this._memoryPredicted=(t+i)/a;const n=a-t;this._cacheStorage.maxSize=Math.max(0,n+1048576*this.additionalCacheMemory)}get test(){}};c([m({constructOnly:!0})],ki.prototype,"view",void 0),c([m()],ki.prototype,"maxMemory",null),c([m()],ki.prototype,"additionalCacheMemory",null),c([m({readOnly:!0})],ki.prototype,"memoryFactor",null),c([m({readOnly:!0})],ki.prototype,"updating",null),c([m({readOnly:!0})],ki.prototype,"usedMemory",null),c([m({readOnly:!0})],ki.prototype,"usedCacheMemory",null),c([m()],ki.prototype,"_quality",void 0),c([m()],ki.prototype,"_usedMemory",void 0),c([m()],ki.prototype,"_updating",void 0),c([m()],ki.prototype,"_stableQuality",void 0),c([m()],ki.prototype,"_maxMemory",void 0),c([m()],ki.prototype,"_additionalCacheMemory",void 0),ki=c([F("esri.views.3d.support.MemoryController")],ki);let c$=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},u$=class{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new d$}},d$=class{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}},p$=class{constructor(e,t,i,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=r.map(a=>new u$(a))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(i,r)=>this._taskCallback(i,r))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,ws(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(t,i)=>this._taskCallback(t,i)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){}},m$=class{constructor(e,t){this.element=e,this.type="image+type",this.isOpaque=t==="image/jpeg"}},cd=class extends Re{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,i){this._loadQueue=new p$((r,a)=>this._startLoading(r,a),(r,a)=>this._doneLoadingCB(r,a),e,t),i&&(this._frameTask=i.registerTask(ai.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=ea(this._frameTask),this._tasks.forEach(e=>xn(e.abortController)),this._loadQueue=se(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,i,r={}){const a=ug();a.__signal=r!=null?r.signal:null;const n=this._createOrUpdateTask(e,t,i,r,a);return pp(r,()=>this._cancelRequest(n,a)),a.promise}_createTask(e,t,i,r,a,n){const o=new f$(e,t,i,r,a);return this._updateTask(o,n),this._tasks.set(a,o),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){var i;Dd(e.resolvers,t),t.reject(_r()),e.resolvers.length===0&&(e.status===Hs.DOWNLOADING&&(e.status=Hs.CANCELLED,this._loadQueue.cancel(e),(i=e.abortController)==null||i.abort(),e.request=null,e.abortController=null),e.status=Hs.CANCELLED,this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,i,r,a){const n=y$((r==null?void 0:r.uid)||e,t,i),o=this._tasks.get(n);return o?(this._updateTask(o,a),o):this._createTask(e,r,t,i,n,a)}_doneLoadingCB(e,t){this._loadQueue&&(ws(e.status===Hs.DOWNLOADING),e.status=Hs.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();Ai(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==Hs.DOWNLOADED&&(t.err=t.err||_r()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!cn(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=Cg(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)cn(t)?r.reject(t):r.reject(new Ri("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;const a=i>0?Ad(e.result):e.result;r.resolve(a)}this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,t){if(e.status===Hs.CANCELLED)return!1;let i,r;switch(e.startTime=performance.now(),e.status=Hs.DOWNLOADING,e.docType){case"binary":r="array-buffer",i=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const a=e.abortController.signal;e.request=Hp(e.url,{...e.options,responseType:r,timeout:i,signal:a});const n=l=>{e.duration=performance.now()-e.startTime,e.size=l instanceof ArrayBuffer?l.byteLength:e.size||0,e.result=l,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},o=l=>{e.status===Hs.DOWNLOADING&&t(e,l)};return e.docType!=="image+type"?(e.request.then(l=>n(l.data),o),!0):(e.request.then(l=>{const h=l.data,u=g$(h);if(r="image",e.size=h.byteLength,u==="unknown")return e.request=Hp(e.url,{responseType:r,timeout:i,signal:a}),void e.request.then(_=>n(_.data),o);const d=new Blob([h],{type:u}),p=window.URL.createObjectURL(d);e.request=Hp(p,{responseType:r,timeout:i,signal:a}),e.request.then(_=>n(new m$(_.data,u)),o).finally(()=>window.URL.revokeObjectURL(p))},o),!0)}get test(){}};c([m({readOnly:!0})],cd.prototype,"updating",void 0),cd=c([F("esri.views.3d.support.StreamDataLoader")],cd);const _$={numRetries:0};function g$(s){if(s.byteLength<2)return"unknown";const e=new Uint8Array(s,0,s.byteLength);return e[0]===137&&e[1]===80?"image/png":e[0]===71&&e[1]===73?"image/gif":e[0]===66&&e[1]===77?"image/bmp":e[0]===255&&e[1]===216?"image/jpeg":"unknown"}let f$=class extends c${constructor(e,t,i,r,a){super(r),this.url=e,this.options=t,this.docType=i,this.key=a,this.result=null,this.status=Hs.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=_$.numRetries}};function y$(s,e,t){return`${s}:${e}:${t}`}var Hs;(function(s){s[s.QUEUED=1]="QUEUED",s[s.DOWNLOADING=2]="DOWNLOADING",s[s.DOWNLOADED=3]="DOWNLOADED",s[s.CANCELLED=4]="CANCELLED"})(Hs||(Hs={}));let ud=class extends Re{constructor(){super(...arguments),this.updating=!1}};function v$(s){return new Vr({view:s})}c([m({readOnly:!0})],ud.prototype,"updating",void 0),ud=c([F("esri.views.3d.support.ResourceController.ResourceControllerMain")],ud);let Vr=class extends ud{constructor(){super(...arguments),this._immediateTask=qd,this._normalTask=qd,this._updatingObjects=Da([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=sE(),this._memoryController=o$(this.view),this._streamDataLoader=new cd,this._streamDataLoader.setup(a$,r$,this._scheduler),this.addHandles([O(()=>{var e;return(e=this.view.state)==null?void 0:e.mode},e=>{e!=null&&(this._scheduler.state=e)},Ge),O(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=mp({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(ai.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(ai.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=ea(this._frameTask),this._streamDataLoader=se(this._streamDataLoader),this._memoryController=se(this._memoryController),this._scheduler=se(this._scheduler),this.view=null}get updating(){var e,t,i,r;return!!((e=this._memoryController)!=null&&e.updating||(t=this._streamDataLoader)!=null&&t.updating||(i=this._immediateTask)!=null&&i.updating)||((r=this._updatingObjects)==null?void 0:r.value.some(a=>a.updating))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,r,a)=>t.request(i,r,e,a),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],po(()=>{t.value=t.value.filter(i=>i!==e)})}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(kb(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.frame(e))}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};c([m()],Vr.prototype,"view",void 0),c([m()],Vr.prototype,"_scheduler",void 0),c([m()],Vr.prototype,"_memoryController",void 0),c([m()],Vr.prototype,"_streamDataLoader",void 0),c([m()],Vr.prototype,"_immediateTask",void 0),c([m()],Vr.prototype,"_normalTask",void 0),c([m({readOnly:!0})],Vr.prototype,"updating",null),Vr=c([F("esri.views.3d.support.ResourceController")],Vr);let b$=class{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}},w$=class{constructor(e){var t,i,r,a;if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,e.resourceController!=null){const n=e.resourceController.memoryController;this.totalMemory=(n.maxMemory??0)*zO.MEGABYTES,this.usedMemory=Math.round(n.usedMemory*this.totalMemory),this.quality=e.quality,this.load=e.resourceController.scheduler.load,this.cachedMemory=n.usedCacheMemory}this.terrainMemory=((t=e.basemapTerrain)==null?void 0:t.usedMemory)??0,this.edgesMemory=((i=e._stage)==null?void 0:i.renderer.usedMemory.edges)??0,this.fboMemory=((r=e._stage)==null?void 0:r.renderer.usedMemory.fbos)??0,(a=e.allLayerViews)==null||a.items.forEach(n=>{FE(n)&&this.layerPerformanceInfos.push(new b$(n))}),this.layerPerformanceInfos.sort((n,o)=>o.memory-n.memory)}},x$=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",()=>{}),this._wosrMemCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,i){const r=i?`gltfPBR:${e}`:`gltf:${e}`,a=this._gltfMemCache.get(r);return a!=null?Promise.resolve(a):h0(this._gltfLoading,this._gltfMemCache,r,async n=>{const{loadGLTF:o}=await X(()=>import("./loader-B7wNe1V9.js"),__vite__mapDeps([567,1,47,74,8,3,4,9,256,51,6,43,122,46,48,42,45,79,80,376,77]),import.meta.url);return o(new GO(n.streamDataRequester),e,n,i)},t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`,r=this._wosrMemCache.get(i);return r!=null?Promise.resolve(r):h0(this._wosrLoading,this._wosrMemCache,i,a=>BO(e,a),t)}};async function h0(s,e,t,i,r){Ai(r);const a=pp(r,()=>C$(s,t));let n=s.get(t);if(n)n.refCount++;else{const o=new AbortController;n={refCount:1,abortController:o,promise:i({...r,signal:o.signal})},s.set(t,n)}try{const o=await n.promise;return e.put(t,o),s.delete(t),Ai(r),o}finally{ea(a)}}function C$(s,e){const t=s.get(e);t!=null&&--t.refCount>0||(s.delete(e),t!=null&&t.abortController.abort())}let ml=class extends Re{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=(t==null?void 0:t.registerTask(ai.TEXTURE_UNLOAD))??qd}normalizeCtorArgs(){return{}}destroy(){var e,t,i;super.destroy(),(e=this._frameTask)==null||e.remove(),(t=this._textureRequests)==null||t.forEach(r=>this._releaseTextureRequest(r)),(i=this._textureRequests)==null||i.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const i=this.makeUid(e);let r=this._textureRequests.get(i);if(!r){const a=new px;a.texture=t(),this._stage&&(a.texture.load(this._stage.renderView.renderingContext),this._stage.add(a.texture)),this._textureRequests.set(i,a),r=a}return r.referenceCount++,new dx(i,r.texture,()=>this._release(i))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){}_releaseNow(e){var i;if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||((i=t.texture)==null||i.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){var t;e.texture?(t=this._stage)==null||t.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return t!=null?`${e}.${t}px`:e}};c([m()],ml.prototype,"_frameTask",void 0),c([m()],ml.prototype,"updating",null),ml=c([F("esri.views.3d.support.TextureCollection")],ml);let dx=class{constructor(e,t,i){this.uid=e,this.texture=t,this.release=i}},px=class{constructor(){this.referenceCount=0}},T$=class extends ml{constructor(e,t,i){super(t,i),this._streamDataRequester=e}async fromUrl(e,t,i){Ai(i);const r=i==null?void 0:i.signal,a=this.makeUid(e,t);let n=this._textureRequests.get(a);if(!n){const o=new AbortController,l=this._streamDataRequester.request(e,"image",{uid:a,signal:o.signal});n=new px,n.abortController=o;const h=n;this._textureRequests.set(a,n),n.textureAsync=l.then(async u=>{const d=this._createTexture(e,u,t);return h.texture=d,h.abortController=null,await d.load(this._stage.renderView.renderingContext),this._stage.add(d),new dx(a,d,()=>this._release(a))},u=>{throw h.abortController=null,u})}n.referenceCount++;try{return await ZC(n.textureAsync,r)}catch(o){throw this._release(a),o}}_createTexture(e,t,i){var a;const r={width:t.width,height:t.height,wrap:{s:Ki.CLAMP_TO_EDGE,t:Ki.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if(Zb(e)){if(i||t.width===0&&t.height===0){const n=t.width?t.height/t.width:1;i=i||64,n>1?(t.width=Math.round(i/n),t.height=i):(t.width=i,t.height=Math.round(i*n))}(a=this._stage.renderView)!=null&&a.renderingContext.driverTest.svgPremultipliesAlpha.result&&(r.preMultiplyAlpha=!1)}return new MP(t,r)}},S$=class{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(kr.SYMBOLOGY),this.objectResourceCache=new x$((i,r)=>e.resourceController.memoryController.newCache(i,r)),this.textures=new T$(this.streamDataRequester,e.view._stage,e.resourceController.scheduler);const t=Dt(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=lw(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=pO(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return po();this._graphicsOwners.push(e);const t=O(()=>{var i;return(i=e.layer)==null?void 0:i.screenSizePerspectiveEnabled},()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),po(()=>{t.remove(),Dd(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some(t=>{var i;return((i=t.layer)==null?void 0:i.screenSizePerspectiveEnabled)===!0});if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new dg;const t=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([O(()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance,t,Ge),this._viewState.events.on("camera-projection-changed",t)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=se(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;Pu.distance=e.centerOnSurfaceInfrequent.distance,Pu.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(Pu),this.screenSizePerspectiveSettingsLabels.update(Pu),this._view._stage.renderView.requestRender()}get test(){}};const Pu={distance:0,fovY:0};let P$=class{constructor(e){this.destination=e}hide(){this.graphic!=null&&(this.destination.remove(this.graphic),this.graphic=null)}},rl=class extends P${constructor(e,t,i=""){super(e),this._symbol=new xE({symbolLayers:new wo([new CE({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new TE({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(!t)return;this.hide();const i=new Cs({x:e[0],y:e[1],z:e[2],spatialReference:t});this.graphic=new G1({geometry:i,symbol:this._symbol}),this.destination.add(this.graphic)}},en=class extends Re{constructor(e){super(e)}};c([m({constructOnly:!0})],en.prototype,"renderCoordsHelper",void 0),c([m({constructOnly:!0})],en.prototype,"surface",void 0),c([m({constructOnly:!0})],en.prototype,"state",void 0),en=c([F("esri.views.3d.support.pointsOfInterest.PointOfInterest")],en);const E$=Array;let or=class extends en{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new yn({location:Cs,renderLocation:E$},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=v(),this._tmpPoint=new Cs}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles(Aa(()=>{var t,i;return(i=(t=this.map)==null?void 0:t.ground)==null?void 0:i.layers},"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=se(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=vi(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return Al(i,t)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){var r;if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!((r=this.map)!=null&&r.ground))return this._updateSurfaceAltitude(0),Xi;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>O$&&this.renderCoordsHelper.viewingMode===Ne.Global&&(e.isWGS84||e.isWebMercator);let i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:t?M$:0}).then(a=>this._updateSurfaceAltitude(a.geometry.z??0)).catch(a=>{cn(a)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===i&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),i=null}),this._pendingElevationQueryController=i,Xi}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(Sm,this._estimatedSurfaceAltitude,this._camera.eye),vp(this._get("renderLocation"),Sm)||(this._set("renderLocation",le(this._propertiesPool.get("renderLocation"),Sm)),this.notifyChange("renderLocation"))}};c([m({constructOnly:!0})],or.prototype,"scheduler",void 0),c([m({constructOnly:!0})],or.prototype,"cache",void 0),c([m({constructOnly:!0})],or.prototype,"task",void 0),c([m()],or.prototype,"location",null),c([m({constructOnly:!0})],or.prototype,"map",void 0),c([m()],or.prototype,"renderLocation",void 0),c([m()],or.prototype,"scale",null),c([m()],or.prototype,"updating",null),or=c([F("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],or);const Sm=v(),O$=1e5,M$=1e6,R$=Array;let zs=class extends en{constructor(e){super(e),this._propertiesPool=new yn({location:Cs,renderLocation:R$},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=v(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=ea(this._frameWorker),this._propertiesPool=se(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Xi}_updateRenderLocation(){const e=D$;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=$$;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(le(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=vi(this._camera.eye,e):(ee(e,this._camera.viewForward,this._get("distance")),ue(e,e,this._camera.eye)),vp(this._get("renderLocation"),e)||this._set("renderLocation",le(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){var r,a;const i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const n=Dt(this.renderCoordsHelper.spatialReference).radius,o=n+e,l=Zs(i.eye),h=l<o*o,u=vi(i.eye,t);if(h&&u>n/4){const d=o-Math.sqrt(l);return ee(t,i.viewForward,d),ue(t,t,i.eye),!0}}else{const n=(r=this.surface)!=null&&r.ready?this.surface.extent:null;n!=null&&Jb(n,(a=this.surface)==null?void 0:a.spatialReference,mh,this.renderCoordsHelper.spatialReference)&&(t[0]=Q(t[0],mh[0],mh[2]),t[1]=Q(t[1],mh[1],mh[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(xs.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=vi(i,e),a=vi(i,t);if(Math.abs(a-r)/r>A$)return!0}return!1}};c([m({constructOnly:!0})],zs.prototype,"scheduler",void 0),c([m({constructOnly:!0})],zs.prototype,"task",void 0),c([m()],zs.prototype,"distance",void 0),c([m({constructOnly:!0})],zs.prototype,"estimateSurfaceAltitudeAtCenter",void 0),c([m({readOnly:!0})],zs.prototype,"location",null),c([m({readOnly:!0})],zs.prototype,"renderLocation",void 0),c([m()],zs.prototype,"updating",void 0),zs=c([F("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],zs);const A$=.05,D$=v(),$$=v(),mh=pi();let I$=class{constructor(e){this._handles=new dg,this.events=new Va,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",t=>this._layerViewsChanged(t))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=se(this._handles),this._contentLayerViews.destroy()}_layerViewsChanged(e){e.added.forEach(t=>{t.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this._handles.add(t.on("visible-geometry-changed",()=>this._contentChanged()),t.uid)}),e.removed.forEach(t=>this._handles.remove(t.uid))}_contentChanged(){this.events.emit("request-update",L$)}};const L$={},N$=Array;let lr=class extends en{constructor(e){super(e),this._propertiesPool=new yn({location:Cs,renderLocation:N$},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([O(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),O(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.addHandles(this.scheduler.registerTask(ai.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=se(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,c0);const a=Math.max(0,(Math.acos(oe(c0,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(a)){if(!e||!nc(e,t)){const h=this._propertiesPool.get("renderLocation");le(h,t),this._set("renderLocation",h)}return Xi}const n=1-Q(a/(.5*Math.PI),0,1),o=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(u0);const l=this._propertiesPool.get("renderLocation");return Tr(l,t,u0,o),e&&nc(e,l)||this._set("renderLocation",l),Xi}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter(_p());if(i[1]=t.aboveGround?t.padding[vs.BOTTOM]:t.fullHeight-t.padding[vs.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,_h)){ye(_h,_h,t.eye);const a=ie(_h,_h);if(this.renderCoordsHelper.intersectInfiniteManifold(Il(t.eye,a),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};c([m()],lr.prototype,"_dirty",void 0),c([m({constructOnly:!0})],lr.prototype,"scheduler",void 0),c([m({constructOnly:!0})],lr.prototype,"centerOnSurface",void 0),c([m({constructOnly:!0})],lr.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),c([m()],lr.prototype,"updating",null),c([m()],lr.prototype,"location",null),c([m()],lr.prototype,"renderLocation",void 0),c([m()],lr.prototype,"worldUnitsPerContentPixel",null),lr=c([F("esri.views.3d.support.pointsOfInterest.Focus")],lr);const c0=v(),_h=v(),u0=v();let ya=class extends Re{get surface(){var e;return(e=this.view.map)==null?void 0:e.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=v();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([O(()=>{var e,t;return[(e=this.surfaceView)==null?void 0:e.spatialReference,(t=this.surfaceView)==null?void 0:t.extent]},()=>this._update()),Aa(()=>{var e;return(e=this.surface)==null?void 0:e.layers},"change",()=>this._update())]),this._update())}_update(){var i;if(this._updateController&&(this._updateController.abort(),this._updateController=null),((i=this.surfaceView)==null?void 0:i.extent)==null||this.surfaceView.spatialReference==null)return void this._set("location",null);const e=i1(this.surfaceView.extent),t=new Cs({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(r=>{this._updateController=null,this._set("location",r.geometry)}).catch(r=>{})):this._set("location",t)}};c([m({constructOnly:!0})],ya.prototype,"view",void 0),c([m({constructOnly:!0})],ya.prototype,"cache",void 0),c([m()],ya.prototype,"surface",null),c([m()],ya.prototype,"surfaceView",null),c([m({readOnly:!0})],ya.prototype,"location",void 0),c([m({readOnly:!0})],ya.prototype,"renderLocation",null),ya=c([F("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],ya);let va=class extends Re{constructor(e){super(e),this._tileGeometryUpdateExtent=_o(),this._tileGeometryUpdateSpatialReference=null,this.events=new Va,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(ai.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",V$),_o(this._tileGeometryUpdateExtent),this._set("updating",!1),Xi):Xi}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,vl(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.contentCamera.eye,r=F$,a=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,In,t),this.renderCoordsHelper.fromRenderCoords(a.renderLocation,Ln,t),In[0]<Ln[0]?(r[0]=In[0],r[2]=Ln[0]):(r[0]=Ln[0],r[2]=In[0]),In[1]<Ln[1]?(r[1]=In[1],r[3]=Ln[1]):(r[1]=Ln[1],r[3]=In[1]),tc(r,e)}};c([m({constructOnly:!0})],va.prototype,"state",void 0),c([m({constructOnly:!0})],va.prototype,"centerOnSurfaces",void 0),c([m({constructOnly:!0})],va.prototype,"renderCoordsHelper",void 0),c([m({constructOnly:!0})],va.prototype,"scheduler",void 0),c([m({constructOnly:!0})],va.prototype,"surface",void 0),c([m({readOnly:!0})],va.prototype,"updating",void 0),va=c([F("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],va);const V$={},In=v(),Ln=v(),F$=_o();let ss=class extends Re{constructor(e){super(e),this.renderPointOfView=v(),this._pois=new Array,this._debugCenters=null,this._tmpRay=To(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new yn({renderPointOfView:U$},this)}initialize(){var h;const{state:e,basemapTerrain:t,renderCoordsHelper:i,map:r}=this.view;this._surfaceIntersector=sa(e.viewingMode),this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=Xr.MIN,this._contentIntersector=sa(e.viewingMode);const a=()=>this._estimateSurfaceAltitudeAtCenter(),n=this.view.resourceController.scheduler,o=(h=this.view.basemapTerrain)==null?void 0:h.elevationQueryCache,l={state:e,scheduler:n,surface:t,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new zs({...l,task:ai.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:a})),this._set("centerOnSurfaceFrequent",new zs({...l,task:ai.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:a})),this._set("centerOnContent",new zs({...l,task:ai.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new or({...l,cache:o,task:ai.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new va({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new I$({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:i})),this._set("surfaceOrigin",new ya({cache:o,view:this.view})),this._set("focus",new lr({state:e,scheduler:n,surface:t,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(u,d)=>this._estimateSurfaceIntersectionAtRenderPoint(u,this.view.state.contentCamera,d)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus),this.addHandles([O(()=>e.contentCamera,u=>this._cameraChanged(u),Ge),O(()=>t.extent,()=>this._updateCenterPointsOfInterest()),O(()=>{var u,d,p;return(p=(d=(u=this.view.map)==null?void 0:u.ground)==null?void 0:d.navigationConstraint)==null?void 0:p.type},u=>{this._surfaceIntersector.options.backfacesTerrain=u==="none"},at),Pl(()=>!t.updating,()=>this._updateCenterPointsOfInterest(),Ge),Aa(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),Aa(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),O(()=>xs.SHOW_POI,u=>this._setDebug(u),at)]),this._cameraChanged(this.view.state.contentCamera);for(const u of this._pois)u.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!(!((e=this.surfaceGeometryUpdates)!=null&&e.updating)&&!this._pois.some(t=>t.updating))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return e==null||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,zo,z$)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(zo):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(e==null)return this._surfaceAltitudeAtCenter;const t=e.origin,i=ue(zo,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(zo)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(zo)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=X1(t,e,H$);if(r==null)return null;const a=r.origin,n=ue(zo,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,a,n),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;vp(this.renderPointOfView,t)||this._set("renderPointOfView",le(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){var t;if(!e)return(t=this._debugCenters)==null||t.forEach(i=>i.hide()),void this.removeHandles("debug");if(!this._debugCenters){this._debugCenters=new Map;const i=this.view.graphics;this._debugCenters.set(this.centerOnContent,new rl(i,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new rl(i,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new rl(i,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new rl(i,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new rl(i,"green","Focus"))}for(const i of this._pois)this.addHandles(O(()=>i.renderLocation,r=>{var a,n;return(n=(a=this._debugCenters)==null?void 0:a.get(i))==null?void 0:n.show(r,i.renderCoordsHelper.spatialReference)},at),"debug")}get test(){}};c([m()],ss.prototype,"centerOnContent",void 0),c([m()],ss.prototype,"centerOnSurfaceFrequent",void 0),c([m()],ss.prototype,"centerOnSurfaceInfrequent",void 0),c([m()],ss.prototype,"cameraOnSurface",void 0),c([m()],ss.prototype,"focus",void 0),c([m()],ss.prototype,"renderPointOfView",void 0),c([m()],ss.prototype,"surfaceOrigin",void 0),c([m()],ss.prototype,"contentGeometryUpdates",void 0),c([m()],ss.prototype,"surfaceGeometryUpdates",void 0),c([m({constructOnly:!0})],ss.prototype,"view",void 0),c([m()],ss.prototype,"updating",null),ss=c([F("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],ss);const U$=Array,zo=v(),H$=To(),z$={exclude:new Set([_c])},G$=()=>pe.getLogger("esri/core/MemCachePool");let Uc=class{constructor(e,t){this._cache=e(t,(i,r,a)=>{switch(r){case Uy.ALL:return i.forEach(n=>n.dispose()),0;case Uy.SOME:{const n=i.shift();return n?(a-=Math.round(n.cachedMemory),n.dispose()):a>0&&(G$().warn("Encountered empty MemCachePool with non-zero memory."),a=0),a}}})}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const i=t.pop();return t.length>0?i&&(t.cachedMemory=this._cache.getSize(e)-Math.round(i.cachedMemory),this._cache.updateSize(e,t)):this._cache.pop(e),i}put(e,t,i=HO){const r=this._cache.peek(e);if(r)r.push(t),r.cachedMemory=this._cache.getSize(e)+Math.round(t.cachedMemory),this._cache.updateSize(e,r);else{const a=new B$(t);this._cache.put(e,a,i)}}},B$=class extends Array{constructor(e){super(),this.item=e,this.cachedMemory=e.cachedMemory,this.push(e)}};const xG={value:.5,readOnly:!0},q$={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};let _l=class{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}},k$=class{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new $S(i,t)}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const a=e-this.level;if(a<=0)return r;const n=2**a;if(!(Math.floor(t/n)===this.i&&Math.floor(i/n)===this.j))return r;let o=1/0,l=-1/0;const h=this.samplerData.data.width,u=this.samplerData.data.values,d=.5*xg;let p=(h-1)/n,_=(i-this.j*n)*p,f=(t-this.i*n)*p;if(p<1){const g=Math.floor(_),y=Math.floor(f),b=g+y*h,x=u[b],C=u[b+1],T=u[b+h],P=u[b+h+1];if(x+C+T+P<d){const S=_-g,E=f-y,M=Wc(x,C,T,P,S,E),$=Wc(x,C,T,P,S+p,E),B=Wc(x,C,T,P,S,E+p),k=Wc(x,C,T,P,S+p,E+p);return r.min=Math.min(M,$,B,k),r.max=Math.max(M,$,B,k),r}_=g,f=y,p=1}else _=Math.floor(_),f=Math.floor(f),p=Math.ceil(p);for(let g=_;g<=_+p;g++)for(let y=f;y<=f+p;y++){const b=u[g+y*h];b<d?(o=Math.min(o,b),l=Math.max(l,b)):r.hasNoDataValues=!0}return r.min=o,r.max=l,r}};const j$=.5*xg;function bt(s,e,t){if(t==null)return null;for(const i of t){if(!i)continue;const r=i.safeWidth;let a=Q(i.dy*(i.y1-e),0,r),n=Q(i.dx*(s-i.x0),0,r);const o=Math.floor(a),l=Math.floor(n),h=i.data.width,u=o*h+l,d=i.data.values,p=d[u],_=d[u+1],f=u+h,g=d[f],y=d[f+1];if(p+g+_+y<j$){a-=o,n-=l;const b=p+(_-p)*n;return b+(g+(y-g)*n-b)*a}}return null}let Us=class extends Re{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const i=t.layer;if("operationalLayerType"in i&&WT(i.operationalLayerType)&&this.viewSpatialReference!=null){const r=mx(i.fullExtent,this.viewSpatialReference);r!=null&&e.push(VT(r))}}),e}};function W$(s,e){return s===Ne.Global?new j_(e):new W_(e)}c([m({readOnly:!0})],Us.prototype,"layerViewsExtent",null),c([m({readOnly:!0})],Us.prototype,"tiledLayersExtent",null),c([m({readOnly:!0})],Us.prototype,"stencilEnabledExtents",null),c([m()],Us.prototype,"viewSpatialReference",void 0),c([m()],Us.prototype,"tilingScheme",void 0),c([m()],Us.prototype,"defaultTiledLayersExtent",void 0),c([m({constructOnly:!0})],Us.prototype,"layers",void 0),c([m({constructOnly:!0})],Us.prototype,"layerViews",void 0),Us=c([F("esri.views.3d.terrain.ExtentHelper")],Us);let j_=class extends Us{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?IS:LS}};j_=c([F("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],j_);let W_=class extends Us{_computeLayerViewsExtent(){const e=_o(),t=this.viewSpatialReference;this.layerViews.forEach(a=>{const n=a.layer;if(a.isResolved()&&(n.type!=="graphics"||!n.internal)){const o=mx("fullExtentInLocalViewSpatialReference"in a&&a.fullExtentInLocalViewSpatialReference||a.layer.fullExtent,t);vl(e,o,e)}});const i=ty(e)?e:null,r=this._get("layerViewsExtent");return no(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=_o();this.layers.forEach(n=>{var o;if(n.loaded&&zh(n)){const l=fp(n,t,Ne.Local);if(l==null)return;const{tileInfo:h,fullExtent:u}=l,d="tilemapCache"in n?(o=n.tilemapCache)==null?void 0:o.effectiveMaxLOD:void 0;h!=null&&u!=null&&(_1(n)||e.compatibleWith(h,d)&&u.spatialReference.equals(e.spatialReference))&&vl(i,u,i)}}),vl(i,this.defaultTiledLayersExtent,i);const r=ty(i)?i:null,a=this._get("tiledLayersExtent");return no(r,a)?a:r}};function mx(s,e){return s==null||s.spatialReference.equals(e)?s:MT(s,s.spatialReference,e)}W_=c([F("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],W_);let df=class{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}};function d0(s){if(s.length<2)return;const e=new Map;s.forAll(i=>e.set(i.from,i));let t=!0;for(;t;){t=!1;for(let i=0;i<s.length;++i){const r=s.data[i],a=e.get(r.to);a&&(r.to=a.to,e.delete(a.from),s.removeUnordered(a),t=!0)}}}let p0=class extends df{constructor(e,t,i,r){super(t,i),this.geometry=e,this._highlightName=null,this.updateHighlightOptions(r)}updateHighlightOptions(e){const{geometry:t}=this;if(!t.hasHighlights)return void(this._highlightName=null);let i=-1,r=null;t.foreachHighlightOptions(a=>{const n=e.get(a)??-1;n>i&&(i=n,r=a)}),this._highlightName=r}get highlightName(){return this._highlightName}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}get hasOccludees(){return this.geometry.occludees!=null}},Q$=class{constructor(){this.first=0,this.count=0}},Y$=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new mt({allocator:e=>e||new df,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightNames=new Set,this.drawCommandsDefault=Eu(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=Eu(),this.drawCommandsShadowHighlightRest=Eu()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightNames.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightNames.clear()}updateIfDrawCommandsDirty(e,t){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const i of this.instances.values())this.updateDrawState(i);this.updateDrawCommands(e,t)}}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,i){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,r.from=t,r.to=i,this._numElements+=r.numElements)}updateDrawState(e){if(e.isVisible){const{highlightName:t}=e;t&&this.highlightNames.add(t),e.hasOccludees&&(this.hasOccludees=!0)}else this.hasHiddenInstances=!0}updateDrawCommands(e,t){if(this.drawCommandsDefault.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;const{sortedInstances:i}=this;if(this._updateHighlightDrawCommands(e,i),!this.needsMultipleCommands()){const r=this.drawCommandsDefault.pushNew(),a=this.holes.front();return this.vao!=null&&this.holes.length===1&&a.to===Math.floor(this.vao.byteSize/t)?(r.first=0,void(r.count=a.from)):(r.first=1/0,r.count=0,this._instances.forEach(n=>{r.first=Math.min(r.first,n.from),r.count=Math.max(r.count,n.to)}),void(r.count-=r.first))}for(const r of i)r.isVisible&&Pm(r.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,r)}get sortedInstances(){return Array.from(this._instances.values()).sort((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from)}updateHighlights(e){this.highlightNames.clear();const t=this.sortedInstances;for(const i of t)i.updateHighlightOptions(e),i.isVisible&&i.highlightName&&this.highlightNames.add(i.highlightName);this._updateHighlightDrawCommands(e)}_updateHighlightDrawCommands(e,t=this.sortedInstances){const{drawCommandsHighlights:i,drawCommandsShadowHighlightRest:r}=this;i.clear(),r.clear();for(const a of t){if(a.updateHighlightOptions(e),!a.isVisible)continue;const{highlightName:n}=a;n&&(this.highlightNames.add(n),Pm(pg(i,n,Eu),a)),n&&n===nn||Pm(r,a)}}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function Z$(s){return s.vao!=null}function Eu(){return new mt({allocator:s=>s||new Q$,deallocator:s=>s})}function Pm(s,e){const t=s.back();if(t==null){const i=s.pushNew();return i.first=e.from,void(i.count=e.numElements)}if(X$(t,e)){const i=e.from-t.first+e.numElements;t.count=i}else{const i=s.pushNew();i.first=e.from,i.count=e.numElements}}function X$(s,e){return s.first+s.count>=e.from}let K$=class{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(t=>t.instances.has(e))}},ao=class extends Cp{get _hasHighlights(){return this._highlightNames.size>0}hasHighlightOptions(e){return this._highlightNames.has(e)}constructor(e){super(e),this._dataByOrigin=new Map,this._drawParameters=new cw,this._highlightNames=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=We(this._glMaterials),this._dataByOrigin.forEach(e=>e.dispose()),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this._updateProduces()}_updateProduces(){this.material.produces.forEach((e,t)=>{this._produces.set(t,i=>!(this._dataByOrigin.size===0||!(i!==D.Highlight&&i!==D.ShadowHighlight||this._hasHighlights))&&e(i))})}initializeRenderContext(e,t){this._glMaterials=new xO(this.material,t??e.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,Fa(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(e){return this.material.queryRenderOccludedState(e)}get numGeometries(){let e=0;return this._dataByOrigin.forEach(t=>e+=t.buffers.reduce((i,r)=>i+r.instances.size,0)),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach(t=>e+=t.buffers.reduce((i,r)=>i+r.vao.cachedMemory,0)),e}forEachGeometry(e){this._dataByOrigin.forEach(t=>t.buffers.forEach(i=>i.instances.forEach(({geometry:r})=>e(r))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}updateHighlights(e){this.highlightOrderMap=e,this._highlightNames.clear(),this._dataByOrigin.forEach(t=>{t.buffers.forEach(i=>{i.updateHighlights(e),i.highlightNames.forEach(r=>this._highlightNames.add(r))})}),this._updateProduces()}_updateGeometries(e){const t=this._bufferWriter;if(t==null)return;const i=t.vertexBufferLayout.stride/4;for(const r of e){const a=r.renderGeometry,n=this._dataByOrigin.get(a.localOrigin.id),o=n==null?void 0:n.findBuffer(a.id);if(o==null)return;const l=o.instances.get(a.id);if(r.updateType&(Ui.GEOMETRY|Ui.TRANSFORMATION)){const h=Ru(t.elementCount(l.geometry.geometry.attributes)*i),u=t.vertexBufferLayout.createView(h.buffer);this._writeGeometry(a,u,0),o.vao.vertexBuffers.get("geometry").setSubData(h,l.from*i,0,l.numElements*i)}r.updateType&(Ui.HIGHLIGHT|Ui.OCCLUDEE|Ui.VISIBILITY)&&(o.drawCommandsDirty=!0)}}_computeDeltas(e,t){const i=new Yd;for(const r of e){const a=r.localOrigin;if(a==null)continue;let n=i.get(a.id,null);n==null&&(n=new m0(a.vec3),i.set(a.id,null,n)),n.changes.push(r)}for(const r of t){const a=r.localOrigin;if(a==null)continue;const n=this._dataByOrigin.get(a.id),o=n==null?void 0:n.findBuffer(r.id);if(o==null)continue;let l=i.get(a.id,o);l==null&&(l=new m0(a.vec3),i.set(a.id,o,l)),l.changes.push(r)}return i}_addAndRemoveGeometries(e,t){if(this._bufferWriter==null||this._vaoCache==null)return;const{_bufferWriter:i,_dataByOrigin:r}=this,a=i.vertexBufferLayout.stride/4,n=this._computeDeltas(e,t);n.forEach((o,l)=>{const h=o.get(null),u=(h==null?void 0:h.changes)??[];n.delete(l,null);let d=r.get(l);if(o.forEach((p,_)=>{if(n.delete(l,_),_==null)return void ws(!1,"No VAO for removed geometries");if(_.instances.size===p.changes.length)return this._vaoCache.deleteVao(_.vao),Dd(d.buffers,_),void(d.buffers.length===0&&u.length===0&&r.delete(l));const f=_.numElements,g=_.vao.byteSize/4,y=u.reduce((T,P)=>T+i.elementCount(P.geometry.attributes),0),b=p.changes.reduce((T,P)=>T+i.elementCount(P.geometry.attributes),0),x=Math.min((f+y-b)*a,Mu),C=x>g;x>Zh&&x<g/2?(p.changes.forEach(({id:T})=>_.deleteInstance(T)),_.instances.forEach(({geometry:T})=>u.push(T)),this._vaoCache.deleteVao(_.vao),Dd(d.buffers,_)):C?this._applyAndRebuild(_,u,p):this._applyRemoves(_,p)}),u.length>0)for(d==null&&(d=new K$(h.origin),r.set(l,d)),d.buffers.forEach(p=>this._applyAdds(p,u));u.length>0;)d.buffers.push(this._applyAndRebuild(new Y$,u,null))})}_updateDrawCommands(){this._highlightNames.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach(e=>{e.buffers.forEach(t=>{t.updateIfDrawCommandsDirty(this.highlightOrderMap,this._bufferWriter.vertexBufferLayout.stride),t.hasHighlights&&XC(this._highlightNames,t.highlightNames),this._hasOccludees=this._hasOccludees||t.hasOccludees})})}_applyAndRebuild(e,t,i){if(i)for(const f of i.changes)e.deleteInstance(f.id);const r=this._bufferWriter,a=r.vertexBufferLayout.stride,n=a/4,o=Math.floor(Mu/n);let l=e.numElements;for(;t.length>0;){const f=t.pop(),g=r.elementCount(f.geometry.attributes);if(l+g>o&&l>0){t.push(f);break}l+=g;const y=new p0(f,0,0,this.highlightOrderMap);ws(e.instances.get(f.id)==null),e.addInstance(f.id,y)}const h=l*n,u=Ru(h),d=r.vertexBufferLayout.createView(u.buffer);let p=0;e.resetInstanceSummary(),e.instances.forEach((f,g)=>{this._writeGeometry(f.geometry,d,p);const y=p;p+=r.elementCount(f.geometry.geometry.attributes),e.updateInstance(g,y,p),e.updateDrawState(f)}),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(g0(h)),e.vao.vertexBuffers.get("geometry").setSubData(u,0,0,p*n),e.holes.clear();const _=e.holes.pushNew();return _.from=p,_.to=Math.floor(e.vao.byteSize/a),e.updateDrawCommands(this.highlightOrderMap,a),e}_applyRemoves(e,t){if(t.changes.length===0||this._bufferWriter==null)return;for(const o of t.changes){const l=o.id,h=e.instances.get(l);if(!h)continue;e.deleteInstance(l);const u=Ar.back();if(u){if(u.to===h.from){u.to=h.to;continue}if(u.from===h.to){u.from=h.from;continue}}const d=Ar.pushNew();d.from=h.from,d.to=h.to}d0(Ar);const i=this._bufferWriter.vertexBufferLayout.stride/4,r=Ar.reduce((o,l)=>Math.max(o,l.numElements),0)*i,a=Ru(r);a.fill(0,0,r);const n=e.vao.vertexBuffers.get("geometry");Ar.forAll(o=>n.setSubData(a,o.from*i,0,o.numElements*i)),e.holes.pushArray(Ar.data,Ar.length),Ar.forAll((o,l)=>Ar.data[l]=null),Ar.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(t.length===0||this._bufferWriter==null)return;if(!Z$(e))return void this._applyAndRebuild(e,t,null);const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,a=e.numElements,n=t.reduce((b,x)=>b+i.elementCount(x.geometry.attributes),0),o=Math.min((a+n)*r,Mu),l=4*o;if(e.vao.byteSize<g0(Mu-Zh)&&l>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);d0(e.holes);const h=new Array;for(const b of t){const x=i.elementCount(b.geometry.attributes),C=J$(e.holes,x);h.push(C)}const u=e.vao.vertexBuffers.get("geometry");let d=0,p=0,_=0;const f=Ru(o),g=i.vertexBufferLayout.createView(f.buffer);t.forEach((b,x)=>{const C=h[x];if(C==null)return;if(_!==C){const S=_-p;S>0&&u.setSubData(f,p*r,0,S*r),p=C,d=0}const T=i.elementCount(b.geometry.attributes);this._writeGeometry(b,g,d),d+=T,_=C+T;const P=new p0(b,C,C+T,this.highlightOrderMap);ws(e.instances.get(b.id)==null),e.addInstance(b.id,P),e.drawCommandsDirty=!0});const y=_-p;y>0&&u.setSubData(f,p*r,0,y*r),KC(t,(b,x)=>h[x]==null)}_writeGeometry(e,t,i){this._bufferWriter!=null&&(Rc(Go,e.transformation),Go[12]-=e.localOrigin.vec3[0],Go[13]-=e.localOrigin.vec3[1],Go[14]-=e.localOrigin.vec3[2],hc(Ou,Go),T1(Ou,Ou),this._bufferWriter.write(Go,Ou,e.geometry.attributes,e.geometry.objectAndLayerIdColor,t,i))}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){var f;if(!this.material.shouldRender(e))return null;const{output:t,bind:i}=e,r=this.material.produces.get(i.slot);if(!(r!=null&&r(t)))return null;const{highlight:a,slot:n}=i,o=t===D.ShadowHighlight,l=t===D.Highlight,h=l||o,u=a==null?void 0:a.name;if(h&&(this._highlightNames.size===0||l&&u&&!this._highlightNames.has(u)))return null;const d=g=>l&&!!u&&!g.has(u),p=t===D.ShadowExcludeHighlight,_=!(h||p);for(const{buffers:g}of this._dataByOrigin.values())for(const y of g){if(d(y.highlightNames))continue;const b=o?y.drawCommandsHighlights.get(nn):h?u?y.drawCommandsHighlights.get(u):y.drawCommandsHighlights.size>0:((f=(p&&y.needsMultipleCommands()?y.drawCommandsShadowHighlightRest:y.drawCommandsDefault)||null)==null?void 0:f.length)??!1,x=_&&y.drawCommandsOccludees||null;if(b||x!=null&&x.length){const C=this._glMaterials.load(e.rctx,n,t),T=C==null?void 0:C.beginSlot(i);if(T)return T}}return null}render(e,t){const{output:i,bind:r}=e,{slot:a,highlight:n}=r,o=i===D.Highlight,l=(n==null?void 0:n.name)??"";if(o&&!n)return;const h=i===D.ShadowHighlight,u=o||h,d=i===D.ShadowExcludeHighlight,p=!(u||d),_=a===j.OCCLUDER_MATERIAL||a===j.TRANSPARENT_OCCLUDER_MATERIAL?a:null,{rctx:f}=e;f.runAppleAmdDriverHelper();const g=f.bindTechnique(t,r,this.material.parameters);for(const y of this._dataByOrigin.values())for(const b of y.buffers){if(o&&(!b.hasHighlights||!b.drawCommandsHighlights.has(l))||h&&(!b.hasHighlights||!b.drawCommandsHighlights.has(nn)))continue;const x=()=>{const E=[],M=b.drawCommandsHighlights.get(nn)??new mt;return M&&E.push(M),E},C=u&&!h?b.drawCommandsHighlights.get(l)??null:null,T=h?x():u?C?[C]:eI:d&&b.needsMultipleCommands()?[b.drawCommandsShadowHighlightRest]:[b.drawCommandsDefault],P=T.some(E=>E.length>0),S=p&&b.drawCommandsOccludees||null;if(P||S!=null&&S.length){if(this._drawParameters.origin=y.origin,g.bindDraw(r,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(b.vao),f.bindVAO(b.vao),P)for(const E of T)f.setPipelineState(t.getPipeline(!1,_)),E.forAll(M=>f.drawArrays(t.primitiveType,M.first,M.count));S!=null&&S.length&&(f.setPipelineState(t.getPipeline(!0,_)),S.forAll(E=>f.drawArrays(t.primitiveType,E.first,E.count)))}}}static prune(){dd=new Float32Array(Zh)}get test(){}};c([m({constructOnly:!0})],ao.prototype,"material",void 0),c([m({})],ao.prototype,"highlightOrderMap",void 0),ao=c([F("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],ao);let m0=class{constructor(e){this.origin=e,this.changes=new Array}};function J$(s,e){const t=s.find(r=>r.numElements>=e);if(t==null)return null;const i=t.from;return t.from+=e,t.from>=t.to&&s.removeUnordered(t),i}const Go=It(),Ou=It(),Ar=new mt({allocator:s=>s||new df,deallocator:null}),Zh=65536,Em=4*Zh,_0=1024,_x=16777216,Mu=_x/4;let dd=new Float32Array(Zh);function Ru(s){return dd.length<s&&(dd=new Float32Array(s)),dd}function g0(s){const e=4*s;return e<=_0?_0:e<Em?JS(e):Math.max(Math.min(Math.ceil(1.5*e/Em)*Em,_x),e)}const eI=[];let Vs=class extends Re{constructor(e){super(e),this._pending=new tI,this._changes=new w_,this._renderers=new Map,this._sortedRenderers=new mt,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._sortedRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materials(){return this.rendererContext.materials}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}hasHighlightOptions(e){return qu(this._renderers,t=>t.hasHighlightOptions(e))}get hasWater(){return this._hasWater}get rendersOccludedDraped(){for(const e of this._renderers.values())if(e.numGeometries!==0&&!e.queryRenderOccludedState(Pi.Occlude))return!0;return!1}get isEmpty(){return!this.updating&&this._renderers.size===0&&this._geometries.size===0}getMaterialRenderer(e){return this._renderers.get(e)}get sortedRenderers(){return this._sortedRenderers}commitChanges(e){if(!this.updating)return!1;this._processAddsRemoves();const t=q1(this._changes);let i=!1;return t.forEach((r,a)=>{let n=this._renderers.get(a);!n&&r.adds.length>0&&(n=new ao({material:a,highlightOrderMap:e}),n.initializeRenderContext(this.rendererContext.pluginContext,this._materials),this._renderers.set(a,n),i=!0),n&&(n.modify(r),n.updateHighlights(e),n.numGeometries===0&&(this._renderers.delete(a),n.destroy(),i=!0))}),this._changes.clear(),i&&this._updateSortedMaterialRenderers(),this._hasHighlights=qu(this._renderers,r=>{const a=r.produces.get(j.DRAPED_MATERIAL);return!!a&&a(D.Highlight)}),this._hasWater=qu(this._renderers,r=>{const a=r.produces.get(j.DRAPED_WATER);return!!a&&a(D.Normal)}),this.notifyChange("updating"),!0}updateHighlights(e){this._renderers.forEach(t=>t.updateHighlights(e))}addGeometries(e,t){if(e.length===0)return;const i=this._validateRenderGeometries(e);for(const a of i)this._geometries.set(a.id,a);const r=this._pending.empty;for(const a of i)this._pending.adds.add(a);r&&this.notifyChange("updating"),t===Nt.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const i=this._pending.empty,r=this._pending.adds;for(const a of e)r.has(a)?(this._pending.removed.add(a),r.delete(a)):this._pending.removed.has(a)||this._pending.removes.add(a),this._geometries.delete(a.id);i&&!this._pending.empty&&this.notifyChange("updating"),t===Nt.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const i=this._changes.updates.length===0;for(const r of e){const a=this._changes.updates.pushNew();a.renderGeometry=this._validateRenderGeometry(r),a.updateType=t}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case Ui.TRANSFORMATION:case Ui.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case Ui.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedRenderers.forAll(i=>t=!!i.updateAnimation&&i.updateAnimation(e)||t),t}precompile(e){return this._sortedRenderers.reduce((t,i)=>i.precompile(e)||t,!1)}render(e){this._sortedRenderers.forAll(t=>{const i=t.acquireTechniques(e);i&&t.render(e,i)})}intersect(e,t,i,r,a){for(const n of this._geometries.values()){if(!r(n))continue;this._intersectRenderGeometry(n,i,t,0,e,a);const o=this.rendererContext.longitudeCyclical;o&&(n.boundingSphere[0]-n.boundingSphere[3]<o.min&&this._intersectRenderGeometry(n,i,t,o.range,e,a),n.boundingSphere[0]+n.boundingSphere[3]>o.max&&this._intersectRenderGeometry(n,i,t,-o.range,e,a)),a++}return a}_updateSortedMaterialRenderers(){this._sortedRenderers.clear();let e=0;for(const t of this._renderers.values())t.drapedPriority=e++,this._sortedRenderers.push(t);this._sortedRenderers.sort((t,i)=>{var r,a,n,o;return((r=i.material)==null?void 0:r.renderPriority)===((a=t.material)==null?void 0:a.renderPriority)?t.drapedPriority-i.drapedPriority:(((n=i.material)==null?void 0:n.renderPriority)||0)-(((o=t.material)==null?void 0:o.renderPriority)||0)})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes)),this._changes.updates.filterInPlace(({renderGeometry:e})=>!this._pending.has(e)),this._pending.clear()}_intersectRenderGeometry(e,t,i,r,a,n){if(!e.visible||!e.material.visible)return;let o=0;r+=e.transformation[12],o=e.transformation[13],Om[0]=i[0]-r,Om[1]=i[1]-o,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,a,Om,(l,h,u)=>{iI(t,u,n,e.material.renderPriority,a,e.layerUid,e.graphicUid)},t)}_notifyGraphicGeometryChanged(e){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let t;for(const{graphicUid:i}of e)i!=null&&i!==t&&(this.drapeSource.notifyGraphicGeometryChanged(i),t=i)}_notifyGraphicVisibilityChanged(e){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let t;for(const{graphicUid:i}of e)i!=null&&i!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(i),t=i)}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return e.localOrigin==null&&(e.localOrigin=this._localOriginFactory.getOrigin(wt(e.boundingSphere))),e}get test(){}};c([m()],Vs.prototype,"drapeSource",void 0),c([m()],Vs.prototype,"updating",null),c([m()],Vs.prototype,"rctx",null),c([m({constructOnly:!0})],Vs.prototype,"rendererContext",void 0),c([m()],Vs.prototype,"_materials",null),c([m()],Vs.prototype,"_localOriginFactory",null),c([m({readOnly:!0})],Vs.prototype,"isEmpty",null),c([m()],Vs.prototype,"_renderers",void 0),c([m()],Vs.prototype,"_geometries",void 0),Vs=c([F("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Vs);let tI=class{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}};function iI(s,e,t,i,r,a,n){const o=new WO(a,n,e),l=h=>{h.set(Ur.OVERLAY,o,s.dist,s.normal,s.transformation,t,i)};if((r.results.min.drapedLayerOrder==null||t>=r.results.min.drapedLayerOrder)&&(r.results.min.dist==null||r.results.ground.dist<=r.results.min.dist)&&l(r.results.min),r.options.store!==Xr.MIN&&(r.results.max.drapedLayerOrder==null||t<r.results.max.drapedLayerOrder)&&(r.results.max.dist==null||r.results.ground.dist>r.results.max.dist)&&l(r.results.max),r.options.store===Xr.ALL){const h=k1(r.ray);l(h),r.results.all.push(h)}}const Om=Ts();function gx(){var e;const s=(e=globalThis.require)==null?void 0:e.modules;if(s){const t=Object.keys(s);for(const i of t)i.includes(".glsl")&&delete s[i]}}let f0=class{constructor(e,t){this.screen=e,this.olid=t}};const fx=1.3,sI=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let ja,ts=class extends Re{constructor(e){super(e),this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._latestOriginId=0,this._maxResolution=Gi("esri-mobile")?2048:4096}initialize(){const e=this.view;this.renderer=new nP({parent:this}),e._stage.renderer.plugins.add(this.renderer);const t=()=>this.requestRender();this._groundIntersector=sa(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([O(()=>this.renderer.hasHighlights,t),this.renderer.events.on("has-water",()=>{var i;return(i=e._stage)==null?void 0:i.renderer.updateHasFlags()}),this.renderer.events.on("content-changed",t),O(()=>e.state.camera.pixelRatio,t),O(()=>e.state.alignPixelEnabled,t),this.renderer.events.on("textures-disposed",()=>this.surface.requestRender()),O(()=>{var i,r,a;return[(i=e.pointsOfInterest)==null?void 0:i.renderPointOfView,(a=(r=e.pointsOfInterest)==null?void 0:r.centerOnSurfaceFrequent)==null?void 0:a.location]},()=>this.setPlacementDirty()),O(()=>{var i,r;return[(i=e.state)==null?void 0:i.pixelRatio,(r=e.state)==null?void 0:r.contentPixelRatio]},()=>this.setPlacementDirty(),Ge),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.on("resize",()=>this.setPlacementDirty()),e.resourceController.scheduler.registerTask(ai.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",i=>{this._updateOverlays(qr,i.camera,Ce.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(Ce.BACKGROUND,i)})]),e._stage.renderer.overlay=this}destroy(){var e;(e=this.view)!=null&&e._stage&&(this.view._stage.renderer.plugins.remove(this.renderer),this.view._stage.renderer.overlay=null),ja&&(ja.hide(),ja=null),this.renderer=se(this.renderer)}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.renderer.longitudeCyclical=null;const t=this.view.renderSpatialReference;e!=null&&t!=null?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this.renderer.longitudeCyclical=e.isWebMercator?new Oy(-20037508342787e-6,20037508342787e-6):new Oy(-180,180))):this.renderer.disposeOverlays()}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||xs.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get worldToPCSRatio(){return this._spatialReference!=null&&this._spatialReference.isGeographic&&!this.view.state.isLocal?Dt(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return fx/this.view.resolutionScale}get _longitudeCyclical(){return this.renderer.longitudeCyclical}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}render(){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._precompileShaders()?this._drawOverlays(Ce.UPDATE):null}get hasOverlays(){return this.renderer.hasOverlays}registerDrapeSource(e,t,i){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const r=this.renderer.createDrapeSourceRenderer(e,t,i);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),r}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,Vs)}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&e.setDrapingExtent!=null&&this._spatialReference!=null&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.requestRender()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,Ce.UPDATE)}_updateOverlays(e,t,i){if(!this._spatialReference)return Xi;const r=this._computeOverlayResolution(t);this._computeOverlayExtents(t,r,Dr),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,Dr.stretch);const a=this._updateOverlay(Or.INNER,Dr.inner,r,1*Dr.pixelRatioAdjustment,Dr.mapUnitsPerPixel),n=Qn(Dr.inner)/Qn(Dr.outer),o=this._updateOverlay(Or.OUTER,Dr.outer,r,n*Dr.pixelRatioAdjustment,Dr.mapUnitsPerPixel);a!==Hr.EXTENT&&o!==Hr.EXTENT||(this._drapeSources.forEach(l=>this._updateDrapeSourceExtent(l)),this.updateOverlayParameters(i)),a===Hr.NONE&&o===Hr.NONE||this.requestRender(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,i=e.fullWidth/e.pixelRatio*t,r=e.fullHeight/e.pixelRatio*t,a=Math.ceil(1.5*Math.max(i,r));return Math.min(dc(a),this._maxResolution)}_updateOverlay(e,t,i,r,a){if(this.renderer.overlays.length===0)return Hr.NONE;const n=this.renderer.overlays[e],o=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=a,n.pixelRatio=r,rI(t,n.extent)&&i===n.resolution)return o===a?Hr.NONE:Hr.RERENDER_ONLY;u_(n.extent,t),n.resolution=i;const l=i1(n.extent);return n.renderLocalOrigin=kO(l[0],l[1],0,"OV_"+this._latestOriginId++),Hr.EXTENT}updateOverlayParameters(e){this.surface.allTiles.forAll(t=>this.updateTileOverlayParameters(t)),this.surface.requestRender(e)}updateTileOverlayParameters(e){if(!e.renderData)return;const t=e.renderData.overlay;if(this.renderer.overlays.length===0)this._clearTileOverlayData(Or.INNER,t),this._clearTileOverlayData(Or.OUTER,t);else{const[i,r]=this.renderer.overlays,a=e.extent;this._rectInsideRect(i.extent,a)||this._rectanglesOverlap(a,i.extent)||this._rectanglesOverlap(a,r.extent)?(this._setTileOverlayData(a,Or.INNER,t),this._setTileOverlayData(a,Or.OUTER,t)):(this._clearTileOverlayData(Or.INNER,t),this._clearTileOverlayData(Or.OUTER,t))}}overlayPixelSizeInMapUnits(e,t){if(this.renderer.overlays.length===0)return t();const i=this.renderer.overlays[Or.INNER],r=this.renderer.overlays[Or.OUTER],a=this._pointIsInExtent(e,i.extent)?i:r;return(a.extent[2]-a.extent[0])/a.resolution}_setTileOverlayData(e,t,i){if(this.renderer.overlays.length===0)return;const r=this.renderer.overlays[t].extent,a=Qn(r),n=Id(r);let o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(r[0],o);const l=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);o>l&&(o=l-(e[2]-e[0]))}i.setScale(t,Qn(e)/a,Id(e)/n),i.setOffset(t,(o-r[0])/a,(e[1]-r[1])/n)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}reloadShaders(){gx(),this.requestRender(),this.runTask(qr)}requestRender(e=Ce.UPDATE){this.renderer.hasOverlays?(e===Ce.UPDATE?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this._drawTexturesAnimateDirty=!0,this.view._stage.renderView.requestRender(e)):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r,a){const n=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,lI,t,i);if(n==null)return!1;const o=n.origin,l=ue(Au,n.origin,n.direction);this._groundIntersector.reset(o,l,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,o,l);const h=this._groundIntersector.results.min;return h.getIntersectionPoint(a)&&h.withinDistance(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,a=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,l=Q(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:a+o,e.aboveGround?a-o:1/0),h=e.aboveGround;if(this.view.viewingMode==="global"){const u=Au;Pp(Fg(Ug,Dt(this.view.spatialReference).radius+l),Il(e.eye,e.viewForward),u),ye(u,u,e.eye);const d=fn.normalize(jE(e.viewForward,u,e.viewRight))/e.fovY+.5,p=d<=0||d>=1?.5:r;i=h?p*d:d+p*(1-d)}else{const u=.5*Math.PI-Math.acos(-e.viewForward[2]),d=Math.tan(u),p=Pr(0,d,1,0),_=x_(p,p,e.projectionMatrix)[1],f=Q(.5+.5*_,0,1);i=f===1||f===0?.5:h?f*r:1-(1-f)*r}return this._intersectGroundFromView(e,.5,i,n.distance,t)}_computeOverlayExtents(e,t,i){var $;const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,a=v();this._findHorizonBasedPointOfInterest(e,a)||le(a,r),xs.OVERLAY_SHOW_CENTER?(ja==null&&(ja=new rl(this.view.graphics,"red")),ja.show(a,this._renderSR)):ja!=null&&ja.hide();const n=Math.max(.1,vi(e.eye,a)),o=pn(this.view.renderCoordsHelper,r,e.eye);this._overlaySREqualsRenderSR||Ll(a,this._renderSR,a,this._spatialReference);const l=this.surface.extent,h=!this._isSpherical&&(($=this._spatialReference)==null?void 0:$.isGeographic),u=h&&this._spatialReference?1/Dt(this._spatialReference).metersPerDegree:1,d=this.view.state.contentPixelRatio,p=e.perScreenPixelRatio/d*n*u;i.mapUnitsPerPixel=p/this.worldToPCSRatio,i.stretch=this._overlayStretch;let _=t*p/2*i.stretch,f=!1,g=h?90:1/0;this._isSpherical&&l&&this._spatialReference&&(this._spatialReference.isWebMercator?(_/=Math.cos(mT(a[1])),g=l[3]):(f=!0,_/=Dt(this._spatialReference).metersPerDegree,g=90),_>=g&&(_=g,a[1]=0,this._spatialReference.isWebMercator&&(a[0]=0)));let y=1;f&&(y=1/Math.max(.2,Math.cos(Math.abs(Rt(a[1])))),_*y>180&&(y=180/_),i.mapUnitsPerPixel*=y);const b=Math.log(2)/12;_=Math.exp(Math.round(Math.log(_)/b)*b);const x=_*y,C=32,T=.5*t/(C*x),P=.5*t/(C*_);a[0]=Math.round(a[0]*T)/T,a[1]=Math.round(a[1]*P)/P;const S=i.inner;S[0]=a[0]-x,S[1]=a[1]-_,S[2]=a[0]+x,S[3]=a[1]+_,this._isSpherical&&this._shiftExtentToFitBounds(S,1/0,g);const E=i.outer;if(6*x>Qn(l))u_(E,l);else if(Math.PI/2-Math.abs(o-Math.PI/2)<=.25*Math.PI)E[0]=S[0]-x,E[1]=S[1]-_,E[2]=S[2]+x,E[3]=S[3]+_;else{Ll(e.eye,this._renderSR,Au,this._spatialReference),SP(Nn,a,Au);let B=-Math.atan2(Nn[1],Nn[0])+.125*Math.PI;B<0&&(B+=2*Math.PI);const k=Math.floor(B/(.25*Math.PI));K1(Nn,sI[k],2*_),Nn[0]*=y,Nn[2]*=y,YE(E,S,Nn)}if(this._isSpherical)E[0]=this._longitudeCyclical.clamp(E[0]),E[2]=this._longitudeCyclical.clamp(E[2]),E[1]=Math.max(E[1],-g),E[3]=Math.min(E[3],g);else{const B=d_(S,l,nI),k=d_(E,l,oI);iy(B,k)&&(E[2]=E[0],E[3]=E[1])}const M=Math.abs(S[2]-S[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,M),i.pixelRatioAdjustment=i.mapUnitsPerPixel/M}_precompileShaders(){return!!this.renderer.hasOverlays&&(this.renderer.precompileShaders(this.view.state),!0)}_drawOverlays(e,t=this.view.state){if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const i=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const r=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),r!==this.renderer.computeValidity()&&this.updateOverlayParameters(Ce.UPDATE),i?(this.surface.requestRender(e),e===Ce.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(Ce.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return e!=null&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):tc(e,t))}_rectInsideRect(e,t){return t!=null&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:iy(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,a=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?a=e[1]+i:e[3]>i&&(a=i-e[3]),t1(e,r,a)}get test(){}};function rI(s,e){const i=xs.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(s[2]-s[0],s[3]-s[1],e[2]-e[0],e[3]-e[1]);return Math.abs(e[0]-s[0])<=i&&Math.abs(e[1]-s[1])<=i&&Math.abs(e[2]-s[2])<=i&&Math.abs(e[3]-s[3])<=i}c([m()],ts.prototype,"_spatialReference",void 0),c([m({readOnly:!0})],ts.prototype,"running",null),c([m()],ts.prototype,"_placementDirty",void 0),c([m()],ts.prototype,"_contentUpdated",void 0),c([m()],ts.prototype,"_isSpherical",null),c([m()],ts.prototype,"worldToPCSRatio",null),c([m()],ts.prototype,"renderer",void 0),c([m({constructOnly:!0})],ts.prototype,"view",void 0),c([m({constructOnly:!0})],ts.prototype,"surface",void 0),c([m()],ts.prototype,"suspended",null),c([m()],ts.prototype,"updating",null),c([m({type:Boolean})],ts.prototype,"rendersOccludedDraped",null),ts=c([F("esri.views.3d.terrain.OverlayManager")],ts);let aI=class{constructor(){this.inner=pi(),this.outer=pi(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=fx}};const Nn=Mi(),Au=v(),Dr=new aI,nI=pi(),oI=pi(),lI=To();var Hr;(function(s){s[s.NONE=0]="NONE",s[s.EXTENT=1]="EXTENT",s[s.RERENDER_ONLY=2]="RERENDER_ONLY"})(Hr||(Hr={}));let hI=class{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=Nl(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=ui(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,Nl(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,i,r){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,r),t),ue(t,t,i)}getEdgeNormal(e,t,i){const{typedBuffer:r,typedBufferStride:a}=this.vertexAttributes.normalCompressed;ZO(t,r,this.getEdgeAttributeIndex(e,i),a)}setEdgeNormalFromValues(e,t,i,r,a){this._setNormal(this.getEdgeAttributeIndex(e,t),i,r,a)}setEdgeVertexFromValuesRawPositionUV(e,t,i,r,a,n,o){const l=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(l,i,r,a),this._setUV(l,n,o)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,i,r,a,n,o,l,h,u){const d=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(d,i,r,a),this._setUV(d,n,o),this._setNormal(d,l,h,u)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,i,r){const{typedBuffer:a,typedBufferStride:n}=this.vertexAttributes.normalCompressed;fc(a,e,t,i,r,n)}_setUV(e,t,i){xr(this.vertexAttributes.uv0,e,t,i)}getEdgeAttributeIndex(e,t){return z(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}};const y0=16384;function xr(s,e,t,i){s.setValues(e,t*y0,i*y0)}let cI=class{constructor(){this.sinLonLUT=new Array(wh+1),this.cosLonLUT=new Array(wh+1),this.sinLatLUT=new Array(wh+1),this.cosLatLUT=new Array(wh+1)}update(e,t,i){const r=t[0],a=t[2];for(let n=0;n<=e;n++){const o=n/e,l=r*(1-o)+a*o;this.sinLonLUT[n]=Math.sin(l),this.cosLonLUT[n]=Math.cos(l);const h=i(o);this.sinLatLUT[n]=Math.sin(h),this.cosLatLUT[n]=Math.cos(h)}}},uI=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}},yx=class pd{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=se(this._current),this._next=se(this._next),this._waiting=se(this._waiting),this._delayed=se(this._delayed)}get current(){if(this._current==null)return null;if(!this._isFadingEnabled){const t=this._delayed||this._waiting||this._next||this._current;t!==this._current&&(this._current=null,this.clear(),this._current=t)}let e=pd.test.fadeMoment;if(this._delayed!=null&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,hn.Immediate),this._delayed=null)),this._next!=null){e=e||performance.now();const t=this._fadeDuration,i=this._current!=null&&this._next.texture===this._current.texture,r=this._next.type!==zt.FADING,a=e-this._fadeStart>=t;(i||r||a)&&(se(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(this._next==null)return 1;const e=pd.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return this._next!=null||this._delayed!=null}push(e,t=hn.Immediate){this._delayed=se(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),this._current==null)return void(this._current=e);const i=pd.test.fadeMoment||performance.now();return t!==hn.Immediate?(this._delayed=e,void(this._delayedTime=i+t)):this._next==null?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(e!=null&&(se(this._waiting),this._waiting=e))}get _fadeDuration(){const e=this._getFadeDuration();return this._waiting?.5*e:e}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}};var hn;yx.test={fadeMoment:0},function(s){s[s.Immediate=0]="Immediate",s[s.Delayed=5e3]="Delayed"}(hn||(hn={}));let hp=class{constructor(e,t,i,r,a,n){this.texture=e,this.type=t,this.offsetAndScale=i,e.retain(),this.opacities=Vt(r,a,n)}destroy(){this.texture.release()}},dI=class{constructor(){this._scales=Pr(-1,-1,-1,-1),this._offsets=Pr(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}};var Fl;(function(s){s[s.BACK_TO_FRONT=-1]="BACK_TO_FRONT",s[s.NONE=0]="NONE",s[s.FRONT_TO_BACK=1]="FRONT_TO_BACK"})(Fl||(Fl={}));let vx=class{constructor(){this._queue=new mt,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.leaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),e!=null&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){var t;const e=(t=this._last)==null?void 0:t.children;return e!=null&&e[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}},pI=class{constructor(){this._q=new mt}get done(){return this._q.length===0}reset(e){if(this._q.clear(),e!=null){this._q.pushArray(e);for(let t=0;t<this._q.length;++t){const i=this._q.data[t];i.leaf||this._q.pushArray(i.children)}}}next(){return this._q.pop()}};function co(s,e){if(e==null)return!1;const t=mI(e);if((t==null?void 0:t.fullExtent)==null)return!1;const i=t.fullExtent,r=s.extent;if(i.xmin>r[2]||i.ymin>r[3]||i.xmax<r[0]||i.ymax<r[1])return!1;const a=s.surface.tilingScheme.levels[s.level].scale,n=t.minScale;if(n>0&&a>1.00000001*n)return!1;const o=t.maxScale;return!(o>0&&a<.99999999*o)}function mI(s){return g1(s)?{fullExtent:s.fullExtent,minScale:s.layer.minScale,maxScale:s.layer.maxScale}:s.layer}function _I(s){return!g1(s)&&s.layer&&"tilemapCache"in s.layer?s.layer.tilemapCache:null}function Wr(s,e){const t=s.lij,i=e.lij;return t[0]-i[0]||t[1]-i[1]||t[2]-i[2]}function gI(s,e,t=null){t==null||t.length===0?s===Fl.BACK_TO_FRONT?e.sort(fI):e.sort(yI):e.sort((i,r)=>vI(i,r,s,t))}function fI(s,e){const t=e.screenDepth-s.screenDepth;if(t!==0)return t;const i=s.lij,r=e.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function yI(s,e){const t=s.screenDepth-e.screenDepth;if(t!==0)return t;const i=s.lij,r=e.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function bx(s,e,t){const i=s.screenDepth,r=e.screenDepth;return i<r?-t:i>r?t:Wr(s,e)}function vI(s,e,t,i){return v0(s,i)===v0(e,i)?bx(s,e,t):s?t:-t}function v0(s,e){for(const t of e)if(s.intersectsExtent(t))return!0;return!1}function bI(s,e){const t=s.distanceToPOI-e.distanceToPOI;if(t!==0)return t;const i=s.lij,r=e.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function wI(s,e){const t=s.length;for(let i=0;i<t;++i)s.at(i).updateDistanceToPOI(e);s.sort(bI)}function xI(s,e,t){let i=1,r=0,a=0;for(;s!==e;)if(i*=.5,r*=.5,a*=.5,1&s.lij[2]&&(r+=.5),1&s.lij[1]||(a+=.5),(s=s.parent)==null)throw new Error("tile was not a descendant of upsampleTile");t.init(e,r,a,i)}function CI(s){for(let e=0;e<s.length;e++){const t=s[e],i=t.parent;if(i)for(let r=0;r<4;r++){const a=i.children[r];if(a&&a!==t)return!0}}return!1}function WG(s,e){if(!s||!e||s[0]===e[0])return!1;const t=s[0]<e[0],i=t?s:e,r=t?e:s,a=1<<r[0]-i[0];return Math.floor(r[1]/a)===i[1]&&Math.floor(r[2]/a)===i[2]}var Di;(function(s){s[s.Opaque=0]="Opaque",s[s.Transparent=1]="Transparent",s[s.InvisibleWithDraped=2]="InvisibleWithDraped",s[s.Invisible=3]="Invisible",s[s.COUNT=4]="COUNT"})(Di||(Di={}));function TI(s,e){s.varyings.add("tbnTangent","vec3"),s.varyings.add("tbnBiTangent","vec3"),e.spherical?s.vertex.code.add(w`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):s.vertex.code.add(w`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),s.fragment.code.add(w`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function pf(s){s.code.add(w`
    float lineFactorAtPosition(float value) {
      float pos = value * ${w.float(257)};
      if(pos < 0.5 || pos > ${w.float(257-.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}var Qr;(function(s){s[s.LayerOnly=0]="LayerOnly",s[s.ColorComposite=1]="ColorComposite",s[s.GridComposite=2]="GridComposite",s[s.COUNT=3]="COUNT"})(Qr||(Qr={}));let SI=class extends Wg{constructor(){super(...arguments),this.overlayOpacity=1}};function PI(s,e){const{vertex:t,fragment:i,varyings:r}=s;r.add("vtc","vec2"),t.uniforms.add(new b0("texOffsetAndScale")),i.uniforms.add(new w0("tex")),i.uniforms.add(new Mm("textureOpacities"));const a=e.textureFadingEnabled&&!e.renderOccluded;a&&(t.uniforms.add(new b0("nextTexOffsetAndScale")),r.add("nvtc","vec2"),i.uniforms.add(new w0("texNext")),i.uniforms.add(new Mm("nextTexOpacities")),i.uniforms.add(new EI("fadeFactor")));const n=e.tileBlendInput===Qr.ColorComposite,o=e.tileBlendInput===Qr.GridComposite;o&&i.include(pf),n&&i.uniforms.add(new Mm("backgroundColor")),t.code.add(w`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = texOffsetAndScale.xy + uv * texOffsetAndScale.zw;
    ${Pe(a,"nvtc = nextTexOffsetAndScale.xy + uv * nextTexOffsetAndScale.zw;")}
  }`),i.code.add(w`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${Pe(o||n,w`if (opacities.y <= 0.0) {
           return color * opacities.z * opacities.x;
         }
         vec4 bg = vec4(${n?w`backgroundColor`:w`gridColor(uv)`} * opacities.y, opacities.y);
         vec4 layer = color * opacities.z;
         return (bg * (1.0 - layer.a) + layer) * opacities.x;`,"return color;")}
    }`),a?i.code.add(w`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):i.code.add(w`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}let EI=class extends Lc{constructor(e){super(e,"float")}},Mm=class extends Lc{constructor(e){super(e,"vec3")}},b0=class extends Lc{constructor(e){super(e,"vec4")}},w0=class extends Lc{constructor(e){super(e,"sampler2D")}},mf=class extends SI{};function wx(s){const e=new kt,{vertex:t,fragment:i,varyings:r}=e,{output:a,pbrMode:n,overlayMode:o,tileBorders:l,spherical:h,transparencyMode:u,screenSizePerspective:d}=s;e.include(k2),e.include(_2,s),e.include(O1,s);const p=()=>{e.include(fS,s),t.code.add(w`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};RP(t,s),e.include(bw,s);const _=u===Di.InvisibleWithDraped||u===Di.Invisible,f=o!==Ud.Disabled,g=f&&_;switch(a){case D.ColorEmission:case D.Color:{e.include(PI,s),e.include(Kd,s),f&&(s.pbrMode=n===Wt.Simplified?Wt.TerrainWithWater:Wt.Water,e.include(eh,s),s.pbrMode=n);const y=o===Ud.EnabledWithWater;y&&e.include(TI,s),r.add("vnormal","vec3"),r.add("vpos","vec3"),r.add("vup","vec3"),p(),d&&wy(t);const b=s.receiveShadows&&!s.renderOccluded;b&&e.include(ww,s),d&&(r.add("screenSizeDistanceToCamera","float"),r.add("screenSizeCosAngle","float")),t.main.add(w`
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);
          vnormal = getNormal();
          vup = getLocalUp(position, localOrigin);
          ${Pe(y,w`forwardVertexTangent(vnormal);`)}

          vec2 uv = getUV0();
          forwardTextureCoordinatesWithTransform(uv);
          ${Pe(f,"setOverlayVTC(uv);")}
          ${Pe(l,"forwardTextureCoordinates();")}
          ${Pe(d,w`vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
                 screenSizeDistanceToCamera = length(viewPos);
                 vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
                 screenSizeCosAngle = abs(viewSpaceNormal.z);`)}
          ${Pe(b,"forwardLinearDepth();")}`),e.fragment.include(AP,s),e.include(Kd,s),e.include(P2,s),e.include(E2,s),DP(i,s),O2(i),S_(i),i.uniforms.add(t.uniforms.get("localOrigin"),new gn("viewDirection",({camera:C})=>ie(x0,ce(x0,C.viewMatrix[12],C.viewMatrix[13],C.viewMatrix[14])))),y&&i.uniforms.add(new ft("ovWaterTex",(C,T)=>{var P;return(P=T.overlay)==null?void 0:P.getTexture(Bs.WaterNormal)}),new $P("view",({origin:C},{camera:T})=>lc(OI,T.viewMatrix,C)));const x=.2;i.code.add(w`float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),Tp(i),U1(i),i.main.add(w`
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${b?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), readShadowMap(vpos, linearDepth))":h?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${Pe(f,w`vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
                   vec4 overlayColor = overlayOpacity * overlayColorOpaque;
                   ${Pe(_,`if (overlayColor.a < ${w.float(ll)}) { discard; }`)}
                   vec4 groundColor = tileColor;
                   tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`)}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a < ${w.float(ll)}) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= ${w.float(x)};
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${n===Wt.Simplified||n===Wt.TerrainWithWater?w`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:w`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${Pe(y,w`vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
                   float waterNormalLength = length(overlayWaterMask);
                   if (waterNormalLength > 0.95) {
                     mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                     vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                     vec4 viewPosition = view*vec4(vpos, 1.0);
                     vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                     vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                     float opacity = sliced ? ${w.float(x)} : 1.0;
                     // un-gamma the ground color to mix in linear space
                     fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
                   }`)}
          ${Pe(d,w`float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0));
                   if (perspectiveScale <= 0.25) {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
                   } else if (perspectiveScale <= 0.5) {
                     fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
                   } else if (perspectiveScale >= 0.99) {
                     fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
                   } else {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
                   }`)}
          ${Pe(s.visualizeNormals,h?w`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`:w`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`)}
          ${Pe(l,w`vec2 dVuv = fwidth(vuv0);
                 vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
                 float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
                 fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`)}
          fragColor = applySlice(fragColor, vpos);`)}break;case D.Depth:g&&e.include(eh,s),t.main.add(w`
        ${Pe(g,"setOverlayVTC(getUV0());")}
        gl_Position = transformPosition(proj, view, position);`),i.main.add(`${Pe(g,`if (getCombinedOverlayColor().a < ${w.float(ll)}) discard;`)}`);break;case D.Shadow:case D.ShadowHighlight:case D.ShadowExcludeHighlight:case D.ViewshedShadow:e.include(_w,s),j2(e),W2(e),t.main.add(w`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);`),i.main.add(w`outputDepth(linearDepth);`);break;case D.Normal:g&&e.include(eh,s),r.add("vnormal","vec3"),wy(t),p(),t.main.add(w`
        ${Pe(g,"setOverlayVTC(getUV0());")}
        gl_Position = transformPosition(proj, view, position);
        vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);`),i.main.add(w`
        ${Pe(g,`if (getCombinedOverlayColor().a < ${w.float(ll)}) discard;`)}
        vec3 normal = normalize(vnormal);
        if (gl_FrontFacing == false) {
          normal = -normal;
        }
        fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);`);break;case D.Highlight:f&&e.include(eh,s),t.main.add(w`
        ${Pe(f,"setOverlayVTC(getUV0());")}
        gl_Position = transformPosition(proj, view, position);`),e.include(M1,s),i.main.add(w`
        ${Pe(f,w`
           vec2 overlayHighlightTexel = getAllOverlayHighlightValuesEncoded();
           calculateOcclusionAndOutputHighlightOverlay(overlayHighlightTexel);`,"calculateOcclusionAndOutputHighlight();")}
      `)}if(a===D.ObjectAndLayerIdColor)if(f)s.pbrMode=Wt.Disabled,e.include(eh,s),s.pbrMode=n,t.main.add(w`gl_Position = transformPosition(proj, view, position);
setOverlayVTC(getUV0());`),i.main.add(w`fragColor = getOverlayColorTexel();`);else{const y=u===Di.Opaque;t.main.add(w`${Pe(y,"gl_Position = transformPosition(proj, view, position);")}`),i.main.add(w`fragColor = vec4(0.0);`)}return e}const OI=It(),x0=v(),MI=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:mf,build:wx},Symbol.toStringTag,{value:"Module"}));let RI=class extends Bt{constructor(e,t){super(e,t,new qt(MI,()=>X(()=>Promise.resolve().then(()=>G4),void 0,import.meta.url)),xx),this.type="TerrainTechnique",this.useStencil=!1}initializePipeline(e){return this._stencilPipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}_createPipeline(e,t){const{renderOccluded:i,output:r}=e,a=e.backfaceCullingEnabled&&!i;return Qt({blending:i?Dg:null,culling:a?V1:null,depthTest:i?null:{func:Zi.LESS},depthWrite:i?null:N1,colorWrite:ti,stencilTest:t?IP(Ig.IntegratedMeshMaskExcluded):null,drawBuffers:r===D.Depth?{buffers:[I1.NONE]}:null})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}};const xx=new Map([[De.POSITION,0],[De.UV0,1],[De.NORMALCOMPRESSED,2]]);let AI=class{constructor(){this.geometry=new hI,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureOpacity=1,this._textureRef=new yx(()=>this._tile.surface.fadeDuration),this.overlay=new dI,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new uI,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),zi&&this.tile.intersectsClippingArea)for(let t=0;t<4;++t)z(this.geometry.getEdgeCount(t)===this.geometryState.edgeResolutions[t]+1)}_calculateEdgeResolution(e,t){var l;const i=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const h=i.surface.extent;if(h!=null&&(e===0&&i.extent[3]>h[3]||e===1&&i.extent[2]>h[2]||e===2&&i.extent[1]<h[1]||e===3&&i.extent[0]<h[0]))return r}const a=i.level,n=gr[e];if(!t)return z(((l=i.surface)==null?void 0:l.rootTiles)==null||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(n)),r;if(t.loaded){const h=t,u=h.renderData.geometryState,d=a-h.level;if(z(d>=0),d===0){const f=u.numVerticesPerSide-1;return Math.max(f,r)}const p=2**d,_=u.edgeResolutions[(e+2)%4]/p;return Math.max(1,_)}z(!t.leaf);let o=r;return t.forAllSubtreeOnSide(Tg(n),h=>h===i||(h.loaded?(o=Math.max(o,2**(h.level-a)),!0):(z(!h.leaf),!1))),o}updateNeighborData(){var n;const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,i=o=>(o.loaded||o.level===e.level)&&(o==null?void 0:o.intersectsClippingArea),r=t.edgePeerNeighbors,a=t.edgePeerNeighborSamplerVersions;for(let o=0;o<4;++o){const l=e.findNeighborTile(gr[o],i),h=eo(e,l),u=((n=h==null?void 0:h.renderData)==null?void 0:n.geometryState.samplerDataVersion)??-1,d=r[o],p=h!==eo(e,d),_=a[o]!==u;zi&&l&&(z(e.level>=l.level),z(e.level-l.level<=Kt)),r[o]=l,(p||_)&&(a[o]=u,this._markEdgeDirty(o));const f=t.edgeResolutions[o],g=this._calculateEdgeResolution(o,l);z(rc(g)),z(g>=1),t.edgeResolutions[o]=g,f!==g&&this._markEdgeResolutionDirty(o)}for(let o=0;o<4;++o){const l=e.findNeighborTile(Ld[o],i);t.cornerPeerNeighbors[o]=l;const h=eo(e,r[o]),u=eo(e,r[(o+1)%4]),d=eo(e,l);nr[o]=d,nr[(o+1)%4]=u,nr[(o+2)%4]=e,nr[(o+3)%4]=h,z(nr.some(g=>(g==null?void 0:g.loaded)||g===e));const p=nr.reduce((g,y)=>Math.min(g,(y==null?void 0:y.level)??1/0),1/0);nr.forEach((g,y)=>{g&&(g==null?void 0:g.level)>p&&(nr[y]=null)}),z(nr.some(g=>(g==null?void 0:g.loaded)||g===e));const _=t.cornerNeighborCornerTiles,f=t.cornerNeighborCornerTileSamplerVersions;for(let g=0;g<4;++g){const y=nr[g],b=(y==null?void 0:y.renderData.geometryState.samplerDataVersion)??-1,x=4*o+g,C=_[x]!==y,T=!C&&f[x]!==b;(C||T)&&(_[x]=y,f[x]=b,this._markCornerDirty(o))}zi&&z(_f.some(g=>{var y;return((y=_[4*o+g])==null?void 0:y.loaded)||_[4*o+g]===e}))}zi&&z(this.geometryState.edgeResolutions.every(o=>o>0));for(let o=0;o<4;++o)nr[o]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;zi&&z(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every(_=>_>0)),this.intersectionData=null;const{tile:t,_vao:i,geometry:r,geometryState:a}=this,n=!i||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,o=this.dirtyEdgeResolutions!==0,l=a.edgeResolutions.reduce((_,f)=>_+f+1,0),h=n||o&&l>((r==null?void 0:r.maxEdgeVertexCount)??0),u=!h&&o,d=!u&&(this.dirtyEdges!==0||o),p=!d&&this.dirtyCorners!==0;h?(this.releaseGeometry(),this._createGeometry(e)):u?t.updateEdgeElevationsAndResolutions():d||p?t.updateEdgeElevations():p?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=We(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,i,r){const a=t?ni.RGBA:ni.RGB;return this._texture!=null&&(i===zt.FADING&&this._tile.surface.fadeDuration>0&&this._isTextureVisible(this._texture)||this._texture.descriptor.width!==e||this._texture.descriptor.pixelFormat!==a)&&this.releaseTexture(),this._texture==null&&(this._texture=r(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture!=null&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}reuseTexture(e,t){return!(!e||!this._texture)&&(e.setTextureReference(new hp(this._texture,zt.FADING,t,this._textureOpacity,0,1)),!0)}get numVerticesPerSideChanged(){return!!(this._modifiedFlags&$I)}get samplerDataChanged(){return!!(this._modifiedFlags&II)}get clippingAreaChanged(){return!!(this._modifiedFlags&LI)}get wireframeChanged(){return!!(this._modifiedFlags&NI)}get dirtyEdges(){return this._modifiedFlags>>Rm&15}get dirtyCorners(){return this._modifiedFlags>>Am&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>Dm&15}_markCornerDirty(e){const t=1<<e<<Am;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<Rm;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<Dm;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<Am|15<<Rm|15<<Dm}updateGeometryState(){const e=this._elevationInfo,t=this.tile,i=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.minimumVerticesPerSide,r=Math.max(i,5);let a=t.clippingArea;t.intersectsClippingArea&&!t.withinClippingArea||(a=null);const n=this.geometryState;let o=!1;n.numVerticesPerSide!==r&&(this._modifiedFlags|=1,n.numVerticesPerSide=r,n.samplerDataVersion++,o=!0),e.changed&&(this._modifiedFlags|=2,n.samplerData=e.samplerData,n.samplerDataVersion++,o=!0),jb(n.clippingArea,a)||(this._modifiedFlags=4,n.clippingArea=a,o=!0);const l=t.surface.wireframe;return n.wireframe!==l&&(this._modifiedFlags=8,n.wireframe=l,o=!0),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=o),o&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometry.vertexAttributes,i=this.geometry.indices,r=e.gl;this._vao=new Tn(e,xx,new Map([["geometry",Fa(t.layout)]]),new Map([["geometry",$s.createVertex(e,r.STATIC_DRAW,t.buffer)]]),$s.createIndex(e,r.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=hn.Immediate){(e==null?void 0:e.texture)===this._texture?this._textureOpacity=e.opacities[0]:this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_isTextureVisible(e){var t,i;return((t=this._textureRef.current)==null?void 0:t.texture)===e||((i=this._textureRef.next)==null?void 0:i.texture)===e&&this._textureRef.fadeFactor<1}get _elevationInfo(){var u;const e=this.geometryState.samplerData,t=this.tile.layerInfo[fe.ELEVATION],i=t.length,r=new Array(i);let a=0,n=0,o=!1;for(let d=0;d<i;d++){const p=t[d],_=(u=p.upsampleInfo)==null?void 0:u.tile;if(_){const f=_.layerInfo[fe.ELEVATION][d].data,g=f&&f.samplerData;e&&e[a]===g||(o=!0),r[a++]=g,n=Math.max(n,_.lij[0])}else if(p.data){const f=this.tile.surface.layerViewByIndex(d,fe.ELEVATION);if(co(this.tile,f)){const g=p.data;e&&e[a]===g.samplerData||(o=!0),r[a++]=g.samplerData,n=this.tile.level}}}e!=null&&e.length!==a&&(o=!0);const l=a>0,h=l?r:null;return l&&(r.length=a),{changed:o,samplerData:h,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){var t,i,r;const e=((t=this.intersectionData)==null?void 0:t.estimatedMemoryUsage)??0;return(((i=this.geometry.indices)==null?void 0:i.byteLength)??0)+(((r=this.geometry.vertexAttributes)==null?void 0:r.byteLength)??0)+e}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!zi)return;const e=this.tile;if(!e.loaded||!e.intersectsClippingArea||e.level===0)return void z(e==null?void 0:e.loaded);const t=e.surface.extent;if(t!=null&&!e.intersectsExtent(t))return;const i=gr.map((o,l)=>t!=null&&(l<2?-1:1)*(e.extent[3-l]-t[3-l])<0),r=e.level;z(this.dirtyCorners===0),z(this.dirtyEdges===0),z(this.dirtyEdgeResolutions===0),z(!this.numVerticesPerSideChanged),z(!this.samplerDataChanged),z(!this.clippingAreaChanged),z(!this.wireframeChanged);const a=Ld.map(o=>e.findNeighborCornerTileExact(o,l=>!l.intersectsClippingArea||l.loaded||l.level===e.level)??null).map(o=>o!=null&&o.intersectsClippingArea?o:null),n=this.geometryState;for(let o=0;o<4;++o){const l=n.cornerPeerNeighbors[o],h=a[o];z(h===l,`Tile[${e.lij}].corner[${o}] out of date: cur=[${l==null?void 0:l.lij}] exp=[${h==null?void 0:h.lij}]`)}gr.forEach((o,l)=>{if(i[l])return;const h=e.findNeighborTile(o,ve=>(ve.level===r||(ve==null?void 0:ve.loaded))&&(ve==null?void 0:ve.intersectsClippingArea));if(!h){const ve=!e.surface.updatingRootTiles&&e.surface.rootTiles!=null&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(o);return void z(!ve)}z(h.loaded||h.level===e.level),z(h===this.geometryState.edgePeerNeighbors[l]);const u=r-h.level;if(!h.loaded)return z(!h.leaf),void z(u===0);const d=h.renderData;z(e.isEdgeNeighbor(h,o)),z(u>=0);const p=2**u;if(u<0)return void z(!1);const _=e.renderData,f=_.geometry,g=_.localOrigin,y=f.getEdgeCount(l),b=f.numVerticesPerSide-1,x=d.geometry;if(!x)return void z(!1);const C=d.localOrigin,T=this.geometryState.edgePeerNeighbors[l];if(T!=null&&T.loaded){const ve=T.renderData;z(_.geometryState.edgePeerNeighborSamplerVersions[l]===ve.geometryState.samplerDataVersion),z(this.geometryState.edgePeerNeighborSamplerVersions[l]===ve.geometryState.samplerDataVersion)}const P=(l+2)%4,S=x.getEdgeCount(P),E=y-1,M=S-1;z(E*p===M,`Tile[${e.lij}]:e${l},res=${E} edgeRes mismatch with Neighbor[${h.lij}]:e${P},res=${M} (expected:${E*p})`);const $=e.extent,B=o===dt.NORTH||o===dt.SOUTH,k=S-1,H=k>>u,Y=y-1;if(H<1)return void z(Y===1);z(H===Y),z(rc(H));const A=x.numVerticesPerSide-1;z(u>0||H===Math.max(A,b));const R=e.getNeighborEdgeStartVertexIndex(l,h);z(0<=R&&R<p);const W=R*H;z(0<=W&&W<=k-H);let U=0,I=W;f.getEdgeVertexPosition(l,$r,g,0),f.getEdgeVertexPosition(l,Ir,g,y-1);const de=vi($r,Ir),ae=Math.max(DI,1e-4*de);for(let ve=0;ve<=H;++ve){f.getEdgeVertexPosition(l,$r,g,U),x.getEdgeVertexPosition(P,Ir,C,I);const Le=ve/H,Qe=B?$[0]+Le*($[2]-$[0]):o===dt.WEST?$[0]:$[2],$e=B?o===dt.SOUTH?$[1]:$[3]:$[1]+Le*($[3]-$[1]),Ke=e.surface.extent;if(Ke==null||FT(Ke,Qe,$e)){const xt=ys($r,Ir),Ct=ns($r)-os.radius,Ue=ns(Ir)-os.radius,Ae=xt<ae;if(!Ae){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${l}[${U}/${y}] and [${h.lij}].edge${P}[${I}/${S}]`),Ke!=null&&console.warn("  surface extent= ",Ke," x,y=",Qe,",",$e);const qe=v();ye(qe,_.localOrigin,d.localOrigin),ns(qe)>0&&console.warn(`   localOrigins: ${_.localOrigin} vs ${d.localOrigin} d=${ns(qe)} [${qe}]`),(()=>{const V=dn($r),L=dn(Ir);e.updateEdgeElevations(),h.updateEdgeElevations(),f.getEdgeVertexPosition(l,$r,g,U),x.getEdgeVertexPosition(P,Ir,C,I);const N=v();Mt(N,$r,V),ns(N)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${V} vs ${$r} d=${ns(N)} [${N}]`),Mt(N,Ir,L),ns(N)>0&&console.warn(`  XXX Neighbor[${h.lij}] edge out of date: ${L} vs ${Ir} d=${ns(N)} [${N}]`)})();const me=f.getEdgeCount(l),Me=x.getEdgeCount(S);z(Ae,`Mismatch in tile [${e.lij}].edge[${l}][${U}/${me}] vs neighbor [${h.lij}].edge[${P}][${I}/${Me}] ${ua($r)} vs ${ua(Ir)}  dist=${xt} h(t|n|d)=${Ct}|${Ue}|${Ue-Ct}`)}f.getEdgeNormal(l,Bo,U),x.getEdgeNormal(P,qo,I),ie(C0,Bo),ie(T0,qo);const st=oe(C0,T0),Ie=1-st<.01||!1||e===h;if(!Ie){const qe=v();Mt(qe,Bo,qo);const me=()=>`Mismatch in tile edge normal ${cy(e.lij)} (${U}/${y-1}) edge ${l} vs neighbor ${cy(h.lij)}  (${I}/${S-1}) nedge ${P} :${ua(Bo)} vs ${ua(qo)}  dot = ${st} : ${ua(qe)}`;console.warn("Mismatch in tile edge normal: ",me());{e.updateEdgeElevations(),h.updateEdgeElevations();const Me=v(),V=v();f.getEdgeNormal(l,Me,U),x.getEdgeNormal(P,V,I),nc(Bo,Me)||console.warn("Missing update in tile normal: ",ua(Bo)," => ",ua(Me)),nc(qo,V)||console.warn("Missing update in neighbor normal: ",ua(qo)," => ",ua(V))}z(Ie,me())}}U+=1,I+=1}})}};const $r=v(),Ir=v(),Bo=v(),qo=v(),C0=v(),T0=v(),DI=1,nr=[null,null,null,null];function eo(s,e){return e!=null&&e.loaded||e===s?e:null}const $I=1,II=2,LI=4,NI=8,Rm=4,Am=8,Dm=12,_f=[0,1,2,3];let gf=class{get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const a=this._findAncestorWithData();this._setUpsampleTile(a)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,zt.FADING,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e!=null?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){var b;const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),{minLevel:r,maxLevel:a}=i.dataLevelRange,n=this._desiredMinLevelDelta,o=this._progressiveLevelModulo+n,l=this._scaleRangeEnabled?co:()=>!0;let h=this.tile;const u=h.level;let d;const p=this._tileLayerInfo.upsampleInfo,_=((b=p==null?void 0:p.tile)==null?void 0:b.level)??-1,f=p!=null&&_-u>=n,g=_I(i),y=i.type==="vector-tile-3d"?i.schemaHelper:null;for(;h&&l(h,i)&&h.level>=r;){const x=h.level,C=u-x,T=h.layerInfo[t][e];if(T.data&&C>=n){(!f||x>_)&&this._setUpsampleTile(h),T.dataInvalidated&&(d=h);break}const P=(y==null?void 0:y.getLevelRowColumn(h.lij))??h.lij;if((g==null?void 0:g.getAvailability(P[0],P[1],P[2]))!=="unavailable"&&x<=a&&!T.data&&!T.dataMissing&&((!d||h.level===r||x%f1==0||u-d.level<n)&&(d=h),C>=o))break;h=h.parent}if(d!=null&&u-d.level<n)if(p)d=null;else{const x=this._findAncestorWithData();x!=null&&(this._setUpsampleTile(x),d=x.layerInfo[t][e].dataInvalidated?x:null)}return d}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,zt.FADING,t)}get test(){}},VI=class extends gf{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw S0}get _progressiveLevelModulo(){throw S0}dispose(){}};const S0=new Error("Abstract method called on TileAgent"),ms=new VI;let FI=class extends gf{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}};function UI(s){return s.type==="elevation"}let HI=class extends gf{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return f1}};function zI(s){return s.type==="map"}var Hi;(function(s){s[s.INSIDE=0]="INSIDE",s[s.INTERSECTS=1]="INTERSECTS",s[s.OUTSIDE=2]="OUTSIDE"})(Hi||(Hi={}));let md=class{constructor(){this.waitingAgents=new mt,this.pendingUpdates=0}static acquire(e){const t=$m.acquire();return t._init(e),t}release(){this.dispose(),_d.delete(this),$m.release(this)}dispose(){this.loadingAgent=We(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=bl(this._data)}static prune(){$m.prune(0)}_init(e){this.waitingAgents.clear(),this._data=bl(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=xn(this.requestAbort),this.requestPromise=null}_unsetUpsampleInfo(){var e;this.upsampleInfo&&((e=this.upsampleInfo.tile)==null||e.unrefMapData(),this._pool.release(this.upsampleInfo),this.upsampleInfo=null)}setUpsampleInfo(e,t){var i;if(e!==t&&t!=null){if(this.upsampleInfo==null)this.upsampleInfo=this._pool.acquire();else{if(this.upsampleInfo.tile===t)return;(i=this.upsampleInfo.tile)==null||i.unrefMapData()}t.refMapData(),xI(e,t,this.upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){bl(this._data),this._data=e}};const $m=new mo(md,null,()=>{}),_d=new Map;function GI(){_d.size>0&&(console.log(`${_d.size} live TilePerLayerInfo allocations:`),_d.forEach(s=>console.log(s,`
`)))}var te;(function(s){s[s.NONE=0]="NONE",s[s.SPLIT=1]="SPLIT",s[s.ELEVATION=2]="ELEVATION",s[s.MERGE=4]="MERGE",s[s.GEOMETRY=8]="GEOMETRY",s[s.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",s[s.TEXTURE_FADING=32]="TEXTURE_FADING"})(te||(te={}));const BI=.1;let ff=class{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=pi(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=pi(),this.centerAtSeaLevel=v(),this._center=[v(),Sr(),v()],this.up=TT(),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=0,this._rasterTileMemory=0,this._vectorTileMemory=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=v(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){yf.prune(0),vf.prune(0),md.prune()}get _cached(){return!this.leaf&&this._mapDataRefCount<=0}get withinClippingArea(){return this._withinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[Ht.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent,t=(e==null?void 0:e.frustumVisibility)??Hi.INTERSECTS;this._frustumVisibility=t===Hi.INSIDE?Hi.INSIDE:t===Hi.OUTSIDE?Hi.OUTSIDE:this._calculateFrustumVisibility(this.surface.frustum);const i=this._frustumVisibility!==Hi.OUTSIDE&&this._intersectsClippingArea;i!==this._visible&&(this._visible=i,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get _loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,i,r,a){this._lij[0]=e,this._lij[1]=t,this._lij[2]=i,this.ellipsoid=Dt(a.tilingScheme.spatialReference),a.tilingScheme.getExtent(e,t,i,this.extent),a.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,a.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[Ht.MIDDLE][3]=0,this.elevationLevel=e,r&&!Number.isNaN(r.elevationBoundsMin)?(this._elevationBoundsMin=r.elevationBoundsMin,this._elevationBoundsMax=r.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=r,this.clearChildren(),this._surface=a,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const n of sl){const o=a.numLayers(n),l=this.layerInfo[n];for(const h of l)h.release();l.length=o;for(let h=0;h<o;h++)l[h]=md.acquire(this._surface.upsampleInfoPool),n===fe.ELEVATION&&this.findElevationBoundsForLayer(h,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(a.tilingScheme.pixelSize,wh)}dispose(){this._surface!=null&&(ci(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key),this.layerInfo.forEach(e=>{e.forEach(t=>t.release()),e.length=0}),this._surface=this._parent=null,this.clearChildren(),this.setMemoryDirty())}refMapData(){++this._mapDataRefCount,this._cached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){--this._mapDataRefCount,this._cached&&this.cachedMemory>0&&this._surface.upsampleMapCache.put(this.key,this)}setMemoryDirty(){this._usedMemory=0}get usedMemory(){return this._ensureUsedMemory()+(this._cached?0:this._mapTileMemory)}get cachedMemory(){return this._ensureUsedMemory(),this._surface==null?this.usedMemory:this._cached?this._mapTileMemory:0}get _mapTileMemory(){return this._rasterTileMemory+this._vectorTileMemory}get _cpuImageMemorySize(){const t=this._surface.tilingScheme.pixelSize;return t*t*4}_ensureUsedMemory(){var e;if(this._usedMemory>0)return this._vectorTileMemory=this.layerInfo[fe.MAP].reduce((t,{data:i})=>t+(Xl(i)?i.usedMemoryPerReference:0),0),this._usedMemory;this._usedMemory=this._baseUsedMemory,this._rasterTileMemory=0,this._vectorTileMemory=0;for(const{data:t}of this.layerInfo[fe.MAP])Xl(t)?this._vectorTileMemory+=t.usedMemoryPerReference:this._rasterTileMemory+=this.getTerrainDataMemory(t);for(const t of this.layerInfo[fe.ELEVATION])this._usedMemory+=t.data?this._cpuImageMemorySize:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._rasterTileMemory+=((e=this.renderData.texture)==null?void 0:e.cachedMemory)??0),this._cached&&this._surface.upsampleMapCache.updateSize(this.key,this),this._usedMemory}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];return i!=null&&i.data?e===fe.MAP?this._cached?0:this.getTerrainDataMemory(i.data):e===fe.ELEVATION?this._cpuImageMemorySize:0:0}getTerrainDataMemory(e){return NS(e)?e.texture.usedMemory:VS(e)?e.memoryUsage:Xl(e)?e.usedMemoryPerReference:Cg(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(e){const t=this._center[Ht.MIDDLE],i=e,r=t[0],a=t[1],n=t[2],o=i[2]*r+i[6]*a+i[10]*n+i[14];this.screenDepth=o<0?0:o/(i[3]*r+i[7]*a+i[11]*n+i[15])}shouldSplit(e,t,i){if(!this.visible||e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibility(e.frustum)===Hi.OUTSIDE))return te.NONE;const r=this.level;ye($u,wt(this._center[Ht.MIDDLE]),t);let a=Zs($u),n=$u,o=wt(this._center[Ht.MIDDLE]);ye(Im,this._center[Ht.TOP],t);const l=Zs(Im);l<a&&(a=l,n=Im,o=this._center[Ht.TOP]),ye(Lm,this._center[Ht.BOTTOM],t);const h=Zs(Lm);if(h<a&&(a=h,n=Lm,o=this._center[Ht.BOTTOM]),this._edgeLen2>a&&r<e.maxLod)return te.SPLIT;const u=Math.sqrt(a),d=e.fovX*u*2,p=this._edgeLen/d,_=()=>{if(r<e.maxLod)return this.elevationLevel=r,te.NONE;const E=r+Math.ceil(-Math.log2(e.relativeWidthLimit/p));return E!==this.elevationLevel?(this.elevationLevel=E,te.ELEVATION):te.NONE},f=i!=null?i-r:1/0;if(f<=.5)return _();const g=oe(this.up,$u),y=this._elevationBoundsMax-this._elevationBoundsMin,b=y/this.edgeLen;if(e.aboveGround&&g>0&&b<.001&&g/u-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-b>0)return te.NONE;const x=i!=null?3-Math.min(f,2):1;if(p*x<e.relativeWidthLimit||r>=e.maxLod)return _();if(r<7)return te.SPLIT;ee(_i,this.up,g),ye(_i,_i,n);const C=Zs(_i);if(C<=this.radius*this.radius)return te.SPLIT;ee(_i,_i,this.radius/Math.sqrt(C)),ue(_i,_i,o),ye(_i,t,_i);const T=Math.min(1,(Math.abs(oe(_i,this.up))+.5*y+this._curvatureHeight)/we(_i)),P=BI/e.angledSplitBias,S=e.fovY*u*2;return T*(this._edgeLen/S*x)<P*e.relativeHeightLimit?te.NONE:te.SPLIT}createChildren(){const e=this._children,t=this.lij[0]+1,i=2*this.lij[1],r=2*this.lij[2];return e[0]=this.surface.createTile(t,i,r,this),e[1]=this.surface.createTile(t,i,r+1,this),e[2]=this.surface.createTile(t,i+1,r,this),e[3]=this.surface.createTile(t,i+1,r+1,this),e}clearChildren(){this._children[0]=this._children[1]=this._children[2]=this._children[3]=null}get loaded(){var e;return((e=this.renderData)==null?void 0:e.hasGeometry)??!1}load(){this.refMapData();for(const e of sl)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(){this.renderData&&this.unrefMapData(),this.surface.renderer.unloadTile(this);for(const e of sl){const t=this.layerInfo[e];for(const i of t)i.loadingAgent&&i.loadingAgent!==ms&&(Du(i.loadingAgent),i.loadingAgent=null),i.pendingUpdates=0}this.resetPendingUpdate(te.GEOMETRY),this.resetPendingUpdate(te.TEXTURE_NOFADING),this.resetPendingUpdate(te.TEXTURE_FADING)}unloadMapData(){const e=this.layerInfo[fe.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==ms&&(Du(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0,t.invalidateSourceData();this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(no(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._withinClippingArea;e!=null?(this._intersectsClippingArea=this.intersectsExtent(e),this._withinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._withinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=i&&this._withinClippingArea,a=!(i||t||this._withinClippingArea||this._intersectsClippingArea);return!this.renderData||r||a||this.setPendingUpdate(te.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!(i!=null&&i.data)||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of sl){const t=this.layerInfo[e];for(const i of t)if(i.loadingAgent&&i.loadingAgent!==ms&&i.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(te.SPLIT)||e!==fe.ELEVATION&&!this._loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,e===te.SPLIT||e===te.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const r=this.layerInfo[t][e];if(r.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(i),r.data&&!r.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e);const o=Xl(r.data);return i.dataArrived(this,o),!0}if(r.requestPromise)return!0;xn(r.requestAbort),r.requestAbort=new AbortController;const a=this._surface.requestTileData(this,e,t,r.requestAbort);if(!a)return r.requestAbort=null,!1;const n=()=>{r.requestPromise===a&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=a,a.then(n,n),!0}get leaf(){return this._children[0]==null}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return Zs(ye(_i,wt(this._center[Ht.MIDDLE]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const i=this.extent;return e>=i[0]&&t>=i[1]&&e<=i[2]&&t<=i[3]}unrequestLayerData(e,t,i){const r=this.layerInfo[t][e],a=r.waitingAgents,n=a.removeUnordered(i)!=null;ci(n,"agent has not requested this piece of map data"),a.length<1&&(r.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,i){const r=Xl(i),a=this.layerInfo[t][e];a.data=i,a.dataInvalidated=!1,a.waitingAgents.forAll(n=>n.dataArrived(this,r)),a.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t){const i=this.layerInfo[t][e];i.dataMissing=!0,i.waitingAgents.forAll(r=>r.dataMissing()),i.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,i){switch(i&&this.forEachLoadedNeighbor(r=>r.updateRenderData(e,t)),e){case fe.MAP:return this._updateTexture(t);case fe.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===zt.FADING?te.TEXTURE_NOFADING:te.TEXTURE_FADING),this.setPendingUpdate(e===zt.FADING?te.TEXTURE_FADING:te.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(te.GEOMETRY);for(const e of this.layerInfo[fe.ELEVATION])e.pendingUpdates|=te.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let i=1/0,r=-1/0;const a=this.layerInfo[fe.ELEVATION];let n=!0;for(const o of a)o.elevationBounds!=null&&(i=Math.min(i,o.elevationBounds.min),r=Math.max(r,o.elevationBounds.max),o.elevationBounds.hasNoDataValues||(n=!1));n&&(i=Math.min(i,0),r=Math.max(r,0)),e===i&&t===r||(this._elevationBoundsMin=i,this._elevationBoundsMax=r,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax,i=.5*(e+t),r=this._center;ee(_i,this.up,i),ue(wt(r[Ht.MIDDLE]),this.centerAtSeaLevel,_i),ee(_i,this.up,e),ue(r[Ht.TOP],this.centerAtSeaLevel,_i),ee(_i,this.up,t),ue(r[Ht.BOTTOM],this.centerAtSeaLevel,_i)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[fe.ELEVATION][e],r=this.elevationLevelDelta,a=Math.max(this.elevationLevel-r,0),n=i.elevationBounds;if(n!=null&&n.level>=t&&n.level<=a)return;const o=this._surface.layerViewByIndex(e,fe.ELEVATION);if(!co(this,o))return;const l=kI;let h=!1;const u=i.data;if(u&&u.level<=a){const d=i.data;l.min=d.samplerData.data.minValue,l.max=d.samplerData.data.maxValue,l.hasNoDataValues=d.samplerData.data.hasNoDataValues,l.level=this.level,h=!0}else{let d,p,_=0;for(let f=this._parent;f&&(!p||_<r)&&(_=this.elevationLevel-f.level,d=p||d,p=f.layerInfo[fe.ELEVATION][e].data,!(!p&&d&&f.level<=a));f=f.parent);p=p||d,p&&(p.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],l),l.min!==1/0&&(l.level=p.level,h=!0))}h&&(i.elevationBounds==null&&(i.elevationBounds=new _l),i.elevationBounds.copyFrom(l))}modifyLayers(e,t,i){const r=this.layerInfo[i];for(const o of r)o.loadingAgent&&o.loadingAgent!==ms&&(Du(o.loadingAgent),o.loadingAgent=null),o.waitingAgents.clear();for(let o=0;o<r.length;++o)e[o]===void 0&&r[o].release();const a=new Array(...r),n=t.length;r.length=n;for(let o=0;o<n;o++){const l=t[o];r[o]=l>-1?a[l]:md.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,zt.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const i of t)i.loadingAgent===ms&&(i.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of sl){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==ms&&(i.loadingAgent.setSuspension(t),i.loadingAgent===ms&&this.updateRenderData(e,zt.FADING))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==ms&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=ms,i.data||i.upsampleInfo!=null||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return e.blendMode!=="normal"||Ml(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,i){var r,a,n;for(let o=e;o<t;++o){const l=this._surface.layerViewByIndex(o,i);if(ic(l)&&((r=l==null?void 0:l.layer)==null?void 0:r.blendMode)!=="normal"||Ml((a=l==null?void 0:l.layer)==null?void 0:a.parent)&&this._hasBlendableAncestor((n=l==null?void 0:l.layer)==null?void 0:n.parent))return!0}return!1}_createOrUpdateAgents(e,t){const i=this.layerInfo[t];if(i.length===0)return;const r=this._isSuspended(t);for(let a=e;a<i.length;++a){const n=i[a],o=this._surface.layerViewByIndex(a,t);let l=!1;if(n.loadingAgent?co(this,o)?(n.loadingAgent!==ms&&n.loadingAgent.setSuspension(r),n.loadingAgent!==ms&&(l=n.loadingAgent.update())):n.dispose():co(this,o)&&(n.loadingAgent=qI(this,a,t,r),l=n.loadingAgent.startLoading(),l?n.loadingAgent===ms&&this.setPendingUpdate(te.GEOMETRY):(Du(n.loadingAgent),n.loadingAgent=ms)),n.loadingAgent===ms&&this.updateRenderData(t,zt.FADING),!this._hasBlendModes(e,i.length,t)&&l&&o.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,i=Math.max(this.level-e,this.elevationLevelDelta-t),r=Q(1+(this._maxTesselation>>i),2,this._maxTesselation+1),a=this.minimumVerticesPerSide;return Math.max(r,a)}_findLIJ(e,t){if(!e)return null;const i=this.surface.rootTiles;if(i!=null){for(const r of i)if(jI(r,e)){let a=r,n=e[0]-a.level-1;for(;n>=0&&!a.leaf&&!t(a);){const o=e[1]>>n&1,l=e[2]>>n&1;a=a.children[2*o+l],n--}return t(a)?a:null}}return null}findNeighborTile(e,t){const i=this._lij,r=this._getNeighborLIJ(i,e);return r?gd(i,r)?t(this)?this:null:this._findLIJ(r,t):null}findCorner(e,t){const i=e===dt.NORTH_EAST?1:e===dt.NORTH_WEST?0:e===dt.SOUTH_WEST?2:3;let r=this;for(;r.children[0]&&(!t||!t(r));)r=r.children[i];return r}findNeighborCornerTileExact(e,t){var i;return((i=this.findNeighborTile(e,r=>t(r)||r.level===this.level))==null?void 0:i.findCorner(Nd(e),t))||null}forAllSubtreeOnSide(e,t){const i=e===dt.NORTH?[0,1]:e===dt.NORTH_EAST?[1]:e===dt.EAST?[1,3]:e===dt.SOUTH_EAST?[3]:e===dt.SOUTH?[2,3]:e===dt.SOUTH_WEST?[2]:e===dt.WEST?[0,2]:[0],r=a=>{const n=a.children;!t(a)&&n[0]&&i.forEach(o=>r(n[o]))};r(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const i=this.level-t.level;if(z(!zi||i>=0),i===0)return 0;const r=2**i,a=!(1&~e),n=a?0:1,o=t.lij[n+1]*r,l=this._lij[n+1],h=l-o,u=a?r-1-h:h;return zi&&(z(o<=l&&l<o+r),z(0<=u&&u<r)),u}forEachLoadedNeighbor(e){const t=this.level,i=r=>r.level===t||r.loaded;gr.forEach(r=>{const a=this.findNeighborTile(r,i);a!=null&&a!==this&&a.forAllSubtreeOnSide(Tg(r),n=>!!n.loaded&&(e(n,r),!0))}),Ld.forEach(r=>{var n;const a=(n=this.findNeighborTile(r,i))==null?void 0:n.findCorner(Nd(r),o=>o.loaded);z(!a||Q_(this,a,r)),a!=null&&a.loaded&&e(a,r)})}_getNeighborLIJ(e,t){const i=uy(t)?-1:dy(t)?1:0,r=py(t)?-1:my(t)?1:0,a=[e[0],e[1]+i,e[2]+r];return a[1]<0?null:this.surface.isGlobal?this._wrapLIJ(a):a[2]<0?null:a}_wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}isEdgeNeighbor(e,t){if(e==null)return!1;if(this.level===0&&e.level===0&&(this._eastEnd&&e._westEnd&&t===dt.EAST||this._westEnd&&e._eastEnd&&t===dt.WEST))return!0;const i=Math.max(1e-6*(this.extent[2]-this.extent[0]),1);switch(t){case dt.NORTH:return js(this.extent[3],e.extent[1],i);case dt.SOUTH:return js(this.extent[1],e.extent[3],i);case dt.EAST:return js(this.extent[2],e.extent[0],i)||js(this.extent[2],-e.extent[0],i);case dt.WEST:return js(this.extent[0],e.extent[2],i)||js(this.extent[0],-e.extent[2],i)}}get _eastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get _westEnd(){return this._lij[2]===0}checkGeometryWaterproofness(){var e;__&&(z(this.loaded),(e=this.renderData)==null||e.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,i=this.surface.rootTilesExtent,r=.25*(t[2]-t[0]);if(uy(e)&&t[3]+r>=i[3]||dy(e)&&t[1]-r<=i[1])return!1;const a=this.surface.isGlobal;return!(!a&&py(e)&&t[0]-r<=i[0])&&!(!a&&my(e)&&t[2]+r>=i[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;le(this._lastPOI,e);const i=this._center[Ht.MIDDLE],r=e[0]-i[0],a=e[1]-i[1],n=e[2]-i[2];this.distanceToPOI=r*r+a*a+n*n}};function qI(s,e,t,i){const r=t===fe.ELEVATION?vf.acquire():yf.acquire();return r.init(s,e,t,i),r}function Du(s){s.dispose(),UI(s)?vf.release(s):zI(s)&&yf.release(s)}const yf=new mo(HI),vf=new mo(FI),kI=new _l;var Ht;function jI(s,e){const t=s.lij,i=e[0]-t[0];return!(i<0)&&e[1]>>i===t[1]&&e[2]>>i===t[2]}function gd(s,e){return s[0]===e[0]&&s[1]===e[1]&&s[2]===e[2]}function Q_(s,e,t){return s!=null&&e!=null&&e!==s&&(s.level>=e.level?P0(s,e,t):P0(e,s,Nd(t)))}function P0(s,e,t){z(s.level>=e.level);const i=FS(t),r=US(t),a=s.extent,n=e.extent,o=[i?a[0]:a[2],r?a[3]:a[1]],l=[i?n[2]:n[0],r?n[1]:n[3]],h=1e-5*(a[2]-a[0]),u=js(o[0],l[0],h)||s.surface.isGlobal&&js(o[0],-l[0],h),d=js(o[1],l[1],h);if(u&&d)return!0;if(s.level===e.level)return z(!1),!1;if(!u&&!d)return z(!1),!1;const p=u?E0(n[1],n[3],a[1],a[3],h):E0(n[0],n[2],a[0],a[2],h);return z(p),p}function E0(s,e,t,i,r){return s-r<=t&&t<=i&&i<=e+r}(function(s){s[s.TOP=0]="TOP",s[s.MIDDLE=1]="MIDDLE",s[s.BOTTOM=2]="BOTTOM"})(Ht||(Ht={}));const $u=v(),Im=v(),Lm=v(),_i=v(),WI=65536;function QI(s,e){const{tile:t,geometry:i,geometryState:r}=s,{extentInRadians:a,surface:n}=t,{isWebMercator:o,renderer:l}=n,{numVerticesPerSide:h,wireframe:u}=r,d=h-1,p=(h-2)**2,_=o&&(e===zr.HAS_SOUTH_POLE||e===zr.HAS_BOTH_POLES),f=o&&(e===zr.HAS_NORTH_POLE||e===zr.HAS_BOTH_POLES),g=((_?1:0)+(f?1:0))*fd*h,y=Vx(r),b=p+g+4*y,x=l.tileGeometryCache.acquire(b);i.numVerticesPerSide=h,i.vertexAttributes=x,i.maxEdgeVertexCount=y;const{boundingBox:C}=i;Nl(C);const T=wf(s);fi.update(d,a,T),ZI(s),i.poleVerticesStartIndex=p;const P=YI(s,_,f);i.edgeVerticesStartIndex=p+g,Cf(s),bf(s),Mx(i,P,u),s.intersectionData=null}function YI(s,e,t){const{tile:i,localOrigin:r,geometry:a}=s,{extent:n,ellipsoid:o}=i,{boundingBox:l,numVerticesPerSide:h,vertexAttributes:u,poleVerticesStartIndex:d}=a,p=h-1,_=r[0],f=r[1],g=r[2],y=o.radius,b=n[1],x=n[3],C=[];let T=d;const P=(S,E)=>{const M=E*h;tr(-_,-f,S*y-g,l),C.push(new mL(S===1,M,S===1?0:2,T,fd));const $=Sx(S===-1?b:x,y),B=S*Math.PI/2-$,k=.99*(S===1?1:-1),H=y+0,{position:Y,uv0:A}=u,{typedBuffer:R,typedBufferStride:W}=u.normalCompressed;for(let U=1;U<=fd;++U){const I=$+B*(U/fd),de=Math.cos(I),ae=Math.sin(I);for(let ve=0;ve<=p;ve++){const Le=ve/p,Qe=fi.sinLonLUT[ve],$e=fi.cosLonLUT[ve]*de,Ke=Qe*de,xt=ae,Ct=$e*H-_,Ue=Ke*H-f,Ae=xt*H-g;tr(Ct,Ue,Ae,l),Y.setValues(T,Ct,Ue,Ae),xr(A,T,Le,k),fc(R,T,$e,Ke,xt,W),++T}}};return e&&P(-1,0),t&&P(1,p),C}function ZI(s){const{tile:e}=s;if(!e.intersectsClippingArea)return;const{geometry:t,geometryState:i,localOrigin:r}=s,{numVerticesPerSide:a,samplerData:n}=i,o=a-2,l=a-1,{vertexAttributes:h,boundingBox:u}=t,d=h.position,p=h.uv0,{typedBuffer:_,typedBufferStride:f}=h.normalCompressed,{extent:g}=e,y=g[0],b=g[2],x=g[1],C=g[3],T=e.ellipsoid.radius,P=r[0],S=r[1],E=r[2],M=d.typedBuffer,$=d.typedBufferStride,B=1/l;let k=0;if(1<=o){const H=B,Y=x*(1-H)+C*H,A=fi.sinLatLUT[1],R=fi.cosLatLUT[1];for(let W=1;W<=o;W++){const U=W*B,I=y*(1-U)+b*U,de=fi.sinLonLUT[W],ae=fi.cosLonLUT[W],ve=T+bt(I,Y,n),Le=ve*ae*R-P,Qe=ve*de*R-S,$e=ve*A-E;tr(Le,Qe,$e,u);const Ke=(W-1)*$;M[Ke]=Le,M[Ke+1]=Qe,M[Ke+2]=$e,xr(p,W-1,U,H)}}for(let H=1;H<=o;H++){const Y=H*B,A=x*(1-Y)+C*Y,R=fi.sinLatLUT[H],W=fi.cosLatLUT[H],U=H+1,I=U*B,de=x*(1-I)+C*I,ae=fi.sinLatLUT[U],ve=fi.cosLatLUT[U],Le=fi.sinLonLUT[0],Qe=fi.cosLonLUT[0],$e=T+bt(y,A,n);let Ke=Qe*W*$e-P,xt=Le*W*$e-S,Ct=R*$e-E;const Ue=k*$;let Ae=M[Ue],st=M[Ue+1],Ie=M[Ue+2];for(let qe=1;qe<=o;qe++){const me=qe*B,Me=y*(1-me)+b*me,V=fi.sinLonLUT[qe],L=fi.cosLonLUT[qe];let N=0,K=0,he=0;if(qe<o){const Fe=(k+1)*$;N=M[Fe],K=M[Fe+1],he=M[Fe+2]}else{const Fe=fi.sinLonLUT[l],_t=fi.cosLonLUT[l],Ft=T+bt(b,A,n);N=_t*W*Ft-P,K=Fe*W*Ft-S,he=R*Ft-E}const Te=Ke,re=xt,be=Ct;Ke=Ae,xt=st,Ct=Ie,Ae=N,st=K,Ie=he;const q=N-Te,J=K-re,_e=he-be;let ot=0,ut=0,lt=0;if(H>1){const Fe=(k-o)*$;ot=M[Fe],ut=M[Fe+1],lt=M[Fe+2]}else{const Fe=fi.sinLatLUT[0],_t=fi.cosLatLUT[0],Ft=T+bt(Me,x,n);ot=L*_t*Ft-P,ut=V*_t*Ft-S,lt=Fe*Ft-E}const it=T+bt(Me,de,n),et=L*ve*it-P,ke=V*ve*it-S,Ye=ae*it-E;if(H<o){const Fe=k+o,_t=Fe*$;M[_t]=et,M[_t+1]=ke,M[_t+2]=Ye,tr(et,ke,Ye,u),xr(p,Fe,me,I)}const je=ot-et,Se=ut-ke,Ee=lt-Ye;let Ve=L*W,Je=V*W,ht=R;ht*ht<.999&&(Ve=_e*Se-J*Ee,Je=q*Ee-_e*je,ht=J*je-q*Se);const Yt=1/Math.sqrt(Ve*Ve+Je*Je+ht*ht);fc(_,k,Ve*Yt,Je*Yt,ht*Yt,f),++k}}}function XI(s){s.tile.intersectsClippingArea&&(bf(s),kl(s),s.intersectionData=null)}function KI(s){s.tile.intersectsClippingArea&&(Dx(s),bf(s),kl(s),Lx(s),s.intersectionData=null)}function JI(s){s.tile.intersectsClippingArea&&(Tx(s),Cx(s,!0),kl(s),s.intersectionData=null)}function bf(s){s.tile.intersectsClippingArea&&(Tx(s),Cx(s))}function Cx(s,e=!1){const{geometry:t,geometryState:i,tile:r,localOrigin:a}=s,{level:n,extent:o,extentInRadians:l,ellipsoid:h}=r,u=h.radius,d=l[0],p=l[2],_=l[1],f=l[3],{samplerData:g}=i,y=o[0],b=o[2],x=o[1],C=o[3],T=wf(s),{boundingBox:P,vertexAttributes:S}=t,E=a[0],M=a[1],$=a[2],B=S.position,k=B.typedBuffer,H=B.typedBufferStride,Y=S.uv0;for(let A=0;A<4;++A){const R=A===1||A===3,W=i.edgeResolutions[A];z(rc(W));const U=W+1,I=eo(r,i.edgePeerNeighbors[A]);if(Nx(r,I,A)){$x(s,A,I);continue}const de=I!=null;z(!de||I.level===r.level),z(!de||Wr(r,I)<=0);const ae=I==null?void 0:I.renderData,ve=ae==null?void 0:ae.geometryState;if(zi){const q=r.surface;if(!I&&q&&!q.updatingRootTiles){const J=gr[A],_e=r.findNeighborTile(J,ot=>ot.loaded||ot.leaf||ot.level===r.level);_e?_e.intersectsClippingArea&&(z(!_e.loaded),z(!_e.leaf),z(_e.level===n)):z((q==null?void 0:q.rootTiles)==null||!r.shouldHaveNeighbor(J))}}const Le=A===1?o[2]:o[0],Qe=I==null?void 0:I.extent,$e=Qe&&R?A===1?Qe[0]:Qe[2]:Le,Ke=A===0?o[3]:o[1],xt=A===1?1:0,Ct=A===0?1:0,Ue=A===1?p:d,Ae=A===0?f:_,st=Math.sin(Ue),Ie=Math.cos(Ue),qe=Math.sin(Ae),me=Math.cos(Ae),Me=ve==null?void 0:ve.samplerData,V=de?(q,J,_e)=>.5*(bt(q,J,g)+bt(_e,J,Me)):(q,J,_e)=>bt(q,J,g),L=t.outerEdgesOffsetAndLength[2*A+0],N=e&&U>3?U-3:1,K=g!=null&&g.some(q=>q!=null),he=Me!=null&&Me.some(q=>q!=null),Te=K||he,re=1/W,be=L;z(!Qe||js(Qe[2]-Qe[0],o[2]-o[0])),(()=>{const q=A===1?-1:A===3?1:0,J=A===0?-1:A===2?1:0,_e=(o[2]-o[0])*re,ot=q*_e,ut=J*_e,lt=R?q*((p-d)*re):0,it=R?0:J*re,et=Ct,ke=R?Ue+lt:Ue,Ye=R?Math.sin(ke):st,je=R?Math.cos(ke):Ie,Se=R?Ue-lt:Ue,Ee=R?Math.sin(Se):st,Ve=R?Math.cos(Se):Ie,Je=R?Ae:T(et+it),ht=R?qe:Math.sin(Je),Yt=R?me:Math.cos(Je),Fe=R?Ae:T(et-it),_t=R?qe:Math.sin(Fe),Ft=R?me:Math.cos(Fe);let Li=0,cs=0,us=0;{const He=0*re,yt=R?Le:y*(1-He)+b*He,li=R?$e:yt,wi=R?x*(1-He)+C*He:Ke,Zt=R?Ue:d*(1-He)+p*He,ds=R?st:Math.sin(Zt),Eo=R?Ie:Math.cos(Zt),la=R?T(He):Ae,Pn=R?Math.sin(la):qe,ha=R?Math.cos(la):me,ca=u+V(yt,wi,li);Li=Eo*ha*ca,cs=ds*ha*ca,us=Pn*ca}let Ni=0,ii=0,Ut=0;{const He=1*re,yt=R?Le:y*(1-He)+b*He,li=R?$e:yt,wi=R?x*(1-He)+C*He:Ke,Zt=R?Ue:d*(1-He)+p*He,ds=R?st:Math.sin(Zt),Eo=R?Ie:Math.cos(Zt),la=R?T(He):Ae,Pn=R?Math.sin(la):qe,ha=R?Math.cos(la):me,ca=u+V(yt,wi,li);Ni=Eo*ha*ca,ii=ds*ha*ca,Ut=Pn*ca}for(let He=1;He<U-1;He+=N){let yt=0,li=0,wi=0;{const ps=(He+1)*re,Er=R?Le:y*(1-ps)+b*ps,Ha=R?$e:Er,Bi=R?x*(1-ps)+C*ps:Ke,za=R?Ue:d*(1-ps)+p*ps,Do=R?st:Math.sin(za),Gc=R?Ie:Math.cos(za),Ql=R?T(ps):Ae,Bc=R?Math.sin(Ql):qe,Yl=R?Math.cos(Ql):me,$o=u+V(Er,Bi,Ha);yt=Gc*Yl*$o,li=Do*Yl*$o,wi=Bc*$o}const Zt=yt,ds=li,Eo=wi,la=Ni,Pn=ii,ha=Ut;Ni=Zt,ii=ds,Ut=Eo;{const ps=be+He,Er=ps*H,Ha=la-E,Bi=Pn-M,za=ha-$;k[Er]=Ha,k[Er+1]=Bi,k[Er+2]=za,tr(Ha,Bi,za,P);const Do=He*re;xr(Y,ps,R?xt:Do,R?Do:Ct)}const ca=Li,HC=cs,zC=us;Li=la,cs=Pn,us=ha;const jl=la,Wl=Pn,Oo=ha,zc=1/Math.sqrt(jl*jl+Wl*Wl+Oo*Oo),Ff=Oo*zc;let Mo=0,Ro=0,Ao=0;if(Te&&Ff*Ff<.999){let ps=0,Er=0,Ha=0;{const Bi=A===0?-1:1;ps=Bi*(Zt-ca),Er=Bi*(ds-HC),Ha=Bi*(Eo-zC)}{const Bi=He*re,za=R?Le:y*(1-Bi)+b*Bi,Do=R?$e:za,Gc=R?x*(1-Bi)+C*Bi:Ke,Ql=R?Ue:d*(1-Bi)+p*Bi,Bc=R?st:Math.sin(Ql),Yl=R?Ie:Math.cos(Ql),$o=R?T(Bi):Ae,Uf=R?Math.sin($o):qe,Hf=R?Math.cos($o):me;let Lp=jl,Np=Wl,Vp=Oo;if(de){const En=u+bt(Do-ot,Gc-ut,Me),Zl=R?Hf:Ft;Lp=(R?Ve:Yl)*Zl*En,Np=(R?Ee:Bc)*Zl*En,Vp=(R?Uf:_t)*En}{const En=u+bt(za+ot,Gc+ut,g),Zl=R?Hf:Yt,zf=(R?je:Yl)*Zl*En,Gf=(R?Ye:Bc)*Zl*En,Bf=(R?Uf:ht)*En;de||(Lp=2*jl-zf,Np=2*Wl-Gf,Vp=2*Oo-Bf);const Fp=A===3?-1:1,qf=Fp*(Lp-zf),kf=Fp*(Np-Gf),jf=Fp*(Vp-Bf);Mo=Ha*kf-Er*jf,Ro=ps*jf-Ha*qf,Ao=Er*qf-ps*kf;const Up=1/Math.sqrt(Mo*Mo+Ro*Ro+Ao*Ao);Mo*=Up,Ro*=Up,Ao*=Up}}}else Mo=jl*zc,Ro=Wl*zc,Ao=Oo*zc;t.setEdgeNormalFromValues(A,He,Mo,Ro,Ao)}})()}}function Tx(s){Ix(s)}function Sx(s,e){return Math.PI/2-2*Math.atan(Math.exp(-s/e))}function eL(s,e,t,i){return Sx(s*(1-i)+e*i,t)}function tL(s,e,t){return s*(1-t)+e*t}function wf(s){const{tile:e}=s;if(e.surface.isWebMercator){const i=e.extent,r=e.ellipsoid.radius;return a=>eL(i[1],i[3],r,a)}const t=e.extentInRadians;return i=>tL(t[1],t[3],i)}function iL(s,e){const{tile:t,geometryState:i,geometry:r}=s,{extent:a,surface:n}=t,{wireframe:o}=i,l=a[0],h=a[1],u=a[2]-l,d=a[3]-h,{numVerticesPerSide:p,clippingArea:_}=i,f=_!=null?Math.max(0,(_[0]-l)/u):0,g=_!=null?Math.max(0,(_[1]-h)/d):0,y=_!=null?Math.min(1,(_[2]-l)/u):1,b=_!=null?Math.min(1,(_[3]-h)/d):1,x=(p-2)**2,C=Vx(i),T=x+4*C,P=n.renderer.tileGeometryCache.acquire(T),{boundingBox:S}=r;Nl(S),r.numVerticesPerSide=p,r.vertexAttributes=P,r.maxEdgeVertexCount=C,r.minu=f,r.minv=g,r.maxu=y,r.maxv=b,sL(s),r.edgeVerticesStartIndex=x,Cf(s),xf(s),Mx(r,[],o),s.intersectionData=null}function sL(s){const e=s.tile;if(!e.intersectsClippingArea)return;const{geometry:t,geometryState:i,localOrigin:r}=s,{samplerData:a,clippingArea:n,numVerticesPerSide:o}=i,{surface:l,extent:h,ellipsoid:u}=e,{isWebMercatorOnPlateCarree:d}=l,p=n??Tf,_=h[0],f=h[1],g=h[2],y=h[3],b=Math.max(_,p[0]),x=Math.min(g,p[2]),C=Math.max(f,p[1]),T=Math.min(y,p[3]),P=u.radius,S=e.horizontalScale,E=o-1,M=o-2,{minu:$,minv:B,maxu:k,maxv:H,boundingBox:Y,vertexAttributes:A}=t,R=A.position,W=A.uv0,{typedBuffer:U,typedBufferStride:I}=A.normalCompressed,de=r[0],ae=r[1],ve=r[2],Le=R.typedBuffer,Qe=R.typedBufferStride;let $e=0;const Ke=Q(f,C,T),xt=d?(Math.PI/2-2*Math.atan(Math.exp(-Ke/P)))*P:Ke*S,Ct=1/E,Ue=Q(f*(1-Ct)+y*Ct,C,T);let Ae=xt,st=d?(Math.PI/2-2*Math.atan(Math.exp(-Ue/P)))*P:Ue*S;for(let Ie=1;Ie<=M;Ie++){const qe=Ie/E,me=Q(f*(1-qe)+y*qe,C,T),Me=Q(qe,B,H),V=st,L=(Ie-1)/E,N=Q(f*(1-L)+y*L,C,T),K=Ae,he=(Ie+1)/E,Te=Q(f*(1-he)+y*he,C,T),re=d?(Math.PI/2-2*Math.atan(Math.exp(-Te/P)))*P:Te*S,be=Q(he,B,H);Ae=st,st=re;const q=Q(_,b,x);let J=q*S,_e=bt(q,me,a);const ot=1/E,ut=Q(ot,$,k),lt=Q(_*(1-ut)+g*ut,b,x);let it=ut,et=lt,ke=lt*S,Ye=bt(lt,me,a);if(Ie===1){const je=ke-de,Se=Ae-ae,Ee=Ye-ve,Ve=0*Qe;Le[Ve]=je,Le[Ve+1]=Se,Le[Ve+2]=Ee,tr(je,Se,Ee,Y);const Je=Q(ot,$,k);xr(W,$e,Je,Me)}for(let je=1;je<=M;je++){const Se=ke,Ee=Ye,Ve=(je+1)/E,Je=Q(Ve,$,k),ht=Q(_*(1-Ve)+g*Ve,b,x),Yt=et;et=ht;{const ii=$e+1,Ut=ii*Qe;if(Ie===1||je===M){const He=ht*S,yt=bt(ht,me,a);if(Ie===1&&je<M){const li=He-de,wi=V-ae,Zt=yt-ve;Le[Ut]=li,Le[Ut+1]=wi,Le[Ut+2]=Zt,tr(li,wi,Zt,Y),xr(W,ii,Je,Me)}ke=He,Ye=yt}else ke=Le[Ut]+de,Ye=Le[Ut+2]+ve}const Fe=ke,_t=Ye,Ft=J,Li=_e;J=Se,_e=Ee;const cs=($e-M)*Qe,us=Ie===1?bt(Yt,N,a):Le[cs+2]+ve,Ni=bt(Yt,Te,a);if(Ie<M){const ii=$e+M,Ut=ii*Qe,He=Se-de,yt=re-ae,li=Ni-ve;Le[Ut]=He,Le[Ut+1]=yt,Le[Ut+2]=li,tr(He,yt,li,Y);const wi=it;it=Je,xr(W,ii,wi,be)}{const ii=Fe-Ft,Ut=K-re,He=Ut*(_t-Li),yt=ii*(us-Ni),li=-Ut*ii,wi=He*He+yt*yt+li*li;if(wi===0)fc(U,$e,0,0,1,I);else{const Zt=1/Math.sqrt(wi);fc(U,$e,He*Zt,yt*Zt,li*Zt,I)}}++$e}}}function rL(s,e){s.tile.intersectsClippingArea&&(Ex(s),Px(s,!0),kl(s),s.intersectionData=null)}function aL(s,e){s.tile.intersectsClippingArea&&(Dx(s),xf(s),kl(s),Lx(s),s.intersectionData=null)}function nL(s,e){s.tile.intersectsClippingArea&&(xf(s),kl(s),s.intersectionData=null)}function xf(s,e){s.tile.intersectsClippingArea&&(Ex(s),Px(s,!1))}function Px(s,e){const{geometry:t,geometryState:i,localOrigin:r}=s,a=s.tile,{surface:n,extent:o}=a,{clippingArea:l,samplerData:h}=i,u=l??Tf,d=o[0],p=o[2],_=o[1],f=o[3],g=[f>u[3],p>u[2],_<u[1],d<u[0]],y=a.horizontalScale,b=Ox(n.isWebMercatorOnPlateCarree,a.ellipsoid.radius,y),{minu:x,minv:C,maxu:T,maxv:P,boundingBox:S}=t,E=Math.max(d,u[0]),M=Math.min(p,u[2]),$=Math.max(_,u[1]),B=Math.min(f,u[3]),k=r[0],H=r[1],Y=r[2];for(let A=0;A<4;++A){const R=A===1||A===3,W=i.edgeResolutions[A];z(rc(W));const U=W+1,I=g[A],de=eo(a,i.edgePeerNeighbors[A]);if(!I&&Nx(a,de,A)){$x(s,A,de);continue}const ae=de!=null&&!I,ve=de==null?void 0:de.renderData,Le=ve==null?void 0:ve.geometryState;if(zi&&(z(!ae||de.level===a.level),z(!ae||Wr(a,de)<=0),a&&!de&&!n.updatingRootTiles)){const re=gr[A],be=a.findNeighborTile(re,q=>q.loaded||q.leaf||q.level===a.level);n.updatingRootTiles||(be?be.intersectsClippingArea&&(z(!be.loaded),z(!be.leaf),z(be.level===a.level)):z((n==null?void 0:n.rootTiles)==null||!a.shouldHaveNeighbor(re)))}const Qe=Q(A===1?p:d,E,M),$e=Q(A===0?f:_,$,B),Ke=Le==null?void 0:Le.samplerData,xt=e&&U>3?U-3:1,Ct=Q(A===1?1:0,x,T),Ue=Q(A===0?1:0,C,P),Ae=ae?(re,be)=>.5*(bt(re,be,Ke)+bt(re,be,h)):(re,be)=>bt(re,be,h),st=(p-d)/W,Ie=R?A===1?st:-st:0,qe=R?0:A===0?st:-st,me=-Ie,Me=-qe;let V=0,L=0,N=0;{const re=0/W,be=R?Qe:Q(d*(1-re)+p*re,E,M),q=R?Q(_*(1-re)+f*re,$,B):$e,J=Ae(be,q);V=be*y,L=b(q),N=J}let K=0,he=0,Te=0;{const re=1/W,be=R?Qe:Q(d*(1-re)+p*re,E,M),q=R?Q(_*(1-re)+f*re,$,B):$e,J=Ae(be,q);K=be*y,he=b(q),Te=J}for(let re=1;re<U-1;re+=xt){const be=re/W,q=K,J=he,_e=Te;{const Ee=R?Ct:Q(be,x,T),Ve=R?Q(be,C,P):Ue,Je=q-k,ht=J-H,Yt=_e-Y;tr(q,ht,Yt,S),t.setEdgeVertexFromValuesRawPositionUV(A,re,Je,ht,Yt,Ee,Ve)}{const Ee=(re+1)/W,Ve=R?Qe:Q(d*(1-Ee)+p*Ee,E,M),Je=R?Q(_*(1-Ee)+f*Ee,$,B):$e,ht=Ae(Ve,Je);K=Ve*y,he=b(Je),Te=ht}const ot=K,ut=Te,lt=V,it=L,et=N;V=q,L=J,N=_e;let ke=0,Ye=0,je=0;if(R){const Ee=he-J,Ve=ut-_e,Je=it-J,ht=et-_e,Yt=Q(_*(1-be)+f*be,$,B),Fe=Qe+me,_t=Fe*y-q,Ft=bt(Fe,Yt,h)-_e,Li=A===3?-1:1;if(ke=Li*(-Je+Ee)*Ft,Ye=Li*_t*(-ht+Ve),je=-Li*_t*(-Je+Ee),ae){const cs=Qe+Ie,us=cs*y-q;ke=(-Je+Ee)*(Ft-(bt(cs,Yt,Ke)-_e)),Ye=(_t-us)*(-ht+Ve),je=-(_t-us)*(-Je+Ee)}}else{const Ee=ot-q,Ve=ut-_e,Je=lt-q,ht=et-_e,Yt=Q(d*(1-be)+p*be,E,M),Fe=$e+Me,_t=bt(Yt,Fe,h)-_e,Ft=b(Fe)-J,Li=A===2?-1:1;if(ke=Li*Ft*(-ht+Ve),Ye=Li*(-Je+Ee)*_t,je=-Li*Ft*(-Je+Ee),ae){const cs=Yt,us=$e+qe,Ni=b(us)-J;ke=(-Ft+Ni)*(-ht+Ve),Ye=(-Je+Ee)*(-_t+(bt(cs,us,Ke)-_e)),je=-(-Ft+Ni)*(-Je+Ee)}}const Se=1/Math.sqrt(ke*ke+Ye*Ye+je*je);t.setEdgeNormalFromValues(A,re,ke*Se,Ye*Se,je*Se)}}}function Ex(s,e){Ix(s)}function oL(s,e){return(Math.PI/2-2*Math.atan(Math.exp(-s/e)))*e}function lL(s,e){return s*e}function Ox(s,e,t){return s?i=>oL(i,e):i=>lL(i,t)}function Mx(s,e,t){const{numVerticesPerSide:i,vertexAttributes:r,maxEdgeVertexCount:a}=s,n=i-1,o=r.count,l=2*(i-3)*(i-3),h=4*(n+a-3),u=_f.reduce((g,y)=>g+(n+s.getEdgeCount(y)-3),0),d=e.reduce((g,y)=>g+n*(2*(y.latitudeResolution-1)+1),0),p=3*(t?2:1),_=(l+h+d)*p,f=o>=WI?new Uint32Array(_):new Uint16Array(_);for(let g=0;g<_;++g)f[g]=0;s.indices=f,s.indexCount=(l+u+d)*p,s.poleIndicesStartIndex=l*p,s.edgeIndicesStartIndex=(l+d)*p,t?(uL(s),dL(s,e),Ax(s)):(hL(s),cL(s,e),Rx(s))}function hL(s){const{numVerticesPerSide:e,indices:t,vertexAttributes:i}=s,{position:r}=i,{typedBuffer:a,typedBufferStride:n}=r,o=e-2,l=e-3,h=0,u=e-3;let d=0;for(let p=0;p<l;++p){const _=p*o;for(let f=h;f<u;++f){const g=_+f,y=g+1,b=y+o,x=b-1;Fx(g,y,b,x,n,a)?(t[d]=g,t[d+1]=y,t[d+2]=b,t[d+3]=b,t[d+4]=x,t[d+5]=g):(t[d]=g,t[d+1]=y,t[d+2]=x,t[d+3]=x,t[d+4]=y,t[d+5]=b),d+=6}}}function cL(s,e){const{numVerticesPerSide:t,indices:i,poleIndicesStartIndex:r}=s,a=t-1;let n=r;for(const o of e){const l=o.isNorth?1:2,h=o.isNorth?2:1,u=o.isNorth?3:4,d=o.isNorth?4:3;let p=s.getEdgeVertexIndex(o.connectedOuterEdgeOffset,0),_=1;for(let f=0;f<o.latitudeResolution;++f){const g=f===0?o.rowOffset:p+t;for(let y=0;y<a;y++){const b=g+y;i[n]=p,i[n+l]=p+1,i[n+h]=b,f<o.latitudeResolution-1?(i[n+u]=p+1,i[n+d]=b+1,i[n+5]=b,n+=6):n+=3,p+=_}p=g,_=1}}}function Rx(s){const{indices:e,numVerticesPerSide:t,edgeIndicesStartIndex:i}=s,r=t-1,a=r-2;let n=i;for(let o=0;o<4;++o){const l=Sf[o];let h=0,u=0;const d=s.getEdgeCount(o),p=l.count;z(p===r-1);const _=o===1||o===2,f=_?1:2,g=_?2:1,y=s.getEdgeFirstVertexIndex(o),b=1,x=l.vertex0Index,C=l.stride;for(;h<d-1||u<p-1;){const T=x+u*C,P=y+h*b,S=h<d-1,E=u<p-1,M=S&&(!E||(S?0+r*(h+.5)/(d-1):0)<=(E?1+a*(u+.5)/(p-1):0));M?++h:++u;const $=M?P+b:T+C;e[n]=T,e[n+f]=P,e[n+g]=$,n+=3}}s.indexCount=n}function uL(s){const{indices:e,numVerticesPerSide:t,vertexAttributes:i}=s,{position:r}=i,{typedBuffer:a,typedBufferStride:n}=r,o=t-2;let l=0;for(let h=0;h<t-3;++h){const u=h*o;for(let d=0;d<t-3;++d){const p=h*o+d,_=p+1,f=_+o,g=f-1,y=u+d,b=y+1,x=b+o;Fx(y,b,x,x-1,n,a)?(gl(e,l,p,_,f),l+=6,gl(e,l,f,g,p)):(gl(e,l,p,_,g),l+=6,gl(e,l,g,f,_)),l+=6}}}function dL(s,e){const{indices:t,numVerticesPerSide:i,poleIndicesStartIndex:r}=s,a=i-1;let n=r;for(const o of e){const l=o.connectedOuterEdgeOffset;let h=s.getEdgeVertexIndex(l,0),u=1;for(let d=0;d<o.latitudeResolution;++d){const p=d===0?o.rowOffset:h+i;for(let _=0;_<a;_++)gl(t,n,h,h+1,p+_),n+=6,d<o.latitudeResolution-1&&(gl(t,n,h+1,p+_+1,p+_),n+=6),h+=u;h=p,u=1}}}function Ax(s){const{indices:e,numVerticesPerSide:t,edgeIndicesStartIndex:i}=s,r=t-1,a=r-2;let n=i;for(let o=0;o<4;++o){const l=Sf[o];let h=0,u=0;const d=s.getEdgeCount(o),p=l.count;z(p===r-1);const _=o===1||o===2,f=_?1:3,g=_?3:1,y=s.getEdgeFirstVertexIndex(o),b=1,x=l.vertex0Index,C=l.stride;for(;h<d-1||u<p-1;){const T=x+u*C,P=y+h*b,S=h<d-1,E=u<p-1,M=S&&(!E||(S?0+r*(h+.5)/(d-1):0)<=(E?1+a*(u+.5)/(p-1):0));M?++h:++u;const $=M?P+b:T+C;e[n]=T,e[n+f]=P,e[n+f+1]=P,e[n+g]=$,e[n+g+1]=$,e[n+5]=T,n+=6}}s.indexCount=n}function Cf(s){const{geometry:e,geometryState:t}=s,{edgeResolutions:i}=t,{numVerticesPerSide:r,edgeVerticesStartIndex:a}=e,n=r-2;let o=a;for(let l=0;l<4;++l){{const h=l===0||l===2,u=(l===0?n-1:0)*n+(l===1?n-1:0),d=(h?0:1)*n+(h?1:0),p=Sf[l];p.vertex0Index=u,p.stride=d,p.count=n}{const h=i[l]+1;e.outerEdgesOffsetAndLength[2*l+0]=o,e.outerEdgesOffsetAndLength[2*l+1]=h,o+=h}}}function Dx(s){Cf(s),s.geometryState.wireframe?Ax(s.geometry):Rx(s.geometry)}function $x(s,e,t){const{geometryState:i,geometry:r,tile:a,localOrigin:n}=s,o=e===1||e===3,l=i.edgeResolutions[e];z(rc(l));const h=l+1,{boundingBox:u,minu:d,minv:p,maxu:_,maxv:f,vertexAttributes:g}=r,y=Q(e===1?1:0,d,_),b=Q(e===0?1:0,p,f),x=t.renderData,C=x.geometryState,T=x.geometry,P=(e+2)%4,S=T.getEdgeCount(P),E=a.getNeighborEdgeStartVertexIndex(e,t)*l,M=l*2**(a.level-t.level);z(C.edgeResolutions[P]===M),z(S-1===M);const $=x.localOrigin[0]-n[0],B=x.localOrigin[1]-n[1],k=x.localOrigin[2]-n[2],H=r.getEdgeFirstVertexIndex(e),Y=g.position,A=Y.typedBuffer,R=Y.typedBufferStride,W=g.normalCompressed,U=W.typedBuffer,I=W.typedBufferStride,de=g.uv0,ae=T.vertexAttributes,ve=T.getEdgeFirstVertexIndex(P),Le=ae.position.typedBuffer,Qe=ae.position.typedBufferStride,$e=ae.normalCompressed.typedBuffer,Ke=ae.normalCompressed.typedBufferStride;for(let xt=1;xt<h-1;++xt){const Ct=H+xt,Ue=ve+(E+xt),Ae=Ct*R,st=Ue*Qe,Ie=Le[st]+$,qe=Le[st+1]+B,me=Le[st+2]+k;A[Ae]=Ie,A[Ae+1]=qe,A[Ae+2]=me,tr(Ie,qe,me,u);const Me=Ct*I,V=Ue*Ke;U[Me]=$e[V],U[Me+1]=$e[V+1];const L=xt/l,N=o?y:Q(L,d,_),K=o?Q(L,p,f):b;xr(de,Ct,N,K)}}function Ix(s){var Me;const{geometry:e,geometryState:t,localOrigin:i}=s,{clippingArea:r,samplerData:a}=t,{minu:n,minv:o,maxu:l,maxv:h,boundingBox:u,vertexAttributes:d}=e,p=s.tile,{surface:_,ellipsoid:f,extent:g,extentInRadians:y,horizontalScale:b}=p,x=((Me=_.view)==null?void 0:Me.viewingMode)==="local",C=f.radius;let T=0,P=0,S=0;const E=(V,L,N)=>{const K=y[L===0?1:3],he=y[V===0?0:2],Te=Math.cos(K),re=Math.sin(K),be=Math.sin(he),q=Math.cos(he),J=C+N;T=q*Te*J,P=be*Te*J,S=re*J},M=x?(()=>{const V=r,L=V!=null&&(g[3]>V[3]||g[2]>V[2]||g[1]<V[1]||g[0]<V[0]),N=Ox(_.isWebMercatorOnPlateCarree,C,b);return(K,he,Te)=>{const re=K===0?g[0]:g[2],be=he===0?g[1]:g[3],q=L?Q(re,V[0],V[2]):re,J=L?Q(be,V[1],V[3]):be,_e=Te;T=q*b,P=N(J),S=_e}})():E;let $=0,B=0,k=0,H=0,Y=0,A=0,R=0,W=0,U=0;const I=x&&_.isWebMercatorOnPlateCarree,de=(V,L,N,K,he)=>{let Te=0,re=0,be=0;if(x){const q=L*b,J=I?(Math.PI/2-2*Math.atan(Math.exp(-N/C)))*C:N*b;Te=q-T,re=J-P,be=K-S}else{const q=wf(V),J=V.tile,_e=J.extent,ot=J.extentInRadians,ut=(L-_e[0])/(_e[2]-_e[0]),lt=(N-_e[1])/(_e[3]-_e[1]),it=ot[0]*(1-ut)+ot[2]*ut,et=q(lt),ke=Math.cos(et),Ye=Math.sin(et),je=Math.sin(it),Se=Math.cos(it),Ee=C+K;Te=Se*ke*Ee-T,re=je*ke*Ee-P,be=Ye*Ee-S}switch(he){case 0:R+=Te,W+=re,U+=be;break;case 1:H-=Te,Y-=re,A-=be;break;case 2:R-=Te,W-=re,U-=be;break;case 3:H+=Te,Y+=re,A+=be}},ae=r??Tf,ve=g[0],Le=g[2],Qe=g[1],$e=g[3],Ke=[$e>ae[3],Le>ae[2],Qe<ae[1],ve<ae[0]],xt=Math.max(ve,ae[0]),Ct=Math.min(Le,ae[2]),Ue=Math.max(Qe,ae[1]),Ae=Math.min($e,ae[3]),st=V=>Math.max(ae[0],Math.min(ae[2],V)),Ie=V=>Math.max(ae[1],Math.min(ae[3],V)),qe=V=>{const L=t.cornerNeighborCornerTiles;$=0,B=0,k=1,H=0,Y=0,A=0,R=0,W=0,U=0;let N=1/0;for(let q=0;q<4;++q){const J=L[4*V+q];N=Math.min(N,(J==null?void 0:J.level)??1/0)}for(let q=0;q<4;++q){const J=L[4*V+q];gh[q]=(J==null?void 0:J.level)===N?J:null}let K=1,he=0;for(let q=0;q<4;++q){const J=gh[q];J&&(K=Math.max(K,J==null?void 0:J.renderData.geometryState.numVerticesPerSide),he=J.extent[2]-J.extent[0])}const Te=he,re=K;z(re>1);const be=Te/re;for(let q=0;q<4;++q){const J=gh[(q+3)%4],_e=gh[q%4];if(!J&&!_e)continue;const ot=q===0?1:q===1?2:q===2?3:0,ut=q===0?2:q===1?3:q===2?0:1;if(J&&_e){const lt=Nm[q][0]*be,it=Nm[q][1]*be,et=J.extent,ke=st(et[ot===0||ot===1?2:0]+lt),Ye=Ie(et[ot===0||ot===3?3:1]+it),je=_e.extent,Se=st(je[ut===0||ut===1?2:0]+lt),Ee=Ie(je[ut===0||ut===3?3:1]+it),Ve=J.renderData,Je=_e.renderData,ht=bt(ke,Ye,Ve.geometryState.samplerData),Yt=bt(Se,Ee,Je.geometryState.samplerData);de(Ve,ke,Ye,.5*(ht+Yt),q)}else{const lt=J??_e,it=J?ot:ut,et=lt.extent,ke=Nm[q],Ye=st(et[it===0||it===1?2:0]+ke[0]*be),je=Ie(et[it===0||it===3?3:1]+ke[1]*be),Se=lt.renderData,Ee=bt(Ye,je,Se.geometryState.samplerData);de(Se,Ye,je,Ee,q)}}if(!x){const q=Math.sqrt(T*T+P*P+S*S);$=T/q,B=P/q,k=S/q}if(x||k*k<.999){const q=Math.sqrt(H*H+Y*Y+A*A);H/=q,Y/=q,A/=q;const J=Math.sqrt(R*R+W*W+U*U);R/=J,W/=J,U/=J,$=A*W-Y*U,B=H*U-A*R,k=Y*R-H*W;const _e=1/Math.sqrt($*$+B*B+k*k);$*=_e,B*=_e,k*=_e}},me=t.cornerNeighborCornerTiles;for(let V=0;V<4;++V){const L=V,N=(V+1)%4,K=V===0||V===1?1:0,he=V===0||V===3?1:0,Te=Q(K,n,l),re=Q(he,o,h),be=e.getEdgeFirstVertexIndex(L),q=e.getEdgeCount(L),J=V===0||V===3?q-1:0,_e=e.getEdgeFirstVertexIndex(N),ot=e.getEdgeCount(N),ut=V===0||V===1?ot-1:0;let lt=-1;for(let ke=0;ke<4;++ke){const Ye=me[4*V+ke],je=me[4*V+lt];Ye&&(lt===-1||Wr(je,Ye)>0)&&(lt=ke)}const it=lt,et=me[4*V+it];if(et!==p){const ke=p.level-et.level,Ye=2**ke,je=[et.lij[0]+ke,et.lij[1]*Ye,et.lij[2]*Ye],Se=[je[1]+Ye===p.lij[1],V===0&&(it===1||it===0&&et!==me[4*V+3])||V===1&&(it===0||it===1&&et!==me[4*V+2]),je[1]===p.lij[1]+1,V===2&&(it===3||it===2&&et!==me[4*V+1])||V===3&&(it===2||it===3&&et!==me[4*V+0])],Ee=Se.reduce((Fe,_t)=>Fe+(_t?1:0),0);z(Ee===1||Ee===2);let Ve=-1,Je=-1;const ht=et.renderData;if(Ee===1){const Fe=Se.findIndex(Ft=>Ft);z(0<=Fe&&Fe<=3),Ve=(Fe+2)%4;const _t=t.edgeResolutions[Fe];Je=p.getNeighborEdgeStartVertexIndex(Fe,et)*_t+_t*(Fe===0&&V===0||Fe===1&&V===0||Fe===2&&V===1||Fe===3&&V===3?1:0)}else{z(Se[1]||Se[3]),Ve=Se[1]?3:1;const Fe=ht.geometryState.edgeResolutions[Ve];Je=V===0||V===3?0:Fe}const Yt=ht.geometry;{const Fe=be+J,_t=_e+ut,Ft=Yt.getEdgeFirstVertexIndex(Ve)+Je,Li=Yt.vertexAttributes,cs=ht.localOrigin;{const Ni=Li.position,ii=Ni.typedBuffer,Ut=Ft*Ni.typedBufferStride,He=ii[Ut]+cs[0]-i[0],yt=ii[Ut+1]+cs[1]-i[1],li=ii[Ut+2]+cs[2]-i[2];tr(He,yt,li,u);const wi=d.position,Zt=wi.typedBuffer;{const ds=Fe*wi.typedBufferStride;Zt[ds]=He,Zt[ds+1]=yt,Zt[ds+2]=li}{const ds=_t*wi.typedBufferStride;Zt[ds]=He,Zt[ds+1]=yt,Zt[ds+2]=li}}const us=d.uv0;xr(us,Fe,Te,re),xr(us,_t,Te,re);{const Ni=Li.normalCompressed.typedBuffer,ii=Ft*Li.normalCompressed.typedBufferStride,Ut=d.normalCompressed,He=Ut.typedBuffer;{const yt=Fe*Ut.typedBufferStride;He[yt]=Ni[ii],He[yt+1]=Ni[ii+1]}{const yt=_t*Ut.typedBufferStride;He[yt]=Ni[ii],He[yt+1]=Ni[ii+1]}}}}else{const ke=Ke[L],Ye=Ke[N];let je;if(ke||Ye){const Je=Q(ve*(1-K)+Le*K,xt,Ct),ht=Q(Qe*(1-he)+$e*he,Ue,Ae);je=bt(Je,ht,a)}else je=pL(me,V);M(K,he,je),qe(V);const Se=T-i[0],Ee=P-i[1],Ve=S-i[2];tr(Se,Ee,Ve,u),e.setEdgeVertexFromValuesRawPositionUVNormal(L,J,Se,Ee,Ve,Te,re,$,B,k),e.setEdgeVertexFromValuesRawPositionUVNormal(N,ut,Se,Ee,Ve,Te,re,$,B,k)}}for(let V=0;V<4;++V)gh[V]=null}function pL(s,e){var o,l;const t=4*e,i=_f.reduce((h,u)=>{var d;return Math.min(h,((d=s[t+u])==null?void 0:d.level)??1/0)},1/0);zi&&(z(!s[t+0]||!s[t+2]||Q_(s[t+0],s[t+2],dt.SOUTH_WEST)),z(!s[t+1]||!s[t+3]||Q_(s[t+1],s[t+3],dt.NORTH_WEST)));let r=0,a=0;for(let h=0;h<4;++h){const u=s[t+h];if(u&&u.level===i){const d=h===0||h===1,p=h===0||h===3,_=u.extent,f=_[d?0:2],g=_[p?1:3],y=(l=(o=u.renderData)==null?void 0:o.geometryState)==null?void 0:l.samplerData;a+=bt(f,g,y),r++}}const n=r?a/r:0;return z(n!=null),n}function kl(s){const{vao:e,geometry:t}=s,{vertexAttributes:i,edgeVerticesStartIndex:r}=t,a=i.position.typedBuffer;e.vertexBuffers.get("geometry").setSubData(a,r,r,a.length)}function Lx(s){const{vao:e,geometry:t}=s,{indices:i,indexCount:r,edgeIndicesStartIndex:a}=t;e.indexBuffer.setSubData(i,a,a,r)}class mL{constructor(e,t,i,r,a){this.isNorth=e,this.connectedRowOffset=t,this.connectedOuterEdgeOffset=i,this.rowOffset=r,this.latitudeResolution=a}}const Nm=[[0,1],[1,0],[0,-1],[-1,0]],fi=new cI,Tf=UT(-1/0,-1/0,1/0,1/0),gh=[null,null,null,null];function Nx(s,e,t){if(!e)return!1;const i=Wr(s,e);return i>0||i===0&&t>=2}class Iu{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return z(0<=e&&e<this.count),this.vertex0Index+this.stride*e}}const Sf=[new Iu,new Iu,new Iu,new Iu];function tr(s,e,t,i){s<i[0]?i[0]=s:s>i[3]&&(i[3]=s),e<i[1]?i[1]=e:e>i[4]&&(i[4]=e),t<i[2]?i[2]=t:t>i[5]&&(i[5]=t)}function Vx(s){const{edgeResolutions:e,numVerticesPerSide:t}=s,i=1+Math.max(...e);return Math.max(t,i)}function Fx(s,e,t,i,r,a){const n=s*r,o=a[n],l=a[n+1],h=a[n+2],u=e*r,d=a[u],p=a[u+1],_=a[u+2],f=t*r,g=a[f],y=a[f+1],b=a[f+2],x=i*r,C=a[x],T=a[x+1],P=a[x+2];return(d-C)*(d-C)+(p-T)*(p-T)+(_-P)*(_-P)>(o-g)*(o-g)+(l-y)*(l-y)+(h-b)*(h-b)}function gl(s,e,t,i,r){s[e]=t,s[e+1]=i,s[e+2]=i,s[e+3]=r,s[e+4]=r,s[e+5]=t}const fd=6;let _L=class extends ff{constructor(e,t,i,r,a){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=pi(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,i,r,a)}init(e,t,i,r,a){super.init(e,t,i,r,a);const n=a.view.renderSpatialReference,o=a.spatialReference,l=n!=null&&Yb(n)&&o!=null&&o.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=l;const{isWebMercatorOnPlateCarree:h}=a,u=this._extentInRenderSR,d=this.extent;if(h){const p=Vt(d[0],d[1],0);Ll(p,si.WebMercator,p,si.PlateCarree);const _=Vt(d[2],d[3],0);Ll(_,si.WebMercator,_,si.PlateCarree),u[0]=p[0],u[1]=p[1],u[2]=_[0],u[3]=_[1]}else for(let p=0;p<4;++p)u[p]=d[p]*l;this.centerAtSeaLevel[0]=.5*(u[0]+u[2]),this.centerAtSeaLevel[1]=.5*(u[1]+u[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(u[2]-u[0],u[3]-u[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),r=Math.sqrt(t*t+i*i),a=.5*(this.elevationBoundsMax-this.elevationBoundsMin),n=Math.max(r,a);this._center[Ht.MIDDLE][3]=n}_calculateFrustumVisibility(e){const t=this._aabb(),i=t[0],r=t[1],a=t[2],n=t[3],o=t[4],l=t[5];let h=!0;for(let u=0;u<6;u++){const d=e[u],p=d[0],_=d[1],f=d[2],g=d[3];if(p*(p>0?i:n)+_*(_>0?r:o)+f*(f>0?a:l)+g>=0)return Hi.OUTSIDE;h=h&&p*(p<0?i:n)+_*(_<0?r:o)+f*(f<0?a:l)+g<=0}return h?Hi.INSIDE:Hi.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return aO(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,i,r){return Lu[0]=1/t[0],Lu[1]=1/t[1],Lu[2]=1/t[2],uw(this._aabb(),e,Lu,i,r)}createGeometry(){iL(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,i=this.renderData;let r=e,a=t;if(i){const n=i.geometry.boundingBox;r=n[2],a=n[5]}else if(!this.leaf){r=1/0,a=-1/0;for(const n of this.children){const o=n;r=Math.min(r,o._subtreeGeometryElevationBoundMin),a=Math.max(a,o._subtreeGeometryElevationBoundMax)}}if(r!==this._subtreeGeometryElevationBoundMin||a!==this._subtreeGeometryElevationBoundMax){this._subtreeGeometryElevationBoundMin=r,this._subtreeGeometryElevationBoundMax=a;const n=this.parent;n==null||n._updateSubtreeGeometryElevationsBounds()}}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){rL(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){nL(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){aL(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}};const Lu=v();let gL=class{constructor(){this.extent=Mi(),this.minLevel=0,this.maxLevel=0,this.callback=null}},yd=class extends Re{constructor(){super(...arguments),this._queries=new mt({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new mt({initialSize:30}),this._queryPool=new mo(gL)}queryVisibleLevelRange(e,t,i,r){const a=this._queryPool.acquire();zg(a.extent,e),a.minLevel=t??-Number.MAX_VALUE,a.maxLevel=i??Number.MAX_VALUE,a.callback=r,this._queryQueue.push(a),this.notifyChange("updating")}get updating(){return this._queryQueue.length!==0}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let i=0;for(;i<this._queriesInvPtr;){const r=this._queries.data[i],a=r.extent;t>=r.minLevel&&t<=r.maxLevel&&a[0]<=e.extent[2]&&a[2]>=e.extent[0]&&a[1]<=e.extent[3]&&a[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};c([m()],yd.prototype,"updating",null),yd=c([F("esri.views.3d.terrain.ScaleRangeQueries")],yd);function fL(s,e,t,i){const r=Math.cos(t);s[0]=Math.cos(e)*r*i,s[1]=Math.sin(e)*r*i,s[2]=Math.sin(t)*i}let yL=class extends ff{constructor(e,t,i,r,a){super(),this._convexHull=new Array(24),this._boundingSphere=Sr(),this._baseUsedMemory=1816,this.init(e,t,i,r,a)}init(e,t,i,r,a){super.init(e,t,i,r,a);const n=this.ellipsoid.radius,o=this.extentInRadians[0],l=this.extentInRadians[1],h=this.extentInRadians[2],u=this.extentInRadians[3],d=ze(l,u,.5),p=ze(o,h,.5),_=e===0?0:Math.min(Math.abs(l),Math.abs(u));this._edgeLen=(h-o)*Math.cos(_)*n,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=n-Math.sqrt(n*n-this._edgeLen2/4),fL(this.centerAtSeaLevel,p,d,this.ellipsoid.radius),ie(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(this.lij[0]===0)ce(wt(e[Ht.MIDDLE]),0,0,0),ce(e[Ht.TOP],0,0,0),ce(e[Ht.BOTTOM],0,0,0),e[Ht.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[Ht.MIDDLE],i=this.convexHull;let r=0;for(let a=0;a<8;++a)r=Math.max(r,vL(wt(t),i,3*a));e[Ht.MIDDLE][3]=Math.sqrt(r)}}_calculateFrustumVisibility(e){if(!Gg(e,this._boundingSphere))return Hi.OUTSIDE;if(this.lij[0]<10)return Hi.INTERSECTS;const t=this.convexHull,i=this.surface.view.state.camera.near;let r=!0;for(let a=0;a<lO;a++){const n=a===el.NEAR,o=e[a],l=o[0],h=o[1],u=o[2],d=o[3]-(n?i:0);let p=!1;for(let _=0;_<8;++_){const f=3*_;if(l*t[f]+h*t[f+1]+u*t[f+2]+d<0){if(p=!0,!r)break}else r=!1}if(!p)return Hi.OUTSIDE}return r?Hi.INSIDE:Hi.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){QI(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),zi&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=wt(e),i=this.elevationBoundsMin,r=this.elevationBoundsMax,a=this.ellipsoid.radius,n=r;if(this.level===0)ce(t,0,0,0),e[3]=a+n;else{const o=this.extentInRadians,l=.5*(o[0]+o[2]),h=o[1],u=o[3];Vn(R0,l,h,a),Vn(A0,l,u,a),ue(t,R0,A0),ee(t,t,(a+.5*(i+r))/ns(t));const d=this.convexHull;let p=0;const _=(g,y)=>{const b=g[0]-d[3*y],x=g[1]-d[3*y+1],C=g[2]-d[3*y+2];return Math.sqrt(b*b+x*x+C*C)};for(let g=0;g<8;++g){const y=_(t,g);p=Math.max(p,y)}const f=p;e[3]=f+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(this.level===0)return;const i=this.elevationBoundsMin,r=this.elevationBoundsMax,a=this._getPatchType(),n=this.surface.isWebMercator,o=n&&a===zr.HAS_NORTH_POLE,l=n&&a===zr.HAS_SOUTH_POLE,h=l||o,u=Math.PI/2,d=e[0],p=e[2],_=l?-u:e[1],f=o?u:e[3],g=.5*(d+p),y=i,b=t+(h?Math.min(0,y-1):y),x=(U,I,de)=>Vn(U,I,de,b),C=v(),T=v(),P=v(),S=v();x(C,d,_),x(T,d,f),x(P,p,f),x(S,p,_);const E=(U,I)=>{for(let de=0;de<3;++de)this._convexHull[3*I+de]=U[de]};E(C,0),E(T,1),E(P,2),E(S,3);const M=r,$=t+(h?Math.max(0,M+1):M),B=v(),k=v(),H=v();Vn(k,g,f,b),Vn(H,g,_,b),ue(B,k,H),ie(B,B);const Y=v(),A=v(),R=(U,I)=>{Mt(A,U,I),ie(A,A);const de=-oe(U,Y)/oe(A,Y);z(de>=0),ee(A,A,de),ue(U,U,A)};if(2**this.lij[0]>2*this.lij[1]){const U=H,I=v();pt(I,M0,U),ie(I,I),pt(Y,U,I),ie(Y,Y),z(js(oe(Y,U)/ns(U),0)),R(C,T),R(S,P),E(C,0),E(S,3)}else if(2**this.lij[0]!==2*this.lij[1]){const U=k,I=v();pt(I,M0,U),ie(I,I),pt(Y,I,U),ie(Y,Y),R(T,C),R(P,S),E(T,1),E(P,2)}const W=(U,I)=>{const de=$/oe(I,B);for(let ae=0;ae<3;++ae)this._convexHull[3*U+ae]=I[ae]*de};W(4,C),W(5,T),W(6,P),W(7,S)}_getPatchType(){const e=this.lij[1],t=e===0,i=e===(1<<this.level)-1;return t?i?zr.HAS_BOTH_POLES:zr.HAS_NORTH_POLE:i?zr.HAS_SOUTH_POLE:zr.REGULAR}intersectsRay(e,t,i,r){const a=this._boundingSphere,n=a[3]+i,o=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],l=a[0]-e[0],h=a[1]-e[1],u=a[2]-e[2],d=(l*t[0]+h*t[1]+u*t[2])/o,p=t[0]*d-l,_=t[1]*d-h,f=t[2]*d-u;return p*p+_*_+f*f<n*n}get minimumVerticesPerSide(){return this.level<O0.length?O0[this.level]+1:2}updateCornerElevations(){JI(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){XI(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){KI(this.renderData),this._updateBoundingVolumes()}_checkBVs(){var V;if(!zi||this.level<=2)return;const e=this._boundingSphere,t=e[3],i=wt(e),r=v(),a=this.ellipsoid.radius,n=this.elevationBoundsMin,o=this.elevationBoundsMax,l=a+n,h=1,u=0,d=this._center[Ht.MIDDLE][3],p=this.convexHull,_=(L,N)=>{for(let K=0;K<3;++K)L[K]=p[3*N+K]};{const L=v(),N=v(),K=v(),he=v(),Te=v(),re=(be,q,J,_e)=>{_(N,be),_(K,q),_(he,J),Mt(N,N,K),Mt(he,he,K),pt(L,N,he),ie(L,L);const ot=oe(L,K);_(Te,_e);const ut=oe(L,Te),lt=Math.abs(ut-ot);z(js(lt,0),`Non coplanar ${be},${q},${J},${_e} diff = ${lt}`)};re(0,1,2,3),re(4,5,6,7),re(0,1,4,5),re(1,2,5,6),re(2,3,6,7),re(3,0,7,4)}const f=nO(24),g=(L,N,K)=>{const he=4*L;for(let Te=0;Te<3;++Te)f[he+Te]=N[Te];f[he+3]=K},y=v(),b=v(),x=v(),C=v(),T=(L,N,K,he)=>{_(y,N),_(b,K),_(x,he),Mt(y,y,b),ie(y,y),Mt(x,x,b),ie(x,x),pt(C,y,x),ie(C,C);const Te=oe(C,b);g(L,C,Te)};T(0,0,1,2),T(1,1,0,4),T(2,1,5,2),T(3,3,2,6),T(4,4,0,3),T(5,4,6,5);const P=(L,N,K,he)=>{const Te=4*L;return f[Te]*N+f[Te+1]*K+f[Te+2]*he-f[Te+3]},S=(L,N,K,he)=>P(L,N,K,he)>=-1,E=(L,N)=>S(L,N[0],N[1],N[2]),M=2**this.lij[0]>2*this.lij[1],$=(L,N,K)=>Math.sqrt(Ux(L,N,K,i[0],i[1],i[2]))<t,B=L=>$(L[0],L[1],L[2]),k=(L,N)=>$(L[N],L[N+1],L[N+2]),H=this.extentInRadians,Y=.5*(H[0]+H[2]),A=H[1],R=H[3],W=v(),U=v();Vn(W,Y,R,l),Vn(U,Y,A,l);const I=M?"Upper":"Lower";let de=!0;for(let L=0;L<6;++L){for(let N=0;N<8;++N){const K=3*N,he=S(L,p[K],p[K+1],p[K+2]);de&&(de=he),z(he,`Tile[${this.lij}] Convex hull point ${N} outside of plane ${L}`)}z(E(L,U),`Tile[${this.lij}] (${I}) bottom mid outside of plane ${L}`),z(E(L,W),`Tile[${this.lij}] (${I}) top mid outside of plane ${L}`)}z(de,"Not all convex hull points are inside  convex hull polyhedron"),z(B(U),`Tile[${this.lij}] (${I}) bottom mid outside of bounding sphere`),z(B(W),`Tile[${this.lij}] (${I}) top mid outside of bounding sphere`);for(let L=0;L<8;++L){const N=k(p,3*L);z(N,`Tile[${this.lij}] Convex hull point ${L} outside of bounding sphere`)}for(let L=0;L<6;++L)for(let N=0;N<8;++N){const K=3*N;S(L,p[K],p[K+1],p[K+2])||console.error(`Tile[${this.lij}] Convex hull point ${N} outside of plane ${L}`)}const{extentInRadians:ae}=this,ve=Math.max(ae[2]-ae[0],ae[3]-ae[1]),Le=Math.round(ve*a),{renderData:Qe}=this;if(!Qe)return;const{geometry:$e,geometryState:Ke,localOrigin:xt}=Qe,Ct=(V=$e.vertexAttributes)==null?void 0:V.position;if(!Ct)return;const Ue=v(),Ae=$e.numVerticesPerSide-2,{indices:st,indexCount:Ie,edgeVerticesStartIndex:qe,poleVerticesStartIndex:me}=$e;if(!st)return;const Me=new Set;for(let L=0;L<Ie;++L){const N=st[L];if(Me.has(N))continue;Me.add(N);const K=N<me,he=N>=qe;let Te=!1,re=-1;if(he){let Se=qe;for(let Ee=0;Ee<4;++Ee){const Ve=Ke.edgeResolutions[Ee];if(N===Se||N===Se+Ve-1){Te=!0;break}if(Se+=Ve,N<Se){re=Ee;break}}}const be=he?Ke.edgePeerNeighbors[re]:null,q=he&&be&&Wr(this,be)>0;Ct.getVec(N,r),ue(Ue,r,xt);const J=ns(Ue)-a;let _e=0,ot=!1;const ut=n-J,lt=J-o,it=ut>h,et=lt>h,ke=it||et,Ye=()=>{const Se=K?"internal":he&&!Te?"edge":Te?"corner":"pole";return`Tile[${this.lij}].vertex[${N}]:${Se}`+(it?"(below)":et?"(above)":"")+(q?"(Neighbor)":"")},je=ys(Ue,i);if(je>=t+u){const Se=je-t;ke||(console.error(`${Ye()} is out of the bounding sphere by ${Se.toFixed(0)} / ${t.toFixed(0)}[tol=${u}] h=${J.toFixed(0)} / [${n.toFixed(0)}..${o.toFixed(0)}] (${(Se/t).toFixed(0)})`),ot=!0)}for(let Se=0;Se<6;++Se)if(!S(Se,Ue[0],Ue[1],Ue[2])){const Ee=P(Se,Ue[0],Ue[1],Ue[2]),Ve=N%Ae,Je=(N-Ve)/Ae;Se===0&&ut||Se===5&&lt||(console.error(`${Ye()} (${Ve},${Je})|${Ae}] is out of the bounding trapezoid plane ${Se} h=${Math.round(J)} / [${Math.round(n)}..${Math.round(o)}] dist=${Math.round(Ee)} radii = ${Math.round(t)}/${Math.round(d)}} : maxL = ${Le}`),++_e)}if(ot||_e>0)break}}get convexHull(){return this._convexHull}};const O0=[128,64,64,32,16,8,8,4];function vL(s,e,t){return Ux(s[0],s[1],s[2],e[t],e[t+1],e[t+2])}function Ux(s,e,t,i,r,a){const n=i-s,o=r-e,l=a-t;return n*n+o*o+l*l}const Vn=(s,e,t,i)=>{const r=Math.cos(e),a=Math.sin(e),n=Math.cos(t),o=Math.sin(t);s[0]=i*n*r,s[1]=i*n*a,s[2]=i*o},M0=[0,0,1],R0=v(),A0=v();let hr=class extends Re{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};c([m()],hr.prototype,"fovX",void 0),c([m()],hr.prototype,"fovY",void 0),c([m()],hr.prototype,"relativeWidthLimit",void 0),c([m()],hr.prototype,"relativeHeightLimit",void 0),c([m()],hr.prototype,"maxLod",void 0),c([m()],hr.prototype,"angledSplitBias",void 0),c([m()],hr.prototype,"aboveGround",void 0),c([m()],hr.prototype,"frustum",void 0),hr=c([F("esri.views.3d.terrain.SplitLimits")],hr);const bL=Cn().vec3f(De.POSITION).vec2i16(De.UV0).vec2i16(De.NORMALCOMPRESSED,{glNormalized:!0});let wL=class{constructor(e){this._storage=new Uc((t,i)=>e.newCache(t,i),"TileGeometry")}acquire(e){const i=Math.ceil(e/4)*4,r=this._storage,a=xL(i),n=r.pop(a);if(n)return n;const o=bL.createBuffer(i);return o.release=()=>r.put(a,o),o}clear(){this._storage.clear()}destroy(){this._storage.destroy()}};function xL(s){return s.toString()}let Hx=class extends Ii{constructor(){super(...arguments),this.scale=1,this.offset=uc}};function zx(s){s.attributes.add(De.POSITION,"vec2"),s.attributes.add(De.UV0,"vec2"),s.varyings.add("uv","vec2"),s.varyings.add("vuv","vec2"),s.vertex.uniforms.add(new Ze("scale",e=>e.scale),new ra("offset",e=>e.offset)),s.vertex.main.add(w`gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;`)}var jt;(function(s){s[s.Composite=0]="Composite",s[s.ColorComposite=1]="ColorComposite",s[s.GridComposite=2]="GridComposite",s[s.GroupBackgroundComposite=3]="GroupBackgroundComposite",s[s.COUNT=4]="COUNT"})(jt||(jt={}));var G;(function(s){s[s.Normal=0]="Normal",s[s.Average=1]="Average",s[s.Lighten=2]="Lighten",s[s.Lighter=3]="Lighter",s[s.Plus=4]="Plus",s[s.Screen=5]="Screen",s[s.ColorDodge=6]="ColorDodge",s[s.Darken=7]="Darken",s[s.Multiply=8]="Multiply",s[s.ColorBurn=9]="ColorBurn",s[s.Overlay=10]="Overlay",s[s.SoftLight=11]="SoftLight",s[s.HardLight=12]="HardLight",s[s.VividLight=13]="VividLight",s[s.Hue=14]="Hue",s[s.Saturation=15]="Saturation",s[s.Luminosity=16]="Luminosity",s[s.Color=17]="Color",s[s.DestinationOver=18]="DestinationOver",s[s.DestinationAtop=19]="DestinationAtop",s[s.DestinationIn=20]="DestinationIn",s[s.DestinationOut=21]="DestinationOut",s[s.SourceAtop=22]="SourceAtop",s[s.SourceIn=23]="SourceIn",s[s.SourceOut=24]="SourceOut",s[s.Xor=25]="Xor",s[s.Difference=26]="Difference",s[s.Exclusion=27]="Exclusion",s[s.Minus=28]="Minus",s[s.Invert=29]="Invert",s[s.Reflect=30]="Reflect",s[s.COUNT=31]="COUNT"})(G||(G={}));const Y_={normal:G.Normal,average:G.Average,lighten:G.Lighten,lighter:G.Lighter,screen:G.Screen,plus:G.Plus,"color-dodge":G.ColorDodge,darken:G.Darken,multiply:G.Multiply,"color-burn":G.ColorBurn,overlay:G.Overlay,"soft-light":G.SoftLight,"hard-light":G.HardLight,"vivid-light":G.VividLight,hue:G.Hue,saturation:G.Saturation,luminosity:G.Luminosity,color:G.Color,difference:G.Difference,exclusion:G.Exclusion,minus:G.Minus,invert:G.Invert,reflect:G.Reflect,"destination-over":G.DestinationOver,"destination-atop":G.DestinationAtop,"destination-in":G.DestinationIn,"destination-out":G.DestinationOut,"source-atop":G.SourceAtop,"source-in":G.SourceIn,"source-out":G.SourceOut,xor:G.Xor};function CL(s){return s===G.DestinationOver||s===G.DestinationAtop||s===G.DestinationIn||s===G.DestinationOut||s===G.SourceAtop||s===G.SourceIn||s===G.SourceOut||s===G.Xor}var Fi;(function(s){s[s.NotRequired=0]="NotRequired",s[s.Required=1]="Required",s[s.COUNT=2]="COUNT"})(Fi||(Fi={}));var ks;(function(s){s[s.Off=0]="Off",s[s.On=1]="On",s[s.COUNT=2]="COUNT"})(ks||(ks={}));function TL(s,e){const t=e.blendMode;t!==G.Normal&&(t===G.Reflect&&s.code.add(w`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),t!==G.ColorDodge&&t!==G.VividLight||s.code.add(w`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),t!==G.ColorBurn&&t!==G.VividLight||s.code.add(w`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),t===G.Overlay&&s.code.add(w`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),t===G.HardLight&&s.code.add(w`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),t===G.SoftLight&&s.code.add(w`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),t===G.VividLight&&s.code.add(w`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),t!==G.Hue&&t!==G.Saturation&&t!==G.Color&&t!==G.Luminosity||(s.code.add(w`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),t!==G.Hue&&t!==G.Saturation||s.code.add(w`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),s.code.add(w`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${t===G.Multiply?w`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.Average?w`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.Lighten?w`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.Darken?w`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.Lighter?w`return vec4(cl * ol + cb * ob, ol + ob);`:t===G.Plus?w`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:t===G.Minus?w`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:t===G.Screen?w`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.Difference?w`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.Invert?w`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:t===G.DestinationOver?w`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:t===G.DestinationAtop?w`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:t===G.DestinationOut?w`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:t===G.SourceAtop?w`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:t===G.SourceOut?w`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:t===G.Xor?w`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:t===G.DestinationIn?w`return vec4(cb * ob * ol, ol * ob);`:t===G.SourceIn?w`return vec4(cl * ol * ob, ol * ob);`:t===G.Hue?w`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.Saturation?w`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.Color?w`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.Luminosity?w`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.Exclusion?w`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.Reflect?w`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.ColorDodge?w`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.ColorBurn?w`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.Overlay?w`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.SoftLight?w`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.HardLight?w`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===G.VividLight?w`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:w``}
    }
  `))}function Gx(s,e){const t=e.output===jt.GridComposite,i=e.output===jt.ColorComposite,r=e.output===jt.GroupBackgroundComposite,a=e.output===jt.Composite,n=e.baseOpacityMode===Fi.Required,o=s.fragment;n&&o.uniforms.add(new Ze("baseOpacity",d=>d.baseOpacity)),t?o.include(pf):i?o.uniforms.add(new on("backgroundColor",d=>d.backgroundColor)):a&&o.uniforms.add(new ft("fboColor",d=>d.fboTexture));const l=e.blendMode!==G.Normal,h=e.premultipliedSource===ks.On,u=!l&&!h&&(a&&!n||r);o.include(TL,e),o.code.add(w`
    vec4 getBackground(vec2 uv) {
      return ${n?w`baseOpacity *`:""} ${r?w`vec4(0.0, 0.0, 0.0, 0.0)`:i?w`vec4(backgroundColor, 1.0)`:t?w`vec4(gridColor(uv), 1.0)`:w`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`};
    }

    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {
      ${l?w`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec4 bgColor = getBackground(bgUV);
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:w`
          float composeAlpha = colorLayer.a * opacity;
          ${u?w`return colorLayer * opacity;`:w`
            vec4 bgColor = getBackground(bgUV);
            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}var Na;function Bx(s){const e=new kt,t=e.fragment;if(e.include(zx),s.background===Na.Only){const i=s.output===jt.ColorComposite;return i?t.uniforms.add(new on("backgroundColor",r=>r.backgroundColor)):t.include(pf),t.main.add(w`fragColor = vec4(${i?w`backgroundColor`:w`gridColor(uv)`}, 1.0);`),e}return e.include(Gx,s),t.uniforms.add(new ft("tex",i=>i.texture),new Ze("opacity",i=>i.opacity)),t.main.add(w`fragColor = blendLayers(uv, texture(tex, uv), opacity);`),e}(function(s){s[s.BelowLayer=0]="BelowLayer",s[s.Only=1]="Only",s[s.COUNT=2]="COUNT"})(Na||(Na={}));const SL=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return Na},build:Bx},Symbol.toStringTag,{value:"Module"}));let PL=class extends Hx{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=vr}},D0=class extends Bt{constructor(e,t){super(e,t,new qt(SL,()=>X(()=>Promise.resolve().then(()=>B4),void 0,import.meta.url)))}};var uo,bo;(function(s){s[s.Stretch=0]="Stretch",s[s.Lut=1]="Lut",s[s.Hillshade=2]="Hillshade",s[s.COUNT=3]="COUNT"})(uo||(uo={})),function(s){s[s.Noop=0]="Noop",s[s.PerBand=1]="PerBand",s[s.COUNT=2]="COUNT"}(bo||(bo={}));function EL(s,e){const t=s.transforms.tileUnitsToPixels,i=pw(e),r=Math.cos(i),a=Math.sin(i),n=Math.ceil(512*(Math.abs(a)+Math.abs(r)));w1(Lr),zd(Lr,Lr,[n/2,n/2]),x1(Lr,Lr,i),zd(Lr,Lr,[-256,-256]),C1(Lr,Lr,[1/8,1/8,1]),s.transforms.tileUnitsToPixels=Lr;const o=[],l=new s2(4096,o,()=>new a2),h=new r2(o,l,(u,d,p)=>new n2(u,d,p,s.styleRepository,s.key.level,e),(u,d)=>{o2(u,d,!1)},()=>0,u=>{const d=s.styleRepository.getStyleLayerByUID(u).getLayoutProperty("visibility");return!d||d.getValue()!==h2.NONE});o.push(s),l.add(s),h.setScreenSize(n,n),h.continue(1/0),l.removeTile(s),s.transforms.tileUnitsToPixels=t}const Lr=oS(),OL=.125;let ML=class{constructor(){this._renderParams={reshuffleManager:new u2,context:null,drawPhase:1,state:new RL,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new l2(new i2(0,0,0,0),0,0,0,512,512,4096,4096),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,t,i,r,a,n,o,l,h,u){const d=this._backgroundTile;this._updateRenderParameters(e,t,d,i,a,n,o,l,h,u),this._renderParams.stencilSymbols=!1,i.drawBackground(this._renderParams,d,r)}renderContent(e,t,i,r,a,n,o,l,h,u,d,p){this._declutter(i),r.forAll(({sourceLayerInfo:{data:g}})=>this._declutter(g));const _=r.length>0;_&&this._stencilSymbols(e,t,i,r,a,n,o,l,h,u,d,p);let f=1;i.stencilRef=_?f:0,e.setStencilFunction(Zi.EQUAL,i.stencilRef,255),this._render(e,t,i,a,n,o,l,h,u,d,p),r.forAll(({sourceLod:g,offset:y,sourceLayerInfo:{data:b}})=>{b.stencilRef=++f,this._renderSymbols(e,g,b,a,n,o,l,y,u,d,p)})}_stencilSymbols(e,t,i,r,a,n,o,l,h,u,d,p){let _=1;i.stencilRef=_,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(kp.KEEP,kp.KEEP,kp.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(Zi.ALWAYS,i.stencilRef,255),this._stencilTileSymbols(e,t,i,a,n,o,l,h,u,d,p),r.forAll(({sourceLod:f,offset:g,sourceLayerInfo:{data:y}})=>{y.stencilRef=++_,e.setStencilFunction(Zi.ALWAYS,y.stencilRef,255),this._stencilTileSymbols(e,f,y,a,n,o,l,g,u,d,p)}),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,i,r,a,n,o,l,h,u,d){e.setStencilFunction(Zi.EQUAL,i.stencilRef,255),this._render(e,t,i,r,a,n,o,l,h,u,d,c2.SYMBOL)}_render(e,t,i,r,a,n,o,l,h,u,d,p){this._updateRenderParameters(e,t,i,r,n,o,l,h,u,d),this._renderParams.stencilSymbols=!1,r.drawTile(this._renderParams,i,a,p)}_stencilTileSymbols(e,t,i,r,a,n,o,l,h,u,d){this._updateRenderParameters(e,t,i,r,n,o,l,h,u,d),this._renderParams.stencilSymbols=!0,i.triangleCount=0,r.drawSymbols(this._renderParams,i,a)}_updateRenderParameters(e,t,i,r,a,n,o,l,h,u){"type"in i&&i.type==="vector-tile"&&!i.stage&&i.attachWithContext(e);const d=t[0]-a.getLevelShift(t[0]),p=this._renderParams;p.context=e,p.painter=r,p.glyphMosaic=r.glyphMosaic,p.spriteMosaic=r.spriteMosaic,p.pixelRatio=h*u,p.displayLevel=d,p.requiredLevel=d;const _=a.getScale(t[0]),[f,g]=a.getOffset(t,n*_),y=OL*n*_/l,b=i.transforms.displayViewScreenMat3;b[0]=y,b[4]=-y,b[6]=-1-f-o[0]*n*2,b[7]=1+g+(1-o[1])*n*2-2;const x=p.state,C=l/u;x.size[0]=C,x.size[1]=C,x.pixelRatio=u,x.rotation=(360-this._heading)%360;const T=2/C;fP(x.displayViewMat3,T,0,0,0,-T,0,-1,1,1);const P=w1(x.displayMat3),S=pw(this._heading);zd(P,P,[C/2,C/2]),x1(P,P,S),zd(P,P,[-C/2,-C/2]),yP(P,x.displayViewMat3,P)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(EL(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}},RL=class{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=ia(),this.displayViewMat3=ia(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}},qx=class extends Ua{constructor(){super(...arguments),this.blendMode=G.Normal}};c([ne({count:G.COUNT})],qx.prototype,"blendMode",void 0);let Xh=class extends qx{constructor(){super(...arguments),this.output=jt.Composite,this.baseOpacityMode=Fi.NotRequired,this.premultipliedSource=ks.Off}};c([ne({count:jt.COUNT})],Xh.prototype,"output",void 0),c([ne({count:Fi.COUNT})],Xh.prototype,"baseOpacityMode",void 0),c([ne({count:ks.COUNT})],Xh.prototype,"premultipliedSource",void 0);let kx=class extends Xh{constructor(){super(...arguments),this.background=Na.BelowLayer}};c([ne({count:Na.COUNT})],kx.prototype,"background",void 0);function AL(s){s.fragment.uniforms.add(new ft("u_colormap",e=>e.u_colormap),new Ze("u_colormapOffset",e=>e.colormap.u_colormapOffset),new Ze("u_colormapMaxIndex",e=>e.colormap.u_colormapMaxIndex),new Ze("u_opacity",e=>e.common.u_opacity)),s.fragment.code.add(w`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}function DL(s){s.fragment.uniforms.add(new ft("u_transformGrid",e=>e.u_transformGrid),new ra("u_transformSpacing",e=>e.common.u_transformSpacing),new ra("u_targetImageSize",e=>e.common.u_targetImageSize)),s.fragment.code.add(w`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}let Sc=class extends Lc{constructor(e,t){super(e,"bool",vw.Pass,(i,r,a)=>i.setUniform1b(e,t(r,a)))}},$L=class extends Hx{constructor(e,t,i){super(),this.common=e,this.u_image=t,this.u_transformGrid=i}};function IL(s,e){s.include(DL),s.fragment.uniforms.add(new ft("u_image",i=>i.u_image),new Sc("u_flipY",i=>i.common.u_flipY),new Sc("u_applyTransform",i=>i.common.u_applyTransform));const{requireBilinearWithNN:t}=e;t&&s.fragment.uniforms.add(new ra("u_srcImageSize",i=>i.common.u_srcImageSize)),s.fragment.code.add(w`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),t?s.fragment.code.add(w`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):s.fragment.code.add(w`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}let Ap=class extends $L{constructor(e,t,i,r,a,n){super(e,r,a),this.colormap=t,this.symbolizer=i,this.u_colormap=n,this.backgroundColor=vr,this.fboTexture=null,this.baseOpacity=1}},jx=class extends Ap{},Wx=class extends Ap{};function Qx(s){const e=new kt;return e.include(zx),e.include(IL,s),e.include(AL,s),e.include(Gx,s),e.fragment.code.add(w`vec4 applyBackgroundBlend(vec4 layerColor) {
return blendLayers(vuv, layerColor, u_opacity);
}`),s.colorizerType===uo.Stretch?NL(e,s):s.colorizerType===uo.Lut?LL(e):s.colorizerType===uo.Hillshade&&VL(e,s),e}function LL(s){s.fragment.main.add(w`vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));`)}function NL(s,e){s.fragment.uniforms.add(new H1("u_bandCount",i=>i.symbolizer.u_bandCount),new Oa("u_minCutOff",i=>i.symbolizer.u_minCutOff,3),new Oa("u_maxCutOff",i=>i.symbolizer.u_maxCutOff,3),new Oa("u_factor",i=>i.symbolizer.u_factor,3),new Ze("u_minOutput",i=>i.symbolizer.u_minOutput),new Ze("u_maxOutput",i=>i.symbolizer.u_maxOutput),new Sc("u_useGamma",i=>i.symbolizer.u_useGamma),new Oa("u_gamma",i=>i.symbolizer.u_gamma,3),new Oa("u_gammaCorrection",i=>i.symbolizer.u_gammaCorrection,3),new Ze("u_opacity",i=>i.common.u_opacity)),s.fragment.code.add(w`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const t=e.applyColormap?w`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:w`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;s.fragment.main.add(w`
    vec2 pixelLocation = getPixelLocation(uv);
    if (isOutside(pixelLocation)) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }

    vec4 currentPixel = getPixel(pixelLocation);
    ${e.stretchType===bo.Noop?w`fragColor = applyBackgroundBlend(currentPixel);`:w`
    if (currentPixel.a == 0.0) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }
    if (u_bandCount == 1) {
      float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      ${t}
    } else {
      float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
      float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
      fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
    }`}`)}function VL(s,e){const t=s.fragment;t.uniforms.add(new ft("u_image",r=>r.u_image),new H1("u_hillshadeType",r=>r.symbolizer.u_hillshadeType),new Oa("u_sinZcosAs",r=>r.symbolizer.u_sinZcosAs,6),new Oa("u_sinZsinAs",r=>r.symbolizer.u_sinZsinAs,6),new Oa("u_cosZs",r=>r.symbolizer.u_cosZs,6),new Oa("u_weights",r=>r.symbolizer.u_weights,6),new ra("u_factor",r=>r.symbolizer.u_factor),new Ze("u_minValue",r=>r.symbolizer.u_minValue),new Ze("u_maxValue",r=>r.symbolizer.u_maxValue),new ra("u_srcImageSize",r=>r.common.u_srcImageSize)),t.include(R1),t.code.add(w`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),t.code.add(w`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=e.applyColormap?w`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:w`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;t.main.add(w`
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}`)}const FL=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:Wx,ColorizerStretchUniforms:jx,ColorizerUniforms:Ap,build:Qx},Symbol.toStringTag,{value:"Module"}));let $0=class extends Bt{constructor(e,t){super(e,t,new qt(FL,()=>X(()=>Promise.resolve().then(()=>q4),void 0,import.meta.url)))}},Dh=class extends Xh{constructor(){super(...arguments),this.colorizerType=uo.Stretch,this.stretchType=bo.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}};c([ne({count:uo.COUNT})],Dh.prototype,"colorizerType",void 0),c([ne({count:bo.COUNT})],Dh.prototype,"stretchType",void 0),c([ne()],Dh.prototype,"applyColormap",void 0),c([ne()],Dh.prototype,"requireBilinearWithNN",void 0);let I0=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const i=new $c(this._rctx,new mi(e),new F1(L1.DEPTH24_STENCIL8,e));return this._fbos.set(e,i),i}};function Sn(s,e=na.Pos2,t=Bl,i=-1,r=1){const a=e===na.Pos2?new Float32Array([i,i,r,i,i,r,r,r]):new Float32Array([i,i,0,0,r,i,1,0,i,r,0,1,r,r,1,1]);return new Tn(s,t,new Map([["geometry",HL.get(e)]]),new Map([["geometry",$s.createVertex(s,wr.STATIC_DRAW,a)]]))}const UL=4;function Yx(s){const e=new mi(UL);return e.samplingMode=Ds.NEAREST,new oi(s,e)}var na;(function(s){s[s.Pos2=0]="Pos2",s[s.Pos2Tex=1]="Pos2Tex"})(na||(na={}));const HL=new Map([[na.Pos2,y1],[na.Pos2Tex,oP]]),zL=()=>pe.getLogger("esri.views.3d.terrain");let GL=class{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new ML,this._bindParameters=new v1(null),this._blendLayersTechniqueConfig=new kx,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=Sn(this._rctx,na.Pos2Tex)}dispose(){this._fbos.forEach(We),this._fbos=null,this._vtFBO=We(this._vtFBO),this._vaoQuad=We(this._vaoQuad),this._vectorTileHelper=We(this._vectorTileHelper)}updateHeading(e){var t;(t=this._vectorTileHelper)==null||t.updateHeading(e)}_acquireBlendLayersTechnique(e,t,i,r=ks.Off,a=Na.BelowLayer){return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=i,this._blendLayersTechniqueConfig.premultipliedSource=r,this._blendLayersTechniqueConfig.background=a,this._techniques.precompile(D0,this._blendLayersTechniqueConfig),this._techniques.get(D0,this._blendLayersTechniqueConfig)}drawBackground(e,t){const i=this._acquireBlendLayersTechnique(G.Normal,t?jt.ColorComposite:jt.GridComposite,Fi.NotRequired,ks.Off,Na.Only),r=this._rctx.bindTechnique(i,this._bindParameters,e);this._render(r)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(bi.TRIANGLE_STRIP,0,$l(this._vaoQuad,"geometry"))}drawGroup(e,t,i,r,a=ks.On){t===jt.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const n=e.baseOpacity<1?Fi.Required:Fi.NotRequired,o=this._acquireBlendLayersTechnique(r,t,n,a),l=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(l)}drawImageData(e,t,i,r,a=ks.Off){if(e.texture==null)return;const n=e.baseOpacity<1?Fi.Required:Fi.NotRequired;e.fboTexture=t===jt.GroupBackgroundComposite||r===G.Normal&&n===Fi.NotRequired&&a===ks.Off?null:this.switch(i).colorTexture;const o=this._acquireBlendLayersTechnique(r,t,n,a),l=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(l)}drawRasterData(e,t,i,r,a){const n=a.sourceLayerInfo.data;if(!n.source||(a.tile.surface.layerViewByIndex(a.layerIndex,fe.MAP).ensureSymbolizerParameters(n),!n.bind(this._rctx)))return;const o=e.baseOpacity<1?Fi.Required:Fi.NotRequired;e.fboTexture=r===G.Normal&&o===Fi.NotRequired?null:this.switch(i).colorTexture;const l=this._acquireRasterColorizerTechnique(n,t,r,o);n.opacity=e.opacity;const h=n.getUniforms();h.scale=a.scale,h.offset=a.offset,h.backgroundColor=e.backgroundColor,h.fboTexture=e.fboTexture,h.baseOpacity=e.baseOpacity;const u=this._rctx.bindTechnique(l,this._bindParameters,h);this._render(u)}_acquireRasterColorizerTechnique(e,t,i,r){const a=e.symbolizerParameters,n=["stretch","lut","hillshade"].indexOf(a.type);return this._rasterColorizerConfig==null&&(this._rasterColorizerConfig=new Dh,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=i,this._rasterColorizerConfig.baseOpacityMode=r,this._rasterColorizerConfig.colorizerType=n,this._rasterColorizerConfig.applyColormap=!!a.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?bo.Noop:bo.PerBand,this._techniques.precompile($0,this._rasterColorizerConfig),this._techniques.get($0,this._rasterColorizerConfig)}drawVectorData(e,t,i,r,a,n,o,l){const h=this._rctx,u=a.sourceLayerInfo.data,d=a.tile.surface.layerViewByIndex(a.layerIndex,fe.MAP),p=e.baseOpacity<1?Fi.Required:Fi.NotRequired,_=p===Fi.Required||e.opacity<1||r!==G.Normal||t!==jt.Composite,f=_?ks.On:ks.Off,g=this._acquireBlendLayersTechnique(r,t,p,f);h.setPipelineState(g.getPipeline());let y=null,b=null;_?(b=this.currentFBO(i),this._vtFBO==null&&(this._vtFBO=new I0(this._rctx)),y=this._vtFBO.get(i),h.bindFramebuffer(y),this._clearCurrentFBO()):l&&h.clear(Jt.DEPTH);try{this._vectorTileHelper.renderBackground(h,a.sourceLod,d.painter,d.layer.styleRepository,d.schemaHelper,Math.round(1/a.scale),a.offset,o,n,d.contentZoom),u&&this._vectorTileHelper.renderContent(h,a.sourceLod,u,a.vtlNeighborInfos,d.painter,d.layer.styleRepository,d.schemaHelper,Math.round(1/a.scale),a.offset,o,n,d.contentZoom)}catch(x){zL().warnOnce("A render call containing vector tiles did not resolve correctly.",x)}return!y||(h.bindFramebuffer(b),e.texture=y.colorTexture,e.offset=uc,e.scale=1,this.drawImageData(e,t,i,r,f),l)}copyFBOToTexture(e){const t=this._rctx,i=t.bindTexture(e.texture,oi.TEXTURE_UNIT_FOR_UPDATES),r=e.descriptor;t.gl.copyTexImage2D(v_.TEXTURE_2D,0,r.pixelFormat,0,0,r.width,r.height,0),e.generateMipmap(),t.bindTexture(i,oi.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(Jt.COLOR|Jt.DEPTH|Jt.STENCIL)}_initFBO(e,t,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,i=!0){if(this._current=t,t>=this._fbos.length)for(let r=this._fbos.length;r<=t;r++)this._fbos.push(new I0(this._rctx));this._initFBO(this._fbos[t].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},BL=class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new mt({allocator:e=>e||new qL})}},qL=class{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}},L0=class{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&(this._cache?(this._texture.isCompressing&&this._texture.abortCompression(),this._cache.put(this._generateCacheKey(),this)):this.dispose())}dispose(){this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}_generateCacheKey(){return`${this._texture.descriptor.width} ${this._texture.descriptor.pixelFormat}`+(tE(this._texture)?"compressed":"")}get descriptor(){return this._texture.descriptor}get cachedMemory(){return this._texture.usedMemory}};function Zx(s){return s instanceof HTMLImageElement||s instanceof HTMLCanvasElement}let kL=class extends p2{constructor(e){super("TextureCompressionWorker","compress",{compress:t=>[t.data]},e)}isCompressible(e){return Zx(e)}},jL=class{constructor(e,t,i,r,a,n){this.start=e,this.end=t,this.blendMode=i,this.opacity=r,this.output=a,this.baseOpacity=n}},Ka=class extends Re{constructor(e){super(e),this._passParameters=new PL,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1}initialize(){this._maxAnisotropy=this.rctx.parameters.maxMaxAnisotropy,this._compositor=new GL(this.rctx,this.techniques),this._ensureBackgroundTexture(this.tileSize),this.texturesBeingCompressed=0}dispose(){this._compositor=We(this._compositor),this._backgroundTexture=ui(this._backgroundTexture)}get backgroundIsGrid(){return this._backgroundColor==null}get backgroundColor(){return this._backgroundColor}updateHeading(e){var t;(t=this._compositor)==null||t.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const i=e.surface,r=i.baseOpacity;let a=0,n=0,o=this.tileSize,l=!1,h=!1;const u=i.view.state.contentPixelRatio;let d=!1;cp.clear(),ko.length=0;const p=e.layerInfo[fe.MAP];let _=0,f=null;for(;_<p.length;_++){const b=i.layerViewByIndex(_,fe.MAP),x=b.layer,C=!co(e,b),T=x.opacity,P=b.fullOpacity;if(h=h||ku(x),ic(b)){let M=b.layer.blendMode!=="normal";if(Ml(x.parent)){const $=x.parent.uid;$!=null&&$!==""&&(M=Xx(x.parent)||M)}M&&(d=M,l=!1)}if((C||T===0)&&!d){p[_].pendingUpdates&=~(te.TEXTURE_NOFADING&te.TEXTURE_FADING);continue}++n;const S=Vd(b),E=Vm(e,_,S);if(E){if(p[_].pendingUpdates&=~(te.TEXTURE_NOFADING&te.TEXTURE_FADING),Ml(x.parent)){const M=x.parent.uid;M!=null&&M!==""&&Kx(x.parent,_)}S?o=Math.max(o,this.tileSize*u):r===1&&P===1&&(b.isOpaque||this._dataToTexture(E)&&E.sourceLayerInfo.data.descriptor.isOpaque)&&(l=!0),++a,f===null&&(f=_)}}const g=o/this.tileSize,y=this._ensureBackgroundTexture(this.tileSize);a!==0&&f!==null?a===1&&!d&&this._useLayerTexture(e,f)||this._composeLayers(e,t,_-1,h,o,g,!l||d,cp,d):QL(e,n,y,t!==zt.FADING)}_ensureBackgroundTexture(e){return this._backgroundTexture==null&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._compositor.bind(e),this._passParameters.offset=uc,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,this.backgroundColor!=null),this._compositor.copyFBOToTexture(this._backgroundTexture),this._compositor.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useLayerTexture(e,t){const i=e.surface.layerViewByIndex(t,fe.MAP),r=ku(i.layer),a=r?e.surface.baseOpacity:1,n=r?1:e.surface.baseOpacity,o=i.fullOpacity,l=Vm(e,t,!1);return!!this._dataToTexture(l)&&(e.renderData.setTextureReference(new hp(l.sourceLayerInfo.data,zt.FADING,Pr(l.offset[0],l.offset[1],l.scale,l.scale),a,n,o)),!0)}_composeLayers(e,t,i,r,a,n,o,l,h){this._compositor.ensureBuffer(a);const u=e.surface.baseOpacity;let d=!1,p=Ds.LINEAR_MIPMAP_LINEAR,_=!1,f=0;for(let x=i;x>=0;x--){const C=e.surface.layerViewByIndex(x,fe.MAP),T=C.layer,P=Vd(C),S=Vm(e,x,P),E=T.opacity,M=!co(e,C);if(!S||(E===0||M)&&!h)continue;const $=!ku(T)&&!d;$&&(d=!0);let B=!1;l.forEach(A=>{A.start===x&&(A.output=r?jt.Composite:o&&$?this.backgroundIsGrid?jt.GridComposite:jt.ColorComposite:jt.Composite,A.baseOpacity=$?u:1,ko.push(A),this._compositor.openGroup(a),B=!0)});const k=f===0,H=B?jt.GroupBackgroundComposite:o&&k?this.backgroundIsGrid?jt.GridComposite:jt.ColorComposite:jt.Composite,Y=Y_[ic(C)?C.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=$&&!B&&u<1?u:1,this._passParameters.opacity=E,HS(S)?_=this._compositor.drawVectorData(this._passParameters,H,a,Y,S,n,this.tileSize,_):zS(S)?(this._compositor.drawRasterData(this._passParameters,H,a,Y,S),WL(S)&&(p=Ds.NEAREST)):this._dataToTexture(S)&&(this._passParameters.texture=S.sourceLayerInfo.data.texture,this._passParameters.offset=S.offset,this._passParameters.scale=S.scale,this._compositor.drawImageData(this._passParameters,H,a,Y));ko.length>0&&ko[ko.length-1].end===x;){const A=ko.pop();this._passParameters.baseOpacity=A.baseOpacity,this._passParameters.opacity=A.opacity,this._passParameters.offset=uc,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,A.output,a,Y_[A.blendMode])}f++}const g=e.renderData,y=h||d&&u<1,b=g.ensureTexture(a,y,t,()=>this._buildTexture(a,y,p));this._compositor.copyFBOToTexture(b),this._compositor.unbind(),g.setTextureReference(new hp(b,t,Jx,d?1:u,0,1))}_dataToTexture(e){if(GS(e)){const t=e.sourceLayerInfo,i=e.scale===1;t.data=this._buildTexture(t.data,!0,i),e.tile.setMemoryDirty()}return BS(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t,i=Ds.LINEAR_MIPMAP_LINEAR){if(e==null)return null;const r=new mi;r.wrapMode=Ki.CLAMP_TO_EDGE,r.samplingMode=typeof i=="boolean"?Ds.LINEAR_MIPMAP_LINEAR:i,r.maxAnisotropy=this._maxAnisotropy,r.preMultiplyAlpha=!0,r.flipped=!0,r.hasMipmap=!0,t||(r.pixelFormat=ni.RGB);const a=this.rctx,n=typeof i=="boolean"&&i;let o;if(typeof e=="number")r.width=r.height=e,o=this._buildTileTexture(r,e);else if(Cg(e))r.isOpaque=e.isOpaque,r.isOpaque&&(r.pixelFormat=ni.RGB),o=this._buildTileTexture(r,e.element.width,n,e.element);else try{r.width=e.width,r.height=e.height,o=this._buildTileTexture(r,e.width,n,e)}catch{o=new L0(Yx(a)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const l=a.bindTexture(o.texture,oi.TEXTURE_UNIT_FOR_UPDATES);return o.generateMipmap(),a.bindTexture(l,oi.TEXTURE_UNIT_FOR_UPDATES),o}_buildTileTexture(e,t,i=!1,r){const a=`${t} ${e.pixelFormat}`,n=this.cache.pop(a)??this.cache.pop(a+"compressed");if(i&&(i=Zx(r)),n)return n.retain(),i&&n.texture.enableCompression(!0),n.texture.setData(r),n;e.shouldCompress=i;const o=new oi(this.rctx,e,r);return o.isCompressing&&(this.texturesBeingCompressed++,this.addHandles([O(()=>o.isCompressing,l=>{l?this.texturesBeingCompressed++:this.texturesBeingCompressed--},Ge)])),new L0(o,this.cache)}get test(){}};function Vm(s,e,t){var n;Vi.layerIndex=e,Vi.vtlNeighborInfos.clear();const i=s.layerInfo[fe.MAP][e];if(xo(Vi.offset,0,0),Vi.tile=s,Vi.scale=1,Vi.sourceLod=s.lij,Vi.sourceLayerInfo=i,Vi.isVTLBackground=t,i.data)return t&&s.forEachLoadedNeighbor((o,l)=>{if(o.level!==s.level)return;const h=o.layerInfo[fe.MAP][e];if(!qS(h)||i.data===h.data)return;const u=Vi.vtlNeighborInfos.pushNew();u.offset=ba[l],u.sourceLod=o.lij,u.sourceLayerInfo=h}),Vi;const r=i.upsampleInfo,a=(n=r==null?void 0:r.tile)==null?void 0:n.layerInfo[fe.MAP][e];return a&&r.tile?(Vi.tile=r.tile,_n(Vi.offset,r.offset),Vi.scale=r.scale,Vi.sourceLod=r.tile.lij,Vi.sourceLayerInfo=a,Vi):t?Vi:null}function WL(s){const e=s.sourceLayerInfo.data;return!!e.source&&e.interpolation==="nearest"}function Xx(s){let e=s.blendMode!=="normal";return Ml(s.parent)&&(e=Xx(s.parent)||e),e}function Kx(s,e){Ml(s.parent)&&Kx(s.parent,e);const t=s.uid;if(t!=null&&t!==""){const i=cp.get(t);i?i.start=e:cp.set(t,new jL(e,e,s.blendMode,s.opacity,jt.Composite,1))}}function QL(s,e,t,i){const r=s.renderData,a=!i&&r.textureReference!=null&&(s.surface.view.layerViewManager.updating||e>0)?hn.Delayed:hn.Immediate;r.setTextureReference(new hp(t,zt.FADING,Jx,s.surface.baseOpacity,0,1),a)}c([m({constructOnly:!0})],Ka.prototype,"rctx",void 0),c([m({constructOnly:!0})],Ka.prototype,"techniques",void 0),c([m({constructOnly:!0})],Ka.prototype,"cache",void 0),c([m()],Ka.prototype,"tileSize",void 0),c([m()],Ka.prototype,"texturesBeingCompressed",void 0),Ka=c([F("esri.views.3d.terrain.TileRenderer")],Ka);const cp=new Map,ko=new Array,Vi=new BL,Jx=Pr(0,0,1,1),ba=new Array;ba[dt.NORTH]=[0,-1],ba[dt.NORTH_EAST]=[-1,-1],ba[dt.EAST]=[-1,0],ba[dt.SOUTH_EAST]=[-1,1],ba[dt.SOUTH]=[0,1],ba[dt.SOUTH_WEST]=[1,1],ba[dt.WEST]=[1,0],ba[dt.NORTH_WEST]=[1,-1];const YL=200,Fm=40,ZL=.8,XL=10,Z_=1e-6;function KL(s,e,t){const i=e,r=t;let a=0,n=1/0;for(let o=0;o<3;++o){{const l=s[o];if(i[o]<l){if(r[o]<=Z_)return!1;const h=(l-i[o])/r[o];a=Math.max(a,h)}else if(r[o]<=-1e-6){const h=(l-i[o])/r[o];n=Math.min(n,h)}if(a>n)return!1}{const l=s[o+3];if(i[o]>l){if(r[o]>=-1e-6)return!1;const h=(l-i[o])/r[o];a=Math.max(a,h)}else if(r[o]>=Z_){const h=(l-i[o])/r[o];n=Math.min(n,h)}if(a>n)return!1}}return!0}let N0=class{constructor(e,t,i,r,a){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=r,this.rightStartIndex=a}},eC=class X_{constructor(e,t,i,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positions=r,this._rayDirection=v(),this._callback=F0,this._intersectionOptions=V0,this.bspNodeTree=new Array;const a=i-t,n=new(a<s3?Uint8Array:a<r3?Uint16Array:Uint32Array)(a);this.triangleIndexMap=n;for(let o=0;o<a;++o)n[o]=o;{const o=i3(e,t,i,r.data,r.stride),l=Q(Math.log2(a/Fm),2,XL),h=(u,d,p)=>{const _=e3(n,o,u,d),f=d-u;if(f<=Fm){const T=new N0(_,void 0,0,u,d);return this.bspNodeTree.push(T),T}const{axis:g,midValue:y}=t3(_),b=JL(n,o,u,d,g,y),x=(T,P)=>{if(p>l)return;const S=P-T;return S<Fm||S>=ZL*f?void 0:h(T,P,p+1)},C=new N0(_,g,y,b.next,b.mid);return this.bspNodeTree.push(C),C.leftNode=x(u,b.next),C.rightNode=x(b.mid,d),C};h(0,a,0)}}intersectRayTriangleRange(e,t){if(e>=t)return;const i=this.positions;dw(this._rayFrom,this._rayDirection,e,t,this.globalTriangleVertexIndices,i.data,i.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),X_.numFacesTested+=t-e}intersectRay(e,t,i,r){X_.numFacesTested=0;const a=e,n=t,o=n[0]-a[0],l=n[1]-a[1],h=n[2]-a[2];if(o*o+l*l+h*h<Z_)return;this._rayFrom=a;const u=this._rayDirection;u[0]=o,u[1]=l,u[2]=h;const d=this.triangleIndexMap.length;this._callback=r,this._intersectionOptions=i,this.intersectRayBSP(this.bspNodeTree[0],0,d),this._callback=F0,this._intersectionOptions=V0}intersectRayBSP(e,t,i){const r=this._rayFrom,a=this._rayDirection;if(!KL(e.aabb,r,a))return;const n=e.axis,o=e.d;if(r[n]<o||a[n]<0){const l=t,h=e.midStartIndex;if(l<h){const u=e.leftNode;u!==void 0?this.intersectRayBSP(u,l,h):this.intersectRayTriangleRange(l,h)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[n]>o||a[n]>0){const l=e.rightStartIndex,h=i;if(l<h){const u=e.rightNode;u!==void 0?this.intersectRayBSP(u,l,h):this.intersectRayTriangleRange(l,h)}}}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}};eC.numFacesTested=0;const jo=[1/0,1/0,1/0],Wo=[-1/0,-1/0,-1/0];function JL(s,e,t,i,r,a){let n=t,o=i;for(;n<o;){const h=s[n];e[6*h+r+3]<=a?++n:(--o,s[n]=s[o],s[o]=h)}let l=n;for(o=i;l<o;){const h=s[o-1];e[6*h+r]>=a?--o:(s[o-1]=s[l],s[l]=h,++l)}return{next:n,mid:l}}function e3(s,e,t,i){if(i<=t)return Dy(NaN,NaN,NaN,NaN,NaN,NaN);{const r=6*s[t];for(let a=0;a<3;++a)jo[a]=e[r+0+a],Wo[a]=e[r+3+a]}for(let r=t+1;r<i;++r){const a=6*s[r];for(let n=0;n<3;++n)jo[n]=Math.min(jo[n],e[a+0+n]),Wo[n]=Math.max(Wo[n],e[a+3+n])}return Dy(jo[0],jo[1],jo[2],Wo[0],Wo[1],Wo[2])}function t3(s){const e=s[3]-s[0],t=s[4]-s[1],i=s[5]-s[2],r=e>t?e>i?0:t>i?1:2:t>i?1:i>e?2:0;return{axis:r,midValue:(s[r]+s[r+3])/2}}function i3(s,e,t,i,r){const a=t-e,n=new Float32Array(6*a);for(let o=0;o<a;++o){const l=3*(o+e),h=s[l]*r,u=s[l+1]*r,d=s[l+2]*r;for(let p=0;p<3;++p){const _=i[h+p],f=i[u+p],g=i[d+p];n[6*o+p]=Math.min(_,f,g),n[6*o+3+p]=Math.max(_,f,g)}}return n}const s3=255,r3=65535,V0=new kg,F0=()=>{};let ji=class extends A1{constructor(e){super(),this.spherical=e,this.overlayMode=Ud.Disabled,this.tileBlendInput=Qr.LayerOnly,this.transparencyMode=Di.Opaque,this.pbrMode=Wt.Simplified,this.doublePrecisionRequiresObfuscation=!1,this.receiveShadows=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.normalType=Ra.Compressed,this.textureCoordinateType=pc.Compressed,this.highStepCount=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!0,this.canHaveOverlay=!0}};c([ne({count:Ud.COUNT})],ji.prototype,"overlayMode",void 0),c([ne({count:Qr.COUNT})],ji.prototype,"tileBlendInput",void 0),c([ne({count:Di.COUNT})],ji.prototype,"transparencyMode",void 0),c([ne({count:Wt.COUNT})],ji.prototype,"pbrMode",void 0),c([ne()],ji.prototype,"doublePrecisionRequiresObfuscation",void 0),c([ne()],ji.prototype,"receiveShadows",void 0),c([ne()],ji.prototype,"backfaceCullingEnabled",void 0),c([ne()],ji.prototype,"textureFadingEnabled",void 0),c([ne()],ji.prototype,"renderOccluded",void 0),c([ne()],ji.prototype,"screenSpaceReflections",void 0),c([ne()],ji.prototype,"cloudReflections",void 0),c([ne()],ji.prototype,"tileBorders",void 0),c([ne()],ji.prototype,"visualizeNormals",void 0),c([ne()],ji.prototype,"screenSizePerspective",void 0),c([ne()],ji.prototype,"receiveAmbientOcclusion",void 0);const Um=7,a3=10,Hm=Ic();let Es=class extends Cp{get _isGlobal(){return this._stage.viewingMode===Ne.Global}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(s,e,t,i,r){super({}),this._overlayRenderer=s,this._stage=e,this._allTiles=t,this._ellipsoidRadius=i,this.type=Ur.TERRAIN,this.isGround=!0,this._passParameters=new mf,this._drawParameters=new cw,this._renderDataPool=new mo(AI),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new vx,this._castShadows=!1,this._inViewshed=!1,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=Pi.Occlude,this.produces=new Map([[j.OPAQUE_TERRAIN,()=>this._produces()&&this.transparency===Di.Opaque],[j.TRANSPARENT_TERRAIN,()=>this._produces()&&(this.transparency===Di.Transparent||this.transparency===Di.InvisibleWithDraped)],[j.OCCLUDED_TERRAIN,()=>this._produces()]]),this._tileSize=256,this._configuration=new ji(e.viewingMode===Ne.Global),this._tileTextureCache=new Uc((a,n)=>r.newCache(a,n),"TileTexture"),this.tileGeometryCache=new wL(r)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(O(()=>this._overlayRenderer.rendersOccludedDraped,s=>{this.renderOccludedFlags=s?yy:Pi.Occlude,this.setNeedsRender()},Ge))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?lE:hE}set renderingDisabled(s){this._set("renderingDisabled",!!s),this.setDirty()}set visible(s){this._set("visible",!!s),this.setDirty()}updateHeading(s){var e;(e=this._tileRenderer)==null||e.updateHeading(s)}set transparency(s){this._configuration.transparencyMode!==s&&(this._configuration.transparencyMode=s,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get tileRenderer(){return this._tileRenderer}get texturesBeingCompressed(){var s;return this._tileRenderer?(s=this._tileRenderer)==null?void 0:s.texturesBeingCompressed:null}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(s){this._configuration.tileBorders!==s&&(this._configuration.tileBorders=s,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(s){this._configuration.visualizeNormals!==s&&(this._configuration.visualizeNormals=s,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(s){this._configuration.backfaceCullingEnabled!==s&&(this._configuration.backfaceCullingEnabled=s,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(s){this._set("renderOrder",s),this._setSortingDirty()}get layerUid(){return _c}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(s){this._configuration.hasSlicePlane!==s&&(this._configuration.hasSlicePlane=s,this.setNeedsRender())}set textureFadingEnabled(s){this._configuration.textureFadingEnabled!==s&&(this._configuration.textureFadingEnabled=s,this.setNeedsRender())}set pbrMode(s){this._configuration.pbrMode!==s&&(this._configuration.pbrMode=s,this.setNeedsRender())}setDebugScreenSizePerspective(s){this._configuration.screenSizePerspective!==s&&(this._configuration.screenSizePerspective=s,this.setNeedsRender())}setRootTiles(s){this._rootTiles=s,this.setDirty()}setStencilEnabledLayerExtents(s){this._stencilEnabledLayerExtents=s,this._setSortingDirty()}set tileSize(s){this._tileSize=s,this._tileRenderer!=null&&(this._tileRenderer.tileSize=s),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(s){s.renderData||(s.renderData=this._renderDataPool.acquire(),s.renderData.init(s,this._getLocalOriginOfTile(s)))}loadTile(s){this._ensureRenderData(s),this.updateTileGeometryState(s),this.reuseTextureFromParent(s)||this.updateTileTexture(s,te.TEXTURE_FADING)}reuseTextureFromParent(s){var i;const e=s.parent;if(!e)return!1;const t=Pr(1&s.lij[2]?.5:0,1&s.lij[1]?0:.5,.5,.5);return((i=e.renderData)==null?void 0:i.reuseTexture(s.renderData,t))??!1}updateTileTexture(s,e){this._tileRenderer!=null&&(this._tileRenderer.updateTileTexture(s,e===te.TEXTURE_FADING?zt.FADING:zt.UNFADED),this.setNeedsRender(),s.resetPendingUpdate(e))}updateTileGeometryState(s){for(const t of s.layerInfo[fe.ELEVATION])t.pendingUpdates&=~te.GEOMETRY;s.resetPendingUpdate(te.GEOMETRY);const e=s.renderData.updateGeometryState();return e&&this.setDirty(),e}updateGeometryIfNeeded(s){s.loaded&&s.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(s){const e=s.renderData;e&&(e.releaseGeometry(),this._renderDataPool.release(e),e.clear(),s.renderData=null,s.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(s){const e=a3-Um,t=Math.max(0,Math.floor((s.level-e)/Um)*Um);if(this._isGlobal&&t===0)return vr;for(;s.parent&&s.level>t;)s=s.parent;return s.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(s){this._get("wireframe")!==s&&(this._set("wireframe",s),this.setNeedsRender())}setDirty(s=Ce.UPDATE){this._patchesByOriginDirty=!0,this._context.requestRender(s)}_setSortingDirty(s=Ce.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(s)}setNeedsRender(s=Ce.UPDATE){this._context.requestRender(s)}initializeRenderContext(s){this._context=s,this._tileRenderer=new Ka({rctx:this._rctx,tileSize:this._tileSize,techniques:this._techniques,cache:this._tileTextureCache}),this.updateTileBackground(),this._emptyTex=Yx(this._rctx)}uninitializeRenderContext(){this._emptyTex=We(this._emptyTex),this._tileRenderer=We(this._tileRenderer)}intersect(s,e,t,i){if(!this._rootTiles||s.options.selectOpaqueTerrainOnly&&s.options.selectionMode&&this.transparency!==Di.Opaque)return;const r=n3,a=o3;ye(r,i,t),ce(a,1/r[0],1/r[1],1/r[2]);const n=s.results.min,o=s.results.max,l=s.results.ground,h=s.options.store===Xr.MIN,u=!!s.results.ground.target,d=WE(s.verticalOffset),p=s.tolerance;let _,f=h&&n.dist!=null?n.dist:1/0;const g=s.options,y=g.normalRequired||!g.backfacesTerrain,b=new kg(!1,y),x=T=>{const P=T.renderData;if(!(P!=null&&P.vao))return;const S=P.geometry;oO(Hm,S.boundingBox);const E=P.localOrigin;d!=null&&(d.localOrigin=E,d.applyToAabb(Hm));const M=Hm;if(Qo[0]=t[0]-E[0],Qo[1]=t[1]-E[1],Qo[2]=t[2]-E[2],!uw(M,Qo,a,p,f))return;const $=(I,de,ae)=>{I.set(this.type,T,de,ae,Gh),f=h&&n.dist!=null?n.dist:1/0},B=(I,de,ae)=>{if((!y||ae!=null)&&I>=0&&(g.backfacesTerrain||oe(ae,r)<0)&&(g.invisibleTerrain||!g.selectionMode||e==null||e(t,i,I))){if((l.dist==null||I<l.dist)&&$(l,I,ae),g.isFiltered)return;g.store===Xr.ALL&&(_==null?(_=k1(s.ray),$(_,I,ae),s.results.all.push(_)):I<_.dist&&$(_,I,ae)),(n.dist==null||I<n.dist)&&$(n,I,ae),g.store!==Xr.MIN&&(o.dist==null||I>o.dist)&&$(o,I,ae)}},k=l3;ye(k,i,E);const{indices:H,indexCount:Y}=S,A=S.vertexAttributes,R=A.getField(De.POSITION,t2),W=new m2(R.typedBuffer,3,A.stride/4),U=Y/3;if(!d&&U>YL){const I=T.renderData;I.intersectionData==null&&(I.intersectionData=new eC(H,0,U,W)),I.intersectionData.intersectRay(Qo,k,b,B)}else XO(Qo,k,0,U,H,W,d,b,B)},C=this._rootTiles;C!=null&&(()=>{const T=this._tileIterator;T.reset(C);const P=s.options.invisibleTerrain;for(let S=T.next();S;S=T.next())!(S.visible||P&&S.intersectsClippingArea)||d==null&&!S.intersectsRay(t,r,p,f)||u&&this._useStencilForTile(S)?T.skipSubtree():x(S)})()}processScaleRangeQueries(s,e){var t;if(!e.done)for(this._updatePatchGroups();s.updating&&!e.done;){s.prepare();for(const i of this._visiblePatchesByOrigin.values())for(const r of i)((t=r.renderData)==null?void 0:t.textureReference)!=null&&s.queriesForTile(r);s.process(),e.madeProgress()}}acquireTechniques(s){const e=!!Gi("enable-feature:terrain-shadows")&&s.bind.shadowMap.enabled;e!==this._castShadows&&(this._castShadows=e,this._patchesByOriginDirty=!0);const t=s.bind.viewshedEnabled;if(this._inViewshed!==t&&(this._inViewshed=t,this._patchesByOriginDirty=!0),s.bind.slot===j.OCCLUDED_TERRAIN){if(!(s.renderOccludedMask&yy))return null}else{const i=this.transparency===Di.Opaque?j.OPAQUE_TERRAIN:j.TRANSPARENT_TERRAIN;if(s.bind.slot!==i)return null}if(this.transparency===Di.Invisible)return null;switch(this._configuration.screenSpaceReflections=this._configuration.cloudReflections=this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=!1,this._configuration.overlayMode=this._overlayRenderer.mode,s.output){case D.Color:case D.ColorEmission:return this._configuration.screenSpaceReflections=s.bind.ssr.lastFrameColor!=null,this._configuration.cloudReflections=s.bind.clouds.data!=null,this._configuration.receiveShadows=s.bind.shadowMap.ready,this._configuration.receiveAmbientOcclusion=s.bind.ssao!=null,this._acquireTechnique(s.output,s.bind.slot===j.OCCLUDED_TERRAIN);case D.Shadow:case D.ShadowExcludeHighlight:return this._castShadows?this._acquireTechnique(D.Shadow,!1):null;case D.ViewshedShadow:return this._inViewshed?this._acquireTechnique(D.ViewshedShadow,!1):null;case D.Depth:case D.Normal:return this._acquireTechnique(s.output,!1);case D.ObjectAndLayerIdColor:return this._acquireTechnique(D.ObjectAndLayerIdColor,!1);case D.Highlight:return this._overlayRenderer.hasHighlights?this._acquireTechnique(D.Highlight,!1):null}return null}render(s,e){var t;switch(this._updatePatchGroups(),e.useStencil=!1,s.output){case D.Color:case D.ColorEmission:{const i=s.bind.slot===j.OCCLUDED_TERRAIN?Bs.Occluded:Bs.Color;this._renderMaterialPass(s,e,i);break}case D.Depth:case D.Normal:this._renderAuxiliaryPass(s,e,Bs.Color,this._visiblePatchesByOrigin);break;case D.Highlight:{const i=(t=s.bind.highlight)==null?void 0:t.name;i&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(Bs.Highlight)&&this._overlayRenderer.hasHighlightOptions(i)&&this._renderAuxiliaryPass(s,e,Bs.Highlight,this._visiblePatchesByOrigin);break}case D.Shadow:case D.ShadowExcludeHighlight:case D.ViewshedShadow:this._renderAuxiliaryPass(s,e,null,this._allPatchesByOrigin);break;case D.ObjectAndLayerIdColor:this._renderAuxiliaryPass(s,e,Bs.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(s){if(this._tileRenderer==null)return;const e=this._tileRenderer;let t;if(s!=null){const i=Vg.toUnitRGBA(s);t=Vt(i[0]||0,i[1]||0,i[2]||0)}e.setBackground(t),this._allTiles.forAll(i=>e.updateTileTexture(i,zt.FADING)),this._configuration.tileBlendInput=e.backgroundIsGrid?Qr.GridComposite:e.backgroundColor!=null?Qr.ColorComposite:Qr.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==Fl.NONE){const s=Array.from(this._visiblePatchesByOrigin.values()),e=this._stencilEnabledLayerExtents;for(const t of s)gI(this.renderOrder,t,e);s.sort((t,i)=>bx(t[0],i[0],this.renderOrder)),this._visiblePatchesByOrigin=new Map(s.map(t=>[t[0].renderData.localOrigin,t])),this._patchSortingDirty=!1}}_rebuildPatchGroups(){var e;const s=this._rootTiles;if(s!=null){(e=s[0])==null||e.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of s)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(s){const e=this._tileIterator;for(e.resetOne(s);!e.done;){const t=e.next(),i=t.renderData;if(!i){this._numTilesCulled++;continue}const r=i.localOrigin;if(this._castShadows||this._inViewshed){let n=this._allPatchesByOrigin.get(r);n||(n=[],this._allPatchesByOrigin.set(r,n)),n.push(t)}if(!t.visible){this._numTilesCulled++,e.skipSubtree();continue}let a=this._visiblePatchesByOrigin.get(r);a||(a=[],this._visiblePatchesByOrigin.set(r,a)),a.push(t),e.skipSubtree()}}_useStencilForTile(s){for(const e of this._stencilEnabledLayerExtents)if(s.intersectsExtent(e))return!0;return!1}_renderAuxiliaryPass(s,e,t,i){const r=s.rctx;this._passParameters.overlayContent=t,r.bindTechnique(e,s.bind,this._passParameters);const a=this._stencilEnabledLayerExtents.length>0;i.forEach(n=>{this._drawParameters.origin=n[0].renderData.localOrigin,e.program.bindDraw(s.bind,this._passParameters,this._drawParameters);for(let o=0;o<n.length;o++)this._renderPatch(s,e,n[o],bi.TRIANGLES,a,t)}),s.rctx.bindVAO(null)}_renderMaterialPass(s,e,t){var d;const{rctx:i}=s;this._passParameters.overlayContent=t,i.bindTechnique(e,s.bind,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const r=s.bind.camera,a=e.program;if(this._configuration.screenSizePerspective&&this.pointsOfInterest){const p=lw(this._stage.viewingMode,this._ellipsoidRadius),_=this.pointsOfInterest.centerOnSurfaceFrequent.distance;p.update({distance:_,fovY:r.fovY})}const n=this._stencilEnabledLayerExtents.length>0,o=t===Bs.Occluded;o&&(a.bindTexture("tex",this._emptyTex),a.setUniform3fv("textureOpacities",vr),a.setUniform4fv("texOffsetAndScale",ur));const l=((d=this._tileRenderer)==null?void 0:d.backgroundColor)!=null?this._tileRenderer.backgroundColor:vr;this._configuration.tileBlendInput===Qr.ColorComposite&&a.setUniform3fv("backgroundColor",l);const h=this.wireframe?bi.LINES:bi.TRIANGLES;this._configuration.textureFadingEnabled&&a.bindTexture("texNext",this._emptyTex);const u=this._visiblePatchesByOrigin;for(const p of u.values()){const _=p[0].renderData.localOrigin;this._drawParameters.origin=_,e.program.bindDraw(s.bind,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(const f of p){const g=f.renderData,y=g.textureReference;if(y!=null){if(!o){a.setUniform4fv("texOffsetAndScale",y.offsetAndScale),a.bindTexture("tex",y.texture.texture);const b=g.textureFadeFactor,x=b<1?g.nextTextureReference:null;this._configuration.textureFadingEnabled&&x!=null&&b<1?(a.setUniform1f("fadeFactor",b),a.setUniform4fv("nextTexOffsetAndScale",x.offsetAndScale),a.setUniform3fv("nextTexOpacities",x.opacities),a.bindTexture("texNext",x.texture.texture)):a.setUniform1f("fadeFactor",1),g.textureIsFading&&this.setNeedsRender(),a.setUniform3fv("textureOpacities",y.opacities)}this._renderPatch(s,e,f,h,n,t),f.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}s.rctx.bindVAO(null)}_renderPatch(s,e,t,i,r,a){const n=t.renderData,o=n.vao,l=o==null?void 0:o.indexBuffer;if(!o||l==null)return void(zi&&console.error("Rendered tile with no indices: ",t.lij," : ",n));const h=e.program;a==null||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,n.overlay),r&&(e.useStencil=this._useStencilForTile(t),s.rctx.setPipelineState(e.getPipeline()));const u=n.geometry.indexCount;s.rctx.bindVAO(o),h.assertCompatibleVertexAttributeLocations(o),s.rctx.drawElements(i,u,l.indexType,0)}_bindOverlayPatchData(s,e){s.setUniform4fv("overlayTexOffset",e.offsets),s.setUniform4fv("overlayTexScale",e.scales)}_acquireTechnique(s,e){return this._configuration.output=s,this._configuration.renderOccluded=e,this._techniques.get(RI,this._configuration)}get test(){}hasHighlightOptions(s){return this._overlayRenderer.hasHighlightOptions(s)}};c([m({readOnly:!0})],Es.prototype,"_isGlobal",null),c([m()],Es.prototype,"renderOccludedFlags",void 0),c([m({value:!1})],Es.prototype,"renderingDisabled",null),c([m({value:!0})],Es.prototype,"visible",null),c([m()],Es.prototype,"texturesBeingCompressed",null),c([m()],Es.prototype,"renderPatchBorders",null),c([m()],Es.prototype,"visualizeNormals",null),c([m()],Es.prototype,"cullBackFaces",null),c([m({value:Fl.FRONT_TO_BACK})],Es.prototype,"renderOrder",null),c([m()],Es.prototype,"wireframe",null),Es=c([F("esri.views.3d.terrain.TerrainRenderer")],Es);const n3=v(),o3=v(),Qo=v(),l3=v();let h3=class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}},Fr=class extends Re{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",()=>this._update()),O(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!zh(t)||t.isRejected())&&!(t.isFulfilled()&&!c3(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!((t==null?void 0:t.type)==="vector-tile"||_1(t)))),e)if(e.isResolved()){const t=fp(e,this.viewSpatialReference,this.viewingMode);if(t!=null){const i=new Io(t.tileInfo);this._lockTilingScheme(i)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===Ne.Global){const t=e.levels.length-1,i=e.spatialReference;i.isWebMercator?e=Io.makeWebMercatorAuxiliarySphere(t):kS(i)&&(e=Io.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles(O(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Ne.Global){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=Io.WebMercatorAuxiliarySphere:jS(e)&&(this.tilingScheme=Io.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;e==null||no(e,this.extent)||(this.tilingScheme=Io.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}};function c3(s,e,t){return fp(s,e,t)!=null}c([m()],Fr.prototype,"tilingScheme",void 0),c([m({readOnly:!0})],Fr.prototype,"extent",void 0),c([m({value:!1})],Fr.prototype,"tilingSchemeLocked",void 0),c([m({constructOnly:!0})],Fr.prototype,"viewSpatialReference",void 0),c([m({constructOnly:!0})],Fr.prototype,"layers",void 0),c([m({constructOnly:!0})],Fr.prototype,"extentHelper",void 0),c([m({constructOnly:!0})],Fr.prototype,"viewingMode",void 0),Fr=c([F("esri.views.3d.terrain.TilingSchemeLogic")],Fr);let u3=class{constructor(){this._offset=Ts(),this.scale=0}get offset(){return this._offset}init(e,t,i,r){this.tile=e,this._offset[0]=t,this._offset[1]=i,this.scale=r}dispose(){this.tile=null,this._offset[0]=0,this._offset[1]=0,this.scale=0}};var vd;let xe=vd=class extends Va.EventedMixin(Re){get allTiles(){return this._allTiles}constructor(s){var e,t,i;super(s),this._scaleRangeQueries=new yd,this._iteratorPool=new mo(vx,r=>r.remove=()=>this._iteratorPool.release(r)),this._postorderIterator=new pI,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new h3,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=v(),this._eyePosSurfaceSR=v(),this._splitLimits=new hr,this._frustum=$y(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new ow,this._frameTask=qd,this._allTiles=new mt,this._upsampleInfoPool=new mo(u3),this._shouldEmitChangeEvent=!1,this._destroying=!1,this._rootTilesExtent=pi(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=si.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new _l(1/0,-1/0),this.rootTileElevationBounds=new _l(1/0,-1/0),this._projectorCache=new Map,this._radiusModifier=Math.cos(Math.PI/16/16),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this.overlayManager=new ts({...s,surface:this}),this._isGlobal=!((t=(e=s.view)==null?void 0:e.state)!=null&&t.isLocal),this._isGeographic=((i=this._spatialReference)==null?void 0:i.isGeographic)??!1,this._tileConstructor=this._isGlobal?yL:_L,this._ellipsoid=Dt(s.view.spatialReference)}initialize(){const s=this.view,e=s.resourceController,t=e.memoryController;this._tileCache=new Uc((l,h)=>t.newCache(l,h),"terrain-tile"),this._upsampleMapCache=t.newCache("terrain-upsample",l=>l.unloadMapData()),this._elevationQueryCache=new IO(t.newCache("elevation-query"));const i=this.overlayManager;this._renderer=new Es(i.renderer,s._stage,this._allTiles,this._ellipsoid.radius,t),this.addHandles([O(()=>i.renderer.isEmpty,()=>this._evaluateTransparency()),O(()=>this.renderer.visible,l=>this.suspended=!l),O(()=>this.heading,l=>{this._renderer.updateHeading(l),this._updateTileTextures(zt.FADING)}),O(()=>{var l,h;return{heading:(l=s.camera)==null?void 0:l.heading,state:(h=s.state)==null?void 0:h.mode}},({heading:l,state:h})=>{if(l==null)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(l/90)%360);const u=Math.round(l)%360,d=Math.abs(u-this.heading);(h===Oi.IDLE||Math.min(d,360-d)>=30)&&(this.heading=u)})],"overlayManager"),this.addHandles([O(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?zt.UNFADED:zt.IMMEDIATE)},Be),O(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?zt.UNFADED:zt.IMMEDIATE),Be),O(()=>this.backgroundColor,(l,h)=>{l!=null&&l.equals(h)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(l))},Ge),O(()=>this.snapLevel,()=>this._viewChanged=!0,Ge),O(()=>this.view.pointsOfInterest,l=>{this._renderer.pointsOfInterest=l,this._watchUpdatingTracking.removeAll(),l&&this._watchUpdatingTracking.add(()=>l.focus.renderLocation,()=>this._allTilesSorted=!1)}),O(()=>xs.TERRAIN_TILE_TREE_SHOW_TILES,l=>{l&&!this._treeDebugger?X(()=>import("./TerrainTileTree3DDebugger-bKp97IUI.js"),__vite__mapDeps([568,1,17,18,5,12,10,11,7,8,3,4,9,13,569,23,24,26,27,28,29,30,31,32,33,34,35,36,37,38,6,39]),import.meta.url).then(({TerrainTileTree3DDebugger:h})=>{!this._treeDebugger&&xs.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new h({view:s}))}):l||(this._treeDebugger=se(this._treeDebugger))},at)]),this.addHandles([O(()=>{var l;return(l=this._renderer.tileRenderer)==null?void 0:l.texturesBeingCompressed},(l,h)=>{h&&l<h&&(this.setMemoryDirty(),this._allTiles.forAll(u=>u.setMemoryDirty()))})]),this.addHandles([O(()=>this._renderer.texturesBeingCompressed,(l,h)=>{l===0&&l!==h&&this.requestRender()})]);const{spatialReference:r}=s;this._extentHelper=W$(this.viewingMode,{layers:s.map.allLayers,layerViews:s.allLayerViews,viewSpatialReference:r});const a=new qO({getCollections:()=>{var l,h;return(h=(l=s.defaultsFromMap)==null?void 0:l.mapCollections)==null?void 0:h.map(({layers:u})=>u)},getChildrenFunction:l=>l&&"layers"in l?l.layers:null}),n=new Fr({layers:a,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:r});this._set("tilingSchemeLogic",n),this._updateTilingScheme(),this._elevationDataRequester=e.createStreamDataRequester(kr.ELEVATION),this._mapDataRequester=e.createStreamDataRequester(kr.BASEMAP);const o=e.scheduler;this._frameTask=o.registerTask(ai.TERRAIN_SURFACE,this),this.addHandles([O(()=>this._extentHelper.stencilEnabledExtents,l=>this._renderer.setStencilEnabledLayerExtents(l),at),O(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),Ge),O(()=>this.extent,()=>this._updateRootTiles(),at),s.on("resize",()=>this._viewChangeUpdate()),O(()=>{const l=s.state;return[this._lodBias,this.lodSnappingEnabled,s.quality,l.camera,l.contentCamera,l.fixedContentCamera]},()=>this._viewChangeUpdate(),Be),O(()=>{var l;return(l=s.qualitySettings)==null?void 0:l.fadeDuration},l=>this._renderer.textureFadingEnabled=l>0,at),O(()=>{var l;return(l=s.qualitySettings)==null?void 0:l.physicallyBasedRenderingEnabled},l=>this._renderer.pbrMode=l?Wt.Simplified:Wt.Disabled,at),O(()=>{var l;return(l=s.qualitySettings)==null?void 0:l.tiledSurface.elevationLevelDelta},()=>this._updateAllTileGeometries()),O(()=>this._userClippingExtent,()=>this._updateClippingExtent(),Ge)]),this.addHandles(s.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._destroying=!0,this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",se(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((s,e)=>this._unregisterTiledLayerView(e)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",se(this.overlayManager)),this._tileCache=se(this._tileCache),ff.prune(),this._treeDebugger=se(this._treeDebugger),this._renderer=se(this._renderer),this._iteratorPool=se(this._iteratorPool),this._upsampleMapCache=se(this._upsampleMapCache),this._elevationQueryCache=se(this._elevationQueryCache),this._set("view",null),this._extentHelper=se(this._extentHelper),this._upsampleInfoPool=se(this._upsampleInfoPool),GI()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnappingEnabled){const{view:s,tilingScheme:e}=this,t=s.scale;if(e&&t){const i=e.levelAtScale(t)+s.qualitySettings.tiledSurface.lodBias,r=e.getMaxLod();return i<=0?null:Math.min(i,r||1/0)}}return null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){const{spatialReference:s}=this,{clippingArea:e}=this.view;if(e==null||s==null)return null;const t=pi(),i=B1(e,t,s)?t:null,r=this._get("extent");return no(i,r)?r:i}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const s=d_(this.groundExtent,this._userClippingExtent,pi()),e=this._get("extent");return no(s,e)?e:s}get groundExtent(){return this._tilingSchemeExtent!=null?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){var s;return(s=this.tilingSchemeLogic)==null?void 0:s.extent}get updating(){var s,e;return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||(s=this._watchUpdatingTracking)!=null&&s.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||(e=this.overlayManager)!=null&&e.updating||this.renderer.texturesBeingCompressed)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){var s,e,t;return((t=(e=(s=this.view)==null?void 0:s.map)==null?void 0:e.ground)==null?void 0:t.opacity)??1}set baseOpacity(s){this.view.map.ground.opacity=s}get viewingMode(){return this.view.state.viewingMode}get ready(){return this._rootTiles!=null}set renderOrder(s){this._renderer.renderOrder=s,this._set("renderOrder",s)}get rootTiles(){return this._rootTiles}get spatialReference(){var s;return((s=this.tilingScheme)==null?void 0:s.spatialReference)??null}get backgroundColor(){var s,e,t;return(t=(e=(s=this.view)==null?void 0:s.map)==null?void 0:e.ground)==null?void 0:t.surfaceColor}set backgroundColor(s){this.view.map.ground.surfaceColor=s}set slicePlaneEnabled(s){this._renderer.slicePlaneEnabled=s,this._set("slicePlaneEnabled",s),this._evaluateTransparency()}get tilingSchemeLocked(){var s;return((s=this.tilingSchemeLogic)==null?void 0:s.tilingSchemeLocked)??!1}get wireframe(){var s;return(s=this._renderer)==null?void 0:s.wireframe}set wireframe(s){s!==this._renderer.wireframe&&(this._renderer.wireframe=s,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===Di.Opaque}set suspended(s){this._set("suspended",s),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(s,e,t,i){this._renderer.intersect(s,e,t,i)}getElevationLevelDelta(s){return s<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(s,e,t,i){const r=this._rootTiles;if(!(r!=null&&r.length)||r[0].layerInfo[fe.ELEVATION].length===0)return null;let a=this._elevationProjectorCache.get(i);if(a===void 0&&(a=T_(i,this._spatialReference)??null,this._elevationProjectorCache.set(i,a)),a==null)return pe.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const n=ce(fh,s,e,t);return a(n,0,n,0),U0(r,n[0],n[1])}getElevations(s,e,t){const i=this._rootTiles,r=i?i[0].layerInfo[fe.ELEVATION].length:0;if(i!=null&&i.length&&r!==0)for(let a=0;a<e;++a){const n=3*a;t(a,U0(i,s[n],s[n+1]))}else for(let a=0;a<e;++a)t(a,null)}getScale(s){if(!this.tilingScheme)return null;if(!ec(s,fh,this.spatialReference))return pe.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const e=this._rootTiles;if(e!=null){for(const t of e)if(t!=null&&t.containsPoint(fh)){let i=t;for(;i.children[0]&&!i.rendered;){const r=i.children[0].extent;let a=0;fh[0]>r[2]&&(a+=1),fh[1]<r[1]&&(a+=2),i=i.children[a]}return this._getLodBiasCorrectedScale(i.level)}}return 1/0}_ensureProjector(s){const e=this._projectorCache.get(s);if(e)return e;const t=T_(s,this._tilingSchemeSpatialReference)??null;return this._projectorCache.set(s,t),t}getSphereElevationBounds(s,e){const t=this._ensureProjector(e);if(t==null)return pe.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;OE(s,Yo);const i=wt(Yo);t(i,0,i,0);const r=new Qd,a=this._rootTiles;if(a!=null){const n=[];for(const l of a)n.push(l);let o=0;for(;o<n.length;){const l=n[o];if(++o,!sy(l.extent,Yo))continue;const h=l.children;if(h[0]==null||l.rendered)r.expandElevationRangeValues(l.elevationBoundsMin,l.elevationBoundsMax);else for(const u of h)n.push(u)}}return r}getRootElevationBounds(){return new Qd(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getLowerBoundRadius(){const s=(this._ellipsoid.radius+this.visibleElevationBounds.min)*this._radiusModifier;return Math.min(s,this._ellipsoid.radius)}getSphereScale(s,e){if(!this.tilingScheme)return null;if(!ec(s,wt(Yo),this.spatialReference))return pe.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;Yo[3]=e;let t=null;const i=a=>{if(a&&sy(a.extent,Yo)){const n=a.children;if(n[0]&&!a.rendered)for(const o of n)i(o);else{const o=this._getLodBiasCorrectedScale(a.level);t=t==null?o:Math.min(t,o)}}},r=this._rootTiles;if(r!=null)for(const a of r)i(a);return t}queryVisibleScaleRange(s,e,t,i){const r=e?this.tilingScheme.levelAtScale(e):0,a=t?this.tilingScheme.levelAtScale(t):1/0,n=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(s,r+n,a+n,i)}_evaluateTransparency(){const s=this.baseOpacity,e=this.overlayManager.renderer.isEmpty,t=this._renderer.transparency,i=this._allSurfaceLayersTransparent()?e?Di.Invisible:Di.InvisibleWithDraped:s>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?Di.Opaque:Di.Transparent;return this._renderer.transparency=i,t!==i}_updateTilingScheme(){var t,i,r,a;const s=this.tilingSchemeLogic.tilingScheme;if(s===this.tilingScheme)return;ci(!!s,"tiling scheme cannot be reset to undefined"),this._isGlobal=!((i=(t=this.view)==null?void 0:t.state)!=null&&i.isLocal),this.tilingScheme&&this._removeAllTiles();const e=(s==null?void 0:s.spatialReference)??si.WebMercator;this._spatialReference=e,this._isWebMercator=!!(e!=null&&e.isWebMercator),this._isWebMercatorOnPlateCarree=this._isWebMercator&&Yb((r=this.view)==null?void 0:r.renderSpatialReference),this._isGeographic=(e==null?void 0:e.isGeographic)??!1,this._set("tilingScheme",s),this._tilingSchemeSpatialReference=(a=this.tilingScheme)==null?void 0:a.spatialReference,this._projectorCache.clear(),this._updateClippingExtent(),s&&(this._updateTiledLayers(),this._renderer.tileSize=s.pixelSize,this.overlayManager.spatialReference=s.spatialReference,this._updateRootTiles())}_acquireTile(s,e,t,i){const r=this._tileCache.pop(vd._tileMemcacheKey);return r?(r.init(s,e,t,i,this),r):new this._tileConstructor(s,e,t,i,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:s,tilingScheme:e}=this;if(!e)return;const t=p3;let i=e.rootTilesInExtent(s,t,5*jc);if(this._rootTiles!=null){if(i.length>jc)return void pe.getLogger(this).warn(WS);const r=this._rootTiles.map(n=>n.lij),a=JC(r,i,gd);if(this._updatingRootTiles=!0,a.removed.length>0||a.added.length>0){const n=this._rootTiles.filter(o=>!(a.removed.findIndex(l=>gd(l,o.lij))>-1)||(this._purgeTile(o),!1));a.added.forEach(o=>n.push(this._newRootTile(o))),this._setRootTiles(n)}}else this._updatingRootTiles=!0,i.length>jc&&(pe.getLogger(this).warn(QS),i=e.rootTilesInExtent(s,t,jc)),this._setRootTiles(i.map(r=>this._newRootTile(r)));no(t,this._rootTilesExtent)||(this._rootTilesExtent=pi(t)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const s=this._allTiles.filter(e=>e.loaded&&e.intersectsClippingArea);s.sort(Wr),s.forEach(e=>this._renderer.updateTileGeometryState(e)),s.forEach(e=>e.renderData.updateNeighborData()),this._updateTilesGeometries(s),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(s){if(s.length===0)return;s.sort(Wr);const e=this.renderer;s.forEach(t=>e.updateGeometryIfNeeded(t)),s.forEach(t=>this._pendingTilesForElevationUpdateEvent.add(t))}_shouldSplit(s){return s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===te.SPLIT}_newRootTile(s){const e=this._acquireTile(0,s[1],s[2],null);return this._shouldSplit(e)&&e.setPendingUpdate(te.SPLIT),this._loadTile(e),this._markTileToUpdate(e),this._updateRootTileElevationBounds(),e}_setRootTiles(s){if(this._rootTiles=s,this._allTiles.clear(),s!=null){const e=this._iteratorPool.acquire();for(e.reset(s);!e.done;)this._allTiles.push(e.next());e.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(s)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(s){s.updateClippingStatus(this.extent)&&s.resetPendingUpdate(te.GEOMETRY)&&this._updateTileGeometryState(s)}_updateTilesVisibility(s){if(s==null)return;const e=CI(s),t=this.visibleElevationBounds;let i=e?t.min:1/0,r=e?t.max:-1/0;const a=this.extent,n=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(s);!o.done;){const l=o.next();l.updateClippingStatus(a)&&l.resetPendingUpdate(te.GEOMETRY)&&this._updateTileGeometryState(l),l.computeVisibility(),l.updateScreenDepth(n),l.renderData&&(i=Math.min(l.elevationBoundsMin,i),r=Math.max(l.elevationBoundsMax,r))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(i)&&isFinite(r)&&(t.min!==i||t.max!==r)&&(this.visibleElevationBounds=new _l(i,r))}_updateRootTileElevationBounds(){let s=1/0,e=-1/0;const t=this._rootTiles;t!=null&&t.forEach(({elevationBoundsMin:r,elevationBoundsMax:a})=>{s=Math.min(s,r),e=Math.max(e,a)});const i=this.rootTileElevationBounds;i.min===s&&i.max===e||(this.rootTileElevationBounds=new _l(s,e))}_updateViewDependentParameters(){const{camera:s,contentCamera:e}=this.view.state,t=Math.tan(.5*e.fovX),i=Math.tan(.5*e.fovY),r=this.tilingScheme.pixelSize,a=2**-this._lodBias*s.pixelRatio;this._splitLimits.aboveGround=s.aboveGround,this._splitLimits.fovX=t,this._splitLimits.fovY=i,this._splitLimits.relativeWidthLimit=r/s.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=r/s.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=Iy(this._splitLimits.frustum??$y(),e.frustum):this._splitLimits.frustum=null,Iy(this._frustum,s.frustum),le(this._eyePosRenderSR,e.eye),Ll(s.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(s){s.updateVisibility(),this._renderer.updateTileGeometryState(s)&&this._markTileToUpdate(s),this.setMemoryDirty()}_markAllTileNeighborsForUpdate(s){s.forEachLoadedNeighbor(e=>{this._layerViews[fe.MAP].some(Vd)&&e.setPendingUpdate(te.TEXTURE_FADING),this._pendingTilesToUpdate.add(e)})}_updateTileTexture(s,e){const t=s.resetPendingUpdate(te.TEXTURE_FADING)?te.TEXTURE_FADING:!!s.resetPendingUpdate(te.TEXTURE_NOFADING)&&te.TEXTURE_NOFADING;t&&(this._renderer.updateTileTexture(s,t),this._usedMemory=null,e.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const s=zm.extent;_o(s),this._pendingTilesForElevationUpdateEvent.forEach(e=>vl(s,e.extent,s)),this._pendingTilesForElevationUpdateEvent.clear(),zm.spatialReference=this.spatialReference,this.emit("elevation-change",zm),this._shouldEmitChangeEvent=!1}runTask(s){this._handleLayerViewChanges(s),this._frameTask.processQueue(s),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,s),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(s),this._sortTiles(s);const e=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(s,e),this._updateElevation(s),this._updateTextures(s),e||this._mergeAndSplit(s,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),s.done&&s.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),zi&&this._checkTileInvariant(),!s.hasProgressed)return Xi}_checkTileInvariant(){const s=new Map;this._allTiles.forAll(e=>s.set(e,new Set)),this._allTiles.forAll(e=>{var t;if(ci(e.rendered===e.leaf,` rendered ${e.rendered} != ${e.leaf} leaf`),!e.leaf){const i=a=>a.unmergableChildCount===0&&a.maxLevelDeltaNeighborCount===0,r=e.children.reduce((a,n)=>a+(i(n)?0:1),0);if(ci(e.unmergableChildCount===r,` Tile[${e.lij.toString()}] unmergeable child count mismatch: actual ${e.unmergableChildCount} vs ${r}`),e.hasPendingUpdate(te.MERGE)){ci(!e.hasPendingUpdate(te.SPLIT),"Tile can be both split and merge at the same time");for(const a of e.children)ci(a.leaf||a.hasPendingUpdate(te.MERGE),"Child of tile to merge must also merge")}}for(let i=0;i<4;++i){if(e.rendered){const o=(t=e.renderData)==null?void 0:t.geometryState.edgePeerNeighbors[i];if(o!=null){{const l=e.level-o.level<=Kt;l||(console.log(`tile level delta [${e.lij.toString()}] vs [${o.lij.toString()}] > ${Kt}  (edge[${i}])`),ci(l,`tile level delta [${e.level}] vs [${o.level}] > ${Kt}`))}ci(e.level-o.level<=Kt,`Max tile lod delta exceeded: [${e.lij.toString()}] vs [${o.lij.toString()}]`)}}const r=e.level-Kt,a=o=>o.leaf||o.level===e.level,n=e.findNeighborTile(gr[i],a);if(n!=null){if(e.leaf&&e.level>=Kt){let o=n;for(;e.level-o.level<Kt;)o=o.parent;const l=[r,e.lij[1]>>Kt,e.lij[2]>>Kt];if(!gd(l,o.lij)){const h=s.get(o);ci(!h.has(e),"Cannot already have neighbor"),h.add(e)}}ci(n.rendered||n.level===e.level,"Non-same-level-neighbor of rendered must be rendered"),ci(e.level-n.level<=Kt,`Tile level delta [${e.level}] vs [${n.level}] > ${Kt}`)}}}),this._allTiles.forAll(e=>{const t=e.maxLevelDeltaNeighborCount,i=s.get(e);ci(t===i.size,`Tile[${e.lij.toString()}] merge-blocker mismatch: actual ${t} vs ${i.size}`)})}_updateAllTilesStatus(s){if(!this._viewChanged||!this._rootTiles||s.done)return;this._viewChanged=!1;const e=new m3(this._allTiles.length);e.pushAll(this._rootTiles);const t=this.snapLevel,i=this._splitLimits,r=this._eyePosRenderSR;this._allTiles.forAll(n=>{n.maxLevelDeltaNeighborCount=0,n.unmergableChildCount=0});const a=this.view.state.contentCamera.viewProjectionMatrix;for(;!e.empty;){const n=e.pop(),o=n.parent,l=o!=null&&o.hasPendingUpdate(te.MERGE),h=l?te.MERGE:n.shouldSplit(i,r,t),u=h===te.SPLIT;n.leaf?Gm(n,u):e.pushAll(n.children),l?(n.resetPendingUpdate(te.SPLIT),n.leaf||n.setPendingUpdate(te.MERGE),this._updateClippingStatus(n),n.updateVisibility(),n.updateScreenDepth(a)):u?(n.resetPendingUpdate(te.MERGE),n.leaf&&n.setPendingUpdate(te.SPLIT)):(n.resetPendingUpdate(te.SPLIT)&&n.updateAgentSuspension(),h===te.ELEVATION&&n.updateAgents(fe.ELEVATION),n.leaf||(n.setPendingUpdate(te.MERGE),n.resetPendingUpdate(te.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),s.madeProgress()}_sortTiles(s){s.done||this._allTilesSorted||(wI(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),s.madeProgress())}_markTileToUpdate(s){z(s.loaded),s.intersectsClippingArea&&(this._pendingTilesToUpdate.add(s),this._markAllTileNeighborsForUpdate(s))}_updatePendingTileGeometries(){const s=this._pendingTilesToUpdate,e=Array.from(s.keys()).filter(r=>r.loaded&&r.intersectsClippingArea);if(e.length===0)return void s.clear();const t=(r,a)=>{!(a!=null&&a.loaded)||!a.intersectsClippingArea||a.level<r.level||s.has(a)||(s.add(a),e.push(a),a.renderData.updateNeighborData())};e.sort(Wr);const i=e.length;for(let r=0;r<i;++r){const a=e[r];z(a.loaded),z(a.intersectsClippingArea);const n=a.renderData;n.updateNeighborData();const o=n.dirtyEdgeResolutions,l=n.geometryState,h=u=>{var p;const d=Ld[u];t(a,(p=l.cornerPeerNeighbors[u])==null?void 0:p.findCorner(Nd(d),_=>_.loaded))};for(let u=0;u<4;++u)if(o&1<<u){const d=n.geometryState.edgePeerNeighbors[u];d&&(d==null?void 0:d.level)>=a.level&&d.forAllSubtreeOnSide(Tg(gr[u]),p=>!(!p.loaded||!p.intersectsClippingArea)&&(z(s.has(p)||Wr(a,p)<0),t(a,p),!0)),h((u+1)%4),h(u)}}s.clear(),this._updateTilesGeometries(e),this._shouldEmitChangeEvent=!0,zi&&__&&this.checkAllTilesWaterproofness()}_mergeAndSplit(s,e){if(this.suspended||s.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let t=!1;const i=this.view.state.fixedContentCamera;let r=!1;for(;!s.done;){r=!0;let a=!1;const n=!this._allTiles.some(o=>{if(!t&&!i&&!o.visible)return s.done;let l=o;if(o.hasPendingUpdate(te.MERGE)){if(!e||o.unmergableChildCount>0)return s.done;for(o.resetPendingUpdate(te.MERGE);l.parent!=null&&l.parent.unmergableChildCount===0&&l.parent.resetPendingUpdate(te.MERGE);)l=l.parent;this._mergeTile(l),a=!0,s.madeProgress()}else if(o.resetPendingUpdate(te.SPLIT)){let h=!0;const u=o.level;if(u>=Kt){const d=p=>p.leaf||u-p.level<Kt;for(let p=0;p<4;++p){const _=o.findNeighborTile(gr[p],d);_!=null&&u-_.level===Kt&&(h=!1,zi&&(z(_.leaf),z(_.hasPendingUpdate(te.SPLIT))))}}h?(this._splitTile(o),s.madeProgress(),a=!0):o.setPendingUpdate(te.SPLIT)}return s.done});if(a&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),n){if(!t){t=!0;continue}if(!a)break}else this._allTilesDirty=!0}r?s.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(s)}_updateElevation(s){s.done||(this._allTiles.some(e=>(e.resetPendingUpdate(te.GEOMETRY)&&(this._updateTileGeometryState(e),this._shortBatches&&this._updatePendingTileGeometries(),s.madeProgress()),s.done)),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(s){s.done||this._allTiles.some(e=>(this._updateTileTexture(e,s),s.done))}_updateClippingExtent(){var s;this.spatialReference&&((s=this.overlayManager)==null||s.updateOverlayParameters(Ce.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const s=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-s)*YS}_getLodBiasCorrectedScale(s){const e=this.tilingScheme.levels,t=Q(s-this._lodBias,0,e.length-1),i=t-Math.floor(t);return e[Math.floor(t)].scale*(1-i)+e[Math.ceil(t)].scale*i}_removeAllTiles(){this._rootTiles!=null&&(this._rootTiles.forEach(s=>this._purgeTile(s)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.renderer.visible=!1}_purgeSubtree(s){const e=s.children;e[0]&&(this._purgeTile(e[0]),this._purgeTile(e[1]),this._purgeTile(e[2]),this._purgeTile(e[3]),s.clearChildren())}_purgeTile(s){s.leaf?H0(s):this._purgeSubtree(s),this._allTiles.removeUnordered(s),this._unloadTile(s),s.dispose(),this._tileCache.put(vd._tileMemcacheKey,s)}_unloadTile(s){this._pendingTilesToUpdate.delete(s),this._pendingTilesForElevationUpdateEvent.delete(s),s.unload()}_splitTile(s){ci(s.leaf,"Tile that is already split should not be split again!"),ci(s.rendered,"Tile marked to split is not rendered"),H0(s);const e=s.createChildren();this._allTiles.pushArray(e),s.updateAgentSuspension(),ci(s.rendered,"parent should be rendered"),e.forEach(t=>this._loadTile(t)),e.forEach(t=>this._pendingTilesToUpdate.add(t)),this._unloadTile(s),this._markAllTileNeighborsForUpdate(s),this._emitTileScaleChange(s,s.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),e.forEach(t=>Gm(t,t.hasPendingUpdate(te.SPLIT))),++this._performanceInfo.numSplit}_emitTileScaleChange(s,e=s.level){Nu.spatialReference=this.spatialReference,Nu.extent=s.extent,Nu.scale=this._getLodBiasCorrectedScale(e),this.emit("scale-change",Nu)}createTile(s,e,t,i){ci(!!i,"createTile sanity check");const r=this._acquireTile(s,e,t,i);return r.updateClippingStatus(this.extent),r.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(r)&&r.setPendingUpdate(te.SPLIT),r}get _shortBatches(){return this.view.state.mode!==Oi.IDLE}_mergeTile(s){ci(!s.hasPendingUpdate(te.SPLIT),"_mergeTile sanity check"),ci(!s.leaf,"Cannot merge a leaf"),s.leaf||(this._purgeSubtree(s),ci(!s.renderData,"Merging tile with existing render data?"),this._loadTile(s),this._markTileToUpdate(s),this._emitTileScaleChange(s),this._shortBatches&&this._updatePendingTileGeometries(),Gm(s,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(s){var e;s.load(),this.requestUpdate(),this._allTilesDirty=!0,(e=this.overlayManager)!=null&&e.hasOverlays&&this.overlayManager.updateTileOverlayParameters(s)}_handleLayerViewChanges(s=qr){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let e=!1;const t=new Set;let i=-1;for(let r=this.view.allLayerViews.length-1;r>=0;r--){const a=this.view.allLayerViews.items[r];if(t.add(a.uid),g_(a)||Kl(a))if(this._basemapLayerViewHandles.has(a.uid)&&!Kl(a)){const n=this._layerClassFromLayerView(a),o=this._getLayerIdxByUID(n,a.uid);o!=null&&((o<i||i==null)&&(e=!0),i=o)}else this._registerTiledLayerView(a),a.layer.loaded&&(e=!0)}this._basemapLayerViewHandles.forEach((r,a)=>{t.has(a)||(this._unregisterTiledLayerView(a),e=!0)}),e&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),s.madeProgress()}_allSurfaceLayersTransparent(){var e,t;let s=((t=(e=this.view.map)==null?void 0:e.ground)==null?void 0:t.opacity)===0;for(const i of this.view.allLayerViews.items)if(_y(i)&&!ku(i.layer)&&i.fullOpacity!==0)return s=!1,s;return s}_hasCompositeBlendMode(){for(const s of this.view.allLayerViews.items)if((ic(s)||Kl(s))&&CL(Y_[s.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(s){return gy(s)?fe.ELEVATION:fe.MAP}_registerTiledLayerView(s){const e=[];if((ic(s)||Kl(s))&&e.push(O(()=>s.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(zt.UNFADED)})),!Kl(s)){const t=this._layerClassFromLayerView(s);e.push(O(()=>s.suspended,()=>this._updateTiledLayers())),e.push(O(()=>s.fullOpacity,()=>this._updateTileTextures(zt.UNFADED))),e.push(O(()=>"effectiveScaleRange"in s.layer?s.layer.effectiveScaleRange:null,()=>this._restartAllAgents(t))),e.push(s.on("data-changed",()=>{const i=this._getLayerIdxByUID(t,s.uid);i!=null&&this._invalidateLayerData(i,t)}))}this._unregisterTiledLayerView(s.uid),this._basemapLayerViewHandles.set(s.uid,e)}_unregisterTiledLayerView(s){const e=this._basemapLayerViewHandles.get(s);if(e){for(const t of e)t.remove();this._basemapLayerViewHandles.delete(s)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const s=this.view.allLayerViews,e=[[],[]];let t=null;s.forEach(i=>{if(!i.layer||i.suspended||!g_(i)||!i.fullExtent)return;const r=this._layerClassFromLayerView(i);if(r===fe.MAP){const a=i.displayLevelRange.maxLevel;a!==1/0&&(t===null||a>t)&&(t=a)}e[r].push(i)});for(const i of sl){const r=this._layerViews[i],a=e[i];a.reverse();const n=a.length;let o=r.length!==n;const l=new Array(n),h=new Array(r.length);this._layerIndexByUid[i].clear();for(let u=0;u<n;u++){const d=a[u].uid;this._layerIndexByUid[i].set(d,u);const p=r.indexOf(a[u]);l[u]=p,u!==p&&(o=!0),p>-1&&(h[p]=u)}if(o){const u=this._postorderIterator;for(u.reset(this._rootTiles);!u.done;)u.next().modifyLayers(h,l,i);this._layerViews[i]=a,this._restartAllAgents(i),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(t)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(s){const e=this._postorderIterator;for(e.reset(this._rootTiles);!e.done;){const t=e.next();t.restartAgents(s),s===fe.ELEVATION&&t.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(s,e){return this._layerViews[e][s]}numLayers(s){return this._layerViews[s].length}_updateTileTextures(s){this._allTiles.forAll(e=>{e.updateAgents(fe.MAP),s===zt.IMMEDIATE?this.renderer.updateTileTexture(e,te.TEXTURE_NOFADING):e.updateRenderData(fe.MAP,s)}),this._evaluateTransparency()}_invalidateLayerData(s,e){this._allTiles.forAll(t=>t.removeLayerAgent(s,e)),this._allTiles.forAll(t=>t.invalidateLayerData(s,e))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(s=Ce.UPDATE){this.renderer.setNeedsRender(s)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(s,e,t,i){const r=this.layerViewByIndex(e,t),a=r.layer;return!a.tilemapCache||Vd(r)?this._requestTileData(s,t,r,i):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(s.level,s.lij[1],s.lij[2],{...i,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(n=>{throw--this._asyncWorkItems,Ai(i),cn(n)||this._dataMissing(s,t,r),n}).then(()=>this._frameTask.schedule(()=>this._requestTileData(s,t,r,i),i.signal)))}_requestTileData(s,e,t,i){if(this._destroying)return Promise.resolve();const r=e===fe.ELEVATION;return i.requester??(i.requester=r?this._elevationDataRequester:this._mapDataRequester),r?gy(t)?this._requestElevationTileData(s,t,i):Promise.reject():_y(t)?this._requestMapTileData(s,t,i):Promise.reject()}_requestElevationTileData(s,e,t){++this._asyncWorkItems;const i=a=>{!Hh(t)&&a&&(this.setMemoryDirty(),this.requestUpdate(),this._elevationDataArrived(s,e,a))},r=a=>{cn(a)||(pe.getLogger(this).error(`Tile ${s.lij.toString()} layer ${fe.ELEVATION}/${e.uid} error ${a}`),this._dataMissing(s,fe.ELEVATION,e),this.requestUpdate())};return e.fetchTile(s.lij,t).then(a=>this._frameTask.schedule(()=>i(a)),r).finally(()=>--this._asyncWorkItems)}_elevationDataArrived(s,e,t){const i=this._layerIndexByUid[fe.ELEVATION].get(e.uid);if(i==null)return void pe.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",fe.ELEVATION,s.lij.toString());const r=new k$(s.lij,s.extent,t);s.dataArrived(i,fe.ELEVATION,r);const a=[s],n=s.level,o=this._iteratorPool.acquire();for(o.reset(a);!o.done;){const l=o.next();l.findElevationBoundsForLayer(i,n),l.computeElevationBounds()}n===0&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(a)}_requestMapTileData(s,e,t){++this._asyncWorkItems;const i=(o,l)=>{bl(l),Hh(t)||(console.error(`Tile ${s.lij.toString()} layer ${fe.MAP}/${e.uid} error ${o}`),this._dataMissing(s,fe.MAP,e),this.requestUpdate())},r=o=>l=>i(l,o),a=o=>this._frameTask.schedule(()=>{this.requestUpdate(),Hh(t)?bl(o):this._mapTileDataArrived(s,e,o)},t.signal,r(o)).catch(r(o)),n=(o,l=null)=>this._frameTask.schedule(()=>i(o,l));return e.fetchTile(s.lij,t).then(a,n).finally(()=>--this._asyncWorkItems)}_mapTileDataArrived(s,e,t){const i=this._getLayerIdxByUID(fe.MAP,e.uid);if(i==null)return bl(t),void pe.getLogger(this).warn("TerrainSurface: received data from unknown layer");s.dataArrived(i,fe.MAP,t)}_getLayerIdxByUID(s,e){return this._layerIndexByUid[s].get(e)}_dataMissing(s,e,t){const i=this._getLayerIdxByUID(e,t.uid);i!=null?s.dataMissing(i,e):pe.getLogger(this).warn("TerrainSurface: received data from unknown layer")}get performanceInfo(){const s=this._performanceInfo;return s.numNodes=this._allTiles.length,s.numLeaves=s.numVisible=s.numRendered=s.numLoadedPerLevel.length=s.numRenderedPerLevel.length=0,this._allTiles.forAll(e=>{e.leaf&&s.numLeaves++;const t=e.level;e.renderData&&(s.numLoadedPerLevel[t]=(s.numLoadedPerLevel[t]||0)+1),e.visible&&(s.numVisible++,e.rendered&&(s.numRenderedPerLevel[t]=(s.numRenderedPerLevel[t]||0)+1,s.numRendered++))}),s}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this.tilingScheme?(this._usedMemory==null&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce((s,e)=>s+e.usedMemory,0)):null}getUsedMemoryForLayerView(s){let e=0;const t=this._layerClassFromLayerView(s),i=this._getLayerIdxByUID(t,s.uid);return i!=null&&this._allTiles.forAll(r=>e+=r.getUsedMemoryForLayer(t,i)),e}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(s){this._renderer.renderPatchBorders=s}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(s){this._renderer.visualizeNormals=s}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(s){this._renderer.renderingDisabled=s}get test(){}checkAllTilesWaterproofness(){if(!__)return;const s=this._rootTiles;if(s==null)return;const e=a=>{var n,o,l;return((l=(o=(n=a==null?void 0:a.renderData)==null?void 0:n.geometry)==null?void 0:o.indices)==null?void 0:l.length)>0},t=(a,n)=>{e(a)&&console.error("Tile[",a.lij,"] has geometry although parent[",n.lij,"] has geom")},i=a=>{var n,o;if(a.intersectsClippingArea)if(a.renderData&&!a.renderData.geometryState&&console.error("Tile[",a.lij,"] has renderData but not geometryState"),a.renderData&&!a.renderData.geometry&&console.error("Tile[",a.lij,"] has renderData but not geometryInfo"),!((n=a.renderData)!=null&&n.geometry)||(((o=a.renderData.geometry.indices)==null?void 0:o.length)??0)>0||console.error("Tile[",a.lij,"] has renderData but no indices - geometryInfo: ",a.renderData.geometry),e(a)){a.checkGeometryWaterproofness();for(const l of a.children)t(l,a)}else if(a.leaf)console.error("Tile[",a.lij,"] has no geometry and no children, from root to leaf");else for(const l of a.children)i(l)},r=a=>{var h;const n=((h=a.parent)==null?void 0:h.visible)??!0,o=a.visible;a.computeVisibility();const l=a.visible;if(o!==l&&n&&console.error(" Tile[",a.lij,"] has out of date visibility: ",o," instead of ",l),!a.leaf)for(const u of a.children)r(u)};for(const a of s)i(a),r(a)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(s){return this._isGlobal&&s[2]===this.lijEastEnd(s[0])-1}isWestEndWrap(s){return this._isGlobal&&s[2]===0}lijEastEnd(s){return 1<<s+(this._isGeographic?1:0)}wrapEastWest(s){const e=this.lijEastEnd(s[0]),t=s[2];if(0<=t&&t<e)return s;if(!this._isGlobal)return null;const i=(t+(t<0?e:0))%e;return[s[0],s[1],i]}enableInternalChecks(s){ZS(s)}enableWaterproofnessChecks(s){XS(s)}};xe._tileMemcacheKey="TerrainTileMemcache",c([m()],xe.prototype,"_renderer",void 0),c([m({constructOnly:!0})],xe.prototype,"_scaleRangeQueries",void 0),c([m({constructOnly:!0})],xe.prototype,"view",void 0),c([m({constructOnly:!0})],xe.prototype,"overlayManager",void 0),c([m()],xe.prototype,"_hasPendingUpdates",void 0),c([m()],xe.prototype,"_asyncWorkItems",void 0),c([m()],xe.prototype,"_allTilesDirty",void 0),c([m()],xe.prototype,"_allTilesSorted",void 0),c([m()],xe.prototype,"_viewChanged",void 0),c([m({type:Number})],xe.prototype,"heading",void 0),c([m()],xe.prototype,"_splitLimits",void 0),c([m({readOnly:!0})],xe.prototype,"_watchUpdatingTracking",void 0),c([m()],xe.prototype,"_frameTask",void 0),c([m({readOnly:!0})],xe.prototype,"snapLevel",null),c([m({readOnly:!0})],xe.prototype,"lodSnappingEnabled",null),c([m()],xe.prototype,"_userClippingExtent",null),c([m()],xe.prototype,"_rootTilesExtent",void 0),c([m({readOnly:!0})],xe.prototype,"extent",null),c([m({readOnly:!0})],xe.prototype,"groundExtent",null),c([m({readOnly:!0})],xe.prototype,"_tilingSchemeExtent",null),c([m({readOnly:!0})],xe.prototype,"updating",null),c([m({readOnly:!0})],xe.prototype,"running",null),c([m(q$)],xe.prototype,"updatingProgress",void 0),c([m({readOnly:!0})],xe.prototype,"updatingProgressValue",null),c([m()],xe.prototype,"_maxNumUpdating",void 0),c([m()],xe.prototype,"baseOpacity",null),c([m()],xe.prototype,"hasCompositeBlendMode",void 0),c([m({readOnly:!0})],xe.prototype,"viewingMode",null),c([m()],xe.prototype,"maxTextureScale",void 0),c([m({readOnly:!0})],xe.prototype,"ready",null),c([m({value:Fl.FRONT_TO_BACK})],xe.prototype,"renderOrder",null),c([m({readOnly:!0})],xe.prototype,"rootTiles",null),c([m()],xe.prototype,"_rootTiles",void 0),c([m({readOnly:!0})],xe.prototype,"spatialReference",null),c([m({type:Vg})],xe.prototype,"backgroundColor",null),c([m({value:!1})],xe.prototype,"slicePlaneEnabled",null),c([m({readOnly:!0})],xe.prototype,"tilingScheme",void 0),c([m({readOnly:!0})],xe.prototype,"tilingSchemeLocked",null),c([m({readOnly:!0})],xe.prototype,"tilingSchemeLogic",void 0),c([m()],xe.prototype,"wireframe",null),c([m({value:!1})],xe.prototype,"suspended",null),c([m()],xe.prototype,"fadeDuration",null),c([m()],xe.prototype,"visibleElevationBounds",void 0),c([m()],xe.prototype,"rootTileElevationBounds",void 0),c([m()],xe.prototype,"_layerViewsDirty",void 0),c([m()],xe.prototype,"renderPatchBorders",null),c([m()],xe.prototype,"visualizeNormals",null),c([m()],xe.prototype,"renderingDisabled",null),xe=vd=c([F("esri.views.3d.terrain.TerrainSurface")],xe);const d3=xe,fh=v(),Yo=Sr(),p3=pi();new mt;const zm=new UE("ground"),Nu={spatialReference:null,extent:null,scale:0};function U0(s,e,t){var i;for(const r of s){if(!r.containsPointXY(e,t))continue;let a=r;for(;a&&!a.renderData;){const o=(e>a.extentMidX?1:0)+(t<a.extentMidY?2:0);a=a.children[o]}const n=((i=a==null?void 0:a.renderData)==null?void 0:i.geometryState.samplerData)??null;return bt(e,t,n)}return null}class m3{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(t===0)return;const i=this._tail;if(!(i+t<=this.capacity))throw new Error("Queue full");for(let r=0;r<t;++r)this._data[i+r]=e[r];this._tail=i+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function Gm(s,e){!s.leaf||s.level<Kt||Pf(s,t=>{e&&tC(t);const i=K_(t);if(t.maxLevelDeltaNeighborCount++,i){let r=t.parent;for(;r;){const a=K_(r);if(r.unmergableChildCount++,!a)break;r=r.parent}}})}function tC(s){if(s.hasPendingUpdate(te.SPLIT))return;let e=s.parent;for(;e!=null&&e.resetPendingUpdate(te.MERGE);)e=e.parent;s.resetPendingUpdate(te.MERGE),s.leaf&&s.setPendingUpdate(te.SPLIT),s.level<Kt||Pf(s,t=>{tC(t)})}function H0(s){s.level<Kt||Pf(s,e=>{if(e.maxLevelDeltaNeighborCount--,e.maxLevelDeltaNeighborCount===0&&e.unmergableChildCount===0){let t=e.parent;for(;t&&(t.unmergableChildCount--,K_(t));)t=t.parent}})}function K_(s){return s.maxLevelDeltaNeighborCount===0&&s.unmergableChildCount===0}function Pf(s,e){if(s.level<Kt)return;const t=s.level-Kt,i=s.lij[1]>>Kt,r=s.lij[2]>>Kt,a=n=>n.leaf||n.level===t;for(let n=0;n<4;++n){const o=s.findNeighborTile(gr[n],a);if(!o||o.level!==t)continue;const l=o.lij;l[1]===i&&l[2]===r||e(o)}}let _3=class{constructor(e,t,i,r){this.operation=e,this.geometry=t,this.states=i,this.sync=r}},$h=class extends Re{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this._dirtyRecordCount=0}get dirty(){return this._dirtyRecordCount>0}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);if(!i)return;let r=0;i.forEach((a,n)=>{const o=this._ensureGeomRecord(e,n);r+=a.size,a.forEach(({geometry:l,operation:h,states:u},d)=>{let p=!1;if(h===Nt.UPDATE){const _=o.get(d);if(_){if(u&Ui.TRANSFORMATION){const f=this.model.getObject(n);this.model.updateRenderGeometryTransformation(f,l,_)&&(p=!0)}p||t.updates.push({renderGeometry:_,updateType:u})}else ws(!1,"ModelDirtySet.commitLayer: invalid update")}if(h===Nt.REMOVE||p){const _=o.get(d);_?(t.removes.push(_),o.delete(d)):h===Nt.REMOVE&&ws(!1,"ModelDirtySet.commitLayer: invalid remove")}if(h===Nt.ADD||p){const _=this.model.getObject(n);if(_!=null){const f=this.model.getRenderGeometry(_,l);t.adds.push(f),o.set(d,f)}}}),o.size===0&&this._residentGeomRecords.get(e).delete(n)}),this._residentGeomRecords.get(e).size===0&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this._dirtyRecordCount-=r}commitSyncUpdates(e,t){const i=this._dirtyGeomRecords.get(e);i&&i.forEach((r,a)=>{const n=this._ensureGeomRecord(e,a);r.forEach(({geometry:o,operation:l,states:h,sync:u},d)=>{let p=!1;if(l===Nt.UPDATE&&u){const _=n.get(d);if(_){if(h&Ui.TRANSFORMATION){const f=this.model.getObject(a);this.model.updateRenderGeometryTransformation(f,o,_)&&(p=!0)}p||t.updates.push({renderGeometry:_,updateType:h})}else ws(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}})})}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach(r=>r.forEach(a=>t.push(a)))}_objectStateChanged(e,t){for(const i of t.geometries)this._updateOrCreateDirtyRecord(t,i,null,Nt.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(Ui.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(Ui.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(Ui.OCCLUDEE,e)}attributesChanged({object:e,geometry:t,sync:i}){this._updateOrCreateDirtyRecord(e,t,null,Nt.UPDATE,Ui.GEOMETRY,i)}layerAdded(e){e.objects.forAll(t=>this._layerObjectAdded(e,t))}layerRemoved(e){e.objects.forAll(t=>this._layerObjectRemoved(e,t))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id;for(const r of t.geometries)this._geometryAdded(t,r,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id;for(const r of t.geometries)this._geometryRemoved(t,r,i)}transformationChanged(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(r=>{this._updateOrCreateDirtyRecord(e,r.geometry,t,Nt.UPDATE,Ui.TRANSFORMATION)})}shaderTransformationChanged(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(r=>{r.objectShaderTransformationChanged(e.shaderTransformation)})}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,Nt.ADD)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,Nt.REMOVE)}_updateOrCreateDirtyRecord(e,t,i,r,a=Ui.NONE,n=!1){i=i??this._getParentLayerId(e);const o=e.id,l=t.id,h=this._ensureDirtyRecord(i,o),u=h.get(l);if(u){const d=u.operation;d===Nt.REMOVE&&r===Nt.ADD&&u.states!==Ui.NONE?u.operation=Nt.UPDATE:d===Nt.REMOVE&&r===Nt.ADD||d===Nt.ADD&&r===Nt.REMOVE?(h.delete(l),this._dirtyRecordCount--):d!==Nt.UPDATE||r!==Nt.REMOVE&&r!==Nt.UPDATE?(ws((d===Nt.REMOVE||d===Nt.ADD)&&r===Nt.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),u.states|=a):(u.operation=r,u.states|=a),u.sync=u.sync||n}else h.set(l,new _3(r,t,a,n)),this._dirtyRecordCount++}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return e.parentLayer?e.parentLayer.id:eT}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach((i,r)=>{i.forEach((a,n)=>{t.length>0&&(t+=`
`),t+=r+"."+n;const o=[];a.forEach(l=>{const h=l.operation;o[h]||(o[h]=[]),o[h].push(l.geometry.id)});for(let l=0;l<o.length;l++)if(o[l]){t+=" "+e[l-1]+": ";for(let h=0;h<o[l].length;h++)t+=o[l][h]+", "}})}),t}get test(){}};c([m()],$h.prototype,"_dirtyRecordCount",void 0),c([m({constructOnly:!0})],$h.prototype,"model",void 0),$h=c([F("esri.views.3d.webgl-engine.lib.ModelDirtySet")],$h);const g3=$h;let bd=class extends Re{constructor(){super(...arguments),this.dirtySet=new g3({model:this}),this._content=new Map,this._originFactory=new jO(null)}getObject(e){return this._content.get(e)}add(e){const t=e.id;ws(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),Wd(e)&&this.dirtySet.layerAdded(e)}remove(e){return!!this._content.has(e.id)&&(this._content.delete(e.id),Wd(e)&&this.dirtySet.layerRemoved(e),!0)}addMany(e){for(const t of e)t&&(ws(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)t&&(ws(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id))}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach(i=>{i.type===e&&t(i)})}getRenderGeometry(e,t){const i=new lP(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation});i.transformation=e.getCombinedStaticTransformation(t,z0);const{localOrigin:r}=t;return i.localOrigin=r??this._originFactory.getOrigin(wt(i.boundingSphere)),i}updateRenderGeometryTransformation(e,t,i){if(e==null)return!1;i.transformation=e.getCombinedStaticTransformation(t,z0);const r=this._originFactory.getOrigin(wt(i.boundingSphere));return i.localOrigin!==r}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<hw.COUNT;++i)e[i]=t.filter(r=>r.type===i).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){}};c([m({constructOnly:!0})],bd.prototype,"dirtySet",void 0),bd=c([F("esri.views.3d.webgl-engine.parts.Model")],bd);const z0=It();let iC=class extends Ii{constructor(){super(...arguments),this.radii=Ts(),this.heightParameters=Mi()}};function f3(s){s.uniforms.add(new ra("radii",e=>e.radii),new wp("heightParameters",e=>e.heightParameters)),s.constants.add("scaleHeight","float",os.scaleHeight*os.atmosphereHeight),s.code.add(w`float chapmanApproximation(float thickness, float height, float cosZenith) {
float c = sqrt(thickness + height);
float cExpH = c * exp(-height);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (thickness + height);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(thickness - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),s.code.add(w`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),s.code.add(w`vec4 planetIntersect(vec3 cameraPos, vec3 rayDir) {
float reducedPlanetRadius = radii[0] - 20000.0;
float rayPlanetDistance = heightParameters[1] - reducedPlanetRadius * reducedPlanetRadius;
vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, rayPlanetDistance);
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, heightParameters[2]);
bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
bool insideAtmosphere = heightParameters[0] < radii[1];
if (!(hitsAtmosphere || insideAtmosphere)) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;
float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;
if (heightParameters[0] < reducedPlanetRadius) {
if (dot(rayDir, normalize(cameraPos)) < -0.025) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
start = rayPlanetIntersect.y;
}
float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
return vec4(0.0, hitsPlanet ? 1.0 : 0.0, start, end);
}`)}function sC(s,e){s.include(f3);const t=6;s.uniforms.add(new gn("cameraPosition",i=>i.camera.eye)),s.constants.add("betaRayleigh","vec3",sd),s.constants.add("betaCombined","vec3",MR),s.constants.add("betaMie","float",OR),s.code.add(w`
    vec3 raymarchAtmosphere(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      vec4 ray = planetIntersect(cameraPos, rayDir);
      if(ray.x == 1.0) {
        return vec3(0);
      }
      ${Pe(e,"if (terrainDepth != -1.0) { ray.w = terrainDepth; }")}

      vec3 samplePoint = cameraPos + rayDir * ray.w;
      float multiplier = ray.y == 1.0 ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (ray.w - ray.z) / ${w.float(t)};

      for (int i = 0; i < ${w.int(t)}; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
          ${Pe(!e,"scattering *= mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0))")};
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {
          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);
          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${Pe(!e,"scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);")}
        }
        lastOpticalDepth = opticalDepth;
      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;
      ${e?"return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;":w`const float g = 0.8;
             const float gg = g * g;
             float phaseMie = 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg));
             phaseMie = clamp(phaseMie, 0.0, 128.0);
             return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }`)}function Dp(s,e={needUVs:!0,needEyeDirection:!0}){s.attributes.add(De.POSITION,"vec2"),s.varyings.add("worldRay","vec3");const{needUVs:t,needEyeDirection:i}=e;t&&s.varyings.add("uv","vec2"),i&&s.varyings.add("eyeDir","vec3"),s.vertex.uniforms.add(new bn("inverseProjectionMatrix",r=>r.camera.inverseProjectionMatrix),new bn("inverseViewMatrix",r=>xP(y3,r.camera.viewMatrix))),s.vertex.main.add(w`
    vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
    ${Pe(i,"eyeDir = posViewNear;")}
    worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
    ${Pe(t,"uv = position * 0.5 + vec2(0.5);")}
    gl_Position = vec4(position, 1, 1);
  `)}const y3=It();function rC(s){const e=new kt;e.include(Dp);const{reduced:t}=s,{fragment:i}=e;return Tp(i),e.include(bp),i.include(Ep),i.include(Eg),i.include(sC,!1),i.uniforms.add(new on("backgroundColor",r=>r.backgroundColor),new Ze("innerFadeDistance",r=>r.innerFadeDistance),new Ze("altitudeFade",r=>r.altitudeFade),new br("depthTexture",r=>r.mainDepth)).code.add(w`vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
float rayPlanetDistance = heightParameters[1] - radii[0] * radii[0];
vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, rayPlanetDistance);
if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
return fragColor;
}
float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
if (relDist > 1.0) {
return surfaceColor;
}
return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
}
float getGlow(float dist, float radius, float intensity) {
return pow(radius / max(dist, 1e-6), intensity);
}
vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){
float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));
vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));
float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));
return normalize(sunTransmittance) * sunDisc;
}`).main.add(w`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${Pe(!t,w`float depthSample = texture(depthTexture, uv).r;
             if (depthSample != 1.0) {
                fragColor = vec4(0);
                return;
             }`)}

      vec3 col = linearizeGamma(backgroundColor);
      col += raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      col += getSun(cameraPosition, rayDir, mainLightDirection);
      float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);
  `),e}const v3=Object.freeze(Object.defineProperty({__proto__:null,build:rC},Symbol.toStringTag,{value:"Module"}));let b3=class extends iC{constructor(){super(...arguments),this.innerFadeDistance=0,this.altitudeFade=0,this.backgroundColor=v()}},Bm=class extends Bt{constructor(e,t){super(e,t,new qt(v3,()=>X(()=>Promise.resolve().then(()=>k4),void 0,import.meta.url)))}initializePipeline(e){return Qt({blending:e.reduced?Ag:Rg($t.SRC_ALPHA,$t.ONE_MINUS_SRC_ALPHA),depthTest:{func:e.reduced?Zi.ALWAYS:Zi.LEQUAL},colorWrite:ti})}},aC=class extends Ua{constructor(){super(...arguments),this.reduced=!1}};c([ne()],aC.prototype,"reduced",void 0);let Yr=class extends Co{constructor(){super(...arguments),this.produces="disabled",this.consumes={required:[ge.OPAQUE_ENVIRONMENT]}}_enable(){this.produces=ge.OPAQUE_ENVIRONMENT,this.requestRender(Ce.UPDATE)}_disable(){this.produces="disabled",this.requestRender(Ce.UPDATE)}};c([m()],Yr.prototype,"produces",void 0),c([m()],Yr.prototype,"consumes",void 0),Yr=c([F("esri.views.3d.webgl-engine.effects.OpaqueEnvironment")],Yr);let Ef=class extends Ii{};function nC(){const s=new kt;return s.include(sr),s.fragment.uniforms.add(new ft("colorTexture",e=>e.color),new br("depthTexture",e=>e.mainDepth)),s.fragment.main.add(w`float depthSample = texture(depthTexture, uv).r;
if (depthSample != 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),s}const w3=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:Ef,build:nC},Symbol.toStringTag,{value:"Module"}));let G0=class extends Bt{constructor(e,t){super(e,t,new qt(w3,()=>X(()=>Promise.resolve().then(()=>j4),void 0,import.meta.url)))}initializePipeline(){return Qt({blending:Rg($t.SRC_ALPHA,$t.ONE_MINUS_SRC_ALPHA),depthTest:{func:Zi.ALWAYS},colorWrite:ti})}},J_=class extends Yr{constructor(){super(...arguments),this.requireGeometryDepth=!0,this._compositingPassParameters=new Ef,this._vao=null,this._passParameters=new b3,this._configuration=new aC}initialize(){this.techniques.precompile(Bm,this._configuration),this.techniques.precompile(G0),this._configuration.reduced=!0,this.techniques.precompile(Bm,this._configuration),this._configuration.reduced=!1,this.addHandles([O(()=>this.view.environment.background,e=>{const t=e instanceof Mw?jg(e.color):ur;ce(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])},Be),O(()=>{var e,t;return(t=(e=this.view._stage)==null?void 0:e.renderer)==null?void 0:t.fullResolutionAtmosphere},e=>this._configuration.reduced=!e,Be),O(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Be)])}destroy(){this._vao=We(this._vao)}render(e){const t=e.find(({name:g})=>g===ge.OPAQUE_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext;this._vao??(this._vao=Sn(i,na.Pos2Tex));const r=t.getAttachment(i.gl.DEPTH_STENCIL_ATTACHMENT);this._update();const a=this.techniques.get(Bm,this._configuration);if(!a.compiled)return this.requestRender(Ce.UPDATE),t;if(!this._configuration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(a,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(bi.TRIANGLE_STRIP,0,4),t.attachDepth(r),t;const n=this.techniques.get(G0);if(!n.compiled)return this.requestRender(Ce.UPDATE),t;const o=i.getViewport(),l=this.bindParameters.camera,h=we(l.eye)-os.radius;let u;const d=os.atmosphereHeight;if(h<d){const g=Math.min(1,Math.max(0,h/d));u=ze(.2,.3,g)}else{const g=Math.min(1,Math.max(0,(h-d)/(15*d)));u=ze(.3,.6,g)}const p=dc(Math.round(u*l.fullViewport[2])),_=dc(Math.round(u*l.fullViewport[3]));i.setViewport(0,0,p,_);const f=this.fboCache.acquire(p,_,"chapman",di.RGBA);return i.bindFramebuffer(f.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(a,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(bi.TRIANGLE_STRIP,0,4),i.setViewport(o.x,o.y,o.width,o.height),this._compositingPassParameters.color=f.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(r),f.release(),t}_update(){var o;const e=this.bindParameters.camera,t=Zs(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]**2,a=Q((i-this._passParameters.radii[0])/os.atmosphereHeight,0,1);vn(this._passParameters.heightParameters,i,t,r,a);const n=((o=this.view.basemapTerrain)==null?void 0:o.getLowerBoundRadius())??0;xo(this._passParameters.radii,n,n+os.atmosphereHeight),this._passParameters.innerFadeDistance=2*Math.sqrt((2*n-bv)*bv),this._passParameters.altitudeFade=hf(i-n)}};J_=c([F("esri.views.3d.environment.ChapmanAtmosphere")],J_);function oC(){const s=new kt,{fragment:e}=s;return s.include(Dp,{needUVs:!1,needEyeDirection:!1}),e.include(R1),e.include(Yg),s.include(M2,{pbrMode:Wt.Disabled,lightingSphericalHarmonicsOrder:2}),s.include(LP),s.include(bp),s.include(hP),e.uniforms.add(new gn("cameraPosition",t=>t.camera.eye),new D1("cloudsOpacity",t=>t.clouds.opacity)).main.add(w`vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4(cloudsOpacity * cloudsColor.rgb, cloudsColor.a);`),s}const x3=Object.freeze(Object.defineProperty({__proto__:null,build:oC},Symbol.toStringTag,{value:"Module"}));let B0=class extends Bt{constructor(e,t){super(e,t,new qt(x3,()=>X(()=>Promise.resolve().then(()=>W4),void 0,import.meta.url)))}initializePipeline(){return Qt({blending:Ac($t.ONE,$t.ZERO,$t.SRC_ALPHA,$t.ONE),depthTest:{func:Zi.LEQUAL},colorWrite:ti})}},eg=class extends Yr{constructor(e){super(e),this._planetRadius=Dt(e.view.spatialReference).radius}initialize(){this.techniques.precompile(B0),this.addHandles([O(()=>this.view.environment.weather!=null&&this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),at)])}destroy(){this._vao=We(this._vao)}render(e){const t=e.find(({name:o})=>o===ge.OPAQUE_ENVIRONMENT),i=this.bindParameters.clouds;if(!i.data)return t;const r=this.techniques.get(B0);if(!r.compiled)return this.requestRender(Ce.UPDATE),t;const a=this.renderingContext;this._vao??(this._vao=Sn(a));const n=a.bindTechnique(r,this.bindParameters);return a.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),a.drawArrays(bi.TRIANGLE_STRIP,0,4),i.isFading&&this.requestRender(Ce.UPDATE),t}};eg=c([F("esri.views.3d.environment.CloudsComposition")],eg);let Of=class extends Ii{constructor(){super(...arguments),this.color=v(),this.strength=4e-6,this.atmosphereC=1,this.amount=0}};function lC(){const s=new kt;s.include(Dp,{needUVs:!0,needEyeDirection:!0});const e=s.fragment;return e.uniforms.add(new Ze("atmosphereC",t=>t.atmosphereC),new gn("cameraPosition",t=>t.camera.eye),new br("depthTexture",t=>t.mainDepth),new Ze("fogStrength",t=>t.strength),new Ze("fogAmount",t=>t.amount),new on("fogColor",t=>t.color)),s.include(bp),e.include(Ep),e.include(Eg),e.include(xp),e.code.add(w`float getFogAmount(float dist, vec3 rayDir) {
if(dist == -1.0){
dist = 0.055 * sphereIntersect(cameraPosition, rayDir, atmosphereC).y;
}
return fogAmount * (1.0 - exp(-dist * fogStrength));
}`),e.main.add(w`vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
float depthSample = depthFromTexture(depthTexture, uv);
if(depthSample < 1.0 && depthSample > 0.0){
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= linearizeDepth(depthSample);;
terrainDepth = max(0.0, length(cameraSpaceRay));
}
float fogAmount = getFogAmount(terrainDepth, rayDir);
vec4 fog = vec4(fogColor, 1.0) * fogAmount;
fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));`),s}const C3=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:Of,build:lC},Symbol.toStringTag,{value:"Module"}));let q0=class extends Bt{constructor(e,t){super(e,t,new qt(C3,()=>X(()=>Promise.resolve().then(()=>Q4),void 0,import.meta.url)))}initializePipeline(){return Qt({blending:Ac($t.SRC_ALPHA,$t.ZERO,$t.ONE_MINUS_SRC_ALPHA,$t.ONE),colorWrite:ti})}},Kh=class extends Yr{constructor(){super(...arguments),this.consumes={required:[ge.TRANSPARENT_ENVIRONMENT]}}_enable(){this.produces=ge.TRANSPARENT_ENVIRONMENT,this.requestRender(Ce.UPDATE)}};c([m()],Kh.prototype,"consumes",void 0),Kh=c([F("esri.views.3d.webgl-engine.effects.TransparentEnvironment")],Kh);const T3=.95,S3=1;let tg=class extends Kh{constructor(e){super(e),this.requireGeometryDepth=!0,this._newParameters=new qm,this._oldParameters=new qm,this._fadedParameters=new qm,this._parameters=this._newParameters,this._passParameters=new Of;const t=Dt(e.view.spatialReference);this._planetRadius=t.radius,this._atmosphereRadius=t.radius+t.atmosphereHeight,e.view._stage.renderView.techniques.precompile(q0)}toogle(){this.view.environment.atmosphereEnabled&&this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([O(()=>this.view.environment.atmosphereEnabled,()=>this.toogle(),Be),O(()=>this.view.environment.weather,()=>this.toogle(),Be),O(()=>this._updateFogParameters(),()=>{},Be)]),this.addHandles(O(()=>this._fadeFactor,e=>this._fade(e),Be))}get _fadeFactor(){var e;return((e=this.view._stage)==null?void 0:e.renderer.renderContext.bind.clouds.fadeFactor)??1}_fade(e){const{_newParameters:t,_oldParameters:i}=this;e>=1?(this._parameters=t,this._oldParameters.copyFrom(this._newParameters)):e<=0?this._parameters=i:(this._fadedParameters.lerp(i,t,e),this._parameters=this._fadedParameters)}_updateFogParameters(){const e=this.view.environment.weather,t=e.type==="foggy"||e.type==="snowy"||e.type==="rainy";this._newParameters.strength=e.type==="foggy"?ze(3e-5,.005,e.fogStrength**3):e.type==="snowy"||e.type==="rainy"?ze(4e-6,2e-4,(e.precipitation??0)**3):0,this._newParameters.amount=t?1:0,e.type!=="foggy"&&e.type!=="snowy"||le(this._newParameters.color,E3),e.type==="rainy"&&le(this._newParameters.color,P3),this._fadeFactor>=1&&this._oldParameters.copyFrom(this._newParameters),this.requestRender(Ce.UPDATE)}render(e){const t=e.find(({name:n})=>n===ge.TRANSPARENT_ENVIRONMENT);if(this._parameters.amount===0||(this._update(),this._passParameters.amount<=0))return t;const i=this.techniques.get(q0);if(!i.compiled)return this.requestRender(Ce.UPDATE),t;const r=this.renderingContext,a=t.getAttachment(r.gl.DEPTH_STENCIL_ATTACHMENT);return t.attachDepth(null),r.bindFramebuffer(t.fbo),r.bindTechnique(i,this.bindParameters,this._passParameters),r.screen.draw(),t.attachDepth(a),t}_update(){const e=this.bindParameters.camera;ie(k0,e.eye);const t=Math.max(0,oe(k0,this.bindParameters.lighting.mainLight.direction)),i=this._parameters.color;ee(j0,i,.1),Tr(this._passParameters.color,j0,i,t);const r=we(e.eye);this._passParameters.atmosphereC=r**2-this._atmosphereRadius**2,this._passParameters.amount=(1-ac(T3*b_,S3*b_,Math.abs(r-this._planetRadius)))*this._parameters.amount,this._passParameters.strength=this._parameters.strength}};tg=c([F("esri.views.3d.environment.Fog")],tg);let qm=class{constructor(){this.color=v(),this.strength=0,this.amount=0}copyFrom(e){this.amount=e.amount,this.strength=e.strength,le(this.color,e.color)}lerp(e,t,i){this.amount=ze(e.amount,t.amount,i),this.strength=ze(e.strength,t.strength,i),Tr(this.color,e.color,t.color,i)}};const k0=v(),j0=v(),P3=Vt(.5,.5,.5),E3=Vt(1.5,1.5,1.5);var Cr;(function(s){s[s.Cone=0]="Cone",s[s.Cylinder=1]="Cylinder",s[s.Underground=2]="Underground",s[s.COUNT=3]="COUNT"})(Cr||(Cr={}));let Mf=class extends A1{constructor(){super(...arguments),this.geometry=Cr.Cone}};c([ne({count:Cr.COUNT})],Mf.prototype,"geometry",void 0);let $p=class extends Ii{constructor(){super(...arguments),this.texV=Ts(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new Rf}},Rf=class{constructor(){this.center=v(),this.v1=v(),this.v2=v()}};function hC(s){const e=new kt,{vertex:t,fragment:i}=e;if(Tp(t),s.geometry===Cr.Underground)e.attributes.add(De.POSITION,"vec2"),e.varyings.add("color","vec4"),t.uniforms.add(new gn("cameraPosition",r=>r.camera.eye),new Ze("undergroundFadeAlpha",r=>r.undergroundFadeAlpha)),t.main.add(w`float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);`),i.main.add(w`fragColor = color;`);else{e.include(bw,s),e.attributes.add(De.POSITION,"vec3"),e.varyings.add("vtc","vec2"),e.varyings.add("falloff","float");const r=s.geometry===Cr.Cylinder;t.uniforms.add(new bn("proj",o=>o.camera.projectionMatrix),new bn("view",o=>o.camera.viewMatrix)),r||(e.varyings.add("innerFactor","float"),t.uniforms.add(new on("silCircleCenter",o=>o.silhouette.center)),t.uniforms.add(new on("silCircleV1",o=>o.silhouette.v1)),t.uniforms.add(new on("silCircleV2",o=>o.silhouette.v2)),t.uniforms.add(new ra("texV",o=>o.texV)),t.uniforms.add(new Ze("innerScale",o=>o.innerScale)));const a=6.2831853,n=1/128;t.main.add(w`
      ${r?w`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:w`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${w.float(a*n)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${w.float(n)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
	  `),i.uniforms.add(new ft("tex",o=>o.texture)),r||i.uniforms.add(new Ze("altitudeFade",o=>o.altitudeFade)),i.main.add(w`
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${r?w`fragColor = atmosphereColor;`:w`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));`}`)}return e}const O3=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:Rf,SimpleAtmospherePassParameters:$p,build:hC},Symbol.toStringTag,{value:"Module"}));let fl=class extends Bt{constructor(e,t){super(e,t,new qt(O3,()=>X(()=>Promise.resolve().then(()=>Y4),void 0,import.meta.url)))}initializePipeline(e){const t=e.geometry===Cr.Cylinder;return Qt({blending:Dc,culling:t?V1:void 0,depthTest:{func:Zi.LEQUAL},colorWrite:ti})}};const M3=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);let ig=class extends Yr{constructor(){super(...arguments),this._configuration=new Mf,this._passParameters=new $p,this._vao=null,this._vaoCount=0}initialize(){this._configuration.geometry=Cr.Cylinder,this.addHandles([O(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),at)])}destroy(){this._passParameters.texture=We(this._passParameters.texture),this._vao=We(this._vao)}precompile(){this.techniques.precompile(fl,this._configuration)}render(e){const t=e.find(({name:n})=>n===ge.OPAQUE_ENVIRONMENT),i=this.techniques.get(fl,this._configuration);if(!i.compiled)return this.requestRender(Ce.UPDATE),t;const r=this.renderingContext;if(this._vao||(this._vao=R3(r),this._vaoCount=$l(this._vao,"geometry")),!this._passParameters.texture){const n=new mi;n.wrapMode=Ki.CLAMP_TO_EDGE,n.flipped=!0,n.width=1,n.height=512,this._passParameters.texture=new oi(r,n,M3)}const a=r.bindTechnique(i,this.bindParameters,this._passParameters);return A3(W0,this.bindParameters.camera.viewMatrix),a.setUniformMatrix4fv("view",W0),r.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(bi.TRIANGLES,0,this._vaoCount),t}};function R3(s){const e=y2(1,2,!1),{data:t,indices:i}=e[0][1],r=Q0.createBuffer(i.length),a=r.position;for(let n=0;n<i.length;++n){const o=3*i[n%3==0?n+2:n%3==2?n-2:n];a.set(n,0,t[o]),a.set(n,1,t[o+1]),a.set(n,2,t[o+2])}return new Tn(s,Bl,new Map([["geometry",Fa(Q0)]]),new Map([["geometry",$s.createVertex(s,wr.STATIC_DRAW,r.buffer)]]))}function A3(s,e){Rc(s,e),s[12]=0,s[13]=0,s[14]=0,s[15]=1}ig=c([F("esri.views.3d.environment.LocalAtmosphere")],ig);const W0=It(),Q0=Cn().vec3f(De.POSITION),D3=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),Vu=128,Y0=-1e4,Z0=0,km=50,$3=()=>1-511/512,I3=Wu([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let sg=class extends Yr{constructor(e){super(e),this._passParameters=new $p,this._configuration=new Mf,this._vao=null,this._vaoCount=0,this._fadeVao=null,this._fadeVaoCount=0,this._texV1=1;const t=e.view,i=Dt(t.spatialReference),{outerAtmosphereRimWidth:r,radius:a}=i;this._planetRadius=a,this._innerRimFactor=1+Y0/a,this._middleRimFactor=1+Z0/a,this._outerRimFactor=1+r/a,this._texV0=Z0/r,this._texVScale=this._texV1-this._texV0;const n=t._stage.renderView.techniques;n.precompile(fl,this._configuration),this._configuration.geometry=Cr.Underground,n.precompile(fl,this._configuration)}initialize(){this.addHandles(O(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),at))}destroy(){this._passParameters.texture=We(this._passParameters.texture),this._fadeVao=We(this._fadeVao),this._vao=We(this._vao)}render(e){const t=e.find(({name:r})=>r===ge.OPAQUE_ENVIRONMENT);this._update();const i=this.renderingContext;if(!this._passParameters.texture){const r=new mi;r.wrapMode=Ki.CLAMP_TO_EDGE,r.flipped=!0,r.width=1,r.height=512,this._passParameters.texture=new oi(i,r,D3)}if(this._passParameters.undergroundFadeAlpha<1){this._vao||(this._vao=this._createRibbon(i),this._vaoCount=$l(this._vao,"geometry")),this._configuration.geometry=Cr.Cone;const r=this.techniques.get(fl,this._configuration);if(!r.compiled)return this.requestRender(Ce.UPDATE),t;i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(bi.TRIANGLES,0,this._vaoCount)}if(this._passParameters.undergroundFadeAlpha>0){this._fadeVao||(this._fadeVao=Sn(i),this._fadeVaoCount=$l(this._fadeVao,"geometry")),this._configuration.geometry=Cr.Underground;const r=this.techniques.get(fl,this._configuration);if(!r.compiled)return this.requestRender(Ce.UPDATE),t;i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._fadeVao),i.drawArrays(bi.TRIANGLE_STRIP,0,this._fadeVaoCount)}return t}_update(){const e=this.bindParameters.camera,t=v(),i=this._planetRadius,r=we(e.eye),a=r-i;if(a<0){const _=Math.min(-a/5e3,1);this._passParameters.undergroundFadeAlpha=_}else this._passParameters.undergroundFadeAlpha=0;const n=Math.max(km,a),o=i+Y0;this._passParameters.innerScale=L3(i+n,i,o)-1,this._passParameters.altitudeFade=hf(a),ee(t,e.eye,(i+km)/r),X0(t,e.center,e.up,i,this._passParameters.silhouette);const l=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),h=$3(),u=I3(a);let d=this._texV0+h*this._texVScale,p=this._texV0+l*u*this._texVScale;if(a>km){X0(e.eye,e.center,e.up,i,this._passParameters.silhouette);const _=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),f=Q((_-1.5)/(l-1.5),0,1);d=this._texV0+f*h*this._texVScale,p=this._texV0+ze(this._texV1,l*u,f)*this._texVScale}xo(this._passParameters.texV,d,p)}_createRibbon(e){const t=$1(3+3*Vu*3),i=new Uint32Array(3*Vu*5);t[0]=0,t[1]=0,t[2]=-1;for(let n=0;n<Vu;n++){const o=9*n+3;t[o]=n,t[o+1]=this._innerRimFactor,t[o+2]=-1,t[o+3]=n,t[o+4]=this._middleRimFactor,t[o+5]=0,t[o+6]=n,t[o+7]=this._outerRimFactor,t[o+8]=1;const l=3*n+1,h=n===Vu-1?1:l+3,u=15*n;i[u]=l,i[u+1]=l+1,i[u+2]=h+1,i[u+3]=h+1,i[u+4]=h,i[u+5]=l,i[u+6]=l+1,i[u+7]=l+2,i[u+8]=h+2,i[u+9]=h+2,i[u+10]=h+1,i[u+11]=l+1,i[u+12]=l,i[u+13]=h,i[u+14]=0}const r=K0.createBuffer(i.length),a=r.position;for(let n=0;n<i.length;++n){const o=3*i[n];a.set(n,0,t[o]),a.set(n,1,t[o+1]),a.set(n,2,t[o+2])}return new Tn(e,Bl,new Map([["geometry",Fa(K0)]]),new Map([["geometry",$s.createVertex(e,wr.STATIC_DRAW,r.buffer)]]))}_computeScreenRimWidth(e,t,i,r){return ue(Zo,r.center,r.v2),ee(Fu,Zo,this._outerRimFactor),CP(jm,t,Zo,i),Cy(Zo,jm,e.projectionMatrix,e.viewport,Zo),Cy(Fu,jm,e.projectionMatrix,e.viewport,Fu),vi(Zo,Fu)/e.height}};function X0(s,e,t,i,r){const a=we(s),n=i*Math.sqrt(a*a-i*i)/a,o=Math.sqrt(i*i-n*n),l=r.v1,h=r.v2;return ee(r.center,s,o/a),pt(l,s,e),Zs(l)<1&&pt(l,s,t),ee(l,l,n/we(l)),pt(h,l,s),ee(h,h,n/we(h)),n}sg=c([F("esri.views.3d.environment.MarsAtmosphere")],sg);const jm=It(),Zo=v(),Fu=v();function L3(s,e,t){return s*s/(Math.sqrt(s*s-e*e)*Math.sqrt(s*s-t*t)+e*t)}const K0=Cn().vec3f(De.POSITION),N3=sg;let V3=class{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return this._indexRanges.length===0}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;{const t=this._indexRanges;let i=0,r=t.length/2;if(e<t[2*i]||e>t[2*r]+t[2*r+1])return!1;for(;r-i>0;){const a=Math.floor(.5*(i+r)),n=t[2*a];if(e<n){if(r-i==1)return!1;r=a;continue}if(e<n+t[2*a+1])return!0;if(r-i==1)return!1;i=a+1}return!1}}get componentCount(){if(this._componentCountCache===-1){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];this._componentCountCache=t}return this._componentCountCache}reset(e){e==="all"||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=F3(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],a=r+t[i+1];for(let n=r;n<a;n++)if(!e(n))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const a=i[r],n=a+i[r+1],o=e[a],l=e[n];t[r]=o,t[r+1]=l-o}return t}};function F3(s){const e=new Array;if(s.length===0)return e;let t=s[0],i=1;for(let r=1;r<s.length;r++){const a=s[r];t+i===a?i+=1:(e.push(t),e.push(i),t=a,i=1)}return e.push(t),e.push(i),e}let U3=class{constructor(e,t){this.offsets=t,this._highlightsInOrder=[],this.pickability=null,this.componentHighlights=new Map,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRangesMap=null,this.cachedShadowmapRanges=null;const i=this.count;this.visibility=new V3(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let r=0;r<i;r++)this.materialDataIndices[r]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return this.cachedGeometryRanges==null&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRangesMap(){return this.componentHighlights.size===0?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRangesMap)}get shadowmapRanges(){return this.componentHighlights.size===0?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedShadowmapRanges)}markHighlightsDirty(){this.cachedHighlightRangesMap=null,this.cachedShadowmapRanges=null}markVisibilityDirty(){this.cachedGeometryRanges=null,this.markHighlightsDirty()}updateHighlights(e){this._updateHighlightOrder(e)&&(this.markHighlightsDirty(),this._updateCachedHighlightRanges())}_updateHighlightOrder(e){const{_highlightsInOrder:t}=this;let i=t.length!==e.length;t.length=Math.min(e.length,8);for(let r=0;r<e.length;++r){const a=e.at(r).name;t.length<r?(i=!0,t.push(a)):t[r]!==a&&(t[r]=a,i=!0)}return i}_updateCachedHighlightRanges(){if(this.cachedHighlightRangesMap==null||this.cachedShadowmapRanges==null){const{highlightRangesMap:e,shadowmapRangesMap:t}=H3(this.componentHighlights,this.visibility,this.offsets,this._highlightsInOrder);this.cachedHighlightRangesMap=e,this.cachedShadowmapRanges=t}}};function H3(s,e,t,i){const r=new Map,a=[];if(s.size>0){let n=t.length;e.forEachComponent(o=>{let l=!1;for(let h=i.length-1;h>=0;--h){const u=i[h],d=s.get(u);if(((d==null?void 0:d[o])??0)>0){const p=pg(r,u,()=>[]),_=t[o],f=t[o+1];p.push(_),p.push(f-_),l||(l=u===nn);break}}return l||(n!==o-1&&(a.length>0&&a.push(t[n+1]-a[a.length-1]),a.push(t[o])),n=o),!0}),a.length>0&&a.push(t[n+1]-a[a.length-1])}return{highlightRangesMap:r,shadowmapRangesMap:a}}let z3=class{constructor(e,t,i,r,a,n){this.transform=e,this.toMapSpace=t,this.obb=i,this.componentData=r,this.renderable=a,this.intersectionGeometry=n,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=se(this.intersectionGeometry),this.renderable=se(this.renderable),this.componentData=se(this.componentData)}};function G3(s,e,t,i,r,a,n){const o=a-n,l=e-s,h=new Float64Array(4*l);for(let u=0;u<l;++u){const d=3*(u+s),p=r*t[d+0],_=i[p+0],f=i[p+1],g=o/(i[p+2]-n),y=_*g,b=f*g,x=r*t[d+1],C=i[x+0],T=i[x+1],P=o/(i[x+2]-n),S=C*P,E=T*P,M=r*t[d+2],$=i[M+0],B=i[M+1],k=o/(i[M+2]-n),H=$*k,Y=B*k,A=4*u;h[A+0]=Math.min(y,S,H),h[A+1]=Math.min(b,E,Y),h[A+2]=Math.max(y,S,H),h[A+3]=Math.max(b,E,Y)}return h}function B3(s,e,t,i,r){const a=e-s,n=new Float64Array(4*a);for(let o=0;o<a;++o){const l=3*(o+s),h=r*t[l+0],u=i[h+0],d=i[h+1],p=r*t[l+1],_=i[p+0],f=i[p+1],g=r*t[l+2],y=i[g+0],b=i[g+1],x=4*o;n[x+0]=Math.min(u,_,y),n[x+1]=Math.min(d,f,b),n[x+2]=Math.max(u,_,y),n[x+3]=Math.max(d,f,b)}return n}function q3(s,e){return new(k3(s))(e)}function k3(s){return s<128?Uint8Array:s<32768?Uint16Array:s<1<<31?Uint32Array:Array}let cC=class{constructor(e,t){this.elementCount=e,this.model=t,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=t.localMode,this.planetCenterZ=t.planetCenterZ,this.geometryMinZ=t.geometryMinZ,this.planetCenter=Vt(0,0,this.planetCenterZ),this.maxBspNodeDepth=t.maxBspNodeDepth??8,this.minElementCountForBVH=t.minElementCountForBVH??15,this.minBspNodeElementCount=t.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||this._bspNodes.length===0&&this._generateBsp()}intersectRay(e,t,i){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(i):this._intersectRayWithBVH(e,t,i))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,t){this.model.intersectRange(e,t)}_intersectRayWithBVH(e,t,i){this._ensureBVH(),i?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}_intersectGeometryWithBVHVerticalRay(e){let t=e[0],i=e[1];if(!this.localMode){const{geometryMinZ:n,planetCenterZ:o}=this,l=(n-o)/(e[2]-o);t=e[0]*l,i=e[1]*l}const{_bspNodes:r}=this;let a=0;for(;a>=0;){const n=r[a],{d:o,dim:l,minIndexIndex:h,minMidIndexIndex:u,maxMidIndexIndex:d,maxIndexIndex:p,aabb2D:_}=n;if(t<_[0]||t>_[2]||i<_[1]||i>_[3])break;if(l===-1||n.child0===-1&&n.child1===-1){this._intersectRange(h,p);break}{this._intersectRange(u,d);const f=(l===0?t:i)-o;if(f<0){if(n.child0===-1){this._intersectRange(h,u);break}a=n.child0}else{if(!(f>0))break;if(n.child1===-1){this._intersectRange(d,p);break}a=n.child1}}}}_intersectGeometryWithBVHGeneralRay(e,t){let i=e[0],r=e[1],a=t[0],n=t[1];const{geometryMinZ:o}=this;if(!this.localMode){let f=0,g=1;const y=Math.min(.5*this.planetCenterZ,o),b=e[2],x=t[2];if(b<y&&x<y||(b<y&&(f=(y-b)/(x-b)),x<y&&(g=(y-b)/(x-b)),f>g))return;const C=(1-f)*e[0]+f*t[0],T=(1-f)*e[1]+f*t[1],P=(1-f)*e[2]+f*t[2],S=(1-g)*e[0]+g*t[0],E=(1-g)*e[1]+g*t[1],M=(1-g)*e[2]+g*t[2],{planetCenterZ:$}=this,B=o-$,k=B/(P-$);i=C*k,r=T*k;const H=B/(M-$);a=S*H,n=E*H}const l=a-i,h=n-r,u=this._bspNodes;let d=1;{const{aabb2D:f}=u[0],g=(x,C,T,P)=>{if(Math.abs(C)<1e-5*Math.max(P-T,1))return!1;const S=C>0,E=S?P:T,M=x+d*C;return(S?M<E:M>E)&&(d=Math.max((E-x)/C,d),!0)},y=()=>g(i,l,f[0],f[2]),b=()=>g(r,h,f[1],f[3]);Math.abs(l)>=Math.abs(h)?y()||b():b()||y()}const p=[0,0,d];let _=0;for(;_<p.length;){const f=p[_];let g=p[_+1],y=p[_+2];if(_+=3,g>y)continue;const b=u[f],{minIndexIndex:x,maxIndexIndex:C}=b,{child0:T,child1:P,minMidIndexIndex:S,maxMidIndexIndex:E,aabb2D:M,d:$,dim:B}=b;{const k=i+g*l,H=i+y*l,Y=Math.min(k,H),A=Math.max(k,H),R=M[0],W=M[2];if(A<R||W<Y)continue;if(Y<R){const U=(R-i)/l;l>0?g=Math.max(g,U):y=Math.min(y,U)}if(W<A){const U=(W-i)/l;l>0?y=Math.min(y,U):g=Math.max(g,U)}}{const k=r+g*h,H=r+y*h,Y=Math.min(k,H),A=Math.max(k,H),R=M[1],W=M[3];if(A<R||W<Y)continue;if(Y<R){const U=(R-r)/h;h>0?g=Math.max(g,U):y=Math.min(y,U)}if(W<A){const U=(W-r)/h;h>0?y=Math.min(y,U):g=Math.max(g,U)}}if(T===-1&&P===-1)this._intersectRange(x,C);else{const k=B===0?i:r,H=B===0?l:h,Y=k+g*H,A=k+y*H,R=Math.min(Y,A),W=Math.max(Y,A),U=Q(($-k)/H,0,d);x<S&&R<=$&&(T!==-1?(p.push(T),p.push(H>=0?g:Math.max(g,U)),p.push(H>=0?Math.min(y,U):y)):this._intersectRange(x,S)),this._intersectRange(S,E),E<C&&$<=W&&(P!==-1?(p.push(P),p.push(H>=0?Math.max(g,U):g),p.push(H>=0?y:Math.min(y,U))):this._intersectRange(E,C))}}}_generateBsp(){const{elementCount:e}=this;if(e<1)return;const t=q3(e,e);this._elementIndexMap=t;for(let _=0;_<e;++_)t[_]=_;const i=this.model.getAabbs2D();let r=0;const a=this._bspNodes;a.length=0;const{localMode:n}=this;let o=!1;if(!n){const{planetCenterZ:_,geometryMinZ:f}=this;o=_>=0||f<.5*_}const l=[],h=(_,f,g,y,b)=>{l.push(_),l.push(f),l.push(g),l.push(y<0?-1:(b?0:1)+2*y)},{maxBspNodeDepth:u,minBspNodeElementCount:d}=this,p=(_,f,g,y,b)=>{const x=a.length;if(x>0&&(o||g>=u||f-_<d))return;const C=[0,0,0,0];Y3(C,_,f,t,i);const{d:T,dim:P}=n?j3(C):W3(C),{rangeMidStart:S,rangeMidEnd:E}=Q3(_,f,P,T,t,i),M=g===u-1,$=!M&&S>=_+d,B=!M&&f>=E+d;if($||B||x===0){const k=new Z3(_,S,E,f,P,T,C);if($&&h(_,S,g+1,x,!0),B&&h(E,f,g+1,x,!1),a.push(k),y!==-1){const H=a[y];b?H.child0=x:H.child1=x}}};for(h(0,e,0,-1,!1);r<l.length;){const _=l[r],f=l[r+1],g=l[r+2],y=l[r+3];r+=4;const b=y>>1;p(_,f,g,b,y-(b<<1)==0)}this._generatedBVH=!0}};function j3(s){const e=s[0],t=s[1],i=s[2],r=s[3];let a,n;return i-e>=r-t?(n=.5*(e+i),a=0):(n=.5*(t+r),a=1),{d:n,dim:a}}function W3(s){const e=s[0],t=s[1],i=s[2],r=s[3];let a,n;return i-e>=r-t?(a=0,n=.5*(e+i)):(a=1,n=.5*(t+r)),{dim:a,d:n}}function Q3(s,e,t,i,r,a){let n=s;{let u=e;for(;n<u;){const d=r[n];J0(d,t,i,a)<0?++n:(--u,r[n]=r[u],r[u]=d)}}const o=n;let l=n,h=e;for(;l<h;){const u=r[h-1];J0(u,t,i,a)>0?--h:(r[h-1]=r[l],r[l]=u,++l)}return{rangeMidStart:o,rangeMidEnd:h}}function J0(s,e,t,i){const r=4*s,a=i[r+0+e];return i[r+2+e]<t?-1:a>t?1:0}function Y3(s,e,t,i,r){let a=1/0,n=1/0,o=-1/0,l=-1/0;for(let h=e;h<t;++h){const u=4*i[h];a=Math.min(a,r[u+0]),n=Math.min(n,r[u+1]),o=Math.max(o,r[u+2]),l=Math.max(l,r[u+3])}s[0]=a,s[1]=n,s[2]=o,s[3]=l}let Z3=class{constructor(e,t,i,r,a,n,o){this.minIndexIndex=e,this.minMidIndexIndex=t,this.maxMidIndexIndex=i,this.maxIndexIndex=r,this.dim=a,this.d=n,this.aabb2D=o,this.child0=-1,this.child1=-1}},X3=class{constructor(e,t,i,r,a,n,o,l,h){this.componentIndex=e,this.vertexData=t,this.vertexStride=i,this.indexData=r,this.startTriangleNumber=a,this.endTriangleNumber=n,this.geometryMinZ=o,this.planetCenterZ=l,this.localMode=h,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=v(),this.ray0=v(),this.isVerticalRay=!1,this._triangleHitCallback=eb,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new cC(n-a,this)}getAabbs2D(){return this.localMode?B3(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):G3(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,t,i,r,a,n){le(this.ray0,e),Mt(this.rayDirection,t,e),this.isVerticalRay=i,this.totalElevationOffset=r,this.normalRequired=n,this._triangleHitCallback=a,this._bvh.intersectRay(e,t,i),this._triangleHitCallback=eb}intersectRange(e,t){const i=this._bvh.elementIndexMap;uC(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,i,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}};function uC(s,e,t,i,r,a,n,o,l,h,u,d=null,p=0){o!==0?KO(s,e,t,i,r,a,n,o,l,h,u,d,p):dw(s,e,t,i,r,a,n,h,u,d,p)}function eb(){}function K3(s,e,t,i){if(t>=e)return s;s==null&&(s=J3());const r=s.isVisibleBit;let a=s.data;const n=dC(a),o=t/n|0,l=t-n*o,h=(e-1)/n|0,u=a,d=i===r;if(!(t<u.length*n)&&d){const p=o+1,_=Math.ceil(u.length*tT),f=h+1;let g=Math.max(p,_);g=Math.min(g,f),a=new Uint32Array(g),a.set(u)}return o<a.length&&(a[o]=tN(a[o],l,d)),s.data=a,s}function rg(s,e){if(s==null)return!0;const{isVisibleBit:t,data:i}=s,r=dC(i);return e<i.length*r?eN(t,i,e,r):!s.isVisibleBit}function J3(s=!0){return{isVisibleBit:!s,data:new Uint32Array(0)}}function eN(s,e,t,i){const r=t/i|0,a=t-r*i;return iN(e[r],a)===s}function dC(s){return s.BYTES_PER_ELEMENT*8}function tN(s,e,t){return s&~(1<<e)|(t?1:0)<<e}function iN(s,e){return!!(s&1<<e)}let sN=class{constructor(e,t,i,r,a,n,o,l){this.vertexData=e,this.vertexStride=t,this.indexData=i,this._components=r,this._componentAabbs3D=a,this.geometryMinZ=n,this.planetCenterZ=o,this.localMode=l,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=oN,this._ray1=lN,this._invDir=v(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=hN,this._callback=tb,this.rayDirectionC=v(),this._componentIndexMap=null,this._bvh=new cC(r.count,this),this.componentIntersectionData=new Array(r.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:e,planetCenterZ:t,minZGlobal:i}=this,r=new Float64Array(4*e),a=this._componentAabbs3D;for(let n=0;n<e;++n){const o=6*n,l=a[o+0],h=a[o+1],u=a[o+2],d=a[o+3],p=a[o+4],_=i/(u-t),f=i/(a[o+5]-t),g=Math.min(l*_,l*f),y=Math.min(h*_,h*f),b=Math.max(d*_,d*f),x=Math.max(p*_,p*f),C=4*n;r[C+0]=g,r[C+1]=y,r[C+2]=b,r[C+3]=x}return r}getAabbs2DLocal(){const{numComponents:e}=this,t=new Float64Array(4*e),i=this._componentAabbs3D;for(let r=0;r<e;++r){const a=6*r,n=i[a+0],o=i[a+1],l=i[a+3],h=i[a+4],u=4*r;t[u+0]=n,t[u+1]=o,t[u+2]=l,t[u+3]=h}return t}intersectRay(e,t,i,r,a,n,o){const{isVerticalRay:l}=o;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=i,this._verticalOffset=r,this._tolerance=n,this._intersectionOptions=o,this._componentIndexMap=this._bvh.elementIndexMap,JO(e,t,this._invDir),this._callback=a,this._bvh.intersectRay(e,t,l),this._callback=tb}intersectRange(e,t){const i=this._componentIndexMap,r=this._components,a=r.pickability,n=r.visibility;for(let o=e;o<t;++o){const l=i?i[o]:o;rg(a,l)&&n.isVisible(l)&&this._intersectComponent(l)}}getComponentTriangleCount(e){const t=this._components.offsets,i=t[e]/3;return t[e+1]/3-i}getComponentAabb3D(e,t){const i=this._componentAabbs3D,r=6*e;return t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],t[3]=i[r+3],t[4]=i[r+4],t[5]=i[r+5],t}_intersectComponent(e){if(!rg(this._components.pickability,e))return;const t=this.getComponentAabb3D(e,rN);let i=!1;const{localMode:r,_componentVerticalOffsets:a,_verticalOffset:n,_ray0:o,_ray1:l,_invDir:h,planetCenterZ:u,_tolerance:d,rayDirectionC:p,componentIntersectionData:_}=this,{isVerticalRay:f}=this._intersectionOptions,g=this._components.offsets,y=le(aN,o),b=le(nN,l),x=(a==null?void 0:a[e])??0,C=x+((n==null?void 0:n.offset)??0);if(C!==0&&(r?(y[2]=o[2]-C,b[2]=l[2]-C,i=!0):n!=null&&(n.componentOffset=x)),n==null||i||C===0||n.applyToAabb(t),!e2(t,y,h,d))return;Mt(p,b,y);const T=g[e]/3,P=g[e+1]/3,S=P-T,E=(Y,A,R)=>{this._callback(Y,A,e,R)},{vertexData:M,vertexStride:$,indexData:B,_intersectionOptions:k}=this,{normalRequired:H}=k;if(S>cN){let Y=_[e];Y==null&&(Y=new X3(e,M,$,B,T,P,this.geometryMinZ,u,r),_[e]=Y),Y.intersectRay(y,b,f,i?0:C,E,H)}else uC(y,p,T,P,B,M,$,i?0:C,u,H,E)}};const rN=Ic(),aN=v(),nN=v(),oN=v(),lN=v(),tb=()=>{},hN=new kg,cN=40;let uN=class{constructor(e,t,i){this.viewingMode=e,this.positionData=t,this._components=i,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=v(),this._componentBvh=null,this._aabb=[0,0,0,0,0,0],this._indices=t.indices?mw(t.indices):v2(t.positions.length/3),this._positions=t.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,t){const i=this._ensureComponentAabbs(),r=6*e;return t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],t[3]=i[r+3],t[4]=i[r+4],t[5]=i[r+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,a,n,o,l){this.verticalOffset=r,this.componentVerticalOffsets=a;const{position:h}=n,u=Mt(dN,e,h),d=Mt(pN,t,h),p=Mg(mN,n.rotationScale);jr(u,u,p),jr(d,d,p);const _=Mc(gN,p);if(this.viewingMode===Ne.Global){const g=this._planetCenter;an(g,h),jr(g,g,p)}const f=(g,y,b,x)=>{l(b,g,x?jr(_N,x,_):null,y)};this._intersectComponents(u,d,a,r,f,i,o)}_computePerComponentAabbs(){const e=this._aabb,t=.5*(e[0]+e[3]),i=.5*(e[1]+e[4]),r=.5*(e[2]+e[5]),a=this._components.count,n=$1(6*a),o=this._indices,l=this._positions,h=this._components.offsets;let u=0,d=1/0,p=1/0,_=1/0,f=-1/0,g=-1/0,y=-1/0;for(let b=0;b<a;b++){const x=h[b],C=h[b+1];let T=1/0,P=1/0,S=1/0,E=-1/0,M=-1/0,$=-1/0;if(x<C)for(let B=x;B<C;B++){const k=3*o[B],H=l[k],Y=l[k+1],A=l[k+2];T=Math.min(T,H),P=Math.min(P,Y),S=Math.min(S,A),E=Math.max(E,H),M=Math.max(M,Y),$=Math.max($,A)}else T=t,P=i,S=r,E=t,M=i,$=r;n[u++]=T,n[u++]=P,n[u++]=S,n[u++]=E,n[u++]=M,n[u++]=$,d=Math.min(d,T),p=Math.min(p,P),_=Math.min(_,S),f=Math.max(f,E),g=Math.max(g,M),y=Math.max(y,$)}return this._aabb[0]=d,this._aabb[1]=p,this._aabb[2]=_,this._aabb[3]=f,this._aabb[4]=g,this._aabb[5]=y,n}_intersectComponents(e,t,i,r,a,n,o){let l=this._componentBvh;l==null&&(l=new sN(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=l),l.intersectRay(e,t,i,r,a,n,o)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return this.viewingMode===Ne.Local}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}};const dN=v(),pN=v(),mN=ia(),_N=v(),gN=ia();let fN=class{constructor(e,t,i){this.material=e,this.geometry=t,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}},yN=class{constructor(e,t,i,r){this.vao=e,this.primitiveType=t,this.parameters=i,this.indexed=r}dispose(){this.vao.dispose()}};function vN(s,e){const t=new ir,{eye:i,frustum:r,viewForward:a}=s;e.forAll(n=>{const o=n.offsetObb!=null?n.offsetObb:n.obb,l=oe(Mt(Os,o.center,i),a),h=o.projectedRadius(a);if(t.within(l-h)&&t.within(l+h))return;const u=TN(o,r);if(u===-1)return;if(u===0)return da.far=l+h,da.near=l-h,void t.union(da);const d=Uu.pushNew();d.near=l-h,d.far=l+h,d.mask=u,d.object=n});for(let n=0;n<Uu.length;n++){const o=Uu.data[n];if(t.within(o.near)&&t.within(o.far))continue;da.far=o.far,da.near=1/0,CN(o.object.offsetObb!=null?o.object.offsetObb:o.object.obb,i,bN,h=>{let u=wN;for(let d=0;d<pC&&h.length>0;d++){if(!(o.mask&1<<d))continue;xN(r[d],h,u);const p=h;h=u,u=p}for(let d=0;d<h.length;d+=3){ce(rs,h.data[d],h.data[d+1],h.data[d+2]);const p=oe(Mt(rs,rs,i),a);da.near=Math.min(da.near,p)}})===0&&(da.near=0),t.union(da)}return Uu.length=0,t}const Uu=new mt({allocator:s=>s||{near:1/0,far:-1/0,mask:0,object:null},deallocator:s=>(s.object=null,s)}),da=new ir,rs=v(),Fn=v(),bN=new mt({deallocator:null}),wN=new mt({deallocator:null});function xN(s,e,t){t.length=0;const i=e.length-3;Wm(rs,e,i);const r=yo(s,rs);r<=0&&(t.push(rs[0]),t.push(rs[1]),t.push(rs[2]));let a=0,n=r;for(;a<i;a+=3){Wm(Fn,e,a);const o=yo(s,Fn);n*o<0&&(Tr(rs,Fn,rs,o/(o-n)),as(t,rs)),o<=0&&as(t,Fn),n=o,le(rs,Fn)}n*r<0&&(Wm(Fn,e,i),Tr(rs,Fn,rs,r/(r-n)),as(t,rs))}function Wm(s,e,t){return ce(s,e.data[t],e.data[t+1],e.data[t+2])}function as(s,e){s.push(e[0]),s.push(e[1]),s.push(e[2])}function CN(s,e,t,i){zE(sb,s.quaternion),Mt(Os,e,s.center),iP(Os,Os,sb);const r=s.halfSize,a=8*((Os[0]<-r[0]?-1:Os[0]>r[0]?1:0)+3*(Os[1]<-r[1]?-1:Os[1]>r[1]?1:0)+9*(Os[2]<-r[2]?-1:Os[2]>r[2]?1:0)+13),n=ib[a];if(n===0)return n;vP(Hu,s.quaternion),C1(Hu,Hu,s.halfSize);const o=(l,h)=>{const u=ib[a+h+1];return ce(l,((1&u)<<1)-1,(2&u)-1,((4&u)>>1)-1),jr(l,l,Hu),ue(l,s.center,l)};return t.length=0,as(t,o(Qm,0)),as(t,o(rb,1)),as(t,o(Os,2)),as(t,o(ab,3)),i(t),n===1||(t.length=0,as(t,Qm),as(t,ab),as(t,o(Os,4)),as(t,o(nb,5)),i(t),n===2||(t.length=0,as(t,Qm),as(t,nb),as(t,o(Os,6)),as(t,rb),i(t))),n}const ib=(()=>{const s=new Array(216);let e=0;const t=i=>{for(let r=0;r<i.length;r++)s[e+r]=i[r];e+=8};return t([3,0,6,2,3,1,5,4]),t([2,0,2,3,1,5,4,0]),t([3,1,0,2,3,7,5,4]),t([2,0,1,3,2,6,4,0]),t([1,0,1,3,2,0,0,0]),t([2,1,5,7,3,2,0,0]),t([3,2,0,1,3,7,6,4]),t([2,2,0,1,3,7,6,0]),t([3,3,0,1,5,7,6,2]),t([2,0,1,5,4,6,2,0]),t([1,0,1,5,4,0,0,0]),t([2,1,3,7,5,4,0,0]),t([1,0,2,6,4,0,0,0]),t([0,0,0,0,0,0,0,0]),t([1,1,3,7,5,0,0,0]),t([2,2,3,7,6,4,0,0]),t([1,2,3,7,6,0,0,0]),t([2,3,1,5,7,6,2,0]),t([3,4,0,1,5,7,6,2]),t([2,5,7,6,4,0,1,0]),t([3,5,0,1,3,7,6,4]),t([2,4,5,7,6,2,0,0]),t([1,4,5,7,6,0,0,0]),t([2,5,1,3,7,6,4,0]),t([3,6,0,2,3,7,5,4]),t([2,6,2,3,7,5,4,0]),t([3,7,6,2,3,1,5,4]),s})(),pC=4;function TN(s,e){let t=0;for(let i=0;i<pC;i++){const r=s.intersectPlane(e[i]);if(r>0)return-1;r===0&&(t|=1<<i)}return t}const Hu=ia(),sb=GE(),Os=v(),Qm=v(),rb=v(),ab=v(),nb=v();let SN=class{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll(i=>i.renderable.material.submit(e,t,i))}queryDepthRange(e){return this._objects.visibleObjects.length?vN(e,this._objects.visibleObjects):null}get hasEmissions(){return this._objects.visibleObjects.some(e=>e.renderable.material.hasEmissions)}hasHighlightOptions(e){return this._objects.hasHighlightOptions(e)}},Cq=class extends Ii{constructor(e,t,i,r,a){super(),this.colors=e,this.textureCoordinates=t,this.hasNormals=i,this.shadeNormals=r,this.applySSAO=a}};function PN({hasNormals:s,textureCoordinates:e,colors:t}){const i=Cn().vec3f(De.POSITION);return s&&i.vec2i16(De.NORMALCOMPRESSED,{glNormalized:!0}),e===pc.Default?i.vec2f(De.UV0):e===pc.Atlas&&(i.vec2f(De.UV0),i.vec4u16(De.UVREGION,{glNormalized:!0})),t&&i.vec4u8(De.COLOR,{glNormalized:!0}),i}let EN=class{constructor(){this.externalColor=Mi(),this.externalColorMixMode=Xd.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}};var Ys;(function(s){s[s.None=0]="None",s[s.Transparent=1]="Transparent",s[s.Opaque=2]="Opaque",s[s.COUNT=3]="COUNT"})(Ys||(Ys={}));var Jr;function Pq(s){return s&&_g(s)?Jr.Mars:s&&gg(s)?Jr.Moon:Jr.Earth}(function(s){s[s.Earth=1]="Earth",s[s.Mars=2]="Mars",s[s.Moon=3]="Moon",s[s.COUNT=4]="COUNT"})(Jr||(Jr={}));var Ks;(function(s){s[s.None=0]="None",s[s.NoOverlay=1]="NoOverlay",s[s.ColorOverlay=2]="ColorOverlay",s[s.ColorOverlayWithWater=3]="ColorOverlayWithWater",s[s.COUNT=4]="COUNT"})(Ks||(Ks={}));let rt=class extends Ua{constructor(e,t){super(),this.spherical=e,this.doublePrecisionRequiresObfuscation=t,this.output=D.Color,this.textureCoordinateType=pc.None,this.componentData=Nc.Uniform,this.cullFace=Lg.Back,this.vertexDiscardMode=Ys.None,this.doubleSidedMode=tn.WindingOrder,this.alphaDiscardMode=wl.Opaque,this.integratedMeshMode=Ks.None,this.oitPass=Qi.NONE,this.ellipsoidMode=Jr.Earth,this.pbrMode=Wt.Disabled,this.normalType=Ra.Attribute,this.emissionSource=Bh.None,this.hasVertexColors=!1,this.hasNormals=!1,this.shadeNormals=!0,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.screenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasNormalTextureTransform=!1,this.cloudReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1,this.discardInvisibleFragments=!1,this.occlusionPass=!1,this.bindType=vw.Draw,this.useCustomDTRExponentForWater=!1,this.hasVertexTangents=!1,this.highStepCount=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.useFillLights=!0,this.objectAndLayerIdColorInstanced=!1,this.canHaveOverlay=!0}};c([ne({count:D.COUNT})],rt.prototype,"output",void 0),c([ne({count:pc.COUNT})],rt.prototype,"textureCoordinateType",void 0),c([ne({count:Nc.COUNT})],rt.prototype,"componentData",void 0),c([ne({count:Lg.COUNT})],rt.prototype,"cullFace",void 0),c([ne({count:Ys.COUNT})],rt.prototype,"vertexDiscardMode",void 0),c([ne({count:tn.COUNT})],rt.prototype,"doubleSidedMode",void 0),c([ne({count:wl.COUNT})],rt.prototype,"alphaDiscardMode",void 0),c([ne({count:Ks.COUNT})],rt.prototype,"integratedMeshMode",void 0),c([ne({count:Qi.COUNT})],rt.prototype,"oitPass",void 0),c([ne({count:Jr.COUNT})],rt.prototype,"ellipsoidMode",void 0),c([ne({count:Wt.COUNT})],rt.prototype,"pbrMode",void 0),c([ne({count:Ra.COUNT})],rt.prototype,"normalType",void 0),c([ne({count:Bh.COUNT})],rt.prototype,"emissionSource",void 0),c([ne()],rt.prototype,"hasVertexColors",void 0),c([ne()],rt.prototype,"hasNormals",void 0),c([ne()],rt.prototype,"shadeNormals",void 0),c([ne()],rt.prototype,"hasSlicePlane",void 0),c([ne()],rt.prototype,"hasColorTexture",void 0),c([ne()],rt.prototype,"receiveAmbientOcclusion",void 0),c([ne()],rt.prototype,"receiveShadows",void 0),c([ne()],rt.prototype,"blendingEnabled",void 0),c([ne()],rt.prototype,"screenSpaceReflections",void 0),c([ne()],rt.prototype,"hasPolygonOffset",void 0),c([ne()],rt.prototype,"hasMetallicRoughnessTexture",void 0),c([ne()],rt.prototype,"hasOcclusionTexture",void 0),c([ne()],rt.prototype,"hasNormalTexture",void 0),c([ne()],rt.prototype,"hasOccludees",void 0),c([ne()],rt.prototype,"terrainDepthTest",void 0),c([ne()],rt.prototype,"cullAboveTerrain",void 0),c([ne()],rt.prototype,"hasNormalTextureTransform",void 0),c([ne()],rt.prototype,"cloudReflections",void 0),c([ne()],rt.prototype,"snowCover",void 0),c([ne()],rt.prototype,"objectAndLayerIdColor",void 0);function ob(s,e){const t=s.fragment;switch(e.doubleSidedMode){case tn.None:t.code.add(w`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case tn.View:s.include(Qu,e),t.code.add(w`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case tn.WindingOrder:t.code.add(w`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:Ec(e.doubleSidedMode);case tn.COUNT:}switch(e.normalType){case Ra.Attribute:case Ra.Compressed:s.include(gw,e),t.main.add(w`vec3 fragmentFaceNormal = _adjustDoublesided(normalize(vNormalWorld));
vec3 fragmentFaceNormalView = gl_FrontFacing ? normalize(vNormalView) : -normalize(vNormalView);`);break;case Ra.ScreenDerivative:s.include(Qu,e),t.main.add(w`vec3 fragmentFaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
vec3 fragmentFaceNormalView = normalize(cross(dFdx(vPosition_view), dFdy(vPosition_view)));`);default:case Ra.COUNT:}e.shadeNormals?t.main.add(w`vec3 fragmentShadingNormal = fragmentFaceNormal;`):e.spherical?(s.include(Qu,e),t.main.add(w`vec3 fragmentShadingNormal = normalize(positionWorld());`)):t.main.add(w`vec3 fragmentShadingNormal = vec3(0.0, 0.0, 1.0);`)}function ON(s,e){s.include(xw,e),s.fragment.include(R2);const t=s.fragment;t.uniforms.add(new Q2("baseColor",i=>i.baseColor)),t.uniforms.add(new A2("objectOpacity",i=>i.objectOpacity)),e.hasVertexColors?t.code.add(w`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):t.code.add(w`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),t.code.add(w`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function MN(s,e){const t=e.hasColorTexture&&(oo(e.output)||e.alphaDiscardMode!==wl.Opaque);t&&(s.include(NP,e),s.fragment.uniforms.add(new YO("baseColorTexture",i=>i.texture))),s.fragment.code.add(w`
    vec4 readBaseColorTexture() {
      return ${t?"textureLookup(baseColorTexture, vuv0)":"vec4(1.0)"};
    }
  `)}function mC(s){const e=new kt,{vertex:t,fragment:i}=e;e.include(Qu,s),e.include(gw,s),e.include(xw,s),e.include(O1,s),e.include(ww,s),e.include(T2,s),e.include(D2,s),i.include(VP,s),e.include(MN,s),e.include(FP,s);const{output:r,pbrMode:a,hasNormalTexture:n,snowCover:o,receiveShadows:l,spherical:h,ellipsoidMode:u}=s,d=a===Wt.Normal||a===Wt.Schematic;d&&(e.include(fE,s),n&&e.include($2,s));const p=r===D.Shadow||r===D.ShadowHighlight||r===D.ShadowExcludeHighlight,_=p&&s.componentData===Nc.Varying,f=s.integratedMeshMode===Ks.ColorOverlay||s.integratedMeshMode===Ks.ColorOverlayWithWater;if(f){e.include(Kd,s),e.include(cP,s);const E=u===Jr.Earth,M=u===Jr.Earth,$=E?os.radius:M?_T.radius:gT.radius;t.code.add(`
      ${Pe(h,`const float invRadius = ${w.float(1/$)};`)}
      vec2 projectOverlay(vec3 pos) { return pos.xy ${Pe(h,"/ (1.0 + invRadius * pos.z);")}; }`)}const g=f&&oo(r)&&a===Wt.WaterOnIntegratedMesh;g&&(e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),e.varyings.add("groundNormal","vec3"));const y=s.vertexDiscardMode===Ys.None,b=s.vertexDiscardMode===Ys.Opaque,x=1-1/255;if(t.main.add(w`
    bool castShadows;
    vec4 externalColor = forwardExternalColor(castShadows);
    ${Pe(_,"if(!castShadows) { gl_Position = vec4(vec3(1e38), 1.0); return; }")}

    ${Pe(!y,`{ if (externalColor.a ${b?">":"<="} ${w.float(x)}) { gl_Position = vec4(vec3(1e38), 1.0); return; } }`)}

    ${Pe(r===D.ObjectAndLayerIdColor,"externalColor.a = 1.0;")}

    forwardPosition(readElevationOffset());
    forwardViewPosDepth(vPosition_view);
    forwardNormal();
    forwardTextureCoordinates();
    forwardVertexColor();
    forwardLinearDepth();
    forwardObjectAndLayerIdColor();
    ${Pe(g,h?w`
              groundNormal = normalize(positionWorld());
              tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
              tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:w`
              groundNormal = vec3(0.0, 0.0, 1.0);
              tbnTangent = vec3(1.0, 0.0, 0.0);
              tbnBiTangent = vec3(0.0, 1.0, 0.0);`)}
    ${Pe(f,"setOverlayVTC(projectOverlay(position));")}

    if (externalColor.a < ${w.float(ll)}) {
      // Discard this vertex
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
  `),oo(r))return e.include(ON,s),e.include(ob,s),e.include(Kd,s),e.include(UP,s),l&&e.include(Qg,s),i.code.add(w`
      float evaluateShadow() {
        return ${l?"readShadowMap(vPositionWorldCameraRelative, linearDepth)":"0.0"};
      }`),f&&i.uniforms.add(new ft("ovColorTex",(E,M)=>uP(E,M))),i.main.add(w`
      discardBySlice(vPositionWorldCameraRelative);
      discardByTerrainDepth();

      vec4 textureColor = readBaseColorTexture();
      discardOrAdjustAlpha(textureColor);

      vec4 externalColor;
      int externalColorMixMode;
      readExternalColor(externalColor, externalColorMixMode);

      vec4 materialColor = computeMaterialColor(textureColor, externalColor, externalColorMixMode);
      ${Pe(f,w`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`)}
    `),d?(U1(i),h&&S_(i),i.main.add(w`
        applyPBRFactors();
        ${Pe(a===Wt.Normal,w`if (externalColorMixMode == 3) {
              mrr = vec3(0.0, 0.6, 0.2);
            }`)}
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
        ${Pe(n,"mat3 tangentSpace = computeTangentSpace(fragmentShadingNormal, vPositionWorldCameraRelative, vuv0);")}
        vec3 shadingNormal = ${n?"computeTextureNormal(tangentSpace, vuv0)":"fragmentShadingNormal"};
        vec3 normalGround = ${h?w`normalize(positionWorld())`:w`vec3(0.0, 0.0, 1.0)`};

        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();
        ${Pe(o,w`float snow = smoothstep(0.5, 0.55, dot(fragmentFaceNormal, normalize(positionWorld())));
                 materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                 ssao = mix(ssao, 0.5 * ssao, snow);
                 shadingNormal = mix(shadingNormal, fragmentFaceNormal, snow);`)}
        ${Pe(f,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 emission = getEmissions();
        ${Pe(h,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        ${h?w`float shadow = max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow());`:"float shadow = evaluateShadow();"}
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, shadow, ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(h&&S_(i),g&&i.uniforms.add(new br("ovNormalTex",E=>{var M;return(M=E.overlay)==null?void 0:M.getTexture(Bs.WaterNormal)})),i.main.add(w`
        ${Pe(h,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        float shadow = ${l?h?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow())":"evaluateShadow()":h?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        ${Pe(o,w`float snow = smoothstep(0.5, 0.55, dot(fragmentFaceNormal, normalize(positionWorld())));
               materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)}

        // At global scale we create some additional ambient light based on the main light to simulate global illumination
        float ssao = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());

        ${Pe(f,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec4 shadedColor = vec4(evaluateSceneLighting(fragmentShadingNormal, materialColor.rgb, shadow, ssao, additionalLight), materialColor.a);
        ${Pe(g,w`vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
                 float waterNormalLength = length(overlayWaterMask);
                 if (waterNormalLength > 0.95) {
                   mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                   vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                   vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                   // un-gamma the ground color to mix in linear space
                   shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
                 }`)}
      `)),i.main.add("outputColorHighlightOID(shadedColor, vPositionWorldCameraRelative);"),e;const C=r===D.Normal,T=r===D.ObjectAndLayerIdColor,P=r===D.Highlight,S=p||r===D.ViewshedShadow;return S&&e.include(_w,s),C&&e.include(ob,s),e.include(M1,s),i.main.add(w`
    discardBySlice(vPositionWorldCameraRelative);

    vec4 textureColor = readBaseColorTexture();
    discardOrAdjustAlpha(textureColor);

    ${Pe(S,"outputDepth(linearDepth);")}
    ${Pe(C,w`fragColor = vec4(vec3(0.5) + 0.5 * fragmentFaceNormalView, 1.0);`)}
    ${Pe(T,f?"fragColor = getOverlayColorTexel();":"outputObjectAndLayerIdColor();")}
    ${Pe(P,w`${Pe(f,w`
           vec2 overlayHighlightTexel = getAllOverlayHighlightValuesEncoded();
           calculateOcclusionAndOutputHighlightOverlay(overlayHighlightTexel);`,w`calculateOcclusionAndOutputHighlight();`)}`)}`),e}const RN=Object.freeze(Object.defineProperty({__proto__:null,build:mC},Symbol.toStringTag,{value:"Module"}));let AN=class extends Bt{constructor(e,t){super(e,t,new qt(RN,()=>X(()=>Promise.resolve().then(()=>Z4),void 0,import.meta.url)),_C)}initializePipeline(e){const{integratedMeshMode:t,output:i,blendingEnabled:r,cullFace:a,hasOccludees:n,hasPolygonOffset:o,oitPass:l}=e,h=t!==Ks.None,u=l===Qi.NONE,d=l===Qi.FrontFace;return Qt({blending:oo(i)&&r?jP(l):null,culling:ZP(a),depthTest:{func:kP(l)},depthWrite:u||d?N1:null,drawBuffers:i===D.Depth?{buffers:[I1.NONE]}:qP(l,i),colorWrite:ti,stencilWrite:h||n?BP:null,stencilTest:h?zP(Ig.IntegratedMeshMaskExcluded):n?GP:null,polygonOffset:u||d?o?{factor:2,units:2}:null:HP})}};const _C=new Map([[De.POSITION,0],[De.NORMAL,1],[De.NORMALCOMPRESSED,1],[De.COLOR,2],[De.UV0,3],[De.UVREGION,4],[De.COMPONENTINDEX,5]]);let DN=class extends Ii{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}},Af=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}};function St(s={}){return(e,t)=>{const i=e._parameterCount??0;if(e._parameterCount=i+1,s.vectorOps){const r=s.vectorOps;Object.defineProperty(e,t,{get(){return this[i]},set(a){const n=this[i];if(n==null)this[i]=[...a];else{if(r.equals(n,a))return;r.copy(n,a)}this._setDirty()}})}else Object.defineProperty(e,t,{get(){return this[i]},set(r){this[i]!==r&&(s.dispose&&this[i]&&this[i].dispose(),this[i]=r,this._setDirty())}})}}function lb(){return(s,e)=>{const t=s._parameterCount??0;s._parameterCount=t+1,s._parameterBlocks=s._parameterBlocks||[],s._parameterBlocks.push(t),Object.defineProperty(s,e,{get(){return this[t]},set(i){this[t]!==i&&(this[t]=i,this._setDirty())}})}}let gC=class{constructor(e){this._low=v(),this._high=v(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){le(this._low,le(hb,e));const t=Mt(hb,e,this._low);le(this._high,t)}get(e){return ue(e,this._low,this._high)}getLowScaled(e){return ee(e,this._low,1)}};const hb=OP();let hi=class extends DN{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=KE(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=I2,this.emissiveFactor=gp(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.commonMaterialParameters=new wd,this.componentParameters=new Jh,this.objectOpacity=1,this.textureAlphaCutoff=ll,this.alphaDiscardMode=wl.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=Jr.Earth,this.hasOccludees=!1;const i=new gC(e.position),r=HE(e.rotationScale);Mg(r,r),Mc(r,r),this.transformNormalGlobalFromModel=r,this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){var e;return(e=this.baseColorTexture)==null?void 0:e.glTexture}get textureMetallicRoughness(){var e;return(e=this.metallicRoughnessTexture)==null?void 0:e.glTexture}get textureEmissive(){var e;return(e=this.emissionTexture)==null?void 0:e.glTexture}get hasEmissions(){return this.emissionTexture!=null||!vp(this.emissiveFactor,vr)}get textureOcclusion(){var e;return(e=this.occlusionTexture)==null?void 0:e.glTexture}get textureNormal(){var e;return(e=this.normalTexture)==null?void 0:e.glTexture}acquireTechnique(e,t,i,r){const a=new rt(e.context.spherical,e.context.doublePrecisionRequiresObfuscation);a.hasVertexColors=r.colors,a.hasNormals=r.hasNormals,a.textureCoordinateType=r.textureCoordinates,a.hasMetallicRoughnessTexture=this.metallicRoughnessTexture!=null,a.hasOcclusionTexture=this.occlusionTexture!=null,a.hasNormalTexture=this.normalTexture!=null,a.oitPass=t.identifier===Ws.Material&&i.oitPass!=null?i.oitPass:Qi.NONE,a.terrainDepthTest=t.identifier===Ws.Material&&i.terrainDepthTest,a.cullAboveTerrain=t.identifier===Ws.Material&&i.cullAboveTerrain,a.ellipsoidMode=this.ellipsoidMode,a.componentData=this.componentParameters.type,a.cullFace=this.commonMaterialParameters.cullFace,a.doubleSidedMode=this.commonMaterialParameters.doubleSided?tn.View:tn.None,a.hasColorTexture=this.baseColorTexture!=null;const n=this._computeWhichMaterialPass();if(a.blendingEnabled=n===Wi.Transparent||n===Wi.OpaqueAndTransparent,a.alphaDiscardMode=this.alphaDiscardMode,a.integratedMeshMode=this.isIntegratedMesh?LN(i)?IN(i)?Ks.ColorOverlayWithWater:Ks.ColorOverlay:Ks.NoOverlay:Ks.None,a.hasPolygonOffset=this.polygonOffsetEnabled,a.pbrMode=a.integratedMeshMode===Ks.ColorOverlayWithWater?Wt.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?r.shadeNormals&&this.isIntegratedMesh?Wt.Disabled:Wt.Schematic:Wt.Normal:Wt.Disabled,a.emissionSource=this.emissionTexture!=null?Bh.Texture:a.pbrMode===Wt.Normal?Bh.Value:Bh.None,a.shadeNormals=r.shadeNormals,a.normalType=a.hasNormals?Ra.Compressed:Ra.ScreenDerivative,a.hasSlicePlane=i.slicePlane!=null&&this.commonMaterialParameters.hasSlicePlane,t.identifier===Ws.ShadowMap)a.output=D.Shadow,a.vertexDiscardMode=Ys.None;else if(t.identifier===Ws.ViewshedShadowMap)a.output=D.ViewshedShadow,a.vertexDiscardMode=Ys.None;else if(t.identifier===Ws.Highlight)a.output=D.Highlight,a.vertexDiscardMode=Ys.None;else{switch(n===Wi.OpaqueAndTransparent?a.vertexDiscardMode=t.transparent?Ys.Opaque:Ys.Transparent:a.vertexDiscardMode=Ys.None,a.output=t.output,a.receiveAmbientOcclusion=a.receiveShadows=!1,t.output){case D.Color:case D.ColorEmission:a.receiveAmbientOcclusion=r.applySSAO&&i.ssao!=null,a.hasOccludees=i.hasOccludees,a.receiveShadows=i.shadowMap.ready,a.screenSpaceReflections=i.ssr.lastFrameColor!=null,a.cloudReflections=i.clouds.data!=null;break;case D.ObjectAndLayerIdColor:a.objectAndLayerIdColor=!0}a.snowCover=this.hasSnowCover(i)}const o=e.get(AN,a);return this._setClean(),o}hasSnowCover(e){return e.weather!=null&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}submit(e,t,i){if(this.objectOpacity<=0)return;const{componentData:r,renderable:a}=i,{geometry:n}=a,o=a.meta.cameraDepthSquared;r.updateHighlights(t.highlights);const{geometryRanges:l,highlightRangesMap:h,shadowmapRanges:u}=r;switch(this._computeWhichMaterialPass()){case Wi.Opaque:e.opaque.submitDraw(this,n,l,o);break;case Wi.Transparent:e.transparent.submitDraw(this,n,l,o);break;case Wi.OpaqueAndTransparent:e.opaque.submitDraw(this,n,l,o),e.transparent.submitDraw(this,n,l,o);break;case Wi.IntegratedMesh:e.integratedMesh.submitDraw(this,n,l,o),$N(t)&&e.highlightIntegratedMesh.submitDraw(this,n,l,o)}if(this.componentParameters.castShadows!==ei.None){if(h!=null)for(const d of h)d[0]===nn&&e.highlightShadowMap.submitDraw(this,n,d[1],o,d[0]);u!=null&&e.nonHighlightShadowMap.submitDraw(this,n,u,o),e.shadowMap.submitDraw(this,n,l,o)}if(h!=null)for(const d of h)e.highlight.submitDraw(this,n,d[1],o,d[0]);t.viewshedEnabled&&e.viewshedShadowMap.submitDraw(this,n,l,o)}_computeWhichMaterialPass(){if(this.isIntegratedMesh)return Wi.IntegratedMesh;if(this.objectOpacity<1)return Wi.Transparent;if(this.componentParameters.opaqueOverride===ei.All)return Wi.Opaque;if(this.baseColor[3]<1||this.alphaDiscardMode===wl.Blend||this.alphaDiscardMode===wl.MaskBlend)return Wi.Transparent;switch(this.componentParameters.transparent){case ei.None:return Wi.Opaque;case ei.All:return Wi.Transparent;case ei.Some:return Wi.OpaqueAndTransparent}}};var Wi,ei;c([St({vectorOps:J1})],hi.prototype,"baseColor",void 0),c([St()],hi.prototype,"usePBR",void 0),c([St()],hi.prototype,"hasParametersFromSource",void 0),c([St({vectorOps:fy})],hi.prototype,"mrrFactors",void 0),c([St({vectorOps:fy})],hi.prototype,"emissiveFactor",void 0),c([St({dispose:!0})],hi.prototype,"baseColorTexture",void 0),c([St({dispose:!0})],hi.prototype,"metallicRoughnessTexture",void 0),c([St({dispose:!0})],hi.prototype,"emissionTexture",void 0),c([St({dispose:!0})],hi.prototype,"occlusionTexture",void 0),c([St({dispose:!0})],hi.prototype,"normalTexture",void 0),c([lb()],hi.prototype,"commonMaterialParameters",void 0),c([lb()],hi.prototype,"componentParameters",void 0),c([St()],hi.prototype,"objectOpacity",void 0),c([St()],hi.prototype,"textureAlphaCutoff",void 0),c([St()],hi.prototype,"alphaDiscardMode",void 0),c([St()],hi.prototype,"isIntegratedMesh",void 0),c([St()],hi.prototype,"polygonOffsetEnabled",void 0),c([St()],hi.prototype,"ellipsoidMode",void 0),c([St()],hi.prototype,"hasOccludees",void 0),function(s){s[s.Opaque=0]="Opaque",s[s.Transparent=1]="Transparent",s[s.OpaqueAndTransparent=2]="OpaqueAndTransparent",s[s.IntegratedMesh=3]="IntegratedMesh"}(Wi||(Wi={}));let wd=class extends Af{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=Lg.Back,this.hasSlicePlane=!0}};c([St()],wd.prototype,"doubleSided",void 0),c([St()],wd.prototype,"cullFace",void 0),c([St()],wd.prototype,"hasSlicePlane",void 0);let Jh=class extends Af{constructor(){super(...arguments),this.externalColor=Pr(1,1,1,1),this.externalColorMixMode=Xd.Multiply,this.castShadows=ei.All}get transparent(){return this.externalColor[3]<1?ei.All:ei.None}get opaqueOverride(){return this.externalColorMixMode===Xd.Replace&&this.externalColor[3]===1?ei.All:ei.None}get visible(){return this.externalColor[3]>0?ei.All:ei.None}get type(){return Nc.Uniform}};c([St({vectorOps:J1})],Jh.prototype,"externalColor",void 0),c([St()],Jh.prototype,"externalColorMixMode",void 0),c([St()],Jh.prototype,"castShadows",void 0),function(s){s[s.All=0]="All",s[s.Some=1]="Some",s[s.None=2]="None"}(ei||(ei={}));let Ih=class extends Af{constructor(){super(...arguments),this.texture=null,this.transparent=ei.None,this.opaqueOverride=ei.None,this.castShadows=ei.None}get type(){return Nc.Varying}};function $N(s){var e;return((e=s.overlay)==null?void 0:e.getTexture(Bs.Highlight))!=null}function IN(s){var e;return((e=s.overlay)==null?void 0:e.getTexture(Bs.WaterNormal))!=null}function LN(s){var e;return((e=s.overlay)==null?void 0:e.getTexture(Bs.ColorNoRasterImage))!=null}c([St()],Ih.prototype,"texture",void 0),c([St()],Ih.prototype,"transparent",void 0),c([St()],Ih.prototype,"opaqueOverride",void 0),c([St()],Ih.prototype,"castShadows",void 0);let NN=class{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}},VN=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const i=new mi(this.textureWidth,1);i.samplingMode=Ds.NEAREST,i.wrapMode=Ki.CLAMP_TO_EDGE,this._texture=new oi(this._rctx,i),this._data=new Zd(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,i,r,a,n){const o=e*this._fieldCount+t;this._dirty=!0,this._data.set(o,0,i),this._data.set(o,1,r),this._data.set(o,2,a),this._data.set(o,3,n)}setDataElement(e,t,i,r){const a=e*this._fieldCount+t;this._dirty=!0,this._data.set(a,i,r)}getDataElement(e,t,i){const r=e*this._fieldCount+t;return this._dirty=!0,this._data.get(r,i)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const i=Math.ceil(t/this.textureWidth)*this.textureWidth,r=new Zd(new ArrayBuffer(4*i));r.typedBuffer.set(this._data.typedBuffer),this._data=r}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}};const fC=65536;let FN=class{constructor(e,t=1){this.textureBuffer=new VN(e,t),this._indexManager=new NN(fC)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}},UN=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(e=>e.activeCount!==0||(e.dispose(),!1))}destroy(){this._buffers.forEach(e=>e.dispose()),this._buffers=[]}getBuffer(e){for(const i of this._buffers)if(i.availableCount>=e)return i;if(e>fC)return null;const t=new FN(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}};const zu=()=>pe.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");let HN=class{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._activeHighlightOptions=new Map,this._visible=new mt,this._hidden=new mt,this._renderSubmit=new SN(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new UN(e.rctx,2+(gc()?1:0))}destroy(){ws(this._hidden.length===0&&this._visible.length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll(e=>e.destroy()),this._hidden.forAll(e=>e.destroy()),this._visible.clear(),this._hidden.clear()}createObject(e){const t=e.geometry,i=new U3(this._componentBufferManager,mw(t.componentOffsets)),r=this._createRenderable(e,i),a=new uN(this._viewingMode,t.positionData,i),n=new z3(e.transform,e.toMapSpace,e.obb.clone(),i,r,a);return(n.visible?this._visible:this._hidden).push(n),n}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(t?(this._hidden.removeUnordered(i),this._visible.push(i)):(this._visible.removeUnordered(i),this._hidden.push(i)),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll(i=>i.renderable.meta.cameraDepthSquared=rn(t,i.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.componentData.visibility.reset(t),i.componentData.markVisibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.componentData.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.componentData.visibility.componentCount;return{visible:i,invisible:t.componentData.count-i}}setComponentData(e,t){const i=e,{renderable:r,componentData:a}=i,n=r.material,o=a.materialDataBuffer,l=a.materialDataIndices,h=new EN,u=o.textureBuffer,d=new Uint8Array(4),p=new Uint32Array(d.buffer);let _=0,f=0,g=0,y=a.verticalOffsets,b=1/0,x=-1/0,C=!1,T=!1,P=0;for(let S=0;S<a.count;S++){t(S,h),_+=+(h.externalColor[3]<1),f+=+(h.externalColorMixMode===Xd.Replace&&h.externalColor[3]===1),g+=+h.castShadows,g2(h.externalColor,h.externalColorMixMode,d),d[2]=254&d[2]|+h.castShadows,u.setData(l[S],0,d[0],d[1],d[2],d[3]),C||(C=S>0&&P!==p[0]),P=p[0],T||(T=h.elevationOffset!==0),T&&y==null&&(y=new Array(S).fill(0)),y!=null&&(y[S]=h.elevationOffset),b=Math.min(b,h.elevationOffset),x=Math.max(x,h.elevationOffset),S2(h.elevationOffset,d),u.setData(l[S],1,d[0],d[1],d[2],d[3]);const E=h.objectAndLayerIdColor;E!=null&&u.setData(l[S],2,E[0],E[1],E[2],E[3]),h.pickable!==rg(a.pickability,S)&&(a.pickability=K3(a.pickability,a.count,S,h.pickable))}a.verticalOffsets=T?y:null,i.offsetObb=T?C2(i.obb,b,x,this._viewingMode,i.offsetObb??i.obb.clone()):null,C||T||gc()?(n.componentParameters=new Ih,n.componentParameters.castShadows=Ym(g,a.count),n.componentParameters.transparent=Ym(_,a.count),n.componentParameters.opaqueOverride=Ym(f,a.count),n.componentParameters.texture=u,u.updateTexture()):(n.componentParameters=new Jh,n.componentParameters.castShadows=h.castShadows?ei.All:ei.None,n.componentParameters.externalColor=h.externalColor,n.componentParameters.externalColorMixMode=h.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,i,r=!1){e.intersectionGeometry.getComponentAabb(t,i);const a=e,n=a.componentData.verticalOffsets;if(r||n==null)return i;const o=n[t];if(this._viewingMode===Ne.Local||o===0)return i[2]+=o,i[5]+=o,i;const l=Ry(o);return l.localOrigin=a.transform.position,l.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}expandRangeWithComponentObjectElevationRange(e,t,i,r){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||r.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const a=e,n=a.componentData,o=n.count,l=n.verticalOffsets,h=a.intersectionGeometry,u=this._viewingMode===Ne.Local,d=h.getComponentAabbs(),p=GN;let _=1/0,f=-1/0;for(let g=0;g<o;g++){const y=6*g,b=(l==null?void 0:l[g])??0;let x=1/0,C=-1/0;if(u)x=d[y+2]+b+t,C=d[y+5]+b+t;else{if(p[0]=d[y],p[1]=d[y+1],p[2]=d[y+2],p[3]=d[y+3],p[4]=d[y+4],p[5]=d[y+5],b!==0){const E=Ry(b);E.localOrigin=a.transform.position,E.applyToAabb(p)}const T=Math.max(Math.abs(p[3]),Math.abs(p[0])),P=Math.max(Math.abs(p[4]),Math.abs(p[1])),S=t+p[5]+i;r.expandElevationRangeValues(t+p[2],Math.sqrt(T*T+P*P+S*S)-i)}r.expandElevationRangeValues(x,C),_=Math.min(_,x),f=Math.max(f,C)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=_,this._elevationRangeCacheMax=f}intersect(e,t,i,r,a,n,o){const l=e,{transform:h}=l,{position:u}=h;return a!=null&&(a.localOrigin=u),l.intersectionGeometry.intersect(t,i,r,a,l.componentData.verticalOffsets,h,n,o)}addEdges(e,t,i,r,a){const n=e,{indices:o,positions:l}=n.intersectionGeometry,h=n.componentData.offsets;return t.addComponentObject(n,l,o,h,i,r,a)}async extractEdgeInformation(e,t,i){const r=e,a=r.componentData.visibility;if(a.allInvisible()){const{extractComponentsEdgeLocationsLayout:_}=await X(()=>import("./edgeProcessing-Dmwf8z6c.js").then(f=>f.e),__vite__mapDeps([570,215,13,68,1,78,79,80,43,42,6,45,81,41,49,56,571,233,74,222,226]),import.meta.url);return{buffer:_.createBuffer(0),origin:[0,0,0]}}const{indices:n,positions:o}=r.intersectionGeometry,l=r.componentData.offsets,{EdgeInputBufferLayout:h}=await X(async()=>{const{EdgeInputBufferLayout:_}=await import("./bufferLayouts-DmKtt9ER.js");return{EdgeInputBufferLayout:_}},__vite__mapDeps([571,233,74,222,78,79,80,43,42,6,45,81,41,49,56]),import.meta.url),u=h.createBuffer(o.length/3);x2(u.position.typedBuffer,o,u.position.typedBufferStride,3),w2(u.position,u.position,r.transform.rotationScale),this._setComponentIndices(u.componentIndex,n,l);const d=u.count,p=this._computeVisibilityIndices(n,a,l,d);return{origin:dn(r.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:p,indicesLength:p.length,skipDeduplicate:!0,data:u,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,t,i){let r=0;for(let a=0;a<i.length-1;a++){const n=i[a],o=i[a+1];for(let l=n;l<o;l++){const h=t?t[l]:l;e.set(h,r)}r++}}_computeVisibilityIndices(e,t,i,r){if(e&&t.allVisible())return e;let a=0;t.forEachComponentRange((l,h)=>(a+=i[h]-i[l],!0));const n=iT(e)?(e==null?void 0:e.BYTES_PER_ELEMENT)===2||r<=65536?new Uint16Array(a):new Uint32Array(a):new Array(a);let o=0;return t.forEachComponentRange((l,h)=>{const u=i[l],d=i[h];for(let p=u;p<d;p++)n[o++]=e?e[p]:p;return!0}),n}addComponentHighlight(e,t,i){const r=e.componentData,a=pg(r.componentHighlights,i,()=>new Uint32Array(r.count+1));{const n=this._activeHighlightOptions.get(i)??0;this._activeHighlightOptions.set(i,n+1)}a[t]++===0&&(r.markHighlightsDirty(),this._notifyDirty()),a[r.count]++}removeComponentHighlight(e,t,i){const{componentData:r}=e,a=r.componentHighlights.get(i);if(a===void 0)return void zu().warn("Removing non-existing highlight.");const n=a[t];if(n===0)return void zu().warn("Removing non-existing highlight.");this._removeActiveHighlight(i);const o=a[r.count];if(n>1)return a[t]=n-1,void(a[r.count]=o-1);a[t]=0,o===1?r.componentHighlights.delete(i):a[r.count]=o-1,r.markHighlightsDirty(),this._notifyDirty()}_removeActiveHighlight(e,t=1){const i=this._activeHighlightOptions.get(e);if(i===void 0)zu().warn("Removing non-existing highlight.");else{const r=i-t;r<0&&zu().warn("Removing non-existing highlight."),r<=0?this._activeHighlightOptions.delete(e):this._activeHighlightOptions.set(e,r)}}clearHighlights(e){const{componentData:t}=e,{componentHighlights:i}=t;if(i.size>0){for(const r of i)this._removeActiveHighlight(r[0],r[1][t.count]);i.clear(),t.markHighlightsDirty(),this._notifyDirty()}}hasHighlightOptions(e){return this._activeHighlightOptions.has(e)}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,a=r.vertices.layoutParameters,n=$s.createVertex(i,wr.STATIC_DRAW,r.vertices.data),o=r.indices?$s.createIndex(i,wr.STATIC_DRAW,r.indices):null,l=Fa(PN(a)),h=new Uint16Array(r.vertices.count);for(let g=0;g<t.count;g++){const y=t.offsets[g],b=t.offsets[g+1],x=t.materialDataIndices[g];if(r.indices!=null)for(let C=y;C<b;C++)h[r.indices[C]]=x;else for(let C=y;C<b;C++)h[C]=x}const u=$s.createVertex(i,wr.STATIC_DRAW,h.buffer),d=new hi(e.transform,e.toMapSpace),p=new rE(i,_C,new Map([["data",l],["componentIndices",zN]]),new Map([["data",n],["componentIndices",u]]),o),_=new yN(p,bi.TRIANGLES,a,o!=null),f={cameraDepthSquared:.5,gpuMemoryEstimate:n.usedMemory+u.usedMemory+(o!=null?o.usedMemory:0)};return new fN(d,_,f)}_notifyDirty(){this._renderManager.notifyDirty()}};const zN=Fa(Cn().u16(De.COMPONENTINDEX));function Ym(s,e){return s===e?ei.All:s===0?ei.None:ei.Some}const GN=Ic();let BN=class{constructor(e,t,i,r,a){this.rctx=e,this.viewingMode=t,this.stippleTextures=i,this.waterTextures=r,this.markerTextures=a}get spherical(){return this.viewingMode===Ne.Global}get doublePrecisionRequiresObfuscation(){return this.rctx.driverTest.doublePrecisionRequiresObfuscation.result}},Lh=class extends Co{constructor(e){super(e),this.consumes={required:["olid"]},this.produces="olid"}destroy(){}render(e){const t=e.find(({name:r})=>r==="olid"),i=this.renderingContext;return i.bindFramebuffer(t.fbo),i.clearFramebuffer(ur,!0,!0),this.view._stage.renderer.renderAllGeometry(D.ObjectAndLayerIdColor),i.clear(Jt.DEPTH|Jt.STENCIL),this.view._stage.renderer.renderHUD(Ps.NotOccluded),t}};c([m()],Lh.prototype,"consumes",void 0),c([m()],Lh.prototype,"produces",void 0),Lh=c([F("esri.views.3d.webgl-engine.effects.geometry.ObjectAndLayerIDRenderNode")],Lh);let Nh=class extends Co{constructor(e){super(e),this.consumes={required:[ge.OCCLUDED]},this.produces=ge.OCCLUDED,this._blit=new fw(e.view._stage.renderView.techniques,Hn.PremultipliedAlpha)}precompile(){const e=this.view._stage.renderer;e.plugins.plugins.forAll(t=>{e.precompileSlots(t,j.OCCLUDED_TERRAIN,j.TRANSPARENT_OCCLUDER_MATERIAL),t.material&&e.precompileOccludedSlots(t,cb)})}render(e){const t=e.find(({name:a})=>a===this.produces),i=this.view._stage.renderer;let r=0;if(pa.clear(),i.plugins.plugins.forAll(a=>{a.material&&a.queryRenderOccludedState(Pi.OccludeAndTransparentStencil)&&(r|=Pi.OccludeAndTransparentStencil,pa.push(a))}),pa.length>0&&(i.renderSlots(pa,j.OCCLUDER_MATERIAL),r&Pi.OccludeAndTransparentStencil&&this._renderAndComposite(t,.5,()=>i.renderSlots(pa,j.TRANSPARENT_OCCLUDER_MATERIAL),!1,!1)),pa.clear(),i.plugins.plugins.forAll(a=>{if(!a.material)return;const n=a.queryRenderOccludedState(Pi.OccludeAndTransparent),o=a.queryRenderOccludedState(Pi.Transparent),l=a.queryRenderOccludedState(Pi.Opaque);(n||o||l)&&(r|=n?Pi.OccludeAndTransparent:o?Pi.Transparent:Pi.Opaque,pa.push(a))}),r|=i.plugins.renderOccludedFlags,!r)return t;for(const a of cb)r&a&&this._renderAndComposite(t,a===Pi.Opaque?1:.5,()=>i.renderOccludedSlots(pa,a),!0,Ig.OutlineVisualElementMask);return pa.clear(),t}_renderAndComposite(e,t,i,r,a){const n=this.renderingContext,{width:o,height:l}=e.fbo,h=this.fboCache.acquire(o,l,"tmp color"),u=r?this.fboCache.acquireDepth(Yi.DEPTH_STENCIL_TEXTURE,o,l,"tmp depth"):e.getAttachment(Bd);h.attachDepth(u),n.bindFramebuffer(h.fbo),n.clearFramebuffer(ur,r,a),i(),h.detachDepth(),this._blit.blend(n,h,e,this.bindParameters,t),r&&u.release(),h.release()}};c([m()],Nh.prototype,"consumes",void 0),c([m()],Nh.prototype,"produces",void 0),Nh=c([F("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],Nh);const pa=new mt,cb=[Pi.OccludeAndTransparent,Pi.Transparent,Pi.Opaque];let Df=class extends Ii{};function yC(){const s=new kt;return s.include(sr),s.fragment.uniforms.add(new ft("colorTexture",e=>e.color),new br("depthTexture",e=>e.mainDepth)),s.fragment.main.add(w`float depthSample = texture(depthTexture, uv).r;
if (depthSample == 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),s}const qN=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:Df,build:yC},Symbol.toStringTag,{value:"Module"}));let ub=class extends Bt{constructor(e,t){super(e,t,new qt(qN,()=>X(()=>Promise.resolve().then(()=>X4),void 0,import.meta.url)))}initializePipeline(){return Qt({blending:Ac($t.ONE,$t.ZERO,$t.ONE_MINUS_SRC_COLOR,$t.ONE),depthTest:{func:Zi.ALWAYS},colorWrite:ti})}};function vC(s){const e=new kt,{fragment:t}=e;e.include(Dp),Tp(t),e.include(bp),t.include(xp),t.include(Ep),t.include(Eg),t.include(sC,!0),t.uniforms.add(new br("depthTexture",r=>r.mainDepth),new Ze("hazeStrength",r=>r.hazeStrength));const{reduced:i}=s;return i&&t.code.add(w`float getDepth(vec2 uv){
return linearDepthFromTexture(depthTexture, uv);
}
float textureBilinear(vec2 uv) {
vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
vec2 texelSize = 1.0 / depthTextureSize;
vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);
vec2 f = fract(depthUV);
vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;
float d0 = getDepth(snapUV);
float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
float d3 = getDepth(snapUV + texelSize);
return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
}`),t.main.add(w`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture(depthTexture, uv).r;
      if (depthSample != 1.0) {
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;

        cameraSpaceRay *= ${Pe(i,"-textureBilinear(uv)","-linearDepthFromTexture(depthTexture, uv)")};
        terrainDepth = max(0.0, length(cameraSpaceRay));
      } else {
        discard;
      }

      // Alpha is ignored for haze blending
      vec3 col = vec3(0);
      float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
      if(depthSample != 1.0){
        col = (1.0 - fadeOut) * hazeStrength * raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      }
      float alpha = 1.0;

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
  `),e}const kN=Object.freeze(Object.defineProperty({__proto__:null,build:vC},Symbol.toStringTag,{value:"Module"}));let jN=class extends iC{constructor(){super(...arguments),this.hazeStrength=1}},Zm=class extends Bt{constructor(e,t){super(e,t,new qt(kN,()=>X(()=>Promise.resolve().then(()=>K4),void 0,import.meta.url)))}initializePipeline(e){return e.reduced?Qt({blending:Ag,depthTest:{func:Zi.ALWAYS},colorWrite:ti}):Qt({blending:Ac($t.ONE,$t.ZERO,$t.ONE_MINUS_SRC_COLOR,$t.ONE),colorWrite:ti})}},xd=class extends Ua{constructor(){super(...arguments),this.reduced=!1}};c([ne()],xd.prototype,"reduced",void 0);let ag=class extends Kh{constructor(e){super(e),this._compositingPassParameters=new Df,this._passParameters=new jN,this._hazeConfiguration=new xd,this._vao=null,this.requireGeometryDepth=!0,this._oldAmount=1,this._newAmount=1,this._amount=this._newAmount;const t=e.view._stage.renderView.techniques;t.precompile(Zm,new xd);const i=new xd;i.reduced=!0,t.precompile(Zm,i),t.precompile(ub)}initialize(){this.addHandles([O(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Be),O(()=>{var e;return((e=this.view._stage)==null?void 0:e.renderer.renderContext.bind.clouds.fadeFactor)??1},e=>this._fade(e),Be),O(()=>this.view.environment.weather.type,e=>this._newAmount=e==="rainy"?0:1,Be),O(()=>{var e;return(e=this.view._stage.renderer)==null?void 0:e.fullResolutionAtmosphere},e=>this._hazeConfiguration.reduced=!e,Be)])}_fade(e){e>=1?(this._amount=this._newAmount,this._oldAmount=this._newAmount):this._amount=e<=0?this._oldAmount:ze(this._oldAmount,this._newAmount,e)}destroy(){this._vao=We(this._vao)}render(e){const t=e.find(({name:g})=>g===ge.TRANSPARENT_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext;this._vao??(this._vao=Sn(i,na.Pos2Tex));const r=this.techniques.get(Zm,this._hazeConfiguration);if(!r.compiled)return t;const a=t.getAttachment(i.gl.DEPTH_STENCIL_ATTACHMENT);if(this._update(),!this._hazeConfiguration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),t.attachDepth(a),t;const n=this.techniques.get(ub);if(!n.compiled)return t;const o=i.getViewport(),l=this.camera,h=we(l.eye)-os.radius;let u;const d=os.atmosphereHeight;if(h<d){const g=Math.min(1,Math.max(0,h/d));u=ze(.4,.5,g)}else{const g=Math.min(1,Math.max(0,(h-d)/(15*d)));u=ze(.5,1,g)}const p=dc(Math.round(u*l.fullViewport[2])),_=dc(Math.round(u*l.fullViewport[3]));i.setViewport(0,0,p,_);const f=this.fboCache.acquire(p,_,"haze",di.RGBA);return i.bindFramebuffer(f.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),i.setViewport(o.x,o.y,o.width,o.height),this._compositingPassParameters.color=f.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(a),f.release(),t}_renderCommon(e){this._vao!=null&&(e.bindVAO(this._vao),e.drawArrays(bi.TRIANGLE_STRIP,0,4))}_update(){var o;const e=this.bindParameters.camera,t=Zs(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]*this._passParameters.radii[1],a=Q((i-this._passParameters.radii[0])/os.atmosphereHeight,0,1);vn(this._passParameters.heightParameters,i,t,r,a);const n=((o=this.view.basemapTerrain)==null?void 0:o.getLowerBoundRadius())??0;xo(this._passParameters.radii,n,n+os.atmosphereHeight),this._passParameters.hazeStrength=ze(ze(.6,1,ac(9500,10500,i-os.radius)),1,this._amount)}};ag=c([F("esri.views.3d.webgl-engine.effects.haze.Haze")],ag);function WN(s){const e=s.fragment;s.include(Zg),e.include(xp),e.code.add(w`vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
float leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);
float rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);
float bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);
float topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`)}let $f=class extends Ua{constructor(){super(...arguments),this.receiveShadows=!0}};c([ne()],$f.prototype,"receiveShadows",void 0);const QN=.025;function bC(){const s=new kt;s.include(Qg,YN),s.include(sr),s.include(WN);const e=s.fragment;return e.include(Yg),e.uniforms.add(new br("defaultDepthTex",t=>t.shadowMap.getSnapshot(Hd.ExcludeHighlight)),new br("highlightDepthTex",t=>t.shadowMap.getSnapshot(Hd.Highlight)),new br("depthMap",t=>{var i;return(i=t.depth)==null?void 0:i.attachment}),new ft("highlightTexture",t=>t.highlight),new wp("uColor",t=>t.shadowColor),new Ze("opacity",t=>t.shadowOpacity),new Ze("occludedOpacity",t=>t.occludedShadowOpacity),new Ze("terminationFactor",t=>t.opacityElevation*t.dayNightTerminator),new gn("lightingMainDirectionView",({lighting:t,camera:i})=>ie(pb,Gt(pb,t.mainLight.direction,i.viewInverseTransposeMatrix))),new bn("inverseViewMatrix",({camera:t})=>hc(db,lc(db,t.viewMatrix,t.center)))).main.add(w`
    ivec2 highlightTextureSize = textureSize(highlightTexture, 0);
    ivec2 highlightIUV = ivec2(uv * vec2(highlightTextureSize));
    vec4 highlightInfo = texelFetch(highlightTexture, highlightIUV, 0);

    fragColor = vec4(0.0);

    // Calculate bit mask to check if pixel is highlit unoccluded at any level
    int ored =
         (int(highlightInfo.r*255.0) << 0)
       | (int(highlightInfo.g*255.0) << 8);
    bool visiblyHighlighted = ((ored & ~(ored >> 1)) & (1+4+16+64)) != 0;
    if (visiblyHighlighted) {
      return;
    }

    // 1.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
    float depth = depthFromTexture(depthMap, uv);
    if (depth >= 1.0 || depth <= 0.0) {
      return;
    }

    float currentPixelDepth = linearizeDepth(depth);
    vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
    vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;

    mat4 shadowMatrix;
    float linearDepth = -currentPixelDepth;
    int i = chooseCascade(linearDepth, shadowMatrix);
    if (i >= numCascades) {
      return;
    }

    // vertex completely outside? -> no shadow
    vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
    if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
      return;
    }

    ivec2 texSize = textureSize(highlightDepthTex, 0);
    ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));

    float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
    bool shadowHighlight = depthHighlight < lvpos.z;
    if (!shadowHighlight) {
      return;
    }

    float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
    bool shadowDefault = depthDefault < lvpos.z;

    vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);
    bool shaded = dot(normal, lightingMainDirectionView) < ${w.float(QN)};

    float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
    fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
  `),s}const db=It(),pb=v(),YN=new $f,ZN=Object.freeze(Object.defineProperty({__proto__:null,build:bC},Symbol.toStringTag,{value:"Module"}));let XN=class extends Wg{constructor(){super(...arguments),this.shadowColor=Pr(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}},mb=class extends Bt{constructor(e,t){super(e,t,new qt(ZN,()=>X(()=>Promise.resolve().then(()=>J4),void 0,import.meta.url))),this.primitiveType=bi.TRIANGLE_STRIP}initializePipeline(){return Qt({blending:Dc,colorWrite:ti,depthTest:null,depthWrite:null})}};const KN=1/512,JN=4e4,e5=5e4;let al=class extends Co{constructor(e){super(e),this.produces=gt.COMPOSITE,this.consumes={required:[gt.COMPOSITE,"highlights"]},this._passParameters=new XN,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([O(()=>this.view.highlightOptions.shadowOpacity,e=>{this._passParameters.shadowOpacity=e??RO,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},Be),O(()=>this.view.highlightOptions.shadowDifference,e=>{this._shadowDifference=e??AO,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},Be),O(()=>this.view.highlightOptions.shadowColor,e=>{this._passParameters.shadowColor=jg(e??DO),this._ensureMaxOpacity()},Be)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(Ce.UPDATE)}precompile(){this.techniques.precompile(mb)}render(e){var a;const t=e.find(({name:n})=>n===gt.COMPOSITE),i=this.bindParameters;if(!i.shadowHighlightsVisible||!i.depth||!this._ensureIfVisible(i.camera,i.lighting.mainLight.direction))return t;const r=this.techniques.get(mb);if(r.compiled){this._passParameters.highlight=(a=e.find(({name:o})=>o==="highlights"))==null?void 0:a.getTexture(),this._passParameters.origin=i.camera.center;const n=this.renderingContext;n.bindFramebuffer(t.fbo),n.bindTechnique(r,i,this._passParameters),n.screen.draw()}else this.requestRender(Ce.UPDATE);return t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-ac(JN,e5,e.relativeElevation);const i=this.viewingMode===Ne.Global?ie(_b,e.center):ce(_b,0,0,1),r=oe(i,t);return this._passParameters.dayNightTerminator=ac(0,1,Q(30*r,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=KN}};c([m()],al.prototype,"produces",void 0),c([m()],al.prototype,"consumes",void 0),c([m({constructOnly:!0})],al.prototype,"viewingMode",void 0),al=c([F("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],al);const _b=v();let If=class extends Ii{constructor(){super(...arguments),this.mask=null,this.overlay=null,this.input=null,this.size=0}};function wC(){const s=new kt;return s.attributes.add(De.POSITION,"vec2"),s.vertex.uniforms.add(new wp("drawPosition",(e,t)=>t5(e,t))),s.varyings.add("vUV","vec2"),s.vertex.main.add(w`vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);`),s.fragment.uniforms.add(new ft("textureInput",e=>e.input)),s.fragment.uniforms.add(new ft("textureMask",e=>e.mask)),s.fragment.uniforms.add(new ft("textureOverlay",e=>e.overlay)),s.fragment.uniforms.add(new Sc("maskEnabled",e=>e.magnifier.maskEnabled)),s.fragment.uniforms.add(new Sc("overlayEnabled",e=>e.magnifier.overlayEnabled)),s.fragment.code.add(w`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}`),s.fragment.main.add(w`float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;`),s}function t5(s,e){const t=e.camera.pixelRatio,i=s.magnifier.offset.x*t,r=s.magnifier.offset.y*t;Ea(s.magnifier.position,gb);const a=e.camera.screenToRender(gb,i5),n=Math.ceil(t*s.magnifier.size),{fullWidth:o,fullHeight:l}=e.camera;return vn(s5,(a[0]+i)/o*2-1,(a[1]-r)/l*2-1,n/o*2,n/l*2)}const gb=ri(),i5=Qb(),s5=Mi(),r5=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:If,build:wC},Symbol.toStringTag,{value:"Module"}));let fb=class extends Bt{constructor(e,t){super(e,t,new qt(r5,()=>X(()=>Promise.resolve().then(()=>eV),void 0,import.meta.url)))}initializePipeline(){return Qt({blending:Dg,depthTest:null,depthWrite:null,colorWrite:ti})}},jn=class extends Co{constructor(){super(...arguments),this.produces=ge.MAGNIFIER,this.consumes={required:[ge.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new If,this._vao=null,this._magnifier=null,this._tmpScreenPoint=ri(),this._tmpRenderPoint=Qb()}initialize(){this.addHandles([O(()=>this.view.magnifier,e=>this._update(e),Be)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{const i=this._validMagnifier;i?(this._loadResources(i),this.produces=ge.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles(O(()=>{var i;return(i=this._magnifier)==null?void 0:i.version},t)),t()}get _validMagnifier(){var e,t,i;return(e=this._magnifier)!=null&&e.visible&&((t=this._magnifier)!=null&&t.position)&&((i=this._magnifier)==null?void 0:i.size)>0?this._magnifier:null}get _factor(){var e;return((e=this._magnifier)==null?void 0:e.factor)||1}destroy(){this._magnifier=null,this._imageLoadTask!=null&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=We(this._vao)}_disposeTextures(){this._passParameters.mask=We(this._passParameters.mask),this._passParameters.overlay=We(this._passParameters.overlay),this._passParameters.input=We(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(fb)}render(e){const t=this._validMagnifier,i=e.find(({name:b})=>b===ge.MAGNIFIER);if(t==null)return i;if(this._imageSources==null)return this.requestRender(Ce.UPDATE),i;const r=this.renderingContext,a=this.camera.pixelRatio,n=Math.ceil(a*t.size);this._vao??(this._vao=Sn(r,na.Pos2,Bl,0,1));const o=this.techniques.get(fb);if(this._ensureTextureResources(r,n),!o.compiled||!this._passParameters.input)return this.requestRender(Ce.UPDATE),i;const l=Math.ceil(1/this._factor*n),h=this._passParameters.input;h.resize(l,l),Ea(t.position,this._tmpScreenPoint);const u=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),d=this.camera.fullWidth,p=this.camera.fullHeight,_=.5*l,f=.5*l;u[0]=Q(u[0],_,d-_-1),u[1]=Q(u[1],f,p-f-1);const g=Math.floor(u[0]-_),y=Math.floor(u[1]-f);return r.bindFramebuffer(i.fbo),o.program.bindTexture("textureInput",h),r.gl.copyTexImage2D(h.descriptor.target,0,h.descriptor.pixelFormat,g,y,l,l,0),this._passParameters.magnifier=t,r.bindTechnique(o,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(bi.TRIANGLE_STRIP,0,4),i}_loadResources(e){var r,a,n;const{maskUrl:t,overlayUrl:i}=e;((r=this._imageLoadTask)==null?void 0:r.maskUrl)===t&&((a=this._imageLoadTask)==null?void 0:a.overlayUrl)===i||((n=this._imageLoadTask)==null||n.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:Oc(async o=>{const l=t==null||i==null?d2(o):null,h=t!=null?yc(t,{signal:o}):l.then(d=>d.mask),u=i!=null?yc(i,{signal:o}):l.then(d=>d.overlay);this._imageSources={mask:await h,overlay:await u}})})}_ensureTextureResources(e,t){if(this._imageSources==null||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay)return;this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t;const i=new mi;i.internalFormat=ni.RGBA,i.wrapMode=Ki.CLAMP_TO_EDGE,i.flipped=!0,i.preMultiplyAlpha=!Zb(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result,this._passParameters.overlay=new oi(e,i,this._imageSources.overlay),i.pixelFormat=i.internalFormat=ni.ALPHA,i.preMultiplyAlpha=!1,this._passParameters.mask=new oi(e,i,this._imageSources.mask),i.pixelFormat=i.internalFormat=ni.RGBA,i.flipped=!1,this._passParameters.input=new oi(e,i)}};c([m()],jn.prototype,"produces",void 0),c([m()],jn.prototype,"consumes",void 0),c([m()],jn.prototype,"_imageSources",void 0),c([m()],jn.prototype,"_imageLoadTask",void 0),jn=c([F("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],jn);const yh=8,a5=16;function xC(){const s=new kt;s.include(sr),s.fragment.uniforms.add(new ft("edgesTexture",t=>t.inputTexture),new ft("areaTexture",t=>t.areaTexture),new ft("searchTexture",t=>t.searchTexture)),s.fragment.constants.add("smaaAreaTexPixelSize","vec2",[1/160,1/560]);const e=1/7;return s.fragment.code.add(w`
    vec4 sampleLevelZeroOffset(vec2 coord, vec2 offset, vec2 resolution) {
      return texture(edgesTexture, coord + offset.x * resolution);
    }

    float searchLength(vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture(searchTexture, e).r;
    }

    float searchLeft(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${w.int(yh)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x > end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${w.int(yh)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x < end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength(e, 0.5, 0.5);
      return texcoord.x;
    }

    float searchUp(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${w.int(yh)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y > end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength(e.gr, 0.0, 0.5);
      return texcoord.y;
    }

    float searchDown(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${w.int(yh)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y < end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength(e.gr, 0.5, 0.5);
      return texcoord.y;
    }

    vec2 getArea(sampler2D areaTex, vec2 dist, float e1, float e2, float offset) {
      vec2 texcoord = float(${w.int(a5)}) * round(4.0 * vec2(e1, e2)) + dist;
      texcoord = smaaAreaTexPixelSize * texcoord + (0.5 * smaaAreaTexPixelSize);
      texcoord.y += ${w.float(e)} * offset;
      return texture(areaTex, texcoord).rg;
    }`),s.fragment.main.add(w`
    vec2 size = vec2(textureSize(edgesTexture, 0));
    vec2 resolution = 1.0 / size;
    vec2 pixelCoord = uv * size;
    vec4 offsets[2];
    offsets[0] = uv.xyxy + resolution.xyxy * vec4(-0.25, 0.125, 1.25, 0.125);
    offsets[1] = uv.xyxy + resolution.xyxy * vec4(-0.125, 0.25, -0.125, -1.25);
    vec4 maxOffset = vec4(offsets[0].xz, offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * resolution.xxyy * float(${w.int(yh)});
    ivec4 subsampleIndices = ivec4(0.0);
    vec4 weights = vec4(0.0);
    vec2 e = texture(edgesTexture, uv).rg;
    if (e.r > 0.0) {
      vec2 d;
      vec2 coords;
      coords.y = searchUp(offsets[1].xy, maxOffset.z, resolution);
      coords.x = offsets[0].x;
      d.x = coords.y;
      float e1 = texture(edgesTexture, coords).g;
      coords.y = searchDown(offsets[1].zw, maxOffset.w, resolution);
      d.y = coords.y;
      d = d * size.y - pixelCoord.y;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(0.0, 1.0), resolution).g;
      weights.ba = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.x));
      // for some reason the following lines are necessary to prevent
      // texture lookup precision issues on some Intel integrated graphics chips
      vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
      weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
    }
    if (e.g > 0.0) {
      vec2 d;
      vec2 coords;
      coords.x = searchLeft(offsets[0].xy, maxOffset.x, resolution);
      coords.y = offsets[1].y;
      d.x = coords.x;
      float e1 = texture(edgesTexture, coords).r;
      coords.x = searchRight(offsets[0].zw, maxOffset.y, resolution);
      d.y = coords.x;
      d = d * size.x - pixelCoord.x;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(1.0, 0.0), resolution).r;
      weights.rg = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.y));
    }
    fragColor = weights;
  `),s}const n5=Object.freeze(Object.defineProperty({__proto__:null,build:xC},Symbol.toStringTag,{value:"Module"}));let yb=class extends Bt{constructor(e,t){super(e,t,new qt(n5,()=>X(()=>Promise.resolve().then(()=>tV),void 0,import.meta.url)))}initializePipeline(){return Qt({colorWrite:ti})}};function CC(){const s=new kt;return s.include(sr),s.fragment.uniforms.add(new ft("blendWeightsTexture",e=>e.inputTexture),new ft("colorTexture",e=>e.color)),s.fragment.main.add(w`vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}`),s}const o5=Object.freeze(Object.defineProperty({__proto__:null,build:CC},Symbol.toStringTag,{value:"Module"}));let vb=class extends Bt{constructor(e,t){super(e,t,new qt(o5,()=>X(()=>Promise.resolve().then(()=>iV),void 0,import.meta.url)))}initializePipeline(){return Qt({colorWrite:ti})}};const l5=.05,h5=2;function TC(){const s=new kt;return s.include(sr),s.outputs.add("fragEdges","vec2"),s.fragment.code.add(w`float absMax3(vec3 v) {
vec3 t = abs(v);
return max(max(t.r, t.g), t.b);
}`),s.fragment.uniforms.add(new ft("colorTexture",e=>e.color)).main.add(w`
    vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
    vec4 offsets[3];
    offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
    offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
    offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

    // Calculate color deltas:
    vec3 C = texture(colorTexture, uv).rgb;
    vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
    vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
    vec2 delta = vec2(absMax3(C - Cleft), absMax3(C - Ctop));
    vec2 edges = step(vec2(${w.float(l5)}), delta);

    // discard if there is no edge:
    if (dot(edges, vec2(1.0)) == 0.0) {
      fragEdges = vec2(0.0);
    }
    else {
      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      float horizontal = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      float vertical = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), horizontal), vertical);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      horizontal = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      vertical = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, horizontal), vertical);

      // Local contrast adaptation in action:
      fragEdges = edges * step(maxDelta, float(${w.float(h5)}) * delta);
    }
  `),s}const c5=Object.freeze(Object.defineProperty({__proto__:null,build:TC},Symbol.toStringTag,{value:"Module"}));let bb=class extends Bt{constructor(e,t){super(e,t,new qt(c5,()=>X(()=>Promise.resolve().then(()=>sV),void 0,import.meta.url)))}initializePipeline(){return Qt({colorWrite:ti})}},u5=class extends Ii{},Wn=class extends Co{constructor(e){super(e),this.produces="disabled",this.consumes={required:[ge.ANTIALIASING],optional:[gt.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new u5}initialize(){this.addHandles([O(()=>this.isEnabled(),e=>e?this.enable():this.disable(),Be)])}async enable(){if(this.produces=ge.ANTIALIASING,this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const e=this._abortController.signal;try{const t=await X(()=>import("./SMAAData-DCEZ61Cs.js"),[],import.meta.url);await this._loadTextures(t,e),this.requestRender(Ce.UPDATE)}catch{}this._abortController=null}async _loadTextures(e,t){Ai(t);const[i,r]=await Promise.allSettled([yc(e.areaTexture,{signal:t}),yc(e.searchTexure,{signal:t})]);if(Ai(t),i.status!=="fulfilled"||r.status!=="fulfilled")return;const a=this.renderingContext;this._areaTexture=wb(a,Ds.LINEAR,ni.RGB,i.value),this._searchTexture=wb(a,Ds.NEAREST,ni.LUMINANCE,r.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=We(this._searchTexture),this._areaTexture=We(this._areaTexture)}precompile(){this.techniques.precompile(bb),this.techniques.precompile(yb),this.techniques.precompile(vb)}render(e){const t=e.find(({name:_})=>_===ge.ANTIALIASING);if(!this._areaTexture||!this._searchTexture)return this.requestRender(Ce.UPDATE),t;const i=this.techniques.get(bb),r=this.techniques.get(yb),a=this.techniques.get(vb);if(!i.compiled||!r.compiled||!a.compiled)return this.requestRender(Ce.UPDATE),t;const n=e.find(({name:_})=>_===gt.COMPOSITE);if(!n)return t;const o=n.fbo.width,l=n.fbo.height,h=this.renderingContext;h.setViewport(0,0,o,l);const u=this.fboCache.acquire(o,l,"smaa edges",di.RG);h.bindFramebuffer(u.fbo),h.setClearColor(0,0,0,1),h.clear(Jt.COLOR),this._smaaParameters.color=n.getTexture();const d=this.bindParameters;h.bindTechnique(i,d,this._smaaParameters),h.screen.draw();const p=this.fboCache.acquire(o,l,"smaa blend");return h.bindFramebuffer(p.fbo),h.setClearColor(0,0,1,1),h.clear(Jt.COLOR),this._smaaParameters.inputTexture=u.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,h.bindTechnique(r,d,this._smaaParameters),h.screen.draw(),u.release(),h.bindFramebuffer(t.fbo),h.setClearColor(0,1,0,1),h.clear(Jt.COLOR),this._smaaParameters.inputTexture=p.getTexture(),h.bindTechnique(a,d,this._smaaParameters),h.screen.draw(),p.release(),t}};function wb(s,e,t,i){const r=new mi;return r.pixelFormat=t,r.wrapMode=Ki.CLAMP_TO_EDGE,r.width=i.width,r.height=i.height,r.samplingMode=e,new oi(s,r,i)}c([m()],Wn.prototype,"produces",void 0),c([m()],Wn.prototype,"consumes",void 0),c([m({constructOnly:!0})],Wn.prototype,"isEnabled",void 0),c([m()],Wn.prototype,"_abortController",void 0),Wn=c([F("esri.views.3d.webgl-engine.effects.smaa.SMAA")],Wn);function SC(){const s=new kt;return s.attributes.add(De.POSITION,"vec3"),s.attributes.add(De.COLOR,"vec4"),s.attributes.add(De.SIZE,"float"),s.varyings.add("vcolor","vec4"),s.varyings.add("vsize","float"),s.vertex.uniforms.add(new Y2("transform",(e,t)=>d5(e,t)),new WP("viewport",e=>e.camera.fullViewport),new D1("pixelRatio",e=>e.camera.pixelRatio)),s.vertex.main.add(w`gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;`),s.fragment.main.add(w`float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);`),s}function d5(s,e){return Rc(Wa,e.camera.projectionMatrix),Wa[10]=24e-8-1,Wa[11]=-1,Wa[14]=(24e-8-2)*e.camera.near,Zr(Wa,Wa,e.camera.viewMatrix),Zr(Wa,Wa,s.modelMatrix)}const Wa=It(),p5=Object.freeze(Object.defineProperty({__proto__:null,build:SC},Symbol.toStringTag,{value:"Module"}));let m5=class extends Ii{constructor(){super(...arguments),this.modelMatrix=It()}},xb=class extends Bt{constructor(e,t){super(e,t,new qt(p5,()=>X(()=>Promise.resolve().then(()=>rV),void 0,import.meta.url)))}initializePipeline(){return Qt({blending:Dc,depthTest:{func:Zi.LEQUAL},colorWrite:ti})}},ng=class extends Yr{constructor(){super(...arguments),this._starData=null,this._loadDataTask=null,this._numPoints=0,this._passParameters=new m5}initialize(){this.addHandles([O(()=>this.view.environment.starsEnabled,e=>e?this._enable():this._disable(),at),O(()=>this.view.environment.lighting.type==="virtual"?null:this.view.environment.lighting.date,e=>this._update(e),Be)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=xn(this._loadDataTask),this._numPoints=0,this._vao=We(this._vao),this._starData=null}precompile(){this.techniques.precompile(xb)}render(e){const t=e.find(({name:a})=>a===ge.OPAQUE_ENVIRONMENT),i=this.renderingContext;if(this.loading)return this.requestRender(Ce.UPDATE),t;if(!this._starData)return t;this._vao??(this._vao=this._ensureResources(this._starData,i));const r=this.techniques.get(xb);return r.compiled?(i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(bi.POINTS,0,this._numPoints),t):(this.requestRender(Ce.UPDATE),t)}_ensureResources(e,t){return this._numPoints=e.byteLength/PC,_5(t,new Float32Array(e,0,2*this._numPoints),new Uint8Array(e,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*g5(e),r=Rc(this._passParameters.modelMatrix,x5);by(r,r,-i*Math.PI),Zr(r,w5,r),by(r,r,-t*Math.PI),this.requestRender(Ce.UPDATE)}_createLoadDataTask(){if(this._starData)return null;const e=Oc(async t=>{const{data:i}=await yT("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});f5(i),this._starData=i});return e.promise.catch(t=>{cn(t)||pe.getLogger(this).error(t)}).then(()=>{this.destroyed||this.requestRender(Ce.UPDATE)}),e}};function _5(s,e,t,i){const r=Cb.createBuffer(i),a=r.position,n=r.color,o=r.size;for(let l=0;l<i;l++){const h=e[2*l],u=e[2*l+1];a.set(l,0,-Math.cos(h)*Math.sin(u)),a.set(l,1,-Math.sin(h)*Math.sin(u)),a.set(l,2,-Math.cos(u));const d=v5(t[l]),p=y5(b5[d[1]]);n.set(l,0,255*p[0]),n.set(l,1,255*p[1]),n.set(l,2,255*p[2]),n.set(l,3,255),o.set(l,d[0])}return new Tn(s,Bl,new Map([["geometry",Fa(Cb)]]),new Map([["geometry",$s.createVertex(s,wr.STATIC_DRAW,r.buffer)]]))}function g5(s){const e=s,t=new Date(s.getFullYear(),0,1,11,58,56);return(+e-+t)/(+new Date(s.getFullYear()+1,0,1,11,58,55)-+t)}function f5(s){if(!s)throw new Ri("stars:no-data-received","Failed to create stars because star catalogue is missing");const e=s.byteLength/PC;if(e%1!=0||e>5e4||e<5e3)throw new Ri("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}function y5(s){return[parseInt(s.slice(0,2),16),parseInt(s.slice(2,4),16),parseInt(s.slice(4,6),16)]}function v5(s){return s>=192?[2.9,s-192]:s>=160?[2.5,s-160]:s>=128?[2,s-128]:s>=96?[1.5,s-96]:s>=64?[1,s-64]:s>=32?[.7,s-32]:[.4,s]}ng=c([F("esri.views.3d.webgl-engine.effects.stars.Stars")],ng);const b5=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],w5=S1(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),x5=S1(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),PC=9,Cb=Cn().vec3f(De.POSITION).vec4u8(De.COLOR).f32(De.SIZE);let Lf=class extends Ii{};function EC(){const s=new kt;return s.include(sr),s.fragment.uniforms.add(new ft("tex",e=>e.texture)),s.fragment.main.add(w`fragColor = vec4(1.0 - texture(tex, uv).a);`),s}const C5=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:Lf,build:EC},Symbol.toStringTag,{value:"Module"}));let Tb=class extends Bt{constructor(e,t){super(e,t,new qt(C5,()=>X(()=>Promise.resolve().then(()=>aV),void 0,import.meta.url)))}initializePipeline(){return Qt({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}},T5=class{constructor(e,t){this._rctx=e,this._techniques=t,this._configuration=new F2,this._passParameters=new U2,this._hudParameters=new Lf,this._configuration.blitMode=Hn.PremultipliedAlpha,this._techniques.precompile(th,this._configuration),this._configuration.hasOpacityFactor=!0,this._techniques.precompile(th,this._configuration),this._configuration.hasOpacityFactor=!1,this._configuration.blitMode=Hn.Alpha,this._techniques.precompile(th,this._configuration),this._configuration.blitMode=Hn.Depth,this._techniques.precompile(th,this._configuration),this._techniques.precompile(Tb)}compositeHUD(e,t){this._hudParameters.texture=t;const i=this._techniques.get(Tb);this._rctx.bindTechnique(i,e,this._hudParameters),this._rctx.screen.draw()}compositePreMultipliedAlpha(e,t,i=1){this._composite(e,t,Hn.PremultipliedAlpha,i)}composite(e,t){this._composite(e,t,Hn.Alpha,1)}blitDepthToLinearDepth(e,t){this._composite(e,t,Hn.Depth,1)}_composite(e,t,i,r){this._configuration.blitMode=i,this._configuration.hasOpacityFactor=r!==1,this._passParameters.texture=t,this._passParameters.opacity=r;const a=this._techniques.get(th,this._configuration);this._rctx.bindTechnique(a,e,this._passParameters),this._rctx.screen.draw()}},S5=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new Zd(new ArrayBuffer(4)),this._layerToOidToColor=new Yd,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new Yd,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,i,r,a,n=null,o=null,l=null){e&&t&&i&&r&&(this._layerUidToId.set(r,i),this._layerUidToPopupEnabled.set(r,a),a&&this._layerUidToGraphicsUidToObjectId.set(r,t,{objectId:e,attributeNodeId:n,attributeIndex:o,subLayerId:l}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return Pr(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){var n;if(!e.layerUid||!e.graphicUid)return this.colorZero;const t=this._layerUidToPopupEnabled.get(e.layerUid);if(t===void 0)return this.colorZero;if(t===!1)return this.colorZero;const i=(n=this._layerUidToGraphicsUidToObjectId.get(e.layerUid,e.graphicUid))==null?void 0:n.objectId;if(!i)return this.colorZero;let r=this._layerToOidToColor.get(e.layerUid,i);if(!r){if(Gi("enable-feature:objectAndLayerId-screenshot-testing"))r=i;else for(;!r;){const o=Math.floor(16777214*Math.random())+1;this._colorToUID.has(o)||(r=o)}if(r>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerUid,i,r),this._colorToUID.set(r,e)}const a=new ArrayBuffer(4);return new DataView(a).setUint32(0,r,!1),new Zd(a)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,i]of this._colorToUID.entries()){const r=this._layerUidToGraphicsUidToObjectId.get(i.layerUid,i.graphicUid),a=this._layerUidToId.get(i.layerUid);r&&a&&e.set(t,r.attributeNodeId?{type:"object-and-layer-and-i3s-id",olid:r.objectId,lid:a,attrId:r.attributeNodeId,attrIdx:r.attributeIndex,subLayerId:r.subLayerId}:{type:"object-and-layer-id",olid:r.objectId,lid:a})}return e}},OC=class{constructor(e,t){this.key=e,this.free=t,this.incarnation=0,this._refCount=1}retain(e=1){this._refCount+=e}release(){return this._refCount===0?(console.log(`Releasing already released FBO attachment "${this.name}" in ${new Error().stack}`),!0):(--this._refCount,this._refCount===0&&(this.free(),!0))}};var Ul;(function(s){s[s.FBO=0]="FBO",s[s.DEPTH=1]="DEPTH",s[s.COLOR=2]="COLOR"})(Ul||(Ul={}));let MC=class extends OC{constructor(e,t,i){super(e,i),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get cachedMemory(){return this.attachment.usedMemory}},P5=class extends MC{constructor(e,t,i){super(e,t,i),this.attachment=t,this.type=Ul.COLOR}},Sb=class extends MC{constructor(){super(...arguments),this.type=Ul.DEPTH}};function E5(s){return(s==null?void 0:s.attachment.type)===iE.Texture}let RC=class extends OC{constructor(e,t,i,r,a,n){super(e,n),this.type=Ul.FBO,this._colors=new Map,this._name=gt.COMPOSITE,this.acquireDepth=null,this.acquireColor=null,this._name=t,this.fbo=i,this.acquireDepth=r,this.acquireColor=a}dispose(){var e;(e=this.fbo)==null||e.dispose()}get cachedMemory(){var e;return((e=this.fbo)==null?void 0:e.usedMemory)||0}get numberOfColorAttachments(){return this._colors.size}get name(){return this._name}setName(e){this._name=e}getTexture(e=hs.COLOR_ATTACHMENT0){var t,i;return e===Bd?(t=this.fbo)==null?void 0:t.depthStencilTexture:(i=this.fbo)==null?void 0:i.getColorTexture(e)}getAttachment(e=hs.COLOR_ATTACHMENT0){return e===Bd?this._depth:this._colors.get(e)}hasAttachment(e){return qu(this._colors,t=>t.name===e)}attachDepth(e){var t;return e==null||e.retain(),this.detachDepth(),e&&((t=this.fbo)==null||t.attachDepthStencil(e.attachment)),this._depth=e,this}detachDepth(){var e,t;(e=this.fbo)==null||e.detachDepthStencilTexture(),(t=this.fbo)==null||t.detachDepthStencilBuffer(),this._depth=ui(this._depth)}obtainDepthTexture(){var t;const e=this._depth;return E5(e)?((t=this.fbo)==null||t.detachDepthStencilTexture(),this._depth=null,e):null}attachColor(e,t){var i;return e.retain(),this.detachColor(t),(i=this.fbo)==null||i.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){var i;(i=this.fbo)==null||i.detachColorTexture(e);const t=this._colors.get(e);this._colors.delete(e),t==null||t.release()}detachAll(){this._colors.forEach((e,t)=>this.detachColor(t)),this.detachDepth()}},Xm=class{constructor(e,t){this._last=new mt,this._incarnation=0,this._cache=new Uc(e,t)}destroy(){var e;(e=this._last)==null||e.forAll(t=>t.dispose()),this._last=null,this._cache.destroy()}set interactive(e){var t;e&&!this._last?this._last=new mt:e||((t=this._last)==null||t.forAll(i=>i.dispose()),this._last=null)}clean(){var e;(e=this._last)==null||e.filterInPlace(t=>!(t.incarnation<this._incarnation)||(this._cache.put(t.key,t),!1))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find(i=>i.key===e);if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){var e;return((e=this._last)==null?void 0:e.reduce((t,i)=>t+i.cachedMemory,0))??0}},O5=class{constructor(e){this.rctx=e,this._acquired=new Set,this._cache=new Xm(e.newCache,"FBOCache"),this._depthCache=new Xm(e.newCache,"DepthAttachmentCache"),this._colorCache=new Xm(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){var e;this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),(e=this.debugCallback)==null||e.call(this)}frameEnd(){const e=this.debugCallback;e&&this._acquired.forEach(t=>t.type===Ul.FBO&&e(t.name,t.fbo,t.numberOfColorAttachments))}get usedMemory(){return Array.from(this._acquired.values()).reduce((e,t)=>{var i;return e+("getTexture"in t?((i=t.getTexture())==null?void 0:i.usedMemory)??0:t.cachedMemory)},this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e}acquire(e,t,i,r=di.RGBA){const a=Km(r,e,t);let n=this._cache.pop(a);if(n){n.retain(),n.setName(i);const o=this.rctx.getBoundFramebufferObject();if(this.rctx.bindFramebuffer(n.fbo),this.rctx.setDrawBuffers([hs.COLOR_ATTACHMENT0]),!n.fbo)throw new Ri("attempt to use a not existing framebuffer");this.rctx.unbindTexture(n.fbo.colorTexture),this.rctx.bindFramebuffer(o)}else n=new RC(a,i,new $c(this.rctx,{...Pb[r],width:e,height:t}),o=>{o??(o=Yi.DEPTH_STENCIL_TEXTURE);const l=this._acquireDepth(o,n.fbo.width,n.fbo.height,`${n.name} depth`);return n.attachDepth(l),l.release(),n},(o,l,h)=>{l??(l=di.RGBA);const u=this._acquireColor(l,e,t,h??`${n.name} color ${o}`);return this.rctx.unbindTexture(u.attachment),n.attachColor(u,o),u.release(),n},()=>{var o;(o=this.debugCallback)==null||o.call(this,n.name,n.fbo,n.numberOfColorAttachments),this._acquired.delete(n),n.detachAll(),this._cache.put(n)});return this._trackHandle(n)}acquireDepth(e,t,i,r){return this._acquireDepth(e,t,i,r)}_acquireDepth(e,t,i,r){const a=Km(e,t,i),n=this._depthCache.pop(a);if(n)return n.retain(),n.name=r,this._trackHandle(n);const o=e===Yi.DEPTH_STENCIL_TEXTURE?new Sb(a,new oi(this.rctx,{...Eb[e],width:t,height:i}),()=>{this._acquired.delete(o),this._depthCache.put(o)}):new Sb(a,new KP(this.rctx,{...Eb[e],width:t,height:i}),()=>{this._acquired.delete(o),this._depthCache.put(o)});return o.name=r,this._trackHandle(o)}_acquireColor(e,t,i,r){const a=Km(e,t,i),n=this._colorCache.pop(a);if(n)return n.retain(),n.name=r,this._trackHandle(n);const o=new P5(a,new oi(this.rctx,{...Pb[e],width:t,height:i}),()=>{this._acquired.delete(o),this._colorCache.put(o)});return o.name=r,this._trackHandle(o)}_trackHandle(e){return this._acquired.add(e),e}};const sn=new RC("default","default",null,()=>sn,()=>sn,()=>{});function Km(s,e,t){return`${s}x${e}x${t}`}sn.release=()=>!1;const Cd=new mi;Cd.pixelFormat=ni.RED,Cd.internalFormat=zl.R8,Cd.wrapMode=Ki.CLAMP_TO_EDGE;const Td=new mi;Td.pixelFormat=ni.RG,Td.internalFormat=zl.RG8,Td.wrapMode=Ki.CLAMP_TO_EDGE;const Sd=new mi;Sd.internalFormat=zl.RGBA4,Sd.dataType=fo.UNSIGNED_SHORT_4_4_4_4,Sd.wrapMode=Ki.CLAMP_TO_EDGE;const AC=new mi;AC.wrapMode=Ki.CLAMP_TO_EDGE;const Vh=new mi;Vh.wrapMode=Ki.CLAMP_TO_EDGE,Vh.samplingMode=Ds.LINEAR_MIPMAP_LINEAR,Vh.hasMipmap=!0,Vh.maxAnisotropy=8;const Fh=new mi;Fh.pixelFormat=ni.RED,Fh.dataType=fo.HALF_FLOAT,Fh.internalFormat=zl.R16F,Fh.samplingMode=Ds.NEAREST;const Pd=new mi;Pd.dataType=fo.HALF_FLOAT,Pd.internalFormat=zl.RGBA16F,Pd.samplingMode=Ds.NEAREST;const Pb={[di.RED]:Cd,[di.RG]:Td,[di.RGBA4]:Sd,[di.RGBA]:AC,[di.RGBA_MIPMAP]:Vh,[di.R16F]:Fh,[di.RGBA16F]:Pd},nl=new mi;nl.pixelFormat=ni.DEPTH_STENCIL,nl.dataType=fo.UNSIGNED_INT_24_8,nl.samplingMode=Ds.NEAREST,nl.wrapMode=Ki.CLAMP_TO_EDGE,nl.internalFormat=ni.DEPTH24_STENCIL8;const Eb={[Yi.DEPTH_STENCIL_TEXTURE]:nl,[Yi.DEPTH16_BUFFER]:new F1(L1.DEPTH_COMPONENT16,4)};var Pc;(function(s){s[s.FrontToBack=0]="FrontToBack",s[s.BackToFront=1]="BackToFront"})(Pc||(Pc={}));let ma=class{constructor(e,t,i=Pc.FrontToBack){this._rctx=e,this._techniques=t,this._sorting=i,this._draws=new mt({allocator:r=>r??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r,a){const n=this._draws.pushNew();n.geometry=t,n.geometryRanges=i,n.material=e,n.depthSquaredHint=r,n.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0,n.highlightName=a}acquire(e,t){return this._draws.map(i=>i.material.acquireTechnique(this._techniques,e,t,i.geometry.parameters))}dispatch(e,t,i){var l,h;const r=this._rctx;this._previouslyBoundDraw.clear();let a=null;const n=this._draws.length,o=(l=t.highlight)==null?void 0:l.name;for(let u=0;u<n;u++){const d=this._draws.data[u];if(e.identifier===Ws.Highlight){const C=d.highlightName;if(C){if(C!==o)continue}else if(!o||!((h=t.overlay)!=null&&h.hasHighlightOptions(o)))continue}const p=i[u];p===a&&t.oitPass===Qi.NONE||(r.bindTechnique(p,t,e),a=p);const{geometryRanges:_,indexType:f,geometry:g,material:y}=d;r.bindVAO(g.vao),this._previouslyBoundDraw.get(p)!==y&&(p.program.bindDraw(t,e,y),this._previouslyBoundDraw.set(p,y));const b=_.length,{primitiveType:x}=g;for(let C=0;C<b;C+=2){const T=_[C],P=_[C+1];if(f!==0){const S=Ed.get(f);r.drawElements(x,P,f,T*S)}else r.drawArrays(x,T,P)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===Pc.FrontToBack?1:-1;this._draws.sort((t,i)=>{const r=e*(t.depthSquaredHint-i.depthSquaredHint);return r!==0?r:t.geometry.vao.byteSize-i.geometry.vao.byteSize})}get count(){return this._draws.length}};const Ed=new Map;Ed.set(qh.UNSIGNED_BYTE,1),Ed.set(qh.UNSIGNED_SHORT,2),Ed.set(qh.UNSIGNED_INT,4);let M5=class{constructor(e){const t=e.renderContext.rctx,i=e.techniques;this.opaque=new ma(t,i),this.transparent=new ma(t,i,Pc.BackToFront),this.integratedMesh=new ma(t,i),this.shadowMap=new ma(t,i),this.highlight=new ma(t,i),this.highlightIntegratedMesh=new ma(t,i),this.highlightShadowMap=new ma(t,i),this.viewshedShadowMap=new ma(t,i),this.nonHighlightShadowMap=new ma(t,i)}},Ip=class extends L2{constructor(){super(...arguments),this.slicePlaneLocalOrigin=v(),this.origin=this.slicePlaneLocalOrigin,this.modelTransformation=null}},R5=class extends Ip{constructor(){super(...arguments),this.identifier=Ws.Material,this.output=D.Color,this.transparent=!1}},A5=class extends Ip{constructor(){super(...arguments),this.identifier=Ws.ShadowMap}},D5=class extends Ip{constructor(){super(...arguments),this.identifier=Ws.Highlight}},$5=class extends Ip{constructor(){super(...arguments),this.identifier=Ws.ViewshedShadowMap}},og=class extends Cp{constructor(){super({}),this.produces=new Map([[j.OPAQUE_MATERIAL,e=>this._produces(e,j.OPAQUE_MATERIAL)],[j.TRANSPARENT_MATERIAL,e=>this._produces(e,j.TRANSPARENT_MATERIAL)],[j.INTEGRATED_MESH,e=>this._produces(e,j.INTEGRATED_MESH)]]),this._materialPassParameters=new R5,this._shadowPassParameters=new A5,this._highlightPassParameters=new D5,this._viewshedPassParameters=new $5,this._systems=new Set}initializeRenderContext(e){this._context=e,this._passes=new M5(e)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e,t){return!!this._invoke(e,t,i=>i.count>0)}prepareRender(e){if(this._systems.size!==0&&this._passes!=null){for(const t of Object.values(this._passes))t.prepareSubmit();this._systems.forEach(t=>t.submit(this._passes,e.bind));for(const t of Object.values(this._passes))t.finishSubmit()}}acquireTechniques(e){if(this._systems.size===0)return null;const t=e.output===D.Shadow||e.output===D.ShadowHighlight||e.output===D.ShadowExcludeHighlight?this._shadowPassParameters:e.output===D.ViewshedShadow?this._viewshedPassParameters:e.output===D.Highlight?this._highlightPassParameters:this._materialPassParameters,i=e.bind;return this._updateParameters(i.camera,t,i.slot===j.TRANSPARENT_MATERIAL),this._materialPassParameters.output=e.output,this._invoke(e.output,e.bind.slot,(r,a)=>r.acquire(a,e.bind))}render(e,t){this._invoke(e.output,e.bind.slot,(i,r)=>i.dispatch(r,e.bind,t))}_invoke(e,t,i){if(this._passes==null)return null;switch(t){case j.OPAQUE_MATERIAL:switch(e){case D.Color:case D.ColorEmission:case D.Depth:case D.Normal:case D.ObjectAndLayerIdColor:return i(this._passes.opaque,this._materialPassParameters);case D.Highlight:return i(this._passes.highlight,this._highlightPassParameters);case D.Shadow:return i(this._passes.shadowMap,this._shadowPassParameters);case D.ShadowHighlight:return i(this._passes.highlightShadowMap,this._shadowPassParameters);case D.ShadowExcludeHighlight:return i(this._passes.nonHighlightShadowMap,this._shadowPassParameters);case D.ViewshedShadow:return i(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case j.TRANSPARENT_MATERIAL:switch(e){case D.Color:case D.ColorEmission:case D.Depth:case D.Normal:case D.ObjectAndLayerIdColor:return i(this._passes.transparent,this._materialPassParameters)}break;case j.INTEGRATED_MESH:switch(e){case D.Color:case D.ColorEmission:case D.Depth:case D.Normal:case D.ObjectAndLayerIdColor:return i(this._passes.integratedMesh,this._materialPassParameters);case D.Highlight:return i(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new ir;return this._systems.forEach(i=>t.union(i.queryDepthRange(e))),t}get hasEmissions(){let e=!1;return this._systems.forEach(t=>e=t.hasEmissions||e),e}_updateParameters(e,t,i){const r=e.viewInverseTransposeMatrix;ce(Jm,r[3],r[7],r[11]),e_.set(Jm),le(t.transformWorldFromViewTH,e_.high),le(t.transformWorldFromViewTL,e_.low),le(t.slicePlaneLocalOrigin,Jm),Og(t.transformViewFromCameraRelativeRS,e.viewMatrix),Rc(t.transformProjFromView,e.projectionMatrix),t.identifier===Ws.Material&&(this._materialPassParameters.transparent=i,Mc(Ob,t.transformViewFromCameraRelativeRS),Mg(t.transformNormalViewFromGlobal,Ob))}hasHighlightOptions(e){for(const t of this._systems)if(t.hasHighlightOptions(e))return!0;return!1}};og=c([F("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],og);const Jm=v(),Ob=ia(),e_=new gC;function I5(s){return s.name}let L5=class{constructor(e){this._context=e,this._nodes=new mt}destroy(){this._nodes.forEach(e=>e.destroy()),this._nodes.clear()}add(e){this._nodes.push(e),xy&&console.log(`Registered render nodes: ${this._nodes.map(({declaredClass:t})=>t).join(", ")}`)}remove(e){this._nodes.remove(e),xy&&console.log(`Registered render nodes: ${this._nodes.map(({declaredClass:t})=>t).join(", ")}`)}produces(e){return this._nodes.some(({produces:t})=>t===e)}require(e,...t){const i=this._nodes,r=a=>i.reduce((n,{consumes:o,produces:l})=>n+(!o.required.includes(e)||a!=null&&l!==a?0:1),0);return t.length===0?r():t.reduce((a,n)=>a+r(n),0)}optional(e,...t){const i=this._nodes,r=a=>i.reduce((n,{consumes:o,produces:l})=>{var h;return n+(!((h=o.optional)!=null&&h.includes(e))||a!=null&&l!==a?0:1)},0);return t.length===0?r():t.reduce((a,n)=>a+r(n),0)}updateAnimation(e){return this._nodes.reduce((t,i)=>i.updateAnimation(e)||t,!1)}precompile(...e){++this._context.techniques.precompiling;for(const t of e)this._nodes.forEach(i=>{i.produces===t&&i.precompile()});--this._context.techniques.precompiling}render(e,t,i=()=>{}){const r=e.name,a=this._nodes.filter(({produces:n})=>n===r);return a.length===0?I5(e)?e:sn:(a.forEach(n=>{var l;const o=[e];for(const h of n.consumes.required){if(h===r)continue;const u=t.get(h);if(u)o.push(u);else if(h!=="emissive"||!((l=t.get(r))!=null&&l.hasAttachment(h)))return void(i&&i(o))}if(n.consumes.optional)for(const h of n.consumes.optional){if(h===r)continue;const u=t.get(h);u&&o.push(u)}try{const h=n.doRender(o);h&&h!==e&&(r!==h.name&&(pe.getLogger(n).errorOnce(`RenderNode produced ${h.name}, expected ${r}`),h.setName(r)),e.release(),e=h,t.set(r,e))}catch(h){pe.getLogger(n).errorOnce(h)}i&&i(o)}),this._context.rctx.enforceState(),e)}requireGeometryDepth(){return this._nodes.some(e=>e.produces!=="disabled"&&e.requireGeometryDepth)}get test(){return{nodes:this._nodes}}},N5=class{constructor(e){this.context=e,this._renderPlugins=new mt,this._slots=new Array,this._version=Da(0);for(let t=0;t<j.MAX_SLOTS;++t)this._slots[t]=[]}destroy(){this._renderPlugins.forEach(e=>e.destroy()),this._renderPlugins.clear()}get plugins(){return this._renderPlugins}add(e,t){const i=()=>{if(t!=null&&t.aborted)throw e.uninitializeRenderContext(),_r();this._renderPlugins.push(e),e.produces.forEach((a,n)=>this._slots[n].push(e)),this.context.requestRender(),this._version.value++},r=e.initializeRenderContext(this.context,t);if(mg(r))return r.then(i);i()}remove(e){this._renderPlugins.removeUnordered(e),e.uninitializeRenderContext();for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter(i=>i!==e);this.context.requestRender(),this._version.value++}prepareRender(){this._renderPlugins.forAll(e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)})}updateAnimation(e){let t=!1;return this._renderPlugins.forAll(i=>{var r;return t=((r=i.updateAnimation)==null?void 0:r.call(i,e))||t}),t}precompile(...e){++this.context.techniques.precompiling;const t=this.context.renderContext.bind.slot;for(const i of e)this.context.renderContext.bind.slot=i,this._forEachRender(()=>{});this.context.renderContext.bind.slot=t,--this.context.techniques.precompiling}render(e,...t){for(const i of t)this.context.renderContext.bind.slot=i,this._forEachRender((r,a)=>r.render(this.context.renderContext,a,e))}_forEachRender(e){const t=this.context.renderContext.bind.slot,i=this.context.renderContext.output;this._slots[t].forEach(r=>{const a=r.produces.get(t);if(!(a!=null&&a(i))||r.isDecoration&&!this.context.renderContext.bind.decorations)return;const n=r.acquireTechniques(this.context.renderContext);n&&e(r,n)})}queryDepthRange(e){const t=new ir;return this._renderPlugins.forAll(i=>{var a;const r=(a=i.queryDepthRange)==null?void 0:a.call(i,e);t.union(r)}),t}get updating(){return this._version.value>=0&&this._renderPlugins.some(e=>e.running)}produces(e,...t){return t.some(i=>this._slots[i].some(r=>{const a=r.produces.get(i);return!!a&&a(e)}))}consumes(e){return this._renderPlugins.some(t=>t.consumes().required.includes(e))}hasHighlightOptions(e){return V5.some(t=>this._slots[t].some(i=>i.hasHighlightOptions(e)))}get hasDecorations(){return this._renderPlugins.some(e=>e.isDecoration)}get hasOccludees(){return this._renderPlugins.some(e=>e.hasOccludees)}get hasEmissions(){return this._renderPlugins.some(e=>e.hasEmissions)}get renderOccludedFlags(){return this._renderPlugins.reduce((e,t)=>e|t.renderOccludedFlags,Pi.None)}get usedMemory(){return this._renderPlugins.reduce((e,t)=>t.material?e:e+(t.usedMemory??0),0)}get test(){}};const V5=[j.OPAQUE_MATERIAL,j.TRANSPARENT_MATERIAL,j.DRAPED_MATERIAL,j.HUD_MATERIAL,j.LABEL_MATERIAL];class Nf extends Ii{}function DC(s){const e=new kt;e.include(sr);const t=s.hasEmission,i=e.fragment;return i.uniforms.add(new ft("colorTexture",r=>r.colorTexture),new ft("alphaTexture",r=>r.alphaTexture),new ft("frontFaceTexture",r=>r.frontFaceTexture)),e.outputs.add("fragColor","vec4",0),t&&(e.outputs.add("fragEmission","vec4",1),i.uniforms.add(new ft("emissionTexture",r=>r.emissionTexture)),i.uniforms.add(new ft("emissionFrontFaceTexture",r=>r.emissionFrontFaceTexture))),i.main.add(w`
      float srcAlpha = texture(alphaTexture, uv).r;
      if(srcAlpha == 0.0){
        fragColor = vec4(0.0);
        return;
      }

      vec4 srcColor = texture(colorTexture, uv);
      vec4 frontFace = texture(frontFaceTexture, uv);

      vec4 transparentColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);
      fragColor = transparentColor;

      ${Pe(t,`vec4 emission = texture(emissionTexture, uv);
         vec4 emissionFrontFace = texture(emissionFrontFaceTexture, uv);
        fragEmission = vec4(mix(emission.rgb / srcAlpha, emissionFrontFace.rgb, emissionFrontFace.a), emissionFrontFace.a);`)}
    `),e}const F5=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:Nf,build:DC},Symbol.toStringTag,{value:"Module"}));let t_=class extends Bt{constructor(e,t){super(e,t,new qt(F5,()=>X(()=>Promise.resolve().then(()=>nV),void 0,import.meta.url)))}initializePipeline(e){return Qt({blending:Dc,colorWrite:ti,drawBuffers:e.hasEmission?{buffers:[hs.COLOR_ATTACHMENT0,hs.COLOR_ATTACHMENT1]}:{buffers:[hs.COLOR_ATTACHMENT0]}})}},$C=class extends Ua{constructor(){super(...arguments),this.hasEmission=!1}};c([ne()],$C.prototype,"hasEmission",void 0);let U5=class{constructor(e){this._techniques=e,this._parameters=new Nf,this._configuration=new $C,e.precompile(t_,this._configuration),this._configuration.hasEmission=!0,e.precompile(t_,this._configuration)}blend(e,t,i,r,a){this._parameters.colorTexture=t.getTexture(),a&&(this._parameters.emissionTexture=t.getTexture(hs.COLOR_ATTACHMENT1),this._parameters.emissionFrontFaceTexture=i.getTexture(hs.COLOR_ATTACHMENT1)),this._parameters.alphaTexture=t.getTexture(a?hs.COLOR_ATTACHMENT2:hs.COLOR_ATTACHMENT1),this._parameters.frontFaceTexture=i.getTexture(),this._configuration.hasEmission=a;const n=this._techniques.get(t_,this._configuration);e.bindTechnique(n,r,this._parameters),e.screen.draw()}},H5=class{constructor(e,t){this._camera=e,this._dt=Xe(0),this._time=Xe(0),this._lastUpdate=Xe(0),this._lastUpdate=t,this._time=t}advance(e,t,i){const r=Xe(t-this._lastUpdate);this._dt=Xe(r/i),this._time=Xe(this._time+r),this._lastUpdate=t,this._camera=e}forceTime(e){this._lastUpdate=this._time=e,this._dt=Xe(0)}get camera(){return this._camera}get dt(){return this._dt}get time(){return this._time}},z5=class{constructor(){this._step=Ab,this._dilation=1,this._firstIdleTime=Xe(0)}frame(e,t){if(t?this._firstIdleTime===0&&(this._firstIdleTime=Xe(performance.now())):this._firstIdleTime=Xe(0),Gi("disable-feature:high-quality-idle"))this._dilation=1;else{const r=t?performance.now()-this._firstIdleTime:0;if(r>=Mb+B5)return this._step=Xe(1/0),void(this._dilation=1);this._dilation=r>=Mb?q5:1}const i=Q(e/G5,Ab,j5);this._step===1/0?this._step=Xe(i):this._step=Xe(this._step*Rb+i*(1-Rb))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=Xe(0)}};const G5=.5,Mb=Xe(12e4),B5=Xe(1e4),q5=10,Rb=.9,k5=30,Ab=Xe(1e3/1),j5=Xe(1e3/k5);var up;(function(s){s[s.SHADOW_CASTERS=0]="SHADOW_CASTERS",s[s.FULL_SCENE=1]="FULL_SCENE"})(up||(up={}));const W5=1e4,lg=100,Q5=500,Y5=500,Z5=.1;function X5(s,e,t,i=up.SHADOW_CASTERS){let r=0;if(!e.some(n=>!!n.material&&(r+=n.numGeometries,r>=W5)))return n4.compute(s,e,i);const a=new ir;return t.forAll(n=>a.union(K5(s,n))),a}function K5(s,e){if(!e.visible)return;const t=new ir,i=e.getSpatialQueryAccelerator();return i?J5(t,s,i):e4(t,s,e.objects),t}function J5(s,e,t){const{eye:i,viewForward:r,frustum:a}=e,n=l=>l.visible,o=t.objectCount;if(o<Q5)Gs.set(e.near,Math.min(s.near,e.far)),t.forEachInDepthRange(i,r,to.DepthOrder.FRONT_TO_BACK,Gs,(l,h)=>{hg(s,e,l),Gs.far=s.near,h.setRange(Gs)},a,n),Gs.set(Math.max(s.far,e.near),e.far),t.forEachInDepthRange(i,r,to.DepthOrder.BACK_TO_FRONT,Gs,(l,h)=>{hg(s,e,l),Gs.near=s.far,h.setRange(Gs)},a,n);else{const l=Math.max(Math.min(o,Y5),Math.ceil(o*Z5)),h=t.findClosest(r,to.DepthOrder.FRONT_TO_BACK,a,n,l),u=t.findClosest(r,to.DepthOrder.BACK_TO_FRONT,a,n,l);h&&u&&(Db(s,e,h.boundingVolumeWorldSpace.bounds),Db(s,e,u.boundingVolumeWorldSpace.bounds))}}function e4(s,e,t){Xo.clear(),t.forAll(i=>{i.visible&&i.geometries.length!==0&&Xo.add(i)}),Xo.empty||(Xo.sort(e),Gs.set(e.near,Math.min(s.near,e.far)),Xo.forEachInDepthRange(Gs,to.DepthOrder.FRONT_TO_BACK,(i,r)=>{r<s.near&&hg(s,e,i)}),Gs.set(Math.max(s.far,e.near),e.far),Xo.forEachInDepthRange(Gs,to.DepthOrder.BACK_TO_FRONT,(i,r,a)=>{s.far=Math.max(s.far,a)}))}function hg(s,e,t){if(!t.visible||!Gg(e.frustum,t.boundingVolumeWorldSpace.bounds))return;const i=t.transformation,r=a4;t.geometries.forEach(a=>{Zr(r,i,a.transformation);const n=y_(r);IC(s,e,a.boundingInfo,r,n)})}function IC(s,e,t,i,r){if(t==null)return;Gt(wt(yi),t.center,i);const{eye:a,viewForward:n}=e,o=n[0]*(yi[0]-a[0])+n[1]*(yi[1]-a[1])+n[2]*(yi[2]-a[2]);if(yi[3]=t.radius*r,!(o-yi[3]>s.near&&o+yi[3]<s.far)&&Gg(e.frustum,yi))if(t.radius>lg&&t.getChildren())for(const l of t.getChildren())IC(s,e,l,i,r);else cg.unionDepthRangeWithAABB(s,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}function Db(s,e,t){const i=e.eye,r=e.viewForward,a=(t[0]-i[0])*r[0]+(t[1]-i[1])*r[1]+(t[2]-i[2])*r[2];s.near=Math.min(s.near,a-t[3]),s.far=Math.max(s.far,a+t[3])}let t4=class{constructor(){this._items=new mt({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll(r=>{const a=r.object.boundingVolumeWorldSpace.bounds,n=(a[0]-t[0])*i[0]+(a[1]-t[1])*i[1]+(a[2]-t[2])*i[2];r.distance=n,r.near=n-a[3],r.far=n+a[3]}),this._items.sort((r,a)=>r.distance-a.distance)}forEachInDepthRange(e,t,i){if(t===to.DepthOrder.FRONT_TO_BACK)for(let r=0;r<this._items.length;++r){const a=this._items.data[r];a.far<e.near||a.near>e.far||i(a.object,a.near,a.far)}else for(let r=this._items.length-1;r>=0;--r){const a=this._items.data[r];a.far<e.near||a.near>e.far||i(a.object,a.near,a.far)}}};class i4{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new ir(0,0)}compute(e,t,i){this._reset();const{viewMatrix:r}=e;t.forAll(h=>{h.forEachGeometry(u=>{if(!u.visible||i===up.SHADOW_CASTERS&&!u.castShadow)return;const d=u.boundingSphere,p=r[2]*d[0]+r[6]*d[1]+r[10]*d[2]+r[14],_=p-d[3],f=p+d[3];this._geometries.push(u),this._near.push(-f),this._far.push(-_)})});const a=new ir;if(this._geometries.length===0)return a;for(let h=0;h<this._geometries.length;++h)this._near[h]>a.far&&(a.far=this._near[h]),this._near[h]>2&&this._far[h]<a.near&&(a.near=this._far[h]);const n=this._looseRange;n.near=Math.max(.5*a.near,2),n.far=2*a.far;let o=0,l=0;for(let h=0;h<this._geometries.length;++h)this._near[h]<a.near&&(this._near[h]>=n.near?a.near=this._near[h]:this._nearCandidates[o++]=h),this._far[h]>a.far&&(this._far[h]<=n.far?a.far=this._far[h]:this._farCandidates[l++]=h);if(this._nearCandidates.length===0&&this._farCandidates.length===0)return a;this._nearCandidates.sort((h,u)=>this._near[h]<this._near[u]?-1:this._near[h]>this._near[u]?1:0),this._farCandidates.sort((h,u)=>this._far[h]<this._far[u]?1:this._far[h]>this._far[u]?-1:0);for(let h=0;h<this._nearCandidates.length;++h){const u=this._nearCandidates[h];if(this._near[u]<a.near){const d=this._geometries[u],{boundingInfo:p,shaderTransformation:_}=d;this._includeNearBoundingInfoRec(e,p,_,a)}}for(let h=0;h<this._farCandidates.length;++h){const u=this._farCandidates[h];if(this._far[u]>a.far){const d=this._geometries[u],{boundingInfo:p,shaderTransformation:_}=d;this._includeFarBoundingInfoRec(e,p,_,a)}}return this._reset(),a}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(e,t){const i=wt(e),r=ME(e);return t[0][0]*i[0]+t[0][1]*i[1]+t[0][2]*i[2]+t[0][3]>r||t[1][0]*i[0]+t[1][1]*i[1]+t[1][2]*i[2]+t[1][3]>r||t[2][0]*i[0]+t[2][1]*i[1]+t[2][2]*i[2]+t[2][3]>r||t[3][0]*i[0]+t[3][1]*i[1]+t[3][2]*i[2]+t[3][3]>r}_includeNearBoundingInfoRec(e,t,i,r){if(t==null)return;const a=t.center;Gt(wt(yi),a,i),yi[3]=t.radius*y_(i);const{frustum:n}=e;if(this._isOutsideSidePlanes(yi,n))return;const o=yi[0],l=yi[1],h=yi[2],u=yi[3],{viewMatrix:d}=e,p=d[2]*o+d[6]*l+d[10]*h+d[14],_=p+u;if(!(-(p-u)<2||-_>=r.near))if(-_>this._looseRange.near)r.near=-_;else{if(u>lg){const f=t.getChildren();if(f!==void 0){for(const g of f)this._includeNearBoundingInfoRec(e,g,i,r);return}}cg.unionDepthRangeWithAABB(r,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}}_includeFarBoundingInfoRec(e,t,i,r){if(t==null)return;const a=t.center;Gt(wt(yi),a,i),yi[3]=t.radius*y_(i);const{frustum:n}=e;if(this._isOutsideSidePlanes(yi,n))return;const[o,l,h,u]=yi,{viewMatrix:d}=e,p=d[2]*o+d[6]*l+d[10]*h+d[14]-u;if(!(-p<=r.far))if(-p<this._looseRange.far)r.far=-p;else{if(u>lg){const _=t.getChildren();if(_!==void 0){for(const f of _)this._includeFarBoundingInfoRec(e,f,i,r);return}}cg.unionDepthRangeWithAABB(r,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}}}class s4{constructor(){this._modelViewProj=It(),this._clipPosition=[Mi(),Mi(),Mi(),Mi(),Mi(),Mi(),Mi(),Mi()]}unionDepthRangeWithAABB(e,t,i,r,a){const n=this._modelViewProj;Zr(n,t,i);let o=!1;for(let l=0;l<8;++l){const h=this._clipPosition[l],u=l===0||l===3||l===4||l===7?r[0]:a[0],d=l===0||l===1||l===4||l===5?r[1]:a[1],p=l<4?r[2]:a[2];h[0]=n[0]*u+n[4]*d+n[8]*p+n[12],h[1]=n[1]*u+n[5]*d+n[9]*p+n[13],h[2]=n[2]*u+n[6]*d+n[10]*p+n[14],h[3]=n[3]*u+n[7]*d+n[11]*p+n[15]}for(let l=0;l<12;++l){const h=r4(this._clipPosition[s_[l][0]],this._clipPosition[s_[l][1]],this._clipPosition[s_[l][2]]);let u=!0;for(let d=0;d<h.length;++d)if(h[d][3]>=2){u=!1;break}if(!u){o=!0;for(let d=0;d<h.length;++d){const p=h[d][3];Number.isFinite(p)&&(e.near=Math.min(p,e.near),e.far=Math.max(p,e.far))}}}return o}}function r4(s,e,t){let i=[s,e,t];for(let r=0;r<4;++r){const a=i;i=[];for(let n=0;n<a.length;++n){const o=a[n],l=a[(n+1)%a.length];i_(l,r)?(i_(o,r)||i.push($b(o,l,r)),i.push(l)):i_(o,r)&&i.push($b(o,l,r))}}return i}function i_(s,e){return e===0?s[0]>=-s[3]:e===1?s[1]>=-s[3]:e===2?s[0]<=s[3]:e===3?s[1]<=s[3]:void ws(!1)}function $b(s,e,t){let i=0;return t===0?i=(-s[3]-s[0])/(e[0]-s[0]+e[3]-s[3]):t===1?i=(-s[3]-s[1])/(e[1]-s[1]+e[3]-s[3]):t===2?i=(s[3]-s[0])/(e[0]-s[0]-e[3]+s[3]):t===3&&(i=(s[3]-s[1])/(e[1]-s[1]-e[3]+s[3])),ZE(Mi(),s,e,i)}const s_=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],yi=Sr(),a4=It(),Gs=new ir,Xo=new t4,n4=new i4,cg=new s4,o4={idleOpacity:.8,navigatingOpacity:.4,maxDelta:.1,tiltFadeStart:20,tiltFadeEnd:30,altitudeStart:1e4,altitudeEnd:2e4};let l4=class{constructor(e){this._fbos=e,this._requiresEmission=!1,this._size=new dP(0,0),this._clearColor=Mi()}dispose(){this._color=ui(this._color),this.releaseDepth()}initialize(e,t,i,r){this._size.width=e,this._size.height=t,$g(this._size,this._fbos.rctx.parameters.maxTextureSize);const a=this._color;return this._color=null,this.releaseDepth(),this._requiresEmission=r,zg(this._clearColor,i),a}releaseDepth(){var e;(e=this._color)==null||e.detachDepth(),this._depth=ui(this._depth)}update(e){const t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}bind(){const e=this._color==null;if(this.color.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(this.color.fbo),e){const t=this._fbos.rctx;t.setClearStencil(0),t.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),t.clear(Jt.COLOR|Jt.DEPTH|Jt.STENCIL),this._requiresEmission&&t.gl.clearBufferfv(t.gl.COLOR,1,yw)}}_acquireColor(){return this._requiresEmission?this._fbos.acquire(this._size.width,this._size.height,"acquired-color").acquireColor(hs.COLOR_ATTACHMENT1,di.RGBA,"emissive"):this._fbos.acquire(this._size.width,this._size.height,"acquired-color")}_acquireDepth(){return this._fbos.acquireDepth(Yi.DEPTH_STENCIL_TEXTURE,this._size.width,this._size.height,"depth")}get size(){return this._size}get color(){return this._ensureColor()}get depth(){return this._depth??(this._depth=this._acquireDepth()),this._depth}_ensureColor(){return this._color??(this._color=this._acquireColor()),this._color}},h4=class{constructor(){this._inputs=new Map}set(e,t){this._inputs.set(e,t)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){var t;(t=this._inputs.get(e))!=null&&t.release()&&this._inputs.delete(e)}};const Hc=255,c4=1/Hc;function LC(){const s=new kt,e=s.fragment;return e.include(Yg),e.include(xp),s.include(Zg),s.include(sr),s.include(Qg,u4),e.uniforms.add(new br("shadowMap",t=>t.shadowMap.depthTexture),new br("depthMap",t=>{var i;return(i=t.depth)==null?void 0:i.attachment}),new bn("inverseViewMatrix",t=>hc(Ib,lc(Ib,t.camera.viewMatrix,t.camera.center)))),e.constants.add("sampleValue","float",c4),s.outputs.add("sampleCount","float"),e.main.add(w`sampleCount = 0.0;
float depth = depthFromTexture(depthMap, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float currentPixelDepth = linearizeDepth(depth);
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
return;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
return;
}
ivec2 texSize = textureSize(shadowMap, 0);
ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));
float depthShadow = readShadowMapDepth(uvShadow, shadowMap);
bool shadow = depthShadow < lvpos.z;
if (shadow) {
sampleCount = sampleValue;
}`),s}const Ib=It(),u4=new $f,d4=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:Hc,build:LC},Symbol.toStringTag,{value:"Module"}));let Vf=class extends Ii{constructor(e){super(),this._data=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=ew(p4),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}};const p4=Pr(.01,0,.25,1);function NC(s){const e=new kt,t=e.fragment;e.include(Zg),e.include(sr);const{visualization:i,bandsEnabled:r}=s;t.constants.add("inverseSampleValue","float",Hc),t.uniforms.add(new ft("shadowCastMap",o=>o.shadowCastMap),new Ze("sampleScale",o=>o.sampleScale),new Ze("opacityFromElevation",o=>o.opacityFromElevation),new wp("uColor",o=>o.color));const a=i===Ey.Gradient,n=i===Ey.Threshold;return a&&r?t.uniforms.add(new Ze("bandSize",o=>o.bandSize)):n&&t.uniforms.add(new Ze("threshold",o=>o.threshold)),t.main.add(w`
    float record = texture(shadowCastMap, uv).r;
    float pixelSamples = record * inverseSampleValue;

    fragColor = vec4(0.0);
    if (pixelSamples < 1.0) {
      return;
    }

    float strength = pixelSamples * sampleScale;
    ${n?w`if (strength <= threshold) return;`:""}
    ${a&&r?w`strength = ceil(strength / bandSize) * bandSize;`:""}
    fragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${a?"* strength":""});
  `),e}const m4=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:Vf,build:NC},Symbol.toStringTag,{value:"Module"}));let Lb=class extends Bt{constructor(e,t){super(e,t,new qt(m4,()=>X(()=>Promise.resolve().then(()=>oV),void 0,import.meta.url))),this.primitiveType=bi.TRIANGLE_STRIP}initializePipeline(){return Qt({blending:Dc,colorWrite:ti,depthTest:null,depthWrite:null})}};const _4=4e4,g4=5e4,VC=1/512;let Od=class extends Re{constructor(s,e,t,i){super({}),this._techniques=s,this._rctx=e,this._data=t,this._requestRender=i,this._passParameters=new Vf(this._data),this._configuration=new pE,this._enabled=!1,this._vao=Sn(e)}dispose(){this._stop(),this._vao=We(this._vao)}precompile(){this._showVisualization&&this._techniques.precompile(Lb,this._configuration)}render(s){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const e=this._techniques.get(Lb,this._configuration);this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(e,s,this._passParameters),this._rctx.drawArrays(e.primitiveType,0,$l(this._vao,"geometry"))}setOptions(s){s.enabled!==void 0&&this._setEnabled(s.enabled),s.color!==void 0&&this._setColor(s.color),s.threshold!==void 0&&(this._threshold=s.threshold),s.visualization!==void 0&&(this._visualization=s.visualization),s.bandSize!==void 0&&(this._bandSize=s.bandSize),s.bandsEnabled!==void 0&&(this._bandsEnabled=s.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(s){this._passParameters.opacityFromElevation!==s&&(this._passParameters.opacityFromElevation=s,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>VC}get _threshold(){return this._passParameters.threshold}set _threshold(s){this._threshold!==s&&(this._passParameters.threshold=s,this._requestRenderIfEnabled())}get _visualization(){return this._configuration.visualization}set _visualization(s){s!==this._visualization&&(this._configuration.visualization=s,this._requestRenderIfEnabled())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(s){s!==this._bandSize&&(this._passParameters.bandSize=s,this._requestRenderIfEnabled())}get _bandsEnabled(){return this._configuration.bandsEnabled}set _bandsEnabled(s){s!==this._bandsEnabled&&(this._configuration.bandsEnabled=s,this._requestRenderIfEnabled())}_setColor(s){const e=this._passParameters.color;XE(s,e)||(zg(this._passParameters.color,s),this._requestRenderIfEnabled())}_setEnabled(s){s!==this._enabled&&(s?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};c([m()],Od.prototype,"opacityFromElevation",null),Od=c([F("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],Od);class Nb extends Bt{constructor(e,t){super(e,t,new qt(d4,()=>X(()=>Promise.resolve().then(()=>lV),void 0,import.meta.url))),this.primitiveType=bi.TRIANGLE_STRIP}initializePipeline(){return Qt({blending:XP,colorWrite:ti,depthTest:null,depthWrite:null})}}let is=class extends Re{constructor(s,e,t,i,r,a){super({}),this.fbos=s,this._techniques=e,this._stage=t,this._prepareForShadowMapPass=i,this._renderToShadowMap=r,this._requestRender=a,this._progress=0,this._sampleCount=0,this._passParameters=new Wg,this._cachedLightDirections=[],this._depthRange=ir.zero,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey="shadowAccumulator",this._rctx=s.rctx,this._bindParameters=new v1(new b1(s,t.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=Sn(this._rctx),this._accumulationRenderer=new Od(e,this._rctx,this,a);const n=this._stage.view.resourceController.scheduler;this.addHandles([n.registerTask(ai.SHADOW_ACCUMULATOR,this),O(()=>t.renderView,o=>{this.removeHandles(Vb),o!=null&&this.addHandles(o.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),Vb)},Be),O(()=>this._previewing,()=>this._requestRenderIfEnabled(),Ge)],this._shadowAccumulatorKey),e.precompile(Nb)}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=We(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=We(this._fbo),this._vao=We(this._vao),this._cachedLightDirections.length=0,this._sampleCount=0}get computedSamples(){return this._progress}get shadowCastTexture(){var s;return(s=this._fbo)==null?void 0:s.colorTexture}get accumulating(){return this._active&&this._previewing||this._refining}get _refining(){return this._active&&!this._doneAccumulating&&!this._previewing}get _active(){return this._fbo!=null&&this._sampleCount>0}get canAccumulate(){return this._bindParameters.depth!=null&&this._depthRange!==ir.zero&&this._opacityFromElevation>VC}get _doneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(s){const e=this._cachedLightDirections;if(jb(e,s,nc))return;const t=Math.min(Hc,s.length);e.length=t,this._sampleCount=t;for(let i=0;i<t;++i)e[i]=le(e[i]??v(),s[i]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(s){this._accumulationRenderer.opacityFromElevation=s}get running(){return this._refining&&this.canAccumulate&&this._progress>0}runTask(s){for(this._prepareForShadowMapPass(this._bindParameters);!s.done&&!this._doneAccumulating;)this._accumulateShadow(),s.madeProgress();this._requestRender()}renderAccumulation(s,e,t,i){if(this._depthRange=e,this._updateCamera(t),this._bindParameters.contentCamera=i,this._bindParameters.depth=s,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.accumulating||!this.canAccumulate)return!1;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();let r=this._cameraForcedForScreenshot?this._sampleCount:Math.min(f4,this._sampleCount);r-=this._progress;for(let a=0;a<r;++a)this._accumulateShadow(),this._requestRender();return this._cameraForcedForScreenshot=!1,r>0}precompile(){this._accumulationRenderer.precompile()}render(s){this._accumulationRenderer.render(s)}setOptions(s){if(s.enabled!==void 0){const e=this._fbo!=null;s.enabled!==e&&(s.enabled?this._enable():this._disable())}s.previewing!==void 0&&(this._previewing=s.previewing),s.lightDirections!==void 0&&(this._lightDirections=s.lightDirections),this._accumulationRenderer.setOptions(s)}readAccumulatedShadow(s,e){return!this._active||!this._fbo||this._progress<1||s<0||s>=this._fbo.width||e<0||e>=this._fbo.height?0:(this._fbo.readPixels(s,e,1,1,ni.RGBA,fo.UNSIGNED_BYTE,Fb),Fb[0]/this._progress)}_enable(){this._progress=0;const s=new mi;s.pixelFormat=ni.RED,s.internalFormat=zl.R8,s.wrapMode=Ki.CLAMP_TO_EDGE,this._fbo=new $c(this._rctx,s),this._requestRender()}_disable(){this._fbo=We(this._fbo),this._requestRender()}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(Jt.COLOR),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._lightDirections[this._progress++],this._depthRange);const s=this._techniques.get(Nb);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(s,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(s.primitiveType,0,$l(this._vao,"geometry"))}_updateCamera(s){const e=this._fbo;if(e==null)return;const t=this._bindParameters.camera;s.equals(t)||t.copyFrom(s),e.resize(s.fullWidth,s.fullHeight),this._opacityFromElevation=1-ac(_4,g4,s.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}};c([m()],is.prototype,"_progress",void 0),c([m()],is.prototype,"_sampleCount",void 0),c([m()],is.prototype,"_fbo",void 0),c([m()],is.prototype,"_depthRange",void 0),c([m()],is.prototype,"_previewing",void 0),c([m()],is.prototype,"_accumulationRenderer",void 0),c([m()],is.prototype,"_refining",null),c([m()],is.prototype,"_active",null),c([m()],is.prototype,"canAccumulate",null),c([m()],is.prototype,"_doneAccumulating",null),c([m()],is.prototype,"_opacityFromElevation",null),c([m()],is.prototype,"running",null),is=c([F("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],is);const f4=6,Vb="renderView",Fb=new Uint8Array(4),y4=fg();let v4=class{constructor(){this._plane=fg()}get plane(){return this._plane}set plane(e){yg(e||y4,this._plane)}};function b4(s,e){const t=s.capabilities.disjointTimerQuery;return t==null?null:new w4(t,e)}class w4{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach(i=>{const r=this._timer.createQuery(),a=this._timer.createQuery();this._queryPool.push(r,a),this._queryResults.set(i,null)})}start(){H2||(this._currentQuery=this._queryPool.pop(),this._currentQuery!=null&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||this._currentQuery==null||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(t==null)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){this._currentQuery!=null&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){this._currentQuery!=null&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{e!=null&&this._timer.deleteQuery(e)})}}var Et;(function(s){s.OVERLAY="overlay",s.PREPARE="prepare",s.SHADOW_MAP="shadow map",s.DEPTH="depth",s.ACCUMULATED_SHADOWS="accumulated shadows",s.APPLY_ACCUMULATED_SHADOWS="apply accumulated shadows",s.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",s.NORMALS="normals",s.SSAO="SSAO",s.HIGHLIGHTS="highlights",s.OPAQUE_EDGES="opaque edges",s.VOXEL="voxel",s.TRANSPARENT="transparent",s.TRANSPARENT_EDGES="transparent edges",s.HUD_VISIBILITY="HUD visibility",s.TRANSPARENT_TERRAIN="transparent terrain",s.TRANSPARENT_MATERIAL_WITHOUT_DEPTH="transparent material without depth",s.OPAQUE_ENVIRONMENT="opaque environment",s.TRANSPARENT_ENVIRONMENT="transparent environment",s.OCCLUDED="occluded",s.HUD="HUD",s.HUD_OCCLUDED="HUD occluded",s.FINISH="finish",s.FOCUS_AREA_MASK="focus area mask"})(Et||(Et={}));const r_=Object.values(gt).concat(Object.values(ge)).concat(Object.values(Et)),Ub="Total";let x4=class{constructor(e){this._rctx=e,this._startTimeStampCPU=Xe(0),this._lastTimeStampCPU=Xe(0),this._totalCPUTime=new qc(Ub),this._cpuTimeSamplers=new Map(r_.map(t=>[t,new qc(t)])),this._enableGPUTimer=0,this._totalGPUTime=new qc("GPU"),this._gpuTimeSamplers=new Map(r_.map(t=>[t,new qc(t)])),this._totalTime=Xe(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return this._gpuTimerPool!=null}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return Xe(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(this._gpuTimerPool==null){const t=[...r_,Ub];this._gpuTimerPool=b4(this._rctx,t)}if(this._gpuTimerPool==null)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,this._enableGPUTimer===0&&(this._gpuTimerPool=We(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=Xe(performance.now()),this._gpuTimerPool&&(this._gpuTimeSamplers.forEach(e=>e.push(0)),this._gpuTimerPool.start())}advance(e){const t=Xe(performance.now());if(this._cpuTimeSamplers.get(e).push(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const i=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).set(i),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const t=this._gpuTimerPool.stop(Et.FINISH);this._gpuTimeSamplers.get(Et.FINISH).set(t),this._rctx.gl.flush()}const e=Xe(performance.now()-this._startTimeStampCPU);this._totalTime=Xe(this._totalTime+e),this._totalCPUTime.push(e),this._gpuTimerPool&&this._totalGPUTime.push(this.gpuTimeSamplers.reduce((t,i)=>t+(i.last||0),0)),++this._totalFrameCount}};class Md{constructor(e,t,i,r,a,n){this._stage=e,this._techniques=i,this._rctx=r,this._compositingHelper=a,this._requestRender=n,this._pluginsHas={hudElements:!1,water:!1},this._renderers=new Map,this.renderPassManager=new og,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=Pr(0,0,0,1),this._sliceHelper=new v4,this._blit=null,this._oitblend=null,this._state=Da(Oi.IDLE),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new z5,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=Da(0),this._lastFrameTime=Xe(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new h4,this._releaseNormals=o=>{o.some(({name:l})=>l==="normals")&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this.fboCache=new O5(r),this._renderStateFeatures=Da(Ly(!Gi("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._framebuffer=new l4(this.fboCache),this.performanceInfo=new x4(this._rctx),this._shadowMap=new b1(this.fboCache,e.viewingMode),this._shadowAccumulator=new is(this.fboCache,i,e,o=>{const l=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(o.camera,o.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=l},(o,l,h)=>{const u=this._stage.view.qualitySettings.maximumPixelRatio;o.shadowMap.start(o.camera,l,h,!0,u),this._renderShadowCascades(D.Shadow,o.shadowMap),o.shadowMap.finish(),o.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(o.camera,o.contentCamera)},n),this._renderContext=new pP(this._rctx,this._shadowMap,i),this._nodes=new L5(this._renderContext),this._plugins=new N5({renderContext:this._renderContext,techniques:i,materials:t,requestRender:n,controller:e,fbos:this.fboCache,isFeatureEnabled:o=>this.isFeatureEnabled(o)}),this._plugins.add(this.renderPassManager),this._handles=[O(()=>this._stage.view.state.camera,()=>n(),Be),O(()=>xs.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,o=>{this._renderHiddenTransparentEdges=o?()=>this._renderEdges(No.TRANSPARENT):()=>{},n()},at),O(()=>{var o;return(o=this._stage.view.environment.background)==null?void 0:o.color},o=>{const l=o?jg(o):ur;vn(this._backgroundColor,l[0]*l[3],l[1]*l[3],l[2]*l[3],l[3]),n()},Be),O(()=>this._stage.view.state.camera.relativeElevation,o=>this._inGlobeView=(o??1/0)>=yE,Be),O(()=>this._bindParameters.clouds.fadeFactor,()=>this._bindParameters.fadeLighting(),Ge),O(()=>{var o;return(o=this._bindParameters.clouds.data)==null?void 0:o.state},()=>n(),Ge),O(()=>this._stage.view.state.highlights,o=>{this._bindParameters.highlights=o,this._updateHighlights(),n()},at)]}destroy(){this._handles.forEach(e=>e.remove()),this._gpuTimerHandle=ea(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=xn(this._loadEdgeViewTask),this._edgeView=se(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),this._renderers.clear(),this._blit=null,this._oitblend=null,QP.prune(),ao.prune(),b2()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}updateRenderFeatures(e=null,t=!Gi("disable-feature:high-quality-idle")){this._renderStateFeatures.value=Ly(t,e),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,i){this._renderStateFeatures.mutate(r=>r.set(t,e,i)),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(Gr.HighQualityTransparency)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(Gr.WaterReflection))}get _hasHighlights(){return this._plugins.produces(D.Highlight,j.OPAQUE_MATERIAL,j.TRANSPARENT_MATERIAL,j.DRAPED_MATERIAL,j.HUD_MATERIAL,j.LABEL_MATERIAL)}hasHighlightOptions(e){return this._plugins.hasHighlightOptions(e)}get _hasHUDHighlights(){return this._plugins.produces(D.Highlight,j.HUD_MATERIAL,j.LABEL_MATERIAL)}get hasSSAO(){return(this._stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(Gr.SSAO))&&!this._inGlobeView}get hasSMAA(){return this._stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(Gr.Antialiasing)}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(Gr.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=ui(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=ui(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=ui(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=ui(this._bindParameters.depth),this._bindParameters.hudVisibility=ui(this._bindParameters.hudVisibility)}get updating(){return this._edgeView!=null&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=Oc(async e=>{const{EdgeView:t}=await X(()=>import("./EdgeView-CRrUHzhn.js"),__vite__mapDeps([572,1,13,64,43,46,47,42,6,148,17,18,5,63,51,45,49,12,10,11,7,8,3,4,9,44,48,41,50,272,66,110,23,24,36,93,111,84,56,71,70,96,112,113,97,217,14,15,61,62,65,67,69,72,73,74,75,76,77,68,78,79,80,81,82,83,40,28,29,85,86,90,91,92,94,95,223,224,100,571,233,222,570,215,226,173,165,166,167,174,169,175,37,38,176,177,178,179,140,30,180,181,182,183,184,185,186,187,188,189,32,159,160,170,26,27,31,33,34,35,39,20,190,191,192,104,105,193,194,195,196,197,198,199,200,19,2,201,202,203,204,205,206,207,208,209,128,129,573,270,168,574,125,126,127,99,120,121,122,123,52,130,131,132,133,134,162,163,164,101,60,171,172,59,54,151,210,211,212,53,55,57,58,213,22,25,87,88,89,98,102,103,106,107,108,109,114,115,116,117,118,119,124,135,136,137,138,214,216,218,219,220,221,225,227,228,229,230,231,139,141,142,232,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,271,273,274,275,276,277,278,143,279]),import.meta.url);Ai(e);const i=this._edgeView=new t({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:P4(this._stage.view.resourceController)});return this._handles.push(O(()=>i.updating,()=>this._requestRender(),Ge)),this._requestRender(),this._edgeViewCallbacks.forEach(r=>r(i)),this._edgeViewCallbacks.length=0,i})),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),this._edgeView==null?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&TP(this._bindParameters.ssr.reprojectionMatrix,Gh)}set _reprojectionMatrix(e){sT(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){var e;return!!((e=this._shadowMap)!=null&&e.enabled)}setParameters(e){var r;const{_shadowMap:t,_bindParameters:i}=this;if(((r=e.qualitySettings)==null?void 0:r.reflections)!==void 0&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),e.shadowMap!==void 0&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),e.shadowMapMaxCascades!==void 0&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),e.environment!=null){e.environment.weather!=null&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const a=e.environment.lighting.type!=="virtual";i.enableFillLights!==a&&(i.enableFillLights=a,this._requestRender())}e.highQualityTransparency!==void 0&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),e.shadowCast!==void 0&&this._shadowAccumulator.setOptions(e.shadowCast)}set slicePlane(e){this._sliceHelper.plane!==e&&(this._sliceHelper.plane=e,this._requestRender())}get plugins(){return this._plugins}getMaterialRenderer(e){return this._renderers.get(e)}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,t){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:i,removes:r,updates:a}=e;i.length===0&&r.length===0&&a.length===0||(q1(e).forEach((n,o)=>{if(t.done)return;let l=this._renderers.get(o);l==null&&n.adds.length>0&&(l=new ao({material:o,highlightOrderMap:this._stage.view.state.highlightOrderMap}),l.initializeRenderContext(this._plugins.context),this._plugins.add(l),this._renderers.set(o,l)),l&&(l.modify(n),l.updateHighlights(this._stage.view.state.highlightOrderMap),l.numGeometries===0&&(this._renderers.delete(l.material),this._plugins.remove(l),l.destroy())),n.removes.forEach(h=>e.removes.removeUnordered(h)),n.adds.forEach(h=>e.adds.removeUnordered(h)),n.updates.forEach(h=>e.updates.removeUnordered(h)),t.madeProgress()}),this.updateHasFlags())}updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(D.Color,...bh),e.water=this._plugins.produces(D.Normal,j.DRAPED_WATER),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(e,t){this._animationTimer??(this._animationTimer=new H5(e.camera,t)),this._animationTimer.advance(e.camera,t,this._animationTimeDilation),e.forcedAnimationTime!=null&&this._animationTimer.forceTime(e.forcedAnimationTime);const i=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==i&&(this._gpuTimerHandle=i?ea(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,i=xa.Default,r=!1){try{return this._isRendering=!0,this._render(e,t,i,r)}catch(a){console.error(`Exception during rendering: ${a}`)}finally{this._isRendering=!1}return new f0(this._pluginInput.get(gt.FINAL),null)}_updateHUDOccludedFragmentOpacity(e,t){const{idleOpacity:i,navigatingOpacity:r,maxDelta:a,tiltFadeStart:n,tiltFadeEnd:o,altitudeStart:l,altitudeEnd:h}=o4,u=this._stage.view,d=u.stateManager.camera,p=u.qualitySettings.fadeDuration,_=e===Oi.IDLE?i:r,f=Q((d.tilt-n)/(o-n),0,1),g=Q((d.position.z??0-l)/(h-l),0,1),y=ze(ze(1,_,f),1,g),b=this._bindParameters.hudOccludedFragmentOpacity;if(p<=0||b===y||this._lastFrameTime===0||this._lastFrameTime>t)return this._bindParameters.hudOccludedFragmentOpacity=y,void(this._lastFrameTime=t);const x=t-this._lastFrameTime;this._lastFrameTime=t;const C=Math.min(Math.abs(i-r)*x/p,a);C>=Math.abs(y-b)?this._bindParameters.hudOccludedFragmentOpacity=y:(this._bindParameters.hudOccludedFragmentOpacity=b+Math.sign(y-b)*C,this._requestRender())}_render(e,t,i=xa.Default,r){var k,H,Y,A,R,W,U;this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=i===xa.Default,this._disposeBindBuffers();const{camera:a,contentCamera:n,mode:o,alignPixelEnabled:l}=e;this._state.value=o;const h=this._nodes.produces("magnifier-color"),u=this._nodes.produces(gt.FINAL),d=this._nodes.require("emissive",gt.FINAL,gt.COMPOSITE)>0&&this._plugins.hasEmissions,p=d?D.ColorEmission:D.Color;this._renderContext.time=t,this._renderContext.output=p,this._bindParameters.oitPass=Qi.NONE,this._bindParameters.alignPixelEnabled=l,this._bindParameters.decorations=!r,this._bindParameters.mainDepth=null,this._bindParameters.slicePlane=this._sliceHelper.plane,this._bindParameters.viewshedEnabled=this._nodes.produces(ge.VIEWSHED),this._renderOverlay(t),a.setGLViewport(this._rctx);const _=this._framebuffer,f=_.initialize(a.fullWidth,a.fullHeight,this._backgroundColor,d);this.hasReflections?(f==null||f.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=f):f==null||f.release(),this._ensureBindParametersCamera(a,n),this._updateHUDOccludedFragmentOpacity(o,t),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!r;const g=this._highQualityTransparency&&this._hasTransparentTerrain,y=this._plugins.produces(D.Color,...vh);this._precompilePrepasses(),this.performanceInfo.advance(Et.PREPARE);const b=this._computeDepthRange(a);this._renderShadowMap(a,this._bindParameters.lighting.mainLight.direction,b),this._ensureBindParametersCamera(a,n),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(b,a,n),this._ensureBindParametersSSR(t),this._precompileShaders(g,y,p),this._renderContext.output=p,_.bind(),this._bindParameters.mainDepth=_.depth.attachment;const x=this.plugins.produces(D.Color,...a_);x&&this._renderOpaqueGeometry(),_.update(I=>this._renderNodes(gt.OPAQUE,I,x)),(H=(k=this.fboCache).debugCallback)==null||H.call(k,gt.OPAQUE,_.color.fbo),_.update(I=>this._renderNodes(ge.OPAQUE_ENVIRONMENT,I)),(A=(Y=this.fboCache).debugCallback)==null||A.call(Y,ge.OPAQUE_ENVIRONMENT,_.color.fbo),this._renderTerrainDepth(g),this._renderEdges(No.OPAQUE),_.bind(),this._renderPlugins(j.VOXEL,Et.VOXEL),this._renderHiddenTransparentEdges(),y&&(this._oitEnabled?this._renderOIT(yl.Geometry,p):this._renderTransparentGeometry()),_.update(I=>this._renderNodes(gt.TRANSPARENT,I,y)),(W=(R=this.fboCache).debugCallback)==null||W.call(R,gt.TRANSPARENT,_.color.fbo),this._renderGeometryDepth(g),this._renderHUDVisibility(),g||this._plugins.render(this._pluginInput,j.LINE_CALLOUTS),this._renderEdges(No.TRANSPARENT);const C=this._hasTransparentTerrain?this._renderTransparentTerrain():null;C&&(this.performanceInfo.advance(Et.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(g?this._renderLineCallouts(Ps.Occluded):(this._rctx.bindFramebuffer((U=this._bindParameters.hudVisibility)==null?void 0:U.fbo),this._compositingHelper.compositeHUD(this._bindParameters,C.getTexture())),this._renderHUD(Ps.Occluded,_.color,p))),this._bindParameters.cullAboveTerrain=!1,C&&(_.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,C.getTexture()),C.release(),g&&(this._renderEdges(No.OPAQUE),y&&(this._oitEnabled?this._renderOIT(yl.Geometry,p):this._renderTransparentGeometry(),this.performanceInfo.advance(Et.TRANSPARENT)),this._renderEdges(No.TRANSPARENT))),this._bindParameters.ssao=ui(this._bindParameters.ssao),g&&this._renderLineCallouts(Ps.NotOccluded),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment(),this._pluginInput.set(ge.FOCUSAREA,this._renderFocusAreaGeometry()),_.update(I=>this._renderNodes(ge.TRANSPARENT_ENVIRONMENT,I)),_.update(I=>this._renderNodes(ge.VIEWSHED,I)),_.update(I=>this._renderNodes(ge.LASERLINES,I)),_.update(I=>this._renderNodes(ge.OCCLUDED,I)),this._pluginInput.set("highlights",this._renderHighlightPrepass());const T=i===xa.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;_.update(I=>this._renderNodes(gt.COMPOSITE,I)),this._pluginInput.release(ge.FOCUSAREA);const P=!(i!==xa.Default||u||h&&!r),S=this._pluginInput.get(gt.COMPOSITE),E=P?sn:this.fboCache.acquire(S.fbo.width,S.fbo.height,ge.ANTIALIASING),M=this._nodes.produces(ge.ANTIALIASING)?this._renderNodes(ge.ANTIALIASING,E):this._blitFBO(S,E,!1);let $;this._pluginInput.set(ge.ANTIALIASING,M),this._hasHUDHighlights?(this._renderHUD(Ps.NotOccluded,M,p),$=this._renderNodes(ge.HIGHLIGHTS,M)):($=this._renderNodes(ge.HIGHLIGHTS,M),this._renderHUD(Ps.NotOccluded,$,p));const B=this._renderNodes(ge.MAGNIFIER,$);return h&&!r&&i===xa.Default&&!u&&this._blitFBO(B),u?(B.attachDepth(_.depth),this._blitFBO(this._renderNodes(gt.FINAL,B)),B.detachDepth()):this._pluginInput.set(gt.FINAL,B),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),_.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),i!==xa.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),new f0(this._pluginInput.get(gt.FINAL),T)}_precompileShaders(e,t,i){if(++this._plugins.context.techniques.precompiling,this._renderContext.output=i,this._precompileOpaqueGeometry(),this._nodes.precompile(ge.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,this._renderContext.output=D.Depth,this._plugins.precompile(j.TRANSPARENT_TERRAIN),e&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=i,this._plugins.precompile(j.TRANSPARENT_TERRAIN),t&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=e)),this._nodes.precompile(ge.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile(j.OCCLUSION_PIXELS),this._plugins.precompile(j.LINE_CALLOUTS),this._precompileHUD(Ps.Occluded),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(ge.VIEWSHED,ge.LASERLINES,ge.OCCLUDED,ge.ANTIALIASING,ge.HIGHLIGHTS),this._precompileHUD(Ps.NotOccluded),this._hasHighlights){const r=this._bindParameters;r.highlights.forEach((a,n)=>{r.highlightLevel=n,this._precompileAllGeometry(D.Highlight)}),r.highlightLevel=null}this._nodes.precompile(gt.COMPOSITE,ge.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(j.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),--this._plugins.context.techniques.precompiling}_updateHighlights(){const e=this._stage.view.state;this._renderers.forEach(t=>t.updateHighlights(e.highlightOrderMap))}_renderFocusAreaGeometry(){if(!this._nodes.produces(ge.FOCUSAREA))return null;const{width:e,height:t}=this._framebufferSize;let i=this.fboCache.acquire(e,t,ge.FOCUSAREA);return i=this._nodes.render(i,this._pluginInput),this.performanceInfo.advance(Et.FOCUS_AREA_MASK),i}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;const e=this._renderContext.output;++this._techniques.precompiling;const t=this._framebufferSize;let i=this.fboCache.acquire(t.width,t.height,"olid");return i.acquireDepth(Yi.DEPTH_STENCIL_TEXTURE),i=this._nodes.render(i,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(Et.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=e,i}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,i=e===Ce.BACKGROUND;if(i||t){const r=i?this.performanceInfo.elapsedTime:0;let a=0;t?a=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();const n=Math.max(r,a);this._animationTimestep.frame(n,i)}}readMainDepth(e,t){var n;const{mainDepth:i,camera:r}=this._bindParameters;if(!i)return;const a=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(a.fbo),r.setGLViewport(this._rctx),this._rctx.setScissorRect(e[0],e[1],e[2],e[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(ur),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,i),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),(n=a.fbo)==null||n.readPixels(e[0],e[1],e[2],e[3],ni.RGBA,fo.UNSIGNED_BYTE,t),a.release()}readHUDVisibility(e,t,i,r,a){var n,o;(o=(n=this._bindParameters.hudVisibility)==null?void 0:n.fbo)==null||o.readPixels(e,t,i,r,ni.RGBA,fo.UNSIGNED_BYTE,a)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_renderEdges(e){const t=this._edgeView;if(!(t!=null&&t.shouldRender()))return;const i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"edges"),a=()=>t.render(this._bindParameters,e),n=this._bindParameters.geometryDepth;this.renderToTargets(a,r,n??this._framebuffer.depth,ur),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,r.getTexture()),r.release(),this.performanceInfo.advance(e===No.OPAQUE?Et.OPAQUE_EDGES:Et.TRANSPARENT_EDGES)}_renderOverlay(e){var t;this._bindParameters.overlay=(t=this.overlay)==null?void 0:t.render(e),this._bindParameters.overlay&&this.performanceInfo.advance(Et.OVERLAY)}_renderShadowMap(e,t,i){if(!this.shadowsEnabled)return;const r=this._shadowMap;r.start(e,t,i,this.isFeatureEnabled(Gr.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(D.ShadowHighlight,this._shadowMap),r.moveSnapshot(Hd.Highlight),this._renderShadowCascades(D.ShadowExcludeHighlight,this._shadowMap),r.copySnapshot(Hd.ExcludeHighlight),this._renderShadowCascades(D.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(D.Shadow),r.finish(),e.setGLViewport(this._rctx),this.performanceInfo.advance(Et.SHADOW_MAP)}_precompileShadowCascades(e){for(const t of this._shadowMap.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._precompileAllGeometry(e)}_renderShadowCascades(e,t=this._shadowMap){for(const i of t.cascades)i.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(i.camera,i.camera),this.renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(D.Depth)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._needsShadowAccumulation||this._debugNeedsDepth}_renderRemainingGeometryDepth(){const e=this._pluginInput.get("normals");if(e){const t=this._needsDepth?e.getAttachment(Bd):null;t==null||t.retain(),this._pluginInput.set(ge.SSAO,this._renderSSAO()),this._renderGeometryWithoutNormalsDepth(t)}else this._renderAllGeometryDepth()}_renderGeometryWithoutNormalsDepth(e){if(!this._needsDepth||!e)return void(this._bindParameters.depth=ui(this._bindParameters.depth));const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"depth");i.attachDepth(e),e.release(),this._rctx.bindFramebuffer(i.fbo),this._rctx.clear(Jt.STENCIL),this._renderGeometryWithoutNormals(D.Depth),ui(this._bindParameters.depth),this._bindParameters.depth=i.obtainDepthTexture(),i.release(),this.performanceInfo.advance(Et.DEPTH)}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=ui(this._bindParameters.depth));const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"depth").acquireDepth(Yi.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(t.fbo),this._rctx.clear(Jt.DEPTH|Jt.STENCIL),this.renderAllGeometry(D.Depth),ui(this._bindParameters.depth),this._bindParameters.depth=t.obtainDepthTexture(),t.release(),this.performanceInfo.advance(Et.DEPTH)}_renderTerrainDepth(e){if(this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,!e)return void(this._bindParameters.terrainDepth=ui(this._bindParameters.terrainDepth));const t=this._renderContext.output;this._renderContext.output=D.Depth;const i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"terrain depth").acquireDepth(Yi.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(r.fbo),this._rctx.clear(Jt.DEPTH|Jt.STENCIL),this._renderTransparentTerrain(),ui(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=r.obtainDepthTexture(),this._renderContext.output=t,r.release()}_renderGeometryDepth(e){if(!e)return void(this._bindParameters.geometryDepth=ui(this._bindParameters.geometryDepth));const t=this._renderContext.output,{width:i,height:r}=this._framebufferSize,a=this.fboCache.acquire(i,r,"geometry depth").acquireDepth(Yi.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(a.fbo),this._rctx.clear(Jt.DEPTH|Jt.STENCIL),this._renderOpaqueAndTransparentGeometry(D.Depth),this._renderContext.output=t,ui(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=a.obtainDepthTexture(),a.release()}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowAccumulation}_computeDepthRange(e){if(!this._needsDepthRange)return ir.zero;const t=X5(e,this._plugins.plugins,this._stage.layers);return t.union(this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}get _normalsRequired(){const e=this._nodes.require("normals",gt.FINAL,gt.COMPOSITE,gt.OPAQUE,gt.TRANSPARENT,ge.VIEWSHED,ge.LASERLINES);return(this.hasSSAO?1:0)+e}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(D.Normal),this._needsDepth&&this._precompileAllGeometry(D.Depth),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(D.ShadowHighlight),this._precompileShadowCascades(D.ShadowExcludeHighlight),this._precompileShadowCascades(D.ShadowHighlight)):this._precompileShadowCascades(D.Shadow)),this._needsShadowAccumulation&&this._precompileAllGeometry(D.Shadow)}_renderNormals(){const e=this._normalsRequired;if(e===0)return;const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"normals",di.RGBA);i.acquireDepth(Yi.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer(ur,!0,!0),this._renderGeometryWithNormals(D.Normal);const r=this._nodes.optional("normals",gt.FINAL,gt.COMPOSITE,gt.OPAQUE,gt.TRANSPARENT,ge.VIEWSHED);return i.retain(e+r-1),this.performanceInfo.advance(Et.NORMALS),i}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return void(e==null?void 0:e.detachDepth());sn.setName(ge.SSAO);const t=this._nodes.render(sn,this._pluginInput);return this._bindParameters.ssao=t,e.detachDepth(),this._pluginInput.release("normals"),this.performanceInfo.advance(Et.SSAO),t}_precompileAllGeometry(e){const t=this._renderContext.output;this._renderContext.output=e,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(j.TRANSPARENT_TERRAIN),this._renderContext.output=t}renderAllGeometry(e){this._renderContext.output=e,this._renderOpaqueAndTransparentGeometry(e),this._renderTransparentTerrain()}precompileSlots(e,...t){for(const i of t)this._bindParameters.slot=i,e.precompile(this._renderContext)}precompileOccludedSlots(e,t){for(const i of t)this._renderContext.renderOccludedMask=i,this.precompileSlots(e,...Hb);this._renderContext.renderOccludedMask=vy}renderSlots(e,...t){for(const i of t)this._bindParameters.slot=i,e.forAll(r=>{const a=r.acquireTechniques(this._renderContext);a&&r.render(this._renderContext,a,this._pluginInput)})}renderOccludedSlots(e,t){this._renderContext.renderOccludedMask=t,this.plugins.renderOccludedFlags>Pi.Occlude&&this._plugins.render(this._pluginInput,j.OCCLUDED_TERRAIN),this.renderSlots(e,...Hb),this._renderContext.renderOccludedMask=vy}renderHUD(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(this._pluginInput,j.HUD_MATERIAL)}precompileViewshedShadowMap(){this._precompileAllGeometry(D.ViewshedShadow)}renderViewshedShadowMap(e){const{camera:t,contentCamera:i}=this._bindParameters,r=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this.renderAllGeometry(D.ViewshedShadow),this._ensureBindParametersCamera(t,i),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=r}_renderOpaqueAndTransparentGeometry(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,...C4),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,...T4)}_precompileOpaqueGeometry(){this._plugins.precompile(...a_)}_renderOpaqueGeometry(){this._plugins.render(this._pluginInput,...a_)}_renderTransparentGeometry(){this._plugins.render(this._pluginInput,...vh)}get _hasTransparentTerrain(){return this._plugins.produces(D.Color,j.TRANSPARENT_TERRAIN)}_renderTransparentTerrain(){const e=()=>this._plugins.render(this._pluginInput,j.TRANSPARENT_TERRAIN);if(!oo(this._renderContext.output))return void e();const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"transparent terrain");return this.renderToTargets(e,i,this._framebuffer.depth,ur),i}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,j.OCCLUSION_PIXELS)}_renderHUDVisibility(){var a,n;if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=ui(this._bindParameters.hudVisibility));const{width:e,height:t}=this._framebufferSize;let i=this._bindParameters.hudVisibility;((a=i==null?void 0:i.fbo)==null?void 0:a.width)===e&&((n=i==null?void 0:i.fbo)==null?void 0:n.height)===t||(i==null||i.release(),i=this.fboCache.acquire(e,t,"hud visibility",di.RGBA4),this._bindParameters.hudVisibility=i);const r=this._bindParameters.geometryDepth;i.attachDepth(r||this._framebuffer.depth),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(this._pluginInput,j.OCCLUSION_PIXELS),i.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(Et.HUD_VISIBILITY)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===Ps.Occluded){const t=()=>this._plugins.render(this._pluginInput,j.LINE_CALLOUTS),i=this._framebufferSize,r=this.fboCache.acquireDepth(Yi.DEPTH16_BUFFER,i.width,i.height,"line callouts");this.renderToTargets(t,this._framebuffer.color,r,void 0,!0,!0),r.release()}else this._plugins.render(this._pluginInput,j.LINE_CALLOUTS)}_precompileHUD(e){if(this._precompileHUDOutput(e),this._hasHighlights){const t=this._renderContext.output;this._renderContext.output=D.Highlight,this._precompileHUDOutput(e),this._renderContext.output=t}}_precompileHUDOutput(e){const t=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=e,this._oitEnabled&&oo(this._renderContext.output)?(this._bindParameters.oitPass=Qi.ColorAlpha,this._plugins.precompile(...bh),this._bindParameters.oitPass=Qi.FrontFace,this._plugins.precompile(...bh),this._bindParameters.oitPass=Qi.NONE):this._plugins.precompile(...bh),this._bindParameters.hudRenderStyle=t}_renderHUD(e,t,i){if(this._pluginsHas.hudElements){if(this._oitEnabled){const r=this._renderOIT(yl.HUD,i,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,r.getTexture()),r.release()}else if(this._renderContext.output=i,e===Ps.Occluded){const r=()=>this._renderHUDElements(e),a=this._framebufferSize,n=this.fboCache.acquireDepth(Yi.DEPTH16_BUFFER,a.width,a.height,"hud");this.renderToTargets(r,this._framebuffer.color,n,void 0,!0,!0),n.release()}else t.acquireDepth(Yi.DEPTH16_BUFFER),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(e===Ps.Occluded?Et.HUD_OCCLUDED:Et.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(this._pluginInput,...bh)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(D.ShadowHighlight,j.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(!this._hasHighlights)return;const{fboCache:e,_rctx:t,_bindParameters:i}=this,r=this._framebufferSize,a=e.acquire(r.width,r.height,"highlights",di.RG);return a.acquireDepth(Yi.DEPTH_STENCIL_TEXTURE),t.bindFramebuffer(a.fbo),t.clearFramebuffer(ur,!0),this._renderContext.output=D.Highlight,t.bindFramebuffer(a.fbo),mP(t,e,r,i,()=>this._renderHighlightGeometries()),this.performanceInfo.advance(Et.HIGHLIGHTS),a}_renderHighlightGeometries(){this._plugins.render(this._pluginInput,...S4),this._rctx.clear(Jt.DEPTH),this._renderHUDElements(Ps.Both)}get _needsShadowAccumulation(){return this._shadowAccumulator.accumulating}_renderShadowAccumulation(e,t,i){this._needsShadowAccumulation&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,e,t,i)&&this.performanceInfo.advance(Et.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&oo(this._renderContext.output)?(this._bindParameters.oitPass=Qi.ColorAlpha,this._plugins.precompile(...vh),this._bindParameters.oitPass=Qi.FrontFace,this._plugins.precompile(...vh),this._bindParameters.oitPass=Qi.NONE):this._plugins.precompile(...vh)}_renderOIT(e,t,i=Ps.Both){const r=e===yl.HUD,a=this._framebufferSize,n=r?this.fboCache.acquire(a.width,a.height,"oit hud composite"):null,o=r?()=>this._renderHUDElements(i):()=>this._renderTransparentGeometry(),l=this._bindParameters,h=this._renderContext.output;this._renderContext.output=t,l.oitPass=Qi.ColorAlpha;const u=n?"oit hud color+alpha":"oit color+alpha",d=this.fboCache.acquire(a.width,a.height,u,di.RGBA16F),p=t===D.ColorEmission;p&&d.acquireColor(hs.COLOR_ATTACHMENT1,di.RGBA16F,"emissive"),d.acquireColor(p?hs.COLOR_ATTACHMENT2:hs.COLOR_ATTACHMENT1,di.R16F),n||d.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(d.fbo),this._rctx.clearFramebuffer([0,0,0,1]),p&&this._rctx.gl.clearBufferfv(this._rctx.gl.COLOR,1,yw),o(),d.detachDepth(),l.oitPass=Qi.FrontFace;const _=this.fboCache.acquire(a.width,a.height,n?"oit hud front":"oit front");return p&&_.acquireColor(hs.COLOR_ATTACHMENT1,di.RGBA,"emissive"),n?_.acquireDepth(Yi.DEPTH16_BUFFER):_.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(_.fbo),this._rctx.clearFramebuffer(ur,!!n),o(),_.detachDepth(),l.oitPass=Qi.NONE,n?(this._rctx.bindFramebuffer(n.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(Jt.COLOR)):this._framebuffer.bind(),this._oitblend??(this._oitblend=new U5(this._techniques)),this._oitblend.blend(this._rctx,d,_,l,p),n==null||n.detachDepth(),_.release(),d.release(),this._renderContext.output=h,n}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(Et.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(this._pluginInput,j.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),this.performanceInfo.advance(Et.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(this._pluginInput,e),this.performanceInfo.advance(t))}_renderNodes(e,t,i=!1){if(t.setName(e),this._pluginInput.set(e,t),!this._nodes.produces(e))return i&&this.performanceInfo.advance(e),t;const r=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),r}_blitFBO(e,t=sn,i=!0){return this._blit??(this._blit=new fw(this._techniques)),this._blit.blit(this._rctx,e,t,this._bindParameters),this._pluginInput.set(e.name,t),i&&e.release(),t}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){this._ssrEnableTime==null&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Gh:(hc(Gb,this._bindParameters.camera.viewMatrix),hc(zb,this._bindParameters.camera.projectionMatrix),Zr(Ko,Gb,zb),Zr(Ko,this._renderContext.lastFrameCamera.viewMatrix,Ko),Zr(Ko,this._renderContext.lastFrameCamera.projectionMatrix,Ko),this._reprojectionMatrix=Ko);const t=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=Gh,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}updateLighting(e,t,i,r){this._bindParameters.updateLighting(e,t,i,r),this._requestRender(Ce.UPDATE)}get usedMemory(){var e;return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:((e=this.edgeView)==null?void 0:e.usedMemory)??0}}renderToTargets(e,t,i,r,a=!1,n=!1){t.attachDepth(i),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer(r,a,n),e(),t.detachDepth()}get test(){}}var yl;c([m({readOnly:!0})],Md.prototype,"fullResolutionAtmosphere",null),c([m()],Md.prototype,"_edgeView",void 0),c([m()],Md.prototype,"updating",null),function(s){s[s.Geometry=0]="Geometry",s[s.HUD=1]="HUD"}(yl||(yl={}));const C4=[j.INTEGRATED_MESH,j.OPAQUE_TERRAIN,j.OPAQUE_MATERIAL,j.TRANSPARENT_MATERIAL],T4=[j.OPAQUE_MATERIAL_WITHOUT_NORMALS,j.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],a_=[j.INTEGRATED_MESH,j.OPAQUE_TERRAIN,j.OPAQUE_MATERIAL,j.OPAQUE_MATERIAL_WITHOUT_NORMALS],vh=[j.TRANSPARENT_MATERIAL,j.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],Hb=[j.OPAQUE_MATERIAL,j.TRANSPARENT_MATERIAL,j.TRANSPARENT_MATERIAL_WITHOUT_DEPTH],bh=[j.LINE_CALLOUTS_HUD_DEPTH,j.HUD_MATERIAL,j.LABEL_MATERIAL],S4=[j.TRANSPARENT_MATERIAL,j.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,j.OPAQUE_MATERIAL,j.OPAQUE_MATERIAL_WITHOUT_NORMALS,j.TRANSPARENT_TERRAIN,j.INTEGRATED_MESH,j.OPAQUE_TERRAIN],zb=It(),Gb=It(),Ko=It();function P4(s){return e=>s.immediate.schedule(e)}let E4=class{constructor(e){this._rctx=e,this._vao=O4(e)}destroy(){this._vao=We(this._vao)}draw(){this._vao!=null&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(bi.TRIANGLES,0,3))}get test(){}};function O4(s,e=y1,t=Bl){const i=new Float32Array([-1,-1,3,-1,-1,3]);return new Tn(s,t,new Map([["geometry",e]]),new Map([["geometry",$s.createVertex(s,wr.STATIC_DRAW,i)]]))}class M4{constructor(e,t,i){this._rctx=e,this._locations=t,this._layout=i,this._cache=new Uc(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){var r;const t=e.toString();let i=this._cache.pop(t);return i||(i=new Tn(this._rctx,this._locations,new Map([["geometry",this._layout]]),new Map([["geometry",$s.createVertex(this._rctx,wr.STATIC_DRAW)]])),(r=i.vertexBuffers.get("geometry"))==null||r.setSize(e),i)}deleteVao(e){if(e==null)return;const t=e.byteSize.toString();this._cache.put(t,e)}}let R4=class extends z2{constructor(e,t){super(e,t),this._vaoCaches=new Yd,this._appleAmdDriverHelper=null,this._refCount=1,this._newCache=t.newCache,this.screen=new E4(this)}configure(e){super.configure(e),this._newCache=e.newCache}destroy(){var e,t;(e=this._vaoCaches)==null||e.forAll(i=>i.dispose()),(t=this._vaoCaches)==null||t.clear(),--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){var e;super.dispose(),(e=this._appleAmdDriverHelper)==null||e.dispose(),this.screen.destroy(),this._vaoCaches.forAll(t=>t.dispose()),this._vaoCaches.clear()}get newCache(){return this._newCache}getVaoCache(e,t){const i=Array.from(e).join("."),r=JSON.stringify(t),a=this._vaoCaches.get(i,r);if(a)return a;const n=new M4(this,e,t);return this._vaoCaches.set(i,r,n),n}bindTechnique(e,t,i,r){return this.useProgram(e.program),this.setPipelineState(e.getPipeline()),e.program.bind(t),i&&(e.program.bindPass(i,t),r&&e.program.bindDraw(t,i,r)),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??(this._appleAmdDriverHelper=new G2(this)),this._appleAmdDriverHelper.run())}get test(){}};function Bb(s){return!!s.frameUpdate}let ol=class extends Re{constructor(s){super({}),this._stage=s,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new Va,this._frameTask=s.view.resourceController.scheduler.registerTask(ai.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(hw.Texture,s=>s.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}acquire(s){const e=this._textures.get(s);return e?(e.ref(),e.loadingPromise??e):this._createNewRef(s)}update(){let s=!1;this._frameUpdates.forEach(e=>{const t=e.texture.frameUpdate(e.previousToken);t>=0&&t!==e.previousToken&&(e.previousToken=t,s=!0)}),s&&this.events.emit("changed",Ce.BACKGROUND)}_createNewRef(s){const e=this._stage.getObject(s);if(e==null)return null;const t=e.events.on("unloaded",()=>{t.remove(),this._onTextureUnloaded(s)}),i=new A4(s,()=>{this._frameTask.schedule(()=>{i.isUnreferenced&&e.unload()})});return this._textures.set(s,i),i.ref(),e.glTexture?(this._updateGLTexture(i,e.glTexture),Bb(e)&&this._frameUpdates.set(s,{texture:e,previousToken:-1}),i):(this._loadingCount++,i.loadingPromise=this._stage.schedule(()=>{const r=e.load(this._stage.renderView.renderingContext),a=o=>(this._loadingCount--,i.loadingPromise=null,this._updateGLTexture(i,o),Bb(e)&&this._frameUpdates.set(s,{texture:e,previousToken:-1}),i),n=o=>(this._loadingCount--,i.loadingPromise=null,cn(o)||pe.getLogger(this).error(o),null);return mg(r)?r.then(a,n):a(r)}),i.loadingPromise)}_updateGLTexture(s,e){s.glTexture=e,this.events.emit("changed",Ce.UPDATE)}_onTextureUnloaded(s){this._textures.delete(s),this._frameUpdates.delete(s)}};c([m()],ol.prototype,"_loadingCount",void 0),c([m()],ol.prototype,"_frameTask",void 0),c([m()],ol.prototype,"updating",null),ol=c([F("esri.views.3d.webgl-engine.lib.TextureRepository")],ol);let A4=class{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(pe.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}};function D4(s,e){return new TO(t=>SO(t,s),t=>t,e)}let Uh=class extends Re{constructor(){super(...arguments),this._passParameters=new $4,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=xn(this._resourcesTask),this._passParameters.waveNormal=We(this._passParameters.waveNormal),this._passParameters.wavePerturbation=We(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(s){return this._resourcesTask||(this._resourcesTask=Oc(async e=>{await Promise.allSettled([this._loadImageResource(s,ey("esri/images/materials/water/normals.jpg"),t=>this._passParameters.waveNormal=t,e),this._loadImageResource(s,ey("esri/images/materials/water/perturbation.jpg"),t=>this._passParameters.wavePerturbation=t,e)])})),this._resourcesTask.finished?Ty.LOADED:Ty.LOADING}async _loadImageResource(s,e,t,i){try{const r=await yc(e,{signal:i});Ai(i);const a=new mi(r.width,r.height);a.pixelFormat=ni.RGB,a.samplingMode=Ds.LINEAR_MIPMAP_LINEAR,a.hasMipmap=!0,a.maxAnisotropy=8,t(new oi(s,a,r))}catch(r){pe.getLogger(this).error("Failed to load water material normal texture.",r)}}};c([m()],Uh.prototype,"_resourcesTask",void 0),c([m({type:Boolean,readOnly:!0})],Uh.prototype,"updating",null),Uh=c([F("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],Uh);class $4 extends Ii{}class I4{constructor(e,t){this.parameters=e,this.fbos=t}}class L4{constructor(e,t,i){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=i,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(Ce.BACKGROUND);const t=ug();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const i of this._screenshotQueue){if(this._rctx==null){i.resolver.reject();continue}const r={...i.settings,pixelRatio:i.settings.pixelRatio*e.parameters.camera.pixelRatio},a=this._renderScreenshot(e,r,t);i.resolver(a)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,i){e.width=t.width,e.height=t.height;const r=e.getContext("2d"),a=i.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(a,a),t=this._renderFunctions.renderOverlay(e,i.disableDecorations,t),r.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:i,framebufferHeight:r,region:a,resample:n}=e,o=this._ensureScreenshotEncodeCanvas();let l=Qp(i,r,o);this._rctx.gl.readPixels(0,0,i,r,ni.RGBA,qh.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),t(),l=this._renderScreenshotOverlay(o,l,{...e,region:void 0});const h=Qp(a.width,a.height,o);return lS(l,h,!0,n.region.x,r-(n.region.y+n.region.height),n.region.width,n.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:i,region:r}=e,a=this._ensureScreenshotEncodeCanvas(),n=Qp(r.width,r.height,a);return this._rctx.gl.readPixels(r.x,i-(r.y+r.height),r.width,r.height,ni.RGBA,qh.UNSIGNED_BYTE,new Uint8Array(n.data.buffer)),t(),this._renderScreenshotOverlay(a,n,e)}_renderScreenshot(e,t,i){const r=e.parameters.camera,a={width:t.framebufferWidth,height:t.framebufferHeight};$g(a,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let n=!1;const o=a.width!==r.fullWidth||a.height!==r.fullHeight,l=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,h=o||t.disableDecorations||l||t.objectAndLayerIdColor;let u=null,d=null;if(h){const g=r.clone();if(t.ignorePadding){const T=ew(g.padding);for(let P=0;P<4;P++)T[P]=Math.round(T[P]/g.pixelRatio*t.pixelRatio);g.padding=T}g.fullWidth=a.width,g.fullHeight=a.height,g.pixelRatio=t.pixelRatio;const y=r.fovX-g.fovX,b=r.fovY-g.fovY;y<0&&y<b?g.fovX=r.fovX:b<0&&b<y&&(g.fovY=r.fovY);const x={camera:g,contentCamera:g,mode:Oi.IDLE,alignPixelEnabled:!0,contentPixelRatio:g.pixelRatio,forcedAnimationTime:e.parameters.forcedAnimationTime};this._forceCameraHook(x),n=!0;const C=this._renderFunctions.renderScene(x,i,t.objectAndLayerIdColor?xa.ObjectAndLayerID:xa.Screenshot,t.disableDecorations);d=C.screen,u=C.olid}const p=()=>{this._rctx.bindFramebuffer(null),d==null||d.release()};this._rctx.bindFramebuffer(d==null?void 0:d.fbo);const _=this._readbackScreenshot(t,p);let f=null;if(t.objectAndLayerIdColor){const g=()=>{this._rctx.bindFramebuffer(null),u==null||u.release()};this._rctx.bindFramebuffer(u==null?void 0:u.fbo),f=this._readbackScreenshot(t,g),this._rctx.bindFramebuffer(null)}if(h&&!this._rctx.contextAttributes.alpha)for(let g=3;g<_.data.length;g+=4)_.data[g]=255;if(f&&!this._rctx.contextAttributes.alpha)for(let g=3;g<f.data.length;g+=4)f.data[g]=255;return n&&this._forceCameraHook(e.parameters),[_,f]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas??(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}let Ti=class extends Re{constructor(s){super(s),this.events=new Va,this.waterTextures=new Uh,this.olidRenderHelper=gc()?new S5:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._savedFadeDuration=Xe(0);const e=s.stage;try{this._initializeContext(e)}catch(r){return void console.error("Failed to initialize context",r)}const{memoryController:t}=e.view.resourceController;this.stippleTextures=PO(this._rctx,t),this.markerTextures=D4(this._rctx,t),this._techniques=new V2(new BN(this._rctx,e.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new ol(e),this.addHandles(this._textures.events.on("changed",r=>this.requestRender(r))),this._materials=new _P(this._textures,this._techniques,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new T5(this._rctx,this._techniques),this.renderer=new Md(e,this._materials,this._techniques,this._rctx,this._compositingHelper,r=>this.requestRender(r)),this.addHandles([O(()=>e.view.ready,r=>{r&&this._createRenderNodes()},at),O(()=>{var r;return(r=this.waterTextures)==null?void 0:r.updating},()=>this.requestRender(),at),O(()=>e.view.qualityProfile,r=>{var a;return(a=this.renderer)==null?void 0:a.updateRenderFeatures(r)},Be)]);const i={renderScene:(r,a,n,o)=>this.renderer.render(r,a,n,o),requestRenderScene:r=>this.requestRender(r),prepareOverlay:()=>e.options.screenshot.prepareOverlay(),renderOverlay:(r,a,n)=>e.options.screenshot.renderOverlay(r,a,n)};this._screenshotManager=new L4(this._rctx,i,r=>this.events.emit("force-camera-for-screenshot",r)),this._registerFrameTask(e)}destroy(){var e;const s=(e=this.stage)==null?void 0:e.container;s!=null&&s.contains(this._canvas)&&s.removeChild(this._canvas),this._frameTask=ea(this._frameTask),this._techniques=se(this._techniques),this._componentObjects=se(this._componentObjects),this._screenshotManager=se(this._screenshotManager),se(this.renderer),this._textures=se(this._textures),se(this.waterTextures),se(this.markerTextures),se(this.stippleTextures),this._canvas=null,this._rctx=se(this._rctx)}_createRenderNodes(){const{view:s,viewingMode:e}=this.stage;new ng({view:s}),gg(s.spatialReference)||(e===Ne.Local?new ig({view:s}):_g(s.spatialReference)?new N3({view:s}):(new J_({view:s}),new eg({view:s}),new ag({view:s}),new tg({view:s}))),new N2({view:s,isEnabled:()=>this.renderer.hasSSAO}),new Wn({view:s,isEnabled:()=>this.renderer.hasSMAA}),new jn({view:s}),new gP({view:s}),new al({view:s,viewingMode:e}),new Nh({view:s}),gc()&&new Lh({view:s})}requestRender(s=Ce.UPDATE){this._needsRender=!0,s===Ce.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(s){this._idleSuspend!==s&&(this._idleSuspend=s,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(s){return this._screenshotManager.takeScreenshot(s).then(e=>e[0])}takeScreenshotWithOID(s){return s.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(s)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(s,e,t,i,r,a=r){const n=i.constrainWindowSize(e,t,r*i.pixelRatio,a*i.pixelRatio),o=this._ensureLinearDepthArrayBuffer(n);this.renderer.readMainDepth(n,o);const l=(u,d,p)=>f2(d,u)*(p[1]-p[0])+p[0];let h=Number.MAX_VALUE;for(let u=0;u<n[2]*n[3];u++){const d=l(4*u,o,i.nearFar);h>d&&d!==i.nearFar[0]&&d!==i.nearFar[1]&&(h=d)}if(s){const u=s.pickDepth(e*i.pixelRatio,t*i.pixelRatio,i);u!=null&&h>u&&u!==i.nearFar[0]&&u!==i.nearFar[1]&&(h=u)}return h===Number.MAX_VALUE?void 0:h}_ensureLinearDepthArrayBuffer(s){const e=4*s[2]*s[3];return(this._tmpDepthBuffer==null||this._tmpDepthBuffer.byteLength<e)&&(this._tmpDepthBuffer=new Uint8Array(e)),this._tmpDepthBuffer}async reloadShaders(){var s;gx(),await this._techniques.reloadAll(),(s=this.renderer.overlay)==null||s.reloadShaders(),this.requestRender()}_registerFrameTask(s){const e=s.view.state;let t=!1,i=Ce.BACKGROUND,r=!1;const a={preRender:({time:n})=>{t=this.updating,i=this._needsUpdate?Ce.UPDATE:Ce.BACKGROUND,s.commitSyncLayers(),n=this._testTime??n,(Xe(n-this._lastAnimationUpdate)>this.renderer.animationTimestep||e.forcedAnimationTime!=null||t||this._needsRender)&&(this.renderer.updateAnimation(e,n)&&this.requestRender(Ce.BACKGROUND),this._lastAnimationUpdate=n)},render:({time:n})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&e.camera.fullWidth>0&&e.camera.fullHeight>0){const o=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,n=this._testTime??n,this.renderer.render(e,n),r=!0,o&&this.renderer.hasReflections&&(this.requestRender(Ce.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:n})=>{this._textures.update();const o=new I4(e,this.renderer.fboCache);n=this._testTime??n,this._screenshotManager.update(o,n)},finish:()=>{r&&(this.renderer.finish(e.mode===Oi.IDLE?i:Ce.UPDATE),r=!1)}};this._frameTask=mp(a)}_initializeContext(s){const{options:e}=s,t=e.canvas??document.createElement("canvas");t.setAttribute("style","width: 100%; height:100%; display:block;"),this._canvas=t;const i={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:e.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:e.preserveDrawingBuffer??!1},r=t.getContext("webgl2",i);if(r==null)return void pe.getLogger(this).error("A WebGL2 context could not be created.");this._rctx=N4(r,s),this._loadShaderOnlyExtensions(),!e.alpha&&this._rctx.contextAttributes.alpha&&pe.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested");const{container:a}=s;!this._rctx.contextAttributes.alpha&&Gi("safari")>=11&&(a.style.backgroundColor="black"),a.contains(t)||a.appendChild(t)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}get _viewingMode(){return this.stage.viewingMode}getObjectAndLayerIdColor(s){var e;return(e=this.olidRenderHelper)==null?void 0:e.getObjectAndLayerIdColor(s)}get componentObjectCollection(){return this._componentObjects==null&&(this._componentObjects=new HN(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(s){this._componentObjects=s}updateQualitySettings(s){this._testTime!=null&&(this._savedFadeDuration=s.fadeDuration,s.fadeDuration=Xe(0))}set testTime(s){this._testTime=s,s==null?this.stage.view.qualitySettings.fadeDuration=this._savedFadeDuration:this.updateQualitySettings(this.stage.view.qualitySettings)}get testTime(){return this._testTime}};function N4(s,e){const t=(r,a)=>e.view.resourceController.memoryController.newCache(r,a),i={disabledExtensions:e.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.options.debugWebGLExtensions||{},maxAnisotropy:8,newCache:t};return new R4(s,i)}c([m({type:Boolean,readOnly:!0})],Ti.prototype,"updating",null),c([m({constructOnly:!0})],Ti.prototype,"stage",void 0),c([m()],Ti.prototype,"_rctx",void 0),c([m()],Ti.prototype,"_canvas",void 0),c([m()],Ti.prototype,"stippleTextures",void 0),c([m()],Ti.prototype,"markerTextures",void 0),c([m()],Ti.prototype,"waterTextures",void 0),c([m({readOnly:!0})],Ti.prototype,"olidRenderHelper",void 0),c([m()],Ti.prototype,"_textures",void 0),c([m({readOnly:!0})],Ti.prototype,"renderer",void 0),c([m()],Ti.prototype,"_screenshotManager",void 0),c([m()],Ti.prototype,"componentObjectCollection",null),c([m()],Ti.prototype,"_componentObjects",void 0),c([m()],Ti.prototype,"_needsUpdate",void 0),c([m()],Ti.prototype,"_needsWaterReflectionUpdate",void 0),Ti=c([F("esri.views.3d.webgl-engine.parts.RenderView")],Ti);let Fs=class extends Re{constructor(s){super(s),this._model=new bd,this._layers=new mt,this._asyncChangeSet=new w_,this._syncChangeSet=new w_,this._layerSyncSet=new Set}initialize(){this._set("renderView",new Ti({stage:this})),this._frameTask=this.view.resourceController.scheduler.registerTask(ai.STAGE,this),this.addHandles(this._frameTask)}destroy(){this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){var s;return(s=this.renderView)==null?void 0:s.renderer}add(s){this._model.add(s),Wd(s)&&this._addLayer(s),this.renderView.requestRender()}remove(s){s!=null&&!this.destroyed&&this._model.remove(s)&&(Wd(s)&&this._removeLayer(s),this.renderView.requestRender())}addMany(s){s!=null&&(this._model.addMany(s),this.renderView.requestRender())}removeMany(s){var e,t;s!=null&&((e=this._model)==null||e.removeMany(s),(t=this.renderView)==null||t.requestRender())}forEachOfType(s,e){this._model.forEachOfType(s,e)}handleEvent(s,e){this.destroyed||(this._model.dirtySet[s](e),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(s){if(this._frameTask.processQueue(s),this._commit(s),!s.hasProgressed)return Xi}_commit(s){const e=this._model.dirtySet;this._asyncChangeSet.empty||s.done||(this.renderer.modify(this._asyncChangeSet,s),this.renderView.requestRender(),s.madeProgress()),this._layers.forAll(t=>{if(s.done)return;const i=this._layerSyncSet.has(t.id)||t.updatePolicy===Wp.SYNC,r=i?this._syncChangeSet:this._asyncChangeSet;e.commitLayer(t.id,r),this._layerSyncSet.delete(t.id),r.empty||(this.renderer.modify(r,i?qr:s),this.renderView.requestRender(),s.madeProgress())}),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,qr),this.renderView.requestRender(),s.madeProgress()),this._layers.forAll(t=>{s.done||this._layerSyncSet.has(t.id)||t.updatePolicy!==Wp.ASYNC||(e.commitLayer(t.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,s),this.renderView.requestRender(),s.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const s=this._model.dirtySet;this._layers.forAll(e=>{this._layerSyncSet.has(e.id)||e.updatePolicy===Wp.SYNC?(s.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id)):s.commitSyncUpdates(e.id,this._syncChangeSet)});for(const e of this._layerSyncSet)s.commitLayer(e,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,qr),this.renderView.requestRender())}_commitLayer(s){this._model.dirtySet.commitLayer(s.id,this._syncChangeSet),this._layerSyncSet.delete(s.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,qr),this.renderView.requestRender())}schedule(s,e){return this._frameTask.schedule(s,e)}reschedule(s,e){return this._frameTask.reschedule(s,e)}syncLayer(s){this._layerSyncSet.add(s),this.renderView.requestRender()}getObject(s){return this._model.getObject(s)}get layers(){return this._layers}_addLayer(s){this._layers.includes(s)||this._layers.push(s)}_removeLayer(s){this._commitLayer(s),this._layers.removeUnordered(s)!=null&&(this._model.dirtySet.getResidentRenderGeometries(s.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,qr))}addRenderPlugin(s,e){const t=this.renderer.plugins.add(s,e),i=()=>{a0(s)&&this.view.sceneIntersectionHelper.addIntersectionHandler(s)};if(mg(t))return t.then(i);i()}removeRenderPlugin(s){this.destroyed||(a0(s)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(s),this.renderer.plugins.remove(s))}get performanceInfo(){return this._model.getStats()}get test(){}};c([m({constructOnly:!0})],Fs.prototype,"view",void 0),c([m({constructOnly:!0})],Fs.prototype,"options",void 0),c([m({readOnly:!0})],Fs.prototype,"viewingMode",null),c([m({constructOnly:!0})],Fs.prototype,"container",void 0),c([m({readOnly:!0})],Fs.prototype,"updating",null),c([m({constructOnly:!0})],Fs.prototype,"_model",void 0),c([m()],Fs.prototype,"renderView",void 0),c([m({readOnly:!0})],Fs.prototype,"renderer",null),c([m({readOnly:!0})],Fs.prototype,"running",null),Fs=c([F("esri.views.3d.webgl-engine.Stage")],Fs);const dp=new Set,FC=()=>pe.getLogger("esri/views/support/TextureCompressionHelper");function V4(s,e){var t;return(t=oi).compressionWorkerHandle??(t.compressionWorkerHandle=new kL(q2(e))),dp.has(s)?FC().warn("Repeated texture compression worker initialization by the same view."):dp.add(s),oi.compressionWorkerHandle}function F4(s){oi.compressionWorkerHandle&&(dp.delete(s)||FC().warn("Unknown view attempted to destroy the texture compression worker."),dp.size||(se(oi.compressionWorkerHandle),oi.compressionWorkerHandle=null))}let Rd=class extends r1{constructor(s){super(s),this.components=["attribution","zoom","navigation-toggle","compass"]}};c([m()],Rd.prototype,"components",void 0),Rd=c([F("esri.views.ui.3d.DefaultUI3D")],Rd);const UC=Rd;let Z=class extends hS(cS(uS(pS))){constructor(s){super(s),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._overrideDefaultEnvironmentOnly=!0,this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new yn({slicePlane:GT},this),this._resourceController=v$(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new B_({view:this}),this.labeler=new kn({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new a1,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new Xn,this.environment=new il,this.environmentManager=new Ns,this.floors=new wo,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new J2({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new QD({view:this}),this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new UC,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.focusAreas=new yS({view:this}),fT();const e=(t=null)=>{t!=null&&t.type===Zf.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(async i=>{try{await i.when()}catch{}this._updatingChanged()}))};this.addHandles([Aa(()=>{var t;return(t=this.map)==null?void 0:t.allLayers},"after-changes",t=>e(t),{onListenerAdd:()=>e(),onListenerRemove:()=>e(),sync:!0}),this.allLayerViews.on("after-changes",t=>this._updateUpdatingMonitors(t)),O(()=>this.map,t=>{t&&"load"in t&&t.load&&t.load().catch(()=>{})})]),this.inputManager=new RA({view:this}),this.stateManager=new Lt({view:this})}initialize(){if(Gi("enable-feature:esri-compress-textures")){const e=V4(this,this.resourceController);this.addResolvingPromise(e.promise)}this.groundView=new X2({view:this}),this._updateUpdatingMonitors();const s=()=>this._updateDefaultToMapOptions();this.addHandles(Aa(()=>{var e;return(e=this.map)==null?void 0:e.allLayers},"after-changes",s,{onListenerAdd:s,onListenerRemove:s})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},at),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},at),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,e=>rT(e>0?1e3/Math.ceil(e):0),at),this.updatingHandles.add(()=>{var e;return(e=this.map)==null?void 0:e.ground},s,Be),this.updatingHandles.add(()=>{var e,t;return(t=(e=this.map)==null?void 0:e.ground)==null?void 0:t.opacity},()=>this._updateDefaultHitTestOptions(),Be),this.addHandles(O(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),Ge))}destroy(){var s;this.destroyed||(F4(this),this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._set("analysisViewManager",se(this.analysisViewManager)),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=se(this.sharedSymbolResources),this._set("labeler",se(this.labeler)),this._set("deconflictor",se(this.deconflictor)),this._resourceController=se(this._resourceController),this._set("stateManager",se(this.stateManager)),this._set("inputManager",se(this.inputManager)),this.state.destroy(),this.highlights.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",se(this.environmentManager)),this._set("environment",se(this.environment)),this.groundView=se(this.groundView),this._exitBasemapTerrain(),(s=this._stage)==null||s.destroy())}get renderSpatialReference(){var s;return(s=this.renderCoordsHelper)==null?void 0:s.spatialReference}get basemapSpatialReference(){var s;return(s=this.basemapTerrain)==null?void 0:s.spatialReference}get animation(){var s;return(s=this.state)==null?void 0:s.animation}get camera(){var s;return(s=this.stateManager)==null?void 0:s.camera}set camera(s){this.stateManager&&(this.stateManager.camera=s)}get contentCamera(){var s;return(s=this.stateManager)==null?void 0:s.contentCamera}set contentCamera(s){this.stateManager&&(this.stateManager.contentCamera=s)}installContentCameraReset(s={sticky:!1}){return this.stateManager.installContentCameraReset(s)}get center(){var s;return(s=this.stateManager)==null?void 0:s.center}set center(s){this.stateManager&&(this.stateManager.center=s)}get clippingArea(){if(this.viewingMode==="global")return null;const s=this.map;let e=this._userClippingArea||Yf(s,"clippingArea");return!this._userClippingArea&&!Yf(s,"clippingEnabled")||e==null?(this._clippingArea=null,null):e instanceof dr?this.spatialReference&&(e=Gu(e,this.spatialReference),e==null)?(pe.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),e.intersection(this._groundAndLayersExtent)==null&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(pe.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(s){this.ready&&this.viewingMode==="global"&&s!=null?pe.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=s}get renderDataExtent(){if(this.state.viewingMode===Ne.Global)return null;const s=this.renderSpatialReference,e=this.dataExtent;return e==null||s==null||e.spatialReference.equals(s)?e:Gu(e,s)}get tileInfo(){var s,e;return(e=(s=this.basemapTerrain)==null?void 0:s.tilingScheme)==null?void 0:e.toTileInfo()}get dataExtent(){let s=this._groundAndLayersExtent;const e=this.spatialReference||si.WGS84,t=Gu(this.clippingArea,e);t!=null&&(s=s!=null?s.intersection(t):t);const i=this._get("dataExtent");return s!=null&&s.equals(i)?i:s}get _groundAndLayersExtent(){const s=this.spatialReference||si.WGS84;let e;const t=a=>{const n=Gu(a,s);n!=null&&(e!=null?e.union(n):e=n.clone())},i=this.basemapTerrain;if(i!=null&&i.spatialReference){const a=i.groundExtent;t(new dr({xmin:a[0],ymin:a[1],zmin:0,xmax:a[2],ymax:a[3],zmax:0,spatialReference:i.spatialReference}))}if(this.map){const a=n=>{n.fullExtent==null||n.type==="graphics"&&n.internal||t(n.fullExtent)};this.map.allLayers.forEach(n=>a(n))}if(e==null)return null;e.hasZ?(e.zmin=Math.min(0,e.zmin??0),e.zmax=Math.max(0,e.zmax??0)):(e.zmin=0,e.zmax=0);const r=this._get("_groundAndLayersExtent");return e.equals(r)?r:e}castEnvironment(s){var e;return s?s instanceof il?s:s instanceof Rw?((e=this.environment)==null?void 0:e.cloneWithWebsceneEnvironment(s))??il.fromWebsceneEnvironment(s):aT(il,s):new il}get extent(){var s;return(s=this.stateManager)==null?void 0:s.extent}set extent(s){this.stateManager&&(this.stateManager.extent=s)}get screenCenter(){var s;return(s=this.stateManager)==null?void 0:s.screenCenter}get frustum(){var s;return(s=this.stateManager)==null?void 0:s.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){var s;return this.navigating||(((s=this.toolViewManager)==null?void 0:s.interacting)??!1)}get stationary(){var s;return!this.animation&&!this.resizing&&(((s=this.state)==null?void 0:s.stationary)??!0)}get navigating(){var s;return((s=this.state)==null?void 0:s.navigating)??!1}get padding(){var s;return(s=this.stateManager)==null?void 0:s.padding}set padding(s){this.stateManager&&(this.stateManager.padding=s)}set qualityProfile(s){var e;ho.isValidProfile(s)&&(ho.apply(s,this.qualitySettings),(e=this._stage)==null||e.renderView.updateQualitySettings(this.qualitySettings),this._set("qualityProfile",s))}get qualityProfile(){return this._get("qualityProfile")||ho.getDefaultProfile()}set slicePlane(s){if(this._stage!=null&&(this._stage.renderer.slicePlane=s),s==null)return void this._set("slicePlane",null);const e=this._propertiesPool.get("slicePlane");yg(s,e),this._set("slicePlane",e)}get typeSpecificPreconditionsReady(){var s;return!!this.viewingMode&&!!((s=this.stateManager)!=null&&s.preinit(this.spatialReference))}get resolution(){return this.spatialReference!=null?jT(this.scale,this.spatialReference):0}get scale(){var s;return(s=this.stateManager)==null?void 0:s.scale}set scale(s){this.stateManager&&(this.stateManager.scale=s)}get heightModelInfo(){const s=this.getDefaultHeightModelInfo();return s!=null?ET.deriveUnitFromSR(s,this.spatialReference):null}get updating(){var r,a,n,o;if(this.destroyed)return!1;let s=0,e=this.layerViewManager.updating,t=e?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(l=>{if(l.isFulfilled()){if(l.updating){if(e=!0,l.suspended||g_(l))return;++t,s+=l.updatingProgress}}else++t});for(const l of this._updatingObjects)l!=null&&l.updating&&(t+=.1,s+=.5*.1);for(const l of this._updatingObjectsWithProgress)l!=null&&l.updating&&(++t,s+=l.updatingProgress);const i=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(e=!!(e||t>0||this.updatingHandles.updating||!this.ready||!this.stationary||i||this._createGraphicsViewController||(r=this.inputManager)!=null&&r.updating||(n=(a=this.map)==null?void 0:a.allLayers)!=null&&n.some(l=>!l.isFulfilled())||(o=this.textures)!=null&&o.updating),e?(this._numUpdating=Math.max(t,this._numUpdating),s+=this._numUpdating-t):this._numUpdating=0,this._numUpdating>0?s/=this._numUpdating:s=e?0:1,this._get("updatingProgress")!==s){const l=performance.now();if(s<1){const h=Math.min((l-this._lastUpdateTime)/2e3,1);s=this.updatingProgress*(1-h)+s*h}this._set("updatingProgress",s),this._lastUpdateTime=e&&s<1?l:0}return e}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){var t;const s=this._predeterminedViewingMode;if(s!=null)return Bp(s);const e=this.spatialReference;return e?((t=this.defaultsFromMap)==null?void 0:t.viewingMode)!=null&&e.equals(this.defaultsFromMap.spatialReference)?Bp(this.defaultsFromMap.viewingMode):Gy(e,Ne.Global)?"global":"local":"global"}set viewingMode(s){this.ready?pe.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",s)}get viewpoint(){var s;return(s=this.stateManager)==null?void 0:s.viewpoint}set viewpoint(s){this.stateManager&&(this.stateManager.viewpoint=s)}get visibleArea(){var s;return(s=this.stateManager)==null?void 0:s.visibleArea}get zoom(){return this.stateManager.zoom}set zoom(s){this.stateManager&&(this.stateManager.zoom=s)}get highlightOptions(){return this.highlights.find(({name:s})=>s===nn)??new n1}set highlightOptions(s){for(let e=0;e<this.highlights.length;++e)if(this.highlights.at(e).name===nn)return void this.highlights.items[e].assignFrom(s)}get resourceController(){return this._resourceController}get quality(){var s,e;return((e=(s=this._resourceController)==null?void 0:s.memoryController)==null?void 0:e.memoryFactor)??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new w$(this)}on(s,e,t,i){return this.viewEvents.on(s,e,t,i)||super.on(s,e)}hasEventListener(s){return super.hasEventListener(s)||this.viewEvents.hasHandler(s)}toMap(s,e){if(!this.ready)return pe.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const t=Hy(s)?zy(this,s):s;return LO(this,t,e,this._defaultToMapOptions)}toScreen(s){if(!this.ready)return pe.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const e=(s.z==null?Bg(this.elevationProvider,s):null)??0;return ec(s,Bu,this.renderSpatialReference,e),this.state.camera.projectToScreen(Bu,n_),Wb(n_[0],n_[1])}pixelSizeAt(s,e){if(!this.ready)return pe.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if(!s)return 0;const t=this.renderSpatialReference;ec(s,Bu,t);const i=this.state.camera.computeScreenPixelSizeAt(Bu);return e&&t!==e?i*h_(t)/h_(e):i}overlayPixelSizeInMapUnits(s){const e=this.basemapTerrain.overlayManager;return e?e.overlayPixelSizeInMapUnits(s,()=>this.pixelSizeAt(s)):1}hitTest(s,e){if(!this.ready)return pe.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const t=Hy(s)?zy(this,s):s;return NO(this,t,e,this._defaultHitTestOptions)}async popupHitTest(s){return e$(this,s)}goTo(s,e){return this.updatingHandles.addPromise(this.stateManager.goTo(s,e))}async whenAnalysisView(s){if(s.parent==null)throw new Ri("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:s});switch(s.parent.type){case"line-of-sight":case"dimension":case"viewshed":return(await this.whenLayerView(s.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(s)}}whenLayerView(s){return super.whenLayerView(s)}async takeScreenshot(s){const e=await this._completeSettings(s);await this.whenReady();const t=await this._stage.renderView.takeScreenshot(e);return(await X(async()=>{const{encode:i}=await import("./DefaultUI-BwWVKFUS.js").then(r=>r.X);return{encode:i}},__vite__mapDeps([173,1,17,18,5,165,166,29,8,3,4,9,167,148,174,169,73,175,37,38,10,11,7,176,177,178,179,140,23,24,13,30,180,28,181,182,183,184,185,186,36,187,51,6,43,188,189,32,159,160,170,26,27,31,33,12,34,35,39,20,190,191,192,104,105,193,194,195,196,197,198,199,200,19,66,2,14,15,42,201,202,203,204,205,206,207,208,209]),import.meta.url)).encode(t,e,this._pixelFormat())}async _takeScreenshot(s){const e=await this._completeSettings(s);await this.whenReady();const t=await this._stage.renderView.takeScreenshot(e);return(await X(async()=>{const{encodeData:i}=await import("./DefaultUI-BwWVKFUS.js").then(r=>r.X);return{encodeData:i}},__vite__mapDeps([173,1,17,18,5,165,166,29,8,3,4,9,167,148,174,169,73,175,37,38,10,11,7,176,177,178,179,140,23,24,13,30,180,28,181,182,183,184,185,186,36,187,51,6,43,188,189,32,159,160,170,26,27,31,33,12,34,35,39,20,190,191,192,104,105,193,194,195,196,197,198,199,200,19,66,2,14,15,42,201,202,203,204,205,206,207,208,209]),import.meta.url)).encodeData(t,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(s){const e=await this._completeSettings(s);await this.whenReady();const t=await this._stage.renderView.takeScreenshotWithOID(e),{encodeData:i}=await X(async()=>{const{encodeData:r}=await import("./DefaultUI-BwWVKFUS.js").then(a=>a.X);return{encodeData:r}},__vite__mapDeps([173,1,17,18,5,165,166,29,8,3,4,9,167,148,174,169,73,175,37,38,10,11,7,176,177,178,179,140,23,24,13,30,180,28,181,182,183,184,185,186,36,187,51,6,43,188,189,32,159,160,170,26,27,31,33,12,34,35,39,20,190,191,192,104,105,193,194,195,196,197,198,199,200,19,66,2,14,15,42,201,202,203,204,205,206,207,208,209]),import.meta.url);return[i(t[0],this._pixelFormat()),i(t[1],this._pixelFormat())]}async _completeSettings(s){const{toRenderSettings:e,screenshotSuperSampleSettings:t}=await X(()=>import("./DefaultUI-BwWVKFUS.js").then(r=>r.X),__vite__mapDeps([173,1,17,18,5,165,166,29,8,3,4,9,167,148,174,169,73,175,37,38,10,11,7,176,177,178,179,140,23,24,13,30,180,28,181,182,183,184,185,186,36,187,51,6,43,188,189,32,159,160,170,26,27,31,33,12,34,35,39,20,190,191,192,104,105,193,194,195,196,197,198,199,200,19,66,2,14,15,42,201,202,203,204,205,206,207,208,209]),import.meta.url),i=e(s,this);return i.pixelRatio/=this.state.pixelRatio,t(i,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){}async takeScreenshotWithObjectAndLayerId(s){if(!gc())throw new Ri("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true");const{encode:e}=await X(()=>import("./DefaultUI-BwWVKFUS.js").then(n=>n.X),__vite__mapDeps([173,1,17,18,5,165,166,29,8,3,4,9,167,148,174,169,73,175,37,38,10,11,7,176,177,178,179,140,23,24,13,30,180,28,181,182,183,184,185,186,36,187,51,6,43,188,189,32,159,160,170,26,27,31,33,12,34,35,39,20,190,191,192,104,105,193,194,195,196,197,198,199,200,19,66,2,14,15,42,201,202,203,204,205,206,207,208,209]),import.meta.url),t=await this._completeSettings(s);await this.whenReady();const i=await this._stage.renderView.takeScreenshotWithOID(t),r=e(i[0],t,this._pixelFormat()),a=await this._completeSettings(s);return a.format="png",[r,e(i[1],a,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){const s=this._stage.renderView.olidRenderHelper;if(s)return s.getColorToObjectAndLayerIdMapping();throw new Ri("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true")}addUpdatingPromise(s){return this.updatingHandles.addPromise(s)}importLayerView(s){return ky.importLayerView(s)}hasLayerViewModule(s){return ky.hasLayerViewModule(s)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var s,e,t;return this.map&&"initialViewProperties"in this.map&&((s=this.map.initialViewProperties)==null?void 0:s.spatialReference)||((e=this.defaultsFromMap)==null?void 0:e.spatialReference)||((t=this.defaultsFromMap)==null?void 0:t.ready)&&this._initialDefaultSpatialReference||null}async validate(){let s=dS(this.type);const e=Gi("safari");if(e&&e<9&&(s=new Ri("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:e})),s!=null)throw pe.getLogger(this).warn("#validate()",s.message),s}get _predeterminedViewingMode(){var e;const s=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?(e=this.map.initialViewProperties)==null?void 0:e.viewingMode:null)??null;return s!=null?f_(s):null}getSpatialReferenceSupport(s,e){const t=this._predeterminedViewingMode;if(t!=null)return this._validateSpatialReferenceForViewingMode(s,e,t)?{constraints:this._makeSpatialReferenceConstraints(s,e,t)}:null;const i=this._validateSpatialReferenceForViewingMode(s,e,Ne.Local),r=this._validateSpatialReferenceForViewingMode(s,e,Ne.Global);return i||r?i&&r?{constraints:this._makeSpatialReferenceConstraints(s,e,null)}:i?{constraints:this._makeSpatialReferenceConstraints(s,e,Ne.Local)}:{constraints:this._makeSpatialReferenceConstraints(s,e,Ne.Global)}:null}_validateSpatialReferenceForViewingMode(s,e,t){return!!Gy(s,t)&&(e==null||!!ay(e)||(!zh(e)||fp(e,s,t)!=null)&&(!ny(e)||t!==Ne.Global))}_makeSpatialReferenceConstraints(s,e,t){if(e==null)return[{spatialReference:s,viewingMode:t}];const{isWebMercator:i,isWGS84:r}=s;return ay(e)&&(i||r)?!r||t===Ne.Local||KS(e.tileInfo,e.fullExtent,s,Ne.Global)===null?[{spatialReference:s,viewingMode:t},{spatialReference:si.WebMercator,viewingMode:t}]:[{spatialReference:i?si.WGS84:si.WebMercator,viewingMode:t}]:zh(e)||ny(e)||!i&&!r?zh(e)&&i&&t!==Ne.Global?[{spatialReference:s,viewingMode:t},{spatialReference:si.WGS84,viewingMode:Ne.Local}]:[{spatialReference:s,viewingMode:t}]:[{spatialReference:s,viewingMode:t},{spatialReference:i?si.WGS84:si.WebMercator,viewingMode:t}]}_validateSpatialReference(s){const e=this.getSpatialReferenceSupport(s)!=null,t=this._predeterminedViewingMode;return e||(t!=null?pe.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${Bp(t)} viewing mode.`):s.isGeographic&&pe.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),e}whenReady(){return new Promise(s=>{this.ready?s(this):this._resolveWhenReady.push(s)})}trackGraphicState(s){if(!s.graphic)return pe.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const e=this.getViewForGraphic(s.graphic);let t=null,i=!1;const r=a=>{var n;!i&&a!=null&&"processor"in a&&((n=a.processor)==null?void 0:n.type)==="graphics-3d"&&a.processor.graphicsCore&&(t=a.processor.graphicsCore.trackGraphicState(s))};return e!=null?r(e):this.whenViewForGraphic(s.graphic,{waitForLayer:!0}).then(a=>r(a),()=>{}).catch(()=>{}),po(()=>{i=!0,t!=null&&(t.remove(),t=null)})}maskOccludee(s){if(!s)return pe.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const e=this.getViewForGraphic(s);let t=null,i=!1;const r=a=>{!i&&a!=null&&B2(a)&&(t=a.maskOccludee(s))};return e!=null?r(e):this.whenViewForGraphic(s,{waitForLayer:!0}).then(a=>r(a),()=>{}).catch(()=>{}),po(()=>{i=!0,t!=null&&(t.remove(),t=null)})}getViewForGraphic(s){return s.layer===this.graphics?this.graphicsView:s.layer?this.allLayerViews.filter(e=>e.type!=="media-3d").find(e=>e.layer===s.layer):null}graphicChanged(s){this.graphicsView!=null&&this.graphicsView.graphicChanged(s)}async whenViewForGraphic(s,e){if(s.layer===this)return await l_(()=>this.graphicsView),this.graphicsView;if(!s.layer||!this.map)throw new Ri("no-view-for-graphic");return e&&e.waitForLayer&&!this.map.allLayers.includes(s.layer)?new Promise((t,i)=>{const r=this.map.allLayers.on("change",a=>{a.added.includes(s.layer)&&(r.remove(),this.whenLayerView(s.layer).then(t,i))})}):this.whenLayerView(s.layer)}_initBasemapTerrain(){this._set("basemapTerrain",new d3({view:this})),this._set("elevationProvider",new Ah({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new ss({view:this})),this._set("featureTiles",new gi({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const s=()=>{var t;const e=(t=this.basemapTerrain)==null?void 0:t.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const i=this.basemapTerrain.extent!=null&&this.basemapTerrain.spatialReference!=null?Kb(e1(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;this.clippingArea?this.featureTiles.filterExtent=this.clippingArea.intersection(i):this.featureTiles.filterExtent=i}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add(()=>xs.FEATURE_TILE_TREE_SHOW_TILES,e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(X(()=>import("./FeatureTileTree3DDebugger-BMAKj6Xj.js"),__vite__mapDeps([575,1,17,18,5,148,12,10,11,7,8,3,4,9,13,569,23,24,26,27,28,29,30,31,32,33,34,35,36,37,38,6,39]),import.meta.url)).then(({FeatureTileTree3DDebugger:t})=>{!this._featureTreeDebugger&&xs.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new t({view:this}))}):e||!this._featureTreeDebugger||xs.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)},Be),this.updatingHandles.add(()=>this.clippingArea,s,Be),this.updatingHandles.add(()=>this.basemapTerrain.extent,s,Be)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.featureTiles&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this._set("featureTiles",se(this.featureTiles)),this._set("pointsOfInterest",se(this.pointsOfInterest)),this._exitBasemapTerrain(),this.state.reset(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const s=this.spatialReference,e=this.state.isGlobal,t=BT(e,s);t!==this.renderSpatialReference&&(this._set("renderCoordsHelper",qT.create(this.state.viewingMode,t)),e||this.addHandles(O(()=>{var i;return(i=this.basemapTerrain)==null?void 0:i.extent},i=>{const r=this.renderCoordsHelper.spatialReference;i==null||i[0]===0&&i[1]===0&&i[2]===0&&i[3]===0||!Jb(i,this.basemapTerrain.spatialReference,qb,r)||(this.renderCoordsHelper.extent=qb)},Ge),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(jd/this.renderCoordsHelper.unitInMeters))}else this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null)}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(s=null){s!=null&&s.type===Zf.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.addHandles(O(()=>[e.updating,e.updatingProgress],()=>this._updatingChanged(),Ge),"updatingMonitors"),e.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(s,e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const i=s.getContext("2d");return i.putImageData(t,0,0),this.overlay.renderCanvas(s,{disableDecorations:e}),i.getImageData(0,0,t.width,t.height)}_initStage(){const s={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(i,r,a)=>this._renderScreenshotOverlay(i,r,a)}},e=new ZD(this.state.viewingMode,i=>this._stage.layers.forAll(i),this);this._set("sceneIntersectionHelper",e);const t=cT(this.surface);this._stage=new Fs({view:this,options:s,container:t}),this._stage.renderer.slicePlane=this.slicePlane,this.addHandles([this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,i=>this._stage.renderer.setParameters({highQualityTransparency:i}),at),this.on("pointer-move",()=>{var i;return(i=this._stage)==null?void 0:i.renderer.resetAnimation()}),nT(this._stage.renderView.canvas,"webglcontextlost",i=>{this.fatalError=new Ri("webgl-context-lost",i.statusMessage)})],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(jd/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=se(this._stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(s){this._exitSurface(),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new S$({view:this,viewingMode:s,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;const s=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(s,s),this._updatingChanged()}async _createGraphicsViewAsync(s){const e=(await X(async()=>{const{default:t}=await import("./GraphicsView3D-D0i8J2uZ.js");return{default:t}},__vite__mapDeps([576,1,32,436,26,27,17,18,5,9,8,3,4,10,28,29,7,30,23,24,13,31,33,11,12,34,35,36,37,38,6,39,311,148,189,159,160,58,59,14,15,60,2,22,25,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,192,193,217,383,253,310,303,304,305,306,307,140,308,309,312,313,384,185,186,187,178,166,385,386,387,161,174,169,143,419,390,199]),import.meta.url)).default;Ai(s),await l_(()=>{var t;return(t=this.basemapTerrain)==null?void 0:t.ready},s),this._set("graphicsView",new e({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),this.graphicsView!=null&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const s=f_(this.viewingMode);s===Ne.Global&&(this._clippingArea=null),this._initSurface(s),this._set("ready",!0),this.addHandles(Aa(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded();const e=this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties:null,t=e==null?void 0:e.environment;t&&(this._overrideDefaultEnvironmentOnly?Cw(this.environment,t):this.environment=this.environment.cloneWithWebsceneEnvironment(t)),this.timeExtent=e==null?void 0:e.timeExtent,this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect(),this._set("textures",new ml(this._stage,this.resourceController.scheduler));const i=this._resolveWhenReady;this._resolveWhenReady=[],i.forEach(r=>r(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this._overrideDefaultEnvironmentOnly=!1,this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._set("textures",se(this.textures)),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(_c);for(const s of this.map.allLayers.items)m_(s.type)&&this._defaultToMapOptions.include.add(s.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(_c);for(const s of this.map.allLayers.items)m_(s.type)&&s.opacity<1&&this._defaultHitTestOptions.exclude.add(s.uid)}}};function Gu(s,e){return s!=null&&RT(s.spatialReference,e)?Kb(s,e):null}Z.type="3d",c([m()],Z.prototype,"_userClippingArea",void 0),c([m()],Z.prototype,"_resourceController",void 0),c([m()],Z.prototype,"_stage",void 0),c([m({readOnly:!0})],Z.prototype,"deconflictor",void 0),c([m({readOnly:!0})],Z.prototype,"labeler",void 0),c([m(ST(a1,"analyses"))],Z.prototype,"analyses",void 0),c([m({type:Rl,readOnly:!0})],Z.prototype,"animation",null),c([m({readOnly:!0})],Z.prototype,"basemapTerrain",void 0),c([m({readOnly:!0})],Z.prototype,"elevationProvider",void 0),c([m()],Z.prototype,"camera",null),c([m({type:ta})],Z.prototype,"contentCamera",null),c([m({readOnly:!0})],Z.prototype,"canvas",void 0),c([m({type:Cs})],Z.prototype,"center",null),c([m({type:dr})],Z.prototype,"clippingArea",null),c([m({type:Xn})],Z.prototype,"constraints",void 0),c([m({type:dr,readOnly:!0})],Z.prototype,"renderDataExtent",null),c([m({readOnly:!0})],Z.prototype,"tileInfo",null),c([m({type:dr,readOnly:!0})],Z.prototype,"dataExtent",null),c([m({type:dr,readOnly:!0})],Z.prototype,"_groundAndLayersExtent",null),c([m({type:il})],Z.prototype,"environment",void 0),c([El("environment")],Z.prototype,"castEnvironment",null),c([m({readOnly:!0})],Z.prototype,"environmentManager",void 0),c([m({type:dr})],Z.prototype,"extent",null),c([m({type:wo})],Z.prototype,"floors",void 0),c([m()],Z.prototype,"screenCenter",null),c([m()],Z.prototype,"frustum",null),c([m({type:Number,readOnly:!0})],Z.prototype,"fullOpacity",void 0),c([m({readOnly:!0})],Z.prototype,"graphicsView",void 0),c([m({readOnly:!0})],Z.prototype,"analysisViewManager",void 0),c([m()],Z.prototype,"groundView",void 0),c([m({type:Boolean})],Z.prototype,"initialExtentRequired",null),c([m()],Z.prototype,"defaultsFromMapSettings",null),c([m()],Z.prototype,"interacting",null),c([m()],Z.prototype,"stationary",null),c([m()],Z.prototype,"navigating",null),c([m()],Z.prototype,"map",void 0),c([m()],Z.prototype,"padding",null),c([m({type:ss,readOnly:!0})],Z.prototype,"pointsOfInterest",void 0),c([m({type:gi,readOnly:!0})],Z.prototype,"featureTiles",void 0),c([m()],Z.prototype,"_featureTreeDebugger",void 0),c([m({type:Boolean})],Z.prototype,"screenSizePerspectiveEnabled",void 0),c([m({constructOnly:!0})],Z.prototype,"deactivatedWebGLExtensions",void 0),c([m({constructOnly:!0})],Z.prototype,"debugWebGLExtensions",void 0),c([m({constructOnly:!0})],Z.prototype,"renderCanvas",void 0),c([m({constructOnly:!0})],Z.prototype,"state",void 0),c([m({readOnly:!0})],Z.prototype,"inputManager",void 0),c([m({readOnly:!0})],Z.prototype,"stateManager",void 0),c([m({type:["low","medium","high"]})],Z.prototype,"qualityProfile",null),c([m({type:n0,get(){let s=this._get("qualitySettings");return s||(s=new n0,ho.apply(this.qualityProfile,s)),s}})],Z.prototype,"qualitySettings",void 0),c([m()],Z.prototype,"slicePlane",null),c([m({readOnly:!0})],Z.prototype,"typeSpecificPreconditionsReady",null),c([m({readOnly:!0})],Z.prototype,"renderCoordsHelper",void 0),c([m({readOnly:!0})],Z.prototype,"sceneIntersectionHelper",void 0),c([m({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Z.prototype,"resolution",null),c([m({type:Number})],Z.prototype,"scale",null),c([m()],Z.prototype,"heightModelInfo",null),c([m()],Z.prototype,"spatialReference",void 0),c([m({type:Boolean,constructOnly:!0})],Z.prototype,"alphaCompositingEnabled",void 0),c([m({constructOnly:!0})],Z.prototype,"preserveDrawingBufferEnabled",void 0),c([m({type:Boolean})],Z.prototype,"supersampleScreenshotsEnabled",void 0),c([m({readOnly:!0})],Z.prototype,"type",void 0),c([m(),El(s=>s instanceof r1?s:oT(UC,s))],Z.prototype,"ui",void 0),c([m({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],Z.prototype,"updating",null),c([m()],Z.prototype,"_updatingObjects",null),c([m()],Z.prototype,"_updatingObjectsWithProgress",null),c([m({type:Number,readOnly:!0,dependsOn:["updating"]})],Z.prototype,"updatingProgress",void 0),c([m({type:["global","local"]})],Z.prototype,"viewingMode",null),c([m({type:un})],Z.prototype,"viewpoint",null),c([m({readOnly:!0})],Z.prototype,"visibleArea",null),c([m({type:Number})],Z.prototype,"zoom",null),c([m({type:n1})],Z.prototype,"highlightOptions",null),c([m({readOnly:!0})],Z.prototype,"quality",null),c([m({readOnly:!0})],Z.prototype,"resolutionScale",null),c([m()],Z.prototype,"textures",void 0),Z=c([F("esri.views.SceneView")],Z);const Bu=v(),n_=ri(),qb=pi(),Wk=Z,Qk=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaColorPassParameters:vS,build:bS},Symbol.toStringTag,{value:"Module"})),Yk=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaMaskDrawParameters:wS,build:xS},Symbol.toStringTag,{value:"Module"})),U4=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:Xg,build:Tw,cubeMapSize:xl},Symbol.toStringTag,{value:"Module"})),H4=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:Kg,build:Sw},Symbol.toStringTag,{value:"Module"})),z4=Object.freeze(Object.defineProperty({__proto__:null,build:Ew},Symbol.toStringTag,{value:"Module"})),G4=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:mf,build:wx},Symbol.toStringTag,{value:"Module"})),B4=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return Na},build:Bx},Symbol.toStringTag,{value:"Module"})),q4=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:Wx,ColorizerStretchUniforms:jx,ColorizerUniforms:Ap,build:Qx},Symbol.toStringTag,{value:"Module"})),k4=Object.freeze(Object.defineProperty({__proto__:null,build:rC},Symbol.toStringTag,{value:"Module"})),j4=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:Ef,build:nC},Symbol.toStringTag,{value:"Module"})),W4=Object.freeze(Object.defineProperty({__proto__:null,build:oC},Symbol.toStringTag,{value:"Module"})),Q4=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:Of,build:lC},Symbol.toStringTag,{value:"Module"})),Y4=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:Rf,SimpleAtmospherePassParameters:$p,build:hC},Symbol.toStringTag,{value:"Module"})),Z4=Object.freeze(Object.defineProperty({__proto__:null,build:mC},Symbol.toStringTag,{value:"Module"})),X4=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:Df,build:yC},Symbol.toStringTag,{value:"Module"})),K4=Object.freeze(Object.defineProperty({__proto__:null,build:vC},Symbol.toStringTag,{value:"Module"})),J4=Object.freeze(Object.defineProperty({__proto__:null,build:bC},Symbol.toStringTag,{value:"Module"})),eV=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:If,build:wC},Symbol.toStringTag,{value:"Module"})),tV=Object.freeze(Object.defineProperty({__proto__:null,build:xC},Symbol.toStringTag,{value:"Module"})),iV=Object.freeze(Object.defineProperty({__proto__:null,build:CC},Symbol.toStringTag,{value:"Module"})),sV=Object.freeze(Object.defineProperty({__proto__:null,build:TC},Symbol.toStringTag,{value:"Module"})),rV=Object.freeze(Object.defineProperty({__proto__:null,build:SC},Symbol.toStringTag,{value:"Module"})),aV=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:Lf,build:EC},Symbol.toStringTag,{value:"Module"})),nV=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:Nf,build:DC},Symbol.toStringTag,{value:"Module"})),oV=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:Vf,build:NC},Symbol.toStringTag,{value:"Module"})),lV=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:Hc,build:LC},Symbol.toStringTag,{value:"Module"}));export{kr as A,Qk as F,Vs as G,a$ as I,yu as N,PN as a,Pq as b,Rw as c,CM as d,xG as e,o0 as f,gC as g,WG as h,NH as i,Gv as j,ei as k,LH as l,qH as m,Wk as n,Tc as o,Yk as p,UN as r,Cq as s,q$ as t,Sn as u,Ap as v};
