const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./deleteForwardEdits-DvZiU-zD.js","./assets-C43MgM-v.js","./subclass-BZA_h8Db.js","./index-Bh2oEzTI.js","./index-2kwcjS9-.css","./tslib.es6-B3Jf3DVX.js","./Accessor-BLX9ikPh.js","./utils-6jMaHUrH.js","./DeleteForwardEditsParameters-CCrE6Z2I.js"])))=>i.map(i=>d[i]);
import{r as j}from"./tslib.es6-B3Jf3DVX.js";import{o as S}from"./Evented-BHRw9x22.js";import{m as R,a as T,g as p}from"./subclass-BZA_h8Db.js";import{L as k}from"./Accessor-BLX9ikPh.js";import{_ as $}from"./index-Bh2oEzTI.js";import{U as x}from"./assets-C43MgM-v.js";import{o as D}from"./uuid-fwrPAdZb.js";const P=D(),A=new Map,U=new Map,Q=new Map;async function X(e,r,n){if(!e||!n)return!1;if(!r)return!0;const i=new URL(e).host;let t=A.get(i);if(!t){const s=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");t=(await x(s,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return t===r}async function Y(e,r,n=!1){var s,d,a;if(!e||!r)return!0;const i=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),t=(s=U.get(i))==null?void 0:s.entries();if(t){for(const[m,l]of t)if(l.name===r){const u=!((d=l.stack)!=null&&d.hasForwardEdits());if(!u&&n){const[{deleteForwardEdits:h},{default:I}]=await Promise.all([$(()=>import("./deleteForwardEdits-DvZiU-zD.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url),$(()=>import("./DeleteForwardEditsParameters-CCrE6Z2I.js"),__vite__mapDeps([8,5,1,2,3,4,6]),import.meta.url)]),b=await h(i,m,new I({sessionId:P,moment:l.moment}));return b.success&&((a=l.stack)==null||a.clearForwardEdits()),b.success}return u}}return!0}function O(e,r){var t;if(!e)return!1;const n=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),i=(t=U.get(n))==null?void 0:t.entries();if(i){for(const[s,d]of i)if(d.name===r)return d.lockType==="edit"}return!1}const g=new S.EventEmitter;function W(e){return g.on("apply-edits",new WeakRef(e))}function q(e){return g.on("update-moment",new WeakRef(e))}function Z(e,r,n=null,i=!1){const t=k();return i=r==null||i,g.emit("apply-edits",{serviceUrl:e,layerId:r,gdbVersion:n,mayReceiveServiceEdits:i,result:t.promise}),t}function ee(e,r,n=null,i){g.emit("update-moment",{serviceUrl:e,layerId:r,gdbVersion:n,moment:i})}const H=Symbol();function te(e){return e!=null&&typeof e=="object"&&H in e}function f(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function y(e,r,n){const i=new URL(e).host,t=A.get(i),s=d=>!d||d===t;return s(r)&&s(n)||r===n}const ie=e=>{var r;let n=class extends e{constructor(...i){super(...i),this[r]=!0,this._applyEditsHandler=t=>{const{serviceUrl:s,layerId:d,gdbVersion:a,mayReceiveServiceEdits:m,result:l}=t,u=s===this.url,h=d!=null&&this.layerId!=null&&d===this.layerId,I=f(this),b=f(this)&&y(s,a,this.gdbVersion);if(!u||I&&!b||!h&&!m)return;const L=l.then(o=>{var _;if(this.lastEditsEventDate=new Date,h&&(o.addedFeatures.length||o.updatedFeatures.length||o.deletedFeatures.length||o.addedAttachments.length||o.updatedAttachments.length||o.deletedAttachments.length))return this.emit("edits",p(o)),o;const v=(_=o.editedFeatures)==null?void 0:_.find(({layerId:F})=>F===this.layerId);if(v){const{adds:F,updates:E,deletes:w}=v.editedFeatures,V={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:F?F.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],deletedFeatures:w?w.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],updatedFeatures:E?E.map(({current:{attributes:c}})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],editedFeatures:p(o.editedFeatures),exceededTransferLimit:!1,historicMoment:p(o.historicMoment)};return this.emit("edits",V),V}const M={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:p(o.editedFeatures),exceededTransferLimit:!1,historicMoment:p(o.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(s,a,M.historicMoment)&&this.emit("edits",M),M}).then(o=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(s,a,o.historicMoment)&&(this.historicMoment=o.historicMoment),o));this.emit("apply-edits",{result:L})},this._updateMomentHandler=t=>{const{serviceUrl:s,gdbVersion:d,moment:a}=t,m=s===this.url,l=f(this),u=f(this)&&y(s,d,this.gdbVersion),h=f(this)&&!y(s,this.gdbVersion,null);m&&l&&u&&h&&"historicMoment"in this&&this.historicMoment!==a&&(this.historicMoment=a)},this.when().then(()=>{this.addHandles(W(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(q(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(i,t,s){return"historicMoment"in this&&this.historicMoment!==s&&O(i,t)}};return r=H,j([R()],n.prototype,"lastEditsEventDate",void 0),n=j([T("esri.layers.mixins.EditBusLayer")],n),n};export{ie as F,O as a,Q as b,Z as c,y as g,q as h,Y as i,W as l,A as n,X as o,te as p,U as s,P as t,ee as u};
