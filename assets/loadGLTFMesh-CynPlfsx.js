import{l as B}from"./Color-BCS62Hs5.js";import{U as L}from"./assets-C43MgM-v.js";import{b as P,r as O}from"./subclass-BZA_h8Db.js";import{A as C,M as D}from"./mathUtils-C4_ghTv4.js";import{j as U,n as z}from"./mat3-BRl2i9Bz.js";import{e as S}from"./mat3f64-BBpwCtoL.js";import{r as G}from"./vec3f64-BLpZdpfb.js";import{r as N}from"./vec4f64-o2zAXfmz.js";import{w as q,m as K,f as Q,c as V}from"./MeshComponent-C3VFvn4B.js";import{p as k}from"./MeshVertexAttributes-BgxxMxrG.js";import{s as E}from"./meshVertexSpaceUtils-CXzOFlTI.js";import{c as F,x as I,L as H,O as M,i as j,E as J,T as W,u as X}from"./BufferView-_QDXRCew.js";import{t as Y,r as Z,u as tt,n as R}from"./vec3-kbEkneOB.js";import{f as rt,o as et,u as A}from"./vec4-BpYqBTK4.js";import{e as ot}from"./InterleavedLayout-e-di2fxs.js";import{loadGLTF as nt}from"./loader-Ca9EgBla.js";import{a as it,f as h,b as st,l as at,e as mt,o as lt}from"./DefaultMaterial_COLOR_GAMMA-DmJDQQRt.js";import{n as pt,f as ut,e as ft}from"./vec33-DUxPafiq.js";import{B as ct}from"./vertexSpaceConversion-CPh5QK5U.js";import{r as dt}from"./resourceUtils-B0XGoEvl.js";import{D as w}from"./enums-D9v74xTE.js";import"./colorUtils-0bJDPow9.js";import"./index-Bh2oEzTI.js";import"./tslib.es6-B3Jf3DVX.js";import"./Accessor-BLX9ikPh.js";import"./common-DQOJ18NT.js";import"./cast-Bjksrh93.js";import"./imageUtils-CtmzXUTE.js";import"./writer-DNAwXnhG.js";import"./persistableUrlUtils-fa1mAujs.js";import"./Clonable-D3rtuBWg.js";import"./meshProperties-C4iW0Ukm.js";import"./vec32-Dvg_eL9J.js";import"./Point-Cg0-ChZE.js";import"./jsonMap-0cxwUWs2.js";import"./MeshLocalVertexSpace-LEHwMUnu.js";import"./enumeration-Ba5njXdz.js";import"./vec2-maR1OrZI.js";import"./vec42-YcqnINSP.js";import"./Util-BIfApRF5.js";import"./vec2f64-miziP1SN.js";import"./mat4f64-Dk4dwAN8.js";import"./Version-BSlAgupz.js";import"./mat4-GpOFENPA.js";import"./quat-4pa1e6ds.js";import"./quatf64-CCm9z-pX.js";import"./Indices-DflDlU4Z.js";import"./asyncUtils-CWX51uTe.js";import"./NestedMap-GuqgquCN.js";import"./aaBoundingBox-BE7cC1jD.js";import"./Extent-Bf3YTe7m.js";import"./Polyline-D9YkgmM_.js";import"./requestImageUtils-DgMiQwsm.js";import"./orientedBoundingBox-DOAJUK5g.js";import"./spatialReferenceEllipsoidUtils-DBE_OFra.js";import"./computeTranslationToOriginAndRotation-Q27G6TBL.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";import"./plane-IENfwZlB.js";import"./mathUtils-BG-eq9fO.js";import"./ViewingMode-Dodu7ZZk.js";import"./renderState-DQLu6AJX.js";import"./Texture-Fac_8AOC.js";import"./interfaces-DDtDqZYj.js";import"./VertexAttribute-Cq4MnHjR.js";import"./BindType-BmZEZMMh.js";import"./Material-_xx7OZxD.js";import"./boundedPlane-EV1sS2Ke.js";import"./sphere-C77djCO6.js";import"./lineSegment-D7sKPPYf.js";import"./Texture-Begq2x5n.js";import"./reactiveUtils-C5zUhJQJ.js";import"./Collection-CEdjem1-.js";import"./Evented-BHRw9x22.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./Matrix3DrawUniform-CiBFaSz6.js";import"./compilerUtils-Dw3R0f-Z.js";import"./lengthUtils-DL1-FDQQ.js";import"./ShaderTechniqueConfiguration-CBbn2DCi.js";import"./triangle-PTGDC_xJ.js";import"./AlphaCutoff-UcccL64p.js";import"./DefaultMaterial-DgOvtNL9.js";import"./VertexColor.glsl-_ARMpsAT.js";import"./verticalOffsetUtils-BDQLpfho.js";import"./doublePrecisionUtils-B0owpBza.js";import"./DecodeSymbolColor.glsl-BPIX0fAF.js";import"./projectPointToVector-GINIbYMz.js";import"./projection-B971H0Re.js";function xt(t,e,r){const l=t.typedBuffer,n=t.typedBufferStride,s=e.typedBuffer,p=e.typedBufferStride,m=r?r.count:e.count;let i=((r==null?void 0:r.dstIndex)??0)*n,f=((r==null?void 0:r.srcIndex)??0)*p;for(let a=0;a<m;++a){for(let o=0;o<9;++o)l[i+o]=s[f+o];i+=n,f+=p}}Object.freeze(Object.defineProperty({__proto__:null,copy:xt},Symbol.toStringTag,{value:"Module"}));function gt(t,e,r){const l=t.typedBuffer,n=t.typedBufferStride,s=e.typedBuffer,p=e.typedBufferStride,m=r?r.count:e.count;let i=((r==null?void 0:r.dstIndex)??0)*n,f=((r==null?void 0:r.srcIndex)??0)*p;for(let a=0;a<m;++a){for(let o=0;o<16;++o)l[i+o]=s[f+o];i+=n,f+=p}}Object.freeze(Object.defineProperty({__proto__:null,copy:gt},Symbol.toStringTag,{value:"Module"}));function $(t,e){return new t(new ArrayBuffer(e*t.ElementCount*ot(t.ElementType)))}async function le(t,e,r){const l=new pt($t(r)),n=(await nt(l,e,r,!0)).model,s=n.lods.shift(),p=new Map,m=new Map;n.textures.forEach((g,T)=>p.set(T,ht(g))),n.materials.forEach((g,T)=>m.set(T,wt(g,p)));const i=Tt(s);for(const g of i.parts)bt(i,g,m);const{position:f,normal:a,tangent:o,color:u,texCoord0:c}=i.vertexAttributes,d=E(t,r),b=t.spatialReference.isGeographic?E(t):d,v=ct({vertexAttributes:{position:f.typedBuffer,normal:a==null?void 0:a.typedBuffer,tangent:o==null?void 0:o.typedBuffer},vertexSpace:b,spatialReference:t.spatialReference},d,{allowBufferReuse:!0,sourceUnit:r!=null&&r.unitConversionDisabled?void 0:"meters"});if(!v)throw new P("load-gltf-mesh:vertex-space-projection",`Failed to load mesh from glTF because we could not convert the vertex space from ${b.type} to ${d.type}`);return{transform:null,vertexSpace:d,components:i.components,spatialReference:t.spatialReference,vertexAttributes:new k({...v,color:u==null?void 0:u.typedBuffer,uv:c==null?void 0:c.typedBuffer})}}function $t(t){const e=t==null?void 0:t.resolveFile;return e?{busy:!1,request:async(r,l,n)=>{const s=(e==null?void 0:e(r))??r;return(await L(s,{responseType:l==="image"?"image":l==="binary"||l==="image+type"?"array-buffer":"json",signal:n==null?void 0:n.signal,timeout:0})).data}}:null}function y(t,e){if(t==null)return"-";const r=t.typedBuffer;return`${O(e,r.buffer,()=>e.size)}/${r.byteOffset}/${r.byteLength}`}function yt(t){return t!=null?t.toString():"-"}function Tt(t){let e=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1},l=new Map,n=new Map,s=[];for(const p of t.parts){const{attributes:{position:m,normal:i,color:f,tangent:a,texCoord0:o}}=p,u=`
      ${y(m,l)}/
      ${y(i,l)}/
      ${y(f,l)}/
      ${y(a,l)}/
      ${y(o,l)}/
      ${yt(p.transform)}
    `;let c=!1;const d=O(n,u,()=>(c=!0,{start:e,length:m.count}));c&&(e+=m.count),i&&(r.normal=!0),f&&(r.color=!0),a&&(r.tangent=!0),o&&(r.texCoord0=!0),s.push({gltf:p,writeVertices:c,region:d})}return{vertexAttributes:{position:$(W,e),normal:r.normal?$(j,e):null,tangent:r.tangent?$(F,e):null,color:r.color?$(I,e):null,texCoord0:r.texCoord0?$(X,e):null},parts:s,components:[]}}function ht(t){return new q({data:(dt(t.data),t.data),wrap:Ct(t.parameters.wrap)})}function wt(t,e){const r=new B(St(t.color,t.opacity)),l=t.emissiveFactor?new B(Et(t.emissiveFactor)):null,n=s=>s?new V({scale:s.scale?[s.scale[0],s.scale[1]]:[1,1],rotation:D(s.rotation??0),offset:s.offset?[s.offset[0],s.offset[1]]:[0,0]}):null;return new K({color:r,colorTexture:e.get(t.textureColor),normalTexture:e.get(t.textureNormal),emissiveColor:l,emissiveTexture:e.get(t.textureEmissive),occlusionTexture:e.get(t.textureOcclusion),alphaMode:Bt(t.alphaMode),alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,metallic:t.metallicFactor,roughness:t.roughnessFactor,metallicRoughnessTexture:e.get(t.textureMetallicRoughness),colorTextureTransform:n(t.colorTextureTransform),normalTextureTransform:n(t.normalTextureTransform),occlusionTextureTransform:n(t.occlusionTextureTransform),emissiveTextureTransform:n(t.emissiveTextureTransform),metallicRoughnessTextureTransform:n(t.metallicRoughnessTextureTransform)})}function bt(t,e,r){e.writeVertices&&vt(t,e);const{indices:l,attributes:n,primitiveType:s,material:p}=e.gltf;let m=it(l||n.position.count,s);const i=e.region.start;if(i){const f=new Uint32Array(m);for(let a=0;a<m.length;a++)f[a]+=i;m=f}t.components.push(new Q({name:e.gltf.name,faces:m,material:r.get(p),shading:n.normal?"source":"flat",trustSourceNormals:!0}))}function vt(t,e){const{position:r,normal:l,tangent:n,color:s,texCoord0:p}=t.vertexAttributes,m=e.region.start,{attributes:i,transform:f}=e.gltf,a=i.position.count;if(Y(r.slice(m,a),i.position,f),i.normal!=null&&l!=null){const o=U(S(),f),u=l.slice(m,a);Z(u,i.normal,o),C(o)&&tt(u,u)}else l!=null&&ut(l,0,0,1,{dstIndex:m,count:a});if(i.tangent!=null&&n!=null){const o=z(S(),f),u=n.slice(m,a);rt(u,i.tangent,o),C(o)&&et(u,u)}else n!=null&&h(n,0,0,1,1,{dstIndex:m,count:a});if(i.texCoord0!=null&&p!=null?st(p.slice(m,a),i.texCoord0):p!=null&&at(p,0,0,{dstIndex:m,count:a}),i.color!=null&&s!=null){const o=i.color,u=s.slice(m,a);if(o.elementCount===4)o instanceof F?A(u,o,255):o instanceof I?mt(u,o):o instanceof H&&A(u,o,1/256);else{h(u,255,255,255,255);const c=M.fromTypedArray(u.typedBuffer,u.typedBufferStride);o instanceof j?R(c,o,255):o instanceof M?ft(c,o):o instanceof J&&R(c,o,1/256)}}else s!=null&&h(s.slice(m,a),255,255,255,255)}function Bt(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function Ct(t){return{horizontal:_(t.s),vertical:_(t.t)}}function _(t){switch(t){case w.CLAMP_TO_EDGE:return"clamp";case w.MIRRORED_REPEAT:return"mirror";case w.REPEAT:return"repeat"}}function x(t){return t**(1/lt)*255}function St(t,e){return N(x(t[0]),x(t[1]),x(t[2]),e)}function Et(t){return G(x(t[0]),x(t[1]),x(t[2]))}export{le as loadGLTFMesh};
