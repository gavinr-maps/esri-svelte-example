import{r as p,m,a as G,g as K,aA as ot,B as ee,aV as ie,j as Lt,N as Dt,bJ as Mt,e as ne,l as He,bo as Re,i as Gt}from"./Accessor-BHnuXKD2.js";import{V as ze,g as gt,d as v,A,P as tt,C as wt,p as Tt}from"./reactiveUtils-BR0C1Kq4.js";import{s as ke}from"./AnalysisView3D-DKkik0jJ.js";import{t as _,r as Ee,u as Ve}from"./LengthDimension-CYiTgx6b.js";import{ay as Le,az as Ge,x as Ie,j as F}from"./Point-XGrwlf63.js";import{e as Ue}from"./getDefaultUnitForView-CuRQcAm0.js";import{s as It,M as je}from"./mathUtils-DV9iOXpW.js";import{s as oe}from"./quantityUtils-1LswOhxZ.js";import{p as Ut,o as Fe,f as ae,q as Be}from"./mat4-Fi6iAz29.js";import{e as At}from"./mat4f64-Dk4dwAN8.js";import{s as T,E as jt,R as k,_ as j,P as V,J as se,A as Ne,q as pt,X as Ft,j as Pt,g as at,c as re,H as le,r as pe,o as de}from"./vec32-Dvg_eL9J.js";import{n as P,_ as J,r as dt}from"./vec3f64-BLpZdpfb.js";import{n as qe}from"./Polyline-BmuD2-ZN.js";import{c as f,l as Ct,M as bt,V as Bt,O as We}from"./plane-4dpuo6-e.js";import{e as Je}from"./projectVectorToVector-dS8io47t.js";import{x as Q}from"./hydratedFeatures-BVVSs98j.js";import{f as B,a as Ke}from"./Segment-Cz-DWVE8.js";import{m as Xe}from"./automaticLengthMeasurementUtils-B8fQn4oI.js";import{x as Ye,m as Qe}from"./euclideanLengthMeasurementUtils-EupqVlJl.js";import{p as me}from"./geodesicMeasurementUtils-ChQtpZ42.js";import{h as N}from"./Color-gncXBiLc.js";import{a as $t}from"./Cyclical-CPiNl4ru.js";import{u as x}from"./screenUtils-_ZIvrt5o.js";import{n as Ze,s as X}from"./vec4f64-o2zAXfmz.js";import{P as ti,E as ei}from"./colorUtils-BAowQmkN.js";import{e as _t,f as ii,a as H,b as ce,w as ni,O as xt,j as rt}from"./RenderObject-8TEkyAoe.js";import{B as oi,C as ue,z as Ht}from"./dragEventPipeline3D-m6RYCQo0.js";import{p as ai,W as q,b as si}from"./RibbonLine.glsl-D3IEIaDR.js";import{t as Nt}from"./Attribute-B-NAci_J.js";import{f as ri}from"./FloatArray-BCfeX8wo.js";import{o as li,w as et}from"./GeometryUtil-vHI0hYMT.js";import{p as O}from"./Material-Ba8x5bbY.js";import{e as qt}from"./VertexAttribute-Cq4MnHjR.js";import{I as he}from"./ImageMaterial.glsl-DS2HLuOB.js";import{p as st,h as Rt,w as pi}from"./dragEventPipeline-D_Ldto1o.js";import{u as fe,t as z}from"./interfaces-D6pIddIh.js";import{t as di}from"./memoize-DsJmrG76.js";import{h as mi}from"./UpdatingHandles-ptqz1ck8.js";import{l as ci}from"./Factory-Dp0C9G0y.js";import{R as ui}from"./SnappingVisualizer3D-DDfmr2ew.js";import{d as I,r as hi,t as fi}from"./LineVisualElement-B4fIKpim.js";import{d as gi}from"./VerticesVisualElement-BdDIOLJe.js";import{h as mt}from"./lineStippleUtils-C89mzWlO.js";import{E as _i,p as vi,P as yi}from"./EditGeometryOperations-C5kkQVhH.js";import{e as Si}from"./SnappingContext-lR2hMWGP.js";import{f as Mi}from"./SnappingDragPipelineStep-C7nIAEz_.js";import{a as wi}from"./SnappingManagerPool-DzCRDPdL.js";import{p as Pi}from"./SnappingOperation-DhUO_0vk.js";import{u as Ci}from"./RightAngleSnappingHint-CCcBBYgG.js";import{o as bi}from"./ShadedColorMaterial.glsl-BaXE-_67.js";import{p as Wt}from"./keybindings-DrKrBFID.js";import{t as $i}from"./ToolIntersector-A0WvzCEW.js";import{c as Oi}from"./screenUtils-DyhV4TAA.js";import{f as Di}from"./intl-Do3GEEJ7.js";import{g as Ti}from"./quantityFormatUtils-9VppKzbq.js";import{a as Ai,t as xi}from"./DefaultVertexAttributeLayouts-DMsCtEEh.js";import{a as Hi}from"./Object3DVisualElement-BtsT49h4.js";import{R as Ri,b as zi}from"./line-CTiLAMHp.js";import{S as ge}from"./LineMarker.glsl-DDT-WuAq.js";import{h as ki}from"./Promise-CmQqe-ke.js";import{a as Ei,v as Vi,l as Li}from"./analysisViewUtils-VWx-Y-gy.js";import"./Evented-DCWccWGU.js";import"./SimpleObservable-7oieNGD8.js";import"./Clonable-DvJsj5LF.js";import"./JSONSupport-CGdeqxpk.js";import"./cast-BA_-jlhc.js";import"./index-tefRSezt.js";import"./writer-B2bQV2uU.js";import"./Portal-CTRRujjZ.js";import"./Extent-CBBGeHb-.js";import"./common-DQOJ18NT.js";import"./vec42-YcqnINSP.js";import"./mat3f64-BBpwCtoL.js";import"./quatf64-CCm9z-pX.js";import"./vec2f64-Dy6m9Nrb.js";import"./mathUtils-B9R7G-2c.js";import"./projectBuffer-DOU0xvVi.js";import"./geodesicConstants-yASAK_zX.js";import"./projectPointToVector-BS0u8fq6.js";import"./projection-B2I9Bzj_.js";import"./Graphic-CFXUQZlS.js";import"./opacityUtils-CSd4XoR2.js";import"./enumeration-Cr5WIZs4.js";import"./ActionToggle-__-l4AdQ.js";import"./Identifiable-BrT7zvUW.js";import"./jsonUtils-Cu7OBRmN.js";import"./typeUtils-BSg8Y507.js";import"./TextSymbol-BQ_NW9Xo.js";import"./collectionUtils-CbaToa73.js";import"./aaBoundingBox-CeBivBRq.js";import"./vec2-maR1OrZI.js";import"./viewUtils-Ce2x26K8.js";import"./elevationInfoUtils-RSZ4Logn.js";import"./unitConversionUtils-C4AR5obr.js";import"./lengthUtils-DjJgJFRg.js";import"./VisualElement-D3eR6o-M.js";import"./jsxFactory-CLjKarlq.js";import"./uuid-Cl5lrJ4c.js";import"./TextOverlayItem-D-lNDrXB.js";import"./spatialReferenceEllipsoidUtils-DM073JUd.js";import"./geodesicLengthMeasurementUtils-C8eO8ivV.js";import"./geometryEngine-CtEcpiHE.js";import"./geometryEngineBase-yFIvKOkM.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./hydrated-Dw-Mfo_Y.js";import"./geodesicUtils-Bh_GX0Qj.js";import"./colorUtils-Rxh2V3ai.js";import"./mat3-CR8GKnhD.js";import"./computeTranslationToOriginAndRotation-BT43Xu5d.js";import"./lineSegment-C-CDF7QX.js";import"./sphere-DQxj5tsv.js";import"./ElevationProvider-aS5xrHHy.js";import"./dehydratedFeatureUtils-1rrRm6hF.js";import"./ray-D3Okb4cY.js";import"./RenderCamera-BovI3JTe.js";import"./Octree-B-jwmuW2.js";import"./InterleavedLayout-Dvj-Snan.js";import"./BufferView-_QDXRCew.js";import"./types-D0PSWh4d.js";import"./ViewingMode-Dodu7ZZk.js";import"./graphicUtils-Daa6cjYT.js";import"./meshVertexSpaceUtils-SW0WEjNN.js";import"./MeshLocalVertexSpace-C0YDTRex.js";import"./basicInterfaces-CZwQPxTp.js";import"./ColorMaterial.glsl-CArPvmMs.js";import"./Matrix3PassUniform-Bhi2fM3C.js";import"./BindType-BBwFZqyN.js";import"./DefaultBufferWriter-D4XUxbP-.js";import"./TriangleMaterial-t01j2IAH.js";import"./enums-D9v74xTE.js";import"./renderState-e7QeQoUO.js";import"./ShaderTechniqueConfiguration-YrUOztAU.js";import"./NoParameters-t-PuNrgq.js";import"./glsl-BH37Aalp.js";import"./ShaderBuilder-DV1s2efh.js";import"./VertexColor.glsl-C67vI27I.js";import"./Matrix3DrawUniform-B_gSHO7v.js";import"./Matrix4PassUniform-LFIUaE9i.js";import"./Intersector-DqUGp7Vs.js";import"./intersectorUtils-l6zkk4nF.js";import"./boundedPlane-Dyz2ub5d.js";import"./verticalOffsetUtils-CUH6QZ7-.js";import"./orientedBoundingBox-9z4w3ZAL.js";import"./quat-4pa1e6ds.js";import"./sdfPrimitives-B8Jbwvqs.js";import"./doublePrecisionUtils-B0owpBza.js";import"./floatRGBA-CR2j2c7-.js";import"./Texture-D-SqNa4i.js";import"./signal-DSa0yokC.js";import"./getDataTypeBytes-BTGR5GyG.js";import"./RgbaFloatEncoding.glsl-_io2eW3M.js";import"./Indices-Db9lERgy.js";import"./triangle-D_E6eTS3.js";import"./requestImageUtils-Brn0e8z8.js";import"./TextureFormat-1mYWTFa-.js";import"./vec3f32-nZdmKIgz.js";import"./GLTextureMaterial-BXvkeRxQ.js";import"./DefaultLayouts-RacFqL-X.js";import"./ExtendedLineVisualElement-D93_23WS.js";import"./EngineVisualElement-B_1wMpLc.js";import"./GridLocalOriginFactory-BvhZ_UoU.js";import"./OverlayCompositing.glsl-BbJKjUZQ.js";import"./SceneLighting-fZH2UQ_L.js";import"./axisAngleDegrees-8Sw4vC28.js";import"./weather-DtiKeY2t.js";import"./BooleanBindUniform-xvVHJCDz.js";import"./Float4DrawUniform-C_Hqa-pI.js";import"./RenderPlugin-B2sz29jJ.js";import"./HighlightDefaults-ESbuT2uR.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./VertexArrayObject-DcVjXzZo.js";import"./BufferObject-CIl3vJtA.js";import"./memoryEstimations-5gFNwkKK.js";import"./NestedMap-GuqgquCN.js";import"./HUDRenderStyle-BhGvVxgm.js";import"./Scheduler-B_GuBefw.js";import"./debugFlags-ZrDyTcDc.js";import"./LaserlineVisualElement-BPYPJd-Q.js";import"./Blit-D5AxBSxC.js";import"./glUtil-D0YUa0ow.js";import"./CameraSpace.glsl-BZ4Eapt3.js";import"./Float2PassUniform-Blij1ug3.js";import"./LaserlinePath.glsl-C1vDezzs.js";import"./ElevationContext-jcnAn7VT.js";import"./HUDMaterial-DRUv4rua.js";import"./HUDVisibility.glsl-DSeZY4v-.js";import"./VerticalOffset.glsl-0YVQE7vQ.js";import"./RightAngleQuadVisualElement-C-m5WG_E.js";import"./SnappingVisualizer-Cb3uuWOu.js";import"./PointSnappingHint-CurBFXPo.js";import"./geometry2dUtils-vtViF5g_.js";import"./dehydratedFeatureComparison-Bbl7iMhI.js";import"./SnappingManager-CF4NflXd.js";import"./timeUtils-D2X862bk.js";import"./Query-DCBIeen2.js";import"./Field-Cyk7Ur5d.js";import"./fieldType-L-VlbZqy.js";import"./FullTextSearch-BWm_kPUE.js";import"./TimeExtent-J5qnUFx_.js";import"./InputManager-Bs9UE-jw.js";import"./Queue-BOnccek2.js";import"./utils-D02V2_jH.js";import"./Version-9k2AOv05.js";import"./InteractiveToolBase-DNJTN0p5.js";import"./unitFormatUtils-Dbksq3U5.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./DisplayObject-S19ALweP.js";import"./TileKey-BtGhNUzq.js";const Gi=t=>{let e=class extends t{constructor(...i){super(...i),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new ze}createLengthDimensions(i){throw new Error("Method not implemented.")}};return p([m({constructOnly:!0})],e.prototype,"view",void 0),p([m({constructOnly:!0,nonNullable:!0})],e.prototype,"analysis",void 0),p([m()],e.prototype,"tool",void 0),p([m({readOnly:!0})],e.prototype,"results",null),p([m()],e.prototype,"selectedDimension",void 0),p([m()],e.prototype,"interactive",void 0),p([m()],e.prototype,"visible",void 0),e=p([G("esri.views.analysis.DimensionAnalysisView")],e),e};let Y=class extends K{constructor(t){super(t),this.dimension=null,this.length=null}};p([m({constructOnly:!0,nonNullable:!0})],Y.prototype,"dimension",void 0),p([m()],Y.prototype,"length",void 0),Y=p([G("esri.views.analysis.LengthDimensionResult")],Y);const Ii=Y;class Ui{constructor(e,i,n,o,a,s){this.elevationAlignedStartPoint=e,this.elevationAlignedEndPoint=i,this.directSegment=n,this.dimensionSegment=o,this.primaryOffsetAxis=a,this.spatialReference=s}}function ji(t,e,i){if(t==null)return null;let n;if(e===_.Horizontal)n=Xe(t.elevationAlignedStartPoint,t.elevationAlignedEndPoint);else{const{startRenderSpace:a,endRenderSpace:s}=t.dimensionSegment;n=Ye(a,s,t.spatialReference)}if(n==null)return null;const o=e===_.Vertical?Le(n.value,n.unit,i):Ge(n.value,n.unit,i);return oe(n,o)}function ct(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:o,orientation:a}}=t;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,offset:n,measureType:o,orientation:a}}function ut({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,offset:i,measureType:n,orientation:o},a,s=null){if(t==null||e==null)return null;const l=ve((s==null?void 0:s.directSegment)??new B,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e},a),r=(s==null?void 0:s.primaryOffsetAxis)??P();vt(r,{measureType:n,elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,directSegment:l,orientation:o,renderCoordsHelper:a});const d=(s==null?void 0:s.dimensionSegment)??new B;return zt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e})&&n===_.Vertical?(T(d.startRenderSpace,l.startRenderSpace),T(d.endRenderSpace,l.endRenderSpace)):ye(d,r,i,l,a),new Ui(t,e,l,d,r,a.spatialReference)}function Jt(t,e,i,n){return e===it.Start?(T(t.startRenderSpace,i.startRenderSpace),T(t.endRenderSpace,n.startRenderSpace)):(T(t.startRenderSpace,i.endRenderSpace),T(t.endRenderSpace,n.endRenderSpace)),t}var it;function Fi(t,e,i,n){pt(t.startRenderSpace,e.startRenderSpace,i,n),pt(t.endRenderSpace,e.endRenderSpace,i,n)}function _e(t,e,i,n){switch(e){case _.Direct:return ve(t,i,n);case _.Horizontal:case _.Vertical:{const{elevationAlignedStartPoint:o,elevationAlignedEndPoint:a,dimension:s,geometry:l}=i;let r;s.measureType===_.Direct?(r=Bi(l,n)===o.z>a.z,e===_.Horizontal&&(r=!r)):r=!Ni(l);const[d,c]=r?[o,a]:[a,o],h=Q(c,qi);return e===_.Horizontal?h.z=d.z:(h.x=d.x,h.y=d.y),n.toRenderCoords(d,t.startRenderSpace),n.toRenderCoords(h,t.endRenderSpace),t}}}function ve(t,e,i){return i.toRenderCoords(e.elevationAlignedStartPoint,t.startRenderSpace),i.toRenderCoords(e.elevationAlignedEndPoint,t.endRenderSpace),t}function Bi(t,e){const i=t.directSegment.eval(.5,f.get()),n=e.worldUpAtPosition(i,f.get()),o=t.dimensionSegment.eval(.5,f.get()),a=k(f.get(),o,i);return!se(a,J)&&V(a,n)>0}function Ni(t){const{startRenderSpace:e,endRenderSpace:i}=t.dimensionSegment,{startRenderSpace:n,endRenderSpace:o}=t.directSegment;return Ft(n,e)<Ft(o,i)}(function(t){t[t.Start=0]="Start",t[t.End=1]="End"})(it||(it={}));const qi=Je(0,0,0,null);function Wi(t,e,i,n){const{directSegment:o}=i,a=vt(f.get(),{measureType:e,directSegment:o,renderCoordsHelper:n}),s=ye(Ji,a,0,o,n).eval(.5,f.get()),l=k(f.get(),t,s);return V(l,a)*n.unitInMeters}const Ji=new B;function vt(t,e){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:o,directSegment:{startRenderSpace:a,endRenderSpace:s},directSegment:l,renderCoordsHelper:r}=e,d=l.eval(.5,f.get()),c=r.worldUpAtPosition(d,f.get()),h=r.worldBasisAtPosition(d,qe.Y,f.get());switch(i){case _.Horizontal:T(t,c);break;case _.Vertical:V(a,c)<V(s,c)?k(t,s,a):k(t,a,s),j(t,t,c),j(t,t,c);break;case _.Direct:{const u=e.orientation??0;if(zt({elevationAlignedStartPoint:n,elevationAlignedEndPoint:o}))Ut(lt,-It(u),c),jt(t,h,lt);else{const S=k(f.get(),s,a),g=j(f.get(),S,c);j(g,g,S),Ut(lt,It(u),S),jt(t,g,lt)}break}}return se(t,J)?T(t,h):Ne(t,t)}const lt=At();function zt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}){return t!=null&&e!=null&&t.x===e.x&&t.y===e.y}function ye(t,e,i,n,o){const{startRenderSpace:a,endRenderSpace:s}=n,l=i/o.unitInMeters,[r,d]=Ki(a,s,e,l);return pt(t.startRenderSpace,n.startRenderSpace,e,r),pt(t.endRenderSpace,n.endRenderSpace,e,d),t}function Ki(t,e,i,n=0){const o=V(e,i),a=V(t,i),s=Math.abs(o-a)+n;return o>a?[s,n]:[n,s]}function yt(t,e,i){const n=e.directSegment.eval(.5,f.get());return i.worldUpAtPosition(n,t)}function kt(t,e){const{startRenderSpace:i,endRenderSpace:n}=e.directSegment;return k(t,n,i)}function Et(t,e,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:o}=e.dimensionSegment;return i.invert?k(t,n,o):k(t,o,n)}function Ot(t,e){const i=t.directSegment.eval(.5,f.get());return e.headingAtPosition(i,t.primaryOffsetAxis)}function Xi(t,e){return Pt(Et(Yi,t))/e**2}const Yi=P();function Se(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i}=t;if(e==null||i==null)return!1;const n=Qe(e,i);return n!=null&&oe(n,"meters").value>me}function nt(t){return t.geometry!=null}let U=class extends K{constructor(e){super(e)}initialize(){const e=gt(()=>this.analysisViewData.computations,({computation:i})=>this._watchComputation(i));this.addHandles(ot(e))}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return Ue(this.view)}_watchComputation(e){return v(()=>ct(e),i=>{const{measureType:n}=i;if(Se(i)&&n!==_.Direct){const a=Math.round(Ie(me,"meters","kilometers"));return ee.getLogger(this).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${a} km. Update the measureType of the affected dimension to "direct" to display it.`),void(e.geometry=null)}const o=ut(i,this.view.renderCoordsHelper,e.geometry);e.geometry=o,e.result.length=ji(o,n,this._defaultUnit)},A)}};p([m({constructOnly:!0})],U.prototype,"analysisViewData",void 0),p([m({constructOnly:!0})],U.prototype,"view",void 0),p([m()],U.prototype,"analysis",null),p([m()],U.prototype,"_defaultUnit",null),U=p([G("esri.views.3d.analysis.Dimension.DimensionController")],U);function ht(t){return ti(t.accentColor,.5)}function Qi(t){return ei(t.accentColor)}const Me=5,Zi=new N([127,127,127,.5]),we=.8,tn=4,en=6,nn=.1,Pe=.5,on=18,an=2,sn=.3,rn=2,ln=.25,pn=20,dn=5,Kt=5,Xt=10,mn=2500,cn=50,un=2;class hn{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&e===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const i of Ee)e(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(e){switch(e){case _.Direct:return this.direct;case _.Horizontal:return this.horizontal;case _.Vertical:return this.vertical}}}class fn extends _t{constructor(e,i){const n=ii(N.toUnitRGBA(ht(e.effectiveTheme))),o=[new H(li(n,1,32,32),E)];super({view:e,renderObjects:o,metadata:i.metadata,available:!1,grabCursor:"crosshair",radius:Me,collisionPriority:1}),this._themeHandle=v(()=>({color:N.toUnitRGBA(ht(e.effectiveTheme))}),a=>n.setParameters(a))}destroy(){this._themeHandle.remove(),super.destroy()}}function gn(t,e){const i=[dt(-.5,0,0),dt(.5,0,0)],n=et(e.unfocusedMaterial,i.map(a=>at(P(),a,Pe))),o=n.instantiate({material:e.focusedMaterial});return new _t({view:t,renderObjects:[new H(n,z.Unfocused|z.Selected|E),new H(o,z.Focused|E)],collisionType:{type:"line",paths:[i]},radius:Vt(e.lineSizePt)/2,metadata:e.metadata,available:!1,...ce})}class Yt extends _t{constructor(e,{lineSizePt:i,material:n,metadata:o}){super({view:e,autoScaleRenderObjects:!1,collisionPriority:1,metadata:o}),this._options={calloutColor:Ze(),lineSizePt:i,material:n},this._themeHandle=v(()=>N.toUnitRGBA(ht(e.effectiveTheme)),a=>{this._options.calloutColor=a,Zt(this,Qt({...this._options,metadata:this.metadata}))},tt)}update({lineSizePt:e,material:i}){this._options.lineSizePt=e,this._options.material=i,Zt(this,Qt({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function Qt({calloutColor:t,lineSizePt:e,material:i,metadata:n}){return{calloutLength:.25*ai*we*x(e)+on,calloutColor:t,calloutWidth:an,customStateMask:E,discScale:sn,focusMultiplier:rn,material:i,metadata:n}}function _n(t,e){const i=[dt(-.5,0,0),dt(.5,0,0)],n=et(e.thinOffsetManipulatorMaterial,i),o=et(e.unfocusedMaterial,i.map(s=>at(P(),s,Pe))),a=o.instantiate({material:e.focusedMaterial});return new _t({view:t,renderObjects:[new H(o,z.Unfocused|E),new H(a,z.Focused|E),new H(n,E)],collisionType:{type:"line",paths:[i]},radius:Vt(e.lineSizePt)/2,available:!1,metadata:e.metadata,...ce})}function vn(t,{isStart:e,createSnappingPipelineStep:i,dimension:n,onUpdate:o,view:a}){const s=e?"startPoint":"endPoint";return[st(t,(r,d,c,h)=>{const u=Ht(r),{snappingStep:S,cancelSnapping:g}=i(h);c=c.next(u).next(Rt(n,[s,"measureType","orientation"])).next(g),d.next(u).next(oi(a)).next(...S).next(M=>{const y=Q(M.mapEnd,new F);o(s==="startPoint"?{startPoint:y}:{endPoint:y})})})]}function yn(t,{computation:e,view:i}){return[st(t,(n,o,a)=>{if(!nt(e)||!n.selected)return;const{geometry:s,dimension:l}=e,r=Ht(n);o.next(r).next(be(i,l,s.dimensionSegment,s.primaryOffsetAxis)),a.next(r).next(Rt(l,["offset"]))})]}function Sn(t,{computation:e,view:i}){return[st(t,(n,o,a)=>{Ce({cancel:a,computation:e,settingHeading:!0,steps:o,view:i})})]}function Mn(t,{computation:e,view:i}){return[st(t,(n,o,a)=>{Ce({cancel:a,computation:e,settingHeading:!1,steps:o,view:i})}),t.events.on("immediate-click",n=>{wn(n,e,i)})]}function wn(t,e,i){const{dimension:n,geometry:o}=e;if(n.orientation===90||n.orientation===270)return n.orientation=0,void t.stopPropagation();if(o==null)return;const{renderCoordsHelper:a}=i,s=ut({...ct(e),orientation:90},a),l=ut({...ct(e),orientation:270},a);if(s==null||l==null)return;const r=Ot(s,a),d=Ot(l,a),c=$e(o,i),h=$t.shortestSignedDiff(c,r),u=$t.shortestSignedDiff(c,d);n.orientation=Math.abs(h)<Math.abs(u)?90:270,t.stopPropagation()}function Ce(t){const{cancel:e,computation:i,settingHeading:n,steps:o,view:a}=t;if(!nt(i))return;const{renderCoordsHelper:s}=a,{dimension:l,geometry:r}=i,d=P(),c=De(P(),r,r.directSegment,s),h=Te(f.get(),{forHeading:n,geometry:r,renderCoordsHelper:s}),u=Ct(c,h,bt()),S=n?l.orientation??Ot(r,a.renderCoordsHelper):l.orientation??0;o.next(ue(a,u)).next(g=>{g.action==="start"&&T(d,g.renderStart);const M=We(u),y=ni(d,g.renderEnd,c,M);let L=S-je(y);n||(L=Pn(L)),l.orientation=L}),e.next(Rt(l,["orientation"]))}function Pn(t){const e=$t.normalize(t)%90;return e<Kt?t-e:90-e<Kt?t+(90-e):t}function Cn(t,{computation:e,manipulatorMeasureType:i,view:n}){let o=_.Direct,a=0,s=0;return[t.events.on("grab-changed",l=>{if(l.action!=="start"||!nt(e))return;const{dimension:r,geometry:d}=e;o=r.measureType,a=r.offset,s=r.orientation;const c=T(f.get(),t.renderLocation);r.measureType=i,r.offset=Wi(c,i,d,n.renderCoordsHelper),r.orientation=0}),st(t,(l,r,d)=>{if(!nt(e))return;const{geometry:c,dimension:h}=e,{renderCoordsHelper:u}=n,S=_e(Ae,i,e,u),g=vt(f.get(),{measureType:i,directSegment:c.directSegment,renderCoordsHelper:u}),M=Ht(l);r.next(M).next(be(n,h,S,g)),d.next(M).next(y=>(h.measureType=o,h.offset=a,h.orientation=s,y))})]}function be(t,e,i,n){const o=re(f.get(),i.endRenderSpace,i.startRenderSpace);j(o,o,n);const a=Ct(i.startRenderSpace,o,bt()),s=Ct(i.startRenderSpace,n,bt()),l=e.offset;let r,d=0;const c=new pi;return c.next(ue(t,a)).next(h=>{h.action==="start"&&(d=Bt(s,h.renderStart));const u=(Bt(s,h.renderEnd)-d)*t.renderCoordsHelper.unitInMeters;e.offset=l+u,r=h}),h=>(c.execute(h),r)}function $e(t,e){const{directSegment:i}=t,{renderCoordsHelper:n}=e,o=yt(f.get(),t,n),a=kt(f.get(),t),s=j(f.get(),a,o),{viewForward:l}=e.state.camera;V(s,l)>0&&at(s,s,-1);const r=i.eval(.5,f.get());return n.headingAtPosition(r,s)}function bn(t,e,i){const{dimensionSegment:n,primaryOffsetAxis:o}=e,a=Et(Z,e),s=le(a,J)?Fe(ft):xt(a,o,J,ft),l=Math.max(pe(a),nn/i.unitInMeters);ae(s,s,de(Z,l,l,l)),t.modelTransform=s,t.renderLocation=n.eval(.5,Z)}function $n(t,e,i){Oe(t,e,i,{forHeading:!0})}function On(t,e,i){Oe(t,e,i,{forHeading:!1})}function Oe(t,e,i,{forHeading:n}){const{dimension:o,geometry:a}=e,{primaryOffsetAxis:s}=a,l=at(Dn,s,o.offset>=0?1:-1),r=Te(Tn,{forHeading:n,geometry:a,renderCoordsHelper:i});j(r,r,l);const d=xt(l,r,J,ft);t.modelTransform=d,t.renderLocation=De(Z,a,a.dimensionSegment,i)}const Dn=P(),Tn=P();function An(t,e,i,n){const{geometry:o}=e,a=_e(Ae,i,e,n),s=vt(Z,{measureType:i,directSegment:o.directSegment,renderCoordsHelper:n}),l=k(St,a.endRenderSpace,a.startRenderSpace),r=xt(l,s,J,ft),d=pe(l);ae(r,r,de(St,d,d,d)),t.modelTransform=r,t.renderLocation=a.eval(.5,St)}function De(t,e,i,n){const{startRenderSpace:o,endRenderSpace:a}=i,s=xn(e,n)?o:a;return T(t,s)}function Te(t,{forHeading:e,geometry:i,renderCoordsHelper:n}){return e?yt(t,i,n):Et(t,i,{invert:!0})}function xn(t,e){const i=kt(Hn,t),n=yt(Rn,t,e);return V(i,n)>0}const Hn=P(),Rn=P();function zn(t){return x(t)+tn}function Vt(t){return x(t)+en}function Zt(t,e){var S;const i=e.material??new he({writeDepth:!1,textureId:(S=e.texture)==null?void 0:S.id,renderOccluded:O.Opaque,isDecoration:!0}),n=e.focusMultiplier??rt.focusMultiplier,o=e.calloutLength??rt.calloutLength,a=rt.discRadius*(e.discScale??1),s=a*n,l=(g,M)=>{const y=[0,1,2,2,3,0];return new ri(M,[[qt.POSITION,new Nt([o-g,-g,0,o+g,-g,0,o+g,g,0,o-g,g,0],y,3,!0)],[qt.UV0,new Nt([0,0,1,0,1,1,0,1],y,2,!0)]])},r=e.calloutWidth??rt.calloutWidth,d=new q({width:r,color:e.calloutColor,renderOccluded:O.OccludeAndTransparent,isDecoration:!0}),c=et(d,[[0,0,0],[o-a,0,0]]),h=et(d,[[0,0,0],[o-s,0,0]]),u=e.customStateMask??fe.None;t.collisionType={type:"disc",direction:[0,0,1],offset:[o,0,0]},t.focusMultiplier=n,t.metadata=e.metadata,t.radius=a,t.renderObjects=[new H(l(a,i),z.Unfocused|u),new H(c,z.Unfocused|u),new H(l(s,i),z.Focused|u),new H(h,z.Focused|u)]}const E=fe.Custom1,Z=P(),St=P(),ft=At(),Ae=new B;var D;function kn(t,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,geometry:t.geometry}}function En(t,e){if(Se(t))return D.Direct;if(!t.enabled)return null;const{geometry:i}=t;if(i==null||le(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{camera:n}=e.state,o=yt(f.get(),i,e.renderCoordsHelper),a=kt(f.get(),i),s=at(f.get(),o,V(a,o)),l=re(f.get(),a,s),r=Pt(l),d=Pt(s),{startRenderSpace:c,endRenderSpace:h}=i.directSegment,u=Math.max(n.computeScreenPixelSizeAt(c)*Xt,n.computeScreenPixelSizeAt(h)*Xt)**2;return r<u?D.Vertical:d<u?D.Horizontal:null}function Vn(t,e,{constraint:i,view:n}){const{unconstrainedGeometry:o}=t;if(o==null)return;const{renderCoordsHelper:a,spatialReference:s}=n,{startRenderSpace:l,endRenderSpace:r}=o.directSegment,d=a.fromRenderCoords(l,new F({spatialReference:s})),c=a.fromRenderCoords(r,new F({spatialReference:s}));let h;h=e==="start"?{startPoint:d}:{endPoint:c},xe(t,h,{constraint:i,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,unconstrainedGeometry:o,view:n})}function xe(t,e,i){const{constraint:n,elevationAlignedStartPoint:o,elevationAlignedEndPoint:a,unconstrainedGeometry:s,view:l}=i,{dimension:r,previousConstraint:d,preConstraintProperties:c}=t;if(o==null||a==null)return;const h=()=>{"startPoint"in e?r.startPoint=e.startPoint:"endPoint"in e&&(r.endPoint=e.endPoint)};if(n==null)h(),d!=null&&c!=null&&(r.measureType=c.measureType,r.orientation=c.orientation);else switch(r.measureType=_.Direct,n){case D.Horizontal:if(n!==d&&(r.orientation=0),"startPoint"in e){const u=e.startPoint;u!=null&&(u.z=a.z),r.startPoint=u}else if("endPoint"in e){const u=e.endPoint;u!=null&&(u.z=o.z),r.endPoint=u}break;case D.Vertical:if(n!==d&&(r.orientation=$e(s,l)),"startPoint"in e){const u=e.startPoint;u!=null&&(u.x=a.x,u.y=a.y),r.startPoint=u}else if("endPoint"in e){const u=e.endPoint;u!=null&&(u.x=o.x,u.y=o.y),r.endPoint=u}break;case D.Direct:n!==d&&c!=null&&(r.orientation=c.orientation),h()}t.previousConstraint=n,t.unconstrainedGeometry=s}(function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Direct=2]="Direct"})(D||(D={}));let w=class extends K{constructor(t){super(t),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new ie,this._orientationManipulatorTexture=null,this._updatingHandles=new mi,this._getSnappingContext=di(n=>new Si({elevationInfo:{mode:"absolute-height",offset:0},pointer:n,editGeometryOperations:new _i(new vi("point",yi(!0,!1,this.view.spatialReference)),this.view.state.viewingMode),visualizer:new ui}));const{view:e}=t;this._snappingManagerResult=wi(e),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:mt(2)}),this._constraintSnappingIndicator=new I({view:e,attached:!0,width:1,renderOccluded:O.OccludeAndTransparent,stipplePattern:mt(5),isDecoration:!0});const i=N.toUnitRGBA(Zi);this._stagedStartIndicator=new gi({view:e,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,color:i,size:2*Me,outlineSize:0,renderOccluded:O.OccludeAndTransparent,isDecoration:!0})}initialize(){var n;const{view:t}=this;this._snappingOperation=new Pi({view:t});const e=!((n=t._stage)!=null&&n.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result);this._orientationManipulatorMaterial=new he({writeDepth:!1,renderOccluded:O.Opaque,isDecoration:!0}),this.addHandles(v(()=>({accentColor:ht(t.effectiveTheme),contrastColor:Qi(t.effectiveTheme)}),({accentColor:o,contrastColor:a})=>{const s=this._orientationManipulatorTexture,l=ci(t.textures,{accentColor:o,contrastColor:a,preMultiplyAlpha:e});this._orientationManipulatorMaterial.setParameters({textureId:l.texture.id}),this._orientationManipulatorTexture=l,s==null||s.release();const r=N.toUnitRGBA(o);this._unfocusedOffsetManipulatorMaterial.setParameters({color:r}),this._focusedOffsetManipulatorMaterial.setParameters({color:r}),this._thinOffsetManipulatorMaterial.setParameters({color:r}),this._constraintSnappingIndicator.color=r},tt));const i=gt(()=>this.analysisViewData.computations,({computation:o})=>this._createManipulators(o));this.addHandles(ot(i)),this.addHandles([v(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:o,stagedComputation:a})=>{if(a==null||o==null)return;const s=Q(o,new F);this._applyPointUpdate(a,{endPoint:s})},wt),v(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(o,a)=>{const{stagedDimension:s,selectedComputation:l,firstGrabbedManipulator:r}=o;if(s===(a==null?void 0:a.stagedDimension)&&r===(a==null?void 0:a.firstGrabbedManipulator)){for(const d of[l,a==null?void 0:a.selectedComputation])if(d!=null){const c=this._computationManipulators.get(d);c!=null&&this._updateManipulators(d,c,o)}}else for(const[d,c]of this._computationManipulators)this._updateManipulators(d,c,o)},A),v(()=>this.analysis.style.lineSize,o=>{this._updateManipulatorStyle(o)},tt),v(()=>this.view.state.camera,()=>{this._stagedComputation!=null&&this._updateStagedDimensionOffset(this._stagedComputation)}),v(()=>{const o=this._stagedComputation;if(!o)return null;const a=o.elevationAlignedStartPoint,s=P();return a!=null&&this.view.renderCoordsHelper.toRenderCoords(a,s)?s:null},o=>{o!=null?(this._stagedStartIndicator.vertices=[o],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),Ci(this,()=>{const o=this._activeComputation,a=this._stagedComputation;if(o==null||a!=null){const s=this.view.inputManager.latestPointerType??"mouse",l=this._getSnappingContext(s);this._updatingHandles.addPromise(Lt(this._snappingOperation.snapAgainNearPreviousMapPoint(this._snappingManager,l)))}if(o!=null){const{start:s,end:l}=this._computationManipulators.get(o);if(s.grabbing||l.grabbing){const r=s.grabbing?"start":"end",d=this._computeConstraint(o);Vn(o,r,{constraint:d,view:this.view})}}})}destroy(){var t;this._snappingOperation=Dt(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),(t=this._orientationManipulatorTexture)==null||t.release()}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(this._stagedComputation!=null)return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&t!=null?t:null}get _stagedComputation(){var i;const t=this._stagedDimension,e=(i=this.analysisViewData.computations.at(-1))==null?void 0:i.computation;return t==null||e==null||e.dimension!==t?null:e}get _constraintHandles(){return[Tt(()=>this.analysisViewData.selectedComputation,t=>{t.previousConstraint=this._computeConstraint(t)},{...A,equals:Mt}),v(()=>{const t=this._activeComputation;if(t==null)return null;const{measureType:e,orientation:i}=t.dimension;return{measureType:e,orientation:i,computation:t}},(t,e)=>{if(t!=null&&e==null){const{measureType:i,orientation:n,computation:o}=t;switch(o.previousConstraint){case D.Horizontal:o.preConstraintProperties={measureType:_.Horizontal,orientation:0};break;case D.Vertical:o.preConstraintProperties={measureType:_.Vertical,orientation:0};break;case D.Direct:o.preConstraintProperties={measureType:_.Direct,orientation:n};break;default:o.preConstraintProperties={measureType:i,orientation:n}}}t==null&&e!=null&&(e.computation.preConstraintProperties=null)},wt)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[v(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(t),i!=null)if(i===e)n.attached=!0;else{const{start:o,end:a}=this._computationManipulators.get(i),s=()=>{n.attached=o.grabbing||a.grabbing};s(),this.addHandles([o.events.on("grab-changed",s),a.events.on("grab-changed",s)],t)}else n.attached=!1}),v(()=>{const e=this._activeComputation;return e!=null?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:i})=>{const n=this._constraintSnappingIndicator;e!=null&&i!=null&&i!==D.Direct?(n.visible=!0,n.setGeometryFromSegment(e.directSegment)):n.visible=!1})]}removeStaged(){return this._stagedDimension!=null&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(e==null){const i=this._onUnstagedClick(t);return this.analysis.dimensions.add(i),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if(e==="touch")return;const i=this._getSnappingContext(e);this._updatingHandles.addPromise(Lt(this._snappingOperation.snap({point:t},this._snappingManager,i)))}onManipulatorSelectionChanged(){this.analysisViewData.selectedComputation!=null&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:t,pointerType:e}){let i=t;if(e==="mouse"){const o=this._getSnappingContext(e);i=this._snappingManager.update({point:t,context:o})}const n=new Ve({startPoint:Q(i,new F),endPoint:null,measureType:_.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:t,pointerType:e}){const i=this._stagedComputation;if(i==null)return;let n=t;if(e==="mouse"){const a=this._getSnappingContext(e);n=this._snappingManager.update({point:t,context:a})}const o=Q(n,new F);this._applyPointUpdate(i,{endPoint:o}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_createManipulators(t){const e=this._setupPointManipulator(t,{isStart:!0}),i=this._setupPointManipulator(t,{isStart:!1}),n=this._setupOffsetManipulator(t),o=this._setupHeadingManipulator(t),a=this._setupRotationManipulator(t),s=this._setupMeasureTypeManipulator(t,_.Direct),l=this._setupMeasureTypeManipulator(t,_.Horizontal),r=this._setupMeasureTypeManipulator(t,_.Vertical),d=new hn({start:e,end:i,offset:n,heading:o,rotation:a,direct:s,horizontal:l,vertical:r});return this._setupComputationToManipulatorsSync(t,d),this._computationManipulators.set(t,d),this.manipulators.addMany(d.values()),{manipulators:d,remove:()=>{this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const c of d.values())this.manipulators.remove(c)}}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([v(()=>t.geometry,()=>this._updateManipulators(t,e),{...A,equals:Mt})],t)}_setupPointManipulator(t,e){const{view:i}=this,{dimension:n}=t,o=new fn(i,{metadata:n}),a=vn(o,{isStart:e.isStart,createSnappingPipelineStep:s=>Mi({snappingContext:this._getSnappingContext(s),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:n,onUpdate:s=>this._applyPointUpdate(t,s),view:i});return this._computationHandles.add(a,t),o}_setupOffsetManipulator(t){const{view:e}=this,i=gn(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),n=yn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupHeadingManipulator(t){const{view:e}=this,i=new Yt(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=Sn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupRotationManipulator(t){const{view:e}=this,i=new Yt(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=Mn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupMeasureTypeManipulator(t,e){const{view:i}=this,n=_n(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),o=Cn(n,{computation:t,manipulatorMeasureType:e,view:i});return this._computationHandles.add(o,t),n}_updateManipulators(t,e,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:o,firstGrabbedManipulator:a}=i,{start:s,end:l,offset:r,heading:d,rotation:c}=e,h=o===t,u=nt(t),{dimension:S}=t;for(const y of e.values()){const L=u&&n==null&&(a==null||y===a);y===r?(y.available=L,y.selected=h):y.available=L&&h}if(!u)return;this._computeConstraint(t)!=null?e.forEachMeasureTypeManipulator(y=>y.available=!1):e.manipulatorForMeasureType(S.measureType).available=!1;for(const y of[d,c])S.measureType===_.Direct&&S.offset!==0||(y.available=!1);zt(t)?c.available=!1:d.available=!1;const{geometry:g}=t;s.renderLocation=g.directSegment.startRenderSpace,l.renderLocation=g.directSegment.endRenderSpace;const{renderCoordsHelper:M}=this.view;bn(r,g,M),d.available&&$n(d,t,M),c.available&&On(c,t,M),e.forEachMeasureTypeManipulator((y,L)=>{y.available&&An(y,t,L,M)})}_updateManipulatorStyle(t){const e=zn(t),i=Vt(t),n={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:o,heading:a,rotation:s}of this._computationManipulators.values())o.radius=i/2,a.update(n),s.update(n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(t,e){const{view:i}=this,n=ct(t);"startPoint"in e&&(n.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(n.elevationAlignedEndPoint=e.endPoint);const o=ut(n,i.renderCoordsHelper);if(o==null)return;const a=this._computeConstraint({...n,geometry:o});xe(t,e,{...n,constraint:a,unconstrainedGeometry:o,view:i}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(t.geometry==null)return;t.geometry.directSegment.eval(.5,te);const{state:e,renderCoordsHelper:i}=this.view,n=e.camera.computeScreenPixelSizeAt(te);t.dimension.offset=cn*n*i.unitInMeters}_computeConstraint(t){return En(kn(t,this._snappingManager.options),this.view)}_createOffsetManipulatorMaterial(){return new q({width:1,renderOccluded:O.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0})}get testInfo(){}};p([m({constructOnly:!0})],w.prototype,"analysis",void 0),p([m({constructOnly:!0})],w.prototype,"analysisViewData",void 0),p([m({constructOnly:!0})],w.prototype,"manipulators",void 0),p([m({constructOnly:!0})],w.prototype,"parentTool",void 0),p([m({constructOnly:!0,nonNullable:!0})],w.prototype,"view",void 0),p([m({readOnly:!0})],w.prototype,"updating",null),p([m()],w.prototype,"firstGrabbedManipulator",null),p([m()],w.prototype,"hasGrabbedManipulators",null),p([m()],w.prototype,"snappingOptions",null),p([m()],w.prototype,"_stagedDimension",void 0),p([m()],w.prototype,"_activeComputation",null),p([m()],w.prototype,"_stagedComputation",null),w=p([G("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],w);const te=P();var W;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(W||(W={}));let b=class extends bi{constructor(t){super(t),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=mn,this._prevPointerMoveTimeout=null}initialize(){this._intersector=$i(this.view.state.viewingMode),this._lengthDimensionSubTool=new w({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([ot(this._lengthDimensionSubTool),ne(()=>this._clearPointerMoveTimeout()),v(()=>this.state,t=>{t===W.Created&&this.finishToolCreation()},A),Tt(()=>this.firstGrabbedManipulator,t=>{this.selectedDimension=t.metadata},A),v(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),A)])}get state(){return this.analysis.dimensions.some(t=>t.type==="length")?this._activeSubTool!=null?W.Creating:W.Created:W.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(t){this.analysisViewData.selectedDimension=t}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":if(Wt.cancel===t.key){if(this._activeSubTool!=null&&this._activeSubTool.removeStaged())return void t.stopPropagation();this.active||(this.selectedDimension=null)}else Wt.delete.includes(t.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){this._activeSubTool!=null&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(t){if(this.hasFocusedManipulators)return void t.stopPropagation();if(this._activeSubTool==null)return;const e=this._intersectScreen(t);e!=null&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:t.pointerType}),t.stopPropagation())}_doubleClickHandler(t){this.active&&(this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(this._resetPointerMoveTimeout(),this._activeSubTool==null||this.hasFocusedManipulators)return;const e=this._intersectScreen(t);e!=null&&this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_deleteKeyHandler(){this._activeSubTool!=null&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(t){const e=Oi(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,n=f.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,new F({spatialReference:this.view.spatialReference})):null}_removeSelected(){this.selectedDimension!=null&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=He(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(t=>t.manipulator.state|=E),this._prevPointerMoveTimeout=Re.setTimeout(()=>{this.manipulators.forEach(t=>t.manipulator.state&=~E)},this._pointerMoveTimerMs)}get testInfo(){}};p([m({constructOnly:!0})],b.prototype,"view",void 0),p([m({constructOnly:!0})],b.prototype,"analysis",void 0),p([m({readOnly:!0})],b.prototype,"state",null),p([m({readOnly:!0})],b.prototype,"updating",null),p([m({readOnly:!0})],b.prototype,"cursor",null),p([m({constructOnly:!0})],b.prototype,"analysisViewData",void 0),p([m()],b.prototype,"selectedDimension",null),p([m()],b.prototype,"automaticManipulatorSelection",void 0),p([m()],b.prototype,"_activeSubTool",void 0),p([m()],b.prototype,"_lengthDimensionSubTool",void 0),b=p([G("esri.views.3d.analysis.Dimension.DimensionTool")],b);class Ln extends Hi{constructor(e,i){super(e),this._hasExternalMaterial=!1,this._renderOccluded=O.OccludeAndTransparent,this._width=1,this._color=Ai(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=i,this._hasExternalMaterial=i!=null,this.applyProperties(e)}setGeometryFromSegment(e,i){const n=e.endRenderSpace;this.transform=Be(Gn,n),this._normal=i;const{points:o}=e.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[o]}get renderOccluded(){return this._material!=null?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,this._material!=null&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return this._material!=null?this._material.parameters.width:this._width}set width(e){this._width=e,this._material!=null&&this._material.setParameters({width:e})}get color(){return this._material!=null?this._material.parameters.color:this._color}set color(e){this._color=xi(e),this._material!=null&&this._material.setParameters({color:this._color})}get placement(){return this._material!=null?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,this._material!=null&&this._material.setParameters({placement:this._placement})}get markerPrimitive(){var e;return((e=this._material)==null?void 0:e.parameters.markerPrimitive)??this._markerPrimitive}set markerPrimitive(e){this._markerPrimitive=e,this._material!=null&&this._material.setParameters({markerPrimitive:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new ge({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive,isDecoration:this.isDecoration}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const i of Ri(this.geometry,this.normal)){const n=zi(this._material,i);e.addGeometry(n)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(this._material)}}const Gn=At();let In=class{set visible(e){for(const i of this._visualElements.values())i.attached=e}constructor(e){this.destroyed=!1,this._handles=new ie,this._messages=null,this._labelSegment=new B;const{analysis:i,computation:n,view:o,messages:a,isDecoration:s}=e;this.analysis=i,this.computation=n,this.view=o,this._messages=a;const l=e.visible,r={view:o,attached:l,isDecoration:s},{fontSize:d,textColor:c,textBackgroundColor:h}=i.style;this._visualElements=new Nn({marker:new Ln(r,e.markerMaterial),dimension:new I(r,e.dimensionLineMaterial),startOffset:new I(r,e.offsetLineMaterial),endOffset:new I(r,e.offsetLineMaterial),dimensionSmall:new I(r,e.smallDimensionLineMaterial),startOffsetSmall:new I(r,e.smallOffsetLineMaterial),endOffsetSmall:new I(r,e.smallOffsetLineMaterial),label:new Ke({view:o,attached:l,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:x(d),textColor:c.clone(),backgroundColor:h.clone(),isDecoration:s})}),this._handles.add([v(()=>n.geometry,u=>{this.updateCameraDependentElements(o.state.camera,u,i.style),n.geometry!=null&&this._updateLines(n.geometry)},{...tt,equals:Mt}),v(()=>n.length,u=>this._updateLabelContent(u),tt)])}destroy(){this.destroyed=!0,this._handles=Dt(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){}_updateLines(e){const i=Jt(jn,it.Start,e.directSegment,e.dimensionSegment),n=Jt(Fn,it.End,e.directSegment,e.dimensionSegment),o=this._visualElements;o.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),o.dimension.setGeometryFromSegment(e.dimensionSegment),o.startOffset.setGeometryFromSegment(i),o.endOffset.setGeometryFromSegment(n),o.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),o.startOffsetSmall.setGeometryFromSegment(i),o.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(e,i,n){const o=this._visualElements;if(i==null){for(const M of o.values())M.visible=!1;return}const a=e.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,Bn)),s=Xi(i,a),l=s<(x(n.lineSize)*un)**2,r=!l;o.marker.visible=r,o.dimension.visible=r,o.startOffset.visible=r,o.endOffset.visible=r,o.dimensionSmall.visible=l,o.startOffsetSmall.visible=l,o.endOffsetSmall.visible=l;const d=x(n.fontSize)*dn,{label:c}=o;if(c.visible=s>=d**2,!c.visible)return;const{dimensionSegment:h,primaryOffsetAxis:u}=i,{offset:S}=this.computation.dimension,g=(Math.sign(S)>=0?1:-1)*Un(n)*a;Fi(this._labelSegment,h,u,g),c.updateLabelPosition()}updateLabelStyle(e){const{label:i}=this._visualElements;i.fontSize=x(e.fontSize),i.textColor=e.textColor,i.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(e){const{label:i}=this._visualElements;e!=null&&this._messages!=null?i.text=Ti(this._messages,e,e.unit):i.text=""}};function Un(t){return 1.5*x(t.fontSize)+pn+x(t.lineSize/2)}const jn=new B,Fn=new B,Bn=P();class Nn{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let R=class extends K{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(t){super(t),this.loadingMessages=!1,this._messages=null}initialize(){const t=this.isDecoration;this._markerMaterial=new ge({width:1,anchor:si.Tip,color:X,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:O.OccludeAndTransparent,markerPrimitive:"triangle",isDecoration:t}),this._dimensionLineMaterial=new q({width:1,color:X,renderOccluded:O.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters,isDecoration:t}),this._offsetLineMaterial=new q({width:1,color:X,renderOccluded:O.OccludeAndTransparent,stipplePattern:mt(5),isDecoration:t}),this._smallDimensionLineMaterial=new q({width:1,color:X,renderOccluded:O.OccludeAndTransparent,isDecoration:t}),this._smallOffsetLineMaterial=new q({width:1,color:X,renderOccluded:O.OccludeAndTransparent,stipplePattern:mt(5),isDecoration:t});for(const i of this._lineMaterials())this.view._stage.add(i),this.addHandles(ne(()=>{var n;(n=this.view._stage)==null||n.remove(i)}));const e=gt(()=>this.analysisViewData.computations,({computation:i})=>this._createVisualization(i));this._dimensionVisualizations=e,this.addHandles([ot(e),v(()=>N.toUnitRGBA(this.analysis.style.color),i=>{for(const n of this._lineMaterials())n.setParameters({color:i})},A),v(()=>this.analysis.style.lineSize,i=>{const n=x(i);this._markerMaterial.setParameters({width:n*we}),this._dimensionLineMaterial.setParameters({width:n,markerParameters:this._markerMaterial.parameters});const o=Math.max(n*ln,1);this._offsetLineMaterial.setParameters({width:o})},A),v(()=>({camera:this.view.state.camera,style:qn(this.analysis)}),({camera:i,style:n})=>{for(const{visualization:o}of this._dimensionVisualizations)o.updateCameraDependentElements(i,o.computation.geometry,n),o.updateLabelStyle(n)}),v(()=>this.visible,i=>{for(const{visualization:n}of this._dimensionVisualizations)n.visible=i})]),this.addHandles([ki(()=>this._updateMessageBundle()),Tt(()=>!this.loadingMessages,()=>{for(const{visualization:i}of this._dimensionVisualizations)i.updateUnitsMessages(this._messages)},wt)]),this._updateMessageBundle()}get testInfo(){}_createVisualization(t){const e=new In({analysis:this.analysis,computation:t,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:e,remove:()=>e.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Di("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function qn(t){const{fontSize:e,lineSize:i,textColor:n,textBackgroundColor:o}=t.style;return{fontSize:e,lineSize:i,textBackgroundColor:o.clone(),textColor:n.clone()}}p([m({constructOnly:!0})],R.prototype,"analysisViewData",void 0),p([m({constructOnly:!0,nonNullable:!0})],R.prototype,"view",void 0),p([m({constructOnly:!0})],R.prototype,"isDecoration",void 0),p([m()],R.prototype,"analysis",null),p([m()],R.prototype,"visible",null),p([m()],R.prototype,"loadingMessages",void 0),R=p([G("esri.views.3d.analysis.Dimension.DimensionVisualization")],R);let $=class extends K{constructor(t){super(t),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(t){const{dimension:e,...i}=t;return{result:new Ii({dimension:e}),...i}}initialize(){this.addHandles([v(()=>this.dimension.startPoint,t=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(t),A),v(()=>this.dimension.endPoint,t=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(t),A)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};p([m({constructOnly:!0,nonNullable:!0})],$.prototype,"result",void 0),p([m({constructOnly:!0,nonNullable:!0})],$.prototype,"projectAndAlignPoint",void 0),p([m()],$.prototype,"dimension",null),p([m()],$.prototype,"length",null),p([m()],$.prototype,"geometry",void 0),p([m()],$.prototype,"unconstrainedGeometry",void 0),p([m()],$.prototype,"elevationAlignedStartPoint",void 0),p([m()],$.prototype,"elevationAlignedEndPoint",void 0),p([m()],$.prototype,"preConstraintProperties",void 0),p([m()],$.prototype,"previousConstraint",void 0),$=p([G("esri.views.3d.analysis.Dimension.LengthDimensionComputation")],$);let C=class extends Gi(ke(K)){constructor(t){super(t),this.type="dimension-view-3d",this.tool=null,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=e=>{if(e==null)return null;const{spatialReference:i,elevationProvider:n}=this.view,o=hi(e,i,n);return o==null&&fi(this.analysis,e.spatialReference,ee.getLogger(this)),o};const t=gt(()=>this.analysis.dimensions,e=>this._createComputation(e));this.computations=t,this.addHandles([Ei(this,b),ot(t)]),this._analysisVisualization=new R({analysisViewData:this,view:this.view,isDecoration:!this.parent}),this._analysisController=new U({analysisViewData:this,view:this.view})}destroy(){this._placementTask=Gt(this._placementTask),this._analysisVisualization=Dt(this._analysisVisualization),Vi(this)}get updating(){var t;return((t=this._analysisVisualization)==null?void 0:t.loadingMessages)??!1}get results(){return this.analysis.dimensions.map(t=>this._dimensionsToComputations.get(t).result)}get selectedComputation(){const{selectedDimension:t}=this;return t==null?null:this._dimensionsToComputations.get(t)}get testInfo(){}async createLengthDimensions(t){return this.selectedDimension=null,this._placementTask=Gt(this._placementTask),this._placementTask=Li(this,t),this._placementTask.promise}_createComputation(t){const{_dimensionsToComputations:e}=this,i=new $({dimension:t,projectAndAlignPoint:this._projectAndAlignPoint});return e.set(t,i),{computation:i,remove:()=>this._removeComputation(i)}}_removeComputation(t){const{dimension:e}=t;e===this.selectedDimension&&(this.selectedDimension=null),this._dimensionsToComputations.delete(e),t.destroy()}};p([m({readOnly:!0})],C.prototype,"type",void 0),p([m()],C.prototype,"tool",void 0),p([m()],C.prototype,"updating",null),p([m({readOnly:!0})],C.prototype,"results",null),p([m()],C.prototype,"computations",void 0),p([m()],C.prototype,"selectedDimension",void 0),p([m()],C.prototype,"selectedComputation",null),p([m()],C.prototype,"_analysisVisualization",void 0),p([m()],C.prototype,"_analysisController",void 0),p([m()],C.prototype,"_dimensionsToComputations",void 0),p([m()],C.prototype,"_placementTask",void 0),C=p([G("esri.views.3d.analysis.DimensionAnalysisView3D")],C);const jr=C;export{jr as default};
