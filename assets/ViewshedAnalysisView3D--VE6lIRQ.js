import{r as c}from"./tslib.es6-B3Jf3DVX.js";import{d as Zt,m as ei}from"./featureReferenceUtils-DBGXy8CW.js";import{W as xe,q as P,b as _e,e as Se,I as ti,s as ii,F as si,B as ri}from"./Accessor-BLX9ikPh.js";import{t as Ht,m as p,a as se,O as ai,e as oi,aA as ni,i as li,j as hi,n as ci}from"./subclass-BZA_h8Db.js";import{watch as M,initial as $,syncAndInitial as ce,mapCollection as Ze,sync as zt,when as Oe}from"./reactiveUtils-C5zUhJQJ.js";import{E as q,A as pe,s as j,B as De,P as ve,R as C,u as Q,g as k,o as J,Y as we,q as di,y as et,_ as pi,p as at,H as ui}from"./vec32-Dvg_eL9J.js";import{n as u,r as G,t as Lt,u as mi,c as vi}from"./vec3f64-BLpZdpfb.js";import{H as wi,J as fi,_ as gi}from"./projection-B971H0Re.js";import{s as _i}from"./AnalysisView3D-BBHxe6zf.js";import{d as re,t as Vi}from"./LineVisualElement-mUtX7dGi.js";import{l as ie}from"./Color-BCS62Hs5.js";import{s as y,M as fe,r as Te}from"./mathUtils-C4_ghTv4.js";import{p as X,y as $e,g as It,d as Ae,R as Ne,c as Be,q as Ve,J as W,i as Ut,e as kt,f as bi}from"./mat4-GpOFENPA.js";import{e as S,o as ot}from"./mat4f64-Dk4dwAN8.js";import{e as jt,B as Mi,g as yi,c as Si,a as nt}from"./renderState-DQLu6AJX.js";import{p as ne}from"./Material-_xx7OZxD.js";import"./geometry-D964gYQX.js";import{d as Oi}from"./Viewshed-Dhyh7k32.js";import{O as Di,l as Wt,M as Nt,H as Ti}from"./plane-IENfwZlB.js";import{d as $i}from"./asyncUtils-CWX51uTe.js";import{a as lt,n as xi}from"./Cyclical-oTUX3aX7.js";import{o as Ai}from"./ViewingMode-Dodu7ZZk.js";import{J as qe}from"./boundedPlane-EV1sS2Ke.js";import{O as Ri,b as Pi,a as oe,e as Re,f as Ci}from"./RenderObject-CuwfmXYe.js";import{C as ht,A as Fi}from"./dragEventPipeline3D-BzC_kbE1.js";import{Y as Ei,h as Hi}from"./viewpointUtils-Bq9TFP4R.js";import{z as Bt,A as ee,o as qt,a as zi,u as Li}from"./MoveManipulation-DDXwpmjU.js";import{w as Ii,p as ct,g as Ui,o as ki}from"./sdfPrimitives-CUWZbMRe.js";import{s as Ge}from"./Util-BIfApRF5.js";import{W as ji}from"./RibbonLine.glsl-BZu1FDpE.js";import{p as Me,M as Wi,h as Pe,f as Ni}from"./InteractiveToolBase-vg6J8uyT.js";import{t as de}from"./interfaces-D6pIddIh.js";import{q as Bi,O as qi}from"./sphere-C77djCO6.js";import{s as tt}from"./sliceToolConfig-D0gkc1PF.js";import{O as Gt}from"./ColorMaterial.glsl-BF1fDRqL.js";import{E as Gi}from"./EditGeometryOperations-Cl8Sbfxr.js";import{j as Qi}from"./settings-BHWvAK7h.js";import{G as Ji}from"./ExtendedLineVisualElement-BaVIzd5h.js";import{c as Xi}from"./LaserlineVisualElement-CUgS0u0n.js";import{m as Yi}from"./intersectorUtilsConversions-D_fcRVdX.js";import{o as Ki}from"./ShadedColorMaterial.glsl-BhqCcqcp.js";import{p as dt}from"./keybindings-DoOdil3D.js";import{t as Zi}from"./ToolIntersector-LAq5Sd_3.js";import{c as es}from"./screenUtils-WcqhHU65.js";import{j as Qe}from"./Point-Cg0-ChZE.js";import{S as ts}from"./LaserlinePath.glsl-CV6hrJ4l.js";import{a as is}from"./Object3DVisualElement-BVfa8i_P.js";import{t as ss}from"./orientedBoundingBox-DOAJUK5g.js";import{p as rs,at as as,Y as pt,au as ut,n as os,G as ns,o as ls,i as hs,av as cs,g as ds,a2 as ps,b as Ce,c as Fe,Q as us,ak as ms,s as vs,h as ws,j as fs,H as gs,I as Ee}from"./Texture-Fac_8AOC.js";import{e as _s}from"./VertexAttribute-Cq4MnHjR.js";import{h as Vs}from"./lineStippleUtils-C89mzWlO.js";import{T as bs}from"./dehydratedFeatureUtils-B--Sgpdi.js";import{e as Ms}from"./intersectorUtils-BK9EUwUf.js";import{V as ys}from"./Collection-CEdjem1-.js";import{h as Ss,a as Os}from"./ShadowCastAccumulate.glsl-BNKV7IEU.js";import{n as Ds,u as mt}from"./vec4f64-o2zAXfmz.js";import{a as Ts}from"./MergedRenderer-Dli9s1X5.js";import{_ as vt}from"./enums-D9v74xTE.js";import{_ as $s}from"./index-Bh2oEzTI.js";import{a as xs,v as As,l as Rs}from"./analysisViewUtils-E34vvAuK.js";import"./vec2-maR1OrZI.js";import"./vec2f64-miziP1SN.js";import"./BindType-BmZEZMMh.js";import{t as Ps,o as ye}from"./interfaces-DDtDqZYj.js";import"./vec42-YcqnINSP.js";import{i as Je,h as He,o as Cs}from"./Matrix3DrawUniform-CiBFaSz6.js";import{a as Fs,e as wt}from"./DefaultMaterial-DgOvtNL9.js";import"./Evented-BHRw9x22.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./common-DQOJ18NT.js";import"./Extent-Bf3YTe7m.js";import"./Polyline-D9YkgmM_.js";import"./writer-DNAwXnhG.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";import"./Promise-B2Hu02L7.js";import"./ElevationProvider-C95wyCKc.js";import"./line-CML3g7Ng.js";import"./aaBoundingBox-BE7cC1jD.js";import"./Indices-DflDlU4Z.js";import"./colorUtils-0bJDPow9.js";import"./jsonMap-0cxwUWs2.js";import"./Clonable-D3rtuBWg.js";import"./assets-C43MgM-v.js";import"./cast-Bjksrh93.js";import"./mat3f64-BBpwCtoL.js";import"./quatf64-CCm9z-pX.js";import"./mathUtils-BG-eq9fO.js";import"./lineSegment-D7sKPPYf.js";import"./compilerUtils-Dw3R0f-Z.js";import"./screenUtils-_ZIvrt5o.js";import"./mat3-BRl2i9Bz.js";import"./computeTranslationToOriginAndRotation-Q27G6TBL.js";import"./hydratedFeatures-DBKLr8hT.js";import"./Graphic-DsxsIjhH.js";import"./PopupTemplate-BHMhS05j.js";import"./fieldUtils-tmQlKvWo.js";import"./intl-CChhNOV8.js";import"./date-DlqISzcw.js";import"./locale-C9TlLpzi.js";import"./messages-OmQvZhAg.js";import"./enumeration-Ba5njXdz.js";import"./ActionToggle-iT4slXc7.js";import"./Identifiable-B1UbsKNt.js";import"./symbols-CNimns--.js";import"./TextSymbol-D8QO_KUV.js";import"./materialUtils-DarhapKC.js";import"./opacityUtils-C68Tlu6_.js";import"./persistableUrlUtils-fa1mAujs.js";import"./collectionUtils-D_lHIu88.js";import"./Portal-C10FKnaA.js";import"./Loadable-BabW5Xcc.js";import"./jsonUtils-CEfjT-BK.js";import"./projectVectorToVector-G2uWGoIb.js";import"./projectPointToVector-GINIbYMz.js";import"./elevationInfoUtils-BC_66_Fg.js";import"./unitConversionUtils-BMfW9yAe.js";import"./lengthUtils-DL1-FDQQ.js";import"./Compositing.glsl-DMM7CJmu.js";import"./Blit-B-VutIER.js";import"./Float4DrawUniform-N58YDhuZ.js";import"./ShaderTechniqueConfiguration-CBbn2DCi.js";import"./colorUtils-aL8wj-8G.js";import"./graphicUtils-CWEFaVJb.js";import"./VertexColor.glsl-_ARMpsAT.js";import"./BufferView-_QDXRCew.js";import"./meshVertexSpaceUtils-CXzOFlTI.js";import"./MeshLocalVertexSpace-LEHwMUnu.js";import"./InterleavedLayout-e-di2fxs.js";import"./AlphaCutoff-UcccL64p.js";import"./verticalOffsetUtils-BDQLpfho.js";import"./Viewpoint-C4FqWA2d.js";import"./projectVectorToPoint-DcLtSZYw.js";import"./frustum-CQrOepbv.js";import"./scaleUtils-D_Nw3nhM.js";import"./earthUtils-ByXwmaX5.js";import"./spatialReferenceSupport-yRFduOSO.js";import"./vec3f32-nZdmKIgz.js";import"./doublePrecisionUtils-B0owpBza.js";import"./floatRGBA-CfH_2xsy.js";import"./Octree-C8d4sqjv.js";import"./Texture-Begq2x5n.js";import"./TriangleMaterial-BiHR3MKx.js";import"./geometry2dUtils-DdyQE7AQ.js";import"./EngineVisualElement-DAbK0X3b.js";import"./VisualElement-Bz1W-x8t.js";import"./OverlayCompositing.glsl-CiE3Tt8y.js";import"./signal-D4lghLjV.js";import"./axisAngleDegrees-Ci2HA7Jo.js";import"./quat-4pa1e6ds.js";import"./weather-eV4wTXCK.js";import"./HighlightDefaults-D4ckYWWJ.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./BufferObject-BVi1lwBq.js";import"./NestedMap-GuqgquCN.js";import"./Intersector-wXoCuQ8W.js";import"./Scheduler-CJu5awNf.js";import"./debugFlags-BF6Z0j0F.js";import"./glUtil-D0YUa0ow.js";import"./Intersector-BQ92CPLA.js";import"./InputManager-Ba9xzDpe.js";import"./Queue-yu3bZ02p.js";import"./HUDMaterial.glsl-D6WRipwF.js";import"./spatialReferenceEllipsoidUtils-DBE_OFra.js";import"./triangle-PTGDC_xJ.js";import"./requestImageUtils-DgMiQwsm.js";import"./jsxFactory-CJa39Fro.js";import"./uuid-fwrPAdZb.js";import"./workers-D4HfeYKj.js";import"./GraphicsCollection-FfahqxsR.js";import"./HeightModelInfo-9nOoV6LU.js";import"./LineCallout.glsl-C1R4fy2f.js";import"./vec2f32-BbH2jxlN.js";import"./dehydratedFeatures-BiOblf0d.js";import"./quantizationUtils-uj_P09aO.js";import"./Field-ybkHhtnK.js";import"./fieldType-BuzM0UHS.js";import"./featureConversionUtils-D14h8iad.js";import"./OptimizedFeature-6cJ-QFG5.js";import"./OptimizedGeometry-BF8iz5FO.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./edgeUtils-BUKTgPFR.js";import"./DecodeSymbolColor.glsl-BPIX0fAF.js";import"./RealisticTree.glsl-CAmeC2w1.js";import"./RenderCoordsHelper-C50UGjbb.js";import"./layerUtils-BrNoooE9.js";import"./DefaultUI-C0utm694.js";import"./UpdatingHandles-GfwcIh5z.js";import"./Map-iWpb5DpI.js";import"./Basemap-DVYOaWHz.js";import"./loadAll-B6mYSptb.js";import"./PortalItem-DzgXrpyc.js";import"./writeUtils-Dz7BsE1e.js";import"./Ground-CAIVlzbd.js";import"./CollectionFlattener-CQN6i8ZK.js";import"./editableLayers-Cn9dHzhB.js";import"./catalogUtils-DyGHPM81.js";import"./basemapUtils-B9TjOm47.js";import"./utils-93yNk4Xc.js";import"./mat4f32-DcsiF_Rp.js";import"./TablesMixin-5umgS75f.js";import"./Layer-CVt7Hb5J.js";import"./TimeExtent-DocT5yPf.js";import"./timeUtils-8fb_2oAt.js";import"./ReactiveMap-6CfRGOlR.js";import"./Query-5Xpquc1r.js";import"./DataLayerSource-BKkswDvG.js";import"./FullTextSearch-Csd1Hktu.js";import"./selectionUtils-DYi6daQO.js";import"./IViewEvents-Bci6PjlS.js";import"./a11yUtils-cyWndM8Q.js";import"./heightModelInfoUtils-C6gW75mB.js";import"./arcgisLayerUrl-BX1FE5Hm.js";import"./imageUtils-CtmzXUTE.js";import"./capabilities-A2uoe7dc.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-CZa70j6i.js";import"./accessibleHandler-hWbBTR_7.js";import"./CompassViewModel-C7G3VWNL.js";import"./utils-DsJqvptN.js";import"./GoTo-Wtu9mgoE.js";import"./NavigationToggle-BIWeotJk.js";import"./ZoomViewModel-oUfjVFgI.js";import"./ElevationSamplerData-DF8Bl6I9.js";import"./terrainUtils-CPZNZdjg.js";import"./TileInfo-Dphjf6xH.js";import"./TileKey-DZd6gJy7.js";import"./Program-mfcb06fW.js";import"./ShadowCastVisualizeTechniqueConfiguration-Bb-Uir0o.js";import"./Environment-BDo9QJi6.js";import"./unitFormatUtils-CZ2bRlFg.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./quantityUtils-D0GB2dMc.js";import"./ZoomMomentumEstimator-DA-HeSfK.js";import"./labelFormatUtils-DFKxfrJb.js";import"./labelUtils-B8petyBk.js";import"./NormalUtils.glsl-DwmdcsLR.js";import"./fontUtils-BKHqaMFz.js";import"./LodRenderer-EVrH9dsH.js";import"./FeaturePipelineRenderManager-DjjUkvYY.js";import"./ElevationQueryTileCache-D4sXpJpw.js";import"./LayerConstants-B33OP6sh.js";import"./ElevationRange-BrgM1moX.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./MemCache-Dx1v3xLC.js";import"./vec33-DUxPafiq.js";import"./Version-BSlAgupz.js";import"./Normals-DzBXR8Bg.js";import"./TileStrategy-DT04gaWW.js";import"./TileKey-Cs1awCRX.js";import"./QueueProcessor-DZiVr5XH.js";import"./RenderableTile-Dl7jrqnB.js";import"./config-MDUrh2eL.js";import"./StyleDefinition-BTt_i6C1.js";import"./enums-CmIX1y88.js";import"./enums-BRzLM11V.js";import"./GeometryUtils-Dyjqugo6.js";import"./DefaultVertexAttributeLayouts-PrbBmwty.js";import"./DisplayObject-DGZ6h7sV.js";import"./resources-CLJpJAXm.js";import"./vec3-kbEkneOB.js";import"./VertexArrayObject-lPxPk5E-.js";import"./ShaderTechniqueRepository-hTzew41Z.js";import"./testSVGPremultipliedAlpha-uTaDUvFS.js";import"./RenderingContext-C2W2PIoX.js";import"./ProgramCache-BcuuBWLJ.js";import"./layerViewUtils-DhFEu8Rd.js";const ft=2,Es=4,Qt=y(2),Hs=1.5;let zs=class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=Es,this.fovFocusedArcWidth=ft*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=ft/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(t){return t?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(t){return this.scaleOrientArrowTipLength*(t?this.scaleOrientArrowTipFocusMultiplier:1)}};const H=new zs;class Ls{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new ie([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:ie.toUnitRGBA(new ie([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:ne.Occlude,cullFace:jt.Back,writeDepth:!1}}}const K=new Ls;function it({tiltedUpVector:r,rightVector:t,observerRenderSpace:e},i){const s=Ri(r,t,e,i);return s[12]=0,s[13]=0,s[14]=0,s}function Xe(r,t,e,i){const s=u(),a=Di(e.plane),o=Is(t,a);let h;if(Math.abs(o)>H.viewAngleThreshold)h=r.next(ht(t,e.plane));else{const d=Wt(i.targetRenderSpace,e.basis1,Nt()),l=pe(Jt,e.basis1),n=pe(Us,e.basis2);h=r.next(ht(t,d)).next(m=>{const v=D=>{const O=ve(C(gt,D,e.origin),n),A=Math.acos(Te(O/i.farDistanceRenderSpace,-1,1)),F=Math.sin(A)*i.farDistanceRenderSpace;return Q(u(),e.origin,Q(u(),k(gt,l,F),k(ks,n,O)))},w=v(m.renderStart),f=v(m.renderEnd);return{...m,renderStart:w,renderEnd:f}})}return h.next(d=>{d.action==="start"&&j(s,d.renderStart);const l=fe(Pi(s,d.renderEnd,e.origin,a));return{...d,deltaAngle:l}})}function Is(r,t){const e=Jt;r.renderCoordsHelper.toRenderCoords(r.camera.position,e);const i=Ei(r,e,r.camera.heading,r.camera.tilt,Hi()).direction;return fe(De(i,t))-90}function te(r,t,e,i){return X(_t,e,i),q(r,t,_t)}const Jt=u(),Us=u(),gt=u(),ks=u(),_t=S();let js=class extends Bt{constructor(t){super(),this._handles=new xe,this._tool=t.tool,this._view=t.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles=P(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(t,e){const i=Object.values(this._manipulators);return Ht(i.map(({manipulator:s,side:a})=>Me(s,(o,h,d,l,n)=>{const m=Qs(a,e),v=h.next(f=>({...f,manipulatorType:ee.SCALE,side:a})),w=Xe(v,this._view,m,e);t(o,w,d)})))}updateManipulatorsTransform(t){t.arcCentersPoints(Vt),this._forEachManipulatorInfo(e=>this._updateArcManipulatorTransform(e,t,Vt[e.side]))}updateManipulatorVisuals(t){this._forEachManipulatorInfo(e=>this._updateArcManipulatorVisuals(e,t))}_updateArcManipulatorVisuals({manipulator:t,side:e},i){const s=[];if(i!=null){const[a,o]=Ws(e,i,this._unfocusedArcMaterial);s.push(new oe(a,de.Unfocused),new oe(a.instantiate({material:this._focusedArcMaterial}),de.Focused)),t.collisionType={type:"line",paths:[o]}}t.renderObjects=s,t.radius=H.collisionRadius}_updateArcManipulatorTransform({manipulator:t,side:e},i,s){const a=i.horizontalFieldOfView,o=y(i.verticalFieldOfView/2),h=y(a/2),d=ge(e);t.renderLocation=s;const l=S(),n=D=>{Be(l,D,l)};n($e(le,y(-90))),d||n(It(le,o));const m=i.farDistanceRenderSpace;let v,w;n(Ae(le,J(Xt,m,m,m))),n(Ne(le,qs(e))),n(it(i,le)),d?(v=h,w=i.tiltedUpVector):(w=i.rightVector,v=o),v*=e==="right"||e==="bottom"?-1:1;const f=X(le,v,w);f!=null&&n(f),t.modelTransform=l}_createManipulators(){const t=this._createArcManipulator("left"),e=this._createArcManipulator("right"),i=this._createArcManipulator("top"),s=this._createArcManipulator("bottom");this._manipulators={left:t,right:e,top:i,bottom:s},[[s.manipulator,i.manipulator],[t.manipulator,e.manipulator]].forEach(([a,o])=>{a.metadata={pairedManipulator:o},o.metadata={pairedManipulator:a}})}_createArcManipulator(t){const e=new Re({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),i={manipulator:e,side:t};return this._updateArcManipulatorVisuals(i),this._handles.add(e.events.on("focus-changed",s=>{var o;const a=(o=e.metadata)==null?void 0:o.pairedManipulator;a!=null&&(a.hovering!==e.hovering&&(a.hovering=e.hovering),a.grabbing!==e.grabbing&&(a.grabbing=e.grabbing))})),i}_createArcMaterial(t){const e=H.getFovArcWidth(t),i=new ji({renderOccluded:ne.OccludeAndTransparent,isDecoration:!0,width:e});return this._handles.add(M(()=>ie.toUnitRGBA(this._view.effectiveTheme.accentColor),s=>i.setParameters({color:s}),$)),i}forEachManipulator(t){Object.values(this._manipulators).forEach(({manipulator:e})=>t(e,ee.SCALE))}_forEachManipulatorInfo(t){Object.values(this._manipulators).forEach(e=>t(e))}get test(){return{manipulators:this._manipulators}}};function Ws(r,t,e){const{horizontalFieldOfView:i,verticalFieldOfView:s}=t,a=ge(r),o=y(Te((a?s:i)/2,0,15)),h=Ns(-o/2,o/2,a?1:Math.max(Math.sin(y(90-s/2)),.1));return[Ii(e,h),h]}function Ns(r,t,e,i=10){Ge(i>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const s=t-r;if(s<=0||e<=0)return[G(0,0,.01),G(0,0,-.01)];const a=[],o=s/i;for(let h=0;h<i;h++){let d=r+h*o;h===i-1&&(d=t);const l=Math.cos(d)*e,n=Math.sin(d)*e,m=G(l-e,0,n);a.push(m)}return a}function Bs(r){switch(r){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function qs(r){return Bs(r)*Js}function ge(r){return r==="left"||r==="right"}function Gs(r){return r==="left"?"right":r==="right"?"left":r==="top"?"bottom":"top"}function Qs(r,{observerRenderSpace:t,targetRenderSpace:e,tiltedUpVector:i,rightVector:s,farDistanceRenderSpace:a}){const o=C(Xt,e,t),h=ge(r)?s:i,d=k(Xs,h,a);return qe(t,o,d)}const Js=Math.PI/2,le=S(),Xt=u(),Xs=u(),Vt={top:u(),bottom:u(),left:u(),right:u()};let ze=class extends Re{constructor(t,e){super({view:t,autoScaleRenderObjects:!1,worldSized:!1,radius:H.collisionRadius}),this._handles=new xe,this._setupManipulatorVisual(e)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(t){const e=this._createMaterial(),i=1,s=[G(0,0,0),G(0,0,i)],a=ct(e,s,t,16,!1),o=ct(e,s,t*tt,16,!1),h=bt(!1,e,t),d=bt(!0,e,t),l=S();Ve(l,s[s.length-1]),W(l,l,It(Mt,Math.PI/2)),W(l,l,$e(Mt,Math.PI/2)),h.transformation=l,d.transformation=l,this.renderObjects=[new oe(a,de.Unfocused),new oe(o,de.Focused),new oe(h,de.Unfocused),new oe(d,de.Focused)];const n=G(0,H.getScaleOrientArrowTipLength(!0),0),m=q(n,n,l),v=[...s,m];this.collisionType={type:"line",paths:[v]}}_createMaterial(){const t=new Gt({cullFace:jt.Back,renderOccluded:ne.OccludeAndTransparent,isDecoration:!0});return this._handles.add(M(()=>ie.toUnitRGBA(this.view.effectiveTheme.accentColor),e=>t.setParameters({color:e}),$)),t}};function bt(r,t,e){const i=H.getScaleOrientArrowTipLength(r);let s=2*e;r&&(s*=tt);const a=i/2;return Ui(t,i,a,a,s,0)}const Mt=S();let Ys=class extends Bt{constructor(t){super(),this._handles=new xe,this._tool=t.tool,this._view=t.view;const e=H.scaleOrientHandleRadius;this._manipulatorHeading=new ze(this._view,e),this._manipulatorTilt=new ze(this._view,e),this._manipulatorDistance=new ze(this._view,e),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles.destroy(),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(t,e){return Me(this._manipulatorHeading,(i,s,a,o,h)=>{const d=this._view,{tiltParallelToSurface:l,farDistanceRenderSpace:n,upVector:m,observerRenderSpace:v,targetRenderSpace:w,rightVector:f}=e,D=Math.sin(y(l))*n,O=Q(be,v,k(Le,m,D)),A=C(Le,w,O),F=k(Ks,f,we(A)),R=qe(O,A,F),z=Xe(s,d,R,e).next(L=>({...L,manipulatorType:ee.ROTATE}));t(i,z,a)})}createTiltDragPipeline(t,e){return Me(this._manipulatorTilt,(i,s,a,o,h)=>{const{observerRenderSpace:d,farDistanceRenderSpace:l,upVector:n,targetDirection:m}=e,v=ve(m,n),w=di(be,m,n,-v);k(w,pe(w,w),l);const f=k(Le,n,l),D=qe(d,w,f),O=Xe(s,this._view,D,e).next(A=>({...A,manipulatorType:ee.ROTATE}));t(i,O,a)})}createDistanceDragPipeline(t,e){return Me(this._manipulatorDistance,(i,s,a,o,h)=>{const d=Bi(e.observerRenderSpace,e.targetDirection),l=s.next(Wi(this._view,i.location)).next(Fi(this._view,d)).next(n=>({...n,manipulatorType:ee.SCALE}));t(i,l,a)})}updateManipulators(t){const{targetRenderSpace:e}=t;this._manipulatorHeading.renderLocation=e,this._manipulatorTilt.renderLocation=e,this._manipulatorDistance.renderLocation=e;const i=S(),s=n=>{Be(i,n,i)},a=H.scaleOrientSize*(qt/zi);s(Ae(ue,J(be,a,a,a))),s(it(t,ue));const o=H.scaleOrientHandleRadius*tt*a,h=k(be,t.targetDirection,o);s(Ve(ue,h));const d=Ne(ue,-Ie);W(d,d,$e(yt,-Ie)),this._manipulatorHeading.modelTransform=W(S(),i,d);const l=$e(ue,Ie);W(l,l,Ne(yt,Math.PI)),this._manipulatorTilt.modelTransform=Be(S(),i,l),this._manipulatorDistance.modelTransform=i}forEachManipulator(t){t(this._manipulatorHeading,ee.ROTATE),t(this._manipulatorTilt,ee.ROTATE),t(this._manipulatorDistance,ee.SCALE)}};const ue=S(),yt=S(),be=u(),Le=u(),Ks=u(),Ie=Math.PI/2;let Yt=class extends Re{constructor(t,e){super({view:t,autoScaleRenderObjects:!1,worldSized:!1,radius:H.observerSize,interactive:!1}),this._handles=new xe;const i=Ci(this._color);this.renderObjects=[new oe(ki(i,H.observerSize,32,32))],e.manipulators.add(this),this._handles.add([M(()=>this._color,s=>{i.setParameters({color:s})},$)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return ie.toUnitRGBA(this.view.effectiveTheme.accentColor)}};c([p()],Yt.prototype,"_color",null);const St=Symbol("dragHandles"),Ot=Symbol("hideManipulators"),Dt=Symbol("hideFoVManipulators"),Tt=Symbol("hideObserverManipulator");let I=class extends _e{constructor(t){super(t),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new js({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Ys({view:this.view,tool:this.parentTool}),this._observerManipulator=new Yt(this.view,this.parentTool),this.addHandles([M(()=>{var e;return(e=this.viewshedComputedData)==null?void 0:e.observerRenderSpace},e=>{e!=null&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)},ce),M(()=>{var e;return(e=this.viewshedComputedData)==null?void 0:e.heading},e=>{e&&(this._moveManipulation.angle=y(90-e))},$),M(()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e==null?void 0:e.observer}},({viewshedComputedData:e,observer:i},s)=>{this._grabbing&&i!==(s==null?void 0:s.observer)||(this.removeHandles(St),e!=null&&e.isValid()&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(ai),St))},$),M(()=>{const e=this.viewshedComputedData;return e!=null&&e.isValid()?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)},$),M(()=>{const e=this.viewshedComputedData;return e!=null&&e.isValid()?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)},$),M(()=>{var s;const e=this.analysisViewData.visible&&(((s=this.viewshedComputedData)==null?void 0:s.isValid())??!1),i=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||i)}},({fovManipulationAvailable:e,nonFOVManipulationAvailable:i})=>{this._moveManipulation.available=i,this._scaleOrientManipulation.available=i,this._observerManipulator.available=i,this._fieldOfViewManipulation.available=e},$),M(()=>{const e=this.viewshedComputedData;if(!(e!=null&&e.isValid()))return null;const{observer:i,target:s,verticalFieldOfView:a,horizontalFieldOfView:o}=e;return{viewshedCompData:e,observer:i,target:s,verticalFieldOfView:a,horizontalFieldOfView:o}},e=>{e!=null&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)},$)]);const t=e=>{const i=this.analysisViewData;this.addHandles([e.events.on("focus-changed",()=>{const s=this._someManipulatorHovering();s&&this.parentTool.subToolHandles.forEach(({subTool:a})=>{a._resetHoveringTask()}),this._someManipulatorSelected()||s||(this._forceHoveringTask=$i(async a=>{await(this._forceHoveringTestPromise??ti(H.hoverTimeoutMilliseconds,a)),ii(a),this._forceHoveringTask=null,this._updateManipulatorVisibility()}))}),e.events.on("grab-changed",s=>{var a;this._grabbing=s.action==="start",s.action==="end"&&((a=i.tool)==null||a.updateInteractionVisualsVisibility()),this.parentTool.subToolHandles.forEach(({subTool:o})=>{o!==this&&o._setInteractive(!this._grabbing)}),this._setInteractive(o=>o.hasManipulator(e)||!this._grabbing)}),e.events.on("drag",s=>{var a;s.action==="start"&&((a=i.tool)==null||a.updateInteractionVisualsVisibility())})])};this._forEachManipulator(t)}destroy(){this._forceHoveringTask=Se(this._forceHoveringTask),this._moveManipulation=P(this._moveManipulation),this._fieldOfViewManipulation=P(this._fieldOfViewManipulation),this._scaleOrientManipulation=P(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=P(this._observerManipulator)}get viewshed(){var t;return(t=this.viewshedComputedData)==null?void 0:t.viewshed}get grabbing(){return this._grabbing}get observer(){var t;return(t=this.viewshed)==null?void 0:t.observer}set observer(t){const e=this.viewshed;e!=null&&(e.observer=t)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:t,grabbing:e}=this._moveManipulation;return{dragging:t,grabbing:e}}get scaleOrientInteractionState(){const{dragging:t,grabbing:e}=this._scaleOrientManipulation;return{dragging:t,grabbing:e}}_setInteractive(t){const e=typeof t=="boolean";this._forEachManipulation(i=>i.interactive=e?t:t(i))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),!this._someManipulatorSelected()&&(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(t){let e=!1;return this._forEachManipulator(i=>{e=e||i===t}),e}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new Li({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:qt})}_buildObserverDragPipeline(t){const e={mode:"absolute-height",offset:0},i=t.observer;if(i==null)return null;const s=this.view.spatialReference;return this._moveManipulation.createDragPipeline((a,o,h,d,l)=>{d=d.next(Pe(this,["observer"]));const n=wi(i,s);if(n==null)return{steps:h,cancel:d};const m=Gi.fromGeometry(n,Ai(this.view.viewingMode));return{steps:h.next(Ni({operations:m})).next(v=>(this.observer=m.data.geometry,v)),cancel:d}},e,s,void 0)}_buildFOVDragPipeline(t){let e=0,i=0;return this._fieldOfViewManipulation.createDragPipeline((s,a,o)=>{if(t==null)return{steps:a,cancel:o};const h=t.viewshed;let d=null;return o=o.next(Pe(t,["horizontalFieldOfView","verticalFieldOfView"])),{steps:a.next(l=>{if(l.action==="start")return d=null,e=t.horizontalFieldOfView,i=t.verticalFieldOfView,l;const n=l.deltaAngle;if(d==null&&n!==0){const w=l.side==="bottom"||l.side==="left"?n>0:n<0;d=ge(l.side)?e===0&&w||e===360&&!w:i===0&&w}const m=d?Gs(l.side):l.side;let v=0;switch(m){case"left":v=e/2-n;break;case"right":v=e/2+n;break;case"top":v=i+2*n;break;case"bottom":v=i-2*n}return ge(m)?(v=lt.normalize(v),v=v>270?0:v>180?180:v,h.horizontalFieldOfView=2*v):h.verticalFieldOfView=v,l}),cancel:o}},t)}_buildScaleOrientDragPipeline(t){let e=0,i=0;const s=(a,o)=>(h,d,l)=>{if(t==null)return{steps:d,cancel:l};const n=t.viewshed;return l=l.next(Pe(n,[a])),{steps:d=d.next(o(n,t)),cancel:l}};return Ht([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",(a,o)=>h=>(h.action==="start"&&(i=t.heading),a.heading=lt.normalize(i+h.deltaAngle),h)),t),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",(a,o)=>h=>{h.action==="start"&&(e=t.tilt);let d=e+h.deltaAngle;return d<-90?d=180:d>270&&(d=0),a.tilt=er.clamp(d),h}),t),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",(a,o)=>h=>{const d=C(Zs,h.renderEnd,o.observerRenderSpace),l=we(d)*o.metersPerUnit,n=ve(d,o.targetDirection)<0?H.scaleOrientMinDistance:l;return a.farDistance=n,h}),t)])}_updateManipulatorVisibility(){const t=this._someManipulatorSelected(),e=this._forceHoveringTask!=null||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,s=this.parentTool.creating;let a=[];const o=h=>{a.push(h.disableDisplay())};t||!s&&e?this.removeHandles(Ot):(this._scaleOrientManipulation.forEachManipulator(o),this._moveManipulation.forEachManipulator(o),this.addHandles(a,Ot),a=[]),t||!s&&e||s&&i?this.removeHandles(Dt):(this._fieldOfViewManipulation.forEachManipulator(o),this.addHandles(a,Dt)),t||!s?this.removeHandles(Tt):this.addHandles(this._observerManipulator.disableDisplay(),Tt)}_resetHoveringTask(){this._forceHoveringTask=Se(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(t){this._forEachManipulation(e=>{e.forEachManipulator(t)}),t(this._observerManipulator)}_forEachManipulation(t){t(this._moveManipulation),t(this._fieldOfViewManipulation),t(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:t=>{this._forceHoveringTestPromise=t}}}};c([p({constructOnly:!0})],I.prototype,"analysis",void 0),c([p({constructOnly:!0})],I.prototype,"analysisViewData",void 0),c([p({constructOnly:!0})],I.prototype,"parentTool",void 0),c([p({constructOnly:!0,nonNullable:!0})],I.prototype,"view",void 0),c([p()],I.prototype,"viewshed",null),c([p()],I.prototype,"_grabbing",void 0),c([p()],I.prototype,"grabbing",null),c([p()],I.prototype,"viewshedComputedData",void 0),c([p()],I.prototype,"observer",null),I=c([se("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],I);const Zs=u(),er=new xi(0,180),Ue=Symbol("interactionVisuals");let T=class extends Ki{constructor(t){super(t),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creationState=!1,this._interactionVisualElements=null,this._settings=new Qi({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=Zi(this.view.state.viewingMode),this._createInteractionVisuals();const t=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=Ze(()=>t,({viewshedComputedData:e})=>{const i=new I({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:i,remove:()=>{this.selectedViewshed===e.viewshed&&(this.selectedViewshed=null),i.destroy()}}}),this.addHandles([M(()=>t==null?void 0:t.some(e=>e.viewshedComputedData.isValid()),e=>{e&&this.finishToolCreation()},ce),M(()=>this._stagedViewshed,e=>{var s;const i=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=e!=null&&i!=null?(s=this._findSubTool(e))==null?void 0:s.viewshedComputedData:null},ce),M(()=>this.firstGrabbedManipulator,e=>{var i,s;if(e!=null){const a=(i=this._findSubTool(e))==null?void 0:i.viewshed;this.selectedViewshed=a,this._selectManipulator(e)}else(s=this._selectedSubTool)==null||s.onManipulatorSelectionChanged()},zt),M(()=>this.view.activeTool,e=>{e!==this&&e!=null&&(this.selectedViewshed=null)}),Oe(()=>{const e=this.selectedViewshedComputedData;return e==null?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}},e=>{const{subTool:i,observer:s,target:a}=e;i!=null&&i.moveInteractionState.dragging?this._updateInteractionVisualsLocation(s,!0):i!=null&&i.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(a,!1)},$),M(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),M(()=>this.selectedViewshed,e=>{const i=this._selectedManipulator,s=this._selectedSubTool;e==null?this._selectManipulator(null):i!=null&&s.hasManipulator(i)||this._selectManipulator(s.discManipulator)},$)])}destroy(){this.subToolHandles=P(this.subToolHandles),this.removeHandles(Ue)}onDeactivate(){this.removeStaged(),this._creationState=!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(t){var i,s;const e=this._selectedManipulator;e!==t&&(this._selectedManipulator=t,e!=null&&(e.selected=!1),t!=null&&(t.selected=!0),(i=this._findSubTool(e))==null||i.onManipulatorSelectionChanged(),(s=this._selectedSubTool)==null||s.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(t){this.analysisViewData.selectedViewshed=t}get selectedViewshedComputedData(){var t;return(t=this._selectedSubTool)==null?void 0:t.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:t})=>t.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return this._creationState==="placing-target"}createViewsheds(){this.selectedViewshed=null,this._creationState="placing-observer"}onManipulatorSelectionChanged(){this.subToolHandles.forEach(t=>t.subTool.onManipulatorSelectionChanged())}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":dt.cancel===t.key?this._cancelKeyHandler(t):dt.delete.includes(t.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(t){t.type==="immediate-click"&&this._clickPlacementHandler(t)}_clickPlacementHandler(t){if(!this.creating||this.hasFocusedManipulators)return;const e=this._intersectScreen(t,xt);if(e!=null){if(this._creationState==="placing-observer"){e.mapPoint.z=(e.mapPoint.z??0)+Hs;const i=new Oi({observer:e.mapPoint.clone(),feature:e.feature});this.analysis.viewsheds.add(i),this._stagedViewshed=i,this._creationState="placing-target",this._updateStagedViewshed(e.scenePoint)}else if(this._creationState==="placing-target"){this._updateStagedViewshed(e.scenePoint);const i=this._stagedViewshed;this._creationState="placing-observer",this._stagedViewshed=null,this.selectedViewshed=i}t.stopPropagation()}}_doubleClickHandler(t){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(!this.creating)return;const e=this._intersectScreen(t,xt);e!=null&&(this._updateInteractionVisualsLocation(e.scenePoint,!1),this._updateStagedViewshed(e.scenePoint))}_cancelKeyHandler(t){if(this.creating){if(this.removeStaged())return this._creationState="placing-observer",this.selectedViewshed=null,void t.stopPropagation();this._creationState=!1}else if(!this.grabbing)return this.selectedViewshed=null,void t.stopPropagation()}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(t){const e=this._stagedViewshed,i=this._stagedViewshedComputedData;if(e==null||i==null)return;const{heading:s,tilt:a,farDistance:o}=tr(this.view,i,t);e.farDistance=o,e.tilt=a,e.heading=s}removeStaged(){return this._stagedViewshed!=null&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}_intersectScreen(t,e){const i=es(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,a=e.scenePoint;if(!s.getIntersectionPoint(a))return null;const o=e.mapPoint;return o.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(a,o),o==null?null:(e.feature=Yi(s,this.view),e)}_createInteractionVisuals(){this.removeHandles(Ue);const t=this._settings.visualElements,e=new Xi({view:this.view,attached:!1,style:{glowWidth:t.heightPlane.glowWidth,innerWidth:t.heightPlane.innerWidth},isDecoration:!0}),i=new Ji({view:this.view,extensionType:t.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:ne.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:e,verticalLine:i},this.addHandles([M(()=>t.zVerticalLine,s=>s.apply(i),ce),M(()=>t.heightPlane,s=>s.apply(e),ce),oi(()=>{e.destroy(),i.destroy(),this._interactionVisualElements=null})],Ue)}updateInteractionVisualsVisibility(t=!1){const e=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,a=this.selectedViewshedComputedData,o=(v,w)=>{const f=this._interactionVisualElements;f!=null&&(f.verticalLine.attached=w,f.laserline.attached=v)};if(e)return void o(i,!1);if(s==null||a==null)return void o(!1,!1);const h=s.moveInteractionState,d=t?h.grabbing:h.dragging,l=s.scaleOrientInteractionState,n=t?l.grabbing:l.dragging,m=i&&(d||n);if(o(m,d),m){const v=d?a.observerRenderSpace:a.targetRenderSpace;this._updateInteractionVisualsLocation(v,d)}}_updateInteractionVisualsLocation(t,e){const i=this._interactionVisualElements;if(i==null)return;const{laserline:s,verticalLine:a}=i;s.heightManifoldTarget=t,s.intersectsWorldUpAtLocation=e?t:null,t!=null&&a.setStartEndFromWorldDownAtLocation(t)}_findSubTool(t){var i,s;if(t==null)return null;const e=t instanceof Re?a=>a.subTool.hasManipulator(t):a=>a.subTool.viewshed===t;return(s=(i=this.subToolHandles)==null?void 0:i.find(e))==null?void 0:s.subTool}get test(){}};function tr(r,t,e){const i=t.observerRenderSpace,s=C(ir,e,i),a=we(s)*t.metersPerUnit,o=r.renderCoordsHelper.basisMatrixAtPosition(i,ar),h=J(sr,o[8],o[9],o[10]),d=Wt(i,h,or),l=Ti(d,e,rr),n=C(l,l,i),m=(we(n)<1e-4?90:fe(De(s,n)))*(ve(h,s)<0?-1:1)+90,v=J($t,o[4],o[5],o[6]),w=fe(De(v,n)),f=J($t,o[0],o[1],o[2]);return{heading:ve(n,f)<0?360-w:w,tilt:m,farDistance:a}}c([p({constructOnly:!0})],T.prototype,"view",void 0),c([p()],T.prototype,"analysisViewData",void 0),c([p()],T.prototype,"removeIncompleteOnCancel",void 0),c([p()],T.prototype,"automaticManipulatorSelection",void 0),c([p({constructOnly:!0})],T.prototype,"analysis",void 0),c([p()],T.prototype,"subToolHandles",void 0),c([p()],T.prototype,"_stagedViewshed",void 0),c([p()],T.prototype,"_stagedViewshedComputedData",void 0),c([p()],T.prototype,"_creationState",void 0),c([p({readOnly:!0})],T.prototype,"cursor",null),c([p()],T.prototype,"_selectedManipulator",void 0),c([p()],T.prototype,"_selectedSubTool",null),c([p()],T.prototype,"selectedViewshed",null),c([p()],T.prototype,"selectedViewshedComputedData",null),c([p()],T.prototype,"stagedViewshed",null),c([p()],T.prototype,"grabbing",null),c([p()],T.prototype,"creating",null),c([p()],T.prototype,"isPlacingTarget",null),T=c([se("esri.views.3d.analysis.Viewshed.ViewshedTool")],T);const ir=u(),sr=u(),rr=u(),$t=u(),ar=S(),or=Nt(),xt={mapPoint:new Qe,scenePoint:u(),feature:null},Ye=T;class nr extends is{constructor(t){super(t),this._material=null,this._viewshedComputedData=null,this._material=new Gt({...K.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(t)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(t){this._viewshedComputedData=t,this.updateTransform()}updateTransform(){const t=this._viewshedComputedData;if(t==null)return;const e=S(),i=t.farDistanceRenderSpace;Ae(e,G(i,i,i)),it(t,me),W(e,me,e),Ve(me,this._viewshedComputedData.observerRenderSpace),W(e,me,e),this.transform=e}createExternalResources(){}destroyExternalResources(){}forEachExternalMaterial(t){this._material!=null&&t(this._material)}createGeometries(t){const{_material:e,viewshedComputedData:i}=this;i==null||e==null||!i.isValid()||lr(e,i).forEach(s=>t.addGeometry(s))}}function lr(r,t){const{horizontalFieldOfView:e,verticalFieldOfView:i}=t,s=J(hr,0,0,1),a=J(Rt,0,1,0),o=J(Pt,1,0,0);te(s,s,y(i/2),a),te(s,s,y(e/2),o);const h=b=>Math.ceil(Math.abs(b)/Qt)+1,d=y(e),l=j(cr,o),n=h(d),m=At(-d/(n-1)),v=X(me,m,l),w=y(-i),f=h(w),D=At(w/(f-1)),O=j(Rt,a),A=X(Ct,y(e)/2,o);q(O,O,A);const F=Ct,R=[],z=j(Pt,s);for(let b=0;b<n;b++){X(F,D,O);for(let g=0;g<f;g++){const _=3*(g*n+b);R[_]=z[0],R[_+1]=z[1],R[_+2]=z[2],q(z,z,F)}q(O,O,v),q(s,s,v),j(z,s)}const L=n*f;R[3*L]=0,R[3*L+1]=0,R[3*L+2]=0;const N=[];for(let b=0;b<n-1;b++)for(let g=0;g<f-1;g++){const _=6*(g*(n-1)+b);N[_]=g*n+b,N[_+1]=(g+1)*n+b,N[_+2]=g*n+b+1,N[_+3]=g*n+b+1,N[_+4]=(g+1)*n+b,N[_+5]=(g+1)*n+b+1}const Y=[N];if(e!==360&&i!==0){const b=[],g=[];for(let _=0;_<f-1;_++){const x=3*_;b[x]=L,b[x+1]=(_+1)*n,b[x+2]=_*n,g[x]=L,g[x+1]=_*n+n-1,g[x+2]=(_+1)*n+n-1}Y.push(b,g)}if(i!==180&&e!==0){const b=[],g=[];for(let _=0;_<n-1;_++){const x=3*_;b[x]=L,b[x+1]=_,b[x+2]=_+1,g[x]=L,g[x+1]=_+(f-1)*n+1,g[x+2]=_+(f-1)*n}Y.push(b,g)}return Y.map(b=>{const g=[[_s.POSITION,new ss(R,b,3,!0)]];return new rs(r,g)})}function At(r){return isNaN(r)?1:r}const hr=u(),Rt=u(),Pt=u(),cr=u(),me=S(),Ct=S();let B=class extends _e{constructor(t){super(t),this.visible=!0,this._viewshedCorners={topLeft:u(),topRight:u(),bottomLeft:u(),bottomRight:u()},this._arcCenterPoints={top:u(),bottom:u(),left:u(),right:u()},this._parallelCenters={top:u(),bottom:u()}}initialize(){const t={view:this.view,isDecoration:!0},e={...t,color:this._color,renderOccluded:ne.OccludeAndTransparent},i={...e,stipplePattern:Vs(2)};this._observerVisualElement=new ts({...t,...K.observerPointConfiguration}),this._shapeVisualElement=new nr(t),this._frameLinesVisualElement=new re(e),this._leftArcVisualElement=new re(e),this._rightArcVisualElement=new re(e),this._topArcVisualElement=new re(e),this._bottomArcVisualElement=new re(e),this._centralLongitude=new re(i),this._centralLatitude=new re(i),this.addHandles([M(()=>{const s=this.viewshedComputedData;if(!(s!=null&&s.isValid()))return null;const a=this._viewshedCorners,o=this._arcCenterPoints,h=this._parallelCenters;return s.cornerPoints(a),s.arcCentersPoints(o),s.parallelCenterPoints(h),{viewshedComputedData:s,corners:a,arcCenters:o,parallelCenters:h,interactive:this.analysisViewData.interactive,selected:this._selected}},s=>{const a=s!=null;this._forEachVisualElement(o=>o.attached=a),a&&this._updateVisualElements(s)},{initial:!0,equals:ni}),M(()=>{const{viewshedComputedData:s}=this,{horizontalFieldOfView:a,verticalFieldOfView:o}=s??{};return{viewshedComputedData:s,horizontalFieldOfView:a,verticalFieldOfView:o}},({viewshedComputedData:s})=>{const{_shapeVisualElement:a}=this;s!==a.viewshedComputedData&&(a.viewshedComputedData=s),this._shapeVisualElement.recreateGeometry()},$),M(()=>{var a;const{interactive:s}=this.analysisViewData;return{visible:this.visible,selected:s&&this._selected,staged:s&&this._staged,horFovNot360:((a=this.viewshedComputedData)==null?void 0:a.horizontalFieldOfView)!==360}},({visible:s,selected:a,staged:o,horFovNot360:h})=>{const d=a||o;this._shapeVisualElement.visible=s,this._topArcVisualElement.visible=s,this._bottomArcVisualElement.visible=s,this._frameLinesVisualElement.visible=s&&h;const l=s&&(a||h);this._leftArcVisualElement.visible=l,this._rightArcVisualElement.visible=l,this._forEachLineVisualElement(n=>{n.width=d?K.frameWidthSelected:K.frameWidthNotSelected,n.renderOccluded=a?ne.OccludeAndTransparent:ne.Occlude}),[this._centralLatitude,this._centralLongitude].forEach(n=>{n.width=2*(d?K.frameWidthSelected:K.frameWidthNotSelected),n.visible=s&&a})},$),M(()=>{const{analysisViewData:{interactive:s,tool:a},_selected:o,visible:h}=this,d=this.view.activeTool,l=!(a!=null&&a.active)&&d instanceof Ye&&d.creating;return{observerVisible:h&&!o&&(!s||((a==null?void 0:a.creating)??!1)||l),color:this._color}},({observerVisible:s,color:a})=>{this._observerVisualElement.visible=s,this._forEachLineVisualElement(o=>o.color=a)},$)])}get _color(){var h,d;const{viewshedComputedData:t,_selected:e,analysisViewData:i}=this;if(t==null)return ie.toUnitRGBA(K.frameColor);const s=((h=i.tool)==null?void 0:h.active)||i.interactive,a=t.viewshed===((d=i.tool)==null?void 0:d.stagedViewshed),o=s&&(e||a)?this.view.effectiveTheme.accentColor:K.frameColor;return ie.toUnitRGBA(o)}get _selected(){const{viewshedComputedData:t,analysisViewData:{selectedViewshedComputedData:e}}=this;return t!=null&&t===e}get _staged(){const{analysisViewData:{tool:t},viewshedComputedData:e}=this;return t!=null&&t.creating&&t.stagedViewshed===(e==null?void 0:e.viewshed)}destroy(){this._observerVisualElement=P(this._observerVisualElement),this._shapeVisualElement=P(this._shapeVisualElement),this._frameLinesVisualElement=P(this._frameLinesVisualElement),this._leftArcVisualElement=P(this._leftArcVisualElement),this._rightArcVisualElement=P(this._rightArcVisualElement),this._topArcVisualElement=P(this._topArcVisualElement),this._bottomArcVisualElement=P(this._bottomArcVisualElement),this._centralLongitude=P(this._centralLongitude),this._centralLatitude=P(this._centralLatitude)}_forEachLineVisualElement(t){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(t)}_forEachVisualElement(t){this._forEachLineVisualElement(t),t(this._observerVisualElement),t(this._shapeVisualElement)}_updateVisualElements(t){const{viewshedComputedData:e,corners:i,arcCenters:s,parallelCenters:a}=t,o=Lt(e.observerRenderSpace);this._observerVisualElement.geometry=e.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(o,i),this._updateFrameArcs(e,i,a),this._updateCentralHelperArcs(e,s)}_updateFrameLines(t,e){this._frameLinesVisualElement.geometry=[[t,e.topLeft],[t,e.topRight],[t,e.bottomLeft],[t,e.bottomRight]]}_updateFrameArcs(t,e,i){const{observerRenderSpace:s,rightVector:a,horizontalFieldOfView:o,tiltedUpVector:h}=t,d=y(o),l=u(),n=S();X(n,d/2,h),q(l,a,n),he(this._leftArcVisualElement,s,e.bottomLeft,e.topLeft,"forward",l),X(n,-d/2,h),J(l,0,0,0),q(l,a,n),he(this._rightArcVisualElement,s,e.bottomRight,e.topRight,"forward",l);const m=o>180?"backward":"forward";he(this._topArcVisualElement,i.top,e.topRight,e.topLeft,m,h),he(this._bottomArcVisualElement,i.bottom,e.bottomRight,e.bottomLeft,m,h)}_updateCentralHelperArcs(t,e){const i=t.observerRenderSpace,s=t.horizontalFieldOfView>=180?"backward":"forward";he(this._centralLatitude,i,e.right,e.left,s,t.tiltedUpVector),he(this._centralLongitude,i,e.top,e.bottom,"forward",t.leftVector)}get test(){}};function he(r,t,e,i,s,a,o=Qt){const h=u();C(h,e,t);const d=we(h),l=u();C(l,i,t),pe(l,l),k(l,l,d);let n=De(h,l);const m=Lt(a);s==="backward"&&(et(m,m),n=-(2*Math.PI-n));const v=[],w=Math.ceil(Math.abs(n)/o),f=S();X(f,n/w,m);const D=u();j(D,h);const O=u();j(O,e);for(let A=0;A<w;A++){const F=u();j(F,O),q(D,D,f),Q(O,t,D);const R=u();j(R,O),v.push([F,R])}r.geometry=v}c([p()],B.prototype,"view",void 0),c([p()],B.prototype,"analysisViewData",void 0),c([p()],B.prototype,"viewshedComputedData",void 0),c([p()],B.prototype,"visible",void 0),c([p()],B.prototype,"_color",null),c([p()],B.prototype,"_selected",null),c([p()],B.prototype,"_staged",null),B=c([se("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],B);const dr=B;let ae=class extends _e{get visible(){return this.analysisViewData.visible}constructor(r){super(r)}initialize(){const r=this.analysisViewData,t=Ze(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:e})=>{const i=new dr({view:this.view,viewshedComputedData:e,analysisViewData:r});return{visualization:i,remove:()=>i.destroy()}});this._viewshedVisualizations=t,this.addHandles([li(t),M(()=>this.visible,e=>this._viewshedVisualizations.forEach(({visualization:i})=>i.visible=e),$)])}get test(){}};c([p({constructOnly:!0})],ae.prototype,"analysisViewData",void 0),c([p({constructOnly:!0,nonNullable:!0})],ae.prototype,"view",void 0),c([p({constructOnly:!0})],ae.prototype,"isDecoration",void 0),c([p()],ae.prototype,"visible",null),ae=c([se("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],ae);var Ke;let V=Ke=class extends _e{constructor(r){super(r),this.observerRenderSpaceOverride=null}get observer(){return this.viewshed.observer??new Qe}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,u())}get target(){const r=this.targetRenderSpace;return this.renderSpaceToPoint(r,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const r=C(u(),this.targetRenderSpace,this.observerRenderSpace);return pe(r,r)}get tiltedUpVector(){const r=te(u(),this.upVector,-y(this.tiltParallelToSurface),this.leftVector);return pe(r,r)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,S())}get upVector(){const r=this._basis;return G(r[8],r[9],r[10])}get northVector(){const r=this._basis;return G(r[4],r[5],r[6])}get leftVector(){const r=this.upVector,t=te(u(),this.northVector,-y(this.heading),r);return pi(t,r,t)}get rightVector(){return et(u(),this.leftVector)}clone(){return new Ke({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}isValid(){return this.viewshed.isValid()}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(r,t,e){const{observerRenderSpace:i,targetRenderSpace:s}=this,a=C(ke,s,i);return te(a,a,-y(t),this.leftVector),te(a,a,-y(r),this.tiltedUpVector),Q(e,a,i)}cornerPoints(r){const t=this.horizontalFieldOfView/2,e=this.verticalFieldOfView/2;this.pointOnSphere(-t,e,r.topLeft),this.pointOnSphere(t,e,r.topRight),this.pointOnSphere(-t,-e,r.bottomLeft),this.pointOnSphere(t,-e,r.bottomRight)}arcCentersPoints(r){const t=this.horizontalFieldOfView/2,e=this.verticalFieldOfView/2;this.pointOnSphere(0,e,r.top),this.pointOnSphere(0,-e,r.bottom),this.pointOnSphere(-t,0,r.left),this.pointOnSphere(t,0,r.right)}parallelCenterPoints(r){const t=this.observerRenderSpace,e=this.farDistanceRenderSpace*Math.sin(y(this.verticalFieldOfView/2)),i=k(ke,this.tiltedUpVector,e);Q(r.top,t,i),C(r.bottom,t,i)}renderSpaceToPoint(r,t){const e=ke;return this.renderCoordsHelper.fromRenderCoords(r,e,t),new Qe(e[0],e[1],e[2],t)}_pointToRenderSpace(r,t){const e=mi(r.toArray());return this.renderCoordsHelper.toRenderCoords(e,r.spatialReference,t),t}_computeTargetRenderSpace(r){const{leftVector:t,northVector:e,upVector:i}=this,s=this.farDistanceRenderSpace,a=u();return k(a,e,s),te(a,a,-y(this.heading),i),te(a,a,-y(this.tiltParallelToSurface),t),Q(a,r,a),a}};c([p()],V.prototype,"renderCoordsHelper",void 0),c([p()],V.prototype,"viewshed",void 0),c([p()],V.prototype,"observerRenderSpaceOverride",void 0),c([p()],V.prototype,"observer",null),c([p()],V.prototype,"effectiveObserverRenderSpace",null),c([p()],V.prototype,"effectiveObserver",null),c([p()],V.prototype,"effectiveTargetRenderSpace",null),c([p()],V.prototype,"farDistance",null),c([p()],V.prototype,"farDistanceRenderSpace",null),c([p()],V.prototype,"heading",null),c([p()],V.prototype,"tilt",null),c([p()],V.prototype,"feature",null),c([p()],V.prototype,"tiltParallelToSurface",null),c([p()],V.prototype,"horizontalFieldOfView",null),c([p()],V.prototype,"verticalFieldOfView",null),c([p()],V.prototype,"observerRenderSpace",null),c([p()],V.prototype,"target",null),c([p()],V.prototype,"targetRenderSpace",null),c([p()],V.prototype,"targetDirection",null),c([p()],V.prototype,"tiltedUpVector",null),c([p()],V.prototype,"_basis",null),c([p()],V.prototype,"upVector",null),c([p()],V.prototype,"northVector",null),c([p()],V.prototype,"leftVector",null),c([p()],V.prototype,"rightVector",null),c([p()],V.prototype,"isValid",null),c([p()],V.prototype,"metersPerUnit",null),V=Ke=c([se("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],V);const ke=u();let Z=class extends Ts{constructor(){super(...arguments),this.sectionAngles=Ds()}get sectionAnglesDeg(){return mt(this.sectionAngles.map(t=>fe(t)))}set sectionAnglesDeg(t){this.sectionAngles=mt(t.map(e=>y(e)))}get projectionMatrix(){return W(S(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const t=this.sectionAngles[0],e=this.sectionAngles[1],i=this.sectionAngles[2],s=this.sectionAngles[3];Ge(t<=e),Ge(i<=s);const a=2*Math.tan(this.fovX/2),o=2*Math.tan(this.fovY/2),h=Math.tan(t),d=Math.tan(e),l=Math.tan(i),n=d-h,m=Math.tan(s)-l,v=a/n,w=o/m,f=-(h+n/2)/a*2,D=-(l+m/2)/o*2,O=S();Ve(O,[f,D,0]);const A=S();Ae(A,[v,w,1]);const F=S();return W(F,A,O)}get _sectionRatioX(){const t=Math.tan(this.sectionAngles[0]),e=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(e-t)/i)}setViewport(t,e){const i=e*this._sectionRatioX;return this.viewport=[t[0],t[1],i,e],i}};c([p()],Z.prototype,"sectionAngles",void 0),c([p()],Z.prototype,"sectionAnglesDeg",null),c([p()],Z.prototype,"projectionMatrix",null),c([p()],Z.prototype,"sectionMatrix",null),c([p()],Z.prototype,"_sectionRatioX",null),Z=c([se("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Z);class pr{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(t){const e=t?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*e}textureResizeModulo(t){return Math.ceil(t/this.textureSizeMultiple)*this.textureSizeMultiple}}const je=["front","left","right","back","top","bottom"];function ur(r){return!["top","bottom"].includes(r)}let mr=class{constructor(t){this._fbos=t,this._minTextureSize=16,this._faces={},this._width=0,this._height=0,this.settings=new pr,this._maxTextureSize=Math.min(hi("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}get depthTexture(){var t;return(t=this._handle)==null?void 0:t.getTexture()}get ready(){return this.depthTexture!=null&&this._width!==0&&this._height!==0}get nearFar(){const t=this.faces;return t.length===0?null:t[0].nearFar}get numActiveFaces(){const t=this._faces;let e=0;return Object.keys(t).forEach(i=>{t[i]&&(e+=1)}),e}get faces(){const t=this._faces,e=[];for(const i of je){const s=t[i];s&&e.push(s)}return e}get atlasRegions(){return this.faces.map(t=>[t.x/this._width,(t.x+t.width)/this._width,t.y/this._height,(t.y+t.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(t=>t.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(t=>t.viewMatrix)}_setupFaceCamera(t,e,i,s){const{effectiveObserverRenderSpace:a,tiltedUpVector:o,targetRenderSpace:h,farDistanceRenderSpace:d,horizontalFieldOfView:l,verticalFieldOfView:n}=e,m=u();C(m,h,a);const v=u(),w=u(),f=(g,_)=>{const x=u(),rt=S();return X(rt,g,_),q(x,m,rt),Q(x,a,x),x};let D,O=o;const A=Math.min(90,l),F=Math.min(90,Math.max(0,(l-90)/2));let R=-45,z=45,L=-45,N=45;if(ur(t)){const g=_=>Te(_,-45,45);L=g(-n/2)-this.settings.toleranceBottomTop,N=g(+n/2)+this.settings.toleranceBottomTop}switch(t){case"front":D=h,R=-A/2,z=A/2;break;case"left":D=f(Math.PI/2,o),R=45-F;break;case"right":D=f(-Math.PI/2,o),z=-45+F;break;case"top":D=Q(v,a,o),O=et(w,m);break;case"bottom":D=C(v,a,o),O=m;break;case"back":D=f(Math.PI,o)}const Y=new Z({center:D,eye:a,up:O,far:d});Y.sectionAnglesDeg=[R-this.settings.toleranceSides,z+this.settings.toleranceSides,L,N],Y.fovY=Math.PI/2;const b=Y.setViewport(i,s);return this._faces[t]=Y,b}isActive(t){return this._computeActiveFaces(t).size>0}_computeActiveFaces(t){const e=new Set,{horizontalFieldOfView:i,verticalFieldOfView:s}=t,a=-s/2,o=s/2;return i===0||s===0||(a<=45&&o>=-45&&e.add("front"),i>90&&(e.add("left"),e.add("right")),i>270&&e.add("back"),o>45-this.settings.toleranceBottomTop&&e.add("top"),a<-45+this.settings.toleranceBottomTop&&e.add("bottom")),e}_computeBaseTextureSize(t,e,i,s){const a=e/t.pixelRatio,o=this.settings.textureSizeModifier(i),h=Math.max(t.fullWidth,t.fullHeight),d=os(Math.floor(h*a*o)),l=Math.floor(this._maxTextureSize/s),n=Te(d,this._minTextureSize,l);return as(n)}_ensureFBO(t){var a,o,h,d,l;const e=this._width,i=this._height;((o=(a=this._handle)==null?void 0:a.fbo)==null?void 0:o.width)===e&&((d=(h=this._handle)==null?void 0:h.fbo)==null?void 0:d.height)===i||((l=this._handle)==null||l.release(),this._handle=this._fbos.acquire(e,i,"viewshed shadow map",pt.RGBA4));const s=t?ut.DEPTH_STENCIL_TEXTURE:ut.DEPTH16_BUFFER;this._handle.acquireDepth(s)}clearFBO(t){var i;const e=this._fbos.rctx;this._ensureFBO(t),e.bindFramebuffer((i=this._handle)==null?void 0:i.fbo),e.setClearColor(1,1,1,1),e.clear(vt.COLOR|vt.DEPTH)}dispose(){this._handle=si(this._handle)}start(t,e,i,s,a=!1){this._faces={};const o=this._computeActiveFaces(e),h=o.size;if(h===0)return!1;const d=this._computeBaseTextureSize(t,s,i,h);let l=0,n=0,m=0;return je.filter(v=>o.has(v)).forEach(v=>{const w=vr(v,h);w>n&&(m=Math.max(m,l),l=0),n=w;const f=w*d;l+=this._setupFaceCamera(v,e,[l,f],d)}),m=Math.max(m,l),this._width=this.settings.textureResizeModulo(m),this._height=wr(h)*d,this.clearFBO(a),!0}finish(){var t;(t=this._handle)==null||t.detachDepth()}get test(){return{faces:this._faces,faceTypes:je,width:this._width,height:this._height,getFBO:()=>this._fbos.acquire(this._width,this._height,"viewshed shadow map",pt.RGBA4)}}};function vr(r,t){if(t<4)return 0;const e=r==="front"||r==="left";return t===4?e?0:1:e||r==="right"?0:1}function wr(r){return r<4?1:2}class fr extends Ps{constructor(){super(...arguments),this.localOrigin=vi()}}function gr(r){r.include(ns),r.fragment.uniforms.add(new Je("inverseViewMatrix",(t,e)=>{const i=Ut(S(),e.camera.viewMatrix,t.localOrigin);return kt(i,i)})).code.add(ye`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}let st=class extends fr{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=ot.flat(),this.viewMatrices=ot.flat(),this.volumeOffset=0}};function Kt(){const r=new ls,t=r.fragment;return r.include(hs),r.include(gr),r.include(cs),r.include(Ss),t.include(ds),t.include(Fs),r.include(ps),t.uniforms.add(new Ce("depthTexture",(e,i)=>{var s;return(s=i.depth)==null?void 0:s.attachment}),new Je("inverseProjectionMatrix",(e,i)=>i.camera.inverseProjectionMatrix),new Je("inverseViewNormalMatrix",(e,i)=>kt(_r,i.camera.viewInverseTransposeMatrix)),new He("viewshedObserverOffset",e=>e.observerOffset),new He("viewshedTargetVector",e=>e.targetVector),new He("viewshedUpVector",e=>e.upVector),new Fe("viewshedFOVs",e=>e.fovs),new Fe("viewshedHeadingAndTilt",e=>e.headingAndTilt),new Fe("viewshedNearFar",e=>e.shadowMap.nearFar??[1,100]),new Cs("viewshedVolumeOffset",e=>e.volumeOffset),new Ce("viewshedShadowMap",e=>e.shadowMap.depthTexture),new wt("viewshedProjectionMatrices",e=>e.projectionMatrices,6),new wt("viewshedViewMatrices",e=>e.viewMatrices,6),new us("viewshedNumFaces",e=>e.shadowMap.numActiveFaces),new ms("viewshedAtlasRegions",e=>e.shadowMap.atlasRegions.flat(),24),new Ce("normalMap",(e,i)=>e.normals),new vs("useNormalMap",(e,i)=>e.normals!=null)),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add(ye`vec3 normalFromTexture() {
vec4 norm4 = texture(normalMap, uv);
vec3 nNormal = vec3(-1.0) + 2.0 * norm4.xyz;
return normalize((inverseViewNormalMatrix * vec4(nNormal, 1.0)).xyz);
}`).code.add(ye`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return rgba4ToFloat(textureAtlasLookup(viewshedShadowMap, uv, atlasRegion));
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec3 viewingDir = normalize(localPosition);
if(useNormalMap) {
vec3 normal = normalFromTexture();
return dot(normal, viewingDir);
}
vec3 cameraSpacePosition = reconstructPosition(gl_FragCoord.xy, linearDepth);
vec3 normal = normalFromDepth(depthTexture, cameraSpacePosition, gl_FragCoord.xy, uv);
normal = (inverseViewNormalMatrix * vec4(normal, 1.0)).xyz;
return dot(normal, viewingDir);
}`),t.main.add(ye`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
if (cosAngle > -0.01) {
fragColor = occludedColor;
}`),r}const _r=S(),Vr=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:st,build:Kt},Symbol.toStringTag,{value:"Module"}));class Ft extends ws{constructor(t,e,i){super(t,e,new fs(Vr,()=>$s(()=>Promise.resolve().then(()=>Dr),void 0,import.meta.url)),i)}initializePipeline(){return Mi({colorWrite:yi,blending:Si})}}let U=class extends gs{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(r=>yr(this.view,r))}constructor(r){super(r),this._techniques=null,this._passParameters=new st,this._viewsheds=new ys,this._shadowMap=null,this.consumes={required:[Ee.VIEWSHED],optional:["normals"]},this.produces=Ee.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new mr(this.fboCache),this.addHandles([M(()=>this.view.resolutionScale,r=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=r)},$),Oe(()=>!this.hasViewsheds,()=>{var r;return(r=this._shadowMap)==null?void 0:r.dispose()}),Oe(()=>this.view._stage.renderView.techniques,r=>this._techniques=r,$),M(()=>this._viewshedsInView.map(r=>[r.observerRenderSpace,r.heading,r.tilt,r.farDistance,r.horizontalFieldOfView,r.verticalFieldOfView]),()=>this.requestRender(nt.UPDATE),zt)])}destroy(){this._shadowMap=ri(this._shadowMap)}precompile(){var r,t;if(this.hasViewsheds){(r=this._techniques)==null||r.precompile(Ft);for(const e of this._viewshedsInView)if((t=this._shadowMap)!=null&&t.isActive(e))return void this.view._stage.renderer.precompileViewshedShadowMap()}}render(r){var o,h,d,l;const t=this.bindParameters,e=this.renderingContext,i=r.find(({name:n})=>n===Ee.VIEWSHED);if(!this.hasViewsheds||!t.depth)return i;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=(o=r.find(({name:n})=>n==="normals"))==null?void 0:o.getTexture();const s=(h=this._techniques)==null?void 0:h.acquire(Ft);if(!(s!=null&&s.compiled))return this.requestRender(nt.UPDATE),s==null||s.release(),i;const a=this.view._stage.renderer.isFeatureEnabled(Os.HighResolutionViewshed);for(const n of this._viewshedsInView){if(!this._renderShadowCubeMap(t,n,a)||!((d=this._shadowMap)!=null&&d.ready))continue;const m=this._setupViewshedParameters(n,t.camera);e.bindTechnique(s,t,m),e.bindFramebuffer(i.fbo),e.screen.draw()}return s.release(),(l=this.shadowMap)==null||l.dispose(),i}updateViewsheds(r){const t=this._viewsheds,{removes:e,adds:i}=r;if(e&&(Array.isArray(e)?t.removeMany(e):t.remove(e)),i)if(Array.isArray(i)){const s=i.filter(a=>!t.includes(a));t.addMany(s)}else t.includes(i)||t.add(i)}_renderShadowCubeMap(r,t,e){const i=this._shadowMap;if(!i)return!1;const s=this.view.basemapTerrain.hasStencilEnabledExtents,a=i.start(r.camera,t,e,this._contentPixelRatio,s);return a&&i.faces.forEach(o=>this.view._stage.renderer.renderViewshedShadowMap(o)),i.finish(),a}_setupViewshedParameters(r,t){var d;const e=this._shadowMap;if(!e)return this._passParameters;const i=this._passParameters,s=r.effectiveObserverRenderSpace;i.localOrigin=s,i.observerOffset=C(Or,r.observerRenderSpace,r.effectiveObserverRenderSpace),i.fovs=[y(r.horizontalFieldOfView),y(r.verticalFieldOfView)],i.headingAndTilt=[y(r.heading),y(r.tiltParallelToSurface)],i.upVector=r.tiltedUpVector;const a=br(r.targetRenderSpace,s);i.targetVector=a;const o=new Array,h=new Array;for(let l=0;l<e.numActiveFaces;l++)Ut(We,e.viewshedViewMatrices[l],s),o.push(...We),Mr(e.viewshedProjectionMatrices[l],We,Et),h.push(...Et);return i.viewMatrices=o,i.projectionMatrices=h,i.volumeOffset=((d=this.selectedViewshed)==null?void 0:d.call(this))===r.viewshed?Sr(r,this.view,t.eye):0,i}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function br(r,t){const e=u();return C(e,r,t)}function Mr(r,t,e){const i=G(.5,.5,.5);return Ve(e,i),bi(e,e,i),W(e,e,r),W(e,e,t),e}function yr(r,t){const e=qi(t.observerRenderSpace,t.farDistanceRenderSpace);return!!r.ready&&r.frustum.intersectsSphere(e)}function Sr(r,t,e){if(r==null)return 0;const{observerRenderSpace:i,targetRenderSpace:s}=r,a=at(e,i)>at(e,s)?r.observer:r.target;return t.pixelSizeAt(a)}c([p()],U.prototype,"_techniques",void 0),c([p()],U.prototype,"selectedViewshed",void 0),c([p()],U.prototype,"shadowMap",null),c([p()],U.prototype,"hasViewsheds",null),c([p()],U.prototype,"_contentPixelRatio",null),c([p()],U.prototype,"_viewshedsInView",null),c([p()],U.prototype,"consumes",void 0),c([p()],U.prototype,"produces",void 0),U=c([se("esri.views.3d.webgl-engine.lib.Viewshed")],U);const Or=u(),We=S(),Et=S();let E=class extends _i(_e){constructor(r){super(r),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this._placementTask=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(r){this._unselectOtherViewsheds(r),this._selectedViewshed=r}get selectedViewshedComputedData(){var r;return(r=this.tool)==null?void 0:r.selectedViewshedComputedData}initialize(){const r=this.view;this._viewshedRenderer=new U({view:r,selectedViewshed:()=>{var t;return this.selectedViewshed??((t=this.tool)==null?void 0:t.stagedViewshed)}}),this._intersector=bs(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=Ms.MIN,this.viewshedComputedDataHandles=Ze(()=>this.analysis.viewsheds,t=>{const e=new V({renderCoordsHelper:r.renderCoordsHelper,viewshed:t}),i=Symbol();return this.addHandles([M(()=>{var s;return{valid:e.isValid(),canProject:fi((s=e.observer)==null?void 0:s.spatialReference,this.view.spatialReference)||gi()}},({valid:s,canProject:a},o)=>{this.visible&&(s&&a?this._addViewshedsToRenderer(e):o!=null&&o.valid&&(o!=null&&o.canProject)&&this._removeViewshedsFromRenderer(e),a||Vi(this.analysis,e.observer.spatialReference,ci.getLogger(this)))},$),M(()=>[r.state.camera,r.slicePlane,e.viewshed.observer,e.targetRenderSpace,e.verticalFieldOfView,e.horizontalFieldOfView,e.feature],()=>{this._updateObserverFromFeature(r,e)},$)]),{viewshedComputedData:e,remove:()=>{this.removeHandles(i),this._removeViewshedsFromRenderer(e),e.destroy()}}}),this._analysisVisualization=new ae({view:r,analysisViewData:this,isDecoration:!this.parent}),this.addHandles([M(()=>this.visible,t=>{const e=this.viewshedComputedDataHandles;if(e==null)return;t||(this.selectedViewshed=null);const i=e.map(s=>s.viewshedComputedData).filter(s=>s.isValid()).toArray();t?this._addViewshedsToRenderer(i):this._removeViewshedsFromRenderer(i)}),M(()=>r.renderCoordsHelper,t=>{var e;(e=this.viewshedComputedDataHandles)==null||e.forEach(({viewshedComputedData:i})=>i.renderCoordsHelper=t)}),xs(this,Ye),Oe(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},ce)])}destroy(){this._placementTask=Se(this._placementTask),As(this),this._analysisVisualization=P(this._analysisVisualization);const r=this.viewshedComputedDataHandles;r!=null&&this._removeViewshedsFromRenderer(r.map(t=>t.viewshedComputedData).toArray())}async createViewsheds(r){return this._placementTask=Se(this._placementTask),this._placementTask=Rs(this,r),this.tool!=null&&this.tool.createViewsheds(),await this._placementTask.promise}_addViewshedsToRenderer(r){this._viewshedRenderer.updateViewsheds({adds:r})}_removeViewshedsFromRenderer(r){this._viewshedRenderer.updateViewsheds({removes:r})}_updateObserverFromFeature(r,t){const e=t.observerRenderSpace,i=t.targetRenderSpace,s=j(u(),e),a={observer:e,observerSurfaceNormal:null,observerAdjusted:s,observerFeatureId:Zt(t.feature),target:i,targetSurfaceNormal:null,targetAdjusted:j(u(),i),targetFeatureId:null};ei(r,this._intersector,a,o=>Math.min(o,.05*t.farDistanceRenderSpace)),t.observerRenderSpaceOverride=ui(s,e)?null:s}_unselectOtherViewsheds(r){if(r!=null)for(const t of this.view.tools.items)t!==this.tool&&t instanceof Ye&&(t.analysisViewData.selectedViewshed=null)}get test(){}};c([p({readOnly:!0})],E.prototype,"type",void 0),c([p({constructOnly:!0,nonNullable:!0})],E.prototype,"analysis",void 0),c([p()],E.prototype,"tool",void 0),c([p()],E.prototype,"_selectedViewshed",void 0),c([p()],E.prototype,"selectedViewshed",null),c([p()],E.prototype,"selectedViewshedComputedData",null),c([p()],E.prototype,"viewshedComputedDataHandles",void 0),c([p()],E.prototype,"_analysisVisualization",void 0),c([p()],E.prototype,"_placementTask",void 0),c([p()],E.prototype,"_viewshedRenderer",void 0),E=c([se("esri.views.3d.analysis.ViewshedAnalysisView3D")],E);const Lh=E,Dr=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:st,build:Kt},Symbol.toStringTag,{value:"Module"}));export{Lh as default};
