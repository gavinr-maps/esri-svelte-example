import{r as s}from"./tslib.es6-B3Jf3DVX.js";import{V as u}from"./Collection-CEdjem1-.js";import{b as w,n as g,r as T,m as h,a as _}from"./subclass-BZA_h8Db.js";import{S}from"./MultiOriginJSONSupport-B5nfqtQh.js";import{p as D,d as f,N as L,E as v}from"./Accessor-BLX9ikPh.js";import{watch as E,sync as N}from"./reactiveUtils-C5zUhJQJ.js";import{Y as A,V as C}from"./assets-C43MgM-v.js";import{n as $}from"./uuid-fwrPAdZb.js";import{o as k,r as I}from"./writer-DNAwXnhG.js";import R from"./Layer-CVt7Hb5J.js";import{u as c,c as b,E as G,F as O,R as U}from"./KnowledgeGraphSublayer-BsOhlWzV.js";import{l as F}from"./ArcGISService-B5qxetOY.js";import{l as j}from"./BlendLayer-CXM4n_Ge.js";import{e as P}from"./CustomParametersMixin-B4u7wiBT.js";import{b as z}from"./OperationalLayer-CVyVfSPu.js";import{j as x}from"./PortalLayer-CKja4bdW.js";import{f as K}from"./RefreshableLayer-D7lXUJRS.js";import{t as V}from"./ScaleRangeLayer-Bb8Ig1Hz.js";import{y as H}from"./commonProperties-CPyIG_-u.js";import{F as B}from"./knowledgeGraphService-9oFvDyoC.js";import{p as Y,m as M}from"./persistableUrlUtils-fa1mAujs.js";import"./Evented-BHRw9x22.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./asyncUtils-CWX51uTe.js";import"./index-Bh2oEzTI.js";import"./geometry-D964gYQX.js";import"./Extent-Bf3YTe7m.js";import"./Point-Cg0-ChZE.js";import"./cast-Bjksrh93.js";import"./jsonMap-0cxwUWs2.js";import"./Polyline-D9YkgmM_.js";import"./mathUtils-C4_ghTv4.js";import"./Identifiable-B1UbsKNt.js";import"./Loadable-BabW5Xcc.js";import"./Promise-B2Hu02L7.js";import"./TimeExtent-DocT5yPf.js";import"./timeUtils-8fb_2oAt.js";import"./date-DlqISzcw.js";import"./locale-C9TlLpzi.js";import"./fieldUtils-tmQlKvWo.js";import"./intl-CChhNOV8.js";import"./messages-OmQvZhAg.js";import"./projection-B971H0Re.js";import"./vec3f64-BLpZdpfb.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";import"./featureConversionUtils-D14h8iad.js";import"./aaBoundingBox-BE7cC1jD.js";import"./jsonUtils-CEfjT-BK.js";import"./OptimizedFeature-6cJ-QFG5.js";import"./OptimizedGeometry-BF8iz5FO.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./Graphic-DsxsIjhH.js";import"./PopupTemplate-BHMhS05j.js";import"./Clonable-D3rtuBWg.js";import"./enumeration-Ba5njXdz.js";import"./Color-BCS62Hs5.js";import"./colorUtils-0bJDPow9.js";import"./ActionToggle-iT4slXc7.js";import"./symbols-CNimns--.js";import"./TextSymbol-D8QO_KUV.js";import"./screenUtils-_ZIvrt5o.js";import"./materialUtils-DarhapKC.js";import"./opacityUtils-C68Tlu6_.js";import"./collectionUtils-D_lHIu88.js";import"./Portal-C10FKnaA.js";import"./GraphicsLayer-i3FeUJ_n.js";import"./GraphicsCollection-FfahqxsR.js";import"./ElevationInfo-CA5m_tHv.js";import"./unitConversionUtils-BMfW9yAe.js";import"./lengthUtils-DL1-FDQQ.js";import"./jsonUtils-CSnQD004.js";import"./parser-CTsgEym6.js";import"./utils-93yNk4Xc.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-GpOFENPA.js";import"./common-DQOJ18NT.js";import"./GraphQueryStreaming-BltM_QD2.js";import"./Query-5Xpquc1r.js";import"./DataLayerSource-BKkswDvG.js";import"./Field-ybkHhtnK.js";import"./fieldType-BuzM0UHS.js";import"./FullTextSearch-Csd1Hktu.js";import"./ClassBreaksRenderer-BuHwSyVK.js";import"./UniqueValueRenderer-BQtAHUSo.js";import"./diffUtils-BP7jmOAy.js";import"./colorRamps-pKd7I5WZ.js";import"./SizeVariable-936USOrb.js";import"./sizeVariableUtils-Cmcuvw-4.js";import"./visualVariableUtils-DX1kS9Se.js";import"./compilerUtils-Dw3R0f-Z.js";import"./ColorStop-Dk3U5tCk.js";import"./jsonUtils-Ds2Sqto-.js";import"./layerUtils-BrNoooE9.js";import"./defaults-DZ1kfMRx.js";import"./defaultsJSON-GKolV7NZ.js";import"./RendererLegendOptions-B-4se3aU.js";import"./styleUtils-BYTm14n3.js";import"./jsonUtils-DxpLMo6d.js";import"./LRUCache-B_PHMSGm.js";import"./MemCache-Dx1v3xLC.js";import"./Version-BSlAgupz.js";import"./FieldsIndex-DpwHKAMX.js";import"./UnknownTimeZone-BkowvBs8.js";import"./OverrideHelper-ti072FkP.js";import"./colorUtils-aL8wj-8G.js";import"./vec42-YcqnINSP.js";import"./vec4f64-o2zAXfmz.js";import"./utils-D2PLyMFF.js";import"./enums-CmIX1y88.js";import"./quantizationUtils-uj_P09aO.js";import"./HeatmapColorStop-BJc5nbwr.js";import"./heatmapUtils-Dwiv9IEa.js";import"./SimpleRenderer-BV2L9G_n.js";import"./workers-D4HfeYKj.js";import"./Queue-yu3bZ02p.js";import"./FeatureStore-Dr0GQdbp.js";import"./BoundsStore-BhV7QrYA.js";import"./PooledRBush-D7s4d_Fs.js";import"./quickselect-QQC62dOK.js";import"./timeSupport-T1g9-JyG.js";import"./queryUtils-O-WFKoZd.js";import"./normalizeUtils-EVmAQ-ak.js";import"./normalizeUtilsCommon-dT81xWiM.js";import"./utils-6jMaHUrH.js";import"./utils-Bema0iXE.js";import"./json-Wa8cmqdu.js";import"./optimizedFeatureQueryEngineAdapter-BOPMFOve.js";import"./centroid-DdLmOD72.js";import"./QueryEngine-DrzbS-Dm.js";import"./WhereClause-BNiy948d.js";import"./TimeOnly-DOn_Hy89.js";import"./QueryEngineCapabilities-DjYb9CEb.js";import"./utils-Bh2cHa3t.js";import"./utils-BwQ00KBJ.js";import"./Basemap-DVYOaWHz.js";import"./loadAll-B6mYSptb.js";import"./PortalItem-DzgXrpyc.js";import"./writeUtils-Dz7BsE1e.js";import"./utils-rwwdQ1Ui.js";import"./ClassBreaksDefinition-CS8Z_VNX.js";import"./SnappingCandidate-O5eRSE6e.js";import"./Scheduler-CJu5awNf.js";import"./signal-D4lghLjV.js";import"./debugFlags-BF6Z0j0F.js";import"./clientSideDefaults-BCN5Jkqv.js";import"./capabilities-Y9lFlGVh.js";import"./fieldProperties-Cgxj08ZE.js";import"./FeatureEffectLayer-CpM66wLd.js";import"./FeatureEffect-BEzQmzeC.js";import"./FeatureFilter-BMHRQSxq.js";import"./FeatureReductionLayer-Ddbk727V.js";import"./layerContainerType-C5CzMsLd.js";import"./FeatureReductionSelection-7vaL4DYT.js";import"./featureLayerUtils-DBsQMhTm.js";import"./featureQueryAll-DnVoEjkM.js";import"./AttachmentQuery-BUlkjzkx.js";import"./RelationshipQuery-DPPNeuLK.js";import"./labelingInfo-DYPSPZCH.js";import"./labelUtils-B8petyBk.js";import"./MD5-C9MwAd2G.js";import"./OrderedLayer-C5VLMHgA.js";import"./OrderByInfo-IYmS1EXF.js";import"./TemporalLayer-Dpq2hKKV.js";import"./TimeInfo-LUiaSFyX.js";import"./TimeInterval-CNlkea1s.js";import"./FeatureSet-BHEkYP03.js";import"./popupUtils-BBuPGAHd.js";import"./arcgisLayerUrl-BX1FE5Hm.js";import"./portalItemUtils-BzVoFAku.js";import"./AttributeTableTemplate-BZeVyq-j.js";let a=class extends j(V(K(F(z(x(S(P(R)))))))){constructor(t){super(t),this._graphTypeLookup=new Map,this._namedTypesModified=!1,this.dataManager=null,this.definitionSetMap=null,this.knowledgeGraph=null,this.layers=new(u.ofType(c)),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="KnowledgeGraphLayer",this.sublayerIdsCache=new Map,this.tables=new(u.ofType(c)),this.type="knowledge-graph",this.url=null,this.addHandles(E(()=>this.layers.concat(this.tables),(e,i)=>this._handleSublayersChange(e,i),N))}load(t){return this.addResolvingPromise(this._doLoad(t)),Promise.resolve(this)}async _doLoad(t){try{await this.loadFromPortal({supportedTypes:["Knowledge Graph Layer"]},t)}catch(e){D(e)}await this._fetchMetadata(),await this._initializeLayerProperties(),this.loadLayerAssumingLocalCache(),await b(this)}async _fetchMetadata(){if(!this.url)throw new w("knowledge-graph:missing-url","KnowledgeGraphLayer must be created with a url");const t=await B(this.url);this.knowledgeGraph=t,this._forEachGraphType(e=>{e.name&&this._graphTypeLookup.set(e.name,e)})}async _initializeLayerProperties(){this.originIdOf("inclusionModeDefinition")===f.USER?this._validateInclusionModeDefinition():await this._initializeInclusionModeDefinition(),this._setMemberTypes(),this.dataManager=new G({knowledgeGraph:this.knowledgeGraph,inclusionModeDefinition:this.inclusionModeDefinition})}async _initializeInclusionModeDefinition(){const t=this.definitionSetMap?await O(this.definitionSetMap,!0):{generateAllSublayers:!0,namedTypeDefinitions:new Map};[...this.layers.toArray(),...this.tables.toArray()].forEach(e=>{const i=this._graphTypeLookup.get(e.graphTypeName);i&&!t.namedTypeDefinitions.has(i.name)&&t.namedTypeDefinitions.set(i.name,{useAllData:!0})}),this.setAtOrigin("inclusionModeDefinition",t,L(this.originIdOf("definitionSetMap")))}_validateInclusionModeDefinition(){const{inclusionModeDefinition:t}=this;if(!t)return;const{namedTypeDefinitions:e}=t;if((e==null?void 0:e.size)>0)e.forEach((i,o)=>{const r=this._graphTypeLookup.get(o);if(!r)return g.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't in the data model and will be removed`),void e.delete(o);r.type!=="relationship"&&r.type!=="entity"&&(g.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't properly modeled and will be removed`),e.delete(o))});else if(!t.generateAllSublayers)throw new w("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined")}_setMemberTypes(){var r,p;let t=[],e=[];const{inclusionModeDefinition:i}=this,o=i==null?void 0:i.namedTypeDefinitions;!i||i.generateAllSublayers?(t=((r=this.knowledgeGraph.dataModel)==null?void 0:r.entityTypes)??[],e=((p=this.knowledgeGraph.dataModel)==null?void 0:p.relationshipTypes)??[]):o&&o.size>0&&o.forEach((n,d)=>{const m=this._graphTypeLookup.get(d);switch(m==null?void 0:m.type){case"relationship":e.push(m);break;case"entity":t.push(m)}}),this.memberEntityTypes=t,this.memberRelationshipTypes=e}_forEachGraphType(t){var e,i;[...((e=this.knowledgeGraph.dataModel)==null?void 0:e.entityTypes)??[],...((i=this.knowledgeGraph.dataModel)==null?void 0:i.relationshipTypes)??[]].forEach(o=>{t(o)})}_refreshNamedTypes(){this._namedTypesModified=!0;for(const t of this.layers)t.emit("refresh",{dataChanged:!0});for(const t of this.tables)t.emit("refresh",{dataChanged:!0})}async _handleNewRecords(t){const e=[];this.dataManager.addToLayer(t);for(const i of t)this.sublayerIdsCache.has(i.typeName)||(this.sublayerIdsCache.set(i.typeName,new Set),e.push(i.typeName)),this.sublayerIdsCache.get(i.typeName).add(i.id);for(const i of e){const o=this._graphTypeLookup.get(i);o&&(this._addSublayer(o),o.type==="entity"?this.dataManager.entityTypeNames.add(i):this.dataManager.relationshipTypeNames.add(i),this.dataManager.sublayerCaches.set(i,new Map))}await b(this,e),this._refreshNamedTypes()}_createSublayers(t,e,i){t.forEach(o=>{const r=this._createSublayer(o);i(r)&&e.push(r),this._updateSublayerCaches(o)})}_addSublayer(t){const e=this._createSublayer(t);return e.geometryType?this.layers.push(e):this.tables.push(e),e}_createSublayer(t){return new c({objectType:t,parentCompositeLayer:this,graphType:t.type})}_updateSublayers(t,e){e.forEach(i=>{i.parentCompositeLayer=this;const o=t.find(r=>r.type===i.graphType&&r.name===i.graphTypeName);o&&(i.objectType=o,this._updateSublayerCaches(o))})}_updateSublayerCaches(t){const e=this.dataManager.sublayerCaches;e.has(t.name)||e.set(t.name,new Map)}_saveUrlAsNewResource(t,e,i,o){t[e]="<pending>",i.pendingOperations.push(q(this.inclusionModeDefinition).then(r=>{const p=J(o);t[e]=p.itemRelativeUrl,i.toAdd.push({resource:p,content:{type:"blob",blob:r},compress:!1,finish:n=>{this.definitionSetMap=n.url}})}))}_displaysAllRecords(t){for(const[,{useAllData:e}]of t.namedTypeDefinitions)if(!e)return!1;return!0}_handleSublayersChange(t,e){e&&(e.forEach(i=>{i.parent=null}),this.removeHandles("sublayers-owner")),t&&(t.forEach(i=>{i.parent=this}),this.addHandles([t.on("after-add",({item:i})=>{i.parent=this}),t.on("after-remove",({item:i})=>{i.parent=null})],"sublayers-owner"))}readDefinitionSetMap(t,e,i){return Y(t,i)}writeDefinitionSetMap(t,e,i,o){const r=o==null?void 0:o.portalItem,p=o==null?void 0:o.resources,n=v(o==null?void 0:o.origin);if(!r||!p||n==null)return void(t&&(e[i]=M(t,o)));const{inclusionModeDefinition:d}=this;if(!d||this._displaysAllRecords(d))return void(this.definitionSetMap=null);const m=this.originIdOf("inclusionModeDefinition");if(m===f.USER||this._namedTypesModified||n<m)this._saveUrlAsNewResource(e,i,p,r);else if(n===m&&t){const y=M(t,o);A(y)?this._saveUrlAsNewResource(e,i,p,r):e[i]=y}}set inclusionModeDefinition(t){this.loadStatus!=="loaded"&&this.loadStatus!=="failed"?this._set("inclusionModeDefinition",t):g.getLogger(this).error("#inclusionModeDefinition","inclusionModeDefinition cannot be changed after the layer is loaded.")}loadLayerAssumingLocalCache(){var e,i;const t=[...this.memberEntityTypes,...this.memberRelationshipTypes];this.originIdOf("layers")===f.DEFAULTS?this._createSublayers(t,this.layers,o=>!!o.geometryType):this._updateSublayers(t,this.layers),this.originIdOf("tables")===f.DEFAULTS?this._createSublayers(t,this.tables,o=>!o.geometryType):this._updateSublayers(t,this.tables),(i=(e=this.dataManager.inclusionModeDefinition)==null?void 0:e.namedTypeDefinitions)==null||i.forEach((o,r)=>{var n;const p=T(this.sublayerIdsCache,r,()=>new Set);(n=o.members)==null||n.forEach(d=>{p.add(d.id)})})}async addRecords(t){await this._handleNewRecords(t)}async removeRecords(t){var i,o,r,p,n,d,m,y;const e=[];for(const l of t)((r=(o=(i=this.dataManager.inclusionModeDefinition)==null?void 0:i.namedTypeDefinitions)==null?void 0:o.get(l.typeName))==null?void 0:r.useAllData)===!1&&((m=(d=(n=(p=this.dataManager.inclusionModeDefinition)==null?void 0:p.namedTypeDefinitions)==null?void 0:n.get(l.typeName))==null?void 0:d.members)!=null&&m.has(l.id))&&e.push(l);this.dataManager.removeFromLayer(e);for(const l of e)(y=this.sublayerIdsCache.get(l.typeName))==null||y.delete(l.id);return this._refreshNamedTypes(),e}};s([h()],a.prototype,"dataManager",void 0),s([h({json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],a.prototype,"definitionSetMap",void 0),s([k("definitionSetMap")],a.prototype,"readDefinitionSetMap",null),s([I("definitionSetMap")],a.prototype,"writeDefinitionSetMap",null),s([h()],a.prototype,"inclusionModeDefinition",null),s([h()],a.prototype,"knowledgeGraph",void 0),s([h({type:u.ofType(c),json:{write:{ignoreOrigin:!0}}})],a.prototype,"layers",void 0),s([h()],a.prototype,"memberEntityTypes",void 0),s([h()],a.prototype,"memberRelationshipTypes",void 0),s([h({type:["KnowledgeGraphLayer"]})],a.prototype,"operationalLayerType",void 0),s([h()],a.prototype,"sublayerIdsCache",void 0),s([h({type:u.ofType(c),json:{write:{ignoreOrigin:!0}}})],a.prototype,"tables",void 0),s([h({json:{read:!1}})],a.prototype,"type",void 0),s([h(H)],a.prototype,"url",void 0),a=s([_("esri.layers.KnowledgeGraphLayer")],a);const so=a;async function q(t){const e=await U(t);return new Blob([e],{type:"application/x-protobuf"})}function J(t){const e=`definitionSetMap-${$()}.dat`,i=C("knowledgeGraphLayer",e);return t.resourceFromPath(i)}export{so as default};
