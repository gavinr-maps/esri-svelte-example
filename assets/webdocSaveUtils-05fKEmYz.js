const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./geometryServiceUtils-C6Kg3Uew.js","./subclass-BZA_h8Db.js","./Portal-C10FKnaA.js","./index-Bh2oEzTI.js","./index-2kwcjS9-.css","./tslib.es6-B3Jf3DVX.js","./assets-C43MgM-v.js","./Accessor-BLX9ikPh.js","./Loadable-BabW5Xcc.js","./Promise-B2Hu02L7.js","./writer-DNAwXnhG.js","./Extent-Bf3YTe7m.js","./Point-Cg0-ChZE.js","./cast-Bjksrh93.js","./jsonMap-0cxwUWs2.js","./locale-C9TlLpzi.js","./project-DlMfXva8.js","./jsonUtils-CEfjT-BK.js","./Polyline-D9YkgmM_.js","./mathUtils-C4_ghTv4.js","./utils-6jMaHUrH.js","./utils-Bema0iXE.js"])))=>i.map(i=>d[i]);
import{_ as B}from"./index-Bh2oEzTI.js";import{b as f}from"./subclass-BZA_h8Db.js";import{m as U}from"./MultiOriginJSONSupport-B5nfqtQh.js";import{whenOnce as w}from"./reactiveUtils-C5zUhJQJ.js";import{W as F,I as K}from"./assets-C43MgM-v.js";import{i as H}from"./originUtils-D69mHv66.js";import{s as J,a as z,g as q}from"./Point-Cg0-ChZE.js";import{I as Q}from"./arcgisLayerUrl-BX1FE5Hm.js";import{L as W,w as X}from"./layerUtils-BrNoooE9.js";import{b as Y}from"./Portal-C10FKnaA.js";import Z from"./PortalItem-DzgXrpyc.js";import{o as $}from"./jsonContext-DueMnVx9.js";import{a as n,i as l,s as u,f as y}from"./portalItemUtils-BzVoFAku.js";import{p as ee,n as te}from"./project-DlMfXva8.js";import{j as oe,T as ae,U as re}from"./basemapUtils-B9TjOm47.js";import{p as A}from"./resourceUtils-BZzv7-k7.js";import{r as T,t as O}from"./saveUtils-gB1pYTqT.js";import"./tslib.es6-B3Jf3DVX.js";import"./Accessor-BLX9ikPh.js";import"./asyncUtils-CWX51uTe.js";import"./Collection-CEdjem1-.js";import"./Evented-BHRw9x22.js";import"./shared-B3wH2qpO.js";import"./SimpleObservable-KocWTzVy.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./cast-Bjksrh93.js";import"./writer-DNAwXnhG.js";import"./jsonMap-0cxwUWs2.js";import"./persistableUrlUtils-fa1mAujs.js";import"./Loadable-BabW5Xcc.js";import"./Promise-B2Hu02L7.js";import"./Extent-Bf3YTe7m.js";import"./locale-C9TlLpzi.js";import"./projection-B971H0Re.js";import"./vec3f64-BLpZdpfb.js";import"./Polyline-D9YkgmM_.js";import"./mathUtils-C4_ghTv4.js";import"./projectBuffer-Bs7GwaPY.js";import"./geodesicConstants-DWQLYX7F.js";import"./jsonUtils-CEfjT-BK.js";import"./utils-6jMaHUrH.js";import"./utils-Bema0iXE.js";import"./Basemap-DVYOaWHz.js";import"./collectionUtils-D_lHIu88.js";import"./loadAll-B6mYSptb.js";import"./messages-OmQvZhAg.js";import"./writeUtils-Dz7BsE1e.js";import"./utils-93yNk4Xc.js";import"./colorUtils-0bJDPow9.js";import"./screenUtils-_ZIvrt5o.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-GpOFENPA.js";import"./common-DQOJ18NT.js";import"./uuid-fwrPAdZb.js";import"./resourceUtils-VfNT3fc0.js";const ie=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map(t=>t.toLowerCase());async function Vt(t,e,o){o??(o={}),ne(t,e),await w(()=>!e.updatingFromView),await e.load(),await D(e),await T(e),await C(t,e);const a=e.portalItem,{json:r,jsonContext:i}=await P(e,a);return O(i,{errorName:`${t.name}:save`},o),await E(e,a),await Pe(t,e,a,r,i),await Promise.all([e.updateItemThumbnail(),A(e.resourceReferences,i)]),a}async function P(t,e){const o=$(e,"web-map",!0),a=t.write({},o);return await Promise.all(o.resources.pendingOperations),{json:a,jsonContext:o}}async function Lt(t,e,o,a){a??(a={});const r=se(t,o);await w(()=>!e.updatingFromView),await e.load(),await D(e),await T(e),await C(t,e);const{json:i,jsonContext:s}=await P(e,r);O(s,{errorName:`${t.name}:save`},a),await ce(e,r);const p=e.getThumbnailState();return await Se(t,e,r,i,s,a)&&(e.resourceReferences.portalItem=r),e.restoreThumbnailFromState(p),await Promise.all([e.updateItemThumbnail(),A(e.resourceReferences,s)]),r}function ne(t,e){if(!e.portalItem)throw new f(`${t.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");S(t,e.portalItem)}function S(t,e){if(e.type!==t.itemType)throw new f(`${t.name}:portal-item-wrong-type`,`Portal item needs to have type "${t.itemType}"`)}async function C(t,e){var a;if(!((a=e.basemap)!=null&&a.baseLayers.length))throw new f(`${t.name}:save`,"Map does not have a valid basemap with a base layer.");let o=null;if(await w(()=>{const r=oe(e.initialViewProperties,e.basemap);return o=r.spatialReference,!r.updating}),!J(o,e.initialViewProperties.spatialReference))throw new f(`${t.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:e.initialViewProperties.spatialReference,actual:o})}function se(t,e){let o=Z.from(e);return o.id&&(o=o.clone(),o.id=null),o.type||(o.type=t.itemType),o.portal||(o.portal=Y.getDefault()),S(t,o),o}function D(t){const e=[];return t.basemap&&e.push(t.basemap.load()),t.ground&&e.push(t.ground.load()),Promise.allSettled(e).then(()=>{})}async function E(t,e){e.extent=await ve(t.portalItem,t.initialViewProperties.viewpoint.targetGeometry),await ue(t,e)}const pe=y.JSAPI,V="CollectorDisabled",_="Collector",g="Data Editing",L="OfflineDisabled",b="Offline",M="Workforce Project",j="Workforce Worker",k="Workforce Dispatcher",le="Offline Map Areas",me="FieldMapsDisabled",v=y.DEVELOPER_BASEMAP,R="UtilityNetwork",I="IPS";async function ce(t,e){n(e,V),n(e,me),n(e,y.METADATA),n(e,L),n(e,le),n(e,k),n(e,M),n(e,j),await E(t,e)}async function ue(t,e){l(e,pe),await fe(t),we(t,e),ye(t,e),he(t,e),_e(t,e),ge(t,e),be(t,e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((o,a,r)=>r.indexOf(o)===a))}function fe(t){const e=h(t).map(o=>o.load()).toArray();return Promise.allSettled(e).then(()=>{})}function h(t){return t.allLayers.concat(t.allTables)}function G(t){return h(t).some(e=>e.loaded&&W(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&(e.type!=="subtype-group"||e.sublayers.some(o=>o.editingEnabled)))}function de(t){return h(t).filter(e=>e.type!=="group").every(e=>e.loaded&&We(t,e))}function we(t,e){u(e,V)||u(e,M)||u(e,j)||u(e,k)||!G(t)?n(e,_):l(e,_)}function ye(t,e){G(t)?l(e,g):n(e,g)}function he(t,e){!u(e,L)&&de(t)?l(e,b):n(e,b)}function _e(t,e){ae(t.basemap)?l(e,v):n(e,v)}function ge(t,e){var o;(o=t.utilityNetworks)!=null&&o.length?l(e,R):n(e,R)}function be(t,e){t.ipsInfo?l(e,I):n(e,I)}async function ve(t,e){const o=e.clone().normalize();let a;if(o.length>1)for(const r of o)a?r.width>a.width&&(a=r):a=r;else a=o[0];return Re(t,a)}async function Re(t,e){const o=e.spatialReference;if(o.isWGS84)return e.clone();if(o.isWebMercator)return z(e);const{getGeometryServiceURL:a}=await B(()=>import("./geometryServiceUtils-C6Kg3Uew.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21]),import.meta.url),r=await a(t),i=new ee({geometries:[e],outSpatialReference:q.WGS84});return(await te(r,i))[0]}function Ie(t){return X(t)||t.type==="map-notes"||t.type==="route"}function We(t,e){return W(e)&&e.capabilities.operations.supportsSync||Ie(e)&&!e.portalItem||Ae(e)&&!Te(e)&&e.spatialReference.equals(t.initialViewProperties.spatialReference)}function Ae(t){return(t.type==="tile"||t.type==="vector-tile")&&(t.capabilities.operations.supportsExportTiles||Oe(t)||re(t))}function Te(t){return t.type==="vector-tile"&&Object.keys(t.sourceNameToSource).length>1}function Oe(t){return t.type==="tile"&&Q(t.url)&&ie.some(e=>{var o;return(o=t.url)==null?void 0:o.toLowerCase().includes("/"+e+"/")})}async function Pe(t,e,o,a,r){await o.update({data:a}),N(t,e,o,a,r)}async function Se(t,e,o,a,r,i){const s=e.portalItem,p={item:s,authenticated:!(!(s!=null&&s.id)||!s.portal.user)},m=o.portal;await m.signIn();const{copyAllowed:c,itemReloaded:d}=await Ce(p,m);if(p.authenticated||(p.authenticated=d),!c)throw new f(`${t.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const x=await De(o,p,a,i);return e.portalItem=o,N(t,e,o,a,r),x}async function Ce(t,e){var r;const{item:o,authenticated:a}=t;return o!=null&&o.id&&((r=o.typeKeywords)!=null&&r.includes("useOnly"))?o.portal.portalHostname!==e.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(a||await o.reload(),{copyAllowed:o.itemControl==="admin"||o.itemControl==="update",itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function De(t,e,o,a){const r=t.portal,{item:i}=e,{folder:s,copyAllResources:p}=a;let m=!1;if(p&&(i!=null&&i.id)&&F(i.portal.url,r.url)&&parseInt(i.portal.currentVersion,10)>=2023){const{total:c}=await i.fetchResources();m=!!c}if(m){const c=await i.copy({copyResources:"all",folder:s});t.id=c.id,t.portal=c.portal;const d=t.toJSON();await t.load(),t.read(d),await t.update({data:o})}else await r.user.addItem({item:t,folder:s,data:o});return m}function N(t,e,o,a,r){U.prototype.read.call(e,{version:a.version,authoringApp:a.authoringApp,authoringAppVersion:a.authoringAppVersion},{origin:t.origin,ignoreDefaults:!0,url:o.itemUrl?K(o.itemUrl):void 0}),H(r),e.resourceInfo=a}export{P as createJSON,De as initializeNewItem,Ce as isCopyAllowed,Vt as save,Lt as saveAs};
