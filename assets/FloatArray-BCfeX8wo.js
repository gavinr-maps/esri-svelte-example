import{a as x}from"./BindType-BBwFZqyN.js";import{i as $,u as yt,b as Se,e as L,a as R,n as dt,o as ye,t as _t,H as Yt}from"./Matrix3PassUniform-Bhi2fM3C.js";import{aR as be,a0 as Zt,aD as bt,B as Jt,aO as we,I as ut,aF as Ie,r as nt,s as te,aE as it,as as rt,D as Nt,a4 as Oe,a6 as Le,l as Me}from"./Accessor-BHnuXKD2.js";import{O as De,r as ee,e as st,t as Re,p as Ue}from"./Material-Ba8x5bbY.js";import{b as ze,w as at,a as Ne,p as Fe}from"./Texture-D-SqNa4i.js";import{E as Ve,c as D,G as K,L as q,D as wt,R as ft,O,X as H,I as v}from"./enums-D9v74xTE.js";import{B as He,o as Be,g as ke,r as Ge,c as je,p as Ke}from"./renderState-e7QeQoUO.js";import{t as ie,O as Xe,u as X,s as V}from"./basicInterfaces-CZwQPxTp.js";import{o as Ft,r as We,e as ht}from"./mat4f64-Dk4dwAN8.js";import{I as Vt,v as qe,o as P,u as w,g as F,W as Qe,E as Tt,c as re}from"./vec32-Dvg_eL9J.js";import{t as Ye,o as Ze}from"./Indices-Db9lERgy.js";import{r as Je,t as ti,n as b,_ as Lt}from"./vec3f64-BLpZdpfb.js";import{s as W}from"./InterleavedLayout-Dvj-Snan.js";import{S as ei}from"./triangle-D_E6eTS3.js";import{e as S}from"./VertexAttribute-Cq4MnHjR.js";import{i as ot,a as ii}from"./ShaderTechniqueConfiguration-YrUOztAU.js";import{o as ri,x as si,l as ni,m as ai,n as oi,r as li,c as ci,f as ui,i as xt}from"./mat4-Fi6iAz29.js";import{n as u,t as N}from"./glsl-BH37Aalp.js";import{c as se}from"./NoParameters-t-PuNrgq.js";import{r as ne}from"./mathUtils-DV9iOXpW.js";import{n as di}from"./mat3-CR8GKnhD.js";import{e as hi}from"./mat3f64-BBpwCtoL.js";import{m as Ht}from"./lengthUtils-DjJgJFRg.js";import{aq as fi,i as Mt,n as j}from"./opacityUtils-CSd4XoR2.js";import{i as mi}from"./Evented-DCWccWGU.js";import{n as pi,Z as Bt,r as gi,ah as vi}from"./cast-BA_-jlhc.js";import{t as _i}from"./requestImageUtils-Brn0e8z8.js";import{_ as Ti}from"./index-tefRSezt.js";import{_ as J}from"./TextureFormat-1mYWTFa-.js";import{o as xi}from"./vec2-maR1OrZI.js";import{n as Ai}from"./vec2f64-Dy6m9Nrb.js";let ae=class{constructor(){this.uid=be()}},Ei=class extends ae{constructor(t){super(),this.highlightName=t,this.channel=ie.Highlight}},vs=class extends ae{constructor(){super(...arguments),this.channel=ie.MaskOccludee}},$i=class extends ${constructor(t,i){super(t,"vec2",x.Bind,(r,s)=>r.setUniform2fv(t,i(s)))}};function Ci(e){e.uniforms.add(new $i("zProjectionMap",t=>Pi(t.camera))),e.code.add(u`float linearizeDepth(float depth) {
float depthNdc = depth * 2.0 - 1.0;
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
return -(c1 / (depthNdc + c2 + 1e-7));
}`),e.code.add(u`float depthFromTexture(sampler2D depthTexture, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
float depth = texelFetch(depthTexture, iuv, 0).r;
return depth;
}`),e.code.add(u`float linearDepthFromTexture(sampler2D depthTexture, vec2 uv) {
return linearizeDepth(depthFromTexture(depthTexture, uv));
}`)}function Pi(e){const t=e.projectionMatrix;return xi(Si,t[14],t[10])}const Si=Ai();let xs=class extends ${constructor(t,i){super(t,"float",x.Pass,(r,s,n)=>r.setUniform1f(t,i(s,n)))}},yi=class extends ${constructor(t,i){super(t,"sampler2D",x.Pass,(r,s,n)=>r.bindTexture(t,i(s,n)))}},$s=class{constructor(t,i){this._module=t,this._load=i}get(){return this._module}async reload(){return this._module=await this._load(),this._module}},kt=class{constructor(t,i,r){this._context=t,this._locations=r,this._textures=new Map,this._freeTextureUnits=new Zt({deallocator:null}),this._glProgram=t.programCache.acquire(i.generate("vertex",!0),i.generate("fragment",!0),r),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bind=i.generateBind(this),this.bindPass=i.generateBindPass(this),this.bindDraw=i.generateBindDraw(this),this._fragmentUniforms=ze()?i.fragmentUniforms:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(t,i){this._glProgram.setUniform1i(t,i?1:0)}setUniform1i(t,i){this._glProgram.setUniform1i(t,i)}setUniform1f(t,i){this._glProgram.setUniform1f(t,i)}setUniform2fv(t,i){this._glProgram.setUniform2fv(t,i)}setUniform3fv(t,i){this._glProgram.setUniform3fv(t,i)}setUniform4fv(t,i){this._glProgram.setUniform4fv(t,i)}setUniformMatrix3fv(t,i){this._glProgram.setUniformMatrix3fv(t,i)}setUniformMatrix4fv(t,i){this._glProgram.setUniformMatrix4fv(t,i)}setUniform1fv(t,i){this._glProgram.setUniform1fv(t,i)}setUniform1iv(t,i){this._glProgram.setUniform1iv(t,i)}setUniform2iv(t,i){this._glProgram.setUniform2iv(t,i)}setUniform3iv(t,i){this._glProgram.setUniform3iv(t,i)}setUniform4iv(t,i){this._glProgram.setUniform4iv(t,i)}assertCompatibleVertexAttributeLocations(t){t.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(t,i){if((i==null?void 0:i.glName)==null){const s=this._textures.get(t);return s&&(this._context.bindTexture(null,s.unit),this._freeTextureUnit(s),this._textures.delete(t)),null}let r=this._textures.get(t);return r==null?(r=this._allocTextureUnit(i),this._textures.set(t,r)):r.texture=i,this._context.useProgram(this),this.setUniform1i(t,r.unit),this._context.bindTexture(i,r.unit),r.unit}rebindTextures(){var t;this._context.useProgram(this),this._textures.forEach((i,r)=>{this._context.bindTexture(i.texture,i.unit),this.setUniform1i(r,i.unit)}),(t=this._fragmentUniforms)==null||t.forEach(i=>{i.type!=="sampler2D"&&i.type!=="samplerCube"||this._textures.has(i.name)||console.error(`Texture sampler ${i.name} has no bound texture`)})}_allocTextureUnit(t){return{texture:t,unit:this._freeTextureUnits.length===0?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(t){this._freeTextureUnits.push(t.unit)}};const bi=()=>Jt.getLogger("esri.views.3d.webgl.ShaderTechnique");let Ss=class{constructor(t,i,r,s=De){this.locations=s,this.primitiveType=Ve.TRIANGLES,this.key=i.key,this._program=new kt(t.rctx,r.get().build(i),s),this._pipeline=this.initializePipeline(i),this.reload=async n=>{n&&await r.reload(),this.key.equals(i.key)||bi().warn("Configuration was changed after construction, cannot reload shader.",r),bt(this._program),this._program=new kt(t.rctx,r.get().build(i),s),this._pipeline=this.initializePipeline(i)}}destroy(){this._program=bt(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(t){this.program.assertCompatibleVertexAttributeLocations(t)}getPipeline(t,i){return this._pipeline}initializePipeline(t){return He({blending:Be,colorWrite:ke})}},bs=class extends ${constructor(t,i){super(t,"vec4",x.Bind,(r,s)=>r.setUniform4fv(t,i(s)))}},It=class extends ${constructor(t,i){super(t,"sampler2D",x.Bind,(r,s)=>r.bindTexture(t,i(s)))}},wi=class extends ${constructor(t,i){super(t,"vec3",x.Bind,(r,s)=>r.setUniform3fv(t,i(s)))}},Ls=class extends ${constructor(t,i){super(t,"vec4",x.Pass,(r,s,n)=>r.setUniform4fv(t,i(s,n)))}},Ii=class extends ${constructor(t,i){super(t,"float",x.Bind,(r,s)=>r.setUniform1f(t,i(s)))}};var I;function Oi(e,t){switch(t.textureCoordinateType){case I.Default:return e.attributes.add(S.UV0,"vec2"),e.varyings.add("vuv0","vec2"),void e.vertex.code.add(u`void forwardTextureCoordinates() {
vuv0 = uv0;
}`);case I.Compressed:return e.attributes.add(S.UV0,"vec2"),e.varyings.add("vuv0","vec2"),void e.vertex.code.add(u`vec2 getUV0() {
return uv0 / 16384.0;
}
void forwardTextureCoordinates() {
vuv0 = getUV0();
}`);case I.Atlas:return e.attributes.add(S.UV0,"vec2"),e.varyings.add("vuv0","vec2"),e.attributes.add(S.UVREGION,"vec4"),e.varyings.add("vuvRegion","vec4"),void e.vertex.code.add(u`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);default:we(t.textureCoordinateType);case I.None:return void e.vertex.code.add(u`void forwardTextureCoordinates() {}`);case I.COUNT:return}}(function(e){e[e.None=0]="None",e[e.Default=1]="Default",e[e.Atlas=2]="Atlas",e[e.Compressed=3]="Compressed",e[e.COUNT=4]="COUNT"})(I||(I={}));function Li(e){e.fragment.code.add(u`vec4 textureAtlasLookup(sampler2D tex, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
return textureGrad(tex, uvAtlas, dUVdx, dUVdy);
}`)}function Mi(e,t){const{textureCoordinateType:i}=t;if(i===I.None||i===I.COUNT)return;e.include(Oi,t);const r=i===I.Atlas;r&&e.include(Li),e.fragment.code.add(u`
    vec4 textureLookup(sampler2D tex, vec2 uv) {
      return ${r?"textureAtlasLookup(tex, uv, vuvRegion)":"texture(tex, uv)"};
    }
  `)}let Rs=class{constructor(t){this._material=t.material,this._techniques=t.techniques,this._output=t.output}dispose(){}get _stippleTextures(){return this._techniques.context.stippleTextures}get _markerTextures(){return this._techniques.context.markerTextures}getTechnique(t,i){return this._techniques.get(t,this._material.getConfiguration(this._output,i))}ensureResources(t){return Xe.LOADED}};function zs(e){const t=3.141592653589793,i=.3183098861837907;e.vertex.constants.add("PI","float",t),e.fragment.constants.add("PI","float",t),e.fragment.constants.add("LIGHT_NORMALIZATION","float",i),e.fragment.constants.add("INV_PI","float",i),e.fragment.constants.add("HALF_PI","float",1.570796326794897),e.fragment.constants.add("TWO_PI","float",6.28318530717958)}function Di(e){const{fragment:t}=e;t.code.add(u`uint readChannelBits(uint channel, int highlightLevel) {
int llc = (highlightLevel & 3) << 1;
return (channel >> llc) & 3u;
}
uint readChannel(vec2 texel, int highlightLevel) {
int lic = (highlightLevel >> 2) & 1;
return uint(texel[lic] * 255.0);
}
uint readLevelBits(vec2 texel, int highlightLevel) {
return readChannelBits(readChannel(texel, highlightLevel), highlightLevel);
}`)}let Ri=class extends ${constructor(t,i){super(t,"int",x.Bind,(r,s)=>r.setUniform1i(t,i(s)))}};function Ui(e){if(e.length<ut)return Array.from(e);if(Array.isArray(e))return Float64Array.from(e);if(!("BYTES_PER_ELEMENT"in e))return Array.from(e);switch(e.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(e);case 2:return Ie(e)?Uint16Array.from(e):Int16Array.from(e);case 4:return Float32Array.from(e);default:return Float64Array.from(e)}}let zi=class oe{constructor(t,i,r){this.primitiveIndices=t,this._numIndexPerPrimitive=i,this.position=r,this._children=void 0,W(t.length>=1),W(r.size===3||r.size===4);const{data:s,size:n,indices:a}=r;W(a.length%this._numIndexPerPrimitive==0),W(a.length>=t.length*this._numIndexPerPrimitive);const o=t.length;let c=n*a[this._numIndexPerPrimitive*t[0]];B.clear(),B.push(c);const d=Je(s[c],s[c+1],s[c+2]),l=ti(d);for(let f=0;f<o;++f){const m=this._numIndexPerPrimitive*t[f];for(let E=0;E<this._numIndexPerPrimitive;++E){c=n*a[m+E],B.push(c);let T=s[c];d[0]=Math.min(T,d[0]),l[0]=Math.max(T,l[0]),T=s[c+1],d[1]=Math.min(T,d[1]),l[1]=Math.max(T,l[1]),T=s[c+2],d[2]=Math.min(T,d[2]),l[2]=Math.max(T,l[2])}}this.bbMin=d,this.bbMax=l;const h=Vt(b(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(l[0]-d[0],l[1]-d[1]),l[2]-d[2]);let A=this.radius*this.radius;for(let f=0;f<B.length;++f){c=B.at(f);const m=s[c]-h[0],E=s[c+1]-h[1],T=s[c+2]-h[2],k=m*m+E*E+T*T;if(k<=A)continue;const Y=Math.sqrt(k),Z=.5*(Y-this.radius);this.radius=this.radius+Z,A=this.radius*this.radius;const G=Z/Y;h[0]+=m*G,h[1]+=E*G,h[2]+=T*G}this.center=h,B.clear()}getChildren(){if(this._children||qe(this.bbMin,this.bbMax)<=1)return this._children;const t=Vt(b(),this.bbMin,this.bbMax,.5),i=this.primitiveIndices.length,r=new Uint8Array(i),s=new Array(8);for(let l=0;l<8;++l)s[l]=0;const{data:n,size:a,indices:o}=this.position;for(let l=0;l<i;++l){let h=0;const A=this._numIndexPerPrimitive*this.primitiveIndices[l];let f=a*o[A],m=n[f],E=n[f+1],T=n[f+2];for(let k=1;k<this._numIndexPerPrimitive;++k){f=a*o[A+k];const Y=n[f],Z=n[f+1],G=n[f+2];Y<m&&(m=Y),Z<E&&(E=Z),G<T&&(T=G)}m<t[0]&&(h|=1),E<t[1]&&(h|=2),T<t[2]&&(h|=4),r[l]=h,++s[h]}let c=0;for(let l=0;l<8;++l)s[l]>0&&++c;if(c<2)return;const d=new Array(8);for(let l=0;l<8;++l)d[l]=s[l]>0?new Uint32Array(s[l]):void 0;for(let l=0;l<8;++l)s[l]=0;for(let l=0;l<i;++l){const h=r[l];d[h][s[h]++]=this.primitiveIndices[l]}this._children=new Array;for(let l=0;l<8;++l)d[l]!==void 0&&this._children.push(new oe(d[l],this._numIndexPerPrimitive,this.position));return this._children}static prune(){B.prune()}};const B=new Zt({deallocator:null});function Ni(e,t){if(!e)return!1;const{size:i,data:r,indices:s}=e;P(t,0,0,0),P(C,0,0,0);let n=0,a=0;for(let o=0;o<s.length-2;o+=3){const c=s[o]*i,d=s[o+1]*i,l=s[o+2]*i;P(p,r[c],r[c+1],r[c+2]),P(M,r[d],r[d+1],r[d+2]),P(mt,r[l],r[l+1],r[l+2]);const h=ei(p,M,mt);h?(w(p,p,M),w(p,p,mt),F(p,p,1/3*h),w(t,t,p),n+=h):(w(C,C,p),w(C,C,M),w(C,C,mt),a+=3)}return(a!==0||n!==0)&&(n!==0?(F(t,t,1/n),!0):a!==0&&(F(t,C,1/a),!0))}function Fi(e,t){if(!e)return!1;const{size:i,data:r,indices:s}=e;P(t,0,0,0);let n=-1,a=0;for(let o=0;o<s.length;o++){const c=s[o]*i;n!==c&&(t[0]+=r[c],t[1]+=r[c+1],t[2]+=r[c+2],a++),n=c}return a>1&&F(t,t,1/a),a>0}function Vi(e,t,i){if(!e)return!1;P(i,0,0,0),P(C,0,0,0);let r=0,s=0;const{size:n,data:a,indices:o}=e,c=o.length-1,d=c+(t?2:0);for(let l=0;l<d;l+=2){const h=l<c?l+1:0,A=o[l<c?l:c]*n,f=o[h]*n;p[0]=a[A],p[1]=a[A+1],p[2]=a[A+2],M[0]=a[f],M[1]=a[f+1],M[2]=a[f+2],F(p,w(p,p,M),.5);const m=Qe(p,M);m>0?(w(i,i,F(p,p,m)),r+=m):r===0&&(w(C,C,p),s++)}return r!==0?(F(i,i,1/r),!0):s!==0&&(F(i,C,1/s),!0)}const p=b(),M=b(),mt=b(),C=b();let Fs=class le extends ee{constructor(t,i,r=null,s=st.Mesh,n=null,a=-1){super(),this.material=t,this.mapPositions=r,this.type=s,this.objectAndLayerIdColor=n,this.edgeIndicesLength=a,this.highlights=new Set,this._highlightOptionsCounts=new Map,this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[o,c]of i)this._attributes.set(o,{...c,indices:Ye(c.indices)}),o===S.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(o).indices.length:this.edgeIndicesLength)}instantiate(t={}){const i=new le(t.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach((r,s)=>{r.exclusive=!1,i._attributes.set(s,r)}),i._boundingInfo=this._boundingInfo,i.transformation=t.transformation||this.transformation,i}get attributes(){return this._attributes}getMutableAttribute(t){let i=this._attributes.get(t);return i&&!i.exclusive&&(i={...i,exclusive:!0,data:Ui(i.data)},this._attributes.set(t,i)),i}setAttributeData(t,i){const r=this._attributes.get(t);r&&this._attributes.set(t,{...r,exclusive:!0,data:i})}get indexCount(){var i;const t=(i=this._attributes.values().next().value)==null?void 0:i.indices;return(t==null?void 0:t.length)??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo==null&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(t){return!!(this.type===st.Mesh?this._computeAttachmentOriginTriangles(t):this.type===st.Line?this._computeAttachmentOriginLines(t):this._computeAttachmentOriginPoints(t))&&(this._transformation!=null&&Tt(t,t,this._transformation),!0)}_computeAttachmentOriginTriangles(t){const i=this.attributes.get(S.POSITION);return Ni(i,t)}_computeAttachmentOriginLines(t){const i=this.attributes.get(S.POSITION);return Vi(i,Hi(this.material.parameters,i),t)}_computeAttachmentOriginPoints(t){const i=this.attributes.get(S.POSITION);return Fi(i,t)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const t=this.attributes.get(S.POSITION);if(!t||t.indices.length===0)return null;const i=this.type===st.Mesh?3:1;W(t.indices.length%i==0,"Indexing error: "+t.indices.length+" not divisible by "+i);const r=Ze(t.indices.length/i);return new zi(r,i,t)}get transformation(){return this._transformation??Ft}set transformation(t){this._transformation=t&&t!==Ft?We(t):null}get highlightNames(){return this._highlightOptionsCounts}get hasHighlights(){return this._highlightOptionsCounts.size>0}foreachHighlightOptions(t){this._highlightOptionsCounts.forEach((i,r)=>t(r))}allocateIdAndHighlight(t){const i=new Ei(t);return this.addHighlight(i)}addHighlight(t){this.highlights.add(t);const{highlightName:i}=t,r=(this._highlightOptionsCounts.get(i)??0)+1;return this._highlightOptionsCounts.set(i,r),t}removeHighlight(t){if(this.highlights.delete(t)){const{highlightName:i}=t,r=this._highlightOptionsCounts.get(i)??0;r<=1?this._highlightOptionsCounts.delete(i):this._highlightOptionsCounts.set(i,r-1)}}};function Hi(e,t){return!(!("isClosed"in e)||!e.isClosed)&&t.indices.length>2}var Gt;(function(e){e[e.INTEGRATED_MESH=0]="INTEGRATED_MESH",e[e.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",e[e.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",e[e.OPAQUE_MATERIAL_WITHOUT_NORMALS=3]="OPAQUE_MATERIAL_WITHOUT_NORMALS",e[e.TRANSPARENT_MATERIAL=4]="TRANSPARENT_MATERIAL",e[e.TRANSPARENT_MATERIAL_WITHOUT_NORMALS=5]="TRANSPARENT_MATERIAL_WITHOUT_NORMALS",e[e.TRANSPARENT_TERRAIN=6]="TRANSPARENT_TERRAIN",e[e.TRANSPARENT_MATERIAL_WITHOUT_DEPTH=7]="TRANSPARENT_MATERIAL_WITHOUT_DEPTH",e[e.OCCLUDED_TERRAIN=8]="OCCLUDED_TERRAIN",e[e.OCCLUDER_MATERIAL=9]="OCCLUDER_MATERIAL",e[e.TRANSPARENT_OCCLUDER_MATERIAL=10]="TRANSPARENT_OCCLUDER_MATERIAL",e[e.OCCLUSION_PIXELS=11]="OCCLUSION_PIXELS",e[e.HUD_MATERIAL=12]="HUD_MATERIAL",e[e.LABEL_MATERIAL=13]="LABEL_MATERIAL",e[e.LINE_CALLOUTS=14]="LINE_CALLOUTS",e[e.LINE_CALLOUTS_HUD_DEPTH=15]="LINE_CALLOUTS_HUD_DEPTH",e[e.OVERLAY=16]="OVERLAY",e[e.DRAPED_MATERIAL=17]="DRAPED_MATERIAL",e[e.DRAPED_WATER=18]="DRAPED_WATER",e[e.VOXEL=19]="VOXEL",e[e.MAX_SLOTS=20]="MAX_SLOTS"})(Gt||(Gt={}));var _,jt;(function(e){e[e.Undefined=0]="Undefined",e[e.DefinedSize=1]="DefinedSize",e[e.DefinedScale=2]="DefinedScale"})(_||(_={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedAngle=1]="DefinedAngle"}(jt||(jt={}));let Dt=class{constructor(t){this.field=t}},Bi=class extends Dt{constructor(t){super(t),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[_.Undefined,_.Undefined,_.Undefined]}};class ki extends Dt{constructor(t){super(t),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0]}}let Gi=class extends Dt{constructor(t){super(t),this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}},ji=class{};function tt(e){return e!=null}function Ki(e,t,i,r=ht()){const s=e||0,n=t||0,a=i||0;return s!==0&&si(r,r,-s/180*Math.PI),n!==0&&ni(r,r,n/180*Math.PI),a!==0&&ai(r,r,a/180*Math.PI),r}function U(e,t,i,r,s){var o;const n=e.minSize,a=e.maxSize;if(e.useSymbolValue){const c=r.symbolSize[i];return t.minSize[i]=c,t.maxSize[i]=c,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=_.DefinedSize,!0}if(tt(e.field))return tt(e.stops)?e.stops.length===2&&j(e.stops[0].size)&&j(e.stops[1].size)?(Kt(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=_.DefinedSize,!0):!1:j(n)&&j(a)&&tt(e.minDataValue)&&tt(e.maxDataValue)?(Kt(n,a,e.minDataValue,e.maxDataValue,t,i),t.type[i]=_.DefinedSize,!0):e.valueUnit==="unknown"?!1:Ht[e.valueUnit]!=null?(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/Ht[e.valueUnit],t.type[i]=_.DefinedSize,!0):!1;if(!tt(e.field)){if((o=e.stops)!=null&&o[0]&&j(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=_.DefinedSize,!0;if(j(n))return t.minSize[i]=n,t.maxSize[i]=n,t.offset[i]=n,t.factor[i]=0,t.type[i]=_.DefinedSize,!0}return!1}function Kt(e,t,i,r,s,n){const a=Math.abs(r-i)>0?(t-e)/(r-i):0;s.minSize[n]=a>0?e:t,s.maxSize[n]=a>0?t:e,s.offset[n]=e-i*a,s.factor[n]=a}function Xi(e,t,i,r){if(e.normalizationField||e.valueRepresentation||!fi(e.field))return null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return null}else t.size.field=e.field}else t.size=new Bi(e.field);let s;switch(e.axis){case"width":return s=U(e,t.size,0,i),s?t:null;case"height":return s=U(e,t.size,2,i),s?t:null;case"depth":return s=U(e,t.size,1,i),s?t:null;case"width-and-depth":return s=U(e,t.size,0,i),s&&U(e,t.size,1,i),s?t:null;case null:case void 0:case"all":return s=U(e,t.size,0,i),s=s&&U(e,t.size,1,i),s=s&&U(e,t.size,2,i),s?t:null;default:return`${e.axis}`,null}}function Wi(e,t,i){for(let s=0;s<3;++s){let n=t.unitInMeters;e.type[s]===_.DefinedSize&&(n*=t.modelSize[s],e.type[s]=_.DefinedScale),e.minSize[s]=e.minSize[s]/n,e.maxSize[s]=e.maxSize[s]/n,e.offset[s]=e.offset[s]/n,e.factor[s]=e.factor[s]/n}let r;if(e.type[0]!==_.Undefined)r=0;else if(e.type[1]!==_.Undefined)r=1;else{if(e.type[2]===_.Undefined)return!1;r=2}for(let s=0;s<3;++s)e.type[s]===_.Undefined&&(e.minSize[s]=e.minSize[r],e.maxSize[s]=e.maxSize[r],e.offset[s]=e.offset[r],e.factor[s]=e.factor[r],e.type[s]=e.type[r]);return!0}function Xt(e,t,i){e[4*t]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function qi(e,t,i){if(e.normalizationField)return null;if(Mt(e.field)){if(!e.stops)return null;{if(e.stops.length>8)return null;t.color=new ki(e.field);const r=e.stops;for(let s=0;s<8;++s){const n=r[Math.min(s,r.length-1)];t.color.values[s]=n.value,Xt(t.color.colors,s,n.color)}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const r=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)t.color.values[s]=1/0,Xt(t.color.colors,s,r)}}return t}function Qi(e,t,i){if(e.normalizationField)return null;if(Mt(e.field)){if(!e.stops)return null;{if(e.stops.length>8)return null;t.opacity=new Gi(e.field);const r=e.stops;for(let s=0;s<8;++s){const n=r[Math.min(s,r.length-1)];t.opacity.values[s]=n.value,t.opacity.opacityValues[s]=n.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const r=e.stops&&e.stops.length>=0?e.stops[0].opacity:0;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)t.opacity.values[s]=1/0,t.opacity.opacityValues[s]=r}}return t}function Ct(e,t,i){const r=i===2&&e.rotationType==="arithmetic";t.offset[i]=r?90:0,t.factor[i]=r?-1:1,t.type[i]=1}function Yi(e,t,i){if(!Mt(e.field))return null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return Ct(e,t.rotation,0),t;case"roll":return Ct(e,t.rotation,1),t;case null:case void 0:case"heading":return Ct(e,t.rotation,2),t;default:return`${e.axis}`,null}}class Gs{constructor(t,i=[1,1,1],r=[1,1,1],s=1,n=[0,0,0],a=[1,1,1],o=[0,0,0]){this.supports=t,this.modelSize=i,this.symbolSize=r,this.unitInMeters=s,this.anchor=n,this.scale=a,this.rotation=o}}function ce(e,t,i){if(!e)return null;const r=e.reduce((s,n)=>{if(!s)return s;if(n.valueExpression)return null;switch(n.type){case"size":return t.supports.size?Xi(n,s,t,i):s;case"color":return t.supports.color?qi(n,s):s;case"opacity":return t.supports.opacity?Qi(n,s):null;case"rotation":return t.supports.rotation?Yi(n,s,i):s;default:return null}},new ji);return!(e.length>0&&r)||r.size||r.color||r.opacity||r.rotation?r!=null&&r.size&&!Wi(r.size,t)?null:r:null}class Zi{constructor(t,i,r){this.visualVariables=t,this.materialParameters=i,this.requiresShaderTransformation=r}}function js(e,t){if(!e||Re.TESTS_DISABLE_FAST_UPDATES)return null;const i=ce(e.visualVariables,t);return i?new Zi(i,de(i,t),!!i.size):null}function Ks(e,t,i){if(!t||!e)return!1;const r=e.visualVariables,s=ce(t.visualVariables,i);return!!s&&!!(pt(r.size,s.size,"size")&&pt(r.color,s.color,"color")&&pt(r.rotation,s.rotation,"rotation")&&pt(r.opacity,s.opacity,"opacity"))&&(e.visualVariables=s,e.materialParameters=de(s,i),e.requiresShaderTransformation=!!s.size,!0)}function pt(e,t,i){if(!!e!=!!t||e&&e.field!==(t==null?void 0:t.field))return!1;if(e&&i==="rotation"){const r=e,s=t;for(let n=0;n<3;n++)if(r.type[n]!==s.type[n]||r.offset[n]!==s.offset[n]||r.factor[n]!==s.factor[n])return!1}return!0}class ue extends se{constructor(t){super(),this.vvSize=(t==null?void 0:t.size)??null,this.vvColor=(t==null?void 0:t.color)??null,this.vvOpacity=(t==null?void 0:t.opacity)??null}}function de(e,t){const i=new ue(e);return i.vvSize&&(i.vvSymbolAnchor=t.anchor,ri(lt),Ki(t.rotation[2],t.rotation[0],t.rotation[1],lt),i.vvSymbolRotationMatrix=i.vvSymbolRotationMatrix||hi(),di(i.vvSymbolRotationMatrix,lt)),i}function Xs(e,t,i){if(!e.vvSize)return i;oi(z,i);const r=e.vvSymbolRotationMatrix;li(lt,r[0],r[1],r[2],0,r[3],r[4],r[5],0,r[6],r[7],r[8],0,0,0,0,1),ci(z,z,lt);for(let s=0;s<3;++s){const n=e.vvSize.offset[s]+t[0]*e.vvSize.factor[s];Wt[s]=ne(n,e.vvSize.minSize[s],e.vvSize.maxSize[s])}return ui(z,z,Wt),xt(z,z,e.vvSymbolAnchor),z}function Ws(e,t,i){if(!t.vvSize)return P(e,1,1,1),e;for(let r=0;r<3;++r){const s=t.vvSize.offset[r]+i[0]*t.vvSize.factor[r];e[r]=ne(s,t.vvSize.minSize[r],t.vvSize.maxSize[r])}return e}function qs(e,t){const i=e==null?0:t.attributes[e];return typeof i=="number"&&isFinite(i)?i:0}const z=ht(),Wt=b(),lt=ht();let Qs=class extends ue{constructor(){super(...arguments),this.renderOccluded=Ue.Occlude,this.isDecoration=!1}};const Pt=8;var At;(function(e){e[e.None=0]="None",e[e.Value=1]="Value",e[e.Texture=2]="Texture",e[e.COUNT=3]="COUNT"})(At||(At={}));function Ji(e,t){if(!yt(t.output))return;const{emissionSource:i,hasEmissiveTextureTransform:r,bindType:s}=t,n=i===At.Texture;n&&(e.include(Mi,t),e.fragment.uniforms.add(s===x.Pass?new yi("texEmission",o=>o.textureEmissive):new Se("texEmission",o=>o.textureEmissive)));const a=i===At.Value||n;a&&e.fragment.uniforms.add(s===x.Pass?new L("emissionFactor",o=>o.emissiveFactor):new R("emissionFactor",o=>o.emissiveFactor)),e.fragment.code.add(u`
    vec4 getEmissions() {
      vec4 emissions = ${a?"vec4(emissionFactor, 1.0)":"vec4(0.0)"};
      ${N(n,`emissions *= textureLookup(texEmission, ${r?"emissiveUV":"vuv0"});
         emissions.w = emissions.rgb == vec3(0.0) ? 0.0: emissions.w;`)}
      return emissions;
    }
  `)}let Ot=class extends ii{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}};nt([ot()],Ot.prototype,"instancedDoublePrecision",void 0),nt([ot()],Ot.prototype,"hasModelTransformation",void 0);var g;(function(e){e[e.NONE=0]="NONE",e[e.ColorAlpha=1]="ColorAlpha",e[e.FrontFace=2]="FrontFace",e[e.COUNT=3]="COUNT"})(g||(g={}));let St=class extends Ot{constructor(){super(...arguments),this.output=dt.Color,this.oitPass=g.NONE,this.hasSlicePlane=!1,this.bindType=x.Pass,this.writeDepth=!0}};nt([ot({count:dt.COUNT})],St.prototype,"output",void 0),nt([ot({count:g.COUNT})],St.prototype,"oitPass",void 0),nt([ot()],St.prototype,"hasSlicePlane",void 0);let tn=class extends se{constructor(t){super(),this.slicePlaneLocalOrigin=t}};function rn(e,t){fe(e,t,new L("slicePlaneOrigin",(i,r)=>Rt(t,i,r)),new L("slicePlaneBasis1",(i,r)=>{var s;return Q(t,i,r,(s=r.slicePlane)==null?void 0:s.basis1)}),new L("slicePlaneBasis2",(i,r)=>{var s;return Q(t,i,r,(s=r.slicePlane)==null?void 0:s.basis2)}))}function sn(e,t){fe(e,t,new R("slicePlaneOrigin",(i,r)=>Rt(t,i,r)),new R("slicePlaneBasis1",(i,r)=>{var s;return Q(t,i,r,(s=r.slicePlane)==null?void 0:s.basis1)}),new R("slicePlaneBasis2",(i,r)=>{var s;return Q(t,i,r,(s=r.slicePlane)==null?void 0:s.basis2)}))}function nn(e,t){he(e,t,new R("slicePlaneOrigin",(i,r)=>Rt(t,i,r)),new R("slicePlaneBasis1",(i,r)=>{var s;return Q(t,i,r,(s=r.slicePlane)==null?void 0:s.basis1)}),new R("slicePlaneBasis2",(i,r)=>{var s;return Q(t,i,r,(s=r.slicePlane)==null?void 0:s.basis2)}))}const tr=u`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
bool rejectBySlice(vec3 pos) {
return sliceByPlane(pos);
}`;function he(e,t,...i){t.hasSlicePlane?(e.uniforms.add(...i),e.code.add(tr)):e.code.add("bool rejectBySlice(vec3 pos) { return false; }")}function fe(e,t,...i){he(e,t,...i),t.hasSlicePlane?e.code.add(`
    void discardBySlice(vec3 pos) {
      if (sliceByPlane(pos)) {
        discard;
      }
    }

    vec4 applySliceOutline(vec4 color, vec3 pos) {
      SliceFactors factors = calculateSliceFactors(pos);

      factors.front /= 2.0 * fwidth(factors.front);
      factors.side0 /= 2.0 * fwidth(factors.side0);
      factors.side1 /= 2.0 * fwidth(factors.side1);
      factors.side2 /= 2.0 * fwidth(factors.side2);
      factors.side3 /= 2.0 * fwidth(factors.side3);

      // return after calling fwidth, to avoid aliasing caused by discontinuities in the input to fwidth
      if (sliceByFactors(factors)) {
        return color;
      }

      float outlineFactor = (1.0 - step(0.5, factors.front))
        * (1.0 - step(0.5, factors.side0))
        * (1.0 - step(0.5, factors.side1))
        * (1.0 - step(0.5, factors.side2))
        * (1.0 - step(0.5, factors.side3));

      return mix(color, vec4(vec3(0.0), color.a), outlineFactor * 0.3);
    }

    vec4 applySlice(vec4 color, vec3 pos) {
      return sliceEnabled() ? applySliceOutline(color, pos) : color;
    }
  `):e.code.add(u`void discardBySlice(vec3 pos) { }
vec4 applySlice(vec4 color, vec3 pos) { return color; }`)}function me(e,t,i){return e.instancedDoublePrecision?P(er,i.camera.viewInverseTransposeMatrix[3],i.camera.viewInverseTransposeMatrix[7],i.camera.viewInverseTransposeMatrix[11]):t.slicePlaneLocalOrigin}function pe(e,t){return e!=null?re(Et,t.origin,e):t.origin}function ge(e,t,i){return e.hasSliceTranslatedView?t!=null?xt(ir,i.camera.viewMatrix,t):i.camera.viewMatrix:null}function Rt(e,t,i){if(i.slicePlane==null)return Lt;const r=me(e,t,i),s=pe(r,i.slicePlane),n=ge(e,r,i);return n!=null?Tt(Et,s,n):s}function Q(e,t,i,r){if(r==null||i.slicePlane==null)return Lt;const s=me(e,t,i),n=pe(s,i.slicePlane),a=ge(e,s,i);return a!=null?(w(et,r,n),Tt(Et,n,a),Tt(et,et,a),re(et,et,Et)):r}const er=b(),Et=b(),et=b(),ir=ht();function an(e,t){if(t.output!==dt.ObjectAndLayerIdColor)return e.vertex.code.add(u`void forwardObjectAndLayerIdColor() {}`),void e.fragment.code.add(u`void outputObjectAndLayerIdColor() {}`);const i=t.objectAndLayerIdColorInstanced;e.varyings.add("objectAndLayerIdColorVarying","vec4"),e.attributes.add(i?S.INSTANCEOBJECTANDLAYERIDCOLOR:S.OBJECTANDLAYERIDCOLOR,"vec4"),e.vertex.code.add(u`
    void forwardObjectAndLayerIdColor() {
      objectAndLayerIdColorVarying = ${i?"instanceObjectAndLayerIdColor":"objectAndLayerIdColor"} * 0.003921568627451;
    }`),e.fragment.code.add(u`void outputObjectAndLayerIdColor() {
fragColor = objectAndLayerIdColorVarying;
}`)}let rr=class extends ${constructor(t,i,r){super(t,"vec4",x.Pass,(s,n,a)=>s.setUniform4fv(t,i(n,a)),r)}},sr=class extends ${constructor(t,i,r){super(t,"float",x.Pass,(s,n,a)=>s.setUniform1fv(t,i(n,a)),r)}};function cn(e,t){const{vertex:i,attributes:r}=e;t.hasVvInstancing&&(t.vvSize||t.vvColor)&&r.add(S.INSTANCEFEATUREATTRIBUTE,"vec4"),t.vvSize?(i.uniforms.add(new L("vvSizeMinSize",s=>s.vvSize.minSize)),i.uniforms.add(new L("vvSizeMaxSize",s=>s.vvSize.maxSize)),i.uniforms.add(new L("vvSizeOffset",s=>s.vvSize.offset)),i.uniforms.add(new L("vvSizeFactor",s=>s.vvSize.factor)),i.uniforms.add(new ye("vvSymbolRotationMatrix",s=>s.vvSymbolRotationMatrix)),i.uniforms.add(new L("vvSymbolAnchor",s=>s.vvSymbolAnchor)),i.code.add(u`vec3 vvScale(vec4 _featureAttribute) {
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),i.code.add(u`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);
        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);
      }

      ${t.hasVvInstancing?u`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):i.code.add(u`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),t.vvColor?(i.constants.add("vvColorNumber","int",Pt),i.uniforms.add(new sr("vvColorValues",s=>s.vvColor.values,Pt),new rr("vvColorColors",s=>s.vvColor.colors,Pt)),i.code.add(u`
      vec4 interpolateVVColor(float value) {
        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${t.hasVvInstancing?u`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }`:"vec4 vvColor() { return vec4(1.0); }"}
    `)):i.code.add(u`vec4 vvColor() { return vec4(1.0); }`)}let nr=class extends ${constructor(t,i){super(t,"mat4",x.Draw,(r,s,n)=>r.setUniformMatrix4fv(t,i(s,n)))}};function dn(e,t){t.instancedDoublePrecision?e.constants.add("cameraPosition","vec3",Lt):e.uniforms.add(new R("cameraPosition",(i,r)=>P(ve,r.camera.viewInverseTransposeMatrix[3]-i.origin[0],r.camera.viewInverseTransposeMatrix[7]-i.origin[1],r.camera.viewInverseTransposeMatrix[11]-i.origin[2])))}function hn(e,t){if(!t.instancedDoublePrecision)return void e.uniforms.add(new _t("proj",r=>r.camera.projectionMatrix),new nr("view",(r,s)=>xt(qt,s.camera.viewMatrix,r.origin)),new R("localOrigin",r=>r.origin));const i=({camera:r})=>P(ve,r.viewInverseTransposeMatrix[3],r.viewInverseTransposeMatrix[7],r.viewInverseTransposeMatrix[11]);e.uniforms.add(new _t("proj",r=>r.camera.projectionMatrix),new _t("view",r=>xt(qt,r.camera.viewMatrix,i(r))),new wi("localOrigin",r=>i(r)))}const qt=ht(),ve=b();function fn(e){e.uniforms.add(new _t("viewNormal",t=>t.camera.viewInverseTransposeMatrix))}function mn(e){e.uniforms.add(new Ii("pixelRatio",t=>t.camera.pixelRatio/t.overlayStretch))}function ar(){return Qt??(Qt=(async()=>{const e=await Ti(()=>import("./basis_transcoder-B40h2JNH.js"),[],import.meta.url),t=await e.default({locateFile:i=>pi(`esri/libs/basisu/${i}`)});return t.initializeBasis(),t})()),Qt}let Qt,y=null,gt=null;async function _e(){return gt==null&&(gt=ar(),y=await gt),gt}function or(e,t){if(y==null)return e.byteLength;const i=new y.BasisFile(new Uint8Array(e)),r=xe(i)?Te(i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),t):0;return i.close(),i.delete(),r}function lr(e,t){if(y==null)return e.byteLength;const i=new y.KTX2File(new Uint8Array(e)),r=Ae(i)?Te(i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),t):0;return i.close(),i.delete(),r}function Te(e,t,i,r,s){const n=Ne(t?D.COMPRESSED_RGBA8_ETC2_EAC:D.COMPRESSED_RGB8_ETC2),a=s&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(i*r*n*a)}function xe(e){return e.getNumImages()>=1&&!e.isUASTC()}function Ae(e){return e.getFaces()>=1&&e.isETC1S()}async function cr(e,t,i){y==null&&(y=await _e());const r=new y.BasisFile(new Uint8Array(i));if(!xe(r))return null;r.startTranscoding();const s=Ee(e,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(n,a)=>r.getImageTranscodedSizeInBytes(0,n,a),(n,a,o)=>r.transcodeImage(o,0,n,a,0,0));return r.close(),r.delete(),s}async function ur(e,t,i){y==null&&(y=await _e());const r=new y.KTX2File(new Uint8Array(i));if(!Ae(r))return null;r.startTranscoding();const s=Ee(e,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(n,a)=>r.getImageTranscodedSizeInBytes(n,0,0,a),(n,a,o)=>r.transcodeImage(o,n,0,0,a,0,-1,-1));return r.close(),r.delete(),s}function Ee(e,t,i,r,s,n,a,o){const{compressedTextureETC:c,compressedTextureS3TC:d}=e.capabilities,[l,h]=c?r?[J.ETC2_RGBA,D.COMPRESSED_RGBA8_ETC2_EAC]:[J.ETC1_RGB,D.COMPRESSED_RGB8_ETC2]:d?r?[J.BC3_RGBA,D.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[J.BC1_RGB,D.COMPRESSED_RGB_S3TC_DXT1_EXT]:[J.RGBA32,K.RGBA],A=t.hasMipmap?i:Math.min(1,i),f=[];for(let m=0;m<A;m++)f.push(new Uint8Array(a(m,l))),o(m,l,f[m]);return t.internalFormat=h,t.hasMipmap=f.length>1,t.samplingMode=t.hasMipmap?q.LINEAR_MIPMAP_LINEAR:q.LINEAR,t.width=s,t.height=n,new at(e,t,{type:"compressed",levels:f})}const vt=()=>Jt.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),dr=542327876,hr=131072,fr=4;function Ut(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function mr(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}const pr=Ut("DXT1"),gr=Ut("DXT3"),vr=Ut("DXT5"),_r=31,Tr=0,xr=1,Ar=2,Er=3,$r=4,Cr=7,Pr=20,Sr=21;function yr(e,t,i){const r=br(i,t.hasMipmap??!1);if(r==null)throw new Error("DDS texture data is null");const{textureData:s,internalFormat:n,width:a,height:o}=r;return t.samplingMode=s.levels.length>1?q.LINEAR_MIPMAP_LINEAR:q.LINEAR,t.hasMipmap=s.levels.length>1,t.internalFormat=n,t.width=a,t.height=o,new at(e,t,s)}function br(e,t){const i=new Int32Array(e.buffer,e.byteOffset,_r);if(i[Tr]!==dr)return vt().error("Invalid magic number in DDS header"),null;if(!(i[Pr]&fr))return vt().error("Unsupported format, must contain a FourCC code"),null;const r=i[Sr];let s,n;switch(r){case pr:s=8,n=D.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case gr:s=16,n=D.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case vr:s=16,n=D.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return vt().error("Unsupported FourCC code:",mr(r)),null}let a=1,o=i[$r],c=i[Er];(3&o||3&c)&&(vt().warn("Rounding up compressed texture size to nearest multiple of 4."),o=o+3&-4,c=c+3&-4);const d=o,l=c;let h,A;i[Ar]&hr&&t!==!1&&(a=Math.max(1,i[Cr]));let f=e.byteOffset+i[xr]+4;const m=[];for(let E=0;E<a;++E)A=(o+3>>2)*(c+3>>2)*s,h=new Uint8Array(e.buffer,f,A),m.push(h),f+=A,o=Math.max(1,o>>1),c=Math.max(1,c>>1);return{textureData:{type:"compressed",levels:m},internalFormat:n,width:d,height:l}}const $t=16;function pn(e){return Math.ceil(e/$t)*$t}function gn(e){return Math.floor(e/$t)*$t}function wr(e,t){let n=e.width*e.height;if(n<4096)return e instanceof ImageData?$e(e):e;let a=e.width,o=e.height;do a=Math.ceil(a/2),o=Math.ceil(o/2),n=a*o;while(n>1048576||t!=null&&(a>t||o>t));return zt(e,a,o)}function Ir(e,t){const i=Math.max(e.width,e.height);if(i<=t)return e;const r=t/i;return zt(e,Math.round(e.width*r),Math.round(e.height*r))}function zt(e,t,i){if(e instanceof ImageData)return zt($e(e),t,i);const r=document.createElement("canvas");return r.width=t,r.height=i,r.getContext("2d").drawImage(e,0,0,r.width,r.height),r}function $e(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");if(i==null)throw new te("Failed to create 2d context from HTMLCanvasElement");return i.putImageData(e,0,0),t}let vn=class extends ee{constructor(t,i){super(),this._data=t,this.type=st.Texture,this.events=new mi,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this._parameters={...Lr,...i},this._startPreload(t)}dispose(){this.unload(),this._data=this.frameUpdate=void 0}_startPreload(t){t!=null&&(t instanceof HTMLVideoElement?(this.frameUpdate=i=>this._frameUpdate(t,i),this._startPreloadVideoElement(t)):t instanceof HTMLImageElement&&this._startPreloadImageElement(t))}_startPreloadVideoElement(t){if(!(Bt(t.src)||t.preload==="auto"&&t.crossOrigin)){t.preload="auto",t.crossOrigin="anonymous";const i=!t.paused;if(t.src=t.src,i&&t.autoplay){const r=()=>{t.removeEventListener("canplay",r),t.play()};t.addEventListener("canplay",r)}}}_startPreloadImageElement(t){gi(t.src)||Bt(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}_createDescriptor(t){const i=new Fe;return i.wrapMode=this._parameters.wrap??wt.REPEAT,i.flipped=!this._parameters.noUnpackFlip,i.samplingMode=this._parameters.mipmap?q.LINEAR_MIPMAP_LINEAR:q.LINEAR,i.hasMipmap=!!this._parameters.mipmap,i.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,i.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?t.parameters.maxMaxAnisotropy:1),i}get glTexture(){return this._glTexture}get memoryEstimate(){var t;return((t=this._glTexture)==null?void 0:t.usedMemory)||Or(this._data,this._parameters)}load(t){if(this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;const i=this._data;return i==null?(this._glTexture=new at(t,this._createDescriptor(t),null),this._glTexture):(this._parameters.reloadable||(this._data=void 0),typeof i=="string"?this._loadFromURL(t,i):i instanceof Image?this._loadFromImageElement(t,i):i instanceof HTMLVideoElement?this._loadFromVideoElement(t,i):i instanceof ImageData||i instanceof HTMLCanvasElement?this._loadFromImage(t,i):it(i)&&this._parameters.encoding===X.DDS_ENCODING?this._loadFromDDSData(t,i):rt(i)&&this._parameters.encoding===X.DDS_ENCODING?this._loadFromDDSData(t,new Uint8Array(i)):(rt(i)||it(i))&&this._parameters.encoding===X.KTX2_ENCODING?this._loadFromKTX2(t,i):(rt(i)||it(i))&&this._parameters.encoding===X.BASIS_ENCODING?this._loadFromBasis(t,i):it(i)?this._loadFromPixelData(t,i):rt(i)?this._loadFromPixelData(t,new Uint8Array(i)):null)}_frameUpdate(t,i){return this._glTexture==null||t.readyState<ct.HAVE_CURRENT_DATA||i===t.currentTime?i:(this._glTexture.setData(t),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),t.currentTime)}_loadFromDDSData(t,i){return this._glTexture=yr(t,this._createDescriptor(t),i),this._glTexture}_loadFromKTX2(t,i){return this._loadAsync(()=>ur(t,this._createDescriptor(t),i).then(r=>(this._glTexture=r,r)))}_loadFromBasis(t,i){return this._loadAsync(()=>cr(t,this._createDescriptor(t),i).then(r=>(this._glTexture=r,r)))}_loadFromPixelData(t,i){W(this._parameters.width>0&&this._parameters.height>0);const r=this._createDescriptor(t);return r.pixelFormat=this._parameters.components===1?K.LUMINANCE:this._parameters.components===3?K.RGB:K.RGBA,r.width=this._parameters.width??0,r.height=this._parameters.height??0,this._glTexture=new at(t,r,i),this._glTexture}_loadFromURL(t,i){return this._loadAsync(async r=>{const s=await _i(i,{signal:r});return Nt(r),this._loadFromImage(t,s)})}_loadFromImageElement(t,i){return i.complete?this._loadFromImage(t,i):this._loadAsync(async r=>{const s=await vi(i,i.src,!1,r);return Nt(r),this._loadFromImage(t,s)})}_loadFromVideoElement(t,i){return i.readyState>=ct.HAVE_CURRENT_DATA?this._loadFromImage(t,i):this._loadFromVideoElementAsync(t,i)}_loadFromVideoElementAsync(t,i){return this._loadAsync(r=>new Promise((s,n)=>{const a=()=>{i.removeEventListener("loadeddata",o),i.removeEventListener("error",c),Me(d)},o=()=>{i.readyState>=ct.HAVE_CURRENT_DATA&&(a(),s(this._loadFromImage(t,i)))},c=l=>{a(),n(l||new te("Failed to load video"))};i.addEventListener("loadeddata",o),i.addEventListener("error",c);const d=Oe(r,()=>c(Le()))}))}_loadFromImage(t,i){let r=i;if(!(r instanceof HTMLVideoElement)){const{maxTextureSize:a}=t.parameters;r=this._parameters.downsampleUncompressed?wr(r,a):Ir(r,a)}const s=Ce(r);this._parameters.width=s.width,this._parameters.height=s.height;const n=this._createDescriptor(t);return n.pixelFormat=this._parameters.components===3?K.RGB:K.RGBA,n.width=s.width,n.height=s.height,n.shouldCompress=this._parameters.shouldCompress,this._glTexture=new at(t,n,r),this._glTexture}_loadAsync(t){const i=new AbortController;this._loadingController=i;const r=t(i.signal);this._loadingPromise=r;const s=()=>{this._loadingController===i&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(s,s),r}unload(){if(this._glTexture=bt(this._glTexture),this._loadingController!=null){const t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}};function Or(e,t){if(e==null)return 0;if(rt(e)||it(e))return t.encoding===X.KTX2_ENCODING?lr(e,!!t.mipmap):t.encoding===X.BASIS_ENCODING?or(e,!!t.mipmap):e.byteLength;const{width:i,height:r}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?Ce(e):t;return(t.mipmap?4/3:1)*i*r*(t.components||4)||0}function Ce(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}var ct;(function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(ct||(ct={}));const Lr={wrap:{s:wt.REPEAT,t:wt.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1,downsampleUncompressed:!1,shouldCompress:!1};function Tn(e,{occlusionPass:t,terrainDepthTest:i,cullAboveTerrain:r}){const s=e.vertex,n=e.fragment;if(!i)return s.code.add("void forwardViewPosDepth(vec3 pos) {}"),void n.code.add(`${t?"bool":"void"} discardByTerrainDepth() { ${N(t,"return false;")}}`);e.varyings.add("viewPosDepth","float"),s.code.add(`void forwardViewPosDepth(vec3 pos) {
    viewPosDepth = pos.z;
  }`),n.include(Ci),n.uniforms.add(new It("terrainDepthTexture",a=>{var o;return(o=a.terrainDepth)==null?void 0:o.attachment})).code.add(u`
    ${t?"bool":"void"} discardByTerrainDepth() {
      float depth = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0).r;
      float linearDepth = linearizeDepth(depth);
      ${t?"return viewPosDepth < linearDepth && depth < 1.0;":`if(viewPosDepth ${r?">":"<="} linearDepth) discard;`}
    }`)}function Mr(e){e.code.add(u`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}let Dr=class extends ${constructor(t,i){super(t,"ivec2",x.Bind,(r,s)=>r.setUniform2iv(t,i(s)))}};function Rr(e,t){const{fragment:i}=e;t.output===dt.Highlight?(i.uniforms.add(new It("depthTexture",r=>r.mainDepth),new It("highlightTexture",r=>r.highlightMixTexture),new Ri("highlightLevel",r=>r.highlightLevel??0),new Dr("highlightMixOrigin",r=>r.highlightMixOrigin)),e.outputs.add("fragHighlight","vec2",0),e.include(Di),i.code.add(u`vec2 getAccumulatedHighlight() {
return texelFetch(highlightTexture, ivec2(gl_FragCoord.xy) - highlightMixOrigin, 0).rg;
}
void outputHighlight(bool occluded) {
if (highlightLevel == 0) {
uint bits = occluded ? 3u : 1u;
fragHighlight = vec2(float(bits) / 255.0, 0.0);
} else {
int ll = (highlightLevel & 3) << 1;
int li = (highlightLevel >> 2) & 3;
uint bits;
if (occluded) {
bits = 3u << ll;
} else {
bits = 1u << ll;
}
vec2 combinedHighlight = getAccumulatedHighlight();
uint accumulatedI = uint(combinedHighlight[li] * 255.0);
combinedHighlight[li] = float(bits | accumulatedI) / 255.0;
fragHighlight = combinedHighlight;
}
}
bool isHighlightOccluded() {
float sceneDepth = texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x;
return gl_FragCoord.z > sceneDepth + 5e-7;
}
void calculateOcclusionAndOutputHighlight() {
outputHighlight(isHighlightOccluded());
}`),t.canHaveOverlay&&i.code.add(u`void calculateOcclusionAndOutputHighlightOverlay(vec2 highlightToAdd) {
uint levelBits = readLevelBits(highlightToAdd, highlightLevel);
if ((levelBits & 1u) == 0u) { discard; }
outputHighlight(isHighlightOccluded());
}`)):i.code.add(u`void calculateOcclusionAndOutputHighlight() {}`)}const Ur=1/255.5;function An(e,t){e.include(Rr,t),e.include(Ji,t),e.fragment.include(Mr);const i=t.output===dt.ObjectAndLayerIdColor,r=Yt(t.output),s=yt(t.output)&&t.oitPass===g.ColorAlpha,n=yt(t.output)&&t.oitPass!==g.ColorAlpha,a=t.discardInvisibleFragments;let o=0;(n||r||s)&&e.outputs.add("fragColor","vec4",o++),r&&e.outputs.add("fragEmission","vec4",o++),s&&e.outputs.add("fragAlpha","float",o++),e.fragment.code.add(u`
    void outputColorHighlightOID(vec4 finalColor, const in vec3 vWorldPosition) {
      ${N(i,"finalColor.a = 1.0;")}

      ${N(a,`if (finalColor.a < ${u.float(Ur)}) { discard; }`)}

      finalColor = applySlice(finalColor, vWorldPosition);
      ${N(s,u`fragColor = premultiplyAlpha(finalColor);
             fragAlpha = finalColor.a;`)}
      ${N(n,"fragColor = finalColor;")}
      ${N(r,"fragEmission = finalColor.a * getEmissions();")}
      calculateOcclusionAndOutputHighlight();
      ${N(i,"outputObjectAndLayerIdColor();")}
    }
  `)}const Pe=Ge(ft.ONE,ft.ZERO,ft.ONE,ft.ONE_MINUS_SRC_ALPHA);function En(e){return e===g.FrontFace?null:Pe}function $n(e){switch(e){case g.NONE:return je;case g.ColorAlpha:return Pe;case g.FrontFace:case g.COUNT:return null}}function Cn(e){if(e.draped)return null;switch(e.oitPass){case g.NONE:case g.FrontFace:return e.writeDepth?Ke:null;case g.ColorAlpha:case g.COUNT:return null}}const Pn=5e5,zr={factor:-1,units:-2};function Sn(e){return e?zr:null}function yn(e,t=O.LESS){return e===g.NONE||e===g.FrontFace?t:O.LEQUAL}function bn(e,t){const i=Yt(t);return e===g.ColorAlpha?i?{buffers:[H.COLOR_ATTACHMENT0,H.COLOR_ATTACHMENT1,H.COLOR_ATTACHMENT2]}:{buffers:[H.COLOR_ATTACHMENT0,H.COLOR_ATTACHMENT1]}:i?{buffers:[H.COLOR_ATTACHMENT0,H.COLOR_ATTACHMENT1]}:null}const wn={func:O.LESS},In={func:O.ALWAYS},On={mask:255},Ln={mask:0},Mn=e=>({function:{func:O.NOTEQUAL,ref:e,mask:e},operation:{fail:v.KEEP,zFail:v.KEEP,zPass:v.KEEP}}),Dn=e=>({function:{func:O.ALWAYS,ref:e,mask:e},operation:{fail:v.KEEP,zFail:v.KEEP,zPass:v.REPLACE}}),Rn={function:{func:O.ALWAYS,ref:V.OutlineVisualElementMask,mask:V.OutlineVisualElementMask},operation:{fail:v.KEEP,zFail:v.KEEP,zPass:v.ZERO}},Un={function:{func:O.ALWAYS,ref:V.OutlineVisualElementMask,mask:V.OutlineVisualElementMask},operation:{fail:v.KEEP,zFail:v.KEEP,zPass:v.REPLACE}},zn={function:{func:O.EQUAL,ref:V.OutlineVisualElementMask,mask:V.OutlineVisualElementMask},operation:{fail:v.KEEP,zFail:v.KEEP,zPass:v.KEEP}},Nn={function:{func:O.NOTEQUAL,ref:V.OutlineVisualElementMask,mask:V.OutlineVisualElementMask},operation:{fail:v.KEEP,zFail:v.KEEP,zPass:v.KEEP}};function Fn(e,t=!1){return e<=ut?t?new Array(e).fill(0):new Array(e):new Float32Array(e)}function Vn(e){return Array.isArray(e)?e.length<ut?e:new Float32Array(e):e.length<ut?Array.from(e):e}function Hn(e){return(Array.isArray(e)?e.length:e.byteLength/8)<=ut?Array.from(e):new Float32Array(e)}function Bn(e,t,i){return Array.isArray(e)?e.slice(t,t+i):e.subarray(t,t+i)}export{On as $,Gt as A,Rr as B,g as C,bn as D,St as E,At as F,sn as G,An as H,$n as I,Cn as J,zr as K,wi as L,Mi as M,vn as N,zs as O,nr as P,pn as Q,_e as R,Vn as S,En as T,wr as U,zi as V,Ws as W,Ui as X,Oi as Y,Ri as Z,yn as _,$i as a,Un as a0,Rn as a1,Sn as a2,Pn as a3,vs as a4,sr as a5,In as a6,Nn as a7,Ln as a8,zn as a9,wn as aa,Qs as ab,qs as ac,gn as ad,Li as ae,tn as af,Di as ag,js as ah,Ks as ai,Gs as aj,Xs as ak,Bn as al,Pt as am,rr as an,Mn as ao,rn as ap,Dn as aq,Hn as b,Ls as c,dn as d,Rs as e,Fs as f,hn as g,Ii as h,It as i,Ei as j,yi as k,Ci as l,Ss as m,Fn as n,bs as o,fn as p,I as q,Ur as r,xs as s,$s as t,Tn as u,nn as v,mn as w,cn as x,an as y,Mr as z};
