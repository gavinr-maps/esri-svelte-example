const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./calcite-action-eUVYjjgY.js","./action-CFB8-9mS.js","./jsxFactory-Be5PKa9i.js","./Evented-CXIxDjmW.js","./Accessor-D6mNnsWy.js","./subclass-BR3PhgZG.js","./intl-CArXn1et.js","./Promise-CZrWwByK.js","./jsonMap-DCC6W5ex.js","./assets-BNizZMOZ.js","./index-BVncS3aY.js","./index-CjOb8WjV.css","./reactiveUtils-BFQ0BtrB.js","./shared-B3wH2qpO.js","./uuid-fwrPAdZb.js","./dom-BkQ_hHOr.js","./interactive-QOqfpSSx.js","./loadable-Bgtgv1lm.js","./locale-BvYy6Wxh.js","./key-D5DPfjW0.js","./observers-DSkGD1TQ.js","./component-ByvC-PUv.js","./t9n-Atzq4sOi.js","./icon-D6t4qKDg.js","./loader-ew3V3w9x.js","./calcite-block-CcSPCrEC.js","./conditionalSlot-eNLH0S30.js","./Heading-DQrTi3L3.js","./openCloseComponent-Bqj9CrBJ.js","./action-menu-M1XR2Dkh.js","./array-DofFqflK.js","./popover-DLRbisRr.js","./floating-ui-5U9KNmUg.js","./debounce-C5YDvsuO.js","./focusTrapComponent-Bepj0OOn.js","./FloatingArrow-BN7WHE4B.js","./handle-DVEsJI64.js","./scrim-fRLdjgt6.js","./calcite-icon-DtUarwQp.js","./calcite-notice-CVdHfJFK.js","./calcite-option-CMhra6rd.js","./calcite-select-BWZbWbHD.js","./form-BOCdnUd9.js","./label-1rGx7O4B.js","./Validation-Dm76Kltf.js","./input-message-BGlL44gg.js","./calcite-tooltip-5IY_tl60.js"])))=>i.map(i=>d[i]);
import{_ as h}from"./index-BVncS3aY.js";import{e as s}from"./Evented-CXIxDjmW.js";import{y as a,b as m,n as v,c as g}from"./subclass-BR3PhgZG.js";import{e as k,B as x,r as V,n as e}from"./jsxFactory-Be5PKa9i.js";import"./intl-CArXn1et.js";import{S as N}from"./Accessor-D6mNnsWy.js";import{V as T,d as f,P as L,v as A}from"./reactiveUtils-BFQ0BtrB.js";import{h as C}from"./UpdatingHandles-CMtXpTiG.js";import{r as D,x as b}from"./layerUtils-BzjQnEdj.js";import{C as I}from"./Portal-DCqdz-K4.js";import{t as S}from"./utils-BO9vnABf.js";import{e as $,h as P}from"./Promise-CZrWwByK.js";import"./uuid-fwrPAdZb.js";import"./jsonMap-DCC6W5ex.js";import"./assets-BNizZMOZ.js";import"./shared-B3wH2qpO.js";import"./writer-3zufXUNV.js";import"./Extent-B4rrMrqp.js";import"./Point-TlcsOcXV.js";const w={noDirtyAreasInExtent:-2147208940,noUtilityNetworkExtension:-2147208474,cannotAcquireVersionLock_v10:-2147217146,cannotAcquireVersionLock_v11:-2147220947};let d=class extends N{constructor(t){super(t),this._activeOperationDidSucceed=!1,this._initialValidationsFinished=!1,this._dirtyAreasLayer=null,this._serverVersion=null,this._updatingHandles=new C,this._validConstructProperties=!1,this.executionError="",this.extentToValidate="current",this.loadErrors=new T}initialize(){const t=async()=>{this.messages||(this.messages=await P("esri/widgets/UtilityNetworkValidateTopology/t9n/UtilityNetworkValidateTopology"))};t().then(()=>{this.view||(this.view=null),this.utilityNetwork||(this.utilityNetwork=null),this.addHandles([f(()=>[this.view,this.utilityNetwork],async()=>{var n,l;const{loadErrors:i,messages:{info:{noUtilityNetwork:o,noView:r}}}=this;this._initialValidationsFinished=!1,i.removeAll(),this._validConstructProperties=!0,this._dirtyAreasLayer=null,this._serverVersion=null,((n=this.utilityNetwork)==null?void 0:n.type)!=="utility"&&(this.loadErrors.push(o),v.getLogger(this).error(new g("utilityNetworkValidateTopology:missing-property",o)),this._validConstructProperties=!1),((l=this.view)==null?void 0:l.type)!=="2d"&&(this.loadErrors.push(r),v.getLogger(this).error(new g("utilityNetworkValidateTopology:missing-property",r)),this._validConstructProperties=!1),this._validConstructProperties&&(this.utilityNetwork.loaded||await this.utilityNetwork.load().catch(u=>{v.getLogger(this).error(u),this._validConstructProperties=!1}),await this._setDirtyAreasLayer()),this._validConstructProperties&&await this._validateNetworkExtension()},L),A(()=>{var i,o;return(o=(i=this.view)==null?void 0:i.map)==null?void 0:o.layers},"change",async()=>{const{loadErrors:i,messages:{info:{noUtilityNetwork:o}}}=this,r=i.find(n=>n===o);this._initialValidationsFinished=!1,r||(i.removeAll(),await this._validateNetworkExtension(),await this._setDirtyAreasLayer()),this._initialValidationsFinished=!0}),$(t)])})}destroy(){this._updatingHandles.destroy()}get state(){return this.loadErrors.length||!this._validConstructProperties?"disabled":this.executionError?"failed":this._updatingHandles.updating?"executing":this._activeOperationDidSucceed?"success":this._initialValidationsFinished?"ready":"loading"}set utilityNetwork(t){this._get("utilityNetwork")!==t&&this._set("utilityNetwork",t)}set view(t){this._get("view")!==t&&this._set("view",t)}async validateTopology(){var n;const{messages:{info:{cannotAcquireVersionLock:t,noDirtyAreasInExtent:i}},utilityNetwork:o,view:r}=this;this.loadErrors.length||(this._activeOperationDidSucceed=!1,this._set("executionError",""),this._updatingHandles.addPromise(o==null?void 0:o.validateTopology({validateArea:this.extentToValidate==="current"?r.extent.clone():o.fullExtent.clone(),outSpatialReference:((n=r.spatialReference)==null?void 0:n.clone())||null}).then(()=>{this._activeOperationDidSucceed=!0},l=>{var _;let u="Error: "+l;if(l instanceof g&&((_=l.details)!=null&&_.raw))switch(l.details.raw.extendedCode){case w.noDirtyAreasInExtent:u=i;break;case w.cannotAcquireVersionLock_v10:case w.cannotAcquireVersionLock_v11:u=t;break;default:u=l.details.message}this._set("executionError",u)})))}async _setDirtyAreasLayer(){var o;const{messages:{info:{noDirtyAreasLayer:t}}}=this,i=(o=this.view)==null?void 0:o.map.allLayers.items.filter(r=>D(r)).find(r=>{var n,l;return((n=r.parsedUrl)==null?void 0:n.path)===((l=this.utilityNetwork)==null?void 0:l.networkSystemLayers.dirtyAreasLayerUrl)});i?(this._dirtyAreasLayer=i,await this._dirtyAreasLayer.load(),this._serverVersion=this._dirtyAreasLayer.version??0,this._validConstructProperties=!0):(this.loadErrors.push(t),v.getLogger(this).error(new g("utilityNetworkValidateTopology:missing-layer",t)),this._validConstructProperties=!1)}async _validateNetworkExtension(){var u;const{messages:{info:{noAdvancedEditingUserTypeExtension:t,noUtilityNetworkServiceUserTypeExtension:i}}}=this,o=await b(this.utilityNetwork.layerUrl),r=new I({url:o});await r.load();const n=((u=r.user)==null?void 0:u.username)??"",l=Number(this._serverVersion)<=11.1?"utilityNetwork":"advediting";if(!await S(r,n,l)){const _=Number(this._serverVersion)<=11.1?i:t;this.loadErrors.push(_),v.getLogger(this).error(new g("utilityNetworkValidateTopology:no-user-type-extension",_)),this._validConstructProperties=!1}this._initialValidationsFinished=!0}};s([a()],d.prototype,"_initialValidationsFinished",void 0),s([a()],d.prototype,"_dirtyAreasLayer",void 0),s([a()],d.prototype,"_validConstructProperties",void 0),s([a({readOnly:!0})],d.prototype,"executionError",void 0),s([a()],d.prototype,"extentToValidate",void 0),s([a()],d.prototype,"loadErrors",void 0),s([a()],d.prototype,"messages",void 0),s([a({readOnly:!0})],d.prototype,"state",null),s([a()],d.prototype,"utilityNetwork",null),s([a()],d.prototype,"view",null),d=s([m("esri.widgets.UtilityNetworkValidateTopology.UtilityNetworkValidateTopologyViewModel")],d);const E=d,y="esri-un-validate-topology",c={container:`${y}__container`,content:`${y}__content`,controlsContainer:`${y}__controls-container`,statusIconError:`${y}__status-icon-error`,statusIconSuccess:`${y}__status-icon-success`,statusIconContainer:`${y}__status-icon-container`};let p=class extends x{constructor(t,i){super(t,i),this.messages=null,this.viewModel=new E}loadDependencies(){return V({action:()=>h(()=>import("./calcite-action-eUVYjjgY.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]),import.meta.url),block:()=>h(()=>import("./calcite-block-CcSPCrEC.js"),__vite__mapDeps([25,2,3,4,5,6,7,8,9,10,11,12,13,14,26,20,15,16,18,19,22,27,17,28,1,21,23,24,29,30,31,32,33,34,35,36,37]),import.meta.url),icon:()=>h(()=>import("./calcite-icon-DtUarwQp.js"),__vite__mapDeps([38,23,2,3,4,5,6,7,8,9,10,11,12,13,14,15,20]),import.meta.url),notice:()=>h(()=>import("./calcite-notice-CVdHfJFK.js"),__vite__mapDeps([39,2,3,4,5,6,7,8,9,10,11,12,13,14,26,20,15,17,18,19,22,28,21,23]),import.meta.url),option:()=>h(()=>import("./calcite-option-CMhra6rd.js"),__vite__mapDeps([40,2,3,4,5,6,7,8,9,10,11,12,13,14,20]),import.meta.url),select:()=>h(()=>import("./calcite-select-BWZbWbHD.js"),__vite__mapDeps([41,2,3,4,5,6,7,8,9,10,11,12,13,14,15,42,16,43,21,17,20,44,23,45]),import.meta.url),tooltip:()=>h(()=>import("./calcite-tooltip-5IY_tl60.js"),__vite__mapDeps([46,2,3,4,5,6,7,8,9,10,11,12,13,14,15,32,33,28,35]),import.meta.url)})}get extentToValidate(){return this.viewModel.extentToValidate}set extentToValidate(t){this.viewModel.extentToValidate=t}get icon(){return"check-circle"}set icon(t){this._overrideIfSome("icon",t)}get label(){var t;return((t=this.messages)==null?void 0:t.label)??""}set label(t){this._overrideIfSome("label",t)}get utilityNetwork(){return this.viewModel.utilityNetwork}set utilityNetwork(t){this.viewModel.utilityNetwork=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}render(){const{viewModel:t}=this;return t.state==="disabled"?e("div",{class:c.container},e("calcite-block",{class:c.content,collapsible:!1,heading:this.label,open:!0},this._renderLoadErrorStatusIcon(),this._renderLoadErrorsNotices())):e("div",{class:c.container},e("calcite-block",{class:c.content,collapsible:!0,heading:this.label,open:!1},this._renderStatusIcon(),this._renderValidateTopologyAction(),this._renderControls()))}_extentOptionSelectChange(t){this.extentToValidate=t.target.value}_getLoadErrorMessagesAsNotices(t,i){return e("calcite-notice",{closable:!1,key:"error-notice-"+i,kind:"warning",open:!0,scale:"s"},e("div",{slot:"message"},t))}_handleValidateTopologyAction(){this.viewModel.validateTopology().catch(()=>{})}_renderControls(){const{viewModel:t}=this;return t.state==="failed"?e("div",{class:c.controlsContainer},this._renderExtentOptionSelect(),this._renderStatusNotice()):this._renderExtentOptionSelect()}_renderExtentOptionSelect(){const{messages:t,viewModel:i}=this;return e("div",{key:"selectExtentDiv"},e("calcite-select",{bind:this,disabled:i.state==="loading"||i.state==="executing",label:t.input.extentToValidate,onCalciteSelectChange:this._extentOptionSelectChange},e("calcite-option",{value:"current"},t.input.currentExtent),e("calcite-option",{value:"entire"},t.input.entireExtent)))}_renderLoadErrorsNotices(){const{viewModel:t}=this;return e("div",{class:c.controlsContainer,key:"loadErrorsDiv"},t.loadErrors.items.map(this._getLoadErrorMessagesAsNotices))}_renderLoadErrorStatusIcon(){return e("div",{class:c.statusIconContainer,key:"statusDiv",slot:"control"},e("calcite-icon",{class:c.statusIconError,icon:"exclamation-mark-triangle",scale:"s"}))}_renderStatusIcon(){const{messages:t,viewModel:i}=this,o=`${this.id}-validation-status-action`,r=`${this.id}-error-status-icon`,n=`${this.id}-success-status-icon`,l=u=>{setTimeout(()=>{u.innerHTML=""},3500)};return i.state==="executing"?e("div",{key:"statusDivExecuting",slot:"control"},e("calcite-action",{id:o,loading:!0,text:t.status.executing}),e("calcite-tooltip",{referenceElement:o},e("span",null,t.status.executing))):i.state==="success"?e("div",{afterCreate:l,class:c.statusIconContainer,key:"statusDivSuccess",slot:"control"},e("calcite-icon",{class:c.statusIconSuccess,icon:"check-circle",id:n,scale:"s"}),e("calcite-tooltip",{referenceElement:n},e("span",null,t.status.success))):i.state==="failed"?e("div",{class:c.statusIconContainer,key:"statusDivFailed",slot:"control"},e("calcite-icon",{class:c.statusIconError,icon:"exclamation-mark-triangle",id:r,scale:"s"}),e("calcite-tooltip",{referenceElement:r},e("span",null,i.executionError))):e("div",{class:c.statusIconContainer,key:"statusDiv",slot:"control"})}_renderStatusNotice(){const{viewModel:t}=this;return e("div",{key:"executionErrorDiv"},e("calcite-notice",{closable:!0,kind:"warning",open:!0,scale:"s"},e("div",{slot:"message"},t.executionError)))}_renderValidateTopologyAction(){const{messages:t,viewModel:i}=this,o=`${this.id}-validation-action`;return e("div",{key:"actionDiv",slot:"control"},e("calcite-action",{bind:this,disabled:i.state==="executing",icon:"play-f",id:o,loading:i.state==="loading",onclick:this._handleValidateTopologyAction,text:t.input.validateTopology}),e("calcite-tooltip",{referenceElement:o},e("span",null,i.state==="loading"?t.status.loading:t.input.validateTopology)))}};s([a()],p.prototype,"extentToValidate",null),s([a()],p.prototype,"icon",null),s([a()],p.prototype,"label",null),s([a(),k("esri/widgets/UtilityNetworkValidateTopology/t9n/UtilityNetworkValidateTopology")],p.prototype,"messages",void 0),s([a()],p.prototype,"utilityNetwork",null),s([a()],p.prototype,"view",null),s([a({type:E})],p.prototype,"viewModel",void 0),p=s([m("esri.widgets.UtilityNetworkValidateTopology")],p);const et=p;export{et as default};
