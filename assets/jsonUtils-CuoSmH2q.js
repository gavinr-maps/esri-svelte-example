import{n as E,c as oe,a,y as r,b as $,Y as ne,t as le,O as ae,u as ue,d as pe}from"./subclass-BR3PhgZG.js";import{w as K}from"./ClassBreaksRenderer-DMO3d0Rn.js";import{e as i}from"./Evented-CXIxDjmW.js";import{r as J}from"./writer-3zufXUNV.js";import{i as ye,a3 as de,C as M,z as he}from"./fieldUtils-CNduWQU9.js";import{v as B,p as V,j as ce,A as Q}from"./UniqueValueRenderer-dci9bLM8.js";import{u as w}from"./Color-DDUWtbqR.js";import{U as G,f as C}from"./assets-C2mb-ea2.js";import{e as me}from"./LRUCache-ju6LnIBZ.js";import{b as fe,v as ge,O as be}from"./Accessor-D6mNnsWy.js";import{r as we}from"./Version-_Vxue7Ui.js";import{Z as ve}from"./FieldsIndex-IOXc-mnc.js";import{d as xe}from"./symbols-CsUQ5BxR.js";import{y as Se}from"./OverrideHelper-C4oumxVn.js";import{B as $e,j as _e}from"./utils-CO7DMJWl.js";import{o as z}from"./enumeration--HlxOQ_N.js";import{s as je}from"./jsonMap-DCC6W5ex.js";import{d as U,S as W,y as X}from"./TextSymbol-gKE-H_J6.js";import{o as ee}from"./screenUtils-PfxkaaMN.js";import{l as N}from"./HeatmapColorStop-CgvKf0-E.js";import{i as L}from"./Clonable-cKbRam6-.js";import{a as Ie,e as De,c as Ee}from"./heatmapUtils-C-uT6ZIV.js";import{p as te}from"./SimpleRenderer-DvJZ7cyq.js";const Z="esri.renderers.support.DictionaryLoader",Pe={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};class ie{constructor(t,s,o){this.config=null,this.fieldMap=null,this.url=null,this._ongoingRequests=new Map,this._symbolCache=new me(100),this._dictionaryVersion=null,this._fieldIndex=null,this._dictionaryPromise=null,this.url=t,this.config=s,this.fieldMap=o}getSymbolFields(){return this._symbolFields}async getSymbolAsync(t,s){var I;let o;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(s));try{o=await this._dictionaryPromise}catch(y){if(fe(y))return this._dictionaryPromise=null,null}const d=(I=this._dictionaryVersion)==null?void 0:I.since(4,0),l={};if(this.fieldMap)for(const y of this._symbolFields){const n=$e(this.fieldMap[y],this._fieldIndex);if(n){const h=t.attributes[n];l[y]=d?h:h!=null?""+t.attributes[n]:""}else l[y]=""}let u=null;try{u=o==null?void 0:o(l,s)}catch{return null}if(!u||typeof u!="string"||u==="invalid")return null;const v=u.split(";"),_=[],m=[];for(const y of v)if(y)if(y.includes("po:")){const n=y.substr(3).split("|");if(n.length===3){const h=n[0],x=n[1];let g=n[2];if(x==="DashTemplate")g=g.split(" ").map(j=>Number(j));else if(x==="Color"){const j=new w(g).toRgba();g=[j[0],j[1],j[2],255*j[3]]}else g=Number(g);m.push({primitiveName:h,propertyName:x,value:g,defaultValue:null})}}else if(y.includes("|")){for(const n of y.split("|"))if(this._itemNames.has(n)){_.push(n);break}}else this._itemNames.has(y)&&_.push(y);const P=t.geometry==null||!t.geometry.hasZ&&t.geometry.type==="point";return this._cimPartsToCIMSymbol(t,_,m,P,s)}async fetchResources(t){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void E.getLogger(Z).error("no valid URL!");const s=G(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},signal:t!=null?t.signal:null}),[{data:o}]=await Promise.all([s,ye()]);if(!o)throw this._dictionaryPromise=null,new oe("esri.renderers.DictionaryRenderer","Bad dictionary data!");const{authoringInfo:d,dictionary_version:l,expression:u,itemsNames:v}=o,_=u;let m=!1;l&&(this._dictionaryVersion=we.parse(l),m=this._dictionaryVersion.since(4,0)),this._refSymbolUrlTemplate=this.url+"/"+o.cimRefTemplateUrl,this._itemNames=new Set(v),this._symbolFields=d.symbol;const P={};if(this.config){const n=this.config;for(const h in n)P[h]=n[h]}if(d.configuration)for(const n of d.configuration)P.hasOwnProperty(n.name)||(P[n.name]=n.value);const I=[];if(t!=null&&t.fields&&this.fieldMap)for(const n in this.fieldMap){const h=this.fieldMap[n],x=t.fields.filter(g=>g.name.toLowerCase()===(h==null?void 0:h.toLowerCase()));x.length>0&&I.push({...x[0],type:m?x[0].type:"esriFieldTypeString"})}I.length>0&&(this._fieldIndex=new ve(I));const y=de(_,t!=null?t.spatialReference:null,I,P).then(n=>{const h={scale:0};return(x,g)=>{if(n==null)return null;const j=n.repurposeFeature({geometry:null,attributes:x});return h.scale=g!=null?g.scale??void 0:void 0,n.evaluate({$feature:j,$view:h},n.services)}}).catch(n=>(E.getLogger(Z).error("Creating dictionary expression failed:",n),null));return this._dictionaryPromise=y,y}async _cimPartsToCIMSymbol(t,s,o,d,l){const u=new Array(s.length);for(let m=0;m<s.length;m++)u[m]=this._getSymbolPart(s[m],l);let v=await Promise.all(u);const _=this.fieldMap;if(_){v=a(v);for(const m of v)Se.applyDictionaryTextOverrides(m,t,_,this._fieldIndex,_e(m))}return new xe({data:Re(v,o,d)})}async _getSymbolPart(t,s){const o=this._symbolCache.get(t);if(o)return o;if(this._ongoingRequests.has(t))return this._ongoingRequests.get(t).then(u=>u.data);const d=this._refSymbolUrlTemplate.replaceAll(/\{itemName\}/gi,t),l=G(d,{responseType:"json",query:{f:"json"},...s});this._ongoingRequests.set(t,l),l.finally(()=>this._ongoingRequests.delete(t));try{const u=await l;return this._symbolCache.put(t,u.data),u.data}catch(u){throw u}}}function Re(e,t,s){if(!e||e.length===0)return null;const o={...e[0]};if(e.length>1){o.symbolLayers=[];for(const d of e){const l=d;o.symbolLayers.unshift(...l.symbolLayers)}}return s&&(o.callout=Pe),{type:"CIMSymbolReference",symbol:o,primitiveOverrides:t}}var q;let b=q=class extends B(V){constructor(e){super(e),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type="dictionary"}get _loader(){return new ie(this.url,this.config,this.fieldMap)}writeData(e,t){e&&(t.scalingExpressionInfo={expression:e,returnType:"number"})}writeVisualVariables(e,t,s,o){o!=null&&o.origin||super.writeVisualVariables(e,t,s,o)}clone(){return new q({config:a(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:a(this.fieldMap),url:a(this.url),visualVariables:a(this.visualVariables)})}async getSymbolAsync(e,t){return this._loader.getSymbolAsync(e,t)}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t),this.scaleExpression&&await M(e,t,this.scaleExpression);for(const s in this.fieldMap){const o=this.fieldMap[s];t.has(o)&&e.add(o)}}get arcadeRequired(){return!0}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._loader.getSymbolFields()}};i([r({type:ie})],b.prototype,"_loader",null),i([r({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],b.prototype,"config",void 0),i([r({type:Object,json:{write:!0}})],b.prototype,"fieldMap",void 0),i([r({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],b.prototype,"scaleExpression",void 0),i([J("scaleExpression")],b.prototype,"writeData",null),i([r({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(e){return{enabled:!!e&&!!this.scaleExpression}}}}})],b.prototype,"scaleExpressionTitle",void 0),i([r({type:String,json:{write:!0}})],b.prototype,"url",void 0),i([J("visualVariables")],b.prototype,"writeVisualVariables",null),b=q=i([$("esri.renderers.DictionaryRenderer")],b);const Ve=b;var A;let S=A=class extends C{constructor(e){super(e),this.color=null,this.field=null,this.label=null,this.valueExpression=null,this.valueExpressionTitle=null}castField(e){return e==null?e:typeof e=="function"?(E.getLogger(this).error(".field: field must be a string value"),null):ne(e)}getAttributeHash(){return`${this.field}-${this.valueExpression}`}clone(){var e;return new A({color:(e=this.color)==null?void 0:e.clone(),field:this.field,label:this.label,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};i([r({type:w,json:{type:[Number],write:!0}})],S.prototype,"color",void 0),i([r({type:String,json:{write:!0}})],S.prototype,"field",void 0),i([je("field")],S.prototype,"castField",null),i([r({type:String,json:{write:!0}})],S.prototype,"label",void 0),i([r({type:String,json:{write:!0}})],S.prototype,"valueExpression",void 0),i([r({type:String,json:{write:!0}})],S.prototype,"valueExpressionTitle",void 0),S=A=i([$("esri.renderers.support.AttributeColorInfo")],S);const se=S;var F;let T=F=class extends C{constructor(){super(...arguments),this.unit=null}clone(){return new F({unit:this.unit})}};i([r({type:String,json:{write:!0}})],T.prototype,"unit",void 0),T=F=i([$("esri.renderers.support.DotDensityLegendOptions")],T);const Ce=T;var k;let c=k=class extends B(V){constructor(e){super(e),this.attributes=null,this.backgroundColor=new w([0,0,0,0]),this.dotBlendingEnabled=!0,this.dotShape="square",this.dotSize=1,this.legendOptions=null,this.outline=new U,this.dotValue=null,this.referenceScale=null,this.seed=1,this.type="dot-density"}calculateDotValue(e){if(this.referenceScale==null)return this.dotValue;const t=e/this.referenceScale*this.dotValue;return t<1?1:t}getSymbol(){return new W({outline:this.outline})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}getAttributeHash(){var e;return((e=this.attributes)==null?void 0:e.reduce((t,s)=>t+s.getAttributeHash(),""))??""}getMeshHash(){return JSON.stringify(this.outline)}clone(){return new k({attributes:a(this.attributes),backgroundColor:a(this.backgroundColor),dotBlendingEnabled:a(this.dotBlendingEnabled),dotShape:a(this.dotShape),dotSize:a(this.dotSize),dotValue:a(this.dotValue),legendOptions:a(this.legendOptions),outline:a(this.outline),referenceScale:a(this.referenceScale),seed:a(this.seed),visualVariables:a(this.visualVariables),authoringInfo:a(this.authoringInfo)})}getControllerHash(){var t;return`${(t=this.attributes)==null?void 0:t.map(s=>s.field||s.valueExpression||"")}-${this.outline&&JSON.stringify(this.outline.toJSON())||""}`}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t);for(const s of this.attributes??[])s.valueExpression&&await M(e,t,s.valueExpression),s.field&&e.add(s.field)}};i([r({type:[se],json:{write:!0}})],c.prototype,"attributes",void 0),i([r({type:w,json:{write:!0}})],c.prototype,"backgroundColor",void 0),i([r({type:Boolean,json:{write:!0}})],c.prototype,"dotBlendingEnabled",void 0),i([r({type:String,json:{write:!1}})],c.prototype,"dotShape",void 0),i([r({type:Number,json:{write:!0}})],c.prototype,"dotSize",void 0),i([r({type:Ce,json:{write:!0}})],c.prototype,"legendOptions",void 0),i([r({type:U,json:{default:null,write:!0}})],c.prototype,"outline",void 0),i([r({type:Number,json:{write:!0}})],c.prototype,"dotValue",void 0),i([r({type:Number,json:{write:!0}})],c.prototype,"referenceScale",void 0),i([r({type:Number,json:{write:!0}})],c.prototype,"seed",void 0),i([z({dotDensity:"dot-density"})],c.prototype,"type",void 0),c=k=i([$("esri.renderers.DotDensityRenderer")],c);const Ne=c;let R=class extends L(C){constructor(){super(...arguments),this.minLabel=null,this.maxLabel=null,this.title=null}};i([r({type:String,json:{write:!0}})],R.prototype,"minLabel",void 0),i([r({type:String,json:{write:!0}})],R.prototype,"maxLabel",void 0),i([r({type:String,json:{write:!0}})],R.prototype,"title",void 0),R=i([$("esri.renderers.support.HeatmapLegendOptions")],R);var H;function Y(e){if(e!=null){const{maxDensity:t,minDensity:s,radius:o}=e;if(t!=null||s!=null||o!=null){const{blurRadius:d,maxPixelIntensity:l,minPixelIntensity:u,...v}=e;return v}}return e}let p=H=class extends V{constructor(e){super(e),this.authoringInfo=null,this.colorStops=[new N({ratio:0,color:new w("rgba(255, 140, 0, 0)")}),new N({ratio:.75,color:new w("rgba(255, 140, 0, 1)")}),new N({ratio:.9,color:new w("rgba(255, 0,   0, 1)")})],this.field=null,this.legendOptions=null,this.maxDensity=.04,this.minDensity=0,this.radius=18,this.referenceScale=0,this.type="heatmap",this.valueExpression=null,this.valueExpressionTitle=null,this._warnedProps={blurRadius:!1,maxPixelIntensity:!1,minPixelIntensity:!1}}normalizeCtorArgs(e){return Y(e)}get blurRadius(){return Ie(this.radius)}set blurRadius(e){const t=this.maxPixelIntensity,s=this.minPixelIntensity;this._set("radius",De(e)),this._warnAboutDeprecatedGaussianBlurProp("blurRadius","radius"),this._set("maxDensity",t*this._pixelIntensityToDensity),this._set("minDensity",s*this._pixelIntensityToDensity)}get maxPixelIntensity(){return this.maxDensity/this._pixelIntensityToDensity}set maxPixelIntensity(e){this._set("maxDensity",e*this._pixelIntensityToDensity),this._warnAboutDeprecatedGaussianBlurProp("maxPixelIntensity","maxDensity")}get minPixelIntensity(){return this.minDensity/this._pixelIntensityToDensity}set minPixelIntensity(e){this._set("minDensity",e*this._pixelIntensityToDensity),this._warnAboutDeprecatedGaussianBlurProp("minPixelIntensity","minDensity")}get _pixelIntensityToDensity(){return 24/(Ee**2*this.blurRadius**4)}_warnAboutDeprecatedGaussianBlurProp(e,t){this._warnedProps[e]||le(this).getDefaultOrigin()==="user"&&(this._warnedProps[e]=!0,ge(()=>{be(E.getLogger(this),e,{replacement:`${String(t)} (suggested value: ${this._get(t)})`,version:"4.24"})}))}read(e,t){e=Y(e),super.read(e,t)}getSymbol(){return new X}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}async collectRequiredFields(e,t){const s=this.field,o=this.valueExpression;s&&typeof s=="string"&&he(e,t,s),o&&typeof o=="string"&&await M(e,t,o)}getAttributeHash(){return null}getMeshHash(){return`${JSON.stringify(this.colorStops)}.${this.blurRadius}.${this.field}`}clone(){return new H({authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),colorStops:a(this.colorStops),field:this.field,legendOptions:a(this.legendOptions),maxDensity:this.maxDensity,minDensity:this.minDensity,radius:this.radius,referenceScale:this.referenceScale,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};i([r({type:ce,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],p.prototype,"authoringInfo",void 0),i([r({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],p.prototype,"blurRadius",null),i([r({type:[N],json:{write:!0}})],p.prototype,"colorStops",void 0),i([r({type:String,json:{write:!0}})],p.prototype,"field",void 0),i([r({type:R,json:{write:!0}})],p.prototype,"legendOptions",void 0),i([r({type:Number,json:{write:!0}})],p.prototype,"maxDensity",void 0),i([r({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],p.prototype,"maxPixelIntensity",null),i([r({type:Number,json:{write:!0}})],p.prototype,"minDensity",void 0),i([r({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],p.prototype,"minPixelIntensity",null),i([r({type:Number,cast:ee,json:{write:!0}})],p.prototype,"radius",void 0),i([r({type:Number,range:{min:0},json:{default:0,write:!0}})],p.prototype,"referenceScale",void 0),i([z({heatmap:"heatmap"})],p.prototype,"type",void 0),i([r({type:String,json:{write:!0,origins:{"web-document":{write:!1},"portal-item":{write:!1}}}})],p.prototype,"valueExpression",void 0),i([r({type:String})],p.prototype,"valueExpressionTitle",void 0),i([r({readOnly:!0})],p.prototype,"_pixelIntensityToDensity",null),p=H=i([$("esri.renderers.HeatmapRenderer")],p);const re=p;let D=class extends L(C){constructor(){super(...arguments),this.color=new w([0,0,0,0]),this.label=null,this.threshold=0}};i([r({type:w,json:{write:!0}})],D.prototype,"color",void 0),i([r({type:String,json:{write:!0}})],D.prototype,"label",void 0),i([r({type:Number,range:{min:0,max:1},json:{write:!0}})],D.prototype,"threshold",void 0),D=i([$("esri.renderers.support.OthersCategory")],D);let O=class extends L(C){constructor(){super(...arguments),this.title=null}};i([r({type:String,json:{write:!0}})],O.prototype,"title",void 0),O=i([$("esri.renderers.support.PieChartLegendOptions")],O);let f=class extends B(L(V)){constructor(t){super(t),this.attributes=null,this.backgroundFillSymbol=null,this.defaultColor=new w([0,0,0,0]),this.defaultLabel=null,this.holePercentage=0,this.othersCategory=new D,this.legendOptions=null,this.outline=null,this.size=12,this.type="pie-chart"}getSymbol(){var t;return new X({size:this.size?this.size/2+(((t=this.outline)==null?void 0:t.width)||0):0})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol(),this.backgroundFillSymbol].filter(ae)}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,s)=>t+s.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((t,s)=>t+JSON.stringify(s),"")}async collectRequiredFields(t,s){await this.collectVVRequiredFields(t,s);for(const o of this.attributes)o.valueExpression&&await M(t,s,o.valueExpression),o.field&&t.add(o.field)}};i([r({type:[se],json:{write:!0}})],f.prototype,"attributes",void 0),i([r({type:W,json:{default:null,write:!0}})],f.prototype,"backgroundFillSymbol",void 0),i([r({type:w,json:{write:!0}})],f.prototype,"defaultColor",void 0),i([r({type:String,json:{write:!0}})],f.prototype,"defaultLabel",void 0),i([r({type:Number,range:{min:0,max:1},json:{write:!0}})],f.prototype,"holePercentage",void 0),i([r({type:D,json:{write:!0}})],f.prototype,"othersCategory",void 0),i([r({type:O,json:{write:!0}})],f.prototype,"legendOptions",void 0),i([r({type:U,json:{default:null,write:!0}})],f.prototype,"outline",void 0),i([r({type:Number,cast:ee,json:{write:!0}})],f.prototype,"size",void 0),i([z({pieChart:"pie-chart"})],f.prototype,"type",void 0),f=i([$("esri.renderers.PieChartRenderer")],f);const Te=f,Oe={key:"type",base:V,typeMap:{heatmap:re,simple:te,"unique-value":Q,"class-breaks":K,"dot-density":Ne,dictionary:Ve,"pie-chart":Te},errorContext:"renderer"},ct={key:"type",base:V,typeMap:{simple:te,"unique-value":Q,"class-breaks":K,heatmap:re},errorContext:"renderer",validate:Me};function Me(e){switch(e.type){case"simple":return Le(e);case"unique-value":return qe(e);case"class-breaks":return Ae(e);case"heatmap":return e}}function Le(e){if(e.symbol)return e;E.getLogger("esri.renderers.support.types").error("Removed invalid 'simple' renderer without a symbol from web scene.")}function qe(e){const t=e.uniqueValueInfos,s=t==null?void 0:t.filter(({symbol:o,label:d},l)=>(o||E.getLogger("esri.renderers.support.types").error(`Removed invalid unique value info ([${l}] ${d}) without a symbol from web scene.`),!!o));return(s==null?void 0:s.length)!==(t==null?void 0:t.length)&&(e.uniqueValueInfos=s),e}function Ae(e){const t=e.classBreakInfos,s=t==null?void 0:t.filter(({symbol:o,label:d},l)=>(o||E.getLogger("esri.renderers.support.types").error(`Removed invalid class break info ([${l}] ${d}) without a symbol from web scene.`),!!o));return(s==null?void 0:s.length)!==(t==null?void 0:t.length)&&(e.classBreakInfos=s),e}function mt(e,t){return ke(e,null,t)}const Fe=ue({types:Oe});function ke(e,t,s){return e?e&&(e.styleName||e.styleUrl)&&e.type!=="uniqueValue"?(s!=null&&s.messages&&s.messages.push(new pe("renderer:unsupported","Only UniqueValueRenderer can be referenced from a web style, but found '"+e.type+"'",{definition:e,context:s})),null):Fe(e,t,s):null}export{Oe as m,ke as o,mt as t,ct as u};
