import{aO as Pt,g as q,B as z,r as n,m as l,a as H,bo as Vt,N as V,aW as bt,l as W}from"./Accessor-BmwT4B0c.js";import{s as Mt}from"./AnalysisView3D-DoDk2o7n.js";import{h as nt}from"./SlicePlane-oF-O5hhm.js";import{d as y,C as Dt,A as F}from"./reactiveUtils-XM7cS2OP.js";import{W as d,Z as u,y as K,J as Z}from"./boundedPlane-DuGhiiFM.js";import{f as J}from"./Layer-DH4_Pn8a.js";import{C as Et}from"./BuildingComponentSublayer-C_pZIhA8.js";import{x as Ct,L as Tt,V as St,R as lt,I as xt,H as $t,g as Q,v as kt,j as ot,A as pt,l as X,_ as Y,r as Lt,s as Ht,M as S,e as zt,C as P,c as ht,u as Ot,m as Rt,p as Gt,a as It,b as ut,t as ct,d as At,f as Bt}from"./SlicePlaneMaterial.glsl-DRbvxdCD.js";import{t as Ft}from"./LineVisualElement-BCLvCZUF.js";import{c as Kt,g as Ut}from"./screenUtils-_ZIvrt5o.js";import{p as jt,d as dt,c as mt}from"./mat4-Fi6iAz29.js";import{P as x,r as C,s as tt,g as O,u as et,E as it,A as at,o as yt}from"./vec32-Dvg_eL9J.js";import{n as U,t as Nt}from"./vec3f64-BLpZdpfb.js";import{t as qt,s as vt}from"./vec4f64-o2zAXfmz.js";import{V as st,c,M as j,x as L,O as R,a as T,t as Wt}from"./plane-CpXmOyqq.js";import{b as Zt}from"./sphere-Cin5efBj.js";import{l as Jt,n as Qt}from"./Factory-BJU6qm9N.js";import{m as Xt,M as wt,r as G,t as I,p as Yt,f as te,h as ee,j as ie}from"./sliceToolConfig-DdKbqpbd.js";import{w as ae}from"./RenderObject-DqJETQox.js";import{C as $}from"./dragEventPipeline3D-BPjuyc9D.js";import{m as M}from"./ray-C_tSu6xd.js";import{o as se}from"./ShadedColorMaterial.glsl-BFmY_SxS.js";import{p as k}from"./dragEventPipeline-Dj33NxJd.js";import{t as re}from"./ToolIntersector-Ce8oIgvQ.js";import{n as D}from"./screenUtils-BWEEmpSb.js";import{h as ne}from"./lineStippleUtils-C89mzWlO.js";import{a as le,v as oe}from"./analysisViewUtils-CVt56akI.js";import"./Promise-DfET-uns.js";import"./cast-CsZslgGN.js";import"./index-4eY77cms.js";import"./JSONSupport-DcrLLGjL.js";import"./Clonable-Z-AWS-16.js";import"./Cyclical-Dlbl-cQK.js";import"./mathUtils-Cfq9PL9W.js";import"./persistable-C1YjaxW7.js";import"./MD5-C9MwAd2G.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./uuid-Cl5lrJ4c.js";import"./resourceExtension-DiQ4lOGT.js";import"./Point-Cz2JYYmX.js";import"./writer-DKgfqj4X.js";import"./Evented-Dw4_VOGn.js";import"./SimpleObservable-CvOkykwM.js";import"./mat4f64-Dk4dwAN8.js";import"./Polyline-s-JzsQqo.js";import"./Extent-g5W9hy0j.js";import"./lineSegment-v806maA5.js";import"./Identifiable-BHVfzH03.js";import"./Portal-CmmHxpLg.js";import"./TimeExtent-BO6BsF_x.js";import"./timeUtils-C1c_L2Fd.js";import"./Graphic-Dt0LgVGU.js";import"./opacityUtils-Dim20wpZ.js";import"./enumeration-DpvDkLNI.js";import"./Color-VJEMvW-n.js";import"./colorUtils-Rxh2V3ai.js";import"./ActionToggle-D7439N1A.js";import"./jsonUtils-CwFG8yN4.js";import"./typeUtils-B6WBEKDM.js";import"./TextSymbol-BLIQ6RKX.js";import"./collectionUtils-CTT-51g7.js";import"./aaBoundingBox-Dw3yBk2f.js";import"./FeatureLayer-U46cmps3.js";import"./MultiOriginJSONSupport-DbmrbwMa.js";import"./layerContainerType-C5CzMsLd.js";import"./FeatureLayerBase-C4QQJYE9.js";import"./formUtils-l8pvwous.js";import"./Field-BDG0QV_T.js";import"./fieldType-CBeoJWlv.js";import"./HeightModelInfo-C05IFsWs.js";import"./commonProperties-B0GHoNP5.js";import"./ElevationInfo-BPOqhCue.js";import"./unitConversionUtils-rg07EgOm.js";import"./lengthUtils-_77UiyVF.js";import"./AttributeTableTemplate-cR37sM72.js";import"./timeZoneUtils-DxzjpEBb.js";import"./featureLayerUtils-Btb8HY8h.js";import"./featureQueryAll-JpNZKIBO.js";import"./Query-B_2mhyL4.js";import"./FullTextSearch-CBnxSwz4.js";import"./layerUtils-B__v9OBu.js";import"./SimpleRenderer-CEw_geZx.js";import"./commonProperties-ZfGquLPI.js";import"./colorRamps-CRjjPL3r.js";import"./SizeVariable-B-ghFm6e.js";import"./visualVariableUtils-Xcorldoo.js";import"./ColorStop-BYiAUa8d.js";import"./jsonUtils-B-voMz-i.js";import"./defaults-FkBa0ybj.js";import"./defaultsJSON-GKolV7NZ.js";import"./UniqueValueRenderer-yoWHKJ_P.js";import"./diffUtils-BanfihCO.js";import"./RendererLegendOptions-CYAPr8D6.js";import"./styleUtils-ColFrJ-Z.js";import"./AttachmentQuery-CpEmJqq-.js";import"./NormalizationBinParametersMixin-CZD0XfhN.js";import"./RelationshipQuery-B5a-mYy7.js";import"./LayerFloorInfo-iCgtHY6f.js";import"./Relationship-CTbzI1Kb.js";import"./serviceCapabilitiesUtils-B2yGaMdk.js";import"./infoFor3D-C7tb3HsI.js";import"./workers-Cds_sd9m.js";import"./Queue-BQesTh_6.js";import"./intl-Duiy0OzY.js";import"./editsZScale-LI19I1vI.js";import"./queryZScale-BdW_vUm_.js";import"./projection-CyCZAIaD.js";import"./projectBuffer-CQnuEMuP.js";import"./geodesicConstants-RQL9oKdk.js";import"./FeatureSet-B5-Veyin.js";import"./APIKeyMixin-3z69J1h4.js";import"./ArcGISService-CDyDWGI0.js";import"./ScaleRangeLayer-Cnzwr9PT.js";import"./jsonUtils-DZz5FrgB.js";import"./utils-DYurMneM.js";import"./mat4f32-DcsiF_Rp.js";import"./CustomParametersMixin-Be7WOSEG.js";import"./DisplayFilteredLayer-CzliK74b.js";import"./scaleUtils-DPfHG2g0.js";import"./displayFilterUtils-uKPOP7_-.js";import"./EditBusLayer-KXo-LY9o.js";import"./FeatureEffectLayer-BZmannck.js";import"./FeatureEffect-DZgZP6Sj.js";import"./FeatureFilter-Ca1n-g_b.js";import"./FeatureReductionLayer-B6VhUfZv.js";import"./FeatureReductionSelection-BJWsAyix.js";import"./labelingInfo-BgG6IH9B.js";import"./labelUtils-DCpQ7n-8.js";import"./jsonUtils-BZp85R7u.js";import"./typeUtils-B3iPBwJ2.js";import"./ClassBreaksRenderer-C7fhua2J.js";import"./LRUCache-CXiGQWMN.js";import"./MemCache-CmojB_Z1.js";import"./Version-Cd3TlGH0.js";import"./FieldsIndex-FW1AMU67.js";import"./utils-UPZJIDfz.js";import"./defaultCIMValues-Bb-CUowV.js";import"./enums-BTM-fOHQ.js";import"./HeatmapColorStop-CHbSyb1s.js";import"./heatmapUtils-Cyq-bAyG.js";import"./vec42-YcqnINSP.js";import"./common-DQOJ18NT.js";import"./OperationalLayer-B__lrMRq.js";import"./OrderedLayer-ucEg87Tu.js";import"./OrderByInfo-KsusEmpW.js";import"./PortalLayer-Cqwv_mmr.js";import"./PortalItem-CTx1kJsR.js";import"./portalItemUtils-ByOtbGao.js";import"./RefreshableLayer-C90FXoHt.js";import"./TemporalLayer-CMqBosxi.js";import"./TimeInfo-CctegBed.js";import"./TimeInterval-B7L-CEq7.js";import"./TrackableLayer-DaYHUnrc.js";import"./FeatureTemplate-Dh5_oWTV.js";import"./FeatureType-DhERcdEP.js";import"./fieldProperties-DDN0PSrH.js";import"./TitleCreator-DIyQ9Yy3.js";import"./versionUtils-BfhafDf-.js";import"./styleUtils-Bye9ft1s.js";import"./popupUtils-CmsUVJA0.js";import"./interfaces-CL2NbQte.js";import"./capabilities-B4c8vV3b.js";import"./I3SIndexInfo-CtHVwWKN.js";import"./I3SLayerDefinitions-F93A6ZIl.js";import"./I3SUtil-BD55sujO.js";import"./projectVectorToVector-CCOy_B5J.js";import"./projectPointToVector-BoxjK-qy.js";import"./I3SBinaryReader-DxrJbUZw.js";import"./VertexAttribute-Cq4MnHjR.js";import"./computeTranslationToOriginAndRotation-DYUrDrjE.js";import"./edgeUtils-D0U-z06n.js";import"./floatRGBA-Cb__GiDF.js";import"./NormalAttribute.glsl-0GHNIsQf.js";import"./glsl-BH37Aalp.js";import"./Matrix3PassUniform-uCCQMnlP.js";import"./BindType-BBwFZqyN.js";import"./RgbaFloatEncoding.glsl-_io2eW3M.js";import"./Float4DrawUniform-Db0CLl_z.js";import"./Matrix3DrawUniform-DD7AqlIc.js";import"./orientedBoundingBox-B17G_yFO.js";import"./mat3-CR8GKnhD.js";import"./mat3f64-BBpwCtoL.js";import"./quat-CP7JhygC.js";import"./quatf64-CCm9z-pX.js";import"./spatialReferenceEllipsoidUtils-DBqQpPRa.js";import"./ViewingMode-Dodu7ZZk.js";import"./vec2f64-Dy6m9Nrb.js";import"./Attribute-DGhdp5lO.js";import"./layerViewUtils-Bevty3Jm.js";import"./popupUtils-CY6-CisY.js";import"./GeometryUtil-D-PMXorz.js";import"./vec3f32-nZdmKIgz.js";import"./FloatArray-BQXWSSJh.js";import"./Material-C_-mgXN8.js";import"./NoParameters-t-PuNrgq.js";import"./Texture-BVJ22uHh.js";import"./signal-CySMLEX9.js";import"./enums-D9v74xTE.js";import"./getDataTypeBytes-BTGR5GyG.js";import"./renderState-Ci93M1-P.js";import"./basicInterfaces-CZwQPxTp.js";import"./Indices-D8XWalpO.js";import"./InterleavedLayout-_dYEAUNK.js";import"./BufferView-0osDbyWD.js";import"./vec2-ChnYg_BJ.js";import"./types-D0PSWh4d.js";import"./triangle-B1tKFm7z.js";import"./ShaderTechniqueConfiguration-D4dZMCXS.js";import"./requestImageUtils-DWgRKL5q.js";import"./TextureFormat-1mYWTFa-.js";import"./RibbonLine.glsl-DwJpAQ1c.js";import"./mathUtils-BgCEaV43.js";import"./sdfPrimitives-DBgFWIDT.js";import"./doublePrecisionUtils-B0owpBza.js";import"./Octree-CmoRJhci.js";import"./ShaderBuilder-BKul5qh8.js";import"./interfaces-D6pIddIh.js";import"./colorUtils-DaPfwnk3.js";import"./ImageMaterial.glsl-WwbGgv6U.js";import"./GLTextureMaterial-96UpbkjC.js";import"./DefaultBufferWriter-CqCDaNCZ.js";import"./DefaultLayouts-CBF6SkyQ.js";import"./TriangleMaterial-D-IjcYAX.js";import"./VertexColor.glsl-D3WyDYIi.js";import"./Matrix4PassUniform-COGIPIq4.js";import"./Object3DVisualElement-D0-_EXFp.js";import"./VisualElement-CaupdJPJ.js";import"./ShaderTechniqueRepository-Ch1TPHrL.js";import"./NestedMap-GuqgquCN.js";import"./RenderCoordsHelper-DA-pMWeR.js";import"./projectVectorToPoint-DEm8-dt4.js";import"./dehydratedFeatureUtils-1rrRm6hF.js";import"./ColorMaterial.glsl-B6FVFiO0.js";import"./ElevationProvider-aS5xrHHy.js";import"./line-BiDIlUeT.js";import"./hydratedFeatures-CNHxsqRS.js";import"./elevationInfoUtils-D26wVF2d.js";import"./RenderCamera-CDB-KFBK.js";import"./graphicUtils-BFGMMQ1R.js";import"./meshVertexSpaceUtils-AgAbm20L.js";import"./MeshLocalVertexSpace-CnHk-qPr.js";import"./Intersector-tBiZcjSu.js";import"./intersectorUtils-BNnvTT1E.js";import"./verticalOffsetUtils-BFnFdbst.js";import"./InteractiveToolBase-rZBtMOMv.js";import"./EditGeometryOperations-CAMJU2Wn.js";import"./geometry2dUtils-D9Oax6Qb.js";function pe(t){switch(t.type){case"building-scene":case"catalog":case"catalog-dynamic-group":case"catalog-footprint":case"csv":case"dimension":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"integrated-mesh-3dtiles":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"viewshed":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case"parquet":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"video":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return Pt(t.type),!1}}let _=class extends q{constructor(t){super(t),this._internalChange=!1,this._currentSlicePlane=null}initialize(){this.addHandles(this.analysis.excludedLayers.on("before-add",t=>{const e=t.item;e!=null&&(e instanceof J||e instanceof Et)?e instanceof J&&pe(e)?(z.getLogger(this).error("excludedLayers",`Layer '${e.title}, id:${e.id}' of type '${e.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),t.preventDefault()):this.analysis.excludedLayers.includes(e)&&t.preventDefault():(z.getLogger(this).error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),t.preventDefault())})),ue(this.view,this),this.addHandles([y(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),y(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),y(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),y(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this.addHandles([y(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null,this._updateActiveController(),this._updateViewSlicePlane()),ce(this.view,this),this.set("view",null)}get _allLayerAndSubLayerViews(){const t=this.view.allLayerViews.items;return t.concat(t.filter(Ct).flatMap(({sublayerViews:e})=>e.items))}_updateBoundedPlaneFromSlicePlane(){const t=this.analysis.shape,e=this._currentSlicePlane;if(e==null&&t==null||e!=null&&t!=null&&t.equals(e))return;let i=null,a=null;if((t==null?void 0:t.position)!=null){const s=t.position.spatialReference,r=Tt(t,this.view);r==null&&Ft(this.analysis,s,z.getLogger(this)),i=St(r,this.view,{tiltEnabled:this.analysis.tiltEnabled},d()),i!=null&&(a={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=i,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const t=this.analysisViewData.plane,e=lt(t,this.view,this.view.spatialReference,new nt);let i=null;e!=null&&(i={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height}),this._currentSlicePlane=i,this._internalChange=!0,this.analysis.shape=e,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(A)return;const t=_t(this.view);if(t)if(this.analysisViewData.active)t.activeController!=null&&t.activeController!==this?(A=!0,t.activeController.analysisViewData.active=!1,A=!1):t.activeController!=null&&t.activeController,this._updateLayerViews(),t.activeController=this;else{if(t.activeController!=null&&t.activeController!==this)return;t.activeController!=null&&t.activeController===this&&(t.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){he(this.view)}_updateLayerViews(){const t=this.analysisViewData.plane!=null&&this.analysisViewData.visible&&this.analysisViewData.active,e=[],i=a=>{"layers"in a?a.layers.forEach(i):e.push(a)};this.analysis.excludedLayers.forEach(i),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=t&&!e.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=t&&!e.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=t&&!this.analysis.excludeGroundSurface)}};n([l()],_.prototype,"view",void 0),n([l()],_.prototype,"analysis",void 0),n([l()],_.prototype,"analysisViewData",void 0),n([l()],_.prototype,"_allLayerAndSubLayerViews",null),_=n([H("esri.views.3d.analysis.Slice.SliceController")],_);const g=new Map;let A=!1;function he(t){const e=_t(t),i=e==null?void 0:e.activeController;(i==null?void 0:i.analysisViewData.plane)!=null&&i.analysisViewData.visible?t.slicePlane=i.analysisViewData.plane:t.slicePlane=null}function ue(t,e){var i;g.has(t)||g.set(t,{all:[],activeController:null}),(i=g.get(t))==null||i.all.push(e)}function _t(t){return g.get(t)}function ce(t,e){if(!g.has(t))throw new Error("view expected in global slice register");const i=g.get(t),a=(i==null?void 0:i.all.lastIndexOf(e))??-1;if(!i||a===-1)throw new Error("controller expected in global slice register");i.all.splice(a,1),i.all.length===0&&g.delete(t)}var N;let h=N=class extends se{constructor(t){super(t),this._clock=Vt,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this._layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._frameTask=null,this._pointerMoveTimerMs=Xt,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=d(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=Kt(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=re(t.view.state.viewingMode)}initialize(){var p;if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");const t=o=>{this._updateManipulatorsInteractive(o),o.grabbing||(this.analysisViewData.plane!=null&&u(this.analysisViewData.plane,this._startPlane),this.inputState=null)},e=new xt(this.view,$t.CENTER_ON_ARROW);this.shiftManipulator=e,this.manipulators.add(e),this.addHandles([this._createShiftDragPipeline(e),e.events.on("grab-changed",o=>{this._onShiftGrab(o),t(e)})]);const i=!((p=this.view._stage)!=null&&p.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result),a=new Q(this.view,(o,v)=>Jt(this.view.textures,{accentColor:o,contrastColor:v,preMultiplyAlpha:i}));this.rotateHeadingManipulator=a,this.manipulators.add(a),this.addHandles([this._createRotateHeadingDragPipeline(a),a.events.on("grab-changed",o=>{this._onRotateHeadingGrab(o),t(a)})]);const s=new Q(this.view,(o,v)=>Qt(this.view.textures,{accentColor:o,contrastColor:v,preMultiplyAlpha:i}));this.rotateTiltManipulator=s,this.manipulators.add(s),this.addHandles([this._createRotateTiltDragPipeline(s),s.events.on("grab-changed",o=>{this._onRotateTiltGrab(o),t(s)})]),this.resizeManipulators=this._resizeHandles.map((o,v)=>{const f=new kt(this.view,o);return this.addHandles([this._createResizeDragPipeline(f),f.events.on("grab-changed",b=>{this._onResizeGrab(b,v),t(f)})]),f}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=ot(this.view),this._previewPlaneOutlineVisualElement=pt(this.view),this._previewPlaneOutlineVisualElement.width=wt,this.addHandles(y(()=>[this.analysisViewData.plane,this.analysis.tiltEnabled],()=>this._updateManipulators(),Dt));const r=y(()=>this.state,o=>{o==="sliced"&&this.finishToolCreation()},F);this.addHandles([r,y(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=V(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=V(this._previewPlaneGridVisualElement)}get state(){const t=!!this.analysisViewData.plane,e=!!this.inputState;return t?t&&e?"slicing":t&&!e?"sliced":"ready":"ready"}get cursor(){return this._isPlacingSlicePlane||this.layersMode==="exclude"?"crosshair":this._creatingPointerId!=null?"grabbing":null}set analysis(t){if(t==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.removeHandles("analysis"),this._set("analysis",t)}get layersMode(){return this._layersMode}get inputState(){return this._get("inputState")}set inputState(t){this._set("inputState",t),this.analysisViewData.showGrid=t!=null&&t.type==="resize",this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.analysisViewData.plane&&this.active}get _creatingPointerId(){return this.inputState!=null&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){this.analysisViewData.plane!=null&&(this._layersMode="exclude",this.active||(this.view.activeTool=this))}exitExcludeLayerMode(){this.analysisViewData.plane!=null&&(this._layersMode="none",this.active&&(this.view.activeTool=null))}onDeactivate(){this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(t){this._updateManipulators(),t||this._clearPointerMoveTimeout()}onInputEvent(t){switch(t.type){case"pointer-drag":if(!B(t))return;this._isPlacingSlicePlane?this._onClickPlacePlane(t)&&t.stopPropagation():this._onPointerDrag(t)&&t.stopPropagation();break;case"pointer-move":this._onPointerMove(t);break;case"pointer-up":this._onPointerUp(t)&&t.stopPropagation();break;case"immediate-click":if(!B(t))return;this._onClickPlacePlane(t)&&t.stopPropagation();break;case"click":if(!B(t))return;this._onClickExcludeLayer(t)&&t.stopPropagation();break;case"drag":this.inputState&&t.stopPropagation();break;case"key-down":this._onKeyDown(t)&&t.stopPropagation();break;case"key-up":this._onKeyUp(t)&&t.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(t){const e=this.inputState;if(t.pointerId===this._creatingPointerId&&e!=null&&e.type==="shift"){const i=D(t);return this.shiftManipulator.events.emit("drag",{action:e.hasBeenDragged?"update":"start",pointerType:t.pointerType,start:i,screenPoint:i}),e.hasBeenDragged=!0,!0}return!1}_onPointerMove(t){this._lastCursorPosition.x=t.x,this._lastCursorPosition.y=t.y,this._resetPointerMoveTimeout(),t.pointerType!=="touch"&&this._updatePreviewPlane(D(t),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(t){if(t.pointerId===this._creatingPointerId&&this.analysisViewData.plane!=null){const e=D(t);return this.shiftManipulator.events.emit("drag",{action:"end",start:e,screenPoint:e}),u(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(t){if(this.layersMode==="exclude")return!1;if(this._isPlacingSlicePlane){const e=D(t),i=d();if(this._pickPlane(e,!1,this._activeKeyModifiers,i)){if(t.type==="pointer-drag"){const a=M(this.view.state.camera,e,E);this.inputState=rt(a,t.pointerId,i.origin,i)}return u(i,this._startPlane),this.analysis.shape=lt(i,this.view,this.view.spatialReference,new nt),!0}}return!1}_onClickExcludeLayer(t){return!(this.layersMode!=="exclude"||!this.created)&&(this.view.hitTest(D(t)).then(e=>{if(e.results.length){const i=e.results[0],a=(i==null?void 0:i.type)==="graphic"&&i.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else e.ground.layer?this.analysis.excludedLayers.push(e.ground.layer):this.analysis.excludeGroundSurface=!0}),this.exitExcludeLayerMode(),!0)}_onKeyDown(t){return(t.key===G||t.key===I)&&(this._activeKeyModifiers[t.key]=!0,this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(t){return!(t.key!==G&&t.key!==I||!this._activeKeyModifiers[t.key])&&(delete this._activeKeyModifiers[t.key],this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const e=M(this.view.state.camera,t.screenPoint,E);u(this.analysisViewData.plane,this._startPlane),this.inputState=rt(e,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(t){return k(t,(e,i,a)=>{const s=this.inputState;if(s==null||s.type!=="shift")return;const r=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;i.next($(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{r!=null&&this._updateBoundedPlane(r)})})}_shiftDragAdjustSensitivity(t){return e=>{if(this.analysisViewData.plane==null)return null;const i=.001,a=Math.min((1-Math.abs(x(K(this.analysisViewData.plane),e.ray.direction)/C(e.ray.direction)))/i,1),s=-st(this._startPlane.plane,e.renderEnd),r=-st(this._startPlane.plane,t.startPoint);return t.depth=t.depth*(1-a)+s*a-r,e}}_shiftDragUpdatePlane(t){return()=>{if(this.analysisViewData.plane==null)return;const e=tt(c.get(),this._startPlane.origin),i=tt(c.get(),K(this._startPlane));O(i,i,-t.depth),et(i,i,e);const a=Z(i,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,d());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const e=X(this.analysisViewData.plane,this.view.renderCoordsHelper,Y.HEADING,j()),i=M(this.view.state.camera,t.screenPoint,E),a=U();L(e,i,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:e,startPoint:a})}_createRotateHeadingDragPipeline(t){return k(t,(e,i,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const r=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;i.next($(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{r!=null&&this._updateBoundedPlane(r)})})}_onRotateTiltGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const e=X(this.analysisViewData.plane,this.view.renderCoordsHelper,Y.TILT,j()),i=M(this.view.state.camera,t.screenPoint,E),a=U();L(e,i,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:e,startPoint:a})}_createRotateTiltDragPipeline(t){return k(t,(e,i,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const r=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;i.next($(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{r!=null&&this._updateBoundedPlane(r)})})}_rotateDragRenderPlaneToRotate(t){return e=>{if(this.analysisViewData.plane==null)return null;const i=R(t.rotatePlane),a=ae(t.startPoint,e.renderEnd,this.analysisViewData.plane.origin,i);return{...e,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return t=>{if(this.analysisViewData.plane==null)return;const e=jt(T.get(),t.rotateAngle,t.rotateAxis);if(e==null)return;const i=it(c.get(),this._startPlane.basis1,e),a=it(c.get(),this._startPlane.basis2,e),s=Z(this.analysisViewData.plane.origin,i,a,d());this._updateBoundedPlane(s)}}_onResizeGrab(t,e){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const i=M(this.view.state.camera,t.screenPoint,E),a=c.get();L(this.analysisViewData.plane.plane,i,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:e,startPoint:Nt(a)})}_createResizeDragPipeline(t){return k(t,(e,i,a)=>{const s=this.inputState;if(s==null||s.type!=="resize"||this.analysisViewData.plane==null)return;const r=u(this.analysisViewData.plane,d());i.next($(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(r)})})}_resizeDragUpdatePlane(t){return e=>{if(this.analysisViewData.plane==null)return;const i=this._resizeHandles[t.activeHandleIdx],a=Lt(i,t.startPoint,e.renderEnd,this.view.state.camera,this._startPlane,u(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(t){const e=this.analysisViewData;if(e==null)throw new Error("valid internal object expected");e.plane=t}_updatePreviewPlane(t,e={}){let i=this._previewPlane;if(this._previewPlane=null,t==null)return this._removeFrameTask(),void this._updateManipulators();if(!this.analysisViewData.plane&&this.active){const a=i??d();if(i=i!=null?u(i,me):null,this._pickPlane(t,!0,e,a)){const s=te;let r=!1;i!=null&&(r=x(R(i.plane),R(a.plane))<s||x(at(c.get(),i.basis1),at(c.get(),a.basis1))<s),r&&(this._previewPlaneOpacity=0),this._previewPlane=a}}this._previewPlane!=null&&this._frameTask==null&&this._previewPlaneOpacity===0?this._frameTask=bt({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*Yt),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):this._previewPlane==null&&this._frameTask!=null?this._removeFrameTask():this._previewPlane!=null&&this._updateManipulators()}_removeFrameTask(){this._frameTask=W(this._frameTask)}_pickMinResult(t){const e=Ut(t,Wt.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector),this._intersector.results.min}_pickPlane(t,e,i,a){const s=this._pickMinResult(t),r=c.get();if(!s.getIntersectionPoint(r))return!1;const p=s.getTransformedNormal(c.get()),o=this.view.state.camera;x(p,o.viewForward)>0&&O(p,p,-1);const v=Ht(r,o),f=(e?1:-1)*v*ee,b=O(c.get(),p,f);et(b,b,r);const gt=this.analysis.tiltEnabled?S.TILTED:S.HORIZONTAL_OR_VERTICAL,ft=i[G]?S.VERTICAL:i[I]?S.HORIZONTAL:gt;return zt(b,p,v,v,o,ft,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=W(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=P,this.rotateHeadingManipulator.state|=P,this.rotateTiltManipulator.state|=P,this._prevPointerMoveTimeout=this._clock.setTimeout(()=>{this.shiftManipulator.state&=~P,this.rotateHeadingManipulator.state&=~P,this.rotateTiltManipulator.state&=~P},this._pointerMoveTimerMs)}_updateManipulators(){if(N.disableEngineLayers)return;let t,e=!1;if(this.analysisViewData.plane!=null)t=this.analysisViewData.plane,e=!1;else{if(this._previewPlane==null)return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(p=>p.available=!1),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);t=this._previewPlane,e=!0}const i=ht(t,T.get());e?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(p=>p.available=!1),this._previewPlaneOutlineVisualElement.attached=!0,this._previewPlaneGridVisualElement.attached=!0,this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.analysis.tiltEnabled,this.resizeManipulators.forEach(p=>p.available=!0),Ot(this.shiftManipulator,i,t,this.view.state.camera),Rt(this.rotateHeadingManipulator,i,t,this.view.renderCoordsHelper),Gt(this.rotateTiltManipulator,i,t),this.resizeManipulators.forEach((p,o)=>It(p,this._resizeHandles[o],i,t)),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=yt(c.get(),C(t.basis1),C(t.basis2),1),s=dt(T.get(),a),r=mt(s,i,s);this._previewPlaneOutlineVisualElement.transform=r,this._previewPlaneGridVisualElement.transform=r,this._updateMaterials()}_updateMaterials(){const t=ut(this.view.effectiveTheme);t[3]*=this._previewPlaneOpacity;const e=qt(ct);e[3]*=this._previewPlaneOpacity,this._previewPlaneOutlineVisualElement.color=t,this._previewPlaneGridVisualElement.backgroundColor=e,this._previewPlaneGridVisualElement.gridColor=vt}_updateManipulatorsInteractive(t){if(!t.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(e=>{e.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===t,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===t,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===t,this.resizeManipulators.forEach(e=>{e.interactive=e===t})}get test(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:t=>{this._pointerMoveTimerMs=t}}}};h.disableEngineLayers=!1,n([l()],h.prototype,"_clock",void 0),n([l({constructOnly:!0})],h.prototype,"view",void 0),n([l()],h.prototype,"analysisViewData",void 0),n([l({readOnly:!0})],h.prototype,"state",null),n([l({readOnly:!0})],h.prototype,"cursor",null),n([l()],h.prototype,"analysis",null),n([l()],h.prototype,"removeIncompleteOnCancel",void 0),n([l()],h.prototype,"_layersMode",void 0),n([l()],h.prototype,"layersMode",null),n([l({value:null})],h.prototype,"inputState",null),n([l()],h.prototype,"_isPlacingSlicePlane",null),n([l()],h.prototype,"_creatingPointerId",null),h=N=n([H("esri.views.3d.analysis.Slice.SliceTool")],h);const de=h;function rt(t,e,i,a){const s=At(i,K(a),t.direction,j()),r=U();return L(s,t,r)?{type:"shift",creatingPointerId:e,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:r}:null}function B(t){return t.pointerType!=="mouse"||t.button===0}const me=d(),E=Zt();let w=class extends q{constructor(t){super(t),this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const t=this.analysisViewData;if(t==null)throw new Error("expected internal object to be valid");this._gridVisualElement=ot(this.view),this._outlineVisualElement=pt(this.view),this.addHandles([y(()=>{const e=t.plane!=null&&this.analysisViewData.visible,{active:i}=this.analysisViewData,{preview:a,showGrid:s,view:r}=this,{effectiveTheme:p}=r;return{visible:e,active:i,preview:a,showGrid:s,gridColor:Bt(p),outlineColor:ut(p)}},e=>this._updateMaterials(e),F),y(()=>t.plane,e=>this._updatePlane(e),F)],"internal")}destroy(){this._gridVisualElement=V(this._gridVisualElement),this._outlineVisualElement=V(this._outlineVisualElement),this.set("view",null)}_updatePlane(t){if(t==null)return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const e=yt(c.get(),C(t.basis1),C(t.basis2),1),i=dt(T.get(),e),a=ht(t,T.get()),s=mt(i,a,i);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:t,active:e,preview:i,showGrid:a,gridColor:s,outlineColor:r}){this._outlineVisualElement.color=r,this._outlineVisualElement.width=i?wt:ie,this._outlineVisualElement.stipplePattern=e?null:ne(5),this._gridVisualElement.backgroundColor=ct,this._gridVisualElement.gridColor=a?s:vt,this._gridVisualElement.visible=t,this._outlineVisualElement.visible=t}};n([l()],w.prototype,"view",void 0),n([l()],w.prototype,"analysis",void 0),n([l()],w.prototype,"analysisViewData",void 0),n([l()],w.prototype,"showGrid",void 0),n([l()],w.prototype,"preview",void 0),w=n([H("esri.views.3d.analysis.Slice.SliceVisualization")],w);let m=class extends Mt(q){constructor(t){super(t),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0}initialize(){this.analysisVisualization=new w({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new _({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(le(this,de))}destroy(){oe(this),this.analysisVisualization=V(this.analysisVisualization),this.analysisController=V(this.analysisController)}get showGrid(){var t;return((t=this.analysisVisualization)==null?void 0:t.showGrid)??!1}set showGrid(t){this.analysisVisualization&&(this.analysisVisualization.showGrid=t)}get editable(){return!this.analysisVisualization.preview}set editable(t){this.analysisVisualization.preview=!t}get testData(){}};n([l({readOnly:!0})],m.prototype,"type",void 0),n([l({constructOnly:!0,nonNullable:!0})],m.prototype,"analysis",void 0),n([l()],m.prototype,"tool",void 0),n([l()],m.prototype,"plane",void 0),n([l()],m.prototype,"active",void 0),n([l()],m.prototype,"showGrid",null),n([l()],m.prototype,"editable",null),m=n([H("esri.views.3d.analysis.SliceAnalysisView3D")],m);const Nr=m;export{Nr as default};
