import{n as T}from"./mat4-GpOFENPA.js";import{e as C,o as I}from"./mat4f64-Dk4dwAN8.js";import{u as N,E as x,g as B,r as D,s as E,A as J}from"./vec32-Dvg_eL9J.js";import{n as p,N as S}from"./vec3f64-BLpZdpfb.js";import{z as V}from"./vec42-YcqnINSP.js";import{n as W}from"./vec4f64-o2zAXfmz.js";import{b as c,S as z,v as w}from"./sphere-C77djCO6.js";import{l as G}from"./ViewingMode-Dodu7ZZk.js";import{s as H,e as R,a as X,i as _,r as Q}from"./intersectorUtils-BK9EUwUf.js";import{b as k,d as j}from"./verticalOffsetUtils-BDQLpfho.js";const M=1e-5;class q{constructor(t){this.options=new H,this._results=new F,this.transform=new k,this.tolerance=M,this.verticalOffset=null,this._ray=c(),this._rayEnd=p(),this._rayBeginTransformed=p(),this._rayEndTransformed=p(),this.viewingMode=t??G.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,r,s){this.resetWithRay(z(t,r,this._ray),s)}resetWithRay(t,r){this.camera=r,t!==this._ray&&w(t,this._ray),this.options.verticalOffset!==0?this.viewingMode===G.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,N(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(t=null,r,s,f,a){var d;this.point=r,this.filterPredicate=f,this.tolerance=s??M;const h=j(this.verticalOffset);if(t&&t.length>0){const m=a?i=>{a(i)&&this.intersectObject(i)}:i=>{this.intersectObject(i)};for(const i of t){const l=(d=i.getSpatialQueryAccelerator)==null?void 0:d.call(i);l!=null?(h!=null?l.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,m,h):l.forEachAlongRay(this._ray.origin,this._ray.direction,m),this.options.selectionMode&&this.options.hud&&l.forEachDegenerateObject(m)):i.objects.forAll(g=>m(g))}}this.sortResults()}intersectObject(t){const r=t.geometries;if(!r)return;const s=t.effectiveTransformation,f=j(this.verticalOffset);for(const a of r){if(!a.visible)continue;const{material:h,id:d}=a;if(!h.visible)continue;this.transform.setAndInvalidateLazyTransforms(s,a.transformation),x(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),x(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const m=this.transform.transform;f!=null&&(f.objectTransform=this.transform),h.intersect(a,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(i,l,g,v,O,P)=>{if(i>=0){if(this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,i))return;const n=v?this._results.hud:this._results,L=v?o=>{const U=new Q(t,d,g,P);o.set(_.HUD,U,i,l,I,O)}:o=>o.set(_.OBJECT,{object:t,geometryId:d,triangleNr:g},i,l,m,O);if((n.min.drapedLayerOrder==null||O>=n.min.drapedLayerOrder)&&(n.min.dist==null||i<n.min.dist)&&L(n.min),this.options.store!==R.MIN&&(n.max.drapedLayerOrder==null||O<n.max.drapedLayerOrder)&&(n.max.dist==null||i>n.max.dist)&&L(n.max),this.options.store===R.ALL)if(v){const o=new A(this._ray);L(o),this._results.hud.all.push(o)}else{const o=new u(this._ray);L(o),this._results.all.push(o)}}})}}sortResults(t=this._results.all){t.sort((r,s)=>r.dist!==s.dist?(r.dist??0)-(s.dist??0):r.drapedLayerOrder!==s.drapedLayerOrder?$(r.drapedLayerOrder,s.drapedLayerOrder):$(r.drapedLayerGraphicOrder,s.drapedLayerGraphicOrder))}}function $(e,t){return(t??-Number.MAX_VALUE)-(e??-Number.MAX_VALUE)}function ot(e){return new q(e)}class F{constructor(){this.min=new u(c()),this.max=new u(c()),this.hud={min:new A(c()),max:new A(c()),all:new Array},this.ground=new u(c()),this.all=[]}init(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0}}class u{get ray(){return this._ray}get distanceInRenderSpace(){return this.dist!=null?(B(b,this.ray.direction,this.dist),D(b)):null}getIntersectionPoint(t){return!!X(this)&&(B(b,this.ray.direction,this.dist),N(t,this.ray.origin,b),!0)}getTransformedNormal(t){return E(y,this.normal),y[3]=0,V(y,y,this.transformation),E(t,y),J(t,t)}constructor(t){this.intersector=_.OBJECT,this.normal=p(),this.transformation=C(),this._ray=c(),this.init(t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=_.OBJECT,w(t,this._ray)}set(t,r,s,f,a,h,d){this.intersector=t,this.dist=s,E(this.normal,f??S),T(this.transformation,a??I),this.target=r,this.drapedLayerOrder=h,this.drapedLayerGraphicOrder=d}copy(t){w(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,E(this.normal,t.normal),T(this.transformation,t.transformation)}}class A extends u{constructor(){super(...arguments),this.intersector=_.HUD}}function ht(e){return new u(e)}const b=p(),y=W();function dt(e){return e.type==="point"}export{M as E,ht as G,ot as T,dt as t};
