import{t as W,J as X,U as N}from"./assets-C43MgM-v.js";import{_ as O}from"./asyncUtils-CWX51uTe.js";import{b as G,ad as Y,n as Z}from"./subclass-BZA_h8Db.js";import{s as ee,p as M}from"./Accessor-BLX9ikPh.js";import{t as te}from"./NestedMap-GuqgquCN.js";import{r as z}from"./Version-BSlAgupz.js";import{u as j}from"./vec3f64-BLpZdpfb.js";import{q as re,l as S}from"./aaBoundingBox-BE7cC1jD.js";import{l as ne}from"./Indices-DflDlU4Z.js";import{t as ae}from"./requestImageUtils-DgMiQwsm.js";import{t as se}from"./orientedBoundingBox-DOAJUK5g.js";import{e as oe,i as x}from"./renderState-DQLu6AJX.js";import{C as ie,p as ue}from"./Texture-Fac_8AOC.js";import{e as C}from"./VertexAttribute-Cq4MnHjR.js";import{B as le}from"./DefaultMaterial-DgOvtNL9.js";import{D}from"./enums-D9v74xTE.js";class je{constructor(e){this._streamDataRequester=e}async loadJSON(e,n){return this._load("json",e,n)}async loadBinary(e,n){return W(e)?(ee(n),X(e)):this._load("binary",e,n)}async loadImage(e,n){return this._load("image",e,n)}async _load(e,n,t){if(this._streamDataRequester==null)return(await N(n,{responseType:ce[e]})).data;const s=await O(this._streamDataRequester.request(n,e,t));if(s.ok===!0)return s.value;throw M(s.error),new G("glt-loader-request-error",`Request for resource failed: ${s.error}`)}}const ce={image:"image",binary:"array-buffer",json:"json","image+type":void 0},f=()=>Z.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function Se(r,e){const n=await pe(r,e),t=await ye(n.textureDefinitions??{},e);let s=0;for(const o in t)if(t.hasOwnProperty(o)){const a=t[o];s+=a!=null&&a.image?a.image.width*a.image.height*4:0}return{resource:n,textures:t,size:s+Y(n)}}async function pe(r,e){const n=e==null?void 0:e.streamDataRequester;if(n)return fe(r,n,e);const t=await O(N(r,e));if(t.ok===!0)return t.value.data;M(t.error),F(t.error)}async function fe(r,e,n){const t=await O(e.request(r,"json",n));if(t.ok===!0)return t.value;M(t.error),F(t.error.details.url)}function F(r){throw new G("",`Request for object resource failed: ${r}`)}function me(r){const e=r.params,n=e.topology;let t=!0;switch(e.vertexAttributes||(f().warn("Geometry must specify vertex attributes"),t=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const o=e.faces;if(o){if(e.vertexAttributes)for(const a in e.vertexAttributes){const i=o[a];i!=null&&i.values?(i.valueType!=null&&i.valueType!=="UInt32"&&(f().warn(`Unsupported indexed geometry indices type '${i.valueType}', only UInt32 is currently supported`),t=!1),i.valuesPerElement!=null&&i.valuesPerElement!==1&&(f().warn(`Unsupported indexed geometry values per element '${i.valuesPerElement}', only 1 is currently supported`),t=!1)):(f().warn(`Indexed geometry does not specify face indices for '${a}' attribute`),t=!1)}}else f().warn("Indexed geometries must specify faces"),t=!1;break}default:f().warn(`Unsupported topology '${n}'`),t=!1}r.params.material||(f().warn("Geometry requires material"),t=!1);const s=r.params.vertexAttributes;for(const o in s)s[o].values||(f().warn("Geometries with externally defined attributes are not yet supported"),t=!1);return t}function Ce(r,e){var B,E;const n=new Array,t=new Array,s=new Array,o=new te,a=r.resource,i=z.parse(a.version||"1.0","wosr");he.validate(i);const m=a.model.name,d=a.model.geometries,v=a.materialDefinitions??{},b=r.textures;let $=0;const g=new Map;for(let P=0;P<d.length;P++){const h=d[P];if(!me(h))continue;const U=ge(h),I=h.params.vertexAttributes,T=[],L=u=>{if(h.params.topology==="PerAttributeArray")return null;const l=h.params.faces;for(const p in l)if(p===u)return l[p].values;return null},_=I[C.POSITION],H=_.values.length/_.valuesPerElement;for(const u in I){const l=I[u],p=l.values,q=L(u)??ne(H);T.push([u,new se(p,q,l.valuesPerElement,!0)])}const y=U.texture,c=b&&b[y];if(c&&!g.has(y)){const{image:u,parameters:l}=c,p=new ie(u,l);t.push(p),g.set(y,p)}const k=g.get(y),K=k?k.id:void 0,A=U.material;let w=o.get(A,y);if(w==null){const u=v[A.slice(A.lastIndexOf("/")+1)].params;u.transparency===1&&(u.transparency=0);const l=c&&c.alphaChannelUsage,p=u.transparency>0||l==="transparency"||l==="maskAndTransparency",q=c?J(c.alphaChannelUsage):void 0,R={ambient:j(u.diffuse),diffuse:j(u.diffuse),opacity:1-(u.transparency||0),transparent:p,textureAlphaMode:q,textureAlphaCutoff:.33,textureId:K,initTextureTransparent:!0,doubleSided:!0,cullFace:oe.None,colorMixMode:u.externalColorMixMode||"tint",textureAlphaPremultiplied:(c==null?void 0:c.parameters.preMultiplyAlpha)??!1};e!=null&&e.materialParameters&&Object.assign(R,e.materialParameters),w=new le(R,e),o.set(A,y,w)}s.push(w);const Q=new ue(w,T);$+=((E=(B=T.find(u=>u[0]===C.POSITION))==null?void 0:B[1])==null?void 0:E.indices.length)??0,n.push(Q)}return{engineResources:[{name:m,stageResources:{textures:t,materials:s,geometries:n},pivotOffset:a.model.pivotOffset,numberOfVertices:$,lodThreshold:null}],referenceBoundingBox:de(n)}}function de(r){const e=re();return r.forEach(n=>{const t=n.boundingInfo;t!=null&&(S(e,t.bbMin),S(e,t.bbMax))}),e}async function ye(r,e){const n=new Array;for(const o in r){const a=r[o],i=a.images[0].data;if(!i){f().warn("Externally referenced texture data is not yet supported");continue}const m=a.encoding+";base64,"+i,d="/textureDefinitions/"+o,v=a.channels==="rgba"?a.alphaChannelUsage||"transparency":"none",b={noUnpackFlip:!0,wrap:{s:D.REPEAT,t:D.REPEAT},preMultiplyAlpha:J(v)!==x.Opaque},$=e!=null&&e.disableTextures?Promise.resolve(null):ae(m,e);n.push($.then(g=>({refId:d,image:g,parameters:b,alphaChannelUsage:v})))}const t=await Promise.all(n),s={};for(const o of t)s[o.refId]=o;return s}function J(r){switch(r){case"mask":return x.Mask;case"maskAndTransparency":return x.MaskBlend;case"none":return x.Opaque;default:return x.Blend}}function ge(r){const e=r.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const he=new z(1,2,"wosr");function we(r,e){V(r.typedBuffer,e.typedBuffer,r.typedBufferStride,e.typedBufferStride)}function V(r,e,n=3,t=n){const s=e.length/t;let o=0,a=0;for(let i=0;i<s;++i)r[o]=e[a],r[o+1]=e[a+1],r[o+2]=e[a+2],o+=n,a+=t}function xe(r,e,n,t,s){const o=r.typedBuffer,a=r.typedBufferStride,i=(s==null?void 0:s.count)??r.count;let m=((s==null?void 0:s.dstIndex)??0)*a;for(let d=0;d<i;++d)o[m]=e,o[m+1]=n,o[m+2]=t,m+=a}Object.freeze(Object.defineProperty({__proto__:null,copy:V,copyView:we,fill:xe},Symbol.toStringTag,{value:"Module"}));export{Se as A,Ce as T,we as e,xe as f,je as n,V as t};
